<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[RuoYi 登录性能：异步处理登录日志的实践与代码解析]]></title>    <link>https://juejin.cn/post/7571655979256627240</link>    <guid>https://juejin.cn/post/7571655979256627240</guid>    <pubDate>2025-11-12T15:23:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571655979256627240" data-draft-id="7571672422689587252" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RuoYi 登录性能：异步处理登录日志的实践与代码解析"/> <meta itemprop="keywords" content="Spring Boot"/> <meta itemprop="datePublished" content="2025-11-12T15:23:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="元Y亨H"/> <meta itemprop="url" content="https://juejin.cn/user/2839351584888617"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RuoYi 登录性能：异步处理登录日志的实践与代码解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2839351584888617/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    元Y亨H
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T15:23:30.000Z" title="Wed Nov 12 2025 15:23:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><hr/>
<h2 data-id="heading-0">优化 RuoYi 登录性能：异步处理登录日志的实践与代码解析</h2>
<p>在现代Web应用中，用户体验和系统性能是至关重要的指标。RuoYi（若依）框架作为一款优秀的后台管理系统，其性能优化同样是开发者关注的焦点。在登录认证这样的高频操作中，即使是看似简单的日志记录，也可能成为潜在的性能瓶颈。本文将深入探讨在 RuoYi 框架中，如何通过<strong>异步处理</strong>登录日志来显著提升系统响应速度和吞吐量，并提供详细的代码解析。</p>
<h3 data-id="heading-1">一、为什么登录日志需要异步处理？</h3>
<p>当用户尝试登录系统时，除了验证用户名密码、生成Token等核心业务逻辑外，通常还需要记录用户的登录信息，例如登录时间、IP地址、登录状态（成功/失败）等。这些信息往往需要持久化到数据库中。</p>
<p>如果这些日志记录操作是<strong>同步</strong>进行的，即在登录认证流程中等待数据库写入完成后才返回结果，那么：</p>
<ol>
<li><strong>增加响应时间：</strong> 数据库I/O操作相对耗时，会直接增加用户等待登录响应的时间。</li>
<li><strong>降低并发能力：</strong> 在高并发场景下，同步的数据库操作会阻塞主线程，限制系统处理更多并发登录请求的能力。</li>
<li><strong>资源竞争：</strong> 多个登录请求同时写入数据库时，可能引发数据库锁竞争，进一步恶化性能。</li>
</ol>
<p>因此，将登录日志的写入操作从核心登录流程中剥离出来，进行<strong>异步处理</strong>，成为优化登录性能的关键策略。这意味着登录认证通过后，系统可以立即响应用户，而日志记录则在后台默默进行，互不干扰。</p>
<h3 data-id="heading-2">二、RuoYi 框架中异步处理登录日志的实现思路</h3>
<p>在 RuoYi 框架中，我们通常会利用 Spring Boot 提供的特性，结合事件驱动机制和线程池来实现登录日志的异步记录。核心思路如下：</p>
<ol>
<li><strong>事件发布：</strong> 在登录认证成功或失败后，发布一个自定义的登录事件（<code>LoginEvent</code>），包含所有需要记录的登录信息。</li>
<li><strong>异步监听：</strong> 创建一个事件监听器，并使用 Spring 的 <code>@Async</code> 注解将其标记为异步方法。当 <code>LoginEvent</code> 被发布时，这个监听器会在独立的线程中执行。</li>
<li><strong>日志持久化：</strong> 在异步监听器中，调用 <code>SysLogininforService</code> 将登录信息保存到数据库。</li>
</ol>
<h3 data-id="heading-3">三、代码实现与解析</h3>
<p>接下来，我们将通过具体的代码示例来逐步构建异步登录日志功能。</p>
<h4 data-id="heading-4">1. 开启 Spring 异步支持</h4>
<p>首先，确保你的 Spring Boot 应用开启了异步执行功能。这通常通过在启动类上添加 <code>@EnableAsync</code> 注解实现。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// RuoYiApplication.java</span>
<span class="hljs-keyword">package</span> com.ruoyi;

<span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
<span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.EnableAsync; <span class="hljs-comment">// 引入异步支持</span>

<span class="hljs-comment">/**
 * 启动程序
 *
 * <span class="hljs-doctag">@author</span> ruoyi
 */</span>
<span class="hljs-meta">@SpringBootApplication(exclude = { DataSourceAutoConfiguration.class })</span>
<span class="hljs-meta">@EnableAsync</span> <span class="hljs-comment">// 开启异步方法执行</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RuoYiApplication</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span>
    {
        <span class="hljs-comment">// System.setProperty("spring.devtools.restart.enabled", "false");</span>
        SpringApplication.run(RuoYiApplication.class, args);
        System.out.println(<span class="hljs-string">"(♥◠‿◠)ﾉﾞ  若依启动成功   ლ(´ڡ`ლ)ﾞ  \n"</span> +
                <span class="hljs-string">" .-------.         .--.  .--.\n"</span> +
                <span class="hljs-string">" |  _ _   \\ .-.     |  |  |  |\n"</span> +
                <span class="hljs-string">" | ( ' )  | `-'     |  .--.  |\n"</span> +
                <span class="hljs-string">" |(_ o _) /         |  |  |  |\n"</span> +
                <span class="hljs-string">" | (_,_).' __        |  |  |  |\n"</span> +
                <span class="hljs-string">" |  |\\ \\  |  |   ___ |  |  |  |\n"</span> +
                <span class="hljs-string">" |  | \\ `'   / / \\  \\          /\n"</span> +
                <span class="hljs-string">" |  |  \\    /   \\  \\        /\n"</span> +
                <span class="hljs-string">" '--'   `--'     '--'--.--'\n"</span> +
                <span class="hljs-string">"                                      "</span>);
    }
}
</code></pre>
<h4 data-id="heading-5">2. 定义异步线程池（可选，但推荐）</h4>
<p>为了更好地控制异步任务的执行，我们可以自定义一个线程池供 <code>@Async</code> 注解使用。这样可以避免使用 Spring 默认的 <code>SimpleAsyncTaskExecutor</code>，提高线程资源管理效率。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// AsyncConfig.java</span>
<span class="hljs-keyword">package</span> com.ruoyi.framework.config;

<span class="hljs-keyword">import</span> java.util.concurrent.Executor;
<span class="hljs-keyword">import</span> java.util.concurrent.ThreadPoolExecutor;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.AsyncConfigurer;
<span class="hljs-keyword">import</span> org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;

<span class="hljs-comment">/**
 * 异步任务配置
 *
 * <span class="hljs-doctag">@author</span> ruoyi
 */</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AsyncConfigurer</span>
{
    <span class="hljs-comment">// 定义一个日志专用的线程池</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LOG_TASK_EXECUTOR</span> <span class="hljs-operator">=</span> <span class="hljs-string">"logTaskExecutor"</span>;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Bean(name = LOG_TASK_EXECUTOR)</span>
    <span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">getAsyncExecutor</span><span class="hljs-params">()</span>
    {
        <span class="hljs-type">ThreadPoolTaskExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolTaskExecutor</span>();
        executor.setCorePoolSize(<span class="hljs-number">5</span>); <span class="hljs-comment">// 核心线程数</span>
        executor.setMaxPoolSize(<span class="hljs-number">10</span>); <span class="hljs-comment">// 最大线程数</span>
        executor.setQueueCapacity(<span class="hljs-number">200</span>); <span class="hljs-comment">// 队列容量</span>
        executor.setKeepAliveSeconds(<span class="hljs-number">60</span>); <span class="hljs-comment">// 线程空闲时间</span>
        executor.setThreadNamePrefix(<span class="hljs-string">"ruoyi-log-async-"</span>); <span class="hljs-comment">// 线程名称前缀</span>
        <span class="hljs-comment">// 拒绝策略：当队列满且线程数达到最大时，由调用者线程执行任务</span>
        executor.setRejectedExecutionHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy());
        executor.initialize();
        <span class="hljs-keyword">return</span> executor;
    }
}
</code></pre>
<h4 data-id="heading-6">3. 定义登录事件</h4>
<p>创建一个自定义的 <code>LoginEvent</code>，它继承自 Spring 的 <code>ApplicationEvent</code>，用于封装登录相关的信息。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// LoginEvent.java</span>
<span class="hljs-keyword">package</span> com.ruoyi.framework.event;

<span class="hljs-keyword">import</span> com.ruoyi.system.domain.SysLogininfor;
<span class="hljs-keyword">import</span> org.springframework.context.ApplicationEvent;

<span class="hljs-comment">/**
 * 登录事件
 * 用于在登录成功或失败时，发布事件进行异步日志记录
 *
 * <span class="hljs-doctag">@author</span> ruoyi
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginEvent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ApplicationEvent</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SysLogininfor logininfor;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">LoginEvent</span><span class="hljs-params">(Object source, SysLogininfor logininfor)</span>
    {
        <span class="hljs-built_in">super</span>(source);
        <span class="hljs-built_in">this</span>.logininfor = logininfor;
    }

    <span class="hljs-keyword">public</span> SysLogininfor <span class="hljs-title function_">getLogininfor</span><span class="hljs-params">()</span>
    {
        <span class="hljs-keyword">return</span> logininfor;
    }
}
</code></pre>
<h4 data-id="heading-7">4. 创建异步事件监听器</h4>
<p>编写一个 Spring 组件作为事件监听器。使用 <code>@EventListener</code> 注解监听 <code>LoginEvent</code>，并通过 <code>@Async</code> 注解指定它在后台线程中执行，同时可以指定使用我们之前定义的线程池。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// LoginEventListener.java</span>
<span class="hljs-keyword">package</span> com.ruoyi.framework.listener;

<span class="hljs-keyword">import</span> com.ruoyi.framework.config.AsyncConfig;
<span class="hljs-keyword">import</span> com.ruoyi.framework.event.LoginEvent;
<span class="hljs-keyword">import</span> com.ruoyi.system.service.ISysLogininforService;
<span class="hljs-keyword">import</span> org.slf4j.Logger;
<span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.context.event.EventListener;
<span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.Async;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-comment">/**
 * 登录事件监听器
 * 负责异步记录登录日志到数据库
 *
 * <span class="hljs-doctag">@author</span> ruoyi
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginEventListener</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(LoginEventListener.class);

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ISysLogininforService logininforService;

    <span class="hljs-comment">/**
     * 监听 LoginEvent，并在异步线程中处理登录日志
     * 指定使用 logTaskExecutor 线程池
     *
     * <span class="hljs-doctag">@param</span> event 登录事件
     */</span>
    <span class="hljs-meta">@Async(AsyncConfig.LOG_TASK_EXECUTOR)</span>
    <span class="hljs-meta">@EventListener</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleLoginEvent</span><span class="hljs-params">(LoginEvent event)</span>
    {
        log.debug(<span class="hljs-string">"异步线程[{}] 开始处理登录日志..."</span>, Thread.currentThread().getName());
        <span class="hljs-keyword">try</span>
        {
            <span class="hljs-comment">// 获取登录信息对象</span>
            <span class="hljs-type">SysLogininfor</span> <span class="hljs-variable">logininfor</span> <span class="hljs-operator">=</span> event.getLogininfor();
            <span class="hljs-comment">// 调用服务层方法，将登录日志保存到数据库</span>
            logininforService.insertLogininfor(logininfor);
            log.info(<span class="hljs-string">"用户[{}] 登录日志记录成功。状态: {}"</span>, logininfor.getUserName(), logininfor.getStatus());
        }
        <span class="hljs-keyword">catch</span> (Exception e)
        {
            log.error(<span class="hljs-string">"异步记录登录日志失败：{}"</span>, e.getMessage(), e);
            <span class="hljs-comment">// 可以在这里添加告警通知机制</span>
        }
    }
}
</code></pre>
<h4 data-id="heading-8">5. 在登录服务中发布事件</h4>
<p>最后，在 RuoYi 的登录服务（例如 <code>SysLoginService</code>）中，当用户登录成功或失败后，构建 <code>SysLogininfor</code> 对象，并通过 <code>ApplicationEventPublisher</code> 发布 <code>LoginEvent</code>。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// SysLoginService.java (简化版，仅展示事件发布逻辑)</span>
<span class="hljs-keyword">package</span> com.ruoyi.framework.web.service;

<span class="hljs-keyword">import</span> com.ruoyi.common.constant.Constants;
<span class="hljs-keyword">import</span> com.ruoyi.common.exception.user.CaptchaException;
<span class="hljs-keyword">import</span> com.ruoyi.common.exception.user.UserPasswordNotMatchException;
<span class="hljs-keyword">import</span> com.ruoyi.common.utils.DateUtils;
<span class="hljs-keyword">import</span> com.ruoyi.common.utils.ServletUtils;
<span class="hljs-keyword">import</span> com.ruoyi.framework.event.LoginEvent; <span class="hljs-comment">// 引入 LoginEvent</span>
<span class="hljs-keyword">import</span> com.ruoyi.framework.manager.AsyncManager;
<span class="hljs-keyword">import</span> com.ruoyi.framework.manager.factory.AsyncFactory;
<span class="hljs-keyword">import</span> com.ruoyi.system.domain.SysLogininfor;
<span class="hljs-keyword">import</span> com.ruoyi.system.domain.SysUser;
<span class="hljs-keyword">import</span> com.ruoyi.system.service.ISysConfigService;
<span class="hljs-keyword">import</span> com.ruoyi.system.service.ISysUserService;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.context.ApplicationEventPublisher; <span class="hljs-comment">// 引入事件发布器</span>
<span class="hljs-keyword">import</span> org.springframework.security.authentication.AuthenticationManager;
<span class="hljs-keyword">import</span> org.springframework.security.authentication.BadCredentialsException;
<span class="hljs-keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
<span class="hljs-keyword">import</span> org.springframework.security.core.Authentication;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-comment">/**
 * 登录校验方法
 *
 * <span class="hljs-doctag">@author</span> ruoyi
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SysLoginService</span>
{
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> TokenService tokenService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> AuthenticationManager authenticationManager;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ISysUserService userService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ISysConfigService configService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ApplicationEventPublisher eventPublisher; <span class="hljs-comment">// 注入事件发布器</span>

    <span class="hljs-comment">/**
     * 登录验证
     *
     * <span class="hljs-doctag">@param</span> username 用户名
     * <span class="hljs-doctag">@param</span> password 密码
     * <span class="hljs-doctag">@param</span> code     验证码
     * <span class="hljs-doctag">@param</span> uuid     唯一标识
     * <span class="hljs-doctag">@return</span> 结果
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">login</span><span class="hljs-params">(String username, String password, String code, String uuid)</span>
    {
        <span class="hljs-comment">// ... (省略验证码、账户锁定等其他登录逻辑) ...</span>

        <span class="hljs-type">SysLogininfor</span> <span class="hljs-variable">logininfor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SysLogininfor</span>();
        logininfor.setUserName(username);
        logininfor.setIpaddr(ServletUtils.getIpAddr(ServletUtils.getRequest()));
        logininfor.setLoginLocation(AsyncFactory.getRealAddressByIP(logininfor.getIpaddr()));
        logininfor.setBrowser(ServletUtils.getBrowser());
        logininfor.setOs(ServletUtils.getOs());
        logininfor.setLoginTime(DateUtils.getNowDate());

        Authentication authentication;
        <span class="hljs-keyword">try</span>
        {
            <span class="hljs-comment">// 该方法会去调用UserDetailsServiceImpl.loadUserByUsername</span>
            authentication = authenticationManager
                    .authenticate(<span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernamePasswordAuthenticationToken</span>(username, password));

            <span class="hljs-comment">// 认证成功</span>
            logininfor.setStatus(Constants.SUCCESS);
            logininfor.setMsg(<span class="hljs-string">"登录成功"</span>);
            <span class="hljs-comment">// 发布登录成功事件</span>
            eventPublisher.publishEvent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LoginEvent</span>(<span class="hljs-built_in">this</span>, logininfor));
        }
        <span class="hljs-keyword">catch</span> (Exception e)
        {
            logininfor.setStatus(Constants.FAIL);
            <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> BadCredentialsException || e <span class="hljs-keyword">instanceof</span> UserPasswordNotMatchException)
            {
                logininfor.setMsg(<span class="hljs-string">"用户不存在/密码错误"</span>);
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> CaptchaException)
            {
                logininfor.setMsg(<span class="hljs-string">"验证码错误"</span>);
            }
            <span class="hljs-keyword">else</span>
            {
                logininfor.setMsg(e.getMessage());
            }
            <span class="hljs-comment">// 发布登录失败事件</span>
            eventPublisher.publishEvent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LoginEvent</span>(<span class="hljs-built_in">this</span>, logininfor));
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e.getMessage()); <span class="hljs-comment">// 抛出异常给上层处理</span>
        }
        <span class="hljs-comment">// ... (省略后续生成Token等逻辑) ...</span>
        <span class="hljs-keyword">return</span> token;
    }
}
</code></pre>
<p><strong>代码说明：</strong></p>
<ul>
<li><code>ApplicationEventPublisher</code> 是 Spring 提供的事件发布接口，通过 <code>eventPublisher.publishEvent()</code> 方法可以发布任何继承自 <code>ApplicationEvent</code> 的事件。</li>
<li><code>LoginEvent</code> 包含了所有需要在日志中记录的信息。</li>
<li>当 <code>login</code> 方法中认证成功或失败后，我们立即发布 <code>LoginEvent</code>，而无需等待数据库操作完成。</li>
<li><code>LoginEventListener</code> 上的 <code>@Async</code> 和 <code>@EventListener</code> 会确保 <code>handleLoginEvent</code> 方法在 <code>logTaskExecutor</code> 线程池中异步执行，从而不阻塞主登录流程。</li>
</ul>
<h3 data-id="heading-9">四、测试与效果</h3>
<p>通过上述改造，当用户发起登录请求时：</p>
<ol>
<li>主线程快速完成用户认证和Token生成等核心操作。</li>
<li><code>SysLoginService</code> 发布 <code>LoginEvent</code> 后，立即返回登录结果给前端。</li>
<li>一个独立的线程（来自 <code>logTaskExecutor</code> 线程池）接收到 <code>LoginEvent</code>，并在后台异步执行 <code>logininforService.insertLogininfor()</code> 方法，将登录日志保存到数据库。</li>
</ol>
<p>这种模式下，登录接口的响应速度将主要取决于认证逻辑和Token生成，而不再受数据库I/O的拖累。特别是在数据库压力较大或网络延迟较高的情况下，异步处理的优势将更加明显。</p>
<h3 data-id="heading-10">五、总结</h3>
<p>异步处理登录日志是优化 RuoYi 框架性能的一种有效手段。通过利用 Spring 的 <code>@EnableAsync</code>、自定义线程池、事件发布与监听机制，我们可以轻松地将日志记录这一非核心业务逻辑从主流程中解耦出来，使其在后台异步执行。这不仅提升了用户登录体验，也增强了系统的并发处理能力和整体稳定性。</p>
<p><strong>关键点回顾：</strong></p>
<ul>
<li><strong>问题根源：</strong> 同步数据库I/O是登录性能瓶颈。</li>
<li><strong>解决方案：</strong> 事件驱动 + <code>@Async</code> 异步处理。</li>
<li><strong>代码核心：</strong> <code>LoginEvent</code>、<code>@EnableAsync</code>、自定义 <code>Executor</code>、<code>@Async @EventListener</code>、<code>ApplicationEventPublisher</code>。</li>
</ul>
<p>希望本文能帮助你在 RuoYi 框架的开发中更好地实践异步编程，构建出更高效、更健壮的应用。</p>
<hr/>
<p>`</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Go 通道引用与 close 操作]]></title>    <link>https://juejin.cn/post/7571678674145705994</link>    <guid>https://juejin.cn/post/7571678674145705994</guid>    <pubDate>2025-11-12T15:44:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571678674145705994" data-draft-id="7571662618056015898" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Go 通道引用与 close 操作"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-12T15:44:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Penge666"/> <meta itemprop="url" content="https://juejin.cn/user/1549628692501449"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Go 通道引用与 close 操作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1549628692501449/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Penge666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T15:44:16.000Z" title="Wed Nov 12 2025 15:44:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Go 开发中，通道（chan）的使用频率极高，但它的引用特性和 close 操作的作用范围，往往是新手容易踩坑的点。比如 “通道赋值后关闭原变量，新变量会受影响吗？”“会不会导致内存泄露？”“后续发送数据会不会 panic？”—— 这篇文章就用通俗的语言 + 结论 + 代码验证，把这些问题讲透。</p>
<h2 data-id="heading-0">一、核心结论（先给答案，不绕弯）</h2>
<ol>
<li><code>destChan</code> 不是指针，是「通道引用」：Go 中通道是引用类型（类似 slice、map），变量存储的是指向底层数据结构的引用，而非结构本身。</li>
<li>关闭 <code>source.TaskChan</code> 后，<code>destChan</code> 会受影响，但不是 “被关闭”：close 操作作用于底层通道，所有引用这个通道的变量（包括 <code>destChan</code>）都会感知到 “通道已关闭”。</li>
<li>不会因 <code>destChan</code> 导致内存泄露：只要所有引用（<code>source.TaskChan</code> 和 <code>destChan</code>）都不再被使用，底层通道会被 GC 回收；真正需要警惕的是 “关闭通道后的发送 panic”。</li>
</ol>
<h2 data-id="heading-1">二、逐点拆解：把原理讲明白</h2>
<h3 data-id="heading-2">1. 通道是 “引用类型”，不是指针但行为类似</h3>
<p>Go 中的引用类型（chan/slice/map/func/interface）有个共性：变量存储的是「指向底层对象的地址」，赋值操作只会复制这个地址，不会复制底层对象。</p>
<p>举个实际场景的例子：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 假设 source 是一个自定义结构体，TaskChan 是已初始化的 chan string</span>
<span class="hljs-keyword">type</span> Resource <span class="hljs-keyword">struct</span> {
    TaskChan <span class="hljs-keyword">chan</span> <span class="hljs-type">string</span> <span class="hljs-comment">// 通道字段</span>
}

<span class="hljs-keyword">var</span> source = Resource{
    TaskChan: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">string</span>, <span class="hljs-number">5</span>), <span class="hljs-comment">// 初始化带缓冲通道</span>
}

<span class="hljs-comment">// 赋值操作：将 source.TaskChan 赋值给 destChan</span>
destChan := source.TaskChan
</code></pre>
<p>执行后，<code>destChan</code> 和 <code>source.TaskChan</code> 持有同一个底层通道的引用 —— 就像两个遥控器控制同一个电视，操作任何一个，影响的都是同一个 “底层设备”。</p>
<p>这里要注意：<code>destChan</code> 不是 <code>*chan string</code>（通道指针），而是 <code>chan string</code>（通道引用类型），语法上不需要解引用（<code>*</code>）就能直接使用，比指针更简洁。</p>
<h3 data-id="heading-3">2. close 操作作用于 “底层通道”，所有引用都会感知</h3>
<p>当我们执行 <code>close(source.TaskChan)</code> 时，要明确一个关键：<strong>关闭的是底层的通道对象，不是 <code>source.TaskChan</code> 这个变量本身</strong>。</p>
<p>因为 <code>destChan</code> 和 <code>source.TaskChan</code> 指向同一个底层通道，所以 <code>destChan</code> 会变成 “指向已关闭通道的引用”—— 此时会有两个核心影响：</p>
<ul>
<li>往 <code>destChan</code> 发送数据：直接 panic（错误信息：<code>send on closed channel</code>）；</li>
<li>从 <code>destChan</code> 接收数据：会立即返回通道元素的零值 + <code>ok=false</code>（表示通道已关闭且无数据）。</li>
</ul>
<p>可以用一个通俗的比喻理解：两个指针指向同一个文件，关闭文件后，两个指针都无法再写入文件，但指针变量本身还存在（不是 nil），只是失去了有效操作的能力。</p>
<h3 data-id="heading-4">3. 内存泄露风险：几乎不存在，无需过度担心</h3>
<p>内存泄露的核心是 “底层对象被无用的引用持有，无法被 GC 回收”，但在这个场景中，完全不需要担心：</p>
<ul>
<li><code>destChan</code> 通常是局部变量（比如在函数或回调中定义），函数执行完毕后，变量会被销毁，引用自然释放；</li>
<li><code>source.TaskChan</code> 是结构体字段，当 <code>source</code> 结构体被销毁（比如任务执行结束后），这个引用也会消失；</li>
<li>只要所有引用都释放，无论底层通道是否关闭，都会被 GC 回收，不会造成内存泄露。</li>
</ul>
<p>唯一可能的泄露场景：如果 <code>source</code> 是全局变量（长期存在），且通道被关闭后，<code>source.TaskChan</code> 仍被持有，但这是 <code>source</code> 的生命周期管理问题，和 <code>destChan</code> 无关。</p>
<h2 data-id="heading-5">三、代码验证：直观感受引用与 close 的影响</h2>
<p>光说不练假把式，用一段简单的代码验证上面的结论，跑起来就能直观看到效果：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 1. 初始化一个通道（底层通道对象在堆上分配）</span>
    sourceChan := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">string</span>, <span class="hljs-number">1</span>)
    fmt.Printf(<span class="hljs-string">"sourceChan 变量本身地址（栈上）：%p\n"</span>, &amp;sourceChan)
    fmt.Printf(<span class="hljs-string">"sourceChan 引用的底层通道地址（堆上）：%p\n"</span>, sourceChan)

    <span class="hljs-comment">// 2. 赋值给 destChan：复制引用</span>
    destChan := sourceChan
    fmt.Printf(<span class="hljs-string">"destChan 变量本身地址（栈上）：%p\n"</span>, &amp;destChan)
    fmt.Printf(<span class="hljs-string">"destChan 引用的底层通道地址（堆上）：%p\n"</span>, destChan)

    <span class="hljs-comment">// 3. 关闭 sourceChan（实际关闭的是底层通道）</span>
    <span class="hljs-built_in">close</span>(sourceChan)

    <span class="hljs-comment">// 4. destChan 感知到底层通道已关闭</span>
    data, ok := &lt;-destChan
    fmt.Printf(<span class="hljs-string">"从 destChan 接收数据：data=%q, ok=%v（ok=false 表示通道已关闭）\n"</span>, data, ok)

    <span class="hljs-comment">// 5. 往 destChan 发送数据会直接 panic（注释掉可避免运行报错）</span>
    <span class="hljs-comment">// destChan &lt;- "test" // 执行后报错：panic: send on closed channel</span>
}
</code></pre>
<h3 data-id="heading-6">运行结果：</h3>
<pre><code class="hljs language-plaintext" lang="plaintext">sourceChan 变量本身地址（栈上）：0xc0000a6020
sourceChan 引用的底层通道地址（堆上）：0xc0000b4000
destChan 变量本身地址（栈上）：0xc0000a6040
destChan 引用的底层通道地址（堆上）：0xc0000b4000
从 destChan 接收数据：data="", ok=false（ok=false 表示通道已关闭）
</code></pre>
<h3 data-id="heading-7">结论验证：</h3>
<ul>
<li><code>sourceChan</code> 和 <code>destChan</code> 是不同的变量（栈地址不同），但引用同一个底层通道（堆地址相同）；</li>
<li>关闭 <code>sourceChan</code> 后，<code>destChan</code> 能直接感知到通道关闭；</li>
<li>关闭后的通道发送数据会 panic，这是核心风险点。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[初见 Dart：这门新语言如何让你的 App「动」起来？]]></title>    <link>https://juejin.cn/post/7571641339688845312</link>    <guid>https://juejin.cn/post/7571641339688845312</guid>    <pubDate>2025-11-12T11:03:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571641339688845312" data-draft-id="7571636682695278632" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="初见 Dart：这门新语言如何让你的 App「动」起来？"/> <meta itemprop="keywords" content="Flutter,Android,iOS"/> <meta itemprop="datePublished" content="2025-11-12T11:03:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="全栈派森"/> <meta itemprop="url" content="https://juejin.cn/user/430664289093176"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            初见 Dart：这门新语言如何让你的 App「动」起来？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/430664289093176/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    全栈派森
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T11:03:51.000Z" title="Wed Nov 12 2025 11:03:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好,我是<code>Petter Guo</code> <br/></p>
<p>一位热爱<code>探索</code>的<code>全栈工程师</code>。在这里，我将分享<code>个人</code>的<code>Technical essentials</code>，带你玩转<code>前端</code>、<code>后端</code>到 <code>DevOps</code> 的硬核技术，解锁<code>AI</code>，助你打通技术任督二脉，成为真正的<code>全能玩家</code>!！<br/></p>
<p>如果对你有帮助, 请<code>点赞</code>+ <code>收藏</code> +<code>关注</code>鼓励下, 学习公众号为 <code>全栈派森</code>。 <br/></p>
<p>时间过的好快, 本人接触业务比较复杂, 最近一直在搞跨平台相关的技术, 比如很火的两大框架 Flutter &amp; ReactNative, 本期你将有如下收获:</p>
<ol>
<li>🍰 Flutter底层架构</li>
<li>🍦 Flutter核心组件</li>
<li>⛽️ Dart常用语法</li>
<li>🙋 Flutter vs RN</li>
</ol>
<h3 data-id="heading-0">Flutter底层架构</h3>
<ol>
<li>
<p>顶层：框架层 (The Framework)</p>
<p>这一层完全由 <strong>Dart 语言</strong> 编写，是我们作为开发者直接打交道的部分。</p>
</li>
</ol>
<ul>
<li><strong>Dart Platform:</strong> 包含 Dart 语言、核心库和 Dart VM（虚拟机）。</li>
<li><strong>Widgets (组件)：</strong> Flutter 的核心概念。所有的 UI 都是由 Widget 组成的，它描述了 UI 的一部分应该如何渲染和交互。</li>
<li><strong>基础 Widgets：</strong> 如 <code>Text</code>, <code>Image</code>, <code>Row</code>, <code>Column</code> 等。</li>
<li><strong>渲染 Widgets：</strong>
<ul>
<li><strong>Material Design:</strong> 实现 Google 的 Material 设计规范（如 <code>Scaffold</code>, <code>AppBar</code>）。</li>
<li><strong>Cupertino:</strong> 实现 Apple 的 iOS 设计规范。</li>
</ul>
</li>
<li><strong>Rendering (渲染):</strong> 提供了抽象的渲染模型，包括 <code>RenderObject</code>、布局、绘制等。</li>
<li><strong>Animation, Gestures &amp; Painting:</strong> 处理动画、手势识别和底层绘图逻辑。</li>
</ul>
<blockquote>
<p><strong>核心思想：</strong> Flutter 框架只提供 <strong>抽象的 UI 组件</strong> 和 <strong>一套渲染规范</strong>。</p>
</blockquote>
<ol start="2">
<li>
<p>中间层：引擎层 (The Engine)</p>
<p>这一层主要由 <strong>C++</strong> 编写，它负责执行 Dart 运行时环境，并将上层的 Dart 代码渲染到萤幕上。</p>
</li>
</ol>
<ul>
<li><strong>Skia 引擎 (Skia Graphics Engine):</strong> 这是 Flutter 最关键的部分。 Skia 是一个高性能的 2D 渲染引擎，也是 Chrome 和 Android 采用的图形库。 <strong>Flutter 依靠 Skia 在移动设备上绘制每一个像素</strong>。</li>
<li><strong>优势：</strong> 这使得 Flutter <strong>完全绕过了</strong> 原生 OEM（原始设备制造商）的 UI 组件。应用程式只需一个「画布」，所有的按钮、文本、动画都由 Skia 直接绘制。</li>
<li><strong>Dart Runtime：</strong> Dart 虚拟机（VM）和 AOT/JIT 编译器，负责运行 Dart 代码。</li>
<li><strong>Text Layout:</strong> 处理文本布局和字体渲染。</li>
<li><strong>Platform Channels (平台通道):</strong> 实现 Dart 代码与原生平台（如 iOS 的 Swift/Objective-C 或 Android 的 Java/Kotlin）之间的通信。这是 Flutter 访问原生 API（如 GPS、蓝牙）的唯一途径。</li>
</ul>
<blockquote>
<p><strong>核心思想：</strong> 引擎层是 <strong>底层执行者</strong>，负责将 Dart 的指令翻译成像素并绘制出来。</p>
</blockquote>
<ol start="3">
<li>
<p>底层：嵌入层 (The Embedder)</p>
<p>这是与 <strong>特定操作系统（OS）</strong> 交互的层级。</p>
</li>
</ol>
<ul>
<li><strong>平台特定的程式码：</strong> 这部分是 Dart 运行时和底层 OS 之间粘合剂。</li>
<li><strong>Android:</strong> 使用 Java/Kotlin，将 Flutter 引擎作为 <code>Activity</code> 嵌入。</li>
<li><strong>iOS:</strong> 使用 Swift/Objective-C，将 Flutter 引擎作为 <code>ViewController</code> 嵌入。</li>
<li><strong>访问原生 API：</strong> 嵌入层提供了底层的系统服务、生命周期事件、输入事件（触摸、滑鼠）等。</li>
</ul>
<blockquote>
<p><strong>核心思想：</strong> 嵌入层是 <strong>宿主</strong>，负责提供一个原生环境来运行和承载 Flutter 引擎。</p>
</blockquote>
<h3 data-id="heading-1">Flutter优势</h3>
<p>这种分层架构带来了以下独特的优势：</p>
<ol>
<li><strong>高性能 (High Performance):</strong> 由于 Dart 代码可以 <strong>AOT (Ahead-of-Time)</strong> 编译成高效的 ARM 机器码，再加上直接使用 Skia 引擎渲染，性能可以<strong>媲美原生应用</strong>。</li>
<li><strong>UI 一致性 (UI Consistency):</strong> 由于不依赖原生系统的 UI，Flutter 应用在​​任何版本或型号的设备上都能保持<strong>像素级的一致性</strong>。</li>
<li><strong>消除 Bridge 瓶颈 (No Bridge):</strong> Flutter 不使用 React Native 那样的 JSON 异步 Bridge，所有的 UI 逻辑都在 Dart VM 中运行，避免了序列化和跨线程通信的开销。</li>
</ol>
<h3 data-id="heading-2">Flutter核心组件</h3>
<h4 data-id="heading-3">1. 📂 布局与结构 Widgets (Layout &amp; Structure)</h4>















































<table><thead><tr><th align="left">Widget</th><th align="left">作用</th><th align="left">关键属性</th><th align="left">示例场景</th></tr></thead><tbody><tr><td align="left"><strong>Scaffold</strong></td><td align="left">脚手架。提供应用程式的基本结构，如抽屉、底部导航栏、浮动按钮等。</td><td align="left"><code>appBar</code>, <code>body</code>, <code>drawer</code>, <code>bottomNavigationBar</code></td><td align="left">每个页面/屏幕的顶层 Widget。</td></tr><tr><td align="left"><strong>Container</strong></td><td align="left">容器。最基础的布局/装饰 Widget，用于添加边距、填充、颜色、装饰等。</td><td align="left"><code>child</code>, <code>padding</code>, <code>margin</code>, <code>color</code>, <code>decoration</code></td><td align="left">给子 Widget 设置背景色和边距。</td></tr><tr><td align="left"><strong>Row / Column</strong></td><td align="left">行/列。在水平 (<code>Row</code>) 或垂直 (<code>Column</code>) 方向上排列多个子 Widget。</td><td align="left"><code>children</code> (Widget 列表), <code>mainAxisAlignment</code>, <code>crossAxisAlignment</code></td><td align="left">实现线性布局。</td></tr><tr><td align="left"><strong>Center</strong></td><td align="left">居中。将其子 Widget 居中放置。</td><td align="left"><code>child</code></td><td align="left">将单个元素放在萤幕中央。</td></tr><tr><td align="left"><strong>Padding</strong></td><td align="left">填充。在其子 Widget 周围添加内部间距（填充）。</td><td align="left"><code>padding</code> (通常使用 <code>EdgeInsets.all</code> 等)</td><td align="left">调整 Widget 内部空间。</td></tr><tr><td align="left"><strong>SizedBox</strong></td><td align="left">尺寸。用于控制子 Widget 的大小或简单地创建空白间距。</td><td align="left"><code>width</code>, <code>height</code>, <code>child</code></td><td align="left">创建两个 Widget 之间的固定间隔。</td></tr></tbody></table>
<h4 data-id="heading-4">2. 🧱 基础内容与交互 Widgets (Content &amp; Interaction)</h4>















































<table><thead><tr><th align="left">Widget</th><th align="left">作用</th><th align="left">关键属性</th><th align="left">示例场景</th></tr></thead><tbody><tr><td align="left"><strong>Text</strong></td><td align="left">文本。用于显示静态文本。</td><td align="left"><code>data</code> (文本内容), <code>style</code> (TextStyle), <code>textAlign</code></td><td align="left">显示标题、描述、正文。</td></tr><tr><td align="left"><strong>Image</strong></td><td align="left">图片。用于显示图片，支持本地资源、文件或网路图片。</td><td align="left"><code>image</code> (Asset/NetworkImage), <code>fit</code>, <code>width</code>, <code>height</code></td><td align="left">显示应用 Logo、用户头像、网路图片。</td></tr><tr><td align="left"><strong>Icon</strong></td><td align="left">图标。用于显示 Material 或 Cupertino 图标。</td><td align="left"><code>icon</code> (Icons.xxx), <code>color</code>, <code>size</code></td><td align="left">菜单图标、操作按钮图标。</td></tr><tr><td align="left"><strong>ElevatedButton</strong></td><td align="left">按钮。带有阴影效果的凸起按钮。</td><td align="left"><code>onPressed</code> (点击回调), <code>child</code></td><td align="left">提交表单、执行操作。</td></tr><tr><td align="left"><strong>TextField</strong></td><td align="left">文本输入框。用于接收用户输入。</td><td align="left"><code>controller</code>, <code>decoration</code> (InputDecoration), <code>onChanged</code>, <code>keyboardType</code></td><td align="left">用户名/密码输入、搜寻框。</td></tr><tr><td align="left"><strong>ListView</strong></td><td align="left">列表。用于垂直滚动的长列表，<strong>只渲染可见部分</strong>（性能优化）。</td><td align="left"><code>children</code> 或 <code>itemBuilder</code> (Factory 模式)</td><td align="left">显示新闻列表、聊天记录。</td></tr></tbody></table>
<h4 data-id="heading-5">3. 🔄 状态管理与动态 Widgets (State Management)</h4>























<table><thead><tr><th align="left">Widget</th><th align="left">作用</th><th align="left">区别</th><th align="left">示例场景</th></tr></thead><tbody><tr><td align="left"><strong>StatelessWidget</strong></td><td align="left">无状态 Widget。一旦创建，它的属性（数据）就不会改变。</td><td align="left">数据是固定的 (<code>final</code>)，没有内部状态。</td><td align="left">显示静态文本、Logo、静态图标。</td></tr><tr><td align="left"><strong>StatefulWidget</strong></td><td align="left">有状态 Widget。其内部数据可以在 Widget 生命周期内发生变化。</td><td align="left">包含一个 <code>State</code> 对象，通过调用 <strong><code>setState()</code></strong> 来触发 UI 重新绘制。</td><td align="left">带有计数器的按钮、复选框、动态列表。</td></tr></tbody></table>
<h3 data-id="heading-6">✍️ Dart 常用语法特性</h3>
<p>Flutter 使用 Dart 语言，它是一种面向对象、类基的语言，同时支持 AOT（编译成机器码）和 JIT（即时编译，用于热重载）。</p>
<h4 data-id="heading-7">1. 类型与变量</h4>
<ul>
<li><strong>类型推断：</strong> 大多数时候可以使用 <code>var</code>，Dart 会自动推断类型。</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">var</span> name = <span class="hljs-string">'Alice'</span>; <span class="hljs-comment">// String</span>
<span class="hljs-keyword">var</span> year = <span class="hljs-number">1977</span>;   <span class="hljs-comment">// int</span>
</code></pre>
<ul>
<li><strong>明确类型：</strong> 也可以明确声明。</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-built_in">String</span> name = <span class="hljs-string">'Bob'</span>;
<span class="hljs-built_in">int</span> age = <span class="hljs-number">30</span>;
</code></pre>
<ul>
<li><strong>不变性 (Immutability)：</strong></li>
<li><code>final</code>: 运行时常量，只能赋值一次。</li>
<li><code>const</code>: 编译时常量，在编译时就确定值。</li>
</ul>

<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> uid = getUserId(); <span class="hljs-comment">// 运行时确定</span>
<span class="hljs-keyword">const</span> PI = <span class="hljs-number">3.14159</span>;             <span class="hljs-comment">// 编译时确定</span>
</code></pre>
<ul>
<li><strong>可空类型 (Null Safety)：</strong> 这是 Dart 2.12+ 的重要特性。</li>
<li><code>String?</code>: 变量可以是 <code>String</code> 类型，也可以是 <code>null</code>。</li>
<li><code>String</code>: 变量<strong>不能</strong>是 <code>null</code>。</li>
<li><code>!</code> (断言): 告诉编译器「我相信它不是 null」。</li>
</ul>
<h4 data-id="heading-8">2. 函数与箭头语法</h4>
<ul>
<li><strong>普通函数：</strong></li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-built_in">int</span> add(<span class="hljs-built_in">int</span> a, <span class="hljs-built_in">int</span> b) {
  <span class="hljs-keyword">return</span> a + b;
}
</code></pre>
<ul>
<li><strong>箭头函数：</strong> 适用于只有单个表达式的函数。</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-built_in">int</span> multiply(<span class="hljs-built_in">int</span> a, <span class="hljs-built_in">int</span> b) =&gt; a * b;
</code></pre>
<h4 data-id="heading-9">3. 构造函数 (Constructors)</h4>
<p>Dart 提供了强大的构造函数语法，常在 Flutter Widget 中使用：</p>
<ul>
<li><strong>简化赋值：</strong> 直接在构造函数中为实例变量赋值。</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> name;
  Person(<span class="hljs-keyword">this</span>.name); <span class="hljs-comment">// 简洁地将参数赋值给 name</span>
}
</code></pre>
<ul>
<li><strong>命名构造函数：</strong> 创建多个、有特定用途的构造函数。</li>
</ul>
<pre><code class="hljs language-dart" lang="dart">Person.fromJson(<span class="hljs-built_in">Map</span> data) {
<span class="hljs-comment">// ...</span>
}
</code></pre>
<ul>
<li><strong>工厂构造函数 (Factory):</strong> 用于复杂的对象创建逻辑（如单例模式或返回子类型）。</li>
</ul>
<h4 data-id="heading-10">4. 异步编程 (Asynchrony)</h4>
<p>Dart 使用 <code>Future</code> 和 <code>async/await</code> 处理异步操作（如网路请求）。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 声明函数是异步的</span>
Future&lt;<span class="hljs-built_in">String</span>&gt; fetchData() <span class="hljs-keyword">async</span> {
  <span class="hljs-comment">// 使用 await 等待结果，代码看起来像同步一样</span>
  <span class="hljs-keyword">var</span> response = <span class="hljs-keyword">await</span> httpClient.<span class="hljs-keyword">get</span>(<span class="hljs-string">'...'</span>);
  <span class="hljs-keyword">return</span> response.body;
}
</code></pre>
<h3 data-id="heading-11">Flutter vs RN</h3>
<h3 data-id="heading-12">1. ⚛️ React Native (JS + Bridge + 原生元件)</h3>
<ul>
<li><strong>技术栈：</strong> JavaScript / TypeScript + React。</li>
<li><strong>工作原理：</strong> React Native 依赖于一个 <strong>Bridge（桥接器）</strong>，将 JavaScript 逻辑转换为原生操作。它使用 <strong>原生 UI 元件</strong>（如 Android 的 <code>TextView</code>，iOS 的 <code>UILabel</code>）进行渲染。</li>
<li><strong>优势：</strong> 能够提供完全的原生体验，因为它使用的就是平台自带的 UI 元素。可以充分利用现有的原生代码和生态。</li>
<li><strong>瓶颈：</strong> Bridge 的 <strong>JSON 序列化与异步传输</strong> 带来性能开销，尤其在高频度交互或动画时，容易造成卡顿。</li>
</ul>
<h3 data-id="heading-13">2. 🐦 Flutter (Dart + Skia 引擎 + 自绘元件)</h3>
<ul>
<li><strong>技术栈：</strong> Dart 语言。</li>
<li><strong>工作原理：</strong> Flutter 跳过了原生 UI 元件和 Bridge。它自带一个高效的 <strong>Skia 图形渲染引擎</strong>。应用程式启动时，Flutter 创建一个 Canvas（画布），然后在上面用 Dart 代码直接绘制 <strong>自定义的 Widget</strong>。</li>
<li><strong>优势：</strong> <strong>接近原生的性能</strong>，因为它被编译成 ARM 机器码。 UI 表现力强，因为它不依赖原生系统的 UI，实现了 <strong>像素级的控制</strong>。</li>
<li><strong>瓶颈：</strong> 文件体积较大，且没有使用平台原生的 UI 元素，在某些极度依赖原生系统风格的应用上可能显得突兀。</li>
</ul>
<hr/>
<h2 data-id="heading-14">二、选择决策矩阵：五个关键维度</h2>









































<table><thead><tr><th align="left">决策维度</th><th align="left">Flutter (Dart)</th><th align="left">React Native (JS/TS)</th><th align="left">选择建议</th></tr></thead><tbody><tr><td align="left"><strong>1. 团队现有技能</strong></td><td align="left">需要学习 <strong>Dart 语言</strong> 和 Flutter 框架的思维模式。</td><td align="left">技能门槛低，可以重用 <strong>React/Web 前端</strong> 团队的大部分经验。</td><td align="left"><strong>前端背景强</strong>：选 RN；<strong>无历史包袱或有原生背景</strong>：选 Flutter。</td></tr><tr><td align="left"><strong>2. 性能与 UI 复杂度</strong></td><td align="left">性能优异，因其编译为原生机器码，且自绘引擎消除了 Bridge 瓶颈。</td><td align="left">性能良好，但在复杂动画和高频交互上可能因 Bridge 而略输 Flutter。</td><td align="left"><strong>对性能要求极高、复杂动画</strong>：选 Flutter；<strong>标准业务应用</strong>：RN 足够。</td></tr><tr><td align="left"><strong>3. 生态系统与第三方库</strong></td><td align="left"><strong>较新</strong>，社群成长快，但第三方库的数量和成熟度不如 RN。</td><td align="left"><strong>极其庞大和成熟</strong>，大量库可供选择。与原生生态桥接成熟。</td><td align="left"><strong>依赖大量现有轮子</strong>：选 RN；<strong>愿意自建或 Bridge 原生代码</strong>：选 Flutter。</td></tr><tr><td align="left"><strong>4. 开发效率与热重载</strong></td><td align="left">优秀的 <strong>Hot Reload</strong>，但在 <strong>Native Code</strong> 变更时需重新编译。</td><td align="left">拥有 <strong>Fast Refresh</strong>，JS 代码更新极快。原生代码变更也需重新编译。</td><td align="left"><strong>基本持平</strong>；RN 在 JS 迭代上更胜一筹。</td></tr><tr><td align="left"><strong>5. 多平台支持</strong></td><td align="left"><strong>广泛：</strong> iOS, Android, Web, Desktop (Windows, macOS, Linux)。</td><td align="left"><strong>主流：</strong> iOS, Android；Web 需额外使用 React Native for Web。</td><td align="left"><strong>未来可能扩展到桌面端</strong>：选 Flutter；<strong>专注于移动端</strong>：RN 足够。</td></tr></tbody></table>
<p>滑到这里定然有所收获 ⛽️⛽️</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从定时器到 Promise：一次 JS 异步编程的进阶之旅]]></title>    <link>https://juejin.cn/post/7571637614203633691</link>    <guid>https://juejin.cn/post/7571637614203633691</guid>    <pubDate>2025-11-12T11:08:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571637614203633691" data-draft-id="7571644531608469550" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从定时器到 Promise：一次 JS 异步编程的进阶之旅"/> <meta itemprop="keywords" content="JavaScript,面试"/> <meta itemprop="datePublished" content="2025-11-12T11:08:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="T___T"/> <meta itemprop="url" content="https://juejin.cn/user/1599155645973066"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从定时器到 Promise：一次 JS 异步编程的进阶之旅
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1599155645973066/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    T___T
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T11:08:16.000Z" title="Wed Nov 12 2025 11:08:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在学习 JavaScript 的过程中，我们经常会听到“<strong>JS 是单线程语言</strong>”、“<strong>异步操作</strong>”、“<strong>Promise 控制流程</strong>”等概念。它们听起来高深，但其实都是理解 JavaScript 运行机制的关键。本文将从最基础的同步与异步入手，逐步讲清楚 <strong>为什么需要异步</strong>、<strong>异步是如何执行的</strong>、以及 <strong>Promise 是如何让异步代码更优雅地运行的</strong>。</p>
<hr/>
<h2 data-id="heading-0">一、JS 是单线程语言</h2>
<p>JavaScript 是一种<strong>单线程</strong>语言，也就是说，它在同一时刻只能执行一段代码。<br/>
举个简单的例子：</p>
<pre><code class="hljs language-arduino" lang="arduino">console.<span class="hljs-built_in">log</span>(<span class="hljs-number">1</span>);
console.<span class="hljs-built_in">log</span>(<span class="hljs-number">2</span>);
console.<span class="hljs-built_in">log</span>(<span class="hljs-number">3</span>);
</code></pre>
<p>运行结果非常直观：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-number">1</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">2</span> <span class="hljs-punctuation">-&gt;</span><span class="hljs-number">3</span>
</code></pre>
<p>JavaScript 会<strong>从上到下、逐行执行</strong>，这就是 <strong>同步执行</strong>。</p>
<hr/>
<h2 data-id="heading-1">二、为什么需要异步？</h2>
<p>问题在于：当代码中出现“耗时操作”时，例如：</p>
<ul>
<li>读取文件（I/O 操作）</li>
<li>发送网络请求（fetch / ajax）</li>
<li>定时器（setTimeout）</li>
</ul>
<p>如果这些操作是同步的，那么 JS 会<strong>卡死等待结果</strong>，导致页面无法响应用户点击、滚动等操作。</p>
<p>于是，JavaScript 设计了“<strong>异步机制</strong>”：<br/>
耗时的任务不阻塞主线程，而是交给浏览器或 Node.js 的底层去处理，等任务完成后再通知 JS 主线程执行回调函数。</p>
<hr/>
<h2 data-id="heading-2">三、setTimeout：最经典的异步例子</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>);
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">2</span>);
}, <span class="hljs-number">1000</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">3</span>);
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>执行结果为：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-number">1</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">3</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">2</span>
</code></pre>
<p>解释：</p>
<ol>
<li><code>console.log(1)</code> 立即执行。</li>
<li><code>setTimeout</code> 被识别为一个“异步任务”，交给 <strong>浏览器的定时器线程</strong> 去计时。</li>
<li>JS 主线程继续往下执行 <code>console.log(3)</code>。</li>
<li>当计时结束后，回调函数被放入 <strong>事件队列（Event Queue）</strong> 。</li>
<li>主线程空闲时通过 <strong>事件循环（Event Loop）</strong> 取出该回调并执行，于是打印 <code>2</code>。</li>
</ol>
<hr/>
<h2 data-id="heading-3">四、事件循环（Event Loop）简要说明</h2>
<p>事件循环是浏览器或 Node.js 实现异步的核心机制。</p>
<ul>
<li>JS 主线程执行同步代码；</li>
<li>异步任务交给浏览器处理；</li>
<li>当异步任务完成后，其回调函数被放入“任务队列”；</li>
<li>一旦主线程空闲，事件循环会取出这些任务并执行。</li>
</ul>
<p>简单来说：</p>
<blockquote>
<p>同步 → 先执行<br/>
异步 → 等主线程空闲再执行</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">五、Promise：让异步更优雅</h2>
<p>在早期，异步常常通过**回调函数（callback）**实现，但当多个异步操作需要依次执行时，就会出现“<strong>回调地狱</strong>”：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'任务1'</span>);
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'任务2'</span>);
  }, <span class="hljs-number">1000</span>);
}, <span class="hljs-number">1000</span>);
</code></pre>
<p>可读性差、难以维护。<br/>
为了解决这个问题，ES6 引入了 <strong>Promise</strong>。</p>
<hr/>
<h2 data-id="heading-5">六、Promise 的基本使用</h2>
<p>看下面的例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>);

<span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">resolve</span>) {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">2</span>);
    <span class="hljs-title function_">resolve</span>();
  }, <span class="hljs-number">3000</span>);
});

p.<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">3</span>);
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">4</span>);
</code></pre>
<p>输出结果：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-number">1</span><span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">4</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">2</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">3</span>
</code></pre>
<p>分析执行顺序：</p>
<ol>
<li><code>console.log(1)</code>：同步执行。</li>
<li><code>new Promise(...)</code>：立即执行里面的函数（称为 <strong>executor</strong>），但其中的 <code>setTimeout</code> 是异步操作。</li>
<li><code>console.log(4)</code>：继续执行同步任务。</li>
<li>3 秒后，<code>setTimeout</code> 的回调执行，打印 <code>2</code>，同时调用 <code>resolve()</code>。</li>
<li><code>resolve()</code> 触发 <code>then</code> 方法中的回调，打印 <code>3</code>。</li>
</ol>
<p>可以看到，Promise 让异步代码的执行顺序更清晰，结构也更优雅。</p>
<hr/>
<h2 data-id="heading-6">七、结合 Node.js 的异步 I/O 示例</h2>
<p>在 Node.js 中，文件读取就是典型的异步操作：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">'fs'</span>;

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>);

<span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">resolve, reject</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">3</span>); <span class="hljs-comment">// 同步执行</span>
  fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'./b.txt'</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (err) {
      <span class="hljs-title function_">reject</span>(err);
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-title function_">resolve</span>(data.<span class="hljs-title function_">toString</span>());
  });
});

p.<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data, <span class="hljs-string">'//////'</span>);
}).<span class="hljs-title function_">catch</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err, <span class="hljs-string">'读取文件失败'</span>);
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">2</span>);
</code></pre>
<p>执行顺序：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-number">1</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">3</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">2</span> <span class="hljs-punctuation">-&gt;</span> &lt;文件内容&gt; <span class="hljs-comment">///////</span>
</code></pre>
<p>解释：</p>
<ul>
<li><code>fs.readFile</code> 是 Node 的异步 I/O 操作；</li>
<li>读取文件的任务被交给系统底层；</li>
<li>主线程不会等待；</li>
<li>当读取完成后，通过事件循环回到主线程执行 <code>.then()</code>。</li>
</ul>
<hr/>
<h2 data-id="heading-7">八、fetch 与异步请求</h2>
<p>浏览器端的 <code>fetch</code> 也是基于 Promise 的异步操作。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.github.com/orgs/lemoncode/members'</span>));
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>🧠<code>fetch()</code> 返回的是一个 Promise 对象。我们可以使用 <code>.then()</code> 来获取返回的数据：</p>
<pre><code class="hljs language-ini" lang="ini">fetch('https://api.github.com/orgs/lemoncode/members')
  .then(<span class="hljs-attr">res</span> =&gt; res.json())
  .then(<span class="hljs-attr">data</span> =&gt; {
    document.getElementById('member').<span class="hljs-attr">innerHTML</span> =
      data.map(<span class="hljs-attr">item</span> =&gt; `&lt;li&gt;<span class="hljs-variable">${item.login}</span>&lt;/li&gt;`).join(<span class="hljs-string">''</span>)<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h2 data-id="heading-8">九、总结</h2>






























<table><thead><tr><th>概念</th><th>含义</th><th>示例</th></tr></thead><tbody><tr><td><strong>同步代码</strong></td><td>从上到下顺序执行</td><td><code>console.log()</code></td></tr><tr><td><strong>异步代码</strong></td><td>延后执行，不阻塞主线程</td><td><code>setTimeout</code>、<code>fetch</code>、<code>fs.readFile</code></td></tr><tr><td><strong>事件循环</strong></td><td>调度同步和异步任务</td><td>异步任务完成后放入任务队列等待执行</td></tr><tr><td><strong>Promise</strong></td><td>用于优雅地处理异步</td><td><code>.then()</code>、<code>.catch()</code></td></tr></tbody></table>
<blockquote>
<p>🧩<strong>一句话总结：</strong><br/>
JavaScript 虽然是单线程的，但通过事件循环和 Promise 等机制，实现了强大的异步能力，让我们能够同时处理多个任务，而不影响页面或程序的流畅运行。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[让Qwen-VL的检测能力像YOLO一样强，VLM-FO1如何打通大模型的视觉任督二脉]]></title>    <link>https://juejin.cn/post/7571678763782258722</link>    <guid>https://juejin.cn/post/7571678763782258722</guid>    <pubDate>2025-11-13T01:53:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571678763782258722" data-draft-id="7571702660933173263" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="让Qwen-VL的检测能力像YOLO一样强，VLM-FO1如何打通大模型的视觉任督二脉"/> <meta itemprop="keywords" content="算法,计算机视觉,深度学习"/> <meta itemprop="datePublished" content="2025-11-13T01:53:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            让Qwen-VL的检测能力像YOLO一样强，VLM-FO1如何打通大模型的视觉任督二脉
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T01:53:33.000Z" title="Thu Nov 13 2025 01:53:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在当今多模态大模型（VLMs）飞速发展的时代，一个令人尴尬的问题依然存在：<strong>为什么这些能看懂图像、生成描述的模型，却难以精确地定位图像中的物体？</strong></p>
<p>答案在于一个根本性矛盾：让一个为语言生成而设计的模型，去输出精确的浮点数坐标，就像让一位诗人去做微积分——虽然都是处理“符号”，但思维方式截然不同。</p>
<h2 data-id="heading-0"><strong>坐标生成的困境</strong></h2>
<p>现有的多模态大模型在生成边界框时面临两大挑战：</p>
<ul>
<li><strong>格式敏感性：</strong> 一个坐标值的轻微偏差就可能导致整个检测框无效</li>
<li><strong>多实例处理困难：</strong> 长序列的坐标生成容易超出模型的注意力范围</li>
</ul>
<p>结果就是，即使在COCO这样的标准检测数据集上，顶尖的开源VLM模型召回率也不到40%，远低于专用检测器50-60%的水平。</p>
<h2 data-id="heading-1"><strong>VLM-FO1的突破</strong></h2>
<p>浙江大学与Om AI Research团队提出的VLM-FO1框架带来了全新的思路：与其让大模型艰难地生成坐标，不如让它直接理解区域内容。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65ae036ea023406eb4b2efbe03c5d8ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=27TiYCFvcdynPSN933hXx7aapo8%3D" alt="screenshot_2025-11-12_11-28-02.png" loading="lazy"/></p>
<h2 data-id="heading-2"><strong>核心创新</strong></h2>
<ul>
<li><strong>即插即用的模块化设计</strong></li>
</ul>
<p>VLM-FO1不需要重新训练整个大模型，而是作为一个增强模块接入现有的预训练VLM。这意味着开发者可以快速为已有模型赋予检测能力，而不用担心破坏其原有的语言理解能力。</p>
<ul>
<li><strong>双视觉编码器架构</strong></li>
</ul>
<p>团队设计了混合细粒度区域编码器（HFRE），包含两个并行的视觉编码器：</p>
<p>主编码器：沿用原VLM的视觉编码器，提供丰富的语义信息</p>
<p>辅助编码器：采用高分辨率处理的DaViT模型，捕捉细节特征</p>
<p>两者特征融合后，形成了既懂“是什么”又知“在哪里”的区域表示。</p>
<ul>
<li><strong>两阶段训练策略</strong></li>
</ul>
<p>阶段一：只训练新添加的模块，学习将区域特征映射到语言空间</p>
<p>阶段二：开放更多参数进行指令微调，全面提升感知能力</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f29f5f7c52314202818c6e8ef262b915~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=8laX5C0uUAZBfQc9tQ4xcTEnmX4%3D" alt="screenshot_2025-11-12_11-26-41.png" loading="lazy"/></p>
<h2 data-id="heading-3"><strong>性能表现：小模型的大能量</strong></h2>
<p>在多项基准测试中，VLM-FO1展现出了令人印象深刻的性能：</p>
<ul>
<li><strong>目标定位能力显著提升</strong></li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0997010f19be4c958dfcc4b4b2a36dcf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=mBuDkUfK1u6Oj%2F0aIrf4cOQsgzw%3D" alt="screenshot_2025-11-12_11-30-08.png" loading="lazy"/></p>
<p>在COCO目标检测任务上，仅3B参数的VLM-FO1达到了44.4 mAP，比同类VLM方法提升超过20个点，甚至超越了部分专用检测器。</p>
<p>特别是在包含困难负样本的OVDEval数据集上，VLM-FO1的43.7 mAP显著高于Grounding DINO等专业模型，证明其能有效利用大模型的世界知识进行推理。</p>
<ul>
<li><strong>区域理解全面领先</strong></li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50be8eb2999e4d318cf8ea69b84dd313~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=RZYbOIt2J2quS%2BDN5V4vqoVHnAI%3D" alt="screenshot_2025-11-12_11-31-20.png" loading="lazy"/></p>
<p>区域分类：在LVIS数据集上达到92.4% 的语义相似度</p>
<p>区域OCR：在COCO文本上以59.0% 的准确率大幅领先</p>
<p>指代表达理解：在Ferret Bench上以80.1分刷新纪录</p>
<ul>
<li><strong>复杂推理表现出色</strong></li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cc1649f46b14145a29f56dbd1f8efc4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=vwMBkM7B%2B%2FIu3TQeXXpn7NP%2FJxE%3D" alt="screenshot_2025-11-12_11-31-32.png" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c2036b4bab6426082c5cd70c8868d4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=72kVjOhWj1kX0DHe74SkcyC%2Bw1E%3D" alt="screenshot_2025-11-12_11-31-40.png" loading="lazy"/></p>
<p>在需要结合语言理解和视觉定位的指代表达理解任务中，VLM-FO1在多个数据集上保持领先。在对象计数任务中，其“先检测再计数”的策略在PixMo-Count上达到86.0% 的准确率，超越了众多参数量大得多的模型。</p>
<ul>
<li><strong>不影响原有能力：真正的“增强”而非“替换”</strong></li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/745f4d395f604c44a0afcd8665daa367~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=Krm64cVsMnA1fSbUDepKaWDHMoA%3D" alt="screenshot_2025-11-12_11-31-47.png" loading="lazy"/></p>
<p>最令人惊喜的是，VLM-FO1在增强细粒度感知的同时，完全保留了基础模型的通用视觉理解能力。在OpenCompass综合评测中，VLM-FO1-3B与原始Qwen2.5-VL-3B的表现基本持平，证明其没有出现灾难性遗忘。</p>
<h2 data-id="heading-4"><strong>实际应用展示</strong></h2>
<p>论文中展示了丰富的可视化结果，包括：</p>
<ul>
<li><strong>目标检测：</strong> 准确框出人物、笔记本电脑等物体</li>
<li><strong>指代表达理解：</strong> 根据语言描述定位特定对象</li>
<li><strong>对象计数：</strong> 复杂场景下的数量统计</li>
<li><strong>区域描述：</strong> 针对特定区域生成详细描述</li>
<li><strong>视觉推理：</strong> 结合逻辑推理的区域分析</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7958de31e7224590b487a59c5ccb4174~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=BMbPgrxAUVFiu8CZ4rJjQzw%2Ft3g%3D" alt="screenshot_2025-11-12_11-32-23.png" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39b513f6bf304cef9469f683fd994040~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=YcWxza3Hl%2FQW5LZXTYefyIzGihY%3D" alt="screenshot_2025-11-12_11-32-31.png" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3eea2e74b6134450ad3459935266ab92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=24LQ%2FOYh7TnJm2R8Y4YrIW201KM%3D" alt="screenshot_2025-11-12_11-32-38.png" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acc638ac3f22464ab67da8f192d2919d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=bqUrMwtDF9bjnZA3HOPB1DhyS2M%3D" alt="screenshot_2025-11-12_11-33-46.png" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/743a48113571463fb706f6a43aa633b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=od4RRrG%2F38ufKpyLRp3PxJI1gHI%3D" alt="screenshot_2025-11-12_11-52-58.png" loading="lazy"/></p>
<p>特别是在复杂推理任务中，模型能够展示出清晰的思维链条，如通过排除法找到“没有打领带的人”，逐步推理定位“盛放黑色甜甜圈的盘子”。</p>
<h2 data-id="heading-5"><strong>技术启示</strong></h2>
<p>VLM-FO1的成功为多模态大模型的发展提供了重要启示：</p>
<ul>
<li><strong>扬长避短</strong></li>
</ul>
<p>不强求大模型完成所有任务，而是将其核心的语言理解和推理能力与专门的视觉处理模块相结合。</p>
<ul>
<li><strong>模块化设计</strong></li>
</ul>
<p>通过即插即用的方式增强模型能力，避免每次升级都要推倒重来。</p>
<ul>
<li><strong>训练策略创新</strong></li>
</ul>
<p>分阶段、有针对性的训练策略能够在引入新能力的同时保护已有知识。</p>
<h2 data-id="heading-6"><strong>结语</strong></h2>
<p>VLM-FO1架起了一座桥梁，连接了大模型的高层推理能力与细粒度视觉感知需求。这种“理解内容而非生成坐标”的范式转变，不仅解决了当前VLM在定位任务上的瓶颈，更为构建真正理解视觉世界的多模态模型指明了方向。</p>
<p>随着这种技术的成熟，我们离能够真正“看懂”图像、在像素世界中自由“对话”的AI助手又近了一步。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue scoped CSS 与 Element Plus Drawer 样式失效问题深度解析]]></title>    <link>https://juejin.cn/post/7571650164843773986</link>    <guid>https://juejin.cn/post/7571650164843773986</guid>    <pubDate>2025-11-12T11:11:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571650164843773986" data-draft-id="7571559178743365667" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue scoped CSS 与 Element Plus Drawer 样式失效问题深度解析"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-12T11:11:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一只叁木Meow"/> <meta itemprop="url" content="https://juejin.cn/user/231371762837604"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue scoped CSS 与 Element Plus Drawer 样式失效问题深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/231371762837604/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一只叁木Meow
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T11:11:01.000Z" title="Wed Nov 12 2025 11:11:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问题概述</h2>
<p>在使用 Vue 3 + Element Plus 开发组件库时，我们遇到了一个棘手的样式问题：当将 <code>el-drawer</code> 组件抽离到子组件中，并且 <code>el-drawer</code> 直接作为子组件 <code>template</code> 的根元素时，<code>scoped</code> 样式无法正确应用到 drawer 上。然而，当在 <code>el-drawer</code> 外层包装一个 <code>div</code> 容器后，样式又能够正常工作。</p>
<p>这个问题不仅影响了我们的组件抽离工作，也暴露了对 Vue scoped CSS 和 Element Plus 组件内部机制理解的不足。</p>
<h2 data-id="heading-1">问题现象</h2>
<h3 data-id="heading-2">场景一：样式失效的实现</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- problematic-drawer.vue --&gt;
&lt;template&gt;
  &lt;!-- el-drawer 直接作为 template 根元素 --&gt;
  &lt;el-drawer
    :model-value="drawerVisible"
    direction="btt"
    size="300px"
    title="子组件抽屉 - 样式失效"
    @update:model-value="$emit('update:drawerVisible', $event)"
  &gt;
    &lt;div class="drawer-content"&gt;
      这个抽屉的样式无法生效！
    &lt;/div&gt;
  &lt;/el-drawer&gt;
&lt;/template&gt;

&lt;style scoped&gt;
/* 这些样式不会生效 */
:deep(.el-drawer) {
  border-top-left-radius: 20px !important;
  border-top-right-radius: 20px !important;
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
}

:deep(.el-drawer__header) {
  background: rgba(255, 255, 255, 0.1) !important;
  color: white !important;
  border-bottom: 2px solid rgba(255, 255, 255, 0.3) !important;
}

:deep(.el-drawer__body) {
  color: white !important;
  font-size: 16px !important;
}
&lt;/style&gt;
</code></pre>
<p><img src="https://img.sanmu7.com/sanmu/20251112/article-content/d16b48fe-9f7d-4dcd-b82f-b7f46fd656d2.png" alt="1762929206541.png" loading="lazy"/></p>
<h3 data-id="heading-3">场景二：样式正常的实现</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- fixed-drawer.vue --&gt;
&lt;template&gt;
  &lt;!-- el-drawer 被 div 包装 --&gt;
  &lt;div class="drawer-container"&gt;
    &lt;el-drawer
      :model-value="drawerVisible"
      direction="btt"
      size="300px"
      title="修复后的子组件抽屉 - 样式正常"
      @update:model-value="$emit('update:drawerVisible', $event)"
    &gt;
      &lt;div class="drawer-content"&gt;
        现在样式可以正常工作了！
      &lt;/div&gt;
    &lt;/el-drawer&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
/* 这些样式现在可以正常工作 */
.drawer-container :deep(.el-drawer) {
  border-top-left-radius: 20px !important;
  border-top-right-radius: 20px !important;
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%) !important;
}

.drawer-container :deep(.el-drawer__header) {
  background: rgba(255, 255, 255, 0.1) !important;
  color: white !important;
  border-bottom: 2px solid rgba(255, 255, 255, 0.3) !important;
}

.drawer-container :deep(.el-drawer__body) {
  color: white !important;
  font-size: 16px !important;
}
&lt;/style&gt;
</code></pre>
<p><img src="https://img.sanmu7.com/sanmu/20251112/article-content/1a162eb3-ad7b-4ffb-8c6b-df5874d1bad3.png" alt="1762929256553.png" loading="lazy"/></p>
<h2 data-id="heading-4">技术原理解析</h2>
<h3 data-id="heading-5">Vue scoped CSS 的工作机制</h3>
<p>Vue 的 scoped CSS 通过以下两个步骤实现样式隔离：</p>
<ol>
<li><strong>属性注入</strong>：Vue 编译器会给组件模板中的每个元素添加唯一的 <code>data-v-*</code> 属性</li>
<li><strong>选择器重写</strong>：将 CSS 选择器重写为包含对应 <code>data-v-*</code> 属性的选择器</li>
</ol>
<p>例如，对于下面的模板和样式：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="container"&gt;Hello&lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.container { color: red; }
&lt;/style&gt;
</code></pre>
<p>Vue 编译后会变成：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span> <span class="hljs-attr">data-v-xxxxxxx</span>&gt;</span>Hello<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span><span class="hljs-selector-attr">[data-v-xxxxxxx]</span> { <span class="hljs-attribute">color</span>: red; }
</code></pre>
<h3 data-id="heading-6">Element Plus Drawer 的内部机制</h3>
<p>Element Plus 的 <code>el-drawer</code> 组件内部结构较为复杂，它会：</p>
<ol>
<li>创建多个内部 DOM 元素（如 <code>.el-drawer__header</code>、<code>.el-drawer__body</code> 等）</li>
<li>这些内部元素是由组件动态生成的，不会继承父组件的 <code>data-v-*</code> 属性</li>
</ol>
<h3 data-id="heading-7">问题根源分析</h3>
<h4 data-id="heading-8">场景一的问题</h4>
<p>当 <code>el-drawer</code> 直接作为子组件的根元素时：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-drawer&gt;...&lt;/el-drawer&gt;
&lt;/template&gt;

&lt;style scoped&gt;
:deep(.el-drawer) { /* 样式 */ }
&lt;/style&gt;
</code></pre>
<p>编译后的结果：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">el-drawer</span> <span class="hljs-attr">data-v-xxxxxxx</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">el-drawer</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[data-v-xxxxxxx]</span> <span class="hljs-selector-class">.el-drawer</span> { <span class="hljs-comment">/* 样式 */</span> }
</code></pre>
<p><strong>问题在于</strong>：虽然 <code>el-drawer</code> 元素本身有 <code>data-v-xxxxxxx</code> 属性，但 Element Plus 在其内部创建的 <code>.el-drawer__header</code>、<code>.el-drawer__body</code> 等元素<strong>没有这个属性</strong>，导致选择器 <code>[data-v-xxxxxxx] .el-drawer__header</code> 无法匹配到目标元素。</p>
<h4 data-id="heading-9">场景二的解决方案</h4>
<p>当使用 <code>div</code> 包装 <code>el-drawer</code> 时：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="drawer-container"&gt;
    &lt;el-drawer&gt;...&lt;/el-drawer&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.drawer-container :deep(.el-drawer) { /* 样式 */ }
&lt;/style&gt;
</code></pre>
<p>编译后的结果：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"drawer-container"</span> <span class="hljs-attr">data-v-yyyyyyy</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">el-drawer</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">el-drawer</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[data-v-yyyyyyy]</span> <span class="hljs-selector-class">.drawer-container</span> <span class="hljs-selector-class">.el-drawer</span> { <span class="hljs-comment">/* 样式 */</span> }
</code></pre>
<p><strong>为什么能成功</strong>：</p>
<ol>
<li><strong>正确的属性承载</strong>：外层 <code>div</code> 容器获得了 <code>data-v-yyyyyyy</code> 属性</li>
<li><strong>更高的 CSS 特异性</strong>：选择器 <code>[data-v-yyyyyyy] .drawer-container .el-drawer</code> 具有更高的特异性</li>
<li><strong>样式继承和覆盖</strong>：更高特异性的选择器能够成功覆盖 Element Plus 的默认样式</li>
</ol>
<h2 data-id="heading-10">解决方案</h2>
<h3 data-id="heading-11">方案一：容器包装法（推荐）</h3>
<p>这是最简单有效的解决方案：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="drawer-wrapper"&gt;
    &lt;el-drawer
      v-model="visible"
      title="抽屉标题"
    &gt;
      &lt;!-- 抽屉内容 --&gt;
    &lt;/el-drawer&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.drawer-wrapper :deep(.el-drawer) {
  /* 自定义样式 */
  border-radius: 8px;
}

.drawer-wrapper :deep(.el-drawer__header) {
  background: #f0f0f0;
}

.drawer-wrapper :deep(.el-drawer__body) {
  padding: 20px;
}
&lt;/style&gt;
</code></pre>
<h3 data-id="heading-12">方案二：全局样式法</h3>
<p>如果组件需要在多个地方复用，可以考虑使用全局样式：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-drawer
    v-model="visible"
    class="custom-drawer"
    title="抽屉标题"
  &gt;
    &lt;!-- 抽屉内容 --&gt;
  &lt;/el-drawer&gt;
&lt;/template&gt;

&lt;style&gt;
/* 注意：这里没有 scoped */
.custom-drawer {
  border-radius: 8px;
}

.custom-drawer .el-drawer__header {
  background: #f0f0f0;
}

.custom-drawer .el-drawer__body {
  padding: 20px;
}
&lt;/style&gt;
</code></pre>
<h3 data-id="heading-13">方案三：CSS Modules 方案</h3>
<p>使用 CSS Modules 可以避免样式冲突：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-drawer
    v-model="visible"
    :class="$style.customDrawer"
    title="抽屉标题"
  &gt;
    &lt;!-- 抽屉内容 --&gt;
  &lt;/el-drawer&gt;
&lt;/template&gt;

&lt;style module&gt;
.customDrawer {
  border-radius: 8px;
}

.customDrawer :global(.el-drawer__header) {
  background: #f0f0f0;
}

.customDrawer :global(.el-drawer__body) {
  padding: 20px;
}
&lt;/style&gt;
</code></pre>
<h2 data-id="heading-14">最佳实践建议</h2>
<h3 data-id="heading-15">1. 组件结构设计原则</h3>
<ul>
<li><strong>避免直接暴露第三方组件</strong>：尽量用容器元素包装第三方组件</li>
<li><strong>保持组件层级清晰</strong>：每个组件都应该有明确的根容器</li>
<li><strong>考虑样式复用性</strong>：设计时考虑样式是否需要在多个地方复用</li>
</ul>
<h3 data-id="heading-16">2. scoped CSS 使用技巧</h3>
<ul>
<li><strong>合理使用 <code>:deep()</code></strong>：只在必要时使用深度选择器</li>
<li><strong>选择器特异性平衡</strong>：避免过度依赖 <code>!important</code></li>
<li><strong>样式隔离优先</strong>：优先使用 scoped 样式，必要时才使用全局样式</li>
</ul>
<h3 data-id="heading-17">3. 第三方组件集成策略</h3>
<ul>
<li><strong>了解组件内部机制</strong>：使用前了解第三方组件的 DOM 结构</li>
<li><strong>建立组件包装层</strong>：为第三方组件创建包装组件</li>
<li><strong>文档化样式定制</strong>：记录样式定制的最佳实践</li>
</ul>
<h3 data-id="heading-18">4. 开发调试技巧</h3>
<ul>
<li><strong>使用浏览器开发者工具</strong>：检查实际的 DOM 结构和 CSS 选择器</li>
<li><strong>关注编译后的代码</strong>：了解 Vue 编译器如何处理 scoped CSS</li>
<li><strong>建立样式测试</strong>：为关键样式建立测试用例</li>
</ul>
<h2 data-id="heading-19">总结</h2>
<p>Vue scoped CSS 与 Element Plus Drawer 的样式问题，本质上是由 Vue 的样式隔离机制与第三方组件的内部实现之间的冲突造成的。通过添加容器元素，我们为 scoped CSS 提供了正确的属性承载上下文，从而解决了样式匹配问题。</p>
<p>这个问题的解决过程告诉我们：</p>
<ol>
<li><strong>理解底层机制很重要</strong>：深入了解 Vue 和第三方组件的工作原理</li>
<li><strong>简单的解决方案往往有效</strong>：添加容器元素是最简单有效的解决方案</li>
<li><strong>设计时需要考虑扩展性</strong>：良好的组件设计可以避免后续的样式问题</li>
<li><strong>文档化经验很重要</strong>：将遇到的问题和解决方案记录下来，避免重复踩坑</li>
</ol>
<p>希望这篇文章能够帮助开发者更好地理解 Vue scoped CSS 的工作机制，并在实际开发中避免类似的样式问题。</p>
<h2 data-id="heading-20">参考资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2Fapi%2Fsfc-css-features.html%23scoped-css" target="_blank" title="https://vuejs.org/api/sfc-css-features.html#scoped-css" ref="nofollow noopener noreferrer">Vue 3 官方文档 - Scoped CSS</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Felement-plus.org%2F" target="_blank" title="https://element-plus.org/" ref="nofollow noopener noreferrer">Element Plus 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FCSS%2FSpecificity" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/CSS/Specificity" ref="nofollow noopener noreferrer">CSS 特异性计算规则</a></li>
</ul>
<hr/>
<p><em>本文基于实际项目中的问题总结而成，如有不当之处，欢迎指正和讨论。</em></p>
<p>文章最后，给大家介绍一下个人博客网站：<a href="https://link.juejin.cn?target=https%3A%2F%2Fsanmu7.com%2F" target="_blank" title="https://sanmu7.com/" ref="nofollow noopener noreferrer">叁木の小屋</a>。欢迎各位捧场。笔芯❤。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 数组：从内存布局到遍历策略的深度解析]]></title>    <link>https://juejin.cn/post/7571648135585169451</link>    <guid>https://juejin.cn/post/7571648135585169451</guid>    <pubDate>2025-11-12T11:59:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571648135585169451" data-draft-id="7571648135585136683" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 数组：从内存布局到遍历策略的深度解析"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-11-12T11:59:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Zyx2007"/> <meta itemprop="url" content="https://juejin.cn/user/3924597867554890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 数组：从内存布局到遍历策略的深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3924597867554890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Zyx2007
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T11:59:16.000Z" title="Wed Nov 12 2025 11:59:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：数组为何“开箱即用”？</h2>
<p>在 JavaScript 开发中，数组（Array）是最常用、最直观的数据结构。我们几乎每天都在写 <code>const arr = [1, 2, 3]</code>，却很少思考：这个看似简单的结构背后，究竟隐藏着怎样的内存机制与性能权衡？为什么说数组是“开箱即用”的数据结构？它与链表相比有何优劣？不同的遍历方式又如何影响程序效率？</p>
<p>本文将从<strong>内存分配、动态扩容、遍历方法</strong>三个维度，深入剖析 JavaScript 数组的本质，并结合实际代码，揭示高效使用数组的最佳实践。</p>
<hr/>
<h2 data-id="heading-1">一、数组的内存模型：栈与堆的协作</h2>
<h3 data-id="heading-2">1.1 引用类型 vs 值类型</h3>
<p>在 JavaScript 中，数组属于<strong>引用类型</strong>。当我们声明：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]<span class="hljs-comment">;</span>
</code></pre>
<p>实际上发生了两件事：</p>
<ul>
<li><strong>栈内存</strong>中存储变量 <code>arr</code>，其值是一个<strong>指向堆内存的引用地址</strong></li>
<li><strong>堆内存</strong>中分配一块连续空间，存放 <code>[1, 2, 3]</code> 的实际数据</li>
</ul>
<p>这种设计使得多个变量可以共享同一数组（通过引用），也解释了为何修改一个引用会影响所有指向它的变量。</p>
<h3 data-id="heading-3">1.2 数组的创建方式与初始化</h3>
<p>JS 提供多种创建数组的方式，但效果截然不同：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> arr1 = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];               <span class="hljs-comment">// 字面量：元素和长度均确定</span>
<span class="hljs-keyword">const</span> arr2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">3</span>);            <span class="hljs-comment">// 长度为3，但内容为 empty（稀疏数组）</span>
<span class="hljs-keyword">const</span> arr3 = (<span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">3</span>)).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>);  <span class="hljs-comment">// 长度为3，每个元素初始化为0</span>
</code></pre>
<p>特别注意：<code>new Array(3)</code> 创建的是一个<strong>稀疏数组（sparse array）</strong> ，其内部并未真正分配三个值为 <code>undefined</code> 的槽位，而是仅记录长度。这在某些遍历方法（如 <code>forEach</code>）中会导致跳过这些“空洞”。</p>
<p>而 <code>fill(0)</code> 则确保每个位置都被显式赋值，避免意外行为。</p>
<hr/>
<h2 data-id="heading-4">二、动态扩容：便利背后的代价</h2>
<h3 data-id="heading-5">2.1 连续内存的优势与局限</h3>
<p>数组的核心优势在于<strong>连续内存布局</strong>，这使得通过索引访问元素的时间复杂度为 <strong>O(1)</strong> ——无论数组多大，<code>arr[1000]</code> 都能瞬间定位。</p>
<p>然而，连续性也带来了挑战：<strong>当数组容量不足时，必须扩容</strong>。</p>
<p>JavaScript 引擎（如 V8）采用以下策略：</p>
<ol>
<li>申请一块更大的连续内存（通常按倍数增长，如 1.5 倍）</li>
<li>将原数组所有元素<strong>逐个复制</strong>到新内存</li>
<li>释放旧内存</li>
</ol>
<p>这个过程称为“<strong>搬家</strong>”，虽然对开发者透明，但<strong>开销较大</strong>——尤其在频繁 push 大量元素时。</p>
<h3 data-id="heading-6">2.2 数组 vs 链表：动态性的权衡</h3>
<p>笔记中提到：“考虑动态性时，数组比链表差”。这是因为在链表中：</p>
<ul>
<li>插入/删除只需修改指针，无需移动数据</li>
<li>内存可离散分布，无扩容压力</li>
</ul>
<p>但链表也有致命缺点：</p>
<ul>
<li>访问任意元素需从头遍历，时间复杂度 O(n)</li>
<li>每个节点需额外存储指针，内存开销更大</li>
</ul>
<p>因此，在<strong>数据量较小、读多写少</strong>的场景下，数组凭借其缓存友好性和快速随机访问，仍是更优选择。</p>
<blockquote>
<p>正如笔记所言：“少数数据的情况下，数组是更加优秀的。”</p>
</blockquote>
<hr/>
<h2 data-id="heading-7">三、遍历策略：性能与可读性的平衡</h2>
<p>JavaScript 提供多种数组遍历方式，各有适用场景：</p>
<h3 data-id="heading-8">3.1 计数循环（for）</h3>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">len</span> = arr.length<span class="hljs-comment">;</span>
for (let <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; len; i++) {</span>
    console.log(arr<span class="hljs-section">[i]</span>)<span class="hljs-comment">;</span>
}
</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>性能最佳：无函数调用开销，CPU 友好</li>
<li>支持 <code>break</code> 和 <code>continue</code></li>
</ul>
<p><strong>注意</strong>：应缓存 <code>arr.length</code>，避免每次循环都访问对象属性（虽现代引擎已优化，但仍是良好习惯）。</p>
<h3 data-id="heading-9">3.2 for...of</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> item <span class="hljs-keyword">of</span> arr) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(item);
}
</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>可读性强：直接获取元素值，无需索引</li>
<li>支持 <code>break</code>/<code>continue</code></li>
<li>兼容所有可迭代对象（包括字符串、Set 等）</li>
</ul>
<p><strong>适用场景</strong>：只需元素值，不关心索引时。</p>
<h3 data-id="heading-10">3.3 forEach</h3>
<pre><code class="hljs language-javascript" lang="javascript">arr.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(item, index);
});
</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>语义清晰：明确表达“对每个元素执行操作”</li>
<li>自动处理稀疏数组（跳过 empty slots）</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li><strong>无法使用 <code>break</code> 或 <code>continue</code></strong>（会报错）</li>
<li>函数调用带来额外开销（入栈/出栈）</li>
<li>性能低于 for 循环</li>
</ul>
<blockquote>
<p>因此，<strong>性能敏感场景应避免 forEach</strong>。</p>
</blockquote>
<h3 data-id="heading-11">3.4 for...in 的陷阱</h3>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-keyword">key</span> <span class="hljs-keyword">in</span> arr) {
    console.log(<span class="hljs-keyword">key</span>, arr[<span class="hljs-keyword">key</span>]);
}
</code></pre>
<p>虽然数组是对象，<code>for...in</code> 能遍历其索引，但存在严重问题：</p>
<ul>
<li>遍历的是<strong>所有可枚举属性</strong>，包括原型链上的（若未正确设置）</li>
<li>索引以<strong>字符串形式</strong>返回（"0", "1"）</li>
<li>不保证顺序（尽管现代引擎通常按索引顺序）</li>
</ul>
<p><strong>强烈建议</strong>：遍历数组时不要使用 <code>for...in</code>。</p>
<hr/>
<h2 data-id="heading-12">四、实战建议：如何高效使用数组？</h2>
<h3 data-id="heading-13">4.1 初始化时预估容量</h3>
<p>若已知数组大致大小，可预先分配：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = new Array(expectedSize).fill(<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
</code></pre>
<p>减少后续扩容次数。</p>
<h3 data-id="heading-14">4.2 选择合适的遍历方式</h3>

























<table><thead><tr><th>需求</th><th>推荐方法</th></tr></thead><tbody><tr><td>最高性能</td><td><code>for (let i=0; i&lt;len; i++)</code></td></tr><tr><td>只需元素值</td><td><code>for...of</code></td></tr><tr><td>函数式风格</td><td><code>map</code>, <code>filter</code>（但注意性能）</td></tr><tr><td>避免</td><td><code>forEach</code>（需中断时）、<code>for...in</code></td></tr></tbody></table>
<h3 data-id="heading-15">4.3 理解 map 与 forEach 的区别</h3>
<ul>
<li><code>forEach</code>：仅遍历，无返回值</li>
<li><code>map</code>：遍历并<strong>返回新数组</strong>，用于数据转换</li>
</ul>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">const</span> doubled = arr.<span class="hljs-built_in">map</span>(x =&gt; x * <span class="hljs-number">2</span>); <span class="hljs-comment">// [2,4,6,...]</span>
</code></pre>
<p>不要为了遍历而滥用 <code>map</code>——若不需要新数组，用 <code>forEach</code> 或 <code>for...of</code> 更合适。</p>
<hr/>
<h2 data-id="heading-16">结语：理解底层，方能驾驭上层</h2>
<p>JavaScript 数组的“简单”是精心设计的结果。它在连续内存、动态扩容、丰富 API 之间取得了精妙平衡，成为开发者最信赖的工具之一。</p>
<blockquote>
<p>“开箱即用”不等于“无需思考”。<br/>
对数据结构的敬畏，是写出高效、可靠代码的第一步。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS 定位系统全解析：从文档流到 sticky 的实战指南]]></title>    <link>https://juejin.cn/post/7571693273728040996</link>    <guid>https://juejin.cn/post/7571693273728040996</guid>    <pubDate>2025-11-12T12:23:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571693273728040996" data-draft-id="7571657746346131510" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS 定位系统全解析：从文档流到 sticky 的实战指南"/> <meta itemprop="keywords" content="CSS"/> <meta itemprop="datePublished" content="2025-11-12T12:23:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Zyx2007"/> <meta itemprop="url" content="https://juejin.cn/user/3924597867554890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS 定位系统全解析：从文档流到 sticky 的实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3924597867554890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Zyx2007
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T12:23:59.000Z" title="Wed Nov 12 2025 12:23:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：布局的基石——理解“文档流”</h2>
<p>在前端开发中，页面元素如何排列？为何有的元素会“漂浮”起来，而有的始终按顺序堆叠？这一切的答案，都藏在一个核心概念中——<strong>文档流（Document Flow）</strong> 。</p>
<p>文档流是 HTML 元素在页面中的默认布局方式：块级元素垂直排列，行内元素水平排列，整体遵循“从上到下、从左到右”的自然顺序。每个元素默认采用 <strong><code>position: static</code></strong>（静态定位），乖乖待在自己的位置上，既不影响别人，也不被别人影响。</p>
<p>然而，一旦我们引入 CSS 定位（<code>position</code>），元素就可能<strong>离开或部分脱离文档流</strong>，从而实现复杂布局。本文将结合代码实例，深入剖析 <code>relative</code>、<code>absolute</code>、<code>fixed</code>、<code>sticky</code> 四种定位方式的本质区别、使用场景与常见陷阱。</p>
<hr/>
<h2 data-id="heading-1">一、relative：相对定位，不离不弃</h2>
<h3 data-id="heading-2">1.1 行为特征</h3>
<p><code>position: relative</code> 是最温和的定位方式。它让元素<strong>相对于自身原始位置进行偏移</strong>，但关键在于：<strong>它仍然占据文档流中的原始空间</strong>。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 1.html --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"parent"</span>&gt;</span> <span class="hljs-comment">&lt;!-- pink, 500x500 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"child"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span> <span class="hljs-comment">&lt;!-- skyblue --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span> <span class="hljs-comment">&lt;!-- green --&gt;</span>
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.parent</span> {
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">100px</span>;
}
</code></pre>
<p>效果：</p>
<ul>
<li><code>.parent</code> 视觉上向右下移动了 100px</li>
<li>但 <code>.box</code>（绿色方块）依然紧贴在 <code>.parent</code> <strong>原始位置的下方</strong>，仿佛 <code>.parent</code> 没动过</li>
</ul>
<p>这说明：<strong>relative 不脱离文档流</strong>，后续元素仍按标准流对待它。</p>
<h3 data-id="heading-3">1.2 实战价值</h3>
<ul>
<li>作为 <code>absolute</code> 子元素的<strong>定位上下文容器</strong></li>
<li>微调元素位置而不破坏整体布局</li>
<li>配合 <code>z-index</code> 控制层叠顺序</li>
</ul>
<blockquote>
<p>笔记提醒：“用 <code>static</code> 可取消元素的定位属性”——这在动态切换布局时非常有用（如 1.html 中 5 秒后恢复 static）。</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">二、absolute：绝对定位，彻底脱离</h2>
<h3 data-id="heading-5">2.1 脱离文档流</h3>
<p><code>position: absolute</code> 会让元素<strong>完全脱离文档流</strong>。这意味着：</p>
<ul>
<li>原始位置不再被占据</li>
<li>后续元素会“无视”它，直接填补其空缺</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 2.html --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"parent"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"child"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span> <span class="hljs-comment">&lt;!-- absolute --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>123<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>456<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p><code>.child</code> 使用 <code>absolute</code> 后，<code>&lt;div&gt;123&lt;/div&gt;</code> 和 <code>&lt;div&gt;456&lt;/div&gt;</code> 的排布不受其影响。</p>
<h3 data-id="heading-6">2.2 定位参考点：寻找“最近的定位祖先”</h3>
<p>绝对定位的元素不会凭空定位，它需要一个<strong>参考坐标系</strong>。规则如下：</p>
<ol>
<li>向上查找父元素，寻找第一个 <code>position</code> <strong>不为 <code>static</code></strong> 的祖先</li>
<li>若找到，则以该祖先的<strong>边框盒（border box）</strong> 为参考</li>
<li>若未找到，则以 <code>&lt;body&gt;</code> 为参考</li>
</ol>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.parent</span> { <span class="hljs-attribute">position</span>: relative; } <span class="hljs-comment">/* 成为 .child 的定位上下文 */</span>
<span class="hljs-selector-class">.child</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">100px</span>; <span class="hljs-comment">/* 相对于 .parent 内部偏移 */</span>
}
</code></pre>
<p>若 <code>.parent</code> 没有设置 <code>position: relative</code>，<code>.child</code> 将相对于整个页面定位。</p>
<h3 data-id="heading-7">2.3 经典应用：居中技巧</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>);
}
</code></pre>
<p>这是实现<strong>绝对居中</strong>的黄金组合：先移到中心点，再用 <code>transform</code> 反向偏移自身一半尺寸。</p>
<hr/>
<h2 data-id="heading-8">三、fixed：固定定位，锁定视口</h2>
<h3 data-id="heading-9">3.1 以浏览器窗口为基准</h3>
<p><code>position: fixed</code> 是 <code>absolute</code> 的“特殊版本”——它的参考点永远是<strong>浏览器视口（viewport）</strong> ，而非任何父元素。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 3.html --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"child"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"position: fixed; right: 100px; bottom: 100px;"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>无论页面如何滚动，该元素始终固定在距离右下角 100px 的位置。</p>
<h3 data-id="heading-10">3.2 完全脱离文档流</h3>
<p>和 <code>absolute</code> 一样，<code>fixed</code> 元素：</p>
<ul>
<li>不占据原始空间</li>
<li>后续元素会忽略它</li>
<li>可能覆盖其他内容（需注意 <code>z-index</code>）</li>
</ul>
<blockquote>
<p>注意：在移动端，某些浏览器对 <code>fixed</code> 支持不佳（尤其在软键盘弹出时），需谨慎使用。</p>
</blockquote>
<hr/>
<h2 data-id="heading-11">四、sticky：智能粘连，动静结合</h2>
<h3 data-id="heading-12">4.1 hybrid 定位：relative + fixed</h3>
<p><code>position: sticky</code> 是 CSS 最具智慧的定位方式。它表现为：</p>
<ul>
<li><strong>默认行为像 <code>relative</code></strong>：在文档流中正常占位</li>
<li><strong>当滚动到阈值时，行为像 <code>fixed</code></strong>：固定在视口某处</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 4.html --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"position: sticky; top: 100px;"</span>&gt;</span>hello world<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>效果：</p>
<ul>
<li>页面未滚动时，<code>.box</code> 在正常位置</li>
<li>当其<strong>顶部距离视口顶部 ≤ 100px</strong> 时，自动变为 <code>fixed</code>，吸附在 <code>top: 100px</code> 处</li>
<li>向上滚动回原位置时，又恢复为 <code>relative</code></li>
</ul>
<h3 data-id="heading-13">4.2 必须指定阈值</h3>
<p><code>sticky</code> 必须配合 <code>top</code>/<code>bottom</code>/<code>left</code>/<code>right</code> 使用，否则无效。最常见的是 <code>top</code>（用于表头、导航栏固定）。</p>
<h3 data-id="heading-14">4.3 父容器限制</h3>
<p><code>sticky</code> 元素的“固定范围”受其<strong>最近的具有 overflow 非 visible 的祖先</strong>限制。若父容器高度不足，可能无法 sticky 到预期位置。</p>
<hr/>
<h2 data-id="heading-15">五、对比总结：何时使用哪种定位？</h2>









































<table><thead><tr><th>定位类型</th><th>是否脱离文档流</th><th>参考点</th><th>典型用途</th></tr></thead><tbody><tr><td><code>static</code></td><td>否</td><td>—</td><td>默认状态，取消定位</td></tr><tr><td><code>relative</code></td><td>否</td><td>自身原始位置</td><td>微调位置，作为 absolute 容器</td></tr><tr><td><code>absolute</code></td><td>是</td><td>最近的非 static 祖先</td><td>弹窗、tooltip、脱离流的装饰元素</td></tr><tr><td><code>fixed</code></td><td>是</td><td>浏览器视口</td><td>导航栏、返回顶部按钮</td></tr><tr><td><code>sticky</code></td><td><strong>部分</strong></td><td>视口（滚动时）</td><td>表头固定、侧边目录</td></tr></tbody></table>
<blockquote>
<p>特别注意：<code>display: none</code> 与定位无关——它直接<strong>移除元素</strong>，不占空间；而 <code>opacity: 0</code> 仅隐藏视觉，仍占空间（如 2.html 所示）。</p>
</blockquote>
<hr/>
<h2 data-id="heading-16">六、避坑指南：常见误区</h2>
<ol>
<li><strong>误以为 relative 会腾出空间</strong><br/>
→ 错！它只是“视觉偏移”，原始位置仍被占据。</li>
<li><strong>absolute 元素找不到定位祖先</strong><br/>
→ 结果会相对于 body 定位，导致布局错乱。务必检查父容器是否设置了 <code>position: relative/absolute/fixed</code>。</li>
<li><strong>sticky 不生效</strong><br/>
→ 检查是否设置了 <code>top</code> 等阈值；检查父容器是否有 <code>overflow: hidden</code> 限制。</li>
<li><strong>滥用 fixed 导致移动端体验差</strong><br/>
→ 在 iOS Safari 等环境中，fixed 元素可能在输入框聚焦时错位。</li>
</ol>
<hr/>
<h2 data-id="heading-17">结语：定位是布局的灵魂</h2>
<p>CSS 定位系统看似简单，实则蕴含精妙的设计哲学。<code>relative</code> 的克制、<code>absolute</code> 的自由、<code>fixed</code> 的坚定、<code>sticky</code> 的智能，共同构成了现代 Web 布局的强大工具集。</p>
<p>掌握它们的关键，在于理解<strong>文档流</strong>这一底层逻辑。只有明白元素“原本在哪里”，才能精准控制它“应该去哪里”。</p>
<blockquote>
<p>正如笔记开篇所问：“离开文档流？”——答案不是简单的“是”或“否”，而是：<strong>根据需求，恰到好处地脱离或保留</strong>。这才是前端布局的艺术所在。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[WebSocket指南：从原理到生产环境实战]]></title>    <link>https://juejin.cn/post/7571650164843986978</link>    <guid>https://juejin.cn/post/7571650164843986978</guid>    <pubDate>2025-11-12T13:07:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571650164843986978" data-draft-id="7571655312799072282" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="WebSocket指南：从原理到生产环境实战"/> <meta itemprop="keywords" content="前端,WebSocket"/> <meta itemprop="datePublished" content="2025-11-12T13:07:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ZKshun"/> <meta itemprop="url" content="https://juejin.cn/user/4106030135654128"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            WebSocket指南：从原理到生产环境实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4106030135654128/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ZKshun
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T13:07:16.000Z" title="Wed Nov 12 2025 13:07:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.7;font-weight:400;font-size:16px;overflow-x:hidden;color:#212122}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:8px;padding-bottom:8px}.markdown-body h1{color:#a0a0a0;font-size:38px;margin-top:32px;padding-top:32px}.markdown-body h2{color:#fff;background-color:#212122;width:fit-content;border-bottom-right-radius:100px;margin-top:47px;margin-bottom:16px;padding:4px 48px 4px 8px;line-height:1.7;font-size:30px;transition:all .3s ease-out}.markdown-body h2:hover{border-bottom-right-radius:50px;transition:all .3s ease-out}.markdown-body h3{font-size:24px;padding-left:8px;margin-top:32px;border-bottom:2px solid #c6c4c4;line-height:1.7}.markdown-body h4{font-size:20px;padding-left:8px;margin-top:32px;border-bottom:1px solid #ddd}.markdown-body h5{font-size:16px;margin-top:24px}.markdown-body h6{margin-top:16px;line-height:1.1}.markdown-body p{font-size:16px;text-align:start;white-space:normal;text-size-adjust:auto;line-height:2;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%;margin:auto;padding-left:8px;padding-right:8px}.markdown-body hr{border:none;border-top:4px double #212122;margin-top:32px;margin-bottom:32px;text-align:center}.markdown-body hr:after{content:"♥";display:inline-block;position:relative;top:-15px;padding:0 10px;color:#212122;font-size:18px}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f1f1f1;color:#ef7060;font-size:14px;padding:.065em 6px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.7;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);margin:32px 16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-color:#212122;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);background-size:40px}.markdown-body pre&gt;code{font-size:14px;padding:16px 8px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#fff;background:#272822}.markdown-body pre&gt;code::-webkit-scrollbar{height:10px;background-color:#f5f5f5}.markdown-body pre&gt;code::-webkit-scrollbar-track{box-shadow:inset 0 0 6px rgba(0,0,0,.3);border-radius:3px;background-color:#f5f5f5}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{border-radius:3px;box-shadow:inset 0 0 6px rgba(0,0,0,.3);background-color:#555}.markdown-body a{color:#ef7060;padding:2px;text-decoration:none;border-bottom:.125em solid #ef7060;border-radius:2px;box-shadow:inset 0 -.025em 0 #ef7060;transition:box-shadow .27s cubic-bezier(.77,0,.175,1),color .27s cubic-bezier(.77,0,.175,1)}.markdown-body a:focus,.markdown-body a:hover{outline:none;box-shadow:inset 0 -1.5em 0 #ef7060;color:#fff}.markdown-body a:before{content:"⇲ ";vertical-align:top;margin-left:2px;font-family:dart!important;font-size:12px;color:inherit;opacity:.7}.markdown-body table{background:#fbfbfb;border-radius:4px;border-collapse:collapse;margin:auto;padding:5px;width:95%;box-shadow:0 5px 10px rgba(0,0,0,.1);animation:float 5s infinite}.markdown-body table th{color:#fff;background:#212122;border-bottom:1px solid #9ea7af;border-right:1px solid #343a45;font-size:18px;padding:16px;text-align:left;vertical-align:middle}.markdown-body table th:first-child{border-top-left-radius:4px}.markdown-body table th:last-child{border-top-right-radius:4px;border-right:none}.markdown-body table tr{border-top:1px solid #c1c3d1;border-bottom:1px solid #c1c3d1;color:#666b85}.markdown-body table tr:hover td{background:#212122;color:#fff;border-top:1px solid #22262e}.markdown-body table tr:first-child{border-top:none}.markdown-body table tr:last-child{border-bottom:none}.markdown-body table tr:nth-child(odd) td{background:#f1f1f1}.markdown-body table tr:nth-child(odd):hover td{background:#212122}.markdown-body table tr:last-child td:first-child{border-bottom-left-radius:4px}.markdown-body table tr:last-child td:last-child{border-bottom-right-radius:4px}.markdown-body table td{background:#fbfbfb;padding:16px;text-align:left;vertical-align:middle;font-size:16px;border-right:1px solid #c1c3d1}.markdown-body table td:last-child{border-right:0}.markdown-body blockquote{color:#777;padding:1px 16px;margin:24px 0;border-left:4px solid #c6c4c4;background-color:#f1f1f1;transition:all .3s ease-out;border-radius:4px}.markdown-body blockquote:hover{border-left-color:#212122;background-color:#212122;color:#fff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:24px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body span.math{margin-left:32px;font-size:18px;font-weight:700}@media (max-width:720px){.markdown-body h1{font-size:30.4px}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:19.2px}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:12.8px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><h2 data-id="heading-0">一、为什么选 WebSocket ？</h2>
<p>WebSocket是一个在单个TCP连接上实现全双工通信的网络协议，专为web应用设计，由HTML5规范引入前端开发。</p>
<ul>
<li><strong>全双工</strong>：客户端和服务端可以<strong>同时</strong>独立发送和接收数据，不需要像HTTP/HTTPS协议那样只能单次请求-响应</li>
<li><strong>持久连接</strong>：一旦连接建立之后就会保持连接状态，除非有一端取消连接，避免了HTTP的频繁握手开销，适用于实时聊天、需实时获取数据状态等场景</li>
<li><strong>基于HTTP升级</strong>：连接通过HTTP/HTTPS的**"Upgrade"机制**建立（即websocket握手），初始使用ws://或wss://协议</li>
</ul>
<p><strong>适用场景</strong>：实时聊天、在线协作、多人游戏、直播弹幕等需要低延迟、高频率使用的场景</p>
<blockquote>
<p><strong>通信模式对比</strong></p>
<ul>
<li>单工：数据只能单向传输，如服务端推送（SSE）、
</li><li>半双工：数据可以双向传输、但不能同时进行，如常规的REST API、Fetch/XMLHttpRequest</li>
<li>全双工：数据可以双向同时传输，如WebSocket、WebRTC</li>
</ul>
</blockquote>
<p>本文以小编在一个在线代码评测系统使用websocket来实时获取用户代码的评测信息功能，来介绍小编对于websocket的理解！</p>
<h2 data-id="heading-1">二、WebSocket握手与协议升级</h2>
<p><strong>"Upgrade"机制</strong>是一种协议协商方式，允许客户端和服务器在已有HTTP连接的基础上，将通信协议从HTTP切换为另一种协议WebSocket。这一过程又被称为<strong>协议升级</strong>，所以发送websocket请求也可以理解为一次协议升级的过程，具体过程包括：</p>
<ol>
<li>客户端发起websocket请求，该请求的类型会显示为websocket请求，请求头通常包含几个upgrade的关键字段，如下图所示为ws连接的请求头：</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0464b53ea0cb4d728c04e3c884353bd2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWktzaHVu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763557837&amp;x-signature=mxYsfU97IqOlRj7AVK6ccQdQiDY%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d51e6774c52f465faf19ff95dea37c0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWktzaHVu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763557837&amp;x-signature=74EoqYOx%2B3ajfsqjM9WQ7%2BvLfcY%3D" alt="image.png" loading="lazy"/>
2. 如果服务器支持websocket协议并同意升级，他就会返回一个<strong>101 Switching Protocols</strong> 状态码，并且包含特定的响应头：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f82f7372a611418dbd3a00feabf1b228~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWktzaHVu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763557837&amp;x-signature=HO7BH205btco4qWJAdOyohDqYEw%3D" alt="image.png" loading="lazy"/>
3. 一旦客户端收到<strong>101响应，TCP连接就会从HTTP模式切换到WebSocket模式</strong>，就会发生以下变化：</p>
<ul>
<li>后续所有的数据都以<code>WebSocket帧（frame，如下图）</code>格式传输（不再是原来的HTTP提交）</li>
<li>双方可以随时主动发送消息（全双工）</li>
<li>连接保持打开，直到一方发送<code>关闭帧</code>或连接中断。在小编对接的过程中，由于后端同学并没有在沙箱判题结束之后发送关闭帧主动关闭连接通道，所以小编采用的是判断最后一帧信息的状态来主动关闭连接。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c57e33429a194c1daa938a17a859dedf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWktzaHVu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763557837&amp;x-signature=ZLZsqdbkiODvwJgVRl038k4U6b0%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>简言之：WebSocket 不是全新连接，而是"借用"HTTP连接完成一次安全握手后，将通道"改造"为实时通信管道。</p>
</blockquote>
<h2 data-id="heading-2">三、快速上手-基础语法</h2>
<h3 data-id="heading-3">1、创建 WebSocket 连接</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> socket = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-string">'ws://localhost:8080'</span>); <span class="hljs-comment">// 传入后端给你的ws连接地址</span>
</code></pre>
<h3 data-id="heading-4">2、Websocket 的四个事件</h3>
<ul>
<li><code>onopen</code>：连接建立时触发</li>
<li><code>onmessage</code>：收到服务器消息触发</li>
<li><code>onerror</code>：连接发生错误时触发</li>
<li><code>onclose</code>：连接关闭时触发</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript">socket.<span class="hljs-property">onopen</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'连接建立'</span>);
  <span class="hljs-comment">// socket.send('Hello Server!'); 一般在连接建立成功之后就可以给服务端发消息了</span>
};

socket.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到消息:'</span>, event.<span class="hljs-property">data</span>);
  <span class="hljs-comment">// event.data 是服务器发送的数据</span>
};

socket.<span class="hljs-property">onerror</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'错误:'</span>, error);
};

socket.<span class="hljs-property">onclose</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'连接关闭'</span>, event);
};
</code></pre>
<h3 data-id="heading-5">3、发送消息</h3>
<pre><code class="hljs language-javascript" lang="javascript">socket.<span class="hljs-title function_">send</span>(<span class="hljs-string">'Hello Server!'</span>);
</code></pre>
<h3 data-id="heading-6">4、关闭连接</h3>
<pre><code class="hljs language-javascript" lang="javascript">socket.<span class="hljs-title function_">close</span>();
</code></pre>
<h3 data-id="heading-7">5、四种状态</h3>
<p>websocket有四种只读的状态：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// WebSocket 的四种状态常量</span>
<span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">CONNECTING</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// 连接中</span>
<span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">OPEN</span> = <span class="hljs-number">1</span>; <span class="hljs-comment">// 连接已打开，可以通信</span>
<span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">CLOSING</span> = <span class="hljs-number">2</span>; <span class="hljs-comment">// 连接正在关闭中</span>
<span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">CLOSED</span> = <span class="hljs-number">3</span>; <span class="hljs-comment">// 连接已关闭或无法打开</span>

<span class="hljs-comment">// 实例的readyState属性为当前的状态，使用当前状态和四个状态常量对比即可的得到不同的判断条件</span>
<span class="hljs-comment">// 如</span>
<span class="hljs-keyword">if</span>(socket.<span class="hljs-property">readyState</span> === <span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">OPEN</span>){
  <span class="hljs-comment">// 检测连接正常时触发</span>
}
</code></pre>
<h2 data-id="heading-8">四、具体实战例子</h2>
<blockquote>
<p>以下示例为小编自己的项目在通过WebSocket实时获取沙箱判题状态时的实现👇</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eee1fcda4843492cae0c0bcbc37a85fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWktzaHVu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763557837&amp;x-signature=oSmjj4L%2FM1Jbag4o0mj6lNYlk6s%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-scss" lang="scss">用户提交代码
↓
创建提交记录 (HTTP POST)
↓
建立 WebSocket 连接
↓
接收实时消息 → 更新状态 → UI 刷新
↓
收到 final_result → 自动关闭连接
↓
显示最终结果
</code></pre>
<h3 data-id="heading-9">1、用户点击提交按钮</h3>
<p>用户点击提交之后，首先调用提交代码接口，此时服务端就会启动一个<code>沙箱服务</code>，将用户编写的代码作为沙箱的程序代码，并自动运行测试用例至沙箱内，然后响应本次提交的ID至客户端，<strong>客户端立即基于提交ID建立与服务端的WebSocket连接，实时获取沙箱程序的运行状态展示到页面中！</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 调用提交代码接口（传递题目id、代码、语言）</span>
<span class="hljs-keyword">async</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">problemId: <span class="hljs-built_in">number</span>, code: <span class="hljs-built_in">string</span>, language: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-comment">// 1. 发送 HTTP 请求创建提交记录</span>
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/submit'</span>, {
    <span class="hljs-attr">problem_id</span>: problemId,
    code,
    language
  })
  <span class="hljs-keyword">const</span> submit = response.<span class="hljs-property">data</span>

  <span class="hljs-comment">// 2. 自动建立 WebSocket 连接监听结果（传递响应的提交id）</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setupWebSocketConnection</span>(submit.<span class="hljs-property">id</span>)
}
</code></pre>
<h3 data-id="heading-10">2、Websocket连接管理</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 声明一个建立连接类，在类内部再声明一个connect连接方法</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SubmitWebSocket</span> {
  <span class="hljs-comment">// 建立连接方法</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">connect</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-keyword">const</span> url = <span class="hljs-string">`<span class="hljs-subst">${baseUrl}</span>/ws/submit/<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.submitId}</span>?token=<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.token}</span>`</span>
    <span class="hljs-comment">// 1. 实例化一个websocket</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(url)

    <span class="hljs-comment">// 2. 设置消息监听器</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> message = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(event.<span class="hljs-property">data</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">WebSocketMessage</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">onMessage</span>?.(message) <span class="hljs-comment">// 触发回调函数</span>
    }
  }
}
</code></pre>
<h3 data-id="heading-11">3、实时消息处理</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 在 store 中处理 WebSocket 消息</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">setupWebSocketConnection</span>(<span class="hljs-params">submitId: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">const</span> websocket = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SubmitWebSocket</span>(submitId, <span class="hljs-variable language_">this</span>.<span class="hljs-property">token</span>)

  websocket.<span class="hljs-property">onMessage</span> = <span class="hljs-function">(<span class="hljs-params">message: WebSocketMessage</span>) =&gt;</span> {
    <span class="hljs-comment">// 根据消息类型更新状态</span>
    <span class="hljs-keyword">switch</span> (message.<span class="hljs-property">type</span>) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'status_update'</span>:
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentSubmit</span>!.<span class="hljs-property">status</span> = message.<span class="hljs-property">data</span>.<span class="hljs-property">status</span>
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-string">'test_case_result'</span>:
        <span class="hljs-comment">// 更新测试用例结果</span>
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-string">'final_result'</span>:
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentSubmit</span>!.<span class="hljs-property">result</span> = message.<span class="hljs-property">data</span>
        websocket.<span class="hljs-title function_">close</span>() <span class="hljs-comment">// 收到最终结果后关闭连接</span>
        <span class="hljs-keyword">break</span>
    }
  }
}
</code></pre>
<h2 data-id="heading-12">五、生产环境避坑（重点）</h2>
<p>小编在完成这个功能之后，发现<strong>开发环境正常</strong>，但是<strong>生产环境会报错无法升级HTTP-&gt;WebSocket</strong>，经过一个老师的提醒，发现如果使用nginx来部署前端应用，我们还要<strong>完成nginx的相关配置</strong>才能使用WebSocket功能，具体配置如下：</p>
<pre><code class="hljs language-nginx" lang="nginx">server {
  listen 80;
  server_name http://your-domain.com;

  location /ws/ {
    proxy_pass http://localhost:8080; # 你的 WebSocket 服务器地址

    # WebSocket 必需的三行配置
    proxy_http_version 1.1; # 必需：HTTP 1.1 支持协议升级
    proxy_set_header Upgrade $http_upgrade; # 必需：处理升级头
    proxy_set_header Connection "upgrade"; # 必需：设置连接类型
    proxy_read_timeout 3600s; # 重要：长连接超时

    # 可选的基础头信息
    proxy_set_header Host $host;
  }

  # 其它配置...
}
</code></pre>
<p><strong>那么为什么开发环境正常，生产环境却需要进行websocket的相关配置呢？</strong></p>
<ul>
<li><strong>开发环境</strong></li>
</ul>

<pre><code class="hljs language-scss" lang="scss">前端 (http://localhost:<span class="hljs-number">3000</span>)
↓ 直接连接
后端 WebSocket (后端ws接口地址)
</code></pre>
<p>开发环境下前端直连后端服务，不经过Nginx的反向代理，所以可以直接升级为WebSocket连接</p>
<ul>
<li><strong>生产环境（需要Nginx代理）</strong></li>
</ul>

<pre><code class="hljs language-less" lang="less">用户浏览器 → <span class="hljs-selector-tag">Nginx</span> (<span class="hljs-attribute">https</span>:<span class="hljs-comment">//your-domain.com) → 多个后端服务器</span>
</code></pre>
<p>WebSocket 使用 HTTP 协议升级机制，在生产环境下前端调用接口服务需要经过 Nginx代理，所以Nginx需要正确处理这个升级过程</p>
<blockquote>
<p>以上是小编通过自己在websocket功能的实现过程中总结出来的一些东西，如果有误请各位大佬指出，感激不尽！</p>
</blockquote>
<h2 data-id="heading-13">六、状态管理和重连机制</h2>
<p>websocket的连接有时候会意外断开（网络问题、服务器故障等等），为了保证用户体验，对于意外断开的连接一般情况下会有重连机制进行处理</p>
<h3 data-id="heading-14">1. 简单实现</h3>
<p>声明一个标志变量<code>isManualClose</code>表示是否为正常关闭连接，在用户主动关闭连接事件中设置其值为true，其余情况下皆为false，<strong>在连接关闭事件中据此值来决定是否重连</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> isManualClose = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 默认不是手动关闭</span>

ws.<span class="hljs-property">onclose</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (!isManualClose) {
    <span class="hljs-comment">// 只有意外断开才重连</span>
    <span class="hljs-title function_">startReconnect</span>();
  }
};

<span class="hljs-comment">// 用户主动断开连接</span>
disconnectButton.<span class="hljs-property">onclick</span> = <span class="hljs-function">() =&gt;</span> {
  isManualClose = <span class="hljs-literal">true</span>; <span class="hljs-comment">// ⭐ 标记为手动关闭</span>
  ws.<span class="hljs-title function_">close</span>(); <span class="hljs-comment">// 现在 onclose 不会触发重连</span>
};

<span class="hljs-comment">// 用户跳转到其他页面，主动关闭WebSocket</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-function">() =&gt;</span> {
  isManualClose = <span class="hljs-literal">true</span>;
  ws.<span class="hljs-title function_">close</span>();
});
</code></pre>
<blockquote>
<p><code>isManualClose</code>的值可以有很多标识和判断来决定，小编觉得具体的可以与后端的同学一起来制定约束</p>
</blockquote>
<h3 data-id="heading-15">2. 指数退避+有限尝试</h3>
<p>利用指数退避算法来计算重连的间隔，并设置最大间隔来防止客户端无限重连（浪费带宽）。根据业务场景，如需要的话还可以设置最大重连次数，当达到最大重连次数时，停止重连逻辑（有限尝试），思路与指数退避是类似的！</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 关键参数</span>
<span class="hljs-keyword">let</span> reconnectInterval = <span class="hljs-number">1000</span>; <span class="hljs-comment">// 初始间隔：1秒</span>
<span class="hljs-keyword">let</span> maxReconnectInterval = <span class="hljs-number">30000</span>; <span class="hljs-comment">// 最大间隔：30秒</span>
<span class="hljs-keyword">let</span> reconnectDecay = <span class="hljs-number">1.5</span>; <span class="hljs-comment">// 增长倍数：1.5倍</span>
<span class="hljs-keyword">let</span> reconnectAttempts = <span class="hljs-number">0</span>; <span class="hljs-comment">// 重连次数</span>
<span class="hljs-keyword">let</span> maxAttempts = <span class="hljs-number">50</span>; <span class="hljs-comment">// 最大尝试次数</span>

<span class="hljs-comment">// 每次重连时计算新间隔</span>
reconnectInterval = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(reconnectInterval * reconnectDecay, maxReconnectInterval);

<span class="hljs-comment">// 第1次重连: 1秒后</span>
<span class="hljs-comment">// 第2次重连: 1.5秒后 (1000 × 1.5)</span>
<span class="hljs-comment">// 第3次重连: 2.25秒后 (1500 × 1.5)</span>
<span class="hljs-comment">// 第4次重连: 3.375秒后 (2250 × 1.5)</span>
<span class="hljs-comment">// ...</span>
<span class="hljs-comment">// 直到达到最大30秒间隔</span>
<span class="hljs-comment">// 当间隔达到30秒时，重连频率很低，相当于软限制</span>

<span class="hljs-comment">// 判断是否需要重连</span>
<span class="hljs-title function_">shouldReconnect</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> !<span class="hljs-variable language_">this</span>.<span class="hljs-property">isManualClose</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">reconnectAttempts</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxAttempts</span>;
}

<span class="hljs-comment">// 计算下一次重连间隔</span>
<span class="hljs-title function_">calculateNextInterval</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 基础指数退避计算</span>
  reconnectInterval = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(reconnectInterval * reconnectDecay, maxReconnectInterval);
  <span class="hljs-keyword">return</span> reconnectInterval
}

<span class="hljs-comment">// 启动重连</span>
<span class="hljs-title function_">startReconnect</span>(<span class="hljs-params"/>){
  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">shouldReconnect</span>()) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'不满足重连条件，停止重连'</span>);
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-comment">// 避免重复启动（每次重连先清理上一次的定时器）</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">reconnectTimer</span>) {
    <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">reconnectTimer</span>);
  }
  <span class="hljs-comment">// 更新重连状态</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">reconnectAttempts</span>++;<span class="hljs-variable language_">this</span>.<span class="hljs-property">isReconnecting</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-comment">// 计算下一次重连间隔（指数退避）</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentInterval</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calculateNextInterval</span>();

  <span class="hljs-comment">// 设置重连定时器</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">reconnectTimer</span> = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeReconnect</span>(); <span class="hljs-comment">// 需要重新建立ws连接</span>
  },<span class="hljs-variable language_">this</span>.<span class="hljs-property">reconnectInterval</span>);
}

socket.<span class="hljs-property">onclose</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">shouldReconnect</span>()) {
    <span class="hljs-comment">// 只有意外断开才重连</span>
    <span class="hljs-title function_">startReconnect</span>();
  }
};

socket.<span class="hljs-property">onopen</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
  <span class="hljs-comment">// 连接成功时重置所有重连参数</span>
  reconnectInterval = <span class="hljs-number">1000</span>;
  reconnectAttempts = <span class="hljs-number">0</span>;
};
</code></pre>
<h2 data-id="heading-16">七、心跳机制</h2>
<p>websocket的心跳机制作用于检测连接是否真实存活（避免假连接，适用于生产环境），并在连接断开时及时发现。为什么需要心跳？</p>
<ul>
<li>WebSocket 基于 TCP，但 <code>TCP Keep-Alive</code> 默认关闭或周期极长</li>
<li>中间设备（如我们使用的Nginx代理）一般会设置<strong>空闲超时</strong></li>
<li>若应用层长时间无数据传输，<strong>连接会被静默断开，而客户端毫无感知</strong></li>
</ul>
<p>以下为基于<strong>Ping-Pong模型</strong>实现的心跳机制简易版：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> heartbeatInterval; <span class="hljs-comment">// 心跳定时器</span>
<span class="hljs-keyword">let</span> heartbeatIntervalTime = <span class="hljs-number">30000</span>; <span class="hljs-comment">// 心跳间隔时间（毫秒），默认30秒</span>
<span class="hljs-comment">// 注意：心跳间隔 &lt; min(防火墙超时, 服务端超时, 客户端容忍延迟) / 2 ，否则无效</span>
<span class="hljs-keyword">let</span> heartbeatTimeout; <span class="hljs-comment">// 心跳超时定时器</span>
<span class="hljs-keyword">let</span> heartbeatTimeoutTime = <span class="hljs-number">5000</span>; <span class="hljs-comment">// 心跳超时时间（毫秒），默认5秒</span>

socket.<span class="hljs-property">onopen</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// 其余代码...</span>
  <span class="hljs-comment">// 在连接成功之后启动心跳机制</span>
  <span class="hljs-title function_">startHeartbeat</span>();
}

<span class="hljs-comment">// 收到服务器消息时触发判断</span>
socket.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// 处理心跳响应</span>
  <span class="hljs-keyword">if</span>(event.<span class="hljs-property">data</span> === <span class="hljs-string">'pong'</span>){
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到心跳响应！'</span>);
    <span class="hljs-keyword">if</span>(heartbeatTimeout){
      <span class="hljs-built_in">clearTimeout</span>(heartbeatTimeout);
    }
    <span class="hljs-keyword">return</span>
  }
  <span class="hljs-comment">// 其它代码...</span>
}

<span class="hljs-comment">// 连接关闭时触发</span>
socket.<span class="hljs-property">onclose</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// 其它代码...</span>
  <span class="hljs-comment">// 停止心跳机制</span>
  <span class="hljs-title function_">stopHeartbeat</span>();
  <span class="hljs-comment">// 判断是否需要重连...</span>
}

<span class="hljs-comment">// 发生错误时触发</span>
socket.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// other...</span>
  <span class="hljs-comment">// 停止心跳机制</span>
  <span class="hljs-title function_">stopHeartbeat</span>();
}

<span class="hljs-comment">// 启动心跳机制</span>
<span class="hljs-title function_">startHeartbeat</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 清除之前的心跳定时器</span>
  <span class="hljs-keyword">if</span> (heartbeatInterval) {
    <span class="hljs-built_in">clearInterval</span>(heartbeatInterval);
  }
  <span class="hljs-comment">// 设置心跳定时器，定期发送心跳消息</span>
  heartbeatInterval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (socket &amp;&amp; socket.<span class="hljs-property">readyState</span> === <span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">OPEN</span>) {
      socket.<span class="hljs-title function_">send</span>(<span class="hljs-string">'ping'</span>);
      <span class="hljs-comment">// 设置心跳超时定时器（目的是检测是否收到pong）</span>
      heartbeatTimeout = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'心跳超时，连接可能已断开'</span>);
        <span class="hljs-title function_">addMessage</span>(<span class="hljs-string">'心跳超时，连接可能已断开'</span>, <span class="hljs-string">'received'</span>);
        <span class="hljs-comment">// 主动关闭连接以触发重连机制</span>
        <span class="hljs-keyword">if</span> (socket) {
          socket.<span class="hljs-title function_">close</span>();
        }
      }, heartbeatTimeoutTime);
    }
  }, heartbeatIntervalTime);
}

<span class="hljs-comment">// 停止心跳机制</span>
<span class="hljs-title function_">stopHeartbeat</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (heartbeatInterval) {
    <span class="hljs-built_in">clearInterval</span>(heartbeatInterval);
    heartbeatInterval = <span class="hljs-literal">null</span>;
  }
  <span class="hljs-keyword">if</span> (heartbeatTimeout) {
    <span class="hljs-built_in">clearTimeout</span>(heartbeatTimeout);
    heartbeatTimeout = <span class="hljs-literal">null</span>;
  }
}
</code></pre>
<h2 data-id="heading-17">八、消息队列与流量控制</h2>
<p>如果你使用的websocket涉及到大量、密集的消息需要同段事件发送，为了防止网络拥塞，可以通过消息队列来进行缓冲，将待发送的消息推入消息队列缓冲，以此保证消息数据在网络拥塞/连接断开的时候不会丢失。</p>
<p>消息队列的工作流程大致为：</p>
<pre><code class="hljs">应用层发送消息
↓
检查连接状态
↓
连接可用 → 立即发送
连接不可用 → 加入队列
↓
监听连接恢复事件
↓
连接恢复 → 按顺序发送队列中消息
↓
发送成功 → 从队列移除
发送失败 → 标记重试或丢弃
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> messageQueue = []; <span class="hljs-comment">// 消息队列</span>
<span class="hljs-keyword">let</span> isSending = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 是否正在发送消息</span>
<span class="hljs-keyword">let</span> sendRateLimit = <span class="hljs-number">10</span>; <span class="hljs-comment">// 每秒最大发送消息数</span>
<span class="hljs-keyword">let</span> sendInterval = <span class="hljs-number">1000</span> / sendRateLimit; <span class="hljs-comment">// 发送间隔（毫秒）</span>
<span class="hljs-keyword">let</span> sendTimer = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 发送定时器</span>

socket.<span class="hljs-property">onopen</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// 其余代码...</span>
  <span class="hljs-comment">// 开始处理消息队列</span>
  <span class="hljs-title function_">processMessageQueue</span>();
}

<span class="hljs-comment">// 连接关闭时触发</span>
socket.<span class="hljs-property">onclose</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// 其它代码...</span>
  <span class="hljs-comment">// 停止消息推送</span>
  <span class="hljs-title function_">stopMessageSending</span>();
  <span class="hljs-comment">// 判断是否需要重连...</span>
}

<span class="hljs-comment">// 发生错误时触发</span>
socket.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// other...</span>
  <span class="hljs-comment">// 停止消息推送</span>
  <span class="hljs-title function_">stopMessageSending</span>();
}

<span class="hljs-comment">// 将消息添加到队列</span>
<span class="hljs-title function_">enqueueMessage</span>(<span class="hljs-params">message, priority = <span class="hljs-number">0</span></span>) {
  <span class="hljs-comment">// 创建消息对象</span>
  <span class="hljs-keyword">const</span> messageObj = {
    <span class="hljs-attr">content</span>: message,
    <span class="hljs-attr">priority</span>: priority, <span class="hljs-comment">// 优先级，数值越大优先级越高</span>
    <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() <span class="hljs-comment">// 时间戳</span>
  };

  <span class="hljs-comment">//if (priority &gt; 0) {</span>
  <span class="hljs-comment">// //根据优先级插入消息队列</span>
  <span class="hljs-comment">//} else {</span>
  <span class="hljs-comment">// // 普通消息添加到队列末尾</span>
  <span class="hljs-comment">//}</span>

  messageQueue.<span class="hljs-title function_">push</span>(messageObj);
}

<span class="hljs-comment">// 处理消息队列</span>
<span class="hljs-title function_">processMessageQueue</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (sendTimer) {
    <span class="hljs-built_in">clearInterval</span>(sendTimer);
  }
  <span class="hljs-comment">// 定时处理消息队列</span>
  sendTimer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (messageQueue.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> &amp;&amp; socket &amp;&amp; socket.<span class="hljs-property">readyState</span> === <span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">OPEN</span>) {
      <span class="hljs-comment">// 取出队列中的第一条消息</span>
      <span class="hljs-keyword">const</span> messageObj = messageQueue.<span class="hljs-title function_">shift</span>();
      socket.<span class="hljs-title function_">send</span>(messageObj.<span class="hljs-property">content</span>);
    }
  }, sendInterval);
}

<span class="hljs-comment">// 停止消息发送</span>
<span class="hljs-title function_">stopMessageSending</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (sendTimer) {
    <span class="hljs-built_in">clearInterval</span>(sendTimer);
    sendTimer = <span class="hljs-literal">null</span>;
  }
}

<span class="hljs-comment">// 设置发送速率（每秒消息数）</span>
<span class="hljs-title function_">setSendRate</span>(<span class="hljs-params">rate</span>) {
  <span class="hljs-keyword">if</span> (rate &gt; <span class="hljs-number">0</span> &amp;&amp; rate &lt;= <span class="hljs-number">100</span>) {
    sendRateLimit = rate;
    sendInterval = <span class="hljs-number">1000</span> / sendRateLimit;

    <span class="hljs-comment">// 重新启动消息处理定时器</span>
    <span class="hljs-keyword">if</span> (socket &amp;&amp; socket.<span class="hljs-property">readyState</span> === <span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">OPEN</span>) {
      <span class="hljs-title function_">processMessageQueue</span>();
    }
  }
}
</code></pre>
<blockquote>
<p>本文到此结束，文中的理解和总结难免有不足之处，如有纰漏或错误，请大家直接指出，小编虚心求教！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[当递归引爆调用栈：你的前端应用还能优雅降落吗？]]></title>    <link>https://juejin.cn/post/7571678388954021907</link>    <guid>https://juejin.cn/post/7571678388954021907</guid>    <pubDate>2025-11-12T13:18:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571678388954021907" data-draft-id="7571646669202030634" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="当递归引爆调用栈：你的前端应用还能优雅降落吗？"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-11-12T13:18:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小时前端"/> <meta itemprop="url" content="https://juejin.cn/user/1197805741808339"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            当递归引爆调用栈：你的前端应用还能优雅降落吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1197805741808339/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小时前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T13:18:43.000Z" title="Wed Nov 12 2025 13:18:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">前言</h2>
<p>“今天我们聊聊前端性能中一个隐蔽而关键的角落——递归优化。不过在深入之前，我想先分享一个视角。”</p>
<p>“在我们团队看来，前端代码不仅是实现业务逻辑的工具，更是<strong>用户设备资源的管家</strong>。一个在后端看似无害的深度递归，传递到用户浏览器中，就可能成为耗尽内存、导致页面卡顿甚至崩溃的元凶。”</p>
<p>“因此，当我考察一个候选人对性能优化的理解时，我核心关注的不是他记住了多少API，而是他是否具备一种 <strong>‘执行上下文感知’</strong> 的视角。他是否明白，我们的工作目标，不仅是实现功能，更是要<strong>在有限的内存和计算资源中，构建出最优雅、最高效的执行路径</strong>。”</p>
<p>“这意味着，你需要去理解代码在引擎中的执行过程——调用栈如何增长、内存如何分配、垃圾回收如何工作——并为潜在的资源瓶颈设计<strong>更优的算法和数据结构</strong>。”</p>
<p>“所以，今天的问题不仅仅是关于‘尾递归’这个具体概念，我更想听到的是，你如何<strong>从引擎层面</strong>思考、分析和优化一段看似简单的递归代码。让我们就从这里开始聊起吧。”</p>
<p>当我问起这个问题时，我不仅仅是想听几个名词。我想考察的是：</p>
<ol>
<li><strong>深度</strong>：你对递归的理解是否停留在“函数调用自身”的层面？</li>
<li><strong>原理</strong>：你是否理解调用栈的工作原理和内存管理机制？</li>
<li><strong>实践</strong>：你是否有过实际的性能问题排查经验，或者至少思考过优化方案？</li>
<li><strong>标准认知</strong>：你是否了解语言特性在理论标准和现实实现之间的差距？</li>
</ol>
<p>下面，我们就从“尾递归优化”这个点切入，系统地聊一聊。</p>
<h2 data-id="heading-1">一、核心理念：递归的性能瓶颈不在计算，而在内存</h2>
<p>首先要明确，递归问题的性能瓶颈往往不是计算复杂度，而是<strong>空间复杂度</strong>——具体来说，是调用栈的深度限制。</p>
<ul>
<li><strong>普通递归</strong>：每次递归调用都会在调用栈中创建一个新的栈帧，保存当前函数的执行上下文。</li>
<li><strong>尾递归</strong>：通过特定的代码结构，让引擎有机会复用栈帧，将空间复杂度从O(n)降为O(1)。</li>
</ul>
<p>所以，递归优化的核心是围绕着“如何减少调用栈的深度消耗”来展开的。</p>
<h2 data-id="heading-2">二、普通递归 vs 尾递归：从栈溢出到无限可能</h2>
<p><strong>1. 面试官想听到什么？</strong>
他希望你不仅知道尾递归的概念，更能从调用栈的角度解释清楚为什么尾递归可以优化，以及这种优化带来的实际价值。如果你能提到具体的空间复杂度变化，说明你对性能分析有扎实的基础。</p>
<p><strong>2. 普通递归的困境</strong>
让我们用经典的阶乘函数举例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 普通递归 - 清晰的思维模型，但存在性能隐患</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">factorial</span>(<span class="hljs-params">n</span>) {
  <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> n * <span class="hljs-title function_">factorial</span>(n - <span class="hljs-number">1</span>); <span class="hljs-comment">// 问题所在！</span>
  }
}

<span class="hljs-title function_">factorial</span>(<span class="hljs-number">5</span>); <span class="hljs-comment">// 120</span>
</code></pre>
<p><strong>执行过程分析：</strong></p>
<ul>
<li><code>factorial(5)</code> 等待 <code>factorial(4)</code> 的结果来计算 <code>5 * ...</code></li>
<li><code>factorial(4)</code> 等待 <code>factorial(3)</code> 的结果来计算 <code>4 * ...</code></li>
<li>以此类推...</li>
<li>每个函数都在等待，但它们的执行上下文都被压在调用栈中</li>
</ul>
<pre><code class="hljs language-scss" lang="scss">调用栈增长过程：
| <span class="hljs-built_in">factorial</span>(<span class="hljs-number">1</span>) |  &lt;- 栈顶
| <span class="hljs-built_in">factorial</span>(<span class="hljs-number">2</span>) |
| <span class="hljs-built_in">factorial</span>(<span class="hljs-number">3</span>) |
| <span class="hljs-built_in">factorial</span>(<span class="hljs-number">4</span>) |
| <span class="hljs-built_in">factorial</span>(<span class="hljs-number">5</span>) |  &lt;- 栈底
</code></pre>
<p>当n足够大时（比如100000），调用栈深度超出引擎限制，就会发生<strong>栈溢出</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">factorial</span>(<span class="hljs-number">100000</span>); <span class="hljs-comment">// RangeError: Maximum call stack size exceeded</span>
</code></pre>
<p><strong>3. 尾递归的解决方案</strong>
将函数改写成尾递归形式：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 尾递归版本 - 性能优化，但需要思维转换</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">factorial</span>(<span class="hljs-params">n, total = <span class="hljs-number">1</span></span>) {
  <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">return</span> total;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">factorial</span>(n - <span class="hljs-number">1</span>, n * total); <span class="hljs-comment">// 关键变化！</span>
  }
}

<span class="hljs-title function_">factorial</span>(<span class="hljs-number">5</span>); <span class="hljs-comment">// 120</span>
</code></pre>
<p><strong>执行过程分析：</strong></p>
<ul>
<li><code>factorial(5, 1)</code> 直接返回 <code>factorial(4, 5)</code></li>
<li><code>factorial(4, 5)</code> 直接返回 <code>factorial(3, 20)</code></li>
<li>以此类推...</li>
<li>每个函数在返回时都<strong>不再需要当前的执行上下文</strong></li>
</ul>
<pre><code class="hljs language-scss" lang="scss">调用栈保持平坦：
| <span class="hljs-built_in">factorial</span>(<span class="hljs-number">5</span>, <span class="hljs-number">1</span>) | -&gt; | <span class="hljs-built_in">factorial</span>(<span class="hljs-number">4</span>, <span class="hljs-number">5</span>) | -&gt; | <span class="hljs-built_in">factorial</span>(<span class="hljs-number">3</span>, <span class="hljs-number">20</span>) | -&gt; ...
</code></pre>
<p><strong>4. 如何回答（展现你的原理理解）</strong>
“普通递归和尾递归的核心区别在于调用栈的管理方式。普通递归每次调用都会保留当前函数的栈帧，导致空间复杂度为O(n)，容易栈溢出。而尾递归通过确保函数的最后一步只是递归调用自身，让引擎有机会复用当前栈帧，将空间复杂度降为O(1)。这就像多人接力赛跑——普通递归是每个人都站在原地等待结果，而尾递归是直接把手里的接力棒传给下一个人，自己就可以离开了。”</p>
<h2 data-id="heading-3">三、尾调用优化：理论的美好与现实的骨感</h2>
<p><strong>1. 面试官想听到什么？</strong>
候选人需要了解ES6标准中规定了尾调用优化，但也要清楚知道这个特性在主流浏览器中的实现现状。这考察的是你对Web标准演进和工程实践落差的认知。</p>
<p><strong>2. 理论上的完美方案</strong>
根据ES6标准，尾调用优化应该这样工作：</p>
<ul>
<li>当函数B在函数A的尾部被调用时，引擎可以重用函数A的栈帧</li>
<li>调用栈深度保持不变，避免栈溢出</li>
<li>内存使用保持恒定，不受递归深度影响</li>
</ul>
<p><strong>3. 现实中的实现困境</strong>
然而，现实是骨感的：</p>
<ul>
<li><strong>Chrome (V8)</strong>：默认未启用，需要特殊flag</li>
<li><strong>Firefox</strong>：曾经实现，但在某些版本中又移除了</li>
<li><strong>Safari</strong>：是目前对TCO支持最好的，但也不是默认开启</li>
<li><strong>Node.js</strong>：需要<code>--harmony_tailcalls</code>flag，且该flag已被标记为过时</li>
</ul>
<p><strong>4. 如何回答（展现你的工程实践认知）</strong>
“虽然尾递归在理论上是解决递归性能问题的银弹，但在当前的工程实践中，我们需要保持谨慎。ES6标准确实规定了尾调用优化，但主流浏览器引擎出于调试体验和性能权衡的考虑，大多没有默认启用这个特性。这意味着，即使我们写了符合规范的尾递归代码，在生产环境中也可能无法享受到优化好处。”</p>
<h2 data-id="heading-4">四、超越尾递归：构建完整的递归优化方案</h2>
<p>一个优秀的候选人，还能聊到更多实际解决方案。我会把这些视为"惊喜"。</p>
<p><strong>1. 迭代方案：最可靠的替代</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 迭代版本 - 生产环境的首选</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">factorial</span>(<span class="hljs-params">n</span>) {
  <span class="hljs-keyword">let</span> result = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">2</span>; i &lt;= n; i++) {
    result *= i;
  }
  <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p><strong>2. Trampoline模式：手动管理调用栈</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 通过循环+函数包装来模拟尾递归优化</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">trampoline</span>(<span class="hljs-params">fn</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">let</span> result = <span class="hljs-title function_">fn</span>(...args);
    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">typeof</span> result === <span class="hljs-string">'function'</span>) {
      result = <span class="hljs-title function_">result</span>();
    }
    <span class="hljs-keyword">return</span> result;
  };
}

<span class="hljs-keyword">const</span> factorial = <span class="hljs-title function_">trampoline</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">n, total = <span class="hljs-number">1</span></span>) {
  <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> total;
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">factorial</span>(n - <span class="hljs-number">1</span>, n * total);
});
</code></pre>
<p><strong>3. 算法层面优化</strong></p>
<ul>
<li><strong>记忆化</strong>：缓存已计算结果，避免重复计算</li>
<li><strong>问题分解</strong>：将大问题拆分为可并行处理的子问题</li>
<li><strong>早期终止</strong>：在满足条件时提前返回，减少递归深度</li>
</ul>
<h2 data-id="heading-5">面试官总结：我心目中的理想回答</h2>
<p>一个让我眼前一亮的回答，应该是这样的：</p>
<p>"对于递归优化，我认为需要从理论原理和工程实践两个层面来考虑：</p>
<p>从<strong>原理层面</strong>，我理解尾递归通过改变递归调用的位置，让函数在返回时不再依赖当前的执行上下文，从而为引擎提供了复用栈帧的可能性。这种优化能将空间复杂度从O(n)降为O(1)，从根本上解决栈溢出问题。</p>
<p>从<strong>实践层面</strong>，我知道虽然ES6标准规定了尾调用优化，但由于调试体验和实现复杂度的考虑，主流浏览器引擎大多没有默认启用。因此在生产环境中，我更倾向于使用迭代方案来替代深度递归，或者在必要时使用Trampoline这样的技术来手动模拟尾递归优化。</p>
<p>总之，理解尾递归不仅是为了应对面试问题，更是为了培养一种'执行上下文感知'的编程思维——在实现功能的同时，始终关注代码在引擎中的实际执行过程。"</p>
<p><strong>思考题：</strong> 在你的项目中，是否遇到过因为递归导致的性能问题？你是如何发现并解决的？欢迎在评论区分享你的实战经验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vibe Coding 实战教学：用 Trae 协作开发 Chrome 扩展 “Hulk”]]></title>    <link>https://juejin.cn/post/7571725550709178395</link>    <guid>https://juejin.cn/post/7571725550709178395</guid>    <pubDate>2025-11-12T14:22:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571725550709178395" data-draft-id="7571695634942197787" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vibe Coding 实战教学：用 Trae 协作开发 Chrome 扩展 “Hulk”"/> <meta itemprop="keywords" content="前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-12T14:22:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="神秘的猪头"/> <meta itemprop="url" content="https://juejin.cn/user/793223472877051"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vibe Coding 实战教学：用 Trae 协作开发 Chrome 扩展 “Hulk”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/793223472877051/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    神秘的猪头
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T14:22:47.000Z" title="Wed Nov 12 2025 14:22:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、什么是 Vibe Coding？</h2>
<p>Vibe Coding 是一种以“氛围”和“上下文”为核心的新型编程协作范式。它强调：</p>
<ul>
<li><strong>人与 AI 编程助手（如 Trae）的深度协作</strong></li>
<li><strong>文档 &gt; 代码</strong>：清晰的需求、设计稿、接口说明是生成高质量代码的前提</li>
<li><strong>开发者角色转变</strong>：从写每一行代码，变为提供上下文、监督逻辑、把控质量</li>
</ul>
<p>在 Vibe Coding 模式下，我们不再执着于“手敲代码”，而是专注于：</p>
<ul>
<li>写好需求文档</li>
<li>绘制线框图或设计稿</li>
<li>规划项目结构</li>
<li>定义交互流程</li>
</ul>
<p>AI（如 Trae）则负责将这些“vibe”转化为可运行的代码。</p>
<hr/>
<h2 data-id="heading-1">二、实战目标：开发 Chrome 扩展 “Hulk”</h2>
<p>我们将使用 Vibe Coding 的方式，与 Trae 合作开发一个名为 <strong>Hulk</strong> 的 Chrome 扩展程序。</p>
<h3 data-id="heading-2">功能需求（需求文档）</h3>
<ul>
<li>
<p>用户点击扩展图标，弹出 popup 窗口</p>
</li>
<li>
<p>窗口中显示：</p>
<ul>
<li>标题：“改变背景颜色”</li>
<li>提示文字：“点击下方按钮将当前页面背景色改为绿色”</li>
<li>一个按钮：“改变颜色”</li>
</ul>
</li>
<li>
<p>点击按钮后，<strong>当前网页的背景色变为绿色</strong></p>
</li>
</ul>
<h3 data-id="heading-3">设计参考（UX 设计稿）</h3>
<blockquote>
<p>假设你已提供 <code>ux.jpg</code>，其中展示了 popup 的布局：简洁卡片式 UI，居中文字 + 按钮。</p>
</blockquote>
<h3 data-id="heading-4">技术约束</h3>
<ul>
<li>使用 <code>icons/</code> 文件夹中的图标作为扩展图标</li>
<li>使用标准 Chrome Extension Manifest V3 架构</li>
<li>不依赖外部库（纯 HTML/CSS/JS）</li>
</ul>
<hr/>
<h2 data-id="heading-5">三、为 Trae 提供完整上下文（Vibe 准备）</h2>
<p>为了让 Trae 高效生成代码，我们需要提供以下“vibe”材料：</p>

























<table><thead><tr><th>类型</th><th>内容</th></tr></thead><tbody><tr><td><strong>需求文档</strong></td><td>如上所述的功能描述</td></tr><tr><td><strong>设计稿</strong></td><td><code>ux.jpg</code>（视觉参考）</td></tr><tr><td><strong>目录结构规划</strong></td><td>明确文件组织</td></tr><tr><td><strong>技术栈说明</strong></td><td>Manifest V3、popup、content script</td></tr></tbody></table>
<h3 data-id="heading-6">规划项目目录结构</h3>
<pre><code class="hljs language-bash" lang="bash">hulk-extension/
├── manifest.json          <span class="hljs-comment"># 扩展配置</span>
├── icons/
│   ├── icon16.png
│   ├── icon48.png
│   └── icon128.png
├── popup/
│   ├── index.html         <span class="hljs-comment"># 弹窗页面</span>
│   ├── style.css          <span class="hljs-comment"># 弹窗样式</span>
│   └── script.js          <span class="hljs-comment"># 弹窗逻辑</span>
└── content.js             <span class="hljs-comment"># 注入页面，修改背景色</span>
</code></pre>
<hr/>
<h2 data-id="heading-7">四、Trae 生成的代码（基于上述上下文）</h2>
<blockquote>
<p>下面是 Trae 在接收到完整上下文后，应能自动生成的代码。</p>
</blockquote>
<h3 data-id="heading-8">1. <code>manifest.json</code></h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"manifest_version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Hulk"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"一键将网页背景变为绿色！"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"icons"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"16"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"icons/icon16.png"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"48"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"icons/icon48.png"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"128"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"icons/icon128.png"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"default_popup"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"popup/index.html"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"default_title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Hulk - Change Background to Green"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"content_scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"matches"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"&lt;all_urls&gt;"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"js"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"content.js"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"permissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-9">2. <code>popup/index.html</code></h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"style.css"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>改变背景颜色<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>点击下方按钮将当前页面背景色改为绿色<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"changeColor"</span>&gt;</span>改变颜色<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"script.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-10">3. <code>popup/style.css</code></h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">body</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">250px</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">font-family</span>: -apple-system, BlinkMacSystemFont, sans-serif;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
  <span class="hljs-attribute">line-height</span>: <span class="hljs-number">1.5</span>;
}

<span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">text-align</span>: center;
}

<span class="hljs-selector-tag">button</span> {
  <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">12px</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span> <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#4CAF50</span>;
  <span class="hljs-attribute">color</span>: white;
  <span class="hljs-attribute">border</span>: none;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
  <span class="hljs-attribute">cursor</span>: pointer;
}

<span class="hljs-selector-tag">button</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#45a049</span>;
}
</code></pre>
<h3 data-id="heading-11">4. <code>popup/script.js</code></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'changeColor'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 向当前标签页发送消息</span>
  chrome.<span class="hljs-property">tabs</span>.<span class="hljs-title function_">query</span>({ <span class="hljs-attr">active</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">currentWindow</span>: <span class="hljs-literal">true</span> }, <span class="hljs-function">(<span class="hljs-params">tabs</span>) =&gt;</span> {
    chrome.<span class="hljs-property">tabs</span>.<span class="hljs-title function_">sendMessage</span>(tabs[<span class="hljs-number">0</span>].<span class="hljs-property">id</span>, { <span class="hljs-attr">action</span>: <span class="hljs-string">'changeBackgroundColor'</span> });
  });
});
</code></pre>
<h3 data-id="heading-12">5. <code>content.js</code></h3>
<pre><code class="hljs language-ini" lang="ini">// 监听来自 popup 的消息
chrome.runtime.onMessage.addListener((request, sender, sendResponse) =&gt; {
  if (<span class="hljs-attr">request.action</span> === <span class="hljs-string">'changeBackgroundColor'</span>) {
    <span class="hljs-attr">document.body.style.backgroundColor</span> = <span class="hljs-string">'green'</span><span class="hljs-comment">;</span>
  }
})<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h2 data-id="heading-13">五、Vibe Coding 的协作要点总结</h2>
<h3 data-id="heading-14">✅ 成功的关键：提供清晰上下文</h3>
<ul>
<li>如果只说“做个改背景色的插件”，Trae 可能遗漏 popup 结构或权限配置。</li>
<li>但当我们提供<strong>交互步骤 + 目录结构 + 设计意图</strong>，生成的代码几乎可直接运行。</li>
</ul>
<h3 data-id="heading-15">✅ 开发者的新角色</h3>
<ul>
<li>
<p><strong>不是写代码的人，而是“vibe 架构师”</strong></p>
</li>
<li>
<p>负责：</p>
<ul>
<li>定义用户旅程（Step1 → Step2）</li>
<li>绘制线框图（哪怕手绘拍照）</li>
<li>编写结构化需求（避免模糊描述）</li>
<li>审查 AI 生成的逻辑是否符合预期</li>
</ul>
</li>
</ul>
<h3 data-id="heading-16">✅ 耐心打磨“vibe”</h3>
<p>第一次生成可能不完美？没关系！</p>
<ul>
<li>补充说明：“按钮要居中”、“不要修改字体颜色”</li>
<li>Trae 会基于反馈迭代优化</li>
</ul>
<p>这正是 Vibe Coding 的精髓：<strong>通过持续对话，让 AI 理解你的“感觉”</strong> 。</p>
<hr/>
<h2 data-id="heading-17">六、如何测试 Hulk 扩展？</h2>
<ol>
<li>打开 Chrome → <code>chrome://extensions/</code></li>
<li>开启「开发者模式」</li>
<li>点击「加载已解压的扩展程序」，选择 <code>hulk-extension</code> 文件夹</li>
<li>访问任意网页，点击 Hulk 图标</li>
<li>点击“改变颜色”按钮 → 背景变绿！</li>
</ol>
<hr/>
<h2 data-id="heading-18">七、延伸思考：Vibe Coding 的未来</h2>
<ul>
<li><strong>复杂产品也能这样开发吗？</strong><br/>
当然！只要拆解清楚模块（登录、数据展示、设置页），每个模块都可用同样方式协作。</li>
<li><strong>是否还需要学编程？</strong><br/>
需要，但重点变了：从语法细节 → 系统设计 + 上下文表达能力。</li>
<li><strong>文档即产品</strong><br/>
在 Vibe Coding 中，一份好的 PRD（产品需求文档）可能比 1000 行代码更有价值。</li>
</ul>
<hr/>
<h2 data-id="heading-19">结语</h2>
<p>通过这次 Hulk 扩展的开发，我们体验了 <strong>Vibe Coding 的核心理念</strong>：</p>
<blockquote>
<p><strong>用清晰的文档和设计，引导 AI 生成可靠代码；人类专注创造与监督，而非重复劳动。</strong></p>
</blockquote>
<p>现在，轮到你了——<br/>
拿起你的设计稿，写下你的需求，和 Trae 一起，Vibe 出下一个产品吧！</p>
<hr/>
<blockquote>
<p>🌱 <strong>提示</strong>：本文本身就是一个“vibe 文档”——如果你把这篇文章喂给 Trae，并说“请按此文实现 Hulk 扩展”，它就能生成全部代码。这就是 Vibe Coding 的力量。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Ajax 数据请求学习笔记]]></title>    <link>https://juejin.cn/post/7571704212850917427</link>    <guid>https://juejin.cn/post/7571704212850917427</guid>    <pubDate>2025-11-12T14:57:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571704212850917427" data-draft-id="7571704212850901043" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Ajax 数据请求学习笔记"/> <meta itemprop="keywords" content="前端,JavaScript,代码规范"/> <meta itemprop="datePublished" content="2025-11-12T14:57:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="UIUV"/> <meta itemprop="url" content="https://juejin.cn/user/1036168457093483"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Ajax 数据请求学习笔记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1036168457093483/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    UIUV
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T14:57:27.000Z" title="Wed Nov 12 2025 14:57:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、什么是 Ajax？</h2>
<p>Ajax（Asynchronous JavaScript and XML）是一种在不重新加载整个页面的前提下，通过 JavaScript 异步向服务器请求数据并更新部分网页内容的技术。尽管名字中包含 XML，但在现代 Web 开发中，Ajax 更常用于请求和处理 <strong>JSON</strong> 格式的数据。</p>
<p>Ajax 的核心价值在于：<strong>实现页面的局部刷新，提升用户体验与性能</strong>。用户无需等待整页重载，即可获取最新数据并动态渲染到界面上。</p>
<hr/>
<h2 data-id="heading-1">二、Ajax 的基本工作流程</h2>
<p>使用原生 JavaScript 实现 Ajax 请求，主要依赖 <code>XMLHttpRequest</code>（简称 XHR）对象。其标准流程如下：</p>
<ol>
<li><strong>实例化</strong>：创建 <code>XMLHttpRequest</code> 对象；</li>
<li><strong>配置请求</strong>：调用 <code>.open(method, url, async)</code> 方法；</li>
<li><strong>发送请求</strong>：调用 <code>.send()</code> 方法；</li>
<li><strong>监听状态变化</strong>：通过 <code>onreadystatechange</code> 事件处理响应；</li>
<li><strong>解析与渲染</strong>：当请求完成且成功时，解析响应数据并更新 DOM。</li>
</ol>
<h3 data-id="heading-2">1. 实例化 XMLHttpRequest</h3>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">xhr</span> = new XMLHttpRequest()<span class="hljs-comment">;</span>
</code></pre>
<p>此时 <code>xhr.readyState</code> 为 <code>0</code>，表示“请求未初始化”。</p>
<h3 data-id="heading-3">2. 打开请求（open）</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">xhr.<span class="hljs-keyword">open</span>(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'https://api.github.com/orgs/lemoncode/members'</span>, <span class="hljs-literal">true</span>);
</code></pre>
<p>参数说明：</p>
<ul>
<li><code>method</code>：HTTP 方法，如 <code>'GET'</code>、<code>'POST'</code>；</li>
<li><code>url</code>：目标接口地址；</li>
<li><code>async</code>：是否异步（<code>true</code> 为异步，<code>false</code> 为同步，默认为 <code>true</code>）。</li>
</ul>
<p>调用 <code>open()</code> 后，<code>readyState</code> 变为 <code>1</code>（请求已建立）。</p>
<blockquote>
<p>⚠️ 注意：<strong>同步请求会阻塞主线程</strong>，导致页面卡顿，现代开发中应避免使用。</p>
</blockquote>
<h3 data-id="heading-4">3. 发送请求（send）</h3>
<pre><code class="hljs language-ini" lang="ini">xhr.send()<span class="hljs-comment">;</span>
</code></pre>
<p>调用后，<code>readyState</code> 进入 <code>2</code>（请求已发送），随后进入 <code>3</code>（服务器处理中），最终到达 <code>4</code>（请求完成）。</p>
<h3 data-id="heading-5">4. 监听状态变化（onreadystatechange）</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">xhr.onreadystatechange</span> = function() {
    if (<span class="hljs-attr">xhr.readyState</span> === <span class="hljs-number">4</span> &amp;&amp; xhr.status === <span class="hljs-number">200</span>) {
        const <span class="hljs-attr">data</span> = JSON.parse(xhr.responseText)<span class="hljs-comment">;</span>
        // 渲染数据
    }
}<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li><code>readyState</code>：表示请求的当前状态（0~4）；</li>
<li><code>status</code>：HTTP 状态码，<code>200</code> 表示成功；</li>
<li><code>responseText</code>：服务器返回的原始字符串。</li>
</ul>
<p>只有当 <code>readyState === 4</code> 且 <code>status === 200</code> 时，才表示请求成功完成，可以安全处理数据。</p>
<hr/>
<h2 data-id="heading-6">三、readyState 状态详解</h2>



































<table><thead><tr><th>状态值</th><th>含义</th><th>说明</th></tr></thead><tbody><tr><td>0</td><td>未初始化</td><td>尚未调用 <code>open()</code></td></tr><tr><td>1</td><td>已建立</td><td>已调用 <code>open()</code></td></tr><tr><td>2</td><td>已发送</td><td>已调用 <code>send()</code></td></tr><tr><td>3</td><td>正在处理中</td><td>服务器正在返回部分数据</td></tr><tr><td>4</td><td>已完成</td><td>整个请求过程完成，可读取响应</td></tr></tbody></table>
<p>理解这些状态有助于调试网络请求问题，例如判断请求是否卡在发送阶段或服务器无响应。</p>
<hr/>
<h2 data-id="heading-7">四、同步 vs 异步请求</h2>
<p>在示例代码中，若将 <code>open()</code> 的第三个参数设为 <code>false</code>（同步）：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">xhr.<span class="hljs-keyword">open</span>(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'https://api.github.com/orgs/lemoncode/members'</span>, <span class="hljs-literal">false</span>);
</code></pre>
<p>则 <code>send()</code> 会<strong>阻塞 JavaScript 主线程</strong>，直到服务器返回结果。这意味着：</p>
<ul>
<li>页面无法交互；</li>
<li>后续代码必须等请求完成才能执行；</li>
<li>用户体验极差。</li>
</ul>
<p>因此，<strong>强烈推荐始终使用异步请求（<code>async = true</code>）</strong> ，并通过事件回调处理结果。</p>
<hr/>
<h2 data-id="heading-8">五、实战：渲染 GitHub 组织成员列表</h2>
<p>以下是一个完整的异步 Ajax 示例，用于获取 Lemoncode 组织成员并动态渲染到页面：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;ul <span class="hljs-attr">id</span>=<span class="hljs-string">"members"</span>&gt;&lt;/ul&gt;
&lt;script&gt;
    const <span class="hljs-attr">xhr</span> = new XMLHttpRequest()<span class="hljs-comment">;</span>
    xhr.open('GET', 'https://api.github.com/orgs/lemoncode/members', true)<span class="hljs-comment">;</span>
    
    <span class="hljs-attr">xhr.onreadystatechange</span> = function() {
        if (<span class="hljs-attr">xhr.readyState</span> === <span class="hljs-number">4</span>) {
            if (<span class="hljs-attr">xhr.status</span> === <span class="hljs-number">200</span>) {
                const <span class="hljs-attr">members</span> = JSON.parse(xhr.responseText)<span class="hljs-comment">;</span>
                const <span class="hljs-attr">listHTML</span> = members.map(user =&gt; `&lt;li&gt;<span class="hljs-variable">${user.login}</span>&lt;/li&gt;`).join(<span class="hljs-string">''</span>)<span class="hljs-comment">;</span>
                document.getElementById('members').<span class="hljs-attr">innerHTML</span> = listHTML<span class="hljs-comment">;</span>
            } else {
                console.error('请求失败，状态码：', xhr.status)<span class="hljs-comment">;</span>
            }
        }
    }<span class="hljs-comment">;</span>
    
    xhr.send()<span class="hljs-comment">;</span>
&lt;/script&gt;
</code></pre>
<p>该代码实现了：</p>
<ul>
<li>异步请求 GitHub API；</li>
<li>成功后解析 JSON 数据；</li>
<li>使用 <code>map()</code> 和 <code>join()</code> 生成 HTML 字符串；</li>
<li>通过 <code>innerHTML</code> 更新 DOM。</li>
</ul>
<hr/>
<h2 data-id="heading-9">六、Ajax 的局限性与现代替代方案</h2>
<p>尽管 <code>XMLHttpRequest</code> 是 Ajax 的经典实现，但它存在以下问题：</p>
<ul>
<li>语法冗长；</li>
<li>错误处理复杂；</li>
<li>不支持 Promise，难以链式调用。</li>
</ul>
<p>因此，现代开发更倾向于使用：</p>
<ul>
<li><strong><code>fetch()</code> API</strong>：基于 Promise，语法简洁；</li>
<li><strong>Axios</strong>：功能强大的第三方库，支持拦截器、自动转换 JSON 等。</li>
</ul>
<p>例如，使用 <code>fetch</code> 实现相同功能：</p>
<pre><code class="hljs language-ini" lang="ini">fetch('https://api.github.com/orgs/lemoncode/members')
    .then(<span class="hljs-attr">response</span> =&gt; response.json())
    .then(<span class="hljs-attr">members</span> =&gt; {
        const <span class="hljs-attr">html</span> = members.map(u =&gt; `&lt;li&gt;<span class="hljs-variable">${u.login}</span>&lt;/li&gt;`).join(<span class="hljs-string">''</span>)<span class="hljs-comment">;</span>
        document.getElementById('members').<span class="hljs-attr">innerHTML</span> = html<span class="hljs-comment">;</span>
    })
    .catch(<span class="hljs-attr">err</span> =&gt; console.error(<span class="hljs-string">'请求出错:'</span>, err))<span class="hljs-comment">;</span>
</code></pre>
<p>代码更清晰，且天然支持异步/await。</p>
<hr/>
<h2 data-id="heading-10">七、总结</h2>
<p>Ajax 是前端与后端通信的基石技术。掌握 <code>XMLHttpRequest</code> 的工作原理，有助于深入理解浏览器网络请求机制。虽然现代开发多用 <code>fetch</code> 或 Axios，但 Ajax 的核心思想——<strong>异步、局部更新、事件驱动</strong>——依然贯穿于所有数据交互场景。</p>
<p>通过本次学习，我认识到：</p>
<ul>
<li>异步是 Web 性能的关键；</li>
<li>状态管理（readyState）是调试请求的重要依据；</li>
<li>文档化请求流程（方法、URL、参数、响应格式）能极大提升协作效率；</li>
<li>在 Vibe Coding 时代，清晰描述“我要什么数据、如何展示”，比手写 XHR 更重要。</li>
</ul>
<p>未来，我将在项目中结合 <code>fetch</code> 与错误边界处理，构建更健壮的数据请求层，同时继续夯实底层原理，做到“知其然，更知其所以然”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[20251112-问题排查与复盘]]></title>    <link>https://juejin.cn/post/7571695634942345243</link>    <guid>https://juejin.cn/post/7571695634942345243</guid>    <pubDate>2025-11-12T15:11:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571695634942345243" data-draft-id="7571678674145493002" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="20251112-问题排查与复盘"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-12T15:11:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="张可爱"/> <meta itemprop="url" content="https://juejin.cn/user/2608489519384504"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            20251112-问题排查与复盘
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2608489519384504/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    张可爱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T15:11:35.000Z" title="Wed Nov 12 2025 15:11:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0"><strong>1. 图片无法显示：</strong></h4>
<h5 data-id="heading-1"><strong>问题描述：</strong></h5>
<p>在使用 <code>&lt;img&gt;</code> 标签绑定图片时，图片没有正确显示，尽管路径和格式看起来正确。</p>
<h5 data-id="heading-2"><strong>解决方案：</strong></h5>
<ul>
<li>
<p><strong>未正确注册 <code>data</code> 中的路径变量</strong>：图片路径没有注册为响应式数据，导致无法渲染。</p>
</li>
<li>
<p><strong>解决步骤</strong>：</p>
<ol>
<li>
<p>在 <code>data()</code> 中注册图片路径：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> userTotal <span class="hljs-keyword">from</span> <span class="hljs-string">"@/assets/bg/userTotal.webp"</span>; <span class="hljs-comment">// 确保导入路径正确</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">userTotal</span>: userTotal <span class="hljs-comment">// 注册路径</span>
    };
  },
}
</code></pre>
</li>
<li>
<p>在模板中绑定图片：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;img :<span class="hljs-attr">src</span>=<span class="hljs-string">"userTotal"</span> alt=<span class="hljs-string">"用户总数"</span> class=<span class="hljs-string">"user-total-img"</span> /&gt;
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong>注意</strong>：检查构建工具配置（如 Vite 或 Webpack），确保图片路径别名（<code>@/assets</code>）能正确解析。</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-3"><strong>2. Vue 的警告：</strong></h4>
<h5 data-id="heading-4"><strong>问题描述：</strong></h5>
<p>在 Vue 项目中，控制台出现了警告信息：</p>
<pre><code class="hljs language-markdown" lang="markdown">[<span class="hljs-symbol">Vue warn</span>]: <span class="hljs-link">Extraneous non-props event listeners (goPublish) were passed to &lt;Deploy&gt; but could not be automatically inherited because component renders text nodes.</span>
</code></pre>
<h5 data-id="heading-5"><strong>解决方案：</strong></h5>
<ul>
<li>
<p><strong>警告原因</strong>：Vue 提示你传递了未声明的事件 <code>goPublish</code>。该事件没有被正确处理。</p>
</li>
<li>
<p><strong>解决步骤</strong>：</p>
<ol>
<li>
<p>确保组件 <code>Deploy</code> 中正确定义了 <code>goPublish</code> 事件：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  props: [<span class="hljs-string">'goPublish'</span>], <span class="hljs-comment">// 确保事件传递和监听</span>
}
</code></pre>
</li>
<li>
<p>使用 <code>$emit()</code> 来触发父组件的事件：</p>
<pre><code class="hljs language-bash" lang="bash">&lt;button @click=<span class="hljs-string">"<span class="hljs-variable">$emit</span>('goPublish')"</span>&gt;发布&lt;/button&gt;
</code></pre>
</li>
</ol>
</li>
</ul>
<hr/>
<h4 data-id="heading-6"><strong>3. ReferenceError: require is not defined：</strong></h4>
<h5 data-id="heading-7"><strong>问题描述：</strong></h5>
<p>在执行某些 Node.js 或 Vue 代码时，出现错误：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">ReferenceError</span>: <span class="hljs-built_in">require</span> is not defined
</code></pre>
<h5 data-id="heading-8"><strong>解决方案：</strong></h5>
<ul>
<li>
<p><strong>错误原因</strong>：该错误通常是由于在浏览器环境中使用了 Node.js 中的 <code>require</code> 方法，浏览器不支持 <code>require</code>。</p>
</li>
<li>
<p><strong>解决步骤</strong>：</p>
<ol>
<li>
<p>使用 <code>import</code> 代替 <code>require</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> userTotal <span class="hljs-keyword">from</span> <span class="hljs-string">'@/assets/bg/userTotal.webp'</span>; <span class="hljs-comment">// 适应 ES 模块导入</span>
</code></pre>
</li>
<li>
<p>检查构建工具配置，确保模块转换正确。</p>
</li>
</ol>
<p><strong>注意</strong>：如果你在浏览器环境中运行代码，请确保没有直接使用 Node.js 的特性（如 <code>require</code>、<code>module.exports</code> 等）。所有模块应使用 <code>import/export</code> 语法。</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-9"><strong>4. 滚动条样式问题：</strong></h4>
<h5 data-id="heading-10"><strong>问题描述：</strong></h5>
<p>在应用中，滚动条样式不符合预期，可能需要隐藏或者自定义滚动条样式。</p>
<h5 data-id="heading-11"><strong>解决方案：</strong></h5>
<ul>
<li>
<p><strong>隐藏滚动条</strong>：使用 CSS 可以隐藏滚动条，或者设置其样式。</p>
</li>
<li>
<p><strong>解决步骤</strong>：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.base-div</span> {
  <span class="hljs-attribute">overflow-y</span>: scroll;
  <span class="hljs-attribute">scrollbar-width</span>: none; <span class="hljs-comment">/* Firefox */</span>
  -ms-<span class="hljs-attribute">overflow</span>-style: none; <span class="hljs-comment">/* IE/Edge */</span>
}

<span class="hljs-selector-class">.base-div</span>::-webkit-scrollbar {
  <span class="hljs-attribute">display</span>: none; <span class="hljs-comment">/* Chrome, Safari */</span>
}
</code></pre>
</li>
<li>
<p><strong>设置滚动条样式</strong>：若想定制滚动条样式，可以使用 <code>::-webkit-scrollbar</code> 系列的 CSS 伪元素：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.base-div</span>::-webkit-scrollbar {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">8px</span>;
}
<span class="hljs-selector-class">.base-div</span>::-webkit-scrollbar-thumb {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.3</span>);
}
</code></pre>
</li>
</ul>
<hr/>
<h4 data-id="heading-12"><strong>5. 图表显示问题（ECharts）</strong> ：</h4>
<h5 data-id="heading-13"><strong>问题描述：</strong></h5>
<p>在使用 ECharts 渲染图表时，图表的数据显示不正确或者未显示。</p>
<h5 data-id="heading-14"><strong>解决方案</strong>：</h5>
<ul>
<li>
<p><strong>解决步骤</strong>：</p>
<ol>
<li>确保图表的 <code>option</code> 配置正确，并传递给 <code>&lt;scEcharts /&gt;</code> 组件。</li>
<li>检查 ECharts 配置是否完整，特别是 <code>xAxis</code> 和 <code>yAxis</code> 的配置。</li>
<li>确保数据来源无误，可以通过 <code>console.log()</code> 打印数据，查看其是否已正确返回。</li>
</ol>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-css" lang="css">this<span class="hljs-selector-class">.userOption</span> = {
  title: {
    text: <span class="hljs-string">"用户总数"</span>,
  },
  xAxis: {
    type: <span class="hljs-string">"category"</span>,
    data: [<span class="hljs-string">"2021-01"</span>, <span class="hljs-string">"2021-02"</span>, <span class="hljs-string">"2021-03"</span>],  // 示例数据
  },
  series: [
    {
      data: [<span class="hljs-number">5</span>, <span class="hljs-number">20</span>, <span class="hljs-number">36</span>],
      type: <span class="hljs-string">"line"</span>,
    },
  ],
};
</code></pre>
</li>
</ul>
<hr/>
<h3 data-id="heading-15"><strong>总结</strong></h3>
<p>今天解决了以下几个问题：</p>
<ol>
<li><strong>图片无法显示</strong>：通过注册数据并确保路径正确来解决。</li>
<li><strong>Vue 警告</strong>：解决了未声明事件的警告，使用 <code>emit</code> 触发自定义事件。</li>
<li><strong>require 错误</strong>：更改为 <code>import</code> 语法，以适应浏览器环境。</li>
<li><strong>滚动条样式</strong>：使用 CSS 自定义滚动条样式或隐藏滚动条。</li>
<li><strong>ECharts 配置问题</strong>：确保图表的 <code>option</code> 配置正确并传递到组件中。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 Ajax：异步 JavaScript 与 XML 的现代应用]]></title>    <link>https://juejin.cn/post/7571704212850950195</link>    <guid>https://juejin.cn/post/7571704212850950195</guid>    <pubDate>2025-11-12T15:11:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571704212850950195" data-draft-id="7571678674145558538" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 深入理解 Ajax：异步 JavaScript 与 XML 的现代应用"/> <meta itemprop="keywords" content="Ajax"/> <meta itemprop="datePublished" content="2025-11-12T15:11:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="_一两风"/> <meta itemprop="url" content="https://juejin.cn/user/2250014422739596"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             深入理解 Ajax：异步 JavaScript 与 XML 的现代应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2250014422739596/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    _一两风
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T15:11:46.000Z" title="Wed Nov 12 2025 15:11:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">深入理解 Ajax：异步 JavaScript 与 XML 的现代应用</h2>
<h3 data-id="heading-1">什么是 Ajax？</h3>
<p>Ajax（Asynchronous JavaScript and XML）是一种在不重新加载整个页面的前提下，通过异步请求与服务器交换数据并局部更新页面的技术。它让 Web 应用能够实现更流畅的用户体验，是现代 Web 开发的基础技术之一。</p>
<h4 data-id="heading-2">Ajax 的核心特点</h4>
<ol>
<li><strong>异步通信</strong>：可以在后台与服务器交换数据，不会阻塞用户界面</li>
<li><strong>局部更新</strong>：只更新页面中需要改变的部分，而不是整个页面</li>
<li><strong>动态交互</strong>：JavaScript 可以主动发起 HTTP 请求，实现界面的动态更新</li>
</ol>
<h3 data-id="heading-3">XMLHttpRequest：Ajax 的核心 API</h3>
<p><code>XMLHttpRequest</code>（简称 XHR）是浏览器提供的原生 API，用于在客户端和服务器之间传输数据。虽然名字中包含 "XML"，但实际上它可以处理任何格式的数据，包括 JSON、HTML、文本等。</p>
<h4 data-id="heading-4">基本使用步骤</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 创建 XMLHttpRequest 实例</span>
<span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();

<span class="hljs-comment">// 2. 打开一个请求（指定方法、URL、是否异步）</span>
xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'https://api.github.com/orgs/lemoncode/members'</span>, <span class="hljs-literal">true</span>);

<span class="hljs-comment">// 3. 发送请求</span>
xhr.<span class="hljs-title function_">send</span>();

<span class="hljs-comment">// 4. 监听状态变化</span>
xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span>(xhr.<span class="hljs-property">readyState</span> === <span class="hljs-number">4</span> &amp;&amp; xhr.<span class="hljs-property">status</span> === <span class="hljs-number">200</span>) {
        <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(xhr.<span class="hljs-property">responseText</span>);
        <span class="hljs-comment">// 处理数据</span>
    }
}
</code></pre>
<h3 data-id="heading-5">深入理解 readyState</h3>
<p><code>readyState</code> 是 XMLHttpRequest 对象的一个重要属性，它表示请求的当前状态。理解这些状态对于正确处理 Ajax 请求至关重要。</p>
<h4 data-id="heading-6">readyState 的五个状态</h4>



































<table><thead><tr><th>状态值</th><th>状态名称</th><th>说明</th></tr></thead><tbody><tr><td>0</td><td>UNSENT</td><td>未初始化。已创建 XMLHttpRequest 对象，但尚未调用 <code>open()</code> 方法</td></tr><tr><td>1</td><td>OPENED</td><td>已打开。已调用 <code>open()</code> 方法，但尚未调用 <code>send()</code> 方法</td></tr><tr><td>2</td><td>HEADERS_RECEIVED</td><td>已接收响应头。已调用 <code>send()</code> 方法，且响应头和响应状态已经可用</td></tr><tr><td>3</td><td>LOADING</td><td>正在接收响应数据。正在接收响应体，<code>responseText</code> 中已经包含部分数据</td></tr><tr><td>4</td><td>DONE</td><td>完成。响应数据接收完成，整个请求过程已经结束</td></tr></tbody></table>
<h4 data-id="heading-7">状态变化流程</h4>
<pre><code class="hljs language-scss" lang="scss">创建对象 (<span class="hljs-number">0</span>) 
  ↓
调用 <span class="hljs-built_in">open</span>() (<span class="hljs-number">1</span>)
  ↓
调用 <span class="hljs-built_in">send</span>() (<span class="hljs-number">2</span>)
  ↓
接收响应头 (<span class="hljs-number">2</span>)
  ↓
接收响应数据 (<span class="hljs-number">3</span>)
  ↓
接收完成 (<span class="hljs-number">4</span>)
</code></pre>
<h4 data-id="heading-8">实际应用示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(xhr.<span class="hljs-property">readyState</span>); <span class="hljs-comment">// 0 - 未初始化</span>

xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'https://api.github.com/orgs/lemoncode/members'</span>, <span class="hljs-literal">true</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(xhr.<span class="hljs-property">readyState</span>); <span class="hljs-comment">// 1 - 已打开</span>

xhr.<span class="hljs-title function_">send</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(xhr.<span class="hljs-property">readyState</span>); <span class="hljs-comment">// 1 - 注意：同步情况下可能还是 1</span>

xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(xhr.<span class="hljs-property">readyState</span>); <span class="hljs-comment">// 2, 3, 4 - 状态会依次变化</span>
    
    <span class="hljs-keyword">if</span>(xhr.<span class="hljs-property">readyState</span> === <span class="hljs-number">4</span> &amp;&amp; xhr.<span class="hljs-property">status</span> === <span class="hljs-number">200</span>) {
        <span class="hljs-comment">// 请求成功完成</span>
        <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(xhr.<span class="hljs-property">responseText</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);
    }
}
</code></pre>
<h3 data-id="heading-9">HTTP 状态码</h3>
<p>除了 <code>readyState</code>，我们还需要关注 HTTP 状态码（<code>xhr.status</code>），它表示服务器响应的状态。</p>
<h4 data-id="heading-10">常见状态码</h4>
<ul>
<li><strong>200 OK</strong>：请求成功，服务器返回了请求的数据</li>
<li><strong>404 Not Found</strong>：请求的资源未找到</li>
<li><strong>500 Internal Server Error</strong>：服务器内部错误</li>
<li><strong>403 Forbidden</strong>：服务器理解请求，但拒绝执行</li>
<li><strong>401 Unauthorized</strong>：需要身份验证</li>
</ul>
<h4 data-id="heading-11">完整的错误处理</h4>
<pre><code class="hljs language-javascript" lang="javascript">xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span>(xhr.<span class="hljs-property">readyState</span> === <span class="hljs-number">4</span>) {
        <span class="hljs-keyword">if</span>(xhr.<span class="hljs-property">status</span> === <span class="hljs-number">200</span>) {
            <span class="hljs-comment">// 成功处理</span>
            <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(xhr.<span class="hljs-property">responseText</span>);
            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'members-list'</span>).<span class="hljs-property">innerHTML</span> = 
                data.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> <span class="hljs-string">`&lt;li&gt;<span class="hljs-subst">${item.login}</span>&lt;/li&gt;`</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 错误处理</span>
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求失败，状态码：'</span>, xhr.<span class="hljs-property">status</span>);
        }
    }
}
</code></pre>
<h3 data-id="heading-12">同步 vs 异步请求</h3>
<p><code>xhr.open()</code> 方法的第三个参数决定了请求是同步还是异步：</p>
<ul>
<li><strong><code>true</code>（异步）</strong>：请求在后台执行，不会阻塞 JavaScript 代码的执行</li>
<li><strong><code>false</code>（同步）</strong>：请求会阻塞代码执行，直到响应完成（不推荐使用）</li>
</ul>
<h4 data-id="heading-13">异步请求的优势</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 异步请求（推荐）</span>
xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">'GET'</span>, url, <span class="hljs-literal">true</span>);
xhr.<span class="hljs-title function_">send</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'这行代码会立即执行'</span>); <span class="hljs-comment">// 不会等待请求完成</span>

<span class="hljs-comment">// 同步请求（不推荐）</span>
xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">'GET'</span>, url, <span class="hljs-literal">false</span>);
xhr.<span class="hljs-title function_">send</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'这行代码会等待请求完成'</span>); <span class="hljs-comment">// 会阻塞执行</span>
</code></pre>
<p><strong>注意</strong>：同步请求会阻塞浏览器，导致用户体验差，现代 Web 开发中应该避免使用。</p>
<h3 data-id="heading-14">实际应用：获取 GitHub 组织成员</h3>
<p>让我们看一个完整的例子，从 GitHub API 获取组织成员列表：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();

<span class="hljs-comment">// 打开 GET 请求</span>
xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'https://api.github.com/orgs/lemoncode/members'</span>, <span class="hljs-literal">true</span>);

<span class="hljs-comment">// 发送请求</span>
xhr.<span class="hljs-title function_">send</span>();

<span class="hljs-comment">// 监听状态变化</span>
xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 确保请求完成且成功</span>
    <span class="hljs-keyword">if</span>(xhr.<span class="hljs-property">readyState</span> === <span class="hljs-number">4</span> &amp;&amp; xhr.<span class="hljs-property">status</span> === <span class="hljs-number">200</span>) {
        <span class="hljs-comment">// 解析 JSON 数据</span>
        <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(xhr.<span class="hljs-property">responseText</span>);
        
        <span class="hljs-comment">// 更新 DOM</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'members-list'</span>).<span class="hljs-property">innerHTML</span> = 
            data.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> <span class="hljs-string">`&lt;li&gt;<span class="hljs-subst">${item.login}</span>&lt;/li&gt;`</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>);
    }
}
</code></pre>
<h3 data-id="heading-15">POST 请求示例</h3>
<p>除了 GET 请求，Ajax 也支持 POST、PUT、DELETE 等方法：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();

xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">'POST'</span>, <span class="hljs-string">'https://api.example.com/users'</span>, <span class="hljs-literal">true</span>);

<span class="hljs-comment">// 设置请求头</span>
xhr.<span class="hljs-title function_">setRequestHeader</span>(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'application/json'</span>);

xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span>(xhr.<span class="hljs-property">readyState</span> === <span class="hljs-number">4</span> &amp;&amp; xhr.<span class="hljs-property">status</span> === <span class="hljs-number">201</span>) {
        <span class="hljs-keyword">const</span> response = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(xhr.<span class="hljs-property">responseText</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'创建成功：'</span>, response);
    }
}

<span class="hljs-comment">// 发送 JSON 数据</span>
<span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
    <span class="hljs-attr">name</span>: <span class="hljs-string">'John Doe'</span>,
    <span class="hljs-attr">email</span>: <span class="hljs-string">'john@example.com'</span>
});
xhr.<span class="hljs-title function_">send</span>(data);
</code></pre>
<h3 data-id="heading-16">现代替代方案：Fetch API</h3>
<p>虽然 XMLHttpRequest 仍然被广泛支持，但现代浏览器提供了更优雅的 <code>fetch</code> API：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用 fetch API（更现代的方式）</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.github.com/orgs/lemoncode/members'</span>)
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.<span class="hljs-title function_">json</span>())
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'members-list'</span>).<span class="hljs-property">innerHTML</span> = 
            data.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> <span class="hljs-string">`&lt;li&gt;<span class="hljs-subst">${item.login}</span>&lt;/li&gt;`</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>);
    })
    .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求失败：'</span>, error);
    });

<span class="hljs-comment">// 使用 async/await（更简洁）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchMembers</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.github.com/orgs/lemoncode/members'</span>);
        <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'members-list'</span>).<span class="hljs-property">innerHTML</span> = 
            data.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> <span class="hljs-string">`&lt;li&gt;<span class="hljs-subst">${item.login}</span>&lt;/li&gt;`</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>);
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求失败：'</span>, error);
    }
}
</code></pre>
<h3 data-id="heading-17">Ajax 的最佳实践</h3>
<ol>
<li><strong>始终使用异步请求</strong>：避免阻塞用户界面</li>
<li><strong>完善的错误处理</strong>：检查 <code>readyState</code> 和 <code>status</code></li>
<li><strong>设置超时</strong>：使用 <code>xhr.timeout</code> 避免长时间等待</li>
<li><strong>处理跨域问题</strong>：了解 CORS 机制</li>
<li><strong>使用现代 API</strong>：优先考虑 <code>fetch</code> API 或 <code>axios</code> 等库</li>
</ol>
<h4 data-id="heading-18">设置超时示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();
xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">'GET'</span>, url, <span class="hljs-literal">true</span>);
xhr.<span class="hljs-property">timeout</span> = <span class="hljs-number">5000</span>; <span class="hljs-comment">// 5 秒超时</span>

xhr.<span class="hljs-property">ontimeout</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求超时'</span>);
}

xhr.<span class="hljs-title function_">send</span>();
</code></pre>
<h3 data-id="heading-19">总结</h3>
<p>Ajax 技术彻底改变了 Web 应用的交互方式，让网页能够实现动态、流畅的用户体验。虽然现在有了 <code>fetch</code> API 等更现代的选择，但理解 XMLHttpRequest 的工作原理仍然很重要，因为：</p>
<ol>
<li><strong>兼容性</strong>：许多旧项目仍在使用 XMLHttpRequest</li>
<li><strong>理解原理</strong>：有助于理解现代 API 的设计思路</li>
<li><strong>面试准备</strong>：前端面试中经常涉及这些基础知识</li>
</ol>
<p>掌握 Ajax 的核心概念，包括 <code>readyState</code> 的状态变化、HTTP 状态码的处理，以及异步编程的思想，是成为一名优秀前端开发者的基础。</p>
<hr/>
<p><strong>参考资源</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FXMLHttpRequest" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest" ref="nofollow noopener noreferrer">MDN: XMLHttpRequest</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FFetch_API" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API" ref="nofollow noopener noreferrer">MDN: Fetch API</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.github.com%2Fen%2Frest" target="_blank" title="https://docs.github.com/en/rest" ref="nofollow noopener noreferrer">GitHub API 文档</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手写useInterval：告别闭包陷阱，玩转React定时器！]]></title>    <link>https://juejin.cn/post/7571729682678186034</link>    <guid>https://juejin.cn/post/7571729682678186034</guid>    <pubDate>2025-11-12T15:18:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571729682678186034" data-draft-id="7571395183945236489" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手写useInterval：告别闭包陷阱，玩转React定时器！"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2025-11-12T15:18:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="FogLetter"/> <meta itemprop="url" content="https://juejin.cn/user/933907109778611"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手写useInterval：告别闭包陷阱，玩转React定时器！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/933907109778611/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    FogLetter
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T15:18:11.000Z" title="Wed Nov 12 2025 15:18:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言：被定时器折磨的日常</h2>
<p>大家好，我是前端手艺人FogLetter！不知道大家在React项目中有没有遇到过这样的场景：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 这里总是拿到旧的count值！</span>
      <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>); 
    }, <span class="hljs-number">1000</span>);
    
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(timer);
  }, []);
  
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{count}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p>运行这段代码，你会发现计数器永远显示1，然后就停滞不前了。这就是React中经典的<strong>闭包陷阱</strong>问题！</p>
<p>今天，我们就来深入剖析这个问题，并手写一个完美的<code>useInterval</code> Hook，让它成为你工具箱中的利器！</p>
<h3 data-id="heading-1">第一章：为什么会有闭包陷阱？</h3>
<h4 data-id="heading-2">1.1 JavaScript闭包的本质</h4>
<p>在JavaScript中，函数可以"记住"并访问其创建时的词法作用域中的变量，即使函数在其他地方执行。这就是闭包。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createCounter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    count++;
    <span class="hljs-keyword">return</span> count;
  };
}

<span class="hljs-keyword">const</span> counter = <span class="hljs-title function_">createCounter</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">counter</span>()); <span class="hljs-comment">// 1</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">counter</span>()); <span class="hljs-comment">// 2</span>
<span class="hljs-comment">// count变量被"记住"了</span>
</code></pre>
<h4 data-id="heading-3">1.2 React函数组件的执行机制</h4>
<p>React函数组件在每次渲染时都会重新执行，每次执行都会创建新的作用域和新的变量：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> value = count * <span class="hljs-number">2</span>; <span class="hljs-comment">// 每次渲染都会重新计算</span>
  
  <span class="hljs-comment">// 这个函数在每次渲染时都是新的！</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count); <span class="hljs-comment">// 闭包捕获了当前渲染时的count值</span>
  };
  
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span>点击<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;
}
</code></pre>
<h4 data-id="heading-4">1.3 问题的根源</h4>
<p>当我们把定时器放在<code>useEffect</code>中且依赖数组为空时：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>); <span class="hljs-comment">// 这里的count是初次渲染时的值：0</span>
  }, <span class="hljs-number">1000</span>);
  
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(timer);
}, []); <span class="hljs-comment">// 依赖为空，effect只执行一次</span>
</code></pre>
<p>定时器回调函数<strong>闭包捕获</strong>了初次渲染时的<code>count</code>值（0），所以每次执行都是<code>setCount(0 + 1)</code>，计数器永远显示1。</p>
<h3 data-id="heading-5">第二章：常规解决方案及其缺陷</h3>
<h4 data-id="heading-6">2.1 方案一：添加依赖项</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);
  }, <span class="hljs-number">1000</span>);
  
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(timer);
}, [count]); <span class="hljs-comment">// 添加count依赖</span>
</code></pre>
<p><strong>问题</strong>：每次count变化都会重新创建定时器，性能差且可能造成定时器执行间隔不稳定。</p>
<h4 data-id="heading-7">2.2 方案二：使用函数式更新</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>); <span class="hljs-comment">// 使用函数式更新</span>
  }, <span class="hljs-number">1000</span>);
  
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(timer);
}, []);
</code></pre>
<p><strong>这个方案其实可以工作</strong>，但它有局限性：只能解决状态更新问题，如果回调函数中需要访问其他props或状态，还是会遇到闭包问题。</p>
<h4 data-id="heading-8">2.3 方案三：使用useReducer</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">reducer</span>(<span class="hljs-params">state</span>) {
  <span class="hljs-keyword">return</span> state + <span class="hljs-number">1</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, dispatch] = <span class="hljs-title function_">useReducer</span>(reducer, <span class="hljs-number">0</span>);
  
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">dispatch</span>();
    }, <span class="hljs-number">1000</span>);
    
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(timer);
  }, []);
  
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{count}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p><strong>问题</strong>：代码复杂度增加，对于简单场景显得太重。</p>
<h3 data-id="heading-9">第三章：手写完美的useInterval Hook</h3>
<h4 data-id="heading-10">3.1 核心思路：useRef + 依赖分离</h4>
<p>让我们来看看如何实现一个既优雅又强大的<code>useInterval</code>：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useEffect, useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">useInterval</span>(<span class="hljs-params">callback, delay</span>) {
  <span class="hljs-comment">// 使用useRef保存回调函数</span>
  <span class="hljs-keyword">const</span> savedCallback = <span class="hljs-title function_">useRef</span>();
  
  <span class="hljs-comment">// 单独监听callback变化，只更新引用</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    savedCallback.<span class="hljs-property">current</span> = callback;
  }, [callback]);
  
  <span class="hljs-comment">// 单独管理定时器，依赖delay</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (delay === <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// delay为null时暂停</span>
    
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">tick</span> = (<span class="hljs-params"/>) =&gt; {
      savedCallback.<span class="hljs-property">current</span>?.();
    };
    
    <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">setInterval</span>(tick, delay);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(id);
  }, [delay]);
}
</code></pre>
<h4 data-id="heading-11">3.2 设计亮点解析</h4>
<h5 data-id="heading-12">3.2.1 使用useRef打破闭包限制</h5>
<p><code>useRef</code>返回一个可变的ref对象，其<code>.current</code>属性被初始化为传入的参数。这个对象在组件的整个生命周期内持续存在，不会因为重新渲染而改变。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> savedCallback = <span class="hljs-title function_">useRef</span>();
<span class="hljs-comment">// savedCallback.current 永远指向最新的回调函数</span>
</code></pre>
<h5 data-id="heading-13">3.2.2 依赖分离策略</h5>
<p>我们将逻辑拆分为两个独立的<code>useEffect</code>：</p>
<ul>
<li><strong>第一个useEffect</strong>：只负责更新回调函数的引用</li>
<li><strong>第二个useEffect</strong>：只负责管理定时器的生命周期</li>
</ul>
<p>这样做的妙处在于：</p>
<ul>
<li>回调函数更新时不会重启定时器</li>
<li>delay变化时自动调整定时器间隔</li>
<li>delay为null时自动暂停</li>
</ul>
<h5 data-id="heading-14">3.2.3 灵活的暂停机制</h5>
<p>通过判断<code>delay === null</code>来实现暂停，这种设计比维护一个<code>isRunning</code>状态更加直观：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-title function_">useInterval</span>(
  <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>),
  running ? <span class="hljs-number">1000</span> : <span class="hljs-literal">null</span> <span class="hljs-comment">// 简洁明了！</span>
);
</code></pre>
<h4 data-id="heading-15">3.3 完整实现与类型定义</h4>
<p>对于TypeScript用户，我们可以添加完整的类型定义：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { useEffect, useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">useInterval</span>(<span class="hljs-params">callback: () =&gt; <span class="hljs-built_in">void</span>, delay: <span class="hljs-built_in">number</span> | <span class="hljs-literal">null</span></span>) {
  <span class="hljs-keyword">const</span> savedCallback = useRef&lt;<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>&gt;();
  
  <span class="hljs-comment">// 记住最新的回调</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    savedCallback.<span class="hljs-property">current</span> = callback;
  }, [callback]);
  
  <span class="hljs-comment">// 设置定时器</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (delay === <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">tick</span> = (<span class="hljs-params"/>) =&gt; {
      savedCallback.<span class="hljs-property">current</span>?.();
    };
    
    <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">setInterval</span>(tick, delay);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(id);
  }, [delay]);
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useInterval;
</code></pre>
<h3 data-id="heading-16">第四章：实战应用场景</h3>
<h4 data-id="heading-17">4.1 基础计数器</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> useInterval <span class="hljs-keyword">from</span> <span class="hljs-string">'./hooks/useInterval'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> [running, setRunning] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);

  <span class="hljs-title function_">useInterval</span>(
    <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>),
    running ? <span class="hljs-number">1000</span> : <span class="hljs-literal">null</span>
  );

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Count: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setRunning(!running)}&gt;
        {running ? 'Pause' : 'Start'}
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(0)}&gt;Reset<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-18">4.2 倒计时组件</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Countdown</span>(<span class="hljs-params">{ initialSeconds = <span class="hljs-number">60</span> }</span>) {
  <span class="hljs-keyword">const</span> [seconds, setSeconds] = <span class="hljs-title function_">useState</span>(initialSeconds);
  <span class="hljs-keyword">const</span> [isRunning, setIsRunning] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-title function_">useInterval</span>(
    <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (seconds &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-title function_">setSeconds</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev - <span class="hljs-number">1</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">setIsRunning</span>(<span class="hljs-literal">false</span>);
      }
    },
    isRunning ? <span class="hljs-number">1000</span> : <span class="hljs-literal">null</span>
  );

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>剩余时间: {seconds}秒<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsRunning(!isRunning)}&gt;
        {isRunning ? '暂停' : '开始'}
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> {
        setSeconds(initialSeconds);
        setIsRunning(false);
      }}&gt;重置<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-19">4.3 轮播图组件</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Carousel</span>(<span class="hljs-params">{ images }</span>) {
  <span class="hljs-keyword">const</span> [currentIndex, setCurrentIndex] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> [autoPlay, setAutoPlay] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);

  <span class="hljs-title function_">useInterval</span>(
    <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">setCurrentIndex</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> (prev + <span class="hljs-number">1</span>) % images.<span class="hljs-property">length</span>);
    },
    autoPlay ? <span class="hljs-number">3000</span> : <span class="hljs-literal">null</span>
  );

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> 
      <span class="hljs-attr">className</span>=<span class="hljs-string">"carousel"</span>
      <span class="hljs-attr">onMouseEnter</span>=<span class="hljs-string">{()</span> =&gt;</span> setAutoPlay(false)}
      onMouseLeave={() =&gt; setAutoPlay(true)}
    &gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{images[currentIndex]}</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"轮播图"</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"indicators"</span>&gt;</span>
        {images.map((_, index) =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
            <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>
            <span class="hljs-attr">className</span>=<span class="hljs-string">{index</span> === <span class="hljs-string">currentIndex</span> ? '<span class="hljs-attr">active</span>' <span class="hljs-attr">:</span> ''}
            <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCurrentIndex(index)}
          /&gt;
        ))}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-20">第五章：进阶技巧与最佳实践</h3>
<h4 data-id="heading-21">5.1 支持立即执行</h4>
<p>有时候我们需要定时器立即执行一次，然后再按间隔执行：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useInterval</span>(<span class="hljs-params">callback, delay, immediate = <span class="hljs-literal">false</span></span>) {
  <span class="hljs-keyword">const</span> savedCallback = <span class="hljs-title function_">useRef</span>();
  <span class="hljs-keyword">const</span> hasExecuted = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    savedCallback.<span class="hljs-property">current</span> = callback;
    hasExecuted.<span class="hljs-property">current</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 重置执行状态</span>
  }, [callback]);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (delay === <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">if</span> (immediate &amp;&amp; !hasExecuted.<span class="hljs-property">current</span>) {
      savedCallback.<span class="hljs-property">current</span>?.();
      hasExecuted.<span class="hljs-property">current</span> = <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">tick</span> = (<span class="hljs-params"/>) =&gt; {
      savedCallback.<span class="hljs-property">current</span>?.();
      hasExecuted.<span class="hljs-property">current</span> = <span class="hljs-literal">true</span>;
    };

    <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">setInterval</span>(tick, delay);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(id);
  }, [delay, immediate]);
}
</code></pre>
<h4 data-id="heading-22">5.2 精确控制执行次数</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useIntervalWithLimit</span>(<span class="hljs-params">callback, delay, limit = <span class="hljs-literal">Infinity</span></span>) {
  <span class="hljs-keyword">const</span> savedCallback = <span class="hljs-title function_">useRef</span>();
  <span class="hljs-keyword">const</span> executionCount = <span class="hljs-title function_">useRef</span>(<span class="hljs-number">0</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    savedCallback.<span class="hljs-property">current</span> = callback;
  }, [callback]);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (delay === <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">tick</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">if</span> (executionCount.<span class="hljs-property">current</span> &lt; limit) {
        savedCallback.<span class="hljs-property">current</span>?.();
        executionCount.<span class="hljs-property">current</span> += <span class="hljs-number">1</span>;
      }
    };

    <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">setInterval</span>(tick, delay);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-built_in">clearInterval</span>(id);
      executionCount.<span class="hljs-property">current</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// 重置计数</span>
    };
  }, [delay, limit]);
}
</code></pre>
<h4 data-id="heading-23">5.3 性能优化建议</h4>
<ol>
<li>
<p><strong>避免在回调函数中创建新对象</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// ❌ 不推荐：每次都会创建新对象</span>
<span class="hljs-title function_">useInterval</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> newData = { count, <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() };
  <span class="hljs-title function_">setData</span>(newData);
}, <span class="hljs-number">1000</span>);

<span class="hljs-comment">// ✅ 推荐：使用函数式更新</span>
<span class="hljs-title function_">useInterval</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">setData</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> ({
    ...prev,
    <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
  }));
}, <span class="hljs-number">1000</span>);
</code></pre>
</li>
<li>
<p><strong>合理设置delay</strong></p>
<ul>
<li>对于频繁更新的场景，考虑使用<code>requestAnimationFrame</code></li>
<li>对于精度要求不高的场景，可以适当增大间隔</li>
</ul>
</li>
</ol>
<h3 data-id="heading-24">第六章：扩展思考</h3>
<h4 data-id="heading-25">6.1 与其他Hook的对比</h4>





























<table><thead><tr><th>Hook</th><th>适用场景</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td><code>useInterval</code></td><td>周期性任务</td><td>简单直观，功能完善</td><td>需要手动实现</td></tr><tr><td><code>setTimeout</code>递归</td><td>需要动态调整间隔的任务</td><td>灵活性高</td><td>可能造成调用栈问题</td></tr><tr><td><code>requestAnimationFrame</code></td><td>动画、高频更新</td><td>性能好，与屏幕刷新同步</td><td>不适合长时间间隔任务</td></tr></tbody></table>
<h4 data-id="heading-26">6.2 实现useTimeout</h4>
<p>基于同样的思路，我们可以实现<code>useTimeout</code>：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useTimeout</span>(<span class="hljs-params">callback, delay</span>) {
  <span class="hljs-keyword">const</span> savedCallback = <span class="hljs-title function_">useRef</span>();

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    savedCallback.<span class="hljs-property">current</span> = callback;
  }, [callback]);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (delay === <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">tick</span> = (<span class="hljs-params"/>) =&gt; {
      savedCallback.<span class="hljs-property">current</span>?.();
    };
    
    <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">setTimeout</span>(tick, delay);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearTimeout</span>(id);
  }, [delay]);
}
</code></pre>
<h3 data-id="heading-27">总结</h3>
<p>通过手写<code>useInterval</code> Hook，我们不仅解决了一个具体的业务问题，更重要的是深入理解了React Hooks的工作原理和闭包机制。</p>
<p><strong>关键要点回顾：</strong></p>
<ol>
<li><strong>useRef是打破闭包限制的利器</strong> - 它提供在组件生命周期内持久化的可变值</li>
<li><strong>依赖分离是优化性能的关键</strong> - 不同的effect负责不同的职责</li>
<li><strong>null是暂停定时器的优雅方案</strong> - 比维护布尔状态更直观</li>
<li><strong>清理函数必不可少</strong> - 防止内存泄漏</li>
</ol>
<p>这个自定义Hook体现了React Hooks设计的精髓：<strong>逻辑复用、关注点分离、声明式编程</strong>。掌握了这些原理，你就能写出更加优雅和健壮的React代码。</p>
<p>希望这篇笔记对你有帮助！如果你有更好的实现方案或者有趣的应用场景，欢迎在评论区分享讨论～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 学习笔记：组件通信（Props / 自定义事件）与插槽（Slot）全解析]]></title>    <link>https://juejin.cn/post/7571678388954382355</link>    <guid>https://juejin.cn/post/7571678388954382355</guid>    <pubDate>2025-11-12T15:17:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571678388954382355" data-draft-id="7571648135585841195" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Vue 学习笔记：组件通信（Props / 自定义事件）与插槽（Slot）全解析"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-12T15:17:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户9242625700731"/> <meta itemprop="url" content="https://juejin.cn/user/2054336951356680"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Vue 学习笔记：组件通信（Props / 自定义事件）与插槽（Slot）全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2054336951356680/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户9242625700731
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T15:17:20.000Z" title="Wed Nov 12 2025 15:17:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作为 Vue 初学者，<strong>组件通信</strong>和<strong>插槽</strong>是实现组件复用、解耦的核心技能。这篇笔记会把这两个知识点拆解成 “一看就懂” 的形式，既是自己的学习总结，也希望能帮到同样入门的同学～</p>
<h2 data-id="heading-0">一、组件通信：父子组件的数据传递</h2>
<p>Vue 中组件是独立的，想要实现 “组件之间传数据”，核心有两种场景：<strong>父传子（Props）</strong>  和 <strong>子传父（自定义事件）</strong> 。</p>
<h3 data-id="heading-1">1. 父传子：Props 传递数据（单向数据流）</h3>
<p>父组件通过<code>props</code>把数据传递给子组件，子组件只能 “读取” 不能 “直接修改”（Vue 的单向数据流规则）。</p>
<p><strong>示例：父组件<code>ComponentA</code>向子组件<code>ComponentB</code>传值</strong></p>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- ComponentA.vue（父组件） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>ComponentA<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 第一步：在子组件标签上绑定要传递的数据 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">ComponentB</span> <span class="hljs-attr">:title</span>=<span class="hljs-string">"title"</span> <span class="hljs-attr">:age</span>=<span class="hljs-string">"age"</span> <span class="hljs-attr">:names</span>=<span class="hljs-string">"names"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ComponentB</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./ComponentB.vue"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">components</span>: { <span class="hljs-title class_">ComponentB</span> },
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">title</span>: <span class="hljs-string">"父组件传递的标题"</span>,
      <span class="hljs-attr">age</span>: <span class="hljs-number">20</span>,
      <span class="hljs-attr">names</span>: [<span class="hljs-string">"iwen"</span>, <span class="hljs-string">"ime"</span>]
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- ComponentB.vue（子组件） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ title }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ age }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(item,index) of names"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"index"</span>&gt;</span>{{ item }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-comment">// 第二步：子组件通过props选项声明接收的数据</span>
  <span class="hljs-attr">props</span>: [<span class="hljs-string">"title"</span>, <span class="hljs-string">"age"</span>, <span class="hljs-string">"names"</span>]
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><strong>进阶：Props 的类型、默认值、必填校验</strong>实际开发中，我们可以给<code>props</code>加 “类型限制、默认值、必填校验”，让组件更健壮。</p>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- ComponentB.vue（子组件） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">props</span>: {
    <span class="hljs-comment">// 限制title的类型可以是字符串、数字、数组、对象</span>
    <span class="hljs-attr">title</span>: {
      <span class="hljs-attr">type</span>: [<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Number</span>, <span class="hljs-title class_">Array</span>, <span class="hljs-title class_">Object</span>],
      <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 表示title是必填项</span>
    },
    <span class="hljs-comment">// 限制age的类型是数字，默认值为0</span>
    <span class="hljs-attr">age</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">Number</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-number">0</span>
    },
    <span class="hljs-comment">// 数组/对象的默认值必须用工厂函数返回</span>
    <span class="hljs-attr">names</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">Array</span>,
      <span class="hljs-title function_">default</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> [<span class="hljs-string">"默认名称"</span>]
      }
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-2">2. 子传父：自定义事件（$emit）传递数据</h3>
<p>子组件通过<code>this.$emit("事件名", 数据)</code>触发自定义事件，父组件通过<code>@事件名</code>监听并接收数据。</p>
<p><strong>示例：子组件<code>Child</code>向父组件<code>ComponentEvent</code>传值</strong></p>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Child.vue（子组件） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>Child<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"clickEventHandle"</span>&gt;</span>传递数据给父组件<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">msg</span>: <span class="hljs-string">"子组件的私有数据~"</span>
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">clickEventHandle</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 触发自定义事件，并传递数据msg</span>
      <span class="hljs-variable language_">this</span>.$emit(<span class="hljs-string">"someEvent"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">msg</span>)
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- ComponentEvent.vue（父组件） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>组件事件<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 监听子组件的someEvent事件，触发getHandle方法 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> @<span class="hljs-attr">someEvent</span>=<span class="hljs-string">"getHandle"</span>/&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>父组件接收的子组件数据：{{ message }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./Child.vue"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">components</span>: { <span class="hljs-title class_">Child</span> },
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">message</span>: <span class="hljs-string">""</span>
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">getHandle</span>(<span class="hljs-params">data</span>) {
      <span class="hljs-comment">// 接收子组件传递的数据，并赋值给message</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = data
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h2 data-id="heading-3">二、插槽（Slot）：让组件更灵活的 “内容插槽”</h2>
<p>插槽的作用是<strong>让父组件可以向子组件 “注入” 自定义内容</strong>，实现组件的灵活复用。Vue 的插槽分为三种：<strong>默认插槽、具名插槽、作用域插槽</strong>。</p>
<h3 data-id="heading-4">1. 默认插槽：最简单的 “内容注入”</h3>
<p>子组件用<code>&lt;slot&gt;&lt;/slot&gt;</code>预留一个 “内容坑位”，父组件在子组件标签内写的内容会自动填入这个坑位。</p>
<p><strong>示例：父组件<code>App</code>向子组件<code>SlotsTow</code>注入内容</strong></p>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- SlotsTow.vue（子组件） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>Slots续集<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 预留默认插槽的坑位 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">slot</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- App.vue（父组件） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">SlotsTow</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 父组件在这里写的内容，会被注入到子组件的slot中 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>我是父组件注入的内容<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>插槽让组件变得更灵活！<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">SlotsTow</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">SlotsTow</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./components/SlotsTow.vue"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">components</span>: { <span class="hljs-title class_">SlotsTow</span> }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><strong>默认内容：</strong>  如果父组件没注入内容，子组件可以给插槽设置 “默认内容”。</p>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- SlotsTow.vue（子组件） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>Slots续集<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 没内容时显示“默认内容” --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">slot</span>&gt;</span>父组件没传内容，我是默认显示的文字~<span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<h3 data-id="heading-5">2. 具名插槽：多个 “命名坑位” 的精准注入</h3>
<p>当子组件需要<strong>多个插槽坑位</strong>时，用<code>name</code>给每个插槽命名，父组件用<code>v-slot:名称</code>（或<code>#名称</code>）指定内容注入到哪个坑位。</p>
<p><strong>示例：子组件<code>SlotsAttr</code>有<code>header</code>和<code>main</code>两个具名插槽</strong></p>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- SlotsAttr.vue（子组件） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>具名插槽示例<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 命名为header的插槽 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"header"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 命名为main的插槽 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"main"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- App.vue（父组件） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">SlotsAttr</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 用v-slot:header指定内容注入到header插槽 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-slot:header</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>这是头部插槽的内容<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 用#main指定内容注入到main插槽（#是v-slot的简写） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">main</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是主体插槽的内容<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">SlotsAttr</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">SlotsAttr</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./components/SlotsAttr.vue"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">components</span>: { <span class="hljs-title class_">SlotsAttr</span> }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-6">3. 作用域插槽：子组件向父组件 “反向传值” 的插槽</h3>
<p>子组件在插槽中绑定数据（<code>slotProps</code>），父组件可以 “接收并使用” 这些数据，实现 <strong>“子传父式的插槽内容定制”</strong>。</p>
<p><strong>示例：子组件<code>SlotsAttr</code>向父组件传递<code>msg</code>和<code>demo</code>数据</strong></p>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- SlotsAttr.vue（子组件） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>作用域插槽示例<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 插槽中绑定数据（msg和demo） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"header"</span> <span class="hljs-attr">:msg</span>=<span class="hljs-string">"slotMsg"</span> <span class="hljs-attr">:demo</span>=<span class="hljs-string">"slotDemo"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"main"</span> <span class="hljs-attr">:msg</span>=<span class="hljs-string">"slotMsg"</span> <span class="hljs-attr">:demo</span>=<span class="hljs-string">"slotDemo"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">slotMsg</span>: <span class="hljs-string">"子组件传递的消息"</span>,
      <span class="hljs-attr">slotDemo</span>: <span class="hljs-string">"子组件传递的演示数据"</span>
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- App.vue（父组件） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">SlotsAttr</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 接收子组件传递的slotProps，并使用其中的msg和demo --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">header</span>=<span class="hljs-string">"slotProps"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>头部插槽：{{ slotProps.msg }} - {{ slotProps.demo }}<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">main</span>=<span class="hljs-string">"slotProps"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>主体插槽：{{ slotProps.msg }} - {{ slotProps.demo }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">SlotsAttr</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">SlotsAttr</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./components/SlotsAttr.vue"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">components</span>: { <span class="hljs-title class_">SlotsAttr</span> }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><strong>渲染作用域：</strong>  插槽内容是在<strong>父组件的作用域</strong>中定义的，所以可以直接访问父组件的数据；而插槽的<code>slotProps</code>是子组件传递的，父组件通过<code>v-slot</code>接收后才能使用。</p>
<h2 data-id="heading-7">三、总结：组件通信与插槽核心要点</h2>



































<table><thead><tr><th>知识点</th><th>核心作用</th><th>关键规则 / 技巧</th></tr></thead><tbody><tr><td>Props（父传子）</td><td>父组件向子组件传递数据</td><td>子组件只能读不能直接改；支持类型、默认值、必填校验；数组 / 对象默认值需用工厂函数</td></tr><tr><td>自定义事件（子传父）</td><td>子组件向父组件传递数据 / 事件</td><td>子组件用<code>this.$emit("事件名", 数据)</code>触发；父组件用<code>@事件名</code>监听</td></tr><tr><td>默认插槽</td><td>父组件向子组件注入单个自定义内容</td><td>子组件用<code>&lt;slot&gt;&lt;/slot&gt;</code>预留坑位；父组件在子组件标签内写内容即可注入</td></tr><tr><td>具名插槽</td><td>父组件向子组件注入多个命名的自定义内容</td><td>子组件用<code>name</code>给插槽命名；父组件用<code>v-slot:名称</code>（或<code>#名称</code>）指定注入位置</td></tr><tr><td>作用域插槽</td><td>子组件向父组件传递数据，父组件定制插槽内容</td><td>子组件在插槽中绑定数据（<code>slotProps</code>）；父组件用<code>v-slot="slotProps"</code>接收并使用</td></tr></tbody></table>
<p>掌握这些知识点后，Vue 组件的复用性和灵活性会大幅提升～ 后续再深入学习 Vuex、Pinia 等状态管理工具，就能应对更复杂的组件通信场景了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vite：下一代前端构建工具深度解析与实践指南]]></title>    <link>https://juejin.cn/post/7571662618055999514</link>    <guid>https://juejin.cn/post/7571662618055999514</guid>    <pubDate>2025-11-12T15:25:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571662618055999514" data-draft-id="7571678674145640458" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vite：下一代前端构建工具深度解析与实践指南"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-12T15:25:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="晴天丨"/> <meta itemprop="url" content="https://juejin.cn/user/2101921963057256"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vite：下一代前端构建工具深度解析与实践指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2101921963057256/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    晴天丨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T15:25:42.000Z" title="Wed Nov 12 2025 15:25:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在前端开发领域，构建工具的发展从未停止。从早期的 Grunt、Gulp 到 Webpack，再到现在的 Vite，每一次变革都带来了开发体验的质的飞跃。Vite 凭借其极速的启动时间和热更新能力，正在迅速成为现代前端开发的首选工具。本文将深入解析 Vite 的核心原理、使用技巧和最佳实践。</p>
<h2 data-id="heading-1">什么是 Vite？</h2>
<p>Vite（法语意为"快速"）是由 Vue.js 作者尤雨溪开发的下一代前端构建工具。它主要由两部分组成：</p>
<ul>
<li><strong>开发服务器</strong>：基于原生 ES 模块，提供丰富的内置功能</li>
<li><strong>构建命令</strong>：使用 Rollup 打包代码，输出高度优化的静态资源</li>
</ul>
<h2 data-id="heading-2">为什么选择 Vite？</h2>
<h3 data-id="heading-3">传统构建工具的痛点</h3>
<p>javascript</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 在 Webpack 中，启动大型项目可能需要几十秒甚至几分钟</span>
<span class="hljs-comment">// 每次修改代码，热更新也需要几秒钟</span>

<span class="hljs-comment">// 这是因为 Webpack 需要：</span>
<span class="hljs-number">1.</span> 构建完整的依赖图
<span class="hljs-number">2.</span> 打包所有模块
<span class="hljs-number">3.</span> 启动开发服务器
</code></pre>
<h3 data-id="heading-4">Vite 的优势</h3>
<p>bash</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 使用 Vite 启动项目</span>
npm create vite@latest <span class="hljs-keyword">my</span>-project
cd <span class="hljs-keyword">my</span>-project
npm install
npm run dev

<span class="hljs-comment"># ⚡ 通常在几毫秒内完成启动！</span>
</code></pre>
<h2 data-id="heading-5">核心原理解析</h2>
<h3 data-id="heading-6">基于 ES Modules 的开发服务器</h3>
<p>html</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 传统方式 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/dist/main.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-comment">&lt;!-- Vite 方式 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/src/main.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>Vite 利用浏览器原生支持 ES 模块的特性，只在浏览器请求时按需编译和提供源码。</p>
<h3 data-id="heading-7">依赖预构建</h3>
<p>javascript</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// Vite 会对第三方依赖进行预构建</span>
<span class="hljs-comment">// 将 CommonJS/UMD 转换为 ESM</span>
<span class="hljs-comment">// 合并多个小文件，减少请求数量</span>

<span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  optimizeDeps: {
    include: [<span class="hljs-string">'lodash-es'</span>, <span class="hljs-string">'axios'</span>]
  }
}
</code></pre>
<h2 data-id="heading-8">项目创建与配置</h2>
<h3 data-id="heading-9">快速创建项目</h3>
<p>bash</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 使用 npm</span>
npm create vite@latest

<span class="hljs-comment"># 使用 yarn</span>
yarn create vite

<span class="hljs-comment"># 使用 pnpm</span>
pnpm create vite

<span class="hljs-comment"># 指定模板</span>
npm create vite@latest <span class="hljs-keyword">my</span>-react-app -- --template react-ts
</code></pre>
<h3 data-id="heading-10">配置文件详解</h3>
<p>javascript</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// vite.config.js</span>
import { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
import vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>
import path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>

export <span class="hljs-keyword">default</span> <span class="hljs-title function_ invoke__">defineConfig</span>({
  // 插件配置
  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_ invoke__">vue</span>()],
  
  // 开发服务器配置
  <span class="hljs-attr">server</span>: {
    <span class="hljs-attr">port</span>: <span class="hljs-number">3000</span>,
    <span class="hljs-attr">open</span>: <span class="hljs-literal">true</span>, // 自动打开浏览器
    <span class="hljs-attr">proxy</span>: {
      <span class="hljs-string">'/api'</span>: {
        <span class="hljs-attr">target</span>: <span class="hljs-string">'http://localhost:8080'</span>,
        <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>
      }
    }
  },
  
  // 构建配置
  <span class="hljs-attr">build</span>: {
    <span class="hljs-attr">outDir</span>: <span class="hljs-string">'dist'</span>,
    <span class="hljs-attr">sourcemap</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">rollupOptions</span>: {
      <span class="hljs-attr">output</span>: {
        <span class="hljs-attr">manualChunks</span>: {
          <span class="hljs-attr">vendor</span>: [<span class="hljs-string">'vue'</span>, <span class="hljs-string">'vue-router'</span>],
          <span class="hljs-attr">utils</span>: [<span class="hljs-string">'lodash-es'</span>, <span class="hljs-string">'axios'</span>]
        }
      }
    }
  },
  
  // 路径别名
  <span class="hljs-attr">resolve</span>: {
    <span class="hljs-attr">alias</span>: {
      <span class="hljs-string">'@'</span>: path.<span class="hljs-title function_ invoke__">resolve</span>(__dirname, <span class="hljs-string">'./src'</span>),
      <span class="hljs-string">'~'</span>: path.<span class="hljs-title function_ invoke__">resolve</span>(__dirname, <span class="hljs-string">'./src/components'</span>)
    }
  },
  
  // CSS 配置
  <span class="hljs-attr">css</span>: {
    <span class="hljs-attr">preprocessorOptions</span>: {
      <span class="hljs-attr">scss</span>: {
        <span class="hljs-attr">additionalData</span>: `@import <span class="hljs-string">"@/styles/variables.scss"</span>;`
      }
    }
  }
})
</code></pre>
<h2 data-id="heading-11">核心功能特性</h2>
<h3 data-id="heading-12">1. 极速热更新（HMR）</h3>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Vite 提供了完整的 HMR API</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">hot</span>) {
  <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">hot</span>.<span class="hljs-title function_">accept</span>(<span class="hljs-string">'./module.js'</span>, <span class="hljs-function">(<span class="hljs-params">newModule</span>) =&gt;</span> {
    <span class="hljs-comment">// 模块更新时的回调</span>
    newModule.<span class="hljs-title function_">update</span>()
  })
  
  <span class="hljs-comment">// 自定义事件</span>
  <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">hot</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'custom-event'</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'自定义事件:'</span>, data)
  })
}
</code></pre>
<h3 data-id="heading-13">2. 环境变量处理</h3>
<p>javascript</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// .env</span>
<span class="hljs-variable constant_">VITE_API_URL</span>=<span class="hljs-attr">https</span>:<span class="hljs-comment">//api.example.com</span>
<span class="hljs-variable constant_">VITE_APP_TITLE</span>=<span class="hljs-title class_">My</span> <span class="hljs-title class_">App</span>

<span class="hljs-comment">// .env.development</span>
<span class="hljs-variable constant_">VITE_API_URL</span>=<span class="hljs-attr">http</span>:<span class="hljs-comment">//localhost:3000</span>

<span class="hljs-comment">// 在代码中使用</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_API_URL</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_APP_TITLE</span>)

<span class="hljs-comment">// 类型提示 (env.d.ts)</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ImportMetaEnv</span> {
  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">VITE_API_URL</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">VITE_APP_TITLE</span>: <span class="hljs-built_in">string</span>
}
</code></pre>
<h3 data-id="heading-14">3. 静态资源处理</h3>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 直接引入图片</span>
<span class="hljs-keyword">import</span> logoUrl <span class="hljs-keyword">from</span> <span class="hljs-string">'./logo.png'</span>
<span class="hljs-keyword">const</span> img = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'img'</span>)
img.<span class="hljs-property">src</span> = logoUrl

<span class="hljs-comment">// URL 查询参数用于资源版本控制</span>
<span class="hljs-keyword">import</span> logoUrl <span class="hljs-keyword">from</span> <span class="hljs-string">'./logo.png?t=123456'</span>

<span class="hljs-comment">// 将小资源转换为 base64</span>
<span class="hljs-keyword">import</span> inlineSvg <span class="hljs-keyword">from</span> <span class="hljs-string">'./icon.svg?raw'</span>

<span class="hljs-comment">// 获取资源路径</span>
<span class="hljs-keyword">const</span> imagePath = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">'./image.png'</span>, <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>).<span class="hljs-property">href</span>
</code></pre>
<h3 data-id="heading-15">4. CSS 和预处理器</h3>
<p>scss</p>
<pre><code class="hljs language-css" lang="css">// 支持所有主流预处理器
<span class="hljs-comment">/* style.scss */</span>
<span class="hljs-keyword">@import</span> <span class="hljs-string">'@/styles/variables'</span>;

<span class="hljs-selector-class">.button</span> {
  <span class="hljs-attribute">background</span>: $primary-color;
  
  // CSS Modules
  &amp;:<span class="hljs-built_in">global</span>(.disabled) {
    <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.5</span>;
  }
}
</code></pre>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在组件中使用</span>
<span class="hljs-keyword">import</span> styles <span class="hljs-keyword">from</span> <span class="hljs-string">'./Component.module.scss'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">{styles.button}</span>&gt;</span>Click me<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  }
}
</code></pre>
<h3 data-id="heading-16">5. TypeScript 集成</h3>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// tsconfig.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"target"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ESNext"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"useDefineForClassFields"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"lib"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"DOM"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"DOM.Iterable"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"ESNext"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"allowJs"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"skipLibCheck"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"esModuleInterop"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"allowSyntheticDefaultImports"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"strict"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"forceConsistentCasingInFileNames"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ESNext"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"moduleResolution"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Node"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"resolveJsonModule"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"isolatedModules"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"noEmit"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"jsx"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"preserve"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"baseUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"."</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"@/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/*"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"include"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/**/*.ts"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"src/**/*.d.ts"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"src/**/*.tsx"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"src/**/*.vue"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"references"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span> <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./tsconfig.node.json"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-17">插件生态系统</h2>
<h3 data-id="heading-18">常用插件推荐</h3>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>
<span class="hljs-keyword">import</span> vueJsx <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue-jsx'</span>
<span class="hljs-keyword">import</span> legacy <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-legacy'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">VitePWA</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-pwa'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">vue</span>(),
    <span class="hljs-title function_">vueJsx</span>(),
    <span class="hljs-title function_">legacy</span>({
      <span class="hljs-attr">targets</span>: [<span class="hljs-string">'defaults'</span>, <span class="hljs-string">'not IE 11'</span>]
    }),
    <span class="hljs-title class_">VitePWA</span>({
      <span class="hljs-attr">registerType</span>: <span class="hljs-string">'autoUpdate'</span>,
      <span class="hljs-attr">workbox</span>: {
        <span class="hljs-attr">globPatterns</span>: [<span class="hljs-string">'**/*.{js,css,html,ico,png,svg}'</span>]
      }
    })
  ]
})
</code></pre>
<h3 data-id="heading-19">自定义插件开发</h3>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// my-plugin.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">myPlugin</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'my-plugin'</span>,
    
    <span class="hljs-comment">// 转换 index.html</span>
    <span class="hljs-title function_">transformIndexHtml</span>(<span class="hljs-params">html</span>) {
      <span class="hljs-keyword">return</span> html.<span class="hljs-title function_">replace</span>(
        <span class="hljs-string">'&lt;title&gt;'</span>,
        <span class="hljs-string">'&lt;title&gt;My Custom Title | '</span>
      )
    },
    
    <span class="hljs-comment">// 配置服务器</span>
    <span class="hljs-title function_">configureServer</span>(<span class="hljs-params">server</span>) {
      server.<span class="hljs-property">middlewares</span>.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Request:'</span>, req.<span class="hljs-property">url</span>)
        <span class="hljs-title function_">next</span>()
      })
    },
    
    <span class="hljs-comment">// 转换代码</span>
    <span class="hljs-title function_">transform</span>(<span class="hljs-params">code, id</span>) {
      <span class="hljs-keyword">if</span> (id.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.custom'</span>)) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">`export default <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(code)}</span>`</span>
      }
    }
  }
}
</code></pre>
<h2 data-id="heading-20">性能优化实践</h2>
<h3 data-id="heading-21">1. 依赖优化</h3>
<p>javascript</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// vite.config.js</span>
export <span class="hljs-keyword">default</span> <span class="hljs-title function_ invoke__">defineConfig</span>({
  <span class="hljs-attr">optimizeDeps</span>: {
    <span class="hljs-attr">include</span>: [
      <span class="hljs-string">'vue'</span>,
      <span class="hljs-string">'vue-router'</span>,
      <span class="hljs-string">'pinia'</span>,
      <span class="hljs-string">'axios'</span>,
      <span class="hljs-string">'lodash-es'</span>
    ],
    <span class="hljs-attr">exclude</span>: [<span class="hljs-string">'@vue/composition-api'</span>]
  }
})
</code></pre>
<h3 data-id="heading-22">2. 代码分割</h3>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 动态导入实现代码分割</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">HeavyComponent</span> = <span class="hljs-title function_">defineAsyncComponent</span>(<span class="hljs-function">() =&gt;</span>
  <span class="hljs-keyword">import</span>(<span class="hljs-string">'./HeavyComponent.vue'</span>)
)

<span class="hljs-comment">// 使用注释指定 chunk 名称</span>
<span class="hljs-keyword">const</span> utils = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(
  <span class="hljs-comment">/* webpackChunkName: "utils" */</span> <span class="hljs-string">'./utils.js'</span>
)
</code></pre>
<h3 data-id="heading-23">3. 构建分析</h3>
<p>javascript</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 安装 rollup-plugin-visualizer</span>
import { visualizer } <span class="hljs-keyword">from</span> <span class="hljs-string">'rollup-plugin-visualizer'</span>

export <span class="hljs-keyword">default</span> <span class="hljs-title function_ invoke__">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_ invoke__">visualizer</span>({
      <span class="hljs-attr">filename</span>: <span class="hljs-string">'dist/stats.html'</span>,
      <span class="hljs-attr">open</span>: <span class="hljs-literal">true</span>
    })
  ]
})
</code></pre>
<h2 data-id="heading-24">高级用法</h2>
<h3 data-id="heading-25">1. 多页面应用</h3>
<p>javascript</p>
<pre><code class="hljs language-css" lang="css">// vite<span class="hljs-selector-class">.config</span><span class="hljs-selector-class">.js</span>
export default defineConfig({
  build: {
    rollupOptions: {
      <span class="hljs-selector-tag">input</span>: {
        <span class="hljs-selector-tag">main</span>: path.<span class="hljs-built_in">resolve</span>(__dirname, <span class="hljs-string">'index.html'</span>),
        admin: path.<span class="hljs-built_in">resolve</span>(__dirname, <span class="hljs-string">'admin.html'</span>),
        about: path.<span class="hljs-built_in">resolve</span>(__dirname, <span class="hljs-string">'about.html'</span>)
      }
    }
  }
})
</code></pre>
<h3 data-id="heading-26">2. 库模式开发</h3>
<p>javascript</p>
<pre><code class="hljs language-css" lang="css">// vite<span class="hljs-selector-class">.config</span><span class="hljs-selector-class">.js</span>
export default defineConfig({
  build: {
    lib: {
      entry: path.<span class="hljs-built_in">resolve</span>(__dirname, <span class="hljs-string">'lib/main.js'</span>),
      name: <span class="hljs-string">'MyLib'</span>,
      fileName: (format) =&gt; `my-lib.${format}<span class="hljs-selector-class">.js</span>`
    },
    rollupOptions: {
      external: [<span class="hljs-string">'vue'</span>],
      output: {
        globals: {
          vue: <span class="hljs-string">'Vue'</span>
        }
      }
    }
  }
})
</code></pre>
<h3 data-id="heading-27">3. SSR 支持</h3>
<p>javascript</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// vite.config.js</span>
export <span class="hljs-keyword">default</span> <span class="hljs-title function_ invoke__">defineConfig</span>({
  <span class="hljs-attr">build</span>: {
    <span class="hljs-attr">ssr</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">rollupOptions</span>: {
      <span class="hljs-attr">input</span>: <span class="hljs-string">'src/entry-server.js'</span>,
      <span class="hljs-attr">output</span>: {
        <span class="hljs-attr">dir</span>: <span class="hljs-string">'dist/server'</span>
      }
    }
  }
})
</code></pre>
<h2 data-id="heading-28">常见问题与解决方案</h2>
<h3 data-id="heading-29">1. 路径别名不生效</h3>
<p>javascript</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 确保在 tsconfig.json 和 vite.config.js 中都配置了</span>
<span class="hljs-comment">// vite.config.js</span>
resolve: {
  <span class="hljs-keyword">alias</span>: {
    <span class="hljs-string">'@'</span>: path.resolve(__dirname, <span class="hljs-string">'./src'</span>)
  }
}

<span class="hljs-comment">// tsconfig.json</span>
{
  <span class="hljs-string">"compilerOptions"</span>: {
    <span class="hljs-string">"paths"</span>: {
      <span class="hljs-string">"@/*"</span>: [<span class="hljs-string">"./src/*"</span>]
    }
  }
}
</code></pre>
<h3 data-id="heading-30">2. 热更新失效</h3>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 检查是否为原生 ES 模块</span>
<span class="hljs-comment">// 确保没有使用 CommonJS 语法</span>
<span class="hljs-keyword">import</span> { method } <span class="hljs-keyword">from</span> <span class="hljs-string">'./module.js'</span> <span class="hljs-comment">// ✅</span>
<span class="hljs-keyword">const</span> { method } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./module.js'</span>) <span class="hljs-comment">// ❌</span>
</code></pre>
<h3 data-id="heading-31">3. 生产环境资源路径问题</h3>
<p>javascript</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-function"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title">defineConfig</span><span class="hljs-params">({
  base: <span class="hljs-string">'./'</span>, <span class="hljs-comment">// 相对路径</span>
  <span class="hljs-comment">// 或者</span>
  base: <span class="hljs-string">'/my-project/'</span> <span class="hljs-comment">// 部署到子路径</span>
})</span>
</span></code></pre>
<h2 data-id="heading-32">与其他工具对比</h2>









































<table><thead><tr><th>特性</th><th>Vite</th><th>Webpack</th><th>Snowpack</th></tr></thead><tbody><tr><td>启动时间</td><td>⚡ 极快</td><td>🐢 较慢</td><td>⚡ 快</td></tr><tr><td>热更新</td><td>⚡ 极快</td><td>🐢 较慢</td><td>⚡ 快</td></tr><tr><td>配置复杂度</td><td>简单</td><td>复杂</td><td>简单</td></tr><tr><td>生态成熟度</td><td>良好</td><td>优秀</td><td>一般</td></tr><tr><td>生产构建</td><td>Rollup</td><td>Webpack</td><td>esbuild</td></tr></tbody></table>
<h2 data-id="heading-33">实战示例：完整的 Vite + Vue3 项目</h2>
<p>javascript</p>
<pre><code class="hljs language-css" lang="css">// vite<span class="hljs-selector-class">.config</span><span class="hljs-selector-class">.js</span>
import { defineConfig } <span class="hljs-selector-tag">from</span> 'vite'
import vue <span class="hljs-selector-tag">from</span> '<span class="hljs-keyword">@vitejs</span>/plugin-vue'
import { createSvgIconsPlugin } <span class="hljs-selector-tag">from</span> 'vite-plugin-svg-icons'
import path <span class="hljs-selector-tag">from</span> 'path'

export default defineConfig({
  plugins: [
    <span class="hljs-built_in">vue</span>(),
    <span class="hljs-built_in">createSvgIconsPlugin</span>({
      iconDirs: [path.<span class="hljs-built_in">resolve</span>(process.<span class="hljs-built_in">cwd</span>(), <span class="hljs-string">'src/icons'</span>)],
      symbolId: <span class="hljs-string">'icon-[dir]-[name]'</span>
    })
  ],
  server: {
    proxy: {
      '/api': {
        target: <span class="hljs-string">'http://localhost:3000'</span>,
        changeOrigin: true,
        rewrite: (path) =&gt; path.<span class="hljs-built_in">replace</span>(/^/api/, <span class="hljs-string">''</span>)
      }
    }
  },
  css: {
    preprocessorOptions: {
      scss: {
        additionalData: `
          @import <span class="hljs-string">"@/styles/variables.scss"</span>;
          <span class="hljs-keyword">@import</span> <span class="hljs-string">"@/styles/mixins.scss"</span>;
        `
      }
    }
  }
})
</code></pre>
<h2 data-id="heading-34">结语</h2>
<p>Vite 代表了前端构建工具的未来方向，它的出现极大地提升了开发体验。通过本文的介绍，相信你已经对 Vite 有了全面的了解。无论是新项目启动还是现有项目迁移，Vite 都是一个值得尝试的优秀选择。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[鸿蒙相对布局RelativeContainer详解]]></title>    <link>https://juejin.cn/post/7571641339688960000</link>    <guid>https://juejin.cn/post/7571641339688960000</guid>    <pubDate>2025-11-12T11:49:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571641339688960000" data-draft-id="7571650164843790370" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="鸿蒙相对布局RelativeContainer详解"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-11-12T11:49:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="金鸿客"/> <meta itemprop="url" content="https://juejin.cn/user/4072230193213886"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            鸿蒙相对布局RelativeContainer详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4072230193213886/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    金鸿客
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T11:49:13.000Z" title="Wed Nov 12 2025 11:49:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在应用的开发过程中，经常需要设计复杂界面，此时涉及到多个相同或不同组件之间的嵌套。如果布局组件嵌套深度过深，或者嵌套组件数过多，会带来额外的开销。如果在布局的方式上进行优化，就可以有效的提升性能，减少时间开销。 RelativeContainer是一种采用相对布局的容器，支持容器内部的子元素设置相对位置关系，适用于处理界面复杂的场景，对多个子元素进行对齐和排列。子元素可以指定兄弟元素或父容器作为锚点，基于锚点进行相对位置布局。在使用锚点时，需注意子元素的相对位置关系，以避免出现错位或遮挡的情况。相对布局示意图如下
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b50eec7d60ed4d91bebc36c1f3fb4f3e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6bi_5a6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763552953&amp;x-signature=3xQT4gbjpLiXYANeubRmf3lp9l4%3D" alt="img004_1.png" loading="lazy"/></p>
<h2 data-id="heading-0">基本概念</h2>
<ul>
<li>参考边界：设置当前组件的哪个边界对齐到锚点。</li>
<li>锚点：通过锚点设置当前元素基于哪个元素确定位置。</li>
<li>对齐方式：通过对齐方式，设置当前元素是基于锚点的上中下对齐，还是基于锚点的左中右对齐。</li>
<li>链：将一系列组件以首尾相连的方式对齐，可以形成一条链。通过设置链的模式，可以指定链上元素的排列方式。</li>
<li>辅助线：辅助线是在容器内虚拟出的额外水平或垂直锚点，便于统一对齐至某个偏移位置。</li>
<li>屏障：屏障是指容器内一组指定组件在特定方向上的共同最远边界，例如，一组组件下方的屏障，是指这些组件底部边缘中最底部的那个边界。</li>
</ul>
<h2 data-id="heading-1">设置依赖关系</h2>
<h3 data-id="heading-2">设置参考边界</h3>
<p>设置当前组件的哪个边界对齐到锚点。容器内子组件的参考边界区分水平方向和垂直方向。</p>
<ul>
<li>在水平方向上，可以按照起始（left）、居中（middle）或尾端（right）的组件边界与锚点对齐。当设置三个边界时，仅起始（left）和居中（middle）的边界设置生效。</li>
<li>在垂直方向上，可以设置组件边界与锚点对齐，具体包括顶部（top）、居中（center）和底部（bottom）。当设置三个边界时，仅顶部（top）和居中（center）生效。</li>
</ul>
<h3 data-id="heading-3">设置锚点</h3>
<p>锚点设置涉及子元素相对于其父元素或兄弟元素的位置依赖关系。具体而言，子元素可以将其位置锚定到相对布局容器（RelativeContainer）、辅助线（guideline）、屏障（barrier）或其他子元素上。 为了准确定义锚点，RelativeContainer的子元素必须拥有唯一的组件标识（id），用于指定锚点信息。父元素RelativeContainer的标识默认为“<strong>container</strong>”，其他子元素的组件标识（id）则通过id属性设置。</p>
<blockquote>
<p>说明</p>
<ul>
<li>未设置组件标识（id）的组件虽可显示，但无法被其他组件引用为锚点。相对布局容器会为其拼接组件标识，但组件标识（id）的规律无法被应用感知。辅助线（guideline）与屏障（barrier）的组件标识（id）需确保唯一，避免与任何组件冲突。若有重复，遵循组件 &gt; guideline &gt; barrier 的优先级。</li>
<li>组件间设置锚点时应避免形成依赖循环（组件之间设置链除外），依赖循环将导致子组件缺乏定位基准，最终无法绘制。</li>
</ul>
</blockquote>
<h3 data-id="heading-4">设置相对于锚点的对齐位置</h3>
<p>设置了锚点之后，可以通过alignRules属性的align设置相对于锚点的对齐位置。</p>
<ul>
<li>在水平方向上，对齐位置可以设置为HorizontalAlign.Start、HorizontalAlign.Center、HorizontalAlign.End。</li>
<li>在垂直方向上，对齐位置可以设置为VerticalAlign.Top、VerticalAlign.Center、VerticalAlign.Bottom。</li>
</ul>
<h3 data-id="heading-5">子组件位置偏移</h3>
<p>子组件经过相对位置对齐后，可能尚未达到目标位置。开发者可根据需要设置额外偏移（offset）。当使用offset调整位置的组件作为锚点时，对齐位置为设置offset之前的位置。从API Version 11开始，新增了Bias对象，建议API Version 11及以后的版本使用bias来设置额外偏移。示例如下</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
<span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
  <span class="hljs-title class_">Row</span>() {
    <span class="hljs-title class_">RelativeContainer</span>() {
      <span class="hljs-title class_">Row</span>() {
        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row1'</span>)
      }
      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
      .<span class="hljs-title function_">width</span>(<span class="hljs-number">100</span>)
      .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)
      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#a3cf62'</span>)
      .<span class="hljs-title function_">alignRules</span>({
        <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Top</span> },
        <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> }
      })
      .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row1"</span>)

      <span class="hljs-title class_">Row</span>() {
        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row2'</span>)
      }
      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
      .<span class="hljs-title function_">width</span>(<span class="hljs-number">100</span>)
      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#00ae9d'</span>)
      .<span class="hljs-title function_">alignRules</span>({
        <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Top</span> },
        <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> },
        <span class="hljs-attr">bottom</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row1"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span> },
      })
      .<span class="hljs-title function_">offset</span>({
        <span class="hljs-attr">x</span>: -<span class="hljs-number">40</span>,
        <span class="hljs-attr">y</span>: -<span class="hljs-number">20</span>
      })
      .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row2"</span>)

      <span class="hljs-title class_">Row</span>() {
        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row3'</span>)
      }
      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
      .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)
      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#0a59f7'</span>)
      .<span class="hljs-title function_">alignRules</span>({
        <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row1"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> },
        <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row1"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> },
        <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row2"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> }
      })
      .<span class="hljs-title function_">offset</span>({
        <span class="hljs-attr">x</span>: -<span class="hljs-number">10</span>,
        <span class="hljs-attr">y</span>: -<span class="hljs-number">20</span>
      })
      .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row3"</span>)

      <span class="hljs-title class_">Row</span>() {
        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row4'</span>)
      }
      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#2ca9e0'</span>)
      .<span class="hljs-title function_">alignRules</span>({
        <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row3"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> },
        <span class="hljs-attr">bottom</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> },
        <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> },
        <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row1"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> }
      })
      .<span class="hljs-title function_">offset</span>({
        <span class="hljs-attr">x</span>: -<span class="hljs-number">10</span>,
        <span class="hljs-attr">y</span>: -<span class="hljs-number">30</span>
      })
      .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row4"</span>)

      <span class="hljs-title class_">Row</span>() {
        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row5'</span>)
      }
      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#30c9f7'</span>)
      .<span class="hljs-title function_">alignRules</span>({
        <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row3"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> },
        <span class="hljs-attr">bottom</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> },
        <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row2"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> },
        <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row2"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> }
      })
      .<span class="hljs-title function_">offset</span>({
        <span class="hljs-attr">x</span>: <span class="hljs-number">10</span>,
        <span class="hljs-attr">y</span>: <span class="hljs-number">20</span>
      })
      .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row5"</span>)

      <span class="hljs-title class_">Row</span>() {
        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row6'</span>)
      }
      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#ff33ffb5'</span>)
      .<span class="hljs-title function_">alignRules</span>({
        <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row3"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> },
        <span class="hljs-attr">bottom</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row4"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> },
        <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row3"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> },
        <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row3"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> }
      })
      .<span class="hljs-title function_">offset</span>({
        <span class="hljs-attr">x</span>: -<span class="hljs-number">15</span>,
        <span class="hljs-attr">y</span>: <span class="hljs-number">10</span>
      })
      .<span class="hljs-title function_">backgroundImagePosition</span>(<span class="hljs-title class_">Alignment</span>.<span class="hljs-property">Bottom</span>)
      .<span class="hljs-title function_">backgroundImageSize</span>(<span class="hljs-title class_">ImageSize</span>.<span class="hljs-property">Cover</span>)
      .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row6"</span>)
    }
    .<span class="hljs-title function_">width</span>(<span class="hljs-number">300</span>).<span class="hljs-title function_">height</span>(<span class="hljs-number">300</span>)
    .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">50</span> })
    .<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">"#6699FF"</span> })
  }
  .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
}
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17bb1edb06aa4f1284fe5b0296ef1835~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6bi_5a6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763552953&amp;x-signature=ePfEsv6UmyHTyDL62yzp745fHKw%3D" alt="img004_2.png" loading="lazy"/></p>
<h2 data-id="heading-6">组件尺寸</h2>
<p>当同时存在前端页面设置的子组件尺寸和相对布局规则时，子组件的绘制尺寸依据约束规则确定。从API Version 11开始，此规则有所变化，子组件自身设置的尺寸优先级高于相对布局规则中的对齐锚点尺寸。因此，若要使子组件与锚点严格对齐，应仅使用alignRules，避免使用尺寸设置。</p>
<blockquote>
<p>说明</p>
<ul>
<li>根据约束条件和子组件自身的size属性无法确定子组件的大小，此时，不绘制该子组件。</li>
<li>在同一方向上设置两个或更多锚点时，若这些锚点的位置顺序有误，该子组件将被视为大小为0而不予绘制。</li>
</ul>
</blockquote>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Row</span>() {
      <span class="hljs-title class_">RelativeContainer</span>() {
        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row1'</span>)
        }
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-number">100</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#a3cf62'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Top</span> },
          <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> }
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row1"</span>)

        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row2'</span>)
        }
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-number">100</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#00ae9d'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Top</span> },
          <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> },
          <span class="hljs-attr">bottom</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row1"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span> },
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row2"</span>)

        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row3'</span>)
        }
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#0a59f7'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row1"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> },
          <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row1"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> },
          <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row2"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> }
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row3"</span>)

        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row4'</span>)
        }.<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#2ca9e0'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row3"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> },
          <span class="hljs-attr">bottom</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> },
          <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> },
          <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row1"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> }
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row4"</span>)

        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row5'</span>)
        }.<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#30c9f7'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row3"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> },
          <span class="hljs-attr">bottom</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> },
          <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row2"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> },
          <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row2"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> }
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row5"</span>)

        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row6'</span>)
        }
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#ff33ffb5'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row3"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> },
          <span class="hljs-attr">bottom</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row4"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> },
          <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row3"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> },
          <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row3"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> }
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row6"</span>)
        .<span class="hljs-title function_">backgroundImagePosition</span>(<span class="hljs-title class_">Alignment</span>.<span class="hljs-property">Bottom</span>)
        .<span class="hljs-title function_">backgroundImageSize</span>(<span class="hljs-title class_">ImageSize</span>.<span class="hljs-property">Cover</span>)
      }
      .<span class="hljs-title function_">width</span>(<span class="hljs-number">300</span>).<span class="hljs-title function_">height</span>(<span class="hljs-number">300</span>)
      .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">50</span> })
      .<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">"#6699FF"</span> })
    }
    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
  }
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e13895426c6749398d9f9d6839b2a671~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6bi_5a6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763552953&amp;x-signature=JiAFOMB7hMqXFS8gteX%2BvZo8ezM%3D" alt="img004_3.png" loading="lazy"/></p>
<h2 data-id="heading-7">多个组件形成链</h2>
<p>链的形成依赖于组件之间的关联关系。以组件A和组件B构成的最简水平链为例，其依赖关系为：锚点1 &lt;-- 组件A &lt;---&gt; 组件B --&gt; 锚点2，即A具有left锚点，B具有right锚点，同时A的right锚点与B的HorizontalAlign.Start对齐，B的left锚点与A的HorizontalAlign.End对齐。</p>
<blockquote>
<ul>
<li>链的方向和格式在链头组件的chainMode接口中声明；链内元素的bias属性全部失效，链头元素的bias属性作为整个链的bias生效。链头是指在满足成链规则时链的第一个组件（在水平方向上，从左边开始，镜像语言中从右边开始；在垂直方向上，从上边开始）。</li>
<li>如果链内所有元素的size超出链的锚点约束，超出部分将被均匀分配到链的两侧。在PACKED链中，可以通过Bias设置超出部分的分布。</li>
</ul>
</blockquote>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Row</span>() {
      <span class="hljs-title class_">RelativeContainer</span>() {
        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row1'</span>)
        }
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#a3cf62'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> },
          <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row2"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> },
          <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Top</span> }
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row1"</span>)
        .<span class="hljs-title function_">chainMode</span>(<span class="hljs-title class_">Axis</span>.<span class="hljs-property">Horizontal</span>, <span class="hljs-title class_">ChainStyle</span>.<span class="hljs-property">SPREAD</span>)

        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row2'</span>)
        }
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#00ae9d'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row1"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> },
          <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row3"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> },
          <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row1"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Top</span> }
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row2"</span>)

        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row3'</span>)
        }
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#0a59f7'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row2"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> },
          <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> },
          <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row1"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Top</span> }
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row3"</span>)

        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row4'</span>)
        }
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#a3cf62'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> },
          <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row5"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> },
          <span class="hljs-attr">center</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span> }
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row4"</span>)
        .<span class="hljs-title function_">chainMode</span>(<span class="hljs-title class_">Axis</span>.<span class="hljs-property">Horizontal</span>, <span class="hljs-title class_">ChainStyle</span>.<span class="hljs-property">SPREAD_INSIDE</span>)

        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row5'</span>)
        }
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#00ae9d'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row4"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> },
          <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row6"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> },
          <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row4"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Top</span> }
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row5"</span>)

        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row6'</span>)
        }
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#0a59f7'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row5"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> },
          <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> },
          <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row4"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Top</span> }
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row6"</span>)

        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row7'</span>)
        }
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#a3cf62'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> },
          <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row8"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> },
          <span class="hljs-attr">bottom</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> }
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row7"</span>)
        .<span class="hljs-title function_">chainMode</span>(<span class="hljs-title class_">Axis</span>.<span class="hljs-property">Horizontal</span>, <span class="hljs-title class_">ChainStyle</span>.<span class="hljs-property">PACKED</span>)

        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row8'</span>)
        }
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#00ae9d'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row7"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> },
          <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row9"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> },
          <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row7"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Top</span> }
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row8"</span>)

        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row9'</span>)
        }
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#0a59f7'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row8"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> },
          <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> },
          <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row7"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Top</span> }
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row9"</span>)
      }
      .<span class="hljs-title function_">width</span>(<span class="hljs-number">300</span>).<span class="hljs-title function_">height</span>(<span class="hljs-number">300</span>)
      .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">50</span> })
      .<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">"#6699FF"</span> })
    }
    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
  }
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aea366bad8af420d810a9f968215d634~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6bi_5a6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763552953&amp;x-signature=JqX8lwJgYJM2pP4lNOxLq7YXit4%3D" alt="img004_4.png" loading="lazy"/></p>
<h2 data-id="heading-8">使用辅助线辅助定位子组件</h2>
<p>辅助线（guideLine）是在容器内虚拟出的额外水平或垂直锚点，便于统一对齐到特定偏移位置，从而避免为每个组件单独编写重复的偏移设置。 辅助线分为垂直（Vertical）和水平（Horizontal）两种：垂直辅助线通过start和end属性指定其距离容器左侧和右侧的距离；水平辅助线通过start和end属性指定其距离容器顶部和底部的距离。</p>
<ul>
<li>如果同时设置了start和end，当两者规则冲突时，仅start属性生效。</li>
<li>若容器在某个方向的尺寸被声明为"auto"，则该方向上的guideLine位置只能使用start属性声明（不允许使用百分比）。</li>
</ul>
<h2 data-id="heading-9">多个组件的屏障</h2>
<p>屏障（barrier）是容器内一组指定组件在指定方向上的公共最远边界。例如，一组组件下方的屏障是它们底部最靠下的位置，可以理解为坐标取min/max。使用屏障可以实现组件不与一组参考组件中的任何一个重叠等效果。 屏障可以有上下左右四个方向。垂直方向（TOP，BOTTOM）的屏障仅能作为组件的水平方向锚点，用作垂直方向锚点时值为0；水平方向（LEFT，RIGHT）的屏障仅能作为组件的垂直方向锚点，用作水平方向锚点时值为0。</p>
<p>如下代码定义了两个屏障，分别是参考组件row1和row2各自右侧边界与底部边界。使用这两个屏障作为row3和row4的锚点，可以方便地避免组件间出现不必要的重叠。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Row</span>() {
      <span class="hljs-title class_">RelativeContainer</span>() {
        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row1'</span>)
        }
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-number">100</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#a3cf62'</span>)
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row1"</span>)

        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row2'</span>)
        }
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-number">100</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#00ae9d'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">middle</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row1"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> },
          <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row1"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> }
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row2"</span>)

        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row3'</span>)
        }
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-number">100</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#0a59f7'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"barrier1"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> },
          <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row1"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Top</span> }
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row3"</span>)

        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row4'</span>)
        }
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-number">50</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#2ca9e0'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row1"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> },
          <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"barrier2"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> }
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row4"</span>)
      }
      .<span class="hljs-title function_">width</span>(<span class="hljs-number">300</span>)
      .<span class="hljs-title function_">height</span>(<span class="hljs-number">300</span>)
      .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">50</span> })
      .<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">"#6699FF"</span> })
      .<span class="hljs-title function_">barrier</span>([{ <span class="hljs-attr">id</span>: <span class="hljs-string">"barrier1"</span>, <span class="hljs-attr">direction</span>: <span class="hljs-title class_">BarrierDirection</span>.<span class="hljs-property">RIGHT</span>, <span class="hljs-attr">referencedId</span>: [<span class="hljs-string">"row1"</span>, <span class="hljs-string">"row2"</span>] },
        { <span class="hljs-attr">id</span>: <span class="hljs-string">"barrier2"</span>, <span class="hljs-attr">direction</span>: <span class="hljs-title class_">BarrierDirection</span>.<span class="hljs-property">BOTTOM</span>, <span class="hljs-attr">referencedId</span>: [<span class="hljs-string">"row1"</span>, <span class="hljs-string">"row2"</span>] }])
    }
    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
  }
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a85202361c1472f9a002d6deac98c76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6bi_5a6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763552953&amp;x-signature=GB0S9iSTjc9eU%2BW7Y6Qtrgf7fxk%3D" alt="img004_5.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Android】给App添加启动画面——SplashScreen]]></title>    <link>https://juejin.cn/post/7571693273728434212</link>    <guid>https://juejin.cn/post/7571693273728434212</guid>    <pubDate>2025-11-12T15:08:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571693273728434212" data-draft-id="7571657746346704950" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Android】给App添加启动画面——SplashScreen"/> <meta itemprop="keywords" content="Java,Android"/> <meta itemprop="datePublished" content="2025-11-12T15:08:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="泥嚎泥嚎"/> <meta itemprop="url" content="https://juejin.cn/user/1197828179492985"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Android】给App添加启动画面——SplashScreen
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1197828179492985/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    泥嚎泥嚎
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T15:08:05.000Z" title="Wed Nov 12 2025 15:08:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【Android】给App添加启动画面——SplashScreen</h2>
<h3 data-id="heading-1">引言</h3>
<p>当我们点击应用图标时，经常会看到一瞬间的白屏或黑屏，然后才进入应用界面。这种现象并不是 bug，在 Android 12 之前，这是系统在创建进程到 Activity 完成第一帧绘制之间临时绘制的一个默认窗口，这个窗口的背景就是我们在主题中设置的<code>windowBackground</code>，默认是白色或黑色。</p>
<p>从 Android 12开始，在所有应用的<strong>冷启动</strong>和<strong>温启动</strong>期间，系统会应用 Android 系统的默认启动画面。SplashScreen 在 Android 12 上是强制的，即使什么都不做，应用在 Android 12 上也会自动拥有 SplashScreen 界面。默认情况下，App 的 Launcher 图标会作为 SplashScreen 界面的中央图标，<code>windowBackground</code>属性指定的颜色会作为 SplashScreen 界面的背景颜色，不过这些都可以修改。</p>
<h3 data-id="heading-2">应用启动方式</h3>
<p>应用有三种启动状态：冷启动、温启动和热启动。</p>
<h4 data-id="heading-3">冷启动</h4>
<p>冷启动是指应用进程完全不存在，系统需要从零开始创建整个应用环境。</p>
<p><strong>典型场景</strong>：</p>
<ul>
<li>第一次打开应用</li>
<li>系统杀掉了后台进程（比如内存不足）</li>
<li>用户强制关闭了应用</li>
</ul>
<p>冷启动应用将经历两个阶段：</p>
<p><strong>第一阶段</strong></p>
<blockquote>
<ol>
<li>
<p><strong>加载并启动应用</strong></p>
<ul>
<li>当用户点击应用图标（或某个 Intent 启动入口）时，
系统（ActivityManagerService）会开始加载应用。</li>
<li>系统根据应用的 <code>AndroidManifest.xml</code> 查找入口 Activity。</li>
<li>系统准备启动该应用对应的进程环境。</li>
</ul>
</li>
<li>
<p><strong>显示空白启动窗口</strong></p>
<ul>
<li>
<p>在启动 Activity 之前，为了防止用户看到黑屏或空白延迟，系统会立即显示一个“starting window”（启动窗口）。</p>
</li>
<li>
<p>这个窗口的外观取决于你的应用主题的 <code>windowBackground</code> 属性。</p>
</li>
<li>
<p>如果没有定义，它通常是默认的纯白色背景（这就是经常看到“白屏”的原因）。</p>
</li>
<li>
<p>从 Android 12 开始，这个阶段由系统 SplashScreen 机制接管：会显示应用图标和背景，而不是纯白。</p>
</li>
</ul>
</li>
<li>
<p><strong>创建应用进程</strong></p>
<ul>
<li>从这一刻起，责任开始从“系统”转移到“应用自身”。</li>
</ul>
</li>
</ol>
</blockquote>
<p><strong>第二阶段</strong></p>
<p>系统一旦创建了应用进程，应用进程就要负责做以下的任务</p>
<blockquote>
<ol>
<li>创建 Application 对象</li>
<li>启动主线程</li>
<li>创建主 Activity</li>
<li>填充视图</li>
<li>布局计算</li>
<li>执行初次绘制</li>
</ol>
</blockquote>
<h4 data-id="heading-4">温启动</h4>
<p>应用进程存在，但 Activity 栈被完全清理，需要重新创建主 Activity。温启动会执行冷启动中的部分操作，但比冷启动轻一些，比热启动重一些。</p>
<h4 data-id="heading-5">热启动</h4>
<p>应用进程已经在后台运行，用户重新打开应用。</p>
<h3 data-id="heading-6">启动画面的元素</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/293f94759ee84f1798c5c410e403e6be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rOl5ZqO5rOl5ZqO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763564885&amp;x-signature=5LnGCAtABazj%2BUNwsL99thHc%2F7o%3D" alt="" loading="lazy"/></p>
<p>图上四个区域分别是：</p>
<ol>
<li><strong>中央显示的图标</strong>：必须是矢量可绘制对象。可以指定一个静态图标或动画图标，动画持续时间理论上没有限制，但官方建议不要超过 1 秒，启动画面的目的只是“平滑过渡”，而不是做长时间动画。如果没有显示指定图标，默认使用应用启动器图标。</li>
<li><strong>图标背景</strong>：可选项，用于在标与启动页背景颜色之间增加视觉对比度。如果你的图标颜色太浅或太透明，比如白色图标配白底，就可以使用图标背景。如果图标本身是 Adaptive Icon（自适应图标），系统会自动判断是否显示它的背景层。</li>
<li><strong>遮罩区域</strong>：启动画面中央的图标（前景层）会被按自适应图标规范进行裁剪（mask）。裁剪比例和自适应图标一样图标前景的边界约占总直径的 2/3（即留 1/3 的安全边距）。图标设计时不要画满整个圆，否则会被裁切。这样做的目的是保持视觉一致性，不同 App 的启动图标在 SplashScreen 中尺寸一致，不会显得不协调。</li>
<li><strong>窗口背景</strong>：启动画面的背景是一个<strong>纯色</strong>。不支持渐变或图片填充。如果没有明确指定颜色，系统会使用主题中设置的<code>windowBackground</code>作为默认背景颜色。</li>
</ol>
<h3 data-id="heading-7">SplashScreen API 基本使用</h3>
<h4 data-id="heading-8">环境配置</h4>
<p>首先添加依赖：</p>
<pre><code class="hljs language-java" lang="java">dependencies {
    implementation <span class="hljs-string">'androidx.core:core-splashscreen:1.0.1'</span>
}
</code></pre>
<h4 data-id="heading-9">第一步：创建 SplashScreen 主题</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"Theme.App.Starting"</span> <span class="hljs-attr">parent</span>=<span class="hljs-string">"Theme.SplashScreen"</span>&gt;</span><span class="xml">
    <span class="hljs-comment">&lt;!-- 设置背景颜色 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"windowSplashScreenBackground"</span>&gt;</span>@color/splash_background<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 设置中心图标 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"windowSplashScreenAnimatedIcon"</span>&gt;</span>@drawable/ic_launcher_foreground<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 设置图标动画时长（毫秒） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"windowSplashScreenAnimationDuration"</span>&gt;</span>1000<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 设置图标背景（可选） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"windowSplashScreenIconBackground"</span>&gt;</span>@color/splash_icon_background<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 设置底部品牌图（不推荐常用） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"android:windowSplashScreenBrandingImage"</span>&gt;</span>@drawable/...<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 设置图标显示策略（Android 13+ 可控制是否强制显示图标） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"android:windowSplashScreenBehavior"</span>&gt;</span>icon_preferred<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 设置SplashScreen结束后使用的主题 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"postSplashScreenTheme"</span>&gt;</span>@style/Theme.App<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>这里定义了一个主题，应继承自 <code>Theme.SplashScreen</code>。</p>
<p>下面详细看一下它的属性：</p>
<ol>
<li>
<p><code>android:windowSplashScreenBackground</code></p>
<p>启动画面背景颜色（<strong>必须是单一不透明颜色</strong>）。当系统决定使用 SplashScreen 时，会把该颜色填充为背景。如果未设置该属性，系统会回退去使用 <code>android:windowBackground</code>（但仅当它是纯色时才会被用到）。</p>
</li>
<li>
<p><code>android:windowSplashScreenAnimatedIcon</code></p>
<p>指定启动页中间显示的图标，可以是静态矢量或 <code>AnimatedVectorDrawable</code>（推荐使用矢量）。如果未指定，系统会尝试使用应用的 launcher icon（前提：图标为可识别的 adaptive/vector）。官方建议动画时长 <strong>不要超过 1000 ms</strong>。</p>
</li>
<li>
<p><code>android:windowSplashScreenAnimationDuration</code></p>
<p>表示图标动画的时长（毫秒）。</p>
<p><strong>注意</strong>：这个属性<strong>不控制 SplashScreen 在屏幕上保持的总时长</strong>，它只是便于你在自定义退出动画时读取该时长（通过 API 获取 <code>SplashScreenView.getIconAnimationDuration()</code>），以便做同步动画。它不能让 Splash 显示更久。想延长停留时间应使用 <code>SplashScreen.setKeepOnScreenCondition(...)</code> 或 <code>OnPreDrawListener</code>。</p>
</li>
<li>
<p><code>android:windowSplashScreenIconBackgroundColor</code></p>
<p>图标后面的圆背景色（增强图标与背景的对比）。当图标颜色与窗口背景对比不足时很有用。如果使用的是 adaptive icon（自适应图标），系统会根据对比度决定是否显示背景，也可以明确提供一个颜色。</p>
</li>
<li>
<p><code>android:windowSplashScreenBrandingImage</code></p>
<p>在启动页底部显示一个品牌图片（logo、slogan 等）。官方不推荐频繁使用，因会增加视觉噪音并可能导致布局兼容问题。如果使用，保持图片简单、轻量，避免在不同屏幕比例下被截断。</p>
</li>
<li>
<p><code>android:windowSplashScreenBehavior</code>（Android 13+）</p>
<p>指定是否始终显示图标或遵循系统/Activity 提示的显示策略。</p>
<p>默认行为：如果启动 Activity 指定了 <code>SPLASH_SCREEN_STYLE_ICON</code> 风格，显示图标；否则遵循系统默认行为（系统可能在某些场景下不显示空白图标）。</p>
<p><code>icon_preferred</code>：<strong>优先显示图标</strong>，即便系统默认不会显示空白图标时也强制显示动画图标，避免出现空白启动页。</p>
<p>如果不想出现空白（没有图标）的启动页，且总是希望看到 app 图标，可以把 <code>windowSplashScreenBehavior</code> 设置为 <code>icon_preferred</code>。</p>
</li>
<li>
<p><code>postSplashScreenTheme</code></p>
<p>系统启动完 SplashScreen 后自动切换到的正式主题。</p>
</li>
</ol>
<h4 data-id="heading-10">第二步：在 Manifest 中应用主题</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">application</span>
        <span class="hljs-attr">android:allowBackup</span>=<span class="hljs-string">"true"</span>
        <span class="hljs-attr">android:dataExtractionRules</span>=<span class="hljs-string">"@xml/data_extraction_rules"</span>
        <span class="hljs-attr">android:fullBackupContent</span>=<span class="hljs-string">"@xml/backup_rules"</span>
        <span class="hljs-attr">android:icon</span>=<span class="hljs-string">"@mipmap/ic_launcher"</span>
        <span class="hljs-attr">android:label</span>=<span class="hljs-string">"@string/app_name"</span>
        <span class="hljs-attr">android:roundIcon</span>=<span class="hljs-string">"@mipmap/ic_launcher_round"</span>
        <span class="hljs-attr">android:supportsRtl</span>=<span class="hljs-string">"true"</span>
        <span class="hljs-attr">android:theme</span>=<span class="hljs-string">"@style/Theme.APP"</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">activity</span>
            <span class="hljs-attr">android:name</span>=<span class="hljs-string">".MainActivity"</span>
            <span class="hljs-attr">android:exported</span>=<span class="hljs-string">"true"</span>
            <span class="hljs-attr">android:theme</span>=<span class="hljs-string">"@style/Theme.APP.starting"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">intent-filter</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.intent.action.MAIN"</span> /&gt;</span>

                <span class="hljs-tag">&lt;<span class="hljs-name">category</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.intent.category.LAUNCHER"</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">intent-filter</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">activity</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">application</span>&gt;</span>
</code></pre>
<h4 data-id="heading-11">第三步：在MainActivity中安装SplashScreen</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {

    <span class="hljs-meta">@Override</span>
	<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
        SplashScreen.installSplashScreen(<span class="hljs-built_in">this</span>);
	    <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
	    setContentView(R.layout.activity_main);
	    ...
	}
    
}
</code></pre>
<h4 data-id="heading-12">installSplashScreen 源码</h4>
<p><strong>静态入口方法</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@JvmStatic</span>
<span class="hljs-meta">@NotNull</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SplashScreen <span class="hljs-title function_">installSplashScreen</span><span class="hljs-params">(<span class="hljs-meta">@NotNull</span> Activity $<span class="hljs-built_in">this</span>$installSplashScreen)</span> {
    <span class="hljs-keyword">return</span> Companion.installSplashScreen($<span class="hljs-built_in">this</span>$installSplashScreen);
}
</code></pre>
<blockquote>
<p>这里是一个简单的委托，实际工作交给Companion对象。</p>
</blockquote>
<p><strong>Companion 对象实现</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@JvmStatic</span>
<span class="hljs-meta">@NotNull</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> SplashScreen <span class="hljs-title function_">installSplashScreen</span><span class="hljs-params">(<span class="hljs-meta">@NotNull</span> Activity $<span class="hljs-built_in">this</span>$installSplashScreen)</span> {
    Intrinsics.checkNotNullParameter($<span class="hljs-built_in">this</span>$installSplashScreen, <span class="hljs-string">"&lt;this&gt;"</span>);
    <span class="hljs-type">SplashScreen</span> <span class="hljs-variable">splashScreen</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SplashScreen</span>($<span class="hljs-built_in">this</span>$installSplashScreen, (DefaultConstructorMarker)<span class="hljs-literal">null</span>);
    splashScreen.install();
    <span class="hljs-keyword">return</span> splashScreen;
}
</code></pre>
<blockquote>
<p>这里创建了实际的实现对象。</p>
</blockquote>
<p><strong>install() 方法核心逻辑</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">install</span><span class="hljs-params">()</span> {
    <span class="hljs-type">TypedValue</span> <span class="hljs-variable">typedValue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypedValue</span>();
    Resources.<span class="hljs-type">Theme</span> <span class="hljs-variable">currentTheme</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.activity.getTheme();
    <span class="hljs-comment">// 解析背景属性</span>
    <span class="hljs-keyword">if</span> (currentTheme.resolveAttribute(attr.windowSplashScreenBackground, typedValue, <span class="hljs-literal">true</span>)) {
        <span class="hljs-built_in">this</span>.backgroundResId = typedValue.resourceId;
        <span class="hljs-built_in">this</span>.backgroundColor = typedValue.data;
    }
     <span class="hljs-comment">// 解析动画图标属性</span>
    <span class="hljs-keyword">if</span> (currentTheme.resolveAttribute(attr.windowSplashScreenAnimatedIcon, typedValue, <span class="hljs-literal">true</span>)) {
        <span class="hljs-built_in">this</span>.icon = currentTheme.getDrawable(typedValue.resourceId);
    }
    <span class="hljs-comment">// 解析图标尺寸属性</span>
    <span class="hljs-keyword">if</span> (currentTheme.resolveAttribute(attr.splashScreenIconSize, typedValue, <span class="hljs-literal">true</span>)) {
        <span class="hljs-built_in">this</span>.hasBackground = typedValue.resourceId == dimen.splashscreen_icon_size_with_background;
    }

    Intrinsics.checkNotNullExpressionValue(currentTheme, <span class="hljs-string">"currentTheme"</span>);
    <span class="hljs-comment">// 设置SplashScreen后的主题</span>
    <span class="hljs-built_in">this</span>.setPostSplashScreenTheme(currentTheme, typedValue);
}
</code></pre>
<p><strong>设置后置主题（关键）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPostSplashScreenTheme</span><span class="hljs-params">(<span class="hljs-meta">@NotNull</span> Resources.Theme currentTheme, <span class="hljs-meta">@NotNull</span> TypedValue typedValue)</span> {
    Intrinsics.checkNotNullParameter(currentTheme, <span class="hljs-string">"currentTheme"</span>);
    Intrinsics.checkNotNullParameter(typedValue, <span class="hljs-string">"typedValue"</span>);
    <span class="hljs-keyword">if</span> (currentTheme.resolveAttribute(attr.postSplashScreenTheme, typedValue, <span class="hljs-literal">true</span>)) {
        <span class="hljs-built_in">this</span>.finalThemeId = typedValue.resourceId;
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.finalThemeId != <span class="hljs-number">0</span>) {
            <span class="hljs-built_in">this</span>.activity.setTheme(<span class="hljs-built_in">this</span>.finalThemeId);
        }
    }

}
</code></pre>
<blockquote>
<ul>
<li>查找<code>postSplashScreenTheme</code>属性</li>
<li>如果找到且不为0，调用<code>activity.setTheme(this.finalThemeId)</code></li>
<li>这是 SplashScreen 消失后应用使用的主题</li>
</ul>
</blockquote>
<p><strong>注意</strong>：<code>installSplashScreen()</code>方法最好在<code>super.onCreate()</code>之前调用，必须保证在<code>setContentView()</code>之前调用。</p>
<h4 data-id="heading-13">让启动画面在屏幕中显示更长时间</h4>
<h5 data-id="heading-14">1. 使用 setKeepOnScreenCondition</h5>
<pre><code class="hljs language-java" lang="java">splashScreen.setKeepOnScreenCondition(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BooleanSupplier</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">getAsBoolean</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> keepSplashOnScreen;
    }
});
</code></pre>
<blockquote>
<ul>
<li>当传入的条件返回 <code>true</code>时，启动画面会<strong>保持显示</strong></li>
<li>当条件返回 <code>false</code>时，启动画面会<strong>自动消失</strong></li>
</ul>
</blockquote>
<h5 data-id="heading-15">2. 使用 ViewTreeObserver.OnPreDrawListener</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">final</span> <span class="hljs-type">View</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> findViewById(android.R.id.content);
content.getViewTreeObserver().addOnPreDrawListener(
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ViewTreeObserver</span>.OnPreDrawListener() {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onPreDraw</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">if</span> (mViewModel.isReady()) {
                <span class="hljs-comment">// 数据就绪，允许绘制并移除监听器</span>
                content.getViewTreeObserver().removeOnPreDrawListener(<span class="hljs-built_in">this</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;   
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 数据未就绪，取消本次绘制</span>
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  
            }
        }
    });
</code></pre>
<blockquote>
<ul>
<li><strong>OnPreDrawListener</strong> 在View即将绘制前被调用</li>
<li>返回 <code>false</code> 会<strong>取消当前绘制周期</strong></li>
<li>返回 <code>true</code> 允许绘制正常进行</li>
<li>系统会在下一个绘制周期再次尝试，直到返回 <code>true</code></li>
</ul>
</blockquote>
<h4 data-id="heading-16">自定义用于关闭启画面的动画</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 获取当前SplashScreen并设置退出动画监听器</span>
getSplashScreen().setOnExitAnimationListener(splashScreenView -&gt; {
    <span class="hljs-comment">// 自定义动画</span>
    <span class="hljs-comment">// ...</span>

    <span class="hljs-comment">// 添加动画监听器，处理动画结束后的逻辑</span>
    slideUp.addListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AnimatorListenerAdapter</span>() {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAnimationEnd</span><span class="hljs-params">(Animator animation)</span> {
            <span class="hljs-comment">// 动画完成后必须移除SplashScreen视图，释放资源</span>
            splashScreenView.remove();
        }
    });

    <span class="hljs-comment">// 启动动画</span>
    slideUp.start();
});
</code></pre>
<h4 data-id="heading-17">示例</h4>
<p>效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6520de7d42c34651bd97c72a33cce670~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rOl5ZqO5rOl5ZqO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763564885&amp;x-signature=zpRxWBBz%2FOLqaO5xWAblwrb6%2FzU%3D" alt="ezgif-7ee68cf45c0fc8b3.gif" loading="lazy"/></p>
<p>代码如下：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"Theme.App.Starting"</span> <span class="hljs-attr">parent</span>=<span class="hljs-string">"Theme.SplashScreen"</span>&gt;</span><span class="xml">
    <span class="hljs-comment">&lt;!-- 设置背景颜色 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"windowSplashScreenBackground"</span>&gt;</span>#2A94C7<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 设置中心图标 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"windowSplashScreenAnimatedIcon"</span>&gt;</span>@drawable/ic_launcher_foreground<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 设置图标背景 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"android:windowSplashScreenIconBackgroundColor"</span>&gt;</span>#1DC3B3<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 设置SplashScreen结束后使用的主题 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"postSplashScreenTheme"</span>&gt;</span>@style/Theme.SplashScreenTest<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">keepSplashOnScreen</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;


    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
        <span class="hljs-type">SplashScreen</span> <span class="hljs-variable">splashScreen</span> <span class="hljs-operator">=</span> SplashScreen.installSplashScreen(<span class="hljs-built_in">this</span>);

        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        EdgeToEdge.enable(<span class="hljs-built_in">this</span>);

        ViewCompat.setOnApplyWindowInsetsListener(findViewById(R.id.main), (v, insets) -&gt; {
            <span class="hljs-type">Insets</span> <span class="hljs-variable">systemBars</span> <span class="hljs-operator">=</span> insets.getInsets(WindowInsetsCompat.Type.systemBars());
            v.setPadding(systemBars.left, systemBars.top, systemBars.right, systemBars.bottom);
            <span class="hljs-keyword">return</span> insets;
        });
        <span class="hljs-keyword">final</span> <span class="hljs-type">View</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> findViewById(android.R.id.content);
        splashScreen.setKeepOnScreenCondition(() -&gt; keepSplashOnScreen);
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Handler</span>().postDelayed(() -&gt; {
            keepSplashOnScreen = <span class="hljs-literal">false</span>;
        }, <span class="hljs-number">1000</span>);

        splashScreen.setOnExitAnimationListener(splashScreenView -&gt; {
            <span class="hljs-type">View</span> <span class="hljs-variable">iconView</span> <span class="hljs-operator">=</span> splashScreenView.getIconView();

            <span class="hljs-type">DisplayMetrics</span> <span class="hljs-variable">displayMetrics</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DisplayMetrics</span>();
            getWindowManager().getDefaultDisplay().getMetrics(displayMetrics);

            <span class="hljs-type">int</span> <span class="hljs-variable">translationDistance</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (-iconView.getRootView().getHeight() * <span class="hljs-number">0.3f</span>);

            <span class="hljs-type">ObjectAnimator</span> <span class="hljs-variable">floatUp</span> <span class="hljs-operator">=</span> ObjectAnimator.ofFloat(
                    iconView,
                    View.TRANSLATION_Y,
                    <span class="hljs-number">0f</span>,
                    translationDistance
            );
            floatUp.setDuration(<span class="hljs-number">600</span>);
            floatUp.setInterpolator(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DecelerateInterpolator</span>());

            <span class="hljs-type">ObjectAnimator</span> <span class="hljs-variable">scaleDown</span> <span class="hljs-operator">=</span> ObjectAnimator.ofFloat(iconView, View.SCALE_X, <span class="hljs-number">1f</span>, <span class="hljs-number">0.5f</span>);
            <span class="hljs-type">ObjectAnimator</span> <span class="hljs-variable">scaleUp</span> <span class="hljs-operator">=</span> ObjectAnimator.ofFloat(iconView, View.SCALE_Y, <span class="hljs-number">1f</span>, <span class="hljs-number">0.5f</span>);
            <span class="hljs-type">ObjectAnimator</span> <span class="hljs-variable">fadeOut</span> <span class="hljs-operator">=</span> ObjectAnimator.ofFloat(iconView, View.ALPHA, <span class="hljs-number">1f</span>, <span class="hljs-number">0f</span>);

            <span class="hljs-type">AnimatorSet</span> <span class="hljs-variable">phase2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnimatorSet</span>();
            phase2.playTogether(scaleDown, scaleUp, fadeOut);
            phase2.setDuration(<span class="hljs-number">400</span>);

            <span class="hljs-type">AnimatorSet</span> <span class="hljs-variable">fullAnimation</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnimatorSet</span>();
            fullAnimation.playSequentially(floatUp, phase2);

            fullAnimation.addListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AnimatorListenerAdapter</span>() {
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAnimationEnd</span><span class="hljs-params">(Animator animation)</span> {
                    splashScreenView.remove();
                }
            });

            fullAnimation.start();
        });

    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vLLM主要模块Scheduler详解]]></title>    <link>https://juejin.cn/post/7571662618054819866</link>    <guid>https://juejin.cn/post/7571662618054819866</guid>    <pubDate>2025-11-12T11:12:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571662618054819866" data-draft-id="7571644531608600622" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vLLM主要模块Scheduler详解"/> <meta itemprop="keywords" content="源码阅读,算法"/> <meta itemprop="datePublished" content="2025-11-12T11:12:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="萌新彭彭"/> <meta itemprop="url" content="https://juejin.cn/user/2098322219205928"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vLLM主要模块Scheduler详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2098322219205928/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    萌新彭彭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T11:12:38.000Z" title="Wed Nov 12 2025 11:12:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">vLLM主要模块Scheduler详解</h2>
<p>在 vLLM 中有许多的模块，而在这篇文章中，我们主要来介绍 vLLM 中如调度管理prompt的。<br/>
本文章是按照vLLM版本：<strong>v0.11.0</strong></p>
<h3 data-id="heading-1">官方代码入口</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 以下是官方调用代码</span>
<span class="hljs-keyword">from</span> vllm <span class="hljs-keyword">import</span> LLM, SamplingParams
prompts = [
    <span class="hljs-string">"Hello, my name is"</span>,
    <span class="hljs-string">"The president of the United States is"</span>,
    <span class="hljs-string">"The capital of France is"</span>,
    <span class="hljs-string">"The future of AI is"</span>,
]
sampling_params = SamplingParams(temperature=<span class="hljs-number">0.8</span>, top_p=<span class="hljs-number">0.95</span>)
llm = LLM(model=<span class="hljs-string">"facebook/opt-125m"</span>)
outputs = llm.generate(prompts, sampling_params)
</code></pre>
<p>我们从这里为入口了解vLLM是如何调用<strong>scheduler</strong>的。</p>
<pre><code class="hljs language-bash" lang="bash">scheduler是vLLM最重要模块之一，它负责对prompts，KV cache的调度和管理
</code></pre>
<h4 data-id="heading-2">vllm/entrypoints/llm.py</h4>
<p>我们从源码得知<strong>llm.generate</strong>是调用的，vllm/entrypoints/llm.py的<strong>generate</strong>方法，</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LLM</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">gennerate</span>(<span class="hljs-params">...</span>) -&gt; <span class="hljs-built_in">list</span>[RequestOutput]:

        ... <span class="hljs-comment"># 省略其他代码</span>

        self._validate_and_add_requests(
            prompts=prompts,
            params=sampling_params,
            use_tqdm=use_tqdm,
            lora_request=lora_request,
            priority=priority,
        )

        outputs = self._run_engine(use_tqdm=use_tqdm)
        <span class="hljs-keyword">return</span> self.engine_class.validate_outputs(outputs, RequestOutput)
</code></pre>
<h4 data-id="heading-3">vllm/v1/engine/llm_engine.py</h4>
<p>再按照<strong>self._validate_and_add_requests</strong>，可以最终看到，vllm/v1/engine/llm_engine.py的<strong>add_request</strong>,我们要关注request的流向。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LLMEngine</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_request</span>(<span class="hljs-params">...</span>) -&gt; <span class="hljs-literal">None</span>:
        ... <span class="hljs-comment"># 省略其他代码</span>
        
        n = params.n <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(params, SamplingParams) <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>

        <span class="hljs-keyword">if</span> n == <span class="hljs-number">1</span>:
            <span class="hljs-comment"># Make a new RequestState and queue.</span>
            self.output_processor.add_request(request, prompt_text, <span class="hljs-literal">None</span>, <span class="hljs-number">0</span>)
            <span class="hljs-comment"># Add the request to EngineCore.</span>
            self.engine_core.add_request(request)
            <span class="hljs-keyword">return</span>
        ...
</code></pre>
<h4 data-id="heading-4">vllm/v1/engine/core.py</h4>
<p>我们需要查看到<strong>self.engine_core.add_request(request)</strong>，<br/>
最终调用了vllm/v1/engine/core.py中<strong>EngineCore中的add_request方法并在其中调用了self.scheduler.add_request(request)</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># vllm/v1/core/sched/scheduler.py</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Scheduler</span>(<span class="hljs-title class_ inherited__">SchedulerInterFace</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_request</span>(<span class="hljs-params">self, request: Request</span>) -&gt; <span class="hljs-literal">None</span>:
        self.waiting.add_request(request) <span class="hljs-comment"># 重要代码</span>
        self.requests[request.request_id] = request
        <span class="hljs-keyword">if</span> self.log_stats:
            request.record_event(EngineCoreEventType.QUEUED)
</code></pre>
<p>当获得prompt后，执行这些prompt是<strong>self._run_engine</strong>，最终会调用到vllm/v1/engine/core.py的step()</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">EngineCore</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">step</span>(<span class="hljs-params">...</span>):
        ...

        <span class="hljs-keyword">with</span> record_function_or_nullcontext(<span class="hljs-string">"core step: schedule"</span>):
            scheduler_output = self.scheduler.schedule() <span class="hljs-comment"># 重要代码</span>
        ...

</code></pre>
<p>最终选择哪个prompt，执行仍然是调用到<strong>self.scheduler.schedule()</strong></p>
<h4 data-id="heading-5">总结</h4>
<p>从以上的代码可以知道以下重要知识点：</p>
<ol>
<li>上层llm.generate是最终调用到底层的<strong>scheduler</strong>中。</li>
<li>上层的prompt会被包装成request，在V1中<strong>首先存入到waiting中。</strong>
<ul>
<li>waiting是<strong>scheduler</strong>中重要的队列，会根据Policy是FCFS还是PRIORITY，来决定是双端队列还是普通队列</li>
<li>waiting是来存储准备要做推理的prompt，prefill阶段都是来自于此</li>
</ul>
</li>
</ol>
<h3 data-id="heading-6">Scheduler.schedule()重要代码详解</h3>
<h4 data-id="heading-7">重要变量概念</h4>
<p>在解释这个算法前，需要了解几个变量，<code>num_token_with_spec, num_computed_tokens, token_budget</code>,<br/>
整个算法都是围绕这些变量变化做的,并且这个算法都是将prompts进行token化，对prompts进行管理.</p>
<pre><code class="hljs language-python" lang="python">num_token_with_spec:<span class="hljs-built_in">len</span>(prompt_token_ids) + <span class="hljs-built_in">len</span>(output_token_ids) + <span class="hljs-built_in">len</span>(spec_token_ids)
token_budget=max_num_batched_tokens,单次迭代处理的最大token数量
num_computed_tokens:被计算过的 KV cache的token数
</code></pre>
<h4 data-id="heading-8">算法整体思路</h4>
<p>首先说说schedule的意图和整体思路：先后看running和waiting中所有request，为他们分配合理的显存blocks,后续会说如何分配block。</p>
<h4 data-id="heading-9">running的调度</h4>
<p>接下来我们来看看源码中是如何处理request的。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">schedule</span>():
    ...
    <span class="hljs-comment"># 首先执行running</span>
    req_index = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> req_index &lt; <span class="hljs-built_in">len</span>(self.running) <span class="hljs-keyword">and</span> token_budget &gt; <span class="hljs-number">0</span>:
        request = self.running[req_index]
        <span class="hljs-comment"># 获取所需新token数</span>
        num_new_tokens = (
            request.num_tokens_with_spec
            + request.num_output_placeholders
            - request.num_computed_tokens
        )
        ...
        <span class="hljs-keyword">with</span> record_function_or_nullcontext(<span class="hljs-string">"schedule: allocate_slots"</span>):
            <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
                <span class="hljs-comment"># 分配显存</span>
                new_blocks = self.kv_cache_manager.allocate_slots(
                    request,
                    num_new_tokens,
                    num_lookahead_tokens=self.num_lookahead_tokens,
                )
                <span class="hljs-comment"># 如果分配成功，退出此循环</span>
                <span class="hljs-keyword">if</span> new_blocks <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
                    <span class="hljs-comment"># The request can be scheduled.</span>
                    <span class="hljs-keyword">break</span>

                <span class="hljs-comment"># 分配不成功，按照策略选择一个request，放入waiting队列中</span>
                <span class="hljs-keyword">if</span> self.policy == SchedulingPolicy.PRIORITY:
                    preempted_req = <span class="hljs-built_in">max</span>(
                        self.running,
                        key=<span class="hljs-keyword">lambda</span> r: (r.priority, r.arrival_time),
                    )
                    self.running.remove(preempted_req)
                    <span class="hljs-keyword">if</span> preempted_req <span class="hljs-keyword">in</span> scheduled_running_reqs:
                        scheduled_running_reqs.remove(preempted_req)
                        token_budget += num_scheduled_tokens[
                            preempted_req.request_id
                        ]
                        req_to_new_blocks.pop(preempted_req.request_id)
                        num_scheduled_tokens.pop(preempted_req.request_id)
                        req_index -= <span class="hljs-number">1</span>
                <span class="hljs-keyword">else</span>:
                    preempted_req = self.running.pop()

                self.kv_cache_manager.free(preempted_req)
                self.encoder_cache_manager.free(preempted_req)
                preempted_req.status = RequestStatus.PREEMPTED
                preempted_req.num_computed_tokens = <span class="hljs-number">0</span>
                preempted_req.num_preemptions += <span class="hljs-number">1</span>
                <span class="hljs-comment"># 存入waiting和被抢占队列中</span>
                self.waiting.prepend_request(preempted_req)
                preempted_reqs.append(preempted_req)
        ...
        token_budget -= num_new_tokens
        req_index += <span class="hljs-number">1</span>
    ...
</code></pre>
<h5 data-id="heading-10">算法总结</h5>
<p>running队列中从第一个request开始，目的是为它分配显存block，<br/>
如果blocks不满足条件，从按照一定的策略（FCFS或PRIORITY），从running总挑选一个request，通过释放它的显存，再将被挑出来的request放入waiting队列第一个位置，同时也存放到preempted_reqs中，从而满足一开始的request显存要求，直到满足分配完所有running队列并且token_budget&gt;0</p>
<h4 data-id="heading-11">waiting的调度</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 接着是waiting</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> preempted_reqs:
    <span class="hljs-keyword">while</span> self.waiting <span class="hljs-keyword">and</span> token_budget &gt; <span class="hljs-number">0</span>:
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.running) == self.max_num_running_reqs:
            <span class="hljs-keyword">break</span>
        <span class="hljs-comment"># 取出第一个但不移除的request</span>
        request = self.waiting.peek_request()
        ...
        <span class="hljs-comment"># 如果new_blocks为空提前结束对waiting的处理</span>
        <span class="hljs-keyword">if</span> new_blocks <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-comment"># The request cannot be scheduled.</span>
            <span class="hljs-keyword">break</span>
        ...
        request = self.waiting.pop_request()
        <span class="hljs-comment"># 存入running中</span>
        self.running.append(request)
        ...

</code></pre>
<h5 data-id="heading-12">算法总结</h5>
<p>在新抢占队列preempted_reqs为空时，waiting和token_budget都有满足条件时，取出第一个但不移除的request，为其分配显存block。<br/>
这里request有两类，一是在prefill阶段的token，二是在decode阶段，所以也可看出并没有明显区分这两个阶段，由于running不满足显存条件从而被抢占后被存入waiting中的token，如果当前request分配当显存不够时，就会提前结束对waiting的处理，<br/>
反之则会继续，将当前request从waiting转移到running中。</p>
<h4 data-id="heading-13">num_new_tokens的含义</h4>
<p>以上算法中，对于到底需要分配多少block，有一个共同的公式。</p>
<pre><code class="hljs language-python" lang="python">num_new_tokens = (
    request.num_tokens_with_spec
    + request.num_output_placeholders
    - request.num_computed_tokens
)
request.num_tokens_with_spec:<span class="hljs-built_in">len</span>(prompt_token_ids) + <span class="hljs-built_in">len</span>(output_token_ids) + <span class="hljs-built_in">len</span>(spec_token_ids)

prompt_token_ids:当前prompt转成token数。
output_token_ids:已经生成的回答token数。从prefill开始产生第一个token开始计算，直到decode结束，所以的动态增加的，output_token_ids.append(token_ids)
spec_token_ids:这个与推测解码相关。

request.num_output_placeholders:为输出预先分配的占位符。
request.num_computed_tokens:计算过的（被分配过显存了）token数。

</code></pre>
<p>num_new_tokens代表是需要被分配显存block数。</p>
<p>以上内容基本就是vLLM的调度策略。接下来会对kv cache manager进行学习。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从擦除到恢复：JSON 库是如何“还原” Java 泛型信息的]]></title>    <link>https://juejin.cn/post/7571646669202571306</link>    <guid>https://juejin.cn/post/7571646669202571306</guid>    <pubDate>2025-11-13T00:04:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571646669202571306" data-draft-id="7571391088947822630" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从擦除到恢复：JSON 库是如何“还原” Java 泛型信息的"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-13T00:04:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风象南"/> <meta itemprop="url" content="https://juejin.cn/user/2524134428655159"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从擦除到恢复：JSON 库是如何“还原” Java 泛型信息的
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2524134428655159/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风象南
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T00:04:27.000Z" title="Thu Nov 13 2025 00:04:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问题重现：泛型擦除的困扰</h2>
<p>在实际开发中，我们经常遇到这样的场景：收到一串用户列表的JSON数据，需要反序列化为<code>List&lt;UserDTO&gt;</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"张三"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"email"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"zhangsan@example.com"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"李四"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"email"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"lisi@example.com"</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">]</span>
</code></pre>
<p>如果直接这样写代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">objectMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();
List&lt;UserDTO&gt; userList = objectMapper.readValue(jsonStr, List.class);

System.out.println(userList.get(<span class="hljs-number">0</span>).getName()); <span class="hljs-comment">// 运行时报错！</span>
</code></pre>
<p>运行时会抛出：<code>java.lang.ClassCastException: java.util.LinkedHashMap cannot be cast to UserDTO</code></p>
<p>根本原因在于Java的泛型擦除机制。</p>
<h3 data-id="heading-1">泛型擦除机制解析</h3>
<p>Java的泛型是编译期特性，运行时泛型信息会被擦除：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 编译期</span>
List&lt;UserDTO&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

<span class="hljs-comment">// 运行时（JVM看到的样子）</span>
<span class="hljs-type">List</span> <span class="hljs-variable">list</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();  <span class="hljs-comment">// 泛型信息消失了</span>
</code></pre>
<p>由于运行时无法获取<code>List&lt;UserDTO&gt;</code>的类型信息，JSON库只能将其解析为<code>List&lt;Map&gt;</code>。</p>
<h2 data-id="heading-2">主流JSON库的解决方案</h2>
<h4 data-id="heading-3">Jackson：TypeReference方案</h4>
<p>Jackson通过<code>TypeReference</code>保留泛型信息：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">objectMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();
List&lt;UserDTO&gt; userList = objectMapper.readValue(jsonStr,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;List&lt;UserDTO&gt;&gt;() {});
</code></pre>
<p><strong>原理分析</strong>：
TypeReference利用匿名内部类的特性，在运行时通过反射获取父类的泛型参数：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TypeReference</span>&lt;T&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Type _type;

    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">TypeReference</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Type</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> getClass().getGenericSuperclass();
        _type = ((ParameterizedType) superClass).getActualTypeArguments()[<span class="hljs-number">0</span>];
    }
}
</code></pre>
<h4 data-id="heading-4">Gson：TypeToken方案</h4>
<p>Gson提供了类似的<code>TypeToken</code>机制：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Gson</span> <span class="hljs-variable">gson</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Gson</span>();
<span class="hljs-type">Type</span> <span class="hljs-variable">userListType</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeToken</span>&lt;List&lt;UserDTO&gt;&gt;(){}.getType();
List&lt;UserDTO&gt; userList = gson.fromJson(jsonStr, userListType);
</code></pre>
<h4 data-id="heading-5">Fastjson2：TypeReference方案</h4>
<p>Fastjson2作为阿里开源的高性能JSON库，同样支持泛型处理：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Fastjson2的TypeReference使用</span>
<span class="hljs-type">String</span> <span class="hljs-variable">jsonStr</span> <span class="hljs-operator">=</span> <span class="hljs-string">"[{\"id\":1,\"name\":\"张三\"},{\"id\":2,\"name\":\"李四\"}]"</span>;
List&lt;UserDTO&gt; userList = JSON.parseObject(jsonStr,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;List&lt;UserDTO&gt;&gt;() {});
</code></pre>
<h2 data-id="heading-6">复杂场景处理</h2>
<h4 data-id="heading-7">嵌套泛型</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// JSON: {"code": 200, "data": [{"id": 1, "name": "张三"}]}</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiResponse</span>&lt;T&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> code;
    <span class="hljs-keyword">private</span> T data;
}

<span class="hljs-comment">// Jackson</span>
ApiResponse&lt;List&lt;UserDTO&gt;&gt; response = objectMapper.readValue(
    jsonStr, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;ApiResponse&lt;List&lt;UserDTO&gt;&gt;&gt;() {});

<span class="hljs-comment">// Fastjson2</span>
ApiResponse&lt;List&lt;UserDTO&gt;&gt; response = JSON.parseObject(
    jsonStr, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;ApiResponse&lt;List&lt;UserDTO&gt;&gt;&gt;() {});
</code></pre>
<h4 data-id="heading-8">Map类型</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// JSON: {"1": {"name": "张三"}, "2": {"name": "李四"}}</span>

<span class="hljs-comment">// Jackson</span>
Map&lt;String, UserDTO&gt; userMap = objectMapper.readValue(
    jsonStr, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;Map&lt;String, UserDTO&gt;&gt;() {});

<span class="hljs-comment">// Fastjson2</span>
Map&lt;String, UserDTO&gt; userMap = JSON.parseObject(
    jsonStr, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;Map&lt;String, UserDTO&gt;&gt;() {});
</code></pre>
<h4 data-id="heading-9">在Spring框架中的应用</h4>
<h5 data-id="heading-10">Feign客户端</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@FeignClient(name = "user-service")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserClient</span> {
    <span class="hljs-meta">@GetMapping("/api/users")</span>
    ResponseEntity&lt;List&lt;UserDTO&gt;&gt; <span class="hljs-title function_">getUsers</span><span class="hljs-params">()</span>;
}
</code></pre>
<h5 data-id="heading-11">WebClient</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Spring WebFlux的WebClient</span>
List&lt;UserDTO&gt; users = webClient.get()
    .uri(<span class="hljs-string">"/api/users"</span>)
    .retrieve()
    .bodyToMono(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ParameterizedTypeReference</span>&lt;List&lt;UserDTO&gt;&gt;() {})
    .block();
</code></pre>
<h2 data-id="heading-12">工程实践建议</h2>
<h4 data-id="heading-13">1. 预定义常用类型</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TypeReferences</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> TypeReference&lt;List&lt;UserDTO&gt;&gt; USER_LIST =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;List&lt;UserDTO&gt;&gt;() {};

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> TypeReference&lt;Map&lt;String, UserDTO&gt;&gt; USER_MAP =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;Map&lt;String, UserDTO&gt;&gt;() {};

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> TypeReference&lt;ApiResponse&lt;List&lt;UserDTO&gt;&gt;&gt; API_USER_LIST =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;ApiResponse&lt;List&lt;UserDTO&gt;&gt;&gt;() {};
}
</code></pre>
<h4 data-id="heading-14">2. 性能优化策略</h4>
<p>在高并发场景下，考虑缓存TypeReference实例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TypeReferenceCache</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, TypeReference&lt;?&gt;&gt; CACHE =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; TypeReference&lt;T&gt; <span class="hljs-title function_">get</span><span class="hljs-params">(String key,
            Supplier&lt;TypeReference&lt;T&gt;&gt; supplier)</span> {
        <span class="hljs-keyword">return</span> (TypeReference&lt;T&gt;) CACHE.computeIfAbsent(key, k -&gt; supplier.get());
    }
}
</code></pre>
<h2 data-id="heading-15">常见误区</h2>
<h4 data-id="heading-16">误区1：数组类型误用</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误：数组类型不需要TypeReference</span>
UserDTO[] users = objectMapper.readValue(jsonStr, UserDTO[].class);

<span class="hljs-comment">// ✅ 正确：数组类型直接传class即可</span>
</code></pre>
<h4 data-id="heading-17">误区2：库混淆</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Jackson的TypeReference</span>
<span class="hljs-keyword">import</span> com.fasterxml.jackson.core.type.TypeReference;

<span class="hljs-comment">// Spring的ParameterizedTypeReference</span>
<span class="hljs-keyword">import</span> org.springframework.core.ParameterizedTypeReference;

<span class="hljs-comment">// Fastjson2的TypeReference</span>
<span class="hljs-keyword">import</span> com.alibaba.fastjson2.TypeReference;
</code></pre>
<h4 data-id="heading-18">误区3：异常处理不当</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误：不处理异常</span>
<span class="hljs-keyword">try</span> {
    List&lt;UserDTO&gt; users = objectMapper.readValue(jsonStr,
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;List&lt;UserDTO&gt;&gt;() {});
} <span class="hljs-keyword">catch</span> (IOException e) {
    <span class="hljs-comment">// 应该记录日志并采取相应措施</span>
    log.error(<span class="hljs-string">"JSON反序列化失败"</span>, e);
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"数据格式错误"</span>);
}
</code></pre>
<h2 data-id="heading-19">技术选型建议</h2>





























<table><thead><tr><th>JSON库</th><th>性能</th><th>特性</th><th>适用场景</th></tr></thead><tbody><tr><td>Jackson</td><td>中等</td><td>功能全面，生态成熟</td><td>Spring全家桶，企业级应用</td></tr><tr><td>Gson</td><td>较低</td><td>API简洁，Android友好</td><td>移动端，轻量级应用</td></tr><tr><td>Fastjson2</td><td>高</td><td>性能优异，功能丰富</td><td>高并发，性能敏感场景</td></tr></tbody></table>
<p><strong>选择建议</strong>：</p>
<ul>
<li>Spring项目：优先Jackson，生态兼容性好</li>
<li>性能要求高：选择Fastjson2</li>
<li>Android开发：考虑Gson</li>
</ul>
<h2 data-id="heading-20">总结</h2>
<p>泛型擦除是Java语言的特性，但通过各JSON库提供的TypeReference/TypeToken机制，我们可以优雅地解决这个问题。掌握不同JSON库的泛型处理方法，能够让我们在实际项目中根据需求做出最合适的技术选型。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[接口开发，咱得整得“优雅”点]]></title>    <link>https://juejin.cn/post/7571749988080435209</link>    <guid>https://juejin.cn/post/7571749988080435209</guid>    <pubDate>2025-11-13T00:02:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571749988080435209" data-draft-id="7571644531609042990" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="接口开发，咱得整得“优雅”点"/> <meta itemprop="keywords" content="Java,API,代码规范"/> <meta itemprop="datePublished" content="2025-11-13T00:02:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员晓凡"/> <meta itemprop="url" content="https://juejin.cn/user/1829211147871415"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            接口开发，咱得整得“优雅”点
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1829211147871415/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员晓凡
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T00:02:33.000Z" title="Thu Nov 13 2025 00:02:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是晓凡。</p>
<h3 data-id="heading-0">一、为什么要“优雅”？</h3>
<p>产品一句话：  “凡哥，接口明天上线，支持 10w 并发，数据脱敏，不能丢单，不能重复，还要安全。”<br/>
优雅不是装，是为了让自己少加班、少背锅、少掉发。<br/>
今天晓凡就把压箱底的东西掏出来，手把手带你撸一套能扛生产的模板。</p>
<p>为方便阅读，晓凡以Java代码为例给出“核心代码 + 使用姿势”，全部亲测可直接使用。</p>
<h3 data-id="heading-1">二、项目骨架（Spring Boot 3.x）</h3>
<pre><code class="hljs language-arduino" lang="arduino">demo-api
├── src/main/java/com/example/demo
│   ├── config          <span class="hljs-comment">// 配置：限流、加解密、日志等</span>
│   ├── annotation      <span class="hljs-comment">// 自定义注解（幂等、日志、脱敏）</span>
│   ├── aspect          <span class="hljs-comment">// 切面统一干活</span>
│   ├── interceptor     <span class="hljs-comment">// 拦截器（签名、白名单）</span>
│   ├── common          <span class="hljs-comment">// 统一返回、异常、常量</span>
│   ├── controller      <span class="hljs-comment">// 对外暴露</span>
│   ├── service
│   └── DemoApplication.java
└── pom.xml
</code></pre>
<h3 data-id="heading-2">三、 签名（防篡改）</h3>
<blockquote>
<p>对外提供的接口要做签名认证，认证不通过的请求不允许访问接口、提供服务</p>
</blockquote>
<p><strong>思路</strong><br/>
“时间戳 + 随机串 + 业务参数”排好序，最后 <code>APP_SECRET</code> 拼后面，SHA256 一下。<br/>
前后端、第三方都统一，拒绝撕逼。</p>
<p><strong>工具类</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SignUtil</span> {
    <span class="hljs-comment">/**
     * 生成签名
     * <span class="hljs-doctag">@param</span> map  除 sign 外的所有参数
     * <span class="hljs-doctag">@param</span> secret 分配给你的私钥
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">sign</span><span class="hljs-params">(Map&lt;String, String&gt; map, String secret)</span> {
        <span class="hljs-comment">// 1. 参数名升序排列</span>
        Map&lt;String, String&gt; tree = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeMap</span>&lt;&gt;(map);
        <span class="hljs-comment">// 2. 拼成 k=v&amp;k=v</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">join</span> <span class="hljs-operator">=</span> tree.entrySet().stream()
                .map(e -&gt; e.getKey() + <span class="hljs-string">"="</span> + e.getValue())
                .collect(Collectors.joining(<span class="hljs-string">"&amp;"</span>));
        <span class="hljs-comment">// 3. 最后拼密钥</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">raw</span> <span class="hljs-operator">=</span> join + <span class="hljs-string">"&amp;key="</span> + secret;
        <span class="hljs-comment">// 4. SHA256</span>
        <span class="hljs-keyword">return</span> DigestUtils.sha256Hex(raw).toUpperCase();
    }

    <span class="hljs-comment">/** 验签：直接比对即可 */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">verify</span><span class="hljs-params">(Map&lt;String, String&gt; map, String secret, String requestSign)</span> {
        <span class="hljs-keyword">return</span> sign(map, secret).equals(requestSign);
    }
}
</code></pre>
<p><strong>拦截器统一验签</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SignInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> {
    <span class="hljs-meta">@Value("${sign.secret}")</span>
    <span class="hljs-keyword">private</span> String secret;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request,
                             HttpServletResponse response,
                             Object handler)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 只拦截接口</span>
        <span class="hljs-keyword">if</span> (!(handler <span class="hljs-keyword">instanceof</span> HandlerMethod)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

        Map&lt;String, String&gt; params = Maps.newHashMap();
        request.getParameterMap().forEach((k, v) -&gt; params.put(k, v[<span class="hljs-number">0</span>]));

        <span class="hljs-type">String</span> <span class="hljs-variable">sign</span> <span class="hljs-operator">=</span> params.remove(<span class="hljs-string">"sign"</span>);   <span class="hljs-comment">// 签名不参与计算</span>
        <span class="hljs-keyword">if</span> (!SignUtil.verify(params, secret, sign)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BizException</span>(<span class="hljs-string">"签名错误"</span>);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<h3 data-id="heading-3">四、 加密（防泄露）</h3>
<blockquote>
<p>敏感数据在网络传输过程中都应该加密处理</p>
</blockquote>
<p><strong>思路</strong><br/>
<code>AES </code>对称加密，密钥放配置中心，支持一键开关。<br/>
只对敏感字段加密，别一上来全包加密，排查日志想打人。</p>
<p><strong>AES 工具</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AesUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ALG</span> <span class="hljs-operator">=</span> <span class="hljs-string">"AES/CBC/PKCS5Padding"</span>;
    <span class="hljs-comment">// 16 位</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">"1234567890abcdef"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">IV</span>  <span class="hljs-operator">=</span> <span class="hljs-string">"abcdef1234567890"</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">encrypt</span><span class="hljs-params">(String src)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Cipher</span> <span class="hljs-variable">cipher</span> <span class="hljs-operator">=</span> Cipher.getInstance(ALG);
            <span class="hljs-type">SecretKeySpec</span> <span class="hljs-variable">keySpec</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecretKeySpec</span>(KEY.getBytes(), <span class="hljs-string">"AES"</span>);
            <span class="hljs-type">IvParameterSpec</span> <span class="hljs-variable">ivSpec</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IvParameterSpec</span>(IV.getBytes());
            cipher.init(Cipher.ENCRYPT_MODE, keySpec, ivSpec);
            <span class="hljs-keyword">return</span> Base64.getEncoder().encodeToString(cipher.doFinal(src.getBytes()));
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"加密失败"</span>, e);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">decrypt</span><span class="hljs-params">(String src)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Cipher</span> <span class="hljs-variable">cipher</span> <span class="hljs-operator">=</span> Cipher.getInstance(ALG);
            <span class="hljs-type">SecretKeySpec</span> <span class="hljs-variable">keySpec</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecretKeySpec</span>(KEY.getBytes(), <span class="hljs-string">"AES"</span>);
            <span class="hljs-type">IvParameterSpec</span> <span class="hljs-variable">ivSpec</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IvParameterSpec</span>(IV.getBytes());
            cipher.init(Cipher.DECRYPT_MODE, keySpec, ivSpec);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(cipher.doFinal(Base64.getDecoder().decode(src)));
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"解密失败"</span>, e);
        }
    }
}
</code></pre>
<h3 data-id="heading-4">五、 IP 白名单</h3>
<blockquote>
<p>限制请求的IP，增加IP白名单，一般在网关层处理</p>
</blockquote>
<p><strong>配置</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">white:</span>
  <span class="hljs-attr">ips:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">,10.0.0.0/8,192.168.0.0/16</span>
</code></pre>
<p><strong>拦截器</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WhiteListInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> {
    <span class="hljs-meta">@Value("#{'${white.ips}'.split(',')}")</span>
    <span class="hljs-keyword">private</span> List&lt;String&gt; allowList;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request,
                             HttpServletResponse response,
                             Object handler)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">String</span> <span class="hljs-variable">ip</span> <span class="hljs-operator">=</span> IpUtil.getIp(request);
        <span class="hljs-type">boolean</span> <span class="hljs-variable">ok</span> <span class="hljs-operator">=</span> allowList.stream()
                .anyMatch(rule -&gt; IpUtil.match(ip, rule));
        <span class="hljs-keyword">if</span> (!ok) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BizException</span>(<span class="hljs-string">"IP 不允许访问"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<h3 data-id="heading-5">六、 限流（Sentinel 注解版）</h3>
<blockquote>
<p>尤其对外提供的接口，无法保障调用频率，应该做限流处理，保障接口服务正常的提供服务</p>
</blockquote>
<p><strong>依赖</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.csp<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sentinel-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.8.6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><strong>配置</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">demo-api</span>
<span class="hljs-attr">sentinel:</span>
  <span class="hljs-attr">transport:</span>
    <span class="hljs-attr">dashboard:</span> <span class="hljs-string">localhost:8080</span>
</code></pre>
<p><strong>使用姿势</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@GetMapping("/order/{id}")</span>
<span class="hljs-meta">@SentinelResource(value = "getOrder",
        blockHandler = "getOrderBlock")</span>
<span class="hljs-keyword">public</span> Result&lt;OrderVO&gt; <span class="hljs-title function_">getOrder</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
    <span class="hljs-keyword">return</span> Result.success(orderService.get(id));
}

<span class="hljs-comment">// 限流兜底</span>
<span class="hljs-keyword">public</span> Result&lt;OrderVO&gt; <span class="hljs-title function_">getOrderBlock</span><span class="hljs-params">(Long id, BlockException e)</span> {
    <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">"访问太频繁，稍后再试"</span>);
}
</code></pre>
<h3 data-id="heading-6">七、 参数校验（JSR303 + 分组）</h3>
<blockquote>
<p>即使前端做了非空，规范性校验，服务端参数校验任然是必不可少的</p>
</blockquote>
<p><strong>DTO</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderCreateDTO</span> {
    <span class="hljs-meta">@NotNull(message = "用户 ID 不能为空")</span>
    <span class="hljs-keyword">private</span> Long userId;

    <span class="hljs-meta">@NotEmpty(message = "商品列表不能为空")</span>
    <span class="hljs-meta">@Size(max = 20, message = "一次最多买 20 件")</span>
    <span class="hljs-keyword">private</span> List&lt;Item&gt; items;

    <span class="hljs-meta">@Valid</span>
    <span class="hljs-meta">@NotNull</span>
    <span class="hljs-keyword">private</span> PayInfo payInfo;

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PayInfo</span> {
        <span class="hljs-meta">@Min(value = 1, message = "金额必须大于 0")</span>
        <span class="hljs-keyword">private</span> Integer amount;
    }
}
</code></pre>
<p><strong>分组接口</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Create</span> {}
</code></pre>
<p><strong>Controller</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@PostMapping("/order")</span>
<span class="hljs-keyword">public</span> Result&lt;Long&gt; <span class="hljs-title function_">create</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> <span class="hljs-meta">@Validated(Create.class)</span> OrderCreateDTO dto)</span> {
    <span class="hljs-type">Long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> orderService.create(dto);
    <span class="hljs-keyword">return</span> Result.success(orderId);
}
</code></pre>
<h3 data-id="heading-7">八、 统一返回值</h3>
<blockquote>
<p>提供统一的返回结果，不应该返回值五花八门</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> code;
    <span class="hljs-keyword">private</span> String msg;
    <span class="hljs-keyword">private</span> T data;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="hljs-title function_">success</span><span class="hljs-params">(T data)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>&lt;&gt;(<span class="hljs-number">200</span>, <span class="hljs-string">"success"</span>, data);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="hljs-title function_">fail</span><span class="hljs-params">(String msg)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>&lt;&gt;(<span class="hljs-number">500</span>, msg, <span class="hljs-literal">null</span>);
    }

    <span class="hljs-comment">/** 返回 200 但提示业务失败 */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="hljs-title function_">bizFail</span><span class="hljs-params">(<span class="hljs-type">int</span> code, String msg)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>&lt;&gt;(code, msg, <span class="hljs-literal">null</span>);
    }
}
</code></pre>
<h3 data-id="heading-8">九、 统一异常处理</h3>
<blockquote>
<p>系统报错信息需要提供友好的提示，避免暴露出SQL异常的信息给调用方和客户端。</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestControllerAdvice</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandler</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(GlobalExceptionHandler.class);

    <span class="hljs-comment">/** 业务异常 */</span>
    <span class="hljs-meta">@ExceptionHandler(BizException.class)</span>
    <span class="hljs-keyword">public</span> Result&lt;Void&gt; <span class="hljs-title function_">handle</span><span class="hljs-params">(BizException e)</span> {
        log.warn(<span class="hljs-string">"业务异常：{}"</span>, e.getMessage());
        <span class="hljs-keyword">return</span> Result.bizFail(e.getCode(), e.getMessage());
    }

    <span class="hljs-comment">/** 参数校验失败 */</span>
    <span class="hljs-meta">@ExceptionHandler(MethodArgumentNotValidException.class)</span>
    <span class="hljs-keyword">public</span> Result&lt;Void&gt; <span class="hljs-title function_">handleValid</span><span class="hljs-params">(MethodArgumentNotValidException e)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> e.getBindingResult()
                .getFieldErrors()
                .stream()
                .map(DefaultMessageSourceResolvable::getDefaultMessage)
                .collect(Collectors.joining(<span class="hljs-string">","</span>));
        <span class="hljs-keyword">return</span> Result.fail(msg);
    }

    <span class="hljs-comment">/** 兜底 */</span>
    <span class="hljs-meta">@ExceptionHandler(Exception.class)</span>
    <span class="hljs-keyword">public</span> Result&lt;Void&gt; <span class="hljs-title function_">handleAll</span><span class="hljs-params">(Exception e)</span> {
        log.error(<span class="hljs-string">"系统异常"</span>, e);
        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">"服务器开小差"</span>);
    }
}
</code></pre>
<h3 data-id="heading-9">十、 请求日志（切面 + 注解）</h3>
<blockquote>
<p>记录请求的入参日志和返回日志，出问题时方便快速定位。也给运维人员提供了方便</p>
</blockquote>
<p><strong>注解</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Target(ElementType.METHOD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> ApiLog {}
</code></pre>
<p><strong>切面</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogAspect</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(<span class="hljs-string">"api.log"</span>);

    <span class="hljs-meta">@Around("@annotation(apiLog)")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">around</span><span class="hljs-params">(ProceedingJoinPoint p, ApiLog apiLog)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-type">ServletRequestAttributes</span> <span class="hljs-variable">attr</span> <span class="hljs-operator">=</span>
                (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> attr.getRequest();

        <span class="hljs-type">String</span> <span class="hljs-variable">uri</span> <span class="hljs-operator">=</span> req.getRequestURI();
        <span class="hljs-type">String</span> <span class="hljs-variable">params</span> <span class="hljs-operator">=</span> JSON.toJSONString(p.getArgs());

        Object result;
        <span class="hljs-keyword">try</span> {
            result = p.proceed();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"【{}】params={} error={}"</span>, uri, params, e.getMessage());
            <span class="hljs-keyword">throw</span> e;
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-type">long</span> <span class="hljs-variable">cost</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - start;
            log.info(<span class="hljs-string">"【{}】params={} cost={}ms"</span>, uri, params, cost);
        }
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<p><strong>用法</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@ApiLog</span>
<span class="hljs-meta">@PostMapping("/order")</span>
<span class="hljs-keyword">public</span> Result&lt;Long&gt; <span class="hljs-title function_">create</span><span class="hljs-params">(...)</span> {}
</code></pre>
<h3 data-id="heading-10">十一、幂等设计（Token &amp; 分布式锁双保险）</h3>
<blockquote>
<p>对于一些涉及到数据一致性的接口一定要做好幂等设计，以防数据出现重复问题</p>
</blockquote>
<p><strong>思路</strong></p>
<ol>
<li>下单前先申请一个幂等 Token（存在 Redis，5 分钟失效）。</li>
<li>下单时带着 Token，后端用 Lua 脚本“判断存在并删除”，原子性保证只能用一次。</li>
<li>对并发极高场景，再补一层分布式锁（Redisson）。</li>
</ol>
<p><strong>代码</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IdempotentService</span> {
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> StringRedisTemplate redis;

    <span class="hljs-comment">/** 申请 Token */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">createToken</span><span class="hljs-params">()</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> UUID.fastUUID().toString();
        redis.opsForValue().set(<span class="hljs-string">"token:"</span> + token, <span class="hljs-string">"1"</span>,
                Duration.ofMinutes(<span class="hljs-number">5</span>));
        <span class="hljs-keyword">return</span> token;
    }

    <span class="hljs-comment">/** 验证并删除 */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkToken</span><span class="hljs-params">(String token)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">"token:"</span> + token;
        <span class="hljs-comment">// 原子删除成功才算用过</span>
        <span class="hljs-keyword">return</span> Boolean.TRUE.equals(redis.delete(key));
    }
}
</code></pre>
<p><strong>Controller</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@GetMapping("/token")</span>
<span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">getToken</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> Result.success(idempotentService.createToken());
}

<span class="hljs-meta">@PostMapping("/order")</span>
<span class="hljs-meta">@ApiLog</span>
<span class="hljs-keyword">public</span> Result&lt;Long&gt; <span class="hljs-title function_">create</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> <span class="hljs-meta">@Valid</span> OrderCreateDTO dto,
                           <span class="hljs-meta">@RequestHeader("Idempotent-Token")</span> String token)</span> {
    <span class="hljs-keyword">if</span> (!idempotentService.checkToken(token)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BizException</span>(<span class="hljs-string">"请勿重复提交"</span>);
    }
    <span class="hljs-type">Long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> orderService.create(dto);
    <span class="hljs-keyword">return</span> Result.success(orderId);
}
</code></pre>
<h3 data-id="heading-11">十二、限制记录条数（分页 + SQL 保护）</h3>
<blockquote>
<p>对于批量数据接口，一定要限制返回的记录条数，不让会造成恶意攻击导致服务器宕机。</p>
</blockquote>
<p><strong>MyBatis-Plus 分页插件</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MybatisConfig</span> {
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> MybatisPlusInterceptor <span class="hljs-title function_">interceptor</span><span class="hljs-params">()</span> {
        <span class="hljs-type">MybatisPlusInterceptor</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MybatisPlusInterceptor</span>();
        i.addInnerInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PaginationInnerInterceptor</span>(DbType.MYSQL));
        <span class="hljs-keyword">return</span> i;
    }
}
</code></pre>
<p><strong>Service</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> Page&lt;OrderVO&gt; <span class="hljs-title function_">list</span><span class="hljs-params">(OrderListDTO dto)</span> {
    <span class="hljs-comment">// 前端不传默认 10 条，最多 200</span>
    <span class="hljs-type">long</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> Math.min(dto.getPageSize(), <span class="hljs-number">200</span>);
    Page&lt;Order&gt; page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(dto.getPageNo(), size);
    LambdaQueryWrapper&lt;Order&gt; w = Wrappers.lambdaQuery();
    <span class="hljs-keyword">if</span> (StrUtil.isNotBlank(dto.getUserName())) {
        w.like(Order::getUserName, dto.getUserName());
    }
    Page&lt;Order&gt; po = orderMapper.selectPage(page, w);
    <span class="hljs-keyword">return</span> po.convert(o -&gt; BeanUtil.copyProperties(o, OrderVO.class));
}
</code></pre>
<h3 data-id="heading-12">十三、 压测（JMeter + 自带脚本）</h3>
<blockquote>
<p>上线前，务必要对API接口进行压力测试，知道各个接口的qps情况。以便我们能够更好的预估，需要部署多少服务节点，对于API接口的稳定性至关重要。</p>
</blockquote>
<ol>
<li>
<p>起服务：<br/>
<code>java -jar -Xms1g -Xmx1g demo-api.jar</code></p>
</li>
<li>
<p>JMeter 线程组：<br/>
500 线程、Ramp-up 10s、循环 20。</p>
</li>
<li>
<p>观测：</p>
<ul>
<li>Sentinel 控制台看 QPS、RT</li>
<li><code>top -H</code> 看 CPU</li>
<li><code>arthas</code> 火焰图找慢方法</li>
</ul>
</li>
<li>
<p>调优：</p>
<ul>
<li>限流阈值 = 压测 80% 最高水位</li>
<li>发现慢 SQL 加索引</li>
<li>热点数据加本地缓存（Caffeine）</li>
</ul>
</li>
</ol>
<h3 data-id="heading-13">十四、异步处理</h3>
<blockquote>
<p>如果同步处理业务，耗时会非常长。这种情况下，为了提升API接口性能，我们可以改为异步处理</p>
</blockquote>
<p>下单成功后，发 MQ 异步发短信/扣库存，接口 RT 直接降一半。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Async("asyncExecutor")</span>   <span class="hljs-comment">// 自定义线程池</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendSmsAsync</span><span class="hljs-params">(Long userId, String content)</span> {
    smsService.send(userId, content);
}
</code></pre>
<h3 data-id="heading-14">十五、数据脱敏</h3>
<blockquote>
<p>业务中对与用户的敏感数据，如密码等需要进行脱敏处理</p>
</blockquote>
<p>返回前统一用 Jackson 序列化过滤器，字段加注解就行，代码零侵入。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@JsonSerialize(using = SensitiveSerializer.class)</span>
<span class="hljs-meta">@Target(ElementType.FIELD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Sensitive {
    SensitiveType <span class="hljs-title function_">type</span><span class="hljs-params">()</span>;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">SensitiveType</span> {
    PHONE, ID_CARD, BANK_CARD
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SensitiveSerializer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JsonSerializer</span>&lt;String&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(String value, JsonGenerator g, SerializerProvider p)</span>
            <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-keyword">if</span> (StrUtil.isBlank(value)) {
            g.writeString(value);
            <span class="hljs-keyword">return</span>;
        }
        g.writeString(DesensitizeUtil.desPhone(value));
    }
}
</code></pre>
<h3 data-id="heading-15">十六、完整的接口文档（Knife4j）</h3>
<blockquote>
<p>提供在线接口文档，既方便开发调试接口，也方便运维人员排查错误</p>
</blockquote>
<p><strong>依赖</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.xiaoymin<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>knife4j-openapi3-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><strong>配置</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">knife4j:</span>
  <span class="hljs-attr">enable:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">setting:</span>
    <span class="hljs-attr">language:</span> <span class="hljs-string">zh_cn</span>
</code></pre>
<p><strong>启动后访问</strong><br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8080%2Fdoc.html" target="_blank" title="http://localhost:8080/doc.html" ref="nofollow noopener noreferrer">http://localhost:8080/doc.html</a><br/>
支持在线调试、导出 PDF、Word。</p>
<h3 data-id="heading-16">十七、小结</h3>
<p>接口开发就像炒菜：</p>
<ul>
<li>签名、加密是“食材保鲜”</li>
<li>限流、幂等是“火候掌控”</li>
<li>日志、文档是“摆盘拍照”</li>
</ul>
<p>每道工序做到位，才能端到桌上“色香味”俱全。<br/>
上面 13 段核心代码，直接粘过去就能跑，跑通后再按业务微调，基本能扛 90% 的生产场景。<br/>
祝你在领导问起接口怎么样了？的时候，可以淡淡来一句：<br/>
“接口已经准备好了，压测报告发群里了。”</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Swift 6 实战：从“定时器轮询”到 AsyncSequence 的优雅实时推送]]></title>    <link>https://juejin.cn/post/7571751304624701486</link>    <guid>https://juejin.cn/post/7571751304624701486</guid>    <pubDate>2025-11-13T00:05:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571751304624701486" data-draft-id="7559481579463000106" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Swift 6 实战：从“定时器轮询”到 AsyncSequence 的优雅实时推送"/> <meta itemprop="keywords" content="Swift"/> <meta itemprop="datePublished" content="2025-11-13T00:05:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="unravel2025"/> <meta itemprop="url" content="https://juejin.cn/user/1116759541421880"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Swift 6 实战：从“定时器轮询”到 AsyncSequence 的优雅实时推送
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759541421880/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    unravel2025
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T00:05:07.000Z" title="Thu Nov 13 2025 00:05:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在 iOS 开发中，「实时刷新」需求随处可见：</p>
<ul>
<li>天气卡片 3 秒更新一次</li>
<li>座位状态由绿变红</li>
<li>股价、比分、配送进度……</li>
</ul>
<p>过去我们习惯用 <code>Timer.scheduledTimer</code> 写一个“死循环”，或者把 Combine 的 <code>Timer.publish</code> 拼成管道。</p>
<p>Swift 6 以后，官方把 AsyncSequence 推到 C 位，让我们用“流”的思维解决轮询。</p>
<h2 data-id="heading-1">核心概念速览</h2>



































<table><thead><tr><th>概念</th><th>一句话说明</th><th>本文对应示例</th></tr></thead><tbody><tr><td>AsyncSequence</td><td>一个可以 <code>for await</code> 遍历的异步序列，天生支持结构化并发与自动取消</td><td><code>AsyncStream&lt;WeatherCondition&gt;</code></td></tr><tr><td>AsyncStream</td><td>官方提供的 AsyncSequence 实现，适合“自己写生产端”的场景</td><td><code>pollingStream(api:)</code></td></tr><tr><td>Task.sleep</td><td>非阻塞的异步“睡眠”，不会卡住线程</td><td><code>try? await Task.sleep(for: .seconds(3))</code></td></tr><tr><td>Task.isCancelled</td><td>结构化并发中的“取消标记”，用 while 判断即可优雅退出</td><td><code>while !Task.isCancelled</code></td></tr><tr><td>MainActor.run</td><td>把闭包安全切回主线程，避免 UI 崩溃</td><td><code>await MainActor.run { … }</code></td></tr></tbody></table>
<h2 data-id="heading-2">三种实现逐行拆解</h2>
<h3 data-id="heading-3">基础API</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">WeatherCondition</span>: <span class="hljs-title class_">String</span>, <span class="hljs-title class_">CaseIterable</span> {
    <span class="hljs-keyword">case</span> clear, stormy
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">WeatherResponse</span> {
    <span class="hljs-keyword">let</span> condition: <span class="hljs-type">WeatherCondition</span>
}

<span class="hljs-keyword">actor</span> <span class="hljs-title class_">MockWeatherAPI</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchWeather</span>() <span class="hljs-keyword">async</span> -&gt; <span class="hljs-type">WeatherResponse</span> {
        <span class="hljs-keyword">try?</span> <span class="hljs-keyword">await</span> <span class="hljs-type">Task</span>.sleep(for: .seconds(<span class="hljs-number">1</span>))
        <span class="hljs-keyword">return</span> <span class="hljs-type">WeatherResponse</span>(condition: <span class="hljs-type">WeatherCondition</span>.allCases.randomElement()<span class="hljs-operator">!</span>)
    }
}
</code></pre>
<h3 data-id="heading-4">定时器派：Timer.scheduledTimer</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 传统写法，功能可用，但坑最多</span>
<span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TimerViewModel</span>: <span class="hljs-title class_">ObservableObject</span> {
    <span class="hljs-meta">@Published</span> <span class="hljs-keyword">var</span> weather: <span class="hljs-type">WeatherCondition</span> <span class="hljs-operator">=</span> .clear
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> timer: <span class="hljs-type">Timer</span>?
    
    <span class="hljs-keyword">init</span>(<span class="hljs-params">api</span>: <span class="hljs-type">MockWeatherAPI</span>) {
        <span class="hljs-comment">// 每 3 秒在主线程回调一次</span>
        timer <span class="hljs-operator">=</span> <span class="hljs-type">Timer</span>.scheduledTimer(withTimeInterval: <span class="hljs-number">3.0</span>, repeats: <span class="hljs-literal">true</span>) { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] <span class="hljs-keyword">_</span> <span class="hljs-keyword">in</span>
            <span class="hljs-comment">// 必须在异步上下文调用 async 方法，所以包一层 Task</span>
            <span class="hljs-type">Task</span> {
                <span class="hljs-keyword">let</span> response <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> api.fetchWeather()
                <span class="hljs-comment">// 回到主线程改 UI</span>
                <span class="hljs-keyword">await</span> <span class="hljs-type">MainActor</span>.run { <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.weather <span class="hljs-operator">=</span> response.condition }
            }
        }
    }
    
    <span class="hljs-keyword">deinit</span> {
        timer<span class="hljs-operator">?</span>.invalidate()   <span class="hljs-comment">// 忘了写就会内存泄漏</span>
    }
}
</code></pre>
<p>缺点小结</p>
<ol>
<li>忘记 <code>invalidate()</code> 直接泄漏</li>
<li>后台模式下容易“卡”计时器</li>
<li>单元测试必须真跑 3 秒，CI 极慢</li>
</ol>
<h3 data-id="heading-5">Combine 派：Timer.publish + Future</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CombineViewModel</span>: <span class="hljs-title class_">ObservableObject</span> {
    <span class="hljs-meta">@Published</span> <span class="hljs-keyword">var</span> weather: <span class="hljs-type">WeatherCondition</span> <span class="hljs-operator">=</span> .clear
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> cancellables <span class="hljs-operator">=</span> <span class="hljs-type">Set</span>&lt;<span class="hljs-type">AnyCancellable</span>&gt;()
    
    <span class="hljs-keyword">init</span>(<span class="hljs-params">api</span>: <span class="hljs-type">MockWeatherAPI</span>) {
        <span class="hljs-comment">// 1. 主线程每 3 秒发一个日期</span>
        <span class="hljs-type">Timer</span>.publish(every: <span class="hljs-number">3</span>, on: .main, in: .common)
            .autoconnect()
            <span class="hljs-comment">// 2. 把日期换成异步请求</span>
            .flatMap { <span class="hljs-keyword">_</span> <span class="hljs-keyword">in</span>
                <span class="hljs-type">Future</span> { promise <span class="hljs-keyword">in</span>
                    <span class="hljs-type">Task</span> {
                        <span class="hljs-keyword">let</span> response <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> api.fetchWeather()
                        promise(.success(response.condition))
                    }
                }
            }
            .receive(on: <span class="hljs-type">RunLoop</span>.main)   <span class="hljs-comment">// 3. 回到主线程</span>
            .assign(to: <span class="hljs-operator">&amp;</span><span class="hljs-variable">$weather</span>)        <span class="hljs-comment">// 4. 直接绑到属性</span>
    }
}
</code></pre>
<p>缺点小结</p>
<ul>
<li>异步/await 与 Combine 混写，心智负担高</li>
<li><code>Future</code> 只能完成一次，不能“持续”发值，需要 <code>flatMap</code> 不断新建</li>
<li>测试仍需跑真时间或使用 <code>TestScheduler</code></li>
</ul>
<h3 data-id="heading-6">AsyncSequence 派：AsyncStream 一统江湖</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StreamViewModel</span>: <span class="hljs-title class_">ObservableObject</span> {
    <span class="hljs-meta">@Published</span> <span class="hljs-keyword">var</span> weather: <span class="hljs-type">WeatherCondition</span> <span class="hljs-operator">=</span> .clear
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> task: <span class="hljs-type">Task</span>&lt;<span class="hljs-type">Void</span>, <span class="hljs-type">Never</span>&gt;?
    
    <span class="hljs-keyword">init</span>(<span class="hljs-params">api</span>: <span class="hljs-type">MockWeatherAPI</span>) {
        <span class="hljs-comment">// 结构化并发：启动一个子任务</span>
        task <span class="hljs-operator">=</span> <span class="hljs-type">Task</span> {
            <span class="hljs-comment">// 直接 for await 遍历自定义流</span>
            <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> update <span class="hljs-keyword">in</span> <span class="hljs-keyword">Self</span>.pollingStream(api: api) {
                <span class="hljs-keyword">await</span> <span class="hljs-type">MainActor</span>.run { <span class="hljs-keyword">self</span>.weather <span class="hljs-operator">=</span> update }
            }
        }
    }
    
    <span class="hljs-keyword">deinit</span> {
        task<span class="hljs-operator">?</span>.cancel()   <span class="hljs-comment">// 取消即停流，无需手动 invalidate</span>
    }
    
    <span class="hljs-comment">// MARK: - 核心工厂方法</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">pollingStream</span>(<span class="hljs-params">api</span>: <span class="hljs-type">MockWeatherAPI</span>) -&gt; <span class="hljs-type">AsyncStream</span>&lt;<span class="hljs-type">WeatherCondition</span>&gt; {
        <span class="hljs-type">AsyncStream</span> { continuation <span class="hljs-keyword">in</span>
            <span class="hljs-comment">// 真正生产端跑在子任务</span>
            <span class="hljs-type">Task</span> {
                <span class="hljs-comment">// 如果外部调用者取消 Task，这里会优雅退出</span>
                <span class="hljs-keyword">while</span> <span class="hljs-operator">!</span><span class="hljs-type">Task</span>.isCancelled {
                    <span class="hljs-keyword">let</span> update <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> api.fetchWeather()
                    continuation.yield(update.condition)          <span class="hljs-comment">// 向下游发一个值</span>
                    <span class="hljs-keyword">try?</span> <span class="hljs-keyword">await</span> <span class="hljs-type">Task</span>.sleep(for: .seconds(<span class="hljs-number">3</span>))       <span class="hljs-comment">// 等 3 秒再采</span>
                }
                continuation.finish()                             <span class="hljs-comment">// 告知“我发完了”</span>
            }
        }
    }
}
</code></pre>
<p>优点小结</p>
<p>✅ 取消即停：Task 取消后 <code>while</code> 自动结束</p>
<p>✅ 测试友好：用 <code>AsyncStream.makeAsyncIterator()</code> 可以同步拿值，无需真睡 3 秒</p>
<p>✅ 可组装：后续加 <code>timeout</code>、<code>debounce</code>、<code>buffer</code> 都只要包一层序列</p>
<h3 data-id="heading-7">视图层：SeatAvailabilityView</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">SeatAvailabilityView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-keyword">let</span> condition: <span class="hljs-type">WeatherCondition</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">Circle</span>()
            .fill(condition <span class="hljs-operator">==</span> .clear <span class="hljs-operator">?</span> .green : .red)
            .frame(width: <span class="hljs-number">100</span>, height: <span class="hljs-number">100</span>)
            .overlay(<span class="hljs-type">Text</span>(condition.rawValue.capitalized))
    }
}
</code></pre>
<p>使用：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ContentView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@StateObject</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> vm <span class="hljs-operator">=</span> <span class="hljs-type">StreamViewModel</span>(api: <span class="hljs-type">MockWeatherAPI</span>())
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">SeatAvailabilityView</span>(condition: vm.weather)
            .task {          <span class="hljs-comment">// 视图消失时自动取消内部的 Task</span>
                <span class="hljs-comment">// 如果这里还启动额外工作，可一并取消</span>
            }
    }
}
</code></pre>
<h4 data-id="heading-8">取消的 3 个姿势</h4>

























<table><thead><tr><th>场景</th><th>实现方式</th><th>代码片段</th></tr></thead><tbody><tr><td>视图消失</td><td><code>.task</code>修饰符</td><td><code>.task { … }</code>自动在 disappear 时 cancel</td></tr><tr><td>手动取消</td><td><code>deinit</code>调 <code>task?.cancel()</code></td><td>见 StreamViewModel</td></tr><tr><td>超时取消</td><td><code>AsyncThrowingStream</code>+ <code>withTimeout</code></td><td>见下方扩展</td></tr></tbody></table>
<h4 data-id="heading-9">单元测试：Swift Testing 示例</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> Testing
<span class="hljs-keyword">@testable</span> <span class="hljs-keyword">import</span> YourModule

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">WeatherPollingTests</span> {
    <span class="hljs-comment">// 验证流能正常 emit 值</span>
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">streamEmitsValues</span>() <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> {
        <span class="hljs-keyword">let</span> api <span class="hljs-operator">=</span> <span class="hljs-type">MockWeatherAPI</span>()
        <span class="hljs-keyword">let</span> stream <span class="hljs-operator">=</span> <span class="hljs-type">StreamViewModel</span>.pollingStream(api: api)
        <span class="hljs-keyword">var</span> iterator <span class="hljs-operator">=</span> stream.makeAsyncIterator()
        <span class="hljs-keyword">let</span> first <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> iterator.next()
        #expect(first <span class="hljs-operator">!=</span> <span class="hljs-literal">nil</span>)
    }
    
    <span class="hljs-comment">// 验证外部取消后，循环会退出</span>
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">streamCancellation</span>() <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> {
        <span class="hljs-keyword">let</span> api <span class="hljs-operator">=</span> <span class="hljs-type">MockWeatherAPI</span>()
        <span class="hljs-keyword">let</span> task <span class="hljs-operator">=</span> <span class="hljs-type">Task</span> {
            <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> <span class="hljs-keyword">_</span> <span class="hljs-keyword">in</span> <span class="hljs-type">StreamViewModel</span>.pollingStream(api: api) { }
        }
        task.cancel()
        #expect(task.isCancelled)
    }
}
</code></pre>
<p>测试提速技巧</p>
<ul>
<li>把 <code>Task.sleep</code> 抽象成 <code>Clock.sleep</code>，测试注入 <code>ImmediateClock</code> 即可 0 秒跑完</li>
<li>用 <code>AsyncStream.makeAsyncIterator()</code> 可以一条一条拿值，断言更细</li>
</ul>
<h2 data-id="heading-10">扩展场景</h2>
<h3 data-id="heading-11">带超时的轮询</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">extension</span> <span class="hljs-title class_">AsyncStream</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">withTimeout</span>&lt;<span class="hljs-type">C</span>: <span class="hljs-type">Clock</span>&gt;(<span class="hljs-keyword">_</span> <span class="hljs-params">duration</span>: <span class="hljs-type">C</span>.<span class="hljs-type">Instant</span>.<span class="hljs-type">Duration</span>, <span class="hljs-params">clock</span>: <span class="hljs-type">C</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-keyword">Self</span> {
        <span class="hljs-comment">// 用 withThrowingTaskGroup 同时跑“生产值”和“倒计时”</span>
        <span class="hljs-comment">// 哪边先到就取消另一边</span>
    }
}
</code></pre>
<h3 data-id="heading-12">假 WebSocket 一键替换</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">MockWebSocket</span>: <span class="hljs-title class_">AsyncSequence</span> {
    <span class="hljs-keyword">typealias</span> <span class="hljs-type">Element</span> <span class="hljs-operator">=</span> <span class="hljs-type">WeatherCondition</span>
    
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">AsyncIterator</span>: <span class="hljs-title class_">AsyncIteratorProtocol</span> {
        <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">next</span>() <span class="hljs-keyword">async</span> -&gt; <span class="hljs-type">WeatherCondition</span>? {
            <span class="hljs-comment">// 2 秒随机一个值，模拟帧</span>
            <span class="hljs-keyword">try?</span> <span class="hljs-keyword">await</span> <span class="hljs-type">Task</span>.sleep(for: .seconds(<span class="hljs-number">2</span>))
            <span class="hljs-keyword">return</span> <span class="hljs-type">WeatherCondition</span>.allCases.randomElement()
        }
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">makeAsyncIterator</span>() -&gt; <span class="hljs-type">AsyncIterator</span> { <span class="hljs-type">AsyncIterator</span>() }
}
</code></pre>
<p>把 <code>for await update in MockWebSocket()</code> 直接塞进 ViewModel，</p>
<p>将来换真 WebSocket 只要改一行，UI 层零改动。</p>
<h2 data-id="heading-13">总结与选型建议</h2>
<ol>
<li>新代码直接上 <code>AsyncStream</code>
<ul>
<li>取消简单、测试快、与 Swift Concurrency 原生一致</li>
</ul>
</li>
<li>老代码如果已用 Combine
<ul>
<li>可继续用 <code>Timer.publish</code>，但建议包一层 <code>AsyncPublisher</code> 逐步迁移</li>
</ul>
</li>
<li>纯定时器场景
<ul>
<li>只要最小依赖，也可以 <code>AsyncSequence</code> 一把梭，别再写 <code>Timer</code> 了</li>
</ul>
</li>
</ol>
<h2 data-id="heading-14">学习资料</h2>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium.com%2F%40wesleymatlock%2Fasyncsequence-for-real-time-apis-from-legacy-polling-to-swift-6-elegance-c2b8139c21e0" target="_blank" title="https://medium.com/@wesleymatlock/asyncsequence-for-real-time-apis-from-legacy-polling-to-swift-6-elegance-c2b8139c21e0" ref="nofollow noopener noreferrer">medium.com/@wesleymatl…</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 性能优化实战：我从 V8 源码中学到的 7 个关键技巧]]></title>    <link>https://juejin.cn/post/7571650164844429346</link>    <guid>https://juejin.cn/post/7571650164844429346</guid>    <pubDate>2025-11-13T00:16:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571650164844429346" data-draft-id="7571702660932845583" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 性能优化实战：我从 V8 源码中学到的 7 个关键技巧"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-13T00:16:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT_陈寒"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 性能优化实战：我从 V8 源码中学到的 7 个关键技巧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT_陈寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T00:16:52.000Z" title="Thu Nov 13 2025 00:16:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>JavaScript 性能优化实战：我从 V8 源码中学到的 7 个关键技巧</strong></h2>
<h3 data-id="heading-1">引言</h3>
<p>在现代 Web 开发中，JavaScript 的性能优化是一个永恒的话题。随着应用复杂度的提升，即使是微小的性能改进也能带来显著的体验提升。作为 JavaScript 开发者，我们常常依赖于引擎的“魔法”来优化代码，但真正理解底层原理的人却不多。V8 引擎（Chrome 和 Node.js 的核心）是当今最先进的 JavaScript 引擎之一，通过深入研究其源码和工作机制，我们可以挖掘出许多实用的性能优化技巧。</p>
<p>本文将分享我从 V8 源码中学到的 <strong>7 个关键性能优化技巧</strong>，并结合实际场景和代码示例说明如何应用这些技术。无论你是前端开发者、Node.js 工程师还是对底层原理感兴趣的极客，这些知识都将帮助你写出更高效的 JavaScript 代码。</p>
<hr/>
<h3 data-id="heading-2">1. <strong>隐藏类与属性访问优化</strong></h3>
<h4 data-id="heading-3">V8 的隐藏类机制</h4>
<p>V8 使用“隐藏类”（Hidden Class）来优化对象属性的访问。每次对象的结构（如属性增减或顺序变化）发生变化时，V8 会创建一个新的隐藏类。频繁改变对象结构会导致隐藏类的“多态性”，从而拖慢属性访问速度。</p>
<h4 data-id="heading-4">实战技巧：</h4>
<ul>
<li><strong>避免动态添加属性</strong>：尽量在构造函数中一次性初始化所有属性。</li>
<li><strong>保持属性顺序一致</strong>：相同结构的对象应按相同顺序定义属性。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ Bad: Dynamic property addition</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Point</span>(<span class="hljs-params"/>) {}
<span class="hljs-keyword">const</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Point</span>();
p1.<span class="hljs-property">x</span> = <span class="hljs-number">10</span>;
p1.<span class="hljs-property">y</span> = <span class="hljs-number">20</span>;

<span class="hljs-comment">// ✅ Good: Predefined properties</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Point</span>(<span class="hljs-params">x, y</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span> = x;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">y</span> = y;
}
<span class="hljs-keyword">const</span> p2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Point</span>(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>);
</code></pre>
<hr/>
<h3 data-id="heading-5">2. <strong>内联缓存（Inline Cache）与函数单态性</strong></h3>
<h4 data-id="heading-6">V8的函数调用优化</h4>
<p>V8通过内联缓存（IC）加速函数调用。如果一个函数始终以相同类型的参数被调用（单态），V8会生成高度优化的机器码；但如果参数类型多变（多态），性能会下降。</p>
<h4 data-id="heading-7">实战技巧：</h4>
<ul>
<li><strong>保持函数参数类型稳定</strong>：避免同一函数处理多种类型参数。</li>
<li><strong>避免多态性较高的工具函数</strong>：例如通用的<code>format</code>函数可能因参数类型多变而降低性能。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ Bad: Polymorphic function</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>) {
    <span class="hljs-keyword">return</span> a + b; <span class="hljs-comment">// May handle numbers, strings, etc.</span>
}

<span class="hljs-comment">// ✅ Good: Monomorphic function</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">addNumbers</span>(<span class="hljs-params">a, b</span>) {
    <span class="hljs-keyword">return</span> a + b; <span class="hljs-comment">// Always expects numbers</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-8">3. <strong>数组操作的陷阱与优化</strong></h3>
<h4 data-id="heading-9">V8的数组元素类型跟踪</h4>
<p>V8会根据数组元素的类型（如全为整数或双精度浮点数）选择最优的存储方式（“packed”或“holey”）。打破这种一致性会导致性能下降。</p>
<h4 data-id="heading-10">实战技巧：</h4>
<ul>
<li><strong>避免混合类型数组</strong>：例如<code>[1, 'foo', {}]</code>会迫使V8使用更慢的通用表示。</li>
<li><strong>预分配数组大小</strong>：对于已知长度的数组，直接初始化长度比动态扩展更快。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ Bad: Mixed-type array and dynamic growth</span>
<span class="hljs-keyword">const</span> arr = [];
arr.<span class="hljs-title function_">push</span>(<span class="hljs-number">1</span>);
arr.<span class="hljs-title function_">push</span>(<span class="hljs-string">'text'</span>);

<span class="hljs-comment">// ✅ Good: Homogeneous array with pre-allocation</span>
<span class="hljs-keyword">const</span> arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">100</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i =<span class="hljs-number">0</span>; i &lt;<span class="hljs-number">100</span>; i++) arr[i] = i;
</code></pre>
<hr/>
<h3 data-id="heading-11">4. <strong>逃逸分析与对象分配优化</strong></h3>
<h4 data-id="heading-12">V8的逃逸分析（Escape Analysis）</h4>
<p>V8会分析对象的生命周期是否“逃逸”出当前作用域。未逃逸的对象可以被栈分配或完全优化掉。</p>
<h4 data-id="heading-13">实战技巧：</h4>
<ul>
<li><strong>避免不必要的全局/闭包引用</strong>：将对象限制在局部作用域内。</li>
<li><strong>优先使用基本类型而非包装对象</strong>：例如用<code>'hello'</code>而非<code>new String('hello')</code>。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ Bad: Object escapes via closure</span>
<span class="hljs-keyword">let</span> leakedObj;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createObj</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> obj = { <span class="hljs-comment">/* ... */</span> };
    leakedObj = obj; <span class="hljs-comment">// Escape!</span>
}

<span class="hljs-comment">// ✅ Good: Object stays local</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">processData</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> localObj = { <span class="hljs-comment">/* ... */</span> };
    <span class="hljs-comment">// Use localObj here only...</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-14">5. <strong>优化的数据结构选择</strong></h3>
<h4 data-id="heading-15">V8的特殊数据结构支持</h4>
<p>某些数据结构在V8中有特殊优化路径，例如：</p>
<ul>
<li><code>Map/Set</code>比普通对象更适合键值对操作；</li>
<li><code>TypedArray</code>对数值计算更高效；</li>
<li><code>ArrayBuffer/SharedArrayBuffer</code>适用于二进制数据共享。</li>
</ul>
<h4 data-id="heading-16">Example:</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ Bad: Using object for frequent key updates</span>
<span class="hljs-keyword">const</span> cache = {};
cache[key] = value;

<span class="hljs-comment">// ✅ Good: Map is optimized for dynamic keys </span>
<span class="hljs-keyword">const</span> cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
cache.<span class="hljs-title function_">set</span>(key, value);
</code></pre>
<hr/>
<h3 data-id="heading-17">6. <strong>异步代码与微观任务调度</strong></h3>
<h4 data-id="heading-18">V8的事件循环集成</h4>
<p>Promise回调作为微任务会被优先执行。过度嵌套或不必要的Promise会影响调度效率。</p>
<h4 data-id="heading-19">Tips:</h4>
<ul>
<li><strong>避免冗余的Promise包装</strong>:  同步操作无需封装为Promise。</li>
<li><strong>优先使用async/await而非深层then链</strong>:  减少微观任务层级.</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ Bad Unnecessary Promise chain  </span>
<span class="hljs-title function_">fetch</span>(url)
.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>())
.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(data)) <span class="hljs-comment">// Redundant!</span>

<span class="hljs-comment">// ✅ Clean async/await  </span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadData</span>(<span class="hljs-params"/>) {
 <span class="hljs-keyword">const</span> res= <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url);
 <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>(); 
}
</code></pre>
<hr/>
<h3 data-id="heading-20">7 .<strong>热函数的JIT友好写法</strong></h3>
<h4 data-id="heading-21">TurboFan如何编译JS</h4>
<p>V  ８ ’s optimizing compiler (TurboFan)会对高频执行(“hot”)的函数进行深度优化 。</p>
<h4 data-id="heading-22">Key Rules :</h4>
<ul>
<li>减少 try-catch in hot paths （破坏编译器信心 ）</li>
<li>减少 arguments usage （阻止参数数量推断 ）</li>
<li>使用显式循环而非函數式编程风格 （如 reduce ）</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ Non-JIT-friendly hot loop  </span>
<span class="hljs-keyword">let</span> sum= arr.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">a,b</span>)=&gt;</span>a+b ,<span class="hljs-number">0</span>);

<span class="hljs-comment">// ✅ Optimizable version  </span>
<span class="hljs-keyword">let</span> sum=<span class="hljs-number">0</span> ;
<span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>;i&lt;arr.<span class="hljs-property">length</span>;i++) sum+=arr[i];
</code></pre>
<hr/>
<h3 data-id="heading-23">Conclusion</h3>
<p>Performance optimization is not about random tweaks—it requires understanding the underlying engine’s behavior . By studying how V８ works at the source code level , we can make informed decisions that align with its optimization strategies . The seven techniques covered here—from hidden class awareness to JIT-friendly coding patterns—are actionable takeaways you can apply immediately .</p>
<p>Remember : profile before optimizing! Tools like Chrome DevTools’ Performance tab and Node.js’ --prof flag are essential companions on this journey . Happy optimizing!</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS preview 预览文件 Kit 的入门讲解]]></title>    <link>https://juejin.cn/post/7571650164844462114</link>    <guid>https://juejin.cn/post/7571650164844462114</guid>    <pubDate>2025-11-13T00:27:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571650164844462114" data-draft-id="7571650164844445730" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS preview 预览文件 Kit 的入门讲解"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-13T00:27:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="万少"/> <meta itemprop="url" content="https://juejin.cn/user/4441682708283191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS preview 预览文件 Kit 的入门讲解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4441682708283191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    万少
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.5 如鱼得水
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.5 如鱼得水" title="VIP.5 如鱼得水" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T00:27:59.000Z" title="Thu Nov 13 2025 00:27:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"/>
<p>本文以实际工程为例，快速上手 HarmonyOS <strong>元服务</strong> 的文件预览能力（PreviewKit），并配套一个后端用于提供示例文件。示例工程路径：</p>
<ul>
<li>客户端（HarmonyOS 端）：<code>client</code></li>
<li>后端（Node.js）：<code>server</code></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/483497220a0e4dab90956bf83e31c2b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763598479&amp;x-signature=8Glr9vfT23NNTaxvWoJD0GcGCQo%3D" alt="image-20251112090708795" loading="lazy"/></p>
<p>image-20251112090708795</p>
<hr/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/509d3edb0c894064a95fa57bc8455e7f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763598479&amp;x-signature=Pr%2BoGCJw90X%2BbVE60gOJf03Bmtk%3D" alt="image-20251112091151694" loading="lazy"/></p>
<p>image-20251112091151694</p>
<p>上图是将 1个pdf文件和3个图片一起预览，那么就只会现实第1个预览窗口。</p>
<p><strong>下图是移除pdf文件，将3个同类型的图片放在一起预览</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf61a49902b74a4eb3a63d5ddebce9d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763598479&amp;x-signature=dgmkow8C39Y8pshx%2Bc8aBXfvA6s%3D" alt="image-20251112091518239" loading="lazy"/></p>
<p>image-20251112091518239</p>
<hr/>
<p><strong>为了方便演示功能，需要先将一些可以预览的文件下载到元服务的沙箱内，是基于这个原因我们才需要引入后端来模拟这个下载的环境，所以元服务内需要先实现下载文件，存储到沙箱，然后再使用预览API filePreview.openPreview预览沙箱内的文件。</strong></p>
<h3 data-id="heading-1">1. 工程结构与目标</h3>
<ul>
<li><code>client/entry/src/main/ets/pages/Index.ets</code>：演示并发下载 4 个文件（<code>1.pdf</code>、<code>1.png</code>、<code>2.png</code>、<code>3.png</code>）并一次性预览。</li>
<li><code>server/index.js</code> 与 <code>server/public/</code>：提供静态文件下载接口 <code>/file/:filename</code>。</li>
</ul>
<p>目标：</p>
<ul>
<li>点击“下载”按钮，并发下载上述 4 个文件到应用沙箱目录。</li>
<li>下载成功后点击“预览”，一次性打开最多 4 个文件的预览窗口。</li>
</ul>
<hr/>
<h3 data-id="heading-2">2. PreviewKit 的核心：filePreview.openPreview</h3>
<p>HarmonyOS 提供了预览能力包 <code>@kit.PreviewKit</code>。在 ETS 代码中引入：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { filePreview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PreviewKit'</span>;
<span class="hljs-keyword">import</span> { fileUri } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;
</code></pre>
<p>核心调用是：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 先准备多个文件的预览信息</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">prewList</span>: filePreview.<span class="hljs-property">PreviewInfo</span>[] = []
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {
  <span class="hljs-keyword">const</span> item = <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastDownloadedList</span>[i];
  <span class="hljs-keyword">const</span> <span class="hljs-attr">fileInfo</span>: filePreview.<span class="hljs-property">PreviewInfo</span> = {
    <span class="hljs-attr">title</span>: item.<span class="hljs-property">name</span>,                                  <span class="hljs-comment">// 预览标题</span>
    <span class="hljs-attr">uri</span>: fileUri.<span class="hljs-title function_">getUriFromPath</span>(item.<span class="hljs-property">path</span>),            <span class="hljs-comment">// 将沙箱路径转成 Uri</span>
    <span class="hljs-attr">mimeType</span>: item.<span class="hljs-property">mime</span> || <span class="hljs-string">'application/octet-stream'</span>, <span class="hljs-comment">// MIME 类型</span>
  };
  prewList.<span class="hljs-title function_">push</span>(fileInfo)
}

<span class="hljs-comment">// 一次性打开多个预览窗口</span>
filePreview.<span class="hljs-title function_">openPreview</span>(uiContext, prewList)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 打开成功</span>
  })
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {
    <span class="hljs-comment">// 打开失败处理</span>
  });
</code></pre>
<p>说明：</p>
<ul>
<li><code>PreviewInfo</code> 至少需要 <code>title</code>、<code>uri</code>、<code>mimeType</code>。</li>
<li><code>uri</code> 使用 <code>fileUri.getUriFromPath(沙箱文件路径)</code> 构造。</li>
<li>支持一次性传入一个 <code>PreviewInfo[]</code>，实现多文件预览。</li>
</ul>
<blockquote>
<p>图片占位：请补充一次性预览 4 个文件的窗口布局截图，标注窗口标题与 MIME 类型展示位置。</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">3. 并发下载与状态反馈（客户端）</h3>
<p>示例使用 <code>Promise.allSettled</code> 并发下载 4 个后端文件，并按项展示“成功/失败”状态：</p>
<pre><code class="hljs language-ini" lang="ini">// 计划 + 状态
@Local private plannedFiles: DownloadPlan<span class="hljs-section">[]</span> = <span class="hljs-section">[]</span><span class="hljs-comment">;</span>
@Local private itemStatuses: string<span class="hljs-section">[]</span> = <span class="hljs-section">[]</span><span class="hljs-comment">;</span>
@Local private isDownloading: <span class="hljs-attr">boolean</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
@Local private statusMessage: <span class="hljs-attr">string</span> = <span class="hljs-string">''</span><span class="hljs-comment">;</span>

// 初始化计划（aboutToAppear）
<span class="hljs-attr">this.plannedFiles</span> = [
  new DownloadPlan(<span class="hljs-string">'1.pdf'</span>, `<span class="hljs-variable">${this.serverBase}</span>/<span class="hljs-number">1</span>.pdf`),
  new DownloadPlan(<span class="hljs-string">'1.png'</span>, `<span class="hljs-variable">${this.serverBase}</span>/<span class="hljs-number">1</span>.png`),
  new DownloadPlan(<span class="hljs-string">'2.png'</span>, `<span class="hljs-variable">${this.serverBase}</span>/<span class="hljs-number">2</span>.png`),
  new DownloadPlan(<span class="hljs-string">'3.png'</span>, `<span class="hljs-variable">${this.serverBase}</span>/<span class="hljs-number">3</span>.png`)
]<span class="hljs-comment">;</span>
<span class="hljs-attr">this.itemStatuses</span> = [<span class="hljs-string">'未下载'</span>,<span class="hljs-string">'未下载'</span>,<span class="hljs-string">'未下载'</span>,<span class="hljs-string">'未下载'</span>]<span class="hljs-comment">;</span>

// 点击“下载”
<span class="hljs-attr">this.isDownloading</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
<span class="hljs-attr">this.statusMessage</span> = <span class="hljs-string">'下载中...'</span><span class="hljs-comment">;</span>
<span class="hljs-attr">this.itemStatuses</span> = new Array(this.plannedFiles.length).fill(<span class="hljs-string">'下载中...'</span>)<span class="hljs-comment">;</span>

const promises: Promise&lt;DownloadInfo&gt;<span class="hljs-section">[]</span> = this.plannedFiles.map(<span class="hljs-attr">p</span> =&gt; this.downloadFile(p.url))<span class="hljs-comment">;</span>
const <span class="hljs-attr">settled</span> = await Promise.allSettled(promises)<span class="hljs-comment">;</span>

// 汇总结果并一次性触发 UI 刷新
const successes: DownloadInfo<span class="hljs-section">[]</span> = <span class="hljs-section">[]</span><span class="hljs-comment">;</span>
const nextStatuses: string<span class="hljs-section">[]</span> = new Array(this.plannedFiles.length).fill('未下载')<span class="hljs-comment">;</span>
for (let <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; settled.length; i++) {</span>
  const <span class="hljs-attr">name</span> = this.plannedFiles[i].name<span class="hljs-comment">;</span>
  const <span class="hljs-attr">r</span> = settled[i]<span class="hljs-comment">;</span>
  if (<span class="hljs-attr">r.status</span> === <span class="hljs-string">'fulfilled'</span>) {
    successes.push(r.value)<span class="hljs-comment">;</span>
    nextStatuses<span class="hljs-section">[i]</span> = `✓ 下载成功：${name}`<span class="hljs-comment">;</span>
  } else {
    nextStatuses<span class="hljs-section">[i]</span> = `✗ 下载失败：${name}（${this.errorToString(r.reason as Object)}）`<span class="hljs-comment">;</span>
  }
}
<span class="hljs-attr">this.itemStatuses</span> = nextStatuses<span class="hljs-comment">; // 重新赋值以触发 UI 刷新</span>
<span class="hljs-attr">this.lastDownloadedList</span> = successes<span class="hljs-comment">;</span>
<span class="hljs-attr">this.isDownloading</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
</code></pre>
<p>UI 渲染建议：</p>
<ul>
<li>使用 <code>ForEach(this.plannedFiles, ...)</code> 动态渲染状态行，避免硬编码索引。</li>
<li>将与 UI 绑定的字段用 <code>@Local</code> 或 <code>@State</code> 修饰，并“重新赋值数组”以触发刷新（不要在原数组上就地修改元素）。</li>
</ul>
<blockquote>
<p>图片占位：请补充“下载中→成功/失败”逐项状态变化的截图，便于读者理解响应式刷新。</p>
</blockquote>
<hr/>
<h3 data-id="heading-4">4. HTTP 下载的细节与 ArkTS 限制规避</h3>
<ul>
<li>MIME 与扩展名：示例通过扩展名推断 MIME，若扩展名缺失则从响应头的 <code>Content-Type</code> 推断。</li>
<li>ArkTS 限制：不建议直接 <code>data.header['Content-Type']</code> 索引；示例使用序列化 + 正则方式提取避免 ArkTS 索引限制。</li>
</ul>

<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 通过序列化响应头并用正则提取 Content-Type</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">tryGetContentTypeHeader</span>(<span class="hljs-attr">headerObj</span>: <span class="hljs-title class_">Object</span> | <span class="hljs-literal">null</span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">if</span> (!headerObj) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> json = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(headerObj);
    <span class="hljs-keyword">if</span> (!json) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
    <span class="hljs-keyword">const</span> match = json.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/"content-type"\s*:\s*"([^"]+)"/i</span>);
    <span class="hljs-keyword">return</span> match &amp;&amp; match.<span class="hljs-property">length</span> &gt; <span class="hljs-number">1</span> ? match[<span class="hljs-number">1</span>] : <span class="hljs-string">''</span>;
  } <span class="hljs-keyword">catch</span> (_) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
  }
}
</code></pre>
<p>保存文件：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">filePath</span> = `<span class="hljs-variable">${this.filesDir}</span>/<span class="hljs-variable">${fileName}</span>`<span class="hljs-comment">;</span>
if (fileIo.accessSync(filePath)) {
  fileIo.unlinkSync(filePath)<span class="hljs-comment">;</span>
}
const <span class="hljs-attr">file</span> = fileIo.openSync(filePath, fileIo.OpenMode.CREATE | fileIo.OpenMode.WRITE_ONLY)<span class="hljs-comment">;</span>
const <span class="hljs-attr">bytesWritten</span> = fileIo.writeSync(file.fd, fileBuffer)<span class="hljs-comment">;</span>
fileIo.closeSync(file)<span class="hljs-comment">;</span>
</code></pre>
<p>权限：</p>
<ul>
<li>客户端需要在 <code>entry/src/main/module.json5</code> 声明 <code>ohos.permission.INTERNET</code> 才能进行网络请求。</li>
</ul>
<hr/>
<h3 data-id="heading-5">5. 后端：简单的静态文件下载接口</h3>
<p>示例后端路径：<code>d:\code\atoStudy\server</code>，目录 <code>public/</code> 放置 4 个演示文件。</p>
<p>核心路由：<code>GET /file/:filename</code></p>
<p>后端的简单目录结构：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/210e1a1877be4e7d948065c20a241e8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763598479&amp;x-signature=HCXQ0zRM6%2FTsE8T4irga3k6Uva0%3D" alt="image-20251112092243514" loading="lazy"/></p>
<p>image-20251112092243514</p>
<pre><code class="hljs language-ini" lang="ini">// index.js（简版示例）
const <span class="hljs-attr">express</span> = require(<span class="hljs-string">'express'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">path</span> = require(<span class="hljs-string">'path'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">app</span> = express()<span class="hljs-comment">;</span>

app.get('/file/:filename', (req, res) =&gt; {
  const <span class="hljs-attr">filename</span> = req.params.filename<span class="hljs-comment">;</span>
  const <span class="hljs-attr">filePath</span> = path.join(__dirname, <span class="hljs-string">'public'</span>, filename)<span class="hljs-comment">;</span>
  res.sendFile(filePath)<span class="hljs-comment">; // 或根据需要设置 Content-Type</span>
})<span class="hljs-comment">;</span>

app.listen(3000, () =&gt; {
  console.log('Server listening on http://localhost:3000')<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<p>客户端请求地址示例：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">private</span> serverBase: <span class="hljs-built_in">string</span> = <span class="hljs-string">"http://192.168.5.2:3000/file"</span>;
<span class="hljs-comment">// 组合完整 URL 示例：`${this.serverBase}/1.pdf`</span>
</code></pre>
<blockquote>
<p>注意：请按真实局域网 IP 替换 <code>192.168.5.2</code>，并保证手机/模拟器与后端在同一网络。</p>
</blockquote>
<hr/>
<h3 data-id="heading-6">6. 快速运行与验证</h3>
<p>后端：</p>
<ul>
<li>安装依赖并启动：<code>npm install &amp;&amp; node index.js</code></li>
<li>确认 <code>public/</code> 下存在 <code>1.pdf</code>、<code>1.png</code>、<code>2.png</code>、<code>3.png</code></li>
</ul>
<p>客户端：</p>
<ul>
<li>在 <code>module.json5</code> 中确保已声明 <code>ohos.permission.INTERNET</code></li>
<li>构建并安装到设备/模拟器</li>
<li>点击“下载”，观察逐项状态变化</li>
<li>下载成功后点击“预览”，验证多窗口预览是否正常</li>
</ul>
<blockquote>
<p>图片占位：请补充上述过程的关键截图（如“权限声明处”、“下载成功状态”、“多窗口预览”）。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">7. 常见问题与排查</h3>
<ul>
<li>权限错误（如 code=201 / “Permission denied”）：检查 <code>ohos.permission.INTERNET</code> 是否声明；确认真机/模拟器的网络可达性。</li>
<li>404 或下载失败：确认后端路由 <code>/file/:filename</code> 存在且文件确实在 <code>public/</code> 目录内；检查客户端 <code>serverBase</code> 地址是否正确。</li>
<li>MIME 与扩展名错配：优先使用后端返回的 <code>Content-Type</code>；如果缺失，则按扩展名推断。</li>
<li>UI 不刷新：在 ArkUI 中对数组进行“重新赋值”来触发刷新，避免原地修改元素（例如使用 <code>this.itemStatuses = [...nextStatuses]</code>）。</li>
</ul>
<hr/>
<h3 data-id="heading-8">8. 小结</h3>
<p><code>filePreview.openPreview</code> 是 HarmonyOS 文件预览能力的核心，支持一次性打开多文件预览。结合简单的后端静态文件服务与并发下载、响应式状态刷新，能够快速搭建一个“下载即预览”的演示工程。本文的示例工程完整覆盖了从后端文件提供、客户端下载与保存、到预览窗口打开的关键路径，适合作为入门教程与二次扩展的基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Swift 访问控制全解析】一篇就够：从 open 到 private，让接口与实现各就其位]]></title>    <link>https://juejin.cn/post/7571729682678808626</link>    <guid>https://juejin.cn/post/7571729682678808626</guid>    <pubDate>2025-11-13T00:47:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571729682678808626" data-draft-id="7554344985492209673" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Swift 访问控制全解析】一篇就够：从 open 到 private，让接口与实现各就其位"/> <meta itemprop="keywords" content="Swift"/> <meta itemprop="datePublished" content="2025-11-13T00:47:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="unravel2025"/> <meta itemprop="url" content="https://juejin.cn/user/1116759541421880"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Swift 访问控制全解析】一篇就够：从 open 到 private，让接口与实现各就其位
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759541421880/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    unravel2025
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T00:47:39.000Z" title="Thu Nov 13 2025 00:47:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">为什么需要“访问控制”</h2>
<ol>
<li>隐藏实现细节，只暴露必要接口</li>
<li>防止外部误用，减少后续兼容压力</li>
<li>支持模块化开发（App、Framework、Swift Package 多目标混合）</li>
</ol>
<p>一句话：接口公开，实现隐藏；该见的见，不该见的永远看不见。</p>
<h2 data-id="heading-1">Swift 的三层作用域与六级权限</h2>















































<table><thead><tr><th>级别</th><th>可见范围</th><th>可继承/重写</th><th>典型用途</th></tr></thead><tbody><tr><td>open</td><td>模块外可见，可子类化、可 override</td><td>✅</td><td>框架的“设计出口”</td></tr><tr><td>public</td><td>模块外可见，不可子类化/override</td><td>❌</td><td>稳定 API</td></tr><tr><td>package</td><td>同一 package 内所有模块</td><td>✅/❌</td><td>Swift Package 跨模块协作</td></tr><tr><td>internal</td><td>默认级，仅当前模块</td><td>✅</td><td>模块内部实现</td></tr><tr><td>fileprivate</td><td>仅当前源文件</td><td>✅</td><td>同一文件内多个类型/扩展共享</td></tr><tr><td>private</td><td>仅当前声明 + 同一文件内扩展</td><td>✅</td><td>最小化封装单元</td></tr></tbody></table>
<h2 data-id="heading-2">默认策略速记</h2>
<ul>
<li>不手写访问修饰符 → internal</li>
<li>类型的默认成员 → 跟随类型（类型 public → 成员 internal）</li>
<li>嵌套类型在 public 类型里 → internal（需要公开再写 public）</li>
</ul>
<h2 data-id="heading-3">代码实战：六级权限一次看个够</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 文件：FrameworkA.swift  (属于 FrameworkA 模块)</span>

<span class="hljs-comment">// 1. open：允许外部模块子类化</span>
<span class="hljs-keyword">open</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OpenClass</span> {
    <span class="hljs-keyword">open</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">overrideMe</span>() {}          <span class="hljs-comment">// 外部可 override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">notOverrideOutside</span>() {} <span class="hljs-comment">// 外部只能调，不能 override</span>
}

<span class="hljs-comment">// 2. public：稳定接口，不可继承</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">PublicAPI</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">init</span>() {}
    <span class="hljs-keyword">internal</span> <span class="hljs-keyword">var</span> innerCounter <span class="hljs-operator">=</span> <span class="hljs-number">0</span>      <span class="hljs-comment">// 模块外不可见</span>
}

<span class="hljs-comment">// 3. package：同一 Package 内共享</span>
package <span class="hljs-keyword">protocol</span> <span class="hljs-title class_">PackageService</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">fetch</span>() -&gt; <span class="hljs-type">String</span>
}

<span class="hljs-comment">// 4. internal：不暴露给外部</span>
<span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InnerHelper</span> {
    <span class="hljs-meta">@MainActor</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> shared <span class="hljs-operator">=</span> <span class="hljs-type">InnerHelper</span>()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">init</span>() {}
}

<span class="hljs-comment">// 5. fileprivate：同一文件内复用</span>
<span class="hljs-keyword">fileprivate</span> <span class="hljs-keyword">extension</span> <span class="hljs-title class_">String</span> {
    <span class="hljs-keyword">var</span> trimmed: <span class="hljs-type">String</span> { trimmingCharacters(in: .whitespaces) }
}

<span class="hljs-comment">// 6. private：隐藏到“声明内部”</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Trimmer</span> {
    <span class="hljs-keyword">private(set)</span> <span class="hljs-keyword">var</span> count: <span class="hljs-type">Int</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>   <span class="hljs-comment">// 只读公开，写私有</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">trim</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">s</span>: <span class="hljs-keyword">inout</span> <span class="hljs-type">String</span>) {
        s <span class="hljs-operator">=</span> s.trimmed                 <span class="hljs-comment">// 同一文件，可访问 fileprivate</span>
        count <span class="hljs-operator">+=</span> <span class="hljs-number">1</span>
    }
}
</code></pre>
<h2 data-id="heading-4">继承与重写中的“升权”</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 同一模块内</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> {
    <span class="hljs-keyword">fileprivate</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">hidden</span>() {}
}

<span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span>: <span class="hljs-title class_">A</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">internal</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">hidden</span>() {} <span class="hljs-comment">// 合法：在同一文件，升级访问权</span>
}
</code></pre>
<p>规则回顾：</p>
<ol>
<li>子类访问级别 ≤ 父类</li>
<li>重写可提高访问权，但不能降低</li>
<li>跨模块只能继承/重写 <code>open</code> 成员</li>
</ol>
<h2 data-id="heading-5">协议、扩展、泛型、别名的细节</h2>
<ol>
<li>协议</li>
</ol>
<ul>
<li>协议权限 ≥ 其所有要求</li>
<li>继承的协议不能比父协议更开放</li>
<li>conformance 权限 = min(类型权限, 协议权限)</li>
</ul>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">public</span> <span class="hljs-keyword">protocol</span> <span class="hljs-title class_">PublicProtocol</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">foo</span>()
}
<span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InternalImpl</span>: <span class="hljs-title class_">PublicProtocol</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">foo</span>() {}   <span class="hljs-comment">// 自动 internal，满足要求</span>
}
</code></pre>
<ol start="2">
<li>扩展</li>
</ol>
<ul>
<li>扩展可写访问修饰符，为内部成员统一设置默认级</li>
<li>用于协议 conformance 的扩展不能写访问修饰符，由协议本身决定</li>
</ul>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">extension</span> <span class="hljs-title class_">Trimmer</span>: <span class="hljs-title class_">CustomStringConvertible</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">var</span> description: <span class="hljs-type">String</span> { <span class="hljs-string">"trimmed <span class="hljs-subst">\(count)</span> times"</span> }
}
</code></pre>
<ol start="3">
<li>泛型</li>
</ol>
<ul>
<li>泛型实体权限 = min(自身权限, 所有约束类型权限)</li>
</ul>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">internal</span> <span class="hljs-keyword">protocol</span> <span class="hljs-title class_">CacheKey</span> {}
<span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cache</span>&lt;<span class="hljs-title class_">T</span>: <span class="hljs-title class_">CacheKey</span>&gt; {} <span class="hljs-comment">// 实际权限 internal</span>
</code></pre>
<ol start="4">
<li>类型别名</li>
</ol>
<ul>
<li>别名权限 ≤ 原类型权限</li>
<li>利用别名可在模块外“隐藏”真实类型</li>
</ul>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">public</span> <span class="hljs-keyword">typealias</span> <span class="hljs-type">Token</span> <span class="hljs-operator">=</span> <span class="hljs-type">String</span>   <span class="hljs-comment">// OK</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">typealias</span> <span class="hljs-type">SecretDict</span> <span class="hljs-operator">=</span> [<span class="hljs-type">String</span>: <span class="hljs-keyword">Any</span>] <span class="hljs-comment">// 仅当前文件可用</span>
</code></pre>
<h2 data-id="heading-6">Package 级访问：多模块仓库的“朋友圈”</h2>
<p>场景：一个 Swift Package 包含 Network、UI、Core 三个模块，希望 Core 的接口仅被 Network/UI 使用，而不暴露给最终 App。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// Core 模块</span>
package <span class="hljs-keyword">protocol</span> <span class="hljs-title class_">DataLoader</span> {
    package <span class="hljs-keyword">func</span> <span class="hljs-title function_">load</span>() -&gt; <span class="hljs-type">Data</span>
}
</code></pre>
<p>在 Package 外（App）<code>import Core</code> 后，无法看见 <code>DataLoader</code>，真正做到“仓库内共享，仓库外隔离”。</p>
<h2 data-id="heading-7">常见踩坑与调试技巧</h2>

























<table><thead><tr><th>错误提示</th><th>原因</th><th>解决</th></tr></thead><tbody><tr><td>Cannot assign to property: ‘count’ is a get-only property</td><td>用了 <code>private(set)</code> 却在外部赋值</td><td>移除 setter 限制或提供内部 API</td></tr><tr><td>Class cannot be declared public because its superclass is internal</td><td>子类比父类“显眼”</td><td>提升父类或降低子类</td></tr><tr><td>Function cannot be declared internal because its parameter uses a private type</td><td>函数权限 &gt; 参数权限</td><td>提升类型权限或降低函数权限</td></tr></tbody></table>
<h2 data-id="heading-8">总结与工程实践建议</h2>
<ol>
<li>
<p>写框架先画“可见性矩阵”：哪些类需要被继承？哪些 API 未来必须冻结？</p>
<ul>
<li>需要被继承 → <code>open</code></li>
<li>仅调用 → <code>public</code></li>
<li>仓库内复用 → <code>package</code></li>
<li>模块内复用 → <code>internal</code></li>
<li>文件内工具 → <code>fileprivate</code></li>
<li>纯内部辅助 → <code>private</code></li>
</ul>
</li>
<li>
<p>先写 <code>internal</code>，真正需要暴露时再升级，避免“过度公开”</p>
</li>
<li>
<p>对<code>private(set)</code>“只读公开”模式上瘾，可大幅减少后续 Breaking Change。</p>
</li>
<li>
<p>用 <code>@testable</code> 而非“为了测试把 private 改成 public”。</p>
</li>
<li>
<p>大型 Package 采用“Core → Service → UI”三级依赖，配合 <code>package</code> 访问级，保证依赖方向无环，又隐藏核心实现。</p>
</li>
</ol>
<h2 data-id="heading-9">扩展场景：访问控制 + SwiftUI + 插件化架构</h2>
<p>SwiftUI 的 <code>public</code> 初始化器经常需要接收“仅内部使用的配置对象”。此时可用类型擦除 + 协议权限组合：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 对外只能拿到协议</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">protocol</span> <span class="hljs-title class_">ConfigProtocol</span> {}

<span class="hljs-comment">// 实际配置在模块内</span>
<span class="hljs-keyword">internal</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">RealConfig</span>: <span class="hljs-title class_">ConfigProtocol</span> {
    <span class="hljs-keyword">var</span> apiKey: <span class="hljs-type">String</span>
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">MyView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">init</span>(<span class="hljs-params">config</span>: <span class="hljs-type">ConfigProtocol</span>) { <span class="hljs-operator">...</span> }
}
</code></pre>
<p>App 只能持有 <code>ConfigProtocol</code>，无法直接访问 <code>apiKey</code>，实现“接口公开，配置隐藏”。</p>
<h2 data-id="heading-10">一句话背下来</h2>
<p>“高”不能依赖“低”，默认 internal 先写着；需要再升级，绝不一步到位全 public</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Agentic AI基础设施实践经验系列（七）：可观测性在Agent应用的挑战与实践]]></title>    <link>https://juejin.cn/post/7571743311519252489</link>    <guid>https://juejin.cn/post/7571743311519252489</guid>    <pubDate>2025-11-13T00:48:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571743311519252489" data-draft-id="7571655312798711834" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Agentic AI基础设施实践经验系列（七）：可观测性在Agent应用的挑战与实践"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-13T00:48:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="亚马逊云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2850395271209496"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Agentic AI基础设施实践经验系列（七）：可观测性在Agent应用的挑战与实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2850395271209496/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    亚马逊云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T00:48:32.000Z" title="Thu Nov 13 2025 00:48:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读23分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/974c07f8ccf246b891b51d00be2ffa69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763600074&amp;x-signature=oZZIPnD09IezVjZ6ak46ufFuJa4%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-0">一. 引言：</h2>
<p>我们正处在一个由 AI Agent 驱动的范式转换前夜。它们不再只是简单的文本生成器，而是能够理解复杂指令、自主规划多步任务，并调用各类 API 与数字世界交互的“数字工作者”；在为大型语言模型增加“执行臂膀”后，Agent 正在成为企业应用中的“能力放大器”。</p>
<p>过去，当我们监控传统微服务或 Web 应用时，“Metrics → Logs → Traces” 的可观测模型已足够应对。但在 Agent 场景，它只能告诉我们“发生了什么”，却无法解释“为什么会这样”——也无法指明“下一步该怎么办”。一旦将关键业务流程托付给 Agent，黑盒效应便迅速显现：</p>
<ul>
<li>决策的“原因”：为何 Agent 选择在此时发起特定调用？它基于怎样的上下文与推理？</li>
<li>行为的“链条”：在这次调用之前，Agent 是否已经与用户或其他工具反复交互？这一步是解决方案的关键，还是误入歧途的昂贵尝试？</li>
<li>结果的“质量”：返回的内容是否真正提升了任务完成度，还是引入了新的偏差或错误？</li>
</ul>
<p>在下文中，我们将结合 Amazon Bedrock、Amazon Bedrock AgentCore、Amazon CloudWatch 等原生能力，构建一套从行为洞察到质量评估、从成本监控到闭环优化的多维度可观测框架。</p>
<h2 data-id="heading-1">二. Agent 可观测性详解</h2>
<p>Agentic AI可观测性是一个多维度的概念，它不仅包括传统应用监控中的指标，还需要特别关注AI特有的行为特征。在Agent系统中，我们需要监控从用户输入到最终输出的整个处理流程，包括模型调用、推理过程、工具使用等各个环节。这种全方位的监控能力使我们能够及时发现问题、优化性能、提升用户体验。对于Agent系统，这里主要需要关注指标、追踪两方面。</p>
<h3 data-id="heading-2">重要指标</h3>
<h4 data-id="heading-3">响应时间指标：时间相关的指标是评估Agent性能的重要维度。其中最关键的是以下几个指标：</h4>
<ul>
<li>总体请求处理时间（TotalTime）： 这个指标衡量了从接收用户请求到生成最终响应的完整时间。例如，当用户询问”巴黎的天气如何？”时，系统可能需要500ms来理解问题，300ms调用天气API，再用200ms生成回答，总计1000ms。监控这个指标可以帮助我们发现性能瓶颈，优化响应速度。</li>
<li>首个token生成时间（TTFT）： 这是衡量系统响应速度的关键指标。它记录从请求开始到生成第一个响应token的时间。比如，如果系统在接收到问题后能在200ms内开始生成回答，这表明系统的初始响应速度较快。这个指标对于提供流式响应的系统特别重要。</li>
<li>模型延迟（ModelLatency）： 专门衡量模型推理所需的时间。通过监控这个指标，我们可以评估不同模型的性能表现，为特定场景选择最适合的模型。</li>
</ul>
<h4 data-id="heading-4"><strong>Token</strong>使用指标：Token使用情况直接关系到系统的运营成本和效率</h4>
<ul>
<li>输入Token数量（InputTokenCount）： 记录发送给模型的token数量。例如，一个包含系统提示词、上下文历史和用户问题的请求可能使用了1000个token。这个指标帮助我们优化提示词设计和上下文管理策略。</li>
<li>输出Token数量（OutputTokenCount）： 统计模型生成的token数量。比如，一个详细的天气报告响应可能产生200个token。监控这个指标有助于控制响应的简洁度和成本。</li>
</ul>
<h4 data-id="heading-5">工具使用指标：Agent系统中的工具调用情况也需要密切监控：</h4>
<ul>
<li>调用频率（InvocationCount）： 记录每个工具被调用的次数。例如，在一个客服Agent中，可能发现知识库查询工具的使用频率是订单查询工具的三倍，这样的信息可以指导我们优化工具的设计和缓存策略。</li>
<li>工具执行时间： 监控每个工具的执行耗时。比如，如果发现天气API的平均响应时间超过800ms，可能需要考虑更换更合适的模型或实施缓存机制。</li>
</ul>
<h4 data-id="heading-6"><strong>Agent</strong>追踪：完整的执行链路视图</h4>
<p>在传统的可观测性三支柱中，追踪（Tracing）对于Agent系统具有独特且至关重要的价值。与指标和日志相比，追踪能够提供Agent决策过程的完整上下文链路，这对于理解和优化AI系统的行为模式至关重要。传统指标虽然能够反映系统的健康状况和性能特征，但无法解释Agent在特定情境下做出某个决策的原因。日志虽然提供了详细的事件记录，但往往缺乏跨服务的关联性，难以构建完整的执行图谱。而追踪数据通过span的层次化结构，能够精确记录Agent从接收用户输入、理解意图、规划执行路径、调用工具、生成响应的完整决策链条。这种端到端的可见性使开发者能够快速定位性能瓶颈、识别错误根因，并深入理解Agent的推理逻辑。</p>
<p>根据Amazon X-Ray和OpenTelemetry的最佳实践，Agent场景下的追踪数据不仅记录了”发生了什么”，更重要的是揭示了”为什么这样发生”以及”各个组件之间如何相互作用”。具体而言，Agent追踪系统需要关注以下几个核心维度：</p>
<ul>
<li><strong>Agent</strong>执行追踪：提供完整的执行链路视图，包括系统级追踪和推理周期追踪。系统级追踪记录每个请求的完整生命周期，从用户输入、系统提示词到最终响应的全过程，形成完整的执行图谱帮助理解Agent的决策过程。推理周期追踪则深入到每个推理步骤的细节，详细记录当前思考步骤的内容、工具调用的决策过程以及中间结果的处理方式，这些信息对于调试复杂的推理链特别有价值。</li>
<li>错误和异常追踪：系统中的错误和异常需要特别关注，主要包括客户端错误和服务器错误两类。客户端错误记录由客户端引起的问题，如参数错误、认证失败等，这些信息帮助改进API设计和文档。服务器错误则追踪服务器端的异常情况，如模型调用失败、资源不足等，这类信息对于提升系统可靠性至关重要。</li>
</ul>
<p>而这些内容均可通过Opentelemerty 协议记录并传输到后端以供分析。在OpenTelemetry的追踪体系中，每个操作都有对应的span ID和trace ID，这两个标识符构成了分布式追踪的核心骨架。Trace ID代表Agent执行循环中的一次完整会话，从用户发起请求到Agent返回最终结果的整个生命周期都会共享同一个trace ID。而span ID则代表这个执行循环中的每个具体操作，如模型调用、工具执行、上下文检索等，每个span ID都是唯一的，并通过父子关系构建起完整的执行树状结构。在Agent场景中，一个trace包含了从用户输入到最终响应生成的所有中间步骤，每个步骤都通过span来表示。Agent traces通常包含模型调用span和工具调用span，这些span会根据其追踪的步骤类型，被丰富的上下文信息所充实。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28283cfd823d48b9b702f176d1697a1a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763600074&amp;x-signature=SGAx5MnYpW3dxWPW4UxClxWNsSw%3D" alt="图1.webp" loading="lazy"/></p>
<p align="center">图1. Agent完整执行链路</p>
<p>除了标准属性外，OpenTelemetry还提供了baggage机制来传递自定义的跨服务元数据。Baggage是一种分布式上下文传播机制，允许开发者在整个请求链路中传递业务相关的键值对信息。例如，可以通过baggage传递用户类型、实验标识、会话主题等业务属性，这些信息会自动附加到所有相关的span中，为后续的离线评估、性能分析和A/B测试提供宝贵的上下文。通过合理使用baggage机制，开发者可以实现更精细化的Agent行为分析和优化。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/20bad2053eba427c804c86682df24355~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763600074&amp;x-signature=xeFrntbemsjKoObRkVDV6c5H5l4%3D" alt="图2.webp" loading="lazy"/></p>
<p align="center">图2. OpenTelemetry span机制</p>
<p>许多Agent框架已自带Opentelemetry支持，但仍需要将Opentelemetry SDK嵌入应用中。对于采用Python开发的Agent，可使用自动注入方式，利用 opentelemetry-instrument  命令将SDK自动嵌入到应用中。这一命令会自动化配置流程，从参数或环境变量中生成Opentelemetry配置，并自动将SDK附加至Agent的内部，亚马逊云科技调用，或其他的外部调用中。这样，Agent的所有操作都会被Opentelemetry记录并传输到后端。</p>
<p>下面是一段跟踪数据的样本：</p>
<pre><code class="hljs language-swift" lang="swift">{
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"chat"</span>,
    <span class="hljs-string">"context"</span>: {
        <span class="hljs-string">"trace_id"</span>: <span class="hljs-string">"0x68888fcdba6326c1fc004fe9396ad6a8"</span>,
        <span class="hljs-string">"span_id"</span>: <span class="hljs-string">"0x4f4c5c4caf92a36d"</span>,
        <span class="hljs-string">"trace_state"</span>: <span class="hljs-string">"[]"</span>
    },
    <span class="hljs-string">"kind"</span>: <span class="hljs-string">"SpanKind.CLIENT"</span>,
    <span class="hljs-string">"parent_id"</span>: <span class="hljs-string">"0xbc776902450f8294"</span>,
    <span class="hljs-string">"start_time"</span>: <span class="hljs-string">"2025-07-29T09:09:33.427326Z"</span>,
    <span class="hljs-string">"end_time"</span>: <span class="hljs-string">"2025-07-29T09:09:34.932205Z"</span>,
    <span class="hljs-string">"status"</span>: {
        <span class="hljs-string">"status_code"</span>: <span class="hljs-string">"OK"</span>
    },
    <span class="hljs-string">"attributes"</span>: {
        <span class="hljs-string">"session.id"</span>: <span class="hljs-string">"session-1234"</span>,
        <span class="hljs-string">"gen_ai.event.start_time"</span>: <span class="hljs-string">"2025-07-29T09:09:33.427342+00:00"</span>,
        <span class="hljs-string">"gen_ai.system"</span>: <span class="hljs-string">"strands-agents"</span>,
        <span class="hljs-string">"gen_ai.operation.name"</span>: <span class="hljs-string">"chat"</span>,
        <span class="hljs-string">"gen_ai.request.model"</span>: <span class="hljs-string">"us.anthropic.claude-3-5-haiku-20241022-v1:0"</span>,
        <span class="hljs-string">"gen_ai.event.end_time"</span>: <span class="hljs-string">"2025-07-29T09:09:34.932173+00:00"</span>,
        <span class="hljs-string">"gen_ai.usage.prompt_tokens"</span>: <span class="hljs-number">443</span>,
        <span class="hljs-string">"gen_ai.usage.input_tokens"</span>: <span class="hljs-number">443</span>,
        <span class="hljs-string">"gen_ai.usage.completion_tokens"</span>: <span class="hljs-number">76</span>,
        <span class="hljs-string">"gen_ai.usage.output_tokens"</span>: <span class="hljs-number">76</span>,
        <span class="hljs-string">"gen_ai.usage.total_tokens"</span>: <span class="hljs-number">519</span>
    },
    <span class="hljs-string">"events"</span>: [
        {
            <span class="hljs-string">"name"</span>: <span class="hljs-string">"gen_ai.user.message"</span>,
            <span class="hljs-string">"timestamp"</span>: <span class="hljs-string">"2025-07-29T09:09:33.427368Z"</span>,
            <span class="hljs-string">"attributes"</span>: {
                <span class="hljs-string">"content"</span>: <span class="hljs-string">"[{<span class="hljs-subst">\"</span>text<span class="hljs-subst">\"</span>: <span class="hljs-subst">\"</span>Research and recommend suitable travel destinations for someone looking for China traditional culture experience in Beijing city. <span class="hljs-subst">\\</span>nUse web search to find current information about venues, <span class="hljs-subst">\\</span>nevents, and attractions.<span class="hljs-subst">\"</span>}]"</span>
            }
        },
        {
            <span class="hljs-string">"name"</span>: <span class="hljs-string">"gen_ai.choice"</span>,
            <span class="hljs-string">"timestamp"</span>: <span class="hljs-string">"2025-07-29T09:09:34.932167Z"</span>,
            <span class="hljs-string">"attributes"</span>: {
                <span class="hljs-string">"finish_reason"</span>: <span class="hljs-string">"tool_use"</span>,
                <span class="hljs-string">"message"</span>: <span class="hljs-string">"[{<span class="hljs-subst">\"</span>text<span class="hljs-subst">\"</span>: <span class="hljs-subst">\"</span>I'll search for the best traditional cultural experiences in Beijing.<span class="hljs-subst">\"</span>}, {<span class="hljs-subst">\"</span>toolUse<span class="hljs-subst">\"</span>: {<span class="hljs-subst">\"</span>toolUseId<span class="hljs-subst">\"</span>: <span class="hljs-subst">\"</span>tooluse_JSt-cJ9fRU28RmhdJ1XENA<span class="hljs-subst">\"</span>, <span class="hljs-subst">\"</span>name<span class="hljs-subst">\"</span>: <span class="hljs-subst">\"</span>web_search<span class="hljs-subst">\"</span>, <span class="hljs-subst">\"</span>input<span class="hljs-subst">\"</span>: {<span class="hljs-subst">\"</span>query<span class="hljs-subst">\"</span>: <span class="hljs-subst">\"</span>Top traditional cultural attractions and experiences in Beijing 2024<span class="hljs-subst">\"</span>}}}]"</span>
            }
        }
    ],
    <span class="hljs-string">"links"</span>: [],
    <span class="hljs-string">"resource"</span>: {
        <span class="hljs-string">"attributes"</span>: {
            <span class="hljs-string">"telemetry.sdk.language"</span>: <span class="hljs-string">"python"</span>,
            <span class="hljs-string">"telemetry.sdk.name"</span>: <span class="hljs-string">"opentelemetry"</span>,
            <span class="hljs-string">"telemetry.sdk.version"</span>: <span class="hljs-string">"1.33.1"</span>,
            <span class="hljs-string">"service.name"</span>: <span class="hljs-string">"agentic-travel-strands"</span>,
            <span class="hljs-string">"telemetry.auto.version"</span>: <span class="hljs-string">"0.10.0-aws"</span>,
            <span class="hljs-string">"aws.local.service"</span>: <span class="hljs-string">"agentic-travel-strands"</span>,
            <span class="hljs-string">"aws.service.type"</span>: <span class="hljs-string">"gen_ai_agent"</span>
        },
        <span class="hljs-string">"schema_url"</span>: <span class="hljs-string">""</span>
</code></pre>
<p>从这个示例中可以看到，Strands Agent框架已经内置了对OpenTelemetry的深度集成支持。根据Strands官方文档，该框架遵循OpenTelemetry GenAI语义约定，会自动将Agent的内部决策过程以标准化的事件（event）形式发送至追踪后端。这种自动化的遥测数据收集机制大大简化了Agent应用的可观测性实现，开发者无需手动编写复杂的追踪代码，即可获得生产级别的监控能力。</p>
<p>Strands Agent的OpenTelemetry集成特别针对GenAI工作负载进行了优化，能够自动捕获Agent执行过程中的关键信息，包括用户消息、系统提示词、模型推理结果、工具调用参数和返回值等。每个操作都会被封装为符合OpenTelemetry语义约定的span，并通过 Baggage 机制，自动添加相应的属性标签。</p>
<p>从上面的示例中可以看到，常用的元数据包括session.id（会话标识符）、gen_ai.system（AI系统标识，如strands-agents）、gen_ai.operation.name（操作名称，如chat）、gen_ai.request.model（请求的模型名称）以及各种token使用统计信息。这些元数据对于后续的数据分析和问题诊断至关重要。这些标准化的属性遵循OpenTelemetry GenAI语义约定，确保了不同Agent框架和监控平台之间的互操作性。</p>
<p>默认情况下，Agent应用产生的遥测数据会通过OTLP（OpenTelemetry Protocol）协议直接发送到CloudWatch的OTLP端点，这种直连方式简化了部署架构，减少了额外的基础设施维护成本。然而，在生产环境中，为了实现更灵活的数据处理和路由策略，通常会在数据源和目标系统之间部署OpenTelemetry Collector作为中间处理层。</p>
<p>OpenTelemetry Collector是一个功能强大的独立服务组件，专门用于接收、处理和导出遥测数据到多个目标系统。其架构采用了管道化设计，包含三个核心组件：Receivers（接收器）负责从各种数据源收集遥测数据，Processors（处理器）对数据执行转换、过滤、采样、属性增删等操作，Exporters（导出器）将处理后的数据发送到指定的后端系统。</p>
<p>在Agent可观测性场景中，Collector的处理器组件尤其有价值。例如，可以使用attributes处理器为特定的Agent span添加环境标签或业务标识，使用sampling处理器对高频操作进行智能采样以控制数据量，使用filter处理器过滤掉敏感信息或无关数据，使用batch处理器优化网络传输效率。这种流水线式的数据处理能力使企业能够根据具体需求定制化Agent遥测数据的收集和分发策略，实现成本效益的最优平衡。</p>
<h2 data-id="heading-7">三. 实践方式：开源生态以及亚马逊云科技托管方案</h2>
<p>在理解了Agent可观测性的核心概念和关键指标后，我们需要将这些理论转化为实际的技术实现。亚马逊云科技生态系统为Agent可观测性提供了完整的托管解决方案，同时开源社区也贡献了丰富的第三方工具。接下来，我们将详细探讨如何在不同的技术栈和部署环境中实现Agent的全方位监控。</p>
<h3 data-id="heading-8">3.1 Amazon Cloudwatch GenAI Observability</h3>
<p>Amazon Cloudwatch GenAI Observability 专门用于监控生成式AI工作负载，包括Amazon Bedrock AgentCore Runtime。它提供：</p>
<p>1、端到端提示词跟踪(End-to-end prompt tracing) – 跟踪 AI Agent 的所有行为（包含大模型推理和工具调用）</p>
<p>2、预配置仪表板 – 提供两个内置仪表板：</p>
<ol>
<li>Model Invocations – 详细的模型使用、token消耗和成本指标</li>
<li>Amazon Bedrock AgentCore agents – 代理的性能和决策指标</li>
</ol>
<p>3、关键指标监控：</p>
<ol>
<li>总调用次数和平均调用次数</li>
<li>Token使用情况（总数、每查询平均数、输入、输出）</li>
<li>延迟（平均值、P90、P99）</li>
<li>错误率和限流事件</li>
<li>按应用程序、用户角色或特定用户的成本归因</li>
</ol>
<p>GenAI Observability的核心是Cloudwatch Transation Search，GenAI Observability利用Cloudwatch Transation Search收集并转换的结构化日志进行AI工作负载的深度分析。</p>
<p>亚马逊云科技在现有X-ray跟踪服务的基础上，推出了CloudWatch Transaction Search。Transaction Search最核心的创新在于其双重存储策略，这一设计巧妙地平衡了成本效益与数据完整性。当用户启用Transaction Search时，所有发送到X-Ray的spans都会被自动转换为语义约定格式（semantic convention format），并以结构化日志的形式存储在CloudWatch Logs的专用日志组aws/spans中。这个转换过程完全透明，spans会自动采用W3C trace ID标准，确保与OpenTelemetry生态系统的完整兼容性。每个span都包含完整的追踪信息：开始时间、结束时间、持续时间，以及丰富的元数据，包括业务属性如客户ID、订单ID等。这些数据全部可以进行搜索和分析，完全消除了传统采样带来的”盲区”问题。</p>
<p>Transaction Search提供的搜索能力远超传统X-Ray的范畴。通过可视化编辑器，用户可以基于任意span属性进行搜索，包括服务名称、span持续时间、状态码，以及自定义的业务属性。系统支持多种查询格式，List格式专注于单个span的详细分析，特别适合故障排查。当出现问题时，工程师可以直接使用对应的业务ID快速定位相关的trace，然后深入分析具体的执行路径。Group analysis格式提供聚合分析能力，可以按照可用区、状态码或客户ID等维度进行分组统计，快速识别影响面最大的问题。对于熟悉SQL的用户，Transaction Search还支持CloudWatch Logs Insights查询语言，提供更灵活的数据分析能力。</p>
<h4 data-id="heading-9">a. 在 Bedrock AgentCore Runtime 上集成Cloudwatch GenAI Observability</h4>
<p>Bedrock AgentCore Observability 在 Cloudwatch GenAI Observability 的基础上，为 Bedrock AgentCore Runtime上运行的 Agent 提供更便捷的可观测性体验。在基础设施层面，AgentCore Runtime会自动创建和配置所需的CloudWatch日志组（如<code>/aws/bedrock-AgentCore/runtimes/&lt;agent_id&gt;-&lt;endpoint_name&gt;/runtime-logs</code>），自动处理IAM权限，并预配置好OTEL环境变量，应用只需添加Opentemeletry SDK即可使用，无需配置任何参数或环境变量。</p>
<p>AgentCore为不同资源类型提供差异化的默认观测能力：</p>
<p>Agent资源的指标可以在GenAI Observability页面直接查看，AgentCore自动提供针对Agent运行时的丰富指标，如Invocations（API请求总数）、Session Count（Agent会话总数）、细分的错误类型统计（InvocationError.Validation、InvocationError.Internal等），以及跨所有资源的聚合指标。</p>
<p>而Memory、Gateway、Tools资源的指标、spans和logs会自动路由到相应的CloudWatch组件中。特别是Memory资源，AgentCore提供了独特的深度可观测性，包括Creation Count（内存事件创建数量）、Memory特定的延迟指标，以及专门的工作流日志（提取日志和整合日志）。</p>
<p>我们提供基于 Jupyter Notebook 的快速使用指导，帮助您快速在 Amazon Bedrock AgentCore Runtime 上部署一个AI Agent，并从Bedrock AgentCore Observability 上观测Agent 的运行状况。您可以从 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fawslabs%2Famazon-bedrock-agentcore-samples%2Ftree%2Fmain%2F01-tutorials%2F06-AgentCore-observability%2F01-Agentcore-runtime-hosted" target="_blank" title="https://github.com/awslabs/amazon-bedrock-agentcore-samples/tree/main/01-tutorials/06-AgentCore-observability/01-Agentcore-runtime-hosted" ref="nofollow noopener noreferrer">此处</a> 获取此快速使用指导。</p>
<h4 data-id="heading-10">b. 在其他计算服务上集成Amazon Cloudwatch GenAI Observability</h4>
<p>对于选择在自建运行环境（如EC2、EKS、Lambda等）部署Agent，但仍希望使用CloudWatch GenAI Observability能力的组织，可以通过标准的OpenTelemetry集成来实现。您可以在软件包管理器中安装ADOT SDK依赖，将SDK注入到Agent代码中，配置详细的OTEL环境变量后，即可将可观测性数据上送至Cloudwatch。CloudWatch GenAI Observability的体验与AgentCore一致，您同样可以基于Trace和Span进行查询，但无法使用Bedrock AgentCore Observability 的指标面板，需要您自行创建。</p>
<p>我们提供基于 Jupyter Notebook 的快速使用指导，帮助您在本地运行基于 Strands 框架的 AI Agent，并从Cloudwatch GenAI Observability 上观测Agent 的运行状况。您可以从 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fawslabs%2Famazon-bedrock-agentcore-samples%2Ftree%2Fmain%2F01-tutorials%2F06-AgentCore-observability%2F01-Agentcore-runtime-hosted" target="_blank" title="https://github.com/awslabs/amazon-bedrock-agentcore-samples/tree/main/01-tutorials/06-AgentCore-observability/01-Agentcore-runtime-hosted" ref="nofollow noopener noreferrer">此处</a> 获取此快速使用指导。</p>
<h3 data-id="heading-11">3.2 MLFlow、Langfuse等第三方组件</h3>
<p>除了Cloudwatch GenAI Observability，许多开源第三方工具，例如Langfuse、MLFlow 也作为观测数据的分析平台。可以提供包括：数据可视化和分析界面，执行边缘案例分析，评估准确性和成本的权衡，分析用户交互模式，提供性能优化建议。</p>
<p>以Amazon SageMaker 托管的 <a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fblogs%2Fmachine-learning%2Faccelerating-generative-ai-development-with-fully-managed-mlflow-3-0-on-amazon-sagemaker-ai%2F" target="_blank" title="https://aws.amazon.com/cn/blogs/machine-learning/accelerating-generative-ai-development-with-fully-managed-mlflow-3-0-on-amazon-sagemaker-ai/" ref="nofollow noopener noreferrer">MLFlow 3.0</a> 进行 Agent 开发中的 Tracing 为例，通过全托管 MLflow 3.0 的追踪能力，开发者可以记录请求每个中间步骤关联的输入、输出和元数据，从而准确定位错误根源和意外行为的来源。以下示例代码展示了使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fstrandsagents.com%2Flatest%2F" target="_blank" title="https://strandsagents.com/latest/" ref="nofollow noopener noreferrer">Strands Agents</a> 来构建一个基本的 Agent 工作流及使用MLFlow来对其中间环节进行追踪。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@mlflow</span>.<span class="hljs-built_in">trace</span>(name= <span class="hljs-string">"strands-bedrock"</span>, attributes={<span class="hljs-string">"k"</span>: <span class="hljs-string">"v"</span>}, span_type=SpanType.LLM)
def <span class="hljs-built_in">get_model</span>():...

<span class="hljs-variable">@mlflow</span>.<span class="hljs-built_in">trace</span>(name= <span class="hljs-string">"strands-agent"</span>, attributes={<span class="hljs-string">"k"</span>: <span class="hljs-string">"v"</span>}, span_type=SpanType.AGENT)
def <span class="hljs-built_in">create_agent</span>(model):...

<span class="hljs-variable">@mlflow</span>.<span class="hljs-built_in">trace</span>(name= <span class="hljs-string">"strands-chain"</span>, attributes={<span class="hljs-string">"k"</span>: <span class="hljs-string">"v"</span>}, span_type=SpanType.CHAIN)
def <span class="hljs-built_in">run_agent</span>():
    model = <span class="hljs-built_in">get_model</span>()
    agent = <span class="hljs-built_in">create_agent</span>(model)
    return <span class="hljs-built_in">agent</span>(<span class="hljs-string">"Hi, where can I eat in San Francisco?"</span>)


with mlflow.<span class="hljs-built_in">start_run</span>(run_name=<span class="hljs-string">"StrandsAgentRun"</span>):
    results = <span class="hljs-built_in">run_agent</span>()
</code></pre>
<p>这些能力通过捕获工作负载服务、节点和工具执行的详细信息，为您的 AI 工作负载提供可观测性。可以在MLFlow Tracking Server 前端的 Trace 选项卡中，查看这些完整记录的执行信息。见如下示例：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b51ab0e027547928564a26b08ae7667~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763600074&amp;x-signature=VPlx%2BLmfWFUZfI5G6E3sOcDl%2BjE%3D" alt="图3.png" loading="lazy"/></p>
<p align="center">图3. MLFlow trace页面</p>
<p>同时，对于使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fbedrock%2Fagentcore%2F" target="_blank" title="https://aws.amazon.com/cn/bedrock/agentcore/" ref="nofollow noopener noreferrer">Bedrock AgentCore</a> 执行环境的Agents工作流来说，可以直接利用其集成至CloudWatch中的 GenAI Observability能力，直接获取整个Agent调用链的轨迹信息。见以下基于 AgentCore 进行 Strands Agents 搭建的调试示例。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a73681984544ba5bac8afcd89ad0849~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763600074&amp;x-signature=2rS53NEdOGMZX0pb6eH5yAqZ764%3D" alt="图4.png" loading="lazy"/></p>
<p align="center">图4. CloudWatch GenAI Observability页面</p>
<p>除了MLFlow之外，也可使用其他可观测性平台，例如Langfuse是一个专为LLM应用设计的开源可观测性平台，提供了完整的追踪、评估和分析能力。它支持多种LLM框架的集成，能够自动捕获Agent的执行轨迹、token使用情况和成本信息，并通过直观的Web界面展示这些数据，帮助开发者快速识别性能瓶颈和优化机会。</p>
<h2 data-id="heading-12">四. 利用可观测性组件运维 Agent</h2>
<p>此部分将以基于 Strands Agent 构建的电商售后智能客服为例，展示如何在应用开发和生产迭代的过程中遇到的多个场景使用可观测性组件进行运维。</p>
<p>示例环境可根据 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcatalog.us-east-1.prod.workshops.aws%2Fworkshops%2F93a2eb2c-7f00-463a-92f1-ab0e6e81f48b%2Fzh-CN" target="_blank" title="https://catalog.us-east-1.prod.workshops.aws/workshops/93a2eb2c-7f00-463a-92f1-ab0e6e81f48b/zh-CN" ref="nofollow noopener noreferrer">workshop</a> 进行创建，创建资源包括一个含有订单数据表格并通过 api gateway 对外暴露的电商系统，和一个通过网页交互的电商售后智能客服应用，智能客服 Agent 应用通过添加多个 MCP servers，其中包括调用电商系统的 API Gateway 接口的工具，来实现对电商系统中的订单进行查询并按照售后流程定义规则进行处理的功能。以下为智能客服的页面截图，支持添加丰富的 MCP servers, 选择不同的 LLM 模型。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21e0ca1f124d4f2f9a92f6076e37b75c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763600074&amp;x-signature=xAzPU7jBWvjDMWOuDIkD47Dxtjs%3D" alt="图5.png" loading="lazy"/></p>
<p align="center">图5.  Agent应用客户端界面</p>
<p>以上应用在开发阶段会在前端页面显示所有的模型和工具调用信息，在实际生产环境中基于数据安全应该在前端隐去。此时则可以将 Agent 的追踪数据打入到 Langfuse 平台进行监控，来保证重要指标的收集和功能异常的分析。</p>
<ol>
<li>模拟新模型发布，针对不同的 LLM 模型进行效果和成本对比测试</li>
</ol>
<p>使用两个不同的 user 对相同的问题进行测试，在 Langfuse 中观察到不同的 Latency, Token 和 Cost , 可以观察到 Claude 3.7 和 Nova Lite 分析过程和对工具的调用次数上一致，Claude 3.7 在成本上更有优势，而 Nova Lite 则在成本上更有优势。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2162c1e1c81c448b96e7715c9a89a501~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763600074&amp;x-signature=F64Y0Pe7aERI%2FEN%2BVuBITs0FQkk%3D" alt="图6.webp" loading="lazy"/></p>
<p align="center">图6. 使用Langfuse对模型分析对比</p>
<ol start="2">
<li>模拟模型混用、网关智能路由的场景</li>
</ol>
<p>假设基于测试结果，团队希望使用 Nova Lite 为主要模型，Claude 3.7 为备用模型 ，对话过程中交替切换 LLM 来进行充分测试，发现出现错误。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a11241ce6763454fa99ee6f16d879234~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763600074&amp;x-signature=CrDO4rHdVe19DovBpxUpR0RfBzA%3D" alt="图7.webp" loading="lazy"/></p>
<p align="center">图7. Agent客户端错误示例</p>
<p>从 Langfuse 页面可以快速定位到历史对话采用 Claude 3.7 模型和当前切换的 Nova Lite 模型的信息格式不一致导致调用出错。基于此类的追踪分析，可以针对性的快速解决开发迭代和生产中遇到的问题。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98ff6c8a19074ec4b00dda733680e549~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763600074&amp;x-signature=Z%2FJcrir7ZDifFnIj38EptyOxpWU%3D" alt="图8.png" loading="lazy"/></p>
<p align="center">图8. 使用Langfuse分析错误日志</p>
<ol start="3">
<li>模拟新功能上线，分析功能调用全流程</li>
</ol>
<p>售后客服扩展功能为不同卖家提供数据查询功能，应用后端通过 Mysql MCP server 接入电商系统数据库。以数据查询“查询今年销售额最高的3个客户”为例，虽然两种模型都可以完成查询，通过调用流程可以看到 Claude 3.7 对数据查询语句的生成思考更严谨，更适合用在数据分析的场景。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f279e31f60064320933db1599612c1d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763600074&amp;x-signature=kqk92sAo4Yx41lHcJDI6pfDC148%3D" alt="图9.png" loading="lazy"/></p>
<p align="center">图9.  使用Langfuse分析调用全流程</p>
<h2 data-id="heading-13">五. 结语</h2>
<p>随着 AI Agent 在企业应用中扮演越来越重要的角色，建立完善的可观测性体系已成为确保其可靠运行的关键基础设施。本文探讨了 Agent 可观测性的核心要素、实现方式和最佳实践，为开发团队提供了一个实用的参考框架，详细介绍了亚马逊云科技生态系统为 Agent 可观测性提供的完整解决方案。通过 CloudWatch GenAI Observability 和 Bedrock AgentCore Observability，团队可以快速获得对 Agent 系统的全面洞察，无需复杂的基础设施搭建。这些服务与 OpenTelemetry 的深度集成，不仅确保了与开源生态的互操作性，更为后续的分析和优化提供了坚实基础。</p>
<p>我们建议您从访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fconsole.aws.amazon.com%2Fbedrock" target="_blank" title="https://console.aws.amazon.com/bedrock" ref="nofollow noopener noreferrer">Amazon Bedrock</a> 控制台开始，体验 CloudWatch GenAI Observability 的监控能力，并参考本文提供的<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fawslabs%2Famazon-bedrock-agentcore-samples%2Ftree%2Fmain%2F01-tutorials%2F06-AgentCore-observability" target="_blank" title="https://github.com/awslabs/amazon-bedrock-agentcore-samples/tree/main/01-tutorials/06-AgentCore-observability" ref="nofollow noopener noreferrer">Agent Observability 示例代码</a>将 Agent 应用接入这些服务。在 Amazon Sample 仓库中还有<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Faws-samples%2Fsample-agentic-platform" target="_blank" title="https://github.com/aws-samples/sample-agentic-platform" ref="nofollow noopener noreferrer">更多资源</a>供您参考。</p>
<p>随着AI Agent在企业应用中的广泛部署，可观测性已经从”锦上添花”的辅助工具转变为”不可或缺”的核心能力。传统的监控方式虽然能够告诉我们系统的运行状态，但面对Agent的复杂决策链条和多步推理过程，我们需要更深层次的洞察能力。</p>
<p>通过本文介绍的多维度可观测性框架，我们不仅能够监控Agent的性能指标和资源消耗，更重要的是能够理解Agent的”思考过程”——从意图理解到工具调用，从推理链条到最终输出的完整决策轨迹。亚马逊云科技提供的CloudWatch GenAI Observability和Bedrock AgentCore等托管服务，结合开源生态中的MLFlow、Langfuse等工具，为企业构建Agent可观测性提供了完整的技术栈支持。无论是选择全托管的便捷方案，还是基于开源工具的灵活定制，企业都能找到适合自身需求的实施路径。</p>
<p>在AI Agent成为企业数字化转型重要推动力的今天，建立完善的可观测性体系不仅是技术需要，更是业务成功的关键保障。只有真正”看见”和”理解”Agent的行为，我们才能充分释放其潜力，让AI真正成为企业的智能助手和效率倍增器。</p>
<p><strong>本篇作者</strong>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/022e3d1c2df74dc08f75e3fcdb676ce9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763600074&amp;x-signature=tmM3VmOSugf9bVaUOpipETRU%2B0E%3D" alt="作者.webp" loading="lazy"/>
关于<strong>Agentic AI</strong>基础设施的更多实践经验参考，欢迎点击：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fblogs%2Fchina%2Fagentive-ai-infrastructure-practice-series-1" target="_blank" title="https://aws.amazon.com/cn/blogs/china/agentive-ai-infrastructure-practice-series-1" ref="nofollow noopener noreferrer">Agentic AI基础设施实践经验系列（一）：Agent应用开发与落地实践思考</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fblogs%2Fchina%2Fagentic-ai-sandbox-practice%2F" target="_blank" title="https://aws.amazon.com/cn/blogs/china/agentic-ai-sandbox-practice/" ref="nofollow noopener noreferrer">Agentic AI基础设施实践经验系列（二）：专用沙盒环境的必要性与实践方案</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fblogs%2Fchina%2Fagentic-ai-infrastructure-deep-practice-experience-thinking-series-three-best-practices-for-agent-memory-module" target="_blank" title="https://aws.amazon.com/cn/blogs/china/agentic-ai-infrastructure-deep-practice-experience-thinking-series-three-best-practices-for-agent-memory-module" ref="nofollow noopener noreferrer">Agentic AI基础设施实践经验系列（三）：Agent记忆模块的最佳实践</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fblogs%2Fchina%2Fagentic-ai-infrastructure-practice-experience-series-four-mcp-server-from-local" target="_blank" title="https://aws.amazon.com/cn/blogs/china/agentic-ai-infrastructure-practice-experience-series-four-mcp-server-from-local" ref="nofollow noopener noreferrer">Agentic AI基础设施实践经验系列（四）：MCP服务器从本地到云端的部署演进</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fblogs%2Fchina%2Fagentic-ai-infrastructure-practice-series-5%2F" target="_blank" title="https://aws.amazon.com/cn/blogs/china/agentic-ai-infrastructure-practice-series-5/" ref="nofollow noopener noreferrer">Agentic AI基础设施实践经验系列（五）：Agent应用系统中的身份认证与授权管理</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fblogs%2Fchina%2Fagent-quality-evaluation%2F" target="_blank" title="https://aws.amazon.com/cn/blogs/china/agent-quality-evaluation/" ref="nofollow noopener noreferrer">Agentic AI基础设施实践经验系列（六）：Agent质量评估</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fblogs%2Fchina%2Fagentic-ai-infrastructure-practice-series-7%2F" target="_blank" title="https://aws.amazon.com/cn/blogs/china/agentic-ai-infrastructure-practice-series-7/" ref="nofollow noopener noreferrer">Agentic AI基础设施实践经验系列（七）：可观测性在Agent应用的挑战与实践</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fblogs%2Fchina%2Fprivacy-and-security-of-agent-applications" target="_blank" title="https://aws.amazon.com/cn/blogs/china/privacy-and-security-of-agent-applications" ref="nofollow noopener noreferrer">Agentic AI基础设施实践经验系列（八）：Agent应用的隐私和安全</a></p>
<p>*前述特定亚马逊云科技生成式人工智能相关的服务目前在亚马逊云科技海外区域可用。亚马逊云科技中国区域相关云服务由西云数据和光环新网运营，具体信息以中国区域官网为准。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis（120）Redis的常见错误如何处理？]]></title>    <link>https://juejin.cn/post/7571672422689636404</link>    <guid>https://juejin.cn/post/7571672422689636404</guid>    <pubDate>2025-11-12T23:12:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571672422689636404" data-draft-id="7571655979256774696" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis（120）Redis的常见错误如何处理？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-12T23:12:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis（120）Redis的常见错误如何处理？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T23:12:42.000Z" title="Wed Nov 12 2025 23:12:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Redis 作为一个高性能的内存数据库和缓存系统，在使用过程中难免会遇到各种错误和异常。以下是一些常见的 Redis 错误及其处理方法，结合代码示例进行详细讲解。</p>
<h3 data-id="heading-0">1. 连接错误</h3>
<h4 data-id="heading-1">问题描述</h4>
<p>当无法连接到 Redis 服务器时，可能会出现连接错误。这通常是由于 Redis 服务器未启动、网络问题或连接配置错误引起的。</p>
<h4 data-id="heading-2">解决方法</h4>
<ul>
<li>确保 Redis 服务器已启动并监听正确的端口。</li>
<li>检查网络连接。</li>
<li>确认客户端配置正确。</li>
</ul>
<h4 data-id="heading-3">示例代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;
<span class="hljs-keyword">import</span> redis.clients.jedis.exceptions.JedisConnectionException;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisConnectionExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            jedis.ping();
            System.out.println(<span class="hljs-string">"Connected to Redis"</span>);
        } <span class="hljs-keyword">catch</span> (JedisConnectionException e) {
            System.err.println(<span class="hljs-string">"Cannot connect to Redis: "</span> + e.getMessage());
            <span class="hljs-comment">// 尝试重新连接或其他处理逻辑</span>
        }
    }
}
</code></pre>
<h3 data-id="heading-4">2. 认证错误</h3>
<h4 data-id="heading-5">问题描述</h4>
<p>如果 Redis 服务器配置了密码保护，客户端在未提供正确密码的情况下尝试进行操作，会出现认证错误。</p>
<h4 data-id="heading-6">解决方法</h4>
<ul>
<li>确认客户端提供的密码正确。</li>
<li>检查 Redis 服务器的 <code>requirepass</code> 配置项。</li>
</ul>
<h4 data-id="heading-7">示例代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;
<span class="hljs-keyword">import</span> redis.clients.jedis.exceptions.JedisDataException;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisAuthExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            jedis.auth(<span class="hljs-string">"your_password_here"</span>);
            jedis.set(<span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>);
            <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> jedis.get(<span class="hljs-string">"key"</span>);
            System.out.println(<span class="hljs-string">"key: "</span> + value);
        } <span class="hljs-keyword">catch</span> (JedisDataException e) {
            <span class="hljs-keyword">if</span> (e.getMessage().contains(<span class="hljs-string">"NOAUTH"</span>)) {
                System.err.println(<span class="hljs-string">"Authentication failed: "</span> + e.getMessage());
            } <span class="hljs-keyword">else</span> {
                System.err.println(<span class="hljs-string">"Data error: "</span> + e.getMessage());
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-8">3. 内存不足错误</h3>
<h4 data-id="heading-9">问题描述</h4>
<p>当 Redis 达到配置的最大内存限制时，可能会出现内存不足错误。这通常是由于内存占用过多、缓存策略不当或数据量过大引起的。</p>
<h4 data-id="heading-10">解决方法</h4>
<ul>
<li>配置合理的 <code>maxmemory</code> 和缓存淘汰策略。</li>
<li>清理不必要的数据。</li>
<li>考虑水平扩展 Redis 集群。</li>
</ul>
<h4 data-id="heading-11">示例代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;
<span class="hljs-keyword">import</span> redis.clients.jedis.exceptions.JedisDataException;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisMemoryExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-comment">// 设置最大内存为 100MB</span>
            jedis.configSet(<span class="hljs-string">"maxmemory"</span>, <span class="hljs-string">"100mb"</span>);
            jedis.configSet(<span class="hljs-string">"maxmemory-policy"</span>, <span class="hljs-string">"allkeys-lru"</span>);

            <span class="hljs-comment">// 填充数据以模拟内存不足</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++) {
                jedis.set(<span class="hljs-string">"key"</span> + i, <span class="hljs-string">"value"</span> + i);
            }
        } <span class="hljs-keyword">catch</span> (JedisDataException e) {
            <span class="hljs-keyword">if</span> (e.getMessage().contains(<span class="hljs-string">"OOM"</span>)) {
                System.err.println(<span class="hljs-string">"Out of memory: "</span> + e.getMessage());
            } <span class="hljs-keyword">else</span> {
                System.err.println(<span class="hljs-string">"Data error: "</span> + e.getMessage());
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-12">4. 命令错误</h3>
<h4 data-id="heading-13">问题描述</h4>
<p>当客户端发送了无效或语法错误的命令时，Redis 会返回命令错误。</p>
<h4 data-id="heading-14">解决方法</h4>
<ul>
<li>确认命令的语法和参数正确。</li>
<li>检查命令是否被重命名或禁用。</li>
</ul>
<h4 data-id="heading-15">示例代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;
<span class="hljs-keyword">import</span> redis.clients.jedis.exceptions.JedisDataException;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisCommandExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-comment">// 尝试执行无效命令</span>
            jedis.sendCommand(() -&gt; <span class="hljs-string">"INVALIDCOMMAND"</span>);
        } <span class="hljs-keyword">catch</span> (JedisDataException e) {
            System.err.println(<span class="hljs-string">"Command error: "</span> + e.getMessage());
        }
    }
}
</code></pre>
<h3 data-id="heading-16">5. 阻塞操作错误</h3>
<h4 data-id="heading-17">问题描述</h4>
<p>一些 Redis 操作（如 <code>BLPOP</code>、<code>BRPOP</code> 等）可能会导致阻塞，从而引起客户端超时或其他问题。</p>
<h4 data-id="heading-18">解决方法</h4>
<ul>
<li>确认使用阻塞操作的场景合理。</li>
<li>设置合理的超时时间。</li>
<li>考虑使用非阻塞操作替代。</li>
</ul>
<h4 data-id="heading-19">示例代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;
<span class="hljs-keyword">import</span> redis.clients.jedis.exceptions.JedisConnectionException;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisBlockingExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            jedis.lpush(<span class="hljs-string">"mylist"</span>, <span class="hljs-string">"item1"</span>);
            jedis.lpush(<span class="hljs-string">"mylist"</span>, <span class="hljs-string">"item2"</span>);

            <span class="hljs-comment">// 尝试阻塞获取元素，超时为 5 秒</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> jedis.blpop(<span class="hljs-number">5</span>, <span class="hljs-string">"mylist"</span>).get(<span class="hljs-number">1</span>);
            System.out.println(<span class="hljs-string">"Popped item: "</span> + result);
        } <span class="hljs-keyword">catch</span> (JedisConnectionException e) {
            System.err.println(<span class="hljs-string">"Blocking operation failed: "</span> + e.getMessage());
        }
    }
}
</code></pre>
<h3 data-id="heading-20">6. 持久化错误</h3>
<h4 data-id="heading-21">问题描述</h4>
<p>Redis 提供 RDB 和 AOF 两种持久化机制，可能会出现持久化失败或数据恢复错误。</p>
<h4 data-id="heading-22">解决方法</h4>
<ul>
<li>检查持久化配置是否正确。</li>
<li>确认磁盘空间充足。</li>
<li>定期备份数据并验证恢复流程。</li>
</ul>
<h4 data-id="heading-23">示例代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;
<span class="hljs-keyword">import</span> redis.clients.jedis.exceptions.JedisDataException;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisPersistenceExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-comment">// 手动触发 RDB 持久化</span>
            jedis.save();
            System.out.println(<span class="hljs-string">"RDB persistence triggered."</span>);

            <span class="hljs-comment">// 手动触发 AOF 持久化</span>
            jedis.bgrewriteaof();
            System.out.println(<span class="hljs-string">"AOF persistence triggered."</span>);
        } <span class="hljs-keyword">catch</span> (JedisDataException e) {
            System.err.println(<span class="hljs-string">"Persistence error: "</span> + e.getMessage());
        }
    }
}
</code></pre>
<h3 data-id="heading-24">总结</h3>
<p>通过上述示例代码，可以帮助你更好地理解和处理 Redis 的常见错误。合理地配置和使用 Redis，可以有效地提高系统的稳定性和性能。此外，监控和日志记录也是确保 Redis 正常运行的重要手段。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis（121）Redis的数据恢复如何进行？]]></title>    <link>https://juejin.cn/post/7571655979256791080</link>    <guid>https://juejin.cn/post/7571655979256791080</guid>    <pubDate>2025-11-12T23:13:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571655979256791080" data-draft-id="7571650164844412962" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis（121）Redis的数据恢复如何进行？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-12T23:13:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis（121）Redis的数据恢复如何进行？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T23:13:22.000Z" title="Wed Nov 12 2025 23:13:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Redis 提供了多种数据持久化机制，包括 RDB 和 AOF，以便在服务器重启或故障时恢复数据。以下是 Redis 数据恢复的详细介绍及代码示例。</p>
<h3 data-id="heading-0">1. 使用 RDB 文件恢复数据</h3>
<p>RDB（Redis DataBase）是 Redis 快照持久化机制，它会在指定的时间间隔内生成数据库的二进制快照文件（即 <code>.rdb</code> 文件）。当 Redis 服务器重启时，可以通过加载 RDB 文件恢复数据。</p>
<h4 data-id="heading-1">配置 RDB</h4>
<p>在 <code>redis.conf</code> 文件中配置 RDB 相关选项：</p>
<pre><code class="hljs language-conf" lang="conf"># 配置在 900 秒（15 分钟）内如果至少有 1 次写操作，则进行一次快照
save 900 1
# 配置在 300 秒（5 分钟）内如果至少有 10 次写操作，则进行一次快照
save 300 10
# 配置在 60 秒（1 分钟）内如果至少有 10000 次写操作，则进行一次快照
save 60 10000

# RDB 文件的存储路径
dir /var/lib/redis

# RDB 文件名称
dbfilename dump.rdb
</code></pre>
<h4 data-id="heading-2">恢复 RDB 数据</h4>
<p>当 Redis 服务器重启时，它会自动加载 <code>dump.rdb</code> 文件恢复数据。以下是一个简单的代码示例，展示如何手动触发 RDB 快照并恢复数据：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisRDBExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-comment">// 手动触发 RDB 快照</span>
            jedis.save();
            System.out.println(<span class="hljs-string">"RDB snapshot created."</span>);

            <span class="hljs-comment">// 模拟重启：停止和重新启动 Redis 服务器</span>
            <span class="hljs-comment">// 将自动加载 dump.rdb 文件恢复数据</span>
            <span class="hljs-comment">// 这里假设 Redis 服务恢复后，客户端重新连接</span>

            <span class="hljs-comment">// 验证数据是否恢复</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> jedis.get(<span class="hljs-string">"your_key"</span>);
            System.out.println(<span class="hljs-string">"Recovered value: "</span> + value);
        }
    }
}
</code></pre>
<h3 data-id="heading-3">2. 使用 AOF 文件恢复数据</h3>
<p>AOF（Append-Only File）是 Redis 另一种持久化机制，它会记录每一个写操作，并以追加的方式写入日志文件。相比于 RDB，AOF 提供了更高的数据恢复精度。</p>
<h4 data-id="heading-4">配置 AOF</h4>
<p>在 <code>redis.conf</code> 文件中配置 AOF 相关选项：</p>
<pre><code class="hljs language-conf" lang="conf"># 启用 AOF 持久化
appendonly yes

# AOF 文件名称
appendfilename "appendonly.aof"

# AOF 刷新策略，默认为 everysec
# appendfsync always  - 每次写操作都会触发 fsync，最安全但性能最低
# appendfsync everysec  - 每秒执行一次 fsync，平衡安全和性能
# appendfsync no  - 由操作系统决定何时写入磁盘，性能最高但最不安全
appendfsync everysec

# AOF 重写配置，防止 AOF 文件过大
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
</code></pre>
<h4 data-id="heading-5">恢复 AOF 数据</h4>
<p>Redis 服务器重启时，会自动加载 <code>appendonly.aof</code> 文件恢复数据。以下是一个简单的代码示例，展示如何手动触发 AOF 重写并恢复数据：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisAOFExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-comment">// 手动触发 AOF 重写</span>
            jedis.bgrewriteaof();
            System.out.println(<span class="hljs-string">"AOF rewrite triggered."</span>);

            <span class="hljs-comment">// 模拟重启：停止和重新启动 Redis 服务器</span>
            <span class="hljs-comment">// 将自动加载 appendonly.aof 文件恢复数据</span>
            <span class="hljs-comment">// 这里假设 Redis 服务恢复后，客户端重新连接</span>

            <span class="hljs-comment">// 验证数据是否恢复</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> jedis.get(<span class="hljs-string">"your_key"</span>);
            System.out.println(<span class="hljs-string">"Recovered value: "</span> + value);
        }
    }
}
</code></pre>
<h3 data-id="heading-6">3. RDB 和 AOF 结合使用</h3>
<p>Redis 允许同时启用 RDB 和 AOF 持久化，以便在系统重启时选择最适合的数据恢复方式。通常，Redis 会优先使用 AOF 文件恢复数据，因为 AOF 提供了更高的数据恢复精度。</p>
<h4 data-id="heading-7">配置 RDB 和 AOF</h4>
<p>在 <code>redis.conf</code> 文件中同时配置 RDB 和 AOF 相关选项：</p>
<pre><code class="hljs language-conf" lang="conf"># RDB 配置
save 900 1
save 300 10
save 60 10000
dir /var/lib/redis
dbfilename dump.rdb

# AOF 配置
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
</code></pre>
<h3 data-id="heading-8">4. 数据备份与恢复</h3>
<p>除了 RDB 和 AOF 持久化，定期备份数据是确保数据安全的另一种有效方法。可以通过复制 RDB 和 AOF 文件进行备份和恢复。</p>
<h4 data-id="heading-9">数据备份</h4>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># 复制 RDB 文件进行备份</span>
<span class="hljs-built_in">cp</span> /var/lib/redis/dump.rdb /backup/dump.rdb

<span class="hljs-comment"># 复制 AOF 文件进行备份</span>
<span class="hljs-built_in">cp</span> /var/lib/redis/appendonly.aof /backup/appendonly.aof
</code></pre>
<h4 data-id="heading-10">数据恢复</h4>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># 停止 Redis 服务</span>
sudo systemctl stop redis

<span class="hljs-comment"># 恢复 RDB 文件</span>
<span class="hljs-built_in">cp</span> /backup/dump.rdb /var/lib/redis/dump.rdb

<span class="hljs-comment"># 恢复 AOF 文件</span>
<span class="hljs-built_in">cp</span> /backup/appendonly.aof /var/lib/redis/appendonly.aof

<span class="hljs-comment"># 启动 Redis 服务</span>
sudo systemctl start redis
</code></pre>
<h3 data-id="heading-11">5. 使用 Redis Cluster 恢复数据</h3>
<p>在 Redis Cluster 中，数据分布在多个节点上。恢复集群中的数据需要分别恢复每个节点的数据。以下是一个简单的示例：</p>
<h4 data-id="heading-12">配置 Redis Cluster 持久化</h4>
<p>在每个节点的 <code>redis.conf</code> 文件中配置 RDB 和 AOF：</p>
<pre><code class="hljs language-conf" lang="conf"># RDB 配置
save 900 1
save 300 10
save 60 10000
dir /var/lib/redis
dbfilename dump.rdb

# AOF 配置
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
</code></pre>
<h4 data-id="heading-13">恢复 Redis Cluster 数据</h4>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># 停止 Redis Cluster 节点</span>
sudo systemctl stop redis-node1
sudo systemctl stop redis-node2
<span class="hljs-comment"># ...</span>

<span class="hljs-comment"># 恢复 RDB 和 AOF 文件</span>
<span class="hljs-built_in">cp</span> /backup/dump-node1.rdb /var/lib/redis-node1/dump.rdb
<span class="hljs-built_in">cp</span> /backup/appendonly-node1.aof /var/lib/redis-node1/appendonly.aof
<span class="hljs-built_in">cp</span> /backup/dump-node2.rdb /var/lib/redis-node2/dump.rdb
<span class="hljs-built_in">cp</span> /backup/appendonly-node2.aof /var/lib/redis-node2/appendonly.aof
<span class="hljs-comment"># ...</span>

<span class="hljs-comment"># 启动 Redis Cluster 节点</span>
sudo systemctl start redis-node1
sudo systemctl start redis-node2
<span class="hljs-comment"># ...</span>
</code></pre>
<h3 data-id="heading-14">总结</h3>
<p>Redis 提供了多种数据持久化和恢复机制，包括 RDB、AOF 以及定期备份和恢复。通过合理配置和管理这些机制，可以确保 Redis 数据的高可用性和可靠性。上述代码示例展示了如何手动触发持久化操作、配置持久化选项以及执行数据备份和恢复操作。结合具体的业务需求，可以进一步优化和定制 Redis 的数据恢复策略。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再只会用默认插槽了！Vue插槽这些高级用法让你的组件更强大]]></title>    <link>https://juejin.cn/post/7571646669202538538</link>    <guid>https://juejin.cn/post/7571646669202538538</guid>    <pubDate>2025-11-12T23:25:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571646669202538538" data-draft-id="7571646669202522154" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再只会用默认插槽了！Vue插槽这些高级用法让你的组件更强大"/> <meta itemprop="keywords" content="Vue.js,JavaScript,前端"/> <meta itemprop="datePublished" content="2025-11-12T23:25:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="良山有风来"/> <meta itemprop="url" content="https://juejin.cn/user/3940246036939358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再只会用默认插槽了！Vue插槽这些高级用法让你的组件更强大
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3940246036939358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    良山有风来
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T23:25:52.000Z" title="Wed Nov 12 2025 23:25:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你是不是经常遇到这样的情况：写了一个通用组件，却发现有些地方需要微调样式，有些地方需要替换部分内容，但又不想为了这点小改动就写一个新的组件？</p>
<p>如果你还在用默认插槽来解决所有问题，那真的有点out了。今天我要分享的Vue插槽高级用法，能让你的组件灵活度提升好几个level！</p>
<p>读完这篇文章，你会彻底搞懂作用域插槽和具名插槽的实战技巧，让你的组件像乐高一样可以随意组合，再也不用担心产品经理那些“稍微改一下”的需求了。</p>
<h2 data-id="heading-0">从基础开始：插槽到底是什么？</h2>
<p>先来个简单的回忆。插槽就是Vue组件里的一个占位符，让使用组件的时候可以往里面塞自定义内容。</p>
<p>看个最简单的例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义一个带插槽的组件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">MyComponent</span> = {
  <span class="hljs-attr">template</span>: <span class="hljs-string">`
    &lt;div class="container"&gt;
      &lt;h2&gt;我是组件标题&lt;/h2&gt;
      &lt;slot&gt;&lt;/slot&gt;
    &lt;/div&gt;
  `</span>
}

<span class="hljs-comment">// 使用这个组件</span>
&lt;my-component&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这里的内容会显示在slot的位置<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
&lt;/my-component&gt;
</code></pre>
<p>这个就是最基本的默认插槽。但现实开发中，我们经常遇到更复杂的需求，这时候就需要更高级的玩法了。</p>
<h2 data-id="heading-1">具名插槽：多个插槽怎么管理？</h2>
<p>想象一下，你要做一个卡片组件，这个卡片有头部、主体、底部三个部分，每个部分都需要自定义内容。如果还用默认插槽，代码就会变得很混乱。</p>
<p>这时候具名插槽就派上用场了：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 卡片组件定义</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">CardComponent</span> = {
  <span class="hljs-attr">template</span>: <span class="hljs-string">`
    &lt;div class="card"&gt;
      &lt;div class="card-header"&gt;
        &lt;slot name="header"&gt;&lt;/slot&gt;
      &lt;/div&gt;
      &lt;div class="card-body"&gt;
        &lt;slot name="body"&gt;&lt;/slot&gt;
      &lt;/div&gt;
      &lt;div class="card-footer"&gt;
        &lt;slot name="footer"&gt;&lt;/slot&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  `</span>
}
</code></pre>
<p>使用的时候，我们可以这样给不同的插槽传递内容：</p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;card-component&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-slot:header</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>这是卡片标题<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
  
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-slot:body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是卡片的主体内容，可以放任何你想放的东西<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>点击我<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
  
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-slot:footer</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>底部信息<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>链接<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
&lt;/card-component&gt;
</code></pre>
<p>看到没？每个部分都清晰明了，再也不用在默认插槽里堆砌一堆div还要用CSS来控制布局了。</p>
<p>这里有个小技巧，v-slot:header可以简写成#header，写起来更简洁：</p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;card-component&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">header</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>简洁写法<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
&lt;/card-component&gt;
</code></pre>
<h2 data-id="heading-2">作用域插槽：让插槽内容访问组件数据</h2>
<p>这才是今天的大招！作用域插槽允许插槽内容访问子组件中的数据，这让组件的灵活性达到了新的高度。</p>
<p>举个实际例子：我们要做一个数据列表组件，但希望使用组件的人可以自定义每行怎么显示。</p>
<p>先看传统的做法有什么问题：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 传统做法 - 灵活性很差</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">DataList</span> = {
  <span class="hljs-attr">props</span>: [<span class="hljs-string">'items'</span>],
  <span class="hljs-attr">template</span>: <span class="hljs-string">`
    &lt;ul&gt;
      &lt;li v-for="item in items" :key="item.id"&gt;
        {{ item.name }} - {{ item.price }}
      &lt;/li&gt;
    &lt;/ul&gt;
  `</span>
}
</code></pre>
<p>这样写死的话，如果其他地方需要显示不同的字段，就得重新写一个组件。太麻烦了！</p>
<p>现在看作用域插槽的解决方案：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用作用域插槽的灵活版本</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">FlexibleList</span> = {
  <span class="hljs-attr">props</span>: [<span class="hljs-string">'items'</span>],
  <span class="hljs-attr">template</span>: <span class="hljs-string">`
    &lt;ul&gt;
      &lt;li v-for="item in items" :key="item.id"&gt;
        &lt;slot :item="item"&gt;&lt;/slot&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  `</span>
}
</code></pre>
<p>使用的时候，我们可以这样自定义每行的显示：</p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;flexible-list :items=<span class="hljs-string">"productList"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-slot</span>=<span class="hljs-string">"slotProps"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"product-item"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>{{ slotProps.item.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"price"</span>&gt;</span>¥{{ slotProps.item.price }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"addToCart(slotProps.item)"</span>&gt;</span>加入购物车<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
&lt;/flexible-list&gt;
</code></pre>
<p>这里的关键在于，我们在slot上绑定了item数据，然后在父组件中通过slotProps来接收这些数据。这样，使用组件的人就可以完全控制怎么显示每个item了。</p>
<h2 data-id="heading-3">实战进阶：作用域插槽 + 具名插槽组合使用</h2>
<p>真正强大的时候是当作用域插槽和具名插槽结合使用的时候。我们来看一个更复杂的例子：一个完整的数据表格组件。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 高级表格组件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">AdvancedTable</span> = {
  <span class="hljs-attr">props</span>: [<span class="hljs-string">'data'</span>, <span class="hljs-string">'columns'</span>],
  <span class="hljs-attr">template</span>: <span class="hljs-string">`
    &lt;div class="table-wrapper"&gt;
      &lt;table&gt;
        &lt;!-- 表头部分 --&gt;
        &lt;thead&gt;
          &lt;tr&gt;
            &lt;th v-for="col in columns" :key="col.key"&gt;
              &lt;slot name="header" :column="col"&gt;
                {{ col.title }}
              &lt;/slot&gt;
            &lt;/th&gt;
          &lt;/tr&gt;
        &lt;/thead&gt;
        
        &lt;!-- 表格主体 --&gt;
        &lt;tbody&gt;
          &lt;tr v-for="(row, index) in data" :key="row.id"&gt;
            &lt;td v-for="col in columns" :key="col.key"&gt;
              &lt;slot 
                name="cell" 
                :row="row" 
                :column="col"
                :index="index"
              &gt;
                {{ row[col.key] }}
              &lt;/slot&gt;
            &lt;/td&gt;
          &lt;/tr&gt;
        &lt;/tbody&gt;
        
        &lt;!-- 表格底部 --&gt;
        &lt;tfoot&gt;
          &lt;slot name="footer" :data="data"&gt;&lt;/slot&gt;
        &lt;/tfoot&gt;
      &lt;/table&gt;
    &lt;/div&gt;
  `</span>
}
</code></pre>
<p>这个组件提供了极大的灵活性：</p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;advanced-table 
  :data=<span class="hljs-string">"userList"</span> 
  :columns=<span class="hljs-string">"tableColumns"</span>
&gt;
  &lt;!-- 自定义表头 --&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">header</span>=<span class="hljs-string">"slotProps"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"custom-header"</span>&gt;</span>
      {{ slotProps.column.title }}
      <span class="hljs-tag">&lt;<span class="hljs-name">i</span> 
        <span class="hljs-attr">v-if</span>=<span class="hljs-string">"slotProps.column.sortable"</span> 
        <span class="hljs-attr">class</span>=<span class="hljs-string">"sort-icon"</span>
        @<span class="hljs-attr">click</span>=<span class="hljs-string">"sortTable(slotProps.column)"</span>
      &gt;</span>↑↓<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
  
  &lt;!-- 自定义单元格 --&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">cell</span>=<span class="hljs-string">"slotProps"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"slotProps.column.key === 'avatar'"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">img</span> 
        <span class="hljs-attr">:src</span>=<span class="hljs-string">"slotProps.row.avatar"</span> 
        <span class="hljs-attr">:alt</span>=<span class="hljs-string">"slotProps.row.name"</span>
        <span class="hljs-attr">class</span>=<span class="hljs-string">"avatar"</span>
      &gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else-if</span>=<span class="hljs-string">"slotProps.column.key === 'status'"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> 
        <span class="hljs-attr">:class</span>=<span class="hljs-string">"`status-badge status-${slotProps.row.status}`"</span>
      &gt;</span>
        {{ getStatusText(slotProps.row.status) }}
      <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else</span>&gt;</span>
      {{ slotProps.row[slotProps.column.key] }}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
  
  <span class="hljs-comment">&lt;!-- 自定义底部 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">footer</span>=<span class="hljs-string">"slotProps"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">:colspan</span>=<span class="hljs-string">"tableColumns.length"</span>&gt;</span>
        共 {{ slotProps.data.length }} 条数据
      <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">advanced-table</span>&gt;</span></span>
</code></pre>
<p>这样的组件既保持了统一的表格功能，又给了使用者最大的自定义空间。</p>
<h2 data-id="heading-4">实际业务场景：配置化表单生成器</h2>
<p>我们再来看一个更贴近实际业务的例子。很多管理系统都需要动态表单，根据配置渲染不同的表单项。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 动态表单组件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">DynamicForm</span> = {
  <span class="hljs-attr">props</span>: [<span class="hljs-string">'fields'</span>, <span class="hljs-string">'formData'</span>],
  <span class="hljs-attr">template</span>: <span class="hljs-string">`
    &lt;form class="dynamic-form"&gt;
      &lt;div 
        v-for="field in fields" 
        :key="field.name"
        class="form-field"
      &gt;
        &lt;label&gt;{{ field.label }}&lt;/label&gt;
        
        &lt;slot 
          name="field" 
          :field="field" 
          :value="formData[field.name]"
          :onChange="(val) =&gt; $emit('update:formData', {
            ...formData,
            [field.name]: val
          })"
        &gt;
          &lt;!-- 默认的表单渲染 --&gt;
          &lt;input 
            v-if="field.type === 'text'"
            :type="field.type"
            :value="value"
            @input="onChange($event.target.value)"
            :placeholder="field.placeholder"
          &gt;
          
          &lt;select 
            v-else-if="field.type === 'select'"
            :value="value"
            @change="onChange($event.target.value)"
          &gt;
            &lt;option 
              v-for="option in field.options" 
              :key="option.value"
              :value="option.value"
            &gt;
              {{ option.label }}
            &lt;/option&gt;
          &lt;/select&gt;
        &lt;/slot&gt;
        
        &lt;!-- 错误信息插槽 --&gt;
        &lt;slot 
          name="error" 
          :field="field"
          :errors="fieldErrors[field.name]"
        &gt;
          &lt;div 
            v-if="fieldErrors[field.name]" 
            class="error-message"
          &gt;
            {{ fieldErrors[field.name] }}
          &lt;/div&gt;
        &lt;/slot&gt;
      &lt;/div&gt;
    &lt;/form&gt;
  `</span>
}
</code></pre>
<p>使用的时候，我们可以完全重写某个字段的渲染方式：</p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;dynamic-form 
  :fields=<span class="hljs-string">"formConfig"</span> 
  :form-data=<span class="hljs-string">"formData"</span>
  @<span class="hljs-attr">update</span>:form-data=<span class="hljs-string">"handleFormUpdate"</span>
&gt;
  &lt;!-- 自定义头像上传字段 --&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">field</span>=<span class="hljs-string">"slotProps"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"slotProps.field.name === 'avatar'"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">image-uploader</span>
        <span class="hljs-attr">:value</span>=<span class="hljs-string">"slotProps.value"</span>
        @<span class="hljs-attr">change</span>=<span class="hljs-string">"slotProps.onChange"</span>
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 其他字段使用默认渲染 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">slot</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
  
  &lt;!-- 自定义错误提示样式 --&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">error</span>=<span class="hljs-string">"slotProps"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> 
      <span class="hljs-attr">v-if</span>=<span class="hljs-string">"slotProps.errors"</span> 
      <span class="hljs-attr">class</span>=<span class="hljs-string">"my-custom-error"</span>
    &gt;</span>
      ❌ {{ slotProps.errors }}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
&lt;/dynamic-form&gt;
</code></pre>
<h2 data-id="heading-5">性能优化和最佳实践</h2>
<p>虽然作用域插槽很强大，但也要注意一些使用技巧：</p>
<ol>
<li>
<p><strong>避免不必要的重新渲染</strong></p>
<p>作用域插槽每次都会创建新的作用域，如果数据没变但组件重新渲染了，可能是作用域插槽导致的。</p>
</li>
<li>
<p><strong>合理使用默认内容</strong></p>
<p>给插槽提供合理的默认内容，让组件开箱即用：</p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;slot name=<span class="hljs-string">"empty"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"empty-state"</span>&gt;</span>
    暂无数据
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/slot&gt;
</code></pre>
</li>
<li>
<p><strong>使用解构让代码更清晰</strong></p>
<p>作用域插槽的参数可以使用解构，让模板更简洁：</p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;template #item=<span class="hljs-string">"{ id, name, price }"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{{ name }} - {{ price }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;
</code></pre>
</li>
</ol>
<h2 data-id="heading-6">总结</h2>
<p>Vue插槽的高级用法真的能让你的组件开发体验完全不同。具名插槽解决了多插槽管理的难题，作用域插槽则打破了父子组件的数据隔离，让组件既保持封装性又具备灵活性。</p>
<p>记住这个进阶路径：默认插槽 → 具名插槽 → 作用域插槽 → 组合使用。每掌握一个层次，你的组件设计能力就提升一个档次。</p>
<p>现在回头看看你项目里的那些通用组件，是不是有很多地方可以用今天学到的技巧来重构？动手试试吧，你会惊讶于组件灵活度提升带来的开发效率变化！</p>
<p>如果你在实战中遇到了有趣的问题或者有更好的用法，欢迎在评论区分享你的经验！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 3.38 发布，快来看看有什么更新吧]]></title>    <link>https://juejin.cn/post/7571693273728696356</link>    <guid>https://juejin.cn/post/7571693273728696356</guid>    <pubDate>2025-11-12T23:24:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571693273728696356" data-draft-id="7571646669202505770" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 3.38  发布，快来看看有什么更新吧"/> <meta itemprop="keywords" content="前端,Android,Flutter"/> <meta itemprop="datePublished" content="2025-11-12T23:24:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="恋猫de小郭"/> <meta itemprop="url" content="https://juejin.cn/user/817692379985752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 3.38  发布，快来看看有什么更新吧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/817692379985752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    恋猫de小郭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T23:24:02.000Z" title="Wed Nov 12 2025 23:24:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 11 月 13 日的 FlutterFlightPlans 直播中，Flutter 3.38 如期而至，本次版本主要涉及 <strong>Dot shorthands、Web 支持增强、性能改进、问题修复和控件预览等方面</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d433075975a4642bfafa8d84892238c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763594642&amp;x-signature=JYqE4ro93N2IYqBtQE2GNsCuD6g%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">Dot shorthands</h2>
<p>在 Dart 3.10 + Flutter 3.38 中开始默认支持 Dot shorthands ，通过 Dot shorthands 可以使用简写方式省略类型前缀，例如使用 <code>.start</code> 而不是 <code>MainAxisAlignment.start</code>  ：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// With shorthands</span>
Column(
  mainAxisAlignment: .start,
  crossAxisAlignment: .center,
  children: [ <span class="hljs-comment">/* ... */</span> ],
),

<span class="hljs-comment">// Without shorthands</span>
Column(
  mainAxisAlignment: MainAxisAlignment.start,
  crossAxisAlignment: CrossAxisAlignment.center,
  children: [ <span class="hljs-comment">/* … */</span> ],
),

</code></pre>
<p>类似的还有  <code>.all</code> 而不是 <code>EdgeInsets.all</code>：</p>
<pre><code class="hljs language-dart" lang="dart">Padding(
  padding: .all(<span class="hljs-number">8.0</span>),
  child: Text(<span class="hljs-string">'Hello world'</span>),
),
</code></pre>
<blockquote>
<p>详细可见我们在之前聊过的 <a href="https://juejin.cn/post/7500234308432445451" target="_blank" title="https://juejin.cn/post/7500234308432445451">《Flutter 合并 'dot-shorthands' 语法糖》</a> 。</p>
</blockquote>
<h2 data-id="heading-1">Web 增强</h2>
<p><code>flutter run</code> 命令现在支持设置 Web 的配置文件，可以在工程根目录放入 <code>web_dev_config.yaml</code> 来配置 web 主机、端口、证书、headers 等，例如：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">host:</span> <span class="hljs-string">"0.0.0.0"</span> <span class="hljs-comment"># Defines the binding address &lt;string&gt;</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span> <span class="hljs-comment"># Specifies the port &lt;int&gt; for the development server</span>
  <span class="hljs-attr">https:</span>
    <span class="hljs-attr">cert-path:</span> <span class="hljs-string">"/path/to/cert.pem"</span> <span class="hljs-comment"># Path &lt;string&gt; to your TLS certificate</span>
    <span class="hljs-attr">cert-key-path:</span> <span class="hljs-string">"/path/to/key.pem"</span> <span class="hljs-comment"># Path &lt;string&gt; to TLS certificate key</span>
</code></pre>
<p>通过支持代理 (proxy) 设置，还可以将请求转发到配置的路径到另一台服务器：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">proxy:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">target:</span> <span class="hljs-string">"http://localhost:5000/"</span> <span class="hljs-comment"># Base URL &lt;string&gt; of your backend</span>
      <span class="hljs-attr">prefix:</span> <span class="hljs-string">"/users/"</span> <span class="hljs-comment"># Path &lt;string&gt;</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">target:</span> <span class="hljs-string">"http://localhost:3000/"</span>
      <span class="hljs-attr">prefix:</span> <span class="hljs-string">"/data/"</span>
      <span class="hljs-attr">replace:</span> <span class="hljs-string">"/report/"</span> <span class="hljs-comment"># Replacement &lt;string&gt; of path in redirected URL (optional)</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">target:</span> <span class="hljs-string">"http://localhost:4000/"</span>
      <span class="hljs-attr">prefix:</span> <span class="hljs-string">"/products/"</span>
      <span class="hljs-attr">replace:</span> <span class="hljs-string">""</span>
</code></pre>
<p>最后 3.38 还增强了 Flutter Web 的 hot reload 并默认开启，当以 <code>-d web-server</code> 参数运行并在浏览器打开时，可以支持多个浏览器同时连接 hot reload 。</p>
<blockquote>
<p>当然，和  <code>-d chrome</code> 一样，你也可以使用 <code>--no-web-experimental-hot-reload</code> 标志暂时禁用，不过禁用功能将在将来的版本中删除。</p>
</blockquote>
<h2 data-id="heading-2">Framework</h2>
<p>本次 Framework 调整主要围绕交互优化相关，比如帮助开发人员可以更精细地控制 UI、导航和平台交互等。</p>
<p>首先是引入了新的 <code>OverlayPortal</code>，允许将子 Widget 渲染在任一 <code>Overlay</code> 上，通过 <code>overlayChildLayoutBuilder</code> 可以更灵活地显示弹出、对话框、通知等 UI ，例如：</p>
<pre><code class="hljs language-dart" lang="dart">
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_OverlayPortalExampleState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">OverlayPortalExample</span>&gt; </span>{
  <span class="hljs-keyword">final</span> OverlayPortalController _controller = OverlayPortalController();

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(title: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'OverlayPortal'</span>)),
      body: Center(
        child: OverlayPortal.overlayChildLayoutBuilder(
          controller: _controller,
          <span class="hljs-comment">/// <span class="markdown"><span class="hljs-strong">****</span>可以配置 root<span class="hljs-strong">****</span></span></span>
          overlayLocation: OverlayChildLocation.rootOverlay,
          child: ElevatedButton(
            onPressed: () =&gt; _controller.toggle(),
            child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'点击显示浮层'</span>),
          ),
          overlayChildBuilder: (context, info) {
            <span class="hljs-keyword">return</span> Material(
              elevation: <span class="hljs-number">4</span>,
              color: Colors.white,
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(<span class="hljs-number">8</span>),
              ),
              child: Container(
                padding: <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">12</span>),
                child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'这是一个浮层'</span>),
              ),
            );
          },
        ),
      ),
    );
  }
}


</code></pre>
<p><strong>通过 <code>overlayChildLayoutBuilder</code> 可以拿到主 Widget 的位置信息</strong>，可将浮层显示在任意屏幕位置，比如按钮下方、屏幕中心、或与鼠标位置对齐。</p>
<p>接着是在 Android 平台下，<strong>使用 <code>MaterialApp</code> 时默认启用了预测后退路由转场 (predictive back route transitions)，后退手势时能看到当前界面预览</strong>，此外默认页面转换已从 <code>ZoomPageTransitionsBuilder</code> 更新为 <code>FadeForwardsPageTransitionsBuilder</code> 。</p>
<p>然后就是久违的 PC 端更新，<strong>针对 Windows 桌面开发增强</strong>：可访问已连接显示器列表，并查询每个显示器的分辨率、刷新率、物理尺寸等属性，算是对多窗口模式的增强，例如 <code>PlatformDispatcher.displays </code>获取到 当前所有显示器：</p>
<pre><code class="hljs language-dart" lang="dart">
<span class="hljs-keyword">void</span> printDisplayInfos() {
  <span class="hljs-keyword">final</span> platformDispatcher = WidgetsBinding.instance.platformDispatcher;
  <span class="hljs-keyword">final</span> displays = platformDispatcher.displays;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> display <span class="hljs-keyword">in</span> displays) {
    <span class="hljs-keyword">final</span> id = display.id;
    <span class="hljs-keyword">final</span> size = display.size; <span class="hljs-comment">// Size in logical pixels</span>
    <span class="hljs-keyword">final</span> dpr = display.devicePixelRatio;
    <span class="hljs-keyword">final</span> refreshRate = display.refreshRate;
  }
}
</code></pre>
<p>同时，现在如果在  Widget 生命周期回调中发生的错误（例如 <code>didUpdateWidget</code>）可以更优雅地处理，防止它们在元素树中导致级联故障 （<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173148" target="_blank" title="https://github.com/flutter/flutter/pull/173148" ref="nofollow noopener noreferrer">#173148</a>），以前如果开发者在这些回调中抛出了异常（哪怕只是一个小错误），<strong>整个元素树可能会进入不一致状态或直接崩溃</strong>。</p>
<p>而现在 Framework 在这些生命周期阶段调用时， <strong>将内部异常捕获包装在更安全的范围内</strong>，也就是说，如果你的某个子 Widget 在 <code>didUpdateWidget()</code> 抛出错误， Flutter 会：</p>
<ul>
<li>捕获这个错误；</li>
<li>上报给 Flutter 的全局错误处理系统（<code>FlutterError.onError</code>）；</li>
<li>允许其他 widget 正常 rebuild；</li>
<li>避免整个 Element Tree 出现「级联错误」(cascade failure)</li>
</ul>
<p>也就是让错误隔离更强，不再因为一个 widget 的生命周期异常破坏整个界面，而 IDE 中仍然能看到详细的异常栈，从而让应用的健壮性显著提升（尤其对热重载、动态组件更新等场景）。</p>
<p>最后是一些问题修复，例如：</p>
<ul>
<li>修复了之前 <code>ResizeImage</code> 的 <code>==</code> 和 <code>hashCode</code> 实现不正确的问题，在之前即使两个 <code>ResizeImage</code> 指向同一底层图像和相同尺寸， Flutter 也认为它们不相等</li>
<li>在 Web 上继续修复 <code>RSuperellipse</code>，以防止在角半径大于 Widget 本身 （<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F172254" target="_blank" title="https://github.com/flutter/flutter/pull/172254" ref="nofollow noopener noreferrer">#172254</a>） 时出现渲染错误</li>
<li>对于国际用户来说，检测浏览器的首选区域设置得到优化，引擎现在使用标准的 <code>Intl.Locale</code> Web API 来解析浏览器语言，取代了以前的手动实现 （<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F172964" target="_blank" title="https://github.com/flutter/flutter/pull/172964" ref="nofollow noopener noreferrer">#172964</a>）</li>
<li>修复了 Android 的特定错误 （<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F171973" target="_blank" title="https://github.com/flutter/flutter/pull/171973" ref="nofollow noopener noreferrer">#171973</a>） ，主要影响配备硬件键盘的三星设备，以前在用户与 <code>TextField</code> 交互后，Android 输入法编辑器 （IME） 可能会陷入过时状态，导致 IME 错误地拦截“Enter”或“Space”键按下，从而阻止非文本 Widget （如<code>复选框</code>或<code>单选</code>按钮）接收事件，而本次的修复可以确保在文本连接关闭时正确重置 <code>InputMethodManager</code>，清除 IME 的过时状态，并为用户还原可预测的硬件键盘交互</li>
</ul>
<h2 data-id="heading-3">Material 和 Cupertino  更新</h2>
<p>在弃用 <code>MaterialState</code> 的基础上，3.38 继续内部迁移到更统一的 <code>WidgetState</code>，这提供了一种更一致的方式来定义控件在不同交互状态（例如按下、悬停或禁用）中的外观，并且开发这不需要对现有应用代码进行更改。</p>
<p>3.38 开始恰迁移已逐步应用在各种 Widget 及其主题，包括 <code>IconButton</code>、<code>ElevatedButton</code>、<code>Checkbox</code> 和 <code>Switch</code> （<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173893" target="_blank" title="https://github.com/flutter/flutter/pull/173893" ref="nofollow noopener noreferrer">#173893</a>），新的 API 还增加了功能和灵活性，例如：</p>
<ul>
<li><code>IconButton</code> 现在包括一个 <code>statesController</code> 属性 （<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F169821" target="_blank" title="https://github.com/flutter/flutter/pull/169821" ref="nofollow noopener noreferrer">#169821</a>），允许以编程方式控制其视觉状态</li>
<li><code>Badge.count</code> 构造函数现在包含一个 <code>maxCount</code> 参数 （<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F171054" target="_blank" title="https://github.com/flutter/flutter/pull/171054" ref="nofollow noopener noreferrer">#171054</a>） ，可以限制显示的计数（例如，显示“99+”而不是“100”）</li>
<li>为了实现更细粒度的手势控制，<code>InkWell</code> 现在具有 <code>onLongPressUp</code> 回调 （<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173221" target="_blank" title="https://github.com/flutter/flutter/pull/173221" ref="nofollow noopener noreferrer">#173221</a>），可用于触发仅在用户抬起手指时才相应完成</li>
<li>Cupertino 也继续朝着更好的 iOS 保真度迈进， <code>CupertinoSlidingSegmentedControl</code>  添加了<code>isMomentary</code> 属性 （<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F164262" target="_blank" title="https://github.com/flutter/flutter/pull/164262" ref="nofollow noopener noreferrer">#164262</a>） 以允许控件触发而不保留选择，为了更好地匹配原生 iOS 行为，<code>CupertinoSheet</code> 在完全展开时向上拖动时具有微妙的“拉伸”效果 （<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F168547" target="_blank" title="https://github.com/flutter/flutter/pull/168547" ref="nofollow noopener noreferrer">#168547</a>）<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/181c61a77436444bbd5b552065ad4f29~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763594642&amp;x-signature=hW72opbkHzAt77Iiy4Z5uHqwvzc%3D" alt="" loading="lazy"/></li>
<li>修复 <code>DropdownMenuFormField</code> 在窗体重置时正确清除其文本字段 （<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F174937" target="_blank" title="https://github.com/flutter/flutter/pull/174937" ref="nofollow noopener noreferrer">#174937</a>）</li>
<li>更新 <code>SegmentedButton</code> 改进焦点处理 （<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173953" target="_blank" title="https://github.com/flutter/flutter/pull/173953" ref="nofollow noopener noreferrer">#173953</a>） 并确保其边框正确反映 Widget 的状态 （<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F172754" target="_blank" title="https://github.com/flutter/flutter/pull/172754" ref="nofollow noopener noreferrer">#172754</a>）</li>
<li>滚动 (Scrolling) 和 Sliver 系列控件改进，例如 <code>SliverMainAxisGroup</code> / <code>SliverCrossAxisGroup</code> 在复杂滚动布局中手势处理、点击响应、焦点导航更可靠，例如：
<ul>
<li>对多个 sliver 进行分组的开发人员会发现手势处理现在更加可靠，现在可以正确计算这些组中细片上的点击和其他指针事件的命中测试，确保用户交互按预期运行 （<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F174265" target="_blank" title="https://github.com/flutter/flutter/pull/174265" ref="nofollow noopener noreferrer">#174265</a>）</li>
<li>在 <code>SliverMainAxisGroup</code>  使用固定标题时过度滚动的问题已得到解决 （<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173349" target="_blank" title="https://github.com/flutter/flutter/pull/173349" ref="nofollow noopener noreferrer">#173349</a>），调用 <code>showOnScreen</code> 显示 sliver 现在可以正常工作 （<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F171339" target="_blank" title="https://github.com/flutter/flutter/pull/171339" ref="nofollow noopener noreferrer">#171339</a>），并且内部滚动偏移量计算更加精确 （<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F174369" target="_blank" title="https://github.com/flutter/flutter/pull/174369" ref="nofollow noopener noreferrer">#174369</a>）。</li>
<li>对于构建自定义滚动视图的开发人员来说，新的 <code>SliverGrid.list</code> 构造函数 （<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173925" target="_blank" title="https://github.com/flutter/flutter/pull/173925" ref="nofollow noopener noreferrer">#173925</a>） 提供了一种更简洁的方法，可以从简单的子列表创建网格<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a326d1ec07d48c98bffe3ba138b3480~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763594642&amp;x-signature=rnmSehJhqnH8%2BBC5aR%2F9GiKZg6w%3D" alt="" loading="lazy"/></li>
</ul>
</li>
<li>另外还改进了复杂布局中键盘和方向键用户的焦点导航，在具有不同滚动轴的嵌套滚动视图（例如水平轮播的垂直列表）中，定向焦点导航现在更具可预测性，可防止焦点在部分之间意外跳转 <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48ea7a9bac734572a7190b652606ddeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763594642&amp;x-signature=kNKSWqEOGlDf98aJZhs%2FFkMFL0Q%3D" alt="" loading="lazy"/></li>
</ul>
<p>最后， Material 和 Cupertino 与框架的解耦还在继续，核心内容就是，<strong>解耦后需要作为第一方官方包发布</strong>，需要自动化语义化版本管理，避免冲突，支持自定义发布（如跳过特定提交、批量破坏性变更），采用“批量发布”（Batch Release），使用 Cocoon cron job 每周生成合并 PR；开发者通过 “commit消息、PR 标签或独立changelog 文件标记变更，首选选项为 PR 独立 changelog 文件，由 bot 合并等。</p>
<p>另外就是 Widgets测试不导入Material/Cupertino；Cupertino不导入Material，Material负责所有多库导入测试，包括 Cupertino 兼容性和自适应等。</p>
<p>以下是一些关于Material 和 Cupertino 与框架的一些关键讨论地址：</p>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.google.com%2Fdocument%2Fu%2F1%2Fd%2F18kjoP-4LAXEllugVOQRg6vZELyD6MuxlKilLD4lFxSY%2Fedit" target="_blank" title="https://docs.google.com/document/u/1/d/18kjoP-4LAXEllugVOQRg6vZELyD6MuxlKilLD4lFxSY/edit" ref="nofollow noopener noreferrer">docs.google.com/document/u/…</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.google.com%2Fdocument%2Fd%2F1jUoFaawutbYsCI5oY3pDP_l-xpv6FhDKlcI1-EoT02s%2Fedit%3Ftab%3Dt.0" target="_blank" title="https://docs.google.com/document/d/1jUoFaawutbYsCI5oY3pDP_l-xpv6FhDKlcI1-EoT02s/edit?tab=t.0" ref="nofollow noopener noreferrer">docs.google.com/document/d/…</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.google.com%2Fdocument%2Fd%2F1y38TN9AUTyd0eTbu4kx4FiNgfsLDPvWvi92Fv5HWFjQ%2Fedit%3Ftab%3Dt.0%23heading%3Dh.pub7jnop54q0" target="_blank" title="https://docs.google.com/document/d/1y38TN9AUTyd0eTbu4kx4FiNgfsLDPvWvi92Fv5HWFjQ/edit?tab=t.0#heading=h.pub7jnop54q0" ref="nofollow noopener noreferrer">docs.google.com/document/d/…</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.google.com%2Fdocument%2Fd%2F1UHxALQqCbmgjnM1RNV9xE2pK3IGyx-UktGX1D7hYCjs%2Fedit%3Ftab%3Dt.0" target="_blank" title="https://docs.google.com/document/d/1UHxALQqCbmgjnM1RNV9xE2pK3IGyx-UktGX1D7hYCjs/edit?tab=t.0" ref="nofollow noopener noreferrer">docs.google.com/document/d/…</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2F177028" target="_blank" title="https://github.com/flutter/flutter/issues/177028" ref="nofollow noopener noreferrer">github.com/flutter/flu…</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.google.com%2Fdocument%2Fd%2F1oFezK5leJzTWA5lsw3BQGx7gLbhpSL8dMleU3HD7bNY%2Fedit%3Ftab%3Dt.0" target="_blank" title="https://docs.google.com/document/d/1oFezK5leJzTWA5lsw3BQGx7gLbhpSL8dMleU3HD7bNY/edit?tab=t.0" ref="nofollow noopener noreferrer">docs.google.com/document/d/…</a></p>
</li>
</ul>
<h2 data-id="heading-4">Accessibility</h2>
<p>对于构建复杂应用的开发人员，3.38 引入了使用 <code>WidgetsFlutterBinding.instance.ensureSemantics</code>   （<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F174163" target="_blank" title="https://github.com/flutter/flutter/pull/174163" ref="nofollow noopener noreferrer">#174163</a>） 在 iOS 上默认打开辅助功能的功能，调试辅助功能问题现在变得更加容易，因为 <code>debugDumpSemanticsTree</code> 包含额外的文本输入验证结果信息，以帮助更快地诊断问题 （<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F174677" target="_blank" title="https://github.com/flutter/flutter/pull/174677" ref="nofollow noopener noreferrer">#174677</a>）。</p>
<p>为了在基于 sliver 的滚动视图中实现高级可访问性，3.38 增加了新的 <code>SliverSemantics</code>  （<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F167300" target="_blank" title="https://github.com/flutter/flutter/pull/167300" ref="nofollow noopener noreferrer">#167300</a>） ，与现有的 <code>Semantics</code>  非常相似，开发人员可以在 <code>CustomScrollView</code> 中使用 <code>SliverSemantics</code> 使用特定语义信息注释其 sliver 树的某些部分，这对于注释标题、分配语义角色以及为屏幕阅读器向 sliver 添加描述性标签特别有用，从而为用户提供更易于理解和访问的体验。</p>
<p>最后，核心 Widget 的可访问性不断完善，现在默认情况下可以访问 <code>CupertinoExpansionTile</code> （<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F174480" target="_blank" title="https://github.com/flutter/flutter/pull/174480" ref="nofollow noopener noreferrer">#174480</a>），<code>AutoComplete</code> 现在向用户宣布搜索结果的状态 （<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173480" target="_blank" title="https://github.com/flutter/flutter/pull/173480" ref="nofollow noopener noreferrer">#173480</a>）， <code>TimePicker</code> （<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F170060" target="_blank" title="https://github.com/flutter/flutter/pull/170060" ref="nofollow noopener noreferrer">#170060</a>） 中有更大的触摸目标，有助于提供更易于访问的开箱即用体验。</p>
<h2 data-id="heading-5">iOS</h2>
<p>iOS 平台已经完整支持最新的 iOS 26、Xcode 26、macOS 26，特别是在命令行部署使用 <code>devicectl</code> 替代必须启动 Xcode App 的流程，现在 Flutter 3.38 可以在大多数情况下仅依赖于 Xcode26 命令行 构建工具，更多可见：</p>
<ul>
<li><a href="https://juejin.cn/post/7560986017034190891" target="_blank" title="https://juejin.cn/post/7560986017034190891">Flutter 在 iOS 26 模拟器跑不起来？其实很简单</a></li>
<li><a href="https://juejin.cn/post/7542461507402924075" target="_blank" title="https://juejin.cn/post/7542461507402924075">Flutter 完成全新 devicectl + lldb 的 Debug JIT 运行支持</a></li>
</ul>
<blockquote>
<p>虽然官方说完全支持，但是 iOS26 问题还是有的，例如：<a href="https://juejin.cn/post/7571306072423448618" target="_blank" title="https://juejin.cn/post/7571306072423448618">《来了解一下，为什么你的 Flutter WebView 在 iOS 26 上有点击问题？》</a></p>
</blockquote>
<p>另外 Flutter 3.38 包括了对 Apple 强制的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fdocumentation%2Ftechnotes%2Ftn3187-migrating-to-the-uikit-scene-based-life-cycle" target="_blank" title="https://developer.apple.com/documentation/technotes/tn3187-migrating-to-the-uikit-scene-based-life-cycle" ref="nofollow noopener noreferrer">UIScene 生命周期</a>的基本支持，这是继 Apple 在 WWDC25 上宣布之后的一次关键的主动更新：“在 iOS 26 之后的版本中，任何使用最新 SDK 构建的 UIKit 应用都将需要使用 UIScene 生命周期，否则它将不会启动”。</p>
<blockquote>
<p>详细可见：<a href="https://juejin.cn/post/7565733796269981738" target="_blank" title="https://juejin.cn/post/7565733796269981738">iOS 26 开始强制 UIScene ，你的 Flutter 插件准备好迁移支持了吗？</a> ，因为适配  UIScene 需要 迁移官方提供了手动迁移和自动迁移的支持，其中自动迁移需要配置 <code>flutter config --enable-uiscene-migration</code> ，更多迁移细节可见：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.flutter.dev%2Frelease%2Fbreaking-changes%2Fuiscenedelegate%23migration-guide-for-flutter-apps" target="_blank" title="https://docs.flutter.dev/release/breaking-changes/uiscenedelegate#migration-guide-for-flutter-apps" ref="nofollow noopener noreferrer">docs.flutter.dev/release/bre…</a></p>
</blockquote>
<p>对于 UIScene 支持，更致命的主要还是插件开发者，对于插件作者而言 <code>UIScene</code> 迁移带来了更大的挑战：<strong>必须确保插件既能在已经迁移到 <code>UIScene</code> 的新应用中正常工作，也要能在尚未迁移的旧应用或旧版 iOS 系统上保持兼容</strong>，例如：</p>
<ul>
<li>一个依赖生命周期事件的插件（例如，一个在应用进入后台时暂停视频播放的插件）不能简单地把监听代码从 <code>AppDelegate</code> 移到 <code>SceneDelegate</code>，这样做会导致它在未迁移的应用中完全失效，因此插件必须能够同时处理两种生命周期模型</li>
<li>具体插件迁移步骤：
<ul>
<li><strong>注册场景事件监听</strong>：在插件的 <code>register(with registrar: FlutterPluginRegistrar)</code> 方法中，除了像以前一样通过 <code>registrar.addApplicationDelegate(self)</code> 注册 <code>AppDelegate</code> 事件监听外，还需要调用新的 API 来注册 <code>SceneDelegate</code> 事件的监听，Flutter 提供了相应的机制让插件可以接收到场景生命周期的回调</li>
<li><strong>实现双重生命周期处理</strong>：插件内部需要实现 <code>UISceneDelegate</code> 协议中的相关方法，在实现时要设计一种优雅降级的逻辑。例如同时实现 <code>applicationDidEnterBackground</code> 和 <code>sceneDidEnterBackground</code>，当 <code>sceneDidEnterBackground</code> 被调用时，执行相应逻辑并设置一个标志位，以避免 <code>applicationDidEnterBackground</code>中的逻辑重复执行（如果它也被意外调用的话）</li>
<li><strong>更新废弃的 API 调用</strong>：插件代码中任何对 <code>UIApplication.shared.keyWindow</code> 或其他与单一窗口相关的废弃 API 的调用都必须被替换</li>
</ul>
</li>
</ul>
<h2 data-id="heading-6">Android</h2>
<p>升级到 Flutter 3.38 是满足 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fguide%2Fpractices%2Fpage-sizes" target="_blank" title="https://developer.android.com/guide/practices/page-sizes" ref="nofollow noopener noreferrer">Google Play 16 KB 页面大小兼容性要求</a>的重要准备工作， 因为 3.38 的更改可确保你的应用在高 RAM 设备上正常运行，并提供性能优势，例如启动速度提高多达 30%。</p>
<blockquote>
<p>Flutter 3.38 将默认的 Android ndkVersion 更新为 NDK r28，这是原生代码实现 16 KB 支持正确对齐所需的最低要求。</p>
</blockquote>
<p>Flutter 3.38 还<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2F173770" target="_blank" title="https://github.com/flutter/flutter/issues/173770" ref="nofollow noopener noreferrer">修复（#173770）</a>了影响 Android 上所有 Flutter 应用的严重内存泄漏，该问题在 3.29.0 中引入，发生在退出时销毁 Activity 时出现。</p>
<p>对于 Flutter 3.38 版本，Android 环境目前的推荐配置：</p>
<ul>
<li><strong>Java 17</strong>：Flutter 3.38 中 Android 开发所需的最低版本</li>
<li><strong>KGP 2.2.20</strong>：该工具已知且支持]的最大 Kotlin Gradle 插件版本</li>
<li><strong>AGP 8.11.1</strong>：与 KGP 2.2.20 兼容的最新 Android Gradle 插件版本</li>
<li><strong>Gradle 8.14</strong>：此版本适用于所选版本的 Java、KGP 和 AGP，请注意 Gradle 8.13 是 AGP 8.11.1 所需的最低版本。</li>
</ul>
<p>为确保应用在 Flutter 版本之间无缝运行，强烈建议在构建文件中使用 Flutter SDK 提供的 API 级变量：</p>
<ul>
<li><code>flutter.compileSdkVersion</code> (API 36)</li>
<li><code>flutter.targetSdkVersion</code> (API 36)</li>
<li><code>flutter.minSdkVersion</code> (API 24) or higher</li>
</ul>
<h2 data-id="heading-7">Engine</h2>
<p>performance overlay  已经重构，现在提高效率的同时，减少了 Skia 和 Impeller 后端的渲染时间，这意味着可以以更少的开销获得更准确的性能数据。</p>
<p>对 Vulkan 和 OpenGL ES 后端的大量修复和改进提高了更广泛设备上的稳定性和性能，包括更好地处理管道缓存 （<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F176322" target="_blank" title="https://github.com/flutter/flutter/pull/176322" ref="nofollow noopener noreferrer">#176322</a>）、fence waiters （<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173085" target="_blank" title="https://github.com/flutter/flutter/pull/173085" ref="nofollow noopener noreferrer">#173085</a>） 和 image layout transitions （<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173884" target="_blank" title="https://github.com/flutter/flutter/pull/173884" ref="nofollow noopener noreferrer">#173884</a>）。</p>
<p>另外对于 Web，继续统一 CanvasKit 和 Skwasm 渲染器的工作，3.38 包括了它们的重大重构，以在两者之间共享更多代码，这将在未来带来更一致的体验和更快的开发 （<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F174588" target="_blank" title="https://github.com/flutter/flutter/pull/174588" ref="nofollow noopener noreferrer">#174588</a>）。</p>
<h4 data-id="heading-8">重点重点重点：iOS 和 Android 中已删除选择退出线程合并的功能。</h4>
<h2 data-id="heading-9">DevTools 和 IDE</h2>
<p>Flutter 3.35 引入了 Widget Previews，而 Flutter 3.38 版本对 Widget Previews 进行了重大改进，包括 VSCode 和 Intellij / Android Studio 插件都已更新，初步支持 Widget Previews ，<strong>可以直接在 IDE 中查看预览</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11176c554cdf463c8fee3a7effa04f19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763594642&amp;x-signature=%2B6oPANPXZtBEyHElel3UFlg0htg%3D" alt="" loading="lazy"/></p>
<p>在 IDE 中使用时，默认情况下  Widget Previews  环境配置为根据当前选定的源文件过滤显示的预览：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ba377af0ca5477fa9c6d7cef3aa0ec0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763594642&amp;x-signature=B1Iedivs7mtdZmkwduZz9aqeaU0%3D" alt="" loading="lazy"/></p>
<p>另外，Widget Previews  现在支持浅色和深色模式，以及自定义 IDE 配色方案以匹配开发环境，控件预览环境中的控件也进行了调整，以使用更少的空间，从而为渲染预览留出更多空间。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5781a9920d3b44b79435f1b2e9308df3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763594642&amp;x-signature=LKoXrgz6I1sA%2B4WXxbJcKmgkJg8%3D" alt="" loading="lazy"/></p>
<p>此外，览批注类不再标记为最终批注，现在可以扩展以创建自定义预览批注，从而减少常见预览类型的样板：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c71ad26d4124abfa90a53890136bcdb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763594642&amp;x-signature=cCVblZ%2BIGB2wwdcU3mnYeo296xM%3D" alt="" loading="lazy"/></p>
<p>并且新的 <code>MultiPreview</code> 基类允许从单个自定义注释创建多个预览变体：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8083a9e09ad4662b1e36f8b42a5c41f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763594642&amp;x-signature=cE52N522gxGE6kBIKeGTEkXE9gY%3D" alt="" loading="lazy"/></p>
<p><code>Preview</code> 类中的新 group 参数允许对相关预览进行分组，减少了对 <code>@Preview</code> 注释参数的限制，支持私有常量作为 <code>Preview</code> 注释的参数等。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ddf13e2bbbb54de2a1c74433bdcc8d49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763594642&amp;x-signature=C5yTEtZHbMR26QKNEwL3alvsY6U%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>目前关于预览还有一些问题，例如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2F178317" target="_blank" title="https://github.com/flutter/flutter/issues/178317" ref="nofollow noopener noreferrer">#178317</a> ，例如 Widget 预览器可能会在 <em>flutter pub get</em>  后崩溃或停止更新。</p>
</blockquote>
<p>其他关于 Tool 更新还有：</p>
<ul>
<li>Flutter DevTools Widget Inspector 正在增加支持适配预览</li>
<li>IDE 中预览的多项目支持：预览目前仅支持显示单个项目或 Pub 工作区中包含的预览，多项目正在支持</li>
<li>正在推进预览的性能改进的机会，以减少初始启动时间</li>
<li>Network Panel 的交互改进</li>
<li>Flutter Inspector 修复了选择 Widget 有时会打开底层框架源代码而不是用户源代码的错误</li>
<li>修复了 Flutter Inspector  偶尔阻止与“检查器”面板中的顶部按钮交互的错误</li>
</ul>
<h2 data-id="heading-10">弃用和重大变更</h2>
<p>首先，3.38 进行了可能影响自定义生成脚本的关键生成和工具更改，<strong>Flutter SDK 根目录的 <code>version</code> 文件已被删除</strong>，取而代之的是位于 <code>bin/cache</code> （<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F172793" target="_blank" title="https://github.com/flutter/flutter/pull/172793" ref="nofollow noopener noreferrer">#172793</a>） 中的新 <code>flutter.version.json</code> 文件，此外默认情况下不再生成 <code>AssetManifest.json</code> 文件 （<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F172594" target="_blank" title="https://github.com/flutter/flutter/pull/172594" ref="nofollow noopener noreferrer">#172594</a>）。</p>
<p>另外还有：</p>
<ul>
<li>对于  predictable behavior，包含作的 SnackBar 将不再自动关闭 （<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173084" target="_blank" title="https://github.com/flutter/flutter/pull/173084" ref="nofollow noopener noreferrer">#173084</a>）</li>
<li>前面介绍过的 <code>OverlayPortal.targetsRootOverlay</code> 构造函数已被弃用，取而代之的是更灵活的 <code>OverlayPortal</code>（ <code>overlayLocation: OverlayChildLocation.rootOverlay</code> ）</li>
<li><code>CupertinoDynamicColor</code> 上的几个属性（例如 <code>withAlpha</code> 和 <code>withOpacity</code>）现在已弃用，取而代之的是标准 <code>Color</code> 方法</li>
<li>Flutter 3.38 要求 Java 17 作为 Android 的最低版本，符合 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.gradle.org%2Fcurrent%2Fuserguide%2Fcompatibility.html" target="_blank" title="https://docs.gradle.org/current/userguide/compatibility.html" ref="nofollow noopener noreferrer">Gradle 8.14</a>（2025 年 7 月版）的最低要求</li>
</ul>
<h2 data-id="heading-11">最后</h2>
<p>本次 3.38 的更新还是挺丰富的，同时也是一个不得不升级的版本，<strong>不管是为了 iOS 26 适配和未来上架，还是为了安卓更稳定的 16KB 体验，这都是一个不得不升级的版本</strong>。</p>
<p>那么大家准备好直接吃 3.38.0 的螃蟹还是等 3.38.6 ?</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C#.NET WebAPI 返回类型深度解析：IActionResult 与 ActionResult<T> 的区别与应用]]></title>    <link>https://juejin.cn/post/7571672422689685556</link>    <guid>https://juejin.cn/post/7571672422689685556</guid>    <pubDate>2025-11-12T23:57:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571672422689685556" data-draft-id="7571672422689669172" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C#.NET WebAPI 返回类型深度解析：IActionResult 与 ActionResult&lt;T&gt; 的区别与应用"/> <meta itemprop="keywords" content="C#,.NET"/> <meta itemprop="datePublished" content="2025-11-12T23:57:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="唐青枫"/> <meta itemprop="url" content="https://juejin.cn/user/3737995266234280"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C#.NET WebAPI 返回类型深度解析：IActionResult 与 ActionResult&lt;T&gt; 的区别与应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3737995266234280/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    唐青枫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T23:57:44.000Z" title="Wed Nov 12 2025 23:57:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">简介</h3>
<h3 data-id="heading-1">核心概念对比</h3>








































<table><thead><tr><th>特性</th><th><code>IActionResult</code></th><th><code>ActionResult&lt;T&gt;</code></th></tr></thead><tbody><tr><td>引入版本</td><td>ASP.NET Core 1.0</td><td>ASP.NET Core 2.1</td></tr><tr><td>主要用途</td><td>表示HTTP响应（状态码+内容）</td><td>类型化HTTP响应</td></tr><tr><td>返回值类型</td><td>接口（多种实现）</td><td>泛型类</td></tr><tr><td>内容类型安全</td><td>❌ 无编译时检查</td><td>✅ 编译时类型检查</td></tr><tr><td><code>OpenAPI/Swagger</code></td><td>需手动添加 <code>[ProducesResponseType]</code></td><td>自动推断响应类型</td></tr><tr><td>适用场景</td><td>需要灵活返回多种响应的场景</td><td>强类型API响应</td></tr></tbody></table>
<h4 data-id="heading-2">类型签名与意图</h4>
<ul>
<li>
<p><code>IActionResult</code></p>
<ul>
<li>
<p>接口，表示任何可执行产生 <code>HTTP</code> 响应的结果类型。</p>
</li>
<li>
<p>方法签名：</p>
</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">Get</span>()</span> { … }
</code></pre>
<ul>
<li>意图：方法只承诺会返回一个“动作结果”，但没有声明具体的响应体类型。</li>
</ul>
</li>
<li>
<p><code>ActionResult&lt;T&gt;</code></p>
<ul>
<li>
<p>泛型类，结合了“动作结果”与“强类型返回值”。</p>
</li>
<li>
<p>方法签名：</p>
</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> ActionResult&lt;Product&gt; <span class="hljs-title">Get</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> id</span>)</span> { … }
</code></pre>
<ul>
<li>意图：正常情况下返回 <code>T</code>（框架会自动包装为 200 OK 与 JSON），或返回任意派生自 <code>ActionResult</code> 的其他结果（如 404、201 等）。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-3">返回值灵活性</h4>

























<table><thead><tr><th>返回方式</th><th><code>IActionResult</code></th><th><code>ActionResult&lt;T&gt;</code></th></tr></thead><tbody><tr><td>返回特定类型</td><td>需手动包装：<code>Ok(product)</code></td><td>可以直接 <code>return product;</code>（自动封装为 <code>Ok(product)</code>）</td></tr><tr><td>返回状态码（无体）</td><td><code>return NoContent();</code></td><td><code>return NoContent();</code> （同样有效）</td></tr><tr><td>返回错误与状态</td><td><code>return NotFound();</code></td><td><code>return NotFound();</code></td></tr></tbody></table>
<h3 data-id="heading-4">代码示例</h3>
<h4 data-id="heading-5">使用 IActionResult</h4>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">HttpGet(<span class="hljs-string">"{id}"</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">Get</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> id</span>)</span>
{
    <span class="hljs-keyword">var</span> prod = _svc.Find(id);
    <span class="hljs-keyword">if</span> (prod == <span class="hljs-literal">null</span>)
        <span class="hljs-keyword">return</span> NotFound();
    <span class="hljs-keyword">return</span> Ok(prod);
}
</code></pre>
<h4 data-id="heading-6">使用 ActionResult</h4>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">HttpGet(<span class="hljs-string">"{id}"</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> ActionResult&lt;Product&gt; <span class="hljs-title">Get</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> id</span>)</span>
{
    <span class="hljs-keyword">var</span> prod = _svc.Find(id);
    <span class="hljs-keyword">if</span> (prod == <span class="hljs-literal">null</span>)
        <span class="hljs-keyword">return</span> NotFound();        <span class="hljs-comment">// 隐式转换为 ActionResult&lt;Product&gt;</span>
    <span class="hljs-keyword">return</span> prod;                  <span class="hljs-comment">// 隐式包装为 Ok(prod)</span>
}
</code></pre>
<h3 data-id="heading-7">最佳实践总结</h3>
<h4 data-id="heading-8">统一选择策略</h4>
<ul>
<li>
<p>新项目：优先使用 <code>ActionResult&lt;T&gt;</code></p>
</li>
<li>
<p>旧项目迁移：新 <code>API</code> 使用 <code>ActionResult&lt;T&gt;</code>，旧 <code>API</code> 逐步迁移</p>
</li>
<li>
<p>混合响应：当方法可能返回多种不相关类型时使用 <code>IActionResult</code></p>
</li>
</ul>
<h4 data-id="heading-9">推荐使用模式</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 标准API控制器模式</span>
[<span class="hljs-meta">ApiController</span>]
[<span class="hljs-meta">Route(<span class="hljs-string">"api/[controller]"</span>)</span>]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ProductsController</span> : <span class="hljs-title">ControllerBase</span>
{
    <span class="hljs-comment">// 查询单个资源：ActionResult&lt;T&gt;</span>
    [<span class="hljs-meta">HttpGet(<span class="hljs-string">"{id}"</span>)</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> ActionResult&lt;Product&gt; <span class="hljs-title">Get</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> id</span>)</span> { <span class="hljs-comment">/* ... */</span> }
    
    <span class="hljs-comment">// 创建资源：ActionResult&lt;T&gt;</span>
    [<span class="hljs-meta">HttpPost</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> ActionResult&lt;Product&gt; <span class="hljs-title">Post</span>(<span class="hljs-params">[FromBody] Product product</span>)</span> { <span class="hljs-comment">/* ... */</span> }
    
    <span class="hljs-comment">// 文件下载：IActionResult</span>
    [<span class="hljs-meta">HttpGet(<span class="hljs-string">"download/{id}"</span>)</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">Download</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> id</span>)</span> { <span class="hljs-comment">/* ... */</span> }
    
    <span class="hljs-comment">// 重定向：IActionResult</span>
    [<span class="hljs-meta">HttpGet(<span class="hljs-string">"legacy/{id}"</span>)</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">LegacyRedirect</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> id</span>)</span> 
        =&gt; RedirectToAction(<span class="hljs-keyword">nameof</span>(Get), <span class="hljs-keyword">new</span> { id });
}
</code></pre>
<h3 data-id="heading-10">框架行为</h3>
<ul>
<li>
<p>模型绑定与文档</p>
<ul>
<li><code>ActionResult&lt;T&gt;</code> 更易让工具（如 <code>Swagger、NSwag</code>）推断出返回类型，生成准确的 <code>API</code> 文档。</li>
</ul>
</li>
<li>
<p>异步场景</p>
<ul>
<li>异步版本对应 <code>Task&lt;IActionResult&gt;</code> 与 <code>Task&lt;ActionResult&lt;T&gt;</code>&gt;，使用方式完全一致。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-11">推荐场景</h3>
<ul>
<li>
<p>强类型返回推荐 <code>ActionResult&lt;T&gt;</code></p>
<ul>
<li>当 <code>API</code> 主要返回某个实体或 <code>DTO</code> 时，<code>ActionResult&lt;T&gt;</code> 简化代码、提升可读性，并让文档工具更准确地生成响应模式。</li>
</ul>
</li>
<li>
<p>多种返回类型场景使用 <code>IActionResult</code></p>
<ul>
<li>如果方法可能返回多种截然不同的 <code>DTO</code>、文件流、视图或跳转等，且没有单一“主”实体类型，使用 <code>IActionResult</code> 更灵活。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-12">总结</h3>
<ul>
<li>
<p><code>IActionResult</code>：通用接口，灵活但缺少类型信息，需要手动包装响应体。</p>
</li>
<li>
<p><code>ActionResult&lt;T&gt;</code>：带泛型的结果类型，直接返回 <code>T</code> 更简洁，兼容所有 <code>ActionResult</code>，并改善文档与类型安全。</p>
</li>
</ul>
<h3 data-id="heading-13">资源和文档</h3>
<ul>
<li>
<p>官方文档：</p>
<ul>
<li>
<p><code>IActionResult</code>：<a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fen-us%2Fdotnet%2Fapi%2Fmicrosoft.aspnetcore.mvc.iactionresult" target="_blank" title="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.iactionresult" ref="nofollow noopener noreferrer">learn.microsoft.com/en-us/dotne…</a></p>
</li>
<li>
<p><code>ActionResult&lt;T&gt;</code>：<a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fen-us%2Fdotnet%2Fapi%2Fmicrosoft.aspnetcore.mvc.actionresult-1" target="_blank" title="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.actionresult-1" ref="nofollow noopener noreferrer">learn.microsoft.com/en-us/dotne…</a></p>
</li>
<li>
<p><code>ASP.NET Core Web API</code>：<a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fen-us%2Faspnet%2Fcore%2Fweb-api" target="_blank" title="https://learn.microsoft.com/en-us/aspnet/core/web-api" ref="nofollow noopener noreferrer">learn.microsoft.com/en-us/aspne…</a></p>
</li>
</ul>
</li>
<li>
<p><code>NuGet</code> 包：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nuget.org%2Fpackages%2FMicrosoft.AspNetCore.Mvc.Core" target="_blank" title="https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Core" ref="nofollow noopener noreferrer">www.nuget.org/packages/Mi…</a></p>
</li>
<li>
<p><code>GitHub</code>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdotnet%2Faspnetcore" target="_blank" title="https://github.com/dotnet/aspnetcore" ref="nofollow noopener noreferrer">github.com/dotnet/aspn…</a></p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Arya - 功能强大的在线 Markdown 编辑器]]></title>    <link>https://juejin.cn/post/7571662618055950362</link>    <guid>https://juejin.cn/post/7571662618055950362</guid>    <pubDate>2025-11-12T15:04:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571662618055950362" data-draft-id="7571695634942328859" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Arya - 功能强大的在线 Markdown 编辑器"/> <meta itemprop="keywords" content="开源"/> <meta itemprop="datePublished" content="2025-11-12T15:04:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="修己xj"/> <meta itemprop="url" content="https://juejin.cn/user/2641475936724142"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Arya - 功能强大的在线 Markdown 编辑器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2641475936724142/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    修己xj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T15:04:55.000Z" title="Wed Nov 12 2025 15:04:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在当今信息爆炸的时代，Markdown 已成为写作、文档编写和内容创作的必备工具。今天我要向大家推荐一款功能强大、界面优美的在线 Markdown 编辑器——<strong>Arya</strong>（二丫）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ffbf4be08b840ac940ebc3a49e08e4a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763564695&amp;x-signature=Seij8E20SpbJQgZvxuXQHTN1nOk%3D" alt="ScreenShot_2025-11-12_195419_427.png" loading="lazy"/></p>
<p>ScreenShot_2025-11-12_195419_427.png</p>
<h2 data-id="heading-0">项目简介</h2>
<p>Arya 是一款基于 Vue2 和 Vditor 构建的现代化在线 Markdown 编辑器。它不仅具备了传统 Markdown 编辑器的所有基础功能，还集成了众多高级特性，让 Markdown 写作变得更加高效和愉悦。 该项目在github上已有3.3k star.</p>
<p>在线地址： <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarkdown.lovejade.cn%2F" target="_blank" title="https://markdown.lovejade.cn/" ref="nofollow noopener noreferrer">markdown.lovejade.cn/</a></p>
<p>github地址： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnicejade%2Fmarkdown-online-editor" target="_blank" title="https://github.com/nicejade/markdown-online-editor" ref="nofollow noopener noreferrer">github.com/nicejade/ma…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/129138b0003e4fe79c6aa2e8b391fafe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763564695&amp;x-signature=a9nIlACc0yeAhMfI69iQiAZBcYo%3D" alt="ScreenShot_2025-11-12_193817_677.png" loading="lazy"/></p>
<p>ScreenShot_2025-11-12_193817_677.png</p>
<h2 data-id="heading-1">核心特色功能</h2>
<h3 data-id="heading-2">🎯 丰富的图表支持</h3>
<ul>
<li><strong>流程图</strong>：轻松绘制专业的技术流程图</li>
<li><strong>甘特图</strong>：项目管理利器，清晰展示项目进度</li>
<li><strong>时序图</strong>：系统设计和架构分析的必备工具</li>
<li><strong>Echarts 图表</strong>：数据可视化，让数据说话</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0f52ab46aea42f7b3a8708a37e02133~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763564695&amp;x-signature=0iMiosUZF1mJlbWPd6g29xt%2BWSg%3D" alt="_20251112_204434.png" loading="lazy"/></p>
<p>_20251112_204434.png</p>
<h3 data-id="heading-3">🎨 多媒体与特殊内容</h3>
<ul>
<li><strong>PPT 预览</strong>：集成 RevealJs，支持将 Markdown 转换为演示文稿</li>
<li><strong>五线谱</strong>：音乐爱好者的福音，直接编辑乐谱</li>
<li><strong>视频音频解析</strong>：智能识别并嵌入多媒体内容</li>
<li><strong>HTML 自动转换</strong>：将 HTML 内容一键转换为 Markdown</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1ad21d74c604018a90024c91ff275da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763564695&amp;x-signature=6zSGtoEhAlRt751Sruhts4RChf8%3D" alt="_20251112_204737.png" loading="lazy"/></p>
<p>_20251112_204737.png</p>
<h3 data-id="heading-4">💪 高效的编辑体验</h3>
<ul>
<li>
<p><strong>三种编辑模式</strong>：</p>
<ul>
<li>所见即所得模式</li>
<li>即时渲染模式</li>
<li>分屏渲染模式</li>
</ul>
</li>
<li>
<p><strong>本地存储</strong>：自动保存编辑内容，防止意外丢失</p>
</li>
<li>
<p><strong>快捷键支持</strong>：丰富的快捷键提升编辑效率</p>
</li>
<li>
<p><strong>语法检查与格式化</strong>：保持 Markdown 代码的专业性</p>
</li>
</ul>
<h3 data-id="heading-5">📤 灵活的导出功能</h3>
<ul>
<li>支持导出为带样式的 PDF、PNG、JPEG 等格式</li>
<li>一键复制到微信公众号等平台</li>
<li>支持导入本地 Markdown 文件</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6b8629fae2a426a94a22c88ade59300~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763564695&amp;x-signature=9xSM44vbrYHXI8L%2F3Kgxu31goUE%3D" alt="_20251112_204647.png" loading="lazy"/></p>
<p>_20251112_204647.png</p>
<h2 data-id="heading-6">部署指南</h2>
<p>Arya 提供了多种部署方式，满足不同用户的需求。我们使用的是Docker私有化部署。</p>
<h3 data-id="heading-7">Docker 部署</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用官方镜像</span>
docker run -d -p 8866:80 nicejade/markdown-online-editor:latest
</code></pre>
<p>或者使用 Docker Compose：</p>
<p>创建 <code>docker-compose.yml</code> 文件：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">'3'</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">markdown-editor:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">nicejade/markdown-online-editor:latest</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">'8866:80'</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
</code></pre>
<p>启动服务：</p>
<pre><code class="hljs">docker-compose up -d
</code></pre>
<p>启动之后在浏览器中访问ip:port就可以使用了</p>
<h2 data-id="heading-8">使用技巧</h2>
<h3 data-id="heading-9">PPT 制作技巧</h3>
<p>Arya 支持将 Markdown 转换为 PPT，使用方法：</p>
<ul>
<li>使用 <code>---</code> 分隔水平幻灯片</li>
<li>使用 <code>--</code> 分隔垂直幻灯片</li>
<li>在设置中开启 PPT 预览功能</li>
</ul>
<h3 data-id="heading-10">编辑模式切换</h3>
<ul>
<li>所见即所得：<code>⌘-⌥-7</code>（Mac）或 <code>Ctrl-Alt-7</code>（Windows）</li>
<li>即时渲染：<code>⌘-⌥-8</code> 或 <code>Ctrl-Alt-8</code></li>
<li>分屏渲染：<code>⌘-⌥-9</code> 或 <code>Ctrl-Alt-9</code></li>
</ul>
<h2 data-id="heading-11">项目意义</h2>
<p>Arya 的出现解决了市面上许多 Markdown 编辑器的痛点：</p>
<ul>
<li>功能不全的问题</li>
<li>高级功能收费的限制</li>
<li>用户体验不佳的困扰</li>
<li>无法直接复制到公众号/知乎</li>
</ul>
<p>作为一个完全开源的项目，Arya 为所有用户提供了企业级的 Markdown 编辑体验，无论是个人写作、团队协作还是技术文档编写，都能找到合适的应用场景。</p>
<h2 data-id="heading-12">结语</h2>
<p>Arya 不仅仅是一个 Markdown 编辑器，更是一个功能全面的内容创作平台。其丰富的功能、优雅的界面和灵活的部署方式，使其成为目前最值得推荐的在线 Markdown 编辑器之一。</p>
<p>无论你是 Markdown 新手还是资深用户，Arya 都能为你带来惊喜。立即尝试部署或访问官方演示站点，体验一下 Markdown 编辑器的强大功能吧！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[😎 Node.js 应用多阶段构建 Dockerfile 详解]]></title>    <link>https://juejin.cn/post/7571646669202391082</link>    <guid>https://juejin.cn/post/7571646669202391082</guid>    <pubDate>2025-11-12T15:48:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571646669202391082" data-draft-id="7571648135585890347" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="😎 Node.js 应用多阶段构建 Dockerfile 详解"/> <meta itemprop="keywords" content="后端,Docker,容器"/> <meta itemprop="datePublished" content="2025-11-12T15:48:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="你的人类朋友"/> <meta itemprop="url" content="https://juejin.cn/user/4051056254523991"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            😎 Node.js 应用多阶段构建 Dockerfile 详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4051056254523991/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    你的人类朋友
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T15:48:50.000Z" title="Wed Nov 12 2025 15:48:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>🍃 你好啊，我是你的人类朋友！✨</p>
<p>本文主要来一起阅读一个高效的 Node.js 应用 Dockerfile。</p>
<p>在开始分析这个 Dockerfile 之前，先问大家一个问题：<strong>为什么这个 Dockerfile 要分两个阶段来构建，而不是直接复制所有文件然后安装依赖？</strong> 读完本文后，你就能找到答案！</p>
<blockquote>
<p>😎 小贴士：如果你不懂啥是两段构建，问题不大，后面有解释，可以继续看。</p>
</blockquote>
<p>下面展示的是一个用于部署 Node.js 应用的 Dockerfile，让我们先看看完整代码：</p>
<pre><code class="hljs language-dockerfile" lang="dockerfile">FROM node:18-alpine AS builder

WORKDIR /app

# 只复制 package.json
COPY package.json ./

# 安装依赖
RUN npm install

# 运行时阶段
FROM node:18-alpine

WORKDIR /app

# 从构建阶段复制 node_modules
COPY --from=builder /app/node_modules ./node_modules

# 复制源代码：注意，这边默认小伙伴们配置了 .dockerignore 文件，所以这一步不会复制 node_modules 目录。建议大家都补上 .dockerignore 文件，好处多多！
COPY . .

EXPOSE 3000

CMD ["node", "index.js"]
</code></pre>
<p>如果你是个新手，这个时候有点头晕是正常的，莫慌，让我们进入正文！😁</p>
<h2 data-id="heading-1">正文</h2>
<h3 data-id="heading-2">🤔 啥是单段构建与多段构建？</h3>
<p><strong>单段构建</strong>：整个应用在一个 Docker 镜像中完成构建和运行，适合简单应用。</p>
<p><strong>多段构建</strong>：将构建过程分为多个阶段，每个阶段负责不同的任务，最终只将必要的文件复制到最终镜像中。这样做可以减小镜像大小，提高安全性。</p>
<p>看不懂？问题不大，下面使用 dockerfile 来作比较：</p>
<h3 data-id="heading-3">✍️ 单段构建示例</h3>
<pre><code class="hljs language-dockerfile" lang="dockerfile">FROM node:18-alpine
WORKDIR /app
COPY . .
RUN npm install
EXPOSE 3000
CMD ["node", "index.js"]
</code></pre>
<p>我们来总结一下，他有什么特征？</p>
<ul>
<li>
<p>整个 Dockerfile 只有一个 FROM 指令</p>
</li>
<li>
<p>所有操作（安装依赖、编译代码、运行应用）都在同一个镜像中完成</p>
</li>
<li>
<p>最终生成的镜像包含了构建过程中的所有文件和工具</p>
</li>
</ul>
<p>还看不懂的话，直接记住：<strong>单段构建：只有 1 个 FROM</strong></p>
<h3 data-id="heading-4">✍️ 多段构建示例</h3>
<pre><code class="hljs language-dockerfile" lang="dockerfile"># ❗孩子们，我是第一个FROM！！！
FROM node:18-alpine AS builder

WORKDIR /app

# 只复制 package.json
COPY package.json ./

# 安装依赖
RUN npm install

# ❗孩子们，我是第二个FROM！！
# 运行时阶段
FROM node:18-alpine

WORKDIR /app

# 从构建阶段复制 node_modules
COPY --from=builder /app/node_modules ./node_modules

# 复制源代码
COPY . .

EXPOSE 3000

CMD ["node", "index.js"]
</code></pre>
<p>我们来总结一下，他有什么特征？</p>
<ul>
<li>
<p>整个 Dockerfile 有两个 FROM 指令</p>
</li>
<li>
<p>所有操作（安装依赖、编译代码、运行应用）都在不同的镜像中完成</p>
</li>
<li>
<p>最终生成的镜像只包含运行时必要的文件和工具</p>
</li>
</ul>
<p>还看不懂的话，直接记住：<strong>多段构建：有 2 个 FROM</strong></p>
<p>套公式做题就是快！bro 😏</p>
<h3 data-id="heading-5">逐行解读 Dockerfile</h3>
<p>我们现在知道啥是单段构建与多段构建</p>
<p>下面就来详细康康这个所谓的多段构建，其每一个阶段都在做啥！【当然，其实每一步这边都会解释！】</p>
<p><strong>第一阶段：构建阶段</strong></p>
<pre><code class="hljs language-dockerfile" lang="dockerfile">FROM node:18-alpine AS builder
</code></pre>
<ul>
<li>使用 Node.js 18 的 Alpine Linux 版本作为基础镜像</li>
<li>Alpine 版本非常轻量，适合生产环境</li>
<li><code>AS builder</code> 给这个阶段命名为 "builder"，方便后续引用</li>
</ul>
<pre><code class="hljs language-dockerfile" lang="dockerfile">WORKDIR /app
</code></pre>
<ul>
<li>设置工作目录为 <code>/app</code>，后续命令都在这个目录下执行。</li>
</ul>
<blockquote>
<p>补充知识：啥是 WORKDIR（工作目录）？</p>
<p>我不解释什么是工作目录，你只需要知道，设置 WORKDIR /app 就相当于你先进入容器的 /app 文件夹，之后的所有操作都在这个 /app 文件夹里完成。</p>
<p>其实很好理解，如果没有设置工作目录，操作会在根目录 / 进行，文件会放得乱七八糟的。</p>
</blockquote>
<pre><code class="hljs language-dockerfile" lang="dockerfile">COPY package.json ./
</code></pre>
<ul>
<li>只复制 <code>package.json</code> 文件到当前目录</li>
<li>这是关键步骤：先只复制依赖定义文件</li>
</ul>
<pre><code class="hljs language-dockerfile" lang="dockerfile">RUN npm install
</code></pre>
<ul>
<li>安装项目依赖包</li>
<li>由于只复制了 <code>package.json</code>，Docker 会缓存这一层，如果 <code>package.json</code> 没变化，后续构建会直接使用缓存。构建是啥意思？构建就是把你的源代码和配置打包成一个可以运行的 Docker 镜像的过程。</li>
</ul>
<p><strong>第二阶段：运行时阶段</strong></p>
<pre><code class="hljs language-dockerfile" lang="dockerfile">FROM node:18-alpine
</code></pre>
<ul>
<li>开始新的构建阶段，再次使用相同的基础镜像</li>
<li>这样确保运行环境与构建环境一致</li>
</ul>
<pre><code class="hljs language-dockerfile" lang="dockerfile">WORKDIR /app
</code></pre>
<ul>
<li>同样设置工作目录为 <code>/app</code></li>
</ul>
<pre><code class="hljs language-dockerfile" lang="dockerfile">COPY --from=builder /app/node_modules ./node_modules
</code></pre>
<ul>
<li><code>--from=builder</code> 从之前的构建阶段复制文件</li>
<li>只复制已安装的 <code>node_modules</code> 目录到当前镜像</li>
<li>这样避免了在最终镜像中包含构建工具和缓存文件</li>
</ul>
<pre><code class="hljs language-dockerfile" lang="dockerfile">COPY . .
</code></pre>
<ul>
<li>复制所有源代码到镜像中</li>
<li>由于依赖已经安装好，这里不会触发依赖重新安装</li>
</ul>
<pre><code class="hljs language-dockerfile" lang="dockerfile">EXPOSE 3000
</code></pre>
<ul>
<li>声明容器运行时监听的端口是 3000</li>
<li>这只是文档说明，实际端口映射需要在运行容器时设置</li>
</ul>
<pre><code class="hljs language-dockerfile" lang="dockerfile">CMD ["node", "index.js"]
</code></pre>
<ul>
<li>设置容器启动时执行的命令</li>
<li>使用数组格式，直接运行 <code>node index.js</code></li>
</ul>
<blockquote>
<p>🤔【疑问】 你可能会有的疑问：</p>
<p>看到这你可能一脸懵逼，第一个阶段安装依赖，第二个阶段用第一阶段的依赖，就能够节省资源？这就是所谓的多段构建吗？</p>
<p>✍️【回答】是的，这就是多段构建的精髓所在。</p>
<p>第一个阶段（builder）负责安装依赖，生成 node_modules 文件夹。第二个阶段只从这个阶段复制 node_modules 文件夹，而不复制其他构建相关的文件。</p>
<p>那么这样做为什么就能节省资源呢 😎：</p>
<p>最终镜像只包含运行需要的文件（你的代码+node_modules）</p>
<p>不包含 npm 安装过程中产生的缓存文件和临时文件</p>
<p>不包含构建工具和开发依赖</p>
<p>简单来说： 第一个阶段准备材料，第二个阶段只拿需要的材料来运行，把垃圾留在原地。</p>
</blockquote>
<blockquote>
<p>🤔【疑问】你老是说什么缓存文件、临时文件之类的，为啥我自己<code>pnpm i</code>或者<code>npm i</code>的时候没看到啥缓存文件、临时文件？</p>
<p>✍️【回答】当你运行 <code>npm install</code> 时，npm 其实会在后台下载包到缓存目录（通常在用户主目录的 .npm 文件夹中），然后从缓存复制到项目的 node_modules。虽然你在项目里看不到这些缓存文件，但它们确实存在于系统其他地方。</p>
<p>而多阶段构建的优势就是连这些隐藏的系统级缓存文件都不会带到最终镜像中，从而减小了镜像的大小，进而提高了镜像的加载速度。😎</p>
</blockquote>
<h2 data-id="heading-6">最后</h2>
<p>OK 了兄弟们，现在全体目光向我看齐，看我看我，我来总结下！</p>
<p>回到开头的问题：<strong>为什么要分两个阶段构建？</strong></p>
<p>答案主要有三点：</p>
<ol>
<li><strong>减小镜像大小</strong>：最终镜像只包含运行所需的文件，不包含构建过程中的【中间文件】和【缓存】</li>
<li><strong>提高构建速度</strong>：利用 Docker 缓存机制，当 <code>package.json</code> 不变时，直接使用缓存的依赖层，也就是 <code>npm install</code> 这一层。如果 <code>package.json</code> 改变了，才会重新安装依赖。</li>
<li><strong>增强安全性</strong>：最终镜像不包含构建工具，减少了攻击面。哈意思？就是说，因为最终镜像不包含构建工具，所以就不能通过攻击工具来攻击应用，这方面算作了解吧！</li>
</ol>
<p>这就是本文的全部内容了，祝你今天开心~</p>
<p>☀️</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TDesign UniApp 组件库来了]]></title>    <link>https://juejin.cn/post/7571650164844068898</link>    <guid>https://juejin.cn/post/7571650164844068898</guid>    <pubDate>2025-11-12T14:02:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571650164844068898" data-draft-id="7571678763781603362" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TDesign UniApp 组件库来了"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-12T14:02:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Novlan1"/> <meta itemprop="url" content="https://juejin.cn/user/1987523605435432"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TDesign UniApp 组件库来了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1987523605435432/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Novlan1
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T14:02:53.000Z" title="Wed Nov 12 2025 14:02:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 背景</h2>
<p>跨端开发一直是前端领域的重要部分，旨在实现一套代码在多个平台运行。国内使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2F" target="_blank" title="https://uniapp.dcloud.net.cn/" ref="nofollow noopener noreferrer">uniapp</a> 框架人数较多，一直有外部声音想要 uniapp 版本的 TDesign，如 TDesign Miniprogram 下的众多 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTencent%2Ftdesign-miniprogram%2Fissues%3Fq%3Duniapp" target="_blank" title="https://github.com/Tencent/tdesign-miniprogram/issues?q=uniapp" ref="nofollow noopener noreferrer">issue</a>。</p>
<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/10/own_mike_z2BC3Qi7FE8DNNWx.png" width="600" alt="转存失败，建议直接上传图片文件" loading="lazy"/>
<p>原生小程序和 uniapp 有差异，有人在 uniapp 项目里用了原生小程序组件，需要魔改内部组件代码。</p>
<p>基于以上需求，写了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnovlan1%2Ftdesign-uniapp" target="_blank" title="https://github.com/novlan1/tdesign-uniapp" ref="nofollow noopener noreferrer">TDesign UniApp</a> 项目。支持：</p>
<ul>
<li>🌈 暗色模式</li>
<li>🌈 自定义主题</li>
<li>🌍  国际化</li>
<li>🚀 API 对齐官方</li>
<li>🚀 类型提示</li>
<li>...</li>
</ul>
<p>欢迎使用，欢迎 star，欢迎反馈！</p>
<ul>
<li>文档地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fuwayfly.com%2Ftdesign-uniapp%2F" target="_blank" title="https://uwayfly.com/tdesign-uniapp/" ref="nofollow noopener noreferrer">uwayfly.com/tdesign-uni…</a></li>
<li>Github 地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnovlan1%2Ftdesign-uniapp" target="_blank" title="https://github.com/novlan1/tdesign-uniapp" ref="nofollow noopener noreferrer">github.com/novlan1/tde…</a></li>
<li>NPM 地址: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Ftdesign-uniapp" target="_blank" title="https://www.npmjs.com/package/tdesign-uniapp" ref="nofollow noopener noreferrer">www.npmjs.com/package/tde…</a></li>
<li>DCloud 插件：<a href="https://link.juejin.cn?target=https%3A%2F%2Fext.dcloud.net.cn%2Fplugin%3Fid%3D25431" target="_blank" title="https://ext.dcloud.net.cn/plugin?id=25431" ref="nofollow noopener noreferrer">ext.dcloud.net.cn/plugin?id=2…</a></li>
</ul>
<h2 data-id="heading-1">2. 预览</h2>
<p>扫码查看 ↓</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb506ae9ced4410c9e79040d2164b5e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTm92bGFuMQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763562060&amp;x-signature=Ej8vw3E%2B%2BS1AzQuNokt32FmyDIY%3D" width="600" loading="lazy"/>
<p>（注：其他平台同样支持，仅因平台审核等原因未能上架预览，不影响组件库正常使用。）</p>
<h2 data-id="heading-2">3. 快速开始</h2>
<h3 data-id="heading-3">3.1. 安装</h3>
<ol>
<li>NPM 方式</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">npm i tdesign-uniapp
</code></pre>
<ol start="2">
<li>UNI_MODULES 方式</li>
</ol>
<p>已上传<a href="https://link.juejin.cn?target=https%3A%2F%2Fext.dcloud.net.cn%2Fplugin%3Fid%3D25431" target="_blank" title="https://ext.dcloud.net.cn/plugin?id=25431" ref="nofollow noopener noreferrer">插件</a>到 DCloud 插件市场，请打开插件详情页并点击<code>使用 HBuilderX 导入插件</code>。</p>
<h3 data-id="heading-4">3.2. 引入并使用</h3>
<ol>
<li><code>main.ts</code> 中引入样式文件</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-string">'tdesign-uniapp/common/style/theme/index.css'</span>;
</code></pre>
<ol start="2">
<li>在文件中使用</li>
</ol>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">t-loading</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">TLoading</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'tdesign-uniapp/loading/loading.vue'</span>;
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-5">3.3. 自动导入</h3>
<p>在 <code>pages.json</code> 配置 <a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Fcollocation%2Fpages.html%23easycom" target="_blank" title="https://uniapp.dcloud.net.cn/collocation/pages.html#easycom" ref="nofollow noopener noreferrer">easycom</a>，可实现自动导入。</p>
<ol>
<li>CLI 模式</li>
</ol>
<p>使用 CLI 模式，即使用 <code>node_modules</code> 下的 <code>tdesign-uniapp</code> 时，配置如下。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"easycom"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"custom"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"^t-(.*)"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tdesign-uniapp/$1/$1.vue"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ol start="2">
<li>UNI_MODULES 模式</li>
</ol>
<p>使用 <code>uni_modules</code> 下的 <code>tdesign-uniapp</code> 时，配置如下。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"easycom"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"custom"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"^t-(.*)"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"@/uni_modules/tdesign-uniapp/components/$1/$1.vue"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-6">3.4. 平台兼容性</h3>



























<table><thead><tr><th>平台</th><th>Vue2</th><th>Vue3</th><th>H5</th><th>Android</th><th>iOS</th><th>App-nvue</th><th>微信小程序</th><th>QQ小程序</th></tr></thead><tbody><tr><td><strong>支持情况</strong></td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>⚠️</td><td>✅</td><td>✅</td></tr></tbody></table>























<table><thead><tr><th>平台</th><th>支付宝小程序</th><th>抖音小程序</th><th>百度小程序</th><th>快手小程序</th><th>小红书小程序</th><th>京东小程序</th></tr></thead><tbody><tr><td><strong>支持情况</strong></td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td></tr></tbody></table>
<h2 data-id="heading-7">4. 浅思考</h2>
<p>有几点是做之前要想清楚的。</p>
<h3 data-id="heading-8">4.1. 为什么不做转换工具</h3>
<ol>
<li>工具转出来的可读性差，可维护性差</li>
<li>转换工具无法做到100%，总有些语法需要手动转换。这意味着一定会有人工介入</li>
<li>维护转换工具成本比维护组件库高好几倍，且写出来的还不一定就能完全满足</li>
<li>业务真正要用的是组件库，真正关心的也是组件库</li>
</ol>
<h3 data-id="heading-9">4.2. 与 tdesign-miniprogram 版本关系</h3>
<p><code>tdesign-uniapp</code> 有独立的版本，并不与 <code>tdesign-miniprogram</code> 的版本相同。这是因为转换后的产物很有可能有自己的 <code>feature/bug</code>，处理需要发版，必然导致版本分叉。</p>
<p>多个 <code>tdesign-uniapp</code> 版本会对应一个 <code>tdesign-miniprogram</code> 版本，会尽量提供 <code>miniprogram</code>  最新版本的转换产物。</p>
<h3 data-id="heading-10">4.3. API 设计</h3>
<p>API 一定要与官方一致，这是最不能妥协的，包括 <code>props</code>、<code>events</code>、事件参数，参数类型、插槽、CSS变量。</p>
<p>这样做的好处是，开发者没有额外心智负担，同时限制开发人员的胡乱发挥，以及减少开发者的决策成本。</p>
<p>API 尽量与小程序对齐，而不是 <code>mobile-vue/mobile-react</code>，因为 <code>uniapp</code> 语法主要是小程序的语法。</p>
<h3 data-id="heading-11">4.4. 可维护性</h3>
<ul>
<li>用统一的语法</li>
<li>不使用编译后的、混淆后的变量</li>
</ul>
<h2 data-id="heading-12">5. 转化过程</h2>
<h3 data-id="heading-13">5.1. 核心转换逻辑</h3>
<p>之前写过 Press UI，整体思路差不多。就是将小程序的 <code>wxml/wxss/js/json</code> 转成 uniapp 的 Vue，四个文件合成一个文件。以及将小程序的语法进行转化，以下是核心部分：</p>
<ol>
<li>uniComponent 包裹，内部有一些公共处理</li>
<li>properties =&gt; props</li>
<li>setData =&gt; data 正常赋值</li>
<li>生命周期改造</li>
<li>事件改造</li>
<li>props 文件改造，from: <code>value: ([^{]+)</code>，to: <code>default: $1</code></li>
</ol>
<p>其他部分，如 <code>externalClasses</code>、<code>relations</code>，以及组件库特有的受控属性、命令调用等都需要进行额外的处理。</p>
<h3 data-id="heading-14">5.2. 事件参数</h3>
<p><code>tdesign-miniprogram</code> 中的事件参数，在 <code>tdesign-uniapp</code> 中都被去掉了 <code>detail</code> 一层。以 Picker 组件为例，在 <code>tdesign-miniprogram</code> 中，这样获取参数</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">onPickerChange</span>(<span class="hljs-params">e</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e.<span class="hljs-property">detail</span>.<span class="hljs-property">value</span>);
}
</code></pre>
<p>在 <code>tdesign-uniapp</code> 中，需要去掉 <code>.detail</code>，即</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">onPickerChange</span>(<span class="hljs-params">e</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e.<span class="hljs-property">value</span>);
}
</code></pre>
<p>这样做是为了简化使用。<code>tdesign-uniapp</code> 中所有组件都采用了这种方式。</p>
<h2 data-id="heading-15">6. 细节</h2>
<h3 data-id="heading-16">6.1. 命令调用</h3>
<p>tdesign-uniapp 中支持命令调用的组件有</p>
<ul>
<li>ActionSheet</li>
<li>Dialog</li>
<li>Message</li>
<li>Toast</li>
</ul>
<p>TDesign UniApp 下，命令调用的核心思路是数据转化，就是把所有 <code>props</code> 都声明成 <code>data</code>，比如 <code>visible</code> =&gt; <code>dataVisible</code>，这样组件自身才能既能从方法（<code>methods</code>）中得到值，又能从 <code>props</code> 中得到值。要改的地方包括</p>
<ol>
<li><code>data</code> 中初始化</li>
<li><code>watch</code> 中监听</li>
<li><code>setData</code> 收口，设置的时候都加上特殊开头</li>
</ol>
<p>每个组件具体实现不同。</p>
<ul>
<li>Message 嵌套了一层 <code>message-item</code>，<code>message-item</code> 没有 <code>props</code>，都是 <code>setData</code> 直接给的 <code>data</code>，所以根本不需要转换。
<ul>
<li>这是另一种解决思路了，用嵌套子组件，而不是转换数据。子组件一嵌套，且数据全部不走 <code>props</code>，而是调用子组件内部方法。</li>
<li>展示时， <code>setMessage</code>（组件调用、命令调用都走） =&gt; <code>addMessage</code> ( =&gt; <code>showMessageItem</code>) 或者 <code>updateMessage</code></li>
<li>Message 中的 <code>setMessage/addMessage/showMessageItem</code> 都是指的内部的 <code>message-item</code>，是循环的 <code>messageList</code>，而不是页面级别的 <code>t-message</code></li>
</ul>
</li>
<li>Dialog、ActionSheet 需要转换
<ul>
<li>调用 <code>setData</code>，将属性（包含 <code>visible: true</code>）传进去，同时将 <code>instance</code> 的 <code>_onConfirm</code> 设置为 <code>promise</code> 的 <code>resolve</code></li>
</ul>
</li>
<li>Toast 没有组件调用，只有命令式，无需数据转换。
<ul>
<li>调用 <code>instance.show</code>，内部还是 <code>setData</code></li>
</ul>
</li>
</ul>
<h3 data-id="heading-17">6.2. 受控属性</h3>
<p>存在受控属性的非表单组件有</p>
<ul>
<li>反馈类：ActionSheet、DropdownItem、Guide</li>
<li>展示类：CheckTag、Collapse、Image-viewer</li>
<li>导航类：Indexes、Sidebar、Steps、Tabbar、Tabs</li>
</ul>
<p>TDesign UniApp 中受控属性的处理，和小程序版本差不多。是将其转成 <code>data</code> 开头的内部属性，初始化的时候，会判断受控和非受控值。同时触发事件的时候也要判断当前是否存在受控属性，非受控的时候直接改变内部值并抛出事件，受控的时候只抛出事件。以及，<code>props</code> 中受控属性的默认值需是 <code>null</code> 或 <code>undefined</code>。</p>
<p>不同的是，小程序受控属性，可以使用 <code>this.setData({ [value]: this.defaultValue })</code>，也就是 <code>data</code> 中声明了一个和 <code>properties</code> 名称一样的变量，Vue 中不可以，会报错 <code>'set' on proxy: trap returned falsish for property 'value'</code></p>
<p>总结下来，受控属性要处理的：</p>
<ol>
<li><code>watch</code> 中监听</li>
<li><code>created</code> 中初始化</li>
<li><code>methods</code> 中新增 <code>_trigger</code>，作为抛出事件的收口</li>
</ol>
<h3 data-id="heading-18">6.3. 三方库</h3>
<p><code>tdesign-miniprogram</code> 执行 <code>npm run build</code>，在 <code>miniprogram_dist/node_modules</code> 目录下 拿到 <code>dayjs</code> 和 <code>tinycolor2</code> 的产物，复制到 <code>tdesign-uniapp</code> 的 <code>npm</code> 目录下，用啥拿啥
。</p>
<p>一次性工作，一般不会改。</p>
<h3 data-id="heading-19">6.4. input 受控</h3>
<p>H5 下，uni-app 封装了 <code>input</code>，且不支持受控。</p>
<p>Input 限制中文字符在 uni-app 实现的话，解决方案是先设置一次，然后在 <code>nextTick</code> 中再设置一次。</p>
<p>参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fask.dcloud.net.cn%2Farticle%2F39736" target="_blank" title="https://ask.dcloud.net.cn/article/39736" ref="nofollow noopener noreferrer">ask.dcloud.net.cn/article/397…</a></p>
<p>其他方案：</p>
<ol>
<li>可以动态创建 <code>input</code> 元素，不用 uni-app 包裹的，缺点是更新属性麻烦。</li>
<li>动态计算 <code>maxlength</code>，用浏览器原生属性约束，缺点是实现稍复杂、代码量稍多。</li>
</ol>
<h3 data-id="heading-20">6.5. externalClass</h3>
<p>uni-app 下，<code>externalClasses</code> 是不生效的。</p>
<p>参考：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdcloudio%2Funi-app%2Fissues%2F3275" target="_blank" title="https://github.com/dcloudio/uni-app/issues/3275" ref="nofollow noopener noreferrer">github.com/dcloudio/un…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fask.dcloud.net.cn%2Fquestion%2F163695" target="_blank" title="https://ask.dcloud.net.cn/question/163695" ref="nofollow noopener noreferrer">ask.dcloud.net.cn/question/16…</a></li>
</ul>
<p>所以 <code>styleIsolation: apply-shared</code> 不够用，以只能改成 <code>styleIsolation: shared</code>，这样开发者才能在任意使用的地方覆盖组件样式。</p>
<p>可以改下 <code>packages/site/node_modules/@dcloudio/uni-mp-compiler/dist/transforms/transformComponent.js</code>，把 <code>isComponentProp</code> 方法，将 <code>t-class</code> 排除，就能解决，但是官方不会推出。</p>
<h3 data-id="heading-21">6.6. scoped</h3>
<p>tdesign-uniapp 必须加 <code>scoped</code>，否则一个自定义组件加了 <code>styleIsolation: shared</code>，同一页面下其他没加此属性的自定义组件也会生效，只要 <code>class</code> 相同！</p>
<h3 data-id="heading-22">6.7. t-class</h3>
<p>统一用 <code>tClass</code>，而不是 <code>class</code>。</p>
<img src="https://cdn.uwayfly.com/article/2025/10/own_mike_bR3Jm86QaWDeWRdD.png" width="600" alt="转存失败，建议直接上传图片文件" loading="lazy"/>
<h3 data-id="heading-23">6.8. distanceTop</h3>
<p>Drawer 顶部过高，是因为子组件 <code>popup</code> 中使用的 <code>--td-popup-distance-top</code> 变量为 <code>0</code>，这个变量由 <code>distanceTop</code> 生成，<code>distanceTop</code> 又是由 <code>using-custom-navbar</code> 这个 <code>mixin</code> 生成。</p>
<p><code>distanceTop</code> 由 <code>uni.getMenuButtonBoundingClientRect</code> 计算生成，H5 和 App 下没有这个API，可以直接传入 <code>customNavbarHeight</code>，这个值由业务自行计算得到。</p>
<p>目前使用到 <code>using-custom-navbar</code> 这个 <code>mixin</code> 的组件有</p>
<ul>
<li>Overlay，基础，使用到它的也会引用
<ul>
<li>Popup</li>
<li>Picker</li>
<li>ActionSheet</li>
<li>Calendar</li>
<li>Dialog</li>
<li>Drawer</li>
<li>Guide</li>
<li>Toast</li>
</ul>
</li>
<li>Fab</li>
<li>ImageViewer</li>
</ul>
<h3 data-id="heading-24">6.9. page-scroll</h3>
<p>APP-PLUS 下，动态监听 <code>onPageScroll</code> 不生效，需要业务自己在页面中监听，下面给出最佳实践之一。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 页面 Vue 文件下，引入组件库提供的监听方法</span>
<span class="hljs-comment">// 该方法内部会通过 event-bus，传递参数给对应的组件</span>
<span class="hljs-keyword">import</span> { handlePageScroll } <span class="hljs-keyword">from</span> <span class="hljs-string">'tdesign-uniapp/mixins/page-scroll'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">onPageScroll</span>(<span class="hljs-params">e</span>) {
    <span class="hljs-title function_">handlePageScroll</span>(e);
  },
}
</code></pre>
<p>目前使用到 <code>page-scroll</code> 这个 <code>mixin</code> 的组件有</p>
<ol>
<li>Sticky</li>
<li>Indexes</li>
<li>Tabs(引入了 Sticky)</li>
</ol>
<p>示例页面有</p>
<ul>
<li>Fab</li>
<li>PullDownRefresh</li>
</ul>
<h3 data-id="heading-25">6.10. getCustomNavbarHeight 报错</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function">Cannot read properties of <span class="hljs-title">null</span> <span class="hljs-params">(reading <span class="hljs-string">'parentElement'</span>)</span>
</span></code></pre>
<img src="https://cdn.uwayfly.com/article/2025/10/own_mike_ycz2zafE5BbMiDDs.png" width="600" alt="转存失败，建议直接上传图片文件" loading="lazy"/>
<p>这种就是 <code>mounted</code> 之后没延时，没获取到对应元素。</p>
<h3 data-id="heading-26">6.11. site 工程中的 alias</h3>
<p>tdesign-uniapp 在 H5 下使用 <code>vite.config</code> 中的 <code>alias</code>，不使用 <code>workspace</code>，可解决修改组件后必须重启才能生效。</p>
<p>小程序下，这种方式需要进一步改造，只能引用同一个子工程，即不能跨 <code>src</code>，解决方案就是监听组件变动，同步复制到 <code>site</code> 工程下。</p>
<h3 data-id="heading-27">6.12. watch</h3>
<p>小程序的 <code>observers</code> 和 <code>vue</code> 的 <code>watch</code> 逻辑并不完全相同，小程序下，如果 <code>prop</code> 接收外部传入的实参与该 <code>prop</code> 的默认值不相等时，会导致 <code>observer</code> 被立即调用一次，Vue 而不是。</p>
<p><code>image</code> 中 <code>calcSize</code> 中就用到了。</p>
<h3 data-id="heading-28">6.13. auto-import</h3>
<p>开发了 auto-import-resolver 插件，但是发现微信小程序下编译有问题，H5 下正常，推测是 uniapp 自己的问题。</p>
<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/11/own_mike_PEGTWZzYiQR36r7C.png" width="400" alt="转存失败，建议直接上传图片文件" loading="lazy"/>
<p>可以使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Fcollocation%2Fpages.html%23easycom" target="_blank" title="https://uniapp.dcloud.net.cn/collocation/pages.html#easycom" ref="nofollow noopener noreferrer">easycom</a> 模式。</p>
<p>⚠️ 注意，<code>easycom</code> 不支持 <code>TIcon</code> 这种大驼峰，只能是 <code>t-icon</code>，这种中划线形式。</p>
<h3 data-id="heading-29">6.14. visible</h3>
<p>下面几个组件在关闭时，需要父组件中设置 <code>visible</code> 为 <code>false</code>，否则无法再次开启。也就是 <code>visible</code> 只能是受控的。可以给 <code>visible</code> 属性增加 <code>v-model</code> 语法糖。</p>
<ul>
<li>drawer</li>
<li>cascader</li>
<li>calendar</li>
<li>date-time-picker</li>
<li>color-picker</li>
</ul>
<h2 data-id="heading-30">7. 支付宝小程序</h2>
<h3 data-id="heading-31">7.1. styleIsolation</h3>
<p>支付宝小程序只支持在 <code>json</code> 文件中配置 <code>styleIsolation</code>，参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fopendocs.alipay.com%2Fmini%2Fframework%2Fcomponent-template%23%25E8%2587%25AA%25E5%25AE%259A%25E4%25B9%2589%25E7%25BB%2584%25E4%25BB%25B6%25E6%25A0%25B7%25E5%25BC%258F%25E9%259A%2594%25E7%25A6%25BB" target="_blank" title="https://opendocs.alipay.com/mini/framework/component-template#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%84%E4%BB%B6%E6%A0%B7%E5%BC%8F%E9%9A%94%E7%A6%BB" ref="nofollow noopener noreferrer">文档</a>。</p>
<p>uni-app 会静态分析组件中的 <code>styleIsolation</code> 配置，放到组件对应的 <code>json</code> 文件中。源码地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdcloudio%2Funi-app%2Ftree%2Fnext%2Fpackages%2Funi-mp-vite%2Fsrc%2Fplugins%2Fentry.ts" target="_blank" title="https://github.com/dcloudio/uni-app/tree/next/packages/uni-mp-vite/src/plugins/entry.ts" ref="nofollow noopener noreferrer">packages/uni-mp-vite/src/plugins/entry.ts</a>。</p>
<p>正则表达式如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> styleIsolationRE = [
  <span class="hljs-regexp">/defineOptions\s*[\s\S]*?styleIsolation\s*:\s*['"](isolated|apply-shared|shared)['"]/</span>,
  <span class="hljs-regexp">/export\s+default\s+[\s\S]*?styleIsolation\s*:\s*['|"](isolated|apply-shared|shared)['|"]/</span>,
]
</code></pre>
<p>所以，不能用 <code>uniComponent</code> 在运行时添加，只能在 Vue 中显式声明。</p>
<h3 data-id="heading-32">7.2. background</h3>
<p>Stepper 中需显式声明 background 和 padding。</p>
<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/11/own_mike_Hce7tsxzWisb4MXZ.png" width="500" alt="转存失败，建议直接上传图片文件" loading="lazy"/>
<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/11/own_mike_J8YPSmdtHBtKPQAs.png" width="500" alt="转存失败，建议直接上传图片文件" loading="lazy"/>
<p>Search 中同样问题。</p>
<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/11/own_mike_nPmaDZpdMnwrxGjm.png" width="500" alt="转存失败，建议直接上传图片文件" loading="lazy"/>
<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/11/own_mike_bBmbPbAYx7R8abDf.png" width="500" alt="转存失败，建议直接上传图片文件" loading="lazy"/>
<h3 data-id="heading-33">7.3. disable-scroll</h3>
<p>滚动穿透问题，uniapp 有<a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Ftutorial%2Fvue3-basics.html%23%25E4%25BA%258B%25E4%25BB%25B6%25E4%25BF%25AE%25E9%25A5%25B0%25E7%25AC%25A6" target="_blank" title="https://uniapp.dcloud.net.cn/tutorial/vue3-basics.html#%E4%BA%8B%E4%BB%B6%E4%BF%AE%E9%A5%B0%E7%AC%A6" ref="nofollow noopener noreferrer">通用方案</a> <code>@touchmove.stop.prevent="noop"</code>，支付宝下无效，需要设置 <code>disable-scroll</code>。参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fopendocs.alipay.com%2Fsupport%2F01rb9a" target="_blank" title="https://opendocs.alipay.com/support/01rb9a" ref="nofollow noopener noreferrer">文档</a>。</p>
<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/11/own_mike_Rs2z2SHDRnm4a4aa.png" width="600" alt="转存失败，建议直接上传图片文件" loading="lazy"/>
<p>⚠️ 注意，设置 <code>disable-scroll</code> 为 <code>true</code> 后，所有子元素的滚动都不能冒泡了，即便子元素设置的 <code>disable-scroll</code> 为 <code>false</code>，所以也尽可能减少 <code>disable-scroll</code> 属性的覆盖范围。</p>
<h3 data-id="heading-34">7.4. :deep 编译问题</h3>
<p>避免 <code>less</code> 中两个 <code>:deep</code> 嵌套，其中一个不会被转化。</p>
<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/11/own_mike_t6jQCkeSjhYc2AYz.png" width="500" alt="转存失败，建议直接上传图片文件" loading="lazy"/>
<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/11/own_mike_D643Bm7WjzhQX3jc.png" width="500" alt="转存失败，建议直接上传图片文件" loading="lazy"/>
<h3 data-id="heading-35">7.5. scroll-view</h3>
<p>微信小程序 <code>scroll-view</code>，宽度 <code>100%</code>。支付宝小程序不是，需手动设置，不设置的话，撑不开。</p>
<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/11/own_mike_RYRrXDTrmrSdmCMh.png" width="500" alt="转存失败，建议直接上传图片文件" loading="lazy"/>
<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/11/own_mike_NpK4EZ3p78tsQNda.png" width="500" alt="转存失败，建议直接上传图片文件" loading="lazy"/>
<h2 data-id="heading-36">8. 抖音小程序</h2>
<h3 data-id="heading-37">8.1. virtualHost</h3>
<p>遇到一个点击事件不能传递的问题，排查下来以为是不能用 <code>uniComponent</code> 包裹，猜测其内部会静态检测 <code>js</code> 文件。后面发现是不能使用 <code>virtualHost: true</code>，不止 <code>button</code> 组件，其他组件也不一样。</p>
<h3 data-id="heading-38">8.2. 样式穿透</h3>
<p>抖音小程序原生的话，可以用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.open-douyin.com%2Fdocs%2Fresource%2Fzh-CN%2Fmini-app%2Fdevelop%2Ftutorial%2Fcustom-component%2Fcomponent-model-and-style%23a6c4373d" target="_blank" title="https://developer.open-douyin.com/docs/resource/zh-CN/mini-app/develop/tutorial/custom-component/component-model-and-style#a6c4373d" ref="nofollow noopener noreferrer">externalClasses</a> 来进行样式覆盖，但是前面提到过 uni-app 不支持。</p>
<p>它也不支持标签选择器，加上刚说的不能用 <code>virtualHost: true</code>，所以它的样式穿透是最麻烦的。</p>
<p>解决方案是，根据具体情况，对 <code>class/t-class/style/custom-style</code> 这些属性区分平台处理，比如</p>
<ul>
<li>DropdownItem 组件中，<code>btn</code> 用了 <code>class/t-class</code> 区分，<code>radio-group/checkbox-group</code> 用了 <code>custom-style</code></li>
<li>AvatarGroup 组件中，<code>avatar</code> 用了 <code>setStyle</code>（<code>children</code> 获取），因为 <code>avatar</code> 是外部定义的，无法用 <code>custom-style</code></li>
<li>涉及到伪类的只能用 <code>class</code>，不能用 <code>custom-style</code></li>
</ul>
<h3 data-id="heading-39">8.3. 父子关系</h3>
<p>抖音小程序给两个组件绑定父子关系也是最复杂的，其他小程序及H5可以通过 <code>provide/inject</code> 来收集 <code>parent</code>，抖音小程序中找不到（下面部分截图是放的 PressUI 组件库的）。</p>
<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/6/own_mike_HHa8HeNminHbpC3j.png" width="600" alt="转存失败，建议直接上传图片文件" loading="lazy"/>
<p>这里想到一个办法是递归调用 <code>$parent</code>，找最近的一个和目标组件名称相同的 <code>parent</code>。比如 <code>picker-item</code> 中就找组件名称为 <code>TPicker</code> 最近的父组件。</p>
<p>但是，抖音小程序子孙组件的 <code>$parent</code> 竟然就是页面，页面的所有 <code>$children</code> 都是拉平的。基于此，想到的办法是从上往下遍历这个拉平的 <code>$children</code>，找距离子组件最近的一个父组件。</p>
<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/6/own_mike_bmwwwRjGpQYYHhf8.png" width="600" alt="转存失败，建议直接上传图片文件" loading="lazy"/>
<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/6/own_mike_XSEkhMDNRdNmXEDp.png" width="600" alt="转存失败，建议直接上传图片文件" loading="lazy"/>
<p>但是，页面的 <code>$children</code> 并不是"父子父子父子.."这样顺序排列的，而是"父父父子子子..."，导致 <code>$children</code> 收集有问题，要么多于实际，要么为空。</p>
<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/6/own_mike_b6aXQpMmPxh3naGG.png" width="600" alt="转存失败，建议直接上传图片文件" loading="lazy"/>
<p>想到的办法是父子组件之间传递一个 <code>relationKey</code>，这个值是唯一的，找 <code>$parent</code> 时就不会找错了。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">findNearListParent</span>(<span class="hljs-params">children = [], name</span>) {
  <span class="hljs-keyword">let</span> temp;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> item <span class="hljs-keyword">of</span> children) {
    <span class="hljs-keyword">const</span> parentRelationKey = item.<span class="hljs-property">$props</span>?.<span class="hljs-property">relationKey</span>;
    <span class="hljs-keyword">const</span> thisRelationKey = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$props</span>?.<span class="hljs-property">relationKey</span>;
    <span class="hljs-keyword">if</span> (item.<span class="hljs-property">$options</span>.<span class="hljs-property">name</span> === name &amp;&amp; parentRelationKey === thisRelationKey) {
      temp = item;
    }
    <span class="hljs-keyword">if</span> (item === <span class="hljs-variable language_">this</span> &amp;&amp; temp) {
      <span class="hljs-keyword">return</span> temp;
    }
  }

  <span class="hljs-keyword">return</span> temp;
}
</code></pre>
<p>上面的 <code>relationKey</code> 应该永远从业务传入。内部组件，不管父子，都只接受 <code>props</code>，不自己生产，减少复杂度。这样的话，不管用 <code>slot</code>， <code>&lt;x&gt;&lt;x-item&gt;&lt;/x&gt;</code> 还是用一个 <code>&lt;x&gt;</code>，都能保证 <code>relationKey</code> 同一个，且不论空还是不空，都是相等的。</p>
<p>此外，还有这种游离在依赖树之外的 <code>vm</code> 实例，也拿不到 <code>provide</code> 的值。</p>
<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/11/own_mike_DZRyKmZBRZRA2B6k.png" width="600" alt="转存失败，建议直接上传图片文件" loading="lazy"/>
<p>这种主要发生在 Popup 组件内部的父子关系，比如 <code>dropdown-menu</code> 组件中的 <code>radio-group/radio</code>、 <code>cascader</code> 组件 <code>tab</code> 模式的 <code>tabs/tab-panel</code>。</p>
<p>这种问题的一个解决方案是在使用它们的地方手动关联。</p>
<h3 data-id="heading-40">8.4. 生命周期</h3>
<p>Vue 中父子组件生命周期正常的执行顺序是：父组件先创建，然后子组件创建；子组件先挂载，然后父组件挂载，即“父beforeCreate-&gt; 父create -&gt; 子beforeCreate-&gt; 子created -&gt; 子mounted -&gt; 父mounted”。</p>
<p>抖音小程序并不遵循这样的规律。</p>
<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/6/own_mike_8rXrNdH7m6fmAaSd.png" width="600" alt="转存失败，建议直接上传图片文件" loading="lazy"/>
<p>这个问题会导致父子组件的初始化数据出问题，之前在父组件 <code>mounted</code> 中执行的初始逻辑，都会因为还没收集完 <code>children</code>，而失败。</p>
<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/6/own_mike_d3M8XdYzTBxHSRzh.png" width="370" alt="转存失败，建议直接上传图片文件" loading="lazy"/>
<p>解决办法有两种，可用延时，也可用回调。回调更安全，延时可能跟机器性能有关。回调就是在子组件 <code>mounted</code> 的时候调用父组件的数据初始化方法。</p>
<h2 data-id="heading-41">9. 其他</h2>
<h3 data-id="heading-42">9.1. 最简单的</h3>
<p><code>button</code> 不是最简单的，<code>loading/icon</code> 才是最简单的，它们是 <code>button</code> 的子元素。</p>
<h3 data-id="heading-43">9.2. 组件归类</h3>
<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/11/own_mike_4fNtPMKtDajWBTyW.png" width="600" alt="转存失败，建议直接上传图片文件" loading="lazy"/>
<p>导航类</p>
<ul>
<li>Navbar、Tabbar、Sidebar、Indexes 分别是上下左右四个方向的导航，固定</li>
<li>Drawer、BackTop 都是可隐藏的，点击某处或滑动到某处时才显示</li>
<li>Tabs 是业务中最常用的导航类组件，Steps 比 Tabs 更苛刻，有顺序，这两都以 <code>s</code> 结尾</li>
</ul>
<p>反馈类</p>
<ul>
<li>Overlay、Popup、Loading 基础</li>
<li>Message、Toast、Dialog、NoticeBar 是一类，Message 上+动态，Toast 中间，Dialog 中间，更重，NoticeBar 上+固定</li>
<li>DropdownMenu、ActionSheet 一个从上往下显示，一个从下往上</li>
<li>SwipeCell，PulldownRefresh 一个向左滑，一个向下滑</li>
<li>Guide 特殊，全局，其他的都是局部</li>
</ul>
<p>输入类</p>
<ul>
<li>Input、Textarea、Search，文字输入</li>
<li>Radio、Checkbox、Switch，点击选择</li>
<li>Stepper、Slider，数字选择（输入）一个是点击，一个是滑动</li>
<li>Picker，Cascader、TreeSelect，滑动选择</li>
<li>Calendar、DatetimePicker，特殊场景</li>
<li>ColorPicker，特殊场景</li>
<li>Rate，特殊场景</li>
<li>Upload，特殊场景</li>
</ul>
<h3 data-id="heading-44">9.3. 野蛮生长</h3>
<p>只有流量大的、用户多的APP，才可能有小程序。国内小程序生态百花齐放，没有两个是完全一样的。每一种小程序框架、文档、运营平台、开发者工具、审核等都需要不少的工作量、不少的人力。看得出来中国互联网过去几年发展的可以。</p>
<h3 data-id="heading-45">9.4. 图标</h3>
<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/11/own_mike_4mZKcT6zYQNyJjrB.png" width="600" alt="转存失败，建议直接上传图片文件" loading="lazy"/>
<p>上面是几个小程序开发者工具的图标</p>
<ul>
<li>微信/qq、支付宝、百度（BAT）</li>
<li>抖音、快手、小红书（分享社区）</li>
<li>京东</li>
</ul>
<p>有意思的是，大家想的都差不多</p>
<ol>
<li>体现连接
<ul>
<li>抖音，平面</li>
<li>京东，立体</li>
<li>快手，横向</li>
<li>百度，中间</li>
</ul>
</li>
<li>代码符号
<ul>
<li>支付宝</li>
<li>小红书</li>
<li>微信（结合了自己的 logo）</li>
</ul>
</li>
<li>产品 logo 变形
<ul>
<li>QQ</li>
<li>微信</li>
</ul>
</li>
</ol>
<h3 data-id="heading-46">9.5. wxComponent</h3>
<p><code>tdesign-miniprogram</code> 中 <code>wxComponent</code> 类的作用：</p>
<ol>
<li>属性，处理受控属性，增加 <code>default*</code> 属性的默认值，增加 <code>style/customStyle</code> 属性，增加 <code>aria*</code> 相关属性</li>
<li><code>externalClasses</code>，增加 <code>class</code></li>
<li>方法，增加 <code>_trigger</code>，兼容受控情况下的抛出事件，非生命周期函数挂载在 <code>methods</code> 对象上</li>
<li>生命周期函数放到 <code>lifetimes</code> 上</li>
</ol>
<h3 data-id="heading-47">9.6. uni-app</h3>
<p><code>src/core/runtime/mp/polyfill/index.js</code></p>
<p>uni-app 中运行时对 <code>vant-weapp</code> 的 <code>polyfill</code> 核心逻辑</p>
<h3 data-id="heading-48">9.7. data</h3>
<p><strong>只要不在模板中使用</strong>，<code>data</code> 不用提前声明，<code>created</code> 中动态声明即可</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title function_">created</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">xxx</span> = <span class="hljs-string">'xxx'</span>;
}
</code></pre>
<h3 data-id="heading-49">9.8. Slider 组件细节</h3>
<p>前置变量：</p>
<ul>
<li><code>initLeft = boxLeft - halfblock</code></li>
<li><code>initRight  = boxRight - halfblock</code></li>
<li><code>maxRange = boxRight - boxLeft - blockSize - 6</code> ( 6 是边框)</li>
</ul>
<p><code>capsule</code> 模式下：</p>
<ol>
<li>左边滑块滑动，<code>offset = blockSize + 3</code>，<code>currentLeft = clientLeft - initLeft - offset</code>，就是 <code>clientLeft - boxLeft - halfBlock - 3</code></li>
<li>右边滑动滑动，<code>offset = - 3</code>，<code>currentIRight = -(clientRight - initRight - offset)</code>，就是 <code>boxRight - clientRight - halfBlock - 3</code></li>
</ol>
<p>假设 <code>boxLeft = 0</code>，<code>boxRight = 100</code>, <code>halfBlock = 10</code>,</p>
<ul>
<li>左就是 <code>clientLeft - 13</code>，左边最小是 13</li>
<li>右就是 <code>87 - clientRight</code>，右边最大是 87</li>
<li><code>maxRange</code> 就是 74</li>
</ul>
<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2025/11/own_mike_mDk26PEERn43wxNX.png" width="600" alt="转存失败，建议直接上传图片文件" loading="lazy"/>
<p>图中分别是左、右、边框。</p>
<h2 data-id="heading-50">10. 反馈</h2>
<p>有任何问题，建议通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnovlan1%2Ftdesign-uniapp%2Fissues" target="_blank" title="https://github.com/novlan1/tdesign-uniapp/issues" ref="nofollow noopener noreferrer">Github issues</a> 反馈或扫码加入用户微信群。</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63498e2781ab4e579729750e6b64da03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTm92bGFuMQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763562060&amp;x-signature=j%2F2Hf477esVpaNObMGgj4Qhr%2Ba8%3D" width="200" loading="lazy"/>
<h2 data-id="heading-51">11. 总结</h2>
<blockquote>
<p>TDesign is an artwork.</p>
</blockquote>
<p>向 TDesign 的开发者致敬🫡。</p>
<p>后续规划是</p>
<ol>
<li>同步 TDesign Miniprogram 改动，尽量在小程序版本发布后的一周内，同步改动到 uniapp 版本上</li>
<li>兼容调试更多平台</li>
<li>模板工程等</li>
</ol>
<hr/>
<p>注，本文发布于非工作时间。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[腾讯KaLM-Embedding：AI多语言理解的全球新篇章]]></title>    <link>https://juejin.cn/post/7571657746346475574</link>    <guid>https://juejin.cn/post/7571657746346475574</guid>    <pubDate>2025-11-12T14:22:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571657746346475574" data-draft-id="7571646669202194474" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="腾讯KaLM-Embedding：AI多语言理解的全球新篇章"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-11-12T14:22:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            腾讯KaLM-Embedding：AI多语言理解的全球新篇章
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T14:22:28.000Z" title="Wed Nov 12 2025 14:22:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在人工智能飞速发展的今天，跨语言的无缝沟通与深度理解，无疑是通向真正通用智能的必经之路。而最近，来自腾讯微信团队的一项突破性成果——KaLM-Embedding模型，如同在多语言AI领域点亮了一盏明灯，在权威的MTEB多语言评测基准中斩获全球第一，标志着我们在破解语言壁垒的道路上又迈出了坚实的一步。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-12_21.41.44-1024x541.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-12_21.41.44-1024x541.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcf8121ba44a46bbb924936e0bf380e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763562147&amp;x-signature=%2FkZqvzQRa%2F3RFobQ6DXGrgjruiE%3D" alt="iShot_2025-11-12_21.41.44" loading="lazy"/></a></p>
<p>这个名为KaLM-Embedding-Gemma3-12B-2511的模型，其名字虽略显技术化，却掩盖不住其背后所蕴含的强大力量。它并非仅仅在几项任务中表现突出，而是在一个涵盖了全球1038种语言、131项复杂任务的庞大评测体系中，以平均任务得分72.32、平均任务类型得分62.51的惊人成绩，力压群雄。这其中，不仅包括了大家耳熟能详的NVIDIA Llama-Embed、阿里巴巴通义千问Qwen3-Embedding，甚至连谷歌的Gemini-Embedding-001也未能超越。想象一下，一个模型能够如此精准地理解和对齐全球近千种语言的语义，这无疑是一场语言智能的盛宴，为全球范围内的信息交互和知识传递打开了新的可能。</p>
<p>那么，腾讯团队是如何铸造出这把“语言魔法杖”的呢？其核心在于对“数据质量”和“训练策略”的极致追求。这款拥有120亿参数的模型，绝非简单地堆砌数据或增大模型规模。它采用了多阶段对比学习的精妙设计，让模型在不同语境下学习更鲁棒的语义表示；Embedding蒸馏技术的运用，则进一步提升了模型的泛化能力与效率；而模型参数融合的策略，更是让其在复杂的语义空间中找到了最佳的对齐方式。这些高阶的训练技巧，辅以经过深度清洗与筛选的海量高质量语料，共同确保了KaLM-Embedding能够提供高度可靠且一致的语义表示，从而在多语言任务中游刃有余。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-12_21.42.14-962x1024.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-12_21.42.14-962x1024.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c241e63751d840ccbdf82348b9d5deb7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763562147&amp;x-signature=YOowO9yDwY8ISARx77iKVoON5Ro%3D" alt="iShot_2025-11-12_21.42.14" loading="lazy"/></a></p>
<p>值得一提的是，KaLM-Embedding并非一个“一招鲜”的模型。它在应用支持上的灵活性令人印象深刻。模型支持从3840到64，共七个层级的向量维度选择。这意味着开发者可以根据具体的应用场景和计算资源限制，自由选择最合适的向量维度。无论是对精度要求极高的云端大型检索系统，还是对响应速度和内存占用有严格限制的移动端应用，KaLM-Embedding都能提供高效且适配的解决方案。这种兼顾高性能与高效率的设计哲学，无疑将极大地拓展其在产业界的实际应用边界。</p>
<p>Embedding模型，作为人工智能理解非结构化文本内容的核心技术，其重要性不言而喻。它能将复杂的文本信息转化为计算机可理解、可计算的高维向量，让“意义”变得可度量、可检索。在当前的AI浪潮中，高质量的Embedding模型更是成为了抑制大型语言模型“幻觉”现象的关键。在RAG（检索增强生成）等主流应用架构中，KaLM-Embedding能够从海量的知识库中进行超精准检索，为大模型动态构建高质量的上下文信息。这种“事实核查员”的角色，极大地提升了大模型生成结果的准确性和可靠性，有效避免了它们“一本正经地胡说八道”。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-12_21.43.19-1024x351.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-12_21.43.19-1024x351.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2aac950e5d4412aa2e48d2215fefbfd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763562147&amp;x-signature=Gwc45IJLxwWrog5OY0WCdmGCKTI%3D" alt="iShot_2025-11-12_21.43.19" loading="lazy"/></a></p>
<p>然而，KaLM-Embedding的应用前景远不止于RAG。其强大的多语言语义理解能力，使其能够广泛应用于文本分类、语义匹配、信息聚类、搜索推荐等多个领域。设想一下，一个能够精准理解不同国家用户查询意图的全球电商平台，或者一个能将不同语种新闻自动分类归纳的智能内容管理系统，又或者是一个能根据用户多语言浏览历史推荐内容的智能推荐引擎——这些都将因KaLM-Embedding的加入而变得更加智能、高效。它不仅是提升现有AI系统性能的“加速器”，更是催生全新应用场景的“孵化器”，真正将AI带入一个“语出必达”的新时代。</p>
<p>更令人欣喜的是，腾讯将这款领先全球的模型以MIT许可证在Hugging Face平台开源，支持商业用途。这不仅体现了腾讯在AI领域开放合作的胸怀，更是对全球AI社区发展的一大贡献。通过开放模型获取渠道和技术论文，KaLM-Embedding有望被更广泛的开发者和研究者所采纳、研究和应用，从而加速多语言AI技术的普及和迭代。这种开放生态的建设，对于推动整个行业向前发展，具有深远的意义。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-12_21.44.19-1024x785.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-12_21.44.19-1024x785.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ba2e85f3bfc414f90334fd8f0c66e37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763562147&amp;x-signature=BSCaKj3bGZs2z4RE7bMYhfcqvts%3D" alt="iShot_2025-11-12_21.44.19" loading="lazy"/></a></p>
<p>回顾KaLM-Embedding的发布，我们不禁思考Embedding技术未来的走向。除了此次发布的120亿参数模型，团队此前开源的V2系列模型（0.5B参数量）也以在极小规模下实现卓越性能而备受关注，展现了腾讯在平衡模型规模与效率上的多样化探索。未来，Embedding技术很可能将继续沿着应用场景的扩展（从文本到多模态数据）、推理优化（动态分配计算资源以平衡速度与精度）以及训练技术演进（借助更强大的大模型合成高质量数据）的方向发展。而KaLM-Embedding无疑是这一激动人心的演进过程中的一个重要里程碑。它的成功不仅是腾讯的骄傲，更是全球AI领域在迈向多语言通用智能道路上的一个重要注脚。我们期待着，随着KaLM-Embedding的广泛应用，一个真正实现语言无界、信息共享的智能世界将加速到来。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React DevTools 组件名乱码？揭秘从开发到生产的代码变形记]]></title>    <link>https://juejin.cn/post/7571678763781652514</link>    <guid>https://juejin.cn/post/7571678763781652514</guid>    <pubDate>2025-11-12T14:34:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571678763781652514" data-draft-id="7571672422689488948" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React DevTools 组件名乱码？揭秘从开发到生产的代码变形记"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2025-11-12T14:34:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React DevTools 组件名乱码？揭秘从开发到生产的代码变形记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T14:34:55.000Z" title="Wed Nov 12 2025 14:34:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React DevTools 组件名乱码？聊聊代码压缩这件事</h2>
<p>线上打开 React DevTools，打开一看，组件树全是 <code>C0</code>、<code>$r</code>、<code>pv</code> 这种不可读的字符。</p>
<p>开发环境明明好好的，叫 <code>NavigationProvider</code>、<code>DialogPortal</code>，怎么到线上就全变了？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23fcd0708f5641e494aca20e819a15d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lmf5peg6aOO6Zuo5Lmf6Zu-5pm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763562895&amp;x-signature=9AyhGROp8t67XkehvUG1el%2BeKjw%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-1">问题出在哪</h3>
<p>简单说：<strong>生产构建时，代码被压缩了，函数名被改成了短字符。</strong></p>
<p>React DevTools 依赖函数名来显示组件名。函数名变了，显示的自然也就变了。</p>
<h4 data-id="heading-2">开发环境 vs 生产环境</h4>
<p><strong>开发环境</strong>：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}
</code></pre>
<p>React DevTools 显示：<code>NavigationProvider</code> ✅</p>
<p><strong>生产环境</strong>（压缩后）：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">pv</span>(<span class="hljs-params">{children:e}</span>){<span class="hljs-keyword">return</span> <span class="hljs-title function_">jsx</span>(<span class="hljs-title class_">Provider</span>,{<span class="hljs-attr">children</span>:e})}
</code></pre>
<p>React DevTools 显示：<code>pv</code> ❌</p>
<h3 data-id="heading-3">从开发到生产：代码都经历了什么</h3>
<p>要理解为什么会被压缩，先要知道我们写的代码是怎么变成用户访问的线上代码的。</p>
<h4 data-id="heading-4">开发模式：原汁原味</h4>
<p>用脚手架（Create React App、Vite）开发时，启动的是<strong>开发服务器</strong>。</p>
<pre><code class="hljs language-bash" lang="bash">npm run dev
<span class="hljs-comment"># 或</span>
npm start
</code></pre>
<p>这时候：</p>
<ul>
<li>代码实时编译，但<strong>不压缩</strong></li>
<li>保留完整的变量名、函数名</li>
<li>包含 Source Maps（方便调试）</li>
<li>有热更新（Hot Module Replacement）</li>
</ul>
<p>浏览器加载的代码长这样：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// http://localhost:3000/src/App.jsx</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">const</span> [location, setLocation] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}
</code></pre>
<p>清清楚楚，React DevTools 自然能读到 <code>NavigationProvider</code>。</p>
<h4 data-id="heading-5">生产构建：全面优化</h4>
<p>准备部署上线时，要执行构建命令：</p>
<pre><code class="hljs language-bash" lang="bash">npm run build
</code></pre>
<p>这一步会调用打包工具（Webpack、Vite、Rollup），做一系列优化：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[源代码&lt;br/&gt;多个 .jsx 文件] --&gt; B[编译&lt;br/&gt;JSX → JS]
    B --&gt; C[打包&lt;br/&gt;合并成少数文件]
    C --&gt; D[Tree Shaking&lt;br/&gt;删除未使用代码]
    D --&gt; E[压缩&lt;br/&gt;Minification]
    E --&gt; F[生产代码&lt;br/&gt;dist/main.abc123.js]
</code></pre>
<h5 data-id="heading-6">1. 编译（Transpilation）</h5>
<p>Babel 把 JSX 和现代 JS 语法转成浏览器能理解的代码。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 源代码</span>
&lt;<span class="hljs-title class_">Provider</span>&gt;{children}&lt;/<span class="hljs-title class_">Provider</span>&gt;

<span class="hljs-comment">// 编译后</span>
<span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-title class_">Provider</span>, <span class="hljs-literal">null</span>, children)
</code></pre>
<h5 data-id="heading-7">2. 打包（Bundling）</h5>
<p>把几十上百个文件合并成几个文件。</p>
<pre><code class="hljs language-css" lang="css">开发环境：
├── App<span class="hljs-selector-class">.jsx</span>
├── components/
│   ├── Navigation<span class="hljs-selector-class">.jsx</span>
│   ├── <span class="hljs-selector-tag">Header</span><span class="hljs-selector-class">.jsx</span>
│   └── <span class="hljs-selector-tag">Footer</span><span class="hljs-selector-class">.jsx</span>
└── utils/
    └── helpers<span class="hljs-selector-class">.js</span>

生产环境：
└── dist/
    └── <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.abc123</span><span class="hljs-selector-class">.js</span>  ← 全部合并
</code></pre>
<h5 data-id="heading-8">3. Tree Shaking</h5>
<p>删除没用到的代码。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">usedFunction</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* ... */</span> }
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">unusedFunction</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* ... */</span> }  <span class="hljs-comment">// 这个没被 import</span>

<span class="hljs-comment">// 打包后：unusedFunction 被删除</span>
</code></pre>
<h5 data-id="heading-9">4. 压缩（Minification）</h5>
<p><strong>这就是导致组件名乱码的关键步骤。</strong></p>
<p>压缩器（Terser、esbuild）把代码体积压到最小：</p>
<ul>
<li>删除空格、换行、注释</li>
<li>缩短变量名和函数名</li>
<li>简化代码逻辑</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 压缩前</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">const</span> [location, setLocation] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}

<span class="hljs-comment">// 压缩后</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">pv</span>(<span class="hljs-params">{children:e}</span>){<span class="hljs-keyword">const</span>[t,n]=<span class="hljs-title function_">useState</span>(<span class="hljs-string">"/"</span>);<span class="hljs-keyword">return</span> <span class="hljs-title function_">jsx</span>(<span class="hljs-title class_">Provider</span>,<span class="hljs-literal">null</span>,e)}
</code></pre>
<h4 data-id="heading-10">为什么生产环境要这么做</h4>
<p><strong>一个字：快。</strong></p>
<p>用户访问网站时：</p>
<ol>
<li>浏览器从服务器下载 JS 文件</li>
<li>解析代码</li>
<li>执行代码</li>
</ol>
<p><strong>如果不压缩</strong>：</p>
<ul>
<li>一个中型 React 应用，原始代码可能 2-3 MB</li>
<li>在 3G 网络下，下载要 20-30 秒</li>
<li>用户看到白屏，早跑了</li>
</ul>
<p><strong>压缩后</strong>：</p>
<ul>
<li>代码体积降到 500-800 KB</li>
<li>Gzip 压缩后可能只有 200 KB</li>
<li>下载时间缩短到 3-5 秒</li>
</ul>
<p>体积差异这么大，主要因为：</p>
<ul>
<li><strong>空格和换行</strong>：原始代码为了可读性，大量使用缩进和换行（占 20-30%）</li>
<li><strong>变量名和函数名</strong>：<code>NavigationProvider</code> → <code>pv</code> 这种压缩（占 30-40%）</li>
<li><strong>注释</strong>：开发时的注释在生产环境完全删除（占 5-10%）</li>
<li><strong>未使用的代码</strong>：Tree Shaking 删除（占 10-20%）</li>
</ul>
<p>所以，<strong>压缩是生产环境的必备步骤</strong>，不是可选项。</p>
<h4 data-id="heading-11">压缩在哪个阶段</h4>
<p>在 Webpack 或 Vite 的配置中，压缩是最后一步：</p>
<p><strong>Webpack 配置</strong>（简化版）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
    <span class="hljs-attr">mode</span>: <span class="hljs-string">'production'</span>,  <span class="hljs-comment">// 自动启用压缩</span>

    <span class="hljs-attr">optimization</span>: {
        <span class="hljs-attr">minimize</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 开启压缩</span>
        <span class="hljs-attr">minimizer</span>: [
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">TerserPlugin</span>(),  <span class="hljs-comment">// 使用 Terser 压缩</span>
        ],
    },
};
</code></pre>
<p><strong>Vite 配置</strong>（简化版）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    <span class="hljs-attr">build</span>: {
        <span class="hljs-attr">minify</span>: <span class="hljs-string">'terser'</span>,  <span class="hljs-comment">// 使用 Terser 压缩（默认是 esbuild）</span>
    },
};
</code></pre>
<p>当你执行 <code>npm run build</code>，打包工具会：</p>
<ol>
<li>编译所有源文件</li>
<li>合并成几个大文件</li>
<li><strong>最后调用压缩器处理</strong></li>
<li>输出到 <code>dist/</code> 目录</li>
</ol>
<p>压缩是<strong>构建流程的最后一步</strong>，产出的就是上线的代码。</p>
<h4 data-id="heading-12">开发和生产的环境区别</h4>













































<table><thead><tr><th>特性</th><th>开发环境</th><th>生产环境</th></tr></thead><tbody><tr><td>命令</td><td><code>npm run dev</code></td><td><code>npm run build</code></td></tr><tr><td>代码压缩</td><td>❌</td><td>✅</td></tr><tr><td>变量名</td><td><code>NavigationProvider</code></td><td><code>pv</code></td></tr><tr><td>文件体积</td><td>2-3 MB</td><td>500-800 KB</td></tr><tr><td>Source Maps</td><td>✅ 完整</td><td>❌ 或隐藏</td></tr><tr><td>调试体验</td><td>轻松</td><td>困难</td></tr><tr><td>加载速度</td><td>慢（本地不care）</td><td>快（关键指标）</td></tr></tbody></table>
<p>现在明白了：<strong>开发时你写的清晰代码，到用户那里已经面目全非</strong>。</p>
<p>而组件名乱码，就是这个"面目全非"的副作用。</p>
<h3 data-id="heading-13">为什么要压缩函数名</h3>
<p>理解了背景，再看具体的压缩逻辑就清楚了。</p>
<p><strong>减小文件体积，加快加载速度。</strong></p>
<p>压缩器做的事：</p>
<ol>
<li><strong>删除空格和换行</strong></li>
<li><strong>缩短变量名</strong>：<code>userName</code> → <code>u</code></li>
<li><strong>缩短函数名</strong>：<code>NavigationProvider</code> → <code>pv</code></li>
<li><strong>简化代码结构</strong></li>
</ol>
<p>看个真实例子：</p>
<p><strong>压缩前</strong>（15 KB）：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">const</span> [location, setLocation] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">navigate</span> = (<span class="hljs-params">path</span>) =&gt; {
        <span class="hljs-title function_">setLocation</span>(path);
    };

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Context.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">location</span>, <span class="hljs-attr">navigate</span> }}&gt;</span>
            {children}
        <span class="hljs-tag">&lt;/<span class="hljs-name">Context.Provider</span>&gt;</span></span>
    );
}
</code></pre>
<p><strong>压缩后</strong>（4 KB）：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">pv</span>(<span class="hljs-params">{children:e}</span>){<span class="hljs-keyword">const</span>[t,n]=<span class="hljs-title function_">useState</span>(<span class="hljs-string">"/"</span>);<span class="hljs-keyword">return</span> <span class="hljs-title function_">jsx</span>(<span class="hljs-title class_">Context</span>.<span class="hljs-property">Provider</span>,{<span class="hljs-attr">value</span>:{<span class="hljs-attr">location</span>:t,<span class="hljs-attr">navigate</span>:<span class="hljs-function"><span class="hljs-params">r</span>=&gt;</span><span class="hljs-title function_">n</span>(r)},<span class="hljs-attr">children</span>:e})}
</code></pre>
<p>体积直接砍掉 70%。</p>
<p>其中 <code>NavigationProvider</code> → <code>pv</code> 就省了 17 个字符。整个项目几百个函数，加起来就是几十 KB 的差异。</p>
<h3 data-id="heading-14">压缩过程详解</h3>
<p>压缩不是简单的文本替换，而是经过多个阶段的代码转换。</p>
<h4 data-id="heading-15">完整的构建流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[源代码 JSX] --&gt; B[Babel 转译]
    B --&gt; C[打包合并]
    C --&gt; D[Terser 压缩]
    D --&gt; E[生产代码]
</code></pre>
<ol>
<li><strong>Babel 转译</strong>：把 JSX 转成标准 JavaScript</li>
<li><strong>打包合并</strong>：多个文件合成一个文件</li>
<li><strong>Terser 压缩</strong>：真正的压缩发生在这一步</li>
<li><strong>输出</strong>：最终的生产代码</li>
</ol>
<p>重点看第三步，压缩器内部其实也分好几个阶段。</p>
<h4 data-id="heading-16">Terser 的压缩阶段</h4>
<h5 data-id="heading-17">阶段 1：解析（Parse）</h5>
<p>把代码转成抽象语法树（AST）。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 源代码</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}

<span class="hljs-comment">// 转成 AST（简化版）</span>
{
    <span class="hljs-attr">type</span>: <span class="hljs-string">"FunctionDeclaration"</span>,
    <span class="hljs-attr">id</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">"Identifier"</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"NavigationProvider"</span> },
    <span class="hljs-attr">params</span>: [
        {
            <span class="hljs-attr">type</span>: <span class="hljs-string">"ObjectPattern"</span>,
            <span class="hljs-attr">properties</span>: [{ <span class="hljs-attr">key</span>: <span class="hljs-string">"children"</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">"children"</span> }]
        }
    ],
    <span class="hljs-attr">body</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-string">"ReturnStatement"</span>,
        <span class="hljs-attr">argument</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">"JSXElement"</span>, ... }
    }
}
</code></pre>
<p>AST 就是代码的树状结构表示，方便后续分析和修改。</p>
<h5 data-id="heading-18">阶段 2：分析（Analyze）</h5>
<p><strong>2.1 作用域分析</strong></p>
<p>找出哪些变量名可以改，哪些不能改。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">const</span> location = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);  <span class="hljs-comment">// 局部变量，可以改</span>
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}

<span class="hljs-variable language_">window</span>.<span class="hljs-property">NavigationProvider</span> = <span class="hljs-title class_">NavigationProvider</span>;  <span class="hljs-comment">// 全局引用，不能改</span>
</code></pre>
<p>规则：</p>
<ul>
<li><strong>可以改</strong>：函数内部的局部变量、函数名（如果没被外部引用）</li>
<li><strong>不能改</strong>：全局变量、对象属性名、被 <code>eval()</code> 使用的变量</li>
</ul>
<p><strong>2.2 引用计数</strong></p>
<p>统计每个标识符出现了多少次，决定是否值得压缩。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {  <span class="hljs-comment">// NavigationProvider 出现 1 次</span>
    <span class="hljs-keyword">const</span> location = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);          <span class="hljs-comment">// location 出现 1 次</span>
    <span class="hljs-keyword">const</span> currentLocation = location;        <span class="hljs-comment">// location 出现 2 次</span>
    <span class="hljs-keyword">return</span> currentLocation;                  <span class="hljs-comment">// currentLocation 出现 1 次</span>
}
</code></pre>
<p>如果一个变量只用了 1 次，改成短名称可能不划算（比如 <code>location</code> → <code>a</code> 只省 7 个字符）。</p>
<p><strong>2.3 依赖分析</strong></p>
<p>找出变量之间的依赖关系，避免命名冲突。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">outer</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> a = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">inner</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> b = <span class="hljs-number">2</span>;  <span class="hljs-comment">// b 可以重命名为 a，因为不在同一作用域</span>
        <span class="hljs-keyword">return</span> b;
    }
    <span class="hljs-keyword">return</span> a;
}
</code></pre>
<h5 data-id="heading-19">阶段 3：转换（Transform）</h5>
<p>这是真正做压缩的阶段，分多个步骤。</p>
<p><strong>3.1 删除死代码（Dead Code Elimination）</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 压缩前</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DEBUG</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-variable constant_">DEBUG</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'debug'</span>);  <span class="hljs-comment">// 这段永远不会执行</span>
    }
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}

<span class="hljs-comment">// 压缩后</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}
</code></pre>
<p><strong>3.2 常量折叠（Constant Folding）</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 压缩前</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MAX_COUNT</span> = <span class="hljs-number">10</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DOUBLED</span> = <span class="hljs-variable constant_">MAX_COUNT</span> * <span class="hljs-number">2</span>;
<span class="hljs-keyword">if</span> (count &gt; <span class="hljs-variable constant_">DOUBLED</span>) { <span class="hljs-comment">/* ... */</span> }

<span class="hljs-comment">// 压缩后</span>
<span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">20</span>) { <span class="hljs-comment">/* ... */</span> }
</code></pre>
<p>直接算出结果，减少运行时计算。</p>
<p><strong>3.3 表达式简化</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 压缩前</span>
<span class="hljs-keyword">if</span> (isActive === <span class="hljs-literal">true</span>) { <span class="hljs-comment">/* ... */</span> }

<span class="hljs-comment">// 压缩后</span>
<span class="hljs-keyword">if</span> (isActive) { <span class="hljs-comment">/* ... */</span> }
</code></pre>
<p><strong>3.4 变量名压缩（Mangle）</strong></p>
<p>这是我们关心的重点。</p>
<p>压缩器遍历 AST，按照一定规则替换标识符：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 压缩前</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">const</span> [location, setLocation] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">navigate</span> = (<span class="hljs-params">path</span>) =&gt; <span class="hljs-title function_">setLocation</span>(path);
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">location</span>, <span class="hljs-attr">navigate</span> }}&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}

<span class="hljs-comment">// 第一轮：函数名</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">pv</span>(<span class="hljs-params">{ children }</span>) {  <span class="hljs-comment">// NavigationProvider → pv</span>
    <span class="hljs-keyword">const</span> [location, setLocation] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">navigate</span> = (<span class="hljs-params">path</span>) =&gt; <span class="hljs-title function_">setLocation</span>(path);
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">location</span>, <span class="hljs-attr">navigate</span> }}&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}

<span class="hljs-comment">// 第二轮：参数名</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">pv</span>(<span class="hljs-params">{ children: e }</span>) {  <span class="hljs-comment">// children → e</span>
    <span class="hljs-keyword">const</span> [location, setLocation] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">navigate</span> = (<span class="hljs-params">path</span>) =&gt; <span class="hljs-title function_">setLocation</span>(path);
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">location</span>, <span class="hljs-attr">navigate</span> }}&gt;</span>{e}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}

<span class="hljs-comment">// 第三轮：局部变量</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">pv</span>(<span class="hljs-params">{ children: e }</span>) {
    <span class="hljs-keyword">const</span> [t, n] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);  <span class="hljs-comment">// location → t, setLocation → n</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">r</span> = (<span class="hljs-params">o</span>) =&gt; <span class="hljs-title function_">n</span>(o);         <span class="hljs-comment">// navigate → r, path → o</span>
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">location:</span> <span class="hljs-attr">t</span>, <span class="hljs-attr">navigate:</span> <span class="hljs-attr">r</span> }}&gt;</span>{e}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}
</code></pre>
<p>注意：<strong>对象属性名不会改</strong>（<code>location:</code>、<code>navigate:</code> 保持原样），因为这些是对外的接口。</p>
<p><strong>3.5 作用域提升（Scope Hoisting）</strong></p>
<p>把多个模块合并到一个作用域，减少闭包和函数调用。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 压缩前（两个文件）</span>
<span class="hljs-comment">// utils.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">formatDate</span>(<span class="hljs-params">date</span>) { <span class="hljs-keyword">return</span> date.<span class="hljs-title function_">toString</span>(); }

<span class="hljs-comment">// app.js</span>
<span class="hljs-keyword">import</span> { formatDate } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">formatDate</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()));

<span class="hljs-comment">// 压缩后（合并）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">a</span>(<span class="hljs-params">b</span>) { <span class="hljs-keyword">return</span> b.<span class="hljs-title function_">toString</span>(); }
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">a</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()));
</code></pre>
<h5 data-id="heading-20">阶段 4：生成（Generate）</h5>
<p>把修改后的 AST 转回代码字符串。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// AST 转回代码</span>
{
    <span class="hljs-attr">type</span>: <span class="hljs-string">"FunctionDeclaration"</span>,
    <span class="hljs-attr">id</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">"pv"</span> },  <span class="hljs-comment">// 已被修改</span>
    <span class="hljs-attr">params</span>: [{ <span class="hljs-attr">name</span>: <span class="hljs-string">"e"</span> }],
    <span class="hljs-attr">body</span>: { ... }
}

<span class="hljs-comment">// 生成代码</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">pv</span>(<span class="hljs-params">e</span>){<span class="hljs-keyword">const</span>[t,n]=<span class="hljs-title function_">useState</span>(<span class="hljs-string">"/"</span>);<span class="hljs-keyword">return</span> <span class="hljs-title function_">jsx</span>(<span class="hljs-title class_">Provider</span>,{<span class="hljs-attr">value</span>:{<span class="hljs-attr">location</span>:t,<span class="hljs-attr">navigate</span>:<span class="hljs-function"><span class="hljs-params">r</span>=&gt;</span><span class="hljs-title function_">n</span>(r)},<span class="hljs-attr">children</span>:e})}
</code></pre>
<p>同时删除所有空格、换行、注释。</p>
<h4 data-id="heading-21">命名规则详解</h4>
<p>压缩器分配短名称时的优先级：</p>
<h5 data-id="heading-22">1. 单字母（52 个）</h5>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">a</span>, <span class="hljs-selector-tag">b</span>, c, ..., z
<span class="hljs-selector-tag">A</span>, <span class="hljs-selector-tag">B</span>, C, ..., Z
</code></pre>
<p>最常用的标识符会优先分配这些。</p>
<h5 data-id="heading-23">2. 美元符号和下划线（104 个）</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-variable">$a</span>, <span class="hljs-variable">$b</span>, ..., <span class="hljs-variable">$Z</span>
_a, _b, ..., _Z
</code></pre>
<p>单字母用完就加前缀。</p>
<h5 data-id="heading-24">3. 两个字母（2704 个）</h5>
<pre><code class="hljs">aa, ab, ac, ..., ZZ
</code></pre>
<p>再不够就用两个字母组合。</p>
<h5 data-id="heading-25">4. 特殊组合</h5>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-variable">$,</span> _, <span class="hljs-variable">$$</span>, <span class="hljs-variable">$_</span>, ...
</code></pre>
<p>然后是各种特殊字符组合。</p>
<p>所以你看到的 <code>pv</code>、<code>$r</code>、<code>Jt</code> 都是按照这个顺序分配的。</p>
<h4 data-id="heading-26">真实例子对比</h4>
<p>拿一段完整的代码看看每个阶段的变化：</p>
<p><strong>原始代码</strong>（150 行，5 KB）：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState, useContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">NavigationContext</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">const</span> [currentLocation, setCurrentLocation] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">navigate</span> = (<span class="hljs-params">newPath</span>) =&gt; {
        <span class="hljs-keyword">if</span> (newPath !== currentLocation) {
            <span class="hljs-title function_">setCurrentLocation</span>(newPath);
            <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">pushState</span>({}, <span class="hljs-string">''</span>, newPath);
        }
    };

    <span class="hljs-keyword">const</span> value = {
        <span class="hljs-attr">location</span>: currentLocation,
        <span class="hljs-attr">navigate</span>: navigate
    };

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">NavigationContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span>&gt;</span>
            {children}
        <span class="hljs-tag">&lt;/<span class="hljs-name">NavigationContext.Provider</span>&gt;</span></span>
    );
}
</code></pre>
<p><strong>经过 Babel</strong>（转 JSX）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState, useContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">NavigationContext</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">const</span> [currentLocation, setCurrentLocation] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">navigate</span> = (<span class="hljs-params">newPath</span>) =&gt; {
        <span class="hljs-keyword">if</span> (newPath !== currentLocation) {
            <span class="hljs-title function_">setCurrentLocation</span>(newPath);
            <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">pushState</span>({}, <span class="hljs-string">''</span>, newPath);
        }
    };

    <span class="hljs-keyword">const</span> value = {
        <span class="hljs-attr">location</span>: currentLocation,
        <span class="hljs-attr">navigate</span>: navigate
    };

    <span class="hljs-keyword">return</span> <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(
        <span class="hljs-title class_">NavigationContext</span>.<span class="hljs-property">Provider</span>,
        { <span class="hljs-attr">value</span>: value },
        children
    );
}
</code></pre>
<p><strong>经过 Terser 分析</strong>（内部记录）：</p>
<pre><code class="hljs language-diff" lang="diff">作用域分析：
<span class="hljs-deletion">- NavigationContext: 全局导出，不能改</span>
<span class="hljs-deletion">- NavigationProvider: 全局导出，不能改</span>
<span class="hljs-deletion">- children: 函数参数，可以改 → e</span>
<span class="hljs-deletion">- currentLocation: 局部变量，可以改 → t</span>
<span class="hljs-deletion">- setCurrentLocation: 局部变量，可以改 → n</span>
<span class="hljs-deletion">- navigate: 局部变量，可以改 → r</span>
<span class="hljs-deletion">- newPath: 函数参数，可以改 → o</span>
<span class="hljs-deletion">- value: 局部变量，可以改 → a（但会被内联优化掉）</span>
</code></pre>
<p><strong>经过 Terser 压缩</strong>（最终产物，1.5 KB）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span>{useState <span class="hljs-keyword">as</span> t}<span class="hljs-keyword">from</span><span class="hljs-string">"react"</span>;<span class="hljs-keyword">const</span> n=<span class="hljs-title class_">React</span>.<span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{children:e}</span>){<span class="hljs-keyword">const</span>[r,o]=<span class="hljs-title function_">t</span>(<span class="hljs-string">"/"</span>),c=<span class="hljs-function"><span class="hljs-params">i</span>=&gt;</span>{i!==r&amp;&amp;(<span class="hljs-title function_">o</span>(i),<span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">pushState</span>({},<span class="hljs-string">""</span>,i))};<span class="hljs-keyword">return</span> <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(n.<span class="hljs-property">Provider</span>,{<span class="hljs-attr">value</span>:{<span class="hljs-attr">location</span>:r,<span class="hljs-attr">navigate</span>:c}},e)}
</code></pre>
<p><strong>体积对比</strong>：</p>
<ul>
<li>原始代码：5 KB</li>
<li>Babel 转译后：5.2 KB（JSX 转换略有增加）</li>
<li>Terser 压缩后：1.5 KB（减少 70%）</li>
</ul>
<p>关键变化：</p>
<ol>
<li>删除所有空格和换行：<code>5KB → 4KB</code></li>
<li>变量名压缩：<code>4KB → 2KB</code></li>
<li>表达式简化和内联：<code>2KB → 1.5KB</code></li>
</ol>
<h4 data-id="heading-27">为什么这么激进</h4>
<p>现代 Web 应用动辄几百个组件，上千个函数。</p>
<p>如果不压缩函数名和变量名：</p>
<ul>
<li>平均每个函数名 15 字符</li>
<li>1000 个函数 = 15KB 仅用于命名</li>
<li>加上变量名，总共可能 50KB+</li>
</ul>
<p>50KB 在 3G 网络下，多加载 3-5 秒。</p>
<p>所以压缩器默认非常激进，能压缩的全压缩。</p>
<h3 data-id="heading-28">背后的原理</h3>
<h4 data-id="heading-29">函数名是怎么被替换的</h4>
<p>压缩器内部维护一个映射表：</p>
<pre><code class="hljs language-bash" lang="bash">原始名称 → 压缩后名称
NavigationProvider → pv
LocationProvider → <span class="hljs-variable">$r</span>
DialogPortal → Jt
Link → vv
</code></pre>
<p>规则很简单：</p>
<ol>
<li>按出现顺序分配短名称</li>
<li>优先用单字母（a-z, A-Z）</li>
<li>单字母用完就用两个字母（aa, ab, ...）</li>
<li>加上特殊字符（$, _）增加组合数</li>
</ol>
<p>所以你会看到 <code>a</code>、<code>$r</code>、<code>pv</code>、<code>Jt</code> 这种看起来毫无规律的名称。</p>
<h4 data-id="heading-30">React DevTools 怎么知道组件名</h4>
<p>React DevTools 获取组件名的逻辑：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[读取组件] --&gt; B{有 displayName?}
    B --&gt;|有| C[显示 displayName]
    B --&gt;|没有| D{有函数名?}
    D --&gt;|有| E[显示函数名]
    D --&gt;|没有| F[显示 Anonymous]
</code></pre>
<p>优先级：<code>displayName</code> &gt; <code>函数名</code> &gt; <code>"Anonymous"</code></p>
<p>开发环境：</p>
<ul>
<li>函数名完整保留 → DevTools 读到 <code>NavigationProvider</code></li>
</ul>
<p>生产环境：</p>
<ul>
<li>函数名被压缩成 <code>pv</code> → DevTools 只能读到 <code>pv</code></li>
<li>没设置 <code>displayName</code> → 没有备用方案</li>
</ul>
<p>所以就出现了开头那张图的情况。</p>
<h3 data-id="heading-31">为什么不是所有组件都乱码</h3>
<p>你可能注意到，有些组件名还是正常的，比如 <code>Link</code>、<code>Menu</code>、<code>Dialog</code>。</p>
<p>原因有三种：</p>
<h4 data-id="heading-32">1. 组件设置了 displayName</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">MyComponent</span> = (<span class="hljs-params"/>) =&gt; <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Hello<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
<span class="hljs-title class_">MyComponent</span>.<span class="hljs-property">displayName</span> = <span class="hljs-string">'MyComponent'</span>;
</code></pre>
<p>压缩器不会改 <code>displayName</code>（它是字符串，不是标识符）。</p>
<h4 data-id="heading-33">2. 组件来自第三方库</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Dialog</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@mui/material'</span>;
</code></pre>
<p>第三方库通常会设置 <code>displayName</code>，或者配置了保留函数名的构建选项。</p>
<h4 data-id="heading-34">3. 名称太短，碰巧没变</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Link</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* ... */</span> }
</code></pre>
<p>如果原本就叫 <code>Link</code>，压缩后可能还是 <code>Link</code>（4 个字符，不一定值得压缩）。</p>
<p>但这纯靠运气，不能依赖。</p>
<h3 data-id="heading-35">怎么解决</h3>
<p>核心思路就两个方向：</p>
<h4 data-id="heading-36">1. 告诉压缩器：别改函数名</h4>
<p>Webpack/Vite 配置中，设置 Terser 选项：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">terserOptions</span>: {
    <span class="hljs-attr">keep_fnames</span>: <span class="hljs-literal">true</span>  <span class="hljs-comment">// 保留函数名</span>
}
</code></pre>
<p>代价：包体积增加 5-10%。</p>
<h4 data-id="heading-37">2. 手动给组件加 displayName</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">NavigationProvider</span> = (<span class="hljs-params">{ children }</span>) =&gt; {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
};

<span class="hljs-title class_">NavigationProvider</span>.<span class="hljs-property">displayName</span> = <span class="hljs-string">'Navigation.Provider'</span>;
</code></pre>
<p>好处：精确控制，体积影响小。
代价：要手动维护。</p>
<h3 data-id="heading-38">该不该解决</h3>
<p><strong>内部系统/管理后台</strong>：</p>
<ul>
<li>调试需求高，体积不敏感</li>
<li>建议保留函数名，调试体验直接拉满</li>
</ul>
<p><strong>面向用户的产品</strong>：</p>
<ul>
<li>体积影响加载速度，调试主要在开发环境</li>
<li>不用管，或者只给核心组件加 displayName</li>
</ul>
<p><strong>开源组件库</strong>：</p>
<ul>
<li>用户调试需要清晰的组件名</li>
<li>建议加 displayName，或构建时保留函数名</li>
</ul>
<p>大多数情况，这不是个必须解决的问题。线上调试本来就该在 staging 环境（保留函数名），生产环境靠日志和监控。</p>
<h3 data-id="heading-39">相关资料</h3>
<ol>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fterser.org%2Fdocs%2Foptions%2F" target="_blank" title="https://terser.org/docs/options/" ref="nofollow noopener noreferrer">Terser 文档</a></strong> - 了解 <code>keep_fnames</code> 等配置</li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Flearn%2Freact-developer-tools%23why-is-my-component-called-_c" target="_blank" title="https://react.dev/learn/react-developer-tools#why-is-my-component-called-_c" ref="nofollow noopener noreferrer">React 官方：为什么我的组件叫 <code>_c</code>？</a></strong> - React 文档的解释</li>
</ol>
<hr/>
<p>搞清楚原理就好办了。遇到这种情况，知道是代码压缩导致的，而不是 React 或 DevTools 的 bug。</p>
<p>要不要解决，看具体需求。大部分时候，不用管。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀微调的力量：看3B参数的DeepSeek-OCR如何蜕变为中文识别高手！零成本微调保姆级教程：用Google Colab免费GPU，十分钟打造一个专属领域的]]></title>    <link>https://juejin.cn/post/7571648135585742891</link>    <guid>https://juejin.cn/post/7571648135585742891</guid>    <pubDate>2025-11-12T14:39:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571648135585742891" data-draft-id="7571648135585513515" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀微调的力量：看3B参数的DeepSeek-OCR如何蜕变为中文识别高手！零成本微调保姆级教程：用Google Colab免费GPU，十分钟打造一个专属领域的"/> <meta itemprop="keywords" content="DeepSeek,OpenAI,AIGC"/> <meta itemprop="datePublished" content="2025-11-12T14:39:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="win4r"/> <meta itemprop="url" content="https://juejin.cn/user/1739869037541555"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀微调的力量：看3B参数的DeepSeek-OCR如何蜕变为中文识别高手！零成本微调保姆级教程：用Google Colab免费GPU，十分钟打造一个专属领域的
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1739869037541555/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    win4r
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T14:39:58.000Z" title="Wed Nov 12 2025 14:39:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你是否遇到过这样的困境：想要识别图片中的文字，但大模型太"重"跑不动，小模型又经常认错字？比如把清晰的"一"识别成"二"，把重要的表格数据搞得面目全非……</p>
<p>🔥🔥🔥本篇笔记所对应的视频：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1hPkyB2EJE%2F" target="_blank" title="https://www.bilibili.com/video/BV1hPkyB2EJE/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1hP…</a></p>
<p>别急，今天我要分享一个"化腐朽为神奇"的方法——通过微调技术，让仅有3B参数的DeepSeek-OCR小模型，变成识别准确率媲美大模型的"识字专家"。更重要的是，整个过程只需10分钟，还能用Google Colab的免费GPU完成！</p>
<h2 data-id="heading-0">一、认识DeepSeek-OCR：小而美的OCR模型</h2>
<p>DeepSeek-OCR是一款专门用于文字识别和文档理解的视觉模型，参数量只有3B。别看它"个头小"，它有几个独特的优势：</p>
<ul>
<li><strong>超高效率</strong>：使用的视觉token数量是文本token的1/10，意味着处理速度比传统文本LLM快10倍</li>
<li><strong>精准识别</strong>：在标准测试中达到97%的准确率</li>
<li><strong>场景丰富</strong>：能处理表格、论文、手写体等多种复杂场景</li>
<li><strong>硬件友好</strong>：3B的参数量意味着普通显卡也能跑得动</li>
</ul>
<p>但是，正如"万金油"往往哪里都不精通，DeepSeek-OCR作为通用模型，对各种语言都能识别，但每种语言的准确率都不够理想。这就是我们需要微调的原因。</p>
<h2 data-id="heading-1">二、什么是微调？为什么要微调？</h2>
<p>用最简单的话来说，<strong>微调就是给模型"开小灶"</strong> 。</p>
<p>想象一下，你有一个什么都会的全能助手（通用模型），但让TA做中文会计报表时经常出错。这时你就给TA准备一本专门的中文会计教材，让TA集中学习这个领域的知识，慢慢地，TA就从"全能选手"变成了"中文会计专家"。</p>
<p>微调的过程就是这样：用特定领域的数据集训练模型，让它在你关注的场景下表现更出色。</p>
<h3 data-id="heading-2">什么场景需要微调OCR模型？</h3>
<ol>
<li><strong>特定语言优化</strong>：比如提升中文、波斯文、阿拉伯文等特定语言的识别准确率</li>
<li><strong>行业文档识别</strong>：医疗处方、法律合同、财务报表等专业文档</li>
<li><strong>特殊字体识别</strong>：手写体、艺术字、古籍文字</li>
<li><strong>复杂版式处理</strong>：多栏排版、表格嵌套、图文混排</li>
<li><strong>低质量图像</strong>：模糊扫描件、拍照文档、旧档案</li>
</ol>
<h2 data-id="heading-3">三、微调效果有多惊艳？</h2>
<p>根据Unsloth官方的测试数据，微调效果非常显著：</p>
<h3 data-id="heading-4">案例一：波斯文识别（官方数据）</h3>
<p>在20万样本的波斯文数据集上微调后，仅用60个训练步（批量大小为8）：</p>
<ul>
<li><strong>字符错误率（CER）从149.07%降至60.43%</strong></li>
<li><strong>准确率提升了88.26%</strong></li>
<li>这意味着微调后的模型准确度提升了57%</li>
</ul>
<h3 data-id="heading-5">案例二：中文识别（实测数据）</h3>
<p>在中文场景下的测试显示：</p>
<ul>
<li><strong>微调前</strong>：将清晰的"一"识别成"二"</li>
<li><strong>微调后</strong>：完美识别所有测试样本</li>
<li><strong>整体错误率下降70%以上</strong></li>
</ul>
<p>这样的提升，对于实际应用来说是质的飞跃。</p>
<h2 data-id="heading-6">四、微调实战：10分钟完成训练</h2>
<p>整个微调流程比你想象的简单得多，核心步骤只有三步：</p>
<h3 data-id="heading-7">第一步：准备数据集（5分钟）</h3>
<p>你需要准备两类数据：</p>
<ol>
<li><strong>图像文件</strong>：包含需要识别的文字图片</li>
<li><strong>标注文本</strong>：图像对应的正确文字内容</li>
</ol>
<p>数据集格式很简单，就是"图像-文本"对：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">图像路径: images/doc001.jpg</span>
<span class="hljs-section">对应文本: 这是图像中的完整文字内容，包括标点符号。</span>
</code></pre>
<p><strong>数据集来源：</strong></p>
<ul>
<li><strong>通用场景</strong>：可以使用Hugging Face上开源的高质量中文OCR数据集</li>
<li><strong>特定场景</strong>：自己制作数据集，准备10-1000个样本即可看到效果</li>
</ul>
<p><strong>制作自己的数据集：</strong> 使用提供的Python脚本，只需运行：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">python create_dataset.py <span class="hljs-keyword">data</span>.txt output.parquet
</code></pre>
<p>脚本会自动将你的图像和文本转换成标准的训练格式。</p>
<h3 data-id="heading-8">第二步：配置环境并开始训练（2分钟）</h3>
<ol>
<li>打开Google Colab，选择免费的T4 GPU</li>
<li>运行Unsloth提供的微调脚本</li>
<li>将默认数据集替换成你的中文数据集</li>
<li>点击运行，开始训练</li>
</ol>
<p><strong>核心参数设置：</strong></p>
<ul>
<li>训练样本：1000-2000个足够（更多样本效果更好）</li>
<li>训练时间：T4 GPU上约6-7分钟</li>
<li>显存占用：14GB以内，完全免费</li>
</ul>
<h3 data-id="heading-9">第三步：验证效果（3分钟）</h3>
<p>训练完成后，立即可以测试：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 加载微调后的模型</span>
model, <span class="hljs-attr">tokenizer</span> = FastVisionModel.from_pretrained(<span class="hljs-string">"./fine_tuned_model"</span>)

<span class="hljs-comment"># 测试识别</span>
<span class="hljs-attr">result</span> = model.infer(tokenizer, prompt=<span class="hljs-string">"&lt;image&gt;\nFree OCR."</span>, image_file=<span class="hljs-string">"test.jpg"</span>)
print(result)
</code></pre>
<p>对比微调前后的识别结果，你会看到显著的改进。</p>
<h2 data-id="heading-10">五、技术细节：LoRA高效微调</h2>
<p>微调使用的是**LoRA（低秩适应）**技术，这是一种参数高效的微调方法：</p>
<ul>
<li><strong>只训练少量参数</strong>：不需要调整整个模型，只训练新增的小规模适配器</li>
<li><strong>显存占用低</strong>：T4免费GPU就能轻松完成</li>
<li><strong>训练速度快</strong>：Unsloth优化后，速度提升1.4倍，显存使用减少40%</li>
<li><strong>效果不打折</strong>：准确率与全量微调相当</li>
</ul>
<p>这也是为什么我们能用免费资源完成专业级微调的原因。</p>
<h2 data-id="heading-11">六、实际应用场景举例</h2>
<h3 data-id="heading-12">场景1：扫描档案数字化</h3>
<p>某档案馆有大量80年代的模糊扫描文件，通用OCR模型错误率高达30%。使用500个样本微调后，错误率降至5%以下，大大加速了数字化进程。</p>
<h3 data-id="heading-13">场景2：手写体识别</h3>
<p>医院需要识别医生的手写处方。使用1000个标注样本微调后，识别准确率从60%提升到92%，显著减少了人工复核工作量。</p>
<h3 data-id="heading-14">场景3：多语言文档处理</h3>
<p>跨国公司需要处理包含中英混排的合同文档。通过混合数据集微调，模型在中英混排场景下的准确率达到98%。</p>
<h2 data-id="heading-15">七、成本分析：真的零成本</h2>
<p>让我们算一笔账：</p>
<p><strong>传统方案：</strong></p>
<ul>
<li>购买商业OCR API：0.01元/张起</li>
<li>处理10万张图片：1000元起</li>
<li>月度费用：持续支出</li>
</ul>
<p><strong>微调方案：</strong></p>
<ul>
<li>Google Colab免费GPU：0元</li>
<li>训练时间：10分钟</li>
<li>部署成本：私有化部署，一次投入长期使用</li>
<li>总成本：几乎为零</li>
</ul>
<p>更重要的是，微调后的模型完全属于你，可以：</p>
<ul>
<li>私有化部署，数据安全有保障</li>
<li>无限次使用，不用担心API调用费用</li>
<li>持续优化，随时用新数据再次微调</li>
</ul>
<h2 data-id="heading-16">八、开始你的微调之旅</h2>
<p>所有资源都已准备好：</p>
<ol>
<li><strong>Unsloth官方教程</strong>：提供完整的Colab笔记本和代码</li>
<li><strong>数据集制作脚本</strong>：含详细中文注释</li>
<li><strong>开源中文数据集</strong>：可直接使用的高质量训练数据</li>
<li><strong>社区支持</strong>：遇到问题随时查阅文档和博客</li>
</ol>
<p>微调不再是高深莫测的技术，它已经变得像安装软件一样简单。只要你有需求，有数据，就能动手实践。</p>
<h2 data-id="heading-17">写在最后</h2>
<p>在AI快速发展的今天，我们不仅要会"用"模型，更要学会"调"模型。微调技术让我们能够用较小的成本，获得针对性极强的AI能力。</p>
<p>DeepSeek-OCR的微调实战，只是一个开始。掌握了这个方法，你可以将它应用到：</p>
<ul>
<li>其他OCR模型的优化</li>
<li>多模态大模型的定制</li>
<li>特定领域的智能应用开发</li>
</ul>
<p>技术的门槛在降低，创新的空间在扩大。现在，轮到你动手实践了！</p>
<hr/>
<p><strong>📚 资源链接：</strong></p>
<ul>
<li>Unsloth官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.unsloth.ai" target="_blank" title="https://docs.unsloth.ai" ref="nofollow noopener noreferrer">docs.unsloth.ai</a></li>
<li>免费Colab笔记本：文中提供的链接</li>
<li>数据集制作脚本：视频描述栏获取</li>
</ul>
<p><strong>💡 小提示：</strong></p>
<ul>
<li>建议从100-500个样本开始尝试</li>
<li>训练时注意保存检查点，避免意外中断</li>
<li>微调后记得在实际场景中测试效果</li>
</ul>
<p>如果这篇文章对你有帮助，欢迎点赞、转发，让更多人了解AI微调的魅力！有任何问题也欢迎在评论区讨论交流。</p>
<hr/>
<p><strong>#AI技术 #OCR识别 #模型微调 #DeepSeek #机器学习 #深度学习实战</strong></p>
<h3 data-id="heading-18">微调脚本</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcolab.research.google.com%2Fgithub%2Funslothai%2Fnotebooks%2Fblob%2Fmain%2Fnb%2FDeepseek_OCR_(3B).ipynb" target="_blank" title="https://colab.research.google.com/github/unslothai/notebooks/blob/main/nb/Deepseek_OCR_(3B).ipynb" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=https%3A%2F%2Fcolab.research.google.com%2Fgithub%2Funslothai%2Fnotebooks%2Fblob%2Fmain%2Fnb%2FDeepseek_OCR_(3B).ipynb" target="_blank" title="https://colab.research.google.com/github/unslothai/notebooks/blob/main/nb/Deepseek_OCR_(3B).ipynb" ref="nofollow noopener noreferrer">colab.research.google.com/github/unsl…</a></p>
<h3 data-id="heading-19">中文数据集</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fdatasets%2Fpriyank-m%2Fchinese_text_recognition" target="_blank" title="https://huggingface.co/datasets/priyank-m/chinese_text_recognition" ref="nofollow noopener noreferrer">huggingface.co/datasets/pr…</a></p>
<h3 data-id="heading-20">图像文本对应<a href="https://link.juejin.cn?target=http%3A%2F%2Fcontent.md%2F" target="_blank" title="http://content.md/" ref="nofollow noopener noreferrer">content.md</a></h3>
<pre><code class="hljs language-bash" lang="bash">/Users/charlesqin/Desktop/img/1.jpg 剧情跌宕起伏，人
/Users/charlesqin/Desktop/img/2.jpg 好的，特效嘛，也算是良心了，演
/Users/charlesqin/Desktop/img/3.jpg 。。。，剧情逻辑有点不通啊啊。
/Users/charlesqin/Desktop/img/4.jpg 以看不了太烧脑的悬疑片
/Users/charlesqin/Desktop/img/5.jpg 。;这颗行星上存在
/Users/charlesqin/Desktop/img/6.jpg 磁场。不加外磁场时，原子在两个
/Users/charlesqin/Desktop/img/7.jpg 过外放的听歌确实比较不错第一
/Users/charlesqin/Desktop/img/8.jpg 快的,书也很整洁,但是我发现在
/Users/charlesqin/Desktop/img/9.jpg 为空间上的排列，有利于科学研究
/Users/charlesqin/Desktop/img/10.jpg 谁也不讨厌谁
</code></pre>
<h3 data-id="heading-21">数据集创建</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">#!/usr/bin/env python3</span>
<span class="hljs-string">"""
安装： pip install datasets Pillow scikit-learn tqdm                      
从 content.md 创建 Parquet 格式的 OCR 数据集

使用方法:
    python create_parquet_dataset.py content.md

或者自定义输出路径:
    python create_parquet_dataset.py content.md --output my_dataset
"""</span>

<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image <span class="hljs-keyword">as</span> PILImage
<span class="hljs-keyword">from</span> datasets <span class="hljs-keyword">import</span> Dataset, DatasetDict, Image
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split
<span class="hljs-keyword">from</span> tqdm <span class="hljs-keyword">import</span> tqdm

<span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_content_md</span>(<span class="hljs-params">file_path</span>):
    <span class="hljs-string">"""解析 content.md 文件"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"📖 读取文件: <span class="hljs-subst">{file_path}</span>"</span>)

    data = []
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:
        <span class="hljs-keyword">for</span> line_num, line <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(f, <span class="hljs-number">1</span>):
            line = line.strip()

            <span class="hljs-comment"># 跳过空行和注释</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> line <span class="hljs-keyword">or</span> line.startswith(<span class="hljs-string">'#'</span>):
                <span class="hljs-keyword">continue</span>

            <span class="hljs-comment"># 分割图像路径和文本</span>
            parts = line.split(<span class="hljs-literal">None</span>, <span class="hljs-number">1</span>)

            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) == <span class="hljs-number">2</span>:
                image_path, text = parts
                data.append((image_path, text))
            <span class="hljs-keyword">else</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"⚠️  行 <span class="hljs-subst">{line_num}</span>: 格式不正确，已跳过"</span>)

    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ 找到 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(data)}</span> 条记录"</span>)
    <span class="hljs-keyword">return</span> data

<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_dataset</span>(<span class="hljs-params">data</span>):
    <span class="hljs-string">"""创建数据集"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n📦 加载图像..."</span>)

    images = []
    texts = []
    skipped = <span class="hljs-number">0</span>

    <span class="hljs-keyword">for</span> img_path, text <span class="hljs-keyword">in</span> tqdm(data):
        <span class="hljs-comment"># 检查文件</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(img_path):
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"⚠️  图像不存在: <span class="hljs-subst">{img_path}</span>"</span>)
            skipped += <span class="hljs-number">1</span>
            <span class="hljs-keyword">continue</span>

        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 加载图像</span>
            img = PILImage.<span class="hljs-built_in">open</span>(img_path).convert(<span class="hljs-string">'RGB'</span>)

            <span class="hljs-comment"># 基本验证</span>
            <span class="hljs-keyword">if</span> img.size[<span class="hljs-number">0</span>] &lt; <span class="hljs-number">10</span> <span class="hljs-keyword">or</span> img.size[<span class="hljs-number">1</span>] &lt; <span class="hljs-number">10</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"⚠️  图像太小: <span class="hljs-subst">{img_path}</span>"</span>)
                skipped += <span class="hljs-number">1</span>
                <span class="hljs-keyword">continue</span>

            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> text <span class="hljs-keyword">or</span> text.strip() == <span class="hljs-string">''</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"⚠️  文本为空: <span class="hljs-subst">{img_path}</span>"</span>)
                skipped += <span class="hljs-number">1</span>
                <span class="hljs-keyword">continue</span>

            images.append(img)
            texts.append(text)

        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"⚠️  加载失败 <span class="hljs-subst">{img_path}</span>: <span class="hljs-subst">{e}</span>"</span>)
            skipped += <span class="hljs-number">1</span>
            <span class="hljs-keyword">continue</span>

    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ 成功加载: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(images)}</span> 个样本"</span>)
    <span class="hljs-keyword">if</span> skipped &gt; <span class="hljs-number">0</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"⚠️  跳过: <span class="hljs-subst">{skipped}</span> 个样本"</span>)

    <span class="hljs-comment"># 创建数据集</span>
    dataset = Dataset.from_dict({
        <span class="hljs-string">'image'</span>: images,
        <span class="hljs-string">'text'</span>: texts
    })

    dataset = dataset.cast_column(<span class="hljs-string">'image'</span>, Image())

    <span class="hljs-keyword">return</span> dataset

<span class="hljs-keyword">def</span> <span class="hljs-title function_">split_dataset</span>(<span class="hljs-params">dataset</span>):
    <span class="hljs-string">"""分割数据集为训练/验证/测试集"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n🔀 分割数据集..."</span>)

    indices = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(dataset)))

    <span class="hljs-comment"># 80% 训练，10% 验证，10% 测试</span>
    train_indices, temp_indices = train_test_split(
        indices, train_size=<span class="hljs-number">0.8</span>, random_state=<span class="hljs-number">42</span>
    )

    val_indices, test_indices = train_test_split(
        temp_indices, train_size=<span class="hljs-number">0.5</span>, random_state=<span class="hljs-number">42</span>
    )

    train_dataset = dataset.select(train_indices)
    val_dataset = dataset.select(val_indices)
    test_dataset = dataset.select(test_indices)

    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  训练集: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(train_dataset)}</span> 样本"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  验证集: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(val_dataset)}</span> 样本"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  测试集: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(test_dataset)}</span> 样本"</span>)

    <span class="hljs-keyword">return</span> DatasetDict({
        <span class="hljs-string">'train'</span>: train_dataset,
        <span class="hljs-string">'val'</span>: val_dataset,
        <span class="hljs-string">'test'</span>: test_dataset
    })

<span class="hljs-keyword">def</span> <span class="hljs-title function_">save_parquet</span>(<span class="hljs-params">dataset_dict, output_prefix</span>):
    <span class="hljs-string">"""保存为 Parquet 格式"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n💾 保存为 Parquet 格式..."</span>)

    <span class="hljs-keyword">for</span> split_name, split_data <span class="hljs-keyword">in</span> dataset_dict.items():
        output_file = <span class="hljs-string">f"<span class="hljs-subst">{output_prefix}</span>_<span class="hljs-subst">{split_name}</span>.parquet"</span>
        split_data.to_parquet(output_file)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  ✅ <span class="hljs-subst">{split_name}</span>: <span class="hljs-subst">{output_file}</span>"</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">print_statistics</span>(<span class="hljs-params">dataset_dict</span>):
    <span class="hljs-string">"""打印统计信息"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span> * <span class="hljs-number">70</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"📊 数据集统计"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">70</span>)

    <span class="hljs-keyword">for</span> split_name, split_data <span class="hljs-keyword">in</span> dataset_dict.items():
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n<span class="hljs-subst">{split_name}</span>:"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  样本数: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(split_data)}</span>"</span>)

        <span class="hljs-comment"># 文本长度</span>
        text_lengths = [<span class="hljs-built_in">len</span>(ex[<span class="hljs-string">'text'</span>]) <span class="hljs-keyword">for</span> ex <span class="hljs-keyword">in</span> split_data]
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  文本长度: <span class="hljs-subst">{<span class="hljs-built_in">min</span>(text_lengths)}</span>-<span class="hljs-subst">{<span class="hljs-built_in">max</span>(text_lengths)}</span> "</span>
              <span class="hljs-string">f"(平均: <span class="hljs-subst">{<span class="hljs-built_in">sum</span>(text_lengths) / <span class="hljs-built_in">len</span>(text_lengths):<span class="hljs-number">.1</span>f}</span>)"</span>)

        <span class="hljs-comment"># 显示样例</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(split_data) &gt; <span class="hljs-number">0</span>:
            sample_text = split_data[<span class="hljs-number">0</span>][<span class="hljs-string">'text'</span>]
            display_text = sample_text[:<span class="hljs-number">40</span>] + <span class="hljs-string">"..."</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sample_text) &gt; <span class="hljs-number">40</span> <span class="hljs-keyword">else</span> sample_text
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  样例: <span class="hljs-subst">{display_text}</span>"</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-comment"># 参数解析</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &lt; <span class="hljs-number">2</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"使用方法: python create_parquet_dataset.py content.md [--output 输出前缀]"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n示例:"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"  python create_parquet_dataset.py content.md"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"  python create_parquet_dataset.py content.md --output my_dataset"</span>)
        sys.exit(<span class="hljs-number">1</span>)

    input_file = sys.argv[<span class="hljs-number">1</span>]

    <span class="hljs-comment"># 输出路径</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt;= <span class="hljs-number">4</span> <span class="hljs-keyword">and</span> sys.argv[<span class="hljs-number">2</span>] == <span class="hljs-string">'--output'</span>:
        output_prefix = sys.argv[<span class="hljs-number">3</span>]
    <span class="hljs-keyword">else</span>:
        output_prefix = <span class="hljs-string">"my_ocr_dataset"</span>

    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">70</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"🚀 创建 Parquet 格式 OCR 数据集"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">70</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"输入文件: <span class="hljs-subst">{input_file}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"输出前缀: <span class="hljs-subst">{output_prefix}</span>"</span>)

    <span class="hljs-comment"># 检查输入文件</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(input_file):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n❌ 错误: 文件不存在: <span class="hljs-subst">{input_file}</span>"</span>)
        sys.exit(<span class="hljs-number">1</span>)

    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 1. 解析文件</span>
        data = parse_content_md(input_file)

        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(data) == <span class="hljs-number">0</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n❌ 错误: 没有找到有效数据"</span>)
            sys.exit(<span class="hljs-number">1</span>)

        <span class="hljs-comment"># 2. 创建数据集</span>
        dataset = create_dataset(data)

        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(dataset) == <span class="hljs-number">0</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n❌ 错误: 没有成功加载任何样本"</span>)
            sys.exit(<span class="hljs-number">1</span>)

        <span class="hljs-comment"># 3. 分割数据集</span>
        dataset_dict = split_dataset(dataset)

        <span class="hljs-comment"># 4. 打印统计</span>
        print_statistics(dataset_dict)

        <span class="hljs-comment"># 5. 保存为 Parquet</span>
        save_parquet(dataset_dict, output_prefix)

        <span class="hljs-comment"># 完成</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span> * <span class="hljs-number">70</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 完成！"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">70</span>)

        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n📦 生成的文件:"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  - <span class="hljs-subst">{output_prefix}</span>_train.parquet"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  - <span class="hljs-subst">{output_prefix}</span>_val.parquet"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  - <span class="hljs-subst">{output_prefix}</span>_test.parquet"</span>)

        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n📖 如何使用:"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"  from datasets import load_dataset"</span>)
        <span class="hljs-built_in">print</span>()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"  # 加载训练集"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  train_dataset = load_dataset('parquet', data_files='<span class="hljs-subst">{output_prefix}</span>_train.parquet')"</span>)
        <span class="hljs-built_in">print</span>()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"  # 或加载所有分割"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  dataset = load_dataset('parquet', data_files={{"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"      'train': '<span class="hljs-subst">{output_prefix}</span>_train.parquet',"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"      'val': '<span class="hljs-subst">{output_prefix}</span>_val.parquet',"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"      'test': '<span class="hljs-subst">{output_prefix}</span>_test.parquet'"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  }})"</span>)
        <span class="hljs-built_in">print</span>()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"  # 用于微调"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"  train_data = dataset['train']"</span>)

    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n❌ 错误: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">import</span> traceback
        traceback.print_exc()
        sys.exit(<span class="hljs-number">1</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    main()
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一个基于 .NET 8 + DDD 搭建的模块化微服务框架]]></title>    <link>https://juejin.cn/post/7571704212850884659</link>    <guid>https://juejin.cn/post/7571704212850884659</guid>    <pubDate>2025-11-12T14:49:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571704212850884659" data-draft-id="7571695634942263323" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一个基于  .NET 8 + DDD 搭建的模块化微服务框架"/> <meta itemprop="keywords" content="后端,.NET"/> <meta itemprop="datePublished" content="2025-11-12T14:49:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="追逐时光者"/> <meta itemprop="url" content="https://juejin.cn/user/2770425031690333"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一个基于  .NET 8 + DDD 搭建的模块化微服务框架
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2770425031690333/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    追逐时光者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T14:49:51.000Z" title="Wed Nov 12 2025 14:49:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>今天大姚给大家分享一个基于 .NET 8 + DDD 搭建的模块化微服务框架：NetCoreKevin。</p>
<h2 data-id="heading-1">项目介绍</h2>
<p>NetCoreKevin 是一个基于 .NET 8 + DDD 搭建的模块化微服务框架，其模块化设计使得每个功能都可以独立引用，非常适合大型企业级应用的开发。框架支持IdentityServer4单点登录、多缓存、自动任务、分布式、一库多租户、日志、授权和鉴权、CAP集成事件、SignalR、领域事件、ESL、MCP协议服务、IOC模块化注入、Cors、Quartz自动任务、多短信集成、AI智能体、AI 集成 SemanticKernel、MCP 服务、OCR验证码识别、API多版本兼容、单元集成测试。</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fe43W9dqTWnmwI2STQREolw" target="_blank" title="https://mp.weixin.qq.com/s/e43W9dqTWnmwI2STQREolw" ref="nofollow noopener noreferrer">DotNetGuide 突破了 9.5K + Star，一份全面的C#/.NET/.NET Core学习、工作、面试指南知识库！</a></li>
</ul>
<h2 data-id="heading-2">DDD 领域驱动设计介绍</h2>
<p>领域驱动设计（Domain-Driven Design，简称DDD）是一种软件设计方法和理念，由Eric Evans在2004年提出。它通过深入理解业务领域，将复杂的业务逻辑转化为可维护、可扩展的软件系统。DDD的核心在于建立一个丰富的领域模型，这个模型能够反映业务实体、业务规则和业务流程。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c4213e54a124c009eb038a6e4e8789b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763563791&amp;x-signature=eh3vULYEzw8mH9%2F731qgy7MTSEE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">项目功能</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d61e793add914067ba18ff2e29aa766c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763563791&amp;x-signature=bMpvR%2FJSuR0A9uUFupNmtX8Npdo%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">项目源代码</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18f42e59c1c140b4944741c181f9b8f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763563791&amp;x-signature=vT7ZzKUG5a%2FEfl7jXQDFNwb05Es%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7779221efd54fd4b727824c5180d4a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763563791&amp;x-signature=jcxF2FCOFRM7SST9KPXgOk7kpL0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">基础 WebAPI</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1825a6e962cf45ae8d8d07e418e3c340~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763563791&amp;x-signature=F4ct6VPx96sMJAqf3Cd0aTTobdg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">项目源码地址</h2>
<p>更多项目实用功能和特性欢迎前往项目开源地址查看👀，别忘了给项目一个Star支持💖。</p>
<ul>
<li><strong>GitHub开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjunkai-li%2FNetCoreKevin" target="_blank" title="https://github.com/junkai-li/NetCoreKevin" ref="nofollow noopener noreferrer">github.com/junkai-li/N…</a></li>
</ul>
<h2 data-id="heading-7">优秀项目和框架精选</h2>
<p>该项目已收录到C#/.NET/.NET Core优秀项目和框架精选中，关注优秀项目和框架精选能让你及时了解C#、.NET和.NET Core领域的最新动态和最佳实践，提高开发工作效率和质量。坑已挖，欢迎大家踊跃提交PR推荐或自荐（<strong>让优秀的项目和框架不被埋没🤞</strong>）。</p>
<ul>
<li><strong>GitHub开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FYSGStudyHards%2FDotNetGuide%2Fblob%2Fmain%2Fdocs%2FDotNet%2FDotNetProjectPicks.md" target="_blank" title="https://github.com/YSGStudyHards/DotNetGuide/blob/main/docs/DotNet/DotNetProjectPicks.md" ref="nofollow noopener noreferrer">github.com/YSGStudyHar…</a></li>
<li><strong>Gitee开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fysgdaydayup%2FDotNetGuide%2Fblob%2Fmain%2Fdocs%2FDotNet%2FDotNetProjectPicks.md" target="_blank" title="https://gitee.com/ysgdaydayup/DotNetGuide/blob/main/docs/DotNet/DotNetProjectPicks.md" ref="nofollow noopener noreferrer">gitee.com/ysgdaydayup…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别span嵌套地狱:CSS Highlights API重新定义语法高亮]]></title>    <link>https://juejin.cn/post/7571655979256414248</link>    <guid>https://juejin.cn/post/7571655979256414248</guid>    <pubDate>2025-11-12T13:23:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571655979256414248" data-draft-id="7571655979256397864" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别span嵌套地狱:CSS Highlights API重新定义语法高亮"/> <meta itemprop="keywords" content="前端,JavaScript,CSS"/> <meta itemprop="datePublished" content="2025-11-12T13:23:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别span嵌套地狱:CSS Highlights API重新定义语法高亮
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T13:23:32.000Z" title="Wed Nov 12 2025 13:23:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">CSS Highlights API：不用 DOM 操作也能实现语法高亮</h2>
<p>做代码编辑器或者技术博客的时候，语法高亮是个绕不开的需求。传统方案是给每个关键字、字符串、注释包一层 <code>&lt;span&gt;</code> 标签，然后加上不同的 class。</p>
<p>问题是，几十行代码下来，DOM 树就被塞满了几百个 span 节点。浏览器渲染起来慢，内存占用也高，还容易出性能问题。</p>
<p>最近研究了 CSS Highlights API，发现这玩意儿挺有意思的：不操作 DOM，直接用 Range 标记文本位置，性能提升明显。来看看到底怎么回事。</p>
<p>文章底部有代码示例，可以直接复制下来运行测试对比不同方案的区别。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/726abd9e9d0641cdbe6b930fccf66528~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lmf5peg6aOO6Zuo5Lmf6Zu-5pm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763558611&amp;x-signature=XbBTAXX4cIgIz5gXyMCo8BIqQf8%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-1">传统方案的问题</h3>
<p>先看看我们常用的方法：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 传统方案：为每个 token 包裹 span</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">highlightCode</span>(<span class="hljs-params">code</span>) {
    <span class="hljs-keyword">const</span> tokens = <span class="hljs-title function_">tokenize</span>(code);
    <span class="hljs-keyword">let</span> html = <span class="hljs-string">''</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> token <span class="hljs-keyword">of</span> tokens) {
        html += <span class="hljs-string">`&lt;span class="token-<span class="hljs-subst">${token.type}</span>"&gt;<span class="hljs-subst">${token.value}</span>&lt;/span&gt;`</span>;
    }

    element.<span class="hljs-property">innerHTML</span> = html;
}
</code></pre>
<p>这样做，一段 50 行的代码，轻松产生 200-300 个 DOM 节点。想想也是，每个关键字、每个字符串、每个数字都是一个节点，能不多吗。</p>
<p>DOM 节点多了带来几个问题：</p>
<ol>
<li><strong>渲染慢</strong>：浏览器要构建整个 DOM 树，计算每个节点的样式和布局</li>
<li><strong>内存占用高</strong>：每个节点都要占内存，几百个节点就是几百份数据</li>
<li><strong>更新麻烦</strong>：代码一改，整个 innerHTML 重新生成，所有节点重建</li>
</ol>
<p>特别是在代码编辑器场景下，用户每输入一个字符，就要重新生成一遍所有节点，卡顿在所难免。</p>
<h3 data-id="heading-2">CSS Highlights API 的思路</h3>
<p>CSS Highlights API 换了个思路：<strong>不修改 DOM 结构，只标记文本位置</strong>。</p>
<p>核心原理说穿了挺简单：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[纯文本 TextNode] --&gt; B[词法分析 Tokenize]
    B --&gt; C[创建 Range 对象]
    C --&gt; D[按类型分组]
    D --&gt; E[注册到 CSS.highlights]
    E --&gt; F[浏览器直接渲染高亮]
</code></pre>
<p>整个过程不创建新的 DOM 节点，文本始终是一个完整的 text node。</p>
<p>具体来说：</p>
<ol>
<li><strong>保持纯文本</strong>：代码放在一个 text node 里，不拆分</li>
<li><strong>用 Range 标记</strong>：Range 对象只是标记"第 10 个字符到第 18 个字符"这样的位置信息</li>
<li><strong>CSS 负责渲染</strong>：用 <code>::highlight()</code> 伪元素定义样式，浏览器直接渲染</li>
</ol>
<h3 data-id="heading-3">实现细节</h3>
<h4 data-id="heading-4">1. 定义高亮样式</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 定义不同 token 类型的样式 */</span>
::<span class="hljs-built_in">highlight</span>(keyword) {
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#569cd6</span>;
    <span class="hljs-attribute">font-weight</span>: bold;
}

::<span class="hljs-built_in">highlight</span>(string) {
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#ce9178</span>;
}

::<span class="hljs-built_in">highlight</span>(comment) {
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#6a9955</span>;
    <span class="hljs-attribute">font-style</span>: italic;
}
</code></pre>
<p>这里用 <code>::highlight()</code> 伪元素，括号里的名称对应后面注册时的 key。</p>
<h4 data-id="heading-5">2. 词法分析</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">tokenize</span>(<span class="hljs-params">code</span>) {
    <span class="hljs-keyword">const</span> tokens = [];

    <span class="hljs-comment">// 定义匹配规则（顺序很重要）</span>
    <span class="hljs-keyword">const</span> patterns = [
        { <span class="hljs-attr">type</span>: <span class="hljs-string">'comment'</span>, <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/\/\/[^\n]*/g</span> },
        { <span class="hljs-attr">type</span>: <span class="hljs-string">'string'</span>, <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/(["'`])(?:(?=(\\?))\2.)*?\1/g</span> },
        { <span class="hljs-attr">type</span>: <span class="hljs-string">'keyword'</span>, <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/\b(function|const|let|var|if|else|return)\b/g</span> },
        { <span class="hljs-attr">type</span>: <span class="hljs-string">'number'</span>, <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/\b\d+\.?\d*\b/g</span> },
        <span class="hljs-comment">// ... 其他规则</span>
    ];

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> { type, regex } <span class="hljs-keyword">of</span> patterns) {
        <span class="hljs-keyword">let</span> match;
        <span class="hljs-keyword">while</span> ((match = regex.<span class="hljs-title function_">exec</span>(code)) !== <span class="hljs-literal">null</span>) {
            tokens.<span class="hljs-title function_">push</span>({
                type,
                <span class="hljs-attr">start</span>: match.<span class="hljs-property">index</span>,
                <span class="hljs-attr">end</span>: match.<span class="hljs-property">index</span> + match[<span class="hljs-number">0</span>].<span class="hljs-property">length</span>,
                <span class="hljs-attr">value</span>: match[<span class="hljs-number">0</span>]
            });
        }
    }

    <span class="hljs-keyword">return</span> tokens;
}
</code></pre>
<p>这里要注意：</p>
<ul>
<li><strong>comment 和 string 放最前面</strong>：确保注释和字符串内部的内容不会被其他规则匹配</li>
<li><strong>去重处理</strong>：多个规则可能匹配同一段文本，要去掉重叠的 token</li>
</ul>
<h4 data-id="heading-6">3. 创建 Range 并注册</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">applyHighlights</span>(<span class="hljs-params">element, code</span>) {
    <span class="hljs-comment">// 检查浏览器支持</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable constant_">CSS</span>.<span class="hljs-property">highlights</span>) {
        <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 降级到传统方案</span>
    }

    <span class="hljs-comment">// 设置纯文本（只有一个 text node）</span>
    element.<span class="hljs-property">textContent</span> = code;
    <span class="hljs-keyword">const</span> textNode = element.<span class="hljs-property">firstChild</span>;

    <span class="hljs-keyword">const</span> tokens = <span class="hljs-title function_">tokenize</span>(code);

    <span class="hljs-comment">// 按类型分组</span>
    <span class="hljs-keyword">const</span> tokensByType = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> token <span class="hljs-keyword">of</span> tokens) {
        <span class="hljs-keyword">if</span> (!tokensByType.<span class="hljs-title function_">has</span>(token.<span class="hljs-property">type</span>)) {
            tokensByType.<span class="hljs-title function_">set</span>(token.<span class="hljs-property">type</span>, []);
        }

        <span class="hljs-comment">// 创建 Range 标记位置</span>
        <span class="hljs-keyword">const</span> range = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Range</span>();
        range.<span class="hljs-title function_">setStart</span>(textNode, token.<span class="hljs-property">start</span>);
        range.<span class="hljs-title function_">setEnd</span>(textNode, token.<span class="hljs-property">end</span>);
        tokensByType.<span class="hljs-title function_">get</span>(token.<span class="hljs-property">type</span>).<span class="hljs-title function_">push</span>(range);
    }

    <span class="hljs-comment">// 注册到 CSS.highlights</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [type, ranges] <span class="hljs-keyword">of</span> tokensByType) {
        <span class="hljs-keyword">const</span> highlight = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Highlight</span>(...ranges);
        <span class="hljs-variable constant_">CSS</span>.<span class="hljs-property">highlights</span>.<span class="hljs-title function_">set</span>(type, highlight);
    }
}
</code></pre>
<p>关键点：</p>
<ul>
<li><strong>Range 只是标记</strong>：不修改 DOM，只是告诉浏览器"这段文本需要高亮"</li>
<li><strong>按类型注册</strong>：同一类型的 token（比如所有关键字）共享一个 Highlight 对象</li>
<li><strong>CSS 自动匹配</strong>：注册的名称（如 <code>keyword</code>）会匹配 CSS 中的 <code>::highlight(keyword)</code></li>
</ul>
<h3 data-id="heading-7">性能对比</h3>
<p>实测数据（50 行代码，约 150 个 token）：</p>



































<table><thead><tr><th>指标</th><th>CSS Highlights API</th><th>传统 DOM 方案</th><th>提升</th></tr></thead><tbody><tr><td>DOM 节点数</td><td>1 个</td><td>300+ 个</td><td>99.7%</td></tr><tr><td>首次渲染时间</td><td>0.8ms</td><td>2.5ms</td><td>68%</td></tr><tr><td>内存占用</td><td>低</td><td>高</td><td>~70%</td></tr><tr><td>重新渲染</td><td>快</td><td>慢</td><td>~60%</td></tr></tbody></table>
<p>优势明显：</p>
<ol>
<li><strong>节点数大幅减少</strong>：从几百个节点降到 1 个</li>
<li><strong>渲染更快</strong>：浏览器不用构建复杂的 DOM 树</li>
<li><strong>内存占用低</strong>：Range 对象比 DOM 节点轻量得多</li>
<li><strong>更新高效</strong>：修改代码只需重新创建 Range，不用重建 DOM</li>
</ol>
<h3 data-id="heading-8">需要注意的点</h3>
<h4 data-id="heading-9">1. 浏览器兼容性</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">if</span> (!<span class="hljs-variable constant_">CSS</span>.<span class="hljs-property">highlights</span>) {
    <span class="hljs-comment">// 降级到传统方案</span>
    <span class="hljs-title function_">applyTraditionalHighlight</span>(element, code);
    <span class="hljs-keyword">return</span>;
}
</code></pre>
<p>当前支持情况：</p>
<ul>
<li>Chrome/Edge 105+</li>
<li>Firefox 140+</li>
<li>Safari 17.2+</li>
</ul>
<p>不支持的浏览器需要 fallback 方案。</p>
<h4 data-id="heading-10">2. 词法分析的顺序</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> patterns = [
    { <span class="hljs-attr">type</span>: <span class="hljs-string">'comment'</span>, <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/\/\/[^\n]*/g</span> },    <span class="hljs-comment">// 必须在最前面</span>
    { <span class="hljs-attr">type</span>: <span class="hljs-string">'string'</span>, <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/(["'`])(?:(?=(\\?))\2.)*?\1/g</span> },  <span class="hljs-comment">// 也要优先</span>
    { <span class="hljs-attr">type</span>: <span class="hljs-string">'keyword'</span>, <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/\b(function|const)\b/g</span> },
    <span class="hljs-comment">// ... 后续规则</span>
];
</code></pre>
<p>为什么 comment 和 string 要放前面？</p>
<p>因为注释里可能包含关键字，字符串里可能包含数字。如果关键字规则先匹配，注释和字符串内部就会被错误高亮。</p>
<h4 data-id="heading-11">3. 去重逻辑</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 按位置排序</span>
tokens.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">start</span> - b.<span class="hljs-property">start</span>);

<span class="hljs-comment">// 去除重叠的 token</span>
<span class="hljs-keyword">const</span> filteredTokens = [];
<span class="hljs-keyword">let</span> lastEnd = <span class="hljs-number">0</span>;

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> token <span class="hljs-keyword">of</span> tokens) {
    <span class="hljs-keyword">if</span> (token.<span class="hljs-property">start</span> &gt;= lastEnd) {
        filteredTokens.<span class="hljs-title function_">push</span>(token);
        lastEnd = token.<span class="hljs-property">end</span>;
    }
}
</code></pre>
<p>这样可以确保：</p>
<ul>
<li>注释中的冒号不会被 operator 规则重复匹配</li>
<li>字符串中的关键字不会被单独高亮</li>
</ul>
<h4 data-id="heading-12">4. Range 不会自动更新</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 代码改变后，需要重新创建 Range</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">updateCode</span>(<span class="hljs-params">newCode</span>) {
    <span class="hljs-variable constant_">CSS</span>.<span class="hljs-property">highlights</span>.<span class="hljs-title function_">clear</span>();  <span class="hljs-comment">// 清除旧的</span>
    <span class="hljs-title function_">applyHighlights</span>(element, newCode);  <span class="hljs-comment">// 重新应用</span>
}
</code></pre>
<p>Range 对象只是快照，不会跟随文本变化自动更新。代码编辑器场景需要监听输入事件，及时重新生成。</p>
<h3 data-id="heading-13">适用场景</h3>
<p><strong>适合用 CSS Highlights API 的场景</strong>：</p>
<ol>
<li><strong>代码展示</strong>：技术博客、文档站、代码分享平台</li>
<li><strong>只读编辑器</strong>：查看器、diff 工具、代码审查工具</li>
<li><strong>性能敏感</strong>：大文件预览、移动端展示</li>
</ol>
<p><strong>不太适合的场景</strong>：</p>
<ol>
<li><strong>复杂编辑器</strong>：需要光标定位、选区管理、行号对齐等功能</li>
<li><strong>老浏览器支持</strong>：IE、老版 Safari 不支持，需要完善的 fallback</li>
<li><strong>极致性能要求</strong>：虚拟滚动、增量渲染的场景可能需要更定制化的方案</li>
</ol>
<h3 data-id="heading-14">和 Prism.js、Highlight.js 的区别</h3>
<p>常见的高亮库都是基于 DOM 的：</p>








































<table><thead><tr><th>特性</th><th>CSS Highlights API</th><th>Prism.js / Highlight.js</th></tr></thead><tbody><tr><td>DOM 节点数</td><td>1 个</td><td>几百个</td></tr><tr><td>渲染性能</td><td>快</td><td>慢</td></tr><tr><td>语言支持</td><td>需自己实现</td><td>内置几十种语言</td></tr><tr><td>主题系统</td><td>CSS 自定义</td><td>预设主题</td></tr><tr><td>插件生态</td><td>无</td><td>丰富</td></tr><tr><td>学习成本</td><td>低</td><td>中</td></tr></tbody></table>
<p>简单总结：</p>
<ul>
<li><strong>语言支持少、要求性能</strong>：用 CSS Highlights API</li>
<li><strong>需要开箱即用、多语言支持</strong>：用 Prism.js / Highlight.js</li>
<li><strong>极致性能 + 定制化</strong>：自己基于 CSS Highlights API 封装</li>
</ul>
<h3 data-id="heading-15">相关文档</h3>
<h4 data-id="heading-16">官方标准文档</h4>
<ol>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FCSS_Custom_Highlight_API" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/API/CSS_Custom_Highlight_API" ref="nofollow noopener noreferrer">CSS Custom Highlight API - MDN</a></strong> - API 使用指南</li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fdrafts.csswg.org%2Fcss-highlight-api%2F" target="_blank" title="https://drafts.csswg.org/css-highlight-api/" ref="nofollow noopener noreferrer">Highlight API Specification</a></strong> - W3C 规范草案</li>
</ol>
<h4 data-id="heading-17">技术文章</h4>
<ol start="3">
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fpavi2410.com%2Fblog%2Fhigh-performance-syntax-highlighting-with-css-highlights-api%2F" target="_blank" title="https://pavi2410.com/blog/high-performance-syntax-highlighting-with-css-highlights-api/" ref="nofollow noopener noreferrer">High Performance Syntax Highlighting</a></strong> - 性能对比和实现细节</li>
</ol>
<h4 data-id="heading-18">浏览器兼容性</h4>
<ol start="4">
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fcaniuse.com%2F%3Fsearch%3Dhighlight" target="_blank" title="https://caniuse.com/?search=highlight" ref="nofollow noopener noreferrer">Can I Use - CSS Custom Highlight</a></strong> - 浏览器支持情况</li>
</ol>
<hr/>
<h3 data-id="heading-19">完整 Demo</h3>
<p>下面是一个完整的对比演示，左侧展示 CSS Highlights API 方案，右侧展示传统 DOM 方案，可以直接看到性能差异：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>CSS Highlights API - 语法高亮演示<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        * {
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">box-sizing</span>: border-box;
        }

        <span class="hljs-selector-tag">body</span> {
            <span class="hljs-attribute">font-family</span>: -apple-system, BlinkMacSystemFont, <span class="hljs-string">'Segoe UI'</span>, <span class="hljs-string">'PingFang SC'</span>, <span class="hljs-string">'Hiragino Sans GB'</span>, <span class="hljs-string">'Microsoft YaHei'</span>, sans-serif;
            <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">135deg</span>, <span class="hljs-number">#667eea</span> <span class="hljs-number">0%</span>, <span class="hljs-number">#764ba2</span> <span class="hljs-number">100%</span>);
            <span class="hljs-attribute">min-height</span>: <span class="hljs-number">100vh</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">2rem</span>;
        }

        <span class="hljs-selector-class">.container</span> {
            <span class="hljs-attribute">max-width</span>: <span class="hljs-number">1200px</span>;
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto;
        }

        <span class="hljs-selector-tag">h1</span> {
            <span class="hljs-attribute">color</span>: white;
            <span class="hljs-attribute">text-align</span>: center;
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">1rem</span>;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">2.5rem</span>;
            <span class="hljs-attribute">text-shadow</span>: <span class="hljs-number">2px</span> <span class="hljs-number">2px</span> <span class="hljs-number">4px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.3</span>);
        }

        <span class="hljs-selector-class">.info</span> {
            <span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.95</span>);
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">1rem</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">2rem</span>;
            <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">4px</span> <span class="hljs-number">6px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>);
        }

        <span class="hljs-selector-class">.info</span> <span class="hljs-selector-tag">h2</span> {
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#667eea</span>;
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">0.5rem</span>;
        }

        <span class="hljs-selector-class">.info</span> <span class="hljs-selector-tag">p</span> {
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#4a5568</span>;
            <span class="hljs-attribute">line-height</span>: <span class="hljs-number">1.6</span>;
        }

        <span class="hljs-selector-class">.demo-grid</span> {
            <span class="hljs-attribute">display</span>: grid;
            <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-number">1</span>fr <span class="hljs-number">1</span>fr;
            <span class="hljs-attribute">gap</span>: <span class="hljs-number">2rem</span>;
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">2rem</span>;
        }

        <span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">768px</span>) {
            <span class="hljs-selector-class">.demo-grid</span> {
                <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-number">1</span>fr;
            }
        }

        <span class="hljs-selector-class">.demo-section</span> {
            <span class="hljs-attribute">background</span>: white;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">12px</span>;
            <span class="hljs-attribute">overflow</span>: hidden;
            <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">10px</span> <span class="hljs-number">25px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.2</span>);
        }

        <span class="hljs-selector-class">.demo-header</span> {
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#2d3748</span>;
            <span class="hljs-attribute">color</span>: white;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">1rem</span>;
            <span class="hljs-attribute">font-weight</span>: bold;
            <span class="hljs-attribute">display</span>: flex;
            <span class="hljs-attribute">justify-content</span>: space-between;
            <span class="hljs-attribute">align-items</span>: center;
        }

        <span class="hljs-selector-class">.demo-header</span> <span class="hljs-selector-class">.badge</span> {
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#48bb78</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">0.25rem</span> <span class="hljs-number">0.75rem</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">12px</span>;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">0.875rem</span>;
        }

        <span class="hljs-selector-class">.demo-header</span> <span class="hljs-selector-class">.badge-warning</span> {
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#f59e0b</span>;
        }

        <span class="hljs-selector-class">.code-container</span> {
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#1e1e1e</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">1.5rem</span>;
            <span class="hljs-attribute">overflow-x</span>: auto;
            <span class="hljs-attribute">min-height</span>: <span class="hljs-number">400px</span>;
        }

        <span class="hljs-selector-class">.code-block</span> {
            <span class="hljs-attribute">font-family</span>: <span class="hljs-string">'Consolas'</span>, <span class="hljs-string">'Monaco'</span>, <span class="hljs-string">'Courier New'</span>, monospace;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
            <span class="hljs-attribute">line-height</span>: <span class="hljs-number">1.6</span>;
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#d4d4d4</span>;
            <span class="hljs-attribute">white-space</span>: pre;
        }

        <span class="hljs-comment">/* CSS Highlights API Styles */</span>
        ::<span class="hljs-built_in">highlight</span>(keyword) {
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#569cd6</span>;
            <span class="hljs-attribute">font-weight</span>: bold;
        }

        ::<span class="hljs-built_in">highlight</span>(string) {
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#ce9178</span>;
        }

        ::<span class="hljs-built_in">highlight</span>(comment) {
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#6a9955</span>;
            <span class="hljs-attribute">font-style</span>: italic;
        }

        ::<span class="hljs-built_in">highlight</span>(function) {
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#dcdcaa</span>;
        }

        ::<span class="hljs-built_in">highlight</span>(number) {
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#b5cea8</span>;
        }

        ::<span class="hljs-built_in">highlight</span>(operator) {
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#d4d4d4</span>;
        }

        ::<span class="hljs-built_in">highlight</span>(punctuation) {
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#d4d4d4</span>;
        }

        ::<span class="hljs-built_in">highlight</span>(identifier) {
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#9cdcfe</span>;
        }

        <span class="hljs-comment">/* Traditional span-based highlighting */</span>
        <span class="hljs-selector-class">.token-keyword</span> {
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#569cd6</span>;
            <span class="hljs-attribute">font-weight</span>: bold;
        }

        <span class="hljs-selector-class">.token-string</span> {
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#ce9178</span>;
        }

        <span class="hljs-selector-class">.token-comment</span> {
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#6a9955</span>;
            <span class="hljs-attribute">font-style</span>: italic;
        }

        <span class="hljs-selector-class">.token-function</span> {
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#dcdcaa</span>;
        }

        <span class="hljs-selector-class">.token-number</span> {
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#b5cea8</span>;
        }

        <span class="hljs-selector-class">.token-operator</span> {
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#d4d4d4</span>;
        }

        <span class="hljs-selector-class">.token-punctuation</span> {
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#d4d4d4</span>;
        }

        <span class="hljs-selector-class">.token-identifier</span> {
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#9cdcfe</span>;
        }

        <span class="hljs-selector-class">.stats</span> {
            <span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.95</span>);
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">1.5rem</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
            <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">4px</span> <span class="hljs-number">6px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>);
        }

        <span class="hljs-selector-class">.stats</span> <span class="hljs-selector-tag">h3</span> {
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#667eea</span>;
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">1rem</span>;
        }

        <span class="hljs-selector-class">.stats-grid</span> {
            <span class="hljs-attribute">display</span>: grid;
            <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(auto-fit, <span class="hljs-built_in">minmax</span>(<span class="hljs-number">200px</span>, <span class="hljs-number">1</span>fr));
            <span class="hljs-attribute">gap</span>: <span class="hljs-number">1rem</span>;
        }

        <span class="hljs-selector-class">.stat-item</span> {
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#f7fafc</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">1rem</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">6px</span>;
            <span class="hljs-attribute">border-left</span>: <span class="hljs-number">4px</span> solid <span class="hljs-number">#667eea</span>;
        }

        <span class="hljs-selector-class">.stat-label</span> {
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#718096</span>;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">0.875rem</span>;
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">0.25rem</span>;
        }

        <span class="hljs-selector-class">.stat-value</span> {
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#2d3748</span>;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">1.5rem</span>;
            <span class="hljs-attribute">font-weight</span>: bold;
        }

        <span class="hljs-selector-class">.warning</span> {
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#fef3c7</span>;
            <span class="hljs-attribute">border-left</span>: <span class="hljs-number">4px</span> solid <span class="hljs-number">#f59e0b</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">1rem</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
            <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">1rem</span>;
        }

        <span class="hljs-selector-class">.warning</span> <span class="hljs-selector-tag">p</span> {
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#92400e</span>;
        }

        <span class="hljs-selector-class">.hidden</span> {
            <span class="hljs-attribute">display</span>: none;
        }

        <span class="hljs-selector-class">.controls</span> {
            <span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.95</span>);
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">1rem</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">2rem</span>;
            <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">4px</span> <span class="hljs-number">6px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>);
            <span class="hljs-attribute">text-align</span>: center;
        }

        <span class="hljs-selector-tag">button</span> {
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#667eea</span>;
            <span class="hljs-attribute">color</span>: white;
            <span class="hljs-attribute">border</span>: none;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">0.75rem</span> <span class="hljs-number">1.5rem</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">6px</span>;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">1rem</span>;
            <span class="hljs-attribute">cursor</span>: pointer;
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> <span class="hljs-number">0.5rem</span>;
            <span class="hljs-attribute">transition</span>: background <span class="hljs-number">0.3s</span>;
        }

        <span class="hljs-selector-tag">button</span><span class="hljs-selector-pseudo">:hover</span> {
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#5568d3</span>;
        }

        <span class="hljs-selector-tag">button</span><span class="hljs-selector-pseudo">:active</span> {
            <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(<span class="hljs-number">1px</span>);
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>🎨 CSS Highlights API 演示<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"info"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>关于此演示<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>
                此演示对比了两种语法高亮方法：现代的 <span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>CSS Highlights API<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span>（左侧）与传统的
                <span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>基于 DOM 的高亮<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span>（右侧）。CSS Highlights API 提供高性能的语法高亮，
                无需操作 DOM，将文本保持在单个文本节点中，以获得最佳渲染性能。
            <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"controls"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"remeasure()"</span>&gt;</span>🔄 重新测量性能<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"changeCode()"</span>&gt;</span>🎲 切换代码示例<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"demo-grid"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"demo-section"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"demo-header"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>CSS Highlights API<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"badge"</span>&gt;</span>现代方案<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"code-container"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">pre</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"code-block"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"highlights-demo"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">pre</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"demo-section"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"demo-header"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>传统 DOM Span 方案<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"badge badge-warning"</span>&gt;</span>传统方案<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"code-container"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">pre</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"code-block"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"traditional-demo"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">pre</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"stats"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>📊 性能对比<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"stats-grid"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"stat-item"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"stat-label"</span>&gt;</span>CSS Highlights - DOM 节点数<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"stat-value"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"highlights-nodes"</span>&gt;</span>-<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"stat-item"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"stat-label"</span>&gt;</span>传统方案 - DOM 节点数<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"stat-value"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"traditional-nodes"</span>&gt;</span>-<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"stat-item"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"stat-label"</span>&gt;</span>CSS Highlights - 渲染时间<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"stat-value"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"highlights-time"</span>&gt;</span>-<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"stat-item"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"stat-label"</span>&gt;</span>传统方案 - 渲染时间<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"stat-value"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"traditional-time"</span>&gt;</span>-<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"stat-item"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"stat-label"</span>&gt;</span>性能提升<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"stat-value"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"improvement"</span>&gt;</span>-<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"stat-item"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"stat-label"</span>&gt;</span>内存节省<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"stat-value"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"memory-saved"</span>&gt;</span>-<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"warning hidden"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"browser-warning"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>⚠️ 浏览器兼容性：<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span>您的浏览器不支持 CSS Highlights API。只有传统的高亮方法能正常工作。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-comment">// 代码示例</span>
        <span class="hljs-keyword">const</span> codeSamples = [
            <span class="hljs-string">`// JavaScript 示例
function fibonacci(n) {
    // 计算斐波那契数
    if (n &lt;= 1) return n;
    return fibonacci(n - 1) + fibonacci(n - 2);
}

const result = fibonacci(10);
console.log("结果:", result);

// 数组操作
const numbers = [1, 2, 3, 4, 5];
const doubled = numbers.map(x =&gt; x * 2);`</span>,

            <span class="hljs-string">`// React 组件
function UserProfile({ name, age }) {
    const [isActive, setActive] = useState(false);

    // 处理点击事件
    const handleClick = () =&gt; {
        setActive(!isActive);
        console.log("状态已改变");
    };

    return (
        &lt;div className="profile"&gt;
            &lt;h1&gt;{name}&lt;/h1&gt;
            &lt;p&gt;年龄: {age}&lt;/p&gt;
        &lt;/div&gt;
    );
}`</span>,

            <span class="hljs-string">`// TypeScript 接口
interface User {
    id: number;
    name: string;
    email: string;
}

function getUserData(userId: number): Promise&lt;User&gt; {
    // 获取用户数据
    return fetch(\`/api/users/\${userId}\`)
        .then(response =&gt; response.json())
        .catch(error =&gt; {
            console.error("错误:", error);
            throw error;
        });
}`</span>
        ];

        <span class="hljs-keyword">let</span> currentCodeIndex = <span class="hljs-number">0</span>;

        <span class="hljs-comment">/**
         * 词法分析器 - 将代码文本解析成 token 列表
         * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">code</span> - 要分析的源代码
         * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Array</span>} - token 数组，每个 token 包含 type, start, end, value
         */</span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">tokenize</span>(<span class="hljs-params">code</span>) {
            <span class="hljs-keyword">const</span> tokens = [];

            <span class="hljs-comment">// 定义匹配规则，顺序很重要：</span>
            <span class="hljs-comment">// 1. comment 和 string 放在最前面，确保它们内部的内容不会被其他规则匹配</span>
            <span class="hljs-comment">// 2. 后续规则按照优先级排列</span>
            <span class="hljs-keyword">const</span> patterns = [
                { <span class="hljs-attr">type</span>: <span class="hljs-string">'comment'</span>, <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/\/\/[^\n]*/g</span> },                    <span class="hljs-comment">// 单行注释</span>
                { <span class="hljs-attr">type</span>: <span class="hljs-string">'string'</span>, <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/(["'`])(?:(?=(\\?))\2.)*?\1/g</span> },   <span class="hljs-comment">// 字符串（支持单引号、双引号、模板字符串）</span>
                { <span class="hljs-attr">type</span>: <span class="hljs-string">'keyword'</span>, <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/\b(function|const|let|var|if|else|return|class|interface|async|await|import|export|from|new|typeof|instanceof)\b/g</span> }, <span class="hljs-comment">// JavaScript 关键字</span>
                { <span class="hljs-attr">type</span>: <span class="hljs-string">'number'</span>, <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/\b\d+\.?\d*\b/g</span> },                 <span class="hljs-comment">// 数字（整数和小数）</span>
                { <span class="hljs-attr">type</span>: <span class="hljs-string">'function'</span>, <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/\b[a-zA-Z_$][a-zA-Z0-9_$]*(?=\()/g</span> }, <span class="hljs-comment">// 函数名（后面跟着左括号）</span>
                { <span class="hljs-attr">type</span>: <span class="hljs-string">'operator'</span>, <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/[+\-*/%=&lt;&gt;!&amp;|^~?:]/g</span> },          <span class="hljs-comment">// 运算符</span>
                { <span class="hljs-attr">type</span>: <span class="hljs-string">'punctuation'</span>, <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/[{}[\]();,\.]/g</span> },            <span class="hljs-comment">// 标点符号</span>
            ];

            <span class="hljs-comment">// 遍历所有规则，收集匹配的 token</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> { type, regex } <span class="hljs-keyword">of</span> patterns) {
                <span class="hljs-keyword">let</span> match;
                <span class="hljs-keyword">while</span> ((match = regex.<span class="hljs-title function_">exec</span>(code)) !== <span class="hljs-literal">null</span>) {
                    tokens.<span class="hljs-title function_">push</span>({
                        type,
                        <span class="hljs-attr">start</span>: match.<span class="hljs-property">index</span>,
                        <span class="hljs-attr">end</span>: match.<span class="hljs-property">index</span> + match[<span class="hljs-number">0</span>].<span class="hljs-property">length</span>,
                        <span class="hljs-attr">value</span>: match[<span class="hljs-number">0</span>]
                    });
                }
            }

            <span class="hljs-comment">// 按起始位置排序</span>
            tokens.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">start</span> - b.<span class="hljs-property">start</span>);

            <span class="hljs-comment">// 去除重叠的 token（保留先匹配到的）</span>
            <span class="hljs-comment">// 例如：注释中的冒号不应该被 operator 规则再次匹配</span>
            <span class="hljs-keyword">const</span> filteredTokens = [];
            <span class="hljs-keyword">let</span> lastEnd = <span class="hljs-number">0</span>;

            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> token <span class="hljs-keyword">of</span> tokens) {
                <span class="hljs-keyword">if</span> (token.<span class="hljs-property">start</span> &gt;= lastEnd) {
                    filteredTokens.<span class="hljs-title function_">push</span>(token);
                    lastEnd = token.<span class="hljs-property">end</span>;
                }
            }

            <span class="hljs-keyword">return</span> filteredTokens;
        }

        <span class="hljs-comment">/**
         * 应用 CSS Highlights API 进行语法高亮
         * 核心思想：不创建额外的 DOM 节点，通过 Range 对象标记文本位置
         * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLElement</span>} <span class="hljs-variable">element</span> - 目标元素
         * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">code</span> - 源代码
         * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Object</span>} - 包含性能数据和清理函数
         */</span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">applyHighlights</span>(<span class="hljs-params">element, code</span>) {
            <span class="hljs-comment">// 检查浏览器是否支持 CSS Highlights API</span>
            <span class="hljs-keyword">if</span> (!<span class="hljs-variable constant_">CSS</span>.<span class="hljs-property">highlights</span>) {
                <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'browser-warning'</span>).<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'hidden'</span>);
                <span class="hljs-keyword">return</span> { <span class="hljs-attr">time</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">nodes</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">cleanup</span>: <span class="hljs-function">() =&gt;</span> {} };
            }

            <span class="hljs-keyword">const</span> startTime = performance.<span class="hljs-title function_">now</span>();

            <span class="hljs-comment">// 清除之前的所有高亮</span>
            <span class="hljs-variable constant_">CSS</span>.<span class="hljs-property">highlights</span>.<span class="hljs-title function_">clear</span>();

            <span class="hljs-comment">// 将代码设置为纯文本内容（只有一个 text node）</span>
            element.<span class="hljs-property">textContent</span> = code;

            <span class="hljs-keyword">const</span> textNode = element.<span class="hljs-property">firstChild</span>;
            <span class="hljs-keyword">if</span> (!textNode) <span class="hljs-keyword">return</span> { <span class="hljs-attr">time</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">nodes</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">cleanup</span>: <span class="hljs-function">() =&gt;</span> {} };

            <span class="hljs-comment">// 获取所有 token</span>
            <span class="hljs-keyword">const</span> tokens = <span class="hljs-title function_">tokenize</span>(code);

            <span class="hljs-comment">// 按 token 类型分组，每种类型对应一个 Highlight 对象</span>
            <span class="hljs-keyword">const</span> tokensByType = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> token <span class="hljs-keyword">of</span> tokens) {
                <span class="hljs-keyword">if</span> (!tokensByType.<span class="hljs-title function_">has</span>(token.<span class="hljs-property">type</span>)) {
                    tokensByType.<span class="hljs-title function_">set</span>(token.<span class="hljs-property">type</span>, []);
                }

                <span class="hljs-comment">// 创建 Range 对象标记 token 在文本中的位置</span>
                <span class="hljs-comment">// 关键：Range 只是标记位置，不修改 DOM 结构</span>
                <span class="hljs-keyword">const</span> range = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Range</span>();
                range.<span class="hljs-title function_">setStart</span>(textNode, token.<span class="hljs-property">start</span>);
                range.<span class="hljs-title function_">setEnd</span>(textNode, token.<span class="hljs-property">end</span>);
                tokensByType.<span class="hljs-title function_">get</span>(token.<span class="hljs-property">type</span>).<span class="hljs-title function_">push</span>(range);
            }

            <span class="hljs-comment">// 为每种 token 类型注册 Highlight</span>
            <span class="hljs-comment">// CSS 中的 ::highlight(keyword)、::highlight(string) 等会匹配这里注册的名称</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [type, ranges] <span class="hljs-keyword">of</span> tokensByType) {
                <span class="hljs-keyword">const</span> highlight = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Highlight</span>(...ranges);
                <span class="hljs-variable constant_">CSS</span>.<span class="hljs-property">highlights</span>.<span class="hljs-title function_">set</span>(type, highlight);
            }

            <span class="hljs-keyword">const</span> endTime = performance.<span class="hljs-title function_">now</span>();

            <span class="hljs-keyword">return</span> {
                <span class="hljs-attr">time</span>: (endTime - startTime).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>),
                <span class="hljs-attr">nodes</span>: <span class="hljs-title function_">countNodes</span>(element),
                <span class="hljs-attr">cleanup</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable constant_">CSS</span>.<span class="hljs-property">highlights</span>.<span class="hljs-title function_">clear</span>()
            };
        }

        <span class="hljs-comment">/**
         * 应用传统的基于 DOM 的语法高亮
         * 传统方法：为每个 token 创建一个 &lt;span&gt; 元素
         * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLElement</span>} <span class="hljs-variable">element</span> - 目标元素
         * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">code</span> - 源代码
         * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Object</span>} - 包含性能数据
         */</span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">applyTraditional</span>(<span class="hljs-params">element, code</span>) {
            <span class="hljs-keyword">const</span> startTime = performance.<span class="hljs-title function_">now</span>();

            <span class="hljs-keyword">const</span> tokens = <span class="hljs-title function_">tokenize</span>(code);
            <span class="hljs-keyword">let</span> html = <span class="hljs-string">''</span>;
            <span class="hljs-keyword">let</span> lastIndex = <span class="hljs-number">0</span>;

            <span class="hljs-comment">// 遍历所有 token，构建 HTML 字符串</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> token <span class="hljs-keyword">of</span> tokens) {
                <span class="hljs-comment">// 添加 token 之前的普通文本</span>
                html += escapeHtml(code.<span class="hljs-title function_">substring</span>(lastIndex, token.<span class="hljs-property">start</span>));

                <span class="hljs-comment">// 为 token 包裹 span 标签，添加对应的 class</span>
                <span class="hljs-comment">// 缺点：每个 token 都创建一个 DOM 节点，大量代码会产生数百个节点</span>
                html += <span class="hljs-string">`&lt;span class="token-<span class="hljs-subst">${token.type}</span>"&gt;<span class="hljs-subst">${escapeHtml(token.value)}</span>&lt;/span&gt;`</span>;
                lastIndex = token.<span class="hljs-property">end</span>;
            }

            <span class="hljs-comment">// 添加最后的剩余文本</span>
            html += escapeHtml(code.<span class="hljs-title function_">substring</span>(lastIndex));

            <span class="hljs-comment">// 将 HTML 字符串插入 DOM（触发浏览器解析和渲染）</span>
            element.<span class="hljs-property">innerHTML</span> = html;

            <span class="hljs-keyword">const</span> endTime = performance.<span class="hljs-title function_">now</span>();

            <span class="hljs-keyword">return</span> {
                <span class="hljs-attr">time</span>: (endTime - startTime).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>),
                <span class="hljs-attr">nodes</span>: <span class="hljs-title function_">countNodes</span>(element)
            };
        }

        <span class="hljs-comment">/**
         * HTML 转义函数 - 防止 XSS 攻击
         */</span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">escapeHtml</span>(<span class="hljs-params">text</span>) {
            <span class="hljs-keyword">const</span> div = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
            div.<span class="hljs-property">textContent</span> = text;
            <span class="hljs-keyword">return</span> div.<span class="hljs-property">innerHTML</span>;
        }

        <span class="hljs-comment">/**
         * 统计 DOM 节点数量
         * 用于对比两种方法的内存占用差异
         */</span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">countNodes</span>(<span class="hljs-params">element</span>) {
            <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">const</span> walker = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTreeWalker</span>(element, <span class="hljs-title class_">NodeFilter</span>.<span class="hljs-property">SHOW_ALL</span>);
            <span class="hljs-keyword">while</span> (walker.<span class="hljs-title function_">nextNode</span>()) count++;
            <span class="hljs-keyword">return</span> count;
        }

        <span class="hljs-comment">/**
         * 更新性能统计数据显示
         */</span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">updateStats</span>(<span class="hljs-params">highlightsResult, traditionalResult</span>) {
            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'highlights-nodes'</span>).<span class="hljs-property">textContent</span> = highlightsResult.<span class="hljs-property">nodes</span>;
            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'traditional-nodes'</span>).<span class="hljs-property">textContent</span> = traditionalResult.<span class="hljs-property">nodes</span>;
            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'highlights-time'</span>).<span class="hljs-property">textContent</span> = highlightsResult.<span class="hljs-property">time</span> + <span class="hljs-string">' ms'</span>;
            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'traditional-time'</span>).<span class="hljs-property">textContent</span> = traditionalResult.<span class="hljs-property">time</span> + <span class="hljs-string">' ms'</span>;

            <span class="hljs-comment">// 计算性能提升百分比</span>
            <span class="hljs-keyword">const</span> improvement = ((traditionalResult.<span class="hljs-property">time</span> - highlightsResult.<span class="hljs-property">time</span>) / traditionalResult.<span class="hljs-property">time</span> * <span class="hljs-number">100</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">1</span>);
            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'improvement'</span>).<span class="hljs-property">textContent</span> = improvement + <span class="hljs-string">'%'</span>;

            <span class="hljs-comment">// 计算内存节省百分比</span>
            <span class="hljs-keyword">const</span> memorySaved = ((traditionalResult.<span class="hljs-property">nodes</span> - highlightsResult.<span class="hljs-property">nodes</span>) / traditionalResult.<span class="hljs-property">nodes</span> * <span class="hljs-number">100</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">1</span>);
            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'memory-saved'</span>).<span class="hljs-property">textContent</span> = memorySaved + <span class="hljs-string">'%'</span>;
        }

        <span class="hljs-comment">/**
         * 渲染代码并应用两种高亮方法
         */</span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">renderCode</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">const</span> code = codeSamples[currentCodeIndex];
            <span class="hljs-keyword">const</span> highlightsElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'highlights-demo'</span>);
            <span class="hljs-keyword">const</span> traditionalElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'traditional-demo'</span>);

            <span class="hljs-comment">// 分别应用两种方法，对比性能差异</span>
            <span class="hljs-keyword">const</span> highlightsResult = <span class="hljs-title function_">applyHighlights</span>(highlightsElement, code);
            <span class="hljs-keyword">const</span> traditionalResult = <span class="hljs-title function_">applyTraditional</span>(traditionalElement, code);

            <span class="hljs-title function_">updateStats</span>(highlightsResult, traditionalResult);
        }

        <span class="hljs-comment">/**
         * 切换代码示例
         */</span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">changeCode</span>(<span class="hljs-params"/>) {
            currentCodeIndex = (currentCodeIndex + <span class="hljs-number">1</span>) % codeSamples.<span class="hljs-property">length</span>;
            <span class="hljs-title function_">renderCode</span>();
        }

        <span class="hljs-comment">/**
         * 重新测量性能
         */</span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">remeasure</span>(<span class="hljs-params"/>) {
            <span class="hljs-title function_">renderCode</span>();
        }

        <span class="hljs-comment">// 页面加载完成后初始化</span>
        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'DOMContentLoaded'</span>, renderCode);
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一行代码的“法律陷阱”：开发者必须了解的开源许可证知识]]></title>    <link>https://juejin.cn/post/7571641339689205760</link>    <guid>https://juejin.cn/post/7571641339689205760</guid>    <pubDate>2025-11-12T13:21:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571641339689205760" data-draft-id="7571650164844003362" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一行代码的“法律陷阱”：开发者必须了解的开源许可证知识"/> <meta itemprop="keywords" content="后端,前端,开源"/> <meta itemprop="datePublished" content="2025-11-12T13:21:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Konata_9"/> <meta itemprop="url" content="https://juejin.cn/user/888061123629997"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一行代码的“法律陷阱”：开发者必须了解的开源许可证知识
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/888061123629997/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Konata_9
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T13:21:47.000Z" title="Wed Nov 12 2025 13:21:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>事情是这样的：我之前在开发一个 PGP 加密的功能。在 Node.js 生态中寻觅了一番后，我找到了一个近乎完美的库——<code>openpgp.js</code>。它的 Star 数很高，社区活跃，文档齐全，API 设计也相当优雅，完美契合我的需求。</p>
<p>但当我整理好设计方案并向团队介绍我找到的这个“神器”时，我的老大提出了一个关键的问题：</p>
<p>“这个库用的是什么开源许可证？”</p>
<p>我心里咯噔一下，因为我知道公司对开源许可证有严格的要求。但 <code>openpgp.js</code> 用的是 LGPL 许可证，在项目中也只是引用。因此我并没觉得这是个大问题。</p>
<p>于是我回答道：“是 LGPL，但我们只是在项目中引用。怎么了？”</p>
<p>老大的回复很坚决：“不行，LGPL 有风险，我们不能在商业闭源项目中使用。你得换一个库。”</p>
<p>预料中的结果还是发生了。一个功能强大、社区活跃的库，就因为一个“许可证”被拒之门外了。因为对于商业项目来说，法律的合规性远比功能来得更重要。</p>
<p>而“开源软件许可证”这个日常与我们开发者打交道、却常常忽略的小事，背后可能隐藏着巨大的法律风险。</p>
<p>所以，我想把我的这段经历和学习心得整理出来，变成一篇极简指南。希望它能帮助你，在选择依赖库时不会陷入法律困境。</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9d70a829e9244bf93e51ffcd6097276~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS29uYXRhXzk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763558507&amp;x-signature=A8aeq3yTBwYRedQF%2FeQdV1ZElyM%3D" alt="" loading="lazy"/></p>

<h2 data-id="heading-0">许可证：一行代码背后的“法律合同”</h2>
<p>有开发者会想，“不就是一个许可证吗？有那么严重？”</p>
<p>答案是：<strong>非常严重</strong>。</p>
<p>与印象中的文档不同：<strong>开源许可证在法律上通常被视为一份具有约束力的合同</strong>。当你下载并使用一个开源项目时，就意味着你默认同意了这份“合同”的所有条款。它不再仅仅是一个道德上的建议，而是一份具备法律效力的文件。</p>
<p>开源运动的初衷是为了“自由”与“共享”，但这种自由并非毫无边界。许可证正是为了保护作者的权利，并明确使用者在何种条件下可以“自由”地使用、修改和分发代码而存在的。</p>
<p>一旦你违反了这份“合同”，就可能面临严重的法律后果。国内外已有不少公司为此付出了惨痛的代价。</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abfe168904434fb6bb4c2ae800867727~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS29uYXRhXzk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763558507&amp;x-signature=b%2BhZ%2FLfyUBbTcH9Cc0kONOfo7jQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-1">真实的“踩坑”案例</h3>
<p>在国内，一个非常著名的案例是“罗盒公司诉玩友公司案”。简单来说，玩友公司在其商业产品中使用了遵循 <code>GPL 3.0</code> 协议的开源代码，但并未按照协议要求将自己的产品也开源。最终，法院判决玩友公司败诉，不仅需要停止侵权行为，还赔偿了原告 50 万元。</p>
<p>这个案例清晰地传递了一个信号：在中国，违反开源许可证就是一种侵权行为，需要承担法律责任。</p>
<p>在国外，类似的案例更是屡见不鲜。例如，法国的 Orange 公司因在其商业软件中违规使用了 <code>GPLv2</code> 许可的组件，最终被判赔偿高达数十万欧元。</p>
<p>这些案例告诉我们，忽视开源许可证可能导致：</p>
<ol>
<li><strong>高额赔偿</strong>：你需要为你的侵权行为支付经济赔偿。</li>
<li><strong>强制开源</strong>：对于像 <code>GPL</code> 这样具有“传染性”的许可证，你可能被迫将整个项目的源代码公之于众，这对于商业公司来说是致命的打击。</li>
<li><strong>产品下架</strong>：法院会判令你停止所有侵权行为，意味着你的产品需要立刻下架，所有努力付诸东流。</li>
</ol>
<p>原来我们日常工作中随手 <code>npm install</code> 的一个库，背后竟然隐藏着如此大的学问和风险。</p>
<h2 data-id="heading-2">化繁为简：三分钟看懂主流开源许可证</h2>
<p>工作中离开开源软件会让我们举步维艰。在用好开源软件的同时，我们要做的是学会如何安全、合规地从中寻宝。第一步，就是看懂宝藏上的“标签”——也就是各种各样的开源许可证。</p>
<p>许可证的种类繁多，但对于我们日常开发者来说，只需要了解最主流的几种就足够了。为了方便理解，我把它们形象地分成了三个“派别”：</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/222f4d3dab3347f38223e5f4d3a39bc2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS29uYXRhXzk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763558507&amp;x-signature=KLhcQXXWbr7mMxRIqAFMc9JzQ9c%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">1. “宽容派” (Permissive)</h3>
<p>这个派别的许可证非常慷慨，限制最少，几乎允许你做任何事情。</p>
<ul>
<li><strong>代表</strong>：<code>MIT</code>、<code>Apache 2.0</code>、<code>BSD</code></li>
<li><strong>核心思想</strong>：“代码你随便用，用在商业项目里也完全没问题。你唯一需要做的，就是在你的项目中保留我的版权声明，告诉别人这里用了我的代码。至于你的项目是否开源，我不在乎。”</li>
<li><strong>一句话总结</strong>：你想怎么用就怎么用，但请记得“署名”。</li>
</ul>
<h3 data-id="heading-4">2. “互惠派” (Copyleft)</h3>
<p>这个派别的许可证强调“共享”与“回馈”，如果你使用了它的代码，你也需要做出同样的贡献。</p>
<ul>
<li><strong>代表</strong>：<code>GPL</code> (General Public License)</li>
<li><strong>核心思想</strong>：“欢迎使用我的代码，但有一个条件：任何使用了我的代码的项目，也必须同样以 <code>GPL</code> 协议开源。我们要做大做强，再创辉煌，大家一起为爱发电！”</li>
<li><strong>一句话总结</strong>：用了我的，你的也得是大家的。</li>
</ul>
<p><code>GPL</code> 因为这个特性，也被称为具有“传染性”的许可证。这也是为什么商业闭源项目通常对它避之不及。</p>
<h3 data-id="heading-5">3. “折中派” (Weak Copyleft)</h3>
<p>这个派别介于前两者之间，试图在“自由使用”和“强制开源”之间找到一个平衡。</p>
<ul>
<li><strong>代表</strong>：<code>LGPL</code> (Lesser General Public License)、<code>Mozilla (MPL)</code></li>
<li><strong>核心思想</strong>：“我的代码你可以用。如果你只是‘引用’我（比如通过动态链接的方式使用我的库），那你的项目可以不开源。但如果你‘修改’了我的代码，或者将我的代码静态编译到你的项目中，那么你修改或集成的部分就需要开源。”</li>
<li><strong>一句话总结</strong>：你可以用我，但别想“白嫖”我的核心代码。</li>
</ul>
<p>这也就是为什么我最初选择的 <code>openpgp.js</code> (使用 LGPL) 会被 Leader 否决的原因。因为在商业项目中，我们很难清晰地界定“引用”和“修改”的边界，为了规避法律风险，最稳妥的方式就是不使用。</p>
<h3 data-id="heading-6">主流许可证对比</h3>
<p>为了让你更直观地理解它们的区别，我整理了一个表格：</p>






















































<table><thead><tr><th align="left">特性</th><th align="left">MIT</th><th align="left">Apache 2.0</th><th align="left">GPL</th><th align="left">LGPL</th></tr></thead><tbody><tr><td align="left"><strong>能否商用</strong></td><td align="left">✅</td><td align="left">✅</td><td align="left">✅</td><td align="left">✅</td></tr><tr><td align="left"><strong>能否闭源</strong></td><td align="left">✅</td><td align="left">✅</td><td align="left">❌</td><td align="left">✅ (有限制)</td></tr><tr><td align="left"><strong>是否需声明版权</strong></td><td align="left">✅</td><td align="left">✅</td><td align="left">✅</td><td align="left">✅</td></tr><tr><td align="left"><strong>是否需开源衍生代码</strong></td><td align="left">❌</td><td align="left">❌</td><td align="left">✅</td><td align="left">✅ (修改部分)</td></tr><tr><td align="left"><strong>专利授权</strong></td><td align="left">❌</td><td align="left">✅</td><td align="left">✅</td><td align="left">✅</td></tr><tr><td align="left"><strong>一句话总结</strong></td><td align="left">随便用，带上我名</td><td align="left">随便用，带上我名，别告我</td><td align="left">你的也得开源</td><td align="left">修改我的部分得开源</td></tr></tbody></table>
<h2 data-id="heading-7">开发者行动指南：如何安全地“寻宝”</h2>
<p>好了，现在我们既了解了风险，也看懂了规则。那么在实际工作中，我们到底该如何操作呢？</p>
<h3 data-id="heading-8">场景一：我想开源自己的项目，该选哪个许可证？</h3>
<p>当你准备将自己的心血贡献给开源社区时，选择一个合适的许可证至关重要。你可以问自己以下几个问题：</p>
<ol>
<li>
<p><strong>你是否希望你的项目被广泛使用，甚至被商业公司使用？</strong></p>
<ul>
<li><strong>是</strong>：那么 <code>MIT</code> 或 <code>Apache 2.0</code> 是你的最佳选择。它们足够“宽容”，可以最大程度地促进你的项目传播。</li>
<li><strong>否/无所谓</strong>：进入下一个问题。</li>
</ul>
</li>
<li>
<p><strong>你是否担心别人用了你的代码后，申请了专利反过来告你？</strong></p>
<ul>
<li><strong>是</strong>：选择 <code>Apache 2.0</code>。它明确授予了专利许可，可以更好地保护你和所有使用者。</li>
<li><strong>否</strong>：<code>MIT</code> 更简单，是许多小型项目的首选。</li>
</ul>
</li>
<li>
<p><strong>你是否希望所有使用了你代码的人，都必须把他们的成果也开源出来，共同壮大社区？</strong></p>
<ul>
<li><strong>是</strong>：那么 <code>GPL</code> 是你的不二之选。选择它，就意味着你选择了一条“纯粹”的开源路线。</li>
</ul>
</li>
</ol>
<p><strong>一图流总结：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[我想开源一个项目] --&gt; B{希望被广泛商用吗？};
    B --&gt;|是| C{担心专利问题吗？};
    B --&gt;|否| D[选择 GPL];
    C --&gt;|是| E[选择 Apache 2.0];
    C --&gt;|否| F[选择 MIT];
</code></pre>
<h3 data-id="heading-9">场景二：我的（商业）项目需要引入一个第三方库，该怎么做？</h3>
<p>这是我们工作中更常遇到的情况，也是风险最高的地方。请严格遵循以下“安全检查流程”：</p>
<ol>
<li>
<p><strong>第一步：检查许可证！</strong></p>
<ul>
<li>在 <code>npm</code> 官网上，每个包的右侧都会清晰地标明其许可证。</li>
<li>在 <code>GitHub</code> 项目的根目录，通常会有一个名为 <code>LICENSE</code> 或 <code>LICENSE.md</code> 的文件。</li>
</ul>
</li>
<li>
<p><strong>第二步：看到 <code>GPL</code> / <code>AGPL</code>？立刻停车！</strong></p>
<ul>
<li>除非你的项目本身就是开源的，或者你已经咨询过公司的法务部门，否则<strong>不要在任何商业闭源项目中使用 <code>GPL</code> 或 <code>AGPL</code> 协议的库</strong>。这是最重要的一条红线。</li>
</ul>
</li>
<li>
<p><strong>第三步：看到 <code>LGPL</code>？谨慎驾驶！</strong></p>
<ul>
<li>如前文所述，<code>LGPL</code> 的界定相对模糊。为了 100% 规避风险，大多数商业公司的策略是：<strong>同样不使用</strong>。寻找一个采用更宽松许可证的替代品，永远是更安全的选择。</li>
</ul>
</li>
<li>
<p><strong>第四步：看到 <code>MIT</code> / <code>Apache 2.0</code> / <code>BSD</code>？安全通过！</strong></p>
<ul>
<li>这些“宽容派”的许可证是商业项目的好朋友。你可以放心地使用它们。</li>
<li><strong>但别忘了</strong>：虽然可以放心用，但你仍然有义务遵守它们的约定，即<strong>在你的项目中保留原始的版权声明</strong>。通常的做法是，在你的产品的“关于”页面、文档或某个角落，列出所有你使用到的开源组件及其许可证信息。</li>
</ul>
</li>
</ol>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63d94ada39d0424d8ad470a8e12bb6a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS29uYXRhXzk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763558507&amp;x-signature=%2BdmkuQV31wOXO2Wzr6u5YJANR64%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">结语</h2>
<p>开源世界波澜壮阔，它建立在无数开发者无私的“信任”基石之上。而许可证，就是这份信任的契约。</p>
<p>了解并尊重它，不仅仅是为了规避法律风险，更是为了守护这份来之不易的信任，维护整个开源生态的健康与繁荣。我们享受着开源带来的便利，也应成为这份契约的守护者。</p>
<p>希望这篇极简指南，能让你在未来的开源“寻宝”之路上，走得更稳、更远，也能让你在贡献自己力量的时候，更加从容和自信。</p>
<h2 data-id="heading-11">参考资料</h2>
<p>[1] <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.guantao.com%2Fpage3260" target="_blank" title="https://www.guantao.com/page3260" ref="nofollow noopener noreferrer">开源许可证的法律效力探析 - 冠韬律师事务所</a>
[2] <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.zhichanli.com%2Fp%2F158105840" target="_blank" title="https://www.zhichanli.com/p/158105840" ref="nofollow noopener noreferrer">“罗盒”诉“玩友”案：GPL 3.0 协议在中国的首次司法实践 - 知产力</a>
[3] <a href="https://link.juejin.cn?target=https%3A%2F%2Fopenatom.cn%2Fjournalism%2Farticle%2FMViMjQL31wMm" target="_blank" title="https://openatom.cn/journalism/article/MViMjQL31wMm" ref="nofollow noopener noreferrer">开源司法经典案例回顾 - 开放原子开源基金会</a>
[4] <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.zhichanli.com%2Fp%2F201624844" target="_blank" title="https://www.zhichanli.com/p/201624844" ref="nofollow noopener noreferrer">开源软件与法：如何正确使用开源软件 - 知产力</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[typescript 方法前面加* 是什么意思]]></title>    <link>https://juejin.cn/post/7571655312799416346</link>    <guid>https://juejin.cn/post/7571655312799416346</guid>    <pubDate>2025-11-12T13:47:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571655312799416346" data-draft-id="7571695634941984795" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="typescript 方法前面加* 是什么意思"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-12T13:47:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="倚栏听风雨"/> <meta itemprop="url" content="https://juejin.cn/user/2682464103830750"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            typescript 方法前面加* 是什么意思
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2682464103830750/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    倚栏听风雨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T13:47:37.000Z" title="Wed Nov 12 2025 13:47:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 TypeScript 中，方法前面加 <code>*</code> 表示这是一个 <strong>生成器函数（Generator Function）</strong> 。</p>
<h2 data-id="heading-0">基本语法</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span>* <span class="hljs-title function_">sendMessageStream</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 函数体</span>
    <span class="hljs-keyword">yield</span> <span class="hljs-string">"消息1"</span>;
    <span class="hljs-keyword">yield</span> <span class="hljs-string">"消息2"</span>;
    <span class="hljs-keyword">yield</span> <span class="hljs-string">"消息3"</span>;
}
</code></pre>
<h2 data-id="heading-1">生成器函数的特点</h2>
<h3 data-id="heading-2">1. 使用 <code>yield</code> 关键字</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span>* <span class="hljs-title function_">messageGenerator</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">yield</span> <span class="hljs-string">"Hello"</span>;
    <span class="hljs-keyword">yield</span> <span class="hljs-string">"World"</span>;
    <span class="hljs-keyword">yield</span> <span class="hljs-string">"!"</span>;
}

<span class="hljs-keyword">const</span> generator = <span class="hljs-title function_">messageGenerator</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(generator.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value: "Hello", done: false }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(generator.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value: "World", done: false }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(generator.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value: "!", done: false }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(generator.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value: undefined, done: true }</span>
</code></pre>
<h3 data-id="heading-3">2. 可暂停和恢复执行</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span>* <span class="hljs-title function_">countGenerator</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">while</span> (count &lt; <span class="hljs-number">3</span>) {
        <span class="hljs-keyword">yield</span> count++;
    }
}

<span class="hljs-keyword">const</span> counter = <span class="hljs-title function_">countGenerator</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(counter.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// 0</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(counter.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// 1</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(counter.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// 2</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(counter.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// undefined</span>
</code></pre>
<h2 data-id="heading-4">实际应用场景</h2>
<h3 data-id="heading-5">1. 消息流处理（如 <code>sendMessageStream</code>）</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span>* <span class="hljs-title function_">sendMessageStream</span>(<span class="hljs-params">messages: <span class="hljs-built_in">string</span>[]</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> message <span class="hljs-keyword">of</span> messages) {
        <span class="hljs-comment">// 可以在这里添加处理逻辑</span>
        <span class="hljs-keyword">const</span> processedMessage = <span class="hljs-string">`[<span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString()}</span>] <span class="hljs-subst">${message}</span>`</span>;
        <span class="hljs-keyword">yield</span> processedMessage;
        
        <span class="hljs-comment">// 模拟一些延迟或条件</span>
        <span class="hljs-keyword">if</span> (message === <span class="hljs-string">"stop"</span>) {
            <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 结束生成器</span>
        }
    }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> messages = [<span class="hljs-string">"消息1"</span>, <span class="hljs-string">"消息2"</span>, <span class="hljs-string">"stop"</span>, <span class="hljs-string">"消息3"</span>];
<span class="hljs-keyword">const</span> stream = <span class="hljs-title function_">sendMessageStream</span>(messages);

<span class="hljs-keyword">let</span> result = stream.<span class="hljs-title function_">next</span>();
<span class="hljs-keyword">while</span> (!result.<span class="hljs-property">done</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result.<span class="hljs-property">value</span>);
    result = stream.<span class="hljs-title function_">next</span>();
}
</code></pre>
<h3 data-id="heading-6">2. 无限序列</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span>* <span class="hljs-title function_">idGenerator</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">let</span> id = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-keyword">yield</span> id++;
    }
}

<span class="hljs-keyword">const</span> idGen = <span class="hljs-title function_">idGenerator</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(idGen.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// 1</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(idGen.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// 2</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(idGen.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// 3</span>
<span class="hljs-comment">// 可以无限继续...</span>
</code></pre>
<h3 data-id="heading-7">3. 状态机</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span>* <span class="hljs-title function_">trafficLight</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-keyword">yield</span> <span class="hljs-string">"red"</span>;
        <span class="hljs-keyword">yield</span> <span class="hljs-string">"yellow"</span>;
        <span class="hljs-keyword">yield</span> <span class="hljs-string">"green"</span>;
    }
}

<span class="hljs-keyword">const</span> light = <span class="hljs-title function_">trafficLight</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(light.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// "red"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(light.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// "yellow"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(light.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// "green"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(light.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// "red"</span>
</code></pre>
<h2 data-id="heading-8">与异步生成器的区别</h2>
<h3 data-id="heading-9">普通生成器</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span>* <span class="hljs-title function_">syncGenerator</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">yield</span> <span class="hljs-number">1</span>;
    <span class="hljs-keyword">yield</span> <span class="hljs-number">2</span>;
    <span class="hljs-keyword">yield</span> <span class="hljs-number">3</span>;
}
</code></pre>
<h3 data-id="heading-10">异步生成器（ES2018+）</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span>* <span class="hljs-title function_">asyncSendMessageStream</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">yield</span> <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchMessage1</span>();
    <span class="hljs-keyword">yield</span> <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchMessage2</span>();
    <span class="hljs-keyword">yield</span> <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchMessage3</span>();
}

<span class="hljs-comment">// 使用 for await...of</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">processMessages</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> message <span class="hljs-keyword">of</span> <span class="hljs-title function_">asyncSendMessageStream</span>()) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(message);
    }
}
</code></pre>
<h2 data-id="heading-11">在类中的使用</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageService</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-attr">messages</span>: <span class="hljs-built_in">string</span>[] = [];
    
    *<span class="hljs-title function_">sendMessageStream</span>(): <span class="hljs-title class_">Generator</span>&lt;<span class="hljs-built_in">string</span>&gt; {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> message <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">messages</span>) {
            <span class="hljs-keyword">yield</span> <span class="hljs-string">`Processed: <span class="hljs-subst">${message}</span>`</span>;
        }
    }
    
    <span class="hljs-comment">// 异步版本</span>
    <span class="hljs-keyword">async</span> *<span class="hljs-title function_">sendAsyncMessageStream</span>(): <span class="hljs-title class_">AsyncGenerator</span>&lt;<span class="hljs-built_in">string</span>&gt; {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> message <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">messages</span>) {
            <span class="hljs-comment">// 模拟异步操作</span>
            <span class="hljs-keyword">const</span> processed = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processMessageAsync</span>(message);
            <span class="hljs-keyword">yield</span> processed;
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">processMessageAsync</span>(<span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-string">`Async: <span class="hljs-subst">${message}</span>`</span>;
    }
}
</code></pre>
<h2 data-id="heading-12">实际用例：分页数据流</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span>* <span class="hljs-title function_">paginatedDataStream</span>(<span class="hljs-params">pageSize: <span class="hljs-built_in">number</span> = <span class="hljs-number">10</span></span>) {
    <span class="hljs-keyword">let</span> page = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">let</span> hasMore = <span class="hljs-literal">true</span>;
    
    <span class="hljs-keyword">while</span> (hasMore) {
        <span class="hljs-comment">// 模拟 API 调用获取分页数据</span>
        <span class="hljs-keyword">const</span> data = <span class="hljs-title function_">fetchPageData</span>(page, pageSize);
        
        <span class="hljs-keyword">if</span> (data.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
            hasMore = <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 没有更多数据</span>
        }
        
        <span class="hljs-keyword">yield</span> data;
        page++;
        
        <span class="hljs-comment">// 可以添加条件来停止</span>
        <span class="hljs-keyword">if</span> (page &gt; <span class="hljs-number">100</span>) { <span class="hljs-comment">// 安全限制</span>
            hasMore = <span class="hljs-literal">false</span>;
        }
    }
}

<span class="hljs-comment">// 模拟分页数据获取</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchPageData</span>(<span class="hljs-params">page: <span class="hljs-built_in">number</span>, pageSize: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">any</span>[] {
    <span class="hljs-comment">// 返回模拟数据</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: pageSize }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> ({
        <span class="hljs-attr">id</span>: page * pageSize + i,
        <span class="hljs-attr">content</span>: <span class="hljs-string">`Item <span class="hljs-subst">${page * pageSize + i}</span>`</span>
    }));
}
</code></pre>
<h2 data-id="heading-13">总结</h2>
<p>方法前加 <code>*</code> 表示生成器函数：</p>
<ul>
<li><strong>可暂停执行</strong>：使用 <code>yield</code> 暂停函数执行并返回值</li>
<li><strong>保持状态</strong>：函数调用之间的状态会被保留</li>
<li><strong>惰性求值</strong>：值在需要时才生成</li>
<li><strong>迭代协议</strong>：遵循迭代器协议，可与 <code>for...of</code> 循环配合使用</li>
</ul>
<p>对于 <code>sendMessageStream</code> 这样的方法，很可能是用于：</p>
<ul>
<li>逐步发送消息</li>
<li>处理消息流</li>
<li>实现某种状态机或序列生成</li>
<li>分批次处理数据</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解密“混合专家模型” (MoE) 的全部魔法]]></title>    <link>https://juejin.cn/post/7571644531608780846</link>    <guid>https://juejin.cn/post/7571644531608780846</guid>    <pubDate>2025-11-12T12:10:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571644531608780846" data-draft-id="7571695634941509659" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解密“混合专家模型” (MoE) 的全部魔法"/> <meta itemprop="keywords" content="人工智能,LLM"/> <meta itemprop="datePublished" content="2025-11-12T12:10:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mwq30123"/> <meta itemprop="url" content="https://juejin.cn/user/3403743729030686"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解密“混合专家模型” (MoE) 的全部魔法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3403743729030686/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mwq30123
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T12:10:03.000Z" title="Wed Nov 12 2025 12:10:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">解密“混合专家模型” (MoE) 的全部魔法</h2>
<p>在当今大语言模型 (LLM) 的竞赛中，您一定听说过 GPT-4、Mixtral 8x7B 这样的“巨无霸”。它们之所以能在保持惊人性能的同时实现高效推理，背后都指向一个共同的架构——<strong>MoE (Mixture of Experts) 混合专家模型</strong>。</p>
<p>MoE 不是一个全新的概念，它的思想最早在 1991 年（Jacobs, Hinton 等）就被提出。但直到这个“大模型”时代，它“稀疏激活”的核心思想才真正得以大放异彩。</p>
<p>这篇博客将汇总我们之前的所有讨论，带您从 MoE 的核心思想出发，一路深入到它最底层的训练“黑魔法”，彻底搞懂它高效运转的全部秘密。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fc03e35368644058284f913d17b083b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbXdxMzAxMjM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554221&amp;x-signature=CCnHdmAPPmRrJcJW1MxhchG90Ec%3D" alt="MoE.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-1">篇章一：MoE 的核心思想——“分而治之”</h3>
<h4 data-id="heading-2">什么是 MoE？一个“专家委员会”的比喻</h4>
<p>要理解 MoE，我们可以先想象一个“专家委员会”：</p>
<ul>
<li>
<p>传统的“密集”模型 (Dense Model)：</p>
<p>就像一个试图精通所有领域的“通才”。当遇到任何问题时，这个“通才”必须调动他全部的知识（模型的全部参数）来思考。当模型变得非常大时，这个过程会极其缓慢且耗费资源。</p>
</li>
<li>
<p>MoE 混合专家模型：</p>
<p>就像一个拥有多名“专科医生”的医院。医院里有心脏科专家、神经科专家、骨科专家等（这就是 Experts）。</p>
<ol>
<li>当一个病人（<strong>输入数据</strong>，例如一个 Token）到来时，会先去“分诊台”（这就是 <strong>Gating Network</strong> 或 <strong>Router</strong>）。</li>
<li>“分诊台”会快速判断：“你这个问题，看起来最需要心脏科和神经科的专家会诊。”</li>
<li>于是，<strong>只有</strong>这两位专家被“激活”（Active）并参与工作。其他专家则继续“休息”，不消耗计算资源。</li>
<li>最后，“分诊台”将两位专家的诊断结果（<strong>输出</strong>）汇总起来，给出一个综合的答案。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-3">MoE 的“魔法”：总参数 vs 激活参数</h4>
<p>MoE 架构（尤其是“稀疏 MoE”）解决了大型模型的一个核心痛点：<strong>如何在不增加计算成本的前提下，极大地扩展模型的知识容量（参数量）</strong> 。</p>
<p>这就引出了两个关键概念：</p>
<ol>
<li>
<p>总参数量 (Total Parameters)：</p>
<p>模型所有专家参数的总和。这代表了模型的“知识库”有多庞大。</p>
<ul>
<li>例如，<strong>Mixtral 8x7B</strong> 拥有 8 个 7B（70亿）参数的专家，总参数量约 47B。</li>
</ul>
</li>
<li>
<p>激活参数量 (Active Parameters)：</p>
<p>处理单个 Token 时，实际参与计算的参数量。这决定了模型的“推理速度”。</p>
<ul>
<li>Mixtral 8x7B 在处理每个 Token 时，只激活 8 个专家中的 2 个 (Top-K=2)。</li>
<li>因此，它实际的计算量大约只和一个 12B-14B 的密集模型相当。</li>
</ul>
</li>
</ol>
<p><strong>结论：</strong> MoE 允许我们拥有一个 47B 量级的“知识库”，但享受的却是 14B 量级的“推理速度”！</p>
<h4 data-id="heading-4">为什么只选 K=2（少数）而不是 K=8（全部）？</h4>
<p>这正是 MoE 的全部意义所在。</p>
<ul>
<li><strong>激活 K=2 (稀疏激活)</strong> ：用 14B 的计算成本，撬动 47B 的知识库。 <strong>（高效）</strong></li>
<li><strong>激活 K=8 (密集激活)</strong> ：用 47B 的计算成本，撬动 47B 的知识库。 <strong>（昂贵）</strong></li>
</ul>
<p>如果你激活了全部 8 个专家，MoE 就退化成了一个普通的、巨大且缓慢的密集模型，完全丧失了其计算优势。</p>
<hr/>
<h3 data-id="heading-5">篇章二：MoE 的架构与实践</h3>
<h4 data-id="heading-6">核心组件（一）：专家 (Experts)</h4>
<p>在 Transformer 架构中，MoE 通常被应用在 FFN（前馈网络）层。这意味着“专家”本身通常就是多个独立的 FFN 网络。</p>
<p>在训练过程中，每个 FFN 专家会逐渐“学会”处理特定类型的数据、模式或概念。比如，一个专家可能擅长处理编程代码，另一个专家可能擅长处理诗歌。</p>
<h4 data-id="heading-7">核心组件（二）：门控网络 (Gating Network)</h4>
<p>这是 MoE 的“大脑”和“调度中心”。它的理论基础是**“可学习的加权平均” (Learnable Weighted Averaging)**。</p>
<p>其工作流程如下：</p>
<ol>
<li><strong>打分 (Logits)</strong> ：门控网络（通常是一个小型的线性层）接收一个 Token，并为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span> 个专家中的每一个都打一个“分数”。</li>
<li><strong>归一化 (Softmax)</strong> ：使用 Softmax 函数将这些分数转换成“权重”或“概率”（总和为 1）。例如 <code>[0.1, 0.05, 0.6, ..., 0.25]</code>。</li>
<li><strong>Top-K 选择</strong>：选择权重最高的 K 个（例如 K=2）专家。</li>
<li><strong>加权输出</strong>：模型只激活这 K 个专家，并将它们的输出，按照 Gating 给出的权重进行“加权平均”，得到最终的输出。</li>
</ol>
<p>Gating 网络和专家是一起训练的。Gating 会学会“如何分配权重”才能让模型的总损失最小。久而久之，它就学会了：“遇到代码，找 3 号和 7 号专家。”</p>
<h4 data-id="heading-8">MoE 与 CNN 多通道的类比</h4>
<p>这是一个非常好的类比，能帮我们深入理解其机制：</p>
<ul>
<li>
<p><strong>相似之处 (专业分工)</strong> ：</p>
<ul>
<li>CNN 的不同通道 (Channel) 提取不同特征（如边缘、颜色）。</li>
<li>MoE 的不同专家 (Expert) 处理不同概念（如代码、法律）。</li>
</ul>
</li>
<li>
<p><strong>根本区别 (密集 vs 稀疏)</strong> ：</p>
<ul>
<li><strong>CNN 是“密集”的</strong>：所有通道都会被<em>同时</em>激活和计算。</li>
<li><strong>MoE 是“稀疏”的</strong>：只有被选中的 Top-K 专家被激活。如果 Gating 认为这个 Token 是代码，它就<em>只</em>去激活“代码专家”。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-9">MoE 模型的生命周期</h4>
<p>MoE 架构贯穿了模型的所有阶段：</p>
<ol>
<li>
<p><strong>预训练 (Pre-training)</strong> ：<strong>MoE 诞生和学习的阶段</strong>。</p>
<ul>
<li>专家在海量数据中“专业化”。</li>
<li>Gating 网络学会如何“路由”。</li>
<li>（关键）模型学会“负载均衡”。</li>
</ul>
</li>
<li>
<p><strong>微调 (Fine-tuning)</strong> ：<strong>MoE 适应和优化的阶段</strong>。</p>
<ul>
<li>在特定任务（如问答）上，Gating 和 Experts 的参数被进一步调整和优化。</li>
</ul>
</li>
<li>
<p><strong>生成/推理 (Inference)</strong> ：<strong>MoE 展现优势的阶段</strong>。</p>
<ul>
<li>Gating 为<em>每一个</em>生成的 Token <strong>实时动态地</strong>选择 Top-K 专家。</li>
<li>这就是我们享受到“稀疏激活”带来高速推理的时刻。</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-10">篇章三：MoE 训练的“黑魔法”——负载均衡 (Load Balancing)</h3>
<p>我们已经知道了 MoE 的美好，但它在训练中有一个致命问题： <strong>“明星专家”问题</strong>。</p>
<p>如果没有约束，Gating 网络可能会很快发现 3 号专家“比较聪明”，于是它“偷懒”地把所有任务都交给 3 号。这会导致：</p>
<ul>
<li><strong>明星专家 (Star Expert)</strong> ：3 号专家“过劳”，见识了所有数据。</li>
<li><strong>摸鱼专家 (Lazy Experts)</strong> ：其他 7 个专家“无所事事”，它们的参数完全得不到训练，被白白浪费。</li>
</ul>
<p>为了解决这个问题，MoE 引入了一个“惩罚”机制，称为<strong>负载均衡 (Load Balancing)</strong> 。</p>
<h4 data-id="heading-11"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>balance</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{balance}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：惩罚明星专家的“辅助损失”</h4>
<p>这个机制的理念非常像“权重衰减 (Weight Decay)”——它通过施加“惩罚”来防止模型过分依赖某几个专家。</p>
<p>在训练时，模型的总损失 (Total Loss) 由两部分组成：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>total</mtext></msub><mo>=</mo><msub><mi>L</mi><mtext>main</mtext></msub><mo>+</mo><mi>α</mi><mo>⋅</mo><msub><mi>L</mi><mtext>balance</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{total}} = L_{\text{main}} + \alpha \cdot L_{\text{balance}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">total</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">main</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.4445em;"/><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>main</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{main}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">main</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：主损失，即“预测是否准确”。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>balance</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{balance}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：<strong>辅助损失（即“惩罚项”）</strong> ，用于衡量“路由是否均衡”。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.0037em;">α</span></span></span></span></span>：一个超参数，用于控制“惩罚”的力度。</li>
</ul>
<h4 data-id="heading-12"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>balance</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{balance}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 的结算公式与过程</h4>
<p>这个“惩罚”的计算，是在**“批次” (Batch)** 级别上进行的。在训练时，GPU 会一次性处理一个批次，例如 <code>[32, 1024]</code>，即总共 32,768 个 Token。</p>
<p>负载均衡损失的经典公式如下：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>balance</mtext></msub><mo>=</mo><mi>N</mi><mo>⋅</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></msubsup><msub><mi>f</mi><mi>i</mi></msub><mo>⋅</mo><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">L_{\text{balance}} = N \cdot \sum_{i=1}^{N} f_i \cdot P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.2809em;vertical-align:-0.2997em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></p>
<p>我们来拆解这几个关键变量（在<em>一个批次</em>的 32,768 个 Token 中）：</p>
<ul>
<li>
<p><strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span></strong> ：专家的总数量（例如 8）。</p>
</li>
<li>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi></mrow><annotation encoding="application/x-tex">G</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">G</span></span></span></span></span> (概率矩阵)：</p>
<p>Gating 网络为所有 32,768 个 Token 并行计算出的“路由概率”。这是一个 [32768, 8] 的矩阵。</p>
</li>
<li>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">D</span></span></span></span></span> (调度掩码)：</p>
<p>对 G 矩阵的每一行（每个 Token）执行 Top-K（例如 K=2）操作，得到一个“硬决策”的 0/1 掩码。这是一个 [32768, 8] 的矩阵，每一行恰好有 2 个 1。</p>
</li>
<li>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (平均路由概率)：</p>
<p>Gating 网络的“意向”。</p>
<p>它是 G 矩阵第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 列的平均值。代表在这个批次中，Gating 希望分配给专家 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 的平均概率。</p>
</li>
<li>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (任务分配比例)：</p>
<p>专家的“实际工作量”。</p>
<p>它是 D 矩阵第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 列的平均值。代表在这个批次中，专家 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 实际 被分配了百分之多少的 Token。</p>
</li>
</ul>
<p>结算：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>balance</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{balance}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 通过将“实际工作量”(<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>) 和“意向”(<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>) 相乘，来计算每个专家的“不均衡贡献”，最后汇总得出总惩罚。</p>
<hr/>
<h3 data-id="heading-13">篇章四：MoE 训练的“天才诡计”——不可微分的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></h3>
<p>您在深入思考后，一定已经发现了几个最棘手的技术问题。这些问题是 MoE 训练的精髓所在。</p>
<h4 data-id="heading-14">疑问一：如果 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">f_i = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span>（摸鱼专家），惩罚从何而来？</h4>
<p>您是对的！在一个批次中，如果一个专家一次都没被选中，它的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">f_i = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span>，因此它的贡献 <code>f_i * P_i = 0</code>。</p>
<p><strong>惩罚并非来自“摸鱼专家”，而是来自“明星专家”！</strong></p>
<ol>
<li>“明星专家”的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 都很高，导致它的 <code>f_i * P_i</code> 贡献值<strong>极大</strong>。</li>
<li>这使得总的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>balance</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{balance}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 惩罚<strong>非常高</strong>。</li>
<li>优化器为了降低这个惩罚，会强迫 Gating 网络<strong>降低“明星专家”的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></strong> 。</li>
<li><strong>（关键）</strong> Gating 使用的是 Softmax（总和为1）。你从“明星”那里剥夺的概率，必须“重新分配”给其他人。</li>
<li><strong>“摸鱼专家”的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 就这样被动地提高了！</strong> 在下一个批次中，它被选中的概率就变大了。</li>
</ol>
<h4 data-id="heading-15">疑问二：为什么不干脆只平衡 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>（概率）？</h4>
<p>既然 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>（硬决策）只是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>（软概率）的结果，为什么不直接设计一个损失函数（例如 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mtext>variance</mtext><mo stretchy="false">(</mo><msub><mi>P</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">L = \text{variance}(P_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">variance</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>）来平衡 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 就行了？</p>
<p><strong>答案是：因为 Top-K 这个“硬决策”操作是不可微分的 (Non-Differentiable)。</strong></p>
<p>这是理解 MoE 训练的<em>终极</em>障碍，也是它最天才的“诡计”。</p>
<ol>
<li>
<p>什么叫“不可微分”？</p>
<p>想象一个“步阶函数”（Step Function）：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">x &gt; 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"/><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span> 时 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">y=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span>，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>≤</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">x \le 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7719em;vertical-align:-0.136em;"/><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span> 时 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">y=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span>。</p>
<p>在 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">x=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span> 处，它是一个“跳跃”，斜率（导数/梯度）不存在。在 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo mathvariant="normal">≠</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">x \ne 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel"><span class="mrel"><span class="mord vbox"><span class="thinbox"><span class="rlap"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="inner"><span class="mord"><span class="mrel"></span></span></span><span class="fix"/></span></span></span></span><span class="mrel">=</span></span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span> 的地方，它又是“平的”，斜率=0。</p>
<p>机器学习的反向传播依赖“梯度”来更新参数。如果梯度为 0 或不存在，优化器就“瞎了”，不知道该往哪走。</p>
</li>
<li>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 为什么不可微分？</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 是通过 Top-K 这个“硬比较”操作得来的。</p>
<p>Gating 网络对参数做出的微小改变（例如 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 从 0.40 变成 0.41），可能完全不会改变 Top-K 的决策结果。</p>
<p>Gating 的参数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span></span> 变了，但 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 却“纹丝不动”。</p>
<p>这意味着 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 相对于 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span></span> 的梯度 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">Δ</mi><msub><mi>f</mi><mi>i</mi></msub></mrow><mrow><mi mathvariant="normal">Δ</mi><mi>θ</mi></mrow></mfrac><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\frac{\Delta f_i}{\Delta \theta} = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2772em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9322em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">Δ</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.4461em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">Δ</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.1076em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span>。</p>
<p><strong>如果损失函数只基于 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，梯度将无法回传，Gating 网络永远无法被训练！</strong></p>
</li>
</ol>
<h4 data-id="heading-16"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>balance</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{balance}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 的“天才诡计”：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub><mo>⋅</mo><mi mathvariant="normal">∇</mi><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i \cdot \nabla P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord">∇</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></h4>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>balance</mtext></msub><mo>=</mo><mi>N</mi><mo>⋅</mo><mo>∑</mo><mo stretchy="false">(</mo><msub><mi>f</mi><mi>i</mi></msub><mo>⋅</mo><msub><mi>P</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">L_{\text{balance}} = N \cdot \sum (f_i \cdot P_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 这个公式的天才之处在于，它如何“绕过”了不可微分的障碍。</p>
<p>在反向传播计算梯度时，它运用了一个“技巧”：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∇</mi><msub><mi>L</mi><mtext>balance</mtext></msub><mo>∝</mo><msub><mi>f</mi><mi>i</mi></msub><mo>⋅</mo><mi mathvariant="normal">∇</mi><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\nabla L_{\text{balance}} \propto f_i \cdot \nabla P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord">∇</span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∝</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord">∇</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></p>
<ul>
<li>我们知道 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 本身是不可微分的（梯度为 0），但 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>（来自 Softmax）是<strong>可微分的</strong>。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 在这里被“伪装”成一个**“常数缩放因子”**（即“惩罚力度”）。</li>
<li>梯度 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∇</mi><mi>L</mi></mrow><annotation encoding="application/x-tex">\nabla L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">∇</span><span class="mord mathnormal">L</span></span></span></span></span> 实际上是沿着<strong>可微分的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∇</mi><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\nabla P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord">∇</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 这条路</strong>回传的。</li>
</ul>
<p><strong>直白地说：</strong></p>
<blockquote>
<p>优化器：“Gating 网络，我要惩罚你的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>（概率输出）。”</p>
<p>惩罚的力度 = 你“实际”分配给这个专家的工作量 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。</p>
</blockquote>
<ul>
<li>对于“明星专家”：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 很高，惩罚力度 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub><mo>⋅</mo><mi mathvariant="normal">∇</mi><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i \cdot \nabla P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord">∇</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 就<strong>非常大</strong>。</li>
<li>对于“摸鱼专家”：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">f_i = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span>，惩罚力度 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mo>⋅</mo><mi mathvariant="normal">∇</mi><msub><mi>P</mi><mi>i</mi></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">0 \cdot \nabla P_i = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord">∇</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span>。</li>
</ul>
<p>这就是 MoE 训练的全部秘密：<strong>它利用“不可微分”的实际工作量 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 作为权重，去惩罚“可微分”的路由意向 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，再通过 Softmax 的内在机制，被动地“提拔”那些“摸鱼”的专家。</strong></p>
<hr/>
<h4 data-id="heading-17">总结</h4>
<p>MoE（混合专家模型）是一种绝妙的架构，它通过<strong>稀疏激活</strong>（激活 Top-K）实现了“巨大知识库”（总参数）和“极高推理速度”（激活参数）的完美平衡。</p>
<p>为了使其有效工作，它在训练中必须使用<strong>负载均衡</strong>（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>balance</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{balance}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>）来防止“明星专家”问题。</p>
<p>而负载均衡的核心，是一个天才般的“梯度诡计”，它巧妙地绕过了 Top-K 决策的“不可微分”障碍，成功地训练了 Gating 网络。</p>
<p>希望这篇博客能帮您彻底理清 MoE 的所有脉络！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[kotlin-2]]></title>    <link>https://juejin.cn/post/7571704212850130995</link>    <guid>https://juejin.cn/post/7571704212850130995</guid>    <pubDate>2025-11-12T12:14:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571704212850130995" data-draft-id="7571126773808234506" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="kotlin-2"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-11-12T12:14:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风冷"/> <meta itemprop="url" content="https://juejin.cn/user/3843548379091742"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            kotlin-2
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3843548379091742/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风冷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T12:14:19.000Z" title="Wed Nov 12 2025 12:14:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>太棒了！我们继续深入，探索 Kotlin 更核心、更强大的特性。这一部分将让你真正体会到 Kotlin 相比 Java 的优雅和高效。</p>
<hr/>
<h3 data-id="heading-0"><strong>Kotlin 基础进阶：解锁现代编程的威力</strong></h3>
<h4 data-id="heading-1"><strong>八、数据类型：不只是“一切皆对象”</strong></h4>
<p>Kotlin 对数据类型做了精心设计，区分了可空与否，并且所有类型都是对象，没有 Java 中的基本类型和包装类型之分。</p>
<ol>
<li>
<p><strong>基本类型</strong></p>
<ul>
<li><strong>数值类型</strong>：<code>Byte</code>, <code>Short</code>, <code>Int</code>, <code>Long</code>, <code>Float</code>, <code>Double</code></li>
<li><strong>其他类型</strong>：<code>Char</code>（字符）, <code>Boolean</code>（布尔值）, <code>String</code>（字符串）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> number: <span class="hljs-built_in">Int</span> = <span class="hljs-number">100</span> <span class="hljs-comment">// 整数</span>
<span class="hljs-keyword">val</span> pi: <span class="hljs-built_in">Double</span> = <span class="hljs-number">3.14</span> <span class="hljs-comment">// 双精度浮点数</span>
<span class="hljs-keyword">val</span> isKotlinFun: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">true</span> <span class="hljs-comment">// 布尔值</span>
<span class="hljs-keyword">val</span> letter: <span class="hljs-built_in">Char</span> = <span class="hljs-string">'A'</span> <span class="hljs-comment">// 字符</span>
<span class="hljs-keyword">val</span> text: String = <span class="hljs-string">"Hello"</span> <span class="hljs-comment">// 字符串</span>
</code></pre>
</li>
<li>
<p><strong>智能类型转换</strong></p>
<p>Kotlin 编译器非常智能，一旦进行了类型检查，在后续作用域内会自动进行类型转换。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">printLength</span><span class="hljs-params">(obj: <span class="hljs-type">Any</span>)</span></span> { <span class="hljs-comment">// Any 是 Kotlin 中所有类的基类，类似 Java 的 Object</span>
    <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">is</span> String) { <span class="hljs-comment">// 类型检查</span>
        <span class="hljs-comment">// 在这个分支内，obj 被自动转换为 String 类型</span>
        println(obj.length) <span class="hljs-comment">// 可以直接调用 String 的方法</span>
    }

    <span class="hljs-comment">// 或者使用 `!is` 进行否定判断</span>
    <span class="hljs-keyword">if</span> (obj !<span class="hljs-keyword">is</span> String) <span class="hljs-keyword">return</span>
    println(obj.length) <span class="hljs-comment">// 这里 obj 也是 String 类型</span>
}
</code></pre>
<p><strong>对比 Java：</strong> 在 Java 中需要显式强制转换：<code>if (obj instanceof String) { String str = (String) obj; }</code></p>
</li>
</ol>
<h4 data-id="heading-2"><strong>九、集合：功能强大的数据容器</strong></h4>
<p>Kotlin 的集合分为可变和不可变两种，这是非常重要的设计理念。</p>
<ol>
<li>
<p><strong>List（列表）</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 不可变列表 - 只能读取，不能修改</span>
val readOnlyList: List&lt;<span class="hljs-type">String</span>&gt; = <span class="hljs-built_in">listOf</span>(<span class="hljs-string">"Apple"</span>, <span class="hljs-string">"Banana"</span>, <span class="hljs-string">"Orange"</span>)
<span class="hljs-built_in">println</span>(readOnlyList[<span class="hljs-number">0</span>]) <span class="hljs-comment">// 输出：Apple</span>
<span class="hljs-comment">// readOnlyList.add("Grape") // 错误！不可变列表不能添加元素</span>

<span class="hljs-comment">// 可变列表 - 可以修改</span>
val mutableList: MutableList&lt;<span class="hljs-type">String</span>&gt; = <span class="hljs-built_in">mutableListOf</span>(<span class="hljs-string">"Apple"</span>, <span class="hljs-string">"Banana"</span>)
mutableList.<span class="hljs-built_in">add</span>(<span class="hljs-string">"Grape"</span>) <span class="hljs-comment">// 正确！</span>
mutableList[<span class="hljs-number">0</span>] = <span class="hljs-string">"Apricot"</span> <span class="hljs-comment">// 修改元素</span>
</code></pre>
</li>
<li>
<p><strong>Set（集合）和 Map（映射）</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// Set - 不重复元素的集合</span>
val set = <span class="hljs-built_in">setOf</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>) <span class="hljs-comment">// 结果： [1, 2, 3]</span>

<span class="hljs-comment">// Map - 键值对</span>
val map = <span class="hljs-built_in">mapOf</span>(<span class="hljs-string">"name"</span> to <span class="hljs-string">"Kotlin"</span>, <span class="hljs-string">"version"</span> to <span class="hljs-string">"1.9"</span>)
<span class="hljs-built_in">println</span>(map[<span class="hljs-string">"name"</span>]) <span class="hljs-comment">// 输出：Kotlin</span>
</code></pre>
</li>
</ol>
<h4 data-id="heading-3"><strong>十、循环：更优雅的遍历方式</strong></h4>
<ol>
<li>
<p><strong>for 循环</strong></p>
<pre><code class="hljs language-scss" lang="scss">val fruits = <span class="hljs-built_in">listOf</span>("Apple", "Banana", "Orange")

<span class="hljs-comment">// 遍历集合元素</span>
for (fruit in fruits) {
    <span class="hljs-built_in">println</span>(fruit)
}

<span class="hljs-comment">// 遍历索引和值</span>
for ((index, fruit) in fruits<span class="hljs-selector-class">.withIndex</span>()) {
    <span class="hljs-built_in">println</span>("$index: $fruit")
}

<span class="hljs-comment">// 遍历数字范围</span>
for (i in <span class="hljs-number">1</span>..<span class="hljs-number">5</span>) { <span class="hljs-comment">// 包含 1 和 5</span>
    <span class="hljs-built_in">println</span>(i)
}

for (i in <span class="hljs-number">1</span> until <span class="hljs-number">5</span>) { <span class="hljs-comment">// 不包含 5</span>
    <span class="hljs-built_in">println</span>(i)
}

for (i in <span class="hljs-number">5</span> downTo <span class="hljs-number">1</span> step <span class="hljs-number">2</span>) { <span class="hljs-comment">// 从5到1，步长为2</span>
    <span class="hljs-built_in">println</span>(i) <span class="hljs-comment">// 输出：5, 3, 1</span>
}
</code></pre>
</li>
<li>
<p><strong>while 和 do-while</strong>（与 Java 相同）</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-tag">var</span> x = <span class="hljs-number">10</span>
while (x &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">println</span>(x)
    x--
}
</code></pre>
</li>
</ol>
<h4 data-id="heading-4"><strong>十一、函数进阶：默认参数、命名参数、扩展函数</strong></h4>
<ol>
<li>
<p><strong>默认参数</strong>：为函数参数提供默认值</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">greet</span><span class="hljs-params">(name: <span class="hljs-type">String</span>, greeting: <span class="hljs-type">String</span> = <span class="hljs-string">"Hello"</span>)</span></span> {
    println(<span class="hljs-string">"<span class="hljs-variable">$greeting</span>, <span class="hljs-variable">$name</span>!"</span>)
}

greet(<span class="hljs-string">"Alice"</span>) <span class="hljs-comment">// 输出：Hello, Alice!</span>
greet(<span class="hljs-string">"Bob"</span>, <span class="hljs-string">"Hi"</span>) <span class="hljs-comment">// 输出：Hi, Bob!</span>
</code></pre>
</li>
<li>
<p><strong>命名参数</strong>：调用时指定参数名，提高可读性</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createUser</span><span class="hljs-params">(name: <span class="hljs-type">String</span>, age: <span class="hljs-type">Int</span>, isAdmin: <span class="hljs-type">Boolean</span> = <span class="hljs-literal">false</span>)</span></span> {
    println(<span class="hljs-string">"Name: <span class="hljs-variable">$name</span>, Age: <span class="hljs-variable">$age</span>, Admin: <span class="hljs-variable">$isAdmin</span>"</span>)
}

<span class="hljs-comment">// 可以跳过有默认值的参数，随意调整顺序</span>
createUser(age = <span class="hljs-number">25</span>, name = <span class="hljs-string">"Charlie"</span>, isAdmin = <span class="hljs-literal">true</span>)
</code></pre>
</li>
<li>
<p><strong>扩展函数</strong>：Kotlin 的"杀手级特性"，可以为现有类添加新功能</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 为 String 类添加一个扩展函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">addExcitement</span><span class="hljs-params">()</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span> + <span class="hljs-string">"!!!"</span>
}

println(<span class="hljs-string">"Kotlin is fun"</span>.addExcitement()) <span class="hljs-comment">// 输出：Kotlin is fun!!!</span>

<span class="hljs-comment">// 为 List 添加一个扩展函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> List<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">secondOrNull</span><span class="hljs-params">()</span></span>: T? {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.size &gt;= <span class="hljs-number">2</span>) <span class="hljs-keyword">this</span>[<span class="hljs-number">1</span>] <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span>
}

<span class="hljs-keyword">val</span> list = listOf(<span class="hljs-string">"first"</span>, <span class="hljs-string">"second"</span>, <span class="hljs-string">"third"</span>)
println(list.secondOrNull()) <span class="hljs-comment">// 输出：second</span>
</code></pre>
</li>
</ol>
<h4 data-id="heading-5"><strong>十二、Lambda 表达式和高阶函数</strong></h4>
<p>这是函数式编程的核心，让代码极其简洁。</p>
<ol>
<li>
<p><strong>Lambda 表达式基础</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 一个简单的 Lambda：接收两个 Int 参数，返回它们的和</span>
<span class="hljs-keyword">val</span> sum: (<span class="hljs-built_in">Int</span>, <span class="hljs-built_in">Int</span>) -&gt; <span class="hljs-built_in">Int</span> = { a, b -&gt; a + b }
println(sum(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>)) <span class="hljs-comment">// 输出：7</span>

<span class="hljs-comment">// 更常见的写法：直接传递给函数</span>
<span class="hljs-keyword">val</span> numbers = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)

<span class="hljs-comment">// 过滤出偶数</span>
<span class="hljs-keyword">val</span> evens = numbers.filter { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> } <span class="hljs-comment">// [2, 4]</span>

<span class="hljs-comment">// 将每个元素乘以2</span>
<span class="hljs-keyword">val</span> doubled = numbers.map { it * <span class="hljs-number">2</span> } <span class="hljs-comment">// [2, 4, 6, 8, 10]</span>

<span class="hljs-comment">// 排序</span>
<span class="hljs-keyword">val</span> sorted = numbers.sortedByDescending { it } <span class="hljs-comment">// [5, 4, 3, 2, 1]</span>
</code></pre>
</li>
<li>
<p><strong>高阶函数</strong>：接收函数作为参数或返回函数的函数</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 接收一个函数作为参数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">calculate</span><span class="hljs-params">(a: <span class="hljs-type">Int</span>, b: <span class="hljs-type">Int</span>, operation: (<span class="hljs-type">Int</span>, <span class="hljs-type">Int</span>) -&gt; <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-keyword">return</span> operation(a, b)
}

<span class="hljs-comment">// 使用 Lambda 调用</span>
<span class="hljs-keyword">val</span> result1 = calculate(<span class="hljs-number">10</span>, <span class="hljs-number">5</span>) { x, y -&gt; x + y } <span class="hljs-comment">// 15</span>
<span class="hljs-keyword">val</span> result2 = calculate(<span class="hljs-number">10</span>, <span class="hljs-number">5</span>) { x, y -&gt; x * y } <span class="hljs-comment">// 50</span>

<span class="hljs-comment">// 返回一个函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createMultiplier</span><span class="hljs-params">(factor: <span class="hljs-type">Int</span>)</span></span>: (<span class="hljs-built_in">Int</span>) -&gt; <span class="hljs-built_in">Int</span> {
    <span class="hljs-keyword">return</span> { number -&gt; number * factor }
}

<span class="hljs-keyword">val</span> double = createMultiplier(<span class="hljs-number">2</span>)
<span class="hljs-keyword">val</span> triple = createMultiplier(<span class="hljs-number">3</span>)

println(double(<span class="hljs-number">5</span>)) <span class="hljs-comment">// 输出：10</span>
println(triple(<span class="hljs-number">5</span>)) <span class="hljs-comment">// 输出：15</span>
</code></pre>
</li>
</ol>
<h4 data-id="heading-6"><strong>十三、异常处理：try-catch 也是表达式</strong></h4>
<p>Kotlin 的 <code>try-catch</code>也可以返回值，这让错误处理更加函数式。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">parseNumber</span><span class="hljs-params">(str: <span class="hljs-type">String</span>)</span></span>: <span class="hljs-built_in">Int</span>? {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> {
        str.toInt() <span class="hljs-comment">// 如果转换成功，返回数字</span>
    } <span class="hljs-keyword">catch</span> (e: NumberFormatException) {
        <span class="hljs-literal">null</span> <span class="hljs-comment">// 如果转换失败，返回 null</span>
    }
}

println(parseNumber(<span class="hljs-string">"123"</span>)) <span class="hljs-comment">// 输出：123</span>
println(parseNumber(<span class="hljs-string">"abc"</span>)) <span class="hljs-comment">// 输出：null</span>
</code></pre>
<h4 data-id="heading-7"><strong>实战演练：综合运用</strong></h4>
<p>让我们用学到的知识解决一个实际问题：处理学生成绩列表。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span>(<span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> score: <span class="hljs-built_in">Int</span>)

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> students = listOf(
        Student(<span class="hljs-string">"Alice"</span>, <span class="hljs-number">85</span>),
        Student(<span class="hljs-string">"Bob"</span>, <span class="hljs-number">92</span>),
        Student(<span class="hljs-string">"Charlie"</span>, <span class="hljs-number">78</span>),
        Student(<span class="hljs-string">"Diana"</span>, <span class="hljs-number">95</span>),
        Student(<span class="hljs-string">"Eve"</span>, <span class="hljs-number">88</span>)
    )
    
    <span class="hljs-comment">// 找出成绩90分以上的学生名字</span>
    <span class="hljs-keyword">val</span> topStudents = students
        .filter { it.score &gt; <span class="hljs-number">90</span> }
        .map { it.name }
    println(<span class="hljs-string">"Top students: <span class="hljs-variable">$topStudents</span>"</span>) <span class="hljs-comment">// [Bob, Diana]</span>
    
    <span class="hljs-comment">// 计算平均分</span>
    <span class="hljs-keyword">val</span> averageScore = students.map { it.score }.average()
    println(<span class="hljs-string">"Average score: <span class="hljs-variable">$averageScore</span>"</span>)
    
    <span class="hljs-comment">// 按成绩降序排列</span>
    <span class="hljs-keyword">val</span> sortedByScore = students.sortedByDescending { it.score }
    sortedByScore.forEach { println(<span class="hljs-string">"<span class="hljs-subst">${it.name}</span>: <span class="hljs-subst">${it.score}</span>"</span>) }
    
    <span class="hljs-comment">// 使用扩展函数添加实用功能</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> List<span class="hljs-type">&lt;Student&gt;</span>.<span class="hljs-title">getNames</span><span class="hljs-params">()</span></span>: List&lt;String&gt; = <span class="hljs-keyword">this</span>.map { it.name }
    
    <span class="hljs-keyword">val</span> allNames = students.getNames()
    println(<span class="hljs-string">"All names: <span class="hljs-variable">$allNames</span>"</span>)
}
</code></pre>
<h4 data-id="heading-8"><strong>下一步学习路径</strong></h4>
<p>现在你已经掌握了 Kotlin 的核心语法！接下来可以探索：</p>
<ul>
<li><strong>面向对象编程</strong>：类、对象、继承、接口、数据类、密封类</li>
<li><strong>协程</strong>：Kotlin 的轻量级线程，用于异步编程</li>
<li><strong>DSL（领域特定语言）</strong> ：用 Kotlin 创建优雅的领域特定语言</li>
<li><strong>与 Java 互操作</strong>：在现有 Java 项目中引入 Kotlin</li>
</ul>
<p>Kotlin 的学习曲线非常平滑，这些基础概念将为你后续的学习打下坚实的基础。尝试用 Kotlin 重写你之前用 Java 写过的小程序，你会立即感受到它的魅力！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[kotlin-1]]></title>    <link>https://juejin.cn/post/7571662618055049242</link>    <guid>https://juejin.cn/post/7571662618055049242</guid>    <pubDate>2025-11-12T12:14:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571662618055049242" data-draft-id="7571126773808218122" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="kotlin-1"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-11-12T12:14:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风冷"/> <meta itemprop="url" content="https://juejin.cn/user/3843548379091742"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            kotlin-1
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3843548379091742/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风冷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T12:14:03.000Z" title="Wed Nov 12 2025 12:14:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>好的，没问题！我们来写一篇更系统、更清晰、更适合零基础入门的 Kotlin 基础语法篇。</p>
<p>我将采用  <strong>“概念讲解 + 代码示例 + 与Java对比”</strong> 的方式，并辅以<strong>实用技巧和总结</strong>，力求让你一篇文章就掌握 Kotlin 语法的精髓。</p>
<hr/>
<h3 data-id="heading-0"><strong>Kotlin 基础语法入门：从零开始，写好每一行代码</strong></h3>
<p>相比于转载的文章，本教程将提供更清晰的逻辑脉络和更实用的知识提炼。</p>
<h4 data-id="heading-1"><strong>一、 Kotlin 初印象：为什么是它？</strong></h4>
<p>在深入语法之前，先了解 Kotlin 的核心优势：</p>
<ul>
<li><strong>简洁实用</strong>：大大减少样板代码（如 getter/setter、数据类型声明等）。</li>
<li><strong>空安全</strong>：从语言层面杜绝了空指针异常（NullPointerException）的困扰。</li>
<li><strong>100% 兼容 Java</strong>：可以在项目中与 Java 代码无缝调用，平滑迁移。</li>
<li><strong>现代语言特性</strong>：支持函数式编程、扩展函数、协程等。</li>
</ul>
<p>现在，让我们开始语法之旅。</p>
<h4 data-id="heading-2"><strong>二、 程序起点：main 函数</strong></h4>
<p>任何程序的执行都有一个入口，在 Kotlin 中，它极其简洁。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    println(<span class="hljs-string">"Hello, Kotlin World!"</span>)
}
</code></pre>
<ul>
<li><code>fun</code>：关键字，用于声明一个函数。</li>
<li><code>main</code>：函数名，是程序的入口点。</li>
<li><code>println</code>：一个内置函数，用于在控制台输出一行内容。</li>
</ul>
<p><strong>对比 Java：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloWorld</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"Hello, Java World!"</span>);
    }
}
</code></pre>
<p>Kotlin 的写法明显更简洁，不需要类包装。</p>
<h4 data-id="heading-3"><strong>三、 变量声明：val 和 var 的艺术</strong></h4>
<p>Kotlin 使用两个关键字来声明变量，这是基础中的基础。</p>
<ol>
<li>
<p><strong><code>val</code>（value 的缩写）</strong> ：用于声明<strong>只读变量</strong>，相当于 Java 中的 <code>final</code>变量。一旦赋值，不可更改。</p>
<pre><code class="hljs language-ini" lang="ini">val name: <span class="hljs-attr">String</span> = <span class="hljs-string">"Kotlin"</span>
// <span class="hljs-attr">name</span> = <span class="hljs-string">"Java"</span> // 错误！编译不通过，因为 name 是只读的
</code></pre>
</li>
<li>
<p><strong><code>var</code>（variable 的缩写）</strong> ：用于声明<strong>可变变量</strong>。</p>
<pre><code class="hljs language-ini" lang="ini">var age: <span class="hljs-attr">Int</span> = <span class="hljs-number">5</span>
<span class="hljs-attr">age</span> = <span class="hljs-number">6</span> // 正确！可以重新赋值
</code></pre>
</li>
</ol>
<p><strong>高级技巧：类型推断</strong></p>
<p>Kotlin 编译器很智能，如果你在声明时直接赋值，可以省略类型声明（<code>: String</code>和 <code>: Int</code>）。</p>
<pre><code class="hljs language-ini" lang="ini">val <span class="hljs-attr">language</span> = <span class="hljs-string">"Kotlin"</span> // 编译器自动推断 language 为 String 类型
var <span class="hljs-attr">count</span> = <span class="hljs-number">10</span> // 编译器自动推断 count 为 Int 类型
</code></pre>
<p><strong>📌 最佳实践建议：</strong></p>
<p><strong>优先使用 <code>val</code></strong>，除非这个变量确实需要被改变。这能让你的代码更安全、更符合函数式编程的理念。</p>
<h4 data-id="heading-4"><strong>四、 函数定义：fun 的关键作用</strong></h4>
<p>使用 <code>fun</code>关键字来定义函数。基本语法如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 基本函数：无返回值</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">greet</span><span class="hljs-params">(name: <span class="hljs-type">String</span>)</span></span> {
    println(<span class="hljs-string">"Hello, <span class="hljs-variable">$name</span>!"</span>)
}

<span class="hljs-comment">// 2. 有返回值的函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">sum</span><span class="hljs-params">(a: <span class="hljs-type">Int</span>, b: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> { <span class="hljs-comment">// 返回值类型在参数列表后声明</span>
    <span class="hljs-keyword">return</span> a + b
}

<span class="hljs-comment">// 3. 单表达式函数（语法糖！）</span>
<span class="hljs-comment">// 当函数体只有一行表达式时，可以简化写法</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">sumSimple</span><span class="hljs-params">(a: <span class="hljs-type">Int</span>, b: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> = a + b
<span class="hljs-comment">// 甚至，类型推断也能用在这里</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">sumEvenSimpler</span><span class="hljs-params">(a: <span class="hljs-type">Int</span>, b: <span class="hljs-type">Int</span>)</span></span> = a + b
</code></pre>
<p><strong>调用函数：</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">greet</span>("World") <span class="hljs-comment">// 输出：Hello, World!</span>
val result = <span class="hljs-built_in">sum</span>(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>)
<span class="hljs-built_in">println</span>(result) <span class="hljs-comment">// 输出：8</span>
</code></pre>
<h4 data-id="heading-5"><strong>五、 字符串模板：让拼接成为历史</strong></h4>
<p>这是 Kotlin 非常方便的特性，用于在字符串中直接嵌入变量或表达式。</p>
<ul>
<li>
<p><strong>使用 <code>$变量名</code></strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> name = <span class="hljs-string">"Alice"</span>
println(<span class="hljs-string">"Hello, <span class="hljs-variable">$name</span>"</span>) <span class="hljs-comment">// 输出：Hello, Alice</span>
</code></pre>
</li>
<li>
<p><strong>使用 <code>${表达式}</code></strong> （表达式复杂时必需）：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> a = <span class="hljs-number">10</span>
<span class="hljs-keyword">val</span> b = <span class="hljs-number">20</span>
println(<span class="hljs-string">"The sum is <span class="hljs-subst">${a + b}</span>"</span>) <span class="hljs-comment">// 输出：The sum is 30</span>
println(<span class="hljs-string">"The text length is <span class="hljs-subst">${name.length}</span>"</span>) <span class="hljs-comment">// 输出：The text length is 5</span>
</code></pre>
</li>
</ul>
<p><strong>对比 Java 的字符串拼接：</strong> <code>"Hello, " + name</code>，Kotlin 的方式更直观、更安全。</p>
<h4 data-id="heading-6"><strong>六、 条件控制：if 和 when</strong></h4>
<ol>
<li>
<p><strong><code>if</code>表达式</strong></p>
<p>在 Kotlin 中，<code>if</code>不仅可以做分支控制，还可以<strong>返回一个值</strong>。</p>
<pre><code class="hljs language-go" lang="go">val max = <span class="hljs-keyword">if</span> (a &gt; b) {
    <span class="hljs-built_in">println</span>(<span class="hljs-string">"a is larger"</span>)
    a <span class="hljs-comment">// 最后一行作为返回值</span>
} <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">println</span>(<span class="hljs-string">"b is larger or equal"</span>)
    b
}
<span class="hljs-built_in">println</span>(<span class="hljs-string">"Max is $max"</span>)
</code></pre>
<p><strong>对比 Java：</strong> Java 的 <code>if</code>是语句，不返回值，需要借助三元运算符 <code>? :</code>。Kotlin 用 <code>if</code>统一了两者。</p>
</li>
<li>
<p><strong><code>when</code>表达式</strong></p>
<p>功能类似 Java 的 <code>switch</code>，但强大得多。</p>
<pre><code class="hljs language-rust" lang="rust">val grade = <span class="hljs-string">"A"</span>
<span class="hljs-title function_ invoke__">when</span> (grade) {
    <span class="hljs-string">"A"</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-title function_ invoke__">println</span>(<span class="hljs-string">"Excellent"</span>)
    <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-title function_ invoke__">println</span>(<span class="hljs-string">"Good"</span>) <span class="hljs-comment">// 可以合并多个条件</span>
    <span class="hljs-keyword">in</span> <span class="hljs-string">"D"</span>..<span class="hljs-string">"F"</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-title function_ invoke__">println</span>(<span class="hljs-string">"Need improvement"</span>) <span class="hljs-comment">// 可以判断范围</span>
    <span class="hljs-keyword">else</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-title function_ invoke__">println</span>(<span class="hljs-string">"Invalid grade"</span>) <span class="hljs-comment">// 类似 default</span>
}

<span class="hljs-comment">// when 也可以返回值</span>
val description = <span class="hljs-title function_ invoke__">when</span> (grade) {
    <span class="hljs-string">"A"</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-string">"Excellent"</span>
    <span class="hljs-keyword">else</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-string">"Other grades"</span>
}
<span class="hljs-title function_ invoke__">println</span>(description)
</code></pre>
</li>
</ol>
<h4 data-id="heading-7"><strong>七、 空安全：Kotlin 的王牌特性</strong></h4>
<p>这是 Kotlin 解决 NPE 的核心设计。</p>
<ol>
<li>
<p><strong>可空类型</strong>：在类型后面加一个问号 <code>?</code>，表示这个变量可以为 <code>null</code>。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> <span class="hljs-attr">nullableName</span>: <span class="hljs-title class_">String</span>? = <span class="hljs-literal">null</span> <span class="hljs-comment">// 允许为 null</span>
<span class="hljs-keyword">var</span> <span class="hljs-attr">nonNullName</span>: <span class="hljs-title class_">String</span> = <span class="hljs-string">"Kotlin"</span> <span class="hljs-comment">// 不允许为 null</span>
<span class="hljs-comment">// nonNullName = null // 错误！编译不通过</span>
</code></pre>
</li>
<li>
<p><strong>安全调用操作符 <code>?.</code></strong> ：如果对象不为空，则调用方法或属性；否则返回 <code>null</code>。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> length: <span class="hljs-built_in">Int</span>? = nullableName?.length <span class="hljs-comment">// 如果 nullableName 为 null，则 length 也为 null，不会抛出 NPE</span>
</code></pre>
</li>
<li>
<p><strong>Elvis 操作符 <code>?:</code></strong> ：提供一个默认值。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> safeLength: <span class="hljs-built_in">Int</span> = nullableName?.length ?: <span class="hljs-number">0</span> <span class="hljs-comment">// 如果左边为 null，则返回 0</span>
</code></pre>
</li>
</ol>
<h4 data-id="heading-8"><strong>总结与学习建议</strong></h4>









































<table><thead><tr><th>特性</th><th>关键字/符号</th><th>核心优点</th><th>对比 Java</th></tr></thead><tbody><tr><td><strong>变量声明</strong></td><td><code>val</code>, <code>var</code></td><td>不可变优先，类型推断</td><td>减少 <code>final</code>，代码更简洁</td></tr><tr><td><strong>函数定义</strong></td><td><code>fun</code></td><td>单表达式函数简化</td><td>无需类包装，语法更轻量</td></tr><tr><td><strong>字符串</strong></td><td><code>$</code>, <code>${}</code></td><td>嵌入变量，无需拼接</td><td>比 <code>+</code>更直观安全</td></tr><tr><td><strong>条件控制</strong></td><td><code>if</code>, <code>when</code></td><td>是表达式，可返回值</td><td>功能比 <code>switch</code>更强大</td></tr><tr><td><strong>空安全</strong></td><td><code>?</code>, <code>?.</code>, <code>?:</code></td><td>编译期防止 NPE</td><td>从语言层面解决痛点</td></tr></tbody></table>
<p><strong>下一步学习建议：</strong></p>
<p>掌握了这些基础语法后，你就可以编写简单的 Kotlin 程序了。接下来可以探索：</p>
<ul>
<li><strong>数据类型</strong>：数值类型、字符、布尔值、数组和集合。</li>
<li><strong>循环</strong>：<code>for</code>和 <code>while</code>循环。</li>
<li><strong>面向对象</strong>：类、继承、接口。</li>
<li><strong>Lambda 表达式与高阶函数</strong>：Kotlin 函数式编程的核心。</li>
</ul>
<p>希望这篇为你量身定制的教程能让你有一个完美的开始！Kotlin 是一门令人愉悦的语言，祝你学习愉快！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude Skills 新玩法：用 skill-creator 10 分钟搞定 Excel 报表自动化，职场人必学]]></title>    <link>https://juejin.cn/post/7571672422689144884</link>    <guid>https://juejin.cn/post/7571672422689144884</guid>    <pubDate>2025-11-12T12:17:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571672422689144884" data-draft-id="7571650164843839522" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude Skills 新玩法：用 skill-creator 10 分钟搞定 Excel 报表自动化，职场人必学"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-12T12:17:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wwwzhouhui"/> <meta itemprop="url" content="https://juejin.cn/user/3428746411400537"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude Skills 新玩法：用 skill-creator 10 分钟搞定 Excel 报表自动化，职场人必学
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3428746411400537/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wwwzhouhui
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T12:17:15.000Z" title="Wed Nov 12 2025 12:17:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.前言</h2>
<p>skill‑creator 是 Anthropic 在 Claude Skills 体系中提供的“元技能”。它本身是一个可直接在 Claude 对话中调用的 Skill，专门用于 <strong>帮助用户快速创建、编辑、打包其他自定义 Skill</strong>，从而让 Claude 能够在特定业务场景下拥有专业化的能力。在产品发布时，Anthropic 将其定位为“一键生成 Skill 的交互式向导”，用户只需用自然语言描述需求，skill‑creator 会引导完成文件结构、<code>SKILL.md</code> 编写、资源打包等全部步骤。</p>
<p>我们可以借助skill‑creator 帮我们生成新的skils技能。那么为什么选择 Skill Creator? 它能拥有强大的元技能系统，帮助你快速构建专业的 Claude 技能扩展</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/638ec69b4e554c6a9a4f64b4308999ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=zSt6J6mjJE7ofGIOpV7cOt66gow%3D" alt="image-20251112150442511" loading="lazy"/></p>
<p>技术架构特点</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24eca58462f14b878dee10c43e8a84de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=pWtoYw%2FRWa0D4LV2OuEiYKg%2FdKw%3D" alt="image-20251112150722385" loading="lazy"/></p>
<p>我们可以通过六个步骤很容易创建一个新的Skill</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67431af7a59d40dd950be3a2ff2ceb36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=NYY%2BaTkhiCQaccoV7Sy06iOhUys%3D" alt="image-20251112150824718" loading="lazy"/></p>
<p>上期给大家介绍过关于Skills制作，当时没有使用skill‑creator 来实现，而且实现的也较为简单，对上期不了解的小伙伴可以看我之前的文章《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FHHZtKZzW-IB7Bu3DVT4Fsg" target="_blank" title="https://mp.weixin.qq.com/s/HHZtKZzW-IB7Bu3DVT4Fsg" ref="nofollow noopener noreferrer">Claude Skills 从零到一：手把手打造专属公众号文风生成器，10 分钟搞定 AI 技能定制</a>》</p>
<p>本期给大家介绍如何使用skill‑creator创建一个Excel 报表自动生成的 Skill，这个skill 很多职场人士应该用的会比较多。那么话不多说下面教大家如何实现吧 。</p>
<h2 data-id="heading-1">2.Claude  Skills制作</h2>
<h3 data-id="heading-2">创建skills</h3>
<p>提示词如下</p>
<pre><code class="hljs">帮我用 skill‑creator 创建一个用于 Excel 报表自动生成的 Skill
</code></pre>
<p>核心是让AI 调用skill‑creator</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d89c3527e9b549eabec0006f51d9f107~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=VkmFtBWxbUm%2FDk%2FdaWSl5KuWReI%3D" alt="image-20251112130211029" loading="lazy"/></p>
<p>​    中间AI 会要求我们填写一些个人技能要求：</p>
<p>​    还是项目技能（当前项目共享）？</p>
<p>​    Excel 报表主要用于什么场景？</p>
<p>​    你希望使用哪个 Python Excel 库？</p>
<p>​    我们填写上面的信息：个人技能（~/.claude/skills/）、数据分析报表, 业务报告, 数据导出, 模板填充、pandas + openpyxl</p>
<p>接下来AI 帮我们生成</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb976c476fbd4cd8a2af34adf1feccd1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=n%2FtgOY08MIER8ifXkmhSmj1oFg8%3D" alt="img" loading="lazy"/></p>
<p>接下来AI 帮我们在生成skill里面用到python代码</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c275aa3c3eb406d8d9969df0f304d8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=GA9MnmLs9%2FT789JdYQNHdNXNRHw%3D" alt="image-20251112130927092" loading="lazy"/></p>
<p>​    后面再等待几分钟后 AI 帮我生成了基于excle表格的skill</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a29e4277d38a4892ac2e8e46c6372552~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=h67bGjzJjGPrtX9rFJgj9gulYLQ%3D" alt="image-20251112131630040" loading="lazy"/></p>
<p>包含这个excle表格的技能</p>
<pre><code class="hljs language-shell" lang="shell"> 包含 11 个详细章节：
  1. pandas Excel 操作
  2. openpyxl 核心 API
  3. 样式和格式化（字体、填充、边框、对齐）
  4. 图表 API（柱状图、折线图、饼图、散点图）
  5. 条件格式（色阶、数据条、图标集）
  6. 高级功能（数据验证、表格、保护）
  7. 性能优化技巧

  示例脚本特点

  basic_report.py:
  - 基础报表生成流程
  - 标准样式应用
  - 列宽自动调整
  - 冻结窗格和筛选

  advanced_report.py:
  - 多工作表管理
  - 数据透视表
  - 各类图表创建
  - 条件格式应用
  - 公式自动计算
  - 仪表板生成

  template_fill.py:
  - 模板加载和填充
  - 命名范围使用
  - 批量生成报告
  - 发票生成示例

  quick_reference.py:
  - 500+ 行代码片段集合
  - 覆盖所有常用操作
  - 即复制即用
  - 包含完整示例模板
</code></pre>
<p>包括如何使用也给我们举例写好了</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-number">1.</span> 测试 Skill: 在 Claude Code 中问：<span class="hljs-string">"帮我创建一个简单的 Excel 销售报表"</span>
</code></pre>
<h3 data-id="heading-3">skills上传打包</h3>
<p>AI 在创建这个skills 直接帮我生成到我的claude skills中，我都不需要复制了。</p>
<p>我们进入/root/.claude/skills 目录下</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> ~/.claude/skills
</code></pre>
<p>​    <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ef786d720774db2a53ec627345a95be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=D6P6Y1mnTmqNnCy8yd8web%2FRxcU%3D" alt="image-20251112132123032" loading="lazy"/></p>
<p>查看生成好的skills  有哪些内容。</p>
<p>​    <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/793bef06fb92485688123d88789b5e07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=6agdTiszDdjjf%2BBeTxw%2Boq4Ty7I%3D" alt="image-20251112132222126" loading="lazy"/></p>
<p>​      代码</p>
<p>​      <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/087380b441174857aa33b00e32483310~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=A3a58T2L4hSr1eHZUqaDO3RgptA%3D" alt="image-20251112132307207" loading="lazy"/></p>
<p>​      非常完美 一行命令就帮我制作好了一个 Excel 报表自动生成的 Skill</p>
<h2 data-id="heading-4">3.验证及测试</h2>
<p>​    接下来我们验证一下这个skills 作出的表格是什么样子的。</p>
<p>​    我们这里为了演示，我让 AI 帮我造成一个表格数据。</p>
<pre><code class="hljs language-arduino" lang="arduino">	请帮我造一个<span class="hljs-string">"简单的初中生成期中考试学习成绩表格"</span> 其中包括语文、数学、英语、物理、化学、历史、生物、地理、历史科目的。学生给我生成大概<span class="hljs-number">50</span>个人。学生的姓名和成绩随机生成
	生成<span class="hljs-string">"2025年101中学八年级期中考试成绩表.xlsx"</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4748f195b2741af8eade5fa70e0709c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=%2B%2FXWdBU9IqDGuWnTzQb9UFRzPGg%3D" alt="image-20251112133252245" loading="lazy"/></p>
<p>​      claude code 会基于我刚才的需求生成python代码，使用这个python代码来生成这个初中成绩表格。</p>
<p>​</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92d16604889f466d86bfbb071893e05f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=1dJCMXDyabRXqPqCSR7mPBsKUwA%3D" alt="image-20251112133703651" loading="lazy"/></p>
<p>生成完成，我们用电脑打开表格看看</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79b980aa3c3c42f8a8e3229147f75222~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=6bzQtVC65ZW5wSGZXEdR8sRHucs%3D" alt="image-20251112133833007" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d9d9fd0d13147b4bfd7efbe0344f022~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=GbtmjWW%2FzkBlpP4SLsYsFaS%2Fcoo%3D" alt="image-20251112133851759" loading="lazy"/></p>
<p>数据表格已经生成了，接下来我们使用刚才创建的excel表格skills  来生成我们要的统计图表。</p>
<p>我的提示词如下：</p>
<pre><code class="hljs">请基于“2025年101中学八年级期中考试成绩表.xlsx”表格使用excel-report-generator 这个skills 技能帮我生成基于“语文、数学、英语、物理、化学、历史、生物、地理、历史科目评价成绩在90分以上、80分-80分、70分以下人员统计占比图” 输出“2025年101中学八年级期中考试成绩表各学科占比统计图.xlsx”
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/409f85294c7c486da965e647494a5bce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=0zwC0EzbHnlQoMrXuk8w7xuylw4%3D" alt="image-20251112142242284" loading="lazy"/></p>
<p>​     生成的结果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e09a977639c94870986af1b8cb927f54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=x2IbT3rHyGs5ZAESF574yHGJcuw%3D" alt="image-20251112142403700" loading="lazy"/></p>
<p>结果AI 非常贴心的帮我生成了下面的数据</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58f3151eadcd48e2a4d038ff19658ecd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=VzcoFd7B7%2BDqrc7tlbzadVakx4o%3D" alt="image-20251112142819679" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae03a724fec74285a06b63adaa7e9371~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=UIAZT76%2FmEyFw7b%2BEJcICI21pvI%3D" alt="image-20251112142845779" loading="lazy"/></p>
<p>我们通过上面的自定义创建excel-report-generator 基于excel表格快速生成一个我们要的各种图表，呵呵是不是非常的方便？</p>
<p>视频效果</p>
<p>skills已经开源</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwwwzhouhui%2Fskills_collection" target="_blank" title="https://github.com/wwwzhouhui/skills_collection" ref="nofollow noopener noreferrer">github.com/wwwzhouhui/…</a></p>
<p>感兴趣小伙伴可以去下载。</p>
<h2 data-id="heading-5">4.总结</h2>
<p>今天主要带大家了解并实践了使用 skill-creator 工具创建 Excel 报表自动生成专属 Claude Skill 的完整流程，该流程以 Anthropic 推出的 Skills 模块化体系为基础，通过借助 AI 辅助生成工具，形成了一套从技能定制到实际报表生成的高效解决方案。</p>
<p>通过这套实践方案，用户能够快速构建专业的 Excel 自动化能力 —— 借助 skill-creator 引导的交互式配置（场景定义、库选择、功能生成），无需复杂的编程经验，就能完成包含 11 个专业章节、4 类实用脚本的 Excel 报表技能封装。无论是数据分析报表生成、业务报告格式化，还是模板批量填充、图表自动绘制，都能通过标准化的 Skill 调用实现，极大降低了职场人士利用 AI 提升 Excel 办公效率的技术门槛。在实际验证中，我们创建的「excel-report-generator」能够稳定处理成绩数据统计、多维度图表生成等任务，有效解决了手动制作报表时的繁琐重复问题。同时，该方案具备很强的扩展性 —— 小伙伴们可以基于此技能扩展更多办公场景应用，如财务报表自动汇总、销售数据可视化看板、库存清单批量生成等，进一步释放 Claude 模型在办公自动化领域的应用价值。</p>
<p>感兴趣的小伙伴可以参照文中提供的步骤，结合自身办公需求创建专属 Excel 技能进行实践。今天的分享就到这里结束了，我们下一篇文章见。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[kotlin-3]]></title>    <link>https://juejin.cn/post/7571678674144739338</link>    <guid>https://juejin.cn/post/7571678674144739338</guid>    <pubDate>2025-11-12T12:33:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571678674144739338" data-draft-id="7571067260053995546" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="kotlin-3"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-11-12T12:33:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风冷"/> <meta itemprop="url" content="https://juejin.cn/user/3843548379091742"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            kotlin-3
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3843548379091742/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风冷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T12:33:05.000Z" title="Wed Nov 12 2025 12:33:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>太棒了！现在让我们进入 Kotlin 最精彩的部分——面向对象编程和高级特性。这一部分将彻底改变你对编程的认知。</p>
<hr/>
<h3 data-id="heading-0"><strong>Kotlin 面向对象编程：重新定义代码组织方式</strong></h3>
<h4 data-id="heading-1"><strong>十四、类与对象：简洁的开始</strong></h4>
<p>Kotlin 中的类定义极其简洁，告别了 Java 的样板代码。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 最简单的类定义</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>

<span class="hljs-comment">// 带主构造函数的类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> <span class="hljs-title function_">constructor</span>(<span class="hljs-params">firstName: <span class="hljs-built_in">String</span></span>) { <span class="hljs-comment">/*...*/</span> }

<span class="hljs-comment">// 主构造函数可以省略 constructor 关键字</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(<span class="hljs-attr">firstName</span>: <span class="hljs-title class_">String</span>) {
    <span class="hljs-comment">// 属性直接在类体中声明</span>
    <span class="hljs-keyword">var</span> <span class="hljs-attr">firstName</span>: <span class="hljs-title class_">String</span> = firstName
    <span class="hljs-keyword">var</span> <span class="hljs-attr">lastName</span>: <span class="hljs-title class_">String</span> = <span class="hljs-string">""</span>
    <span class="hljs-keyword">var</span> <span class="hljs-attr">age</span>: <span class="hljs-title class_">Int</span> = <span class="hljs-number">0</span>
}

<span class="hljs-comment">// 更简洁的写法：在主构造函数中直接声明属性</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(
    val <span class="hljs-attr">firstName</span>: <span class="hljs-title class_">String</span>,  <span class="hljs-comment">// 只读属性</span>
    <span class="hljs-keyword">var</span> <span class="hljs-attr">lastName</span>: <span class="hljs-title class_">String</span>,   <span class="hljs-comment">// 可变属性</span>
    <span class="hljs-keyword">var</span> <span class="hljs-attr">age</span>: <span class="hljs-title class_">Int</span> = <span class="hljs-number">0</span>        <span class="hljs-comment">// 带默认值的参数</span>
) {
    <span class="hljs-comment">// 类体</span>
}
</code></pre>
<p><strong>使用类：</strong></p>
<pre><code class="hljs language-ini" lang="ini">val <span class="hljs-attr">person</span> = Person(<span class="hljs-string">"张"</span>, <span class="hljs-string">"三"</span>, <span class="hljs-number">25</span>)
println(person.firstName)  // 输出：张
<span class="hljs-attr">person.age</span> = <span class="hljs-number">26</span>            // 可以修改
// <span class="hljs-attr">person.firstName</span> = <span class="hljs-string">"李"</span> // 错误！firstName 是 val
</code></pre>
<h4 data-id="heading-2"><strong>十五、数据类（Data Class）：自动生成样板代码</strong></h4>
<p>这是 Kotlin 的"魔法"特性之一，专门用于存储数据。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 数据类定义 - 一行代码搞定！</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(
    <span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Int</span>,
    <span class="hljs-keyword">val</span> name: String,
    <span class="hljs-keyword">val</span> email: String
)

<span class="hljs-comment">// 自动获得以下功能：</span>
<span class="hljs-keyword">val</span> user1 = User(<span class="hljs-number">1</span>, <span class="hljs-string">"Alice"</span>, <span class="hljs-string">"alice@example.com"</span>)
<span class="hljs-keyword">val</span> user2 = User(<span class="hljs-number">1</span>, <span class="hljs-string">"Alice"</span>, <span class="hljs-string">"alice@example.com"</span>)

<span class="hljs-comment">// 1. 自动实现 toString()</span>
println(user1) <span class="hljs-comment">// 输出：User(id=1, name=Alice, email=alice@example.com)</span>

<span class="hljs-comment">// 2. 自动实现 equals() 和 hashCode()</span>
println(user1 == user2) <span class="hljs-comment">// 输出：true（比较内容，不是引用）</span>

<span class="hljs-comment">// 3. 自动实现 copy() 函数</span>
<span class="hljs-keyword">val</span> user3 = user1.copy(name = <span class="hljs-string">"Alice Smith"</span>)
println(user3) <span class="hljs-comment">// 输出：User(id=1, name=Alice Smith, email=alice@example.com)</span>

<span class="hljs-comment">// 4. 自动实现 componentN() 函数（用于解构）</span>
<span class="hljs-keyword">val</span> (id, name, email) = user1
println(<span class="hljs-string">"ID: <span class="hljs-variable">$id</span>, Name: <span class="hljs-variable">$name</span>"</span>) <span class="hljs-comment">// 输出：ID: 1, Name: Alice</span>
</code></pre>
<p><strong>对比 Java：</strong> 在 Java 中需要手动编写 getter/setter、equals()、hashCode()、toString() 等大量样板代码。</p>
<h4 data-id="heading-3"><strong>十六、对象表达式与对象声明：替代匿名类和单例</strong></h4>
<ol>
<li>
<p><strong>对象表达式（匿名对象）</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 类似 Java 的匿名内部类，但更强大</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ClickListener</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onClick</span><span class="hljs-params">()</span></span>
}

<span class="hljs-keyword">val</span> button = <span class="hljs-keyword">object</span> : ClickListener {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onClick</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"Button clicked!"</span>)
    }
}

button.onClick()
</code></pre>
</li>
<li>
<p><strong>对象声明（单例模式）</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用 object 关键字创建单例</span>
<span class="hljs-keyword">object</span> DatabaseManager {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> connectionCount = <span class="hljs-number">0</span>

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">connect</span><span class="hljs-params">()</span></span> {
        connectionCount++
        println(<span class="hljs-string">"Connected! Total connections: <span class="hljs-variable">$connectionCount</span>"</span>)
    }

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getConnectionCount</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> = connectionCount
}

<span class="hljs-comment">// 直接通过类名调用，不需要实例化</span>
DatabaseManager.connect() <span class="hljs-comment">// 输出：Connected! Total connections: 1</span>
DatabaseManager.connect() <span class="hljs-comment">// 输出：Connected! Total connections: 2</span>
</code></pre>
</li>
</ol>
<h4 data-id="heading-4"><strong>十七、伴生对象（Companion Object）：替代静态成员</strong></h4>
<p>Kotlin 没有 <code>static</code>关键字，使用伴生对象实现类似功能。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> {
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> MAX_COUNT = <span class="hljs-number">100</span>  <span class="hljs-comment">// 类似静态常量</span>
        
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">()</span></span>: MyClass {    <span class="hljs-comment">// 类似静态工厂方法</span>
            <span class="hljs-keyword">return</span> MyClass()
        }
        
        <span class="hljs-meta">@JvmStatic</span>  <span class="hljs-comment">// 如果需要 Java 互操作</span>
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">staticMethod</span><span class="hljs-params">()</span></span> {
            println(<span class="hljs-string">"This can be called from Java as static method"</span>)
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">instanceMethod</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"This is an instance method"</span>)
    }
}

<span class="hljs-comment">// 使用方式</span>
println(MyClass.MAX_COUNT)  <span class="hljs-comment">// 直接通过类名访问</span>
<span class="hljs-keyword">val</span> obj = MyClass.create()   <span class="hljs-comment">// 直接通过类名调用</span>
</code></pre>
<h4 data-id="heading-5"><strong>十八、密封类（Sealed Class）：受限的类层次结构</strong></h4>
<p>密封类用于表示受限的类继承结构，在 <code>when</code>表达式中特别有用。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 定义密封类</span>
<span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span>&lt;<span class="hljs-type">out T</span>&gt; {
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Success</span>&lt;<span class="hljs-type">T</span>&gt;(<span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span>: T) : Result&lt;T&gt;()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Error</span>(<span class="hljs-keyword">val</span> message: String) : Result&lt;<span class="hljs-built_in">Nothing</span>&gt;()
    <span class="hljs-keyword">object</span> Loading : Result&lt;<span class="hljs-built_in">Nothing</span>&gt;()
}

<span class="hljs-comment">// 使用密封类 - when 表达式会检查是否覆盖所有情况</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handleResult</span><span class="hljs-params">(result: <span class="hljs-type">Result</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span> {
    <span class="hljs-keyword">when</span> (result) {
        <span class="hljs-keyword">is</span> Result.Success -&gt; println(<span class="hljs-string">"Success: <span class="hljs-subst">${result.data}</span>"</span>)
        <span class="hljs-keyword">is</span> Result.Error -&gt; println(<span class="hljs-string">"Error: <span class="hljs-subst">${result.message}</span>"</span>)
        Result.Loading -&gt; println(<span class="hljs-string">"Loading..."</span>)
        <span class="hljs-comment">// 不需要 else 分支，因为所有情况都已覆盖</span>
    }
}

<span class="hljs-keyword">val</span> successResult = Result.Success(<span class="hljs-string">"Data loaded"</span>)
<span class="hljs-keyword">val</span> errorResult = Result.Error(<span class="hljs-string">"Network error"</span>)

handleResult(successResult) <span class="hljs-comment">// 输出：Success: Data loaded</span>
handleResult(errorResult)   <span class="hljs-comment">// 输出：Error: Network error</span>
</code></pre>
<h4 data-id="heading-6"><strong>十九、扩展函数实战：为现有类添加超能力</strong></h4>
<p>让我们看一些实用的扩展函数例子：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 为 String 类添加扩展</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">isEmail</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">return</span> contains(<span class="hljs-string">"@"</span>) &amp;&amp; contains(<span class="hljs-string">"."</span>)
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">capitalizeWords</span><span class="hljs-params">()</span></span>: String {
    <span class="hljs-keyword">return</span> split(<span class="hljs-string">" "</span>).joinToString(<span class="hljs-string">" "</span>) { it.replaceFirstChar { char -&gt; char.uppercase() } }
}

<span class="hljs-comment">// 为 List 添加扩展</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> List<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">second</span><span class="hljs-params">()</span></span>: T = <span class="hljs-keyword">this</span>[<span class="hljs-number">1</span>]
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> List<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">randomOrNull</span><span class="hljs-params">()</span></span>: T? = <span class="hljs-keyword">if</span> (isEmpty()) <span class="hljs-literal">null</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.random()

<span class="hljs-comment">// 使用扩展函数</span>
println(<span class="hljs-string">"test@example.com"</span>.isEmail())        <span class="hljs-comment">// 输出：true</span>
println(<span class="hljs-string">"hello world"</span>.capitalizeWords())      <span class="hljs-comment">// 输出：Hello World</span>

<span class="hljs-keyword">val</span> list = listOf(<span class="hljs-string">"first"</span>, <span class="hljs-string">"second"</span>, <span class="hljs-string">"third"</span>)
println(list.second())                       <span class="hljs-comment">// 输出：second</span>
println(emptyList&lt;String&gt;().randomOrNull())  <span class="hljs-comment">// 输出：null</span>
</code></pre>
<h4 data-id="heading-7"><strong>二十、属性委托：强大的属性管理</strong></h4>
<p>属性委托是 Kotlin 的高级特性，可以简化代码。</p>
<ol>
<li>
<p><strong>lazy 委托：延迟初始化</strong></p>
<pre><code class="hljs language-scss" lang="scss">class ExpensiveObject {
    init {
        <span class="hljs-built_in">println</span>("正在创建昂贵的对象...")
    }
}

class MyClass {
    <span class="hljs-comment">// 只有第一次访问时才会创建</span>
    val expensiveObject: ExpensiveObject by lazy {
        <span class="hljs-built_in">println</span>("第一次访问，开始初始化")
        <span class="hljs-built_in">ExpensiveObject</span>()
    }
}

val myClass = <span class="hljs-built_in">MyClass</span>()
<span class="hljs-built_in">println</span>("对象已创建，但昂贵对象还未初始化")
<span class="hljs-built_in">println</span>(myClass.expensiveObject)  <span class="hljs-comment">// 这里才会真正初始化</span>
<span class="hljs-built_in">println</span>(myClass.expensiveObject)  <span class="hljs-comment">// 直接使用已初始化的对象</span>
</code></pre>
</li>
<li>
<p><strong>observable 委托：属性变化监听</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlin.properties.Delegates

<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-keyword">var</span> name: String <span class="hljs-keyword">by</span> Delegates.observable(<span class="hljs-string">"未命名"</span>) { property, oldValue, newValue -&gt;
        println(<span class="hljs-string">"属性 <span class="hljs-subst">${property.name}</span> 从 '<span class="hljs-variable">$oldValue</span>' 变为 '<span class="hljs-variable">$newValue</span>'"</span>)
    }
}

<span class="hljs-keyword">val</span> user = User()
user.name = <span class="hljs-string">"Alice"</span>  <span class="hljs-comment">// 输出：属性 name 从 '未命名' 变为 'Alice'</span>
user.name = <span class="hljs-string">"Bob"</span>    <span class="hljs-comment">// 输出：属性 name 从 'Alice' 变为 'Bob'</span>
</code></pre>
</li>
</ol>
<h4 data-id="heading-8"><strong>二十一、空安全深度探索：安全调用链</strong></h4>
<p>当处理复杂对象时，安全调用操作符特别有用。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Address</span>(<span class="hljs-keyword">val</span> street: String?, <span class="hljs-keyword">val</span> city: String)
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Company</span>(<span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> address: Address?)
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Employee</span>(<span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> company: Company?)

<span class="hljs-comment">// 复杂的嵌套对象</span>
<span class="hljs-keyword">val</span> employee: Employee? = Employee(
    <span class="hljs-string">"Alice"</span>, 
    Company(<span class="hljs-string">"Tech Corp"</span>, Address(<span class="hljs-string">"Main St"</span>, <span class="hljs-string">"Beijing"</span>))
)

<span class="hljs-comment">// 传统方式（繁琐）</span>
<span class="hljs-keyword">val</span> city1 = <span class="hljs-keyword">if</span> (employee != <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">if</span> (employee.company != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">if</span> (employee.company.address != <span class="hljs-literal">null</span>) {
            employee.company.address.city
        } <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span>
} <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span>

<span class="hljs-comment">// Kotlin 安全调用链（优雅！）</span>
<span class="hljs-keyword">val</span> city2 = employee?.company?.address?.city

println(city2) <span class="hljs-comment">// 输出：Beijing</span>

<span class="hljs-comment">// 如果中间有任何环节为 null，整个表达式返回 null</span>
<span class="hljs-keyword">val</span> employee2: Employee? = Employee(<span class="hljs-string">"Bob"</span>, <span class="hljs-literal">null</span>)
<span class="hljs-keyword">val</span> city3 = employee2?.company?.address?.city
println(city3) <span class="hljs-comment">// 输出：null</span>
</code></pre>
<h4 data-id="heading-9"><strong>实战项目：构建一个简单的任务管理系统</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 定义数据模型</span>
<span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskPriority</span> {
    <span class="hljs-keyword">object</span> Low : TaskPriority()
    <span class="hljs-keyword">object</span> Normal : TaskPriority()
    <span class="hljs-keyword">object</span> High : TaskPriority()
}

<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Task</span>(
    <span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Int</span>,
    <span class="hljs-keyword">val</span> title: String,
    <span class="hljs-keyword">val</span> description: String,
    <span class="hljs-keyword">val</span> priority: TaskPriority,
    <span class="hljs-keyword">val</span> isCompleted: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">false</span>
) {
    <span class="hljs-comment">// 扩展函数：获取优先级颜色</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getPriorityColor</span><span class="hljs-params">()</span></span>: String = <span class="hljs-keyword">when</span> (priority) {
        TaskPriority.Low -&gt; <span class="hljs-string">"绿色"</span>
        TaskPriority.Normal -&gt; <span class="hljs-string">"黄色"</span>
        TaskPriority.High -&gt; <span class="hljs-string">"红色"</span>
    }
}

<span class="hljs-comment">// 任务管理器（单例）</span>
<span class="hljs-keyword">object</span> TaskManager {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> tasks = mutableListOf&lt;Task&gt;()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> nextId = <span class="hljs-number">1</span>
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addTask</span><span class="hljs-params">(title: <span class="hljs-type">String</span>, description: <span class="hljs-type">String</span>, priority: <span class="hljs-type">TaskPriority</span>)</span></span>: Task {
        <span class="hljs-keyword">val</span> task = Task(nextId++, title, description, priority)
        tasks.add(task)
        <span class="hljs-keyword">return</span> task
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">completeTask</span><span class="hljs-params">(taskId: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">val</span> task = tasks.find { it.id == taskId }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (task != <span class="hljs-literal">null</span>) {
            tasks.replaceAll { <span class="hljs-keyword">if</span> (it.id == taskId) it.copy(isCompleted = <span class="hljs-literal">true</span>) <span class="hljs-keyword">else</span> it }
            <span class="hljs-literal">true</span>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-literal">false</span>
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getHighPriorityTasks</span><span class="hljs-params">()</span></span>: List&lt;Task&gt; {
        <span class="hljs-keyword">return</span> tasks.filter { it.priority <span class="hljs-keyword">is</span> TaskPriority.High &amp;&amp; !it.isCompleted }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getTasksByPriority</span><span class="hljs-params">(priority: <span class="hljs-type">TaskPriority</span>)</span></span>: List&lt;Task&gt; {
        <span class="hljs-keyword">return</span> tasks.filter { it.priority == priority }
    }
}

<span class="hljs-comment">// 使用任务管理系统</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 添加任务</span>
    <span class="hljs-keyword">val</span> task1 = TaskManager.addTask(<span class="hljs-string">"学习 Kotlin"</span>, <span class="hljs-string">"掌握 Kotlin 高级特性"</span>, TaskPriority.High)
    <span class="hljs-keyword">val</span> task2 = TaskManager.addTask(<span class="hljs-string">"写博客"</span>, <span class="hljs-string">"分享 Kotlin 学习心得"</span>, TaskPriority.Normal)
    
    println(<span class="hljs-string">"高优先级任务："</span>)
    TaskManager.getHighPriorityTasks().forEach { task -&gt;
        println(<span class="hljs-string">"<span class="hljs-subst">${task.title}</span> - 优先级：<span class="hljs-subst">${task.getPriorityColor()}</span>"</span>)
    }
    
    <span class="hljs-comment">// 完成任务</span>
    TaskManager.completeTask(task1.id)
    println(<span class="hljs-string">"任务1完成状态：<span class="hljs-subst">${TaskManager.getHighPriorityTasks().isEmpty()}</span>"</span>)
}
</code></pre>
<h4 data-id="heading-10"><strong>下一步学习方向</strong></h4>
<p>你现在已经掌握了 Kotlin 的核心高级特性！接下来可以探索：</p>
<ul>
<li><strong>协程（Coroutines）</strong> ：异步编程的现代解决方案</li>
<li><strong>类型安全的构建器（Type-safe builders）</strong> ：创建 DSL</li>
<li><strong>反射（Reflection）</strong> ：运行时检查代码结构</li>
<li><strong>多平台项目（KMP）</strong> ：用 Kotlin 开发 iOS、Web、桌面应用</li>
</ul>
<p>Kotlin 的世界非常广阔，这些高级特性将让你写出更加优雅、安全、高效的代码。尝试用这些特性重构你之前的项目，你会发现编程可以如此愉快！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[kotlin-4]]></title>    <link>https://juejin.cn/post/7571678674144854026</link>    <guid>https://juejin.cn/post/7571678674144854026</guid>    <pubDate>2025-11-12T12:47:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571678674144854026" data-draft-id="7571088527678275610" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="kotlin-4"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-11-12T12:47:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风冷"/> <meta itemprop="url" content="https://juejin.cn/user/3843548379091742"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            kotlin-4
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3843548379091742/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风冷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T12:47:15.000Z" title="Wed Nov 12 2025 12:47:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>太棒了！现在让我们进入 Kotlin 最激动人心的部分——<strong>协程</strong>和<strong>现代异步编程</strong>。这将彻底改变你处理并发和异步任务的方式。</p>
<hr/>
<h3 data-id="heading-0"><strong>Kotlin 协程：重新定义异步编程</strong></h3>
<h4 data-id="heading-1"><strong>二十二、协程基础：轻量级线程</strong></h4>
<p>协程是 Kotlin 用于异步编程的解决方案，比线程更轻量、更高效。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    println(<span class="hljs-string">"主线程开始: <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
    
    <span class="hljs-comment">// 启动一个协程</span>
    GlobalScope.launch {
        println(<span class="hljs-string">"协程开始: <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
        delay(<span class="hljs-number">1000L</span>) <span class="hljs-comment">// 非阻塞延迟</span>
        println(<span class="hljs-string">"协程结束: <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
    }
    
    println(<span class="hljs-string">"主线程继续执行: <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
    Thread.sleep(<span class="hljs-number">2000L</span>) <span class="hljs-comment">// 阻塞主线程，等待协程完成</span>
    println(<span class="hljs-string">"主线程结束"</span>)
}

<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 主线程开始: main</span>
<span class="hljs-comment">// 主线程继续执行: main</span>
<span class="hljs-comment">// 协程开始: DefaultDispatcher-worker-1</span>
<span class="hljs-comment">// 协程结束: DefaultDispatcher-worker-1</span>
<span class="hljs-comment">// 主线程结束</span>
</code></pre>
<p><strong>关键概念：</strong></p>
<ul>
<li><code>launch</code>: 启动一个不返回结果的协程</li>
<li><code>delay()</code>: 非阻塞的挂起函数</li>
<li>协程运行在后台线程池，不会阻塞主线程</li>
</ul>
<h4 data-id="heading-2"><strong>二十三、挂起函数：异步操作的基石</strong></h4>
<p>挂起函数是协程的核心，用 <code>suspend</code>关键字标记。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fetchUserData</span><span class="hljs-params">(userId: <span class="hljs-type">Int</span>)</span></span>: String {
    delay(<span class="hljs-number">1000L</span>) <span class="hljs-comment">// 模拟网络请求</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"用户 <span class="hljs-variable">$userId</span> 的数据"</span>
}

<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fetchUserPosts</span><span class="hljs-params">(userId: <span class="hljs-type">Int</span>)</span></span>: String {
    delay(<span class="hljs-number">1500L</span>) <span class="hljs-comment">// 模拟数据库查询</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"用户 <span class="hljs-variable">$userId</span> 的帖子"</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> time = measureTimeMillis {
        <span class="hljs-keyword">val</span> userData = fetchUserData(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">val</span> userPosts = fetchUserPosts(<span class="hljs-number">1</span>)
        println(<span class="hljs-string">"<span class="hljs-variable">$userData</span>, <span class="hljs-variable">$userPosts</span>"</span>)
    }
    println(<span class="hljs-string">"顺序执行耗时: <span class="hljs-subst">${time}</span>ms"</span>)
}
</code></pre>
<h4 data-id="heading-3"><strong>二十四、异步并发：同时执行多个任务</strong></h4>
<p>使用 <code>async</code>和 <code>await</code>实现并发操作。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*
<span class="hljs-keyword">import</span> kotlin.system.measureTimeMillis

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> time = measureTimeMillis {
        <span class="hljs-comment">// 同时启动两个异步任务</span>
        <span class="hljs-keyword">val</span> userDataDeferred = async { fetchUserData(<span class="hljs-number">1</span>) }
        <span class="hljs-keyword">val</span> userPostsDeferred = async { fetchUserPosts(<span class="hljs-number">1</span>) }
        
        <span class="hljs-comment">// 等待两个任务都完成</span>
        <span class="hljs-keyword">val</span> userData = userDataDeferred.await()
        <span class="hljs-keyword">val</span> userPosts = userPostsDeferred.await()
        
        println(<span class="hljs-string">"<span class="hljs-variable">$userData</span>, <span class="hljs-variable">$userPosts</span>"</span>)
    }
    println(<span class="hljs-string">"并发执行耗时: <span class="hljs-subst">${time}</span>ms"</span>) <span class="hljs-comment">// 时间接近最长任务的时间</span>
}

<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 用户 1 的数据, 用户 1 的帖子</span>
<span class="hljs-comment">// 并发执行耗时: 1506ms (而不是 1000 + 1500 = 2500ms)</span>
</code></pre>
<h4 data-id="heading-4"><strong>二十五、协程上下文与调度器</strong></h4>
<p>控制协程在哪个线程上运行。</p>
<pre><code class="hljs language-scss" lang="scss">import kotlinx<span class="hljs-selector-class">.coroutines</span>.*

fun <span class="hljs-selector-tag">main</span>() = runBlocking {
    <span class="hljs-comment">// 在不同调度器上启动协程</span>
    launch { <span class="hljs-comment">// 继承父协程的上下文</span>
        <span class="hljs-built_in">println</span>("默认调度器: ${Thread.currentThread()<span class="hljs-selector-class">.name</span>}")
    }
    
    <span class="hljs-built_in">launch</span>(Dispatchers.Unconfined) { <span class="hljs-comment">// 不受限制，在第一个挂起点之前运行在调用者线程</span>
        <span class="hljs-built_in">println</span>("不受限制: ${Thread.currentThread()<span class="hljs-selector-class">.name</span>}")
    }
    
    <span class="hljs-built_in">launch</span>(Dispatchers.Default) { <span class="hljs-comment">// CPU 密集型任务</span>
        <span class="hljs-built_in">println</span>("默认调度器: ${Thread.currentThread()<span class="hljs-selector-class">.name</span>}")
    }
    
    <span class="hljs-built_in">launch</span>(Dispatchers.IO) { <span class="hljs-comment">// I/O 密集型任务</span>
        <span class="hljs-built_in">println</span>("IO 调度器: ${Thread.currentThread()<span class="hljs-selector-class">.name</span>}")
    }
    
    <span class="hljs-built_in">launch</span>(newSingleThreadContext("MyThread")) { <span class="hljs-comment">// 专用线程</span>
        <span class="hljs-built_in">println</span>("专用线程: ${Thread.currentThread()<span class="hljs-selector-class">.name</span>}")
    }
}
</code></pre>
<h4 data-id="heading-5"><strong>二十六、结构化并发：避免资源泄漏</strong></h4>
<p>使用 <code>coroutineScope</code>实现结构化并发。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-comment">// 结构化并发：所有子协程完成后，父协程才完成</span>
    <span class="hljs-keyword">val</span> result = coroutineScope {
        <span class="hljs-keyword">val</span> userData = async { fetchUserData(<span class="hljs-number">1</span>) }
        <span class="hljs-keyword">val</span> userPosts = async { fetchUserPosts(<span class="hljs-number">1</span>) }
        
        <span class="hljs-string">"结果: <span class="hljs-subst">${userData.await()}</span> + <span class="hljs-subst">${userPosts.await()}</span>"</span>
    }
    println(result)
}

<span class="hljs-comment">// 处理异常的结构化并发</span>
<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fetchDataSafely</span><span class="hljs-params">()</span></span>: Result&lt;String&gt; = coroutineScope {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = async { 
            delay(<span class="hljs-number">500L</span>)
            <span class="hljs-keyword">if</span> (System.currentTimeMillis() % <span class="hljs-number">2</span> == <span class="hljs-number">0L</span>) {
                <span class="hljs-keyword">throw</span> RuntimeException(<span class="hljs-string">"模拟错误"</span>)
            }
            <span class="hljs-string">"获取的数据"</span>
        }.await()
        Result.success(<span class="hljs-keyword">data</span>)
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        Result.failure(e)
    }
}
</code></pre>
<h4 data-id="heading-6"><strong>二十七、流（Flow）：异步数据流</strong></h4>
<p>Flow 是 Kotlin 的响应式流处理，类似 RxJava。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*
<span class="hljs-keyword">import</span> kotlinx.coroutines.flow.*

<span class="hljs-comment">// 创建流</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">simpleFlow</span><span class="hljs-params">()</span></span>: Flow&lt;<span class="hljs-built_in">Int</span>&gt; = flow {
    println(<span class="hljs-string">"流开始"</span>)
    <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.3</span>) {
        delay(<span class="hljs-number">100L</span>) <span class="hljs-comment">// 模拟异步工作</span>
        emit(i) <span class="hljs-comment">// 发射值</span>
    }
}

<span class="hljs-comment">// 流的中间操作</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">processNumbers</span><span class="hljs-params">()</span></span>: Flow&lt;String&gt; = flow {
    <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.5</span>) {
        emit(i)
    }
}.filter { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> } <span class="hljs-comment">// 过滤偶数</span>
 .map { <span class="hljs-string">"数字: <span class="hljs-variable">$it</span>"</span> }    <span class="hljs-comment">// 转换</span>
 .onEach { println(<span class="hljs-string">"处理: <span class="hljs-variable">$it</span>"</span>) } <span class="hljs-comment">// 副作用</span>

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-comment">// 收集流</span>
    simpleFlow().collect { value -&gt; 
        println(<span class="hljs-string">"收集到: <span class="hljs-variable">$value</span>"</span>) 
    }
    
    println(<span class="hljs-string">"--- 带中间操作的流 ---"</span>)
    processNumbers().collect { println(<span class="hljs-string">"最终结果: <span class="hljs-variable">$it</span>"</span>) }
}
</code></pre>
<h4 data-id="heading-7"><strong>二十八、通道（Channel）：协程间通信</strong></h4>
<p>Channel 用于协程之间的通信。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*
<span class="hljs-keyword">import</span> kotlinx.coroutines.channels.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> channel = Channel&lt;String&gt;()
    
    <span class="hljs-comment">// 生产者协程</span>
    launch {
        <span class="hljs-keyword">val</span> users = listOf(<span class="hljs-string">"Alice"</span>, <span class="hljs-string">"Bob"</span>, <span class="hljs-string">"Charlie"</span>)
        <span class="hljs-keyword">for</span> (user <span class="hljs-keyword">in</span> users) {
            channel.send(user) <span class="hljs-comment">// 发送数据</span>
            delay(<span class="hljs-number">100L</span>)
        }
        channel.close() <span class="hljs-comment">// 关闭通道</span>
    }
    
    <span class="hljs-comment">// 消费者协程</span>
    launch {
        <span class="hljs-keyword">for</span> (user <span class="hljs-keyword">in</span> channel) { <span class="hljs-comment">// 接收数据</span>
            println(<span class="hljs-string">"收到用户: <span class="hljs-variable">$user</span>"</span>)
        }
        println(<span class="hljs-string">"通道已关闭"</span>)
    }
}
</code></pre>
<h4 data-id="heading-8"><strong>二十九、实战：构建完整的异步应用</strong></h4>
<p>让我们构建一个完整的用户信息获取系统。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*
<span class="hljs-keyword">import</span> kotlinx.coroutines.flow.*
<span class="hljs-keyword">import</span> kotlin.system.measureTimeMillis

<span class="hljs-comment">// 数据类</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> email: String)
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Post</span>(<span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> userId: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> title: String, <span class="hljs-keyword">val</span> content: String)
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserProfile</span>(<span class="hljs-keyword">val</span> user: User, <span class="hljs-keyword">val</span> posts: List&lt;Post&gt;, <span class="hljs-keyword">val</span> friends: List&lt;User&gt;)

<span class="hljs-comment">// 模拟远程数据源</span>
<span class="hljs-keyword">object</span> UserRepository {
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUser</span><span class="hljs-params">(id: <span class="hljs-type">Int</span>)</span></span>: User {
        delay(<span class="hljs-number">500L</span>) <span class="hljs-comment">// 模拟网络延迟</span>
        <span class="hljs-keyword">return</span> User(id, <span class="hljs-string">"用户<span class="hljs-variable">$id</span>"</span>, <span class="hljs-string">"user<span class="hljs-variable">$id</span>@example.com"</span>)
    }
    
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUserPosts</span><span class="hljs-params">(userId: <span class="hljs-type">Int</span>)</span></span>: List&lt;Post&gt; {
        delay(<span class="hljs-number">300L</span>)
        <span class="hljs-keyword">return</span> listOf(
            Post(<span class="hljs-number">1</span>, userId, <span class="hljs-string">"标题1"</span>, <span class="hljs-string">"内容1"</span>),
            Post(<span class="hljs-number">2</span>, userId, <span class="hljs-string">"标题2"</span>, <span class="hljs-string">"内容2"</span>)
        )
    }
    
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUserFriends</span><span class="hljs-params">(userId: <span class="hljs-type">Int</span>)</span></span>: List&lt;User&gt; {
        delay(<span class="hljs-number">400L</span>)
        <span class="hljs-keyword">return</span> listOf(
            User(userId + <span class="hljs-number">1</span>, <span class="hljs-string">"朋友1"</span>, <span class="hljs-string">"friend1@example.com"</span>),
            User(userId + <span class="hljs-number">2</span>, <span class="hljs-string">"朋友2"</span>, <span class="hljs-string">"friend2@example.com"</span>)
        )
    }
}

<span class="hljs-comment">// 业务逻辑层</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUserProfile</span><span class="hljs-params">(userId: <span class="hljs-type">Int</span>)</span></span>: UserProfile = coroutineScope {
        <span class="hljs-keyword">val</span> userDeferred = async { UserRepository.getUser(userId) }
        <span class="hljs-keyword">val</span> postsDeferred = async { UserRepository.getUserPosts(userId) }
        <span class="hljs-keyword">val</span> friendsDeferred = async { UserRepository.getUserFriends(userId) }
        
        UserProfile(
            user = userDeferred.await(),
            posts = postsDeferred.await(),
            friends = friendsDeferred.await()
        )
    }
    
    <span class="hljs-comment">// 使用 Flow 实现实时更新</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUserProfileStream</span><span class="hljs-params">(userId: <span class="hljs-type">Int</span>)</span></span>: Flow&lt;UserProfile&gt; = flow {
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            <span class="hljs-keyword">val</span> profile = getUserProfile(userId)
            emit(profile)
            delay(<span class="hljs-number">5000L</span>) <span class="hljs-comment">// 每5秒更新一次</span>
        }
    }
}

<span class="hljs-comment">// UI 层（模拟）</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> userService = UserService()
    
    println(<span class="hljs-string">"=== 获取用户资料 ==="</span>)
    <span class="hljs-keyword">val</span> time = measureTimeMillis {
        <span class="hljs-keyword">val</span> profile = userService.getUserProfile(<span class="hljs-number">1</span>)
        println(<span class="hljs-string">"用户: <span class="hljs-subst">${profile.user.name}</span>"</span>)
        println(<span class="hljs-string">"帖子数量: <span class="hljs-subst">${profile.posts.size}</span>"</span>)
        println(<span class="hljs-string">"好友数量: <span class="hljs-subst">${profile.friends.size}</span>"</span>)
    }
    println(<span class="hljs-string">"耗时: <span class="hljs-subst">${time}</span>ms"</span>)
    
    println(<span class="hljs-string">"\n=== 实时数据流 ==="</span>)
    <span class="hljs-comment">// 模拟实时数据流（只收集3次）</span>
    userService.getUserProfileStream(<span class="hljs-number">1</span>)
        .take(<span class="hljs-number">3</span>) <span class="hljs-comment">// 只取3个值</span>
        .collect { profile -&gt;
            println(<span class="hljs-string">"实时更新: <span class="hljs-subst">${profile.user.name}</span> - 帖子: <span class="hljs-subst">${profile.posts.size}</span>"</span>)
        }
}
</code></pre>
<h4 data-id="heading-9"><strong>三十、异常处理与超时控制</strong></h4>
<pre><code class="hljs language-scss" lang="scss">import kotlinx<span class="hljs-selector-class">.coroutines</span>.*

fun <span class="hljs-selector-tag">main</span>() = runBlocking {
    <span class="hljs-comment">// 1. 基本的异常处理</span>
    val job = launch {
        try {
            <span class="hljs-built_in">delay</span>(<span class="hljs-number">1000</span>L)
            throw <span class="hljs-built_in">RuntimeException</span>("测试异常")
        } catch (e: Exception) {
            <span class="hljs-built_in">println</span>("捕获异常: ${e.message}")
        }
    }
    job<span class="hljs-selector-class">.join</span>()
    
    <span class="hljs-comment">// 2. 协程异常处理器</span>
    val handler = CoroutineExceptionHandler { _, exception -&gt;
        <span class="hljs-built_in">println</span>("协程异常处理器捕获: ${exception.message}")
    }
    
    val job2 = <span class="hljs-built_in">launch</span>(handler) {
        throw <span class="hljs-built_in">RuntimeException</span>("被处理器捕获的异常")
    }
    job2<span class="hljs-selector-class">.join</span>()
    
    <span class="hljs-comment">// 3. 超时控制</span>
    try {
        <span class="hljs-built_in">withTimeout</span>(<span class="hljs-number">1300</span>L) {
            repeat(<span class="hljs-number">1000</span>) { <span class="hljs-selector-tag">i</span> -&gt;
                <span class="hljs-built_in">println</span>("任务 $i")
                <span class="hljs-built_in">delay</span>(<span class="hljs-number">500</span>L)
            }
        }
    } catch (e: TimeoutCancellationException) {
        <span class="hljs-built_in">println</span>("任务超时")
    }
    
    <span class="hljs-comment">// 4. 超时返回默认值</span>
    val result = <span class="hljs-built_in">withTimeoutOrNull</span>(<span class="hljs-number">1300</span>L) {
        <span class="hljs-built_in">delay</span>(<span class="hljs-number">1000</span>L)
        "成功结果"
    } ?: <span class="hljs-string">"超时默认值"</span>
    
    <span class="hljs-built_in">println</span>(<span class="hljs-string">"结果: $result"</span>)
}
</code></pre>
<h4 data-id="heading-10"><strong>三十一、高级模式：生产者-消费者模式</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*
<span class="hljs-keyword">import</span> kotlinx.coroutines.channels.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> CoroutineScope.<span class="hljs-title">produceUsers</span><span class="hljs-params">()</span></span> = produce {
    <span class="hljs-keyword">var</span> id = <span class="hljs-number">1</span>
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        send(User(id, <span class="hljs-string">"用户<span class="hljs-variable">$id</span>"</span>, <span class="hljs-string">"user<span class="hljs-variable">$id</span>@example.com"</span>))
        delay(<span class="hljs-number">200L</span>)
        id++
        <span class="hljs-keyword">if</span> (id &gt; <span class="hljs-number">5</span>) <span class="hljs-keyword">break</span> <span class="hljs-comment">// 只生产5个用户</span>
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> CoroutineScope.<span class="hljs-title">processUser</span><span class="hljs-params">(userChannel: <span class="hljs-type">ReceiveChannel</span>&lt;<span class="hljs-type">User</span>&gt;)</span></span> = produce {
    <span class="hljs-keyword">for</span> (user <span class="hljs-keyword">in</span> userChannel) {
        delay(<span class="hljs-number">100L</span>) <span class="hljs-comment">// 模拟处理时间</span>
        send(<span class="hljs-string">"已处理: <span class="hljs-subst">${user.name}</span>"</span>)
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> userProducer = produceUsers()
    <span class="hljs-keyword">val</span> processor = processUser(userProducer)
    
    <span class="hljs-comment">// 消费处理结果</span>
    <span class="hljs-keyword">for</span> (result <span class="hljs-keyword">in</span> processor) {
        println(result)
    }
    
    println(<span class="hljs-string">"处理完成"</span>)
}
</code></pre>
<h4 data-id="heading-11"><strong>下一步学习方向</strong></h4>
<p>你现在已经掌握了 Kotlin 协程的核心概念！接下来可以探索：</p>
<ol>
<li><strong>Flow 高级操作</strong>：<code>combine</code>、<code>zip</code>、<code>flatMapLatest</code>等操作符</li>
<li><strong>状态管理</strong>：使用 <code>StateFlow</code>和 <code>SharedFlow</code></li>
<li><strong>测试协程</strong>：使用 <code>TestCoroutineDispatcher</code>和 <code>runTest</code></li>
<li><strong>Android 上的协程</strong>：与 ViewModel、Lifecycle 集成</li>
<li><strong>服务端协程</strong>：Ktor 框架的使用</li>
</ol>
<p>协程是 Kotlin 生态中最强大的特性之一，它将彻底改变你处理异步编程的方式。尝试在实际项目中使用这些模式，你会发现代码变得更加简洁和易于维护！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[高质量动态代理池IP，到底怎么选才不踩坑？]]></title>    <link>https://juejin.cn/post/7568405112269864996</link>    <guid>https://juejin.cn/post/7568405112269864996</guid>    <pubDate>2025-11-04T07:42:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7568405112269864996" data-draft-id="7568416956041101366" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="高质量动态代理池IP，到底怎么选才不踩坑？"/> <meta itemprop="keywords" content="TCP/IP"/> <meta itemprop="datePublished" content="2025-11-04T07:42:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="召唤神龙"/> <meta itemprop="url" content="https://juejin.cn/user/640384299179028"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            高质量动态代理池IP，到底怎么选才不踩坑？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/640384299179028/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    召唤神龙
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-04T07:42:18.000Z" title="Tue Nov 04 2025 07:42:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近很多做数据采集、市场分析或者业务测试的朋友都在问，市面上那么多代理IP服务，到底哪家的动态代理池靠谱？用免费的吧，速度慢不说，还经常被封；随便买一个套餐，结果IP纯净度差、响应慢，白白浪费预算。其实，选对代理IP服务，关键不在于价格多低，而在于是否<strong>稳定、高匿、覆盖广</strong>。今天我们就结合实际使用体验，聊聊如何挑选高质量动态代理池IP，并针对常见业务场景做一次深度解析。</p>
<h2 data-id="heading-0">一、为什么你需要动态代理池？</h2>
<p>简单来说，动态代理池的核心价值在于“变化”和“稳定”的平衡。比如你在做数据采集，如果一直用同一个IP频繁请求，很容易被目标网站识别并封禁。而动态IP池可以在每次请求时自动更换IP，模拟不同地区真实用户的行为，大幅降低被封风险。高质量的代理池还会对IP进行实时检测，确保每一个IP都可用，避免工作中断。</p>
<p>需要注意的是，动态代理并非只是“不断换IP”，更重要的是IP的质量和覆盖范围。有些服务商虽然IP数量多，但大部分是重复或低效的，实际使用中频繁掉线，反而影响效率。</p>
<h2 data-id="heading-1">二、好用的动态代理池应具备哪些特点？</h2>
<p>根据实际业务需求，一个好的动态代理池至少应满足以下几点：</p>
<p><strong>1. 高可用率与响应速度：</strong>代理IP的可用率最好在99%以上，平均响应时间控制在毫秒级。例如有些服务如神龙HTTP，宣称可用率99.9%，响应迅速，这对高频采集或实时测试场景非常重要。</p>
<p><strong>2. 广泛的IP覆盖：</strong>IP池需覆盖国内多数城市，甚至细分到地区级。例如神龙IP代理覆盖200多个城市，能精准模拟多地网络环境，适合做区域化营销测试或数据采集。</p>
<p><strong>3. 高匿名性与安全性：</strong>代理IP应具备高匿名特性，不透露用户真实IP，同时传输协议需加密，避免数据泄露。一些服务商采用运营商正规授权IP，如神龙HTTP强调其IP资源来自三大运营商，合法合规，适合企业长期使用。</p>
<p><strong>4. 业务场景适配性：</strong>能否支持高并发、多协议（HTTP/HTTPS/SOCKS5等），以及是否提供定制解决方案，都是需要考虑的。例如有些服务商支持一对一技术定制，适合有特殊需求的企业用户。</p>
<h2 data-id="heading-2">三、实际场景中如何应用动态代理？</h2>
<p><strong>场景1：数据采集与爬虫</strong><br/>在做大规模数据抓取时，动态代理池能自动切换IP，避免IP被封。例如神龙HTTP提到可为大数据采集提供高去重代理方案，支持高并发请求，适合爬虫长时间运行。</p>
<p><strong>场景2：区域化营销测试</strong><br/>如果你需要测试不同地区用户对广告或搜索结果的反馈，可以用动态代理模拟多地IP。例如神龙IP代理支持精准定位城市，帮助分析地区用户偏好，优化营销策略。</p>
<p><strong>场景3：服务器性能测试</strong><br/>通过代理模拟多地区用户并发请求，测试服务器承载能力和响应延迟。有些服务如神龙IP代理支持定制带宽（6-15M），适合做负载测试和性能评估。</p>
<p><strong>场景4：AI训练与业务监控</strong><br/>动态代理能提供大量差异化IP，用于模型训练或业务监控。例如神龙HTTP称其IP池超3000万，能支持AI大模型训练所需的数据多样性。</p>
<h2 data-id="heading-3">四、常见问题答疑</h2>
<p><strong>问：动态代理和静态代理有什么区别？</strong><br/>动态代理IP会按一定频率自动更换，适合需要频繁切换IP的场景（如采集、测试）；静态代理IP长期不变，适合需要稳定IP的业务（如远程登录或固定身份场景）。</p>
<p><strong>问：代理IP的匿名级别有哪些？</strong><br/>一般分为透明代理、普通匿名代理和高匿名代理。高匿名代理完全不透露用户真实IP，推荐在业务中使用，以避免被识别。</p>
<p><strong>问：如何测试代理IP是否可用？</strong><br/>可通过在线工具或自写脚本检测IP的响应速度、匿名性和稳定性。建议选择提供免费测试的服务商，实际验证后再决定购买。</p>
<p><strong>问：企业用户选代理服务最该关注什么？</strong><br/>除了IP质量，还要看重服务商的技术支持、协议合规性和定制能力。最好选择能提供24小时技术支持、正规运营商资源的服务商，避免法律风险。</p>
<h2 data-id="heading-4">五、总结建议</h2>
<p>选择高质量动态代理池IP，不能光看价格或IP数量，更要结合业务需求综合判断。如果你是做企业级高频采集，需要高并发和稳定响应，可以优先考虑资源量大、支持定制的服务；如果侧重多地区模拟和营销测试，则要选择覆盖城市广、定位精准的服务。</p>
<p>无论用哪家服务，都建议先免费测试，体验实际速度与稳定性。毕竟代理IP是底层工具，选对了事半功倍，选错了全是坑。希望本文能帮你理清思路，找到适合的业务解决方案！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>