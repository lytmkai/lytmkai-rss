<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Java 17实战：我从老旧Spring项目迁移中总结的7个关键避坑点]]></title>    <link>https://juejin.cn/post/7571722835658571810</link>    <guid>https://juejin.cn/post/7571722835658571810</guid>    <pubDate>2025-11-13T04:17:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571722835658571810" data-draft-id="7571734313923493922" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 17实战：我从老旧Spring项目迁移中总结的7个关键避坑点"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-13T04:17:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT_陈寒"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 17实战：我从老旧Spring项目迁移中总结的7个关键避坑点
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT_陈寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T04:17:17.000Z" title="Thu Nov 13 2025 04:17:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Java 17实战：我从老旧Spring项目迁移中总结的7个关键避坑点</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>在当今快速发展的Java生态系统中，保持技术栈的现代性至关重要。随着Java 17（LTS版本）的发布和Spring框架的持续演进，许多企业正面临将老旧Spring项目迁移到新版本的技术挑战。本文基于笔者实际参与的大型遗留系统迁移经验，总结了7个关键避坑点，涵盖从依赖管理到运行时行为的各个方面。</p>
<h2 data-id="heading-2">主体内容</h2>
<h3 data-id="heading-3">1. Java模块系统(JPMS)与老式类加载机制的冲突</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 典型问题示例：非模块化依赖在modulepath下的行为变化</span>
<span class="hljs-keyword">requires</span> spring.context; <span class="hljs-comment">// 显式声明模块依赖</span>
</code></pre>
<p>迁移到Java 17时最大的架构级变化莫过于Java Platform Module System(JPMS)。我们发现：</p>
<ul>
<li><strong>自动模块</strong>：许多老旧Spring库尚未提供明确的<code>module-info.java</code>，导致在模块路径下运行时出现意外行为</li>
<li><strong>资源加载</strong>：<code>ClassLoader.getResource()</code>的行为在模块化环境下发生变化，特别影响Spring的资源配置加载</li>
<li><strong>解决方案</strong>：
<ol>
<li>暂时使用classpath而非modulepath运行（通过<code>--class-path</code>参数）</li>
<li>为关键依赖创建自动模块描述符</li>
<li>全面测试资源加载逻辑</li>
</ol>
</li>
</ul>
<h3 data-id="heading-4">2. Spring XML配置与现代注解驱动的差异</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 遗留配置示例 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"oldService"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.OldServiceImpl"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"dependency"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"legacyDao"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>
</code></pre>
<p>在老项目中常见的XML配置方式需要特别注意：</p>
<ul>
<li><strong>Bean覆盖行为</strong>：Spring Boot默认禁止Bean定义覆盖，而老项目常常依赖此特性</li>
<li><strong>延迟初始化</strong>：现代Spring默认急切初始化单例Bean，可能暴露隐藏的循环依赖问题</li>
<li><strong>应对策略</strong>：
<ul>
<li>显式设置<code>spring.main.allow-bean-definition-overriding=true</code></li>
<li>使用<code>@Lazy</code>注解匹配原有初始化行为</li>
<li>逐步将XML配置迁移为<code>@Configuration</code>类</li>
</ul>
</li>
</ul>
<h3 data-id="heading-5">3. Java语法兼容性问题处理</h3>





























<table><thead><tr><th>Java版本</th><th>Lambda</th><th>var</th><th>Switch表达式</th></tr></thead><tbody><tr><td>Java 8</td><td>✓</td><td>×</td><td>×</td></tr><tr><td>Java 11</td><td>✓</td><td>✓</td><td>×</td></tr><tr><td>Java 17</td><td>✓</td><td>✓</td><td>✓</td></tr></tbody></table>
<p>常见的语法陷阱包括：</p>
<ul>
<li><strong>接口默认方法</strong>：老项目中可能包含未考虑默认方法冲突的实现</li>
<li><strong>类型推断变化</strong>：Java改进的类型推断可能导致泛型方法调用行为变化</li>
<li><strong>推荐做法</strong>：
<ol>
<li>使用JDK Migration工具分析源代码差异</li>
<li><code>javac -Xlint:unchecked</code>全面检查泛型问题</li>
<li>IDE静态分析工具检测语法兼容性</li>
</ol>
</li>
</ul>
<h3 data-id="heading-6">4. Hibernate/JPA持久层升级陷阱</h3>
<p>实体映射中的潜在问题：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Entity</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LegacyEntity</span> {
    <span class="hljs-meta">@Column(name = "USER_ID")</span> <span class="hljs-comment">// Oracle保留字问题可能在新版本凸显</span>
    <span class="hljs-keyword">private</span> String userId;
    
    <span class="hljs-meta">@Temporal(TemporalType.DATE)</span> <span class="hljs-comment">// JAVA8+应使用java.time类型</span>
    <span class="hljs-keyword">private</span> Date oldDate;
}
</code></pre>
<p>关键注意事项：</p>
<ul>
<li><strong>方言变化</strong>：Hibernate新版方言可能生成不同的SQL语句（特别是分页查询）</li>
<li><strong>N+1查询问题</strong>：原本能忍受的性能问题在新版连接池中可能被放大</li>
<li><strong>事务传播行为细微变化</strong></li>
</ul>
<p>解决方案路径：</p>
<ol>
<li>SQL日志比对（开启<code>spring.jpa.show-sql=true</code>)</li>
<li>Flyway/Liquibase脚本兼容性测试</li>
<li>JDBC连接池参数调优（建议HikariCP）</li>
</ol>
<h3 data-id="heading-7">5. Spring Security的破坏性变更</h3>
<p>安全配置的重大变化时间线：</p>
<pre><code class="hljs language-css" lang="css">Spring Security ≤<span class="hljs-number">4</span> → CSRF默认关闭 
Spring Security ≥<span class="hljs-number">5</span> → CSRF默认开启 

OAuth ≤<span class="hljs-number">1</span><span class="hljs-selector-class">.x</span> → <span class="hljs-keyword">@EnableOAuth2Client</span> 
OAuth ≥<span class="hljs-number">2</span>.x →全新客户端注册体系
</code></pre>
<p>迁移时必须注意：</p>
<ol>
<li>WebSecurityConfigurerAdapter已被弃用（需重构为Lambda DSL风格）</li>
<li>PasswordEncoder强制要求（原明文密码存储必须显式处理）</li>
<li>CSRF保护策略调整建议：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Overrideprotected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception {
    http.csrf(csrf -&gt; csrf 
        .ignoringAntMatchers(<span class="hljs-string">"/api/legacy/**"</span>));
}
</code></pre>
<h3 data-id="heading-8">6. Logging框架桥接的正确姿势</h3>
<p>日志堆栈的典型混乱情况：</p>
<pre><code class="hljs language-scss" lang="scss">应用代码 → SLF4J API 
↓ 
log4j-over-slf4j → Logback (期望路径)
↑ 
直接调用Log4j (意外路径)
</code></pre>
<p>确保日志统一的关键步骤：</p>
<ol>
<li>Maven依赖检查：</li>
</ol>
<pre><code class="hljs language-xml&lt;dependency&gt;" lang="xml&lt;dependency&gt;">    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
    &lt;artifactId&gt;jul-to-slf4j&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<ol start="2">
<li>JVM参数验证：</li>
</ol>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">-Djava.util.logging.config.file</span>=/dev/null  
<span class="hljs-attr">-Dlog4j2.configurationFactory</span>=...
</code></pre>
<p>3.AOP切面日志适配测试（特别是CGLIB代理场景）</p>
<p>###7.Java内部API的最后防线</p>
<p>Sun.misc.BASE64Encoder等内部API在Java17已完全移除</p>
<p>应急方案对比表：</p>

























<table><thead><tr><th> 场景 </th><th> 临时方案 </th><th> 长期方案 </th></tr></thead><tbody><tr><td>Unsafe访问</td><td>--add-opens</td><td>VarHandle</td></tr><tr><td>XML解析器</td><td>JAXB独立依赖(Jakarta) </td><td>javax.xml移植包</td></tr><tr><td>Nashorn脚本  </td><td>GraalVM JS引擎  移植到Rhino  </td><td/></tr></tbody></table>
<p>推荐执行顺序：
1.JDK升级前先用jdeps分析(--jdk-internals)
2.Gradle/Maven插件辅助检测：</p>
<pre><code class="hljs language-groovycompileJava" lang="groovycompileJava"/></pre>
<p>3.Runtime.version()做版本适配兜底</p>
<p>##总结</p>
<p>本次迁移实践中我们深刻体会到："没有简单的升级只有权衡的艺术"。Java17带来的不仅是语言特性的提升更重要的是推动架构现代化改造的机会窗口。遵循以下原则可降低风险:</p>
<p>•增量式迁移(多阶段发布)
•强化契约测试(特别是对下游系统)
•建立性能基准线(避免隐性退化)</p>
<p>最终我们的系统获得了40%的GC效率提升和新语言特性的开发效率增益证明这些努力是值得的。希望这些实战经验能帮助读者避开我们曾经踩过的那些"深坑"。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[小白也能训大模型！Hugging Face用「200页手册」亲自教学，连踩的坑都告诉你了...]]></title>    <link>https://juejin.cn/post/7571742703533899812</link>    <guid>https://juejin.cn/post/7571742703533899812</guid>    <pubDate>2025-11-13T03:29:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571742703533899812" data-draft-id="7571747061385904147" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="小白也能训大模型！Hugging Face用「200页手册」亲自教学，连踩的坑都告诉你了..."/> <meta itemprop="keywords" content="LLM,程序员,Agent"/> <meta itemprop="datePublished" content="2025-11-13T03:29:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            小白也能训大模型！Hugging Face用「200页手册」亲自教学，连踩的坑都告诉你了...
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T03:29:25.000Z" title="Thu Nov 13 2025 03:29:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58566b11f6f64110ab7486a258b0320f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763609365&amp;x-signature=1iVOt4dVsjMvOo6zpP30a2PNVuE%3D" alt="" loading="lazy"/></p>
<p>对于技术小白而言，能否快速从零开始训练一个世界级的大语言模型（LLM）呢？</p>
<p>答案或许是：可以的。</p>
<p>日前，Hugging Face 在技术博客《The Smol Training Playbook: The Secrets to Building World-Class LLMs》中，以训练 3B 参数大小的 SmoILM3 为主线，系统剖析了构建 SOTA 语言模型的全过程，包括预训练、后训练和 infra，足足 200 多页内容，详细记录了哪些方法有效、哪些无效，以及如何确保其可靠运行。</p>
<p>无论你是初入人工智能（AI）领域的学生、希望了解全流程的工程师，还是正在规划下一个大模型项目的团队，这份手册都提供了可参考的实战经验。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ece956cca89240358538640f6450ae63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763609365&amp;x-signature=cI7x%2BAdG97KCnr35CWzia%2BIz%2Bu8%3D" alt="" loading="lazy"/></p>
<p>原文链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fspaces%2FHuggingFaceTB%2Fsmol-training-playbook%23introduction" target="_blank" title="https://huggingface.co/spaces/HuggingFaceTB/smol-training-playbook#introduction" ref="nofollow noopener noreferrer">huggingface.co/spaces/Hugg…</a></p>
<h2 data-id="heading-0">训练指南针——从“要不要做”开始</h2>
<p>在过去几年中，大量团队在拥有算力后便直接开始训练模型，但大多数项目无果而终。这些失败的根源并非算法不足，而是动机不清。</p>
<p>Hugging Face 团队用三个问题，把整个训练过程变成一条清晰的思考链条：为什么要训练（Why） → 训练什么（What） → 怎么训练（How）。这三个问题看似简单，却能区分“理性训练”和“盲目烧算力”的差别。</p>
<p><strong>Why —— 为什么要训练</strong></p>
<p>真正值得训练的原因只有三种：一是科研探索，比如验证新架构、新算法；二是生产需求，为特定场景或安全要求定制模型； 三是战略性开源，为大模型领域补足空白。团队要判断已有模型是否能通过提示工程（Prompting Engineering）或微调（Fine-tuning）来解决问题；若不能，再进入下一阶段。</p>
<p><strong>What —— 要训练什么</strong></p>
<p>当训练动机明确后，接下来要设计模型。这一阶段包括模型架构、规模、数据来源、上下文长度、词表设计等。例如，要在手机端部署，就得追求“小而高效”；要做多语言模型，就得有大型分词器词汇表（tokenizer vocab）。</p>
<p><strong>How —— 怎么训练</strong></p>
<p>执行阶段永远排在训练动机和设计模型之后。如果前两步没有足够的思考，任何“怎么做”的讨论都是空谈。 很多研究团队往往先选择训练框架、确定超参数，再回头追问“为何要做”。而 Hugging Face 倡导的逻辑是反向的：只有在明确“Why”与“What”之后，讨论“How”才具有方向性和可操作性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c84fa96fe9194d77ba3eee433f2405e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763609365&amp;x-signature=t%2F8qTsHQpHD3%2FPBBHadvvwPAgi0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">预训练——每个模型都始于一次小的消融实验</h2>
<p>很多人认为，用 arXiv 论文训练模型，模型应该会更聪明。但这种数据过于专业化而缺少日常性、多样性，反而会损害模型的通用性能。在 LLM 领域，那些人类认为“好”的输入，不一定带来“好”的输出。</p>
<p>机器学习实际是一门实验的科学。我们无法只靠推理或常识判断“什么有效”，只能不断进行实验（即消融实验）来对比和验证。</p>
<h3 data-id="heading-2">Hugging Face 团队认为，消融实验设置包括以下三个流程：</h3>
<p><strong>1.选择基线</strong></p>
<p>模型训练，需要站在巨人的肩膀上，只有从一个强大、成熟的基线开始，才能把有限时间和金钱集中在真正重要的创新和优化上，而不是浪费在解决别人已经解决过的问题上。</p>
<p>选择基线时要符合实际用例和部署环境 <strong>；</strong> 必须是经历过大规模训练（万亿 token 级别）的 <strong>；</strong> 有公开的、可复现的超参数和设置；主流的训练和推理框架都支持它等。</p>
<p><strong>2.选择训练框架</strong></p>
<p>训练 LLM 的核心是迭代速度。当模型和数据规模足够大时，限制团队迭代速度的往往不是想法，而是训练框架。</p>
<p>一个好的 LLM 训练框架应该提供以下功能：</p>
<p>高性能数据加载器：必须提供一个可以在多个节点上高效工作、并且不会成为瓶颈的数据加载器。</p>
<p>鲁棒的分布式设置：框架应该能够处理所有并行化方案（数据并行、张量并行、流水线并行）以及它们的组合。</p>
<p>可调试性和可扩展性：一个清晰的框架有助于调试，并允许添加新的功能。</p>
<p>支持最新的硬件：它应该支持最新的 GPU 架构，并利用特定的硬件功能（如 Hopper 架构上的 Transformer Engine 或 FP8 格式）。</p>
<p>成熟的生态系统：活跃的社区、定期维护和大量现有代码库，可以更快地解决问题并利用现有的解决方案。</p>
<p><strong>3.设置消融实验框架</strong></p>
<p>消融实验的目的是在小规模上运行实验，并获得可以自信地外推到最终生产环境运行的结果。主要有两种方法：</p>
<p>方法一：减少 token 数量。可以采用目标模型规模，但只用较少的 token 进行训练。例如，Hugging Face 在 SmolLM3 的消融实验中，训练了完整的 3B 模型，但只用了 100B token，而非 11T token。</p>
<p>方法二：使用代理（Proxy）模型。如果目标模型太大，可以训练一个更小的代理模型来进行消融实验。</p>
<p>过程中——马拉松式的长周期训练</p>
<p>训练 LLM 是一场长期的、充满变数的“马拉松”，而非短期的“冲刺”。许多问题只在长时间、大规模、高负荷的真实生产环境运行中才会暴露，这是小规模消融实验无法完全模拟的。</p>
<h3 data-id="heading-3">Hugging Face 团队解决了两个主要问题：</h3>
<p><strong>1.消失的吞吐量</strong></p>
<p>吞吐量（Tokens/秒）衡量着系统在训练期间每秒处理的 token 数量，它直接影响训练时间；吞吐量下降 50% 意味着原本一个月的运行将变成两个月。训练启动后的几小时内，吞吐量骤降。</p>
<p>最终通过检查节点监控指标，发现吞吐量骤降与磁盘读取延迟尖峰相关。问题在于数据存储， Hugging Face 团队的 24TB 数据集存储在 FSx (Weka) 上，由于存储推到了极限，它在训练中途开始驱逐（evicting）数据集分片，迫使团队必须重新抓取它们，从而造成停顿，这解释了吞吐量的巨大波动。</p>
<p><strong>2.潜伏的并行化 Bug</strong></p>
<p>训练中还出现了其他意外挑战，例如一个隐蔽的张量并行（Tensor Parallelism，TP）Bug。团队发现，每个 TP 进程使用的随机种子是相同的，这导致了结果与非 TP 运行不匹配。</p>
<p>由于之前通过消融实验验证了训练中的每一个其他组件，所以团队能很快地将 TP 识别为唯一可能的原因，并在发现性能差距的一天内修复了这个 Bug。</p>
<h2 data-id="heading-4">后训练——打磨模型</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7f85b3b24f94b7a8957606eb707f0f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763609365&amp;x-signature=eIjT%2FLa8X2p376Gm2aWMAjvoQCI%3D" alt="" loading="lazy"/></p>
<p>图｜LLM 后训练流程图</p>
<p>随着基础模型的规模和质量不断提升，后训练——即对预训练完成的模型进行的后续微调和对齐步骤——已成为 LLM 价值链中最大的差异化因素。</p>
<p>如果说预训练是用蛮力把知识灌进模型的权重里，后训练就是把这些原始能力雕琢成可靠、可控的形态。后训练的具体做法为：</p>
<ul>
<li>监督微调（SFT）：用于注入核心能力；</li>
<li>偏好优化（PO）：用于直接从人类或 AI 偏好中学习；</li>
<li>强化学习（RL）：用于超越监督数据，提炼可靠性和推理能力；</li>
<li>数据整理（Data curation）：用于在多样性和质量之间取得正确的平衡；</li>
<li>评估（Evaluation）：用于跟踪进度，并及时发现能力退步现象。</li>
</ul>
<p>Hugging Face 团队提到，构建一个世界级 LLM 需要的不仅是蛮力，更是一套系统化的方法论。他们希望，这本工具书可以给每一个对大模型感兴趣的人提供实用帮助。</p>
<h2 data-id="heading-5">学习资源推荐</h2>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[实战解析｜阿里云 FunctionAI：Serverless 架构下的 AI 原生应用全栈开发指南]]></title>    <link>https://juejin.cn/post/7571678763782848546</link>    <guid>https://juejin.cn/post/7571678763782848546</guid>    <pubDate>2025-11-13T03:49:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571678763782848546" data-draft-id="7571655979255808040" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="实战解析｜阿里云 FunctionAI：Serverless 架构下的 AI 原生应用全栈开发指南"/> <meta itemprop="keywords" content="Serverless"/> <meta itemprop="datePublished" content="2025-11-13T03:49:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            实战解析｜阿里云 FunctionAI：Serverless 架构下的 AI 原生应用全栈开发指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T03:49:42.000Z" title="Thu Nov 13 2025 03:49:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：刘宇</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/560f5bd2a639495bb9d664326c17785c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763610582&amp;x-signature=ci6AfMyU5rbvyxKocjkiMWfXKmk%3D" alt="image.png" loading="lazy"/></p>
<p><em>本文整理自 2025 云栖大会，</em> <em>阿里云智能集团产品专家，刘宇演讲议题《函数计算发布 FunctionAl:serverless Al 原生应用基础设施》</em></p>
<p>在 AI 技术应用落地进程中，目前面临着五大核心挑战：开发/学习门槛过高，部署运维阶段复杂，AI 应用安全备受挑战，生态能力方面存在严重的割裂与锁定现象，同时资源成本高昂且利用率低下。这些挑战极大地阻碍了 AI 技术的广泛普及以及应用效率的有效提升。</p>
<p>阿里云函数计算（FC）依托 Serverless AI 基础设施与全栈能力的创新突破，推出 Function AI（函数智能），精准攻克上述痛点问题，全面推动 AI 应用在开发至运维的全流程中实现降本增效。以下将从四个关键维度，详细阐述阿里云函数计算（FC）的核心解决方案。</p>
<h2 data-id="heading-0">函数计算 FC：Serverless 形态的 AI 基础设施</h2>
<p>阿里云函数计算（FC）全新推出 <strong>Serverless AI 基础设施</strong>，以“高可用、低成本、零/低运维”为核心，为企业提供从模型部署到 Agent 开发的全栈解决方案。该平台通过 Serverless 架构的弹性特性与智能化资源管理，显著降低 AI 应用的开发复杂度与资源成本，助力企业快速实现 AI 落地。</p>
<p><strong>1. 开发效率提升：</strong> 无需关注底层资源，开发者可专注于业务逻辑，模型一键转换为 Serverless API。</p>
<p><strong>2. 弹性资源调度：</strong> 按需付费 + N 分之一卡资源分配（如 1/16 卡），GPU 部署成本降低 90% 以上。</p>
<p><strong>3. 免运维特性：</strong> 实例闲置时自动缩容至 0，资源利用率优化 60%，实现业务运维转型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48c7c8cff5e346619b4a1dfb2f1695c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763610582&amp;x-signature=NoTKHJjYVYQyurghp6n7dWfkREY%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-1">核心能力发布：AgentRun 与模型服务、文生图服务</h2>
<p>阿里云函数计算全新发布 FunctionAI，基于 Serverless 架构的企业级 AI 应用基础设施平台，实现从模型托管到 Agent 开发的全流程覆盖，显著降低技术门槛并提升跨平台适配性。</p>
<h3 data-id="heading-2">AgentRun 全流程解决方案</h3>
<p>Agent Run <strong>[</strong> <strong>1]</strong> 通过高代码与低代码结合，提升 AI 开发效率，支持主流开发生态。在部署阶段，提供轻量、灵活、安全隔离的 AI 运行时，支持多种模型和工具运行时，确保应用安全与扩展性。运维方面，Agent Run 具备全链路监控能力，免资源运维，实现业务运维转型。八大组件共同构建，助力开发者轻松构建企业级 AI 应用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47d255bd34b34a83a0dd4b27f07d0d77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763610582&amp;x-signature=35wpEa0EWrsTqcLZfn9psi83qrc%3D" alt="图片" loading="lazy"/></p>
<p><strong>1. 全生命周期能力</strong></p>
<ul>
<li>开发阶段：高代码 + 低代码模式，兼容阿里云百炼、CloudFlow、Dify 等生态，开发者可自由选择框架；</li>
<li>部署阶段：轻量、灵活、安全隔离的运行时，支持大模型/垂类模型调用，提供安全沙箱隔离机制与 MCP/Function Call 协议双保障；</li>
<li>运维阶段：全链路监控 + 端到端可观测性，定位问题并提供优化建议，实现免资源运维。</li>
</ul>
<p><strong>2. 技术架构优势</strong></p>
<ul>
<li>百万级并发：基于 Session 亲和与多语言引擎，提供企业级沙箱服务能力；</li>
<li>毫秒级弹性：内存快照技术实现 CPU 毫秒启动、GPU 秒级响应；</li>
<li>成本降低 60%：支持 GPU/CPU/内存解耦配置（最小 0.25 CPU），实例闲置时自动缩容至 0，按需付费。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98348c639ba44559a4fe4cedea42516e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763610582&amp;x-signature=EYw9W3tEAe8SxNRaLb0JFuwYeb4%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-3">大语言模型代理机制</h4>
<p><strong>多模型统一接入</strong></p>
<ul>
<li>支持 Cloud、GPT、通义千问等 20 家主流大模型，实现开源模型一键部署；</li>
<li>通过统一规范管理所有模型，解决 First Token 延迟与负载均衡问题。</li>
</ul>
<p><strong>动态模型治理</strong></p>
<ul>
<li>自动切换机制：当主模型 First Token 时间过长或负载过高时，快速启用备用模型；</li>
<li>并行处理能力：多模型并行执行，首个返回结果的模型优先作为主模型。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1deb59059040413ab301e0205779786f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763610582&amp;x-signature=T%2BGpz45P8c5bA1ecE%2F7h2JQtiAs%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-4">工具生态联动</h4>
<p><strong>1. 统一工具接口</strong></p>
<ul>
<li>兼容 MCP/Function Call 协议，适配主流工具与第三方服务，API 集成时间从天级降至分钟级。</li>
</ul>
<p><strong>2. 智能工具管理</strong></p>
<ul>
<li>Tool Hub 插件市场：海量插件一键部署，快速构建业务场景；</li>
<li>智能路由优化：通过语义分析前置筛选工具，降低调用时间（从 60 秒降至秒级）与 Token 消耗。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a39f669f99eb446b81da83b7ba7b0848~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763610582&amp;x-signature=ULUZoJpMC2xx71bBUrrIITQKB84%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-5">模型服务：AI 模型一键转化为 Serverless API</h3>
<p>阿里云函数计算推出的<strong>模型服务[2]</strong> ，以 Serverless 架构为核心，通过生态兼容性、技术能力与成本优化三位一体，为企业提供从模型部署到服务调用的全链路解决方案。该服务显著降低 AI 应用开发门槛，同时保障高可用性与资源高效利用，助力企业快速构建生产级模型服务。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1361223193f44487a28733a2939853c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763610582&amp;x-signature=J8TVQpHVCovvV0tab5irXNU%2FF7Q%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>
<p><strong>生态兼容性</strong></p>
<ul>
<li>覆盖大语言模型与垂类模型，兼容 ModelScope、HuggingFace 等主流平台；</li>
<li>支持 vLLM、SGLang、Ollama、Transformer 等技术架构的一键部署。</li>
</ul>
</li>
<li>
<p><strong>技术能力</strong></p>
<ul>
<li>提供 100+ 模型在线体验，200+ 模型一键部署；</li>
<li>六大框架一键托管，与 Agent 服务无缝集成；</li>
<li>DevPod 在线环境支持代码调试与镜像自动构建，无需掌握 Dockerfile。</li>
</ul>
</li>
<li>
<p><strong>成本优化</strong></p>
<ul>
<li>Serverless GPU 技术结合按量付费模式，N 分之一卡资源分配（如 1/16 卡）；</li>
<li>部署成本降低 90% 以上，资源闲置时不计费，支持百万级并发与毫秒级弹性；</li>
<li>与 ComfyUI、Dify 等生态实现一键联动，消除资源预置顾虑。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-6">文生图/声音/视频：多模态 AI 创作平台</h3>
<p><strong>多模态 AI 创作平台[3]</strong> 以“零门槛生成”为核心，通过全链路工具与生态联动，覆盖电商设计、游戏渲染、营销物料、教育培训等全行业场景。平台提供开箱即用的文生图/视频/声音能力，结合高性价比算力与自动化资源管理，显著降低创作门槛与成本。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d5896b81c7a47cda95416beab89187c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763610582&amp;x-signature=S3%2BA4jkOsj7KMJCMeD3bKJBII7k%3D" alt="图片" loading="lazy"/></p>
<p><strong>1. 文生图与文生视频</strong></p>
<ul>
<li>集成 ComfyUI 与 Stable Diffusion 工具，解决本地部署复杂度与显存资源限制；</li>
<li>支持全场景内容生成，从设计到渲染实现端到端自动化。</li>
</ul>
<p><strong>2. Lora 模型训练</strong></p>
<ul>
<li>提供 Muse Lora 等专业训练器，覆盖数据标注到模型训练的全流程；</li>
<li>适配垂类场景需求，快速生成定制化模型。</li>
</ul>
<p><strong>3. 企业级 Serverless API 调用</strong></p>
<ul>
<li>一键部署 Stable Diffusion、ComfyUI 等模型，自动转换为 Serverless API；</li>
<li>高性价比 GPU 弹性算力 + 自动扩容，支持同步/异步灵活切换。</li>
</ul>
<h2 data-id="heading-7">Agent 最佳全栈实践：Function Q，你的云上助理</h2>
<p>Function Q 是专业的函数计算智能助手，集成了基于大模型的代码自动生成、智能运维诊断和系统架构设计三大核心能力，显著提升 Serverless 应用的开发效率。整体技术栈基于函数计算 FC、API 网关、RocketMQ、SLS 等阿里云成熟基础服务构建，遵循云原生设计原则，提供企业级的高可用性、安全性和可观测性保障。 </p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c2564f647a84607b8a03f4fc122b870~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763610582&amp;x-signature=sQSdPP73BIo0EMFn6r5EMPi18ws%3D" alt="图片" loading="lazy"/></p>
<p><strong>1. 智能开发助手</strong></p>
<ul>
<li>意图驱动部署：用户通过自然语言描述需求（如“获取本地天气”），Function Q 自动生成代码并部署至函数计算，提供按量付费的 API 接口；</li>
<li>示例场景：输入“获取本地 IP”，Function Q 自动查询 API 并生成可调用服务，无需手动编写 Dockerfile 或配置资源。</li>
</ul>
<p><strong>2. 运维诊断专家</strong></p>
<ul>
<li>问题自动分析：针对资源费用异常、函数运行错误等问题，调用 MCP 工具链定位根源并提供解决方案；</li>
<li>实时监控支持：支持全链路可观测性，缩短故障排查周期，提升运维效率。</li>
</ul>
<p><strong>3. 架构设计顾问</strong></p>
<ul>
<li>业务迁移指导：通过业务描述分析，推荐切分方法或整体打包策略，适配函数计算架构需求；</li>
<li>场景覆盖：解决开发者对 Serverless 架构迁移路径的困惑，实现零门槛上云。</li>
</ul>
<h2 data-id="heading-8">拥抱开源，与开源共成长</h2>
<p>阿里云函数计算将坚定拥抱开源、与开源共成长。AI 并非单纯商业化产品，而是开放共赢的技术生态平台。当下，我们已与 Agentscope、LangChain、dify 等平台开展开源托管及代码集成工作。</p>
<p>未来，还有两大关键动作：一是开源 AgentRun SDK，助力快速集成上层开源框架；二是推出 model plugin，让所有垂类模型可像插件般，快速接入 dify、N8N、Stable Diffusion\ComfyUI 等现有生态。我们期望借此不仅拥抱开源，更能反哺开源，携手共进。</p>
<p><strong>相关链接：</strong></p>
<p>[1] Agent Run</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ffcnext.console.aliyun.com%2Fagent-run" target="_blank" title="https://fcnext.console.aliyun.com/agent-run" ref="nofollow noopener noreferrer">fcnext.console.aliyun.com/agent-run</a></p>
<p>[2] 模型服务</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ffcnext.console.aliyun.com%2Ffun-model" target="_blank" title="https://fcnext.console.aliyun.com/fun-model" ref="nofollow noopener noreferrer">fcnext.console.aliyun.com/fun-model</a></p>
<p>[3] 多模态 AI 创作平台</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ffcnext.console.aliyun.com%2Ffun-art%2Fexplore" target="_blank" title="https://fcnext.console.aliyun.com/fun-art/explore" ref="nofollow noopener noreferrer">fcnext.console.aliyun.com/fun-art/exp…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vibe Coding 实战！花了两天时间，让 AI 写了一个富文本渲染引擎！]]></title>    <link>https://juejin.cn/post/7571695634942394395</link>    <guid>https://juejin.cn/post/7571695634942394395</guid>    <pubDate>2025-11-12T15:58:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571695634942394395" data-draft-id="7571725550709440539" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vibe Coding 实战！花了两天时间，让 AI 写了一个富文本渲染引擎！"/> <meta itemprop="keywords" content="Claude,AI编程"/> <meta itemprop="datePublished" content="2025-11-12T15:58:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="非专业程序员"/> <meta itemprop="url" content="https://juejin.cn/user/1968539883540688"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vibe Coding 实战！花了两天时间，让 AI 写了一个富文本渲染引擎！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1968539883540688/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    非专业程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T15:58:37.000Z" title="Wed Nov 12 2025 15:58:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、先上效果图</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/520d9c2c2023492aa95592613d76adde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2e5LiT5Lia56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763567916&amp;x-signature=Ue4CRoIHL5IRXtWneBINOrbG4%2BQ%3D" alt="" loading="lazy"/></p>
<p>最近动手实践了下 Vibe Coding，想尝试​<strong>一行代码不写，纯通过 Prompt 让 AI 写了一个富文本渲染引擎</strong>​。</p>
<p>整体花了两天时间不到，效果如上图，支持的特性有：</p>
<ul>
<li>类似前端的 Block、InlineBlock、Inline 布局</li>
<li>文本样式：加粗、斜体、下划线、删除线，前景色，背景色，同一行不同字体大小混排等</li>
<li>Attachment：图文混排或插入自定义 View 等</li>
<li>异步排版和算高：基于 CoreText API，支持子线程布局算高，主线程渲染</li>
<li>单测覆盖</li>
</ul>
<p>项目用的 Claude AI，差不多耗费了 50$（是真的贵！但也是真的强！），本文将记录整个过程和一些经验总结。</p>
<h2 data-id="heading-1">二、过程记录</h2>
<h2 data-id="heading-2">2.1 Claude 安装和项目初始化</h2>
<p>Claude 安装和使用在网上有很多教程，细节这里不再赘述，推荐直接使用 VSCode 的 Claude AI 插件；后文「经验总结」部分也会总结 Claude AI 的常用命令，感兴趣可以直接跳转。</p>
<p>首先，我们需要新建一个空的 iOS 项目和富文本渲染引擎的 pod（这里我们叫 RichView），创建完成之后在 VSCode 中打开，点击右上角 Claude AI 的图标开启会话，输入<code>/init</code> 命令初始化工程。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6e2f2e28efa451fbed4cc8476ecfd4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2e5LiT5Lia56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763567916&amp;x-signature=C4lUbo%2B4R6urf2jPMwEtbAuepCE%3D" alt="" loading="lazy"/></p>
<p><strong><code>/init</code><strong>​</strong>命令的作用是让 Claude 理解整个项目，这是在项目中使用 Claude 的第一步，只需要执行一次就好。</strong></p>
<p><code>/init</code>会在根目录下自动创建一个<code>CLAUDE.md</code>文件，这个文件可以理解成​<strong>全局上下文</strong>​，即每次新开 Claude 会话都会自动加载其中的内容，我们可以在这里记录一些如修改历史、全局说明等内容。</p>
<h2 data-id="heading-3">2.2 技术选型、架构</h2>
<p>让 AI 写代码，和我们自己写代码基本类似，不过是将我们的思路转换成 Prompt 告诉 AI。</p>
<p>编码之前需要先确定几件事情：这些确定好之后，我们后续的任务拆分才会更顺利。</p>
<p><strong>1）需要支持哪些 Feature</strong></p>
<ul>
<li>支持文本样式：加粗、斜体、下划线、删除线，前景色，背景色，同一行不同字体大小混排等</li>
<li>支持 Attachment：图文混排或插入自定义 View 等</li>
<li>支持子线程排版算高</li>
<li>支持单元测试</li>
</ul>
<p><strong>2）技术选型</strong></p>
<p>自定义富文本渲染引擎，最难的点在于如何实现精确的文本分词排版（原理可以参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FfcL6if52qYQUTChEjntHJg" target="_blank" title="https://mp.weixin.qq.com/s/fcL6if52qYQUTChEjntHJg" ref="nofollow noopener noreferrer">从 0 到 1 自定义文字排版引擎：原理篇</a>），iOS 有内置的 CoreText API（见<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FfQiB4sYtqdlSEbu8UhspIA" target="_blank" title="https://mp.weixin.qq.com/s/fQiB4sYtqdlSEbu8UhspIA" ref="nofollow noopener noreferrer">链接</a>）用于文本分词排版，当然也可以基于开源的跨端排版引擎 HarfBuzz（见<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FNxBfP4MJ0Y67trIVh39tag" target="_blank" title="https://mp.weixin.qq.com/s/NxBfP4MJ0Y67trIVh39tag" ref="nofollow noopener noreferrer">链接</a>）进行处理。</p>
<p>我们这里不需要跨端，因此选择 CoreText 作为方案选型。</p>
<p>官方封装的 NSAttributedString 当然也能做这件事情，但是从工程实践看，NSAttributedString 在扩展性（比如支持列表、表格等自定义布局）、使用方便性，以及长文本的性能方面不尽如人意。</p>
<p><strong>3）技术架构</strong></p>
<p>文本分词之后，还需要进行布局排版，为方便后续拓展布局，我们这里参考前端的布局模型，引入 Block、InlineBlock、Inline 的概念。</p>
<p>同时参考浏览器的布局渲染过程，引入三棵树的概念：</p>
<ul>
<li>ElementTree：用户输入，整个富文本可以通过一颗 ElementTree 来表示</li>
<li>LayoutTree：负责布局排版，会在这一层处理好文本的分词、图文混排时各自的位置等</li>
<li>RenderTree：负责渲染，这一层接收布局完成的结果，进行最终的上屏绘制</li>
</ul>
<p>敲定技术选型、技术架构之后，我们就可以按思路拆分子任务了。</p>
<h2 data-id="heading-4">2.3 子任务：ElementTree</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbd659f377ab4c9f9b2850a1a58962e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2e5LiT5Lia56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763567916&amp;x-signature=drWJODgfv5a%2BcvD2%2Fiyc0GqiW7Q%3D" alt="" loading="lazy"/></p>
<p>由于我们参考了前端的布局模型，因此我们需要告诉 AI 在 CSS 中 Block、InlineBlock、Inline 的布局规范，这个在<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FCSS%2FGuides%2FDisplay%2FBlock_and_inline_layout" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/CSS/Guides/Display/Block_and_inline_layout" ref="nofollow noopener noreferrer"> MDN </a>中可以直接摘录，当然也可以直接让 AI 帮我们生成（如上图）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf9f97ac2a8c4d5c9fd2d28a97400b1e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2e5LiT5Lia56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763567916&amp;x-signature=BMCsyI802gmOKHn%2BEZchExebbIg%3D" alt="" loading="lazy"/></p>
<p>接着，我们需要告诉 AI 怎么构建 ElementTree，也就是上图所示 Prompt。</p>
<p>最后，我们就可以让 AI 参照 Prompt，生成 ElementTree 了。</p>
<p>ElementTree 生成完成后，我们发现遗漏了单测环节，继续完善 ElementTree 的 Prompt，然后​<strong>明确告诉 AI xx 文件新增了 xx 任务</strong>​，让 AI 继续完成任务，如下图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7d031cb1e8949ce8b93e97add008d19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2e5LiT5Lia56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763567916&amp;x-signature=5I38q4kf7N4WFlMRvupmuA4wYKM%3D" alt="" loading="lazy"/></p>
<p>ElementTree 的创建还算比较顺利，AI 理解也比较到位，生成的代码基本符合预期。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/953fcaa194a646418f38f4772612a721~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2e5LiT5Lia56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763567916&amp;x-signature=cz1gojje7CSIWaqmVOSPcT9lAUE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">2.4 子任务：LayoutTree</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92810dfad40045f3913074c2f5c50508~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2e5LiT5Lia56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763567916&amp;x-signature=Zx%2FgxFRPe8zOFdQkFVsTjwDoOk8%3D" alt="" loading="lazy"/></p>
<p>同样，我们定义好 Prompt，让 AI 生成 LayoutTree。</p>
<p>LayoutTree 的生成不太顺利，而且从最后的测试效果看也有很多 Bug，主要如下：</p>
<ul>
<li>AI 将绘制相关逻辑也加到了 LayoutTree 中，但预期绘制是单独的 RenderTree</li>
<li>布局问题：InlineBlock 无法整体换行，多个 Inline 在同一行时被换行展示，margin、padding 不生效等</li>
<li>对齐问题：同一行包含不同字号的文本时，对齐方式不对</li>
<li>attachment 无法显示</li>
<li>…</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39d5d4ad1aa542f8a8b74ed6b03e8bf6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2e5LiT5Lia56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763567916&amp;x-signature=nWLC3qQPX%2Fnix1UOMJtQht%2FUKw4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">2.5 子任务：RenderTree</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b588d169cbd344a7b174ece81dc036b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2e5LiT5Lia56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763567916&amp;x-signature=o381XCic0zsKqCkKB%2FsJEYhms0g%3D" alt="" loading="lazy"/></p>
<p>由于 LayoutTree 这个底层基础没扎实，RenderTree 的搭建也不顺利，RenderTree 的 Prompt 如上。</p>
<h2 data-id="heading-7">2.6 BugFix</h2>
<p>至此，AI 生成了初版的富文本渲染引擎，接下来就是让 AI 写个 Demo 试用一下，在使用过程中，发现了很多上面罗列的 Bug，针对这些 Bug，也可以让 AI 来修复：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/343d19cdcc904d76a022a9a20943ab75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2e5LiT5Lia56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763567916&amp;x-signature=A6m2dPlUyMznZDhWISTjsShIIBE%3D" alt="" loading="lazy"/></p>
<p>在让 AI 修 Bug 过程中，也踩了一些坑，参见下文经验总结。</p>
<h2 data-id="heading-8">三、一些经验总结</h2>
<h2 data-id="heading-9">3.1 Claude AI 常用命令</h2>
<ul>
<li><code>/init</code>：项目初始化，第一次使用 Claude AI 时执行，​<strong>每个项目只需要执行一次即可</strong>​；会生成一个<code>CLAUDE.md</code>文件，这是​<strong>项目的全局上下文</strong>​，每次新建 Claude 会话时，会自动读取其中的内容；可以在<code>CLAUDE.md</code>文件中补充修改历史、全局说明等</li>
<li><code>@</code>：可以输入<code>@</code>来添加文件到会话窗口，将文件作为上下文给 AI</li>
<li><code>/exit</code>：关闭当前会话</li>
<li><code>/clear</code>：清除当前会话上下文，和退出会话然后新开一个会话效果一样</li>
<li><code>/compact</code>：压缩和总结当前会话上下文，和<code>/clear</code>的区别是，<code>/compact</code>会将当前会话上下文总结后作为当前会话的新上下文，<code>/clear</code>会直接清除所有上下文</li>
<li><code>/resume</code>：显示和恢复历史上下文</li>
<li>自定义 command：可以将通用的 Prompt 做成自定义 command，文件位置在<code>.claude/commands/</code>；还可以通过 <code>$ARGUMENUTS</code> 来接收自定义参数</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5e4f70c3c0b42caa221de1cb0bf2032~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2e5LiT5Lia56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763567916&amp;x-signature=%2FvsfdGwhw8oGvs9ivfWvZ%2FSGnSs%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<p><code>/agents</code>：有的任务比较复杂，或上下文较多，那可以拆分成多个 agents 进行组合，比如写业务逻辑 -&gt; 构建单元测试 -&gt; CI/CD 等，可以拆分多个 agents 组合使用</p>
</li>
<li>
<p>会话模式：在最新版本的 Claude AI 插件中，除了之前命令行风格的 GUI 以外，还提供了会话框风格的 GUI，切换会话模式，查看历史会话等会更方便；如下，会话模式可以在输入框左下角切换</p>
</li>
<li>
<ul>
<li>Edit automatically：AI 根据输入 Prompt 进行理解并直接编辑文件，一般使用该模式即可</li>
</ul>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa3f8eea9b364d41a119159a316cb12f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2e5LiT5Lia56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763567916&amp;x-signature=8AIVFCT%2BakGCI5Rp1w1DwQ0isfw%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<ul>
<li>Plan mode：AI 根据输入 Prompt 列出修改计划，你可以进一步校验和修改 Plan</li>
</ul>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/edccef995e484d3da5629c1a054a025a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2e5LiT5Lia56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763567916&amp;x-signature=DhaJOjtHdBTLI6ssR8pdyhW2GN8%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<ul>
<li>Ask before edits：AI 修改文件前询问</li>
</ul>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/283093f7ef1d4001be269832fbaac12d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2e5LiT5Lia56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763567916&amp;x-signature=7L8MljGnrzrIJLTZZx9%2BrYR6MeE%3D" alt="" loading="lazy"/></p>
<ul>
<li>MCP：常用的 MCP 是<code>context7</code>，<code>context7</code>是用于帮助 AI 查找最新文档的，避免使用过时 API</li>
</ul>
<h2 data-id="heading-10">3.2 经验总结</h2>
<p>不得不感叹，AI 编程实在太强大了，相信在不久的将来，一个只会写 Prompt 的非专业程序员，也能完整交付一个 App 了。</p>
<p>让 AI 编程，并不是说给一句话就能让 AI 完成代码，各种细节还是需要人来提前想清楚，毕竟最终维护代码和解决问题的还是我们自己，AI 只是帮我们<strong>提效和扩展思路</strong>的工具；有句话总结的蛮好：你可以将 AI 视为一个非常聪明，甚至资深，但是没有业务经验的程序员。</p>
<p>下面我想总结下最近实战的一些经验，希望对各位有帮助：</p>
<p><strong>1）架构设计需要提前规划好，尽量想清楚细节</strong></p>
<p>谋定而后动，不管是我们自己写代码，还是让 AI 写代码，我觉得提前想好要做什么，怎么做是非常重要的。</p>
<p>架构设计好了，细节想清楚了，那怎么拆分子任务，其实也就明确了。</p>
<p><strong>2）任务拆分越小越好，上下文越明确越好</strong></p>
<p>AI 最适合做有明确输入输出的事情，给的上下文越明确，AI 产生幻觉的概率越低，输出结果也会越准确。</p>
<p>当然，如果是输入输出明确的任务，也可以让 AI 先输出测试用例，测试用例人工检测完备之后，再让 AI 编码也是可以的（测试驱动开发/TDD）。</p>
<p><strong>3）每一项目任务做好之后再进行下一项任务</strong></p>
<p>基础不牢，地动山摇！</p>
<p>推荐打磨好每一项子任务再继续下一项任务，否则千里之堤毁于蚁穴，每个任务都留一点坑，最终可能带来灾难性的结果！</p>
<p>另外，​<strong>单测是个好东西</strong>​，对每项任务补齐单测，可以有效防止后续 AI 改出问题。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4a64db6938248e5b313b171bb50e5d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2e5LiT5Lia56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763567916&amp;x-signature=whw7TRt%2BIfIVobCVwtBGbluOiAk%3D" alt="" loading="lazy"/></p>
<p><strong>4）善用 Git，防止代码污染</strong></p>
<p>Claude 在 Edit automatically 模式下会直接修改文件，为了防止污染其他代码，每次让 AI 修改前尽量保证工作区干净，这样也能方便我们 Review 代码。</p>
<p><strong>5）写 Prompt 尽量用明确的词汇，不要表意不清</strong></p>
<p>比如在构建 ElementTree 时，我会明确告诉 AI 要支持哪些 Style，可以有效避免 AI 臆测</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b33f7e09eb3c4519a868e829d0284c65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2e5LiT5Lia56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763567916&amp;x-signature=Ny01xR%2F%2Bdzs4EDf6kOsdWTUyVkI%3D" alt="" loading="lazy"/></p>
<p>与之相反的反例是，在构建 LayoutTree 时，限定不足，导致 AI 自由发挥，最终实现出很多 Bug。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27596abffd0e4051b3a8fa31044a6747~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2e5LiT5Lia56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763567916&amp;x-signature=m3rTFDpOgS8CFo7JI4o0Qlyp%2B%2BM%3D" alt="" loading="lazy"/></p>
<p><strong>6）善用提示词：think &lt; think hard &lt; think harder &lt; ultrathink</strong></p>
<p>可以在 Prompt 中追加 think hard / think harder 等词汇，来让 AI 进入​<strong>深度思考</strong>​，这并不是什么黑魔法，而是 Claude AI 官方认证的，参见：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fengineering%2Fclaude-code-best-practices" target="_blank" title="https://www.anthropic.com/engineering/claude-code-best-practices" ref="nofollow noopener noreferrer">www.anthropic.com/engineering…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b75eebc1e18e4de98a0ff568b298ea45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2e5LiT5Lia56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763567916&amp;x-signature=qqh1dhpbg5jy7PKuIBYrLyZIKt0%3D" alt="" loading="lazy"/></p>
<p>实践下来，确实还是有效果的，如下是让 AI 修复文本对齐问题，加了 think hard AI 会更深入理解代码，找到问题原因；当然，这种方式也有弊端，就是会耗费更多的 token（money）👺</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a5d6e88778941a287d6e4f9fcd765eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2e5LiT5Lia56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763567916&amp;x-signature=Vc1%2BQ8XH%2Bc1vZBPW7QBM%2FjsSzNg%3D" alt="" loading="lazy"/></p>
<p>​<strong>7）善用</strong>​ <strong><code>/compact</code><strong>​​</strong>​ ​</strong>​ <strong><code>/clear</code><strong>​</strong>命令，减少模型幻觉</strong></p>
<p>如果不主动清除，Claude AI 会话中的上下文是会一直保存的，当一个会话中问答轮次过多，可能会导致 AI 理解不准确（幻觉）。</p>
<p>可以通过<code>/compact</code> 或<code>/clear</code>命令，来压缩/清除上下文。</p>
<p>一般我在修复有关联性的 Bug 时，会使用<code>/compact</code>命令，这样 AI 就不需要重新理解工程，理解 Bug 了，可以提高效率。</p>
<p><strong>8）BugFix 尽量构造最小可复现 Demo</strong></p>
<p>BugFix 其实也是一个子任务，最小可复现 Demo 减少 AI 的理解负担。</p>
<p><strong>9）及时人工介入，避免在一个问题上死磕</strong></p>
<p>有时候让 AI 修复 Bug 时，可能反复修改都解决不了，这时候大概率是 AI 没有真正理解问题，或者就是输入的 Prompt 有问题，这种情况下就没必要让 AI 死磕问题了，我们可以及时人工介入，避免浪费时间。</p>
<p><strong>10）善用 Plan 模式</strong></p>
<p>在任务拆分时，我们自己可能也没想明白应该怎么做，那可以切换到 Plan 模式，让 AI 和我们一起拆任务。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e358edcca7a247efbef6bcb0bbb55c4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2e5LiT5Lia56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763567916&amp;x-signature=KfXAhLqmFtg9DTncfLV622jGg%2FA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11">3.3 Vibe Coding 的一些弊端</h2>
<p><strong>1）付费，而且还挺贵！</strong></p>
<p>这是一个挺现实的问题，一些好的模型都挺贵，而且还是消耗的刀乐，国内厂商的模型质量又不尽如人意。</p>
<p><strong>2）编码风格问题 &amp; 扩展性、易用性、鲁棒性不足</strong></p>
<p>AI 写的代码还是挺容易看出来的，感觉很难带有程序员的个人风格，一个明显的表现是会用一些比较少见的 API，虽然，这可能也是 AI 的厉害之处。</p>
<p>另外，AI 在一些函数复用性、扩展性、使用方便性上有时候差强人意，比如 AI 生成代码如下：如果要配置 Element 的 Style，需要不断的调用<code>text.style.xxx</code>，但其实写成链式调用使用起来会更舒服，如下注释部分</p>
<pre><code class="hljs language-scss" lang="scss">let text = <span class="hljs-built_in">TextElement</span>(text: "一、晨光初照")
text<span class="hljs-selector-class">.style</span><span class="hljs-selector-class">.color</span> = <span class="hljs-selector-class">.red</span>
text<span class="hljs-selector-class">.style</span><span class="hljs-selector-class">.font</span> = UIFont<span class="hljs-selector-class">.systemFont</span>(ofSize: <span class="hljs-number">17</span>)

<span class="hljs-comment">// 更好的写法</span>
<span class="hljs-comment">// text.style.setColor(xxx).setFont(xxx)</span>
</code></pre>
<p>鲁棒性方面，AI 不会主动考虑调用场景，比如我虽然告诉了 AI 我要支持子线程布局，但是 AI 生成的代码并不是线程安全的。</p>
<p>当然，上述这些，可以通过完善 Prompt 来部分弥补。</p>
<p><strong>3）问题定位幻觉</strong></p>
<p>有时候让 AI 排查一些 Bug，它无法找到真正的原因，反复修改后还是有问题。</p>
<p>这种情况下，就需要人工介入了，我们可以自己定位问题，再告诉 AI 怎么修改，而不要让 AI 死磕问题，避免浪费时间。</p>
<h2 data-id="heading-12">四、贴下源码 &amp; Prompt</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FHusterYP%2FRichView%2Ftree%2Fmain" target="_blank" title="https://github.com/HusterYP/RichView/tree/main" ref="nofollow noopener noreferrer">github.com/HusterYP/Ri…</a></p>
<blockquote>
<p>内容首发在公众号「非专业程序员Ping」，觉得有用的话，三连再走吧～ (⁎˃ᴗ˂⁎)<br/>
富文本相关，你可能感兴趣：</p>
</blockquote>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FEYPO3sSjtIstD3RmlRCs9w" target="_blank" title="https://mp.weixin.qq.com/s/EYPO3sSjtIstD3RmlRCs9w" ref="nofollow noopener noreferrer">一文读懂字符与编码</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F96YJGYKLoxENC4qT9tYNoQ" target="_blank" title="https://mp.weixin.qq.com/s/96YJGYKLoxENC4qT9tYNoQ" ref="nofollow noopener noreferrer">一文读懂字符、字形、字体</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FD0A8HAQaQNart7KAdWXyJg" target="_blank" title="https://mp.weixin.qq.com/s/D0A8HAQaQNart7KAdWXyJg" ref="nofollow noopener noreferrer">一文读懂字体文件</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FfcL6if52qYQUTChEjntHJg" target="_blank" title="https://mp.weixin.qq.com/s/fcL6if52qYQUTChEjntHJg" ref="nofollow noopener noreferrer">从0到1自定义文字排版引擎：原理篇</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FEpaNjLcG6DZBc128A2gdIQ" target="_blank" title="https://mp.weixin.qq.com/s/EpaNjLcG6DZBc128A2gdIQ" ref="nofollow noopener noreferrer">逆向分析CoreText中的字体级联/Font Fallback机制</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F1oOSJkTIJ8njV49B6PsfgA" target="_blank" title="https://mp.weixin.qq.com/s/1oOSJkTIJ8njV49B6PsfgA" ref="nofollow noopener noreferrer">新手小白也能看懂的LLDB技巧/逆向技巧</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fo0Uv0b4MpXJA5Pa_tuM_IQ" target="_blank" title="https://mp.weixin.qq.com/s/o0Uv0b4MpXJA5Pa_tuM_IQ" ref="nofollow noopener noreferrer">HarfBuzz概览</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FqaEfPkmFYRgbOJXqctJPDg" target="_blank" title="https://mp.weixin.qq.com/s/qaEfPkmFYRgbOJXqctJPDg" ref="nofollow noopener noreferrer">HarfBuzz核心概念</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FNxBfP4MJ0Y67trIVh39tag" target="_blank" title="https://mp.weixin.qq.com/s/NxBfP4MJ0Y67trIVh39tag" ref="nofollow noopener noreferrer">HarfBuzz实战：五大核心API实例详解【附iOS/Swift示例】</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🧩 Argon2 密码哈希]]></title>    <link>https://juejin.cn/post/7571747061385691155</link>    <guid>https://juejin.cn/post/7571747061385691155</guid>    <pubDate>2025-11-13T03:02:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571747061385691155" data-draft-id="7571729676344197183" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🧩 Argon2 密码哈希"/> <meta itemprop="keywords" content="后端,人工智能"/> <meta itemprop="datePublished" content="2025-11-13T03:02:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一起养条鱼吧"/> <meta itemprop="url" content="https://juejin.cn/user/2515334721186663"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🧩 Argon2 密码哈希
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2515334721186663/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一起养条鱼吧
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T03:02:43.000Z" title="Thu Nov 13 2025 03:02:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">📘 概述</h2>
<p><code>argon2</code> 是一种<strong>现代、安全的密码哈希算法</strong>，用于安全存储用户密码或其他敏感认证信息。
它不是加密（encryption），而是<strong>单向哈希（hashing）</strong> —— 无法解密。</p>
<p>Argon2 是 2015 年密码哈希竞赛（PHC）的获胜算法，目前公认为业界最安全、最先进的哈希方案之一。</p>
<hr/>
<h2 data-id="heading-1">🧠 核心思想</h2>

























<table><thead><tr><th>概念</th><th>说明</th></tr></thead><tbody><tr><td>哈希（Hash）</td><td>将明文密码转换为固定长度的随机字符串（不可逆）</td></tr><tr><td>加盐（Salt）</td><td>在哈希前加入随机数据，使每个结果唯一</td></tr><tr><td>验证（Verify）</td><td>用输入密码重新计算哈希并比对是否一致</td></tr><tr><td>不可逆</td><td>无法“解密”得到原始密码</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-2">🧰 Node.js 示例</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> argon2 <span class="hljs-keyword">from</span> <span class="hljs-string">"argon2"</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">example</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> password = <span class="hljs-string">"123456"</span>;

  <span class="hljs-comment">// 1️⃣ 生成哈希</span>
  <span class="hljs-keyword">const</span> hash = <span class="hljs-keyword">await</span> argon2.<span class="hljs-title function_">hash</span>(password);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"哈希结果："</span>, hash);
  <span class="hljs-comment">// 示例输出: $argon2id$v=19$m=65536,t=3,p=4$YWFh...ZGRk</span>

  <span class="hljs-comment">// 2️⃣ 验证密码</span>
  <span class="hljs-keyword">const</span> isValid = <span class="hljs-keyword">await</span> argon2.<span class="hljs-title function_">verify</span>(hash, <span class="hljs-string">"123456"</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"验证结果："</span>, isValid); <span class="hljs-comment">// true</span>

  <span class="hljs-comment">// 3️⃣ 错误示例</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">await</span> argon2.<span class="hljs-title function_">verify</span>(hash, <span class="hljs-string">"wrong"</span>)); <span class="hljs-comment">// false</span>
}

<span class="hljs-title function_">example</span>();
</code></pre>
<hr/>
<h2 data-id="heading-3">🧩 Python 等价实现（argon2-cffi）</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> argon2 <span class="hljs-keyword">import</span> PasswordHasher

ph = PasswordHasher()
<span class="hljs-built_in">hash</span> = ph.<span class="hljs-built_in">hash</span>(<span class="hljs-string">"123456"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">hash</span>)

<span class="hljs-comment"># 验证密码</span>
ph.verify(<span class="hljs-built_in">hash</span>, <span class="hljs-string">"123456"</span>)  <span class="hljs-comment"># ✅ 正确</span>
</code></pre>
<p>安装：</p>
<pre><code class="hljs language-bash" lang="bash">pip install argon2-cffi
</code></pre>
<hr/>
<h2 data-id="heading-4">🧩 自动加盐机制（Salt）</h2>
<p>Argon2 在生成哈希时会<strong>自动加入随机盐（salt）</strong>。
每次调用 <code>argon2.hash()</code>，即使输入的密码相同，生成的哈希也不同。</p>
<p>例子：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> hash1 = <span class="hljs-keyword">await</span> argon2.<span class="hljs-title function_">hash</span>(<span class="hljs-string">"123456"</span>);
<span class="hljs-keyword">const</span> hash2 = <span class="hljs-keyword">await</span> argon2.<span class="hljs-title function_">hash</span>(<span class="hljs-string">"123456"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(hash1);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(hash2);
</code></pre>
<p>输出（注意不同）：</p>
<pre><code class="hljs language-ini" lang="ini">$argon2id$<span class="hljs-attr">v</span>=<span class="hljs-number">19</span><span class="hljs-variable">$m</span>=<span class="hljs-number">65536</span>,t=<span class="hljs-number">3</span>,p=<span class="hljs-number">4</span><span class="hljs-variable">$4tYpH</span>...<span class="hljs-variable">$1mSw</span>...
$argon2id$<span class="hljs-attr">v</span>=<span class="hljs-number">19</span><span class="hljs-variable">$m</span>=<span class="hljs-number">65536</span>,t=<span class="hljs-number">3</span>,p=<span class="hljs-number">4</span><span class="hljs-variable">$kqC6z</span>...<span class="hljs-variable">$TnsA</span>...
</code></pre>
<p>✅ <strong>原因</strong>：每次都会生成一个随机盐。
盐会自动包含在哈希字符串中，无需手动保存或管理。</p>
<hr/>
<h3 data-id="heading-5">验证时的工作原理</h3>
<p><code>argon2.verify(stored_hash, input_password)</code> 会自动：</p>
<ol>
<li>从哈希字符串中解析盐和算法参数；</li>
<li>用输入密码和解析出的盐重新计算哈希；</li>
<li>比对结果是否一致。</li>
</ol>
<p>👉 所以只要保存这一整串哈希字符串，就足够验证密码，无需额外存盐。</p>
<hr/>
<h2 data-id="heading-6">🔒 哈希结果结构解析</h2>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-variable">$argon</span>2id<span class="hljs-variable">$v</span>=<span class="hljs-number">19</span><span class="hljs-variable">$m</span>=<span class="hljs-number">65536</span>,t=<span class="hljs-number">3</span>,p=<span class="hljs-number">4</span><span class="hljs-variable">$&lt;</span>salt&gt;<span class="hljs-variable">$&lt;</span>hash&gt;
</code></pre>





































<table><thead><tr><th>字段</th><th>含义</th></tr></thead><tbody><tr><td>argon2id</td><td>使用的 Argon2 类型（推荐）</td></tr><tr><td>v=19</td><td>算法版本</td></tr><tr><td>m=65536</td><td>内存成本（越大越安全）</td></tr><tr><td>t=3</td><td>迭代次数</td></tr><tr><td>p=4</td><td>并行度</td></tr><tr><td>salt</td><td>随机盐</td></tr><tr><td>hash</td><td>哈希结果</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-7">⚠️ 重要特性</h2>





























<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td>自动加盐</td><td>✅ 内置随机盐，每次不同</td></tr><tr><td>不可逆</td><td>❌ 不能解密还原原文</td></tr><tr><td>可验证</td><td>✅ 可用 <code>verify()</code> 检查密码是否匹配</td></tr><tr><td>抗暴力破解</td><td>✅ 需要大量内存和 CPU 时间</td></tr><tr><td>可配置</td><td>可调整内存成本（m）、迭代次数（t）、并行度（p）</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-8">📎 小结</h2>





























<table><thead><tr><th>操作</th><th>方法</th></tr></thead><tbody><tr><td>生成哈希</td><td><code>await argon2.hash(password)</code></td></tr><tr><td>验证密码</td><td><code>await argon2.verify(hash, inputPassword)</code></td></tr><tr><td>是否自动加盐</td><td>✅ 是</td></tr><tr><td>盐需保存吗</td><td>❌ 不需要（哈希中已包含）</td></tr><tr><td>Python 实现</td><td><code>argon2-cffi</code></td></tr></tbody></table>
<hr/>
<blockquote>
<p>🗒️ 记住：
Argon2 是密码哈希算法，不是加密算法。
它的目标是让密码<strong>无法被还原</strong>，但能被安全地验证。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Netty源码分析（终）--关于WriteAndFlush]]></title>    <link>https://juejin.cn/post/7571722835658014754</link>    <guid>https://juejin.cn/post/7571722835658014754</guid>    <pubDate>2025-11-13T02:21:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571722835658014754" data-draft-id="7571237750731128866" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Netty源码分析（终）--关于WriteAndFlush"/> <meta itemprop="keywords" content="Netty,源码阅读"/> <meta itemprop="datePublished" content="2025-11-13T02:21:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="9527出列"/> <meta itemprop="url" content="https://juejin.cn/user/882280885387789"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Netty源码分析（终）--关于WriteAndFlush
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/882280885387789/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    9527出列
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T02:21:18.000Z" title="Thu Nov 13 2025 02:21:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在 Netty 编程中，<code>writeAndFlush()</code> 是我们最常使用的方法之一。它代表着从用户层到内核缓冲区的一整条出站（Outbound）数据路径。本章将从源码层面，深入分析 <code>writeAndFlush()</code> 的执行流程与关键机制。</p>
<h3 data-id="heading-1">write方法</h3>
<p>在前面讲解编解码器时，我们提到过“编码”的概念。编码指的是<strong>将服务器处理完的业务对象转换为字节码</strong>的过程。<br/>
因为数据写出属于 <strong>Outbound 事件</strong>，所以负责编码的 <code>Handler</code> 一般位于管道尾部（<code>TailHandler</code>）之前，如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/419f6c73b9db42b885192ccc345273d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgOTUyN-WHuuWIlw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763605277&amp;x-signature=kmUH8VBF1Tn42tquyHAsEtrcdfs%3D" alt="image.png" loading="lazy"/></p>
<p>典型的编码器（Encoder）通常继承自 <code>MessageToByteEncoder</code>。<br/>
当我们调用 <code>ctx.channel().write()</code> 时，Netty 会从管道尾部（Tail）开始，依次调用所有 <strong>Outbound 类型的 Handler</strong>。</p>
<h4 data-id="heading-2">1. MessageToByteEncoder.write()</h4>
<pre><code class="hljs"/></pre>
<pre><code class="hljs language-ini" lang="ini">MessageToByteEncoder

public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) throws Exception {
    ByteBuf <span class="hljs-attr">buf</span> = null<span class="hljs-comment">;</span>
    try {
        if (acceptOutboundMessage(msg)) {
            I <span class="hljs-attr">cast</span> = (I) msg<span class="hljs-comment">;</span>
            <span class="hljs-attr">buf</span> = allocateBuffer(ctx, cast, preferDirect)<span class="hljs-comment">;</span>
            try {
                encode(ctx, cast, buf)<span class="hljs-comment">;</span>
            } finally {
                ReferenceCountUtil.release(cast)<span class="hljs-comment">;</span>
            }

            if (buf.isReadable()) {
                ctx.write(buf, promise)<span class="hljs-comment">;</span>
            } else {
                buf.release()<span class="hljs-comment">;</span>
                ctx.write(Unpooled.EMPTY_BUFFER, promise)<span class="hljs-comment">;</span>
            }
            <span class="hljs-attr">buf</span> = null<span class="hljs-comment">;</span>
        } else {
            ctx.write(msg, promise)<span class="hljs-comment">;</span>
        }
    } catch (Throwable e) {
        throw new EncoderException(e)<span class="hljs-comment">;</span>
    } finally {
        if (buf != null) {
            buf.release()<span class="hljs-comment">;</span>
        }
    }
}

</code></pre>
<p>这一过程可分为以下几个步骤：</p>
<ol>
<li><strong>判断消息类型</strong>：若当前 <code>Handler</code> 能处理该消息，则进入后续流程，否则直接传递给下一个节点。</li>
<li><strong>类型转换</strong>：将消息强制转换为编码器可处理的类型。</li>
<li><strong>分配 ByteBuf</strong>：为编码后的字节数据分配缓冲区。</li>
<li><strong>编码过程</strong>：调用 <code>encode()</code> 方法（用户自定义逻辑），将对象序列化为字节。</li>
<li><strong>释放原对象</strong>：数据已被写入 ByteBuf，原消息对象不再需要。</li>
<li><strong>传递下一个节点</strong>：若 <code>buf</code> 中有数据则继续传递，否则释放。</li>
<li><strong>最终释放资源</strong>：在 Pipeline 中处理完毕后释放 ByteBuf。</li>
</ol>
<h4 data-id="heading-3">2. HeadContext.write()</h4>
<p>所有 Outbound Handler 执行完后，ByteBuf 会进入管道首部（Head）：</p>
<pre><code class="hljs language-arduino" lang="arduino">HeadContext

@<span class="hljs-function">Override
<span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">write</span><span class="hljs-params">(ChannelHandlerContext ctx, Object msg, ChannelPromise promise)</span> throws Exception </span>{
    unsafe.<span class="hljs-built_in">write</span>(msg, promise);
}
</code></pre>
<p>这里的 <code>unsafe.write()</code> 实际由 <code>AbstractUnsafe</code> 实现：</p>
<pre><code class="hljs language-ini" lang="ini">public final void write(Object msg, ChannelPromise promise) {
    assertEventLoop()<span class="hljs-comment">;</span>

    ChannelOutboundBuffer <span class="hljs-attr">outboundBuffer</span> = this.outboundBuffer<span class="hljs-comment">;</span>
    if (<span class="hljs-attr">outboundBuffer</span> == null) {
        safeSetFailure(promise, WRITE_CLOSED_CHANNEL_EXCEPTION)<span class="hljs-comment">;</span>
        ReferenceCountUtil.release(msg)<span class="hljs-comment">;</span>
        return<span class="hljs-comment">;</span>
    }

    int size<span class="hljs-comment">;</span>
    try {
        <span class="hljs-attr">msg</span> = filterOutboundMessage(msg)<span class="hljs-comment">;</span>
        <span class="hljs-attr">size</span> = pipeline.estimatorHandle().size(msg)<span class="hljs-comment">;</span>
        if (size &lt; 0) <span class="hljs-attr">size</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
    } catch (Throwable t) {
        safeSetFailure(promise, t)<span class="hljs-comment">;</span>
        ReferenceCountUtil.release(msg)<span class="hljs-comment">;</span>
        return<span class="hljs-comment">;</span>
    }

    outboundBuffer.addMessage(msg, size, promise)<span class="hljs-comment">;</span>
}

</code></pre>
<p>核心逻辑如下：</p>
<ol>
<li><strong>确保线程安全</strong>：<code>assertEventLoop()</code> 确认当前操作在 Reactor 线程中。</li>
<li><strong>过滤消息类型</strong>：通过 <code>filterOutboundMessage()</code> 处理不同类型的消息。</li>
<li><strong>估算写入字节数</strong>：用于流控与统计。</li>
<li><strong>加入写缓冲区</strong>：调用 <code>ChannelOutboundBuffer.addMessage()</code> 存入待写链表。</li>
</ol>
<h3 data-id="heading-4">ChannelOutboundBuffer</h3>
<p><code>ChannelOutboundBuffer</code> 内部维护了一个<strong>单向链表结构</strong>，用来保存待写的 ByteBuf 节点。</p>
<pre><code class="hljs language-ini" lang="ini">public void addMessage(Object msg, int size, ChannelPromise promise) {
    Entry <span class="hljs-attr">entry</span> = Entry.newInstance(msg, size, total(msg), promise)<span class="hljs-comment">;</span>
    if (<span class="hljs-attr">tailEntry</span> == null) {
        <span class="hljs-attr">flushedEntry</span> = null<span class="hljs-comment">;</span>
        <span class="hljs-attr">tailEntry</span> = entry<span class="hljs-comment">;</span>
    } else {
        <span class="hljs-attr">tailEntry.next</span> = entry<span class="hljs-comment">;</span>
        <span class="hljs-attr">tailEntry</span> = entry<span class="hljs-comment">;</span>
    }
    if (<span class="hljs-attr">unflushedEntry</span> == null) {
        <span class="hljs-attr">unflushedEntry</span> = entry<span class="hljs-comment">;</span>
    }
    incrementPendingOutboundBytes(size, false)<span class="hljs-comment">;</span>
}
</code></pre>
<p>该链表包含三个重要指针：</p>





















<table><thead><tr><th>指针</th><th>含义</th></tr></thead><tbody><tr><td><strong>flushedEntry</strong></td><td>已刷新（写入操作系统缓冲区）的第一个节点</td></tr><tr><td><strong>unflushedEntry</strong></td><td>尚未刷新到内核缓冲区的第一个节点</td></tr><tr><td><strong>tailEntry</strong></td><td>链表尾节点</td></tr></tbody></table>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0460f83a21df44eebba40d1ec6c731e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgOTUyN-WHuuWIlw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763605277&amp;x-signature=Vi3LqHHHKqmlOrdcXiOEWCMU1qQ%3D" alt="image.png" loading="lazy"/>
每次 <code>addMessage()</code> 调用，都会在 <code>unflushedEntry</code> 和 <code>tailEntry</code> 之间插入新的待写节点。</p>
<h3 data-id="heading-5">flush方法</h3>
<p><code>flush()</code>方法其实和<code>write()</code>的执行流程比较相似。<br/>
<code>ctx.flush()</code>和<code>ctx.channel().flush()</code>最终都会调用到Head节点的flush方法</p>
<pre><code class="hljs language-java" lang="java">HeadContext  
  
<span class="hljs-meta">@Override</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">flush</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception ｛  
    unsafe.flush()；  
｝
</code></pre>
<p><code>unsafe.flush()</code>方法由AbstractUnsafe实现</p>
<pre><code class="hljs language-ini" lang="ini">HeadContext

@Override
public final void flush() {
    assertEventLoop()<span class="hljs-comment">;</span>
    ChannelOutboundBuffer <span class="hljs-attr">outboundBuffer</span> = this.outboundBuffer<span class="hljs-comment">;</span>
    if (<span class="hljs-attr">outboundBuffer</span> == null) {
        return<span class="hljs-comment">;</span>
    }
    outboundBuffer.addFlush()<span class="hljs-comment">;</span>
    flush0()<span class="hljs-comment">;</span>
}
</code></pre>
<p>其中<code>outboundBuffer.addFlush()</code>负责移动<strong>outboundBuffer</strong>中的三个指针，指针最终会变成下图所示</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0129eede58344ecc926f2e12d7ee6fb2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgOTUyN-WHuuWIlw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763605277&amp;x-signature=XKjDNo3SyuyutBwm3uSFXymN6kY%3D" alt="image.png" loading="lazy"/></p>
<p><code>flush0()</code>方法最终会调用<code>AbstractNioByteChannel</code>的<code>doWrite()</code>方法，
<code>doWrite()</code>方法取出<strong>outboundBuffer</strong>中单链表的节点，利用<strong>自旋锁</strong>将节点写到协议栈的缓冲区。<br/>
之后移除当前接节点并将<code>flushedEntry</code>指向一下个节点。如图</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec00be2cbaec46c3849aa053954ef6c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgOTUyN-WHuuWIlw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763605277&amp;x-signature=OC6myQT6%2B9N6a%2Bd5r7VIrFrM1cY%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-6">writeAndFlush 方法</h2>
<p><code>writeAndFlush()</code> 本质上等价于：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">write</span>(msg);
<span class="hljs-built_in">flush</span>();
</code></pre>
<p>也就是说：<br/>
<strong>先将消息加入出站缓冲区，再立即触发刷入内核缓冲区的动作。</strong></p>
<h2 data-id="heading-7">小结</h2>
<p>至此，我们完整分析了 <code>writeAndFlush()</code> 的内部执行路径：</p>
<ol>
<li><strong>write 阶段</strong>：对象 → ByteBuf → OutboundPipeline → ChannelOutboundBuffer</li>
<li><strong>flush 阶段</strong>：出站缓冲区 → 操作系统内核缓冲区</li>
</ol>
<p>本系列从 Netty 的启动流程、Reactor 线程模型、客户端接入、数据解码，到本章的写出流程，系统地展示了 Netty 在网络通信中的核心机制。</p>
<p>Netty 作为一款高性能网络通信框架，内部蕴含了大量优秀设计：</p>
<ul>
<li>对 <code>SelectionKey</code> 的结构优化（由集合改为数组）；</li>
<li>Selector 重建机制，规避 JDK 空轮询 Bug；</li>
<li>精细化内存管理与线程模型优化。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀 从“Hulk”扩展开发实战，聊聊我找到的“Vibe Coding”最佳姿势]]></title>    <link>https://juejin.cn/post/7571657746346917942</link>    <guid>https://juejin.cn/post/7571657746346917942</guid>    <pubDate>2025-11-12T16:46:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571657746346917942" data-draft-id="7571657746346901558" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀 从“Hulk”扩展开发实战，聊聊我找到的“Vibe Coding”最佳姿势"/> <meta itemprop="keywords" content="人工智能,设计"/> <meta itemprop="datePublished" content="2025-11-12T16:46:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="南山安"/> <meta itemprop="url" content="https://juejin.cn/user/1795929588117962"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀 从“Hulk”扩展开发实战，聊聊我找到的“Vibe Coding”最佳姿势
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1795929588117962/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    南山安
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T16:46:19.000Z" title="Wed Nov 12 2025 16:46:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>作为一名前端学习者，我曾沉迷于在每一个像素和每一行代码上精益求精。</p>
<p>但最近，一种名为  <strong>“Vibe Coding”</strong> ​ 的协作模式彻底改变了我的工作流。它并非鼓吹“零代码”，而是强调一种新的分工：<strong>开发者作为“导演”，而AI作为“首席工程师”</strong> 。</p>
<p>今天，我将通过一个完整的实战项目——开发一款名为  <strong>“Hulk”的Chrome扩展</strong>（功能很简单：一键将网页背景变绿），来展示这种高效、愉悦的协作模式。</p>
<h3 data-id="heading-1">一、理念先行：什么是 Vibe Coding？</h3>
<p>一句话解释<strong>Vibe Coding</strong>：VibeCoding 是一种强调开发者在良好氛围（vibe）中高效、愉悦地编写代码的编程理念或工作状态，通常融合了合适的音乐、环境、工具和心流体验。</p>
<p>在开始敲代码之前，我们先统一一下“思想”。根据我的理解，<strong>Vibe Coding 的核心</strong>是：</p>
<ul>
<li>
<p><strong>目标导向</strong>：关注“做什么”和“为什么”，而不是一开始就陷入“怎么做”。</p>
</li>
<li>
<p><strong>文档即上下文</strong>：清晰、结构化的文档是与AI（如 Trae, Cursor, GPT等）高效协作的基石。AI不擅长猜你的心思，但它极其擅长在清晰的上下文中执行任务。</p>
</li>
<li>
<p><strong>人机协同</strong>：开发者负责架构设计、边界划定、逻辑审查和“ vibe ”（感觉）把控；AI负责快速生成模板代码、实现基础功能。</p>
</li>
<li>
<p><strong>低代码是结果，而不是手段</strong>：我们的目标是高质量、快速地交付产品，自动化代码生成是实现这一目标的强大工具。</p>
</li>
</ul>
<p>简单来说，我们不再是<strong>从0到1</strong>的码砖工，而是<strong>从0.5到1.5</strong>的架构师和质检员。</p>
<h3 data-id="heading-2">二、项目实战：Hulk 扩展的 Vibe 开发流</h3>
<p>我们的产品需求非常明确：</p>
<ol>
<li>一个名为 Hulk 的扩展，使用指定图标。</li>
<li>点击扩展图标，弹出窗口显示提示信息和“改变颜色”按钮。</li>
<li>点击按钮，当前网页背景变为绿色。</li>
</ol>
<h4 data-id="heading-3">Step 1: 奠定基石 - 项目清单与架构</h4>
<p>传统的做法是直接打开编辑器创建 <code>manifest.json</code>。但在 Vibe Coding 模式下，我首先创建了一份“需求文档”（instruct.txt），这将成为我给AI的“工作任务书”。</p>
<pre><code class="hljs language-instruct.txt" lang="instruct.txt">你是一个经验丰富的Chrome 扩展程序开发者，请帮我开发一个名为Hulk的扩展程序。
UX 设计图参考ux.jpg

具体交互步骤如下：
Step1:点击程序图标打开弹出窗口，在窗口中默认提示：“改变背景颜色”、“点击下方按钮将当前页面背景色改为绿色”，和生成一个“改变颜色”按钮

Step2:点击按钮，网页背景改变为绿色

注意以下：
请使用icons文件夹的图标作为图标
</code></pre>
<p><code>ux.jpg</code>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0234413ff55c4b2e9a45545b4fdb781e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2X5bGx5a6J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763570779&amp;x-signature=LVkQW%2FDWeuNsi6TwIO6d07Bt7aM%3D" alt="image.png" loading="lazy"/></p>
<p><code>icons</code>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a46769d73d524177a6267973ed686289~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2X5bGx5a6J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763570779&amp;x-signature=MiFjvcxo5FuQMhLlG7CCrzgFvss%3D" alt="image.png" loading="lazy"/></p>
<p>提供好对应文件夹中的参靠文件后，就可以让AI帮我们生成了</p>
<p>在右侧对话框中输入：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bf0fd9338b740f9a87ae20c5f160336~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2X5bGx5a6J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763570779&amp;x-signature=rM8nl1QOPqssnktI4R7KTMxhTzg%3D" alt="image.png" loading="lazy"/></p>
<p>很快，AI给了我一份完美的 <code>manifest.json</code>。它正确地声明了 <code>activeTab</code>和 <code>scripting</code>权限，这正是MV3中注入脚本所需的关键配置。看，好的文档（需求）直接产出了正确的核心配置。</p>
<p>我们可以在Chrome插件管理中手动添加一下，查看效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d8619f8343d4183965fbed2cc439bc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2X5bGx5a6J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763570779&amp;x-signature=CDPEOEkiB7t3adl5cuP%2BB5%2BuKRc%3D" alt="image.png" loading="lazy"/></p>
<p><strong>插件设计效果</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35f077385f8f457fb2e7c719d8ba092f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2X5bGx5a6J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763570779&amp;x-signature=M2yOxJp7rP08gaHWGaHlYdUlSOI%3D" alt="image.png" loading="lazy"/></p>
<p><strong>使用效果</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c4188ce3716469bbb0b6b3de54c84a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2X5bGx5a6J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763570779&amp;x-signature=fIaPW5laG%2BH18A0uzBrIExk6%2FaQ%3D" alt="image.png" loading="lazy"/></p>
<p><strong>至此，一个功能完备的Chrome扩展已经诞生。</strong> ​ 整个过程，我更像是一个产品经理和架构师，通过自然语言向AI下达精确的指令，而AI则完美地扮演了执行者的角色。</p>
<h3 data-id="heading-4">三、Vibe Coding 的心法：耐心与文档</h3>
<p>通过Hulk扩展的开发，我深刻体会到Vibe Coding的成功关键：</p>
<ol>
<li>
<p><strong>清晰的上下文（文档）是生命线</strong>：需求文档、技术选型（MV3）、设计稿（ux.jpg）共同构成了一个完整的上下文。这让AI能生成高度准确的代码，减少返工。</p>
</li>
<li>
<p><strong>做AI不擅长的事</strong>：AI可能会在复杂的业务逻辑或非常规交互上犯错。我的工作是<strong>划定边界、设计架构、并进行最终的质量把关</strong>。例如，我会审查AI生成的 <code>manifest.json</code>中的权限是否合理，<code>popup.js</code>中的API调用是否符合MV3规范。</p>
</li>
<li>
<p><strong>耐心迭代</strong>：Vibe Coding 不是一蹴而就的魔法。有时需要根据生成结果，反过来调整你的提示词和文档，进行多次迭代。这是一种对话，而不是单次命令。</p>
</li>
</ol>
<h3 data-id="heading-5">四、效果展示与源码</h3>
<p>这就是我们的Hulk扩展：（<em>此处应替换为ux.jpg的实际效果图</em>）<strong>最终项目结构：</strong></p>
<pre><code class="hljs language-scss" lang="scss">hulk-extension/
├── icons/
│   ├── icon16<span class="hljs-selector-class">.png</span>
│   ├── icon48<span class="hljs-selector-class">.png</span>
│   └── icon128<span class="hljs-selector-class">.png</span>
├── manifest<span class="hljs-selector-class">.json</span>  (来自AI生成)
├── popup<span class="hljs-selector-class">.html</span>     (来自AI生成)
└── popup<span class="hljs-selector-class">.js</span>       (来自AI生成)
└── ux<span class="hljs-selector-class">.jpg</span>
└── instruction<span class="hljs-selector-class">.txt</span>

</code></pre>
<h3 data-id="heading-6">五、结语：拥抱开发范式的转变</h3>
<p>开发Hulk这个简单的扩展，如果手动编写，可能也需要15-20分钟。但在Vibe Coding模式下，我仅仅通过<strong>编写需求和审查代码</strong>，在5分钟内就完成了功能。</p>
<p>这节省的不仅仅是时间，更是将我的心智负担从“语法细节”和“API记忆”中解放出来，投入到更重要的<strong>产品设计和架构决策</strong>上。</p>
<p>未来，编码能力可能不再局限于“手写代码的行数”，而在于<strong>清晰定义问题的能力、架构设计的能力，以及与AI智能体高效协作的能力</strong>。<strong>Vibe Coding，就是这种未来工作模式的现在进行时。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flink 的 RocksDB 状态后端在 vivo 的实践]]></title>    <link>https://juejin.cn/post/7571731181198032932</link>    <guid>https://juejin.cn/post/7571731181198032932</guid>    <pubDate>2025-11-13T03:02:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571731181198032932" data-draft-id="7571726099689521171" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flink 的 RocksDB 状态后端在 vivo 的实践"/> <meta itemprop="keywords" content="大数据"/> <meta itemprop="datePublished" content="2025-11-13T03:02:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="vivo互联网技术"/> <meta itemprop="url" content="https://juejin.cn/user/993614243303053"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flink 的 RocksDB 状态后端在 vivo 的实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614243303053/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    vivo互联网技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T03:02:02.000Z" title="Thu Nov 13 2025 03:02:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<blockquote>
<p>作者： 互联网大数据团队- Chen Rui</p>
<p>本文简要介绍了特征拼接在实时推荐中的重要作用，并讲述了vivo实时推荐系统中特征拼接模块的架构演进过程以及采用现有的“基于RocksDB的大状态解决方案”的原因，重点叙述了该方案所遇到的一系列问题，包括TM Lost、RocksDB性能调优门槛高、TM初始化慢、状态远程存储HDFS RPC飙高等，并给出了这些问题的现象以及解决方案。</p>
</blockquote>
<p>1分钟看图掌握核心观点👇</p>
<p><img src="https://static001.geekbang.org/infoq/38/382f0104f6e8e8a42bda19405b12bc92.gif" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-0">一、背景</h2>
<p>在推荐系统中，样本拼接是衔接在线服务与算法模型的重要一个环节，主要职责是样本拼接和业务相关的ETL处理等，模块位置如下图红框所示。</p>
<p><img src="https://static001.geekbang.org/infoq/5d/5d6e6d948770d82b730057114ee3f098.jpeg" alt="图片" loading="lazy"/></p>
<p>推荐系统通过学习埋点数据来达到个性化精准推荐的目的，因此需要知道服务端推荐下发的内容，是否有一系列的行为(曝光，点击，播放，点赞，收藏，加购等等)，把被推荐内容的埋点数据与当下的特征拼接起来的过程，一般称为样本拼接，一个简化的流程如下：</p>
<p><img src="https://static001.geekbang.org/infoq/f8/f8fa426d9a1ee10b6bb46dab2dcf15e5.jpeg" alt="图片" loading="lazy"/></p>
<p>推荐的过程可以检验概括为以下几点：</p>
<blockquote>
<ul>
<li>
<p>后台服务rank 推荐内容给app客户端，同时把内容对应的特征快照保存起来；</p>
</li>
<li>
<p>app接收到内容后，埋点日志被上报到消息中间件；</p>
</li>
<li>
<p>样本拼接负责将特征与埋点日志拼接起来，定义正负样本，格式转换；</p>
</li>
<li>
<p>模型接收样本训练，将使用最新的模型做推荐。</p>
</li>
</ul>
</blockquote>
<p>为了保证较高的拼接率和稳定性，我们的拼接架构也经过了长时间的迭代，这篇文章我将给大家介绍vivo特征拼接架构的发展历程、当前方案、当前方案遇到的问题和解决方案，以及未来的规划和展望，希望能帮助到业内的同学。</p>
<h2 data-id="heading-1">二、拼接方案选型</h2>
<h3 data-id="heading-2">2.1 小时粒度拼接</h3>
<p>小时拼接是将埋点日志和特征快照都保存到Hive并以小时分区，每小时调度一个Spark任务来处理两个表相应分区的数据做拼接，由于是小时拼接，实时性较低，Spark作业本身也依赖于上游Hive表小时分区生成，每个小时末尾的请求埋点有可能是落在当前小时，也有可能落在下个小时。举个例子：19点50分下发了一个视频，客户端在19:59分点击了，但是视频播放却是在20点03分完成的，这个时候就会存在拼接不上的问题。</p>
<p><img src="https://static001.geekbang.org/infoq/28/280de17f347240ab7ba7ec4c7d4ce15f.jpeg" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-3">2.2 基于 Redis 的流式拼接</h3>
<p>为了提升拼接率，且达到实时拼接，节点故障容灾，完备监控等特性，Flink是一个很好的替代方案，也是最近几年比较主流的实现。最初在实时推荐场景中，Kafka中的特征快照通过Flink任务写入到Redis，另一个Flink任务消费曝光埋点数据和点击埋点数据并读取存在Redis中的特征快照数据做拼接，拼接后的数据作为拼接特征被写入到下游的Kafka中，提供给后续的算法做模型的训练，架构图如下：</p>
<p><img src="https://static001.geekbang.org/infoq/4a/4a8bee8298f47869bc7732caf8960550.jpeg" alt="图片" loading="lazy"/></p>
<p>经过一段时间实践，以上的方案出现了<strong>两个痛点：</strong></p>
<blockquote>
<ul>
<li>
<p>Redis中存储了几十T的数据，Redis的成本高；</p>
</li>
<li>
<p>业务数据流量会波动，经常需要DBA对Redis集群进行扩容，涉及大量数据的迁移，运维成本高。</p>
</li>
</ul>
</blockquote>
<h3 data-id="heading-4">2.3 基于 RocksDB 大状态流式拼接</h3>
<p>为了解决基于Redis的作为中间数据的存储存在的问题，我们采用Flink状态来存储特征快照，整个架构中不再需要外部的Redis，由于我们需要存储的数据量达几十T，这里我们选用适合大数据量存储的RocksDB类型的状态后端，调整后架构更加简洁，如下图所示：</p>
<p><img src="https://static001.geekbang.org/infoq/01/01317bf13236b42f1a7d450fe1fdca74.jpeg" alt="图片" loading="lazy"/></p>
<p>流程如下：</p>
<blockquote>
<ul>
<li>
<p>首先将曝光流点点击流以及特征在Flink 任务中做union并做keyby；</p>
</li>
<li>
<p>在processElement方法中如果接收到曝光流就将数据保存到state中，如果接收到曝光流就将数据保存到state中，如果接收到特征就去state中查询相应的曝光和点击数据；</p>
</li>
<li>
<p>如果能找到就发送到下游并将状态数据清理掉，没找到就将特征保存到state中，并注册一个定时器；</p>
</li>
<li>
<p>定时器触发时去state中查询相应的曝光和点击数据，如果找到就发到下游，并将状态数据清理掉。</p>
</li>
</ul>
</blockquote>
<p>由于RocksDB可以同时利用内存和磁盘来存储数据，所以对于内存的使用量大幅下降，由于RocksDB是嵌入式的数据库，每个TM上的RocksDB数据库只存储shuffe到该TM上的数据，无需再关注扩缩容的问题。当然随着数据上涨，Flink流式拼接在实际的生产过程中也遇到了一系列的问题，为了保证业务的可用性，我们花了较长的时间对这些问题进行攻克，目前任务稳定性达到99.99% ，拼接率长期稳定在99%以上，对拼接效果提升较大。下面我将列举我们遇到的问题和解决方案，希望能够帮助到业内的其他团队。</p>
<h2 data-id="heading-5">三、问题及解决方案</h2>
<h3 data-id="heading-6">3.1 TM Lost问题</h3>
<h4 data-id="heading-7">3.1.1 现象</h4>
<p>在方案实施之初，我们发现这些特征拼接的任务频繁出现TM was Lost异常导致任务重启，我们看了日志，发现都是TM内存超出了YARN的内存限制被kill。</p>
<h4 data-id="heading-8">3.1.2 问题分析</h4>
<p>那么我们的疑问就来了，为啥这部分任务的内存很容易超出，超出的那部分内存又是谁在用呢？下面这张图是来自Flink的官网，因为我们在平台使用Flink的时，我们只设置了总的内存，并没有关注其他各个局部的内存，那么这些部位的内存是如何分配的？为了搞清楚这个问题，有必要梳理一下每个模块内存计算的逻辑。</p>
<p><img src="https://static001.geekbang.org/infoq/dd/ddc1ee12f23304a440712c0aba4b0dba.jpeg" alt="图片" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fnightlies.apache.org%2Fflink%2Fflink-docs-master%2Fdocs%2Fdeployment%2Fmemory%2Fmem_setup_tm" target="_blank" title="https://nightlies.apache.org/flink/flink-docs-master/docs/deployment/memory/mem_setup_tm" ref="nofollow noopener noreferrer">图片引用自Flink</a></p>
<p><strong>Flink内存分配逻辑</strong></p>
<p>一般在YARN上提交的任务是含有taskmanager.memory.process.size 参数的配置的，所以Flink在分配内存时，会以调用deriveProcessSpecWithTotalProcessMemory 方法分配。</p>
<p>通过配置参数获得meatspace 的大小，通过jobmanager.memory.jvm-overhead.fraction 的比例计算overhead的内存，totalFlinkMemory通过总的进程的内存减去meatspace + overhead的内存得到。</p>
<p>通过配置中的参数获取 frameworkHeapMemory-</p>
<p>Size、frameworkOffHeapMemorySize 、task-</p>
<p>OffHeapMemorySize 的大小。</p>
<p>通过managedmemory的配置获取托管内存的值， 通过networkbuffer的配置获取networkbuffer的值 。totalFlinkMemory 减去所有需要排除的内存，剩下的内存分配给堆。内存分配逻辑，以及每块内存的设置方法如下图：</p>
<p><img src="https://static001.geekbang.org/infoq/98/9850896065a8e3bb60a78aa433f45e1d.jpeg" alt="图片" loading="lazy"/></p>
<p>到此TM的各个内存模块的内存已经划分完成。有上面的分析我们可以得出以下的结论：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">totalProcessMemorySize</span> = totalFlinkMemorySize + JvmMetaspaceSize + JvmOverheadSize
<span class="hljs-attr">totalFlinkMemorySize</span>  = framework<span class="hljs-literal">Off</span>HeapMemorySize + task<span class="hljs-literal">Off</span>HeapMemorySize + managedMemorySize + networkMemorySize + frameworkHeapMemorySize + taskHeapMemorySize
</code></pre>
<p><img alt="" src="" loading="lazy"/><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<p>这里重点将一下JVMOverhead，JVMOverhead并没有具体的作用，是一个预留值，它是一个缓冲区，可以避免在Flink运行在容器中是因为短时时间的内存超出了容器的限制而被kill。</p>
<p>frameworkOffHeapMemorySize和taskOff-</p>
<p>HeapMemorySize 也是预留值，offheap在概念上的主要是指native内存。frameworkHeap-</p>
<p>MemorySize 也是预留值。由此可以看出虽然Flink官方将TM的内存划分的较细致，但是像JvmOverheadSize frameworkOffHeap-</p>
<p>MemorySize，taskOffHeapMemorySize，</p>
<p>frameworkHeapMemorySize 都只是逻辑上的预留，并没有从操作系统层面实现隔离。</p>
<p><strong>RocksDB内存分配逻辑</strong></p>
<p>因为堆内存不足时一般会报out of memory的异常，所以到这一步我们推测应该是堆外内存溢出了，而堆外内存最大的一块就是RocksDB使用的，而从Flink的官网的介绍可以知道托管内存就是给RocksDB使用的，下面我们再看一下托管内存是如何分配给RocksDB的。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">cacheMemory</span> = （<span class="hljs-number">1</span>-（<span class="hljs-number">1</span>/<span class="hljs-number">3</span>）*（writeBufferRatio））* managedMemory
<span class="hljs-attr">bufferMemory</span> = （<span class="hljs-number">2</span>/<span class="hljs-number">3</span>）*（writeBufferRatio）* managedMemory
读写缓存总内存 =  bufferMemory + <span class="hljs-attr">cacheMemory</span> = （<span class="hljs-number">1</span> +（<span class="hljs-number">1</span>/<span class="hljs-number">3</span>）*（writeBufferRatio））* managedMemory
</code></pre>
<p><img alt="" src="" loading="lazy"/><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<p>由上面的代码可以看出，managed memory 是通过一定的比例给RocksDB的各个部分来分配内存的，writeBufferRatio会影响读缓存和写缓存的大小，理论上读写缓存总内存有可能会超过managedMemory的大小。通过上面的公式可以看出读写缓存总内存最多超出managedMemory的1/3，这里很容易想到，那么我们在排查overhead的时候配置大于managedMemory的1/3不就能你面内存溢出了，但是在实践中，我们这样配置并并没有完全的解决物理内存溢出的问题，下面关于RocksDB内存的资料，终于找到了是还有哪部分内存容易溢出了，是因为部分区域的内存难以限制导致的。</p>
<p>RocksDB 的内存占用有 4 个部分:</p>
<blockquote>
<ul>
<li>
<p>Block Cache: OS PageCache 之上的一层缓存，缓存未压缩的数据 Block；</p>
</li>
<li>
<p>Indexes and filter blocks: 索引及布隆过滤器，用于优化读性能；</p>
</li>
<li>
<p>MemTable: 类似写缓存；</p>
</li>
<li>
<p>Blocks pinned by Iterator: 触发 RocksDB 遍历操作（比如遍历 RocksDBMapState 的所有 key）时，Iterator 在其生命周期内会阻止其引用到的 Block 和 MemTable 被释放，导致额外的内存占用。</p>
</li>
</ul>
</blockquote>
<p>前三个区域的内存都是可配置的，但 Iterator 锁定的资源则要取决于应用业务使用模式，且没有提供一个硬限制，因此 Flink 在计算 RocksDB StateBackend 内存时没有将这部分纳入考虑，其次是 RocksDB Block Cache 的一个 bug，它会导致 Cache 大小无法严格控制，有可能短时间内超出设置的内存容量，相当于软限制，原来是迭代器的内存限制的不好，导致的内存溢出。</p>
<h4 data-id="heading-9">3.1.3 解决方案</h4>
<p>我们在使用Flink 的RocksDB状态后端时，是通过managed memory来控制RocksDB各个部分的内存的，所以managed memory内存越小分配给各个部分的内存也就越小，迭代器内存越不容易溢出。到此我们对Flink的RocksDB状态后端的内存有了一定的认知：当性能可以满足的情况下，Flink的Manaed memory应该越小越好。但是上满形成的经验很难高效的在业务上落地，原因是“Flink的Manaed memory应该越小越好”很难去确定。</p>
<p>于是我们联想到了之前的JVMoverhead，在我们的实际实践中过程中，我们是通过调大JVMoverhead，和jemalloc内存分配器来解决内存溢出问题的。在Flink1.12之后Flink on k8s的内存分配器已经默认改成了jemalloc，可以避免内存的分配过程中出现64M问题。</p>
<p>但是要注意：由于我们的Java版本是JAVA8小版本是192，在最新版本的jemalloc5.3上出现了死锁的问题，后来我们采用jemalloc4.5 就没有问题了。据了解业界有些公司使用的JAVA8小版本是256采用jemalloc5.3没有遇到死锁问题。</p>
<h3 data-id="heading-10">3.2 RocksDB 的性能监控问题</h3>
<h4 data-id="heading-11">3.2.1 现象</h4>
<p>Flink RocksDB大状态的任务经常出现延迟，但是我们很难知道性能的瓶颈在哪块，从而优化响应的环节。</p>
<h4 data-id="heading-12">3.2.2 解决方案</h4>
<p>其实Flink提供了一系列对于RocksDB的性能的监控指标，我们只需要加上参数开启即可，这里我只结局我觉得最有参考意义的指标开启的参数：</p>
<p><img src="https://static001.geekbang.org/infoq/e0/e01cb49221cf60f362090e0e2801cd44.jpeg" alt="图片" loading="lazy"/></p>
<p>下面是相关指标的监控页面：</p>
<p><img src="https://static001.geekbang.org/infoq/d1/d1404b9aa08dcae8ea3aaff068872d6e.jpeg" alt="图片" loading="lazy"/></p>
<p><img src="https://static001.geekbang.org/infoq/39/39ca400998d4d6222ac7b82e0695d72e.jpeg" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-13">3.3 任务出现延迟</h3>
<h4 data-id="heading-14">3.3.1 现象</h4>
<p>Flink RocksDB大状态的任务经常出现延迟，调优参数高达近百个，如何系统性的调优，难度较大。</p>
<h4 data-id="heading-15">3.3.2 解决方案</h4>
<p>要想对RocksDB的性能做优化，我们有必要先了解一下RocksDB的读写流程。</p>
<p><strong>RocksDB的读流程</strong></p>
<p><img src="https://static001.geekbang.org/infoq/3f/3f67f6e900780ee1fc52bccd62e2e359.jpeg" alt="图片" loading="lazy"/></p>
<ul>
<li>
<p>获取当前时刻的SuperVersion，SuperVersion是RocksDB内针对于所有SST文件列表以及内存中的MemTable和Immutable MemTable的一个版本；</p>
</li>
<li>
<p>获取当前的序号来决定当前读操作依赖的数据快照；</p>
</li>
<li>
<p>尝试从第一步SuperVersion中引用的MemTable以及Immutable MemTable中获取对应的值。首先会经过布隆过滤器，假如不存在则一定不存在，反之假如返回存在则不一定存在；</p>
</li>
<li>
<p>尝试从Block Cache中读取；</p>
</li>
<li>
<p>尝试从SST文件中获取。</p>
</li>
</ul>
<p><strong>RocksDB的写流程</strong></p>
<p><img src="https://static001.geekbang.org/infoq/29/29664abe3274655acc4ae42695f9f142.jpeg" alt="图片" loading="lazy"/></p>
<ul>
<li>
<p>将写入操作顺序写入WAL日志中，接下来把数据写到 MemTable中（采用SkipList结构实现）</p>
<p>MemTable达到一定大小后，将这个 MemTable 切换为不可更改的 immutable MemTable，并新开一个 MemTable 接收新的写入请求；</p>
</li>
<li>
<p>这个 immutable MemTable进行持久化到磁盘，成为L0 层的 SSTable 文件；</p>
</li>
<li>
<p>每一层的所有文件总大小是有限制的，每下一层大十倍。一旦某一层的总大小超过阈值了，就选择一个文件和下一层的文件合并。</p>
<p><strong>注意：</strong> 所有下一层被影响到的文件都会参与 Compaction。合并之后，保证 L1 到 L6 层的每一层的数据都是在 key 上全局有序的，而 L0 层是可以有重叠的，写流程的约束；</p>
</li>
<li>
<p>日志文件用于崩溃恢复；</p>
</li>
<li>
<p>每个MemTable及SST文件中的Key都是有序的（字符顺序的升序）；</p>
</li>
<li>
<p>日志文件中的Key是无序的；</p>
</li>
<li>
<p>删除操作是标记删除，是插入操作的一种，真正的删除要在Compaction的时候实现；</p>
</li>
<li>
<p>无更新实现，记录更新通过插入一条新记录实现；</p>
</li>
</ul>
<p>当任务出现延迟时，由于我们已经有了RocksDB性能指标的监控也了解RocksDB的原理，我们在做性能优化时就可以对症下药了。</p>
<p><strong>读性能优化</strong></p>
<p>当任务出现延迟且块缓存命中率下降时，说明是读的性能下降导致延迟，我们可以通过提升缓存命中率的方式来提升读性能，RocksDB任务缓存命中率的优化<strong>思路如下：</strong></p>
<ul>
<li>
<p>托管内存小于TM内存20%，可以调大托管内存：state.backend.rocksdb.memory.managed 到 20%；</p>
</li>
<li>
<p>Flink内部对RocksDB的优化已经沉淀了多组参数，建议使用配置：</p>
</li>
</ul>
<p>state.backend.rocksdb.predefined-options =</p>
<p>SPINNING_DISK_OPTIMIZED_HIGH_MEM；</p>
<ul>
<li>Flink中使用state.backend.rocksdb.memory</li>
</ul>
<p>.write-buffer-ratio参数来管理写缓存，调小该参数，能够提升读缓存，该参数默认0.5；</p>
<ul>
<li>RocksDB 会有一写索引和过滤器放在内存中，用这个参数开启：state.backend.rocksdb</li>
</ul>
<p>.memory.partitioned-index-filters 默认 false，并且可以调节索引和过滤器占用的内存比例，参数是：state.backend.rocksdb.memory</p>
<p>.high-prio-pool-ratio默认为0.1。</p>
<p><strong>写性能优化</strong></p>
<p>当任务延迟，如果出现等待flush的内存表的大小增加，或者等待合并的个数增加，因为等带flush个数达到一定的个数时写将会被阻塞，可以先关注一下磁盘io是否打满，如果已经处于高位，建议提升任务的并发。如果此磁盘io处于低位，我们可以调整flush和compation的线程数来使写的数据不再积压。提升写写性能。Flink会将flush和compation的线程数通过一个参数统一管理，参数是：state.backend</p>
<p>.rocksdb.thread.num，默认值是1。</p>
<h3 data-id="heading-16">3.4 任务启动慢的问题</h3>
<h4 data-id="heading-17">3.4.1 现象</h4>
<p>由于Flink任务在从状态启动时需要将存储在远程HDFS的状态文件读到本地，当TM较集中时单台机器的磁盘io很容易被打满，导致某些sub task 长时间处于INITIALIZING的状态。</p>
<h4 data-id="heading-18">3.4.2 解决方案</h4>
<p><strong>YARN参数的优化</strong></p>
<p>YARN默认的yarn.scheduler.fair.assignmultiple参数为flase，即一次只分配一个container，但是CDH将这个参数设置成了true，yarn.scheduler.fair.max.assigr默认为-1，表示不限制，所以导致一次调度到单个节点上的container较多。我们的解决方案是将YARN配置中的yarn.scheduler.fair.assignmultiple参数设为false，一次只调度一个container，解决了TM分配较集中的问题。</p>
<p><strong>Flink调度策略的优化</strong></p>
<p>由于只是限制了每次分配TM的个数，还不能完全避免分配集中的问题，于是我们对Flink引擎内部做了优化，可以硬限制在某台机器上调度TM的个数，具体做法是，是当YARN返回给Flink ResourceManager container信息时，判断container是否符合要求，如果不符合可以部分拒收，再次申请资源，该功能由参数开启。</p>
<p><img src="https://static001.geekbang.org/infoq/16/16a7fa6dc4c5ac2babd329e3c41c33c9.jpeg" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-19">3.5 磁盘打满的问题</h3>
<h4 data-id="heading-20">3.5.1 现象</h4>
<p>由于我们实时集群的磁盘较小，大状态任务的状态达几十上百T，频繁出现磁盘使用率达到90%的告警。</p>
<h4 data-id="heading-21">3.5.2 解决方案</h4>
<p>我们将大状态的任务的Checkpoint数据存储到磁盘资源较宽裕的离线的集群，非大状态的任务的Checkpoint数据存储在实时集群。</p>
<h3 data-id="heading-22">3.6 HDFS RPC 飙高问题</h3>
<h4 data-id="heading-23">3.6.1 现象</h4>
<p>在业务新上一批任务后，我们发现离线集群HDFS的RPC有明显的增加。</p>
<p><img src="https://static001.geekbang.org/infoq/4c/4ca61c00d9c2bc4484c5b10302c79c41.jpeg" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-24">3.6.2 解决方案</h4>
<p>由于我们默认只会保存最近的3个Checkpoint，所以对于增量Checkpoint而言，肯定会有文件的修改和删除，据了解修改和删除是对HDFS性能影响较大的操作。我们对比这一批任务任务在HDFS上的Checkpoint文件和之前的任务对比发现，文件数量大很多，但是每个文件小很多，于是我们调整了参数：state.backend.rocksdb.compaction.level.target-file-size-base参数为256MB，这个参数默认是64MB，参数的作用控制压缩后的文件的大小。配置改参数后RPC回归正常。</p>
<p>效果如图：</p>
<p><img src="https://static001.geekbang.org/infoq/b9/b9ebfdd95264553025698df649ce31ad.jpeg" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-25">四、总结</h2>
<h3 data-id="heading-26">4.1 遗留问题</h3>
<h4 data-id="heading-27">4.1.1.RocksDB的调优的门槛较高</h4>
<p>虽然我们在任务上使用了积累通用经验进行优化，但是有些数据量较大的任务在流量高峰期依然容易出现延迟，RocksDB的参数有几十个，要想把性能调优做到比较极致需要深入了解其原理，还有对业务特点有深入的了解，对于应用开发而言，门槛较高。</p>
<h4 data-id="heading-28">4.1.2.任务恢复慢</h4>
<p>由于有些任务的状态高达几十T，在重启任务或者异常重启时要从Checkpoint恢复，需要从远程的HDFS下载状态到本地磁盘，单机的io很容易被打满，虽然我们做了TM打散，但是有些单个TM恢复状态就需要几十分钟，这对于特征拼接任务来讲是不可接受的。</p>
<h4 data-id="heading-29">4.1.3.SSD寿命消耗加速</h4>
<p>我们的实时集群磁盘使用的是单块的SSD，SSD寿命是有限的，然而RcoksDB的写放大的特点加速了SSD的寿命的消耗。</p>
<h3 data-id="heading-30">4.2 规划</h3>
<p>经过较长时间的实践我们理解了样本拼接的本质是将不同来源、不同更新频率、不同规模的特征（如基础特征、实时埋点特征、历史特征）组合成完整样本，而单一组件往往在 “延迟、存储规模、更新频率” 等维度存在短板，必须通过混合架构实现 “优势互补”。</p>
<h4 data-id="heading-31">业界混合架构的案例</h4>
<p><strong>组件分工</strong></p>
<p><img src="https://static001.geekbang.org/infoq/df/dfa6fcb45b26fb78bb36157c40d3f9a3.jpeg" alt="图片" loading="lazy"/></p>
<p><strong>拼接流程</strong></p>
<p><strong>① 实时日志采集：</strong> 用户点击商品的日志通过Kafka接入Flink实时作业；</p>
<p><strong>② 实时数据存储：</strong> 将曝光流的数据存到RocksDB和HBase中，RocksDB的TTL设置成1小时；</p>
<p><strong>③ 算子内实时拼接：</strong> Flink算子从RocksDB读取用户最近1小时埋点特征，从HBase读取基础特征，初步拼接成“实时+基础”特征；</p>
<p><strong>④ 历史特征融合：</strong> Flink作业将初步拼接结果写入Paimon，与Paimon中存储的“7天历史特征”融合，生成完整样本；</p>
<p><strong>⑤ 样本分发：</strong></p>
<ul>
<li>
<p>实时推荐：完整样本通过Flink写入到HDFS提供给在线训练服务使用；</p>
</li>
<li>
<p>离线训练：Spark作业从Paimon读取全量完整样本，用于推荐模型的离线迭代。</p>
</li>
</ul>
<p>下面是一个调用时序图：</p>
<p><img src="https://static001.geekbang.org/infoq/b6/b63abfc2ba44c1bd027c331aef9fb4a0.jpeg" alt="图片" loading="lazy"/></p>
<p><strong>核心价值</strong></p>
<ul>
<li>
<p><strong>低延迟：</strong> RocksDB 支撑算子内毫秒级拼接，满足实时推荐的 “秒级响应” 需求；</p>
</li>
<li>
<p><strong>大规模：</strong> HBase+Paimon 可支撑亿级用户的PB级特征存储；</p>
</li>
<li>
<p><strong>流批协同：</strong> 同一套样本既供实时推荐，又供离线训练，实现流批架构统一；</p>
</li>
<li>
<p><strong>易于扩展：</strong> Paimon动态列支持特征迭代。</p>
</li>
</ul>
<h3 data-id="heading-32">4.3 展望</h3>
<p>近几年大数据架构已经从计算-存储紧密耦合的Map-Reduce时代，进入到了以Kubernetes容器化部署为标准的云原生世界。未来Flink将引入基于远程存储的存算分离状态管理架构，新架构主要为了解决以下问题：</p>
<blockquote>
<ul>
<li>
<p>容器化环境下计算节点受本地磁盘大小限制的问题；</p>
</li>
<li>
<p>由于RocksDB中LSM结构的周期性 Compaction 导致计算资源尖峰的问题；</p>
</li>
<li>
<p>大规模状态快速扩缩容的挑战。</p>
</li>
</ul>
</blockquote>
<p>我们也将持续关注Flink社区的发展，尝试采用远程存储状态后端来做为特征拼接的解决方案。</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Markdown 将成为 AI 时代的通用编程语言？]]></title>    <link>https://juejin.cn/post/7571655979256840232</link>    <guid>https://juejin.cn/post/7571655979256840232</guid>    <pubDate>2025-11-13T00:48:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571655979256840232" data-draft-id="7571672422689767476" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Markdown 将成为 AI 时代的通用编程语言？"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-13T00:48:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="磊磊落落"/> <meta itemprop="url" content="https://juejin.cn/user/3054882885469577"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Markdown 将成为 AI 时代的通用编程语言？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3054882885469577/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    磊磊落落
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T00:48:48.000Z" title="Thu Nov 13 2025 00:48:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>大家好，我是磊磊落落，目前我在技术上主要关注：Java、Golang、AI、架构设计、云原生和自动化测试。欢迎来我的博客（<a href="https://link.juejin.cn?target=https%3A%2F%2Fleileiluoluo.com%2Fposts%2Fthe-universal-programming-language-of-the-ai-era.html" target="_blank" title="https://leileiluoluo.com/posts/the-universal-programming-language-of-the-ai-era.html" ref="nofollow noopener noreferrer">leileiluoluo.com</a>）获取我的最近更新！</p>
</blockquote>
<p>在 AI 编码助手日渐盛行的当下，一个值得关注的技术趋势正悄然浮现：编程语言的抽象层级正不断上移。这意味着，如今我们习以为常的 Java、TypeScript、Python、Swift 等具体编程语言，或将随着 AI 时代的到来，被一种更接近人类自然语言的通用编程范式所取代。</p>
<p>如果上面的趋势变为现实的话，AI 时代的软件交付就会由「代码交付」变成是「规范文档」交付。我们每个开发者需要从专注于代码实现提升为专注于设计和架构，开发软件的视角需要从开发者视角提升为架构师视角和产品经理视角，所交付的制品也需要从代码变为结构化的文档。而 AI 会取代人负责那「最后一公里」，将文档转换为代码。</p>
<h3 data-id="heading-0">1 当前 AI 辅助编码现状</h3>
<p>下面是网友总结的 AI 时代十大热门「编程语言」：</p>
<pre><code class="hljs language-text" lang="text">给我生成完整可运行的代码
就改这里，别的地方别动
请用中文回答我
这个错误你上次就犯过
别自作聪明优化
你这代码根本编译不过
能不能有点记忆力
按照我给的例子写
还是报错
能先跑起来再说吗
</code></pre>
<p>上面的「热门语」就是我们当下使用 AI 助手的日常，是否戳中了您的笑点。由此可知，目前我们使用 AI 助手时还大多停留在凭感觉编程的阶段（Vibe Coding），未达到真正的工程化。</p>
<p>这个其实不怪 AI，当老板说一句「你把这个给实现了」，我们作为人类也会懵。所以要想让 AI 有高质量、规范化、可复现的产出，我们需要给 AI 提供粒度适中的指导文档，耐心的教 AI 怎么做，而不是泛泛一句「把这个给我实现了」就完了。</p>
<h3 data-id="heading-1">2 规范驱动开发</h3>
<p>所以目前业界首推的是规范驱动开发（Spec-Driven Development）：即让 AI 编码之前，首先我们自己要构思好一个「规范」，然后用结构化的文档告诉 AI「做什么」和「怎么做」。这个规范很重要，规范即代码，这是人类和 AI 之间的契约（唯一事实来源，Source of Truth）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f36afb95a1b74a2a95e23e04c40f21eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK56OK6JC96JC9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763599728&amp;x-signature=C7qie0UzeLsMfMRQMyiH65yAvIQ%3D" alt="规范驱动开发的层级" loading="lazy"/></p>
<h3 data-id="heading-2">3 AI 时代的编程语言长什么样？</h3>
<p>那么这个指导 AI 编码助手的规范长什么样呢？经初步调查，目前业界推出的「规范驱动开发」的工作流基本都包含三个部分：需求 -&gt; 设计 -&gt; 实现（或任务）。即让 AI 编码助手着手编码前需要用文档的方式告知它业务需求、概要设计和实现步骤。而且业界所使用的「规范驱动开发」文档大多用 Markdown 格式编写。</p>
<p>下面我们以实现一个博客聚合网站为例，初步探索一下这个规范文档具体该怎么写？</p>
<p><strong>需求文档样例：</strong></p>
<p>需要文档要将「做什么」说清楚，即业务场景是什么？针对每个需求的用户故事和验收标准是什么，都要一一描述清楚。</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 需求文档</span>

<span class="hljs-section">## 概述</span>

需要实现一个博客聚合 Web 网站，该网站包含博客广场、博客详情、博客提交、和博客审核几个主要页面。

<span class="hljs-section">## 需求</span>

<span class="hljs-section">### 博客广场页面</span>

博客广场是所有已收录博客的集中展示页面，

<span class="hljs-strong">**用户故事：**</span>

作为网站访客，我希望能看到所有已发布的博客，以便了解是否有我所感兴趣的。

<span class="hljs-strong">**验收标准：**</span>

<span class="hljs-bullet">-</span> 页面加载后，显示博客列表（名称、简介、发布时间、浏览数）；

<span class="hljs-bullet">-</span> 每页默认显示 10 篇博客；

<span class="hljs-bullet">-</span> 列表按照发布时间降序排列（最新优先）；

<span class="hljs-bullet">-</span> 数据来源于后端 API （GET /api/blogs?page={page}&amp;size={size}）；

<span class="hljs-bullet">-</span> 当无数据时，显示「暂无博客」提示。

...

<span class="hljs-section">### 博客详情页面</span>

...
</code></pre>
<p><strong>设计文档样例：</strong></p>
<p>设计文档即是基于上述需求文档的具体设计，是在告诉 AI「怎么做」之前告知它的必要参考知识。包括但不限于：架构图、前后端交互方式、前端组件设计、后端 API 设计、错误处理、测试策略等。</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 设计文档</span>

<span class="hljs-section">## 网站架构</span>

┌────────────────────────────────────────────┐
│ 博客聚合网站                                 │
│ (Blog Aggregation Web)                     │
└────────────────────────────────────────────┘
│
▼
┌────────────────────────┐
│ 前端层（Web）            │
│ React + Axios + Router │
└────────────────────────┘
│
▼
┌──────────────────────────────────┐
│ 页面结构                          │
│----------------------------------│
│ 首页（Blog Plaza Page）           │
│ - 显示所有博客列表                  │
│ - 搜索 / 筛选 / 排序 / 分页         │
│ - 点击后进入详情页                  │
│----------------------------------│
│ 博客详情页（Blog Detail Page）     │
│ - 显示单篇博客完整内容              │
│ - 支持点赞 / 评论 / 分享           │
│----------------------------------│
│ 博客提交页（Blog Submit Page）     │
│ - 用户提交博客内容                 │
│ - 填写标题、简介、标签              │
│----------------------------------│
│ 博客审核页（Blog Review Page）     │
│ - 管理员审核用户提交的博客           │
│ - 审核通过或退回修改                │
└──────────────────────────────────┘
│
▼
┌──────────────────────────────────┐
│ 后端层（API）                      │
│ Spring Boot 3.3.5                │
│----------------------------------│
│ 控制器（Controllers）              │
│ - BlogController                 │
│ - AdminController                │
│----------------------------------│
│ 服务层（Services）                 │
│ - BlogService (列表/详情/提交)     │
│ - ReviewService (审核逻辑)        │
│----------------------------------│
│ 数据访问层（Repositories）         │
│ - BlogRepository (JPA)           │
│ - AuthorRepository               │
└──────────────────────────────────┘
│
▼
┌──────────────────────────────────┐
│ 数据层（DB）                       │
│----------------------------------│
│ blogs ← 博客主表                  │
│ authors ← 作者信息                │
│ categories ← 分类信息             │
│ tags ← 标签信息                   │
│ review<span class="hljs-emphasis">_logs ← 审核日志            │
└──────────────────────────────────┘
│
▼
┌──────────────────────────────────┐
│ 外部依赖与集成模块                  │
│----------------------------------│
│ RSS / API 聚合（其他博客源）        │
│ AI 自动分类与摘要生成               │
│ 分析服务（访问统计 / 热度）          │
│ 邮件通知服务（新博客提醒）           │
└──────────────────────────────────┘

## 组件设计

...

## 错误处理

...

## 测试策略

...
</span></code></pre>
<p><strong>实现文档样例</strong>：</p>
<p>实现文档不是具体到每行代码该怎么写，而是介于设计文档和编程语言之间的一个恰当粒度的「怎么做」文档。比如需要使用的编程语言、前后端交互的具体 JSON 结构、针对每个需求的实现步骤等需要在实现文档描述清楚。</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 实现计划</span>

<span class="hljs-section">## 博客广场页面</span>

目标：展示所有已发布的博客，支持搜索、筛选、排序、分页。

<span class="hljs-section">### 前端任务</span>

<span class="hljs-bullet">-</span> 使用 React + React Router 创建 /blogs 页面；

<span class="hljs-bullet">-</span> 实现博客列表组件（BlogList + BlogCard）；

<span class="hljs-bullet">-</span> 添加搜索框、分类筛选、排序下拉框组件；

<span class="hljs-bullet">-</span> 支持分页切换与 URL 同步（Query 参数）；

<span class="hljs-bullet">-</span> 接入后端 API：GET /api/blogs。

<span class="hljs-section">### 后端任务</span>

<span class="hljs-bullet">-</span> 创建 BlogController#getBlogs()；

<span class="hljs-bullet">-</span> 支持分页、排序、关键字与分类过滤参数；

<span class="hljs-bullet">-</span> 定义 DTO：BlogSummaryResponse；

<span class="hljs-bullet">-</span> 单元测试与集成测试，

...
</code></pre>
<p>如上即是实现一个博客聚合网站的「规范驱动开发」样例文档。我们可以手动编写这些文档来指导 AI 做实现，也可以借助市面上诸如 Spec Kit、Open Spec 等工具来自动生成和维护这些规范文档。这样，在有了规则、需求、设计以及指导步骤的情况下，AI 编码助手的实现才会更加可靠和高效。</p>
<h3 data-id="heading-3">4 小结</h3>
<p>综上，这么看下来，在 AI 时代，开发者可能会从之前的代码实现上解脱出来，而会将时间更多的放在设计、架构和编写规范文档上。而良好的规范文档会帮助 AI 消除歧义、减少幻觉，从而实现准确可靠的代码。</p>
<p>当然「规范驱动开发」这个模式也不是万能钥匙，其距离真正落地还面临不少问题。怎么把握文档的粒度？何为一个好的规范文档？针对同一个规范文档 AI 生成的代码就完全一致吗？规范文档如何随着迭代一起演进？针对这些问题，业界正在探索如何解决。</p>
<p>但不管怎么说，AI 改变软件开发是必然的趋势，开发者以后是否可以彻底告别编写代码，而将日常工作完全放在编写诸如 Markdown 等规范文档上，相信不远的将来即会有答案。</p>
<blockquote>
<p>参考资料</p>
<p>[1] YouTube: Spec-Driven Development in the Real World - <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3D3le-v1Pme44" target="_blank" title="https://www.youtube.com/watch?v=3le-v1Pme44" ref="nofollow noopener noreferrer">www.youtube.com/watch?v=3le…</a></p>
<p>[2] Medium: Spec-Driven Development: Designing Before You Code (Again) - <a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium.com%2F%40dave-patten%2Fspec-driven-development-designing-before-you-code-again-21023ac91180" target="_blank" title="https://medium.com/@dave-patten/spec-driven-development-designing-before-you-code-again-21023ac91180" ref="nofollow noopener noreferrer">medium.com/@dave-patte…</a></p>
<p>[3] Martin Fowler: Understanding Spec-Driven-Development: Kiro, spec-kit, and Tessl - <a href="https://link.juejin.cn?target=https%3A%2F%2Fmartinfowler.com%2Farticles%2Fexploring-gen-ai%2Fsdd-3-tools.html" target="_blank" title="https://martinfowler.com/articles/exploring-gen-ai/sdd-3-tools.html" ref="nofollow noopener noreferrer">martinfowler.com/articles/ex…</a></p>
<p>[4] GitHub Blog: Spec-driven development with AI: Get started with a new open source toolkit - <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.blog%2Fai-and-ml%2Fgenerative-ai%2Fspec-driven-development-with-ai-get-started-with-a-new-open-source-toolkit%2F" target="_blank" title="https://github.blog/ai-and-ml/generative-ai/spec-driven-development-with-ai-get-started-with-a-new-open-source-toolkit/" ref="nofollow noopener noreferrer">github.blog/ai-and-ml/g…</a></p>
<p>[5] 微信公众号：Spec-Driven Development - AI 时代的软件开发新范式 - <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FnrJyR5EgvTwp3wAXTM0L3w" target="_blank" title="https://mp.weixin.qq.com/s/nrJyR5EgvTwp3wAXTM0L3w" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/nrJyR5Egv…</a></p>
<p>[6] Wikipedia: Vibe coding - <a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FVibe_coding" target="_blank" title="https://en.wikipedia.org/wiki/Vibe_coding" ref="nofollow noopener noreferrer">en.wikipedia.org/wiki/Vibe_c…</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于 LangGraph 构建极简对话式 AI 智能体]]></title>    <link>https://juejin.cn/post/7571731181197738020</link>    <guid>https://juejin.cn/post/7571731181197738020</guid>    <pubDate>2025-11-13T02:15:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571731181197738020" data-draft-id="7571758212473651251" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于 LangGraph 构建极简对话式 AI 智能体"/> <meta itemprop="keywords" content="Python,LangChain,Agent"/> <meta itemprop="datePublished" content="2025-11-13T02:15:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="秋刀奈"/> <meta itemprop="url" content="https://juejin.cn/user/2066737590439079"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于 LangGraph 构建极简对话式 AI 智能体
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2066737590439079/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    秋刀奈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T02:15:24.000Z" title="Thu Nov 13 2025 02:15:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    16
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">基于LangGraph构建极简对话式AI智能体：Clean Graph工程搭建指南</h2>
<ul>
<li>视频地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1PwCHBCEkV" target="_blank" title="https://www.bilibili.com/video/BV1PwCHBCEkV" ref="nofollow noopener noreferrer">LangGraph 最简工程搭建_哔哩哔哩_bilibili</a></li>
<li>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fslow-coding%2Fclean_graph" target="_blank" title="https://github.com/slow-coding/clean_graph" ref="nofollow noopener noreferrer">GitHub - slow-coding/clean_graph: A LangGraph v1.0 Minimal Quick Starter for Agents</a></li>
</ul>
<h3 data-id="heading-1">引言</h3>
<p>LangGraph作为基于图结构的AI应用框架，为构建复杂智能体提供了灵活的节点编排能力。本文将详细介绍如何搭建一个最小化的LangGraph工程（Clean Graph），该工程可作为智能体开发的脚手架或实验场，帮助开发者快速掌握LangGraph的核心用法，并通过LangGraph Studio实现智能体行为的可视化调试。</p>
<h3 data-id="heading-2">项目概述</h3>
<p>Clean Graph是一个基于LangGraph构建的极简对话式AI智能体，旨在为学习、构建和实验高级智能体技术提供实用起点。其核心优势在于：</p>
<ul>
<li>极简结构：去除冗余代码，聚焦LangGraph核心逻辑</li>
<li>可视化调试：集成LangGraph Studio，支持智能体行为的实时追踪</li>
<li>环境兼容：支持本地模型（如LM Studio、Ollama）及在线API（如OpenAI）</li>
<li>可扩展性：清晰的模块划分便于功能扩展</li>
</ul>
<h3 data-id="heading-3">前置要求</h3>
<h4 data-id="heading-4">必需工具</h4>
<ul>
<li><strong>Python</strong>：编程语言环境（推荐3.12版本）</li>
<li><strong>pip</strong>：Python包管理器</li>
<li><strong>Miniconda</strong>：轻量级环境管理器，用于隔离项目依赖</li>
<li><strong>VSCode</strong>：推荐的开发环境，便于配置虚拟环境及代码调试</li>
</ul>
<h4 data-id="heading-5">工具安装指南</h4>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.python.org%2Fdownloads%2Fmacos%2F" target="_blank" title="https://www.python.org/downloads/macos/" ref="nofollow noopener noreferrer">Python for MacOS</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anaconda.com%2Fdocs%2Fgetting-started%2Fminiconda%2Finstall%23macos-2" target="_blank" title="https://www.anaconda.com/docs/getting-started/miniconda/install#macos-2" ref="nofollow noopener noreferrer">Miniconda installation</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpip.pypa.io%2Fen%2Fstable%2Finstallation%2F%23" target="_blank" title="https://pip.pypa.io/en/stable/installation/#" ref="nofollow noopener noreferrer">pip Installation</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.visualstudio.com%2Fdocs%2Fsetup%2Fmac" target="_blank" title="https://code.visualstudio.com/docs/setup/mac" ref="nofollow noopener noreferrer">Visual Studio Code on macOS</a></li>
</ul>
<h3 data-id="heading-6">快速开始</h3>
<h4 data-id="heading-7">1. 环境设置</h4>
<p>首先创建并激活独立的Conda虚拟环境，避免依赖冲突：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建名为clean_graph的虚拟环境，指定Python 3.12</span>
conda create -n clean_graph python=3.12

<span class="hljs-comment"># 激活环境</span>
conda activate clean_graph
</code></pre>
<blockquote>
<p>若使用VSCode开发，可通过右下角Python环境选择器关联该虚拟环境，无需手动激活。</p>
</blockquote>
<h4 data-id="heading-8">2. 安装依赖</h4>
<p>项目依赖已整理至<code>requirements.txt</code>，执行以下命令批量安装：</p>
<pre><code class="hljs language-bash" lang="bash">pip install -r requirements.txt
</code></pre>
<p>核心依赖说明：</p>
<ul>
<li><code>langgraph~=1.0</code>：LangGraph框架核心</li>
<li><code>langchain~=1.0</code>：AI应用开发工具链</li>
<li><code>langchain_openai</code>：OpenAI兼容API客户端</li>
<li><code>python-dotenv</code>：环境变量管理</li>
<li><code>langgraph-cli</code>：LangGraph Studio开发工具</li>
</ul>
<h4 data-id="heading-9">3. 环境配置</h4>
<p>编辑项目根目录下的<code>.env</code>文件，配置模型及追踪服务参数：</p>
<pre><code class="hljs language-env" lang="env"># 必需：LLM API配置（支持所有OpenAI兼容接口）
LLM_API_BASE=http://localhost:1234/v1  # 本地模型服务地址（如LM Studio、Ollama）
LLM_MODEL=qwen/qwen3-next-80b          # 模型名称（需与服务端一致）
LLM_API_KEY=your-api-key-here          # API密钥（本地模型可填任意值）

# 可选：LangSmith追踪配置（用于调试与分析）
LANGSMITH_TRACING=false                # 是否启用追踪（开发阶段建议设为false）
LANGSMITH_API_KEY=your-langsmith-key   # LangSmith密钥（需在官网注册获取）
</code></pre>
<blockquote>
<p>LangSmith是LangChain提供的在线追踪服务，用于记录智能体执行过程，注册地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fsmith.langchain.com%2F" target="_blank" title="https://smith.langchain.com/" ref="nofollow noopener noreferrer">LangSmith官网</a>。</p>
</blockquote>
<h4 data-id="heading-10">4. 启动LangGraph Studio</h4>
<p>通过以下命令启动可视化调试界面：</p>
<pre><code class="hljs language-bash" lang="bash">langgraph dev --no-reload
</code></pre>
<ul>
<li><code>--no-reload</code>：禁用热更新（避免频繁代码改动导致界面假死）</li>
<li>启动成功后，访问<code>http://localhost:2024</code>即可打开LangGraph Studio界面</li>
</ul>
<h3 data-id="heading-11">项目结构解析</h3>
<p>Clean Graph采用模块化设计，核心结构如下：</p>
<pre><code class="hljs language-bash" lang="bash">clean_graph/
├── src/
│   ├── __init__.py      <span class="hljs-comment"># 包初始化文件</span>
│   ├── graph.py         <span class="hljs-comment"># LangGraph图结构定义（核心逻辑）</span>
│   └── llms.py          <span class="hljs-comment"># LLM实例配置（加载.env参数）</span>
├── .<span class="hljs-built_in">env</span>                 <span class="hljs-comment"># 环境变量配置（模型地址、密钥等）</span>
├── langgraph.json       <span class="hljs-comment"># LangGraph应用定义（关联Studio）</span>
├── requirements.txt     <span class="hljs-comment"># 项目依赖清单</span>
├── README.md            <span class="hljs-comment"># 英文版说明文档</span>
└── README_CN.md         <span class="hljs-comment"># 中文版说明文档</span>
</code></pre>
<h4 data-id="heading-12">核心文件说明</h4>
<ol>
<li>
<p><strong>src/llms.py</strong><br/>
负责加载<code>.env</code>配置，创建LLM调用实例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">import</span> os

load_dotenv()  <span class="hljs-comment"># 加载.env文件</span>

llm = ChatOpenAI(
    base_url=os.getenv(<span class="hljs-string">"LLM_API_BASE"</span>),
    model=os.getenv(<span class="hljs-string">"LLM_MODEL"</span>),
    api_key=os.getenv(<span class="hljs-string">"LLM_API_KEY"</span>)
)
</code></pre>
</li>
<li>
<p><strong>src/graph.py</strong><br/>
定义LangGraph图结构，包含一个极简的对话链路（<code>start → agent → end</code>）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> Graph, StateGraph
<span class="hljs-keyword">from</span> langgraph.graph.message <span class="hljs-keyword">import</span> add_messages
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field
<span class="hljs-keyword">from</span> src.llms <span class="hljs-keyword">import</span> llm

<span class="hljs-comment"># 定义状态结构（存储对话消息列表）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">State</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    messages: <span class="hljs-built_in">list</span> = Field(default_factory=<span class="hljs-built_in">list</span>)

<span class="hljs-comment"># 定义Agent节点逻辑（调用LLM生成回复）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">agent</span>(<span class="hljs-params">state: State</span>):
    response = llm.invoke(state.messages)
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"messages"</span>: [response]}

<span class="hljs-comment"># 构建图结构</span>
builder = StateGraph(State)
builder.add_node(<span class="hljs-string">"agent"</span>, agent)  <span class="hljs-comment"># 添加Agent节点</span>
builder.set_entry_point(<span class="hljs-string">"agent"</span>)   <span class="hljs-comment"># 入口点为Agent</span>
builder.set_finish_point(<span class="hljs-string">"agent"</span>) <span class="hljs-comment"># 出口点为Agent</span>
graph = builder.<span class="hljs-built_in">compile</span>()         <span class="hljs-comment"># 编译为可执行图</span>

<span class="hljs-comment"># 暴露应用实例（供Studio调用）</span>
app = graph
</code></pre>
</li>
<li>
<p><strong>langgraph.json</strong><br/>
关联LangGraph Studio与应用实例，确保Studio能正确加载图结构：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"graphs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"default"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"source"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src.graph:app"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Clean Graph"</span>
        <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
</ol>
<h3 data-id="heading-13">LangGraph Studio使用指南</h3>
<p>LangGraph Studio是可视化调试智能体的核心工具，主要功能包括：</p>
<ol>
<li>
<p><strong>状态追踪</strong><br/>
实时展示<code>State</code>中<code>messages</code>列表的变化，清晰查看对话消息的累加过程。</p>
</li>
<li>
<p><strong>节点执行可视化</strong><br/>
以流程图形式展示智能体执行路径（当前为<code>start → agent → end</code>），复杂链路可直观呈现节点跳转逻辑。</p>
</li>
<li>
<p><strong>交互模式</strong></p>
<ul>
<li><strong>Graph模式</strong>：展示完整执行链路及中间状态，适合调试。</li>
<li><strong>Chat模式</strong>：隐藏中间过程，仅展示人机交互结果，适合快速测试。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-14">基本操作步骤</h4>
<ol>
<li>在Studio界面左侧输入框选择<code>human</code>角色，输入对话内容并提交。</li>
<li>系统会触发<code>agent</code>节点逻辑，调用LLM生成回复并更新<code>messages</code>状态。</li>
<li>多轮对话时，<code>messages</code>列表会自动累加历史消息，实现上下文连贯。</li>
</ol>
<h3 data-id="heading-15">总结</h3>
<p>Clean Graph通过极简设计降低了LangGraph的学习门槛，开发者可基于此框架：</p>
<ul>
<li>快速理解LangGraph的图结构与节点编排逻辑</li>
<li>借助LangGraph Studio可视化调试智能体行为</li>
<li>扩展节点与链路，实验复杂智能体功能（如工具调用、多智能体协作等）</li>
</ul>
<p>如需进一步学习，可参考官方文档：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flanggraph%2Fstudio" target="_blank" title="https://docs.langchain.com/oss/python/langgraph/studio" ref="nofollow noopener noreferrer">LangGraph Studio Doc</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flanggraph%2Foverview" target="_blank" title="https://docs.langchain.com/oss/python/langgraph/overview" ref="nofollow noopener noreferrer">LangGraph Doc</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零开始的 Godot 之旅 — EP10：有限状态机（二）]]></title>    <link>https://juejin.cn/post/7571702660933517327</link>    <guid>https://juejin.cn/post/7571702660933517327</guid>    <pubDate>2025-11-13T02:38:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571702660933517327" data-draft-id="7571722835658113058" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零开始的 Godot 之旅 — EP10：有限状态机（二）"/> <meta itemprop="keywords" content="Godot,游戏开发"/> <meta itemprop="datePublished" content="2025-11-13T02:38:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="陈尕六"/> <meta itemprop="url" content="https://juejin.cn/user/1392435974647373"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零开始的 Godot 之旅 — EP10：有限状态机（二）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1392435974647373/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    陈尕六
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T02:38:18.000Z" title="Thu Nov 13 2025 02:38:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从零开始的 Godot 之旅 — EP10：有限状态机（二）</h2>
<blockquote>
<p>在上一章中，我们详细设计了有限状态机（FSM）的底层架构。理论终须实践，本节我们将正式在项目中应用这套状态机，并通过改造玩家（Player）场景，将枯燥的代码设计化为生动的角色行为。</p>
</blockquote>
<h3 data-id="heading-1">新建目录</h3>
<p>我们首先来调整一下项目结构，为接下来的状态机实现做好准备。</p>
<p>在<code>res://common/</code>目录下创建<code>state_machine/</code>目录。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01e21083b4474abfa85c74a629d0d1fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI5bCV5YWt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763606298&amp;x-signature=Y50TUlmTToRKOuTzRaZGTlERg7U%3D" alt="alt text" loading="lazy"/></p>
<blockquote>
<p>没错，我确实删除了原先的 script 根目录。自从在 EP8 中将玩家相关的脚本和资源整合到其场景目录下后，我愈发觉得一个笼统的 <code>script</code> 目录意义不大。Godot 与 Java 或 C# 不同，它不以脚本为核心，脚本本身也不具备严格的“包（package）”概念。因此，将所有脚本集中存放，反而会导致我们在场景和脚本目录间频繁切换，既浪费时间也不利于组件的迁移。所以，后续我们的项目结构可能会更多地以“场景”为核心，而非“文件类型”。（至少目前是这么想的）</p>
</blockquote>
<p>在<code>state_machine</code>目录中，我们依次创建<code>state_machine.gd</code>、<code>state.gd</code>、<code>state_transition.gd</code>、<code>state_loader.gd</code>这四个文件，并将上一节中提供的代码分别粘贴进去。</p>
<p>请特别注意它们的基类：<code>state_machine</code> 和 <code>state</code> 继承自 <code>Node</code>，而 <code>state_transition</code> 和 <code>state_loader</code> 继承自 <code>RefCounted</code>。</p>
<blockquote>
<p>为什么基类不同？这是因为 <code>StateMachine</code> 和 <code>State</code> 作为场景的一部分需要被挂载到节点树上，而 <code>StateTransition</code> 和 <code>StateLoader</code> 只是用于承载逻辑和数据的辅助类，无需成为场景节点，使用轻量级的 <code>RefCounted</code> 可以有效管理内存。</p>
</blockquote>
<p>在新建 <code>state_transition</code> 脚本时，可以直接在Godot的创建脚本窗口选择其基类 <code>RefCounted</code>:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c2473a3cd07475b9e85137bf4607f4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI5bCV5YWt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763606298&amp;x-signature=Vfa7qLdb%2FMicgfVbcXyC6q5MtEU%3D" alt="alt text" loading="lazy"/></p>
<p>至此，我们通用的状态机模块就创建好了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1a4ce7f617a4c66bac8a2719fdc6e63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI5bCV5YWt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763606298&amp;x-signature=cDt%2BpSBi8KfbqOrvt9bcvZ%2BHpVA%3D" alt="alt text" loading="lazy"/></p>
<blockquote>
<p>最新的代码请查阅<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fcy4ever%2Fsimple_rag" target="_blank" title="https://gitee.com/cy4ever/simple_rag" ref="nofollow noopener noreferrer">Gitee</a>。我有时可能更新了代码但未能及时同步博客，所以最好还是以Gitee上的为准。</p>
</blockquote>
<h3 data-id="heading-2">改造玩家场景</h3>
<p>基础的状态机框架搭建完毕，现在是时候改造我们的玩家场景，让它真正“动”起来了。</p>
<p>我们打开玩家场景，在根节点（<code>CharacterBody2D</code>）下添加一个 <code>StateMachine</code> 节点，并将其命名为<code>StateMachine</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7af8072cb634dd78e69e0e9cb358cea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI5bCV5YWt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763606298&amp;x-signature=AA1YhuLwiErNPP9IMY2A7AN2qOs%3D" alt="alt text" loading="lazy"/></p>
<p>在检查器中设置该 <code>StateMachine</code> 节点的属性：</p>
<ul>
<li>将 <code>Auto Load Mode</code> 设置为 <code>NODE</code>，这样状态机会自动加载其子节点作为状态。</li>
<li>将 <code>Initial State</code> 设置为 <code>idle</code>，这是我们希望的初始状态。</li>
</ul>
<blockquote>
<p>你可能会好奇，为什么我们自己写的脚本类（StateMachine）能像内置节点一样被添加到场景中？答案就在于继承。因为我们的 <code>StateMachine</code> 类继承自 <code>Node</code>，而 Godot 中所有 <code>Node</code> 都可以被添加到场景树里。这意味着，我们可以通过继承 Godot 提供的任意节点类来创造功能丰富的自定义节点！</p>
</blockquote>
<h4 data-id="heading-3">创建状态节点</h4>
<p>我们之前为玩家设计了 <code>idle</code>、<code>walk</code>、<code>attack</code> 三个动画，现在需要为它们分别创建对应的状态节点。</p>
<p>首先，我们来创建 <code>idle</code> 状态。在 <code>StateMachine</code> 节点下添加一个 <code>State</code> 节点，将其命名为 <code>idle</code>，并在检查器中将它的 <code>State Name</code> 属性也设置为 <code>idle</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c836647d7204b1fb0e291a7664f475e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI5bCV5YWt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763606298&amp;x-signature=BYm9T6wva6YhAKZp1HzwbFa0nSY%3D" alt="alt text" loading="lazy"/></p>
<p>接着，用同样的方法创建 <code>walk</code> 和 <code>attack</code> 两个状态节点，并分别设置好它们的命名和 <code>State Name</code> 属性。</p>
<p>创建完成后的节点结构应如下图所示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e56be5a997d45b1989b66502ee6b72e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI5bCV5YWt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763606298&amp;x-signature=o%2BBnrkmS9etaS7YXaN8A8YNncNU%3D" alt="alt text" loading="lazy"/></p>
<h4 data-id="heading-4">启动状态机</h4>
<p>完成上述步骤后，我们回到 <code>player.gd</code> 脚本。按住 <code>Ctrl (Cmd)</code> 键，将场景树中的 <code>StateMachine</code> 节点拖拽到脚本编辑器中。Godot 会为我们自动创建一个 <code>@onready</code> 变量，并将其绑定到该节点上，非常方便。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75c19873a62b43249901c5e1aea39b82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI5bCV5YWt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763606298&amp;x-signature=N1%2BWRnNIhXJUyRp5qMpTALXYznk%3D" alt="alt text" loading="lazy"/></p>
<p>然后，在 <code>player.gd</code> 中添加 <code>_ready</code> 函数。这个函数会在 Player 节点及其子节点都准备就绪后被调用。我们在其中启动状态机：</p>
<pre><code class="hljs language-GDScript" lang="GDScript">## 状态机
@onready var state_machine: StateMachine = $StateMachine

func _ready() -&gt; void:
	# 启动状态机
	state_machine.start()
</code></pre>
<p>现在启动游戏，你可以在控制台看到状态机已成功加载了三个状态，并进入了我们设定的默认状态 <code>idle</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70ec232a78dc41d3aec5600e5f180893~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI5bCV5YWt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763606298&amp;x-signature=N3Y%2BaZ1zA9lTlWNBM4IJ1bjrrLU%3D" alt="alt text" loading="lazy"/></p>
<h3 data-id="heading-5">更新脚本</h3>
<p>至此，我们已经完成了：</p>
<ul>
<li>通用状态机节点的创建</li>
<li>玩家场景结构的改造</li>
<li>状态机的初步启动</li>
</ul>
<p>接下来，我们将开始编写各个状态的具体逻辑。在此之前，需要先对 <code>player.gd</code> 做一些清理和调整，移除旧的、将被状态机替代的逻辑。</p>
<ol>
<li><strong>清空 <code>_physics_process</code> 函数</strong>：其中的逻辑将由各个状态脚本接管。
<pre><code class="hljs language-GDScript" lang="GDScript">func _physics_process(_delta: float) -&gt; void:
	pass
</code></pre>
</li>
<li><strong>移除旧的攻击相关变量</strong>：<code>attack_duration</code>、<code>attack_timer</code>、<code>is_attacking</code> 将被移入攻击状态（Attack State）中管理。</li>
<li><strong>更新 <code>update_animation</code> 函数</strong>：让它从状态机获取当前状态名称。
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">- var current_state: String = "idle" # 或者 "walk"</span>
<span class="hljs-addition">+ var current_state: String = state_machine.get_current_state_name()</span>
</code></pre>
</li>
</ol>
<p>调整后的 <code>player.gd</code> 完整代码如下：</p>
<pre><code class="hljs language-GDScript" lang="GDScript">extends CharacterBody2D

# 可在检查器里调整的移动速度
@export var speed: float = 100.0

# 当前输入方向向量（单位化前的原始输入）
var move_direction: Vector2 = Vector2.ZERO

# 玩家朝向，默认朝下
var player_direction: Vector2 = Vector2.DOWN

# 组件引用
## 动画子节点
@onready var animation_player: AnimationPlayer = $AnimationPlayer
## 精灵
@onready var sprite: Sprite2D = $Sprite2D
## 状态机
@onready var state_machine: StateMachine = $StateMachine

func _ready() -&gt; void:
	# 启动状态机
	state_machine.start()

func _process(_delta: float) -&gt; void:
	pass

func _physics_process(_delta: float) -&gt; void:
	pass

# 更新朝向和动画
# @return 无返回值
func update_direction_and_animation() -&gt; void:
	# 更新朝向（只在有移动时更新，使用标准方向）
	if move_direction != Vector2.ZERO:
		var new_direction: Vector2
		if abs(move_direction.x) &gt; abs(move_direction.y):
			new_direction = Vector2.RIGHT if move_direction.x &gt; 0 else Vector2.LEFT
		else:
			new_direction = Vector2.DOWN if move_direction.y &gt; 0 else Vector2.UP
		
		# 如果朝向发生变化,更新玩家朝向
		if new_direction != player_direction:
			player_direction = new_direction
	# 更新动画
	update_animation()


# 更新角色动画
# @return 无返回值
func update_animation() -&gt; void:
	var current_state: String = state_machine.get_current_state_name()
	var direction: String = get_anim_direction()
	var animation_name: String = current_state + "_" + direction

	if animation_player.has_animation(animation_name):
		animation_player.play(animation_name)
	else:
		print_debug("动画不存在: ", animation_name)


# 获取动画方向字符串
# @return 方向字符串（"down", "up", 或 "side"）
func get_anim_direction() -&gt; String:
	if abs(player_direction.x) &gt; abs(player_direction.y):
		sprite.flip_h = player_direction.x &lt; 0
		return "side"
	if player_direction.y &lt; 0:
		return "up"
	return "down"

</code></pre>
<h4 data-id="heading-6">待机状态（Idle State）</h4>
<p>我们先来梳理一下待机状态的逻辑：</p>
<ul>
<li><strong>进入时</strong>：播放待机动画。</li>
<li><strong>持续时</strong>：
<ul>
<li>确保玩家速度为零，保持静止。</li>
<li>持续更新动画以响应玩家的朝向变化。</li>
</ul>
</li>
<li><strong>退出条件</strong>：由状态转换规则自动处理（例如，检测到移动输入）。</li>
</ul>
<p>现在，为 <code>idle</code> 状态节点附加一个新脚本。我将其命名为 <code>player_idle_state.gd</code> 并存放在 <code>res://scenes/entities/player/scripts/states/</code> 目录下。请注意，它需要继承自我们之前创建的 <code>State</code> 基类。</p>
<pre><code class="hljs language-GDScript" lang="GDScript"># PlayerIdleState.gd
# 玩家空闲状态
# @author chenrui
# @date 2025-08-31
class_name PlayerIdleState
extends State


# 进入状态时调用
func enter(_previous_state: String = "", _data: Dictionary = {}) -&gt; void:
	var player: CharacterBody2D = get_state_owner()
	if player == null:
		printerr("错误: 无法获取玩家节点")
		return

	if player.has_method("update_animation"):
		player.update_animation()


# 物理帧更新
func physics_update(_delta: float) -&gt; void:
	var player: CharacterBody2D = get_state_owner()
	if player == null:
		printerr("错误: 无法获取玩家节点")
		return

	# 保持静止 - 转换由自动转换规则处理
	player.velocity = Vector2.ZERO
	player.move_and_slide()
	# 更新角色朝向和动画
	player.update_direction_and_animation()
</code></pre>
<blockquote>
<p>在状态脚本中，我们可以通过 <code>get_state_owner()</code> 方法方便地获取到玩家节点（CharacterBody2D）的实例，从而直接调用其身上的方法和属性。</p>
</blockquote>
<h4 data-id="heading-7">行走状态（Walk State）</h4>
<p>接着是行走状态的逻辑：</p>
<ul>
<li><strong>进入时</strong>：播放行走动画。</li>
<li><strong>持续时</strong>：
<ul>
<li>接收玩家的移动输入。</li>
<li>根据输入计算归一化的移动方向。</li>
<li>更新 <code>player</code> 的速度属性并调用 <code>move_and_slide()</code> 使其移动。</li>
<li>持续更新角色朝向和动画。</li>
</ul>
</li>
<li><strong>退出条件</strong>：由状态转换规则自动处理（例如，不再有移动输入）。</li>
</ul>
<p>我们为 <code>walk</code> 状态节点新增一个脚本，命名为<code>player_walk_state.gd</code>，同样继承自 <code>State</code> 基类，并存放在相同的状态脚本目录下。</p>
<pre><code class="hljs language-GDScript" lang="GDScript"># PlayerWalkState.gd
# 玩家行走状态
# @author chenrui
# @date 2025-08-31
class_name PlayerWalkState
extends State

# 进入状态时调用
func enter(_previous_state: String = "", _data: Dictionary = {}) -&gt; void:
	var player: CharacterBody2D = get_state_owner()
	if player == null:
		printerr("错误: 无法获取玩家节点")
		return
	
	# 播放行走动画
	if player.has_method("update_animation"):
		player.update_animation()

# 逻辑帧更新
func update(_delta: float) -&gt; void:
	pass


# 物理帧更新
func physics_update(_delta: float) -&gt; void:
	var player: CharacterBody2D = get_state_owner()
	if player == null:
		printerr("错误: 无法获取玩家节点")
		return
		
	# 接收输入,计算移动方向
	var x_axis: float = Input.get_axis("left", "right")
	var y_axis: float = Input.get_axis("up", "down")
	var move_direction = Vector2(x_axis, y_axis)
	# 移动方向大于1时归一化
	if move_direction.length() &gt; 1.0:
		move_direction = move_direction.normalized()

	player.move_direction = move_direction
	# 使用Player中的move_direction和speed
	player.velocity = player.move_direction * player.speed
	player.move_and_slide()
	# 更新角色朝向和动画
	player.update_direction_and_animation()
</code></pre>
<h4 data-id="heading-8">攻击状态（Attack State）</h4>
<p>最后是攻击状态的逻辑：</p>
<ul>
<li><strong>进入时</strong>:
<ul>
<li>重置攻击计时器。</li>
<li>播放攻击动画。</li>
</ul>
</li>
<li><strong>持续时</strong>:
<ul>
<li>计时器累加攻击时长。</li>
<li>确保角色在攻击时保持静止。</li>
<li>更新玩家朝向和动画。</li>
</ul>
</li>
<li><strong>完成条件 (<code>is_finished</code>)</strong>:
<ul>
<li>当攻击计时器超过预设的攻击时长后，此函数返回 <code>true</code>，告知状态机该状态已完成，可以进行转换。</li>
</ul>
</li>
</ul>
<p>攻击状态与待机、行走状态略有不同。为了确保攻击动作的完整性，角色的攻击状态需要等待动画播放完毕后才能退出。在此期间，它不应该被其他状态（如移动）打断。因此，我们需要在攻击状态中实现 <code>is_finished()</code> 函数来告知状态机该状态何时“完成”。</p>
<p>我们为 <code>attack</code> 状态节点新增一个脚本，命名为 <code>player_attack_state.gd</code>，并存放在状态脚本目录下。</p>
<pre><code class="hljs language-GDScript" lang="GDScript"># PlayerAttackState.gd
# 玩家攻击状态
# @author chenrui
# @date 2025-08-31
class_name PlayerAttackState
extends State

## 攻击持续时间（秒）
@export var attack_duration: float = 0.3

## 攻击计时器，用于跟踪攻击进度
var attack_timer: float = 0.0

# 进入状态时调用
func enter(_previous_state: String = "", _data: Dictionary = {}) -&gt; void:
	var player: CharacterBody2D = get_state_owner()
	if player == null:
		printerr("错误: 无法获取玩家节点")
		return

	attack_timer = 0.0

	# 播放攻击动画
	if player.has_method("update_animation"):
		player.update_animation()


# 逻辑帧更新
func update(delta: float) -&gt; void:
	attack_timer += delta
	# 攻击结束的转换由自动转换规则处理


# 物理帧更新
func physics_update(_delta: float) -&gt; void:
	var player: CharacterBody2D = get_state_owner()
	if player == null:
		return

	# 攻击时保持静止
	player.velocity = Vector2.ZERO
	player.move_and_slide()
	
	# 更新角色朝向和动画
	player.update_direction_and_animation()


# 检查状态是否完成
# @return 是否完成
func is_finished() -&gt; bool:
	return attack_timer &gt;= attack_duration
</code></pre>
<h4 data-id="heading-9">实现状态切换</h4>
<p>现在，各个状态的独立逻辑已经完成。但角色还无法在不同状态间切换，因为我们尚未定义切换的“规则”。</p>
<p>我们设计的状态机提供了一套基于规则的自动转换机制。我们只需创建一系列 <code>StateTransition</code> 实例，并告知状态机“在什么条件下，从哪个状态转换到哪个状态”，它就会在每一帧自动检查并执行符合条件的转换。</p>
<p>一个 <code>StateTransition</code> 实例需要以下参数：</p>
<ul>
<li><code>_from_state: String</code> - 源状态名称</li>
<li><code>_to_state: String</code> - 目标状态名称</li>
<li><code>_condition: Callable</code> - 转换条件函数</li>
<li><code>_priority: int</code> - 转换优先级</li>
</ul>
<p>其中，转换条件（<code>condition</code>）是一个返回布尔值的 <code>Callable</code>（通常是匿名函数），用于判断是否满足转换时机。优先级（<code>priority</code>）则用于解决当多个转换规则同时满足时，应优先执行哪一个的问题（数值越大，优先级越高）。</p>
<p>我们以 <code>idle</code> 到 <code>walk</code> 的转换为例：</p>
<pre><code class="hljs language-GDScript" lang="GDScript"># 从 idle 到 walk：有移动输入时
var idle_to_walk_condition: Callable = func():
	return Input.is_action_pressed("up") or Input.is_action_pressed("down") or Input.is_action_pressed("left") or Input.is_action_pressed("right")
var idle_to_walk_transition: StateTransition = StateTransition.new(PlayerConsts.STATE_IDLE, PlayerConsts.STATE_WALK, idle_to_walk_condition, 5)
state_machine.add_transition(idle_to_walk_transition)
</code></pre>
<p>这里的 <code>idle_to_walk_condition</code> 就是一个匿名函数，它检查是否有移动键被按下。<code>StateTransition</code> 定义了从 <code>idle</code> 到 <code>walk</code> 的转换，优先级为 <code>5</code>。最后，通过 <code>add_transition</code> 将这个规则注册到状态机中。</p>
<p>为了避免在代码中硬编码大量的状态名字符串（这很容易因拼写错误而出问题），我们最好创建一个玩家常量脚本来统一管理这些名称。</p>
<p>在<code>res://scenes/entities/player/scripts/</code>目录下创建<code>player_consts.gd</code>文件，内容如下：</p>
<pre><code class="hljs language-GDScript" lang="GDScript"># PlayerConsts.gd
# 玩家常量定义
# @author chenrui
# @date 2025-08-31
class_name PlayerConsts
extends RefCounted

# 状态常量
const STATE_IDLE: String = "idle"
const STATE_WALK: String = "walk"
const STATE_ATTACK: String = "attack"
const STATE_HURT: String = "hurt"
const STATE_DIE: String = "die"

</code></pre>
<p>下面，我们在 <code>player.gd</code> 中编写一个 <code>_setup_transitions</code> 函数，集中定义所有状态的转换规则：</p>
<pre><code class="hljs language-GDScript" lang="GDScript"># 设置状态转换规则
func _setup_transitions() -&gt; void:
	# 从任意状态到攻击状态：按下攻击键时
	var attack_condition: Callable = func(): return Input.is_action_just_pressed("attack")
	var attack_transition: StateTransition = StateTransition.new("*", PlayerConsts.STATE_ATTACK, attack_condition, 10)  # 高优先级，确保攻击能打断其他状态
	state_machine.add_transition(attack_transition)

	# 从 idle 到 walk：有移动输入时
	var idle_to_walk_condition: Callable = func():
		return Input.is_action_pressed("up") or Input.is_action_pressed("down") or Input.is_action_pressed("left") or Input.is_action_pressed("right")
	var idle_to_walk_transition: StateTransition = StateTransition.new(PlayerConsts.STATE_IDLE, PlayerConsts.STATE_WALK, idle_to_walk_condition, 5)
	state_machine.add_transition(idle_to_walk_transition)

	# 从 walk 到 idle：没有移动输入时
	var walk_to_idle_condition: Callable = func():
		return not (Input.is_action_pressed("up") or Input.is_action_pressed("down") or Input.is_action_pressed("left") or Input.is_action_pressed("right"))
	var walk_to_idle_transition: StateTransition = StateTransition.new(PlayerConsts.STATE_WALK, PlayerConsts.STATE_IDLE, walk_to_idle_condition, 5)
	state_machine.add_transition(walk_to_idle_transition)

	# 从 attack 到 walk：攻击结束且有移动输入时
	var attack_to_walk_condition: Callable = func(): return  move_direction != Vector2.ZERO
	var attack_to_walk_transition: StateTransition = StateTransition.new(PlayerConsts.STATE_ATTACK, PlayerConsts.STATE_WALK, attack_to_walk_condition, 5)
	state_machine.add_transition(attack_to_walk_transition)

	# 从 attack 到 idle：攻击结束且没有移动输入时
	var attack_to_idle_condition: Callable = func(): return  move_direction == Vector2.ZERO
	var attack_to_idle_transition: StateTransition = StateTransition.new(PlayerConsts.STATE_ATTACK, PlayerConsts.STATE_IDLE, attack_to_idle_condition, 5)
	state_machine.add_transition(attack_to_idle_transition)
</code></pre>
<p>最后，别忘了在 <code>_ready</code> 函数中调用这个设置方法，确保在状态机启动前所有规则都已注册：</p>
<pre><code class="hljs language-GDScript" lang="GDScript"># 初始化函数
func _ready() -&gt; void:
	# 添加转换规则
	_setup_transitions()

	# 启动状态机
	state_machine.start()
</code></pre>
<h3 data-id="heading-10">最终测试</h3>
<p>一切准备就绪！现在运行游戏，你会发现角色的行为和之前完全一样，可以流畅地移动、站立和攻击。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5fc6bf62047b4e0788a0045233677e68~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI5bCV5YWt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763606298&amp;x-signature=A1nkyaTzFaixKSGasrZGTel7rl8%3D" alt="alt text" loading="lazy"/></p>
<p>但这一次，我们的代码结构已经焕然一新。查看控制台输出的日志，可以看到角色正在我们定义的规则下，于各个状态间精准地切换。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/975558b1a72a46129ea4bbc42c1856a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI5bCV5YWt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763606298&amp;x-signature=lyMDyVrvukUJfhuBRcV3k3qu9h8%3D" alt="alt text" loading="lazy"/></p>
<h3 data-id="heading-11">本节小结</h3>
<p>在本节中，我们将上一章设计的有限状态机架构成功应用到了项目中，彻底重构了玩家的控制逻辑。我们不仅完成了代码层面的迁移，更重要的是，我们建立了一套清晰、可扩展的角色行为管理框架。</p>
<h4 data-id="heading-12">核心实践回顾</h4>
<ol>
<li><strong>状态机集成</strong>：将通用的状态机脚本和节点集成到玩家场景中，并完成了初始化配置。</li>
<li><strong>状态实现</strong>：为“待机”、“行走”和“攻击”创建了各自独立的状态脚本，将原本耦合在 <code>player.gd</code> 中的逻辑进行了解耦和拆分。</li>
<li><strong>规则驱动的转换</strong>：利用 <code>StateTransition</code> 定义了清晰的状态切换规则，实现了状态的自动、智能切换，彻底告别了复杂的 <code>if-else</code> 嵌套。</li>
<li><strong>代码重构</strong>：通过移除旧的逻辑和变量，让 <code>player.gd</code> 变得更加轻量，只负责维护通用的属性和方法，而将具体的状态行为全权委托给状态机。</li>
</ol>
<p>通过这次实践，我们不仅让代码变得更易于维护和扩展，也为未来添加更多复杂功能（如受伤、死亡、翻滚等）打下了坚实的基础。</p>
<h4 data-id="heading-13">下一步</h4>
<p>角色控制已经步入正轨，接下来，我们将把目光投向游戏世界的构建。在下一节中，我们将一同学习 Godot 强大的 <code>TileMap</code>（瓦片地图）系统，用它来搭建我们的第一个游戏场景。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java: 为PDF批量添加图片水印实用指南]]></title>    <link>https://juejin.cn/post/7571672422690193460</link>    <guid>https://juejin.cn/post/7571672422690193460</guid>    <pubDate>2025-11-13T02:02:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571672422690193460" data-draft-id="7571672422690144308" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java: 为PDF批量添加图片水印实用指南"/> <meta itemprop="keywords" content="后端,Java,API"/> <meta itemprop="datePublished" content="2025-11-13T02:02:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="缺点内向"/> <meta itemprop="url" content="https://juejin.cn/user/3414438228006112"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java: 为PDF批量添加图片水印实用指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3414438228006112/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    缺点内向
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T02:02:31.000Z" title="Thu Nov 13 2025 02:02:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Java: 为PDF批量添加图片水印实用指南</h2>
<p>在数字化办公日益普及的今天，PDF文档作为信息传输和共享的重要载体，其安全性和版权保护变得尤为关键。你是否曾为手动给大量PDF文件添加水印而感到头疼？或者，当你的重要文档在未经授权的情况下被传播，却苦于没有有效的标识方法？</p>
<p>传统的文字水印虽然能起到一定作用，但在品牌识别度、防篡改性和视觉效果方面往往不如图片水印。想象一下，将你的公司Logo、版权声明甚至是“绝密”字样的图片水印嵌入到PDF中，既能有效宣示主权，又能提升文档的专业性。然而，如何高效、自动化地在Java项目中实现这一功能，成为了许多开发者面临的痛点。</p>
<p>别担心！本文将为你揭示一个强大而便捷的解决方案——Spire.PDF for Java。通过它，你将能够轻松地在Java应用程序中为PDF文档添加图片水印，告别繁琐的手动操作，实现文档处理的自动化。</p>
<hr/>
<h3 data-id="heading-1">为什么选择图片水印？</h3>
<p>在众多的文档保护和标识策略中，图片水印以其独特的优势脱颖而出：</p>
<ul>
<li>防篡改性更强：图片水印作为文档内容的一部分，相比文本水印，其修改和去除难度更大，有效提高了文档的安全性。</li>
<li>品牌识别度高：企业Logo、品牌标识等图片水印能够直观地传达品牌信息，增强文档的专业性和权威性，有助于品牌形象的建设。</li>
<li>视觉效果更佳：精心设计的图片水印能够与文档内容和谐共存，既不影响阅读，又能起到标识作用，提升文档整体的视觉体验。</li>
<li>应用场景广泛：
<ul>
<li>版权声明：将版权符号、公司名称作为图片水印，明确文档所有权。</li>
<li>公司Logo：在对外发布的文档中嵌入公司Logo，提升企业形象。</li>
<li>保密标识：对于内部敏感文档，添加“绝密”、“内部资料”等图片水印进行警示。</li>
<li>草稿/样品标识：在未定稿或样品文档中添加“Draft”、“Sample”等字样，避免误用。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-2">Spire.PDF for Java：图片水印的利器</h3>
<p>在Java生态中，处理PDF的库有很多，但Spire.PDF for Java凭借其强大的功能、易于集成的特性以及对各种PDF操作的全面支持，成为了开发者们的优选之一。尤其在水印处理方面，它提供了灵活的API，能够帮助我们轻松实现图片水印的添加、定位、透明度设置等复杂操作。</p>
<p>在开始编码之前，我们需要将Spire.PDF for Java库集成到我们的项目中。如果你使用的是Maven或Gradle，只需在<code>pom.xml</code>或<code>build.gradle</code>文件中添加相应的依赖即可。</p>
<p><strong>Maven依赖配置:</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">repositories</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>com.e-iceblue<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>e-iceblue<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://repo.e-iceblue.cn/repository/maven-public/<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">repositories</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>e-iceblue<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spire.pdf.free<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span> <span class="hljs-comment">&lt;!-- 请使用最新版本 --&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<p><strong>Gradle依赖配置:</strong></p>
<pre><code class="hljs language-gradle" lang="gradle">repositories {
    maven { url "https://repo.e-iceblue.cn/repository/maven-public/" }
}
dependencies {
    implementation 'e-iceblue:spire.pdf.free:5.1.0' // 请使用最新版本
}
</code></pre>
<blockquote>
<p><strong>提示</strong>：为了确保代码的兼容性和获取最新的功能，建议始终使用Spire.PDF for Java的最新稳定版本。</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">Java代码实战：为PDF添加图片水印</h3>
<p>以下是一个完整的Java代码示例，展示了如何使用Spire.PDF for Java为PDF文档添加图片水印，并详细解释了每一步的作用。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.spire.pdf.*;
<span class="hljs-keyword">import</span> com.spire.pdf.graphics.*;
<span class="hljs-keyword">import</span> java.awt.geom.Rectangle2D;
<span class="hljs-keyword">import</span> java.awt.image.BufferedImage;
<span class="hljs-keyword">import</span> javax.imageio.ImageIO;
<span class="hljs-keyword">import</span> java.io.File;
<span class="hljs-keyword">import</span> java.io.IOException;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AddImageWatermarkToPDF</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 1. 加载PDF文档</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">inputPdfPath</span> <span class="hljs-operator">=</span> <span class="hljs-string">"input.pdf"</span>; <span class="hljs-comment">// 替换为你的输入PDF文件路径</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">watermarkImagePath</span> <span class="hljs-operator">=</span> <span class="hljs-string">"watermark.png"</span>; <span class="hljs-comment">// 替换为你的水印图片文件路径</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">outputPdfPath</span> <span class="hljs-operator">=</span> <span class="hljs-string">"output_with_watermark.pdf"</span>; <span class="hljs-comment">// 替换为你的输出PDF文件路径</span>

        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">PdfDocument</span> <span class="hljs-variable">pdf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PdfDocument</span>();
            pdf.loadFromFile(inputPdfPath);

            <span class="hljs-comment">// 2. 加载图片水印</span>
            <span class="hljs-type">BufferedImage</span> <span class="hljs-variable">image</span> <span class="hljs-operator">=</span> ImageIO.read(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(watermarkImagePath));
            <span class="hljs-keyword">if</span> (image == <span class="hljs-literal">null</span>) {
                System.err.println(<span class="hljs-string">"错误：无法加载水印图片，请检查路径和文件格式。"</span>);
                <span class="hljs-keyword">return</span>;
            }

            <span class="hljs-comment">// 遍历PDF中的每一页</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; pdf.getPages().getCount(); i++) {
                <span class="hljs-type">PdfPageBase</span> <span class="hljs-variable">page</span> <span class="hljs-operator">=</span> pdf.getPages().get(i);

                <span class="hljs-comment">// 获取页面尺寸</span>
                <span class="hljs-type">float</span> <span class="hljs-variable">pageWidth</span> <span class="hljs-operator">=</span> page.getActualSize().getWidth();
                <span class="hljs-type">float</span> <span class="hljs-variable">pageHeight</span> <span class="hljs-operator">=</span> page.getActualSize().getHeight();

                <span class="hljs-comment">// 创建一个PdfImage对象</span>
                <span class="hljs-type">PdfImage</span> <span class="hljs-variable">pdfImage</span> <span class="hljs-operator">=</span> PdfImage.fromImage(image);

                <span class="hljs-comment">// 3. 定义水印的位置和大小</span>
                <span class="hljs-comment">// 这里我们以页面中心为例，并设置水印宽度为页面宽度的1/2，高度按比例缩放</span>
                <span class="hljs-type">float</span> <span class="hljs-variable">watermarkWidth</span> <span class="hljs-operator">=</span> pageWidth * <span class="hljs-number">0.5f</span>;
                <span class="hljs-type">float</span> <span class="hljs-variable">watermarkHeight</span> <span class="hljs-operator">=</span> watermarkWidth * pdfImage.getHeight() / pdfImage.getWidth();

                <span class="hljs-comment">// 计算水印的X、Y坐标，使其居中</span>
                <span class="hljs-type">float</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> (pageWidth - watermarkWidth) / <span class="hljs-number">2</span>;
                <span class="hljs-type">float</span> <span class="hljs-variable">y</span> <span class="hljs-operator">=</span> (pageHeight - watermarkHeight) / <span class="hljs-number">2</span>;

                <span class="hljs-comment">// 创建一个矩形，定义水印的放置区域</span>
                Rectangle2D.<span class="hljs-type">Float</span> <span class="hljs-variable">watermarkRect</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rectangle2D</span>.Float(x, y, watermarkWidth, watermarkHeight);

                <span class="hljs-comment">// 4. 设置水印的透明度</span>
                <span class="hljs-comment">// PdfTransparency 类用于设置透明度，值范围为0.0（完全透明）到1.0（完全不透明）</span>
                <span class="hljs-type">PdfTransparency</span> <span class="hljs-variable">transparency</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PdfTransparency</span>(<span class="hljs-number">0.3f</span>); <span class="hljs-comment">// 设置为30%不透明度</span>

                <span class="hljs-comment">// 5. 将图片水印绘制到页面上</span>
                <span class="hljs-comment">// 使用 PdfPageBase 的 drawImage 方法</span>
                page.getCanvas().drawImage(pdfImage, watermarkRect, transparency);

                <span class="hljs-comment">// 如果需要将水印放置在文本下方，可以考虑使用 PdfWatermarkAnnotation</span>
                <span class="hljs-comment">// 但对于简单的图片水印，直接绘制到Canvas上通常足够</span>
            }

            <span class="hljs-comment">// 6. 保存修改后的PDF文档</span>
            pdf.saveToFile(outputPdfPath, FileFormat.PDF);
            pdf.close();

            System.out.println(<span class="hljs-string">"图片水印已成功添加到PDF文档："</span> + outputPdfPath);

        } <span class="hljs-keyword">catch</span> (IOException e) {
            System.err.println(<span class="hljs-string">"文件操作异常："</span> + e.getMessage());
            e.printStackTrace();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"处理PDF时发生错误："</span> + e.getMessage());
            e.printStackTrace();
        }
    }
}
</code></pre>
<p><strong>代码解析:</strong></p>
<ul>
<li><code>pdf.loadFromFile(inputPdfPath)</code>: 加载需要添加水印的PDF文件。</li>
<li><code>ImageIO.read(new File(watermarkImagePath))</code>: 读取本地的水印图片文件（支持PNG, JPG等常见格式）。</li>
<li><code>pdf.getPages().get(i)</code>: 获取PDF文档的每一页进行处理，确保水印应用到所有页面。</li>
<li><code>PdfImage.fromImage(image)</code>: 将<code>BufferedImage</code>对象转换为Spire.PDF可识别的<code>PdfImage</code>对象。</li>
<li><code>Rectangle2D.Float(x, y, watermarkWidth, watermarkHeight)</code>: 定义水印在页面上的位置和大小。你可以根据需求调整<code>x</code>, <code>y</code>坐标以及<code>watermarkWidth</code>, <code>watermarkHeight</code>来控制水印的布局。</li>
<li><code>PdfTransparency(0.3f)</code>: 设置水印的透明度。<code>0.3f</code>表示30%的不透明度，可以根据实际效果调整这个值。</li>
<li><code>page.getCanvas().drawImage(pdfImage, watermarkRect, transparency)</code>: 这是核心步骤，将<code>PdfImage</code>以指定的透明度和位置绘制到当前页面的画布上。</li>
<li><code>pdf.saveToFile(outputPdfPath, FileFormat.PDF)</code>: 将修改后的PDF文档保存到新的文件中。</li>
<li><code>pdf.close()</code>: 释放资源，这是一个良好的编程习惯。</li>
</ul>
<hr/>
<h3 data-id="heading-4">结语</h3>
<p>通过本文的介绍和实战代码，相信你已经掌握了如何在Java中利用Spire.PDF for Java库为PDF文档添加图片水印的方法。无论是为了保护文档版权，提升品牌形象，还是实现内部文档的标识管理，图片水印都是一个强大且灵活的工具。</p>
<p>现在，是时候将这些知识应用到你的项目中了！尝试运行上述代码，感受自动化处理PDF的便捷。希望本文能为你打开一扇新的大门，探索更多PDF处理的潜力！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从0到1实现：AI版你画我猜小游戏]]></title>    <link>https://juejin.cn/post/7569150490798899206</link>    <guid>https://juejin.cn/post/7569150490798899206</guid>    <pubDate>2025-11-06T02:27:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7569150490798899206" data-draft-id="7569055467803033642" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从0到1实现：AI版你画我猜小游戏"/> <meta itemprop="keywords" content="前端,AI编程,TensorFlow"/> <meta itemprop="datePublished" content="2025-11-06T02:27:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="vivo互联网技术"/> <meta itemprop="url" content="https://juejin.cn/user/993614243303053"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从0到1实现：AI版你画我猜小游戏
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614243303053/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    vivo互联网技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-06T02:27:42.000Z" title="Thu Nov 06 2025 02:27:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>作者： vivo 互联网前端团队- Wei Xing</p>
<p>全民AI时代，前端er该如何蹭上这波热度？本文将一步步带大家了解前端应该如何结合端侧AI模型，实现一个AI版你画我猜小游戏。</p>
</blockquote>
<p>1分钟看图掌握核心观点👇</p>
<p><img src="https://static001.geekbang.org/infoq/38/38dbb50453bfb2fb8e723763598eda8f.gif" alt="图片" loading="lazy"/></p>
<p>本文提供配套演示代码，可下载体验：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvivo%2FBlueSnippets%2Ftree%2Fmain%2Fdemos%2Fai-quickdraw" target="_blank" title="https://github.com/vivo/BlueSnippets/tree/main/demos/ai-quickdraw" ref="nofollow noopener noreferrer">Github | vivo-</a><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvivo%2FBlueSnippets%2Ftree%2Fmain%2Fdemos%2Fai-quickdraw" target="_blank" title="https://github.com/vivo/BlueSnippets/tree/main/demos/ai-quickdraw" ref="nofollow noopener noreferrer">ai-quickdraw</a></p>
<h2 data-id="heading-0">一、引言</h2>
<p>近几年AI的进化速度堪比科幻片——昨天还在调教ChatGPT写诗，今天Sora已经能生成电影级画面了。技术圈仿佛被AI“腌入味”了，说不定连这篇文章都是DeepSeek帮忙写的（狗头）。</p>
<p>**前端er的野望：**当其他行业忙着用AI造火箭时，我们这群和浏览器“斗智斗勇”的手艺人，该怎么蹭上这波热度？</p>
<p>在深入思考如何蹭上热度之前，<strong>首先，我们需要先简单了解下AI模型的分类。</strong></p>
<h3 data-id="heading-1">1.1 云端模型和端侧模型</h3>
<p>从模型的部署方式上来看，AI模型可以简单分为云端模型（Cloud Model）和端侧模型（On-Device Model）两种。</p>
<ul>
<li>
<p>**云端模型：**将模型部署在服务集群上，提供一些API能力供端侧来调用，端侧无需处理计算部分，只需调用API获取计算结果即可。比如OpenAI的官方API就是如此。</p>
</li>
<li>
<p>**端侧模型：**直接将模型部署在终端设备上，模型的计算、推理完全依赖终端设备，具有更高的实时性、私密性、安全性，但同时对终端设备等硬件要求也较高。</p>
</li>
</ul>
<p>对于前端来说，由于其非常依赖浏览器和终端设备性能，所以原本最适合前端的方式其实是直接调用云端模型API，把计算的负担转嫁给服务集群，页面只需负责展示结果即可。但通常情况下，搭建集群、训练模型、定制API有很高的资源门槛和成本，现实条件往往不允许我们这样做。</p>
<p>因此，我们可以转而考虑<strong>利用端侧模型来赋能。</strong></p>
<h3 data-id="heading-2">1.2 大语言模型和特定领域模型</h3>
<p>端侧模型从概念上来区分，又可以简单分为大语言模型和特定领域模型。</p>
<p><strong>大语言模型</strong></p>
<p>其中大语言模型（Large Language Model，LLM）就是我们熟知的ChatGPT、DeepSeek、Grok这类模型，它们功能强大，但对设备的性能要求很高，以DeepSeek为例，即使是最小的1.5B版本模型，也至少需要RTX 3060+级别的显卡才能带得动，并且模型本身的大小已经达到1.1GB，并不适合部署在前端项目中。</p>
<p><img src="https://static001.geekbang.org/infoq/d5/d5a1f9cadeb203b661c8f1f7528a8598.png" alt="" loading="lazy"/></p>
<p><strong>特定领域模型</strong></p>
<p>所以，最终留给我们的选项就是利用一些特定领域模型来赋能前端，它们可以用来处理某些特定领域的问题。例如，<strong>利用视觉（CNN、MobileNet）模型实现图像分类、人脸检测，或者利用自然语言模型（NLP）实现问答机器人、文本恶意检测等。</strong></p>
<p>这些模型等特征是尺寸较小，并且对设备性能要求不高，非常适合直接部署在前端并实现一些AI交互。</p>
<p>所以，接下来我们就来看看，<strong>如何从0到1训练一个图像分类模型（Doodle Classifier based on CNN）</strong>，并将模型集成至前端页面，实现一个经典<strong>你画我猜小游戏-端侧AI版。</strong></p>
<h2 data-id="heading-3">二、你画我猜AI版-玩法简介</h2>
<p>动手实践之前，先来简单介绍下你画我猜AI版的玩法，它和普通版本你画我猜的区别在于：玩家根据提示词进行涂鸦，<strong>由AI来预测玩家画的词是什么，如果AI顺利猜对玩家画的词，则玩家得分。</strong></p>
<p><img src="https://static001.geekbang.org/infoq/e0/e030938e11971e605ab4b3677de93b74.gif" alt="图片" loading="lazy"/></p>
<p>例如，提示词是“长城”，则玩家需要通过画板手绘一个长城，尽量画的像一些，让AI猜出正确答案就能得分。</p>
<p>了解了基础玩法之后，接下来正片开始，详细介绍如何从零到一开始实现它。</p>
<p>我们提供了简化版的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fh5.vivo.com.cn%2Fcasual%2Fquickdraw%2Findex.html%23%2Fdoodle" target="_blank" title="https://h5.vivo.com.cn/casual/quickdraw/index.html#/doodle" ref="nofollow noopener noreferrer">live demo</a>，你可以访问链接试试看。同时我们也提供了相关的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvivo%2FBlueSnippets%2Ftree%2Fmain%2Fdemos%2Fai-quickdraw" target="_blank" title="https://github.com/vivo/BlueSnippets/tree/main/demos/ai-quickdraw" ref="nofollow noopener noreferrer">demo代码</a>，你可以随时访问github仓库，下载和尝试运行它。</p>
<h2 data-id="heading-4">三、训练模型</h2>
<p>首先，第一步是训练模型。</p>
<p>根据上面的玩法简介，我们知道它本质上是一个<strong>基于视觉的图片分类AI模型</strong>，而这个模型的功能是：输入图片数据后，模型可以计算出图片的分类置信结果。例如，输入一张小猫的图片，模型的分类计算结果可能为：[猫 90%，狗8%，猪2%]，表示模型认为这张图有90%的概率是只猫，8%的概率是条狗，2%概率是只猪。</p>
<p>这样一来，我们通过将用户手绘的canvas中的图片数据丢给模型，并把模型输出的置信概率最大的分类当作AI的猜测结果，就可以模拟出AI猜词的互动了。</p>
<p>而实现这个模型也很简单，但我们需要了解一些深度学习神经网络的知识以及tensorflow.js的基础用法。如果对这两者不太熟悉，可能需要先自行google一下，做点知识储备。</p>
<p>那么假设大家已经有了一些基础的神经网络、TensorFlow.js基础知识，就可以利用TensorFlow.js轻松搭建一个基于CNN的图片分类模型。</p>
<h3 data-id="heading-5">3.1 获取数据集</h3>
<p>在进入模型训练之前，我们需要先获取数据集。</p>
<p>数据集是训练模型的基础，我们可以自己创建数据集（这很困难、费时），或者寻找一些开源数据集。刚好Google Lab提供了一套完整的<a href="https://link.juejin.cn?target=https%3A%2F%2Fquickdraw.withgoogle.com%2Fdata" target="_blank" title="https://quickdraw.withgoogle.com/data" ref="nofollow noopener noreferrer">开源涂鸦数据集（The Quick Draw Dataset）</a>，数据集中包含了345个不同类别的涂鸦数据集合，总共有5000万份涂鸦数据，足够我们挑选使用。</p>
<p><img src="https://static001.geekbang.org/infoq/5b/5b0b47d45a504e148ec442b4d11b849e.jpeg" alt="图片" loading="lazy"/></p>
<p>我们可以直接访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fquickdraw.withgoogle.com%2Fdata" target="_blank" title="https://quickdraw.withgoogle.com/data" ref="nofollow noopener noreferrer">开源涂鸦数据集（The Quick Draw Dataset）</a>下载所需的数据。点击页面右上角的<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgooglecreativelab%2Fquickdraw-dataset" target="_blank" title="https://github.com/googlecreativelab/quickdraw-dataset" ref="nofollow noopener noreferrer">Get the Data</a> 跳转github仓库，可以看到文档中列出了多种数据类型：</p>
<p><img src="https://static001.geekbang.org/infoq/6c/6cd335b509ae7fb9e9179272fd0d6849.jpeg" alt="图片" loading="lazy"/></p>
<p>这里我们直接选择下载<a href="https://link.juejin.cn?target=https%3A%2F%2Fconsole.cloud.google.com%2Fstorage%2Fbrowser%2Fquickdraw_dataset%2Ffull%2Fnumpy_bitmap" target="_blank" title="https://console.cloud.google.com/storage/browser/quickdraw_dataset/full/numpy_bitmap" ref="nofollow noopener noreferrer">Numpy bitmap files</a>。</p>
<p><img src="https://static001.geekbang.org/infoq/57/574bc7918d605cef5c1ab085de0106ff.jpeg" alt="图片" loading="lazy"/></p>
<p>**注意：**这里的数据集有345种类别，如果全部进行训练的话，训练时间会很长并且最终的模型大小较大，因此，我们可以视情况挑选其中的部分词汇，例如选择80个词汇进行训练，对于一款小游戏来说，词汇量也足够了。</p>
<h3 data-id="heading-6">3.2 搭建模型和训练模型</h3>
<p>下载完训练数据之后，接下来我们需要搭建模型结构并进行模型训练。</p>
<p>如果我们下载了<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvivo%2FBlueSnippets%2Ftree%2Fmain%2Fdemos%2Fai-quickdraw" target="_blank" title="https://github.com/vivo/BlueSnippets/tree/main/demos/ai-quickdraw" ref="nofollow noopener noreferrer">demo代码</a>，可以看到项目结构如下，主要内容为3个部分：</p>
<pre><code class="hljs language-bash" lang="bash">项目目录/
├── 📁 src/                    
│   ├── 📄 index.ts            <span class="hljs-comment"># 程序入口文件</span>
│   ├── 📁 data/               <span class="hljs-comment"># 数据集</span>
│   │   ├── 📄 Apple.npy
│   │   ├── 📄 The Great Wall.npy  
│   │   └── 📄 ...       
│   └── 📁 model/              <span class="hljs-comment"># 训练模型相关</span>
│       ├── 📄 doodle-data.model.ts  <span class="hljs-comment"># 数据加载</span>
│       └── 📄 classifier.model.ts   <span class="hljs-comment"># 模型结构</span>
├── 📄 package.json
</code></pre>
<p>**-data目录：**存放训练数据集</p>
<p><strong>-model目录：</strong></p>
<ul>
<li>
<p>doodle-data.model.ts：数据加载预处理</p>
</li>
<li>
<p>classifier.model.ts：定义模型结构</p>
</li>
</ul>
<p>**-index.ts：**训练程序入口</p>
<p>先来看项目的index.ts入口文件，功能非常简单，主要逻辑就是四步：</p>
<ul>
<li>
<p>加载训练数据</p>
</li>
<li>
<p>创建模型</p>
</li>
<li>
<p>训练模型</p>
</li>
<li>
<p>保存模型参数</p>
<p>import { Classifier } from './model/classifier.model';
import { DoodleData } from './model/doodle-data.model';</p>
<p>async function main(){
const data = new DoodleData({
directoryData: 'src/data',
maxImageClass: 20000
});</p>
<p>// 1. 加载训练数据
data.loadData();
// 2. 创建模型
const model = new Classifier(data);
// 3. 训练模型
await model.train();
// 4. 保存模型参数
await model.save();
}</p>
<p>main();</p>
</li>
</ul>
<p>了解了核心流程之后，再来详细看下model目录下的两个核心文件：doodle-data.model.ts和classifier.model.ts。</p>
<p><strong>首先是doodle-data.model.ts</strong> ，它的核心代码如下，主要是加载data目录下的数据，并将数据预处理为tensor张量，后续可于训练模型。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 加载data目录下的数据</span>
<span class="hljs-title function_">loadData</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">classes</span> = fs.<span class="hljs-title function_">readdirSync</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">directoryData</span>)
    .<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">x</span>) =&gt;</span> x.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.npy'</span>))
    .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">x</span>) =&gt;</span> x.<span class="hljs-title function_">replace</span>(<span class="hljs-string">'.npy'</span>, <span class="hljs-string">''</span>));
}

<span class="hljs-comment">// 数据生成器，预处理数据为tensor张量</span>
*<span class="hljs-title function_">dataGenerator</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt; bytes.<span class="hljs-property">length</span>; j = j + <span class="hljs-variable language_">this</span>.<span class="hljs-property">IMAGE_SIZE</span>) {
    <span class="hljs-keyword">const</span> singleImage = bytes.<span class="hljs-title function_">slice</span>(j, j + <span class="hljs-variable language_">this</span>.<span class="hljs-property">IMAGE_SIZE</span>);
    <span class="hljs-keyword">const</span> image = tf
      .<span class="hljs-title function_">tensor</span>(singleImage)
      .<span class="hljs-title function_">reshape</span>([<span class="hljs-variable language_">this</span>.<span class="hljs-property">IMAGE_WIDTH</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">IMAGE_HEIGHT</span>, <span class="hljs-number">1</span>])
      .<span class="hljs-title function_">toFloat</span>();
    <span class="hljs-keyword">const</span> xs = image.<span class="hljs-title function_">div</span>(offset);
    <span class="hljs-keyword">const</span> ys = tf.<span class="hljs-title function_">tensor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">classes</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">x</span>) =&gt;</span> (x === label ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>)));
    <span class="hljs-keyword">yield</span> { xs, ys };
  }
}
</code></pre>
<p>**其次是，classifier.model.ts。**它的核心代码如下，代码的主要功能是：</p>
<p>构建了一个基于CNN的图像分类模型。通过tf.layers.conv3d()构造了卷积神经网络结构。</p>
<p>提供了train()方法，用于训练模型。这里定义了模型训练的迭代次数（epochs）、训练的批次大小（batchSize），这些参数会影响模型训练的最终结果，就是通常我们所说的“模型调参”，当你觉得模型训练效果不佳时，可以调整这些参数重新训练，直到达成不错的准确率。</p>
<p>提供了save()方法，用于保存模型参数。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> tf from <span class="hljs-string">"@tensorflow/tfjs-node"</span>;
<span class="hljs-keyword">import</span> { DoodleData } from <span class="hljs-string">"./doodle-data.model"</span>;

exportclassClassifier {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-comment">// 定义模型结构</span>
  <span class="hljs-keyword">constructor</span>(<span class="hljs-keyword">data</span>: DoodleData) {
    <span class="hljs-keyword">this</span>.<span class="hljs-keyword">data</span> = <span class="hljs-keyword">data</span>;
    <span class="hljs-keyword">this</span>.model = tf.sequential();
    <span class="hljs-keyword">this</span>.model.add(
      tf.layers.conv2d({
        inputShape: [<span class="hljs-keyword">data</span>.IMAGE_WIDTH, <span class="hljs-keyword">data</span>.IMAGE_HEIGHT, <span class="hljs-number">1</span>],
        kernelSize: <span class="hljs-number">3</span>,
        filters: <span class="hljs-number">16</span>,
        strides: <span class="hljs-number">1</span>,
        activation: <span class="hljs-string">"relu"</span>,
        kernelInitializer: <span class="hljs-string">"varianceScaling"</span>,
      })
    );
    <span class="hljs-keyword">this</span>.model.add(
      tf.layers.maxPooling2d({
        poolSize: [<span class="hljs-number">2</span>, <span class="hljs-number">2</span>],
        strides: [<span class="hljs-number">2</span>, <span class="hljs-number">2</span>],
      })
    );
    <span class="hljs-keyword">this</span>.model.add(
      tf.layers.conv2d({
        kernelSize: <span class="hljs-number">3</span>,
        filters: <span class="hljs-number">32</span>,
        strides: <span class="hljs-number">1</span>,
        activation: <span class="hljs-string">"relu"</span>,
        kernelInitializer: <span class="hljs-string">"varianceScaling"</span>,
      })
    );
    <span class="hljs-keyword">this</span>.model.add(
      tf.layers.maxPooling2d({
        poolSize: [<span class="hljs-number">2</span>, <span class="hljs-number">2</span>],
        strides: [<span class="hljs-number">2</span>, <span class="hljs-number">2</span>],
      })
    );
    <span class="hljs-keyword">this</span>.model.add(tf.layers.flatten());
    <span class="hljs-keyword">this</span>.model.add(
      tf.layers.dense({
        units: <span class="hljs-keyword">this</span>.<span class="hljs-keyword">data</span>.totalClasses,
        kernelInitializer: <span class="hljs-string">"varianceScaling"</span>,
        activation: <span class="hljs-string">"softmax"</span>,
      })
    );

    <span class="hljs-keyword">const</span> optimizer = tf.train.adam();
    <span class="hljs-keyword">this</span>.model.compile({
      optimizer,
      loss: <span class="hljs-string">"categoricalCrossentropy"</span>,
      metrics: [<span class="hljs-string">"accuracy"</span>],
    });
  }

  <span class="hljs-comment">// 模型训练</span>
  async train(){
    <span class="hljs-keyword">const</span> trainingData = tf.<span class="hljs-keyword">data</span>
      .generator(() =&gt; <span class="hljs-keyword">this</span>.<span class="hljs-keyword">data</span>.dataGenerator(<span class="hljs-string">"train"</span>))
      .shuffle(<span class="hljs-keyword">this</span>.<span class="hljs-keyword">data</span>.maxImageClass * <span class="hljs-keyword">this</span>.<span class="hljs-keyword">data</span>.totalClasses)
      .batch(<span class="hljs-number">64</span>);

    <span class="hljs-keyword">const</span> testData = tf.<span class="hljs-keyword">data</span>
      .generator(() =&gt; <span class="hljs-keyword">this</span>.<span class="hljs-keyword">data</span>.dataGenerator(<span class="hljs-string">"test"</span>))
      .shuffle(<span class="hljs-keyword">this</span>.<span class="hljs-keyword">data</span>.maxImageClass * <span class="hljs-keyword">this</span>.<span class="hljs-keyword">data</span>.totalClasses)
      .batch(<span class="hljs-number">64</span>);

    await <span class="hljs-keyword">this</span>.model.fitDataset(trainingData, {
      epochs: <span class="hljs-number">5</span>,
      validationData: testData,
      callbacks: {
        onEpochEnd: async (epoch, logs) =&gt; {
          <span class="hljs-keyword">this</span>.logger.debug(
            `Epoch: ${epoch} - acc: ${logs?.acc.toFixed(
              <span class="hljs-number">3</span>
            )} - loss: ${logs?.loss.toFixed(<span class="hljs-number">3</span>)}`
          );
        },
        onBatchBegin: async (epoch, logs) =&gt; {
          console.log(<span class="hljs-string">"onBatchBegin"</span> + epoch + JSON.stringify(logs));
        },
      },
    });
  }

  <span class="hljs-comment">// 保存模型</span>
  async save(){
    fs.mkdirSync(<span class="hljs-string">"doodle-model"</span>, { recursive: <span class="hljs-literal">true</span> });
    fs.writeFileSync(
      <span class="hljs-string">"doodle-model/classes.json"</span>,
      JSON.stringify({ classes: <span class="hljs-keyword">this</span>.<span class="hljs-keyword">data</span>.classes })
    );
    await <span class="hljs-keyword">this</span>.model.save(<span class="hljs-string">"file://./doodle-model"</span>);
  }
}
</code></pre>
<p>如果我们从github仓库下载了<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvivo%2FBlueSnippets%2Ftree%2Fmain%2Fdemos%2Fai-quickdraw" target="_blank" title="https://github.com/vivo/BlueSnippets/tree/main/demos/ai-quickdraw" ref="nofollow noopener noreferrer">demo</a>代码，在根目录下执行：</p>
<pre><code class="hljs language-arduino" lang="arduino">npm run start
</code></pre>
<p>开启模型训练过程，会有一些输出如下，表示当前的训练轮次、识别准确率、损失等。</p>
<pre><code class="hljs language-erlang" lang="erlang">onBatchBegin0{<span class="hljs-string">"batch"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"size"</span>:<span class="hljs-number">512</span>}
onBatchBegin1{<span class="hljs-string">"batch"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"size"</span>:<span class="hljs-number">512</span>}
onBatchBegin2{<span class="hljs-string">"batch"</span>:<span class="hljs-number">2</span>,<span class="hljs-string">"size"</span>:<span class="hljs-number">512</span>}
onBatchBegin3{<span class="hljs-string">"batch"</span>:<span class="hljs-number">3</span>,<span class="hljs-string">"size"</span>:<span class="hljs-number">512</span>}
onBatchBegin4{<span class="hljs-string">"batch"</span>:<span class="hljs-number">4</span>,<span class="hljs-string">"size"</span>:<span class="hljs-number">192</span>}
...
[Classifier] Epoch: <span class="hljs-number">0</span> - acc: <span class="hljs-number">0.078</span> - loss: <span class="hljs-number">2.632</span>
...
</code></pre>
<p>耐心等待日志打完，模型训练完成之后，我们的项目目录下就会产出一个额外的目录，存放模型的训练结果。</p>
<ul>
<li>
<p>**classes.json：**图片的所有分类，根据data目录中的数据文件名称生成</p>
</li>
<li>
<p>**model.json：**模型的描述文件</p>
</li>
<li>
<p>**weights.bin：**模型的参数文件</p>
<p>项目目录/
├── 📁 doodle-model/           # 训练结果（最终模型）
│   │   ├── 📄 classes.json    # 图片分类<br/>
│   │   ├── 📄 model.json      # 模型描述文件
│   │   └── 📄 weights.bin     # 模型参数</p>
</li>
</ul>
<p>这样，我们的模型就训练完成了。</p>
<p>接下来看看如何在页面中集成模型，实现从绘制canvas图片到模型分类预测的效果。</p>
<h2 data-id="heading-7">四、集成至页面</h2>
<p>在页面中的集成模型也非常简单，我们只需要创建一个可以绘图的canvas，每隔一段时间就将当前canvas的图像数据传输给模型，触发一次模型预测即可。</p>
<p>先来看下项目的核心目录结构：</p>
<pre><code class="hljs language-bash" lang="bash">项目目录/
├── 📁 public/assets/doodle-modle/   <span class="hljs-comment"># 将训练生成的模型放置在public目录下</span>
│   │   ├── 📄 classes.json    <span class="hljs-comment"># 图片分类     </span>
│   │   ├── 📄 model.json      <span class="hljs-comment"># 模型描述文件</span>
│   │   └── 📄 weights.bin     <span class="hljs-comment"># 模型参数</span>
├── 📁 src   
│   ├── 📁 models/               
│   │   └── 📄 DoodleClassifier.js  <span class="hljs-comment"># 图片分类器</span>
│   ├── 📁 views/               
│   │   └── 📄 DoodleView.vue   <span class="hljs-comment"># 页面视图（canvas画布）</span>
</code></pre>
<p><strong>其中，DoodleClassifier.js的核心代码如下：</strong></p>
<ul>
<li>
<p>**loadModel：**加载模型，包括model.json、classes.json，在model.json中会自动加载weights.bin</p>
</li>
<li>
<p>**predictTopN：**输入图片数据，调用model.predict() 预测最有可能的TopN个分类结果，并按照置信度排序</p>
<p>import * as tf from "@tensorflow/tfjs";
import apiClient from "@/services/http";</p>
<p>// 加载模型
async loadModel(){
this.model = await tf.loadLayersModel("assets/doodle-model/model.json");
const response = await apiClient.get("assets/doodle-model/classes.json");
this.classes = response.data.classes;
}</p>
<p>// 预测最有可能的TopN个分类，并按照置信度排序
async predictTopN(data, n){
const predictions = Array.from(await this.model.predict(data).data());</p>
<p>const indexedPredictions = predictions.map((probability, index) =&gt; ({
probability,
index,
}));</p>
<p>indexedPredictions.sort((a, b) =&gt; b.probability - a.probability);</p>
<p>const topNPredictions = indexedPredictions.slice(0, n);</p>
<p>return topNPredictions.map((p) =&gt; ({
label: this.classes[p.index],
accuracy: p.probability,
}));
}</p>
<p>// 预测分类结果
async predict(data){
const argMax = await this.model.predict(data).argMax(-1).data();
returnthis.classes[argMax[0]];
}</p>
</li>
</ul>
<p><strong>DoodleView.vue的核心代码如下：</strong></p>
<ul>
<li>
<p>调用new DoodleClassifier()构造图片分类器</p>
</li>
<li>
<p>调用loadModel()加载模型</p>
</li>
<li>
<p>预处理canvas的图片数据</p>
</li>
<li>
<p>将预处理的数据传输给model.predictTopN()，预测图片分类</p>
<p>// 构造图片分类器
this.model = new DoodleClassifier()</p>
<p>// 加载模型
this.model.loadModel()</p>
<p>// 预处理canvas图片数据
const tensor = tf.browser.fromPixels(imgData, 1);
const resized = tf.image
.resizeBilinear(tensor, [28, 28])
.reshape([1, 28, 28, 1]) // Reshape to [1, 28, 28, 1] for batch and single channel
.toFloat();
const normalized = tf.scalar(1.0).sub(resized.div(tf.scalar(255.0)));</p>
<p>// 预测图片分类
this.model.predictTopN(normalized, 5).then((predictions) =&gt; {
if (predictions) {
this.predictions = predictions;
}
});</p>
</li>
</ul>
<p>到这为止，你画我猜-AI版就已经基本搭建完成了。实现起来并不复杂。</p>
<p>如果一切顺利，并且你按照我们提供的<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvivo%2FBlueSnippets%2Ftree%2Fmain%2Fdemos%2Fai-quickdraw%2Fquickdraw-app" target="_blank" title="https://github.com/vivo/BlueSnippets/tree/main/demos/ai-quickdraw/quickdraw-app" ref="nofollow noopener noreferrer">demo</a>构建页面，就可以直接在项目中运行：</p>
<pre><code class="hljs language-arduino" lang="arduino">npm run serve
</code></pre>
<p>一个简易版本的你画我猜AI版就运行成功了，试试看吧。</p>
<p><img src="https://static001.geekbang.org/infoq/2c/2c7b2070f587bec6c7ce03a58c21aaf2.jpeg" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-8">五、优化措施</h2>
<p>通过上面的步骤，我们完成了模型训练和canvas图片分类预测的全流程，成功实现了你画我猜AI版。但实际上可能会遇到两个比较关键的问题。</p>
<h3 data-id="heading-9">5.1 数据标准化</h3>
<p>当我们去调整canvas画布大小、画笔粗细后，可能会出现预测结果不准确的情况，此时从canvas获取的图像数据和我们喂给模型的训练数据产生了差异。</p>
<p>这时候我们需要在获取到canvas数据后，额外做一些数据预处理，将数据标准化，例如：</p>
<ul>
<li>
<p>将画布的内容区域裁剪为正方形，并居中显示</p>
</li>
<li>
<p>将画布的线条适当变粗，使模型更容易识别</p>
</li>
</ul>
<h3 data-id="heading-10">5.2 利用 webworker 优化性能</h3>
<p>模型的计算过程是十分耗时的，将计算过程放在主线程会导致页面卡顿，因此我们可以将整个模型的预测部分放入webworker中，以此来提升计算性能，不影响页面渲染。</p>
<h2 data-id="heading-11">六、总结</h2>
<p>你画我猜-端侧AI版是前端结合AI的一个简单案例，为我们提供了前端利用AI赋能的大致思路和基本实现逻辑。条件允许的情况下，我们可以利云端模型来拓展前端业务。但如果缺乏资源，我们则转而考虑使用端侧的特定领域模型来产出一些新玩法、新交互。相比之下，端侧AI具有更强的灵活性、安全性和更低的集成成本。大家可以试着在各自的业务中探索和使用端侧AI，或许无法产出太大的效益，但也是在全民AI时代下，一些积极的尝试和沉淀。</p>
<h2 data-id="heading-12">七、参考</h2>
<p>部分代码参考自：</p>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FRiccardoGai%2Fdoddle-classifier-model" target="_blank" title="https://github.com/RiccardoGai/doddle-classifier-model" ref="nofollow noopener noreferrer">Gihuthub | RiccardoGai | doddle-classifier-model</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FRiccardoGai%2Fdoddle-classifier-app" target="_blank" title="https://github.com/RiccardoGai/doddle-classifier-app" ref="nofollow noopener noreferrer">Gihuthub | RiccardoGai | doddle-classifier-app</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyining1023%2FdoodleNet%2Ftree%2Fmaster" target="_blank" title="https://github.com/yining1023/doodleNet/tree/master" ref="nofollow noopener noreferrer">Gihuthub |</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyining1023%2FdoodleNet%2Ftree%2Fmaster" target="_blank" title="https://github.com/yining1023/doodleNet/tree/master" ref="nofollow noopener noreferrer">yining1023 | doodleNet</a></p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀 共绩算力：3分钟拥有自己的图像优化服务-CodeFormer：先进的图像算法优化、修复马赛克、提升图片清晰度等]]></title>    <link>https://juejin.cn/post/7571743311520350217</link>    <guid>https://juejin.cn/post/7571743311520350217</guid>    <pubDate>2025-11-13T02:24:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571743311520350217" data-draft-id="7571729682678972466" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀 共绩算力：3分钟拥有自己的图像优化服务-CodeFormer：先进的图像算法优化、修复马赛克、提升图片清晰度等"/> <meta itemprop="keywords" content="前端,人工智能,AI编程"/> <meta itemprop="datePublished" content="2025-11-13T02:24:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀 共绩算力：3分钟拥有自己的图像优化服务-CodeFormer：先进的图像算法优化、修复马赛克、提升图片清晰度等
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T02:24:29.000Z" title="Thu Nov 13 2025 02:24:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">🌌 共绩算力是什么？</h3>
<p>当我们谈论“算力”，其实是在谈论人类与智能的沟通速度。<br/>
而 <strong>共绩算力</strong>，正是这场速度革命的引擎。</p>
<p>它不仅仅是一个 GPU 服务平台，更是 AI 开发者、科研团队与创新企业的“智作工坊”。<br/>
无论你是在训练大规模语言模型，还是在部署实时推理任务，共绩都能用灵活、高性能的算力，让创意落地的过程不再受限。</p>
<hr/>
<h3 data-id="heading-1">🧩 核心服务能力</h3>
<h4 data-id="heading-2">⚙️ 云主机：AI 开发者的超算伙伴</h4>
<p>（<strong>此处预留云主机图片区域</strong>）</p>
<p><strong>共绩科技云主机</strong> 面向 AI、科研与企业级场景，<br/>
提供 <strong>高性能 GPU 算力、极速部署体验</strong> 与 <strong>企业级安全保障</strong>。</p>
<p><strong>优势特性：</strong></p>
<ul>
<li>支持多种主流 GPU 型号，算力“随叫随到”；</li>
<li>一键创建实例，分钟级启动；</li>
<li>稳定网络与安全隔离机制，保障训练与推理过程高效可靠。</li>
</ul>
<blockquote>
<p>从模型训练到推理部署，你只需一次点击，其他交给共绩。</p>
</blockquote>
<hr/>
<h4 data-id="heading-3">🪄 弹性部署：算力像呼吸一样自然</h4>
<p>（<strong>此处预留弹性部署图片区域</strong>）</p>
<p>当模型训练进入高峰期，算力需求瞬间暴涨；而当实验结束，又不想被闲置资源“吃掉预算”——这时你需要的正是 <strong>共绩科技的弹性部署服务</strong>。</p>
<p><strong>我们提供：</strong></p>
<ul>
<li>⏱ 秒级扩缩容：实时响应算力需求变化；</li>
<li>💰 按需计费：让每一分算力都物有所值；</li>
<li>🔄 无缝扩展：训练高峰不再卡顿，推理低谷自动降载。</li>
</ul>
<blockquote>
<p>算力不浪费，性能还在线，科研效率轻盈如风。</p>
</blockquote>
<hr/>
<h4 data-id="heading-4">🔩 裸金属 GPU：为极限任务准备的硬核武器</h4>
<p>（<strong>此处预留裸金属图片区域</strong>）</p>
<p>面对复杂的 AI 模型训练、高性能计算（HPC）或核心业务场景，<br/>
<strong>共绩裸金属服务器</strong> 提供物理级别的算力体验——无虚拟化损耗、全硬件隔离、极致性能释放。</p>
<p><strong>你的收益：</strong></p>
<ul>
<li>100% 硬件性能占有；</li>
<li>专属 GPU 物理机隔离，安全无干扰；</li>
<li>满足金融级与科研级数据安全标准。</li>
</ul>
<blockquote>
<p>每一次训练，都是在物理性能的极限上奔跑。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">🔗 平台优势：多源融合，一站到位</h3>
<p>共绩整合多家算力资源供应商，通过标准化质检认证，确保每一台服务器都能稳定输出高性能计算力。</p>
<p>无论是 AI 模型训练、大数据分析，还是 HPC 应用，<br/>
<strong>“共绩”都能为你设计最优算力组合，让计算，更简单、更聪明。</strong></p>
<hr/>
<h4 data-id="heading-6">🧩 一、自建 AI 文生图的主要挑战</h4>
<ol>
<li>
<p><strong>环境配置地狱</strong></p>
<ul>
<li>不同操作系统、Python 版本、CUDA 驱动、PyTorch 依赖之间总有一对彼此“水火不容”。</li>
<li>一不小心版本错了半个小数点，控制台就变成红色圣经。</li>
</ul>
</li>
<li>
<p><strong>显卡资源吃紧</strong></p>
<ul>
<li>文生图任务通常需要 8GB~24GB 显存，而大多数普通电脑根本“喂不饱模型”。</li>
<li>你可能会一边看生成进度条，一边祈祷显存别炸。</li>
</ul>
</li>
<li>
<p><strong>网络与镜像速度</strong></p>
<ul>
<li>下载模型权重往往是“慢速折磨模式”，几GB的模型文件像乌龟爬。</li>
</ul>
</li>
<li>
<p><strong>安全与服务维护</strong></p>
<ul>
<li>自建WebUI服务需要自己配置访问权限、防止端口暴露、证书更新等问题。</li>
</ul>
</li>
</ol>
<hr/>
<h4 data-id="heading-7">🚀 二、3分钟拥有自己的图像优化服务-CodeFormer</h4>
<h5 data-id="heading-8">🧠 传统图像优化服务的六大难点</h5>
<hr/>
<h6 data-id="heading-9">1. 模糊不是一回事：降噪、去模糊与细节恢复的博弈 🎭</h6>
<p>传统方法（如双边滤波、非局部均值、锐化核卷积等）往往把清晰和噪声放在同一个天平上。</p>
<ul>
<li><strong>降噪太狠</strong> → 人像变成“蜡像”</li>
<li><strong>锐化太猛</strong> → 噪点变成“星空”</li>
</ul>
<p>底层原理上，这些算法只依赖像素邻域的统计特性，并不会理解人脸、纹理这些“结构语义”。<br/>
于是，“鼻孔”被误认成阴影，“头发丝”被当噪点清理掉了——这不是AI，只是数学的悲剧。</p>
<hr/>
<h6 data-id="heading-10">2. 像素修复的“盲人摸象”：缺乏语义理解 🧐</h6>
<p>多数传统优化方法根本<strong>不“懂”图片的内容</strong>。<br/>
它们只是根据局部信息修复像素，完全不知道“这是眼睛”还是“这是窗户”。</p>
<p>当局部像素缺失（比如马赛克、压缩块）时，这类算法只能根据邻近像素插值补全。<br/>
结果呢？修出一个歪脸，或者“幽灵眼神”。</p>
<p>这就像让不会画画的人靠猜想补完《蒙娜丽莎》的嘴角——注定辣眼睛。</p>
<hr/>
<h6 data-id="heading-11">3. 📏 算法通用性差：对不同类型图像“一招鲜吃不遍天”</h6>
<p>传统图像优化算法通常是<strong>手工调参的产物</strong>。<br/>
不同图像类型——比如扫描文档、人像、风景、插画——所需的滤波核权重和锐化强度完全不同。</p>
<blockquote>
<p>工程师心声：调个参数，要命三小时。<br/>
结果：对文档清晰了，对人脸崩坏了。</p>
</blockquote>
<p>缺乏端到端、自适应机制，是传统方法在多场景适配上最致命的短板。</p>
<hr/>
<h6 data-id="heading-12">4. 📶 计算效率与可扩展性</h6>
<p>很多传统算法（特别是基于数学最优化的）对资源要求高、并行性差。<br/>
例如：</p>
<ul>
<li>卷积核像素级扫描效率低；</li>
<li>多步迭代式去模糊算法（如Richardson-Lucy反卷积）耗时长；</li>
<li>一旦换更高分辨率图像，处理时间成倍暴涨。</li>
</ul>
<p>在Web环境下，这种“CPU风扇狂转，浏览器都吓跪”的情况非常常见。<br/>
而现代AIGC模型（如CodeFormer）可以用GPU和智能批处理，极大缓解了这一问题。</p>
<hr/>
<h6 data-id="heading-13">5. 🧩 多模态数据适配性差：无法兼容新式数据来源</h6>
<p>随着AIGC、Web3D、手机RAW格式数据爆发，现代图像的来源和编码方式越来越多样。<br/>
但传统优化服务往往：</p>
<ul>
<li>仅支持静态2D图像；</li>
<li>不理解深度图、法线图、透明通道；</li>
<li>无法与API或WebApp实时交互。</li>
</ul>
<p>这使得传统图像优化只能充当“离线工具”，难以嵌入到AIGC工作流或自动化平台中。</p>
<hr/>
<h6 data-id="heading-14">6. 📉 可解释性与质量评估困难</h6>
<p>传统优化的另一大痛点是——没有一套标准化的<strong>视觉质量评价机制</strong>。</p>
<p>指标如：</p>
<ul>
<li><strong>PSNR（信噪比）</strong> 过于理想化；</li>
<li><strong>SSIM（结构相似度）</strong> 忽略感知差异；</li>
<li><strong>人眼主观评价</strong> 又不可量化。</li>
</ul>
<p>因此，即使图像在数据指标上“更清晰”，肉眼看上去可能反而“更糊”。<br/>
人眼和数学的“审美观”常常互相看不顺眼。</p>
<hr/>
<h6 data-id="heading-15">📚 小结表格（给着急的你）</h6>








































<table><thead><tr><th>难点</th><th>技术症结</th><th>典型后果</th></tr></thead><tbody><tr><td>噪声与锐化权衡</td><td>滤波算法欠智能</td><td>面部细节丢失、伪影</td></tr><tr><td>缺乏语义理解</td><td>纯像素计算</td><td>修复形态错误</td></tr><tr><td>通用性差</td><td>无自适应参数</td><td>各场景表现不稳</td></tr><tr><td>效率瓶颈</td><td>迭代优化复杂</td><td>响应慢、无法实时</td></tr><tr><td>模态兼容差</td><td>接口与数据格式不统一</td><td>与Web/App生态脱节</td></tr><tr><td>评价标准不统一</td><td>感知度难量化</td><td>难以监控效果</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-16">🪄 CodeFormer等新一代服务的优势简述</h4>
<p>像 <strong>CodeFormer</strong> 这样的深度学习优化系统解决了上述痛点：</p>
<ul>
<li>✅ 利用 Transformer 结构理解<strong>全局语义</strong>（知道那是人脸还是背景）；</li>
<li>✅ 端到端训练可同时修复与增强；</li>
<li>✅ 支持 <strong>WebUI可视化 + API服务化集成</strong>；</li>
<li>✅ 高并发 GPU 推理，处理效率提升数十倍；</li>
<li>✅ 可自动根据图像内容调节修复与锐化程度——零参数暴力调试。</li>
</ul>
<hr/>
<h4 data-id="heading-17">实现流程</h4>
<h6 data-id="heading-18">1、打开共绩算力-弹性部署服务</h6>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5706e801681a49f5bf59f05328ccfdea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVvbkdhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763605468&amp;x-signature=5wLDIWLaTVVP%2FPWDAVbfO4Zl%2FI0%3D" alt="image.png" loading="lazy"/></p>
<h6 data-id="heading-19">2、下滑找到服务项、并滑动到底部部署服务</h6>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b43abb53eb34020a90be0968f605671~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVvbkdhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763605468&amp;x-signature=Tw3cTOyZpCzRfbvlyT9guJqz4%2BY%3D" alt="image.png" loading="lazy"/></p>
<h6 data-id="heading-20">3、等待部署完成，访问部署的webUi服务体验。也可以查看文档，集成api调用方式到项目中</h6>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3ea128c39d94005bbba4a78c75d6638~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVvbkdhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763605468&amp;x-signature=lfE8dA3BCJFZsqYVJlhxI0HZvYs%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-21">结果演示</h3>
<p>效果杠杠的</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34ce33f3f178480aa4dad809bb89d922~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVvbkdhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763605468&amp;x-signature=jtBpp7SCIQBYJEKTdVA6CDJUVvI%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-22">相关分享</h2>
<p><a href="https://juejin.cn/post/7569825640852357155" target="_blank" title="https://juejin.cn/post/7569825640852357155">共绩算力-热榜数据实战</a><br/>
<a href="https://juejin.cn/post/7570247858869043252" target="_blank" title="https://juejin.cn/post/7570247858869043252">共绩算力-文生图AI服务</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《拒绝重复代码！模板模式教你优雅复用算法骨架》]]></title>    <link>https://juejin.cn/post/7571648135586103339</link>    <guid>https://juejin.cn/post/7571648135586103339</guid>    <pubDate>2025-11-13T00:34:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571648135586103339" data-draft-id="7571402480966991908" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《拒绝重复代码！模板模式教你优雅复用算法骨架》"/> <meta itemprop="keywords" content="设计模式,后端"/> <meta itemprop="datePublished" content="2025-11-13T00:34:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="昨天的猫"/> <meta itemprop="url" content="https://juejin.cn/user/563421030396568"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《拒绝重复代码！模板模式教你优雅复用算法骨架》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/563421030396568/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    昨天的猫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T00:34:56.000Z" title="Thu Nov 13 2025 00:34:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">今天我们来学习下模板模式，以及在项目中的应用</h2>
<h3 data-id="heading-1">01 模板模式简介</h3>
<p>模板模式（Template Pattern）是一种行为设计模式，它定义了一个操作中的<code>算法骨架</code>，将某些步骤延迟到子类中实现。模板模式使得子类可以不改变算法结构的情况下，重新定义算法中的某些特定步骤。</p>
<blockquote>
<p>主要角色</p>
<ul>
<li><strong>抽象类（Abstract Class）</strong> ：定义算法骨架和抽象操作</li>
<li><strong>具体类（Concrete Class）</strong> ：实现抽象类中的抽象操作</li>
</ul>
</blockquote>
<h3 data-id="heading-2">02 基础代码实现</h3>
<p>以泡茶为例，整个流程可以简化为三个步骤 烧开水、放茶叶、倒入开水，我们将放茶叶定义为可变的部分，比如有人喜欢绿茶、有人喜欢红茶、有人喜欢玫瑰花茶。</p>
<p>首先，创建一个抽象模板，定义泡茶方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@description</span> 泡茶抽象模板
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractMakeTeaTemplate</span> {

    <span class="hljs-comment">/**
     * 泡茶
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">makeTea</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 1. 烧开水</span>
        boilWater();
        <span class="hljs-comment">// 2. 放入茶叶</span>
        putTea();
        <span class="hljs-comment">// 3. 加入水</span>
        addWater();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">boilWater</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"烧开水"</span>);
    }

    <span class="hljs-comment">/**
     * 放入茶叶
     */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">putTea</span><span class="hljs-params">()</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addWater</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"加入水"</span>);
    }
}
</code></pre>
<p>makeTea() 方法就是泡茶方法，烧开水、添加开水是必需的步骤，唯有放入茶叶是可变的，下面我们分别实现使用不同茶叶泡茶的业务。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@description</span> 绿茶
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GreenTea</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMakeTeaTemplate</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">putTea</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"放入龙井茶叶"</span>);
    }
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@description</span> 红茶
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedTea</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMakeTeaTemplate</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">putTea</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"放入普尔茶叶"</span>);
    }
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@description</span> 玫瑰茶
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RoseTea</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMakeTeaTemplate</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">putTea</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"放入玫瑰花茶叶"</span>);
    }
}
</code></pre>
<p>使用main方法测试下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    <span class="hljs-comment">// 1. 制作绿茶</span>
    <span class="hljs-type">AbstractMakeTeaTemplate</span> <span class="hljs-variable">greenTea</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GreenTea</span>();
    greenTea.makeTea();
}
</code></pre>
<p>输出结果如下：</p>
<pre><code class="hljs">烧开水
放入绿茶
加入水
</code></pre>
<p>由此，我们通过模板方式，封装了一个泡茶的流程，但对于其中可变的部分放到子类去实现。后续如果有新业务到来，比如要泡其他茶叶，只需要实现泡茶模板，重写茶叶相关的方法即可。</p>
<h3 data-id="heading-3">03 项目实战</h3>
<p>以上只是一个简单的小demo，真实业务中很少会有泡茶的情况。项目实战中我们以数据导出为例，看下导出模板的设计和实现（数据导出借助easy-excel完成）。
首先定义导出流程：参数校验-》读取数据-》导出-》导出后逻辑处理
<br/></p>
<h4 data-id="heading-4">抽象模板：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@description</span> 数据导出模板
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractExportTemplate</span>&lt;P, T&gt; {

    <span class="hljs-comment">/**
     * 导出数据
     * &lt;p&gt;声明为final类型，防止子类重写，确保导出流程的一致性&lt;/p&gt;
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">export</span><span class="hljs-params">(BaseExportParam&lt;P&gt; baseExportParam)</span> {
        <span class="hljs-comment">// 1. 校验参数</span>
        validateParams(baseExportParam.getParams());
        <span class="hljs-comment">// 2. 读取数据</span>
        List&lt;T&gt; data = readData(baseExportParam.getParams());
        <span class="hljs-comment">// 3. 导出数据</span>
        doExport(baseExportParam, data);
        <span class="hljs-comment">// 4. 导出完成后处理</span>
        afterExport();
    }

    <span class="hljs-comment">/**
     * 获取导出实体的Class对象
     * &lt;p&gt;子类必须实现此方法提供具体的实体类型&lt;/p&gt;
     */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> Class&lt;T&gt; <span class="hljs-title function_">getEntityClass</span><span class="hljs-params">()</span>;

    <span class="hljs-comment">/**
     * 读取数据
     * &lt;p&gt;声明为abstract类型，强制要求子类实现，确保数据读取的一致性&lt;/p&gt;
     */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> List&lt;T&gt; <span class="hljs-title function_">readData</span><span class="hljs-params">(P params)</span>;

    <span class="hljs-comment">/**
     * 校验参数
     * &lt;p&gt;子类根据自身业务情况，看是否需要进行参数校验&lt;/p&gt;
     */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validateParams</span><span class="hljs-params">(P params)</span> {
    }

    <span class="hljs-comment">/**
     * 导出数据
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doExport</span><span class="hljs-params">(BaseExportParam&lt;P&gt; baseExportParam, List&lt;T&gt; data)</span> {
        <span class="hljs-type">HttpServletResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> baseExportParam.getResponse();
        response.setContentType(<span class="hljs-string">"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"</span>);
        response.setCharacterEncoding(<span class="hljs-string">"utf-8"</span>);
        <span class="hljs-comment">// 这里URLEncoder.encode可以防止中文乱码</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> URLEncoder.encode(baseExportParam.getFileName() + <span class="hljs-string">"_"</span> + System.currentTimeMillis(), StandardCharsets.UTF_8);
        response.setHeader(<span class="hljs-string">"Content-disposition"</span>, <span class="hljs-string">"attachment;filename="</span> + fileName + <span class="hljs-string">".xlsx"</span>);

        <span class="hljs-keyword">try</span> {
            EasyExcelFactory.write(response.getOutputStream(), getEntityClass())
                    .sheet(baseExportParam.getFileName())
                    .doWrite(data);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"导出数据失败"</span>, e);
        }
    }

    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterExport</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 导出完成后处理逻辑（可空）</span>
    }
}
</code></pre>
<h4 data-id="heading-5">模板入参基类：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@description</span> 导出基类
 */</span>
<span class="hljs-meta">@Getter</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseExportParam</span>&lt;P&gt; {

    <span class="hljs-comment">/**
     * 导出参数
     */</span>
    <span class="hljs-keyword">protected</span> P params;
    <span class="hljs-comment">/**
     * 导出文件名
     */</span>
    <span class="hljs-keyword">protected</span> String fileName;
    <span class="hljs-comment">/**
     * 导出响应
     */</span>
    <span class="hljs-keyword">protected</span> HttpServletResponse response;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BaseExportParam</span><span class="hljs-params">(P params, String fileName, HttpServletResponse response)</span> {
        <span class="hljs-built_in">this</span>.params = params;
        <span class="hljs-built_in">this</span>.fileName = fileName;
        <span class="hljs-built_in">this</span>.response = response;
    }
}
</code></pre>
<p>可以看到导出的流程方法是export，默认添加了final修饰，防止子类重写从而改变导出流程定义。真正执行的导出的方法是doExport。子类需要实现getEntityClass、readData方法，另外两个方法（validateParams、afterExport）模板类已经做了默认实现，子类视情况选择是否实现。</p>
<h4 data-id="heading-6">用户导出</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@description</span> 用户导出查询参数
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserQo</span> {
    <span class="hljs-comment">/**
     * 用户id
     */</span>
    <span class="hljs-keyword">private</span> Long id;
     <span class="hljs-comment">/**
     * 用户名
     */</span>
    <span class="hljs-keyword">private</span> String name;
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@description</span> 用户导出VO
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserVo</span> {
    <span class="hljs-meta">@ExcelProperty("用户id")</span>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-meta">@ExcelProperty("用户名")</span>
    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-meta">@ExcelProperty("手机号")</span>
    <span class="hljs-keyword">private</span> String phone;
}
</code></pre>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">/**
 * @description 用户导出业务类
 */</span>
<span class="hljs-meta">@Component</span>
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserExportService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractExportTemplate&lt;UserQo</span>, <span class="hljs-title">UserVo&gt;</span> </span>{
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">Class</span>&lt;<span class="hljs-type">UserVo</span>&gt; getEntityClass() {
        <span class="hljs-keyword">return</span> <span class="hljs-type">UserVo</span>.<span class="hljs-keyword">class</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">List</span>&lt;<span class="hljs-type">UserVo</span>&gt; readData(<span class="hljs-type">UserQo</span> params) {
        <span class="hljs-comment">// 1. 模拟从数据库查询用户数据</span>
        <span class="hljs-type">UserVo</span> userVo = <span class="hljs-keyword">new</span> <span class="hljs-type">UserVo</span>();
        userVo.setId(params.getId());
        userVo.setUsername(<span class="hljs-string">"zhangsan"</span>);
        userVo.setPhone(<span class="hljs-string">"13800000000"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-type">List</span>.of(userVo);
    }
}
</code></pre>
<p>用户导出service添加了@Component注解，正常情况导出数据从数据库中查询而来，所以真实业务中需要将模拟数据改为从数据库查询即可。
<br/>
我们写个测试类来试下:</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@RestController</span>
<span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">"/template"</span>)
public class TemplateController {

    <span class="hljs-variable">@Resource</span>
    private UserExportService userExportService;

    <span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">"/user"</span>)
    public void <span class="hljs-built_in">export</span>(UserQo params, HttpServletResponse response) {
        <span class="hljs-comment">// 1. 导出用户数据</span>
        <span class="hljs-selector-tag">userExportService</span><span class="hljs-selector-class">.export</span>(new <span class="hljs-built_in">BaseExportParam</span>(params, <span class="hljs-string">"user-info"</span>, response));
    }
}
</code></pre>
<p>结果：可以正常导出excel。
<br/></p>
<blockquote>
<p>如果有新的业务也需要导出，我们只需要实现导出模板即可，比如城市信息，代码如下：</p>
</blockquote>
<h4 data-id="heading-7">城市信息</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@description</span> 城市导出查询参数
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CityQo</span> {
    <span class="hljs-comment">/**
     * 城市id
     */</span>
    <span class="hljs-keyword">private</span> Long id;
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@description</span> 城市信息导出VO
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CityVo</span> {
    <span class="hljs-meta">@ExcelProperty("城市id")</span>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-meta">@ExcelProperty("城市名称")</span>
    <span class="hljs-keyword">private</span> String cityName;
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@description</span> 城市导出业务类
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CityExportService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractExportTemplate</span>&lt;CityQo, CityVo&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> Class&lt;CityVo&gt; <span class="hljs-title function_">getEntityClass</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> CityVo.class;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> List&lt;CityVo&gt; <span class="hljs-title function_">readData</span><span class="hljs-params">(CityQo params)</span> {
        <span class="hljs-comment">// 1. 模拟从数据库查询城市数据</span>
        <span class="hljs-type">CityVo</span> <span class="hljs-variable">cityVo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CityVo</span>();
        cityVo.setId(params.getId());
        cityVo.setCityName(<span class="hljs-string">"beijing"</span>);
        <span class="hljs-keyword">return</span> List.of(cityVo);
    }
}
</code></pre>
<p>新增一个测试方法试试：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/template")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TemplateController</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> UserExportService userExportService;
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> CityExportService cityExportService;

    <span class="hljs-meta">@GetMapping("/user")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">export</span><span class="hljs-params">(UserQo params, HttpServletResponse response)</span> {
        <span class="hljs-comment">// 1. 导出用户数据</span>
        userExportService.export(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseExportParam</span>(params, <span class="hljs-string">"user-info"</span>, response));
    }

    <span class="hljs-meta">@GetMapping("/city")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exportCity</span><span class="hljs-params">(CityQo params, HttpServletResponse response)</span> {
        <span class="hljs-comment">// 1. 导出城市数据</span>
        cityExportService.export(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseExportParam</span>(params, <span class="hljs-string">"city-info"</span>, response));
    }
}
</code></pre>
<p>导出功能完全OK😀😀😀😀</p>
<h3 data-id="heading-8">模式优势</h3>
<ol>
<li><strong>代码复用</strong>：将公共代码放在抽象类中，避免代码重复</li>
<li><strong>扩展性好</strong>：通过子类扩展新的实现，符合开闭原则</li>
<li><strong>便于维护</strong>：算法结构固定，修改只需要在特定位置进行</li>
<li><strong>控制反转</strong>：父类控制整体流程，子类实现具体细节</li>
</ol>
<h3 data-id="heading-9">适用场景</h3>
<ol>
<li>多个类有相同的方法，但具体实现不同</li>
<li>需要控制子类的扩展，只允许扩展特定步骤</li>
<li>重要复杂的算法，需要分解为多个步骤</li>
<li>框架设计，定义流程骨架，让用户实现具体步骤</li>
</ol>
<h3 data-id="heading-10">注意事项</h3>
<ol>
<li>模板方法应该声明为final，防止子类重写算法骨架</li>
<li>合理使用钩子方法，提供灵活的扩展点</li>
<li>避免过多的抽象方法，会增加子类的实现负担</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[学而时习之：C++中的枚举]]></title>    <link>https://juejin.cn/post/7571729676343918655</link>    <guid>https://juejin.cn/post/7571729676343918655</guid>    <pubDate>2025-11-13T02:08:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571729676343918655" data-draft-id="7571729682679513138" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="学而时习之：C++中的枚举"/> <meta itemprop="keywords" content="C++"/> <meta itemprop="datePublished" content="2025-11-13T02:08:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="煤球王子"/> <meta itemprop="url" content="https://juejin.cn/user/4088439235949739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            学而时习之：C++中的枚举
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4088439235949739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    煤球王子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T02:08:02.000Z" title="Thu Nov 13 2025 02:08:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>C++ 中的枚举</strong></h2>
<p>在 C++ 中，枚举是一种用户定义的数据类型，它由一组命名的整型常量组成。</p>
<p>它有助于为整数值赋予有意义的名称，从而提高代码的可读性和可维护性。
当我们有一个可能值数量较少的集合（例如方向、星期几等）时，它尤其有用。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-comment">// 定义枚举</span>
<span class="hljs-keyword">enum</span> <span class="hljs-title class_">direction</span>
{
    EAST,  <span class="hljs-comment">// 东</span>
    NORTH, <span class="hljs-comment">// 北</span>
    WEST,  <span class="hljs-comment">// 西</span>
    SOUTH  <span class="hljs-comment">// 南</span>
};

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-comment">// 创建枚举变量</span>
    direction dir = NORTH;

    cout &lt;&lt; dir;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<pre><code class="hljs">1
</code></pre>
<h3 data-id="heading-1">1.创建枚举类型</h3>
<p>在创建枚举类型的变量之前，我们必须先定义这个枚举类型。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">enum_name</span> { 
    name1, name2, name3, ... 
};
</code></pre>
<p>其中 <code>name1</code>、<code>name2</code>、… 是命名常量，必须是唯一的标识符。<br/>
默认情况下，枚举中的第一个名称被赋予整数值 0，后面的名称依次递增 1。</p>
<p>然后，我们就可以创建该枚举类型的变量，并把枚举中定义的某个命名常量赋给它：</p>
<pre><code class="hljs language-cpp" lang="cpp">enum_name var;
</code></pre>
<h3 data-id="heading-2">2.修改命名常量的值</h3>
<p>如果需要，我们也可以手动给枚举成员赋值：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">enum_name</span> { 
    name1 = val1, name2 = val2, name3, ... 
};
</code></pre>
<p><code>val1</code>、<code>val2</code> … 必须是整数。<br/>
不需要给所有命名常量都指定值；如果当前命名常量的值是 x，那么后续的值会依次递增 1。</p>
<p>示例代码：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-comment">// 定义枚举</span>
<span class="hljs-keyword">enum</span> <span class="hljs-title class_">fruit</span>
{
    APPLE,      <span class="hljs-comment">// 默认 0</span>
    BANANA = <span class="hljs-number">5</span>, <span class="hljs-comment">// 手动设为 5</span>
    ORANGE      <span class="hljs-comment">// 自动为 6</span>
};

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-comment">// 创建枚举变量</span>
    fruit f = BANANA;
    cout &lt;&lt; f &lt;&lt; endl;  <span class="hljs-comment">// 输出 5</span>

    <span class="hljs-comment">// 改变值</span>
    f = ORANGE;
    cout &lt;&lt; f;          <span class="hljs-comment">// 输出 6</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<pre><code class="hljs">5
6
</code></pre>
<p>枚举类（Enum Classes）<br/>
C++11 引入了 <strong>enum class</strong>，提供了更强的类型安全性。它通过给常量名增加作用域来解决命名冲突，同时也要求 <strong>手动强制类型转换</strong> 才能将枚举值转为整数。</p>
<h3 data-id="heading-3">3.创建枚举类</h3>
<p>只需在普通 enum 声明前加上关键字 <strong>class</strong> 即可：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">enum class</span> <span class="hljs-title class_">Day</span>
{
    Sunday = <span class="hljs-number">1</span>,
    Monday,
    Tuesday,
    Wednesday,
    Thursday,
    Friday,
    Saturday
};
</code></pre>
<p>使用示例：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-comment">// 定义枚举类</span>
<span class="hljs-keyword">enum class</span> <span class="hljs-title class_">Day</span>
{
    Sunday = <span class="hljs-number">1</span>,
    Monday,
    Tuesday,
    Wednesday,
    Thursday,
    Friday,
    Saturday
};

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-comment">// 初始化</span>
    Day today = Day::Thursday;

    <span class="hljs-comment">// 打印枚举值（需强制类型转换）</span>
    cout &lt;&lt; <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(today);  <span class="hljs-comment">// 输出 5</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>错误示例：<br/>
如果直接写常量名而不加作用域，编译器会报错：</p>
<pre><code class="hljs language-cpp" lang="cpp">Day today = Thursday;  <span class="hljs-comment">// ❌ 错误</span>
</code></pre>
<p><strong>编译错误信息：</strong></p>
<pre><code class="hljs language-sql" lang="sql">main.cpp: <span class="hljs-keyword">In</span> <span class="hljs-keyword">function</span> ‘<span class="hljs-type">int</span> main()’:
main.cpp:<span class="hljs-number">12</span>:<span class="hljs-number">17</span>: error: ‘Thursday’ was <span class="hljs-keyword">not</span> declared <span class="hljs-keyword">in</span> this <span class="hljs-keyword">scope</span>; did you mean ‘<span class="hljs-keyword">Day</span>::Thursday’?
   <span class="hljs-number">12</span> <span class="hljs-operator">|</span>     <span class="hljs-keyword">Day</span> today <span class="hljs-operator">=</span> Thursday;
      <span class="hljs-operator">|</span>                 <span class="hljs-operator">^</span><span class="hljs-operator">~</span><span class="hljs-operator">~</span><span class="hljs-operator">~</span><span class="hljs-operator">~</span><span class="hljs-operator">~</span><span class="hljs-operator">~</span><span class="hljs-operator">~</span>
      <span class="hljs-operator">|</span>                 <span class="hljs-keyword">Day</span>::Thursday
main.cpp:<span class="hljs-number">6</span>:<span class="hljs-number">28</span>: note: ‘<span class="hljs-keyword">Day</span>::Thursday’ declared here
    <span class="hljs-number">6</span> <span class="hljs-operator">|</span>                 Wednesday, Thursday, Friday,
      <span class="hljs-operator">|</span>                            <span class="hljs-operator">^</span><span class="hljs-operator">~</span><span class="hljs-operator">~</span><span class="hljs-operator">~</span><span class="hljs-operator">~</span><span class="hljs-operator">~</span><span class="hljs-operator">~</span><span class="hljs-operator">~</span>
</code></pre>
<p>总结：</p>
<ul>
<li>使用 <code>enum class</code> 可以避免命名冲突。</li>
<li>枚举值必须通过 <code>EnumName::Value</code> 的形式访问。</li>
<li>转换为整数时需要使用 <code>static_cast&lt;int&gt;(...)</code>。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[NocoBase 本周更新汇总：优化及缺陷修复]]></title>    <link>https://juejin.cn/post/7571726099689685011</link>    <guid>https://juejin.cn/post/7571726099689685011</guid>    <pubDate>2025-11-13T03:18:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571726099689685011" data-draft-id="7571726099689668627" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="NocoBase 本周更新汇总：优化及缺陷修复"/> <meta itemprop="keywords" content="开源,资讯,低代码"/> <meta itemprop="datePublished" content="2025-11-13T03:18:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="NocoBase"/> <meta itemprop="url" content="https://juejin.cn/user/180779873743566"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            NocoBase 本周更新汇总：优化及缺陷修复
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/180779873743566/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    NocoBase
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T03:18:07.000Z" title="Thu Nov 13 2025 03:18:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>原文链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fweekly-updates-20251113" target="_blank" title="https://www.nocobase.com/cn/blog/weekly-updates-20251113" ref="nofollow noopener noreferrer">www.nocobase.com/cn/blog/wee…</a></p>
<p>汇总一周产品更新日志，最新发布可以<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Ftimeline" target="_blank" title="https://www.nocobase.com/cn/blog/timeline" ref="nofollow noopener noreferrer">前往我们的博客查看</a>。</p>
<p><strong>NocoBase 目前更新包括的版本更新包括三个分支：<code>main</code> ，<code>next</code>和 <code>develop</code>。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed1ee51ad5f644db988e99b36b5e2385~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTm9jb0Jhc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763608687&amp;x-signature=jDFPoduo6kK3yOqpVrkrpABp0%2F8%3D" alt="version.png" loading="lazy"/></p>
<p><code>main</code> ：截止目前最稳定的版本，推荐安装此版本。</p>
<p><code>next</code>：包含即将发布的新功能，经过初步测试的版本，可能存在部分已知或未知问题。主要面向测试用户，用于收集反馈和进一步优化功能。适合愿意提前体验新功能并提供反馈的测试用户。</p>
<p><code>develop</code>：开发中的版本，包含最新的功能代码，可能尚未完成或存在较多不稳定因素，主要用于内部开发和快速迭代。适合对产品功能前沿发展感兴趣的技术用户，但可能存在较多问题或不完整功能，不建议在生产环境中使用。</p>
<h2 data-id="heading-0">main</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d633a58f233142449a9998317877ce06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTm9jb0Jhc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763608687&amp;x-signature=pOlyTTwI6OhHH8edoT6dGutlwIo%3D" alt="main.png" loading="lazy"/></p>
<h3 data-id="heading-1"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fv1.9.6" target="_blank" title="https://www.nocobase.com/cn/blog/v1.9.6" ref="nofollow noopener noreferrer">v1.9.6</a></h3>
<p><em>发布时间：2025-11-12</em></p>
<h3 data-id="heading-2">🐛 修复</h3>
<ul>
<li><strong>[client]</strong> 修复拖拽引用模板后再删除引用模板而导致的复制模板不显示的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7847" target="_blank" title="https://github.com/nocobase/nocobase/pull/7847" ref="nofollow noopener noreferrer">#7847</a>) by @zhangzhonghe</li>
<li><strong>[utils]</strong> 为 intersect 策略增加对象类型支持 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7840" target="_blank" title="https://github.com/nocobase/nocobase/pull/7840" ref="nofollow noopener noreferrer">#7840</a>) by @chenos</li>
<li><strong>[数据可视化：EChrats]</strong> 修复 ECharts 选项配置 labelType 不生效的问题 by @heziqiang</li>
<li><strong>[邮件管理]</strong> 没有时间戳的情况下同步微软邮件已读状态 by @jiannx</li>
</ul>
<h3 data-id="heading-3"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fv1.9.5" target="_blank" title="https://www.nocobase.com/cn/blog/v1.9.5" ref="nofollow noopener noreferrer">v1.9.5</a></h3>
<p><em>发布时间：2025-11-10</em></p>
<h3 data-id="heading-4">🐛 修复</h3>
<ul>
<li><strong>[工作流：审批]</strong> 修复重查关系数据时未屏蔽主表字段的问题 by @mytharcher</li>
<li><strong>[邮件管理]</strong> 修复 Outlook 内敛图片和同步问题 by @jiannx</li>
</ul>
<h3 data-id="heading-5"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fv1.9.4" target="_blank" title="https://www.nocobase.com/cn/blog/v1.9.4" ref="nofollow noopener noreferrer">v1.9.4</a></h3>
<p><em>发布时间：2025-11-10</em></p>
<h3 data-id="heading-6">🚀 优化</h3>
<ul>
<li><strong>[权限控制]</strong> 优化关系字段关联操作的权限控制逻辑 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7800" target="_blank" title="https://github.com/nocobase/nocobase/pull/7800" ref="nofollow noopener noreferrer">#7800</a>) by @2013xile</li>
<li><strong>[工作流：JavaScript 节点]</strong> 修复传递到执行环境中的上层函数导致的安全漏洞，避免通过利用漏洞访问上层执行环境的问题 by @mytharcher</li>
<li><strong>[认证：OIDC]</strong> 增加请求超时时间 by @2013xile</li>
</ul>
<h3 data-id="heading-7">🐛 修复</h3>
<ul>
<li>
<p><strong>[server]</strong> 修复消息队列在启用服务拆分模式后，工作进程发消息导致报错的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7797" target="_blank" title="https://github.com/nocobase/nocobase/pull/7797" ref="nofollow noopener noreferrer">#7797</a>) by @mytharcher</p>
</li>
<li>
<p><strong>[client]</strong> 修复详情区块简单分页出现空数据下一页的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7784" target="_blank" title="https://github.com/nocobase/nocobase/pull/7784" ref="nofollow noopener noreferrer">#7784</a>) by @katherinehhh</p>
</li>
<li>
<p><strong>[工作流]</strong></p>
<ul>
<li>为工作流的日志增加 <code>workflowId</code> 的数据标识 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7789" target="_blank" title="https://github.com/nocobase/nocobase/pull/7789" ref="nofollow noopener noreferrer">#7789</a>) by @mytharcher</li>
<li>修复服务拆分模式下，工作流插件不处于服务模式时仍然消费队列的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7820" target="_blank" title="https://github.com/nocobase/nocobase/pull/7820" ref="nofollow noopener noreferrer">#7820</a>) by @mytharcher</li>
</ul>
</li>
<li>
<p><strong>[用户]</strong> 字段名为 snake_case 风格时，索引字段重置不正确的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7785" target="_blank" title="https://github.com/nocobase/nocobase/pull/7785" ref="nofollow noopener noreferrer">#7785</a>) by @2013xile</p>
</li>
<li>
<p><strong>[工作流：自定义变量节点]</strong> 修复变量节点缺失 config 时报错的问题 by @mytharcher</p>
</li>
</ul>
<h2 data-id="heading-8">develop</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74becc056007440b9fc4a4f10a13aad8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTm9jb0Jhc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763608687&amp;x-signature=l2JjoXH7jprpdddeRCuOkpQ7H%2BQ%3D" alt="develop.png" loading="lazy"/></p>
<h3 data-id="heading-9"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fv2.0.0-alpha.38" target="_blank" title="https://www.nocobase.com/cn/blog/v2.0.0-alpha.38" ref="nofollow noopener noreferrer">v2.0.0-alpha.38</a></h3>
<p><em>发布时间：2025-11-12</em></p>
<h3 data-id="heading-10">🎉 新特性</h3>
<ul>
<li><strong>[client]</strong> 支持表格列操作的拖动 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7842" target="_blank" title="https://github.com/nocobase/nocobase/pull/7842" ref="nofollow noopener noreferrer">#7842</a>) by @zhangzhonghe</li>
<li><strong>[数据可视化]</strong> 新增图表 SQL 数据源 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7830" target="_blank" title="https://github.com/nocobase/nocobase/pull/7830" ref="nofollow noopener noreferrer">#7830</a>) by @heziqiang</li>
</ul>
<h3 data-id="heading-11">🚀 优化</h3>
<ul>
<li><strong>[client]</strong> 在 RunJS 脚本上下文中新增对 Day.js 库的支持，便于进行日期和时间的操作。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7841" target="_blank" title="https://github.com/nocobase/nocobase/pull/7841" ref="nofollow noopener noreferrer">#7841</a>) by @gchust</li>
</ul>
<h3 data-id="heading-12">🐛 修复</h3>
<ul>
<li>
<p><strong>[utils]</strong></p>
<ul>
<li>修复筛选按钮报错 “Invalid filter item type”  (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7838" target="_blank" title="https://github.com/nocobase/nocobase/pull/7838" ref="nofollow noopener noreferrer">#7838</a>) by @zhangzhonghe</li>
<li>为 intersect 策略增加对象类型支持 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7840" target="_blank" title="https://github.com/nocobase/nocobase/pull/7840" ref="nofollow noopener noreferrer">#7840</a>) by @chenos</li>
<li>修复事件流报 “Unrecognized operation” 的错误 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7835" target="_blank" title="https://github.com/nocobase/nocobase/pull/7835" ref="nofollow noopener noreferrer">#7835</a>) by @zhangzhonghe</li>
</ul>
</li>
<li>
<p><strong>[client]</strong></p>
<ul>
<li>修复了表格中行记录数据更新后，行操作按钮的联动规则未重新执行的问题，现在在数据变更时联动规则能够正确重新应用。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7832" target="_blank" title="https://github.com/nocobase/nocobase/pull/7832" ref="nofollow noopener noreferrer">#7832</a>) by @gchust</li>
<li>修复代码编辑器中预览代码时如果使用了 jsx 语法会报错的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7836" target="_blank" title="https://github.com/nocobase/nocobase/pull/7836" ref="nofollow noopener noreferrer">#7836</a>) by @gchust</li>
</ul>
</li>
<li>
<p><strong>[undefined]</strong> 修复暗黑模式下的插件文档首页样式不正确的问题。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7839" target="_blank" title="https://github.com/nocobase/nocobase/pull/7839" ref="nofollow noopener noreferrer">#7839</a>) by @gchust</p>
</li>
<li>
<p><strong>[文件管理器]</strong> 修复表格区块配置字段相关缺陷 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7843" target="_blank" title="https://github.com/nocobase/nocobase/pull/7843" ref="nofollow noopener noreferrer">#7843</a>) by @katherinehhh</p>
</li>
<li>
<p><strong>[AI 员工]</strong> 在 v1 页面隐藏 AI 员工对话按钮 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7829" target="_blank" title="https://github.com/nocobase/nocobase/pull/7829" ref="nofollow noopener noreferrer">#7829</a>) by @cgyrock</p>
</li>
<li>
<p><strong>[数据可视化：EChrats]</strong> 修复 ECharts 选项配置 labelType 不生效的问题 by @heziqiang</p>
</li>
<li>
<p><strong>[邮件管理]</strong></p>
<ul>
<li>修复草稿问题 by @jiannx</li>
<li>没有时间戳的情况下同步微软邮件已读状态 by @jiannx</li>
</ul>
</li>
</ul>
<h3 data-id="heading-13"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fv2.0.0-alpha.37" target="_blank" title="https://www.nocobase.com/cn/blog/v2.0.0-alpha.37" ref="nofollow noopener noreferrer">v2.0.0-alpha.37</a></h3>
<p><em>发布时间：2025-11-11</em></p>
<h3 data-id="heading-14">🚀 优化</h3>
<ul>
<li>
<p><strong>[client]</strong></p>
<ul>
<li>新增页面版本到 flow engine 上下文里 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7826" target="_blank" title="https://github.com/nocobase/nocobase/pull/7826" ref="nofollow noopener noreferrer">#7826</a>) by @gchust</li>
<li>优化 Markdown 编辑器 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7793" target="_blank" title="https://github.com/nocobase/nocobase/pull/7793" ref="nofollow noopener noreferrer">#7793</a>) by @katherinehhh</li>
<li>2.0 区块适配 tableoid 字段 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7809" target="_blank" title="https://github.com/nocobase/nocobase/pull/7809" ref="nofollow noopener noreferrer">#7809</a>) by @katherinehhh</li>
</ul>
</li>
<li>
<p><strong>[数据可视化]</strong> 更新图表提示栏和事件代码模板注释 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7814" target="_blank" title="https://github.com/nocobase/nocobase/pull/7814" ref="nofollow noopener noreferrer">#7814</a>) by @heziqiang</p>
</li>
<li>
<p><strong>[权限控制]</strong> 优化关系字段关联操作的权限控制逻辑 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7800" target="_blank" title="https://github.com/nocobase/nocobase/pull/7800" ref="nofollow noopener noreferrer">#7800</a>) by @2013xile</p>
</li>
<li>
<p><strong>[认证：OIDC]</strong> 增加请求超时时间 by @2013xile</p>
</li>
</ul>
<h3 data-id="heading-15">🐛 修复</h3>
<ul>
<li>
<p><strong>[server]</strong> 修复消息队列在启用服务拆分模式后，工作进程发消息导致报错的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7797" target="_blank" title="https://github.com/nocobase/nocobase/pull/7797" ref="nofollow noopener noreferrer">#7797</a>) by @mytharcher</p>
</li>
<li>
<p><strong>[client]</strong></p>
<ul>
<li>当前数据表变量不应该可以从筛选组件的变量选择器中被选择 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7818" target="_blank" title="https://github.com/nocobase/nocobase/pull/7818" ref="nofollow noopener noreferrer">#7818</a>) by @gchust</li>
<li>修复筛选表单关系字段报错 “value.replace is not a function” (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7824" target="_blank" title="https://github.com/nocobase/nocobase/pull/7824" ref="nofollow noopener noreferrer">#7824</a>) by @zhangzhonghe</li>
<li>修复 onChange 回调传参错误 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7807" target="_blank" title="https://github.com/nocobase/nocobase/pull/7807" ref="nofollow noopener noreferrer">#7807</a>) by @zhangzhonghe</li>
</ul>
</li>
<li>
<p><strong>[flow-engine]</strong> 修复事件流修改后需要刷新页面才会生效的问题。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7811" target="_blank" title="https://github.com/nocobase/nocobase/pull/7811" ref="nofollow noopener noreferrer">#7811</a>) by @gchust</p>
</li>
<li>
<p><strong>[工作流]</strong> 修复服务拆分模式下，工作流插件不处于服务模式时仍然消费队列的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7820" target="_blank" title="https://github.com/nocobase/nocobase/pull/7820" ref="nofollow noopener noreferrer">#7820</a>) by @mytharcher</p>
</li>
<li>
<p><strong>[工作流：审批]</strong> 修复重查关系数据时未屏蔽主表字段的问题 by @mytharcher</p>
</li>
<li>
<p><strong>[邮件管理]</strong> 修复 Outlook 内敛图片和同步问题 by @jiannx</p>
</li>
</ul>
<h3 data-id="heading-16"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fv2.0.0-alpha.36" target="_blank" title="https://www.nocobase.com/cn/blog/v2.0.0-alpha.36" ref="nofollow noopener noreferrer">v2.0.0-alpha.36</a></h3>
<p><em>发布时间：2025-11-10</em></p>
<h3 data-id="heading-17">🚀 优化</h3>
<ul>
<li><strong>[flow-engine]</strong> 优化页面标签的工具栏样式 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7795" target="_blank" title="https://github.com/nocobase/nocobase/pull/7795" ref="nofollow noopener noreferrer">#7795</a>) by @zhangzhonghe</li>
</ul>
<h3 data-id="heading-18">🐛 修复</h3>
<ul>
<li>
<p><strong>[flow-engine]</strong></p>
<ul>
<li>修复了子表单关系字段通过用户界面修改后，其变量无法正确解析的问题。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7799" target="_blank" title="https://github.com/nocobase/nocobase/pull/7799" ref="nofollow noopener noreferrer">#7799</a>) by @gchust</li>
<li>多主键记录编辑表单报错 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7798" target="_blank" title="https://github.com/nocobase/nocobase/pull/7798" ref="nofollow noopener noreferrer">#7798</a>) by @gchust</li>
<li>修复了“打开视图”操作的部分配置未正常应用的问题，现在所有相关配置均能按预期正常运行。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7790" target="_blank" title="https://github.com/nocobase/nocobase/pull/7790" ref="nofollow noopener noreferrer">#7790</a>) by @gchust</li>
</ul>
</li>
<li>
<p><strong>[client]</strong></p>
<ul>
<li>修复数据表选择器字段无法正确选择数据的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7794" target="_blank" title="https://github.com/nocobase/nocobase/pull/7794" ref="nofollow noopener noreferrer">#7794</a>) by @katherinehhh</li>
<li>表格区块操作列无法被隐藏 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7804" target="_blank" title="https://github.com/nocobase/nocobase/pull/7804" ref="nofollow noopener noreferrer">#7804</a>) by @gchust</li>
<li>支持在 AI 员工指令里选择整个变量对象 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7791" target="_blank" title="https://github.com/nocobase/nocobase/pull/7791" ref="nofollow noopener noreferrer">#7791</a>) by @gchust</li>
</ul>
</li>
<li>
<p><strong>[用户]</strong> 字段名为 snake_case 风格时，索引字段重置不正确的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7785" target="_blank" title="https://github.com/nocobase/nocobase/pull/7785" ref="nofollow noopener noreferrer">#7785</a>) by @2013xile</p>
</li>
</ul>
<h3 data-id="heading-19"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fv2.0.0-alpha.35" target="_blank" title="https://www.nocobase.com/cn/blog/v2.0.0-alpha.35" ref="nofollow noopener noreferrer">v2.0.0-alpha.35</a></h3>
<p><em>发布时间：2025-11-06</em></p>
<h3 data-id="heading-20">🚀 优化</h3>
<ul>
<li><strong>[flow-engine]</strong> 支持延迟操作 flow model (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7786" target="_blank" title="https://github.com/nocobase/nocobase/pull/7786" ref="nofollow noopener noreferrer">#7786</a>) by @gchust</li>
<li><strong>[工作流：JavaScript 节点]</strong> 修复传递到执行环境中的上层函数导致的安全漏洞，避免通过利用漏洞访问上层执行环境的问题 by @mytharcher</li>
</ul>
<h3 data-id="heading-21">🐛 修复</h3>
<ul>
<li>
<p><strong>[client]</strong></p>
<ul>
<li>修复详情区块简单分页出现空数据下一页的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7784" target="_blank" title="https://github.com/nocobase/nocobase/pull/7784" ref="nofollow noopener noreferrer">#7784</a>) by @katherinehhh</li>
<li>修复表格操作列和 jsColumn 列宽度设置不生效问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7777" target="_blank" title="https://github.com/nocobase/nocobase/pull/7777" ref="nofollow noopener noreferrer">#7777</a>) by @katherinehhh</li>
<li>页面的事件流设置页面区块数据范围不生效 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7788" target="_blank" title="https://github.com/nocobase/nocobase/pull/7788" ref="nofollow noopener noreferrer">#7788</a>) by @gchust</li>
</ul>
</li>
<li>
<p><strong>[工作流]</strong> 为工作流的日志增加 <code>workflowId</code> 的数据标识 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7789" target="_blank" title="https://github.com/nocobase/nocobase/pull/7789" ref="nofollow noopener noreferrer">#7789</a>) by @mytharcher</p>
</li>
<li>
<p><strong>[工作流：自定义变量节点]</strong> 修复变量节点缺失 config 时报错的问题 by @mytharcher</p>
</li>
<li>
<p><strong>[邮件管理]</strong> MailMessages 添加索引 by @jiannx</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GPT-5.1发布，OpenAI开始拼情商]]></title>    <link>https://juejin.cn/post/7571781196297797641</link>    <guid>https://juejin.cn/post/7571781196297797641</guid>    <pubDate>2025-11-13T03:20:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571781196297797641" data-draft-id="7571829822340055091" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GPT-5.1发布，OpenAI开始拼情商"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-11-13T03:20:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GPT-5.1发布，OpenAI开始拼情商
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T03:20:54.000Z" title="Thu Nov 13 2025 03:20:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>深夜，GPT-5 系列迎来大更新：上线 GPT-5.1 Instant 以及 GPT-5.1 Thinking 模型：</p>
<ul>
<li>
<p>GPT-5.1 Instant：ChatGPT 最常用的模型，更温暖、更智能，也更善于遵循指令的模型。</p>
</li>
<li>
<p>GPT-5.1 Thinking：高级推理模型，在简单任务上更快，在复杂任务上更持久，也更容易理解。</p>
</li>
</ul>
<p>对于新上线的模型，OpenAI 表示出色的 AI 不仅要聪明，还要让人与之对话变得愉悦。GPT-5.1 在智能和沟通风格上都有了显著提升。</p>
<p>Sam Altman 表示：这是一次不错的模型升级。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a74e6e51b1c4edcbf8fba25ffb85911~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763608853&amp;x-signature=3CUrJ9%2FNMch0FrTfZ6uNRq5biI0%3D" alt="图片" loading="lazy"/></p>
<p>GPT-5.1 Instant</p>
<p>根据早期测试，GPT-5.1 Instant 常常以俏皮又清晰实用的方式让人感到惊喜。</p>
<p>对于相同的问题，我们看看两者的差距。例如「我感觉压力很大，需要一些放松技巧。」</p>
<p>GPT-5 和 GPT-5.1 Instant 回答：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d49098c2f6224c3dbe1901f2959e7dc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763608853&amp;x-signature=LMU%2BkshRufjHSfZooWNPXxaICdQ%3D" alt="Image" loading="lazy"/></p>
<p>此外，新模型的指令执行能力更强了，能够更可靠地回答用户问题。例如对于指令要求：「始终用六个字回复」。</p>
<p>GPT-5 回答：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2c556c2f1844e39a6a5dc0bc518ebb3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763608853&amp;x-signature=WRfMUgICPLvmEJVImS1pRy6O4cY%3D" alt="图片" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a557712bf6414596bacee49e6bd8540e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763608853&amp;x-signature=urc%2F%2Bss1R%2BJeF969wFRM9vcBxDY%3D" alt="图片" loading="lazy"/></p>
<p>GPT-5.1 Instant 回答：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e52b69c7a43f4e139164c3b53f556e2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763608853&amp;x-signature=B9h8s%2BtTHs3%2BQsQMOzA6OLxRIAI%3D" alt="图片" loading="lazy"/></p>
<p>此外，GPT-5.1 Instant 能够使用自适应推理，在面对更具挑战性的问题时自行决定是否需要在回答前进行思考，从而提供更全面、更准确的答案，同时依然保持快速响应。</p>
<p>这一点也体现在数学和编程评测上的显著提升，例如 AIME 2025 和 Codeforces。</p>
<p>GPT‑5.1 Thinking</p>
<p>与此同时，OpenAI 也在升级 GPT-5 Thinking 模式，使其在日常使用中更加高效且易于理解。现在，它能更精准地根据问题调整思考时间 —— 在处理复杂问题时投入更多时间，而在处理简单问题时则更快响应。实际应用中，这意味着对于难题，它能给出更详尽的答案；而对于简单问题，它则能更快地给出响应。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae15197bf4c24fc2a91e4e9ff4cdd416~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763608853&amp;x-signature=uXEUh1ge4WMX7cEYbQUHUbaD0Eo%3D" alt="图片" loading="lazy"/></p>
<p>GPT-5.1 Thinking 的响应也更清晰，使用的术语更少、更通俗，并减少了未定义专业词汇的输出。这对处理复杂任务或解释技术概念时尤其重要。举例来说：解释 BABIP 和 wRC+。</p>
<p>GPT-5 Thinking、GPT-5.1 Thinking 回答：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fab301ce57a8486a94a35530f91f43ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763608853&amp;x-signature=CnxNT2pcTKcGCbTO2kziIuPFyr4%3D" alt="Image" loading="lazy"/></p>
<p>完整回答请参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopenai.com%2Findex%2Fgpt-5-1%2F" target="_blank" title="https://openai.com/index/gpt-5-1/" ref="nofollow noopener noreferrer">openai.com/index/gpt-5…</a></p>
<p>GPT-5.1 Thinking 的默认语气也更加温暖和富有同理心。</p>
<p>可以说，此次发布的模型在能力和可用性上都迈出了一大步。GPT-5.1 Auto 将继续把每个请求路由到最适合的模型，因此大多数情况下用户无需手动选择模型。使用过程中，你会明显感受到，GPT-5.1 系列的回答整体上更聪明，也更自然。</p>
<p>GPT-5.1 Instant 和 GPT-5.1 Thinking 将从今天开始逐步推出，首先面向付费用户（Pro、Plus、Go、Business），随后覆盖免费用户和未登录用户。Enterprise 和 Edu 订阅可以提前七天开启早期访问开关（默认关闭）。在此窗口期结束后，GPT-5.1 将成为唯一的默认模型。</p>
<p>如果你现在打开 ChatGPT，已经可以使用 GPT-5.1 了。还没上线的小伙伴，可以再等等，接下来的几天将逐步上线。很快 GPT-5 Pro 也会更新到 GPT-5.1 Pro。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c08341332064ee3b9faf21c402479c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763608853&amp;x-signature=KwB0tUtrLOvWbblxFOeKg2IMepI%3D" alt="图片" loading="lazy"/></p>
<p>另外，本周晚些时候， GPT-5.1 Instant 和 GPT-5.1 Thinking 两个模型在 API 中可用。GPT-5.1 Instant 将作为 gpt-5.1-chat-latest 加入，GPT-5.1 Thinking 则将作为 GPT-5.1 在 API 中发布，两者都支持自适应推理。</p>
<p>GPT-5（Instant 和 Thinking）将在接下来的三个月内继续通过 ChatGPT 中的旧版模型下拉菜单向付费订阅用户提供，以便大家有足够时间进行对比和逐步适应。GPT-5 的下线过渡期不会影响其他旧版模型的可用性。</p>
<p>未来，推出新的 ChatGPT 模型时，OpenAI 都会为用户预留充足的评估空间，让大家了解变化、分享反馈，实现平稳过渡。下线过渡期会提前充分、清晰地进行沟通。</p>
<p>关于命名方式的说明：此次更新被称为 GPT-5.1，是为了体现有意义的改进，同时仍然属于 GPT-5 系列。未来对 GPT-5 的迭代升级将遵循相同的命名模式。</p>
<p>OpenAI 还同时发布了 GPT-5.1 Instant、 GPT-5.1 Thinking 系统卡附录。感兴趣的小伙伴，可以前去查看。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35cd403b4daf40ef9349e4068204e916~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763608853&amp;x-signature=xFk6ceek5T4OcPpnKgsZ6Unn%2FlU%3D" alt="图片" loading="lazy"/></p>
<p>地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcdn.openai.com%2Fpdf%2F4173ec8d-1229-47db-96de-06d87147e07e%2F5_1_system_card.pdf" target="_blank" title="https://cdn.openai.com/pdf/4173ec8d-1229-47db-96de-06d87147e07e/5_1_system_card.pdf" ref="nofollow noopener noreferrer">cdn.openai.com/pdf/4173ec8…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Ollama × 魔搭社区：超简单的大模型本地部署方案]]></title>    <link>https://juejin.cn/post/7571731181198245924</link>    <guid>https://juejin.cn/post/7571731181198245924</guid>    <pubDate>2025-11-13T03:35:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571731181198245924" data-draft-id="7571731181198180388" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Ollama × 魔搭社区：超简单的大模型本地部署方案"/> <meta itemprop="keywords" content="Agent,LLM,程序员"/> <meta itemprop="datePublished" content="2025-11-13T03:35:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Ollama × 魔搭社区：超简单的大模型本地部署方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T03:35:56.000Z" title="Thu Nov 13 2025 03:35:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p>随着大模型的不断发展，小参数模型的能力也在逐渐进步，就拿阿里最新开源的qwen3来说，其中有负责多模态的qwen3-vl系列和专为代码优化的qwen3-code系列等，这些不同使用场景中都有开源的小参数模型来方便我们本地部署。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ab16477dfad4076b55d225510cf7c94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763609756&amp;x-signature=L%2BdoUdz5ne9NX%2FAlOquCX0Z1%2F7s%3D" alt="" loading="lazy"/></p>
<p>那开源部署小模型的好处有什么呢？我认为至少有以下优势：</p>
<ol>
<li>数据私有化：数据不出网，适合政企、学习或医院等对隐私要求高的场景。</li>
<li>无网络依赖：离线即可使用，不依赖网络。</li>
<li>成本大幅下降：本地推理成本降到最低（电费），比调用大模型api要省钱太多了。</li>
<li>微调门槛低：小模型比起大模型所需的庞大的资源来说更适合微调，小模型微调之后在特定领域的能力可以媲美甚至超过大模型。（微调可以理解为：用单独领域的数据集对模型再次训练使其专业化）</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79eb18cac2ae48b28356098d46ee7481~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763609756&amp;x-signature=b8lqhh5r4QGtVz%2FYC5eP5D1vhLc%3D" alt="" loading="lazy"/></p>
<p>在应用落地方面，比如一些agent应用的落地，更离不开本地模型的部署，那说了这么多，如何正确的本地部署一个大模型呢？这里只推荐两种方法，这两种方法也是当下比较正确和常用的。</p>
<ol>
<li>通过Ollama工具快捷部署</li>
<li>通过vLLM高性能推理框架部署</li>
</ol>
<p>本篇文章先讲通过ollama部署本地模型的方法。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7e1519d30e643febafef874f58a1110~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763609756&amp;x-signature=8bZ09%2BIswxsHzwxvJA50KQvSc%2FE%3D" alt="" loading="lazy"/></p>
<p>那在本地部署之前，我们应该先明白当前的电脑配置能够运行什么参数的模型，不然我们辛辛苦苦下载了几十G的模型文件后，发现根本跑不动就尴尬了。</p>
<p>这里给大家一个可以快速估算的公式（最好自己电脑显存比这个结果多一些），如下图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ad9ab2c297443f58e8af157f9bb20ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763609756&amp;x-signature=IQdn%2FcRDuaqlfaAyP3cHjnIQEzc%3D" alt="" loading="lazy"/></p>
<p>比如下面这个模型，部署它大概需要的显存的计算逻辑为：(8x8)/ 8x1.2=9.6G，也就是3060 12G显卡就可以跑，而且这个多模态的小模型能力也是相当不错。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/602e214002514f38b08c8dc9d4780b8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763609756&amp;x-signature=AED5jwbdlxYcAx8ae2DfddCz14k%3D" alt="" loading="lazy"/></p>
<p>这里涉及到两个概念：1.模型参数量 2.参数位宽。这俩个概念对于本地部署模型来说极其的重要，所以我觉得有必要说一下。</p>
<p>说之前大家要先了解一下魔搭社区，魔搭社区是阿里云的一个开源模型市场，里面有各种可下载的预训练好的模型以及数据集等，就像是中国版的Hugging Face。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7774a8e64e84a09b6f46c978287559d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763609756&amp;x-signature=FrHR8J8%2FVGuQ9389Ah2hTPS4h4o%3D" alt="" loading="lazy"/></p>
<p>链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.modelscope.cn%2Fhome" target="_blank" title="https://www.modelscope.cn/home" ref="nofollow noopener noreferrer">www.modelscope.cn/home</a></p>
<p>我们可以打开国内的模型市场——魔搭社区，然后搜索qwen3。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b92143485014f90898e12ba090ad02b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763609756&amp;x-signature=Q9rl5gVYAkurubrau1%2F8kJ2t85I%3D" alt="" loading="lazy"/></p>
<p>可以看到这些都有一个xxB的相关字样，比如30B、8B、235B这些字样，这些就是指得参数量，参数量越大就代表其掌握的知识越多，同时需要的显存越大！就比如图片上那个235B的模型需要的显存是500多G。这么大的显存，部署成本是相当大的。</p>
<p>我们点进去一个通义千问3-32B的模型中，在右侧部分可以看到这个模型的系谱，其中可以找到量化这一个分类。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c039d672e1ef49d2861a34d6c18f09b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763609756&amp;x-signature=kdRnODMWAlzliCzEQxNVQjfn098%3D" alt="" loading="lazy"/></p>
<p>点击这个分类，可以看到当前模型的量化版本，所谓量化其实就是指的是让模型尽量不变笨的情况下，节省部署显存。比如刚刚说的235B的模型经过4bit量化后，需要的显存就从500G降为了150G左右。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2312b420fd0048e697856c868f5f4b7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763609756&amp;x-signature=9EjDCAuU8m3JM%2FII9cSqHShFuKM%3D" alt="" loading="lazy"/></p>
<p>通过上图圈起来的部分，可以看到32B参数的qwen3文本对话模型的名称中包含，AWQ、FP8、GGUF、GPTQ，这些模型标识，对应的含义大家可以看下面这幅图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68709261c2794c5da54e92e835d43dc2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763609756&amp;x-signature=Ei4SclizIVq2cqS%2BRBC234TaYKQ%3D" alt="" loading="lazy"/></p>
<p>其中AWQ是阿里最推荐的量化方法，你可以看到AWQ量化后的模型下载量一般都是最多的，而GGUF的模型格式则是我们接下来要讲的ollama主要支持的模型格式。这里要注意ollama主要支持的是gguf格式，而vllm可以支持绝大多数的模型格式，所以企业应用中大都是使用vllm部署模型而ollama多用于个人应用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43ed6d91d33043f0a8f36e23eb785bf4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763609756&amp;x-signature=oKsfMUkTbvWOw4UPEgdPtfZw2LQ%3D" alt="" loading="lazy"/></p>
<p>下面这些参数就代表了模型 的位宽，比如FP8就是8bit的，GPTQ-Int4就是4bit的，同理GPTQ-Int8也是8bit的，INT4就是4bit的。默认的AWQ和GGUF方法则是4bit的位宽。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/847b21166dda44beba285e43e5626abf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763609756&amp;x-signature=hs79XWoHyU49ebzaoFIOD8MvO2E%3D" alt="" loading="lazy"/></p>
<p>可能第一时间有点不好理解所以给大家总结一下，显存资源有限情况下，一般vLLM框架来说使用AWQ量化后即可，但如果你要使用ollama就用GGUF格式的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46ba4a51651e4600966510151a055b98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763609756&amp;x-signature=x8BbH7VnosVnZv%2FeT8SmpQ9SDPI%3D" alt="" loading="lazy"/></p>
<p>这时候大家根据上面的公式再次估算一次下面的模型需要的现存是多少呢？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa715bd87f8746378acf7edf1d8f885d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763609756&amp;x-signature=0Ysb1cjiBDGCYpTGMdvLKd29gwU%3D" alt="" loading="lazy"/></p>
<p>模型的参数是8B，所以P就是8，GGUF默认ollama拉取的是4bit量化的版本，所以Q就是4，那么最后的显存所需大概就是4.8G。</p>
<p><strong>ollama部署教程</strong></p>
<p>我们拿装有N卡的windows来举例子，mac和linux的安装方法都差不多，大家可以查看官网，ollama的官网如下：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Follama.com%2Fdownload" target="_blank" title="https://ollama.com/download" ref="nofollow noopener noreferrer">ollama.com/download</a></p>
<p>安装ollama之前你需要确保你的N卡有英伟达的cuda驱动，可以运行：nvidia-smi 来查看是否有类似下面的输出：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb1c43d606494527b75167acd3ab6b68~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763609756&amp;x-signature=GZYW0GLpQK1t9Ld6E0oSKLVzZFY%3D" alt="" loading="lazy"/></p>
<p>如果没有的话需要到官方下载最新的显卡驱动，没有gpu也没关系，因为ollama可以将模型推理放在cpu上。驱动下载地址：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nvidia.cn%2Fsoftware%2Fnvidia-app%2F" target="_blank" title="https://www.nvidia.cn/software/nvidia-app/" ref="nofollow noopener noreferrer">www.nvidia.cn/software/nv…</a></p>
<p>随后打开ollama官网后，找到你要的版本点击下载即可。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ede79afd721245d2bb9e34158b7cab3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763609756&amp;x-signature=65vic8PqaofbN3XdxeSkUkqgC3s%3D" alt="" loading="lazy"/></p>
<p>你需要在C盘留足够的空间 因为ollama下载后是必须要安装在C盘的。当你安装好之后，可以输入：ollama -v 来查看是否安装成功，出现版本号就是安装成功了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d478318ae4034c1dbb94c34b2efac284~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763609756&amp;x-signature=LM6AGvc5SA0jKIXd%2BKBSPe05yNA%3D" alt="" loading="lazy"/></p>
<p>安装好了之后，我们需要设置一下模型文件默认存放的路径，不然你不设置他就把模型全放在c盘了。我们使用下面的命令设置ollama的模型安装路径（需要先创建对应文件夹）。</p>
<pre><code class="hljs language-arduino" lang="arduino">setx /M OLLAMA_MODELS <span class="hljs-string">"D:\Ollama\models"</span>
</code></pre>
<p>或者通过ollama最新版的前端界面设置模型安装路径也可以。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/523cb18e3e14413196abb9c4555ad610~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763609756&amp;x-signature=TCDfwq7c6h2uM%2FnwGPutru5ZttA%3D" alt="" loading="lazy"/></p>
<p>注意运行之后需要关闭ollama后重新开一个命令行窗口。这样才会生效。</p>
<p>模型的安装也很简单，魔搭社区就支持ollama的命令行一键下载模型，所以我们找一个gguf格式的模型，复制这个网址。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e94d2c1cf31846b68ecc1c32a6dad1c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763609756&amp;x-signature=k9w9A4LVuHUZja8G8AJ4aNANhT4%3D" alt="" loading="lazy"/></p>
<p>然后运行下面的命令:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f532df8f149447aa4478423b034fad0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763609756&amp;x-signature=6A1GZLBtiZVBsfjuNzM%2BLXfWC8k%3D" alt="" loading="lazy"/></p>
<p>这里要注意的ollama run 后面的模型地址是我们刚刚复制的地址去掉<a href="https://link.juejin.cn?target=http%3A%2F%2F%25E4%25BB%25A5%25E5%258F%258A" target="_blank" title="http://%E4%BB%A5%E5%8F%8A" ref="nofollow noopener noreferrer">http://以及</a> models/ 的结果哦（对于qwen来说）。</p>
<p>在任务管理器中可以看到没有询问模型的cpu和gpu占用情况：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c1808951b3243efa16de40b38ea6e89~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763609756&amp;x-signature=S30lBBNabJrwcK%2BvnoezQD4oRQY%3D" alt="" loading="lazy"/></p>
<p>ai在推理的过程中可以看到cpu和gpu的使用度都明显地变高了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41845c14b024400388b84bec7b9f9808~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763609756&amp;x-signature=EiD%2B3gUnZAAs9R3qxZ6E%2BasTXoQ%3D" alt="" loading="lazy"/></p>
<p>除了在命令行通过ollama run进行模型提问之外，你可以直接在ollama的前端界面中对自己部署的本地模型进行提问，当然你也可以使用Open WebUI等工具作为本地模型的可视化界面：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad5919af61364ea0b7bead178c18baaa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763609756&amp;x-signature=hmXggsZR01%2FvNA%2BdsF1%2BvqZvoiw%3D" alt="" loading="lazy"/></p>
<p>如果你想让ollama下载不是默认4bit量化的模型的话，其实也很简单，还是在魔搭社区GGUF格式模型页面，可以看到不同的量化情况。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db529cbc502b4087ba7b91a3fabd2f9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763609756&amp;x-signature=WRCdTgMxKiM6bPxaV%2Bw0lbyC2Wk%3D" alt="" loading="lazy"/></p>
<p>比如我想<strong>让ollama拉去8bit量化的，就在模型拉取地址中加上:Q8_0即可</strong>，就像下面这样：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ddd4c3003dc4f1d9ff55836ab9240a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763609756&amp;x-signature=A0G4YuEh0x5e7i7M4v4wuMh3Wis%3D" alt="" loading="lazy"/></p>
<p>拉取命令为：</p>
<pre><code class="hljs language-arduino" lang="arduino">ollama run modelscope.cn/Qwen/Qwen3<span class="hljs-number">-8B</span>-GGUF:Q8_0
</code></pre>
<p>至此，你已在本地完成 AI 部署，实现离线推理。但 Ollama 还能更强大，比如部署多模态模型、通过接口开放模型服务、灵活控制 CPU/GPU 分层加载、调整上下文与批量参数等，但是没关系，一切都是要循序渐进的来，这些我们在后续的文章会说。</p>
<p>如果大家到这里成功的部署了自己的模型，后续会给大家推出更进一步的教程和应用方法。</p>
<h2 data-id="heading-0">学习资源推荐</h2>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CompletableFuture的5大坑！]]></title>    <link>https://juejin.cn/post/7571693273729286180</link>    <guid>https://juejin.cn/post/7571693273729286180</guid>    <pubDate>2025-11-13T02:29:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571693273729286180" data-draft-id="7571678388955332627" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CompletableFuture的5大坑！"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-13T02:29:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苏三说技术"/> <meta itemprop="url" content="https://juejin.cn/user/465848661970824"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CompletableFuture的5大坑！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/465848661970824/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苏三说技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T02:29:15.000Z" title="Thu Nov 13 2025 02:29:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>CompletableFuture在并发编程中非常实用，但如果用不好，也很容易踩坑。</p>
<p>今天这篇文章跟大家一起聊聊，CompletableFuture在使用过程中最常见的那些坑，希望对你会有所帮助。</p>
<p><a href="https://link.juejin.cn/?target=http%3A%2F%2Fwww.susan.net.cn%3Frefer%3Djuejin" title="https://link.juejin.cn/?target=http%3A%2F%2Fwww.susan.net.cn%3Frefer%3Djuejin" target="_blank">最近准备面试的小伙伴，可以看一下这个宝藏网站（Java突击队）：www.susan.net.cn，里面：面试八股文、场景设计题、面试真题、7个项目实战、工作内推什么都有</a>。</p>
<p><a href="https://link.juejin.cn/?target=http%3A%2F%2Fwww.susan.net.cn%2Fcontact%2Fneitui.html" title="https://link.juejin.cn/?target=http%3A%2F%2Fwww.susan.net.cn%2Fcontact%2Fneitui.html" target="_blank">加苏三的工作内推群</a></p>
<h2 data-id="heading-1">一、CompletableFuture简介</h2>
<p>有些小伙伴在工作中刚开始接触CompletableFuture时，可能会被它强大的功能所吸引。</p>
<p>确实，CompletableFuture为我们提供了非常优雅的异步编程方式，但正如武侠小说中的神兵利器，如果使用不当，反而会伤到自己。</p>
<h3 data-id="heading-2">CompletableFuture的基本用法</h3>
<p>先来看一个简单的CompletableFuture使用示例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BasicCompletableFutureDemo</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 简单的异步计算</span>
        CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-comment">// 模拟耗时操作</span>
            <span class="hljs-keyword">try</span> {
                Thread.sleep(<span class="hljs-number">1000</span>);
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                e.printStackTrace();
            }
            <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello, CompletableFuture!"</span>;
        });
        
        <span class="hljs-comment">// 获取结果（阻塞）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> future.get();
        System.out.println(result);
    }
}
</code></pre>
<p>看起来很简单对吧？但正是这种表面上的简单，掩盖了很多潜在的复杂性。</p>
<p>让我们通过一个架构图来理解CompletableFuture的完整生态：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7f127463bd94c2fb8a3c19c585e4fbc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763605755&amp;x-signature=PExu2mOkUWYr4biwfx1m66%2FA8Fo%3D" alt="" loading="lazy"/></p>
<p>现在，让我们开始深入探讨各个坑点。</p>
<h2 data-id="heading-3">二、线程池使用不当</h2>
<p>有些小伙伴在使用CompletableFuture时，往往忽略了线程池的配置，这可能是最容易被忽视但影响最大的坑。</p>
<h3 data-id="heading-4">默认线程池的陷阱</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadPoolPitfall</span> {
    
    <span class="hljs-comment">// 危险的用法：大量使用默认线程池</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processBatchData</span><span class="hljs-params">(List&lt;String&gt; dataList)</span> {
        List&lt;CompletableFuture&lt;String&gt;&gt; futures = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        
        <span class="hljs-keyword">for</span> (String data : dataList) {
            <span class="hljs-comment">// 使用默认的ForkJoinPool.commonPool()</span>
            CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(() -&gt; {
                <span class="hljs-keyword">return</span> processData(data);
            });
            futures.add(future);
        }
        
        <span class="hljs-comment">// 等待所有任务完成</span>
        CompletableFuture.allOf(fatures.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletableFuture</span>[<span class="hljs-number">0</span>]))
                        .join();
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">processData</span><span class="hljs-params">(String data)</span> {
        <span class="hljs-comment">// 模拟数据处理</span>
        <span class="hljs-keyword">try</span> {
            Thread.sleep(<span class="hljs-number">100</span>);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
        <span class="hljs-keyword">return</span> data.toUpperCase();
    }
}
</code></pre>
<p><strong>问题分析：</strong></p>
<ul>
<li>默认线程池大小是CPU核心数-1</li>
<li>在IO密集型任务中，这会导致大量任务排队等待</li>
<li>如果任务提交速度 &gt; 任务处理速度，会造成内存溢出</li>
</ul>
<h3 data-id="heading-5">正确的线程池使用方式</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProperThreadPoolUsage</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ExecutorService ioBoundExecutor;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ExecutorService cpuBoundExecutor;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ProperThreadPoolUsage</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// IO密集型任务 - 使用较大的线程池</span>
        <span class="hljs-built_in">this</span>.ioBoundExecutor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
            <span class="hljs-number">50</span>, <span class="hljs-comment">// 核心线程数</span>
            <span class="hljs-number">100</span>, <span class="hljs-comment">// 最大线程数</span>
            <span class="hljs-number">60L</span>, TimeUnit.SECONDS, <span class="hljs-comment">// 空闲线程存活时间</span>
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">1000</span>), <span class="hljs-comment">// 工作队列</span>
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadFactoryBuilder</span>().setNameFormat(<span class="hljs-string">"io-pool-%d"</span>).build(),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy() <span class="hljs-comment">// 拒绝策略</span>
        );
        
        <span class="hljs-comment">// CPU密集型任务 - 使用较小的线程池</span>
        <span class="hljs-built_in">this</span>.cpuBoundExecutor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
            Runtime.getRuntime().availableProcessors(), <span class="hljs-comment">// CPU核心数</span>
            Runtime.getRuntime().availableProcessors() * <span class="hljs-number">2</span>,
            <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">100</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadFactoryBuilder</span>().setNameFormat(<span class="hljs-string">"cpu-pool-%d"</span>).build(),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.AbortPolicy()
        );
    }
    
    <span class="hljs-keyword">public</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">processWithProperPool</span><span class="hljs-params">(String data)</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-comment">// IO操作，使用IO线程池</span>
            <span class="hljs-keyword">return</span> fetchFromDatabase(data);
        }, ioBoundExecutor);
    }
    
    <span class="hljs-keyword">public</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">computeWithProperPool</span><span class="hljs-params">(String data)</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-comment">// CPU密集型计算，使用CPU线程池</span>
            <span class="hljs-keyword">return</span> heavyComputation(data);
        }, cpuBoundExecutor);
    }
    
    <span class="hljs-comment">// 资源清理</span>
    <span class="hljs-meta">@PreDestroy</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> {
        ioBoundExecutor.shutdown();
        cpuBoundExecutor.shutdown();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (!ioBoundExecutor.awaitTermination(<span class="hljs-number">5</span>, TimeUnit.SECONDS)) {
                ioBoundExecutor.shutdownNow();
            }
            <span class="hljs-keyword">if</span> (!cpuBoundExecutor.awaitTermination(<span class="hljs-number">5</span>, TimeUnit.SECONDS)) {
                cpuBoundExecutor.shutdownNow();
            }
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            ioBoundExecutor.shutdownNow();
            cpuBoundExecutor.shutdownNow();
            Thread.currentThread().interrupt();
        }
    }
}
</code></pre>
<h3 data-id="heading-6">线程池工作流程对比</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c38829086cd744bb960248d2eb87f280~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763605755&amp;x-signature=Wo1WlcxGCfGe7SH92rLYjopVg3E%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">三、异常为什么神秘消失了？</h2>
<p>有些小伙伴在调试CompletableFuture时，经常会发现异常"神秘消失"了，这其实是CompletableFuture异常处理机制的一个特性。</p>
<h3 data-id="heading-8">异常丢失的典型案例</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExceptionDisappearance</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testExceptionLost</span><span class="hljs-params">()</span> {
        CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-comment">// 这里会抛出异常</span>
            <span class="hljs-keyword">return</span> dangerousOperation();
        });
        
        <span class="hljs-comment">// 添加转换链</span>
        CompletableFuture&lt;String&gt; resultFuture = future.thenApply(result -&gt; {
            System.out.println(<span class="hljs-string">"处理结果: "</span> + result);
            <span class="hljs-keyword">return</span> result + <span class="hljs-string">" processed"</span>;
        });
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 这里不会抛出异常！</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> resultFuture.get();
            System.out.println(<span class="hljs-string">"最终结果: "</span> + result);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 异常被包装在ExecutionException中</span>
            System.out.println(<span class="hljs-string">"捕获到异常: "</span> + e.getClass().getName());
            System.out.println(<span class="hljs-string">"根本原因: "</span> + e.getCause().getMessage());
        }
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">dangerousOperation</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"业务操作失败！"</span>);
    }
    
    <span class="hljs-comment">// 更隐蔽的异常丢失</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testHiddenExceptionLoss</span><span class="hljs-params">()</span> {
        CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"重要异常"</span>);
        }).thenAccept(result -&gt; {
            <span class="hljs-comment">// 如果上游有异常，这里不会执行</span>
            System.out.println(<span class="hljs-string">"处理结果: "</span> + result);
        });
        
        <span class="hljs-comment">// 程序继续执行，异常被忽略！</span>
        System.out.println(<span class="hljs-string">"程序正常结束，但异常丢失了！"</span>);
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BusinessException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RuntimeException</span> {
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">BusinessException</span><span class="hljs-params">(String message)</span> {
            <span class="hljs-built_in">super</span>(message);
        }
    }
}
</code></pre>
<h3 data-id="heading-9">CompletableFuture异常处理机制</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4cfdb8e566a349bd8ad1a44b3ddd10b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763605755&amp;x-signature=hEQQAjLov96H1FV8SZnojs8mg60%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">正确的异常处理方式</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProperExceptionHandling</span> {
    
    <span class="hljs-comment">// 方法1：使用exceptionally进行恢复</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">handleWithRecovery</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-keyword">return</span> riskyOperation();
        }).exceptionally(throwable -&gt; {
            <span class="hljs-comment">// 异常恢复</span>
            System.err.println(<span class="hljs-string">"操作失败，使用默认值: "</span> + throwable.getMessage());
            <span class="hljs-keyword">return</span> <span class="hljs-string">"default-value"</span>;
        });
    }
    
    <span class="hljs-comment">// 方法2：使用handle统一处理</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">handleWithUnified</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-keyword">return</span> riskyOperation();
        }).handle((result, throwable) -&gt; {
            <span class="hljs-keyword">if</span> (throwable != <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">// 处理异常</span>
                System.err.println(<span class="hljs-string">"操作异常: "</span> + throwable.getMessage());
                <span class="hljs-keyword">return</span> <span class="hljs-string">"error-value"</span>;
            }
            <span class="hljs-keyword">return</span> result + <span class="hljs-string">"-processed"</span>;
        });
    }
    
    <span class="hljs-comment">// 方法3：使用whenComplete进行副作用处理</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;Void&gt; <span class="hljs-title function_">handleWithSideEffect</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-keyword">return</span> riskyOperation();
        }).whenComplete((result, throwable) -&gt; {
            <span class="hljs-keyword">if</span> (throwable != <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">// 记录日志、发送告警等</span>
                logError(throwable);
                sendAlert(throwable);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 正常业务处理</span>
                processResult(result);
            }
        });
    }
    
    <span class="hljs-comment">// 方法4：组合操作中的异常处理</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">handleInComposition</span><span class="hljs-params">()</span> {
        CompletableFuture&lt;String&gt; future1 = CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-keyword">return</span> operation1();
        });
        
        CompletableFuture&lt;String&gt; future2 = future1.thenCompose(result1 -&gt; {
            <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
                <span class="hljs-keyword">return</span> operation2(result1);
            });
        });
        
        <span class="hljs-comment">// 在整个链的末尾处理异常</span>
        <span class="hljs-keyword">return</span> future2.exceptionally(throwable -&gt; {
            <span class="hljs-type">Throwable</span> <span class="hljs-variable">rootCause</span> <span class="hljs-operator">=</span> getRootCause(throwable);
            <span class="hljs-keyword">if</span> (rootCause <span class="hljs-keyword">instanceof</span> BusinessException) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">"business-fallback"</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rootCause <span class="hljs-keyword">instanceof</span> TimeoutException) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">"timeout-fallback"</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-string">"unknown-error"</span>;
            }
        });
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logError</span><span class="hljs-params">(Throwable throwable)</span> {
        <span class="hljs-comment">// 记录错误日志</span>
        System.err.println(<span class="hljs-string">"错误记录: "</span> + throwable.getMessage());
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendAlert</span><span class="hljs-params">(Throwable throwable)</span> {
        <span class="hljs-comment">// 发送告警</span>
        System.out.println(<span class="hljs-string">"发送告警: "</span> + throwable.getMessage());
    }
    
    <span class="hljs-keyword">private</span> Throwable <span class="hljs-title function_">getRootCause</span><span class="hljs-params">(Throwable throwable)</span> {
        <span class="hljs-type">Throwable</span> <span class="hljs-variable">cause</span> <span class="hljs-operator">=</span> throwable;
        <span class="hljs-keyword">while</span> (cause.getCause() != <span class="hljs-literal">null</span>) {
            cause = cause.getCause();
        }
        <span class="hljs-keyword">return</span> cause;
    }
}
</code></pre>
<h2 data-id="heading-11">四、回调地狱：当异步变成"异痛"</h2>
<p>有些小伙伴在复杂业务场景中使用CompletableFuture时，很容易陷入回调地狱，代码变得难以理解和维护。</p>
<h3 data-id="heading-12">回调地狱的典型案例</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CallbackHell</span> {
    
    <span class="hljs-keyword">public</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">processUserOrder</span><span class="hljs-params">(String userId)</span> {
        <span class="hljs-keyword">return</span> getUserInfo(userId)
            .thenCompose(userInfo -&gt; {
                <span class="hljs-keyword">return</span> getOrderHistory(userInfo.getId())
                    .thenCompose(orderHistory -&gt; {
                        <span class="hljs-keyword">return</span> calculateDiscount(userInfo, orderHistory)
                            .thenCompose(discount -&gt; {
                                <span class="hljs-keyword">return</span> createOrder(userInfo, discount)
                                    .thenCompose(order -&gt; {
                                        <span class="hljs-keyword">return</span> sendConfirmation(userInfo, order);
                                    });
                            });
                    });
            });
    }
    
    <span class="hljs-comment">// 上述代码的"平铺"版本，同样难以阅读</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">processUserOrderFlat</span><span class="hljs-params">(String userId)</span> {
        <span class="hljs-keyword">return</span> getUserInfo(userId)
            .thenCompose(userInfo -&gt; getOrderHistory(userInfo.getId()))
            .thenCompose(orderHistory -&gt; getUserInfo(userId))
            .thenCompose(userInfo -&gt; calculateDiscount(userInfo, orderHistory))
            .thenCompose(discount -&gt; getUserInfo(userId))
            .thenCompose(userInfo -&gt; createOrder(userInfo, discount))
            .thenCompose(order -&gt; getUserInfo(userId))
            .thenCompose(userInfo -&gt; sendConfirmation(userInfo, order));
    }
}
</code></pre>
<h3 data-id="heading-13">结构化异步编程解决方案</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StructuredAsyncProgramming</span> {
    
    <span class="hljs-comment">// 定义业务数据类</span>
    <span class="hljs-meta">@Data</span>
    <span class="hljs-meta">@AllArgsConstructor</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderContext</span> {
        <span class="hljs-keyword">private</span> String userId;
        <span class="hljs-keyword">private</span> UserInfo userInfo;
        <span class="hljs-keyword">private</span> List&lt;Order&gt; orderHistory;
        <span class="hljs-keyword">private</span> Discount discount;
        <span class="hljs-keyword">private</span> Order order;
        <span class="hljs-keyword">private</span> String result;
    }
    
    <span class="hljs-keyword">public</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">processUserOrderStructured</span><span class="hljs-params">(String userId)</span> {
        <span class="hljs-type">OrderContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderContext</span>(userId, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);
        
        <span class="hljs-keyword">return</span> getUserInfo(context.getUserId())
            .thenCompose(userInfo -&gt; {
                context.setUserInfo(userInfo);
                <span class="hljs-keyword">return</span> getOrderHistory(userInfo.getId());
            })
            .thenCompose(orderHistory -&gt; {
                context.setOrderHistory(orderHistory);
                <span class="hljs-keyword">return</span> calculateDiscount(context.getUserInfo(), orderHistory);
            })
            .thenCompose(discount -&gt; {
                context.setDiscount(discount);
                <span class="hljs-keyword">return</span> createOrder(context.getUserInfo(), discount);
            })
            .thenCompose(order -&gt; {
                context.setOrder(order);
                <span class="hljs-keyword">return</span> sendConfirmation(context.getUserInfo(), order);
            })
            .thenApply(result -&gt; {
                context.setResult(result);
                <span class="hljs-keyword">return</span> result;
            })
            .exceptionally(throwable -&gt; {
                <span class="hljs-comment">// 统一异常处理</span>
                <span class="hljs-keyword">return</span> handleOrderError(context, throwable);
            });
    }
    
    <span class="hljs-comment">// 使用thenCombine处理并行任务</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;UserProfile&gt; <span class="hljs-title function_">getUserProfile</span><span class="hljs-params">(String userId)</span> {
        CompletableFuture&lt;UserInfo&gt; userInfoFuture = getUserInfo(userId);
        CompletableFuture&lt;List&lt;Order&gt;&gt; orderHistoryFuture = getOrderHistory(userId);
        CompletableFuture&lt;List&lt;Address&gt;&gt; addressesFuture = getUserAddresses(userId);
        
        <span class="hljs-keyword">return</span> userInfoFuture.thenCombine(orderHistoryFuture, (userInfo, orders) -&gt; {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserProfile</span>(userInfo, orders, <span class="hljs-literal">null</span>);
        }).thenCombine(addressesFuture, (profile, addresses) -&gt; {
            profile.setAddresses(addresses);
            <span class="hljs-keyword">return</span> profile;
        });
    }
    
    <span class="hljs-comment">// 使用allOf处理多个独立任务</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">getDashboardData</span><span class="hljs-params">(String userId)</span> {
        CompletableFuture&lt;UserInfo&gt; userInfoFuture = getUserInfo(userId);
        CompletableFuture&lt;List&lt;Order&gt;&gt; ordersFuture = getOrderHistory(userId);
        CompletableFuture&lt;List&lt;Notification&gt;&gt; notificationsFuture = getNotifications(userId);
        CompletableFuture&lt;Preferences&gt; preferencesFuture = getPreferences(userId);
        
        CompletableFuture&lt;Void&gt; allFutures = CompletableFuture.allOf(
            userInfoFuture, ordersFuture, notificationsFuture, preferencesFuture
        );
        
        <span class="hljs-keyword">return</span> allFutures.thenApply(v -&gt; {
            Map&lt;String, Object&gt; dashboard = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
            <span class="hljs-keyword">try</span> {
                dashboard.put(<span class="hljs-string">"userInfo"</span>, userInfoFuture.get());
                dashboard.put(<span class="hljs-string">"orders"</span>, ordersFuture.get());
                dashboard.put(<span class="hljs-string">"notifications"</span>, notificationsFuture.get());
                dashboard.put(<span class="hljs-string">"preferences"</span>, preferencesFuture.get());
            } <span class="hljs-keyword">catch</span> (Exception e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletionException</span>(e);
            }
            <span class="hljs-keyword">return</span> dashboard;
        });
    }
}
</code></pre>
<h3 data-id="heading-14">异步编程模式对比</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e942e5caf5e483e920c1c10311c14a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763605755&amp;x-signature=Pr1AU0Uv84vkw3bVQo%2Fv%2BOzOQn8%3D" alt="" loading="lazy"/></p>
<p>更推荐的方案：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef5b3b1c0a4046a392f8edbd0aa4ba2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763605755&amp;x-signature=XZzYXqQCqO9iyyDxciwC13GC%2F2g%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-15">五、内存泄漏：隐藏的资源消耗者</h2>
<p>有些小伙伴可能没有意识到，不当使用CompletableFuture会导致内存泄漏，特别是在长时间运行的应用中。</p>
<h3 data-id="heading-16">内存泄漏的常见场景</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryLeakDemo</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, CompletableFuture&lt;String&gt;&gt; cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
    
    <span class="hljs-comment">// 场景1：无限增长的缓存</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">getDataWithLeak</span><span class="hljs-params">(String key)</span> {
        <span class="hljs-keyword">return</span> cache.computeIfAbsent(key, k -&gt; {
            <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; fetchData(k));
        });
    }
    
    <span class="hljs-comment">// 场景2：未完成的Future积累</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processWithUnfinishedFutures</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100000</span>; i++) {
            CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(() -&gt; {
                <span class="hljs-comment">// 模拟长时间运行或阻塞的任务</span>
                <span class="hljs-keyword">try</span> {
                    Thread.sleep(Long.MAX_VALUE); <span class="hljs-comment">// 几乎永久阻塞</span>
                } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
                <span class="hljs-keyword">return</span> <span class="hljs-string">"result"</span>;
            });
            <span class="hljs-comment">// future永远不会完成，但一直存在于内存中</span>
        }
    }
    
    <span class="hljs-comment">// 场景3：循环引用</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskManager</span> {
        <span class="hljs-keyword">private</span> CompletableFuture&lt;String&gt; currentTask;
        <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> <span class="hljs-string">"INIT"</span>;
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startTask</span><span class="hljs-params">()</span> {
            currentTask = CompletableFuture.supplyAsync(() -&gt; {
                <span class="hljs-comment">// 任务持有Manager的引用</span>
                <span class="hljs-keyword">while</span> (!<span class="hljs-string">"COMPLETED"</span>.equals(status)) {
                    <span class="hljs-comment">// 处理任务</span>
                    processTask();
                }
                <span class="hljs-keyword">return</span> <span class="hljs-string">"done"</span>;
            });
        }
        
        <span class="hljs-comment">// Manager也持有任务的引用</span>
        <span class="hljs-keyword">public</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">getCurrentTask</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> currentTask;
        }
    }
}
</code></pre>
<h3 data-id="heading-17">内存泄漏检测和预防</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryLeakPrevention</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Cache&lt;String, CompletableFuture&lt;String&gt;&gt; cache;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MemoryLeakPrevention</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 使用Guava Cache自动清理</span>
        <span class="hljs-built_in">this</span>.cache = CacheBuilder.newBuilder()
            .maximumSize(<span class="hljs-number">1000</span>)
            .expireAfterAccess(<span class="hljs-number">10</span>, TimeUnit.MINUTES)
            .removalListener((RemovalListener&lt;String, CompletableFuture&lt;String&gt;&gt;) notification -&gt; {
                <span class="hljs-keyword">if</span> (notification.getCause() == RemovalCause.SIZE || 
                    notification.getCause() == RemovalCause.EXPIRED) {
                    <span class="hljs-comment">// 取消未完成的任务</span>
                    CompletableFuture&lt;String&gt; future = notification.getValue();
                    <span class="hljs-keyword">if</span> (!future.isDone()) {
                        future.cancel(<span class="hljs-literal">true</span>);
                    }
                }
            })
            .build();
    }
    
    <span class="hljs-comment">// 安全的缓存用法</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">getDataSafely</span><span class="hljs-params">(String key)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> cache.get(key, () -&gt; {
                CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(() -&gt; fetchData(key));
                
                <span class="hljs-comment">// 添加超时控制</span>
                <span class="hljs-keyword">return</span> future.orTimeout(<span class="hljs-number">30</span>, TimeUnit.SECONDS)
                           .exceptionally(throwable -&gt; {
                               <span class="hljs-comment">// 发生异常时从缓存中移除</span>
                               cache.invalidate(key);
                               <span class="hljs-keyword">return</span> <span class="hljs-string">"fallback-data"</span>;
                           });
            });
        } <span class="hljs-keyword">catch</span> (ExecutionException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
        }
    }
    
    <span class="hljs-comment">// 使用WeakReference避免循环引用</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeTaskManager</span> {
        <span class="hljs-keyword">private</span> WeakReference&lt;CompletableFuture&lt;String&gt;&gt; currentTaskRef;
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startTask</span><span class="hljs-params">()</span> {
            CompletableFuture&lt;String&gt; task = CompletableFuture.supplyAsync(() -&gt; {
                <span class="hljs-keyword">return</span> performTask();
            });
            
            currentTaskRef = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakReference</span>&lt;&gt;(task);
            
            <span class="hljs-comment">// 任务完成后自动清理</span>
            task.whenComplete((result, error) -&gt; {
                currentTaskRef = <span class="hljs-literal">null</span>;
            });
        }
    }
    
    <span class="hljs-comment">// 监控和诊断工具</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">monitorFutures</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 定期检查未完成的Future</span>
        <span class="hljs-type">Timer</span> <span class="hljs-variable">timer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Timer</span>(<span class="hljs-literal">true</span>);
        timer.scheduleAtFixedRate(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TimerTask</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
                <span class="hljs-type">int</span> <span class="hljs-variable">unfinishedCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
                <span class="hljs-keyword">for</span> (CompletableFuture&lt;?&gt; future : cache.asMap().values()) {
                    <span class="hljs-keyword">if</span> (!future.isDone()) {
                        unfinishedCount++;
                        <span class="hljs-comment">// 记录长时间运行的任务</span>
                        <span class="hljs-keyword">if</span> (future.isDoneExceptionally()) {
                            <span class="hljs-comment">// 处理异常任务</span>
                            handleExceptionalFuture(future);
                        }
                    }
                }
                
                <span class="hljs-keyword">if</span> (unfinishedCount &gt; <span class="hljs-number">100</span>) {
                    <span class="hljs-comment">// 发出警告</span>
                    System.err.println(<span class="hljs-string">"警告: 有 "</span> + unfinishedCount + <span class="hljs-string">" 个未完成的任务"</span>);
                }
            }
        }, <span class="hljs-number">0</span>, <span class="hljs-number">60000</span>); <span class="hljs-comment">// 每分钟检查一次</span>
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleExceptionalFuture</span><span class="hljs-params">(CompletableFuture&lt;?&gt; future)</span> {
        <span class="hljs-comment">// 处理异常Future，避免它们一直存在</span>
        future.exceptionally(throwable -&gt; {
            <span class="hljs-comment">// 记录异常日志</span>
            System.err.println(<span class="hljs-string">"任务异常: "</span> + throwable.getMessage());
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        });
    }
}
</code></pre>
<h3 data-id="heading-18">内存泄漏检测流程</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63241feed2cf4d02b17d4e2acfa69ece~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763605755&amp;x-signature=pku9xmn6qbZFoM5m2YQ9QABS4PE%3D" alt="" loading="lazy"/></p>
<p>最近为了帮助大家找工作，专门建了一些工作内推群，各大城市都有，欢迎各位HR和找工作的小伙伴进群交流，群里目前已经收集了不少的工作内推岗位。加苏三的微信：li_su223，备注：掘金+所在城市，即可进群。</p>
<h2 data-id="heading-19">六、超时控制缺失</h2>
<p>有些小伙伴在使用CompletableFuture时，经常会忘记设置超时控制，这可能导致线程永远阻塞。</p>
<h3 data-id="heading-20">超时问题的严重性</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TimeoutPitfalls</span> {
    
    <span class="hljs-comment">// 危险的代码：没有超时控制</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">dangerousGet</span><span class="hljs-params">()</span> {
        CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-comment">// 模拟网络问题导致的无限阻塞</span>
            <span class="hljs-keyword">return</span> blockingNetworkCall();
        });
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 如果任务永远不完成，这里会永远阻塞</span>
            <span class="hljs-keyword">return</span> future.get();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"error"</span>;
        }
    }
    
    <span class="hljs-comment">// 资源泄漏的示例</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">resourceLeakExample</span><span class="hljs-params">()</span> {
        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {
            CompletableFuture.runAsync(() -&gt; {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-comment">// 长时间运行的任务</span>
                    Thread.sleep(Long.MAX_VALUE);
                } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
            }, executor);
        }
        
        <span class="hljs-comment">// 线程池中的线程都被占用，无法执行新任务</span>
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">blockingNetworkCall</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 模拟网络问题</span>
        <span class="hljs-keyword">try</span> {
            Thread.sleep(Long.MAX_VALUE);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
        <span class="hljs-keyword">return</span> <span class="hljs-string">"response"</span>;
    }
}
</code></pre>
<h3 data-id="heading-21">完整的超时控制方案</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CompleteTimeoutSolution</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ScheduledExecutorService timeoutExecutor;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CompleteTimeoutSolution</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">this</span>.timeoutExecutor = Executors.newScheduledThreadPool(<span class="hljs-number">2</span>);
    }
    
    <span class="hljs-comment">// 方法1：使用orTimeout（Java 9+）</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">withOrTimeout</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-keyword">return</span> externalServiceCall();
        }).orTimeout(<span class="hljs-number">5</span>, TimeUnit.SECONDS) <span class="hljs-comment">// 5秒超时</span>
          .exceptionally(throwable -&gt; {
              <span class="hljs-keyword">if</span> (throwable <span class="hljs-keyword">instanceof</span> TimeoutException) {
                  <span class="hljs-keyword">return</span> <span class="hljs-string">"timeout-fallback"</span>;
              }
              <span class="hljs-keyword">return</span> <span class="hljs-string">"error-fallback"</span>;
          });
    }
    
    <span class="hljs-comment">// 方法2：使用completeOnTimeout（Java 9+）</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">withCompleteOnTimeout</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-keyword">return</span> externalServiceCall();
        }).completeOnTimeout(<span class="hljs-string">"timeout-default"</span>, <span class="hljs-number">3</span>, TimeUnit.SECONDS);
    }
    
    <span class="hljs-comment">// 方法3：手动超时控制（Java 8兼容）</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">withManualTimeout</span><span class="hljs-params">()</span> {
        CompletableFuture&lt;String&gt; taskFuture = CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-keyword">return</span> externalServiceCall();
        });
        
        CompletableFuture&lt;String&gt; timeoutFuture = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletableFuture</span>&lt;&gt;();
        
        <span class="hljs-comment">// 设置超时</span>
        timeoutExecutor.schedule(() -&gt; {
            timeoutFuture.completeExceptionally(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TimeoutException</span>(<span class="hljs-string">"操作超时"</span>));
        }, <span class="hljs-number">5</span>, TimeUnit.SECONDS);
        
        <span class="hljs-comment">// 哪个先完成就返回哪个</span>
        <span class="hljs-keyword">return</span> taskFuture.applyToEither(timeoutFuture, Function.identity())
                       .exceptionally(throwable -&gt; {
                           <span class="hljs-keyword">if</span> (throwable <span class="hljs-keyword">instanceof</span> TimeoutException) {
                               <span class="hljs-keyword">return</span> <span class="hljs-string">"manual-timeout-fallback"</span>;
                           }
                           <span class="hljs-keyword">return</span> <span class="hljs-string">"other-error-fallback"</span>;
                       });
    }
    
    <span class="hljs-comment">// 方法4：分层超时控制</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">withLayeredTimeout</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-keyword">return</span> phase1Operation();
        }).orTimeout(<span class="hljs-number">2</span>, TimeUnit.SECONDS)
          .thenCompose(phase1Result -&gt; {
              <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
                  <span class="hljs-keyword">return</span> phase2Operation(phase1Result);
              }).orTimeout(<span class="hljs-number">3</span>, TimeUnit.SECONDS);
          })
          .thenCompose(phase2Result -&gt; {
              <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
                  <span class="hljs-keyword">return</span> phase3Operation(phase2Result);
              }).orTimeout(<span class="hljs-number">5</span>, TimeUnit.SECONDS);
          })
          .exceptionally(throwable -&gt; {
              <span class="hljs-type">Throwable</span> <span class="hljs-variable">rootCause</span> <span class="hljs-operator">=</span> getRootCause(throwable);
              <span class="hljs-keyword">if</span> (rootCause <span class="hljs-keyword">instanceof</span> TimeoutException) {
                  <span class="hljs-comment">// 根据超时阶段提供不同的降级策略</span>
                  <span class="hljs-keyword">return</span> <span class="hljs-string">"timeout-in-phase"</span>;
              }
              <span class="hljs-keyword">return</span> <span class="hljs-string">"general-fallback"</span>;
          });
    }
    
    <span class="hljs-comment">// 方法5：可配置的超时策略</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">withConfigurableTimeout</span><span class="hljs-params">(String operationType)</span> {
        <span class="hljs-type">TimeoutConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> getTimeoutConfig(operationType);
        
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-keyword">return</span> performOperation(operationType);
        }).orTimeout(config.getTimeout(), config.getTimeUnit())
          .exceptionally(throwable -&gt; {
              <span class="hljs-keyword">return</span> config.getFallbackStrategy().apply(throwable);
          });
    }
    
    <span class="hljs-meta">@PreDestroy</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> {
        timeoutExecutor.shutdown();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (!timeoutExecutor.awaitTermination(<span class="hljs-number">5</span>, TimeUnit.SECONDS)) {
                timeoutExecutor.shutdownNow();
            }
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            timeoutExecutor.shutdownNow();
            Thread.currentThread().interrupt();
        }
    }
    
    <span class="hljs-comment">// 超时配置类</span>
    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TimeoutConfig</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> timeout;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> TimeUnit timeUnit;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Function&lt;Throwable, String&gt; fallbackStrategy;
    }
    
    <span class="hljs-keyword">private</span> TimeoutConfig <span class="hljs-title function_">getTimeoutConfig</span><span class="hljs-params">(String operationType)</span> {
        <span class="hljs-keyword">switch</span> (operationType) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">"fast"</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TimeoutConfig</span>(<span class="hljs-number">1</span>, TimeUnit.SECONDS, 
                    t -&gt; <span class="hljs-string">"fast-timeout"</span>);
            <span class="hljs-keyword">case</span> <span class="hljs-string">"normal"</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TimeoutConfig</span>(<span class="hljs-number">5</span>, TimeUnit.SECONDS,
                    t -&gt; <span class="hljs-string">"normal-timeout"</span>);
            <span class="hljs-keyword">case</span> <span class="hljs-string">"slow"</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TimeoutConfig</span>(<span class="hljs-number">30</span>, TimeUnit.SECONDS,
                    t -&gt; <span class="hljs-string">"slow-timeout"</span>);
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TimeoutConfig</span>(<span class="hljs-number">10</span>, TimeUnit.SECONDS,
                    t -&gt; <span class="hljs-string">"default-timeout"</span>);
        }
    }
}
</code></pre>
<h3 data-id="heading-22">超时控制策略</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd0feab08609426dab28ff92e6ac9b7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763605755&amp;x-signature=y2mZfgiQWKhnvvuBaJn8P%2F9wJ4s%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-23">总结</h2>
<p>通过上面的详细分析，我们可以看到CompletableFuture虽然强大，但也确实存在不少陷阱。</p>
<h3 data-id="heading-24">最后的建议</h3>
<ol>
<li><strong>理解原理</strong>：不要只是机械地使用API，要理解CompletableFuture的工作原理</li>
<li><strong>适度使用</strong>：不是所有场景都需要异步，同步代码更简单易懂</li>
<li><strong>测试覆盖</strong>：异步代码的测试很重要，要覆盖各种边界情况</li>
<li><strong>监控告警</strong>：在生产环境中要有完善的监控和告警机制</li>
<li><strong>持续学习</strong>：关注Java并发编程的新特性和最佳实践</li>
</ol>
<p>记住，工具是为了提高生产力，而不是制造问题。</p>
<p>掌握了这些避坑技巧，CompletableFuture将成为你手中强大的并发编程利器！</p>
<h2 data-id="heading-25">最后说一句(求关注，别白嫖我)</h2>
<p>如果这篇文章对您有所帮助，或者有所启发的话，帮忙关注一下我的同名公众号：苏三说技术，您的支持是我坚持写作最大的动力。</p>
<p>求一键三连：点赞、转发、在看。</p>
<p>关注公众号：【苏三说技术】，在公众号中回复：进大厂，可以免费获取我最近整理的10万字的面试宝典，好多小伙伴靠这个宝典拿到了多家大厂的offer。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Chrome devtools二次开发准备:获取源码和编译]]></title>    <link>https://juejin.cn/post/7571678674144870410</link>    <guid>https://juejin.cn/post/7571678674144870410</guid>    <pubDate>2025-11-12T12:48:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571678674144870410" data-draft-id="7571704212850245683" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Chrome devtools二次开发准备:获取源码和编译"/> <meta itemprop="keywords" content="前端,Google"/> <meta itemprop="datePublished" content="2025-11-12T12:48:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sTone87375"/> <meta itemprop="url" content="https://juejin.cn/user/2946346894764584"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Chrome devtools二次开发准备:获取源码和编译
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2946346894764584/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sTone87375
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T12:48:47.000Z" title="Wed Nov 12 2025 12:48:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Ubuntu 上获取并编译 Google Chrome DevTools Frontend 源码，有两种主流方式：</p>
<ol>
<li>直接下载官方已经打好包的 npm 包（最快，免编译）</li>
<li>用 Google 的 depot_tools 完整拉取 Chromium 源码并自行编译（最完整，可二次开发）</li>
</ol>
<p>下面分别给出步骤，你可以按需求二选一。</p>
<hr/>
<p>一、只想“拿到就用”——用 npm 包（免编译）
官方已经把每天构建好的前端文件发布到 npm，装完就能跑。</p>
<ol>
<li>
<p>安装</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 装包（版本号每天更新，可去 npm 查最新）</span>
npm i -g chrome-devtools-frontend@latest
<span class="hljs-comment"># 进入包目录</span>
<span class="hljs-built_in">cd</span> $(npm root -g)/chrome-devtools-frontend
</code></pre>
</li>
<li>
<p>起静态服务验证</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 任意静态服务器均可</span>
npx http-server . -p 8081
</code></pre>
<p>浏览器访问</p>
<pre><code class="hljs language-bash" lang="bash">http://localhost:8081/front_end/devtools_app.html?ws=localhost:9229
</code></pre>
<p>只要 9229 端口有符合 CDP 的 WebSocket 服务，就能正常调试 。</p>
</li>
</ol>
<hr/>
<p>二、需要“源码级二次开发”——完整拉取并编译
适合想改面板、加功能、追最新主干代码的同学。</p>
<ol start="0">
<li>
<p>系统依赖（Ubuntu 22.04 示例）</p>
<pre><code class="hljs language-bash" lang="bash">sudo apt update
sudo apt install git python3 python3-venv pkg-config \
     build-essential ninja-build nodejs npm curl
</code></pre>
</li>
<li>
<p>准备 depot_tools（Google 的构建工具链）</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://chromium.googlesource.com/chromium/tools/depot_tools.git
<span class="hljs-built_in">echo</span> <span class="hljs-string">'export PATH=$PATH:'</span><span class="hljs-string">"<span class="hljs-subst">$(pwd)</span>/depot_tools"</span> &gt;&gt; ~/.bashrc
<span class="hljs-built_in">source</span> ~/.bashrc
</code></pre>
</li>
<li>
<p>拉取 DevTools Frontend 源码（约 1-2 GB）</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> devtools &amp;&amp; <span class="hljs-built_in">cd</span> devtools
fetch devtools-frontend     <span class="hljs-comment"># 这条命令来自 depot_tools</span>
<span class="hljs-built_in">cd</span> devtools-frontend
</code></pre>
</li>
<li>
<p>同步依赖并生成构建文件</p>
<pre><code class="hljs language-bash" lang="bash">gclient <span class="hljs-built_in">sync</span>                <span class="hljs-comment"># 第一次会下载 Node、Java 运行时等，需科学上网</span>
gn gen out/Default          <span class="hljs-comment"># 生成 Ninja 构建文件</span>
</code></pre>
</li>
<li>
<p>编译（Ubuntu 上约 5-10 分钟，视 CPU 而定）</p>
<pre><code class="hljs language-bash" lang="bash">autoninja -C out/Default    <span class="hljs-comment"># 等价于 ninja -C out/Default，但自动并行</span>
</code></pre>
<p>产物在</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">out</span><span class="hljs-operator">/</span><span class="hljs-keyword">Default</span><span class="hljs-operator">/</span>gen<span class="hljs-operator">/</span>front_end<span class="hljs-operator">/</span>
</code></pre>
<p>即为可运行的 DevTools 前端 。</p>
</li>
<li>
<p>本地预览</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> out/Default/gen/front_end
npx http-server . -p 8081
</code></pre>
<p>浏览器打开</p>
<pre><code class="hljs language-bash" lang="bash">http://localhost:8081/devtools_app.html?ws=localhost:9229
</code></pre>
</li>
<li>
<p>让本地 Chrome 默认使用你编译的版本<br/>
关闭所有 Chrome 后启动</p>
<pre><code class="hljs language-bash" lang="bash">google-chrome --custom-devtools-frontend=file://$(<span class="hljs-built_in">pwd</span>)/out/Default/gen/front_end
</code></pre>
<p>以后按 F12 就会直接加载你改过的面板 。</p>
</li>
</ol>
<hr/>
<p>三、常见问题速查</p>
<ul>
<li>
<p>网络超时：<br/>
<code>fetch</code> / <code>gclient</code> 阶段需要访问 Google 服务器，Ubuntu 下可给终端走代理</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">export</span> https_proxy=http://127.0.0.1:7890 http_proxy=http://127.0.0.1:7890
</code></pre>
</li>
<li>
<p>编译报错缺 header：<br/>
一般把 <code>build-essential</code> 和 <code>pkg-config</code> 补齐即可；若仍缺 <code>java/javac</code>，可再装 <code>openjdk-11-jdk</code>。</p>
</li>
<li>
<p>只想定时拉最新官方构建，而不自己编：<br/>
关注 GitHub 仓库 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Faryasaatvik%2Fchrome-devtools-frontend-build" target="_blank" title="https://github.com/aryasaatvik/chrome-devtools-frontend-build" ref="nofollow noopener noreferrer">aryasaatvik/chrome-devtools-frontend-build</a> 的 releases，每周自动更新已编好的包，下载即用 。</p>
</li>
</ul>
<hr/>
<p>一句话总结</p>
<ul>
<li>“快速体验” → <code>npm i -g chrome-devtools-frontend</code> 即可；</li>
<li>“深度定制” → Ubuntu 装好 depot_tools → <code>fetch devtools-frontend</code> → <code>gn gen</code> → <code>autoninja</code>，完事后 <code>out/Default/gen/front_end</code> 就是你的专属调试器前端。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[还在为HTML转PDF发愁？再介绍两款工具，为你保驾护航！]]></title>    <link>https://juejin.cn/post/7571751304625569838</link>    <guid>https://juejin.cn/post/7571751304625569838</guid>    <pubDate>2025-11-13T02:12:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571751304625569838" data-draft-id="7571758212473749555" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="还在为HTML转PDF发愁？再介绍两款工具，为你保驾护航！"/> <meta itemprop="keywords" content="后端,Java,程序员"/> <meta itemprop="datePublished" content="2025-11-13T02:12:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SimonKing"/> <meta itemprop="url" content="https://juejin.cn/user/4001878056904584"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            还在为HTML转PDF发愁？再介绍两款工具，为你保驾护航！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4001878056904584/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SimonKing
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T02:12:55.000Z" title="Thu Nov 13 2025 02:12:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>关注我的公众号：【编程朝花夕拾】，可获取首发内容。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42b0f46eac5946f38b0d0e83e709783b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763604775&amp;x-signature=XGfEVYv7IQa%2FVvf9k20KoVYhHjw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">01 引言</h2>
<p>在之前专门写了一篇文章《<code>SpringBoot</code>集成：5分钟实现<code>HTML</code>转<code>PDF</code>功能》，介绍三款<code>Html</code>转<code>PDF</code>的工具。这不，又发现了两款类似的工具，整理一下分享给大家。</p>
<h2 data-id="heading-1">02 itext-pdfhtml-java</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/024171cf2f7344d68ee3351459f33583~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763604775&amp;x-signature=GBk7ynYUKAr20K5UleVzP3Z9T7Q%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">2.1 简介</h3>
<p><code>iText pdfHTML</code>是<code>iText7</code>套件的一个附加组件，专门用于将<code>HTML</code>和<code>CSS</code>内容转换为<code>PDF</code>文档。它基于<code>iText</code>核心<code>PDF</code>生成引擎，提供了高质量的<code>HTML</code>到<code>PDF</code>转换功能。性能表现非常优异。</p>
<p>主要特性：</p>
<ul>
<li><strong>完整的<code>HTML5</code>和<code>CSS3</code>支持</strong>：能够处理现代网页布局和样式</li>
<li><strong>字体嵌入</strong>：自动处理Web字体和系统字体</li>
<li><strong>响应式设计</strong>：支持媒体查询和响应式布局</li>
<li><strong>高保真转换</strong>：保持HTML内容的视觉保真度</li>
<li><strong>Java原生</strong>：专为Java生态系统设计</li>
</ul>
<p><code>GitHub</code>地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fitext%2Fitext-pdfhtml-java" target="_blank" title="https://github.com/itext/itext-pdfhtml-java" ref="nofollow noopener noreferrer">github.com/itext/itext…</a></p>
<p>官方地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fitextpdf.com%2Fproducts%2Fconvert-html-css-to-pdf-pdfhtml" target="_blank" title="https://itextpdf.com/products/convert-html-css-to-pdf-pdfhtml" ref="nofollow noopener noreferrer">itextpdf.com/products/co…</a></p>
<h3 data-id="heading-3">2.2 案例</h3>
<p>使用起来也非常简单，下面官方的案例：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca4a7ca81d0d437d9377dd672981f93a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763604775&amp;x-signature=n%2BufL%2FAX17Q1IJJb4bV64o6Je6A%3D" alt="" loading="lazy"/></p>
<p><strong>Maven依赖</strong>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.itextpdf<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>html2pdf<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>6.2.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><strong>实践代码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RequestMapping("index6")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">index6</span><span class="hljs-params">(Model model, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException {
    List&lt;Map&lt;String, Object&gt;&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
        Map&lt;String, Object&gt; item = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        item.put(<span class="hljs-string">"image1"</span>, <span class="hljs-string">"http://example.com/2eb97.jpg"</span>);
        item.put(<span class="hljs-string">"image2"</span>, <span class="hljs-string">"http://example.com/2f9c3.jpg"</span>);
        item.put(<span class="hljs-string">"vehicleName"</span>, <span class="hljs-string">"路虎Defender［卫士］（进口）2023款Defender130 48V［卫士 130 48V] 3.0T手自－体P400 HSE"</span>);
        item.put(<span class="hljs-string">"brandName"</span>, <span class="hljs-string">"路虎"</span>);
        item.put(<span class="hljs-string">"seriesName"</span>, <span class="hljs-string">"Defender［卫士］"</span>);
        item.put(<span class="hljs-string">"modelYear"</span>, <span class="hljs-string">"2023款"</span>);
        item.put(<span class="hljs-string">"licenseYear"</span>, SDF.format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()));
        item.put(<span class="hljs-string">"displayMileage"</span>, DF.format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"9657"</span>)));
        item.put(<span class="hljs-string">"dealDate"</span>, SDF.format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()));
        item.put(<span class="hljs-string">"dealPrice"</span>, DF.format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"702400"</span>)));

        item.put(<span class="hljs-string">"licenseCode"</span>, <span class="hljs-string">"沪A952714"</span>);

        list.add(item);
    }
    model.addAttribute(<span class="hljs-string">"list"</span>, list);
    Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    map.put(<span class="hljs-string">"list"</span>, list);

    <span class="hljs-type">Context</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Context</span>(Locale.getDefault(), map);
    <span class="hljs-type">String</span> <span class="hljs-variable">htmlContent</span> <span class="hljs-operator">=</span> templateEngine.process(<span class="hljs-string">"index"</span>, context);
    System.out.println(htmlContent);

    <span class="hljs-comment">// ---------------------------------------------------</span>
    <span class="hljs-comment">/*itext-html2pdf*/</span>
    <span class="hljs-type">ConverterProperties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConverterProperties</span>();

    <span class="hljs-type">FontProvider</span> <span class="hljs-variable">fontProvider</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FontProvider</span>();
    fontProvider.addSystemFonts();
<span class="hljs-comment">//        fontProvider.addFont("C:\\Windows\\Fonts\\simhei.ttf");</span>
    <span class="hljs-comment">// 添加系统字体</span>
    properties.setFontProvider(fontProvider);

    HtmlConverter.convertToPdf(htmlContent, response.getOutputStream(), properties);
}
</code></pre>
<p>同样默认是不支持中文的，需要通过<code>FontProvider</code>添加指定的字体。<code>fontProvider.addSystemFonts();</code>直接添加系统字体，也可以通过<code>addFont()</code>添加自定义字体。页面必须声明字体，否则会出现乱码。</p>
<h2 data-id="heading-4">03 x-easypdf</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f789e0271ef646d08c9ff65b1d160004~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763604775&amp;x-signature=MzcOsM2iWen1FdY%2FiDzfn9hrK68%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">3.1 简介</h3>
<p><code>x-easypdf</code>是一个<code>java</code>语言简化处理<code>pdf</code>的框架，包含<code>fop</code>模块与<code>pdfbox</code>模块，<code>fop</code>模块以创建功能为主，基于<code>xsl-fo</code>模板生成<code>pdf</code>文档，以数据源的方式进行模板渲染；<code>pdfbox</code>模块以编辑功能为主，对标准的<code>pdfbox</code>进行扩展，添加了成吨的功能。</p>
<p><code>Html</code>转<code>Pdf</code>是<code>pdfbox</code>模块下的一个转化器的功能，是基于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fplaywright.dev%2Fjava%2Fdocs%2Fintro" target="_blank" title="https://playwright.dev/java/docs/intro" ref="nofollow noopener noreferrer">playwright</a> 实现的。而<code>playwright</code>的依赖需要手动引入。<code>Playwright</code>是一个跨语言的浏览器自动化库，由<code>Microsoft</code>开发。虽然主要用于端到端测试，但其强大的<code>PDF</code>生成功能也使其成为<code>HTML</code>转<code>PDF</code>的优秀工具。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92d45b8a6e1b4e38b12f17cd8b94a417~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763604775&amp;x-signature=auTpCKZiPq%2B8JF%2BTr%2B%2BXDxLnfnE%3D" alt="" loading="lazy"/></p>
<p><code>Gitee</code>地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fdromara%2Fx-easypdf" target="_blank" title="https://gitee.com/dromara/x-easypdf" ref="nofollow noopener noreferrer">gitee.com/dromara/x-e…</a></p>
<p>官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fx-easypdf.cn%2F" target="_blank" title="https://x-easypdf.cn/" ref="nofollow noopener noreferrer">x-easypdf.cn/</a></p>
<h3 data-id="heading-6">3.2 案例</h3>
<p><code>x-easypdf</code>是对<code>playwrigh</code>的功能做了一层包装，使用起来更方便。</p>
<p><strong>Maven依赖</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.dromara<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>x-easypdf<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4.7<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.microsoft.playwright<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>playwright<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.53.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><strong>实践代码01</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RequestMapping("index10")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">index10</span><span class="hljs-params">(HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException {
    <span class="hljs-comment">// 获取html转换器</span>
    <span class="hljs-type">HtmlConvertor</span> <span class="hljs-variable">convertor</span> <span class="hljs-operator">=</span> PdfHandler.getDocumentConvertor().getHtmlConvertor();
    <span class="hljs-type">Document</span> <span class="hljs-variable">pdf</span> <span class="hljs-operator">=</span> convertor.toPdf(<span class="hljs-string">"http://127.0.0.1:8080/page/index"</span>);
    pdf.save(response.getOutputStream());
}
</code></pre>
<p><strong>注意事项</strong></p>
<p><code>playwrigh</code>是基于浏览器引擎的，首次调用会下载默认的浏览器，下载完成之后，后续的使用就流畅了。而且默认支持中文，因为使用浏览器引擎，所以对于<code>Html</code>和<code>Css</code>支持较好。但是消耗资源较高。</p>
<p>但是这里<code>convertor.toPdf()</code>目前支持传入地址和文件。不支持直接<code>html</code>内容直接转化的。但是<code>playwrigh</code>本身是支持的。</p>
<p>小编已经给<code>x-easypdf</code>作者提了<code>issues</code>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fdromara%2Fx-easypdf%2Fissues%2FID59TK" target="_blank" title="https://gitee.com/dromara/x-easypdf/issues/ID59TK" ref="nofollow noopener noreferrer">gitee.com/dromara/x-e…</a></p>
<p>**注意：**截止发稿，官方已经在<code>3.5.0</code>版本支持了<code>html</code>内容转<code>Pdf</code>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d21ec3c6eb54a7daec64c339549b078~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763604775&amp;x-signature=7kcF1hIUJPoWys6g%2FV4yWOgDTtA%3D" alt="" loading="lazy"/></p>
<p><strong>实战代码02</strong></p>
<p>使用模板引擎的方式：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90c01f3689904b9ab9a5bb5301649a2a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763604775&amp;x-signature=2pIfLVnU7TbdmZd1c3Q33%2BohlO4%3D" alt="" loading="lazy"/></p>
<p>官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fx-easypdf.cn%2Fguide%2Fpdfbox%2Fadvance%2Ftemplater%2F%25E6%25A8%25A1%25E6%259D%25BF%25E5%25BC%2595%25E6%2593%258E.html%23thymeleaf" target="_blank" title="https://x-easypdf.cn/guide/pdfbox/advance/templater/%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E.html#thymeleaf" ref="nofollow noopener noreferrer">x-easypdf.cn/guide/pdfbo…</a></p>
<p>依然是建立在<code>playwrigh</code>基础之上。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RequestMapping("index12")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">index12</span><span class="hljs-params">(HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException {
    List&lt;Map&lt;String, Object&gt;&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
        Map&lt;String, Object&gt; item = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        item.put(<span class="hljs-string">"image1"</span>, <span class="hljs-string">"http://example.com/2eb97.jpg"</span>);
        item.put(<span class="hljs-string">"image2"</span>, <span class="hljs-string">"http://example.com/2f9c3.jpg"</span>);
        item.put(<span class="hljs-string">"vehicleName"</span>, <span class="hljs-string">"路虎Defender［卫士］（进口）2023款Defender130 48V［卫士 130 48V] 3.0T手自－体P400 HSE"</span>);
        item.put(<span class="hljs-string">"brandName"</span>, <span class="hljs-string">"路虎"</span>);
        item.put(<span class="hljs-string">"seriesName"</span>, <span class="hljs-string">"Defender［卫士］"</span>);
        item.put(<span class="hljs-string">"modelYear"</span>, <span class="hljs-string">"2023款"</span>);
        item.put(<span class="hljs-string">"licenseYear"</span>, SDF.format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()));
        item.put(<span class="hljs-string">"displayMileage"</span>, DF.format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"9657"</span>)));
        item.put(<span class="hljs-string">"dealDate"</span>, SDF.format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()));
        item.put(<span class="hljs-string">"dealPrice"</span>, DF.format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"702400"</span>)));

        item.put(<span class="hljs-string">"licenseCode"</span>, <span class="hljs-string">"沪A952714"</span>);

        list.add(item);
    }
    Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    map.put(<span class="hljs-string">"list"</span>, list);

    <span class="hljs-type">ThymeleafTemplater</span> <span class="hljs-variable">templater</span> <span class="hljs-operator">=</span> PdfHandler.getDocumentTemplater().getThymeleafTemplater();
    templater.setTemplatePath(<span class="hljs-string">"templates"</span>);
    templater.setTemplateName(<span class="hljs-string">"index.html"</span>);
    templater.setTemplateData(map);

    <span class="hljs-comment">// 获取 html 内容</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> templater.getHtmlContent();
    System.out.println(content);

    <span class="hljs-comment">// 转换文档</span>
    <span class="hljs-type">Document</span> <span class="hljs-variable">document</span> <span class="hljs-operator">=</span> templater.transform();
    document.save(response.getOutputStream());
}
</code></pre>
<p>这里需要说明的是：由于<code>x-easypdf</code>自行解析了<code>Thymeleaf</code>模版，所以无法使用<code>spring-boot-starter-thymeleaf</code>的配置。<code>templatePath</code>和<code>templateName</code>都需要写完整。<code>templatePath</code>指<code>classpath</code>下的路径。</p>
<p>模板引擎可能会出现<code>nested exception is java.lang.NoClassDefFoundError: ognl/PropertyAccessor</code>的错误，需要引入<code>ognl</code>，且版本不能超过<code>3.2</code>。从 <code>3.2</code> 开始，会报<code>java.lang.NoClassDefFoundError: ognl/DefaultMemberAccess</code>。有效版本：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>ognl<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ognl<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1.28<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>边距可以通过打印样式控制：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@page</span> {
    size: A4;
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">20px</span>;
}
</code></pre>
<h3 data-id="heading-7">3.3 <code>playwrigh</code>原生写法</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RequestMapping("index11")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">index11</span><span class="hljs-params">(HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException {
    <span class="hljs-keyword">try</span> (<span class="hljs-type">Playwright</span> <span class="hljs-variable">playwright</span> <span class="hljs-operator">=</span> Playwright.create();
         <span class="hljs-type">Browser</span> <span class="hljs-variable">browser</span> <span class="hljs-operator">=</span> playwright.chromium().launch()) {
        <span class="hljs-type">BrowserContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> browser.newContext();
        <span class="hljs-type">Page</span> <span class="hljs-variable">page</span> <span class="hljs-operator">=</span> context.newPage();

        <span class="hljs-comment">// 从HTML内容生成PDF</span>
        page.setContent(<span class="hljs-string">"&lt;h1&gt;Hello, Playwright!&lt;/h1&gt;"</span>);
        <span class="hljs-type">byte</span>[] pdf = page.pdf();

        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bais</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(pdf);
        IOUtils.copy(bais, response.getOutputStream());
    }
}
</code></pre>
<h2 data-id="heading-8">04 小结</h2>
<p><code>iText pdfHTML</code>内存占用低，转换速度快，适合服务器端批量处理。而<code>Playwright</code>需要更多资源，但渲染质量极高，适合对视觉保真度要求高的场景，所以<code>x-easypdf</code>也是一样的。如果只是针对<code>Html</code>转<code>Pdf</code>的服务端转化的场景<code>iText pdfHTML</code>的优势更明显一下，关键它快！</p>
<p>也有粉丝朋友留言说<code>jasperreports</code>也很好用，小编也试了一下。<code>jasperreports</code>需要加载特定的模板，也许是因为不是很熟悉，用起来感觉有点别扭。这里就不推荐了，有兴趣的可以去试试！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Valdi——一个提供原生性能的跨平台 UI 框架]]></title>    <link>https://juejin.cn/post/7571646669201899562</link>    <guid>https://juejin.cn/post/7571646669201899562</guid>    <pubDate>2025-11-12T12:09:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571646669201899562" data-draft-id="7571678388953923603" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Valdi——一个提供原生性能的跨平台 UI 框架"/> <meta itemprop="keywords" content="UI Kit"/> <meta itemprop="datePublished" content="2025-11-12T12:09:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="这儿有一堆花"/> <meta itemprop="url" content="https://juejin.cn/user/3076912575965819"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Valdi——一个提供原生性能的跨平台 UI 框架
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3076912575965819/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    这儿有一堆花
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T12:09:09.000Z" title="Wed Nov 12 2025 12:09:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffd2aef487764ddea9991cb145d12823~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-Z5YS_5pyJ5LiA5aCG6Iqx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554149&amp;x-signature=hy5qLlMfngLqhsBcuqNTafg%2BSN8%3D" alt="近距离代码屏幕" loading="lazy"/></p>
<p>从一个日报起头：移动端团队被要求在两周里把活动页同时上线 iOS、Android 和 macOS。时间紧，交互细，动画还不能掉帧。传统解法要么写三套原生界面，要么走“Web 容器”取巧，结果要么开发效率吃紧，要么性能打折。此时，一个名字近乎低调的框架闯进视野——<strong>Valdi</strong>。它把界面的声明式写法留在 TypeScript，把渲染权交给平台原生视图，试图把“效率与性能只能二选一”的旧逻辑翻过来。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi" title="https://github.com/Snapchat/Valdi" target="_blank" ref="nofollow noopener noreferrer">GitHub</a>)</p>
<h2 data-id="heading-0">它到底是什么</h2>
<p>官方给出的定义非常直接：使用 <strong>声明式 TypeScript/TSX</strong> 写 UI，<strong>编译为 iOS、Android、macOS 的原生视图</strong>，<strong>不依赖 WebView，也没有传统 JS bridge</strong>。因此，列表滚动、复杂手势、系统级动画都沿用原生表现，避免“跨平台层”成为性能瓶颈。该框架在 Snap 的生产环境已经长期服役（内部使用达数年），如今以 <strong>MIT</strong> 许可证开源，当前对外标注为 <strong>Beta</strong>（主要是文档与工具链仍在对开源生态打磨）。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi" title="https://github.com/Snapchat/Valdi" target="_blank" ref="nofollow noopener noreferrer">GitHub</a>)</p>
<p><strong>Valdi GitHub</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjovial-fortune.com%2FK42TvQ" target="_blank" title="https://jovial-fortune.com/K42TvQ" ref="nofollow noopener noreferrer">github.com/Snapchat/Va…</a></p>
<h2 data-id="heading-1">写法长什么样</h2>
<p>在 Valdi 里，界面被写成 TSX 组件。下面的示例展示了“声明—渲染—属性”这一套直觉式流程（语义与官方示例一致，但做了适度裁剪与注释）：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// HelloWorld.tsx</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Component</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'valdi_core/src/Component'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloWorld</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Component</span> {
  <span class="hljs-title function_">onRender</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> message = <span class="hljs-string">'Hello Valdi'</span>;
    <span class="hljs-comment">// 这里的 &lt;view&gt;、&lt;label&gt; 会被编译成平台原生视图（非 WebView）</span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">backgroundColor</span>=<span class="hljs-string">"#FFFC00"</span> <span class="hljs-attr">padding</span>=<span class="hljs-string">{24}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"black"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{message}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span></span>;
  }
}
</code></pre>
<p>这种写法的关键不在“看起来像 React”，而在“<strong>最终落地的是原生控件</strong>”。渲染层的工作交给平台本身，框架则在编译期与运行期开启一系列性能手段（视图池复用、按可视区域增量渲染、组件级别的独立重渲），尽量不把重负留在跨层通信上。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi" title="https://github.com/Snapchat/Valdi" target="_blank" ref="nofollow noopener noreferrer">GitHub</a>)</p>
<p><strong>Valdi 文档与入门</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjovial-fortune.com%2Fb.3-VN0%2FP%2F3Np%2FvObOmBVmJvZ%2FDA0%2F2HMoD%2FQDw%2FNjDJAH3%2FL%2FTyYzwpNXD%2FA_0rM-Dtgj" target="_blank" title="https://jovial-fortune.com/b.3-VN0/P/3Np/vObOmBVmJvZ/DA0/2HMoD/QDw/NjDJAH3/L/TyYzwpNXD/A_0rM-Dtgj" ref="nofollow noopener noreferrer">github.com/Snapchat/Va…</a>**</p>
<h2 data-id="heading-2">为什么在意“原生性能”</h2>
<p>跨平台 UI 的历史里，性能问题往往来自两处：
其一是 <strong>渲染容器</strong>——WebView 或自绘引擎在“贴近系统”上天生吃亏；其二是 <strong>桥接成本</strong>——当状态频繁变动、动画密集、列表超长时，跨语言/跨进程通信会变成隐形税。Valdi 的路径是**“把 UI 编译成原生控件”**，并围绕这个落点做优化：</p>
<ul>
<li>全局 <strong>视图池</strong> 回收与复用，降低视图创建/销毁成本；</li>
<li><strong>独立组件重渲</strong>，避免祖先节点无谓更新；</li>
<li><strong>可视区域感知</strong> 布局与渲染，天生适配长列表与分页；</li>
<li>布局引擎以 <strong>C++</strong> 实现并运行在主线程，减少跨层编组。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi" title="https://github.com/Snapchat/Valdi" target="_blank" ref="nofollow noopener noreferrer">GitHub</a>)</li>
</ul>
<p>这些点不是花拳绣腿，而是移动端耗时热点的“直线突击”。在信息流、商城、消息类应用中尤其明显：首屏更快出现，滚动更稳，滑动手感更接近系统原生控件。</p>
<h2 data-id="heading-3">工程化与开发体验</h2>
<p>效率层面，Valdi 不只是在语法上“像 React”。它辅以 <strong>即时热重载</strong>（毫秒级见效）、<strong>VS Code 调试与性能剖析</strong>、与 <strong>Bazel</strong> 的集成以保障构建复用与可重复。需要原生接口时，可通过 <strong>多语言模块（Polyglot Modules）</strong> 生成 <strong>TypeScript ↔ Kotlin/Swift/ObjC</strong> 的类型安全绑定，既能复用既有原生库，又能把性能关键路径留在原生侧实现。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi" title="https://github.com/Snapchat/Valdi" target="_blank" ref="nofollow noopener noreferrer">GitHub</a>)</p>
<p><strong>Bazel</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjovial-fortune.com%2FK42TvQ" target="_blank" title="https://jovial-fortune.com/K42TvQ" ref="nofollow noopener noreferrer">bazel.build/</a></p>
<h2 data-id="heading-4">迁移与落地的“故事线”</h2>
<p>一个常见落地顺序是这样的：
先把一个<strong>独立页面</strong>或<strong>新功能入口</strong>用 Valdi 重写，内嵌到 UIKit/Android View 的树里做 A/B；性能验证后，再逐步扩大接入面。此时，原生与 Valdi 的<strong>双向嵌入</strong>能力（“在原生里放 Valdi 视图”与“在 Valdi 里嵌原生控件”）就像安全带，既不破坏既有工程，又给新栈足够的发挥空间。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi" title="https://github.com/Snapchat/Valdi" target="_blank" ref="nofollow noopener noreferrer">GitHub</a>)</p>
<p>在数据通路上，团队可以把网络层、图片加载、埋点等继续留在原生模块里，通过类型安全的绑定暴露给 TypeScript。较重的计算（如协议编解码、复杂 diff、媒体管线）可以走 C++ 或平台原生语言；Valdi 提供的 <strong>worker 线程</strong> 能让 JS 侧在不阻塞 UI 的情况下完成部分并行任务。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi" title="https://github.com/Snapchat/Valdi" target="_blank" ref="nofollow noopener noreferrer">GitHub</a>)</p>
<h2 data-id="heading-5">与“别的跨平台”的差异</h2>
<ul>
<li>与 <strong>WebView 系</strong>（Hybrid/H5）不同：渲染不是网页，UI 不是 DOM；因此滚动、手势、导航条这类系统元素更贴近平台期望。</li>
<li>与 <strong>桥接式 JS Runtime</strong>（重度依赖桥的方案）不同：Valdi 通过编译期把“声明式树”降解为原生视图，并尽量在渲染与布局阶段减少跨层通信频率。</li>
<li>与 <strong>纯自绘引擎</strong> 不同：Valdi 倾向“调系统控件”，从而继承各平台在无障碍、输入法、可达性、手势冲突处理等方面的成熟经验。以上差异点均来自其官方的渲染路线与性能要点描述。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi" title="https://github.com/Snapchat/Valdi" target="_blank" ref="nofollow noopener noreferrer">GitHub</a>)</li>
</ul>
<p><strong>Hacker News 讨论帖</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjovial-fortune.com%2Fb.3-VN0%2FP%2F3Np%2FvObOmBVmJvZ%2FDA0%2F2HMoD%2FQDw%2FNjDJAH3%2FL%2FTyYzwpNXD%2FA_0rM-Dtgj" target="_blank" title="https://jovial-fortune.com/b.3-VN0/P/3Np/vObOmBVmJvZ/DA0/2HMoD/QDw/NjDJAH3/L/TyYzwpNXD/A_0rM-Dtgj" ref="nofollow noopener noreferrer">news.ycombinator.com/item?id=458…</a>**</p>
<h2 data-id="heading-6">一个更完整的页面例子</h2>
<p>下面构造一个稍微“像样”的列表页面：顶部标题、主题切换、可复用的 Cell，以及一个在可视区域内才渲染的长列表。逻辑演示为主：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// Feed.tsx</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Component</span>, state } <span class="hljs-keyword">from</span> <span class="hljs-string">'valdi_core/src/Component'</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = { <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">subtitle</span>: <span class="hljs-built_in">string</span> };

<span class="hljs-keyword">function</span> <span class="hljs-title function_">FeedCell</span>(<span class="hljs-params">props: { item: Item }</span>) {
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">padding</span>=<span class="hljs-string">{16}</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{props.item.title}</span> <span class="hljs-attr">fontSize</span>=<span class="hljs-string">{17}</span> <span class="hljs-attr">weight</span>=<span class="hljs-string">"semibold"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{props.item.subtitle}</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"#666"</span> <span class="hljs-attr">marginTop</span>=<span class="hljs-string">{6}</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span></span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Feed</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Component</span> {
  <span class="hljs-meta">@state</span> <span class="hljs-keyword">private</span> dark = <span class="hljs-literal">false</span>;
  <span class="hljs-meta">@state</span> <span class="hljs-keyword">private</span> <span class="hljs-attr">items</span>: <span class="hljs-title class_">Item</span>[] = [];

  <span class="hljs-title function_">onMount</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 模拟异步请求</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span> = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">2000</span> }).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> ({
      <span class="hljs-attr">id</span>: <span class="hljs-title class_">String</span>(i),
      <span class="hljs-attr">title</span>: <span class="hljs-string">`Card <span class="hljs-subst">${i}</span>`</span>,
      <span class="hljs-attr">subtitle</span>: <span class="hljs-string">`Valdi compiles to native views`</span>,
    }));
  }

  <span class="hljs-keyword">private</span> <span class="hljs-title function_">toggleTheme</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dark</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">dark</span>;
  }

  <span class="hljs-title function_">onRender</span>(<span class="hljs-params"/>) {
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">backgroundColor</span>=<span class="hljs-string">{this.dark</span> ? '#<span class="hljs-attr">111</span>' <span class="hljs-attr">:</span> '#<span class="hljs-attr">fff</span>'}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">padding</span>=<span class="hljs-string">{16}</span> <span class="hljs-attr">direction</span>=<span class="hljs-string">"row"</span> <span class="hljs-attr">align</span>=<span class="hljs-string">"center"</span> <span class="hljs-attr">justify</span>=<span class="hljs-string">"space-between"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"Explore"</span> <span class="hljs-attr">fontSize</span>=<span class="hljs-string">{20}</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onTap</span>=<span class="hljs-string">{()</span> =&gt;</span> this.toggleTheme()}&gt;
          <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{this.dark</span> ? '<span class="hljs-attr">Light</span>' <span class="hljs-attr">:</span> '<span class="hljs-attr">Dark</span>'} /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>

      {/* 列表仅对可视区域进行增量渲染，长列表默认可流畅滚动 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">list</span>
        <span class="hljs-attr">data</span>=<span class="hljs-string">{this.items}</span>
        <span class="hljs-attr">keyFor</span>=<span class="hljs-string">{(it:</span> <span class="hljs-attr">Item</span>) =&gt;</span> it.id}
        renderItem={(it: Item) =&gt; <span class="hljs-tag">&lt;<span class="hljs-name">FeedCell</span> <span class="hljs-attr">item</span>=<span class="hljs-string">{it}</span> /&gt;</span>}
        estimatedItemHeight={72}
      /&gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span></span>;
  }
}
</code></pre>
<p>这个例子对应了 Valdi 的三件“拿手活”：<strong>视图池复用</strong>（大量 Cell 循环利用）、<strong>组件级独立重渲</strong>（切换暗黑只让受影响区域更新）、以及<strong>按可视窗口渲染</strong>（大列表默认丝滑）。这些都在其 README 的性能段落中明确列出。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi" title="https://github.com/Snapchat/Valdi" target="_blank" ref="nofollow noopener noreferrer">GitHub</a>)</p>
<h2 data-id="heading-7">风险与边界</h2>
<p>任何跨平台方案都不是“银弹”。Valdi 当前仍处 <strong>Beta</strong> 对外阶段，开源生态的文档、第三方组件、最佳实践沉淀需要时间；同时，团队需要具备原生与 TypeScript 并行的工程能力（特别是当接入平台能力、排查系统层问题时）。不过，从路线选择看，它将“性能优先”的矛盾点拉回到原生栈里，减少了“解释层/桥接层”把控体验的变量。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi" title="https://github.com/Snapchat/Valdi" target="_blank" ref="nofollow noopener noreferrer">GitHub</a>)</p>
<hr/>
<p><strong>Valdi GitHub</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjovial-fortune.com%2FK42TvQ" target="_blank" title="https://jovial-fortune.com/K42TvQ" ref="nofollow noopener noreferrer">github.com/Snapchat/Va…</a>**
<strong>Valdi 入门与示例</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjovial-fortune.com%2FK42TvQ" target="_blank" title="https://jovial-fortune.com/K42TvQ" ref="nofollow noopener noreferrer">github.com/Snapchat/Va…</a>**
<strong>Bazel（构建工具）</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjovial-fortune.com%2FK42TvQ" target="_blank" title="https://jovial-fortune.com/K42TvQ" ref="nofollow noopener noreferrer">bazel.build/</a>**</p>
<hr/>
<h3 data-id="heading-8">小结</h3>
<p>Valdi 的价值主张并不花哨：<strong>用 TypeScript 写声明式 UI，把渲染交还给原生</strong>。这一取舍，使其在“多端一致与原生体验”之间取得少见的平衡。对于正在寻找“性能不妥协、又能快速迭代”的团队，这是值得严肃评估的一条技术路径。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi" title="https://github.com/Snapchat/Valdi" target="_blank" ref="nofollow noopener noreferrer">GitHub</a>)</p>
<blockquote>
<p>参考依据：框架定位、编译为原生视图、性能特性（视图池、布局引擎、可视区域渲染）、工程化能力（热重载、VS Code 调试、Bazel、多语言绑定）、开源许可与 Beta 状态等，均摘自 Valdi 官方 GitHub 仓库与开源发布信息。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi" title="https://github.com/Snapchat/Valdi" target="_blank" ref="nofollow noopener noreferrer">GitHub</a>)</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[剑指offer-37、数字在升序数组中出现的次数]]></title>    <link>https://juejin.cn/post/7571781196297420809</link>    <guid>https://juejin.cn/post/7571781196297420809</guid>    <pubDate>2025-11-13T02:27:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571781196297420809" data-draft-id="7569910533508923411" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="剑指offer-37、数字在升序数组中出现的次数"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-11-13T02:27:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            剑指offer-37、数字在升序数组中出现的次数
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T02:27:28.000Z" title="Thu Nov 13 2025 02:27:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">题目描述</h2>
<p>统计⼀个数字在升序数组中出现的次数。</p>
<p>示例1
输⼊：[1,2,3,3,3,3,4,5],3
返回值：4</p>
<h2 data-id="heading-1">思路及解答</h2>
<h3 data-id="heading-2">线性遍历</h3>
<p>顺序遍历数组，遇到目标值就计数</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">GetNumberOfK</span><span class="hljs-params">(<span class="hljs-type">int</span>[] array, <span class="hljs-type">int</span> k)</span> {
        <span class="hljs-keyword">if</span> (array == <span class="hljs-literal">null</span> || array.length == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }
        
        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; array.length; i++) {
            <span class="hljs-keyword">if</span> (array[i] == k) {
                count++;
            }
            <span class="hljs-comment">// 由于数组有序，如果当前元素已大于k，可提前结束</span>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (array[i] &gt; k) {
                <span class="hljs-keyword">break</span>;
            }
        }
        <span class="hljs-keyword">return</span> count;
    }
}
</code></pre>
<ul>
<li><strong>时间复杂度</strong>​：O(n)，最坏情况下需要遍历整个数组</li>
<li>​<strong>空间复杂度</strong>​：O(1)，只使用常数级别额外空间</li>
</ul>
<h3 data-id="heading-3">二分查找+左右扫描法</h3>
<p>先使用二分查找定位到目标值，然后向两边扩展统计。</p>
<p>由于数组是有序的，可以明显看到是二分法。</p>
<p>第1步是找出数值为 k 的数的索引：
假设数组为 nums[] ，⼀开始的左边索引为 left = 0 ，右边界索引为 right = nums.length-1</p>
<ol>
<li>将数组分成两部分，中间的数为 nums[mid] 。第1部分为 [left,mid] ,第2部分为[mid+1,right]。</li>
<li>如果 nums[mid]&gt;k ,则说明 k 只可能存在前半部分中，对前半部分执⾏操作1。</li>
<li>如果 nums[mid]&lt;k ,则说明 k 只可能存在后半部分中，对后半部分执⾏操作1。</li>
<li>如果 nums[mid]=k ,直接返回当前索引 mid 。</li>
<li>如果 left &gt; right ,说明 k 不存在，则返回 -1 。</li>
</ol>
<p>找到索引之后，往两边扩展，同时统计k的个数，直到元素不等于 k 的时候停⽌。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b060f0fde494c77a3c1f34b60fcc121~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763605647&amp;x-signature=aICGJGvTeAoApVvJr%2F3QY0dIq2w%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">GetNumberOfK</span><span class="hljs-params">(<span class="hljs-type">int</span>[] array, <span class="hljs-type">int</span> k)</span> {
        <span class="hljs-keyword">if</span> (array == <span class="hljs-literal">null</span> || array.length == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-type">int</span> <span class="hljs-variable">left</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, right = array.length - <span class="hljs-number">1</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-comment">// 二分查找</span>
        <span class="hljs-keyword">while</span> (left &lt;= right) {
            <span class="hljs-type">int</span> <span class="hljs-variable">mid</span> <span class="hljs-operator">=</span> left + (right - left) / <span class="hljs-number">2</span>;
            
            <span class="hljs-keyword">if</span> (array[mid] &lt; k) {
                left = mid + <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (array[mid] &gt; k) {
                right = mid - <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 找到目标值，向左右扩展统计</span>
                count = <span class="hljs-number">1</span>;
                <span class="hljs-type">int</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> mid;
                
                <span class="hljs-comment">// 向左统计</span>
                <span class="hljs-keyword">while</span> (--temp &gt;= left &amp;&amp; array[temp] == k) {
                    count++;
                }
                
                <span class="hljs-comment">// 向右统计</span>
                temp = mid;
                <span class="hljs-keyword">while</span> (++temp &lt;= right &amp;&amp; array[temp] == k) {
                    count++;
                }
                <span class="hljs-keyword">break</span>;
            }
        }
        <span class="hljs-keyword">return</span> count;
    }
}
</code></pre>
<ul>
<li>​<strong>时间复杂度</strong>​：O(log n + k)，其中k是目标值出现次数。当目标值出现次数较少时效率接近O(log n)，但最坏情况（全部是目标值）退化为O(n)</li>
<li>​<strong>空间复杂度</strong>​：O(1)</li>
</ul>
<h3 data-id="heading-4">双二分查找法（推荐）</h3>
<p>分别使用二分查找找到目标值的起始和结束位置，计算区间长度，这是最优解法。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">GetNumberOfK</span><span class="hljs-params">(<span class="hljs-type">int</span>[] array, <span class="hljs-type">int</span> k)</span> {
        <span class="hljs-keyword">if</span> (array == <span class="hljs-literal">null</span> || array.length == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-comment">// 找到第一个k的位置</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">firstIndex</span> <span class="hljs-operator">=</span> findFirstPosition(array, k);
        <span class="hljs-comment">// 找到最后一个k的位置</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">lastIndex</span> <span class="hljs-operator">=</span> findLastPosition(array, k);
        
        <span class="hljs-keyword">if</span> (firstIndex == -<span class="hljs-number">1</span> || lastIndex == -<span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 目标值不存在</span>
        }
        
        <span class="hljs-keyword">return</span> lastIndex - firstIndex + <span class="hljs-number">1</span>;
    }
    
    <span class="hljs-comment">/**
     * 查找目标值的第一个出现位置
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">findFirstPosition</span><span class="hljs-params">(<span class="hljs-type">int</span>[] array, <span class="hljs-type">int</span> k)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">left</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, right = array.length - <span class="hljs-number">1</span>;
        
        <span class="hljs-keyword">while</span> (left &lt;= right) {
            <span class="hljs-type">int</span> <span class="hljs-variable">mid</span> <span class="hljs-operator">=</span> left + (right - left) / <span class="hljs-number">2</span>;
            
            <span class="hljs-keyword">if</span> (array[mid] &lt; k) {
                left = mid + <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (array[mid] &gt; k) {
                right = mid - <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 关键：检查是否为第一个出现位置</span>
                <span class="hljs-keyword">if</span> (mid == <span class="hljs-number">0</span> || array[mid - <span class="hljs-number">1</span>] != k) {
                    <span class="hljs-keyword">return</span> mid;
                } <span class="hljs-keyword">else</span> {
                    right = mid - <span class="hljs-number">1</span>; <span class="hljs-comment">// 继续在左半部分查找</span>
                }
            }
        }
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>; <span class="hljs-comment">// 未找到</span>
    }
    
    <span class="hljs-comment">/**
     * 查找目标值的最后一个出现位置
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">findLastPosition</span><span class="hljs-params">(<span class="hljs-type">int</span>[] array, <span class="hljs-type">int</span> k)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">left</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, right = array.length - <span class="hljs-number">1</span>;
        
        <span class="hljs-keyword">while</span> (left &lt;= right) {
            <span class="hljs-type">int</span> <span class="hljs-variable">mid</span> <span class="hljs-operator">=</span> left + (right - left) / <span class="hljs-number">2</span>;
            
            <span class="hljs-keyword">if</span> (array[mid] &lt; k) {
                left = mid + <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (array[mid] &gt; k) {
                right = mid - <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 关键：检查是否为最后一个出现位置</span>
                <span class="hljs-keyword">if</span> (mid == array.length - <span class="hljs-number">1</span> || array[mid + <span class="hljs-number">1</span>] != k) {
                    <span class="hljs-keyword">return</span> mid;
                } <span class="hljs-keyword">else</span> {
                    left = mid + <span class="hljs-number">1</span>; <span class="hljs-comment">// 继续在右半部分查找</span>
                }
            }
        }
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>; <span class="hljs-comment">// 未找到</span>
    }
}
</code></pre>
<ul>
<li>​<strong>时间复杂度</strong>​：O(log n)，执行两次二分查找</li>
<li>​<strong>空间复杂度</strong>​：O(1)，只使用常数空间</li>
</ul>
<h3 data-id="heading-5">k±0.5边界查找法</h3>
<p>一种巧妙的解法，通过查找目标值边界的插入位置来计算出现次数。</p>
<p>由于数组元素都是整数，k-0.5和k+0.5正好是目标值范围的边界，它们的插入位置差值就是目标值出现次数</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">GetNumberOfK</span><span class="hljs-params">(<span class="hljs-type">int</span>[] array, <span class="hljs-type">int</span> k)</span> {
        <span class="hljs-keyword">if</span> (array == <span class="hljs-literal">null</span> || array.length == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-comment">// 查找k+0.5的插入位置（第一个大于k的位置）</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">upperBound</span> <span class="hljs-operator">=</span> findInsertPosition(array, k + <span class="hljs-number">0.5</span>);
        <span class="hljs-comment">// 查找k-0.5的插入位置（第一个大于等于k的位置）</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">lowerBound</span> <span class="hljs-operator">=</span> findInsertPosition(array, k - <span class="hljs-number">0.5</span>);
        
        <span class="hljs-keyword">return</span> upperBound - lowerBound;
    }
    
    <span class="hljs-comment">/**
     * 在有序数组中查找目标值的插入位置
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">findInsertPosition</span><span class="hljs-params">(<span class="hljs-type">int</span>[] array, <span class="hljs-type">double</span> target)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">left</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, right = array.length - <span class="hljs-number">1</span>;
        
        <span class="hljs-keyword">while</span> (left &lt;= right) {
            <span class="hljs-type">int</span> <span class="hljs-variable">mid</span> <span class="hljs-operator">=</span> left + (right - left) / <span class="hljs-number">2</span>;
            
            <span class="hljs-keyword">if</span> (array[mid] &lt; target) {
                left = mid + <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">else</span> {
                right = mid - <span class="hljs-number">1</span>;
            }
        }
        <span class="hljs-keyword">return</span> left; <span class="hljs-comment">// 返回插入位置</span>
    }
}
</code></pre>
<ul>
<li>​<strong>时间复杂度</strong>​：O(log n)，两次二分查找</li>
<li>​<strong>空间复杂度</strong>​：O(1)</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java + Spring 到 Python + FastAPI （一）]]></title>    <link>https://juejin.cn/post/7571743311519924233</link>    <guid>https://juejin.cn/post/7571743311519924233</guid>    <pubDate>2025-11-13T01:49:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571743311519924233" data-draft-id="7571621555513360438" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java + Spring 到 Python + FastAPI （一）"/> <meta itemprop="keywords" content="Java,Python,Spring"/> <meta itemprop="datePublished" content="2025-11-13T01:49:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小兵张健"/> <meta itemprop="url" content="https://juejin.cn/user/1257497032405229"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java + Spring 到 Python + FastAPI （一）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1257497032405229/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小兵张健
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T01:49:27.000Z" title="Thu Nov 13 2025 01:49:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>Java 程序员越来越被唾弃，我看 BOSS 直聘上有的公司在要求里面明文写不要 Java 程序员，感觉自己受到了侮辱，一怒之下怒了一下，既然如此别怪我心狠手辣用 Python + FastAPI 把之前 Java + Spring 的项目重写一遍。</p>
</blockquote>
<p>此文涉及 MySQL、Kafka、Redis 组件和用户、资金、订单模块，整体从 Java 迁移到 Python 所需的知识点。</p>
<h2 data-id="heading-0">语言思维转换</h2>
<p>Java 的语法很臃肿，如果会 Java 再看其他语言简直降维打击，学起来没什么难度，顶多是底层的一些设计、架构不一样。</p>
<p>Python 是动态语言，比如</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-comment"># 传统 Python</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>):
    <span class="hljs-keyword">return</span> a + b

add(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)       <span class="hljs-comment"># 结果是 3</span>
add(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>)   <span class="hljs-comment"># 结果是 "ab"</span>
</code></pre>
<p>没有类型校验，没有运行前编译，看起来非常不安全。于是有了 <strong>Pydantic</strong>。</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">add_with_hints</span>(<span class="hljs-params">a: <span class="hljs-built_in">int</span>, b: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:
    <span class="hljs-keyword">return</span> a + b
</code></pre>
<p>括号里面是参数，-&gt; int 是返回值，用了 Type Hints，相当于一种提示，让 Pydantic 读取到后进行校验和转换。</p>
<p>列举一个接口的例子，比如 Java</p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-comment">// 1. DTO 类 (POJO)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CreateUserDTO</span> {
    
    <span class="hljs-comment">// 2. Validation (javax.validation)</span>
    <span class="hljs-meta">@NotNull</span>
    <span class="hljs-meta">@Size(min = 3, max = 50)</span>
    <span class="hljs-keyword">private</span> String username;
    
    <span class="hljs-meta">@Min(18)</span>
    <span class="hljs-keyword">private</span> Integer age;
    
    <span class="hljs-comment">// Getters and Setters... (由 Jackson 用于序列化)</span>
}

<span class="hljs-comment">// 3. Controller (Jackson + Validation)</span>
<span class="hljs-meta">@PostMapping("/users")</span>
<span class="hljs-keyword">public</span> ResponseEntity&lt;?&gt; createUser(<span class="hljs-meta">@Valid</span> <span class="hljs-meta">@RequestBody</span> CreateUserDTO userDTO) {
    <span class="hljs-comment">// 到了这里，userDTO 已经被 Jackson 解析，并被 Validation 校验过了</span>
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>而 Python + FastAPI + Pydantic 是</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span> <span class="hljs-comment"># 对应 Java 的 Optional 或 null</span>

<span class="hljs-comment"># 1. Pydantic 模型 (这一个东西 = Java 的 DTO + Validation + Jackson 注解)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CreateUserDTO</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-comment"># 对应 @NotNull 和 @Size</span>
    username: <span class="hljs-built_in">str</span> = Field(..., min_length=<span class="hljs-number">3</span>, max_length=<span class="hljs-number">50</span>) 
    
    <span class="hljs-comment"># 对应 @Min(18) 和 可选 (Integer 而非 int)</span>
    age: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">int</span>] = Field(<span class="hljs-literal">None</span>, ge=<span class="hljs-number">18</span>) <span class="hljs-comment"># ge = Greater than or Equal</span>
    
    <span class="hljs-comment"># 注意：</span>
    <span class="hljs-comment"># 1. ... (三个点) 表示这个字段是必填的</span>
    <span class="hljs-comment"># 2. Field(None, ...) 表示这个字段是可选的 (默认值为 None)</span>


<span class="hljs-comment"># 2. FastAPI 路由</span>
<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/users"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_user</span>(<span class="hljs-params">user_dto: CreateUserDTO</span>):
    <span class="hljs-comment"># 到了这里，Pydantic 已经自动完成了：</span>
    <span class="hljs-comment"># 1. 读取 JSON 请求体 (像 Jackson)</span>
    <span class="hljs-comment"># 2. 按照类型提示 (str, int) 校验和转换数据</span>
    <span class="hljs-comment"># 3. 运行校验规则 (min_length, ge) (像 javax.validation)</span>
    <span class="hljs-comment"># 4. 如果校验失败，自动返回一个 422 错误的 JSON 响应</span>
    
    <span class="hljs-comment"># 你可以直接使用这个对象</span>
    <span class="hljs-comment"># user_dto.username </span>
    
    <span class="hljs-keyword">return</span> user_dto
</code></pre>
<p>Python 里面的 <strong>Optional</strong> 和 Java 里面是同一个意思，写法不一样，Python 里面把八大基本类型的包装类也用 Optional 表示。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e09813d413aa4300af942eafd2e30064~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5YW15byg5YGl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603367&amp;x-signature=Avor%2BvoN0Zvf4%2B%2FRe4EW%2F35%2FhNQ%3D" alt="image.png" loading="lazy"/></p>
<p>Python 里没有 Lombok，直接.属性就行。</p>
<h2 data-id="heading-1">并发模型</h2>
<p>这是 Java 和 Python 最大的不同，Java 是多线程，在 Spring Web 中一个请求就是一个线程（非 WebFlux），Tomcat 里面配置最大线程数就这个作用。线程内是阻塞的，比如查数据库线程就停那了，等待数据完成了继续执行。</p>
<p>Python 用的 asyncio 单线程事件循环。查数据库的时候，线程去执行别的，直到数据拿到了再接着执行。（具体流程后面详细分解）</p>
<p>比如这个接口逻辑</p>
<ul>
<li>
<p>查用户</p>
</li>
<li>
<p>查商品</p>
</li>
<li>
<p>写订单</p>
</li>
<li>
<p>写订单详情</p>
</li>
</ul>
<p>Java 是</p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-comment">// 线程 1</span>
<span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrder</span><span class="hljs-params">(...)</span> {
    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userRepo.findById(...);      <span class="hljs-comment">// (线程 1 阻塞，等待 5ms)</span>
    <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> productRepo.findById(...); <span class="hljs-comment">// (线程 1 阻塞，等待 5ms)</span>
    
    <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>(...);
    orderRepo.save(order);                   <span class="hljs-comment">// (线程 1 阻塞，等待 10ms)</span>
    
    <span class="hljs-type">OrderDetail</span> <span class="hljs-variable">detail</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderDetail</span>(...);
    detailRepo.save(detail);                 <span class="hljs-comment">// (线程 1 阻塞，等待 10ms)</span>
    
    <span class="hljs-keyword">return</span> order; <span class="hljs-comment">// 总耗时：5+5+10+10 = 30ms (线程 1 被独占 30ms)</span>
}
</code></pre>
<p>Python 是</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-comment"># 单个事件循环线程</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_order</span>(<span class="hljs-params">...</span>):
    <span class="hljs-comment"># 'await'：我把控制权交回事件循环</span>
    user = <span class="hljs-keyword">await</span> user_repo.get_by_id(...)      <span class="hljs-comment"># (I/O 开始，任务暂停)</span>
    
    <span class="hljs-comment"># ... 某个未来的时刻，事件循环恢复了我的执行 ...</span>
    
    product = <span class="hljs-keyword">await</span> product_repo.get_by_id(...) <span class="hljs-comment"># (I/O 开始，任务再次暂停)</span>
    
    <span class="hljs-comment"># ... 再次恢复 ...</span>
    
    order = Order(...)
    <span class="hljs-keyword">await</span> order_repo.save(order)              <span class="hljs-comment"># (I/O 开始，任务再次暂停)</span>
    
    <span class="hljs-comment"># ... 再次恢复 ...</span>
    
    detail = OrderDetail(...)
    <span class="hljs-keyword">await</span> detail_repo.save(detail)            <span class="hljs-comment"># (I/O 开始，任务再次暂停)</span>
    
    <span class="hljs-comment"># ... 再次恢复 ...</span>
    
    <span class="hljs-keyword">return</span> order <span class="hljs-comment"># 总耗时：还是 30ms (I/O 总时间)</span>
</code></pre>
<p>这导致的第一重大变化是 ThreadLocal 没了，之前用户登录的 token 可以用 AOP 一路带到线程里，在 Python 里面用 FastAPI 的 Depends 解决，后面想说。</p>
<p>第二个是 async 必须全程到底，一个方法用了，所有上下游调用都用，外部的 MySQL、Kafka 这种组件也要用 async 的版本。</p>
<h3 data-id="heading-2">那为什么 Python 是单线程的？</h3>
<p>主要是 Python 的 RAM 内存管理用的 GLC（Global Interpreter Lock），不像 Java 有复杂的 GC 垃圾回收机制，GLC 在用到对象的<strong>引用计数</strong> + 1，没用到 -1，为 0 则清理，为了防止多线程 RAM 内存出问题，有了 GLC。</p>
<p>asyncio 就是用单线程多进程（协程）的方式，提高并发。</p>
<h3 data-id="heading-3">进程、线程、协程有什么区别？</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a689179bade9434cae7cd1f6252b9abe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5YW15byg5YGl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603367&amp;x-signature=0raHfLx%2BwpAwgQE2B%2BCEQFa756A%3D" alt="image.png" loading="lazy"/></p>
<p>打开 Win 的任务管理器，最外层的 Micosoft Edge 就一个进程，括号里的 18 就是 18 的线程，协程一种特殊的线程，可以很快速的在不同任务之间切换，asyncio 里面这么叫。</p>
<h3 data-id="heading-4">Python + asyncio 这么搞效率岂不是很低？多核处理器怎么办？</h3>
<p>其实 CPU 的速度是远超 IO 的，老早之前单核 CPU 就有时间切片模拟成多核，服务器大都是 IO 密集型，卡在查 MySQL、Kafka、Redis 等，这样其实更高效。</p>
<p>每个线程的启动都要消耗几 M 的 RAM，线程上下文切换也比较耗资源，进程之间效率高得多。</p>
<p>线上真实的多核处理器服务器，会用进程管理器 <strong>Gunicorn</strong> 根据服务器核心数启动多个 Python 进程，由 Gunicorn 将请求分发。</p>
<h3 data-id="heading-5">asyncio 的原理</h3>
<p>asyncio 底层有两个组件，<strong>Ready Queue</strong> 和 <strong>Waiting Map</strong>。Ready Queue 是可以立即执行的队列，Waiting Map 是异步等待唤醒的任务。</p>
<p>以为一个请求流程为例</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_order</span>(<span class="hljs-params">...</span>):
    <span class="hljs-comment"># 你的代码从这里开始执行</span>
    user_data = <span class="hljs-keyword">await</span> request.json()  <span class="hljs-comment"># 假设这是第一个 await (I/O)</span>
    ...
</code></pre>
<p>这些代码都先当做任务放到 Ready Queue，直到遇到第一个 await 则暂停，把任务移动到 Waiting Map，然后从 Ready Queue 取下一个任务执行。直到所有的 Ready Queue 都执行完成。</p>
<p>一个是 Queue 一个是 Map，Queue 存的是任务，Map 中存的是任务 + 回调，这样数据回调的时候知道去执行哪个任务。</p>
<p>await 交给操作系统系统 OS 处理，在日常开发中比如付款场景等支付宝回调，在这里类似。</p>
<p>await 告诉操作系统帮我查下 MySQL，有结果了通知我。但不同的操作系统通知方式不一样，Mac UNIX 的 kqueue、Linux 的 epoll 属于<strong>Reactor 的就绪通知</strong>，Win 的 IOPC 属于<strong>Proactor 的回调</strong>。</p>
<p>他俩区别是系统 OS 层的，涉及网卡、数据流那些，Proactor 帮忙把数据流复制了一份，Reactor 则自己去 read() write()，代码层面没有区别，asyncio 已经帮忙封装好了，根据操作系统自动调用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第二节 Node.js 项目实践 - 使用 nvm 安装 Node.js]]></title>    <link>https://juejin.cn/post/7571695634942492699</link>    <guid>https://juejin.cn/post/7571695634942492699</guid>    <pubDate>2025-11-12T16:38:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571695634942492699" data-draft-id="7571662618056081434" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第二节 Node.js 项目实践 - 使用 nvm 安装 Node.js"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-12T16:38:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="undefined在掘金39041"/> <meta itemprop="url" content="https://juejin.cn/user/1081575171951485"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第二节 Node.js 项目实践 - 使用 nvm 安装 Node.js
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1081575171951485/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    undefined在掘金39041
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T16:38:17.000Z" title="Wed Nov 12 2025 16:38:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>课程的第 2 回：使用 nvm 安装 Node.js，在这节课里，我们将探讨：</p>
<ul>
<li>为何要用 nvm？</li>
<li>Windows 和 macOS 安装 nvm 的方式</li>
<li>使用 nvm 安装 Node.js</li>
<li>如何切换 Node.js 的版本</li>
<li>配置 npm 中国镜像</li>
</ul>
<p>开发<code>Node.js</code>，首先就必须要安装<code>Node.js</code>自身。如果你已经安装好了<code>Node.js</code>了，可以略过本节课程，直接开始学习开发。</p>
<h2 data-id="heading-0"><em>1. 为何要用 nvm ？</em></h2>
<p>安装<code>Node.js</code>，最简单办法，就是直接在<a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2Fen%2F" target="_blank" title="https://nodejs.org/en/" ref="nofollow noopener noreferrer">官网</a>下载了安装。但这种方法，却不是最好的办法。因为如果需要更新<code>Node.js</code>的版本，那就需要把之前的卸载了，再去下载安装其他版本，这样就非常的麻烦了。</p>
<p>这里推荐大家使用<code>nvm</code>来安装，可以使用它来安装多个不同版本的<code>Node.js</code>，并且根据需要随意的切换所需版本。</p>
<h2 data-id="heading-1"><em>2. Windows 安装 nvm-windows</em></h2>
<p>Windows 与 macOS 的安装方法有些不同。Windows 的同学，请在这里下载<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcoreybutler%2Fnvm-windows%2F" target="_blank" title="https://github.com/coreybutler/nvm-windows/" ref="nofollow noopener noreferrer">github.com/coreybutler…</a>了，直接安装就好 ，然后点击右侧的 <code>Releases</code>，这里就是下载的地方了。接着，找到最新版本，选择<code>nvm-setup.exe</code>下载。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17ad2cbedddc4a7288f531a2ceda55db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdW5kZWZpbmVk5Zyo5o6Y6YeRMzkwNDE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763570297&amp;x-signature=LaPTXUuFwGo3xZ5yXvWPW%2FJys0M%3D" alt="image.png" loading="lazy"/></p>
<p>下好后，就大家直接安装上，然后将自己电脑的<code>PowerShell</code>或者终端打开，运行<code>nvm</code>，只要出来东西了，就是安装好了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0ea5d8ea8114fe7a40b98113ccca2d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdW5kZWZpbmVk5Zyo5o6Y6YeRMzkwNDE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763570297&amp;x-signature=bIIQWo8lbRVVDkS52b%2F3s5dfsrQ%3D" alt="image.png" loading="lazy"/></p>
<p>注意：Windows 有可能碰到错误提示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b97f58e81fa485d868993283da138c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdW5kZWZpbmVk5Zyo5o6Y6YeRMzkwNDE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763570297&amp;x-signature=O%2F%2F8Yra%2FxNZvvK5ngmJ464j%2BtpU%3D" alt="image.png" loading="lazy"/></p>
<p>如果碰到这个错误，需要用<code>管理员身份</code>打开<code>PowerShell</code>，然后运行：</p>
<p>Set-ExecutionPolicy RemoteSigned</p>
<pre><code class="hljs language-js" lang="js"/></pre>
<p>再按<code>a</code>即可。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring事务在微服务架构中的实践与挑战]]></title>    <link>https://juejin.cn/post/7571749988080173065</link>    <guid>https://juejin.cn/post/7571749988080173065</guid>    <pubDate>2025-11-12T19:30:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571749988080173065" data-draft-id="7570984257665957934" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring事务在微服务架构中的实践与挑战"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-11-12T19:30:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大头an"/> <meta itemprop="url" content="https://juejin.cn/user/618374030438861"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring事务在微服务架构中的实践与挑战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/618374030438861/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大头an
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T19:30:18.000Z" title="Wed Nov 12 2025 19:30:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<blockquote>
<p>在微服务架构中，传统的单体数据库事务不再适用。每个微服务拥有独立的数据存储，如何保证跨服务的数据一致性？如何设计可靠的事务方案？本文将深入探讨微服务架构下的事务挑战，并介绍多种分布式事务解决方案。</p>
</blockquote>
<h2 data-id="heading-1">微服务事务的挑战</h2>
<h3 data-id="heading-2">1. 传统ACID事务的局限性</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 单体应用中的事务 - 在微服务中无法实现</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MonolithicOrderService</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-comment">// 所有操作在同一个数据库事务中</span>
        orderRepository.save(order);           <span class="hljs-comment">// 订单库</span>
        inventoryService.deductStock(order);   <span class="hljs-comment">// 库存库  </span>
        accountService.deductBalance(order);   <span class="hljs-comment">// 账户库</span>
        notificationService.sendEmail(order);  <span class="hljs-comment">// 通知服务</span>
        <span class="hljs-comment">// 要么全部成功，要么全部回滚</span>
    }
}
</code></pre>
<p><strong>微服务中的问题</strong>：</p>
<ul>
<li>每个服务有独立的数据库</li>
<li>无法使用传统的数据库事务</li>
<li>网络调用可能失败</li>
<li>服务可能不可用</li>
</ul>
<h3 data-id="heading-3">2. CAP定理的影响</h3>
<p>在分布式系统中，只能同时满足以下两个：</p>
<ul>
<li><strong>一致性 (Consistency)</strong>：所有节点看到相同的数据</li>
<li><strong>可用性 (Availability)</strong>：每个请求都能获得响应</li>
<li><strong>分区容错性 (Partition Tolerance)</strong>：系统在网络分区时仍能工作</li>
</ul>
<p>微服务架构通常选择<strong>AP + 最终一致性</strong>。</p>
<h2 data-id="heading-4">分布式事务模式</h2>
<h3 data-id="heading-5">1. 两阶段提交 (2PC)</h3>
<p><strong>模式描述</strong>：协调者协调多个参与者，分准备和提交两个阶段。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 2PC 协调者实现示例</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TwoPhaseCommitCoordinator</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderService orderService;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> InventoryService inventoryService;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> AccountService accountService;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrderDistributed</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">transactionId</span> <span class="hljs-operator">=</span> generateTransactionId();
        List&lt;Participant&gt; participants = Arrays.asList(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Participant</span>(<span class="hljs-string">"order"</span>, () -&gt; orderService.prepareCreate(order, transactionId)),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Participant</span>(<span class="hljs-string">"inventory"</span>, () -&gt; inventoryService.prepareDeduct(order, transactionId)),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Participant</span>(<span class="hljs-string">"account"</span>, () -&gt; accountService.prepareDeduct(order, transactionId))
        );
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 阶段一：准备阶段</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">allPrepared</span> <span class="hljs-operator">=</span> preparePhase(participants, transactionId);
            
            <span class="hljs-keyword">if</span> (allPrepared) {
                <span class="hljs-comment">// 阶段二：提交阶段</span>
                commitPhase(participants, transactionId);
                log.info(<span class="hljs-string">"分布式事务提交成功: {}"</span>, transactionId);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 阶段二：回滚阶段</span>
                rollbackPhase(participants, transactionId);
                log.warn(<span class="hljs-string">"分布式事务回滚: {}"</span>, transactionId);
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            rollbackPhase(participants, transactionId);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DistributedTransactionException</span>(<span class="hljs-string">"分布式事务执行失败"</span>, e);
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preparePhase</span><span class="hljs-params">(List&lt;Participant&gt; participants, String transactionId)</span> {
        <span class="hljs-keyword">for</span> (Participant participant : participants) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">boolean</span> <span class="hljs-variable">prepared</span> <span class="hljs-operator">=</span> participant.prepare();
                <span class="hljs-keyword">if</span> (!prepared) {
                    log.warn(<span class="hljs-string">"参与者准备失败: {}, 事务: {}"</span>, participant.getName(), transactionId);
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                }
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(<span class="hljs-string">"参与者准备异常: {}, 事务: {}"</span>, participant.getName(), transactionId, e);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">commitPhase</span><span class="hljs-params">(List&lt;Participant&gt; participants, String transactionId)</span> {
        <span class="hljs-keyword">for</span> (Participant participant : participants) {
            <span class="hljs-keyword">try</span> {
                participant.commit();
            } <span class="hljs-keyword">catch</span> (Exception e) {
                <span class="hljs-comment">// 提交阶段失败需要人工干预</span>
                log.error(<span class="hljs-string">"参与者提交失败: {}, 事务: {}"</span>, participant.getName(), transactionId, e);
                <span class="hljs-comment">// 记录异常，需要补偿</span>
                recordCompensationTask(participant.getName(), transactionId, <span class="hljs-string">"COMMIT"</span>);
            }
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rollbackPhase</span><span class="hljs-params">(List&lt;Participant&gt; participants, String transactionId)</span> {
        <span class="hljs-keyword">for</span> (Participant participant : participants) {
            <span class="hljs-keyword">try</span> {
                participant.rollback();
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(<span class="hljs-string">"参与者回滚失败: {}, 事务: {}"</span>, participant.getName(), transactionId, e);
                <span class="hljs-comment">// 记录异常，需要补偿</span>
                recordCompensationTask(participant.getName(), transactionId, <span class="hljs-string">"ROLLBACK"</span>);
            }
        }
    }
}

<span class="hljs-comment">// 参与者接口</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Participant</span> {
    String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span>;
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">prepare</span><span class="hljs-params">()</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">commit</span><span class="hljs-params">()</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">rollback</span><span class="hljs-params">()</span>;
}
</code></pre>
<h3 data-id="heading-6">2. Saga模式</h3>
<p><strong>模式描述</strong>：将分布式事务拆分为一系列本地事务，每个事务都有对应的补偿操作。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Saga 协调者实现</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SagaCoordinator</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> SagaStepExecutor stepExecutor;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> SagaStateRepository stateRepository;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeOrderSaga</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">sagaId</span> <span class="hljs-operator">=</span> generateSagaId();
        <span class="hljs-type">SagaState</span> <span class="hljs-variable">sagaState</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SagaState</span>(sagaId, order);
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 定义Saga步骤</span>
            List&lt;SagaStep&gt; steps = Arrays.asList(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">SagaStep</span>(<span class="hljs-string">"create_order"</span>, 
                    () -&gt; stepExecutor.createOrder(order, sagaId),
                    () -&gt; stepExecutor.compensateOrder(order, sagaId)),
                    
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">SagaStep</span>(<span class="hljs-string">"deduct_inventory"</span>,
                    () -&gt; stepExecutor.deductInventory(order, sagaId), 
                    () -&gt; stepExecutor.compensateInventory(order, sagaId)),
                    
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">SagaStep</span>(<span class="hljs-string">"deduct_balance"</span>,
                    () -&gt; stepExecutor.deductBalance(order, sagaId),
                    () -&gt; stepExecutor.compensateBalance(order, sagaId)),
                    
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">SagaStep</span>(<span class="hljs-string">"send_notification"</span>,
                    () -&gt; stepExecutor.sendNotification(order, sagaId),
                    <span class="hljs-literal">null</span>) <span class="hljs-comment">// 最后一步不需要补偿</span>
            );
            
            <span class="hljs-comment">// 执行Saga</span>
            executeSagaSteps(steps, sagaState);
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"Saga执行失败: {}"</span>, sagaId, e);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SagaException</span>(<span class="hljs-string">"订单创建失败"</span>, e);
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeSagaSteps</span><span class="hljs-params">(List&lt;SagaStep&gt; steps, SagaState sagaState)</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; steps.size(); i++) {
            <span class="hljs-type">SagaStep</span> <span class="hljs-variable">step</span> <span class="hljs-operator">=</span> steps.get(i);
            sagaState.setCurrentStep(step.getName());
            
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 执行正向操作</span>
                step.execute();
                sagaState.recordSuccess(step.getName());
                
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(<span class="hljs-string">"Saga步骤执行失败: {}, 步骤: {}"</span>, sagaState.getSagaId(), step.getName(), e);
                sagaState.recordFailure(step.getName(), e.getMessage());
                
                <span class="hljs-comment">// 执行补偿操作</span>
                compensatePreviousSteps(steps, i, sagaState);
                <span class="hljs-keyword">break</span>;
            }
        }
        
        <span class="hljs-comment">// 保存Saga状态</span>
        stateRepository.save(sagaState);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">compensatePreviousSteps</span><span class="hljs-params">(List&lt;SagaStep&gt; steps, <span class="hljs-type">int</span> failedIndex, SagaState sagaState)</span> {
        <span class="hljs-comment">// 从失败步骤的前一步开始反向补偿</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> failedIndex - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
            <span class="hljs-type">SagaStep</span> <span class="hljs-variable">step</span> <span class="hljs-operator">=</span> steps.get(i);
            <span class="hljs-keyword">if</span> (step.getCompensate() != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">try</span> {
                    step.compensate();
                    sagaState.recordCompensation(step.getName());
                } <span class="hljs-keyword">catch</span> (Exception e) {
                    log.error(<span class="hljs-string">"Saga补偿操作失败: {}, 步骤: {}"</span>, sagaState.getSagaId(), step.getName(), e);
                    sagaState.recordCompensationFailure(step.getName(), e.getMessage());
                    <span class="hljs-comment">// 补偿失败需要人工干预</span>
                }
            }
        }
    }
}

<span class="hljs-comment">// Saga步骤定义</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SagaStep</span> {
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> Runnable execute;
    <span class="hljs-keyword">private</span> Runnable compensate;
}
</code></pre>
<h3 data-id="heading-7">3. TCC模式 (Try-Confirm-Cancel)</h3>
<p><strong>模式描述</strong>：每个服务提供Try、Confirm、Cancel三个接口。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// TCC 订单服务实现</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TccOrderService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderRepository orderRepository;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> TccTransactionRepository tccRepository;
    
    <span class="hljs-comment">// Try阶段：预留资源</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryCreateOrder</span><span class="hljs-params">(Order order, String transactionId)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 检查业务约束</span>
            validateOrder(order);
            
            <span class="hljs-comment">// 创建预订单状态</span>
            <span class="hljs-type">Order</span> <span class="hljs-variable">pendingOrder</span> <span class="hljs-operator">=</span> order.toPending(transactionId);
            orderRepository.save(pendingOrder);
            
            <span class="hljs-comment">// 记录TCC状态</span>
            <span class="hljs-type">TccTransaction</span> <span class="hljs-variable">tcc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TccTransaction</span>(transactionId, <span class="hljs-string">"order"</span>, <span class="hljs-string">"CREATE"</span>);
            tccRepository.save(tcc);
            
            log.info(<span class="hljs-string">"订单Try阶段成功: {}"</span>, transactionId);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"订单Try阶段失败: {}"</span>, transactionId, e);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
    
    <span class="hljs-comment">// Confirm阶段：确认操作</span>
    <span class="hljs-meta">@Transactional</span> 
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">confirmCreateOrder</span><span class="hljs-params">(String transactionId)</span> {
        <span class="hljs-type">TccTransaction</span> <span class="hljs-variable">tcc</span> <span class="hljs-operator">=</span> tccRepository.findByTransactionIdAndService(transactionId, <span class="hljs-string">"order"</span>);
        <span class="hljs-keyword">if</span> (tcc == <span class="hljs-literal">null</span> || !<span class="hljs-string">"CREATE"</span>.equals(tcc.getAction())) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TccException</span>(<span class="hljs-string">"无效的TCC事务: "</span> + transactionId);
        }
        
        <span class="hljs-comment">// 更新订单状态为确认</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">pendingOrder</span> <span class="hljs-operator">=</span> orderRepository.findByTransactionId(transactionId);
        <span class="hljs-keyword">if</span> (pendingOrder != <span class="hljs-literal">null</span>) {
            pendingOrder.confirm();
            orderRepository.save(pendingOrder);
            
            <span class="hljs-comment">// 删除TCC记录</span>
            tccRepository.delete(tcc);
        }
        
        log.info(<span class="hljs-string">"订单Confirm阶段成功: {}"</span>, transactionId);
    }
    
    <span class="hljs-comment">// Cancel阶段：取消操作</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cancelCreateOrder</span><span class="hljs-params">(String transactionId)</span> {
        <span class="hljs-type">TccTransaction</span> <span class="hljs-variable">tcc</span> <span class="hljs-operator">=</span> tccRepository.findByTransactionIdAndService(transactionId, <span class="hljs-string">"order"</span>);
        <span class="hljs-keyword">if</span> (tcc == <span class="hljs-literal">null</span> || !<span class="hljs-string">"CREATE"</span>.equals(tcc.getAction())) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TccException</span>(<span class="hljs-string">"无效的TCC事务: "</span> + transactionId);
        }
        
        <span class="hljs-comment">// 删除预订单</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">pendingOrder</span> <span class="hljs-operator">=</span> orderRepository.findByTransactionId(transactionId);
        <span class="hljs-keyword">if</span> (pendingOrder != <span class="hljs-literal">null</span>) {
            orderRepository.delete(pendingOrder);
            
            <span class="hljs-comment">// 删除TCC记录</span>
            tccRepository.delete(tcc);
        }
        
        log.info(<span class="hljs-string">"订单Cancel阶段成功: {}"</span>, transactionId);
    }
}
</code></pre>
<h2 data-id="heading-8">Spring Cloud分布式事务实践</h2>
<h3 data-id="heading-9">1. 使用Seata框架</h3>
<p><strong>Seata配置</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml</span>
<span class="hljs-attr">seata:</span>
  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">application-id:</span> <span class="hljs-string">order-service</span>
  <span class="hljs-attr">tx-service-group:</span> <span class="hljs-string">my_tx_group</span>
  <span class="hljs-attr">service:</span>
    <span class="hljs-attr">vgroup-mapping:</span>
      <span class="hljs-attr">my_tx_group:</span> <span class="hljs-string">default</span>
    <span class="hljs-attr">disable-global-transaction:</span> <span class="hljs-literal">false</span>
  <span class="hljs-attr">config:</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">nacos</span>
    <span class="hljs-attr">nacos:</span>
      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:8848</span>
  <span class="hljs-attr">registry:</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">nacos</span>
    <span class="hljs-attr">nacos:</span>
      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:8848</span>
</code></pre>
<p><strong>全局事务使用</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 订单服务</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SeataOrderService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderMapper orderMapper;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> InventoryFeignClient inventoryFeignClient;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> AccountFeignClient accountFeignClient;
    
    <span class="hljs-comment">// 开启全局事务</span>
    <span class="hljs-meta">@GlobalTransactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrderWithSeata</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-comment">// 1. 创建本地订单</span>
        orderMapper.insert(order);
        log.info(<span class="hljs-string">"本地订单创建成功"</span>);
        
        <span class="hljs-comment">// 2. 调用库存服务（远程服务）</span>
        <span class="hljs-type">Boolean</span> <span class="hljs-variable">inventoryResult</span> <span class="hljs-operator">=</span> inventoryFeignClient.deductStock(order.getItems());
        <span class="hljs-keyword">if</span> (!Boolean.TRUE.equals(inventoryResult)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"库存扣减失败"</span>);
        }
        log.info(<span class="hljs-string">"库存扣减成功"</span>);
        
        <span class="hljs-comment">// 3. 调用账户服务（远程服务）</span>
        <span class="hljs-type">Boolean</span> <span class="hljs-variable">accountResult</span> <span class="hljs-operator">=</span> accountFeignClient.deductBalance(order.getUserId(), order.getAmount());
        <span class="hljs-keyword">if</span> (!Boolean.TRUE.equals(accountResult)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"余额扣减失败"</span>);
        }
        log.info(<span class="hljs-string">"余额扣减成功"</span>);
        
        <span class="hljs-comment">// 4. 更新订单状态</span>
        order.complete();
        orderMapper.updateStatus(order);
        log.info(<span class="hljs-string">"订单状态更新完成"</span>);
    }
}

<span class="hljs-comment">// Feign客户端配置</span>
<span class="hljs-meta">@FeignClient(name = "inventory-service", path = "/api/inventory")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">InventoryFeignClient</span> {
    
    <span class="hljs-meta">@PostMapping("/deduct")</span>
    Boolean <span class="hljs-title function_">deductStock</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> List&lt;OrderItem&gt; items)</span>;
}

<span class="hljs-meta">@FeignClient(name = "account-service", path = "/api/account")</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AccountFeignClient</span> {
    
    <span class="hljs-meta">@PostMapping("/deduct")</span>
    Boolean <span class="hljs-title function_">deductBalance</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> Long userId, <span class="hljs-meta">@RequestParam</span> BigDecimal amount)</span>;
}
</code></pre>
<h3 data-id="heading-10">2. 事务消息模式</h3>
<p><strong>基于RocketMQ的事务消息</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionMessageService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RocketMQTemplate rocketMQTemplate;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderService orderService;
    
    <span class="hljs-comment">// 发送事务消息</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrderWithTransactionMessage</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-comment">// 执行本地事务</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">savedOrder</span> <span class="hljs-operator">=</span> orderService.createOrderLocal(order);
        
        <span class="hljs-comment">// 发送事务消息</span>
        <span class="hljs-type">TransactionSendResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> rocketMQTemplate.sendMessageInTransaction(
            <span class="hljs-string">"order-topic"</span>, 
            MessageBuilder.withPayload(order).build(),
            savedOrder.getId() <span class="hljs-comment">// 业务参数</span>
        );
        
        log.info(<span class="hljs-string">"事务消息发送结果: {}"</span>, result.getSendStatus());
    }
    
    <span class="hljs-comment">// 本地事务执行器</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeLocalTransaction</span><span class="hljs-params">(String transactionId, Long orderId)</span> {
        <span class="hljs-comment">// 查询订单状态</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderService.findById(orderId);
        <span class="hljs-keyword">if</span> (order != <span class="hljs-literal">null</span> &amp;&amp; order.isPending()) {
            <span class="hljs-comment">// 更新订单为处理中</span>
            order.processing();
            orderService.updateOrder(order);
            log.info(<span class="hljs-string">"本地事务执行成功: {}"</span>, transactionId);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"订单状态异常: "</span> + orderId);
        }
    }
    
    <span class="hljs-comment">// 事务回查</span>
    <span class="hljs-keyword">public</span> LocalTransactionState <span class="hljs-title function_">checkLocalTransaction</span><span class="hljs-params">(Message message)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">transactionId</span> <span class="hljs-operator">=</span> message.getTransactionId();
        <span class="hljs-type">Long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> Long.valueOf(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(message.getBody()));
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderService.findById(orderId);
            <span class="hljs-keyword">if</span> (order == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> LocalTransactionState.ROLLBACK_MESSAGE;
            }
            
            <span class="hljs-keyword">if</span> (order.isCompleted() || order.isProcessing()) {
                <span class="hljs-keyword">return</span> LocalTransactionState.COMMIT_MESSAGE;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (order.isFailed()) {
                <span class="hljs-keyword">return</span> LocalTransactionState.ROLLBACK_MESSAGE;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> LocalTransactionState.UNKNOW;
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"事务回查异常: {}"</span>, transactionId, e);
            <span class="hljs-keyword">return</span> LocalTransactionState.UNKNOW;
        }
    }
}
</code></pre>
<h2 data-id="heading-11">事件驱动架构与最终一致性</h2>
<h3 data-id="heading-12">1. 基于事件的Saga实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 事件发布服务</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DomainEventPublisher</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ApplicationEventPublisher eventPublisher;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> EventStoreRepository eventStoreRepository;
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">publishWithTransaction</span><span class="hljs-params">(DomainEvent event)</span> {
        <span class="hljs-comment">// 存储事件（与业务操作在同一个事务中）</span>
        eventStoreRepository.save(event.toEventStore());
        
        <span class="hljs-comment">// 发布事件</span>
        eventPublisher.publishEvent(event);
        
        log.info(<span class="hljs-string">"领域事件发布: {}"</span>, event.getEventType());
    }
}

<span class="hljs-comment">// 订单创建事件</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderCreatedEvent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DomainEvent</span> {
    <span class="hljs-keyword">private</span> Long orderId;
    <span class="hljs-keyword">private</span> Long userId;
    <span class="hljs-keyword">private</span> BigDecimal amount;
    <span class="hljs-keyword">private</span> List&lt;OrderItem&gt; items;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OrderCreatedEvent</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-built_in">super</span>(<span class="hljs-string">"ORDER_CREATED"</span>, order.getId().toString());
        <span class="hljs-built_in">this</span>.orderId = order.getId();
        <span class="hljs-built_in">this</span>.userId = order.getUserId();
        <span class="hljs-built_in">this</span>.amount = order.getAmount();
        <span class="hljs-built_in">this</span>.items = order.getItems();
    }
}

<span class="hljs-comment">// 事件处理器</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderCreatedEventHandler</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> InventoryService inventoryService;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> AccountService accountService;
    
    <span class="hljs-meta">@EventListener</span>
    <span class="hljs-meta">@Async</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleOrderCreated</span><span class="hljs-params">(OrderCreatedEvent event)</span> {
        log.info(<span class="hljs-string">"处理订单创建事件: {}"</span>, event.getOrderId());
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 扣减库存</span>
            inventoryService.deductStock(event.getItems());
            log.info(<span class="hljs-string">"库存扣减成功: {}"</span>, event.getOrderId());
            
            <span class="hljs-comment">// 扣减余额</span>
            accountService.deductBalance(event.getUserId(), event.getAmount());
            log.info(<span class="hljs-string">"余额扣减成功: {}"</span>, event.getOrderId());
            
            <span class="hljs-comment">// 发布订单完成事件</span>
            eventPublisher.publish(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderCompletedEvent</span>(event.getOrderId()));
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"订单处理失败: {}"</span>, event.getOrderId(), e);
            
            <span class="hljs-comment">// 发布订单失败事件</span>
            eventPublisher.publish(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderFailedEvent</span>(event.getOrderId(), e.getMessage()));
        }
    }
}
</code></pre>
<h3 data-id="heading-13">2. 事件溯源模式</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 事件存储</span>
<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "event_store")</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EventStore</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-keyword">private</span> String eventId;
    <span class="hljs-keyword">private</span> String aggregateId;
    <span class="hljs-keyword">private</span> String eventType;
    <span class="hljs-keyword">private</span> String eventData;
    <span class="hljs-keyword">private</span> LocalDateTime timestamp;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> version;
}

<span class="hljs-comment">// 聚合根基类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AggregateRoot</span> {
    <span class="hljs-keyword">protected</span> String id;
    <span class="hljs-keyword">protected</span> List&lt;DomainEvent&gt; changes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-variable">version</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">apply</span><span class="hljs-params">(DomainEvent event)</span> {
        changes.add(event);
        handle(event);
    }
    
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(DomainEvent event)</span>;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">markChangesAsCommitted</span><span class="hljs-params">()</span> {
        changes.clear();
    }
    
    <span class="hljs-keyword">public</span> List&lt;DomainEvent&gt; <span class="hljs-title function_">getUncommittedChanges</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(changes);
    }
}

<span class="hljs-comment">// 订单聚合根</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderAggregate</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AggregateRoot</span> {
    <span class="hljs-keyword">private</span> OrderStatus status;
    <span class="hljs-keyword">private</span> BigDecimal amount;
    <span class="hljs-keyword">private</span> Long userId;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OrderAggregate</span><span class="hljs-params">(String orderId, Long userId, BigDecimal amount)</span> {
        <span class="hljs-built_in">this</span>.id = orderId;
        <span class="hljs-built_in">this</span>.userId = userId;
        <span class="hljs-built_in">this</span>.amount = amount;
        <span class="hljs-built_in">this</span>.status = OrderStatus.CREATED;
        
        apply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderCreatedEvent</span>(orderId, userId, amount));
    }
    
    <span class="hljs-comment">// 重建聚合根</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OrderAggregate</span><span class="hljs-params">(String orderId, List&lt;DomainEvent&gt; events)</span> {
        <span class="hljs-built_in">this</span>.id = orderId;
        <span class="hljs-keyword">for</span> (DomainEvent event : events) {
            handle(event);
            <span class="hljs-built_in">this</span>.version++;
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">complete</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.status != OrderStatus.CREATED) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"订单状态异常"</span>);
        }
        <span class="hljs-built_in">this</span>.status = OrderStatus.COMPLETED;
        apply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderCompletedEvent</span>(<span class="hljs-built_in">this</span>.id));
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fail</span><span class="hljs-params">(String reason)</span> {
        <span class="hljs-built_in">this</span>.status = OrderStatus.FAILED;
        apply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderFailedEvent</span>(<span class="hljs-built_in">this</span>.id, reason));
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(DomainEvent event)</span> {
        <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> OrderCreatedEvent) {
            handleOrderCreated((OrderCreatedEvent) event);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> OrderCompletedEvent) {
            handleOrderCompleted((OrderCompletedEvent) event);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> OrderFailedEvent) {
            handleOrderFailed((OrderFailedEvent) event);
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleOrderCreated</span><span class="hljs-params">(OrderCreatedEvent event)</span> {
        <span class="hljs-built_in">this</span>.userId = event.getUserId();
        <span class="hljs-built_in">this</span>.amount = event.getAmount();
        <span class="hljs-built_in">this</span>.status = OrderStatus.CREATED;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleOrderCompleted</span><span class="hljs-params">(OrderCompletedEvent event)</span> {
        <span class="hljs-built_in">this</span>.status = OrderStatus.COMPLETED;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleOrderFailed</span><span class="hljs-params">(OrderFailedEvent event)</span> {
        <span class="hljs-built_in">this</span>.status = OrderStatus.FAILED;
    }
}
</code></pre>
<h2 data-id="heading-14">微服务事务监控</h2>
<h3 data-id="heading-15">1. 分布式链路追踪</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 事务链路追踪</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistributedTransactionTracingAspect</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> Tracer tracer;
    
    <span class="hljs-meta">@Around("@annotation(globalTransactional)")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">traceGlobalTransaction</span><span class="hljs-params">(ProceedingJoinPoint joinPoint, 
                                       GlobalTransactional globalTransactional)</span> <span class="hljs-keyword">throws</span> Throwable {
        
        <span class="hljs-type">Span</span> <span class="hljs-variable">transactionSpan</span> <span class="hljs-operator">=</span> tracer.nextSpan().name(<span class="hljs-string">"global-transaction"</span>).start();
        
        <span class="hljs-keyword">try</span> (Tracer.<span class="hljs-type">SpanInScope</span> <span class="hljs-variable">ws</span> <span class="hljs-operator">=</span> tracer.withSpanInScope(transactionSpan)) {
            <span class="hljs-comment">// 添加事务标签</span>
            transactionSpan.tag(<span class="hljs-string">"transaction.type"</span>, <span class="hljs-string">"global"</span>);
            transactionSpan.tag(<span class="hljs-string">"transaction.timeout"</span>, 
                String.valueOf(globalTransactional.timeoutMills()));
            
            <span class="hljs-comment">// 记录事务开始</span>
            log.info(<span class="hljs-string">"全局事务开始: {}"</span>, transactionSpan.context().traceId());
            
            <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> joinPoint.proceed();
            
            <span class="hljs-comment">// 记录事务成功</span>
            transactionSpan.finish();
            log.info(<span class="hljs-string">"全局事务完成: {}"</span>, transactionSpan.context().traceId());
            
            <span class="hljs-keyword">return</span> result;
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 记录事务失败</span>
            transactionSpan.error(e);
            transactionSpan.finish();
            log.error(<span class="hljs-string">"全局事务失败: {}"</span>, transactionSpan.context().traceId(), e);
            <span class="hljs-keyword">throw</span> e;
        }
    }
}

<span class="hljs-comment">// 在Feign调用中传播追踪上下文</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FeignTracingConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Feign.Builder <span class="hljs-title function_">feignBuilder</span><span class="hljs-params">(Tracer tracer)</span> {
        <span class="hljs-keyword">return</span> Feign.builder()
            .client(<span class="hljs-keyword">new</span> <span class="hljs-title class_">feign</span>.Client.Default(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>))
            .requestInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ForwardedHeaderInterceptor</span>(tracer));
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ForwardedHeaderInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RequestInterceptor</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Tracer tracer;
        
        ForwardedHeaderInterceptor(Tracer tracer) {
            <span class="hljs-built_in">this</span>.tracer = tracer;
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">apply</span><span class="hljs-params">(RequestTemplate template)</span> {
            <span class="hljs-type">Span</span> <span class="hljs-variable">currentSpan</span> <span class="hljs-operator">=</span> tracer.currentSpan();
            <span class="hljs-keyword">if</span> (currentSpan != <span class="hljs-literal">null</span>) {
                template.header(<span class="hljs-string">"X-B3-TraceId"</span>, currentSpan.context().traceIdString());
                template.header(<span class="hljs-string">"X-B3-SpanId"</span>, currentSpan.context().spanIdString());
                template.header(<span class="hljs-string">"X-B3-ParentSpanId"</span>, 
                    currentSpan.context().parentIdString());
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-16">2. 事务健康检查</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionHealthIndicator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HealthIndicator</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> TransactionMetrics transactionMetrics;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> DataSource dataSource;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Health <span class="hljs-title function_">health</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 检查数据库连接</span>
            checkDatabaseConnection();
            
            <span class="hljs-comment">// 检查事务指标</span>
            Map&lt;String, Object&gt; details = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
            details.put(<span class="hljs-string">"activeTransactions"</span>, transactionMetrics.getActiveTransactionCount());
            details.put(<span class="hljs-string">"rollbackRate"</span>, transactionMetrics.getRollbackRate());
            details.put(<span class="hljs-string">"averageDuration"</span>, transactionMetrics.getAverageDuration());
            
            <span class="hljs-comment">// 判断健康状态</span>
            <span class="hljs-keyword">if</span> (transactionMetrics.getRollbackRate() &gt; <span class="hljs-number">0.1</span>) {
                <span class="hljs-keyword">return</span> Health.down()
                    .withDetails(details)
                    .withException(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"事务回滚率过高"</span>))
                    .build();
            }
            
            <span class="hljs-keyword">if</span> (transactionMetrics.getAverageDuration() &gt; <span class="hljs-number">5000</span>) {
                <span class="hljs-keyword">return</span> Health.down()
                    .withDetails(details)
                    .withException(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"事务执行时间过长"</span>))
                    .build();
            }
            
            <span class="hljs-keyword">return</span> Health.up().withDetails(details).build();
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">return</span> Health.down(e).build();
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkDatabaseConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> dataSource.getConnection()) {
            <span class="hljs-keyword">if</span> (!conn.isValid(<span class="hljs-number">5</span>)) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SQLException</span>(<span class="hljs-string">"数据库连接无效"</span>);
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-17">最佳实践与模式选择</h2>
<h3 data-id="heading-18">1. 模式选择指南</h3>



































<table><thead><tr><th>场景</th><th>推荐模式</th><th>理由</th></tr></thead><tbody><tr><td>强一致性要求高</td><td>TCC模式</td><td>保证强一致性，性能较好</td></tr><tr><td>业务流程复杂</td><td>Saga模式</td><td>灵活，支持长业务流程</td></tr><tr><td>简单业务场景</td><td>事务消息</td><td>实现简单，最终一致性</td></tr><tr><td>已有Spring Cloud生态</td><td>Seata</td><td>集成简单，功能完善</td></tr><tr><td>事件驱动架构</td><td>事件溯源</td><td>天然匹配，审计友好</td></tr></tbody></table>
<h3 data-id="heading-19">2. 降级和容错策略</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CircuitBreakerTransactionService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> InventoryService inventoryService;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> AccountService accountService;
    
    <span class="hljs-comment">// 使用断路器保护远程调用</span>
    <span class="hljs-meta">@CircuitBreaker(name = "inventoryService", fallbackMethod = "fallbackDeductInventory")</span>
    <span class="hljs-meta">@Retry(name = "inventoryService")</span>
    <span class="hljs-meta">@TimeLimiter(name = "inventoryService")</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;Boolean&gt; <span class="hljs-title function_">deductInventoryWithProtection</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; 
            inventoryService.deductStock(order.getItems()));
    }
    
    <span class="hljs-comment">// 降级策略</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;Boolean&gt; <span class="hljs-title function_">fallbackDeductInventory</span><span class="hljs-params">(Order order, Exception e)</span> {
        log.warn(<span class="hljs-string">"库存服务降级，订单进入待处理状态: {}"</span>, order.getId());
        
        <span class="hljs-comment">// 将订单标记为待处理，后续补偿</span>
        order.markAsPending();
        orderService.updateOrder(order);
        
        <span class="hljs-comment">// 发布待处理事件</span>
        eventPublisher.publish(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderPendingEvent</span>(order.getId()));
        
        <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(<span class="hljs-literal">true</span>);
    }
    
    <span class="hljs-comment">// 异步补偿任务</span>
    <span class="hljs-meta">@Async</span>
    <span class="hljs-meta">@Scheduled(fixedDelay = 30000)</span> <span class="hljs-comment">// 每30秒执行一次</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">compensatePendingOrders</span><span class="hljs-params">()</span> {
        List&lt;Order&gt; pendingOrders = orderService.findPendingOrders();
        
        <span class="hljs-keyword">for</span> (Order order : pendingOrders) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 重试库存扣减</span>
                <span class="hljs-type">Boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> inventoryService.deductStock(order.getItems());
                <span class="hljs-keyword">if</span> (Boolean.TRUE.equals(result)) {
                    order.complete();
                    orderService.updateOrder(order);
                    log.info(<span class="hljs-string">"补偿处理成功: {}"</span>, order.getId());
                }
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(<span class="hljs-string">"补偿处理失败: {}"</span>, order.getId(), e);
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-20">总结</h2>
<p>微服务架构下的事务管理是一个复杂但重要的话题：</p>
<h3 data-id="heading-21">核心要点：</h3>
<ol>
<li><strong>放弃强一致性</strong>，拥抱最终一致性</li>
<li><strong>选择合适的模式</strong>基于业务需求</li>
<li><strong>设计补偿机制</strong>处理失败场景</li>
<li><strong>实施全面监控</strong>确保系统可靠性</li>
</ol>
<h3 data-id="heading-22">技术选择：</h3>
<ul>
<li><strong>简单场景</strong>：事务消息、本地消息表</li>
<li><strong>复杂业务</strong>：Saga模式、TCC模式</li>
<li><strong>Spring Cloud生态</strong>：Seata框架</li>
<li><strong>事件驱动</strong>：事件溯源、CQRS</li>
</ul>
<h3 data-id="heading-23">成功关键：</h3>
<ol>
<li><strong>业务分析</strong>：理解业务真正的一致性需求</li>
<li><strong>渐进式实施</strong>：从简单模式开始，逐步复杂化</li>
<li><strong>监控告警</strong>：建立完善的监控体系</li>
<li><strong>团队协作</strong>：跨团队的事务协议设计</li>
</ol>
<p>记住，在微服务架构中，没有银弹解决方案。最重要的是根据具体业务场景选择最适合的事务策略。</p>
<hr/>
<p><strong>下期预告</strong>：《Spring 6 &amp; Spring Boot 3新特性：事务管理的革新》</p>
<p>如果觉得本文对你有帮助，请点赞、收藏、关注！欢迎在评论区分享你在微服务事务方面的实战经验和挑战。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[.NET 10 性能突破：持续优化才是质变关键]]></title>    <link>https://juejin.cn/post/7571751304624799790</link>    <guid>https://juejin.cn/post/7571751304624799790</guid>    <pubDate>2025-11-13T00:41:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571751304624799790" data-draft-id="7571678763781701666" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=".NET 10 性能突破：持续优化才是质变关键"/> <meta itemprop="keywords" content="后端,.NET,C#"/> <meta itemprop="datePublished" content="2025-11-13T00:41:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小码编匠"/> <meta itemprop="url" content="https://juejin.cn/user/1308876155395739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            .NET 10 性能突破：持续优化才是质变关键
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1308876155395739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小码编匠
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T00:41:19.000Z" title="Thu Nov 13 2025 00:41:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>2025年11月12日，微软在.NET Conf 2025上正式发布了.NET 10。作为新一代长期支持（LTS）版本，它将获得长达三年的官方安全与服务支持，直至2028年11月10日。</p>
<p>官方称其为"迄今为止最高效、最现代、最安全、最智能、性能最高的 .NET 版本"。这并非营销话术——从底层运行时到高层语言特性，.NET 10通过数百项细微而精准的优化，在万亿次代码执行中累积出显著的性能飞跃。</p>
<p>软件性能的提升，往往不来自某个惊天动地的突破，而源于对细节的持续打磨。就像十九世纪的"冰王"弗雷德里克，靠改良绝缘材料、优化切割与物流，让冰块跨越半个地球抵达印度。</p>
<p>.NET 10的进化逻辑亦是如此：没有单一革命，只有系统性的微优化。这些优化看似微小——每次节省几纳秒、几十字节——却在高频调用场景下产生复合效应，最终带来质的飞跃。</p>
<h3 data-id="heading-1">一、LINQ 的语义级优化</h3>
<p>传统 LINQ 是机械执行操作链，而 .NET 10 让它"理解意图"。</p>
<p>例如，当开发写 OrderBy(...).Contains(...) 时，运行时会意识到"排序后再查找"实属多余，直接跳过排序步骤，直奔源数据搜索。</p>
<pre><code class="hljs language-cs" lang="cs"><span class="hljs-comment">// dotnet run -c Release -f net9.0 --filter "*" --runtimes net9.0 net10.0</span>
<span class="hljs-keyword">using</span> BenchmarkDotNet.Attributes;
<span class="hljs-keyword">using</span> BenchmarkDotNet.Running;
BenchmarkSwitcher.FromAssembly(<span class="hljs-keyword">typeof</span>(Tests).Assembly).Run(args);
[<span class="hljs-meta">MemoryDiagnoser(displayGenColumns: false)</span>]
[<span class="hljs-meta">HideColumns(<span class="hljs-string">"Job"</span>, <span class="hljs-string">"Error"</span>, <span class="hljs-string">"StdDev"</span>, <span class="hljs-string">"Median"</span>, <span class="hljs-string">"RatioSD"</span>)</span>]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Tests</span>
{
    <span class="hljs-keyword">private</span> IEnumerable&lt;<span class="hljs-built_in">int</span>&gt; _source = Enumerable.Range(<span class="hljs-number">0</span>, <span class="hljs-number">1000</span>).ToArray();
    [<span class="hljs-meta">Benchmark</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">AppendContains</span>()</span> =&gt; _source.Append(<span class="hljs-number">100</span>).Contains(<span class="hljs-number">999</span>);
    [<span class="hljs-meta">Benchmark</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">ConcatContains</span>()</span> =&gt; _source.Concat(_source).Contains(<span class="hljs-number">999</span>);
    [<span class="hljs-meta">Benchmark</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">DefaultIfEmptyContains</span>()</span> =&gt; _source.DefaultIfEmpty(<span class="hljs-number">42</span>).Contains(<span class="hljs-number">999</span>);
    [<span class="hljs-meta">Benchmark</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">DistinctContains</span>()</span> =&gt; _source.Distinct().Contains(<span class="hljs-number">999</span>);
    [<span class="hljs-meta">Benchmark</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">OrderByContains</span>()</span> =&gt; _source.OrderBy(x =&gt; x).Contains(<span class="hljs-number">999</span>);
    [<span class="hljs-meta">Benchmark</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">ReverseContains</span>()</span> =&gt; _source.Reverse().Contains(<span class="hljs-number">999</span>);
    [<span class="hljs-meta">Benchmark</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">UnionContains</span>()</span> =&gt; _source.Union(_source).Contains(<span class="hljs-number">999</span>);
    [<span class="hljs-meta">Benchmark</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">SelectManyContains</span>()</span> =&gt; _source.SelectMany(x =&gt; _source).Contains(<span class="hljs-number">999</span>);
    [<span class="hljs-meta">Benchmark</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">WhereSelectContains</span>()</span> =&gt; _source.Where(x =&gt; <span class="hljs-literal">true</span>).Select(x =&gt; x).Contains(<span class="hljs-number">999</span>);
}
</code></pre>
<p>结果令人震撼：DistinctContains 耗时从 16,967 ns 降至 47 ns，内存从 58KB 降至 64 字节；OrderByContains 从 12,884 ns 降至 50 ns。这种优化本质是算法复杂度的降维——从 O(N log N) 回归 O(N)。</p>













































<table><thead><tr><th>Method</th><th>Runtime</th><th>Mean</th><th>Ratio</th><th>Allocated</th><th>Alloc Ratio</th></tr></thead><tbody><tr><td>DistinctContains</td><td>.NET 9.0</td><td>16,967.31 ns</td><td>1.000</td><td>58656 B</td><td>1.000</td></tr><tr><td>DistinctContains</td><td>.NET 10.0</td><td>46.72 ns</td><td>0.003</td><td>64 B</td><td>0.001</td></tr><tr><td>OrderByContains</td><td>.NET 9.0</td><td>12,884.28 ns</td><td>1.000</td><td>12280 B</td><td>1.000</td></tr><tr><td>OrderByContains</td><td>.NET 10.0</td><td>50.14 ns</td><td>0.004</td><td>88 B</td><td>0.007</td></tr></tbody></table>
<h4 data-id="heading-2">二、委托与局部函数的零分配优化</h4>
<p>闭包和委托曾是性能"黑洞"。.NET 10 的 JIT 编译器通过逃逸分析，发现委托未被外部引用时，直接内联调用，避免对象分配。</p>
<pre><code class="hljs language-cs" lang="cs"><span class="hljs-comment">// dotnet run -c Release -f net9.0 --filter "*" --runtimes net9.0 net10.0</span>
<span class="hljs-keyword">using</span> BenchmarkDotNet.Attributes;
<span class="hljs-keyword">using</span> BenchmarkDotNet.Running;
[<span class="hljs-meta">DisassemblyDiagnoser</span>]
[<span class="hljs-meta">MemoryDiagnoser(displayGenColumns: false)</span>]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Tests</span>
{
    [<span class="hljs-meta">Benchmark</span>]
    [<span class="hljs-meta">Arguments(42)</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">Sum</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> y</span>)</span>
    {
        Func&lt;<span class="hljs-built_in">int</span>, <span class="hljs-built_in">int</span>&gt; addY = x =&gt; x + y;
        <span class="hljs-keyword">return</span> DoubleResult(addY, y);
    }
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> <span class="hljs-title">DoubleResult</span>(<span class="hljs-params">Func&lt;<span class="hljs-built_in">int</span>, <span class="hljs-built_in">int</span>&gt; func, <span class="hljs-built_in">int</span> arg</span>)</span>
    {
        <span class="hljs-built_in">int</span> result = func(arg);
        <span class="hljs-keyword">return</span> result + result;
    }
}
</code></pre>
<p>执行时间从 19.53 ns 降至 6.68 ns，内存从 88 B 降至 24 B。类似地，局部函数中的数组也被优化为栈分配，彻底消除堆分配。</p>
<h3 data-id="heading-3">三、去虚拟化与类型细化</h3>
<p>过去，数组通过接口（如 IList&lt; T&gt;）访问时无法去虚拟化，导致 for 循环比 foreach 更慢。.NET 10 修复了这一反直觉现象。</p>
<pre><code class="hljs language-cs" lang="cs"><span class="hljs-keyword">private</span> ReadOnlyCollection&lt;<span class="hljs-built_in">int</span>&gt; _list = <span class="hljs-keyword">new</span>(Enumerable.Range(<span class="hljs-number">1</span>, <span class="hljs-number">1000</span>).ToArray());
[<span class="hljs-meta">Benchmark</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">SumForLoop</span>()</span>
{
    <span class="hljs-built_in">int</span> sum = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; _list.Count; i++)
    {
        sum += _list[i]; <span class="hljs-comment">// .NET 9: 1000 次虚拟调用</span>
    }
    <span class="hljs-keyword">return</span> sum;
}
</code></pre>
<p>优化后，SumForLoop 性能提升 68%，LINQ 查询也因此受益。SkipTakeSum 从 3.525 μs 降至 1.773 μs。</p>
<p>同时，JIT 能识别 IEnumerable&lt; int&gt; 实际是 int[]，从而生成具体类型代码：</p>
<pre><code class="hljs language-cs" lang="cs"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> IEnumerable&lt;<span class="hljs-built_in">int</span>&gt; s_values = <span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>[] { <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span> };
[<span class="hljs-meta">Benchmark</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">Sum</span>()</span>
{
    <span class="hljs-built_in">int</span> sum = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">foreach</span> (<span class="hljs-built_in">int</span> <span class="hljs-keyword">value</span> <span class="hljs-keyword">in</span> s_values) sum += <span class="hljs-keyword">value</span>;
    <span class="hljs-keyword">return</span> sum;
}
</code></pre>
<p>执行时间从 16.34 ns 降至 2.06 ns，内存分配归零。</p>
<h4 data-id="heading-4">四、线程池调度</h4>
<p>"同步包装异步"常导致线程池死锁。.NET 10 在线程即将阻塞时，主动将本地队列任务移交全局队列，避免关键任务被无限延迟。</p>
<pre><code class="hljs language-cs" lang="cs"><span class="hljs-comment">// 模拟高负载下的线程池僵局</span>
ThreadPool.SetMaxThreads(numThreads, <span class="hljs-number">1</span>);
<span class="hljs-comment">// ... 提交阻塞任务与干扰任务</span>
</code></pre>
<p>在 .NET 9 中超时 20 秒的任务，.NET 10 仅需 4 毫秒完成。</p>
<h3 data-id="heading-5">五、硬件级大数运算与容器遍历优化</h3>
<p>UInt128 除法利用 CPU 的 DivRem 指令，性能提升近 50 倍：</p>























<table><thead><tr><th>Method</th><th>Runtime</th><th>Mean</th><th>Ratio</th></tr></thead><tbody><tr><td>Divide</td><td>.NET 9.0</td><td>27.3112 ns</td><td>1.00</td></tr><tr><td>Divide</td><td>.NET 10.0</td><td>0.5522 ns</td><td>0.02</td></tr></tbody></table>
<p>Stack、Queue、ConcurrentDictionary 的枚举器也全面重构。以 Stack 为例，MoveNext 的分支从 5 个减至 1 个，SumDirect 性能提升 81%，代码体积缩小 83%。</p>
<h3 data-id="heading-6">总结</h3>
<p>.NET 10 的性能进步，不是靠炫技，而是源于对"不做无用功"的极致追求。它让编译器从"代码执行者"变为"意图理解者"，让运行时从"被动响应"转向"主动预测”。这种系统性思维，不仅提升了数字指标，更重塑了高性能开发的默认体验——开发无需手动优化，即可享受接近底层的效率。</p>
<p>对于广大 .NET 开发而言，升级到 .NET 10 不仅意味着更长的支持周期，更是一次"免费”的性能红利。</p>
<h3 data-id="heading-7">关键词</h3>
<p>.NET 10、性能优化、LINQ、去虚拟化、JIT、线程池、委托内联、栈分配、UInt128、容器遍历</p>
<h3 data-id="heading-8">最后</h3>
<p>如果你觉得这篇文章对你有帮助，不妨点个赞支持一下！你的支持是我继续分享知识的动力。如果有任何疑问或需要进一步的帮助，欢迎随时留言。</p>
<p>也可以加入微信公众号 <strong>[DotNet技术匠]</strong> 社区，与其他热爱技术的同行一起交流心得，共同成长！</p>
<p><strong>优秀是一种习惯，欢迎大家留言学习！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android系统中HAL层开发实例]]></title>    <link>https://juejin.cn/post/7571749988080893961</link>    <guid>https://juejin.cn/post/7571749988080893961</guid>    <pubDate>2025-11-13T01:22:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571749988080893961" data-draft-id="7571725550710341659" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android系统中HAL层开发实例"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-13T01:22:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户345947411361"/> <meta itemprop="url" content="https://juejin.cn/user/1118620649271515"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android系统中HAL层开发实例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1118620649271515/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户345947411361
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T01:22:57.000Z" title="Thu Nov 13 2025 01:22:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aef6165e899c4227a5ae2116bcb69a87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MzQ1OTQ3NDExMzYx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763601777&amp;x-signature=XT4spgNBTFCRpATMgWTwJo%2FgnVQ%3D" alt="t01bf1f34d94fd74c63.jpg" loading="lazy"/></p>
<p><strong>Android系统中HAL层开发实例---youkeit.xyz/4706/</strong></p>
<h2 data-id="heading-0">从底层重构体验：Android Framework 引领移动开发技术迭代</h2>
<h3 data-id="heading-1">一、Android Framework 架构演进</h3>
<p>Android Framework 作为连接应用层与Linux内核的桥梁，其架构设计直接影响着移动开发的体验与效率。让我们从核心组件开始剖析：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 典型的Android Framework分层架构</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AndroidFramework</span> {
    <span class="hljs-comment">// 应用层组件</span>
    <span class="hljs-keyword">private</span> ApplicationLayer applicationLayer;
    
    <span class="hljs-comment">// Java API框架层</span>
    <span class="hljs-keyword">private</span> FrameworkLayer frameworkLayer;
    
    <span class="hljs-comment">// 本地库和Android运行时</span>
    <span class="hljs-keyword">private</span> NativeLayer nativeLayer;
    
    <span class="hljs-comment">// Linux内核层</span>
    <span class="hljs-keyword">private</span> KernelLayer kernelLayer;
    
    <span class="hljs-comment">// 关键系统服务</span>
    <span class="hljs-keyword">private</span> SystemServiceManager serviceManager;
}
</code></pre>
<h4 data-id="heading-2">1.1 组件化演进</h4>
<p>从Android 5.0引入的ART运行时替代Dalvik，到Android 10推出的Project Mainline模块化更新机制，Framework的核心变化体现在：</p>
<ol>
<li><strong>模块解耦</strong>：将系统组件拆分为独立模块（如WiFi、蓝牙等）</li>
<li><strong>动态更新</strong>：通过Google Play商店更新核心组件</li>
<li><strong>接口稳定</strong>：加强API兼容性保证</li>
</ol>
<h3 data-id="heading-3">二、关键技术创新点</h3>
<h4 data-id="heading-4">2.1 响应式架构改进</h4>
<p>Android Framework逐步引入响应式编程范式，典型如LiveData组件：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LocationViewModel</span> : <span class="hljs-type">ViewModel</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _location = MutableLiveData&lt;Location&gt;()
    <span class="hljs-keyword">val</span> location: LiveData&lt;Location&gt; = _location
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateLocation</span><span class="hljs-params">(newLocation: <span class="hljs-type">Location</span>)</span></span> {
        _location.value = newLocation
    }
}

<span class="hljs-comment">// Activity中的观察者</span>
viewModel.location.observe(<span class="hljs-keyword">this</span>) { location -&gt;
    updateUI(location)
}
</code></pre>
<h4 data-id="heading-5">2.2 性能优化底层机制</h4>
<p>Android 12引入的PerformanceClass API为开发者提供了设备性能分级标准：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 检查设备性能等级</span>
<span class="hljs-keyword">if</span> (BuildCompat.isAtLeastS() &amp;&amp; 
    PerformanceClassManager.getPerformanceClass() &gt;= 
    PerformanceClassManager.PERFORMANCE_CLASS_HIGH) {
    <span class="hljs-comment">// 启用高级功能</span>
    enableAdvancedFeatures();
}
</code></pre>
<h3 data-id="heading-6">三、Framework 深度定制实践</h3>
<h4 data-id="heading-7">3.1 自定义系统服务</h4>
<p>通过AIDL创建跨进程系统服务示例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 定义AIDL接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ICustomService</span> {
    <span class="hljs-type">int</span> <span class="hljs-title function_">getSystemStatus</span><span class="hljs-params">()</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setConfiguration</span><span class="hljs-params">(in Bundle config)</span>;
}

<span class="hljs-comment">// 服务端实现</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ICustomService</span>.Stub {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getSystemStatus</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> SystemProperties.getInt(<span class="hljs-string">"custom.status"</span>, <span class="hljs-number">0</span>);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setConfiguration</span><span class="hljs-params">(Bundle config)</span> {
        <span class="hljs-comment">// 处理配置更新</span>
    }
}

<span class="hljs-comment">// 注册服务</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerSystemService</span><span class="hljs-params">()</span> {
    ServiceManager.addService(<span class="hljs-string">"custom_service"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomServiceImpl</span>());
}
</code></pre>
<h4 data-id="heading-8">3.2 资源覆盖机制</h4>
<p>利用Runtime Resource Overlay (RRO)实现资源动态替换：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- overlay/values/strings.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">string</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"app_name"</span>&gt;</span>New App Name<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span>

<span class="hljs-comment">&lt;!-- overlay/AndroidManifest.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">manifest</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">package</span>=<span class="hljs-string">"com.example.overlay"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">overlay</span> <span class="hljs-attr">android:targetPackage</span>=<span class="hljs-string">"com.example.app"</span>
             <span class="hljs-attr">android:priority</span>=<span class="hljs-string">"1"</span>
             <span class="hljs-attr">android:isStatic</span>=<span class="hljs-string">"false"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span>
</code></pre>
<h3 data-id="heading-9">四、未来技术方向</h3>
<h4 data-id="heading-10">4.1 模块化架构深入</h4>
<p>Android 13进一步强化了模块化设计：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 动态模块加载示例</span>
<span class="hljs-type">val</span> <span class="hljs-variable">moduleManager</span> <span class="hljs-operator">=</span> ModuleManager.getInstance(context)
moduleManager.installModule(<span class="hljs-string">"dynamic_feature"</span>, 
    InstallCallback { status -&gt;
        <span class="hljs-keyword">if</span> (status == InstallStatus.SUCCESS) {
            <span class="hljs-comment">// 模块加载成功</span>
        }
    })
</code></pre>
<h4 data-id="heading-11">4.2 机器学习集成</h4>
<p>ML Kit与Framework深度整合：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用设备端模型进行处理</span>
<span class="hljs-keyword">val</span> recognizer = TextRecognizer.Builder(context)
    .setDeviceMode(MLContext.DEVICE_ONLY)
    .build()

recognizer.process(InputImage.fromBitmap(bitmap))
    .addOnSuccessListener { result -&gt;
        <span class="hljs-comment">// 处理识别结果</span>
    }
</code></pre>
<h3 data-id="heading-12">五、最佳实践建议</h3>
<ol>
<li><strong>兼容性处理</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.R) {
    <span class="hljs-comment">// 使用新API</span>
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 回退方案</span>
}
</code></pre>
<ol start="2">
<li><strong>性能监控</strong>：</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformanceMonitor</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startTrace</span><span class="hljs-params">(tag: <span class="hljs-type">String</span>)</span></span> {
        Trace.beginSection(tag)
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">endTrace</span><span class="hljs-params">()</span></span> {
        Trace.endSection()
    }
}
</code></pre>
<ol start="3">
<li><strong>资源优化</strong>：</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 使用vector drawable替代位图 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">vector</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">android:width</span>=<span class="hljs-string">"24dp"</span>
    <span class="hljs-attr">android:height</span>=<span class="hljs-string">"24dp"</span>
    <span class="hljs-attr">android:viewportWidth</span>=<span class="hljs-string">"24"</span>
    <span class="hljs-attr">android:viewportHeight</span>=<span class="hljs-string">"24"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">path</span> <span class="hljs-attr">android:fillColor</span>=<span class="hljs-string">"#FF0000"</span>
          <span class="hljs-attr">android:pathData</span>=<span class="hljs-string">"M12,2L4,12l8,10l8-10z"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">vector</span>&gt;</span>
</code></pre>
<h3 data-id="heading-13">结语</h3>
<p>Android Framework的持续演进为移动开发带来了前所未有的灵活性和性能潜力。开发者应当：</p>
<ol>
<li>深入理解Framework底层机制</li>
<li>及时适配新特性</li>
<li>合理利用模块化设计</li>
<li>关注性能与能效平衡</li>
</ol>
<p>通过掌握这些核心技术点，开发者能够在快速变化的技术浪潮中保持竞争力，构建出体验卓越的移动应用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀TRAE SOLO 实战赛 | 智启Coding 码力全开]]></title>    <link>https://juejin.cn/post/7571751304625815598</link>    <guid>https://juejin.cn/post/7571751304625815598</guid>    <pubDate>2025-11-13T02:42:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571751304625815598" data-draft-id="7571126773809479690" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀TRAE SOLO 实战赛 | 智启Coding 码力全开"/> <meta itemprop="keywords" content="Trae,AI编程,VibeCoding"/> <meta itemprop="datePublished" content="2025-11-13T02:42:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金酱"/> <meta itemprop="url" content="https://juejin.cn/user/1556564194374926"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀TRAE SOLO 实战赛 | 智启Coding 码力全开
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1556564194374926/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金酱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T02:42:50.000Z" title="Thu Nov 13 2025 02:42:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4de4d0f1dfd46da82bd9051f76951d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763606570&amp;x-signature=7y2hGHXBerfjHKaUhSxnDTGXYk4%3D" alt="image.png" loading="lazy"/></p>
<p>🔥<strong>TRAE SOLO 正式版</strong>重磅上线，Vibe Coding的实战舞台已就位！</p>
<p>无论你是用TRAE破解难题的先锋探索者，还是借它激发灵感的创意玩家，这里都是你展示思考、分享成长的舞台。</p>
<p>你的每一次踩坑经验，都可能成为他人的避坑指南；你的每一个实战技巧，都值得被千万开发者看见！</p>
<p>投稿分享你的<strong>TRAE SOLO</strong>实战秘籍，用代码说话，用干货圈粉，解锁超高曝光流量与丰厚奖品，在SOLO赛道上C位出圈！</p>
<h2 data-id="heading-0">💪活动人群</h2>
<h5 data-id="heading-1"><em><strong>创作等级 Lv4-Lv8用户 (非掘友等级）</strong></em></h5>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/187a397168d44a8a8e73590b62f84862~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1512&amp;h=714&amp;s=46590&amp;e=webp&amp;b=fdfbfb" alt="截屏2022-11-10 10.32.44.png" loading="lazy"/></p>
<h2 data-id="heading-2">⏰活动时间</h2>
<p>2025年11月13日-2025年12月16日</p>
<h2 data-id="heading-3">📒活动玩法</h2>
<h3 data-id="heading-4">🚀创作方向</h3>
<p>本次活动面向AI全链路开发者，以<strong>TRAE SOLO 正式版</strong>为核心开发工具，打通AI应用落地全流程，结合SOLO coder、DiffView等功能聚焦以下3个创作方向，形式包括但不限于实践分享、避坑指南、工具实测对比。</p>
<blockquote>
<ul>
<li><strong>TRAE SOLO驱动AI架构设计与技术选型</strong></li>
</ul>
<p>从0到1搭建AI应用时，如何借助TRAE SOLO做架构决策。如：基于TRAE SOLO的SOLO coder生成开发文档；利用MCP协议适配大模型服务的架构设计等。</p>
<ul>
<li><strong>TRAE SOLO赋能大模型工程化实践</strong></li>
</ul>
<p>在大模型集成、微调、部署等关键环节中，TRAE SOLO的实战应用，如：基于TRAE SOLO选择适配模型；通过内置部署模块实现模型服务一键上线；TRAE SOLO生成代码的兼容性问题修复（使用DiffView工具）；大模型API密钥配置的安全踩坑等。</p>
<ul>
<li><strong>TRAE SOLO支撑AI应用的可观测性与风险管控</strong></li>
</ul>
<p>AI应用开发与上线后，如何基于TRAE SOLO构建质量保障体系。如：利用TRAE SOLO的任务进度追踪功能监控开发全流程、借助自动生成的测试脚本验证AI功能稳定性等。</p>
</blockquote>
<h3 data-id="heading-5">⛵️流量加持</h3>
<blockquote>
<p><em><strong>实战先锋</strong></em></p>
<p>11月13日-11月26日发布的文章：</p>
<p>被官方推荐的文章，将根据文章质量评分，每周排名前<strong>10</strong>的文章均可获得<strong>5000</strong>流量曝光奖励；</p>
<p>周期节点分别为11月13日-11月19日，11月20日-11月26日。</p>
<p><em><strong>优秀投稿榜</strong></em></p>
<p>11月13日-12月2日发布的文章：</p>
<p>被官方推荐的文章，将结合文章质量、互动和浏览数据综合评分，排名前<strong>5</strong>的文章可获得<strong>20000</strong>流量曝光奖励。</p>
<p><em><strong>实战冲刺</strong></em></p>
<p>12月11日-12月15日发布的文章：</p>
<p>被官方推荐的文章，可额外获得<strong>2000</strong>流量曝光奖励，不限名额。</p>
<p><em>注：获得“实战先锋”“实战冲刺”奖励的文章，届时会通过系统消息或群消息通知获奖的创作者；</em></p>
<p><em>荣登“优秀投稿榜”的文章，预计会在12月4日通过“掘金酱”账号进行公示。</em></p>
</blockquote>
<h3 data-id="heading-6">🪐SOLO双赛道</h3>
<blockquote>
<p><em><strong>优秀文章奖</strong></em></p>
<p>活动期间发布的文章，且被官方推荐：</p>
<p>将根据单篇文章质量、互动数据、浏览数据综合评分，前<strong>20</strong>名获奖；同一用户多篇上榜，取最高名次，不重复获同一奖项。</p>
<p><em><strong>Coding达人奖</strong></em></p>
<p>活动期间同一用户发文数≥<strong>2</strong>篇：</p>
<p>单篇文章满足“<em><strong>官方推荐 且 互动数据＞40 且 浏览量＞1000</strong></em>”，即可参与排名。按文章质量、互动浏览数据、发文数量等<strong>综合评分排名</strong>，前<strong>10</strong>名获奖。</p>
<p><em>注：一篇文章可同时参与双赛道，叠加获奖</em></p>
</blockquote>
<h6 data-id="heading-7"><em>❗自动推荐文章也会有人工审核，不符合要求会取消推荐，如最终文章为未推荐状态，则无法获得相关活动奖励。</em></h6>
<h6 data-id="heading-8"><em>❗社区严厉打击刷量、刷赞、互赞行为，一经发现直接取消获奖资格，也请不要在掘金的群里刷屏互赞！通过互赞达到获奖文章条件的不计入、自己点的赞藏不计入</em>！</h6>
<h4 data-id="heading-9">Trae创作内容参考</h4>
<h5 data-id="heading-10">以<strong>TRAE SOLO</strong>实践、技术展示为主</h5>
<ol>
<li><a href="https://juejin.cn/post/7566965016281989170" target="_blank" title="https://juejin.cn/post/7566965016281989170">用 TRAE 开发审批系统：一套可复制的 AI 辅助开发工作流</a></li>
<li><a href="https://juejin.cn/post/7569139641233473574" target="_blank" title="https://juejin.cn/post/7569139641233473574">基于 TRAE + Spec-kit 实现树莓派智能小车控制系统</a></li>
<li><a href="https://juejin.cn/post/7569515660931203123" target="_blank" title="https://juejin.cn/post/7569515660931203123">AI 代理驱动开发实战：用 TRAE 构建经典吃豆人游戏</a></li>
</ol>
<h3 data-id="heading-11">👩🏻评委评审参考</h3>
<ul>
<li>内容质量：文章内容是否丰富、有深度，是否能够清晰地表达观点。</li>
<li>技术水平：文章中所介绍的技术是否先进、实用，是否能够解决实际问题。</li>
<li>创新性：文章是否具有创新性，是否能够提出新的思路或方法。</li>
<li>可读性：文章是否易于阅读，语言是否流畅。</li>
</ul>
<blockquote>
<p>最终评分结果为评审团打分，参考文章互动数据</p>
</blockquote>
<h2 data-id="heading-12">⁉️如何参与</h2>
<p>发布文章时选择带话题 <strong><a href="https://juejin.cn/theme/detail/7571274218302619694?contentType=0" target="_blank" title="https://juejin.cn/theme/detail/7571274218302619694?contentType=0">#TRAE SOLO#</a></strong> 和标签<a href="https://juejin.cn/tag/Trae" target="_blank" title="https://juejin.cn/tag/Trae">Trae</a>就可以被统计到哦💁🏻</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc025ba645bc4c32ac1e10d616fe7d35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763606570&amp;x-signature=0mi04wxqVTgwkgKRGDYgEuqR%2FDY%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-13">🎁活动奖励</h2>
<p>参加活动的优质文章也会获得额外流量曝光~</p>





























































<table><thead><tr><th>奖项名称</th><th>奖项设置</th><th>获奖人数</th><th>奖品名称</th><th>奖品图</th><th>站内荣誉认证</th></tr></thead><tbody><tr><td>优秀文章奖</td><td>TOP1</td><td>1名</td><td>西部数据（WD）1TB 移动硬盘</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b92f91a562af427a9534f2321878dc98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763606570&amp;x-signature=F1%2FQVN22ga0qG8MDNcK1x%2Bu1z7s%3D" alt="" loading="lazy"/></td><td>【AI技术专家】 掘金官方实体证书</td></tr><tr><td/><td>TOP2</td><td>1名</td><td>SKG K3腰部按摩仪</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0f58e0a521d4501a3e4709db9649b7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763606570&amp;x-signature=jxQBmNYHn4suO%2Bl2%2FluDLdBfMsM%3D" alt="" loading="lazy"/></td><td>【AI技术专家】 掘金官方实体证书</td></tr><tr><td/><td>TOP3</td><td>1名</td><td>罗技无线蓝牙机械键盘</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7412780a3b9040e8b33e32f578632244~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763606570&amp;x-signature=ngbs9tvoQXpd%2F8rj%2B16oVlO5vKM%3D" alt="" loading="lazy"/></td><td>【AI技术专家】 掘金官方实体证书</td></tr><tr><td/><td>TOP4-10</td><td>7名</td><td>漫步者头戴式蓝牙耳机</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1444cc68a49a45fead825f4991a331c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763606570&amp;x-signature=sDZY28sTrymlJN5qHO%2F%2BQYs5zT8%3D" alt="" loading="lazy"/></td><td>【AI技术先锋】 掘金官方电子证书</td></tr><tr><td/><td>TOP11-20</td><td>10名</td><td>TRAE大礼包</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0264dcff44a64834975e3ae6754c9af9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763606570&amp;x-signature=1DRaK5mLzSw%2FyUZqwT07QjTE1o8%3D" alt="91cd5cfd8b6eb071e1e5896ec77ea0d2.jpg" loading="lazy"/></td><td>【AI技术新星】 掘金官方电子证书</td></tr><tr><td>Coding达人奖</td><td>TOP1-10</td><td>10名</td><td>GUFIUS古菲斯围炉煮茶套装</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0133953a7c0749739490f63dd2ed1fa8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763606570&amp;x-signature=SxcHZm6jKIrZD4CyayWb0p0zNfE%3D" alt="" loading="lazy"/></td><td>【Coding达人】 掘金官方电子证书</td></tr></tbody></table>
<h2 data-id="heading-14">🗒️内容要求</h2>
<ul>
<li><strong>必须为原创技术文章</strong>，内容符合<a href="https://juejin.cn/book/6844733795329900551/section/6844733795380232199" target="_blank" title="https://juejin.cn/book/6844733795329900551/section/6844733795380232199">掘金社区的内容标准和规范</a>；</li>
<li><strong>字数不得少于 800 字</strong>，不得有广告/洗稿/凑字数/AI撰写等行为，如果发现有此类行为 ，直接取消所有获奖资格（备注：文章中50%及以上内容与网络内容相同，即视为洗稿）；</li>
<li><strong>文章要求首发在掘金</strong>，已在其他平台发布过的文章不计入活动，博客搬家/旧文新发等超过<strong>10篇</strong>直接取消所有获奖资格；</li>
<li><strong>学习笔记/知识点汇总类不能瓜分奖金</strong>，可以是知识点讲解/理解，即所有文章都需要有个人见解、思考、总结，单纯的搬运官网、书中知识点不计入；</li>
<li>刷赞、刷量等有作弊行为的文章，直接取消比赛资格，不能参与评选；</li>
<li>文章需包含背景/问题，核心思路，实操步骤/论证过程，总结反思等，不能只贴代码，如代码量超<strong>60%</strong> 则不计入；</li>
<li>AI代写文章、AI聊天记录等不计入活动（AI检测超过<strong>70%</strong> 取消文章获奖资格）；</li>
<li>工具汇总、软件测评类文章不可参加活动；</li>
<li>参赛文章必须注明参考来源。</li>
</ul>
<h6 data-id="heading-15"><em>活动期间，若发布文章内容与活动主题</em> <em>TRAE</em> <em>无相关性，则取消该用户对应文章获奖资格。</em></h6>
<h2 data-id="heading-16">☎️ 加群交流</h2>
<p>参加活动的掘友一定要入群哦，重要消息不错过，大家互相鼓励，有问题也可以在群内咨询哦～</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6ccf1e26f6f47878f366260e7d4dc67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763606570&amp;x-signature=B559L3y9LMDcB3R0kOVImKsVJpQ%3D" alt="image.png" loading="lazy"/></p>
<p>注意：活动开启，以及发奖进程都会第一时间群内通知，一定要进群呀，避免错过消息</p>
<h2 data-id="heading-17">👀 活动Q&amp;A</h2>
<p><strong>Q1：如何算是成功参与了活动？</strong></p>
<p>活动期间，在掘金平台发布TRAE SOLO相关原创技术文章，选择带话题  <strong><a href="https://juejin.cn/theme/detail/7571274218302619694?contentType=0" target="_blank" title="https://juejin.cn/theme/detail/7571274218302619694?contentType=0">#TRAE SOLO#</a></strong>  和标签<a href="https://juejin.cn/tag/Trae" target="_blank" title="https://juejin.cn/tag/Trae">Trae</a>，即可成功参与活动。注意话题≠标签！</p>
<p><strong>Q2：一篇文章可以参加多个活动吗</strong></p>
<p>可以，优秀文章奖和Coding达人奖2个赛道皆可参与。</p>
<p><strong>Q3：文章被推荐后一定能获得奖励吗</strong></p>
<p>不一定，lv4-lv8用户文章为自动推荐，但也相应的出现了一些利用权益钻空的用户，因此活动结束后会对文章进行人工审核，如果最终不符合优质文章标准也会取消该篇文章领取奖励的资格，若活动期间单用户出现的水文较多，会直接取消自动推荐的等级权益哦！。</p>
<p><strong>Q4：“流量加持”环节多久能获得流量奖励</strong></p>
<p>实战先锋、优秀投稿榜、实战冲刺预计分别会在公示后3天内进行流量投放，届时会通过系统消息或群消息通知获奖的创作者。</p>
<p><strong>Q5：“SOLO双赛道”什么时候开奖呢？如何知晓自己的奖项以及如何领取奖品？</strong></p>
<p>12月16日活动截止后，我们将对文章进行评选、公示，约10-15个工作日后会通过“掘金酱”账号进行名单公示，也会通过系统消息通知获奖的创作者领取奖励，预计填写问卷后的30个工作日内完成奖励发放。</p>
<p><strong>Q6：首发的定义是什么？</strong></p>
<p>未在其他网站发布过的文章，且第一次发布是在掘金。如文章非首发则无法获得奖励。</p>
<ul>
<li>最终解释权归<strong>稀土掘金技术社区</strong>官方所有</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java Duration 完全指南：高精度时间间隔处理的利器]]></title>    <link>https://juejin.cn/post/7571758212473913395</link>    <guid>https://juejin.cn/post/7571758212473913395</guid>    <pubDate>2025-11-13T02:23:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571758212473913395" data-draft-id="7571743311520202761" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java Duration 完全指南：高精度时间间隔处理的利器"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-13T02:23:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Main12138"/> <meta itemprop="url" content="https://juejin.cn/user/124660844331034"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java Duration 完全指南：高精度时间间隔处理的利器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/124660844331034/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Main12138
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T02:23:27.000Z" title="Thu Nov 13 2025 02:23:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>在 Java 8 引入的新时间 API 中，<code>java.time.Duration</code> 类是处理 <strong>时间间隔</strong> 的核心工具。它专门用于测量基于时间的时间量（小时、分钟、秒、纳秒），提供了高精度的计算能力和丰富的操作方法。</p>
<h2 data-id="heading-1">核心特性</h2>
<h3 data-id="heading-2">✅ Duration 的独特优势</h3>
<ul>
<li><strong>纳秒级精度</strong>：最高支持纳秒级别的时间精度</li>
<li><strong>不可变线程安全</strong>：所有实例都是不可变的，线程安全</li>
<li><strong>流畅API设计</strong>：提供链式调用的流畅接口</li>
<li><strong>单位转换便捷</strong>：支持各种时间单位间的轻松转换</li>
<li><strong>ISO-8601标准兼容</strong>：支持标准时间间隔格式</li>
</ul>
<h2 data-id="heading-3">创建 Duration 实例</h2>
<h3 data-id="heading-4">1. 静态工厂方法</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 基本单位创建</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">ofSeconds</span> <span class="hljs-operator">=</span> Duration.ofSeconds(<span class="hljs-number">30</span>);      <span class="hljs-comment">// 30秒</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">ofMinutes</span> <span class="hljs-operator">=</span> Duration.ofMinutes(<span class="hljs-number">15</span>);       <span class="hljs-comment">// 15分钟  </span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">ofHours</span> <span class="hljs-operator">=</span> Duration.ofHours(<span class="hljs-number">2</span>);           <span class="hljs-comment">// 2小时</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">ofMillis</span> <span class="hljs-operator">=</span> Duration.ofMillis(<span class="hljs-number">500</span>);       <span class="hljs-comment">// 500毫秒</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">ofNanos</span> <span class="hljs-operator">=</span> Duration.ofNanos(<span class="hljs-number">1000000</span>);     <span class="hljs-comment">// 1毫秒(100万纳秒)</span>

<span class="hljs-comment">// 组合创建</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">complex</span> <span class="hljs-operator">=</span> Duration.ofHours(<span class="hljs-number">1</span>)
                          .plusMinutes(<span class="hljs-number">30</span>)
                          .plusSeconds(<span class="hljs-number">45</span>);       <span class="hljs-comment">// 1小时30分45秒</span>
</code></pre>
<h3 data-id="heading-5">2. 时间点差值计算</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 基于 Instant（时间戳）</span>
<span class="hljs-type">Instant</span> <span class="hljs-variable">startInstant</span> <span class="hljs-operator">=</span> Instant.now();
Thread.sleep(<span class="hljs-number">2000</span>); <span class="hljs-comment">// 模拟操作</span>
<span class="hljs-type">Instant</span> <span class="hljs-variable">endInstant</span> <span class="hljs-operator">=</span> Instant.now();
<span class="hljs-type">Duration</span> <span class="hljs-variable">elapsed</span> <span class="hljs-operator">=</span> Duration.between(startInstant, endInstant);

<span class="hljs-comment">// 基于 LocalDateTime（无时区）</span>
<span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">meetingStart</span> <span class="hljs-operator">=</span> LocalDateTime.of(<span class="hljs-number">2023</span>, <span class="hljs-number">10</span>, <span class="hljs-number">1</span>, <span class="hljs-number">9</span>, <span class="hljs-number">0</span>);
<span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">meetingEnd</span> <span class="hljs-operator">=</span> LocalDateTime.of(<span class="hljs-number">2023</span>, <span class="hljs-number">10</span>, <span class="hljs-number">1</span>, <span class="hljs-number">11</span>, <span class="hljs-number">30</span>);
<span class="hljs-type">Duration</span> <span class="hljs-variable">meetingDuration</span> <span class="hljs-operator">=</span> Duration.between(meetingStart, meetingEnd);

<span class="hljs-comment">// 基于 LocalTime（仅时间）</span>
<span class="hljs-type">LocalTime</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> LocalTime.of(<span class="hljs-number">9</span>, <span class="hljs-number">0</span>);
<span class="hljs-type">LocalTime</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> LocalTime.of(<span class="hljs-number">17</span>, <span class="hljs-number">30</span>);
<span class="hljs-type">Duration</span> <span class="hljs-variable">workDuration</span> <span class="hljs-operator">=</span> Duration.between(startTime, endTime);
</code></pre>
<h3 data-id="heading-6">3. 字符串解析（ISO-8601标准）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ISO-8601 格式解析</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">pt20s</span> <span class="hljs-operator">=</span> Duration.parse(<span class="hljs-string">"PT20S"</span>);        <span class="hljs-comment">// 20秒</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">pt15m</span> <span class="hljs-operator">=</span> Duration.parse(<span class="hljs-string">"PT15M"</span>);        <span class="hljs-comment">// 15分钟</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">pt10h</span> <span class="hljs-operator">=</span> Duration.parse(<span class="hljs-string">"PT10H"</span>);        <span class="hljs-comment">// 10小时</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">p2d</span> <span class="hljs-operator">=</span> Duration.parse(<span class="hljs-string">"P2D"</span>);            <span class="hljs-comment">// 2天</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">pt1h30m</span> <span class="hljs-operator">=</span> Duration.parse(<span class="hljs-string">"PT1H30M"</span>);    <span class="hljs-comment">// 1小时30分钟</span>
</code></pre>
<h2 data-id="heading-7">核心操作指南</h2>
<h3 data-id="heading-8">🔢 时间值获取与转换</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Duration</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> Duration.ofHours(<span class="hljs-number">2</span>).plusMinutes(<span class="hljs-number">30</span>); <span class="hljs-comment">// 2小时30分钟</span>

<span class="hljs-comment">// 转换为不同单位</span>
<span class="hljs-type">long</span> <span class="hljs-variable">totalHours</span> <span class="hljs-operator">=</span> duration.toHours();        <span class="hljs-comment">// 2小时</span>
<span class="hljs-type">long</span> <span class="hljs-variable">totalMinutes</span> <span class="hljs-operator">=</span> duration.toMinutes();    <span class="hljs-comment">// 150分钟</span>
<span class="hljs-type">long</span> <span class="hljs-variable">totalSeconds</span> <span class="hljs-operator">=</span> duration.toSeconds();    <span class="hljs-comment">// 9000秒</span>
<span class="hljs-type">long</span> <span class="hljs-variable">totalMillis</span> <span class="hljs-operator">=</span> duration.toMillis();      <span class="hljs-comment">// 9,000,000毫秒</span>

<span class="hljs-comment">// 获取各部分（不转换单位）</span>
<span class="hljs-type">long</span> <span class="hljs-variable">hoursPart</span> <span class="hljs-operator">=</span> duration.toHoursPart();     <span class="hljs-comment">// 2小时</span>
<span class="hljs-type">long</span> <span class="hljs-variable">minutesPart</span> <span class="hljs-operator">=</span> duration.toMinutesPart(); <span class="hljs-comment">// 30分钟</span>
<span class="hljs-type">long</span> <span class="hljs-variable">secondsPart</span> <span class="hljs-operator">=</span> duration.toSecondsPart(); <span class="hljs-comment">// 0秒</span>
</code></pre>
<h3 data-id="heading-9">➕ 数学运算操作</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Duration</span> <span class="hljs-variable">base</span> <span class="hljs-operator">=</span> Duration.ofHours(<span class="hljs-number">1</span>);

<span class="hljs-comment">// 加法运算</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">afterAdd</span> <span class="hljs-operator">=</span> base.plusHours(<span class="hljs-number">2</span>)        <span class="hljs-comment">// 加2小时</span>
                       .plusMinutes(<span class="hljs-number">30</span>)      <span class="hljs-comment">// 加30分钟</span>
                       .plus(Duration.ofSeconds(<span class="hljs-number">10</span>)); <span class="hljs-comment">// 加10秒</span>

<span class="hljs-comment">// 减法运算  </span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">afterSubtract</span> <span class="hljs-operator">=</span> base.minusMinutes(<span class="hljs-number">15</span>)
                            .minus(Duration.ofSeconds(<span class="hljs-number">30</span>));

<span class="hljs-comment">// 乘除运算</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">doubled</span> <span class="hljs-operator">=</span> base.multipliedBy(<span class="hljs-number">2</span>);     <span class="hljs-comment">// 乘以2</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">halved</span> <span class="hljs-operator">=</span> base.dividedBy(<span class="hljs-number">2</span>);         <span class="hljs-comment">// 除以2</span>

<span class="hljs-comment">// 取绝对值</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">negative</span> <span class="hljs-operator">=</span> Duration.ofHours(-<span class="hljs-number">1</span>);
<span class="hljs-type">Duration</span> <span class="hljs-variable">absolute</span> <span class="hljs-operator">=</span> negative.abs();          <span class="hljs-comment">// 1小时</span>
</code></pre>
<h3 data-id="heading-10">⚖️ 比较与判断</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Duration</span> <span class="hljs-variable">shortTask</span> <span class="hljs-operator">=</span> Duration.ofMinutes(<span class="hljs-number">5</span>);
<span class="hljs-type">Duration</span> <span class="hljs-variable">longTask</span> <span class="hljs-operator">=</span> Duration.ofHours(<span class="hljs-number">1</span>);

<span class="hljs-comment">// 比较操作</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">isShorter</span> <span class="hljs-operator">=</span> shortTask.compareTo(longTask) &lt; <span class="hljs-number">0</span>; <span class="hljs-comment">// true</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">isZero</span> <span class="hljs-operator">=</span> shortTask.isZero();                   <span class="hljs-comment">// false</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">isNegative</span> <span class="hljs-operator">=</span> shortTask.isNegative();           <span class="hljs-comment">// false</span>

<span class="hljs-comment">// 相等判断</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">equal</span> <span class="hljs-operator">=</span> shortTask.equals(Duration.ofMinutes(<span class="hljs-number">5</span>)); <span class="hljs-comment">// true</span>
</code></pre>
<h2 data-id="heading-11">实战应用场景</h2>
<h3 data-id="heading-12">🎯 场景1：性能监控与执行时间测量</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformanceMonitor</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">measureExecution</span><span class="hljs-params">(String taskName, 
                                       Supplier&lt;T&gt; task)</span> {
        <span class="hljs-type">Instant</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> Instant.now();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">T</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> task.get();
            <span class="hljs-type">Instant</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> Instant.now();
            <span class="hljs-type">Duration</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> Duration.between(start, end);
            
            System.out.printf(<span class="hljs-string">"任务 '%s' 执行时间: %d 毫秒%n"</span>, 
                            taskName, duration.toMillis());
            <span class="hljs-keyword">return</span> result;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-type">Instant</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> Instant.now();
            <span class="hljs-type">Duration</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> Duration.between(start, end);
            System.err.printf(<span class="hljs-string">"任务 '%s' 失败，已执行: %d 毫秒%n"</span>, 
                            taskName, duration.toMillis());
            <span class="hljs-keyword">throw</span> e;
        }
    }
    
    <span class="hljs-comment">// 使用示例</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> measureExecution(<span class="hljs-string">"数据查询"</span>, () -&gt; {
            <span class="hljs-comment">// 模拟耗时操作</span>
            <span class="hljs-keyword">try</span> { Thread.sleep(<span class="hljs-number">1500</span>); } <span class="hljs-keyword">catch</span> (InterruptedException e) {}
            <span class="hljs-keyword">return</span> <span class="hljs-string">"查询结果"</span>;
        });
    }
}
</code></pre>
<h3 data-id="heading-13">🎯 场景2：超时控制与限流管理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TimeoutManager</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Duration timeout;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Duration retryInterval;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TimeoutManager</span><span class="hljs-params">(Duration timeout, Duration retryInterval)</span> {
        <span class="hljs-built_in">this</span>.timeout = timeout;
        <span class="hljs-built_in">this</span>.retryInterval = retryInterval;
    }
    
    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">executeWithTimeout</span><span class="hljs-params">(Callable&lt;T&gt; task)</span> <span class="hljs-keyword">throws</span> TimeoutException {
        <span class="hljs-type">Instant</span> <span class="hljs-variable">deadline</span> <span class="hljs-operator">=</span> Instant.now().plus(timeout);
        
        <span class="hljs-keyword">while</span> (Instant.now().isBefore(deadline)) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">return</span> task.call();
            } <span class="hljs-keyword">catch</span> (Exception e) {
                <span class="hljs-type">Duration</span> <span class="hljs-variable">remaining</span> <span class="hljs-operator">=</span> Duration.between(Instant.now(), deadline);
                <span class="hljs-keyword">if</span> (remaining.toMillis() &lt;= <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TimeoutException</span>(<span class="hljs-string">"操作超时"</span>);
                }
                
                <span class="hljs-comment">// 等待后重试</span>
                <span class="hljs-keyword">try</span> {
                    Thread.sleep(Math.min(retryInterval.toMillis(), 
                                        remaining.toMillis()));
                } <span class="hljs-keyword">catch</span> (InterruptedException ie) {
                    Thread.currentThread().interrupt();
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"操作被中断"</span>, ie);
                }
            }
        }
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TimeoutException</span>(<span class="hljs-string">"操作超时"</span>);
    }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-type">TimeoutManager</span> <span class="hljs-variable">manager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TimeoutManager</span>(
    Duration.ofSeconds(<span class="hljs-number">30</span>),    <span class="hljs-comment">// 30秒超时</span>
    Duration.ofSeconds(<span class="hljs-number">2</span>)      <span class="hljs-comment">// 2秒重试间隔</span>
);
</code></pre>
<h3 data-id="heading-14">🎯 场景3：缓存过期策略实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TimedCache</span>&lt;K, V&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;K, CacheEntry&lt;V&gt;&gt; cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Duration defaultTtl;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TimedCache</span><span class="hljs-params">(Duration defaultTtl)</span> {
        <span class="hljs-built_in">this</span>.defaultTtl = defaultTtl;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> {
        put(key, value, defaultTtl);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value, Duration ttl)</span> {
        <span class="hljs-type">Instant</span> <span class="hljs-variable">expiryTime</span> <span class="hljs-operator">=</span> Instant.now().plus(ttl);
        cache.put(key, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheEntry</span>&lt;&gt;(value, expiryTime));
    }
    
    <span class="hljs-keyword">public</span> V <span class="hljs-title function_">get</span><span class="hljs-params">(K key)</span> {
        CacheEntry&lt;V&gt; entry = cache.get(key);
        <span class="hljs-keyword">if</span> (entry == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        
        <span class="hljs-keyword">if</span> (Instant.now().isAfter(entry.getExpiryTime())) {
            cache.remove(key);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        <span class="hljs-keyword">return</span> entry.getValue();
    }
    
    <span class="hljs-comment">// 清理过期条目</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cleanup</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Instant</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> Instant.now();
        cache.entrySet().removeIf(entry -&gt; 
            now.isAfter(entry.getValue().getExpiryTime()));
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheEntry</span>&lt;V&gt; {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> V value;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Instant expiryTime;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">CacheEntry</span><span class="hljs-params">(V value, Instant expiryTime)</span> {
            <span class="hljs-built_in">this</span>.value = value;
            <span class="hljs-built_in">this</span>.expiryTime = expiryTime;
        }
        
        <span class="hljs-comment">// getters...</span>
    }
}
</code></pre>
<h3 data-id="heading-15">🎯 场景4：任务调度与延迟执行</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskScheduler</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ScheduledExecutorService</span> <span class="hljs-variable">scheduler</span> <span class="hljs-operator">=</span> 
        Executors.newScheduledThreadPool(<span class="hljs-number">2</span>);
    
    <span class="hljs-keyword">public</span> ScheduledFuture&lt;?&gt; scheduleWithFixedDelay(Runnable task,
                                                   Duration initialDelay,
                                                   Duration delay) {
        <span class="hljs-keyword">return</span> scheduler.scheduleWithFixedDelay(
            task,
            initialDelay.toMillis(), 
            delay.toMillis(),
            TimeUnit.MILLISECONDS
        );
    }
    
    <span class="hljs-keyword">public</span> ScheduledFuture&lt;?&gt; scheduleAtFixedRate(Runnable task,
                                                Duration initialDelay, 
                                                Duration period) {
        <span class="hljs-keyword">return</span> scheduler.scheduleAtFixedRate(
            task,
            initialDelay.toMillis(),
            period.toMillis(), 
            TimeUnit.MILLISECONDS
        );
    }
    
    <span class="hljs-comment">// 使用示例</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startMonitoring</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 5秒后开始，每30秒执行一次</span>
        scheduleAtFixedRate(
            <span class="hljs-built_in">this</span>::healthCheck,
            Duration.ofSeconds(<span class="hljs-number">5</span>),
            Duration.ofSeconds(<span class="hljs-number">30</span>)
        );
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">healthCheck</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"执行健康检查: "</span> + Instant.now());
    }
}
</code></pre>
<h3 data-id="heading-16">🎯 场景5：速率限制器实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RateLimiter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Duration refillInterval;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> maxTokens;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> tokens;
    <span class="hljs-keyword">private</span> Instant lastRefill;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RateLimiter</span><span class="hljs-params">(Duration refillInterval, <span class="hljs-type">int</span> maxTokens)</span> {
        <span class="hljs-built_in">this</span>.refillInterval = refillInterval;
        <span class="hljs-built_in">this</span>.maxTokens = maxTokens;
        <span class="hljs-built_in">this</span>.tokens = maxTokens;
        <span class="hljs-built_in">this</span>.lastRefill = Instant.now();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">()</span> {
        refillTokens();
        <span class="hljs-keyword">if</span> (tokens &gt; <span class="hljs-number">0</span>) {
            tokens--;
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> <span class="hljs-keyword">permits</span>)</span> {
        refillTokens();
        <span class="hljs-keyword">if</span> (tokens &gt;= <span class="hljs-keyword">permits</span>) {
            tokens -= <span class="hljs-keyword">permits</span>;
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">refillTokens</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Instant</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> Instant.now();
        <span class="hljs-type">Duration</span> <span class="hljs-variable">timeSinceLastRefill</span> <span class="hljs-operator">=</span> Duration.between(lastRefill, now);
        
        <span class="hljs-type">long</span> <span class="hljs-variable">refillCount</span> <span class="hljs-operator">=</span> timeSinceLastRefill.dividedBy(refillInterval);
        <span class="hljs-keyword">if</span> (refillCount &gt; <span class="hljs-number">0</span>) {
            tokens = Math.min(maxTokens, tokens + (<span class="hljs-type">int</span>)refillCount);
            lastRefill = lastRefill.plus(refillInterval.multipliedBy(refillCount));
        }
    }
    
    <span class="hljs-keyword">public</span> Duration <span class="hljs-title function_">getTimeUntilNextRefill</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Instant</span> <span class="hljs-variable">nextRefill</span> <span class="hljs-operator">=</span> lastRefill.plus(refillInterval);
        <span class="hljs-keyword">return</span> Duration.between(Instant.now(), nextRefill);
    }
}

<span class="hljs-comment">// 使用示例：限制每秒最多10个请求</span>
<span class="hljs-type">RateLimiter</span> <span class="hljs-variable">limiter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RateLimiter</span>(Duration.ofSeconds(<span class="hljs-number">1</span>), <span class="hljs-number">10</span>);
<span class="hljs-keyword">if</span> (limiter.tryAcquire()) {
    <span class="hljs-comment">// 处理请求</span>
} <span class="hljs-keyword">else</span> {
    <span class="hljs-type">Duration</span> <span class="hljs-variable">waitTime</span> <span class="hljs-operator">=</span> limiter.getTimeUntilNextRefill();
    System.out.println(<span class="hljs-string">"需要等待: "</span> + waitTime.toMillis() + <span class="hljs-string">"毫秒"</span>);
}
</code></pre>
<h2 data-id="heading-17">最佳实践与注意事项</h2>
<h3 data-id="heading-18">✅ 最佳实践</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 使用有意义的变量名</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">requestTimeout</span> <span class="hljs-operator">=</span> Duration.ofSeconds(<span class="hljs-number">30</span>);
<span class="hljs-type">Duration</span> <span class="hljs-variable">cacheTtl</span> <span class="hljs-operator">=</span> Duration.ofMinutes(<span class="hljs-number">10</span>);
<span class="hljs-type">Duration</span> <span class="hljs-variable">sessionDuration</span> <span class="hljs-operator">=</span> Duration.ofHours(<span class="hljs-number">2</span>);

<span class="hljs-comment">// 2. 优先使用工厂方法而不是构造函数</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">good</span> <span class="hljs-operator">=</span> Duration.ofMinutes(<span class="hljs-number">5</span>);      <span class="hljs-comment">// ✅ 推荐</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">bad</span> <span class="hljs-operator">=</span> Duration.ofSeconds(<span class="hljs-number">300</span>);      <span class="hljs-comment">// ❌ 可读性差</span>

<span class="hljs-comment">// 3. 合理处理大数值</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">largeDuration</span> <span class="hljs-operator">=</span> Duration.ofDays(<span class="hljs-number">365</span>); <span class="hljs-comment">// 1年</span>
<span class="hljs-keyword">if</span> (largeDuration.toDays() &gt; <span class="hljs-number">100</span>) {
    <span class="hljs-comment">// 处理大时间间隔</span>
}

<span class="hljs-comment">// 4. 使用合适的精度</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">highPrecision</span> <span class="hljs-operator">=</span> Duration.ofNanos(<span class="hljs-number">100</span>);  <span class="hljs-comment">// 需要高精度时</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">normalPrecision</span> <span class="hljs-operator">=</span> Duration.ofMillis(<span class="hljs-number">100</span>); <span class="hljs-comment">// 一般情况</span>
</code></pre>
<h3 data-id="heading-19">⚠️ 注意事项</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 避免在日期计算中使用 Duration（使用 Period）</span>
<span class="hljs-type">LocalDate</span> <span class="hljs-variable">today</span> <span class="hljs-operator">=</span> LocalDate.now();
<span class="hljs-type">LocalDate</span> <span class="hljs-variable">nextMonth</span> <span class="hljs-operator">=</span> today.plus(Period.ofMonths(<span class="hljs-number">1</span>)); <span class="hljs-comment">// ✅ 正确</span>
<span class="hljs-type">LocalDate</span> <span class="hljs-variable">wrong</span> <span class="hljs-operator">=</span> today.plus(Duration.ofDays(<span class="hljs-number">30</span>));    <span class="hljs-comment">// ❌ 可能不准确</span>

<span class="hljs-comment">// 2. 注意时区问题</span>
<span class="hljs-type">ZonedDateTime</span> <span class="hljs-variable">zonedStart</span> <span class="hljs-operator">=</span> ZonedDateTime.now();
<span class="hljs-type">ZonedDateTime</span> <span class="hljs-variable">zonedEnd</span> <span class="hljs-operator">=</span> zonedStart.plus(Duration.ofHours(<span class="hljs-number">2</span>));
<span class="hljs-type">Duration</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> Duration.between(zonedStart, zonedEnd); <span class="hljs-comment">// ✅ 正确处理时区</span>

<span class="hljs-comment">// 3. 大数值计算可能溢出</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">veryLarge</span> <span class="hljs-operator">=</span> Duration.ofDays(Integer.MAX_VALUE);
<span class="hljs-type">long</span> <span class="hljs-variable">days</span> <span class="hljs-operator">=</span> veryLarge.toDays(); <span class="hljs-comment">// 可能溢出，需要检查</span>
</code></pre>
<h2 data-id="heading-20">总结</h2>
<p><strong>Duration 是以下场景的理想选择：</strong></p>
<ul>
<li>✅ <strong>高精度时间测量</strong>（性能监控、执行时间统计）</li>
<li>✅ <strong>超时控制和限流</strong>（网络请求、资源管理）</li>
<li>✅ <strong>缓存和会话管理</strong>（TTL设置、过期策略）</li>
<li>✅ <strong>任务调度</strong>（延迟执行、定期任务）</li>
<li>✅ <strong>速率限制</strong>（API限流、流量控制）</li>
</ul>
<p><strong>关键优势：</strong></p>
<ul>
<li>纳秒级精度满足高性能需求</li>
<li>不可变设计保证线程安全</li>
<li>流畅API提升开发体验</li>
<li>丰富的时间单位转换支持</li>
</ul>
<p>掌握 Duration 的使用，能够让你在时间敏感的应用场景中游刃有余，构建出更加健壮和高效的系统。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS 定位彻底搞懂：五种 position 的真实差异与最佳实践]]></title>    <link>https://juejin.cn/post/7571648135585955883</link>    <guid>https://juejin.cn/post/7571648135585955883</guid>    <pubDate>2025-11-12T15:59:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571648135585955883" data-draft-id="7571678388954447891" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS 定位彻底搞懂：五种 position 的真实差异与最佳实践"/> <meta itemprop="keywords" content="前端,CSS"/> <meta itemprop="datePublished" content="2025-11-12T15:59:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ouma_syu"/> <meta itemprop="url" content="https://juejin.cn/user/2728363512824729"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS 定位彻底搞懂：五种 position 的真实差异与最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2728363512824729/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ouma_syu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T15:59:52.000Z" title="Wed Nov 12 2025 15:59:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">彻底读懂 CSS 定位：文档流、relative、absolute、fixed、sticky 全面解析</h2>
<p>在前端布局体系中，<code>position</code> 是最核心也最容易产生误解的属性。它决定了元素是否参与文档流、参考基准的选择方式、滚动表现以及层叠关系等关键特性。</p>
<p>本文将以统一的逻辑体系，将 <code>position</code> 拆解成最易理解的一套认知结构。读完后，你将能够真正做到：<strong>定位用得准，布局不踩坑。</strong></p>
<hr/>
<h2 data-id="heading-1">一、什么是文档流？为什么所有定位都围绕它展开？</h2>
<p>在浏览器默认布局规则下，元素都会按照“文档流（normal flow）”来排列：</p>
<ul>
<li><strong>块级元素</strong>：从上到下排列</li>
<li><strong>行内元素</strong>：从左到右排列</li>
</ul>
<p>只要元素仍在文档流中，它就会<strong>占据空间</strong>并参与后续元素的排布。</p>
<p>而一旦元素“脱离文档流”，则意味着：</p>
<ul>
<li>不再占据原来的空间</li>
<li>不影响其他元素位置</li>
<li>可在页面中自由摆放</li>
</ul>
<p>理解是否“脱流”，是掌握所有定位方式的关键。</p>
<hr/>
<h2 data-id="heading-2">二、五种定位方式逐个拆解</h2>
<h3 data-id="heading-3">1. position: static（默认定位）</h3>
<ul>
<li>元素按文档流正常排列</li>
<li>不支持 <code>top/left</code> 等偏移属性</li>
<li>常用于<strong>重置定位</strong></li>
</ul>
<p>一句话总结：最普通的布局方式。</p>
<hr/>
<h3 data-id="heading-4">2. position: relative（相对定位）</h3>
<p><strong>特性：</strong></p>
<ul>
<li>不脱离文档流（仍占据原来的位置）</li>
<li>偏移参照自身的“原本位置”</li>
<li>常用于为 absolute 元素建立“定位上下文”</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.parent</span> { <span class="hljs-attribute">position</span>: relative; }
<span class="hljs-selector-class">.child</span> { <span class="hljs-attribute">position</span>: absolute; <span class="hljs-attribute">right</span>: <span class="hljs-number">100px</span>; }
</code></pre>
<p>relative 本质上是对元素进行“微调”，或用于创建新的定位参考点。</p>
<hr/>
<h3 data-id="heading-5">3. position: absolute（绝对定位）</h3>
<p><strong>特性：</strong></p>
<ul>
<li>脱离文档流</li>
<li>不再占据空间</li>
<li>参照“最近的非 static 的父元素”</li>
<li>若无定位父元素，则参照 <code>body/html</code></li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.parent</span> { <span class="hljs-attribute">position</span>: relative; }
<span class="hljs-selector-class">.child</span> { <span class="hljs-attribute">position</span>: absolute; <span class="hljs-attribute">right</span>: <span class="hljs-number">100px</span>; }
</code></pre>
<p><code>.child</code> 会以 <code>.parent</code> 为基准定位。</p>
<p>经典居中：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>);
}
</code></pre>
<p>比 margin auto 更稳定，是前端面试必背方案。</p>
<hr/>
<h3 data-id="heading-6">4. position: fixed（固定定位）</h3>
<p><strong>特性：</strong></p>
<ul>
<li>脱离文档流</li>
<li>以浏览器视口（viewport）为基准</li>
<li>页面滚动时位置保持不变</li>
</ul>
<p>常见使用场景：</p>
<ul>
<li>悬浮图标</li>
<li>固定导航栏</li>
<li>返回顶部按钮</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.child</span> {
  <span class="hljs-attribute">position</span>: fixed;
  <span class="hljs-attribute">right</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">bottom</span>: <span class="hljs-number">100px</span>;
}
</code></pre>
<hr/>
<h3 data-id="heading-7">5. position: sticky（粘性定位）</h3>
<p>sticky 是 relative 与 fixed 的结合体：</p>
<ul>
<li>未触发阈值 → 像 relative（不脱流）</li>
<li>触发阈值 → 像 fixed（吸附在屏幕）</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">position</span>: sticky;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">100px</span>;
}
</code></pre>
<p>常用于吸顶导航、文档标题区等。</p>
<p>注意 sticky 生效条件：</p>
<ul>
<li>必须指定 top/right/bottom/left</li>
<li>父元素不能是 <code>overflow: hidden/auto</code>（否则可能失效）</li>
</ul>
<hr/>
<h2 data-id="heading-8">三、示例代码中的关键知识点总结</h2>
<h3 data-id="heading-9">相对 + 绝对定位：最常用的布局模式</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.parent</span> { <span class="hljs-attribute">position</span>: relative; }
<span class="hljs-selector-class">.child</span> { <span class="hljs-attribute">position</span>: absolute; <span class="hljs-attribute">right</span>: <span class="hljs-number">100px</span>; }
</code></pre>
<p>relative 创建定位上下文，absolute 精准定位。</p>
<hr/>
<h3 data-id="heading-10">最稳健的居中方案</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>);
}
</code></pre>
<p>不会受元素尺寸影响，是居中布局的最佳实践。</p>
<hr/>
<h3 data-id="heading-11">fixed：真正的“固定在屏幕”</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.child</span> {
  <span class="hljs-attribute">position</span>: fixed;
  <span class="hljs-attribute">right</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">bottom</span>: <span class="hljs-number">100px</span>;
}
</code></pre>
<hr/>
<h3 data-id="heading-12">sticky：滚动到某一点自动吸顶</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">position</span>: sticky;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">100px</span>;
}
</code></pre>
<hr/>
<h3 data-id="heading-13">重置定位：position: static</h3>
<p>当父元素从 absolute → static 时，absolute 子元素会重新寻找新的定位参考点。</p>
<p>示例：</p>
<pre><code class="hljs language-ini" lang="ini">setTimeout(() =&gt; {
  <span class="hljs-attr">oParent.style.position</span> = <span class="hljs-string">'static'</span><span class="hljs-comment">;</span>
}, 5000)<span class="hljs-comment">;</span>
</code></pre>
<p>5 秒后，absolute 子元素将以 body 为基准重新定位。</p>
<hr/>
<h2 data-id="heading-14">四、总结</h2>









































<table><thead><tr><th>属性</th><th>是否脱离文档流</th><th>偏移参考点</th><th>常用场景</th></tr></thead><tbody><tr><td>static</td><td>不脱离</td><td>文档流</td><td>默认、重置定位</td></tr><tr><td>relative</td><td>不脱离</td><td>元素自身原位置</td><td>微调、创建定位上下文</td></tr><tr><td>absolute</td><td>脱离</td><td>最近的非 static 父元素</td><td>弹窗、浮层、卡片定位</td></tr><tr><td>fixed</td><td>脱离</td><td>视口 viewport</td><td>悬浮 UI、固定导航</td></tr><tr><td>sticky</td><td>阈值前不脱离 阈值后脱离</td><td>自身 + 视口</td><td>吸顶、目录导航</td></tr></tbody></table>
<p>CSS 定位并不复杂，真正的核心只有三个：</p>
<ol>
<li>是否脱离文档流</li>
<li>参考谁进行定位</li>
<li>滚动时如何表现</li>
</ol>
<p>掌握这三点，你就能在布局中做到真正的“心中有数”，面对任何复杂布局也能游刃有余。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入解析JavaScript数组：从内存原理到高效遍历实践]]></title>    <link>https://juejin.cn/post/7571637614202306587</link>    <guid>https://juejin.cn/post/7571637614202306587</guid>    <pubDate>2025-11-12T07:21:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571637614202306587" data-draft-id="7571427088071557146" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入解析JavaScript数组：从内存原理到高效遍历实践"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-12T07:21:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="闲云ing"/> <meta itemprop="url" content="https://juejin.cn/user/2974655942502250"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入解析JavaScript数组：从内存原理到高效遍历实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2974655942502250/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    闲云ing
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T07:21:30.000Z" title="Wed Nov 12 2025 07:21:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">深入解析 JavaScript 数组：从内存原理到高效遍历实践</h2>
<p>在前端开发中，数组是最基础、最常用的数据结构之一。它语法简洁、开箱即用，既能存储简单的数据列表，也能支撑复杂的业务逻辑。然而，很多开发者对数组的理解停留在 <code>push</code>、<code>map</code>、<code>forEach</code> 等 API 的使用层面，对其底层机制缺乏系统认知。</p>
<p>本文将从内存模型、创建方式、遍历性能到结构选型，带你深入理解 JavaScript 数组的本质，帮助你在实际开发中做出更合理的技术决策。</p>
<hr/>
<h3 data-id="heading-1">一、数组的内存模型：栈与堆如何协作？</h3>
<p>JavaScript 中的变量存储分为<strong>栈内存</strong>和<strong>堆内存</strong>。当我们创建一个数组时，这两者会协同工作：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>]<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li>变量 <code>arr</code> 本身（即引用地址）存储在<strong>栈内存</strong>中；</li>
<li>数组的实际数据 <code>[1, 2, 3, ..., 6]</code> 存储在<strong>堆内存</strong>中，并占用<strong>连续的内存空间</strong>。</li>
</ul>
<p>这种设计使得通过下标访问元素（如 <code>arr[2]</code>）的时间复杂度为 <strong>O(1)</strong> ，效率极高。</p>
<p>即使是通过构造函数创建空数组：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(); <span class="hljs-comment">// 或 []</span>
</code></pre>
<p>栈中依然保存引用，堆中则分配一块初始空间（可能为空），后续写入数据时再逐步填充。</p>
<p>若需要初始化一个固定长度且值统一的数组，推荐使用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">6</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// [0, 0, 0, 0, 0, 0]</span>
</code></pre>
<p>这种方式一次性分配连续内存并完成初始化，避免了逐个赋值的开销。</p>
<hr/>
<h3 data-id="heading-2">二、创建数组：固定长度 vs 动态扩容</h3>
<p>数组的创建方式看似简单，实则涉及内存规划的权衡。</p>
<ul>
<li><strong>已知元素内容</strong>：直接使用字面量 <code>const arr = [1, 2, 3]</code> 最高效，内存精准匹配。</li>
<li><strong>仅知长度</strong>：可用 <code>new Array(n).fill(defaultValue)</code> 预分配空间。</li>
</ul>
<p>但要注意：</p>
<ul>
<li>若预估长度<strong>过大</strong>，会造成内存浪费；</li>
<li>若预估长度<strong>过小</strong>，后续插入超出范围的元素时，JavaScript 引擎会触发<strong>动态扩容</strong>。</li>
</ul>
<p>扩容过程类似“搬家”：申请更大的连续内存块 → 复制旧数据 → 释放原空间。这一过程时间复杂度为 O(n)，频繁扩容会影响性能。</p>
<blockquote>
<p>💡 小结：数组适合<strong>读多写少、长度相对稳定</strong>的场景；若需频繁增删，链表等离散结构可能更合适。</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">三、遍历数组：性能与可读性的平衡</h3>
<p>JavaScript 提供了多种遍历方式，它们在性能、灵活性和可读性上各有侧重。</p>
<h4 data-id="heading-4">1. 传统 for 循环：性能最优</h4>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = new Array(<span class="hljs-number">6</span>).fill(<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">len</span> = arr.length<span class="hljs-comment">;</span>
for (let <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; len; i++) {</span>
  console.log(arr<span class="hljs-section">[i]</span>)<span class="hljs-comment">;</span>
}
</code></pre>
<ul>
<li>直接通过索引访问，无函数调用开销；</li>
<li>缓存 <code>length</code> 可避免重复读取属性（现代引擎虽已优化，但仍属良好习惯）；</li>
<li><strong>适合大数据量或性能敏感场景</strong>。</li>
</ul>
<h4 data-id="heading-5">2. forEach：简洁但无法中断</h4>
<pre><code class="hljs language-javascript" lang="javascript">arr.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(item, index);
});
</code></pre>
<ul>
<li>优点：语义清晰，无需管理索引；</li>
<li>缺点：<strong>不支持 <code>break</code> 或 <code>continue</code></strong>，且每次迭代都有函数调用开销；</li>
<li><strong>适用于纯遍历、无需中断的场景</strong>。</li>
</ul>
<h4 data-id="heading-6">3. map：用于数据转换</h4>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">newArr</span> = arr.map(item =&gt; item + <span class="hljs-number">1</span>)<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li>返回一个新数组，<strong>不修改原数组</strong>；</li>
<li>适合“遍历 + 加工”的需求；</li>
<li>注意：不要用 <code>map</code> 仅做遍历（会产生无用的新数组，浪费内存）。</li>
</ul>
<h4 data-id="heading-7">4. for...of：ES6 的优雅之选</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> item of arr) {
  console.<span class="hljs-built_in">log</span>(item);
}
</code></pre>
<ul>
<li>直接获取元素值，语法简洁；</li>
<li>支持 <code>break</code>/<code>continue</code>；</li>
<li>性能接近 <code>for</code> 循环，远优于 <code>forEach</code>；</li>
<li><strong>日常开发推荐使用</strong>。</li>
</ul>
<h4 data-id="heading-8">5. for...in：慎用于数组！</h4>
<p><code>for...in</code> 的设计初衷是<strong>遍历对象的可枚举属性</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">obj</span> = { name: <span class="hljs-string">"小明"</span>, age: <span class="hljs-number">18</span> }<span class="hljs-comment">;</span>
for (let key in obj) {
  console.log(key, obj<span class="hljs-section">[key]</span>)<span class="hljs-comment">;</span>
}
</code></pre>
<p>虽然数组在 JavaScript 中也是对象（索引即属性名），但使用 <code>for...in</code> 遍历数组存在风险：</p>
<ul>
<li>可能遍历到原型链上的属性（若未正确设置）；</li>
<li>属性名是字符串（如 <code>"0"</code>），非数字；</li>
<li>遍历顺序不保证（尽管通常按索引顺序）。</li>
</ul>
<p>✅ <strong>建议</strong>：数组遍历请优先使用 <code>for</code>、<code>for...of</code> 或函数式方法，<strong>避免使用 <code>for...in</code></strong>。</p>
<hr/>
<h3 data-id="heading-9">四、数组 vs 其他数据结构：如何选择？</h3>
<p>数组是线性结构的代表，但在不同场景下，其他数据结构可能更合适：</p>






























<table><thead><tr><th>数据结构</th><th>特点</th><th>优势场景</th></tr></thead><tbody><tr><td><strong>栈</strong></td><td>先进后出（FILO）</td><td>函数调用、撤销操作、括号匹配</td></tr><tr><td><strong>队列</strong></td><td>先进先出（FIFO）</td><td>任务调度、BFS、消息缓冲</td></tr><tr><td><strong>链表</strong></td><td>节点离散，指针连接</td><td>频繁插入/删除（如购物车、播放列表）</td></tr><tr><td><strong>树</strong></td><td>层级结构（如二叉树）</td><td>分类数据、DOM 结构、搜索索引</td></tr></tbody></table>
<p>数组的核心优势在于<strong>随机访问快</strong>，适合以读取为主、长度稳定的场景；而链表在动态增删上更高效，树结构则擅长处理层级关系。</p>
<hr/>
<h3 data-id="heading-10">五、经典陷阱：循环中的异步与作用域</h3>
<p>最后来看一个常见面试题，涉及遍历与异步的结合：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用 var</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(i), <span class="hljs-number">100</span>); <span class="hljs-comment">// 输出 10 个 10</span>
}

<span class="hljs-comment">// 使用 let</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(i), <span class="hljs-number">100</span>); <span class="hljs-comment">// 输出 0 到 9</span>
}
</code></pre>
<ul>
<li><code>var</code> 没有块级作用域，所有回调共享同一个 <code>i</code>，循环结束后 <code>i === 10</code>；</li>
<li><code>let</code> 在每次循环中创建独立的词法环境，每个回调捕获的是当前迭代的 <code>i</code> 值。</li>
</ul>
<p>这个例子提醒我们：<strong>理解作用域机制，是写出正确异步代码的前提</strong>。</p>
<hr/>
<h3 data-id="heading-11">总结</h3>
<p>JavaScript 数组虽简单，却融合了内存管理、性能优化与语言特性等多维度知识：</p>
<ul>
<li>合理初始化数组，可减少内存浪费；</li>
<li>根据场景选择遍历方式，兼顾性能与可维护性；</li>
<li>在动态性强或层级复杂的数据场景中，灵活选用链表、栈、树等结构；</li>
<li>避免常见陷阱（如 <code>for...in</code> 遍历数组、<code>var</code> 循环闭包问题）。</li>
</ul>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS定位全解析：从静态到粘性，掌握元素布局的核心技巧]]></title>    <link>https://juejin.cn/post/7571725550709489691</link>    <guid>https://juejin.cn/post/7571725550709489691</guid>    <pubDate>2025-11-12T16:12:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571725550709489691" data-draft-id="7571729682678235186" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS定位全解析：从静态到粘性，掌握元素布局的核心技巧"/> <meta itemprop="keywords" content="CSS"/> <meta itemprop="datePublished" content="2025-11-12T16:12:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户1203911294726"/> <meta itemprop="url" content="https://juejin.cn/user/2517262684662348"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS定位全解析：从静态到粘性，掌握元素布局的核心技巧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2517262684662348/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户1203911294726
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T16:12:37.000Z" title="Wed Nov 12 2025 16:12:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">CSS定位全解析：从静态到粘性，掌握元素布局的核心技巧</h2>
<p>在网页开发中，CSS定位是控制元素布局的核心技术之一。不同的定位方式可以让元素在页面上以各种方式排列和交互。本文将深入解析CSS中的各种定位方式，帮助前端开发者彻底掌握这一重要概念。</p>
<h3 data-id="heading-1">1. 文档流与定位基础</h3>
<p>在深入探讨各种定位方式之前，我们需要理解什么是文档流。文档流是HTML元素默认的布局方式：块级元素垂直排列，行内元素水平排列，遵循从上到下、从左到右的自然顺序。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>文档流示例<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        * { <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>; }
        <span class="hljs-selector-class">.block</span> { 
            <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>; 
            <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>; 
            <span class="hljs-attribute">background-color</span>: pink; 
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">10px</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"block"</span>&gt;</span>块级元素1<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"block"</span>&gt;</span>块级元素2<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>行内元素1<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>行内元素2<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-2">2. 相对定位(Relative Positioning)</h3>
<p>相对定位是相对于元素在文档流中的原始位置进行定位。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Relative 相对定位<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        *{
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
        }
        <span class="hljs-selector-class">.parent</span>{
            <span class="hljs-attribute">width</span>: <span class="hljs-number">500px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">500px</span>;
            <span class="hljs-attribute">background-color</span>: pink;
            <span class="hljs-attribute">position</span>: relative;
            <span class="hljs-attribute">left</span>: <span class="hljs-number">100px</span>;
            <span class="hljs-attribute">top</span>:<span class="hljs-number">100px</span>;
        }
        <span class="hljs-selector-class">.child</span>{
            <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
            <span class="hljs-attribute">background-color</span>: skyblue;
            <span class="hljs-attribute">position</span>: absolute;
        }
        <span class="hljs-selector-class">.box</span>{
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
            <span class="hljs-attribute">background-color</span>: red;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"parent"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"child"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc22712c9aa6498ba546e480ab34aff4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MTIwMzkxMTI5NDcyNg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763568756&amp;x-signature=oW0N4FvtN8Dbao6hZJcuE%2B%2FNXkE%3D" alt="0556b5234eebe36f871722d791372291.png" loading="lazy"/></p>
<p><strong>特点分析：</strong></p>
<ul>
<li>不会脱离文档流，原始位置继续被占用</li>
<li>后面的元素依然以标准流方式对待它</li>
<li>通过top、bottom、left、right属性进行微调</li>
<li>常用于微调元素位置或作为绝对定位元素的参考容器</li>
</ul>
<h3 data-id="heading-3">3. 绝对定位(Absolute Positioning)</h3>
<p>绝对定位元素会脱离文档流，不再占用原始空间。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>绝对定位示例<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        *{
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
        }
        <span class="hljs-selector-tag">body</span>{
            <span class="hljs-attribute">background-color</span>: azure;
        }
        <span class="hljs-selector-class">.parent</span>{
            <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.9</span>;
            <span class="hljs-attribute">width</span>: <span class="hljs-number">550px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">500px</span>;
            <span class="hljs-attribute">background-color</span>: pink;
            <span class="hljs-attribute">position</span>: relative;
        }
        <span class="hljs-selector-class">.child</span>{
            <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
            <span class="hljs-attribute">background-color</span>: skyblue;
            <span class="hljs-attribute">position</span>: absolute;
            <span class="hljs-attribute">right</span>: <span class="hljs-number">100px</span>;
        }
        <span class="hljs-selector-class">.box</span>{
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
            <span class="hljs-attribute">background-color</span>: green;
            <span class="hljs-attribute">position</span>: absolute;
            <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
            <span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;
            <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>,-<span class="hljs-number">50%</span>);
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"parent"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"child"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>123<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span>hello,world<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>456<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p><strong>关键特性：</strong></p>
<ul>
<li>脱离文档流，不占用空间</li>
<li>相对于最近的非static定位祖先元素定位</li>
<li>如果没有符合条件的祖先元素，则相对于初始包含块(通常是body)</li>
<li>常用于创建浮动元素、对话框、下拉菜单等</li>
</ul>
<p><strong>居中技巧：</strong> 使用绝对定位实现元素居中是一种常见技巧：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.center</span> {
    <span class="hljs-attribute">position</span>: absolute;
    <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
    <span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>);
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9cf73c1eafc04caab8efba55206ff207~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MTIwMzkxMTI5NDcyNg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763568756&amp;x-signature=S1avdQayzyNhPuQuw8n17p7ucKU%3D" alt="fc7f5c6151ddce40d040ec16eedab012.png" loading="lazy"/></p>
<h3 data-id="heading-4">4. 固定定位(Fixed Positioning)</h3>
<p>固定定位元素相对于浏览器窗口进行定位，不随页面滚动而移动。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>固定定位示例<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        *{
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
        }
        <span class="hljs-selector-tag">body</span>{
            <span class="hljs-attribute">height</span>: <span class="hljs-number">2000px</span>;
        }
        <span class="hljs-selector-class">.parent</span>{
            <span class="hljs-attribute">width</span>: <span class="hljs-number">500px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">500px</span>;
            <span class="hljs-attribute">background-color</span>: pink;
        }
        <span class="hljs-selector-class">.box</span>{
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
            <span class="hljs-attribute">background-color</span>: green;
        }
        <span class="hljs-selector-class">.child</span>{
            <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
            <span class="hljs-attribute">background-color</span>: blue;
            <span class="hljs-attribute">position</span>: fixed;
            <span class="hljs-attribute">right</span>: <span class="hljs-number">100px</span>;
            <span class="hljs-attribute">bottom</span>: <span class="hljs-number">100px</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"parent"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"child"</span>&gt;</span>固定定位元素<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p><strong>应用场景：</strong></p>
<ul>
<li>固定导航栏</li>
<li>回到顶部按钮</li>
<li>侧边广告栏</li>
<li>模态对话框</li>
</ul>
<h3 data-id="heading-5">5. 粘性定位(Sticky Positioning)</h3>
<p>粘性定位是相对定位和固定定位的混合体，在跨越特定阈值前为相对定位，之后为固定定位。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>粘性定位示例<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        *{
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
        }
        <span class="hljs-selector-class">.parent</span>{
            <span class="hljs-attribute">width</span>: <span class="hljs-number">500px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">500px</span>;
            <span class="hljs-attribute">background-color</span>: pink;
        }
        <span class="hljs-selector-class">.child</span>{
            <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
            <span class="hljs-attribute">background-color</span>: blue;
        }
        <span class="hljs-selector-class">.box</span>{
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
            <span class="hljs-attribute">background-color</span>: green;
            <span class="hljs-attribute">position</span>: sticky;
            <span class="hljs-attribute">top</span>: <span class="hljs-number">100px</span>;
        }
        <span class="hljs-selector-tag">body</span>{
            <span class="hljs-attribute">height</span>: <span class="hljs-number">2000px</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"parent"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"child"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span>hello,world<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p><strong>使用要点：</strong></p>
<ul>
<li>必须指定top、bottom、left或right至少一个阈值</li>
<li>在父容器内滚动时生效</li>
<li>兼容性较好，但需要测试目标浏览器支持情况</li>
<li>常用于表格标题固定、导航栏滚动固定等场景</li>
</ul>
<h3 data-id="heading-6">6. 静态定位(Static Positioning)</h3>
<p>静态定位是元素的默认定位方式，元素遵循正常的文档流。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>静态定位示例<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        *{
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
        }
        <span class="hljs-selector-class">.parent</span>{
            <span class="hljs-attribute">width</span>: <span class="hljs-number">500px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">500px</span>;
            <span class="hljs-attribute">background-color</span>: pink;
            <span class="hljs-attribute">left</span>: <span class="hljs-number">100px</span>;
            <span class="hljs-attribute">top</span>: <span class="hljs-number">100px</span>;
            <span class="hljs-attribute">position</span>: absolute;
        }
        <span class="hljs-selector-class">.child</span>{
            <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
            <span class="hljs-attribute">background-color</span>: blue;
        }
        <span class="hljs-selector-class">.box</span>{
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
            <span class="hljs-attribute">background-color</span>: green;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"parent"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"child"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span>hello,world<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">const</span> oParent = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.parent'</span>);
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>{
            oParent.<span class="hljs-property">style</span>.<span class="hljs-property">position</span>=<span class="hljs-string">'static'</span>;
        },<span class="hljs-number">5000</span>)
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p><strong>重要特性：</strong></p>
<ul>
<li>默认定位方式，元素处于正常文档流中</li>
<li>忽略top、bottom、left、right和z-index属性</li>
<li>常用于取消元素的定位属性</li>
</ul>
<h3 data-id="heading-7">7. 定位实战技巧与注意事项</h3>
<h4 data-id="heading-8">7.1 z-index与层叠上下文</h4>
<p>定位元素会创建新的层叠上下文，z-index属性控制垂直方向上的堆叠顺序：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.element</span> {
    <span class="hljs-attribute">position</span>: relative;
    <span class="hljs-attribute">z-index</span>: <span class="hljs-number">10</span>; <span class="hljs-comment">/* 数值越大，显示在越上层 */</span>
}
</code></pre>
<h4 data-id="heading-9">7.2 定位与响应式设计</h4>
<p>在使用定位时需要考虑响应式设计：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">768px</span>) {
    <span class="hljs-selector-class">.fixed-element</span> {
        <span class="hljs-attribute">position</span>: relative;
        <span class="hljs-attribute">right</span>: auto;
        <span class="hljs-attribute">bottom</span>: auto;
    }
}
</code></pre>
<h4 data-id="heading-10">7.3 性能考虑</h4>
<ul>
<li>•过多使用固定定位和绝对定位可能影响页面性能</li>
<li>•变换动画时考虑使用transform而不是定位属性</li>
<li>•避免在滚动事件中频繁修改定位属性</li>
</ul>
<h3 data-id="heading-11">8. 总结</h3>
<p>CSS定位是前端开发中的核心技能，不同的定位方式适用于不同的场景：</p>
<ul>
<li>•<strong>静态定位</strong>：默认布局方式，适用于大多数常规布局</li>
<li>•<strong>相对定位</strong>：微调元素位置，保持文档流结构</li>
<li>•<strong>绝对定位</strong>：创建浮动元素，精确定位</li>
<li>•<strong>固定定位</strong>：相对于视口固定，适合导航和广告</li>
<li>•<strong>粘性定位</strong>：滚动时切换定位方式，增强用户体验</li>
</ul>
<p>掌握这些定位方式并理解它们的适用场景，将帮助你创建出更加精美和功能丰富的网页布局。在实际开发中，根据具体需求选择合适的定位方式，并注意兼容性和性能问题，才能打造出优秀的用户体验。 希望本文能帮助你深入理解CSS定位，如果有任何疑问或想法，欢迎在评论区交流讨论！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[最新Eslint9+prettier+Husky暂存区配置（基于Vue)]]></title>    <link>https://juejin.cn/post/7571662618056146970</link>    <guid>https://juejin.cn/post/7571662618056146970</guid>    <pubDate>2025-11-12T17:23:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571662618056146970" data-draft-id="7571678674145755146" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="最新Eslint9+prettier+Husky暂存区配置（基于Vue)"/> <meta itemprop="keywords" content="代码规范"/> <meta itemprop="datePublished" content="2025-11-12T17:23:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JaneHe"/> <meta itemprop="url" content="https://juejin.cn/user/3280598429350967"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            最新Eslint9+prettier+Husky暂存区配置（基于Vue)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3280598429350967/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JaneHe
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T17:23:41.000Z" title="Wed Nov 12 2025 17:23:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言：Eslint是一种代码质量检查工具，确保代码符合相应规范，prettier是一个代码格式化工具，总而言之，Eslint查错，prettier改错。Husky是一个Git Hooks工具，在把代码提交给仓库时自动触发前两个工具，确保每次提交给仓库的代码都符合项目标准。</h3>
<p>接下来我们就基于创建Vue项目时配置这三个工具。</p>
<h3 data-id="heading-1">1.首先创建一个Vue3项目</h3>
<p>1.1 下载pnpm 包管理器</p>
<pre><code class="hljs">npm install -g pnpm
</code></pre>
<p>1.2 创建Vue3项目，直接贴图</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/448d27f54589480c97fe8334fb589381~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFuZUhl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763575172&amp;x-signature=BHNoXPQWJXjWk%2BF%2FjzoKYYR45Xw%3D" alt="f58a3239-258b-4bef-a925-78895e00b4b1.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b512f3eee0f94629854ef77bfc6aee90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFuZUhl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763575172&amp;x-signature=sk9K58Uol%2F1KmFoU4mF0A5gahqo%3D" alt="378516b1-a0ad-481d-b006-547889d3165e.png" loading="lazy"/></p>
<h3 data-id="heading-2">2.正式配置Eslint9+prettier+Husky</h3>
<p>2.1 配置设置文件</p>
<p>找到设置文件<code>settings.json</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5786acdb746a4ba28fbd7a4f0e137bcc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFuZUhl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763575172&amp;x-signature=kJ4yUzT9K163ByXNwSqOmpzNiFQ%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ae2408296c344bdbeaefbe3a2623bf1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFuZUhl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763575172&amp;x-signature=4BGOWjaQGeTIjZPBeaSRhIVLeJ8%3D" alt="image.png" loading="lazy"/></p>
<p>配置环境：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0c362122d314fe3897d43903d9743ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFuZUhl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763575172&amp;x-signature=5m7hWJ%2BKa2xtvYALP3RMg92crFY%3D" alt="image.png" loading="lazy"/>
下载包：</p>
<pre><code class="hljs language-css" lang="css">pnpm <span class="hljs-selector-tag">i</span> -D eslint-plugin-vue eslint-plugin-prettier
</code></pre>

<pre><code class="hljs language-arduino" lang="arduino">pnpm i -D prettier eslint-config-prettier
</code></pre>

<pre><code class="hljs language-bash" lang="bash">pnpm i -D @eslint/js @eslint/eslintrc
</code></pre>
<p>然后在<code>eslint.config.js</code>中导入包，代码如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> eslintConfigPrettier <span class="hljs-keyword">from</span> <span class="hljs-string">'@vue/eslint-config-prettier'</span> <span class="hljs-comment">//添加这一行代码</span>
<span class="hljs-keyword">import</span> eslintPluginPrettier <span class="hljs-keyword">from</span> <span class="hljs-string">'eslint-plugin-prettier/recommended'</span>
</code></pre>
<p>如图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/354a8953d53043269439374e3d62a27b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFuZUhl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763575172&amp;x-signature=sXbecIMniS9hmA9VzVv%2BrTwSWZM%3D" alt="7605296d-40e0-421f-bb79-31bd28220add.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98fa36d3bcb64ac18eacd2a0e542961d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFuZUhl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763575172&amp;x-signature=4y6kVkldR1jE0OrI%2BzrRCaIKC1M%3D" alt="image.png" loading="lazy"/>
接着在defineConfig里面添加rules和刚刚下好的包配置，代码如下：</p>
<pre><code class="hljs language-arduino" lang="arduino">   eslintConfigPrettier, <span class="hljs-comment">//添加这一行代码</span>
  eslintPluginPrettier, <span class="hljs-comment">// 解决 prettier 和 eslint 的冲突，比如 eslint 里面是 开启 双引号，prettier 里面开启单引号</span>
  {
    rules: {
      <span class="hljs-string">'prettier/prettier'</span>: [
        <span class="hljs-string">'warn'</span>,
        {
          singleQuote: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 单引号</span>
          semi: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 无分号</span>
          printWidth: <span class="hljs-number">100</span>, <span class="hljs-comment">// 每行宽度至多80字符</span>
          trailingComma: <span class="hljs-string">'none'</span>, <span class="hljs-comment">// 不加对象|数组最后逗号</span>
          endOfLine: <span class="hljs-string">'auto'</span> <span class="hljs-comment">// 换行符号不限制（win mac 不一致）</span>
        }
      ],
      <span class="hljs-string">'vue/multi-word-component-names'</span>: [
        <span class="hljs-string">'warn'</span>,
        {
          ignores: [<span class="hljs-string">'index'</span>] <span class="hljs-comment">// vue组件名称多单词组成（忽略index.vue）</span>
        }
      ],
      <span class="hljs-string">'vue/no-setup-props-destructure'</span>: [<span class="hljs-string">'off'</span>], <span class="hljs-comment">// 关闭 props 解构的校验</span>
      <span class="hljs-comment">// 💡 添加未定义变量错误提示，create-vue@3.6.3 关闭，这里加上是为了支持下一个章节演示。</span>
      <span class="hljs-string">'no-undef'</span>: <span class="hljs-string">'error'</span>
    }
  },
</code></pre>
<p>如图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1abe9be2f8204907a8985672f8a1bfb0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFuZUhl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763575172&amp;x-signature=Wka2evK3tAcJDhJ3uvWmsXL0iGI%3D" alt="image.png" loading="lazy"/></p>
<p>然后配置Husky,先在终端里初始化仓库</p>
<pre><code class="hljs language-csharp" lang="csharp">git <span class="hljs-keyword">init</span>
</code></pre>
<p>初始化Husky 工具配置</p>
<pre><code class="hljs language-csharp" lang="csharp">pnpm dlx husky-<span class="hljs-keyword">init</span> &amp;&amp; pnpm install
</code></pre>
<p>lint-staged 配置</p>
<pre><code class="hljs language-css" lang="css">pnpm <span class="hljs-selector-tag">i</span> -D lint-staged
</code></pre>
<p>配置 <code>package.json</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f80cadc4893400a8ec0fe5893f71553~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFuZUhl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763575172&amp;x-signature=C8j4D6m65YMjNxnMHlreS2Npki8%3D" alt="image.png" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a14864a3569749589ce119313adfc1f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFuZUhl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763575172&amp;x-signature=kLDRkKcdUA3uobfH4lttBJKrcFg%3D" alt="07c48257-e1c7-43bd-8db9-96832d995116.png" loading="lazy"/></p>
<p>修改 <code>.husky/pre-commit</code> 文件</p>
<pre><code class="hljs">pnpm lint-staged
</code></pre>
<p>如图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c37669cac9a42e4becffef499ed473d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFuZUhl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763575172&amp;x-signature=TWuFzKf%2Fo0ymSf%2Fbos%2FkJesMioE%3D" alt="image.png" loading="lazy"/></p>
<p>综上，你就配置完了最新的eslint9+prettier+Husky！！
补：这里只开启了eslint插件，关闭了perttier插件</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS 也要支持 if 了 ！！！CSS if() 函数来了！]]></title>    <link>https://juejin.cn/post/7571758212472897587</link>    <guid>https://juejin.cn/post/7571758212472897587</guid>    <pubDate>2025-11-12T23:58:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571758212472897587" data-draft-id="7571758212472881203" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS 也要支持 if 了 ！！！CSS if() 函数来了！"/> <meta itemprop="keywords" content="前端,CSS"/> <meta itemprop="datePublished" content="2025-11-12T23:58:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS 也要支持 if 了 ！！！CSS if() 函数来了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T23:58:11.000Z" title="Wed Nov 12 2025 23:58:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">CSS 也要支持 if 了 ！！！CSS if() 函数来了！</h2>
<p>CSS <code>if()</code> 函数允许在纯 CSS 中基于条件为属性赋值，无需 JavaScript 或预处理器。该函数已在 Chrome 137 发布。</p>
<p>过去常用的做法包括通过 JavaScript 切换类名、使用预处理器 mixin 或编写大量媒体查询。<code>if()</code> 将条件逻辑引入 CSS，使写法更直接、性能稳定。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2025-11%2Fcss-if-function-has-arrived" target="_blank" title="https://catchadmin.com/post/2025-11/css-if-function-has-arrived" ref="nofollow noopener noreferrer">原文 CSS 也要支持 if 了 ！！！CSS if() 函数来了！</a></p>
<h3 data-id="heading-1">工作原理</h3>
<pre><code class="hljs language-css" lang="css">property: <span class="hljs-built_in">if</span>(condition-<span class="hljs-number">1</span>: value-<span class="hljs-number">1</span>; condition-<span class="hljs-number">2</span>: value-<span class="hljs-number">2</span>; condition-<span class="hljs-number">3</span>: value-<span class="hljs-number">3</span>; else: default-value);
</code></pre>
<p>函数按顺序检查条件并应用第一个匹配的值；若没有条件匹配，则使用 <code>else</code> 的值。这一语义与常见编程语言一致，但实现于纯 CSS。</p>
<h3 data-id="heading-2">if() 的三种能力</h3>
<h4 data-id="heading-3">样式查询（Style queries）</h4>
<p>使用 <code>style()</code> 可响应 CSS 自定义属性：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.card</span> {
  <span class="hljs-attr">--status</span>: <span class="hljs-built_in">attr</span>(data-status <span class="hljs-built_in">type</span>(&lt;custom-ident&gt;));

  <span class="hljs-attribute">border-color</span>: <span class="hljs-built_in">if</span>(<span class="hljs-built_in">style</span>(--status: pending): royalblue; style(<span class="hljs-attr">--status</span>: complete): seagreen; style(<span class="hljs-attr">--status</span>: error): crimson; else: gray);
}
</code></pre>
<p>一个 <code>data-status</code> 属性即可驱动对应样式，无需额外工具类。</p>
<h4 data-id="heading-4">媒体查询（Media queries）</h4>
<p>使用 <code>media()</code> 可以在属性内联定义响应式值，无需嵌套媒体查询块：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">h1</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-built_in">if</span>(<span class="hljs-built_in">media</span>(width &gt;= <span class="hljs-number">1200px</span>): <span class="hljs-number">3rem</span>; media(<span class="hljs-attribute">width</span> &gt;= <span class="hljs-number">768px</span>): <span class="hljs-number">2.5rem</span>; media(<span class="hljs-attribute">width</span> &gt;= <span class="hljs-number">480px</span>): <span class="hljs-number">2rem</span>; else: <span class="hljs-number">1.75rem</span>);
}
</code></pre>
<h4 data-id="heading-5">特性检测（Feature detection）</h4>
<p>使用 <code>supports()</code> 可在属性中直接进行特性检测，并提供明确回退：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.element</span> {
  <span class="hljs-attribute">border-color</span>: <span class="hljs-built_in">if</span>(<span class="hljs-built_in">supports</span>(color: <span class="hljs-built_in">lch</span>(<span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span>)): <span class="hljs-built_in">lch</span>(<span class="hljs-number">50%</span> <span class="hljs-number">100</span> <span class="hljs-number">150</span>) ; supports(<span class="hljs-attribute">color</span>: <span class="hljs-built_in">lab</span>(<span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span>)): <span class="hljs-built_in">lab</span>(<span class="hljs-number">50</span> <span class="hljs-number">100</span> -<span class="hljs-number">50</span>) ; else: <span class="hljs-built_in">rgb</span>(<span class="hljs-number">200</span>, <span class="hljs-number">100</span>, <span class="hljs-number">50</span>));
}
</code></pre>
<h3 data-id="heading-6">真实用例</h3>
<h4 data-id="heading-7">暗色模式示例</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">body</span> {
  <span class="hljs-attr">--theme</span>: <span class="hljs-string">'dark'</span>; <span class="hljs-comment">/* 通过 JavaScript 或用户偏好切换 */</span>

  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">if</span>(<span class="hljs-built_in">style</span>(--theme: <span class="hljs-string">'dark'</span>): <span class="hljs-number">#1a1a1a</span>; else: white);

  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">if</span>(<span class="hljs-built_in">style</span>(--theme: <span class="hljs-string">'dark'</span>): <span class="hljs-number">#e4e4e4</span>; else: <span class="hljs-number">#333</span>);
}
</code></pre>
<h4 data-id="heading-8">设计系统状态组件</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.alert</span> {
  <span class="hljs-attr">--type</span>: <span class="hljs-built_in">attr</span>(data-type <span class="hljs-built_in">type</span>(&lt;custom-ident&gt;));

  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">if</span>(<span class="hljs-built_in">style</span>(--type: success): <span class="hljs-number">#d4edda</span>; style(<span class="hljs-attr">--type</span>: warning): <span class="hljs-number">#fff3cd</span>; style(<span class="hljs-attr">--type</span>: danger): <span class="hljs-number">#f8d7da</span>; style(<span class="hljs-attr">--type</span>: info): <span class="hljs-number">#d1ecf1</span>; else: <span class="hljs-number">#f8f9fa</span>);

  <span class="hljs-attribute">border-left</span>: <span class="hljs-number">4px</span> solid <span class="hljs-built_in">if</span>(<span class="hljs-built_in">style</span>(--type: success): <span class="hljs-number">#28a745</span>; style(<span class="hljs-attr">--type</span>: warning): <span class="hljs-number">#ffc107</span>; style(<span class="hljs-attr">--type</span>: danger): <span class="hljs-number">#dc3545</span>; style(<span class="hljs-attr">--type</span>: info): <span class="hljs-number">#17a2b8</span>; else: <span class="hljs-number">#6c757d</span>);
}
</code></pre>
<h4 data-id="heading-9">容器尺寸示例（简化媒体查询）</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-built_in">if</span>(<span class="hljs-built_in">media</span>(width &gt;= <span class="hljs-number">1400px</span>): <span class="hljs-number">1320px</span>; media(<span class="hljs-attribute">width</span> &gt;= <span class="hljs-number">1200px</span>): <span class="hljs-number">1140px</span>; media(<span class="hljs-attribute">width</span> &gt;= <span class="hljs-number">992px</span>): <span class="hljs-number">960px</span>; media(<span class="hljs-attribute">width</span> &gt;= <span class="hljs-number">768px</span>): <span class="hljs-number">720px</span>; media(<span class="hljs-attribute">width</span> &gt;= <span class="hljs-number">576px</span>): <span class="hljs-number">540px</span>; else: <span class="hljs-number">100%</span>);

  <span class="hljs-attribute">padding-inline</span>: <span class="hljs-built_in">if</span>(<span class="hljs-built_in">media</span>(width &gt;= <span class="hljs-number">768px</span>): <span class="hljs-number">2rem</span>; else: <span class="hljs-number">1rem</span>);
}
</code></pre>
<h4 data-id="heading-10">与现代 CSS 特性结合</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.element</span> {
  <span class="hljs-comment">/* 搭配新的 light-dark() 函数 */</span>
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">if</span>(<span class="hljs-built_in">style</span>(--high-contrast: true): black; else: <span class="hljs-built_in">light-dark</span>(<span class="hljs-number">#333</span>, <span class="hljs-number">#e4e4e4</span>));

  <span class="hljs-comment">/* 搭配 CSS 自定义函数（@function） */</span>
  <span class="hljs-attribute">padding</span>: <span class="hljs-built_in">if</span>(<span class="hljs-built_in">style</span>(--spacing: loose): <span class="hljs-built_in">--spacing-function</span>(<span class="hljs-number">2</span>) ; style(<span class="hljs-attr">--spacing</span>: tight): <span class="hljs-built_in">--spacing-function</span>(<span class="hljs-number">0.5</span>) ; else: <span class="hljs-built_in">--spacing-function</span>(<span class="hljs-number">1</span>));
}
</code></pre>
<h3 data-id="heading-11">浏览器支持</h3>
<p>支持情况（截至 2025 年 8 月）：</p>
<ul>
<li>✅ Chrome/Edge：自 137 版起</li>
<li>✅ Chrome Android：自 139 版起</li>
<li>❌ Firefox：开发中</li>
<li>❌ Safari：在规划中</li>
<li>❌ Opera：尚未支持</li>
</ul>
<p>在尚未完全支持的环境中，可采用如下写法：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.button</span> {
  <span class="hljs-comment">/* 所有浏览器的回退 */</span>
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">1rem</span> <span class="hljs-number">2rem</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#007bff</span>;

  <span class="hljs-comment">/* 现代浏览器会自动覆盖 */</span>
  <span class="hljs-attribute">padding</span>: <span class="hljs-built_in">if</span>(<span class="hljs-built_in">style</span>(--size: small): <span class="hljs-number">0.5rem</span> <span class="hljs-number">1rem</span>; style(<span class="hljs-attr">--size</span>: large): <span class="hljs-number">1.5rem</span> <span class="hljs-number">3rem</span>; else: <span class="hljs-number">1rem</span> <span class="hljs-number">2rem</span>);

  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">if</span>(<span class="hljs-built_in">style</span>(--variant: primary): <span class="hljs-number">#007bff</span>; style(<span class="hljs-attr">--variant</span>: success): <span class="hljs-number">#28a745</span>; style(<span class="hljs-attr">--variant</span>: danger): <span class="hljs-number">#dc3545</span>; else: <span class="hljs-number">#6c757d</span>);
}
</code></pre>
<h3 data-id="heading-12">未来展望</h3>
<p>CSS 工作组已经在推进扩展能力：</p>
<ul>
<li>范围查询：<code>if(style(--value &gt; 100): ...)</code></li>
<li>逻辑运算符：<code>if(style(--a: true) and style(--b: false): ...)</code></li>
<li>容器查询集成：更强的上下文感知</li>
</ul>
<p>在使用前建议评估目标浏览器版本，并准备相应回退方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于魔改Nightingale源码浅谈go语言包模块管理]]></title>    <link>https://juejin.cn/post/7571672422690078772</link>    <guid>https://juejin.cn/post/7571672422690078772</guid>    <pubDate>2025-11-13T01:54:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571672422690078772" data-draft-id="7571672422690062388" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于魔改Nightingale源码浅谈go语言包模块管理"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-13T01:54:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="shark_chili"/> <meta itemprop="url" content="https://juejin.cn/user/2858385964801672"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于魔改Nightingale源码浅谈go语言包模块管理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2858385964801672/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    shark_chili
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T01:54:52.000Z" title="Thu Nov 13 2025 01:54:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">写在文章开头</h2>
<p>对于<code>java</code>开发而言，每一个项目完成之后都会打成一个<code>jar</code>包即中间层代码，所以可借由依赖包管理工具<code>maven</code>完成导入，而go语言没有中间字节码这样的一个过程，所以引入第三方依赖的方式都是通过源码，随着人们对于方案的不断探索，对于go语言的方式管理也别有了如下两种主流方案：</p>
<ol>
<li>go get引入</li>
<li>go vendor本地缓存</li>
</ol>
<p>而本文将结合笔者近期针对性的魔改Nightingale底层的es客户端的经历来演示一下go语言中包管理，希望对你有帮助。</p>
<p>我是 <strong>SharkChili</strong> ，Java 开发者，<strong>Java Guide</strong> 开源项目维护者。欢迎关注我的公众号：<strong>写代码的SharkChili</strong>，也欢迎您了解我的开源项目 mini-redis：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fshark-ctrl%2Fmini-redis" target="_blank" title="https://github.com/shark-ctrl/mini-redis" ref="nofollow noopener noreferrer">github.com/shark-ctrl/…</a>。</p>
<p>为方便与读者交流，现已创建读者群。关注下方公众号获取我的联系方式，添加时备注<strong>加群</strong>即可加入。</p>
<h2 data-id="heading-1">详解go modules的使用</h2>
<h3 data-id="heading-2">项目初始化</h3>
<p>我们通过<code>goland</code>创建一个名为<code>awesomeProject</code>项目，默认情况下<code>goland</code>为默认为我们生成一个<code>go.mod</code>文件，其内容标明：</p>
<ol>
<li>项目名称即awesomeProject</li>
<li><code>golang</code>的版本号1.23</li>
</ol>

<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">module</span> awesomeProject


go <span class="hljs-number">1.23</span>
</code></pre>
<p>此时，笔者项目的目录结构如下图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93cecb5e8376431dbccb386c1ca1405c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603692&amp;x-signature=UdMLV%2FA%2FaxnqZnpxUG5E5LYPKF4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">基于go get演示导入elastic</h3>
<p>因为<code>Nightingale</code>这个监控工具底层的es客户端不兼容es9，所以经过笔者调试发现其底层query表达式不正确，遂打算引入这个已被废弃的客户端调试一探究竟，按照go语言主流的包管理办法，通用管理步骤为：</p>
<ol>
<li>项目上传到git</li>
<li>针对该项目打好tag标签</li>
<li>通过go get指令获取指定tag的依赖包</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d4a2494e0b0453d9710b1f6612f97e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603692&amp;x-signature=7tetrfnus2Jt1cVYUXnzjSgUbT8%3D" alt="" loading="lazy"/></p>
<p>例如笔者想引入<code>https://github.com/olivere/elastic</code>这个第三方es客户端管理包，通过查看其go.mod对应模块名为：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">module</span> github.com/olivere/elastic/v7
</code></pre>
<p>查看其依赖包对应最新版本为<code>7.0.32</code>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ecedaa259284f81b3f21e2ed47af9ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603692&amp;x-signature=35bEhb8KGn1XgMx2NKhsIIPCw4I%3D" alt="" loading="lazy"/></p>
<p>对应的我们就可以忽略前两步骤，直接在本地项目中呼出终端执行<code>go get 模块名@版本号</code>对应笔者的请求就是：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">go <span class="hljs-keyword">get</span> github.com/olivere/elastic/<span class="hljs-symbol">v7@</span>v7<span class="hljs-number">.0</span><span class="hljs-number">.32</span>
</code></pre>
<p>随后我们就可以愉快的使用这个模块包了： <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82efa1cf68e3431680ced41c474cf04d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603692&amp;x-signature=x5T3nFmzJoO%2FH%2B%2FNFACK6t0oqX0%3D" alt="" loading="lazy"/></p>
<p>此时我们就可以正常的引用和管理这个模块了，相比于java，因为go语言模块的引入都是引入源代码，所以我们完全可以直接通过<code>IDE</code>修改源码：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b137502748ae4865815c7734864c89cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603692&amp;x-signature=Dt682SF4XfTvEPIa%2Bbzs9TjNHU4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">基于go vendor本地化三方依赖库</h3>
<p>当然上述方案仅仅支持允许联网的情况，对于封网开发的读者可以通过go mod vendor将这个依赖直接缓存到本地进行调测开发：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74d17b4fea374355be017cc37eec6fe2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603692&amp;x-signature=koH8byac%2Fhxoy4OWx46Vin%2Fcxms%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">基于魔改Nightingale底层es客户端源码演示go语言三方包管理</h2>
<h3 data-id="heading-6">魔改三方包通用步骤</h3>
<p>有了上述的基本概念，我们就来演示一个如果魔改已放弃维护的开源项目的通用套路，大体流程也很上述go get差不多，即基于github维度进行版本管理以及go get引入，只不过要修改第三方项目的源码，我们需要首先将项目fork到我们的仓库，以笔者本地修改的elastic为例，对应的执行步骤为：</p>
<ol>
<li>将停止维护的elastic客户端fork到个人仓库</li>
<li>clone本地</li>
<li>修改代码，并打tag(如果为了省事也可以用最新版，无需指明tag，笔者后文会介绍)提交到个人仓库</li>
<li>其他项目通过go get引入源项目地址并通过replace指向我们的项目</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62c9f60de097469481acd8be9614ef41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603692&amp;x-signature=1y7SkmaPmVVdYyey5Z%2FlawxP%2Bzk%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">案例说明</h3>
<p>基于这个实践结合笔者近期接触到的一个这里日志告警工具Nightingale，笔者在接入es9数据源时发现，查询时返回了es服务端语法错误：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa8c6e6709af4d539c740da0c3f346e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603692&amp;x-signature=mflcizhuOnkU%2FVgUa%2FXBhyN%2BAK8%3D" alt="" loading="lazy"/></p>
<p>经过笔者的调测Nightingale底层的es客户端发现，其底层elastic生成的范围查询时间采用了from、to语法，最新版的es9并不支持这种格式，需改为gte和lte：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/efd93ad08fe74d6ebd5e185efb13ebce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603692&amp;x-signature=K1fKCYCn4M88nYbcrXTvrHotKQ4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">魔改适配步骤详解</h3>
<p>所以为了做到es9数据源适配，笔者就需要按照上述步骤的说法：</p>
<ol>
<li>fork已经不再维护的elastic</li>
<li>修改范围子查询源码</li>
<li>提交个人仓库</li>
<li>Nightingale源码使用replace将es客户端改为自己魔改后的版本</li>
</ol>
<p>针对fork和魔改操作笔者就不多做演示，这里笔者直接给出修改后的代码：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f074b1a83a564daa9052ae7c8ac76974~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603692&amp;x-signature=LVXJNBrpdXRdIH6DqhPtv8AB4iA%3D" alt="" loading="lazy"/></p>
<p>当然笔者这里为了省事直接通过<code>go get module name@branch</code>获取最新版本，以笔者为例对应的指令为<code>go get github.com/shark-ctrl/elastic/v7@release-branch.v7</code>：</p>
<p>最终输出结果如下：</p>
<pre><code class="hljs language-bash" lang="bash">go: downloading github.com/shark-ctrl/elastic/v7 v7.0.0-20251112171420-808d8bfca650
go: added github.com/shark-ctrl/elastic/v7 v7.0.0-20251112171420-808d8bfca650
</code></pre>
<p>后续使用使用到魔改的项目直接采用replace修改引用的指向：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb36c1a461f64cd3921de899edb1a1df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603692&amp;x-signature=6D0XW%2BFqykx%2BpX1PVLifPWY18Cc%3D" alt="" loading="lazy"/></p>
<p>可以看到对应的es客户端就用到了笔者的魔改后的版本：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e8935a99029406eba3c0581b1f09f96~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603692&amp;x-signature=dfzT8g9e4MSzhxNaWEhfxZSTmLA%3D" alt="" loading="lazy"/></p>
<p>对应的es9的数据源查询也是可以了：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a58c8456c9b541a8862946b8acb3ccbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603692&amp;x-signature=ZFgu%2F04kXBmNZ3oJoxWQpvMKEcU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">小结</h2>
<p>相比于java源码的改造，go语言的特性使得采用go get指令和replace魔改开源工具更加从容且直观，本文这次针对Nightingale的数据源适配本质就是利用了go get对于三方工具的统一维护结合fork修改和Go mod replace完成底层数据源的适配。</p>
<p>需要补充说明一件事，就在笔者完成这个数据源适配且准备在项目组调测时，Nightingale的作者似乎也在近期完成了这个适配，所以本次的魔改工作就当是对于读者一次学习的普及吧： <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0ca0c98a31443578856699c835d8135~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603692&amp;x-signature=6ZdtWmnDhkNvhFJgAw1ST8k4dMM%3D" alt="" loading="lazy"/></p>
<p>我是 <strong>SharkChili</strong> ，Java 开发者，<strong>Java Guide</strong> 开源项目维护者。欢迎关注我的公众号：<strong>写代码的SharkChili</strong>，也欢迎您了解我的开源项目 mini-redis：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fshark-ctrl%2Fmini-redis" target="_blank" title="https://github.com/shark-ctrl/mini-redis" ref="nofollow noopener noreferrer">github.com/shark-ctrl/…</a>。</p>
<p>为方便与读者交流，现已创建读者群。关注下方公众号获取我的联系方式，添加时备注<strong>加群</strong>即可加入。</p>
<h2 data-id="heading-10">参考</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Felastic%2Fgo-elasticsearch%2Ftree%2Fmain" target="_blank" title="https://github.com/elastic/go-elasticsearch/tree/main" ref="nofollow noopener noreferrer">github.com/elastic/go-…</a> go mod 和 go vendor 使用与区别:<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F374044583" target="_blank" title="https://zhuanlan.zhihu.com/p/374044583" ref="nofollow noopener noreferrer">zhuanlan.zhihu.com/p/374044583</a> Gomodvendor使用教程与依赖管理技巧:<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.17golang.com%2Farticle%2F245274.html" target="_blank" title="https://www.17golang.com/article/245274.html" ref="nofollow noopener noreferrer">www.17golang.com/article/245…</a></p>
<p>深入理解 Go Modules 的 go.mod 与 go.sum :<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fdeveloper%2Farticle%2F2020911" target="_blank" title="https://cloud.tencent.com/developer/article/2020911" ref="nofollow noopener noreferrer">cloud.tencent.com/developer/a…</a></p>
<p>使用go module导入本地包:<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F109828249" target="_blank" title="https://zhuanlan.zhihu.com/p/109828249" ref="nofollow noopener noreferrer">zhuanlan.zhihu.com/p/109828249</a></p>
<p>Golang实战：从零开始构建并发布自己的Go语言库到GitHub及Go Module管理:<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.oryoy.com%2Fnews%2Fgolang-shi-zhan-cong-ling-kai-shi-gou-jian-bing-fa-bu-zi-ji-de-go-yu-yan-ku-dao-github-ji-go-module.html" target="_blank" title="https://www.oryoy.com/news/golang-shi-zhan-cong-ling-kai-shi-gou-jian-bing-fa-bu-zi-ji-de-go-yu-yan-ku-dao-github-ji-go-module.html" ref="nofollow noopener noreferrer">www.oryoy.com/news/golang…</a></p>
<p>Go mod replace 使用:<a href="https://link.juejin.cn?target=https%3A%2F%2Fsegmentfault.com%2Fa%2F1190000040179648" target="_blank" title="https://segmentfault.com/a/1190000040179648" ref="nofollow noopener noreferrer">segmentfault.com/a/119000004…</a></p>
<p>本文使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarkdown.com.cn" target="_blank" title="https://markdown.com.cn" ref="nofollow noopener noreferrer">markdown.com.cn</a> 排版</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用户中心微服务设计指南：从功能到非功能的全维度落地]]></title>    <link>https://juejin.cn/post/7571729676344262719</link>    <guid>https://juejin.cn/post/7571729676344262719</guid>    <pubDate>2025-11-13T02:55:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571729676344262719" data-draft-id="7571729676344246335" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用户中心微服务设计指南：从功能到非功能的全维度落地"/> <meta itemprop="keywords" content="后端,微服务"/> <meta itemprop="datePublished" content="2025-11-13T02:55:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="回家路上绕了弯"/> <meta itemprop="url" content="https://juejin.cn/user/536217404587134"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用户中心微服务设计指南：从功能到非功能的全维度落地
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/536217404587134/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    回家路上绕了弯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T02:55:39.000Z" title="Thu Nov 13 2025 02:55:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">用户中心微服务设计指南：从功能到非功能的全维度落地</h2>
<p>在微服务架构中，用户中心是 “地基级” 服务 —— 所有业务模块（订单、支付、内容）都依赖其提供的用户认证、权限校验、信息查询能力。但很多团队设计时容易陷入 “只做用户 CRUD” 的误区，忽略权限控制、审计日志、高可用等非功能性需求，导致后期业务扩张时重构成本极高。</p>
<p>本文将从 “业务价值→架构设计→功能实现→非功能保障” 四个层面，完整讲解用户中心微服务的设计思路，尤其聚焦权限、审计、安全等关键非功能点，提供可直接落地的方案。</p>
<h3 data-id="heading-1">一、先明确：用户中心微服务的核心定位与边界</h3>
<p>设计前必须划清 “职责范围”，避免服务膨胀为 “万能工具”。用户中心的核心定位是 “<strong>统一的用户身份与权限管理入口</strong>”，具体边界如下：</p>





























<table><thead><tr><th>核心职责（必做）</th><th>非核心职责（不做 / 外包）</th></tr></thead><tbody><tr><td>1. 用户基础信息管理（注册、登录、资料 CRUD）</td><td>1. 具体业务数据存储（如用户订单、积分）</td></tr><tr><td>2. 认证授权（令牌生成、权限校验）</td><td>2. 业务逻辑处理（如用户等级计算）</td></tr><tr><td>3. 权限控制（角色、功能 / 数据权限管理）</td><td>3. 第三方业务集成（如用户营销活动）</td></tr><tr><td>4. 审计日志（用户操作、权限变更记录）</td><td>4. 大规模数据分析（如用户行为画像）</td></tr><tr><td>5. 第三方登录集成（微信、QQ、OAuth2）</td><td/></tr></tbody></table>
<p><strong>举例</strong>：用户积分属于业务数据，应存放在 “积分服务”，用户中心只需提供 “用户 ID” 作为关联标识，无需存储积分数值 —— 这是 “单一职责” 原则的核心体现。</p>
<h3 data-id="heading-2">二、架构设计：模块划分与技术选型</h3>
<p>基于核心职责，将用户中心拆分为 “松耦合模块”，每个模块独立部署、迭代，同时选择适配高并发、高安全的技术栈。</p>
<h4 data-id="heading-3">1. 核心模块划分（分层架构）</h4>
<p>采用 “接入层→业务层→数据层” 三层架构，每层拆分为细分模块：</p>
<pre><code class="hljs language-bash" lang="bash">用户中心微服务
├─ 接入层（API Gateway）
│  ├─ 接口鉴权模块（统一验证令牌、防刷）
│  ├─ 接口版本控制（如/v1/user/info）
│  └─ 流量控制模块（限流、熔断、降级）
├─ 业务层（核心功能）
│  ├─ 用户管理模块（注册、登录、资料CRUD、密码重置）
│  ├─ 认证授权模块（JWT/OAuth2令牌、会话管理）
│  ├─ 权限控制模块（角色管理、功能权限、数据权限）
│  ├─ 审计日志模块（操作记录、日志查询、告警）
│  └─ 第三方集成模块（微信/QQ登录、短信/邮箱验证）
└─ 数据层（存储）
   ├─ 关系型数据库（MySQL：用户、角色、权限表）
   ├─ 缓存（Redis：会话、权限缓存、登录验证码）
   ├─ 日志存储（Elasticsearch：审计日志，支持全文检索）
   └─ 消息队列（Kafka：用户数据变更事件，同步到其他服务）
</code></pre>
<h4 data-id="heading-4">2. 技术栈选型（适配非功能性需求）</h4>
<p>技术选型需优先满足 “安全、高可用、可扩展”，具体如下：</p>


















































<table><thead><tr><th>技术类别</th><th>推荐选型</th><th>选型理由</th></tr></thead><tbody><tr><td>开发语言</td><td>Java（Spring Cloud/Spring Boot）</td><td>生态完善，安全组件丰富（Spring Security），适合企业级权限控制</td></tr><tr><td>关系型数据库</td><td>MySQL（主从架构 + 分库分表）</td><td>支持事务，适合存储用户、角色等强一致性数据；用户量大时用 ShardingSphere 分表</td></tr><tr><td>缓存</td><td>Redis Cluster</td><td>高性能，支持分布式锁（用于并发登录控制），适合存储会话和权限缓存</td></tr><tr><td>认证协议</td><td>JWT + OAuth2.0（授权码模式）</td><td>JWT 无状态便于扩展，OAuth2.0 支持第三方授权（如微信登录）</td></tr><tr><td>权限框架</td><td>Spring Security + Spring Cloud Security</td><td>与 Spring 生态无缝集成，支持 RBAC 权限模型，可自定义权限校验逻辑</td></tr><tr><td>日志存储</td><td>Elasticsearch + Kibana</td><td>支持海量日志存储和全文检索，便于审计日志的多维度查询（如按用户 ID、操作类型）</td></tr><tr><td>消息队列</td><td>Kafka</td><td>高吞吐，确保用户数据变更事件（如用户注册、权限修改）可靠同步到其他服务</td></tr><tr><td>API 网关</td><td>Spring Cloud Gateway</td><td>轻量、高性能，支持动态路由、限流、鉴权，统一接入入口</td></tr></tbody></table>
<h3 data-id="heading-5">三、核心功能设计：从 “能用” 到 “好用”</h3>
<h4 data-id="heading-6">1. 用户管理模块（基础功能）</h4>
<p>核心是 “安全的用户生命周期管理”，重点解决注册登录的安全性与便捷性：</p>
<h5 data-id="heading-7">（1）用户注册流程（防恶意注册）</h5>
<pre><code class="hljs">用户提交手机号/邮箱 → 发送验证码（Redis缓存，5分钟过期） → 验证验证码 → 密码加密存储 → 生成用户ID → 发送“用户注册事件”到Kafka
</code></pre>
<ul>
<li><strong>密码加密</strong>：用 BCrypt 算法（自动加盐，不可逆），避免明文 / MD5 存储（Spring Security 默认支持 BCrypt）；</li>
</ul>

<ul>
<li><strong>防恶意注册</strong>：同一 IP / 设备 1 小时内最多发送 5 次验证码（Redis 记录次数），验证码绑定设备 ID。</li>
</ul>
<h5 data-id="heading-8">（2）用户登录流程（支持多端登录）</h5>
<pre><code class="hljs">用户提交账号密码 → 校验账号密码 → 生成JWT令牌（包含用户ID、角色、过期时间） → Redis存储会话（用户ID→设备列表，支持踢下线） → 返回令牌
</code></pre>
<ul>
<li><strong>JWT 令牌结构</strong>：</li>
</ul>
<p>Header（算法）+ Payload（用户 ID:123, 角色:admin, exp:1688888888）+ Signature（密钥签名，防止篡改）；</p>
<ul>
<li><strong>多端登录控制</strong>：Redis 存储user:session:{userID}为 Hash 结构，key = 设备 ID，value=JWT 令牌，支持 “单端登录”（新登录踢掉旧登录）或 “多端登录”（最多 3 台设备）。</li>
</ul>
<h4 data-id="heading-9">2. 认证授权模块（核心非功能）</h4>
<p>解决 “谁能访问什么资源” 的问题，基于 OAuth2.0 + JWT 实现：</p>
<h5 data-id="heading-10">（1）认证流程（统一鉴权）</h5>
<p>所有业务服务的请求需经过 API 网关，鉴权流程如下：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 客户端携带JWT令牌请求API网关；
<span class="hljs-bullet">2.</span> 网关验证令牌签名与过期时间（无需查库，JWT无状态）；
<span class="hljs-bullet">3.</span> 令牌有效则解析用户信息（用户ID、角色），转发到对应微服务；
<span class="hljs-bullet">4.</span> 令牌无效/过期则返回401未授权。
</code></pre>
<ul>
<li><strong>令牌刷新</strong>：JWT 设置短期过期（如 2 小时），同时生成 “刷新令牌”（过期时间 7 天，存储在 Redis），令牌过期时用刷新令牌重新获取 JWT，避免频繁登录。</li>
</ul>
<h5 data-id="heading-11">（2）第三方登录集成（如微信登录）</h5>
<p>基于 OAuth2.0 授权码模式，流程如下：</p>
<pre><code class="hljs">用户点击微信登录 → 跳转微信授权页 → 用户授权后获取授权码 → 用授权码换微信OpenID → 查用户中心是否绑定OpenID（已绑定则直接登录，未绑定则引导绑定手机号） → 生成JWT令牌
</code></pre>
<h4 data-id="heading-12">3. 权限控制模块（重点非功能）</h4>
<p>权限控制是用户中心的 “灵魂”，需同时支持 “功能权限”（能不能操作某个按钮）和 “数据权限”（能不能看某类数据），推荐采用<strong>RBAC（基于角色的访问控制）模型</strong>。</p>
<h5 data-id="heading-13">（1）RBAC 模型设计（表结构）</h5>
<p>核心表结构如下，通过关联实现 “用户 - 角色 - 权限” 的灵活映射：</p>



































<table><thead><tr><th>表名</th><th>核心字段</th><th>作用</th></tr></thead><tbody><tr><td>sys_user</td><td>user_id, username, password（BCrypt 加密）, status（启用 / 禁用）</td><td>存储用户基础信息</td></tr><tr><td>sys_role</td><td>role_id, role_name, role_code（如 admin、user）, description</td><td>存储角色（如管理员、普通用户、运营）</td></tr><tr><td>sys_permission</td><td>perm_id, perm_name, perm_type（menu/button/api）, perm_url, perm_method</td><td>存储权限（如 “用户删除” 按钮、“/api/user/delete” 接口）</td></tr><tr><td>sys_user_role</td><td>id, user_id, role_id</td><td>用户与角色的多对多关联</td></tr><tr><td>sys_role_permission</td><td>id, role_id, perm_id</td><td>角色与权限的多对多关联</td></tr></tbody></table>
<h5 data-id="heading-14">（2）功能权限校验（接口级控制）</h5>
<ul>
<li><strong>权限缓存</strong>：用户登录时，从数据库查询 “用户→角色→权限”，将权限列表（如/api/user/delete、/api/role/list）缓存到 Redis，Key=user:perm:{userID}，过期时间与 JWT 一致；</li>
</ul>

<ul>
<li><strong>接口校验</strong>：在需要权限的接口上添加注解（如@PreAuthorize("hasPermission('/api/user/delete', 'api')")），Spring Security 会自动从 Redis 获取用户权限并校验，无权限则返回 403。</li>
</ul>
<h5 data-id="heading-15">（3）数据权限控制（数据级隔离）</h5>
<p>解决 “同角色不同用户看不同数据” 的问题（如运营 A 只能看北京地区用户，运营 B 只能看上海地区）：</p>
<ul>
<li><strong>设计思路</strong>：在用户表 / 角色表中添加 “数据权限范围” 字段（如data_scope: beijing），查询数据时动态拼接条件（where region = #{dataScope}）；</li>
</ul>

<ul>
<li><strong>实现方式</strong>：用 MyBatis 插件拦截 SQL，根据当前用户的data_scope自动添加数据权限条件，无需在每个 SQL 中手动写条件。</li>
</ul>
<h4 data-id="heading-16">4. 审计日志模块（关键非功能）</h4>
<p>审计日志是 “安全追溯” 的核心，需记录 “谁在什么时间做了什么操作，结果如何”，满足合规要求（如金融行业的审计需求）。</p>
<h5 data-id="heading-17">（1）日志内容设计（必含字段）</h5>
<p>每条审计日志需包含以下字段，确保可追溯：</p>






































































<table><thead><tr><th>字段名</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td>log_id</td><td>字符串</td><td>唯一 ID（UUID）</td></tr><tr><td>user_id</td><td>字符串</td><td>操作人 ID（匿名操作填 “anonymous”）</td></tr><tr><td>user_name</td><td>字符串</td><td>操作人姓名（便于人工排查）</td></tr><tr><td>operation_type</td><td>枚举</td><td>操作类型（如 USER_CREATE、PERMISSION_UPDATE、LOGIN_SUCCESS、LOGIN_FAILED）</td></tr><tr><td>resource_type</td><td>枚举</td><td>操作资源（如 USER、ROLE、PERMISSION、LOGIN）</td></tr><tr><td>resource_id</td><td>字符串</td><td>操作资源 ID（如用户 ID、角色 ID）</td></tr><tr><td>operation_detail</td><td>字符串</td><td>操作详情（JSON 格式，如{"old_password":"<em><strong>","new_password":"</strong></em>"}，敏感信息脱敏）</td></tr><tr><td>client_ip</td><td>字符串</td><td>操作 IP 地址（便于定位恶意操作）</td></tr><tr><td>client_device</td><td>字符串</td><td>操作设备（如 “Chrome/Windows 10”，解析 User-Agent）</td></tr><tr><td>operation_time</td><td>时间戳</td><td>操作时间（毫秒级）</td></tr><tr><td>result</td><td>枚举</td><td>操作结果（SUCCESS/FAIL）</td></tr><tr><td>fail_reason</td><td>字符串</td><td>失败原因（如 “密码错误”“权限不足”，失败时必填）</td></tr></tbody></table>
<h5 data-id="heading-18">（2）日志记录流程（异步无感知）</h5>
<p>通过 “AOP 切面” 自动记录日志，不侵入业务代码：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-number">1.</span> 定义日志注解（如<span class="hljs-meta">@AuditLog(operationType = <span class="hljs-string">"USER_UPDATE"</span>, resourceType = <span class="hljs-string">"USER"</span>)</span>）；
<span class="hljs-number">2.</span> 在需要记录日志的接口方法上添加注解；
<span class="hljs-number">3.</span> 编写AOP切面，拦截带有<span class="hljs-meta">@AuditLog</span>的方法，自动采集日志字段（如从JWT获取user_id，从请求获取IP）；
<span class="hljs-number">4.</span> 异步将日志发送到Kafka，由消费者写入Elasticsearch；
<span class="hljs-number">5.</span> 提供日志查询接口（支持按user_id、operation_type、时间范围查询），前端用Kibana或自定义页面展示。
</code></pre>
<ul>
<li><strong>敏感信息脱敏</strong>：切面中对密码、手机号等敏感信息进行脱敏（如手机号显示为 “138****5678”），避免日志泄露隐私。</li>
</ul>
<h3 data-id="heading-19">四、非功能性需求落地：从 “能用” 到 “可靠”</h3>
<p>用户中心的非功能性需求直接决定服务的 “稳定性与安全性”，需重点设计：</p>
<h4 data-id="heading-20">1. 安全性（防攻击、防泄露）</h4>
<h5 data-id="heading-21">（1）数据安全</h5>
<ul>
<li><strong>传输安全</strong>：所有接口强制使用 HTTPS，防止数据被抓包窃取；</li>
</ul>

<ul>
<li><strong>存储安全</strong>：密码用 BCrypt 加密，敏感信息（如手机号、邮箱）用 AES 加密存储，密钥存在配置中心（如 Nacos）；</li>
</ul>

<ul>
<li><strong>脱敏展示</strong>：接口返回用户信息时，对敏感字段脱敏（如{"phone":"138<strong><strong>5678","email":"123</strong></strong>@qq.com"}）。</li>
</ul>
<h5 data-id="heading-22">（2）接口安全</h5>
<ul>
<li><strong>防 SQL 注入</strong>：用 MyBatis 参数绑定（#{}），避免拼接 SQL；</li>
</ul>

<ul>
<li><strong>防 XSS 攻击</strong>：API 网关层用过滤器过滤请求参数中的脚本标签（如
</li></ul>

<ul>
<li><strong>防 CSRF 攻击</strong>：前后端分离场景下，用 JWT 令牌的iss（签发者）字段校验来源，或在前端存储 CSRF 令牌；</li>
</ul>

<ul>
<li><strong>接口防刷</strong>：API 网关层对高频接口（如登录、验证码发送）限流，同一 IP / 用户 ID 每分钟最多请求 10 次（Redis 记录请求次数）。</li>
</ul>
<h5 data-id="heading-23">（3）权限安全</h5>
<ul>
<li><strong>最小权限原则</strong>：默认用户只分配 “必要权限”（如普通用户无角色管理权限）；</li>
</ul>

<ul>
<li><strong>权限变更审计</strong>：角色、权限的新增 / 修改 / 删除必须记录审计日志，支持追溯；</li>
</ul>

<ul>
<li><strong>会话安全</strong>：用户注销时删除 Redis 中的会话和 JWT 黑名单（Redis 存储已注销的 JWT，有效期与 JWT 过期时间一致），防止令牌复用。</li>
</ul>
<h4 data-id="heading-24">2. 高可用性（避免单点故障）</h4>
<h5 data-id="heading-25">（1）服务高可用</h5>
<ul>
<li><strong>集群部署</strong>：用户中心服务部署多个实例（至少 3 个），注册到 Nacos/Eureka，API 网关自动负载均衡；</li>
</ul>

<ul>
<li><strong>熔断降级</strong>：用 Sentinel 对依赖的服务（如短信服务、第三方登录接口）熔断，避免依赖故障导致用户中心不可用（如短信服务挂了，临时允许验证码跳过）；</li>
</ul>

<ul>
<li><strong>容灾备份</strong>：MySQL 采用主从架构，主库故障时自动切换到从库；Redis 用 Cluster 架构，至少 3 主 3 从，避免缓存单点故障。</li>
</ul>
<h5 data-id="heading-26">（2）数据高可用</h5>
<ul>
<li><strong>数据库备份</strong>：MySQL 每日全量备份 + 增量备份（binlog），确保数据可恢复；</li>
</ul>

<ul>
<li><strong>缓存穿透防护</strong>：对不存在的用户 ID 请求（如/api/user/info?userID=99999），缓存空结果（10 分钟过期），避免穿透到数据库；</li>
</ul>

<ul>
<li><strong>缓存雪崩防护</strong>：Redis 缓存设置随机过期时间（如 JWT 缓存 2 小时 ±5 分钟），避免同一时间大量缓存失效导致数据库压力骤增。</li>
</ul>
<h4 data-id="heading-27">3. 可扩展性（适配业务增长）</h4>
<h5 data-id="heading-28">（1）水平扩展</h5>
<ul>
<li><strong>无状态设计</strong>：用户中心服务不存储本地会话（会话存在 Redis），新增实例即可扩展性能；</li>
</ul>

<ul>
<li><strong>分库分表</strong>：用户量超千万时，用 ShardingSphere 按user_id哈希分表（如分 16 张表），避免单表数据量过大导致查询缓慢。</li>
</ul>
<h5 data-id="heading-29">（2）功能扩展</h5>
<ul>
<li><strong>多租户支持</strong>：在用户表、角色表中添加tenant_id字段，隔离不同租户的用户数据，适配 SaaS 平台场景；</li>
</ul>

<ul>
<li><strong>自定义权限扩展</strong>：支持业务方通过 “权限注册接口” 添加自定义权限（如订单服务的 “订单查看权限”），用户中心统一管理；</li>
</ul>

<ul>
<li><strong>第三方登录扩展</strong>：设计 “第三方登录适配器”，新增登录渠道（如 Apple 登录、Google 登录）时，只需实现适配器接口，无需修改核心逻辑。</li>
</ul>
<h4 data-id="heading-30">4. 性能优化（低延迟、高吞吐）</h4>
<ul>
<li><strong>缓存优化</strong>：用户基础信息、角色权限列表缓存到 Redis，查询接口从缓存获取，缓存命中率达 95% 以上；</li>
</ul>

<ul>
<li><strong>异步处理</strong>：非实时操作（如发送注册成功短信、同步用户数据到其他服务）用 Kafka 异步处理，减少接口响应时间；</li>
</ul>

<ul>
<li><strong>SQL 优化</strong>：用户、角色、权限表添加索引（如user_id、role_id、perm_url），避免全表扫描；复杂权限查询用 “预计算 + 缓存”，减少关联查询。</li>
</ul>
<h3 data-id="heading-31">五、实践落地建议：避坑与最佳实践</h3>
<ol>
<li><strong>先做 MVP 版本</strong>：初期优先实现 “用户注册登录 + 基础 RBAC 权限 + 简单审计日志”，避免过度设计；</li>
</ol>

<ol start="2">
<li><strong>接口规范统一</strong>：采用 RESTful 风格，接口路径、参数命名、返回格式统一（如返回{"code":200,"msg":"success","data":{}}），方便其他服务集成；</li>
</ol>

<ol start="3">
<li><strong>监控告警到位</strong>：部署 Prometheus+Grafana 监控服务 CPU、内存、接口响应时间，设置告警阈值（如接口响应时间 &gt; 500ms 告警）；对异常登录（如异地登录、连续失败 5 次）发送短信告警给用户；</li>
</ol>

<ol start="4">
<li><strong>灰度发布</strong>：新增功能（如第三方登录）采用灰度发布，先对 10% 用户开放，验证无问题后全量上线；</li>
</ol>

<ol start="5">
<li><strong>文档完善</strong>：编写 API 文档（用 Swagger/knife4j）和运维文档，说明部署步骤、扩容方案、故障处理流程，方便团队协作。</li>
</ol>
<h3 data-id="heading-32">总结</h3>
<p>用户中心微服务的设计核心是 “<strong>以用户为中心，以安全为底线，以扩展为目标</strong>”：</p>
<ul>
<li>功能上，需覆盖 “用户生命周期管理 + 认证授权 + 权限控制 + 审计日志”，满足业务与合规需求；</li>
</ul>

<ul>
<li>非功能上，需重点保障 “安全性、高可用性、可扩展性”，避免成为微服务架构的瓶颈；</li>
</ul>

<ul>
<li>落地时，需循序渐进，先实现核心功能，再逐步优化非功能点，同时注重文档与监控，降低维护成本。</li>
</ul>
<p>最终，一个优秀的用户中心不仅能支撑当前业务，还能随业务增长灵活扩展，成为微服务架构中稳定可靠的 “地基”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【vue3】这些不常用的API，却很实用]]></title>    <link>https://juejin.cn/post/7571726099689373715</link>    <guid>https://juejin.cn/post/7571726099689373715</guid>    <pubDate>2025-11-13T02:32:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571726099689373715" data-draft-id="7571731181197787172" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【vue3】这些不常用的API，却很实用"/> <meta itemprop="keywords" content="前端,Vue.js,面试"/> <meta itemprop="datePublished" content="2025-11-13T02:32:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="珑墨"/> <meta itemprop="url" content="https://juejin.cn/user/3069492194710797"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【vue3】这些不常用的API，却很实用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3069492194710797/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    珑墨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T02:32:17.000Z" title="Thu Nov 13 2025 02:32:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.7;font-weight:400;font-size:16px;overflow-x:hidden;color:#2c3e50;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;font-weight:600;margin-top:35px;margin-bottom:8px;padding-bottom:5px}.markdown-body h1 :before,.markdown-body h2 :before,.markdown-body h3 :before,.markdown-body h4 :before,.markdown-body h5 :before,.markdown-body h6 :before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:8px;margin-top:50px;font-size:24px;border-bottom:1px solid #eaecef}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #eaecef;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;font-weight:400;background-color:rgba(27,31,35,.05);color:#476582;margin:0;font-size:.85em;border-radius:3px;font-size:.87em;padding:.165em .5em}.markdown-body code,.markdown-body pre{font-family:source-code-pro,Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.6;padding:20px 24px;background-color:#282c34;border-radius:6px}.markdown-body pre&gt;code{font-size:14px;padding:0;margin:0;word-break:normal;display:block;overflow-x:auto;color:#fff}.markdown-body a{text-decoration:none;color:#3eaf7c;font-weight:500}.markdown-body a:active,.markdown-body a:hover{color:#42b983;border-bottom:1px solid #42b983}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;margin:16px 0;border-collapse:collapse}.markdown-body thead{background:#f6f6f6;background:#3eaf7c;color:#000;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f6f8fa}.markdown-body td,.markdown-body th{border:1px solid #dfe2e5;padding:10px 16px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{font-size:14px;padding:6px 23px;margin:22px 0;border-left:6px solid #42b983;background-color:#f3f5f7;font-weight:400}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body p,.markdown-body ul{line-height:1.7}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="base16/tomorrow-night">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近在重构一个老移动端项目，用Vue3重写的过程中，发现了一些平时不太注意的API，但用起来真的很香。今天分享几个我觉得特别实用的，希望能帮到正在学习Vue3的jym。</p>
<h2 data-id="heading-0">1. shallowRef 和 shallowReactive - ‘大数据’性能提升</h2>
<p>先说个场景：你有一个很大的对象，里面嵌套了很多层数据，但你只需要最外层的变化触发更新。这时候用 <code>ref</code> 或 <code>reactive</code> 就会把所有嵌套都变成响应式的，性能开销很大。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { ref, shallowRef, reactive, shallowReactive, triggerRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 普通 ref - 深度响应式</span>
<span class="hljs-keyword">const</span> deepData = <span class="hljs-title function_">ref</span>({
  <span class="hljs-attr">user</span>: {
    <span class="hljs-attr">profile</span>: {
      <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,
      <span class="hljs-attr">address</span>: {
        <span class="hljs-attr">city</span>: <span class="hljs-string">'北京'</span>,
        <span class="hljs-comment">// ... 还有很多层</span>
      }
    }
  }
})

<span class="hljs-comment">// shallowRef - 浅层响应式，只监听第一层</span>
<span class="hljs-keyword">const</span> shallowData = <span class="hljs-title function_">shallowRef</span>({
  <span class="hljs-attr">user</span>: {
    <span class="hljs-attr">profile</span>: {
      <span class="hljs-attr">name</span>: <span class="hljs-string">'李四'</span>
    }
  }
})

<span class="hljs-comment">// 只有直接替换整个对象才会触发更新</span>
shallowData.<span class="hljs-property">value</span> = { <span class="hljs-attr">user</span>: { <span class="hljs-attr">profile</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'王五'</span> } } } <span class="hljs-comment">// ✅ 会触发更新</span>

<span class="hljs-comment">// 修改内部属性不会触发更新</span>
shallowData.<span class="hljs-property">value</span>.<span class="hljs-property">user</span>.<span class="hljs-property">profile</span>.<span class="hljs-property">name</span> = <span class="hljs-string">'赵六'</span> <span class="hljs-comment">// ❌ 不会触发更新</span>

<span class="hljs-comment">// 但可以用 triggerRef 手动触发更新</span>
shallowData.<span class="hljs-property">value</span>.<span class="hljs-property">user</span>.<span class="hljs-property">profile</span>.<span class="hljs-property">name</span> = <span class="hljs-string">'赵六'</span>
<span class="hljs-title function_">triggerRef</span>(shallowData) <span class="hljs-comment">// ✅ 手动触发更新，视图会刷新</span>

<span class="hljs-comment">// shallowReactive - 浅层响应式的 reactive 版本</span>
<span class="hljs-keyword">const</span> shallowState = <span class="hljs-title function_">shallowReactive</span>({
  <span class="hljs-attr">user</span>: {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">20</span>
  }
})

shallowState.<span class="hljs-property">user</span> = { <span class="hljs-attr">name</span>: <span class="hljs-string">'李四'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> } <span class="hljs-comment">// ✅ 会触发更新</span>
shallowState.<span class="hljs-property">user</span>.<span class="hljs-property">name</span> = <span class="hljs-string">'王五'</span> <span class="hljs-comment">// ❌ 不会触发更新</span>
</code></pre>
<p>我在处理表格数据的时候经常用这个，特别是那种几千行的数据，用 <code>shallowRef</code> 能明显感觉到性能提升。<code>shallowReactive</code> 和 <code>shallowRef</code> 的区别在于，前者直接返回响应式对象，后者返回的是包装后的 ref。</p>
<p><strong><code>triggerRef</code> 的使用场景</strong>：当你使用 <code>shallowRef</code> 时，如果确实需要修改嵌套属性并触发更新，但又不想替换整个对象（可能很耗性能），就可以先修改属性，然后调用 <code>triggerRef</code> 手动触发更新。这样既享受了浅层响应式的性能优势，又能在需要时精确控制更新时机。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 实际应用：批量修改后统一触发更新</span>
<span class="hljs-keyword">const</span> tableData = <span class="hljs-title function_">shallowRef</span>([
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">status</span>: <span class="hljs-string">'active'</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'李四'</span>, <span class="hljs-attr">status</span>: <span class="hljs-string">'active'</span> },
  <span class="hljs-comment">// ... 几千条数据</span>
])

<span class="hljs-comment">// 批量修改多个嵌套属性</span>
tableData.<span class="hljs-property">value</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
  item.<span class="hljs-property">status</span> = <span class="hljs-string">'inactive'</span> <span class="hljs-comment">// 修改嵌套属性</span>
  item.<span class="hljs-property">updatedAt</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() <span class="hljs-comment">// 继续修改</span>
})

<span class="hljs-comment">// 所有修改完成后，统一触发一次更新（性能更好）</span>
<span class="hljs-title function_">triggerRef</span>(tableData) <span class="hljs-comment">// ✅ 只触发一次更新，而不是每条数据都触发</span>
</code></pre>
<h2 data-id="heading-1">2. markRaw - 让某些数据"免疫"响应式</h2>
<p>有些数据你明确知道不需要响应式，比如第三方库的实例、DOM元素、或者一些配置对象。用 <code>markRaw</code> 标记后，Vue就不会把它变成响应式的。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { reactive, markRaw } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-comment">// 这个第三方库实例不需要响应式</span>
  <span class="hljs-attr">chart</span>: <span class="hljs-title function_">markRaw</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChartLibrary</span>()),
  
  <span class="hljs-comment">// 这个配置对象也不需要</span>
  <span class="hljs-attr">config</span>: <span class="hljs-title function_">markRaw</span>({
    <span class="hljs-attr">apiUrl</span>: <span class="hljs-string">'https://api.example.com'</span>,
    <span class="hljs-attr">timeout</span>: <span class="hljs-number">5000</span>
  }),
  
  <span class="hljs-comment">// 这个需要响应式</span>
  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>
})

<span class="hljs-comment">// 即使把 chart 放到 reactive 里，它也不会变成响应式</span>
<span class="hljs-comment">// 这样既避免了不必要的性能开销，也防止了某些库因为响应式代理而出错</span>
</code></pre>
<p>我之前用 ECharts 的时候就遇到过这个问题，图表实例被响应式代理后各种报错，用 <code>markRaw</code> 一包就解决了。</p>
<h2 data-id="heading-2">3. toRaw - 获取原始对象</h2>
<p>有时候你需要拿到响应式对象的原始值，比如传给第三方库、或者做深拷贝。<code>toRaw</code> 就是干这个的。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { reactive, toRaw } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Vue3'</span>,
  <span class="hljs-attr">version</span>: <span class="hljs-string">'3.0'</span>
})

<span class="hljs-comment">// 获取原始对象，不再是 Proxy</span>
<span class="hljs-keyword">const</span> rawState = <span class="hljs-title function_">toRaw</span>(state)

<span class="hljs-comment">// 传给需要普通对象的函数</span>
someThirdPartyLibrary.<span class="hljs-title function_">process</span>(rawState)

<span class="hljs-comment">// 或者做深拷贝</span>
<span class="hljs-keyword">const</span> copy = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-title function_">toRaw</span>(state)))
</code></pre>
<p>注意，<code>toRaw</code> 只能拿到一层，如果对象里还有嵌套的响应式对象，那些还是 Proxy。需要递归处理的话，可以配合 <code>markRaw</code> 使用。</p>
<h2 data-id="heading-3">4. customRef - 自定义响应式引用</h2>
<p>这个API特别适合做防抖、节流，或者需要自定义 get/set 逻辑的场景。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { customRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 防抖的 ref</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">useDebouncedRef</span>(<span class="hljs-params">value, delay = <span class="hljs-number">200</span></span>) {
  <span class="hljs-keyword">let</span> timeout
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">customRef</span>(<span class="hljs-function">(<span class="hljs-params">track, trigger</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
        <span class="hljs-title function_">track</span>() <span class="hljs-comment">// 追踪依赖</span>
        <span class="hljs-keyword">return</span> value
      },
      <span class="hljs-title function_">set</span>(<span class="hljs-params">newValue</span>) {
        <span class="hljs-built_in">clearTimeout</span>(timeout)
        timeout = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          value = newValue
          <span class="hljs-title function_">trigger</span>() <span class="hljs-comment">// 触发更新</span>
        }, delay)
      }
    }
  })
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">const</span> searchText = <span class="hljs-title function_">useDebouncedRef</span>(<span class="hljs-string">''</span>)

<span class="hljs-comment">// 用户输入时不会立即更新，等停止输入 200ms 后才更新</span>
</code></pre>
<p>我在搜索框里经常用这个，避免用户每输入一个字符就发一次请求。</p>
<h2 data-id="heading-4">5. readonly - 创建只读的响应式对象</h2>
<p>有时候你想让某些数据是响应式的（能追踪变化），但不允许修改。<code>readonly</code> 就派上用场了。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { reactive, readonly } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> original = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Vue3'</span>
})

<span class="hljs-comment">// 创建只读版本</span>
<span class="hljs-keyword">const</span> readOnlyData = <span class="hljs-title function_">readonly</span>(original)

<span class="hljs-comment">// 可以读取</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(readOnlyData.<span class="hljs-property">count</span>) <span class="hljs-comment">// 0</span>

<span class="hljs-comment">// 不能修改（开发环境会警告）</span>
readOnlyData.<span class="hljs-property">count</span> = <span class="hljs-number">1</span> <span class="hljs-comment">// ⚠️ 警告：Set operation on key "count" failed</span>

<span class="hljs-comment">// 但修改原始对象，只读版本也会更新</span>
original.<span class="hljs-property">count</span> = <span class="hljs-number">1</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(readOnlyData.<span class="hljs-property">count</span>) <span class="hljs-comment">// 1 ✅</span>
</code></pre>
<p>这个在组件间传递 props 的时候很有用，特别是你想确保子组件不会意外修改父组件的数据。</p>
<h2 data-id="heading-5">6. getCurrentInstance - 获取当前组件实例</h2>
<p>这个API在组合式API里获取组件实例特别方便，虽然官方文档说主要给库开发者用，但实际开发中偶尔也会用到。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { getCurrentInstance } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> instance = <span class="hljs-title function_">getCurrentInstance</span>()
    
    <span class="hljs-comment">// 获取组件的 props</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(instance.<span class="hljs-property">props</span>)
    
    <span class="hljs-comment">// 获取组件的 attrs</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(instance.<span class="hljs-property">attrs</span>)
    
    <span class="hljs-comment">// 获取组件的 emit</span>
    instance.<span class="hljs-title function_">emit</span>(<span class="hljs-string">'custom-event'</span>)
    
    <span class="hljs-comment">// 访问全局属性</span>
    <span class="hljs-keyword">const</span> $router = instance.<span class="hljs-property">appContext</span>.<span class="hljs-property">config</span>.<span class="hljs-property">globalProperties</span>.<span class="hljs-property">$router</span>
    
    <span class="hljs-keyword">return</span> {}
  }
}
</code></pre>
<p>不过要注意，<code>getCurrentInstance</code> 只能在 <code>setup</code> 或生命周期钩子里调用，而且不能缓存到异步回调里用。</p>
<h2 data-id="heading-6">7. defineAsyncComponent - 异步组件加载</h2>
<p>这个其实不算特别冷门，但很多人可能没深入用过。除了基本的懒加载，它还有很多高级用法。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { defineAsyncComponent } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 基础用法</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">AsyncComponent</span> = <span class="hljs-title function_">defineAsyncComponent</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./HeavyComponent.vue'</span>))

<span class="hljs-comment">// 带加载状态和错误处理</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">AsyncComponentWithStates</span> = <span class="hljs-title function_">defineAsyncComponent</span>({
  <span class="hljs-attr">loader</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./HeavyComponent.vue'</span>),
  <span class="hljs-attr">loadingComponent</span>: <span class="hljs-title class_">LoadingSpinner</span>, <span class="hljs-comment">// 加载时显示的组件</span>
  <span class="hljs-attr">errorComponent</span>: <span class="hljs-title class_">ErrorComponent</span>,   <span class="hljs-comment">// 错误时显示的组件</span>
  <span class="hljs-attr">delay</span>: <span class="hljs-number">200</span>,                       <span class="hljs-comment">// 延迟显示 loading，避免闪烁</span>
  <span class="hljs-attr">timeout</span>: <span class="hljs-number">3000</span>,                    <span class="hljs-comment">// 超时时间</span>
  <span class="hljs-title function_">onError</span>(<span class="hljs-params">error, retry, fail, attempts</span>) {
    <span class="hljs-comment">// 错误处理逻辑</span>
    <span class="hljs-keyword">if</span> (attempts &lt;= <span class="hljs-number">3</span>) {
      <span class="hljs-title function_">retry</span>() <span class="hljs-comment">// 重试</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">fail</span>()  <span class="hljs-comment">// 放弃</span>
    }
  }
})
</code></pre>
<p>我在做路由懒加载和按需加载大组件的时候，这个API帮了不少忙。</p>
<h2 data-id="heading-7">8. watchEffect 的立即执行和清理</h2>
<p><code>watchEffect</code> 大家都知道，但它的立即执行特性和清理函数可能很多人没充分利用。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { watchEffect, ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)

<span class="hljs-keyword">const</span> stop = <span class="hljs-title function_">watchEffect</span>(<span class="hljs-function">(<span class="hljs-params">onInvalidate</span>) =&gt;</span> {
  <span class="hljs-comment">// 这个函数会立即执行一次</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'count:'</span>, count.<span class="hljs-property">value</span>)
  
  <span class="hljs-comment">// 清理函数：在下次执行前或停止监听时调用</span>
  <span class="hljs-title function_">onInvalidate</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'清理之前的副作用'</span>)
    <span class="hljs-comment">// 比如取消请求、清除定时器等</span>
  })
})

<span class="hljs-comment">// 手动停止监听</span>
<span class="hljs-title function_">stop</span>()
</code></pre>
<p>这个特性在处理副作用的时候特别有用，比如监听数据变化自动发送请求，可以在清理函数里取消之前的请求，避免竞态条件。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { watchEffect, ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> userId = <span class="hljs-title function_">ref</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">let</span> abortController = <span class="hljs-literal">null</span>

<span class="hljs-title function_">watchEffect</span>(<span class="hljs-function">(<span class="hljs-params">onInvalidate</span>) =&gt;</span> {
  <span class="hljs-comment">// 取消之前的请求</span>
  <span class="hljs-keyword">if</span> (abortController) {
    abortController.<span class="hljs-title function_">abort</span>()
  }
  
  <span class="hljs-comment">// 创建新的请求</span>
  abortController = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>()
  
  <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/user/<span class="hljs-subst">${userId.value}</span>`</span>, {
    <span class="hljs-attr">signal</span>: abortController.<span class="hljs-property">signal</span>
  })
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>())
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
      <span class="hljs-comment">// 处理数据</span>
    })
  
  <span class="hljs-comment">// 清理函数：在下次执行前或组件卸载时调用</span>
  <span class="hljs-title function_">onInvalidate</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (abortController) {
      abortController.<span class="hljs-title function_">abort</span>()
    }
  })
})
</code></pre>
<p>这样就能避免快速切换用户ID时，旧的请求覆盖新请求结果的问题。</p>
<h2 data-id="heading-8">9. unref、isRef、isReactive - 类型检查工具</h2>
<p>这些工具函数在处理可能是响应式也可能不是的数据时特别有用。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { ref, reactive, unref, isRef, isReactive, isReadonly } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// unref - 如果是 ref 就返回 .value，否则返回原值</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">useValue</span>(<span class="hljs-params">maybeRef</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">unref</span>(maybeRef) <span class="hljs-comment">// 不用判断是不是 ref，直接 unref 就行</span>
}

<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">10</span>)
<span class="hljs-keyword">const</span> name = <span class="hljs-string">'Vue3'</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">useValue</span>(count))  <span class="hljs-comment">// 10</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">useValue</span>(name))   <span class="hljs-comment">// 'Vue3'</span>

<span class="hljs-comment">// isRef - 判断是否是 ref</span>
<span class="hljs-keyword">if</span> (<span class="hljs-title function_">isRef</span>(count)) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'这是一个 ref'</span>)
}

<span class="hljs-comment">// isReactive - 判断是否是 reactive 对象</span>
<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({ <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> })
<span class="hljs-keyword">if</span> (<span class="hljs-title function_">isReactive</span>(state)) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'这是一个 reactive 对象'</span>)
}

<span class="hljs-comment">// isReadonly - 判断是否是 readonly 对象</span>
<span class="hljs-keyword">const</span> readonlyState = <span class="hljs-title function_">readonly</span>(state)
<span class="hljs-keyword">if</span> (<span class="hljs-title function_">isReadonly</span>(readonlyState)) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'这是一个 readonly 对象'</span>)
}
</code></pre>
<p>在写工具函数或者组合式函数的时候，这些检查函数能让你写出更健壮的代码。</p>
<h2 data-id="heading-9">10. effectScope 和 onScopeDispose - 批量管理副作用</h2>
<p><code>effectScope</code> 是 Vue3.2 新增的，可以批量管理一组响应式效果（computed、watch、watchEffect等），统一停止或清理。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { effectScope, ref, watchEffect, computed, onScopeDispose } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">useMouse</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> x = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
  <span class="hljs-keyword">const</span> y = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
  
  <span class="hljs-comment">// 创建一个作用域</span>
  <span class="hljs-keyword">const</span> scope = <span class="hljs-title function_">effectScope</span>()
  
  scope.<span class="hljs-title function_">run</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 在这个作用域内的所有响应式效果都会被统一管理</span>
    <span class="hljs-title function_">watchEffect</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">handler</span> = (<span class="hljs-params">e</span>) =&gt; {
        x.<span class="hljs-property">value</span> = e.<span class="hljs-property">clientX</span>
        y.<span class="hljs-property">value</span> = e.<span class="hljs-property">clientY</span>
      }
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousemove'</span>, handler)
      
      <span class="hljs-comment">// 清理函数</span>
      <span class="hljs-title function_">onScopeDispose</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'mousemove'</span>, handler)
      })
    })
    
    <span class="hljs-comment">// 也可以有多个 watchEffect、computed 等</span>
    <span class="hljs-keyword">const</span> distance = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(x.<span class="hljs-property">value</span> ** <span class="hljs-number">2</span> + y.<span class="hljs-property">value</span> ** <span class="hljs-number">2</span>)
    })
  })
  
  <span class="hljs-comment">// 返回停止函数</span>
  <span class="hljs-keyword">return</span> {
    x,
    y,
    <span class="hljs-attr">stop</span>: <span class="hljs-function">() =&gt;</span> scope.<span class="hljs-title function_">stop</span>() <span class="hljs-comment">// 一次性停止所有效果</span>
  }
}
</code></pre>
<p>这个在写组合式函数的时候特别有用，可以确保所有副作用都能被正确清理，避免内存泄漏。</p>
<h2 data-id="heading-10">11. provide/inject 的响应式传递</h2>
<p><code>provide/inject</code> 大家都知道，但很多人不知道它可以传递响应式数据，而且子组件可以直接修改。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 父组件</span>
<span class="hljs-keyword">import</span> { provide, ref, reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
    <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">reactive</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">20</span> })
    
    <span class="hljs-comment">// 提供响应式数据</span>
    <span class="hljs-title function_">provide</span>(<span class="hljs-string">'count'</span>, count)
    <span class="hljs-title function_">provide</span>(<span class="hljs-string">'user'</span>, user)
    
    <span class="hljs-comment">// 也可以提供修改函数</span>
    <span class="hljs-title function_">provide</span>(<span class="hljs-string">'increment'</span>, <span class="hljs-function">() =&gt;</span> {
      count.<span class="hljs-property">value</span>++
    })
    
    <span class="hljs-keyword">return</span> { count, user }
  }
}

<span class="hljs-comment">// 子组件（可以是任意深度的子组件）</span>
<span class="hljs-keyword">import</span> { inject, ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 注入响应式数据，可以设置默认值</span>
    <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">inject</span>(<span class="hljs-string">'count'</span>, <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)) <span class="hljs-comment">// 如果父组件没有提供，使用默认值</span>
    <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">inject</span>(<span class="hljs-string">'user'</span>, <span class="hljs-function">() =&gt;</span> ({ <span class="hljs-attr">name</span>: <span class="hljs-string">'默认用户'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">0</span> })) <span class="hljs-comment">// 也可以使用工厂函数</span>
    <span class="hljs-keyword">const</span> increment = <span class="hljs-title function_">inject</span>(<span class="hljs-string">'increment'</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'increment 方法未提供'</span>)
    })
    
    <span class="hljs-comment">// 可以直接修改（如果父组件提供的是响应式数据）</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; {
      count.<span class="hljs-property">value</span>++ <span class="hljs-comment">// ✅ 父组件的 count 也会更新</span>
      user.<span class="hljs-property">name</span> = <span class="hljs-string">'李四'</span> <span class="hljs-comment">// ✅ 父组件的 user 也会更新</span>
      <span class="hljs-comment">// 或者调用父组件提供的方法</span>
      <span class="hljs-title function_">increment</span>()
    }
    
    <span class="hljs-keyword">return</span> { count, user, handleClick }
  }
}
</code></pre>
<p>这个在跨层级组件通信的时候特别方便，比 props 一层层传要优雅得多。</p>
<h2 data-id="heading-11">12. v-memo - 性能优化的指令</h2>
<p><code>v-memo</code> 是 Vue3.2 新增的指令，可以缓存模板的一部分，只有在依赖项变化时才重新渲染。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;!-- 只有 item.id 或 selected 变化时才重新渲染这个 div --&gt;
  &lt;div v-for="item in list" :key="item.id" v-memo="[item.id, selected]"&gt;
    &lt;p&gt;{{ item.name }}&lt;/p&gt;
    &lt;p&gt;{{ item.description }}&lt;/p&gt;
    &lt;!-- 复杂的内容 --&gt;
    &lt;ExpensiveComponent :data="item.data" /&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref } from 'vue'

const list = ref([
  { id: 1, name: 'Item 1', description: '...', data: {...} },
  { id: 2, name: 'Item 2', description: '...', data: {...} },
  // ...
])

const selected = ref(null)
&lt;/script&gt;
</code></pre>
<p>这个在处理长列表的时候特别有用，可以大幅提升性能。不过要注意，<code>v-memo</code> 必须和 <code>v-for</code> 一起使用。</p>
<h2 data-id="heading-12">13. Suspense - 异步组件的加载状态</h2>
<p><code>Suspense</code> 可以优雅地处理异步组件的加载状态，不需要在每个组件里单独处理。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;Suspense&gt;
    &lt;template #default&gt;
      &lt;AsyncComponent /&gt;
    &lt;/template&gt;
    &lt;template #fallback&gt;
      &lt;div class="loading"&gt;加载中...&lt;/div&gt;
    &lt;/template&gt;
  &lt;/Suspense&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { defineAsyncComponent } from 'vue'

const AsyncComponent = defineAsyncComponent(() =&gt; 
  import('./HeavyComponent.vue')
)
&lt;/script&gt;
</code></pre>
<p>如果异步组件内部有异步操作（比如 <code>setup</code> 里用了 <code>await</code>），<code>Suspense</code> 也会等待：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- AsyncComponent.vue --&gt;
&lt;script setup&gt;
// 这个组件内部有异步操作
const data = await fetchData() // Suspense 会等待这个完成
&lt;/script&gt;
</code></pre>
<p>这个在处理异步数据加载的时候特别优雅，比手动管理 loading 状态要方便。</p>
<h2 data-id="heading-13">14. 模板引用的高级用法</h2>
<p>模板引用（ref）除了获取 DOM 元素，还有很多高级用法。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;!-- 在 v-for 中获取多个元素 --&gt;
  &lt;div v-for="item in list" :ref="el =&gt; setItemRef(el, item.id)"&gt;
    {{ item.name }}
  &lt;/div&gt;
  
  &lt;!-- 获取子组件实例 --&gt;
  &lt;ChildComponent ref="childRef" /&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref, onMounted } from 'vue'

const list = ref([
  { id: 1, name: 'Item 1' },
  { id: 2, name: 'Item 2' },
])

// 存储多个元素引用
const itemRefs = ref({})

const setItemRef = (el, id) =&gt; {
  if (el) {
    itemRefs.value[id] = el
  }
}

// 子组件引用
const childRef = ref(null)

onMounted(() =&gt; {
  // 访问子组件的方法或属性
  console.log(childRef.value.someMethod())
  console.log(childRef.value.someProperty)
  
  // 访问所有列表项的 DOM
  console.log(itemRefs.value)
})
&lt;/script&gt;
</code></pre>
<p>还可以配合 <code>defineExpose</code> 暴露子组件的特定内容：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- ChildComponent.vue --&gt;
&lt;script setup&gt;
import { ref } from 'vue'

const count = ref(0)
const privateData = ref('private') // 这个不会被暴露

const increment = () =&gt; {
  count.value++
}

// 只暴露 count 和 increment
defineExpose({
  count,
  increment
})
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-14">15. computed 的 getter/setter 形式</h2>
<p><code>computed</code> 除了只读形式，还可以有 getter 和 setter，实现双向绑定。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> firstName = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'张'</span>)
<span class="hljs-keyword">const</span> lastName = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'三'</span>)

<span class="hljs-comment">// 可读写的 computed</span>
<span class="hljs-keyword">const</span> fullName = <span class="hljs-title function_">computed</span>({
  <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${firstName.value}</span><span class="hljs-subst">${lastName.value}</span>`</span>
  },
  <span class="hljs-title function_">set</span>(<span class="hljs-params">newValue</span>) {
    <span class="hljs-comment">// 当设置 fullName 时，自动拆分到 firstName 和 lastName</span>
    <span class="hljs-keyword">const</span> parts = newValue.<span class="hljs-title function_">split</span>(<span class="hljs-string">''</span>)
    <span class="hljs-keyword">if</span> (parts.<span class="hljs-property">length</span> &gt;= <span class="hljs-number">2</span>) {
      firstName.<span class="hljs-property">value</span> = parts[<span class="hljs-number">0</span>]
      lastName.<span class="hljs-property">value</span> = parts.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>)
    }
  }
})

<span class="hljs-comment">// 使用</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(fullName.<span class="hljs-property">value</span>) <span class="hljs-comment">// '张三'</span>
fullName.<span class="hljs-property">value</span> = <span class="hljs-string">'李四'</span> <span class="hljs-comment">// 自动更新 firstName 和 lastName</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(firstName.<span class="hljs-property">value</span>) <span class="hljs-comment">// '李'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(lastName.<span class="hljs-property">value</span>) <span class="hljs-comment">// '四'</span>
</code></pre>
<p>这个在处理表单数据转换的时候特别有用。</p>
<h2 data-id="heading-15">16. watch 的深度监听和立即执行</h2>
<p><code>watch</code> 的选项参数有很多实用的配置。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { watch, ref, reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">user</span>: {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">20</span>
  }
})

<span class="hljs-comment">// 深度监听对象</span>
<span class="hljs-title function_">watch</span>(
  <span class="hljs-function">() =&gt;</span> state.<span class="hljs-property">user</span>,
  <span class="hljs-function">(<span class="hljs-params">newVal, oldVal</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'user 变化了'</span>, newVal, oldVal)
  },
  { <span class="hljs-attr">deep</span>: <span class="hljs-literal">true</span> } <span class="hljs-comment">// 深度监听嵌套属性</span>
)

<span class="hljs-comment">// 或者直接监听整个对象</span>
<span class="hljs-title function_">watch</span>(
  state,
  <span class="hljs-function">(<span class="hljs-params">newVal, oldVal</span>) =&gt;</span> {
    <span class="hljs-comment">// 注意：newVal 和 oldVal 是同一个对象（因为 reactive）</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'state 变化了'</span>)
  },
  { <span class="hljs-attr">deep</span>: <span class="hljs-literal">true</span> }
)

<span class="hljs-comment">// 立即执行一次</span>
<span class="hljs-title function_">watch</span>(
  count,
  <span class="hljs-function">(<span class="hljs-params">newVal, oldVal</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'count:'</span>, newVal)
  },
  { <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span> } <span class="hljs-comment">// 立即执行一次回调</span>
)

<span class="hljs-comment">// 监听多个源</span>
<span class="hljs-title function_">watch</span>(
  [count, <span class="hljs-function">() =&gt;</span> state.<span class="hljs-property">user</span>.<span class="hljs-property">name</span>],
  <span class="hljs-function">(<span class="hljs-params">[newCount, newName], [oldCount, oldName]</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'count 或 name 变化了'</span>)
  }
)

<span class="hljs-comment">// 手动实现只监听一次的效果</span>
<span class="hljs-keyword">let</span> stopWatcher = <span class="hljs-literal">null</span>
stopWatcher = <span class="hljs-title function_">watch</span>(
  count,
  <span class="hljs-function">(<span class="hljs-params">newVal</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'只执行一次'</span>)
    <span class="hljs-comment">// 执行后立即停止监听</span>
    <span class="hljs-keyword">if</span> (stopWatcher) {
      <span class="hljs-title function_">stopWatcher</span>()
      stopWatcher = <span class="hljs-literal">null</span>
    }
  }
)
</code></pre>
<h2 data-id="heading-16">17. nextTick 的多种用法</h2>
<p><code>nextTick</code> 大家都知道，但它的使用场景可能很多人没完全掌握。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { nextTick, ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
<span class="hljs-keyword">const</span> message = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)

<span class="hljs-comment">// 等待 DOM 更新后执行</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"/>) {
  count.<span class="hljs-property">value</span>++
  message.<span class="hljs-property">value</span> = <span class="hljs-string">'Count 已更新'</span>
  
  <span class="hljs-comment">// 此时 DOM 可能还没更新</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.count'</span>).<span class="hljs-property">textContent</span>) <span class="hljs-comment">// 可能是旧值</span>
  
  <span class="hljs-comment">// 等待 DOM 更新</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">nextTick</span>()
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.count'</span>).<span class="hljs-property">textContent</span>) <span class="hljs-comment">// 新值</span>
  
  <span class="hljs-comment">// 或者用回调形式</span>
  <span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'DOM 已更新'</span>)
  })
}

<span class="hljs-comment">// 在组件挂载后操作 DOM</span>
<span class="hljs-keyword">import</span> { onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-title function_">onMounted</span>(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-comment">// 即使组件已挂载，某些 DOM 操作可能还需要等待</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">nextTick</span>()
  <span class="hljs-comment">// 现在可以安全地操作 DOM 了</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.some-element'</span>).<span class="hljs-title function_">focus</span>()
})
</code></pre>
<h2 data-id="heading-17">18. 响应式 API 的转换工具</h2>
<p>Vue3 提供了一些转换工具，可以在不同响应式类型之间转换。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { ref, reactive, toRef, toRefs, isRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Vue3'</span>,
  <span class="hljs-attr">version</span>: <span class="hljs-string">'3.0'</span>,
  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>
})

<span class="hljs-comment">// toRef - 将 reactive 对象的某个属性转为 ref</span>
<span class="hljs-keyword">const</span> nameRef = <span class="hljs-title function_">toRef</span>(state, <span class="hljs-string">'name'</span>)
nameRef.<span class="hljs-property">value</span> = <span class="hljs-string">'Vue 3'</span> <span class="hljs-comment">// 会同步更新 state.name</span>

<span class="hljs-comment">// toRefs - 将 reactive 对象的所有属性转为 ref</span>
<span class="hljs-keyword">const</span> { name, version, count } = <span class="hljs-title function_">toRefs</span>(state)
<span class="hljs-comment">// 现在 name、version、count 都是 ref，可以在模板中直接使用</span>

<span class="hljs-comment">// 在组合式函数中返回响应式数据时特别有用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">useCounter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({
    <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">step</span>: <span class="hljs-number">1</span>
  })
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"/>) =&gt; {
    state.<span class="hljs-property">count</span> += state.<span class="hljs-property">step</span>
  }
  
  <span class="hljs-comment">// 返回 toRefs，让使用者可以解构而不失去响应式</span>
  <span class="hljs-keyword">return</span> {
    ...<span class="hljs-title function_">toRefs</span>(state),
    increment
  }
}

<span class="hljs-comment">// 使用时可以解构</span>
<span class="hljs-keyword">const</span> { count, step, increment } = <span class="hljs-title function_">useCounter</span>()
<span class="hljs-comment">// count 和 step 仍然是响应式的</span>
</code></pre>
<h2 data-id="heading-18">19. 自定义指令的高级用法</h2>
<p>自定义指令除了基本的 <code>mounted</code> 和 <code>updated</code>，还有很多生命周期钩子。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 自定义指令直接定义对象即可，不需要特殊导入</span>
<span class="hljs-keyword">const</span> vMyDirective = {
  <span class="hljs-comment">// 元素插入 DOM 前调用</span>
  <span class="hljs-title function_">created</span>(<span class="hljs-params">el, binding, vnode</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'created'</span>)
  },
  
  <span class="hljs-comment">// 元素插入 DOM 后调用</span>
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params">el, binding, vnode, prevVnode</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'mounted'</span>, binding.<span class="hljs-property">value</span>)
    <span class="hljs-comment">// binding.value - 指令的值</span>
    <span class="hljs-comment">// binding.oldValue - 之前的值（仅在 update 和 componentUpdated 中可用）</span>
    <span class="hljs-comment">// binding.arg - 指令参数，如 v-my-directive:foo 中的 'foo'</span>
    <span class="hljs-comment">// binding.modifiers - 修饰符对象，如 v-my-directive.foo.bar 中的 { foo: true, bar: true }</span>
  },
  
  <span class="hljs-comment">// 在包含组件的 VNode 更新前调用</span>
  <span class="hljs-title function_">beforeUpdate</span>(<span class="hljs-params">el, binding, vnode, prevVnode</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'beforeUpdate'</span>)
  },
  
  <span class="hljs-comment">// 在包含组件的 VNode 及其子 VNode 更新后调用</span>
  <span class="hljs-title function_">updated</span>(<span class="hljs-params">el, binding, vnode, prevVnode</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'updated'</span>)
  },
  
  <span class="hljs-comment">// 在卸载前调用</span>
  <span class="hljs-title function_">beforeUnmount</span>(<span class="hljs-params">el, binding, vnode</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'beforeUnmount'</span>)
  },
  
  <span class="hljs-comment">// 卸载后调用</span>
  <span class="hljs-title function_">unmounted</span>(<span class="hljs-params">el, binding, vnode</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'unmounted'</span>)
  }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-comment">// &lt;div v-my-directive:arg.modifier="value"&gt;&lt;/div&gt;</span>
</code></pre>
<p>实际应用：实现一个点击外部关闭的指令</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> vClickOutside = {
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params">el, binding</span>) {
    el.<span class="hljs-property">_clickOutside</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (!(el === event.<span class="hljs-property">target</span> || el.<span class="hljs-title function_">contains</span>(event.<span class="hljs-property">target</span>))) {
        binding.<span class="hljs-title function_">value</span>() <span class="hljs-comment">// 调用传入的函数</span>
      }
    }
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, el.<span class="hljs-property">_clickOutside</span>)
  },
  <span class="hljs-title function_">unmounted</span>(<span class="hljs-params">el</span>) {
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'click'</span>, el.<span class="hljs-property">_clickOutside</span>)
  }
}
</code></pre>
<h2 data-id="heading-19">20. 组合式 API 的类型推断技巧</h2>
<p>在 TypeScript 中使用组合式 API 时，有一些类型推断的技巧。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { ref, computed, <span class="hljs-title class_">Ref</span>, <span class="hljs-title class_">ComputedRef</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 明确指定 ref 的类型</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">count</span>: <span class="hljs-title class_">Ref</span>&lt;<span class="hljs-built_in">number</span>&gt; = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
<span class="hljs-comment">// 或者让 TypeScript 自动推断</span>
<span class="hljs-keyword">const</span> count = ref&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-number">0</span>)

<span class="hljs-comment">// computed 的类型</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">doubleCount</span>: <span class="hljs-title class_">ComputedRef</span>&lt;<span class="hljs-built_in">number</span>&gt; = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> count.<span class="hljs-property">value</span> * <span class="hljs-number">2</span>)

<span class="hljs-comment">// 在组合式函数中返回类型</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">useCounter</span>(<span class="hljs-params">initialValue: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span></span>) {
  <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(initialValue)
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"/>) =&gt; {
    count.<span class="hljs-property">value</span>++
  }
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">count</span>: count <span class="hljs-keyword">as</span> <span class="hljs-title class_">Ref</span>&lt;<span class="hljs-built_in">number</span>&gt;, <span class="hljs-comment">// 或者用 readonly</span>
    increment
  }
}

<span class="hljs-comment">// 使用泛型</span>
<span class="hljs-keyword">function</span> useAsyncData&lt;T&gt;(<span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>) {
  <span class="hljs-keyword">const</span> data = ref&lt;T | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>)
  <span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
  <span class="hljs-keyword">const</span> error = ref&lt;<span class="hljs-title class_">Error</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>)
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url)
      data.<span class="hljs-property">value</span> = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()
    } <span class="hljs-keyword">catch</span> (e) {
      error.<span class="hljs-property">value</span> = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">Error</span>
    } <span class="hljs-keyword">finally</span> {
      loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
    }
  }
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">data</span>: <span class="hljs-title function_">readonly</span>(data),
    <span class="hljs-attr">loading</span>: <span class="hljs-title function_">readonly</span>(loading),
    <span class="hljs-attr">error</span>: <span class="hljs-title function_">readonly</span>(error),
    fetchData
  }
}
</code></pre>
<h2 data-id="heading-20">21. 性能优化的组合拳</h2>
<p>把这些 API 组合起来，可以实现更强大的性能优化。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { shallowRef, markRaw, computed, watchEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 场景：处理大量数据列表</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">useLargeList</span>(<span class="hljs-params">initialData</span>) {
  <span class="hljs-comment">// 用 shallowRef 避免深度响应式</span>
  <span class="hljs-keyword">const</span> items = <span class="hljs-title function_">shallowRef</span>(initialData.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({
    ...item,
    <span class="hljs-comment">// 某些不需要响应式的数据用 markRaw</span>
    <span class="hljs-attr">metadata</span>: <span class="hljs-title function_">markRaw</span>(item.<span class="hljs-property">metadata</span>)
  })))
  
  <span class="hljs-comment">// 用 computed 缓存计算结果</span>
  <span class="hljs-keyword">const</span> filteredItems = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">return</span> items.<span class="hljs-property">value</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">visible</span>)
  })
  
  <span class="hljs-comment">// 用 watchEffect 处理副作用，自动清理</span>
  <span class="hljs-keyword">const</span> stop = <span class="hljs-title function_">watchEffect</span>(<span class="hljs-function">(<span class="hljs-params">onInvalidate</span>) =&gt;</span> {
    <span class="hljs-comment">// 处理过滤后的数据</span>
    <span class="hljs-title function_">processItems</span>(filteredItems.<span class="hljs-property">value</span>)
    
    <span class="hljs-title function_">onInvalidate</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 清理工作</span>
      <span class="hljs-title function_">cleanup</span>()
    })
  })
  
  <span class="hljs-keyword">return</span> {
    items,
    filteredItems,
    stop
  }
}
</code></pre>
<h2 data-id="heading-21">22. 实际项目中的最佳实践</h2>
<p>结合我自己的项目经验，分享几个实用的模式：</p>
<h3 data-id="heading-22">模式1：响应式数据的初始化</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { ref, reactive, onMounted, readonly } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">useUserData</span>(<span class="hljs-params">userId</span>) {
  <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)
  <span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
  <span class="hljs-keyword">const</span> error = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchUser</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>
    error.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/users/<span class="hljs-subst">${userId}</span>`</span>)
      user.<span class="hljs-property">value</span> = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()
    } <span class="hljs-keyword">catch</span> (e) {
      error.<span class="hljs-property">value</span> = e
    } <span class="hljs-keyword">finally</span> {
      loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
    }
  }
  
  <span class="hljs-comment">// 组件挂载时自动获取</span>
  <span class="hljs-title function_">onMounted</span>(fetchUser)
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">user</span>: <span class="hljs-title function_">readonly</span>(user),
    <span class="hljs-attr">loading</span>: <span class="hljs-title function_">readonly</span>(loading),
    <span class="hljs-attr">error</span>: <span class="hljs-title function_">readonly</span>(error),
    <span class="hljs-attr">refetch</span>: fetchUser
  }
}
</code></pre>
<h3 data-id="heading-23">模式2：表单验证</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { ref, computed, reactive, readonly } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">useFormValidation</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> form = <span class="hljs-title function_">reactive</span>({
    <span class="hljs-attr">email</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">password</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">confirmPassword</span>: <span class="hljs-string">''</span>
  })
  
  <span class="hljs-keyword">const</span> errors = <span class="hljs-title function_">reactive</span>({})
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">validateEmail</span> = (<span class="hljs-params">email</span>) =&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-regexp">/^[^\s@]+@[^\s@]+\.[^\s@]+$/</span>.<span class="hljs-title function_">test</span>(email)
  }
  
  <span class="hljs-comment">// 用 computed 实时验证</span>
  <span class="hljs-keyword">const</span> isValid = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
    errors.<span class="hljs-property">email</span> = form.<span class="hljs-property">email</span> &amp;&amp; !<span class="hljs-title function_">validateEmail</span>(form.<span class="hljs-property">email</span>) 
      ? <span class="hljs-string">'邮箱格式不正确'</span> 
      : <span class="hljs-string">''</span>
    
    errors.<span class="hljs-property">password</span> = form.<span class="hljs-property">password</span>.<span class="hljs-property">length</span> &lt; <span class="hljs-number">6</span> 
      ? <span class="hljs-string">'密码至少6位'</span> 
      : <span class="hljs-string">''</span>
    
    errors.<span class="hljs-property">confirmPassword</span> = form.<span class="hljs-property">password</span> !== form.<span class="hljs-property">confirmPassword</span> 
      ? <span class="hljs-string">'两次密码不一致'</span> 
      : <span class="hljs-string">''</span>
    
    <span class="hljs-keyword">return</span> !<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">values</span>(errors).<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> err)
  })
  
  <span class="hljs-keyword">return</span> {
    form,
    <span class="hljs-attr">errors</span>: <span class="hljs-title function_">readonly</span>(errors),
    isValid
  }
}
</code></pre>
<h3 data-id="heading-24">模式3：防抖和节流的组合使用</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { customRef, watch } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 防抖 ref - 基于 customRef 实现</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">useDebounceRef</span>(<span class="hljs-params">value, delay = <span class="hljs-number">300</span></span>) {
  <span class="hljs-keyword">let</span> timeout
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">customRef</span>(<span class="hljs-function">(<span class="hljs-params">track, trigger</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
        <span class="hljs-title function_">track</span>()
        <span class="hljs-keyword">return</span> value
      },
      <span class="hljs-title function_">set</span>(<span class="hljs-params">newValue</span>) {
        <span class="hljs-built_in">clearTimeout</span>(timeout)
        timeout = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          value = newValue
          <span class="hljs-title function_">trigger</span>()
        }, delay)
      }
    }
  })
}

<span class="hljs-comment">// 节流函数 - 配合 watch 使用（这是纯 JS 函数，不是 Vue3 API，但经常和 Vue3 一起用）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">useThrottleFn</span>(<span class="hljs-params">fn, delay = <span class="hljs-number">300</span></span>) {
  <span class="hljs-keyword">let</span> lastTime = <span class="hljs-number">0</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
    <span class="hljs-keyword">if</span> (now - lastTime &gt;= delay) {
      fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args)
      lastTime = now
    }
  }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">const</span> searchText = <span class="hljs-title function_">useDebounceRef</span>(<span class="hljs-string">''</span>)

<span class="hljs-title function_">watch</span>(searchText, <span class="hljs-function">(<span class="hljs-params">newVal</span>) =&gt;</span> {
  <span class="hljs-comment">// 搜索逻辑，只在用户停止输入 300ms 后执行</span>
  <span class="hljs-title function_">performSearch</span>(newVal)
})

<span class="hljs-keyword">const</span> handleScroll = <span class="hljs-title function_">useThrottleFn</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 滚动处理，每 300ms 最多执行一次</span>
  <span class="hljs-title function_">updateScrollPosition</span>()
}, <span class="hljs-number">100</span>)
</code></pre>
<h2 data-id="heading-25">版本要求说明</h2>
<p>部分 API 需要特定版本的 Vue3：</p>
<ul>
<li><strong>Vue 3.2+</strong>：<code>effectScope</code>、<code>onScopeDispose</code>、<code>v-memo</code></li>
<li><strong>Vue 3.0+</strong>：其他大部分 API</li>
</ul>
<p>建议使用 Vue 3.2 或更高版本，以获得完整的 API 支持。</p>
<h2 data-id="heading-26">常见陷阱和注意事项</h2>
<ol>
<li>
<p><strong>shallowRef/shallowReactive 的陷阱</strong>：修改嵌套属性不会触发更新，如果需要更新，要替换整个对象。</p>
</li>
<li>
<p><strong>toRaw 的局限性</strong>：只能获取一层的原始对象，嵌套的响应式对象仍然是 Proxy。</p>
</li>
<li>
<p><strong>getCurrentInstance 的使用限制</strong>：只能在 <code>setup</code> 或生命周期钩子中调用，不能缓存到异步回调中使用。</p>
</li>
<li>
<p><strong>inject 的默认值</strong>：如果父组件没有提供值，<code>inject</code> 会返回 <code>undefined</code>，建议总是提供默认值。</p>
</li>
<li>
<p><strong>watchEffect 的依赖追踪</strong>：会自动追踪所有在函数内访问的响应式数据，注意不要访问不需要追踪的数据。</p>
</li>
<li>
<p><strong>computed 的副作用</strong>：不要在 <code>computed</code> 中执行副作用操作（如修改 DOM、发送请求等），应该使用 <code>watch</code> 或 <code>watchEffect</code>。</p>
</li>
</ol>
<h2 data-id="heading-27">总结下</h2>
<p>有些API你可能不常用，但在特定场景下真的能解决实际问题。性能优化、边界情况处理、自定义逻辑，这些场景下它们都能派上用场。</p>
<p>不过也要注意，不要过度使用。比如 <code>shallowRef</code> 虽然性能好，但如果你确实需要深度响应式，就不要为了性能而牺牲功能。工具是死的，场景是活的，根据实际需求选择最合适的方案才是王道。。。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用C++实现一个简易的线程池]]></title>    <link>https://juejin.cn/post/7571781196297568265</link>    <guid>https://juejin.cn/post/7571781196297568265</guid>    <pubDate>2025-11-13T02:58:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571781196297568265" data-draft-id="7571829822339907635" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用C++实现一个简易的线程池"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-13T02:58:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="QZQ54188"/> <meta itemprop="url" content="https://juejin.cn/user/666776045362473"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用C++实现一个简易的线程池
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/666776045362473/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    QZQ54188
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T02:58:41.000Z" title="Thu Nov 13 2025 02:58:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在现代软件开发中，多线程编程已经成为提升程序性能的常见手段。无论是处理大量 I/O 请求的服务器，还是进行 CPU 密集型计算的应用，多线程都能显著提高吞吐量和响应速度。然而，直接频繁创建和销毁线程开销巨大，也容易导致资源浪费和管理复杂度的增加。</p>
<p>为了解决这个问题，线程池应运而生。它的核心思想是：提前创建固定数量的工作线程，并将任务提交到一个任务队列中，由线程池中的线程循环取任务执行。这样，不仅减少了线程创建和销毁的开销，也能方便地控制系统的并发度。</p>
<p>这篇博客记录了逐步实现一个简易版线程池的过程。</p>
<p>首先线程池的思想是创建预先创建一定数量的工作线程，它们循环等待任务队列中的任务并执行，从而避免频繁创建和销毁线程，实现资源复用，提高资源利用率和程序性能。所以我们首先需要一个<code>vector&lt;thread&gt;</code>的数组，还有一个任务队列。同时，由于线程池可能会被多个线程同时访问：工作线程需要取出任务队列中的任务，其他使用线程池的线程可能同时提交任务，所以还需要加一把互斥锁。上述还提到了其他线程会往线程池中提交任务，使得线程池中的工作线程可以取出任务队列中的任务并且执行，所以还需要一个公开的提交任务函数。基本架构如下：</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadPool</span>{
<span class="hljs-keyword">public</span>:
  <span class="hljs-built_in">ThreadPool</span>(<span class="hljs-type">size_t</span>);

  <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">class</span> F, <span class="hljs-keyword">class</span> ...Args&gt;
  <span class="hljs-keyword">auto</span> <span class="hljs-title">enqueue</span><span class="hljs-params">(F&amp;&amp; f, Args&amp;&amp;... args)</span> -&gt; <span class="hljs-type">void</span></span>;
  
  ~<span class="hljs-built_in">ThreadPool</span>();

<span class="hljs-keyword">private</span>:
  std::vector&lt;std::thread&gt; workers_;
  std::queue&lt;std::function&lt;<span class="hljs-type">void</span>()&gt;&gt; tasks_;
  std::mutex mutex_;
};
</code></pre>
<p>这里解释一下任务队列为什么使用<code>std::queue&lt;std::function&lt;void()&gt;&gt; tasks_</code>，首先我们肯定需要一个统一的形式封装任务队列，这样就可以统一封装到stl容器中。而且我们期望工作线程执行时是可以直接拿来调用的，工作线程是线程池内部实现，不应该依赖于用户传入任务的参数这层外部抽象，所以参数列表为空。参数列表为空之后用户传入带有参数的函数还是可以执行的，注意我们的<code>enqueue</code>函数中接受了用户提供的任务函数和参数，在这个函数中会将二者进行<code>std::bind</code>，这样就把参数填入可调用对象了，所以工作线程取出任务时可以直接调用。至于用户需要返回值怎么办，这里先埋一个伏笔，先统一使用<code>void</code>表示无返回值，便于封装。</p>
<p>接下来我们实现构造函数：</p>
<pre><code class="hljs language-C++" lang="C++">ThreadPool::<span class="hljs-built_in">ThreadPool</span>(<span class="hljs-type">size_t</span> nums){
    <span class="hljs-keyword">for</span>(<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; nums; i++){
        workers_.<span class="hljs-built_in">emplace_back</span>([<span class="hljs-keyword">this</span>]{
            <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>){
                std::function&lt;<span class="hljs-built_in">void</span>()&gt; task;
                {
                    std::unique_lock&lt;std::mutex&gt; <span class="hljs-built_in">lock</span>(<span class="hljs-keyword">this</span>-&gt;mutex_);
                    <span class="hljs-keyword">this</span>-&gt;condition.<span class="hljs-built_in">wait</span>(lock, [<span class="hljs-keyword">this</span>]{!<span class="hljs-keyword">this</span>-&gt;tasks_.<span class="hljs-built_in">empty</span>(); });
                    task = std::<span class="hljs-built_in">move</span>(<span class="hljs-keyword">this</span>-&gt;tasks_.<span class="hljs-built_in">front</span>());
                    <span class="hljs-keyword">this</span>-&gt;tasks_.<span class="hljs-built_in">pop</span>();
                }
                <span class="hljs-built_in">task</span>();
            }
        });
    }
}
</code></pre>
<p>构造函数的目的就是向<code>std::vector&lt;std::thread&gt; workers_</code>中填充工作线程，工作线程的逻辑如下：首先尝试获取锁，获取锁之后查看任务队列是否为空，如果不为空的话就取出元素执行，如果为空的话就释放锁进行下一轮循环。</p>
<p>下面我们从细节上具体说明，获取锁之后使用条件变量进行等待，<code>wait(lock, [this]{!this-&gt;tasks_.empty(); })</code>，这样当任务队列不为空时就可以不阻塞往下执行，如果为空的话，就会释放锁，并且将该线程添加到对应条件变量的阻塞队列中，之后如果<code>enqueue</code>时填充了任务就可以发<code>signal</code>唤醒阻塞于这个条件变量的一个线程。如果获取锁之后发现任务队列中有任务可以执行，那么就取出任务队列中的第一个任务执行，因为要保证调用顺序。</p>
<p>注意在<code>emplace_back</code>函数中直接调用了线程的构造函数，先在vector 尾部直接原地构造一个线程对象。构造线程对象时会立即创建一个新线程，在这个线程里执行传入的 lambda。所以在执行条件变量的wait时就已经有实际创建的线程对象了。</p>
<p>我们在构造函数中新使用了<code>condition</code>这个条件变量，所以应该在<code>ThreadPool</code>类的私有成员中添加对应变量。上述构造函数构造的线程函数是一个死循环，因此会一直等待，获取任务队列中的任务然后执行。我们还要给线程函数加上停止逻辑，不然主线程调用join的时候就会一直阻塞，因为此时线程函数中还没有返回逻辑，所以需要给线程函数添加返回的分支。</p>
<p>线程函数返回的时任务队列应该为空，因为从逻辑上讲我要把用户给我的任务全部完成，所以任务队列为空是检测是否可以返回的条件。如果只检测这个条件也是不可以的，因为可能线程池中其他线程已经把任务队列中的所有任务取出来执行完，此时任务队列也为空，但是用户还可能<code>enqueue</code>任务进去，所以此时线程池不应该关闭。此时我们需要一个标志位，在ThreadPool的析构函数中将这个标志位设置为<code>true</code>，此时用户也不需要使用线程池了，因为调用析构函数时肯定已经退出用户代码作用域了，所以应该使用这个标志位和任务队列是否为空检测。下面给出完善后代码：</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadPool</span>{
    <span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">ThreadPool</span>(<span class="hljs-type">size_t</span>){
        stoped_ = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">for</span>(<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; nums; i++){
            workers_.<span class="hljs-built_in">emplace_back</span>([<span class="hljs-keyword">this</span>]{
                <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>){
                    std::function&lt;<span class="hljs-built_in">void</span>()&gt; task;
                    {
                        std::unique_lock&lt;std::mutex&gt; <span class="hljs-built_in">lock</span>(<span class="hljs-keyword">this</span>-&gt;mutex_);
                        <span class="hljs-keyword">this</span>-&gt;condition.<span class="hljs-built_in">wait</span>(lock, [<span class="hljs-keyword">this</span>]{!<span class="hljs-keyword">this</span>-&gt;tasks_.<span class="hljs-built_in">empty</span>(); });
                        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>-&gt;stopd_ &amp;&amp; <span class="hljs-keyword">this</span>-&gt;tasks_.<span class="hljs-built_in">empty</span>()){
                            <span class="hljs-keyword">return</span>;
                        }
                        task = std::<span class="hljs-built_in">move</span>(<span class="hljs-keyword">this</span>-&gt;tasks_.<span class="hljs-built_in">front</span>());
                        <span class="hljs-keyword">this</span>-&gt;tasks_.<span class="hljs-built_in">pop</span>();
                    }
                    <span class="hljs-built_in">task</span>();
                }
            });
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">class</span> F, <span class="hljs-keyword">class</span> ...Args&gt;
        <span class="hljs-keyword">auto</span> <span class="hljs-title">enqueue</span><span class="hljs-params">(F&amp;&amp; f, Args&amp;&amp;... args)</span> -&gt; <span class="hljs-type">void</span></span>;

    ~<span class="hljs-built_in">ThreadPool</span>();

    <span class="hljs-keyword">private</span>:
    std::vector&lt;std::thread&gt; workers_;
    std::queue&lt;std::function&lt;<span class="hljs-type">void</span>()&gt;&gt; tasks_;
    std::condition_variable condition;
    std::mutex mutex_;
    <span class="hljs-type">bool</span> stoped_;
};

</code></pre>
<p>接下来是析构函数，析构函数应该是否线程池相关资源，循环调用join回收所有线程。</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-keyword">inline</span> ThreadPool::~<span class="hljs-built_in">ThreadPool</span>()
{
  {
    <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mutex_)</span></span>;
    stoped_ = <span class="hljs-literal">true</span>;
  }
  condition.<span class="hljs-built_in">notify_all</span>();
  <span class="hljs-keyword">for</span>(std::thread &amp;worker: workers_)
    worker.<span class="hljs-built_in">join</span>();
}
</code></pre>
<p>这里我们将<code>stoped_</code>设置为<code>true</code>之后会唤醒所有在该条件变量上阻塞的工作线程，但是条件变量的唤醒只有一个线程可以重新获取锁，这个获取锁的线程就可以继续执行线程函数的逻辑，判断队列是不是为空，为空的话就可以直接return了，因为此时任务队列不会再有任务进来，但是也只有这个线程会return，其他的线程没有获取到锁，继续阻塞在条件变量的阻塞队列上。因此我们要修改条件变量的wait条件，目标是调用析构之后所有的线程都可以感知到并且被唤醒，尽管一次只有一个线程可以获取锁。</p>
<p>将条件变量的wait逻辑修改为如下就好了：</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-keyword">this</span>-&gt;condition.<span class="hljs-built_in">wait</span>(lock, [<span class="hljs-keyword">this</span>]{<span class="hljs-keyword">this</span>-&gt;stoped_ || !<span class="hljs-keyword">this</span>-&gt;tasks_.<span class="hljs-built_in">empty</span>(); });
</code></pre>
<p>最后我们来实现<code>enqueue</code>函数，这个函数的作用是添加新任务到任务队列，下面给出初版实现：</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">class</span> F, <span class="hljs-keyword">class</span> ...Args&gt;
    <span class="hljs-keyword">auto</span> <span class="hljs-title">ThreadPool::enqueue</span><span class="hljs-params">(F&amp;&amp; f, Args&amp;&amp;... args)</span> -&gt; <span class="hljs-type">void</span></span>{
    <span class="hljs-keyword">auto</span> task = std::<span class="hljs-built_in">bind</span>(std::forward&lt;F&gt;(f), std::forward&lt;Args&gt;(args)...);

    {
        <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mutex_)</span></span>;
        <span class="hljs-keyword">if</span>(stoped_){
            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">"enqueue on stopped ThreadPool"</span>);
        }

        tasks_.<span class="hljs-built_in">emplace</span>([task](){<span class="hljs-built_in">task</span>()});
    }
    condition.<span class="hljs-built_in">notify_one</span>();
}
</code></pre>
<p>这段代码就是将用户传入的可调用对象和参数绑定，这样工作线程取出来之后就可以直接调用，不需要再传参。再将这个任务放入任务队列，通知一个工作线程可以取出任务执行。</p>
<p>上述代码其实很粗糙，我们来逐步优化。</p>
<pre><code class="hljs language-C++" lang="C++">tasks_.<span class="hljs-built_in">emplace</span>([task](){<span class="hljs-built_in">task</span>()});
</code></pre>
<p>这段将任务放入任务队列的代码，调用了拷贝构造函数，如果对象很大的话会影响性能，比如说一个可调用对象内部封装了大量变量，和上下文信息。所以我们应该使用移动或者指针的方式，这里不可以使用移动，因为参数<code>F</code>是通过引用传入的，移动意味着放弃所有权，假如用户声明了一个<code>F</code>，传参之后在后续用户代码想调用这个<code>F</code>时就会发生报错，因为此时<code>F</code>已经被移动了，用户代码失去了所有权。这里只可以使用指针来做，而且应该使用共享指针，这样可以确保用户代码拥有所有权。</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">class</span> F, <span class="hljs-keyword">class</span> ...Args&gt;
<span class="hljs-keyword">auto</span> <span class="hljs-title">ThreadPool::enqueue</span><span class="hljs-params">(F&amp;&amp; f, Args&amp;&amp;... args)</span> -&gt; <span class="hljs-type">void</span></span>{
  <span class="hljs-keyword">using</span> TaskType = <span class="hljs-keyword">decltype</span>(std::<span class="hljs-built_in">bind</span>(std::forward&lt;F&gt;(f), std::forward&lt;Args&gt;(args)...));
  <span class="hljs-keyword">auto</span> taskPtr = std::<span class="hljs-built_in">make_shared</span>&lt;TaskType&gt;(
    std::<span class="hljs-built_in">bind</span>(std::forward&lt;F&gt;(f), std::forward&lt;Args&gt;(args)...)
  );

  {
    <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mutex_)</span></span>;
    <span class="hljs-keyword">if</span>(stoped_){
      <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">"enqueue on stopped ThreadPool"</span>);
    }

    tasks_.<span class="hljs-built_in">emplace</span>([taskPtr]() {
      (*taskPtr)();
    });
  }
  condition.<span class="hljs-built_in">notify_one</span>();
}
</code></pre>
<p>注意我们使用智能指针时需要知道对象具体的类型，但是<code>std::bind</code>是一个函数模板，它会返回一个可调用对象，这里返回的可调用对象是一个未命名类型的对象，你不能写出它的确切类型名字（它不是 <code>std::function</code>），但它可以像函数一样调用。也就是说返回一个具有<code>operator()</code>的匿名类型。</p>
<p>因为这个匿名类型我们没法直接写出来，所以需要让编译器帮我们推导。</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-keyword">decltype</span>(std::<span class="hljs-built_in">bind</span>(std::forward&lt;F&gt;(f), std::forward&lt;Args&gt;(args)...))
</code></pre>
<p>上述<code>enqueue</code>函数还有一个问题，就是它没有返回值，用户无法获得任务结果，也无法知道任务是否执行完成。因此我们需要一种机制，当用户调用<code>enqueue</code>函数时可以拿到一个句柄，当任务被工作线程执行完成后，用户检测这个句柄就会发现任务已经执行完成，然后获取返回值。这个机制其实就是<code>future</code>和<code>promise</code>，下面我们来继续完善：</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">class</span> F, <span class="hljs-keyword">class</span> ...Args&gt;
<span class="hljs-keyword">auto</span> <span class="hljs-title">ThreadPool::enqueue</span><span class="hljs-params">(F&amp;&amp; f, Args&amp;&amp;... args)</span> -&gt; std::future&lt;std::<span class="hljs-type">invoke_result_t</span>&lt;F, Args...&gt;&gt;</span>{
  <span class="hljs-keyword">using</span> return_type = <span class="hljs-keyword">typename</span> std::<span class="hljs-type">invoke_result_t</span>&lt;F, Args...&gt;;

  <span class="hljs-keyword">auto</span> taskPtr = std::make_shared&lt;std::packaged_task&lt;<span class="hljs-built_in">return_type</span>()&gt;&gt;(
    std::<span class="hljs-built_in">bind</span>(std::forward&lt;F&gt;(f), std::forward&lt;Args&gt;(args)...)
  );

  std::future&lt;return_type&gt; res = taskPtr-&gt;<span class="hljs-built_in">get_future</span>();
  {
    <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mutex_)</span></span>;
    <span class="hljs-keyword">if</span>(stoped_){
      <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">"enqueue on stopped ThreadPool"</span>);
    }

    tasks_.<span class="hljs-built_in">emplace</span>([taskPtr]() {
      (*taskPtr)();
    });
  }
  condition.<span class="hljs-built_in">notify_one</span>();
  <span class="hljs-keyword">return</span> res;
}
</code></pre>
<p>其中<code>using return_type = std::invoke_result_t&lt;F, Args...&gt;;</code>是推导调用 <code>f(args...)</code> 的返回类型，<code>std::packaged_task&lt;return_type()&gt;</code>用于把一个可调用对象封装成一个可以产生 <code>std::future</code> 的任务。其中<code>return_type()</code>表示一个无参数，返回类型为 <code>return_type</code>的任务，正好对应<code>std::bind</code>后的类型。</p>
<p>之后我们就可以调用<code>taskPtr-&gt;get_future()</code>：取得与该 <code>packaged_task</code> 关联的 <code>std::future</code>，将这个<code>future</code>返回出去之后，调用者可以通过<code>res.get()</code>获取返回值，类似下面的调用：</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-keyword">auto</span> future = pool.<span class="hljs-built_in">enqueue</span>([](<span class="hljs-type">int</span> x){ <span class="hljs-keyword">return</span> x * <span class="hljs-number">2</span>; }, <span class="hljs-number">21</span>);
<span class="hljs-type">int</span> result = future.<span class="hljs-built_in">get</span>(); <span class="hljs-comment">// result == 42</span>
</code></pre>
<p>至此，我们的简易线程池就完成了，完整代码可参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fprogschj%2FThreadPool%2Fblob%2Fmaster%2FThreadPool.h" target="_blank" title="https://github.com/progschj/ThreadPool/blob/master/ThreadPool.h" ref="nofollow noopener noreferrer">这个仓库</a>，下面给出用户使用线程池的示例代码：</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    
    <span class="hljs-function">ThreadPool <span class="hljs-title">pool</span><span class="hljs-params">(<span class="hljs-number">4</span>)</span></span>;
    std::vector&lt; std::future&lt;<span class="hljs-type">int</span>&gt; &gt; results;

    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; ++i) {
        results.<span class="hljs-built_in">emplace_back</span>(
            pool.<span class="hljs-built_in">enqueue</span>([i] {
                std::cout &lt;&lt; <span class="hljs-string">"hello "</span> &lt;&lt; i &lt;&lt; std::endl;
                std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">seconds</span>(<span class="hljs-number">1</span>));
                std::cout &lt;&lt; <span class="hljs-string">"world "</span> &lt;&lt; i &lt;&lt; std::endl;
                <span class="hljs-keyword">return</span> i*i;
            })
        );
    }

    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span> &amp;&amp; result: results)
        std::cout &lt;&lt; result.<span class="hljs-built_in">get</span>() &lt;&lt; <span class="hljs-string">' '</span>;
    std::cout &lt;&lt; std::endl;
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RuoYi 登录性能：异步处理登录日志的实践与代码解析]]></title>    <link>https://juejin.cn/post/7571655979256627240</link>    <guid>https://juejin.cn/post/7571655979256627240</guid>    <pubDate>2025-11-12T15:23:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571655979256627240" data-draft-id="7571672422689587252" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RuoYi 登录性能：异步处理登录日志的实践与代码解析"/> <meta itemprop="keywords" content="Spring Boot"/> <meta itemprop="datePublished" content="2025-11-12T15:23:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="元Y亨H"/> <meta itemprop="url" content="https://juejin.cn/user/2839351584888617"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RuoYi 登录性能：异步处理登录日志的实践与代码解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2839351584888617/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    元Y亨H
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T15:23:30.000Z" title="Wed Nov 12 2025 15:23:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><hr/>
<h2 data-id="heading-0">优化 RuoYi 登录性能：异步处理登录日志的实践与代码解析</h2>
<p>在现代Web应用中，用户体验和系统性能是至关重要的指标。RuoYi（若依）框架作为一款优秀的后台管理系统，其性能优化同样是开发者关注的焦点。在登录认证这样的高频操作中，即使是看似简单的日志记录，也可能成为潜在的性能瓶颈。本文将深入探讨在 RuoYi 框架中，如何通过<strong>异步处理</strong>登录日志来显著提升系统响应速度和吞吐量，并提供详细的代码解析。</p>
<h3 data-id="heading-1">一、为什么登录日志需要异步处理？</h3>
<p>当用户尝试登录系统时，除了验证用户名密码、生成Token等核心业务逻辑外，通常还需要记录用户的登录信息，例如登录时间、IP地址、登录状态（成功/失败）等。这些信息往往需要持久化到数据库中。</p>
<p>如果这些日志记录操作是<strong>同步</strong>进行的，即在登录认证流程中等待数据库写入完成后才返回结果，那么：</p>
<ol>
<li><strong>增加响应时间：</strong> 数据库I/O操作相对耗时，会直接增加用户等待登录响应的时间。</li>
<li><strong>降低并发能力：</strong> 在高并发场景下，同步的数据库操作会阻塞主线程，限制系统处理更多并发登录请求的能力。</li>
<li><strong>资源竞争：</strong> 多个登录请求同时写入数据库时，可能引发数据库锁竞争，进一步恶化性能。</li>
</ol>
<p>因此，将登录日志的写入操作从核心登录流程中剥离出来，进行<strong>异步处理</strong>，成为优化登录性能的关键策略。这意味着登录认证通过后，系统可以立即响应用户，而日志记录则在后台默默进行，互不干扰。</p>
<h3 data-id="heading-2">二、RuoYi 框架中异步处理登录日志的实现思路</h3>
<p>在 RuoYi 框架中，我们通常会利用 Spring Boot 提供的特性，结合事件驱动机制和线程池来实现登录日志的异步记录。核心思路如下：</p>
<ol>
<li><strong>事件发布：</strong> 在登录认证成功或失败后，发布一个自定义的登录事件（<code>LoginEvent</code>），包含所有需要记录的登录信息。</li>
<li><strong>异步监听：</strong> 创建一个事件监听器，并使用 Spring 的 <code>@Async</code> 注解将其标记为异步方法。当 <code>LoginEvent</code> 被发布时，这个监听器会在独立的线程中执行。</li>
<li><strong>日志持久化：</strong> 在异步监听器中，调用 <code>SysLogininforService</code> 将登录信息保存到数据库。</li>
</ol>
<h3 data-id="heading-3">三、代码实现与解析</h3>
<p>接下来，我们将通过具体的代码示例来逐步构建异步登录日志功能。</p>
<h4 data-id="heading-4">1. 开启 Spring 异步支持</h4>
<p>首先，确保你的 Spring Boot 应用开启了异步执行功能。这通常通过在启动类上添加 <code>@EnableAsync</code> 注解实现。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// RuoYiApplication.java</span>
<span class="hljs-keyword">package</span> com.ruoyi;

<span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
<span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.EnableAsync; <span class="hljs-comment">// 引入异步支持</span>

<span class="hljs-comment">/**
 * 启动程序
 *
 * <span class="hljs-doctag">@author</span> ruoyi
 */</span>
<span class="hljs-meta">@SpringBootApplication(exclude = { DataSourceAutoConfiguration.class })</span>
<span class="hljs-meta">@EnableAsync</span> <span class="hljs-comment">// 开启异步方法执行</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RuoYiApplication</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span>
    {
        <span class="hljs-comment">// System.setProperty("spring.devtools.restart.enabled", "false");</span>
        SpringApplication.run(RuoYiApplication.class, args);
        System.out.println(<span class="hljs-string">"(♥◠‿◠)ﾉﾞ  若依启动成功   ლ(´ڡ`ლ)ﾞ  \n"</span> +
                <span class="hljs-string">" .-------.         .--.  .--.\n"</span> +
                <span class="hljs-string">" |  _ _   \\ .-.     |  |  |  |\n"</span> +
                <span class="hljs-string">" | ( ' )  | `-'     |  .--.  |\n"</span> +
                <span class="hljs-string">" |(_ o _) /         |  |  |  |\n"</span> +
                <span class="hljs-string">" | (_,_).' __        |  |  |  |\n"</span> +
                <span class="hljs-string">" |  |\\ \\  |  |   ___ |  |  |  |\n"</span> +
                <span class="hljs-string">" |  | \\ `'   / / \\  \\          /\n"</span> +
                <span class="hljs-string">" |  |  \\    /   \\  \\        /\n"</span> +
                <span class="hljs-string">" '--'   `--'     '--'--.--'\n"</span> +
                <span class="hljs-string">"                                      "</span>);
    }
}
</code></pre>
<h4 data-id="heading-5">2. 定义异步线程池（可选，但推荐）</h4>
<p>为了更好地控制异步任务的执行，我们可以自定义一个线程池供 <code>@Async</code> 注解使用。这样可以避免使用 Spring 默认的 <code>SimpleAsyncTaskExecutor</code>，提高线程资源管理效率。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// AsyncConfig.java</span>
<span class="hljs-keyword">package</span> com.ruoyi.framework.config;

<span class="hljs-keyword">import</span> java.util.concurrent.Executor;
<span class="hljs-keyword">import</span> java.util.concurrent.ThreadPoolExecutor;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.AsyncConfigurer;
<span class="hljs-keyword">import</span> org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;

<span class="hljs-comment">/**
 * 异步任务配置
 *
 * <span class="hljs-doctag">@author</span> ruoyi
 */</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AsyncConfigurer</span>
{
    <span class="hljs-comment">// 定义一个日志专用的线程池</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LOG_TASK_EXECUTOR</span> <span class="hljs-operator">=</span> <span class="hljs-string">"logTaskExecutor"</span>;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Bean(name = LOG_TASK_EXECUTOR)</span>
    <span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">getAsyncExecutor</span><span class="hljs-params">()</span>
    {
        <span class="hljs-type">ThreadPoolTaskExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolTaskExecutor</span>();
        executor.setCorePoolSize(<span class="hljs-number">5</span>); <span class="hljs-comment">// 核心线程数</span>
        executor.setMaxPoolSize(<span class="hljs-number">10</span>); <span class="hljs-comment">// 最大线程数</span>
        executor.setQueueCapacity(<span class="hljs-number">200</span>); <span class="hljs-comment">// 队列容量</span>
        executor.setKeepAliveSeconds(<span class="hljs-number">60</span>); <span class="hljs-comment">// 线程空闲时间</span>
        executor.setThreadNamePrefix(<span class="hljs-string">"ruoyi-log-async-"</span>); <span class="hljs-comment">// 线程名称前缀</span>
        <span class="hljs-comment">// 拒绝策略：当队列满且线程数达到最大时，由调用者线程执行任务</span>
        executor.setRejectedExecutionHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy());
        executor.initialize();
        <span class="hljs-keyword">return</span> executor;
    }
}
</code></pre>
<h4 data-id="heading-6">3. 定义登录事件</h4>
<p>创建一个自定义的 <code>LoginEvent</code>，它继承自 Spring 的 <code>ApplicationEvent</code>，用于封装登录相关的信息。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// LoginEvent.java</span>
<span class="hljs-keyword">package</span> com.ruoyi.framework.event;

<span class="hljs-keyword">import</span> com.ruoyi.system.domain.SysLogininfor;
<span class="hljs-keyword">import</span> org.springframework.context.ApplicationEvent;

<span class="hljs-comment">/**
 * 登录事件
 * 用于在登录成功或失败时，发布事件进行异步日志记录
 *
 * <span class="hljs-doctag">@author</span> ruoyi
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginEvent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ApplicationEvent</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SysLogininfor logininfor;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">LoginEvent</span><span class="hljs-params">(Object source, SysLogininfor logininfor)</span>
    {
        <span class="hljs-built_in">super</span>(source);
        <span class="hljs-built_in">this</span>.logininfor = logininfor;
    }

    <span class="hljs-keyword">public</span> SysLogininfor <span class="hljs-title function_">getLogininfor</span><span class="hljs-params">()</span>
    {
        <span class="hljs-keyword">return</span> logininfor;
    }
}
</code></pre>
<h4 data-id="heading-7">4. 创建异步事件监听器</h4>
<p>编写一个 Spring 组件作为事件监听器。使用 <code>@EventListener</code> 注解监听 <code>LoginEvent</code>，并通过 <code>@Async</code> 注解指定它在后台线程中执行，同时可以指定使用我们之前定义的线程池。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// LoginEventListener.java</span>
<span class="hljs-keyword">package</span> com.ruoyi.framework.listener;

<span class="hljs-keyword">import</span> com.ruoyi.framework.config.AsyncConfig;
<span class="hljs-keyword">import</span> com.ruoyi.framework.event.LoginEvent;
<span class="hljs-keyword">import</span> com.ruoyi.system.service.ISysLogininforService;
<span class="hljs-keyword">import</span> org.slf4j.Logger;
<span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.context.event.EventListener;
<span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.Async;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-comment">/**
 * 登录事件监听器
 * 负责异步记录登录日志到数据库
 *
 * <span class="hljs-doctag">@author</span> ruoyi
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginEventListener</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(LoginEventListener.class);

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ISysLogininforService logininforService;

    <span class="hljs-comment">/**
     * 监听 LoginEvent，并在异步线程中处理登录日志
     * 指定使用 logTaskExecutor 线程池
     *
     * <span class="hljs-doctag">@param</span> event 登录事件
     */</span>
    <span class="hljs-meta">@Async(AsyncConfig.LOG_TASK_EXECUTOR)</span>
    <span class="hljs-meta">@EventListener</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleLoginEvent</span><span class="hljs-params">(LoginEvent event)</span>
    {
        log.debug(<span class="hljs-string">"异步线程[{}] 开始处理登录日志..."</span>, Thread.currentThread().getName());
        <span class="hljs-keyword">try</span>
        {
            <span class="hljs-comment">// 获取登录信息对象</span>
            <span class="hljs-type">SysLogininfor</span> <span class="hljs-variable">logininfor</span> <span class="hljs-operator">=</span> event.getLogininfor();
            <span class="hljs-comment">// 调用服务层方法，将登录日志保存到数据库</span>
            logininforService.insertLogininfor(logininfor);
            log.info(<span class="hljs-string">"用户[{}] 登录日志记录成功。状态: {}"</span>, logininfor.getUserName(), logininfor.getStatus());
        }
        <span class="hljs-keyword">catch</span> (Exception e)
        {
            log.error(<span class="hljs-string">"异步记录登录日志失败：{}"</span>, e.getMessage(), e);
            <span class="hljs-comment">// 可以在这里添加告警通知机制</span>
        }
    }
}
</code></pre>
<h4 data-id="heading-8">5. 在登录服务中发布事件</h4>
<p>最后，在 RuoYi 的登录服务（例如 <code>SysLoginService</code>）中，当用户登录成功或失败后，构建 <code>SysLogininfor</code> 对象，并通过 <code>ApplicationEventPublisher</code> 发布 <code>LoginEvent</code>。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// SysLoginService.java (简化版，仅展示事件发布逻辑)</span>
<span class="hljs-keyword">package</span> com.ruoyi.framework.web.service;

<span class="hljs-keyword">import</span> com.ruoyi.common.constant.Constants;
<span class="hljs-keyword">import</span> com.ruoyi.common.exception.user.CaptchaException;
<span class="hljs-keyword">import</span> com.ruoyi.common.exception.user.UserPasswordNotMatchException;
<span class="hljs-keyword">import</span> com.ruoyi.common.utils.DateUtils;
<span class="hljs-keyword">import</span> com.ruoyi.common.utils.ServletUtils;
<span class="hljs-keyword">import</span> com.ruoyi.framework.event.LoginEvent; <span class="hljs-comment">// 引入 LoginEvent</span>
<span class="hljs-keyword">import</span> com.ruoyi.framework.manager.AsyncManager;
<span class="hljs-keyword">import</span> com.ruoyi.framework.manager.factory.AsyncFactory;
<span class="hljs-keyword">import</span> com.ruoyi.system.domain.SysLogininfor;
<span class="hljs-keyword">import</span> com.ruoyi.system.domain.SysUser;
<span class="hljs-keyword">import</span> com.ruoyi.system.service.ISysConfigService;
<span class="hljs-keyword">import</span> com.ruoyi.system.service.ISysUserService;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.context.ApplicationEventPublisher; <span class="hljs-comment">// 引入事件发布器</span>
<span class="hljs-keyword">import</span> org.springframework.security.authentication.AuthenticationManager;
<span class="hljs-keyword">import</span> org.springframework.security.authentication.BadCredentialsException;
<span class="hljs-keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
<span class="hljs-keyword">import</span> org.springframework.security.core.Authentication;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-comment">/**
 * 登录校验方法
 *
 * <span class="hljs-doctag">@author</span> ruoyi
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SysLoginService</span>
{
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> TokenService tokenService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> AuthenticationManager authenticationManager;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ISysUserService userService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ISysConfigService configService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ApplicationEventPublisher eventPublisher; <span class="hljs-comment">// 注入事件发布器</span>

    <span class="hljs-comment">/**
     * 登录验证
     *
     * <span class="hljs-doctag">@param</span> username 用户名
     * <span class="hljs-doctag">@param</span> password 密码
     * <span class="hljs-doctag">@param</span> code     验证码
     * <span class="hljs-doctag">@param</span> uuid     唯一标识
     * <span class="hljs-doctag">@return</span> 结果
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">login</span><span class="hljs-params">(String username, String password, String code, String uuid)</span>
    {
        <span class="hljs-comment">// ... (省略验证码、账户锁定等其他登录逻辑) ...</span>

        <span class="hljs-type">SysLogininfor</span> <span class="hljs-variable">logininfor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SysLogininfor</span>();
        logininfor.setUserName(username);
        logininfor.setIpaddr(ServletUtils.getIpAddr(ServletUtils.getRequest()));
        logininfor.setLoginLocation(AsyncFactory.getRealAddressByIP(logininfor.getIpaddr()));
        logininfor.setBrowser(ServletUtils.getBrowser());
        logininfor.setOs(ServletUtils.getOs());
        logininfor.setLoginTime(DateUtils.getNowDate());

        Authentication authentication;
        <span class="hljs-keyword">try</span>
        {
            <span class="hljs-comment">// 该方法会去调用UserDetailsServiceImpl.loadUserByUsername</span>
            authentication = authenticationManager
                    .authenticate(<span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernamePasswordAuthenticationToken</span>(username, password));

            <span class="hljs-comment">// 认证成功</span>
            logininfor.setStatus(Constants.SUCCESS);
            logininfor.setMsg(<span class="hljs-string">"登录成功"</span>);
            <span class="hljs-comment">// 发布登录成功事件</span>
            eventPublisher.publishEvent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LoginEvent</span>(<span class="hljs-built_in">this</span>, logininfor));
        }
        <span class="hljs-keyword">catch</span> (Exception e)
        {
            logininfor.setStatus(Constants.FAIL);
            <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> BadCredentialsException || e <span class="hljs-keyword">instanceof</span> UserPasswordNotMatchException)
            {
                logininfor.setMsg(<span class="hljs-string">"用户不存在/密码错误"</span>);
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> CaptchaException)
            {
                logininfor.setMsg(<span class="hljs-string">"验证码错误"</span>);
            }
            <span class="hljs-keyword">else</span>
            {
                logininfor.setMsg(e.getMessage());
            }
            <span class="hljs-comment">// 发布登录失败事件</span>
            eventPublisher.publishEvent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LoginEvent</span>(<span class="hljs-built_in">this</span>, logininfor));
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e.getMessage()); <span class="hljs-comment">// 抛出异常给上层处理</span>
        }
        <span class="hljs-comment">// ... (省略后续生成Token等逻辑) ...</span>
        <span class="hljs-keyword">return</span> token;
    }
}
</code></pre>
<p><strong>代码说明：</strong></p>
<ul>
<li><code>ApplicationEventPublisher</code> 是 Spring 提供的事件发布接口，通过 <code>eventPublisher.publishEvent()</code> 方法可以发布任何继承自 <code>ApplicationEvent</code> 的事件。</li>
<li><code>LoginEvent</code> 包含了所有需要在日志中记录的信息。</li>
<li>当 <code>login</code> 方法中认证成功或失败后，我们立即发布 <code>LoginEvent</code>，而无需等待数据库操作完成。</li>
<li><code>LoginEventListener</code> 上的 <code>@Async</code> 和 <code>@EventListener</code> 会确保 <code>handleLoginEvent</code> 方法在 <code>logTaskExecutor</code> 线程池中异步执行，从而不阻塞主登录流程。</li>
</ul>
<h3 data-id="heading-9">四、测试与效果</h3>
<p>通过上述改造，当用户发起登录请求时：</p>
<ol>
<li>主线程快速完成用户认证和Token生成等核心操作。</li>
<li><code>SysLoginService</code> 发布 <code>LoginEvent</code> 后，立即返回登录结果给前端。</li>
<li>一个独立的线程（来自 <code>logTaskExecutor</code> 线程池）接收到 <code>LoginEvent</code>，并在后台异步执行 <code>logininforService.insertLogininfor()</code> 方法，将登录日志保存到数据库。</li>
</ol>
<p>这种模式下，登录接口的响应速度将主要取决于认证逻辑和Token生成，而不再受数据库I/O的拖累。特别是在数据库压力较大或网络延迟较高的情况下，异步处理的优势将更加明显。</p>
<h3 data-id="heading-10">五、总结</h3>
<p>异步处理登录日志是优化 RuoYi 框架性能的一种有效手段。通过利用 Spring 的 <code>@EnableAsync</code>、自定义线程池、事件发布与监听机制，我们可以轻松地将日志记录这一非核心业务逻辑从主流程中解耦出来，使其在后台异步执行。这不仅提升了用户登录体验，也增强了系统的并发处理能力和整体稳定性。</p>
<p><strong>关键点回顾：</strong></p>
<ul>
<li><strong>问题根源：</strong> 同步数据库I/O是登录性能瓶颈。</li>
<li><strong>解决方案：</strong> 事件驱动 + <code>@Async</code> 异步处理。</li>
<li><strong>代码核心：</strong> <code>LoginEvent</code>、<code>@EnableAsync</code>、自定义 <code>Executor</code>、<code>@Async @EventListener</code>、<code>ApplicationEventPublisher</code>。</li>
</ul>
<p>希望本文能帮助你在 RuoYi 框架的开发中更好地实践异步编程，构建出更高效、更健壮的应用。</p>
<hr/>
<p>`</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Go 通道引用与 close 操作]]></title>    <link>https://juejin.cn/post/7571678674145705994</link>    <guid>https://juejin.cn/post/7571678674145705994</guid>    <pubDate>2025-11-12T15:44:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571678674145705994" data-draft-id="7571662618056015898" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Go 通道引用与 close 操作"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-12T15:44:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Penge666"/> <meta itemprop="url" content="https://juejin.cn/user/1549628692501449"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Go 通道引用与 close 操作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1549628692501449/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Penge666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T15:44:16.000Z" title="Wed Nov 12 2025 15:44:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Go 开发中，通道（chan）的使用频率极高，但它的引用特性和 close 操作的作用范围，往往是新手容易踩坑的点。比如 “通道赋值后关闭原变量，新变量会受影响吗？”“会不会导致内存泄露？”“后续发送数据会不会 panic？”—— 这篇文章就用通俗的语言 + 结论 + 代码验证，把这些问题讲透。</p>
<h2 data-id="heading-0">一、核心结论（先给答案，不绕弯）</h2>
<ol>
<li><code>destChan</code> 不是指针，是「通道引用」：Go 中通道是引用类型（类似 slice、map），变量存储的是指向底层数据结构的引用，而非结构本身。</li>
<li>关闭 <code>source.TaskChan</code> 后，<code>destChan</code> 会受影响，但不是 “被关闭”：close 操作作用于底层通道，所有引用这个通道的变量（包括 <code>destChan</code>）都会感知到 “通道已关闭”。</li>
<li>不会因 <code>destChan</code> 导致内存泄露：只要所有引用（<code>source.TaskChan</code> 和 <code>destChan</code>）都不再被使用，底层通道会被 GC 回收；真正需要警惕的是 “关闭通道后的发送 panic”。</li>
</ol>
<h2 data-id="heading-1">二、逐点拆解：把原理讲明白</h2>
<h3 data-id="heading-2">1. 通道是 “引用类型”，不是指针但行为类似</h3>
<p>Go 中的引用类型（chan/slice/map/func/interface）有个共性：变量存储的是「指向底层对象的地址」，赋值操作只会复制这个地址，不会复制底层对象。</p>
<p>举个实际场景的例子：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 假设 source 是一个自定义结构体，TaskChan 是已初始化的 chan string</span>
<span class="hljs-keyword">type</span> Resource <span class="hljs-keyword">struct</span> {
    TaskChan <span class="hljs-keyword">chan</span> <span class="hljs-type">string</span> <span class="hljs-comment">// 通道字段</span>
}

<span class="hljs-keyword">var</span> source = Resource{
    TaskChan: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">string</span>, <span class="hljs-number">5</span>), <span class="hljs-comment">// 初始化带缓冲通道</span>
}

<span class="hljs-comment">// 赋值操作：将 source.TaskChan 赋值给 destChan</span>
destChan := source.TaskChan
</code></pre>
<p>执行后，<code>destChan</code> 和 <code>source.TaskChan</code> 持有同一个底层通道的引用 —— 就像两个遥控器控制同一个电视，操作任何一个，影响的都是同一个 “底层设备”。</p>
<p>这里要注意：<code>destChan</code> 不是 <code>*chan string</code>（通道指针），而是 <code>chan string</code>（通道引用类型），语法上不需要解引用（<code>*</code>）就能直接使用，比指针更简洁。</p>
<h3 data-id="heading-3">2. close 操作作用于 “底层通道”，所有引用都会感知</h3>
<p>当我们执行 <code>close(source.TaskChan)</code> 时，要明确一个关键：<strong>关闭的是底层的通道对象，不是 <code>source.TaskChan</code> 这个变量本身</strong>。</p>
<p>因为 <code>destChan</code> 和 <code>source.TaskChan</code> 指向同一个底层通道，所以 <code>destChan</code> 会变成 “指向已关闭通道的引用”—— 此时会有两个核心影响：</p>
<ul>
<li>往 <code>destChan</code> 发送数据：直接 panic（错误信息：<code>send on closed channel</code>）；</li>
<li>从 <code>destChan</code> 接收数据：会立即返回通道元素的零值 + <code>ok=false</code>（表示通道已关闭且无数据）。</li>
</ul>
<p>可以用一个通俗的比喻理解：两个指针指向同一个文件，关闭文件后，两个指针都无法再写入文件，但指针变量本身还存在（不是 nil），只是失去了有效操作的能力。</p>
<h3 data-id="heading-4">3. 内存泄露风险：几乎不存在，无需过度担心</h3>
<p>内存泄露的核心是 “底层对象被无用的引用持有，无法被 GC 回收”，但在这个场景中，完全不需要担心：</p>
<ul>
<li><code>destChan</code> 通常是局部变量（比如在函数或回调中定义），函数执行完毕后，变量会被销毁，引用自然释放；</li>
<li><code>source.TaskChan</code> 是结构体字段，当 <code>source</code> 结构体被销毁（比如任务执行结束后），这个引用也会消失；</li>
<li>只要所有引用都释放，无论底层通道是否关闭，都会被 GC 回收，不会造成内存泄露。</li>
</ul>
<p>唯一可能的泄露场景：如果 <code>source</code> 是全局变量（长期存在），且通道被关闭后，<code>source.TaskChan</code> 仍被持有，但这是 <code>source</code> 的生命周期管理问题，和 <code>destChan</code> 无关。</p>
<h2 data-id="heading-5">三、代码验证：直观感受引用与 close 的影响</h2>
<p>光说不练假把式，用一段简单的代码验证上面的结论，跑起来就能直观看到效果：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 1. 初始化一个通道（底层通道对象在堆上分配）</span>
    sourceChan := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">string</span>, <span class="hljs-number">1</span>)
    fmt.Printf(<span class="hljs-string">"sourceChan 变量本身地址（栈上）：%p\n"</span>, &amp;sourceChan)
    fmt.Printf(<span class="hljs-string">"sourceChan 引用的底层通道地址（堆上）：%p\n"</span>, sourceChan)

    <span class="hljs-comment">// 2. 赋值给 destChan：复制引用</span>
    destChan := sourceChan
    fmt.Printf(<span class="hljs-string">"destChan 变量本身地址（栈上）：%p\n"</span>, &amp;destChan)
    fmt.Printf(<span class="hljs-string">"destChan 引用的底层通道地址（堆上）：%p\n"</span>, destChan)

    <span class="hljs-comment">// 3. 关闭 sourceChan（实际关闭的是底层通道）</span>
    <span class="hljs-built_in">close</span>(sourceChan)

    <span class="hljs-comment">// 4. destChan 感知到底层通道已关闭</span>
    data, ok := &lt;-destChan
    fmt.Printf(<span class="hljs-string">"从 destChan 接收数据：data=%q, ok=%v（ok=false 表示通道已关闭）\n"</span>, data, ok)

    <span class="hljs-comment">// 5. 往 destChan 发送数据会直接 panic（注释掉可避免运行报错）</span>
    <span class="hljs-comment">// destChan &lt;- "test" // 执行后报错：panic: send on closed channel</span>
}
</code></pre>
<h3 data-id="heading-6">运行结果：</h3>
<pre><code class="hljs language-plaintext" lang="plaintext">sourceChan 变量本身地址（栈上）：0xc0000a6020
sourceChan 引用的底层通道地址（堆上）：0xc0000b4000
destChan 变量本身地址（栈上）：0xc0000a6040
destChan 引用的底层通道地址（堆上）：0xc0000b4000
从 destChan 接收数据：data="", ok=false（ok=false 表示通道已关闭）
</code></pre>
<h3 data-id="heading-7">结论验证：</h3>
<ul>
<li><code>sourceChan</code> 和 <code>destChan</code> 是不同的变量（栈地址不同），但引用同一个底层通道（堆地址相同）；</li>
<li>关闭 <code>sourceChan</code> 后，<code>destChan</code> 能直接感知到通道关闭；</li>
<li>关闭后的通道发送数据会 panic，这是核心风险点。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[初见 Dart：这门新语言如何让你的 App「动」起来？]]></title>    <link>https://juejin.cn/post/7571641339688845312</link>    <guid>https://juejin.cn/post/7571641339688845312</guid>    <pubDate>2025-11-12T11:03:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571641339688845312" data-draft-id="7571636682695278632" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="初见 Dart：这门新语言如何让你的 App「动」起来？"/> <meta itemprop="keywords" content="Flutter,Android,iOS"/> <meta itemprop="datePublished" content="2025-11-12T11:03:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="全栈派森"/> <meta itemprop="url" content="https://juejin.cn/user/430664289093176"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            初见 Dart：这门新语言如何让你的 App「动」起来？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/430664289093176/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    全栈派森
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T11:03:51.000Z" title="Wed Nov 12 2025 11:03:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好,我是<code>Petter Guo</code> <br/></p>
<p>一位热爱<code>探索</code>的<code>全栈工程师</code>。在这里，我将分享<code>个人</code>的<code>Technical essentials</code>，带你玩转<code>前端</code>、<code>后端</code>到 <code>DevOps</code> 的硬核技术，解锁<code>AI</code>，助你打通技术任督二脉，成为真正的<code>全能玩家</code>!！<br/></p>
<p>如果对你有帮助, 请<code>点赞</code>+ <code>收藏</code> +<code>关注</code>鼓励下, 学习公众号为 <code>全栈派森</code>。 <br/></p>
<p>时间过的好快, 本人接触业务比较复杂, 最近一直在搞跨平台相关的技术, 比如很火的两大框架 Flutter &amp; ReactNative, 本期你将有如下收获:</p>
<ol>
<li>🍰 Flutter底层架构</li>
<li>🍦 Flutter核心组件</li>
<li>⛽️ Dart常用语法</li>
<li>🙋 Flutter vs RN</li>
</ol>
<h3 data-id="heading-0">Flutter底层架构</h3>
<ol>
<li>
<p>顶层：框架层 (The Framework)</p>
<p>这一层完全由 <strong>Dart 语言</strong> 编写，是我们作为开发者直接打交道的部分。</p>
</li>
</ol>
<ul>
<li><strong>Dart Platform:</strong> 包含 Dart 语言、核心库和 Dart VM（虚拟机）。</li>
<li><strong>Widgets (组件)：</strong> Flutter 的核心概念。所有的 UI 都是由 Widget 组成的，它描述了 UI 的一部分应该如何渲染和交互。</li>
<li><strong>基础 Widgets：</strong> 如 <code>Text</code>, <code>Image</code>, <code>Row</code>, <code>Column</code> 等。</li>
<li><strong>渲染 Widgets：</strong>
<ul>
<li><strong>Material Design:</strong> 实现 Google 的 Material 设计规范（如 <code>Scaffold</code>, <code>AppBar</code>）。</li>
<li><strong>Cupertino:</strong> 实现 Apple 的 iOS 设计规范。</li>
</ul>
</li>
<li><strong>Rendering (渲染):</strong> 提供了抽象的渲染模型，包括 <code>RenderObject</code>、布局、绘制等。</li>
<li><strong>Animation, Gestures &amp; Painting:</strong> 处理动画、手势识别和底层绘图逻辑。</li>
</ul>
<blockquote>
<p><strong>核心思想：</strong> Flutter 框架只提供 <strong>抽象的 UI 组件</strong> 和 <strong>一套渲染规范</strong>。</p>
</blockquote>
<ol start="2">
<li>
<p>中间层：引擎层 (The Engine)</p>
<p>这一层主要由 <strong>C++</strong> 编写，它负责执行 Dart 运行时环境，并将上层的 Dart 代码渲染到萤幕上。</p>
</li>
</ol>
<ul>
<li><strong>Skia 引擎 (Skia Graphics Engine):</strong> 这是 Flutter 最关键的部分。 Skia 是一个高性能的 2D 渲染引擎，也是 Chrome 和 Android 采用的图形库。 <strong>Flutter 依靠 Skia 在移动设备上绘制每一个像素</strong>。</li>
<li><strong>优势：</strong> 这使得 Flutter <strong>完全绕过了</strong> 原生 OEM（原始设备制造商）的 UI 组件。应用程式只需一个「画布」，所有的按钮、文本、动画都由 Skia 直接绘制。</li>
<li><strong>Dart Runtime：</strong> Dart 虚拟机（VM）和 AOT/JIT 编译器，负责运行 Dart 代码。</li>
<li><strong>Text Layout:</strong> 处理文本布局和字体渲染。</li>
<li><strong>Platform Channels (平台通道):</strong> 实现 Dart 代码与原生平台（如 iOS 的 Swift/Objective-C 或 Android 的 Java/Kotlin）之间的通信。这是 Flutter 访问原生 API（如 GPS、蓝牙）的唯一途径。</li>
</ul>
<blockquote>
<p><strong>核心思想：</strong> 引擎层是 <strong>底层执行者</strong>，负责将 Dart 的指令翻译成像素并绘制出来。</p>
</blockquote>
<ol start="3">
<li>
<p>底层：嵌入层 (The Embedder)</p>
<p>这是与 <strong>特定操作系统（OS）</strong> 交互的层级。</p>
</li>
</ol>
<ul>
<li><strong>平台特定的程式码：</strong> 这部分是 Dart 运行时和底层 OS 之间粘合剂。</li>
<li><strong>Android:</strong> 使用 Java/Kotlin，将 Flutter 引擎作为 <code>Activity</code> 嵌入。</li>
<li><strong>iOS:</strong> 使用 Swift/Objective-C，将 Flutter 引擎作为 <code>ViewController</code> 嵌入。</li>
<li><strong>访问原生 API：</strong> 嵌入层提供了底层的系统服务、生命周期事件、输入事件（触摸、滑鼠）等。</li>
</ul>
<blockquote>
<p><strong>核心思想：</strong> 嵌入层是 <strong>宿主</strong>，负责提供一个原生环境来运行和承载 Flutter 引擎。</p>
</blockquote>
<h3 data-id="heading-1">Flutter优势</h3>
<p>这种分层架构带来了以下独特的优势：</p>
<ol>
<li><strong>高性能 (High Performance):</strong> 由于 Dart 代码可以 <strong>AOT (Ahead-of-Time)</strong> 编译成高效的 ARM 机器码，再加上直接使用 Skia 引擎渲染，性能可以<strong>媲美原生应用</strong>。</li>
<li><strong>UI 一致性 (UI Consistency):</strong> 由于不依赖原生系统的 UI，Flutter 应用在​​任何版本或型号的设备上都能保持<strong>像素级的一致性</strong>。</li>
<li><strong>消除 Bridge 瓶颈 (No Bridge):</strong> Flutter 不使用 React Native 那样的 JSON 异步 Bridge，所有的 UI 逻辑都在 Dart VM 中运行，避免了序列化和跨线程通信的开销。</li>
</ol>
<h3 data-id="heading-2">Flutter核心组件</h3>
<h4 data-id="heading-3">1. 📂 布局与结构 Widgets (Layout &amp; Structure)</h4>















































<table><thead><tr><th align="left">Widget</th><th align="left">作用</th><th align="left">关键属性</th><th align="left">示例场景</th></tr></thead><tbody><tr><td align="left"><strong>Scaffold</strong></td><td align="left">脚手架。提供应用程式的基本结构，如抽屉、底部导航栏、浮动按钮等。</td><td align="left"><code>appBar</code>, <code>body</code>, <code>drawer</code>, <code>bottomNavigationBar</code></td><td align="left">每个页面/屏幕的顶层 Widget。</td></tr><tr><td align="left"><strong>Container</strong></td><td align="left">容器。最基础的布局/装饰 Widget，用于添加边距、填充、颜色、装饰等。</td><td align="left"><code>child</code>, <code>padding</code>, <code>margin</code>, <code>color</code>, <code>decoration</code></td><td align="left">给子 Widget 设置背景色和边距。</td></tr><tr><td align="left"><strong>Row / Column</strong></td><td align="left">行/列。在水平 (<code>Row</code>) 或垂直 (<code>Column</code>) 方向上排列多个子 Widget。</td><td align="left"><code>children</code> (Widget 列表), <code>mainAxisAlignment</code>, <code>crossAxisAlignment</code></td><td align="left">实现线性布局。</td></tr><tr><td align="left"><strong>Center</strong></td><td align="left">居中。将其子 Widget 居中放置。</td><td align="left"><code>child</code></td><td align="left">将单个元素放在萤幕中央。</td></tr><tr><td align="left"><strong>Padding</strong></td><td align="left">填充。在其子 Widget 周围添加内部间距（填充）。</td><td align="left"><code>padding</code> (通常使用 <code>EdgeInsets.all</code> 等)</td><td align="left">调整 Widget 内部空间。</td></tr><tr><td align="left"><strong>SizedBox</strong></td><td align="left">尺寸。用于控制子 Widget 的大小或简单地创建空白间距。</td><td align="left"><code>width</code>, <code>height</code>, <code>child</code></td><td align="left">创建两个 Widget 之间的固定间隔。</td></tr></tbody></table>
<h4 data-id="heading-4">2. 🧱 基础内容与交互 Widgets (Content &amp; Interaction)</h4>















































<table><thead><tr><th align="left">Widget</th><th align="left">作用</th><th align="left">关键属性</th><th align="left">示例场景</th></tr></thead><tbody><tr><td align="left"><strong>Text</strong></td><td align="left">文本。用于显示静态文本。</td><td align="left"><code>data</code> (文本内容), <code>style</code> (TextStyle), <code>textAlign</code></td><td align="left">显示标题、描述、正文。</td></tr><tr><td align="left"><strong>Image</strong></td><td align="left">图片。用于显示图片，支持本地资源、文件或网路图片。</td><td align="left"><code>image</code> (Asset/NetworkImage), <code>fit</code>, <code>width</code>, <code>height</code></td><td align="left">显示应用 Logo、用户头像、网路图片。</td></tr><tr><td align="left"><strong>Icon</strong></td><td align="left">图标。用于显示 Material 或 Cupertino 图标。</td><td align="left"><code>icon</code> (Icons.xxx), <code>color</code>, <code>size</code></td><td align="left">菜单图标、操作按钮图标。</td></tr><tr><td align="left"><strong>ElevatedButton</strong></td><td align="left">按钮。带有阴影效果的凸起按钮。</td><td align="left"><code>onPressed</code> (点击回调), <code>child</code></td><td align="left">提交表单、执行操作。</td></tr><tr><td align="left"><strong>TextField</strong></td><td align="left">文本输入框。用于接收用户输入。</td><td align="left"><code>controller</code>, <code>decoration</code> (InputDecoration), <code>onChanged</code>, <code>keyboardType</code></td><td align="left">用户名/密码输入、搜寻框。</td></tr><tr><td align="left"><strong>ListView</strong></td><td align="left">列表。用于垂直滚动的长列表，<strong>只渲染可见部分</strong>（性能优化）。</td><td align="left"><code>children</code> 或 <code>itemBuilder</code> (Factory 模式)</td><td align="left">显示新闻列表、聊天记录。</td></tr></tbody></table>
<h4 data-id="heading-5">3. 🔄 状态管理与动态 Widgets (State Management)</h4>























<table><thead><tr><th align="left">Widget</th><th align="left">作用</th><th align="left">区别</th><th align="left">示例场景</th></tr></thead><tbody><tr><td align="left"><strong>StatelessWidget</strong></td><td align="left">无状态 Widget。一旦创建，它的属性（数据）就不会改变。</td><td align="left">数据是固定的 (<code>final</code>)，没有内部状态。</td><td align="left">显示静态文本、Logo、静态图标。</td></tr><tr><td align="left"><strong>StatefulWidget</strong></td><td align="left">有状态 Widget。其内部数据可以在 Widget 生命周期内发生变化。</td><td align="left">包含一个 <code>State</code> 对象，通过调用 <strong><code>setState()</code></strong> 来触发 UI 重新绘制。</td><td align="left">带有计数器的按钮、复选框、动态列表。</td></tr></tbody></table>
<h3 data-id="heading-6">✍️ Dart 常用语法特性</h3>
<p>Flutter 使用 Dart 语言，它是一种面向对象、类基的语言，同时支持 AOT（编译成机器码）和 JIT（即时编译，用于热重载）。</p>
<h4 data-id="heading-7">1. 类型与变量</h4>
<ul>
<li><strong>类型推断：</strong> 大多数时候可以使用 <code>var</code>，Dart 会自动推断类型。</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">var</span> name = <span class="hljs-string">'Alice'</span>; <span class="hljs-comment">// String</span>
<span class="hljs-keyword">var</span> year = <span class="hljs-number">1977</span>;   <span class="hljs-comment">// int</span>
</code></pre>
<ul>
<li><strong>明确类型：</strong> 也可以明确声明。</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-built_in">String</span> name = <span class="hljs-string">'Bob'</span>;
<span class="hljs-built_in">int</span> age = <span class="hljs-number">30</span>;
</code></pre>
<ul>
<li><strong>不变性 (Immutability)：</strong></li>
<li><code>final</code>: 运行时常量，只能赋值一次。</li>
<li><code>const</code>: 编译时常量，在编译时就确定值。</li>
</ul>

<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> uid = getUserId(); <span class="hljs-comment">// 运行时确定</span>
<span class="hljs-keyword">const</span> PI = <span class="hljs-number">3.14159</span>;             <span class="hljs-comment">// 编译时确定</span>
</code></pre>
<ul>
<li><strong>可空类型 (Null Safety)：</strong> 这是 Dart 2.12+ 的重要特性。</li>
<li><code>String?</code>: 变量可以是 <code>String</code> 类型，也可以是 <code>null</code>。</li>
<li><code>String</code>: 变量<strong>不能</strong>是 <code>null</code>。</li>
<li><code>!</code> (断言): 告诉编译器「我相信它不是 null」。</li>
</ul>
<h4 data-id="heading-8">2. 函数与箭头语法</h4>
<ul>
<li><strong>普通函数：</strong></li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-built_in">int</span> add(<span class="hljs-built_in">int</span> a, <span class="hljs-built_in">int</span> b) {
  <span class="hljs-keyword">return</span> a + b;
}
</code></pre>
<ul>
<li><strong>箭头函数：</strong> 适用于只有单个表达式的函数。</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-built_in">int</span> multiply(<span class="hljs-built_in">int</span> a, <span class="hljs-built_in">int</span> b) =&gt; a * b;
</code></pre>
<h4 data-id="heading-9">3. 构造函数 (Constructors)</h4>
<p>Dart 提供了强大的构造函数语法，常在 Flutter Widget 中使用：</p>
<ul>
<li><strong>简化赋值：</strong> 直接在构造函数中为实例变量赋值。</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> name;
  Person(<span class="hljs-keyword">this</span>.name); <span class="hljs-comment">// 简洁地将参数赋值给 name</span>
}
</code></pre>
<ul>
<li><strong>命名构造函数：</strong> 创建多个、有特定用途的构造函数。</li>
</ul>
<pre><code class="hljs language-dart" lang="dart">Person.fromJson(<span class="hljs-built_in">Map</span> data) {
<span class="hljs-comment">// ...</span>
}
</code></pre>
<ul>
<li><strong>工厂构造函数 (Factory):</strong> 用于复杂的对象创建逻辑（如单例模式或返回子类型）。</li>
</ul>
<h4 data-id="heading-10">4. 异步编程 (Asynchrony)</h4>
<p>Dart 使用 <code>Future</code> 和 <code>async/await</code> 处理异步操作（如网路请求）。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 声明函数是异步的</span>
Future&lt;<span class="hljs-built_in">String</span>&gt; fetchData() <span class="hljs-keyword">async</span> {
  <span class="hljs-comment">// 使用 await 等待结果，代码看起来像同步一样</span>
  <span class="hljs-keyword">var</span> response = <span class="hljs-keyword">await</span> httpClient.<span class="hljs-keyword">get</span>(<span class="hljs-string">'...'</span>);
  <span class="hljs-keyword">return</span> response.body;
}
</code></pre>
<h3 data-id="heading-11">Flutter vs RN</h3>
<h3 data-id="heading-12">1. ⚛️ React Native (JS + Bridge + 原生元件)</h3>
<ul>
<li><strong>技术栈：</strong> JavaScript / TypeScript + React。</li>
<li><strong>工作原理：</strong> React Native 依赖于一个 <strong>Bridge（桥接器）</strong>，将 JavaScript 逻辑转换为原生操作。它使用 <strong>原生 UI 元件</strong>（如 Android 的 <code>TextView</code>，iOS 的 <code>UILabel</code>）进行渲染。</li>
<li><strong>优势：</strong> 能够提供完全的原生体验，因为它使用的就是平台自带的 UI 元素。可以充分利用现有的原生代码和生态。</li>
<li><strong>瓶颈：</strong> Bridge 的 <strong>JSON 序列化与异步传输</strong> 带来性能开销，尤其在高频度交互或动画时，容易造成卡顿。</li>
</ul>
<h3 data-id="heading-13">2. 🐦 Flutter (Dart + Skia 引擎 + 自绘元件)</h3>
<ul>
<li><strong>技术栈：</strong> Dart 语言。</li>
<li><strong>工作原理：</strong> Flutter 跳过了原生 UI 元件和 Bridge。它自带一个高效的 <strong>Skia 图形渲染引擎</strong>。应用程式启动时，Flutter 创建一个 Canvas（画布），然后在上面用 Dart 代码直接绘制 <strong>自定义的 Widget</strong>。</li>
<li><strong>优势：</strong> <strong>接近原生的性能</strong>，因为它被编译成 ARM 机器码。 UI 表现力强，因为它不依赖原生系统的 UI，实现了 <strong>像素级的控制</strong>。</li>
<li><strong>瓶颈：</strong> 文件体积较大，且没有使用平台原生的 UI 元素，在某些极度依赖原生系统风格的应用上可能显得突兀。</li>
</ul>
<hr/>
<h2 data-id="heading-14">二、选择决策矩阵：五个关键维度</h2>









































<table><thead><tr><th align="left">决策维度</th><th align="left">Flutter (Dart)</th><th align="left">React Native (JS/TS)</th><th align="left">选择建议</th></tr></thead><tbody><tr><td align="left"><strong>1. 团队现有技能</strong></td><td align="left">需要学习 <strong>Dart 语言</strong> 和 Flutter 框架的思维模式。</td><td align="left">技能门槛低，可以重用 <strong>React/Web 前端</strong> 团队的大部分经验。</td><td align="left"><strong>前端背景强</strong>：选 RN；<strong>无历史包袱或有原生背景</strong>：选 Flutter。</td></tr><tr><td align="left"><strong>2. 性能与 UI 复杂度</strong></td><td align="left">性能优异，因其编译为原生机器码，且自绘引擎消除了 Bridge 瓶颈。</td><td align="left">性能良好，但在复杂动画和高频交互上可能因 Bridge 而略输 Flutter。</td><td align="left"><strong>对性能要求极高、复杂动画</strong>：选 Flutter；<strong>标准业务应用</strong>：RN 足够。</td></tr><tr><td align="left"><strong>3. 生态系统与第三方库</strong></td><td align="left"><strong>较新</strong>，社群成长快，但第三方库的数量和成熟度不如 RN。</td><td align="left"><strong>极其庞大和成熟</strong>，大量库可供选择。与原生生态桥接成熟。</td><td align="left"><strong>依赖大量现有轮子</strong>：选 RN；<strong>愿意自建或 Bridge 原生代码</strong>：选 Flutter。</td></tr><tr><td align="left"><strong>4. 开发效率与热重载</strong></td><td align="left">优秀的 <strong>Hot Reload</strong>，但在 <strong>Native Code</strong> 变更时需重新编译。</td><td align="left">拥有 <strong>Fast Refresh</strong>，JS 代码更新极快。原生代码变更也需重新编译。</td><td align="left"><strong>基本持平</strong>；RN 在 JS 迭代上更胜一筹。</td></tr><tr><td align="left"><strong>5. 多平台支持</strong></td><td align="left"><strong>广泛：</strong> iOS, Android, Web, Desktop (Windows, macOS, Linux)。</td><td align="left"><strong>主流：</strong> iOS, Android；Web 需额外使用 React Native for Web。</td><td align="left"><strong>未来可能扩展到桌面端</strong>：选 Flutter；<strong>专注于移动端</strong>：RN 足够。</td></tr></tbody></table>
<p>滑到这里定然有所收获 ⛽️⛽️</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从定时器到 Promise：一次 JS 异步编程的进阶之旅]]></title>    <link>https://juejin.cn/post/7571637614203633691</link>    <guid>https://juejin.cn/post/7571637614203633691</guid>    <pubDate>2025-11-12T11:08:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571637614203633691" data-draft-id="7571644531608469550" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从定时器到 Promise：一次 JS 异步编程的进阶之旅"/> <meta itemprop="keywords" content="JavaScript,面试"/> <meta itemprop="datePublished" content="2025-11-12T11:08:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="T___T"/> <meta itemprop="url" content="https://juejin.cn/user/1599155645973066"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从定时器到 Promise：一次 JS 异步编程的进阶之旅
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1599155645973066/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    T___T
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T11:08:16.000Z" title="Wed Nov 12 2025 11:08:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在学习 JavaScript 的过程中，我们经常会听到“<strong>JS 是单线程语言</strong>”、“<strong>异步操作</strong>”、“<strong>Promise 控制流程</strong>”等概念。它们听起来高深，但其实都是理解 JavaScript 运行机制的关键。本文将从最基础的同步与异步入手，逐步讲清楚 <strong>为什么需要异步</strong>、<strong>异步是如何执行的</strong>、以及 <strong>Promise 是如何让异步代码更优雅地运行的</strong>。</p>
<hr/>
<h2 data-id="heading-0">一、JS 是单线程语言</h2>
<p>JavaScript 是一种<strong>单线程</strong>语言，也就是说，它在同一时刻只能执行一段代码。<br/>
举个简单的例子：</p>
<pre><code class="hljs language-arduino" lang="arduino">console.<span class="hljs-built_in">log</span>(<span class="hljs-number">1</span>);
console.<span class="hljs-built_in">log</span>(<span class="hljs-number">2</span>);
console.<span class="hljs-built_in">log</span>(<span class="hljs-number">3</span>);
</code></pre>
<p>运行结果非常直观：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-number">1</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">2</span> <span class="hljs-punctuation">-&gt;</span><span class="hljs-number">3</span>
</code></pre>
<p>JavaScript 会<strong>从上到下、逐行执行</strong>，这就是 <strong>同步执行</strong>。</p>
<hr/>
<h2 data-id="heading-1">二、为什么需要异步？</h2>
<p>问题在于：当代码中出现“耗时操作”时，例如：</p>
<ul>
<li>读取文件（I/O 操作）</li>
<li>发送网络请求（fetch / ajax）</li>
<li>定时器（setTimeout）</li>
</ul>
<p>如果这些操作是同步的，那么 JS 会<strong>卡死等待结果</strong>，导致页面无法响应用户点击、滚动等操作。</p>
<p>于是，JavaScript 设计了“<strong>异步机制</strong>”：<br/>
耗时的任务不阻塞主线程，而是交给浏览器或 Node.js 的底层去处理，等任务完成后再通知 JS 主线程执行回调函数。</p>
<hr/>
<h2 data-id="heading-2">三、setTimeout：最经典的异步例子</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>);
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">2</span>);
}, <span class="hljs-number">1000</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">3</span>);
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>执行结果为：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-number">1</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">3</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">2</span>
</code></pre>
<p>解释：</p>
<ol>
<li><code>console.log(1)</code> 立即执行。</li>
<li><code>setTimeout</code> 被识别为一个“异步任务”，交给 <strong>浏览器的定时器线程</strong> 去计时。</li>
<li>JS 主线程继续往下执行 <code>console.log(3)</code>。</li>
<li>当计时结束后，回调函数被放入 <strong>事件队列（Event Queue）</strong> 。</li>
<li>主线程空闲时通过 <strong>事件循环（Event Loop）</strong> 取出该回调并执行，于是打印 <code>2</code>。</li>
</ol>
<hr/>
<h2 data-id="heading-3">四、事件循环（Event Loop）简要说明</h2>
<p>事件循环是浏览器或 Node.js 实现异步的核心机制。</p>
<ul>
<li>JS 主线程执行同步代码；</li>
<li>异步任务交给浏览器处理；</li>
<li>当异步任务完成后，其回调函数被放入“任务队列”；</li>
<li>一旦主线程空闲，事件循环会取出这些任务并执行。</li>
</ul>
<p>简单来说：</p>
<blockquote>
<p>同步 → 先执行<br/>
异步 → 等主线程空闲再执行</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">五、Promise：让异步更优雅</h2>
<p>在早期，异步常常通过**回调函数（callback）**实现，但当多个异步操作需要依次执行时，就会出现“<strong>回调地狱</strong>”：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'任务1'</span>);
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'任务2'</span>);
  }, <span class="hljs-number">1000</span>);
}, <span class="hljs-number">1000</span>);
</code></pre>
<p>可读性差、难以维护。<br/>
为了解决这个问题，ES6 引入了 <strong>Promise</strong>。</p>
<hr/>
<h2 data-id="heading-5">六、Promise 的基本使用</h2>
<p>看下面的例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>);

<span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">resolve</span>) {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">2</span>);
    <span class="hljs-title function_">resolve</span>();
  }, <span class="hljs-number">3000</span>);
});

p.<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">3</span>);
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">4</span>);
</code></pre>
<p>输出结果：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-number">1</span><span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">4</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">2</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">3</span>
</code></pre>
<p>分析执行顺序：</p>
<ol>
<li><code>console.log(1)</code>：同步执行。</li>
<li><code>new Promise(...)</code>：立即执行里面的函数（称为 <strong>executor</strong>），但其中的 <code>setTimeout</code> 是异步操作。</li>
<li><code>console.log(4)</code>：继续执行同步任务。</li>
<li>3 秒后，<code>setTimeout</code> 的回调执行，打印 <code>2</code>，同时调用 <code>resolve()</code>。</li>
<li><code>resolve()</code> 触发 <code>then</code> 方法中的回调，打印 <code>3</code>。</li>
</ol>
<p>可以看到，Promise 让异步代码的执行顺序更清晰，结构也更优雅。</p>
<hr/>
<h2 data-id="heading-6">七、结合 Node.js 的异步 I/O 示例</h2>
<p>在 Node.js 中，文件读取就是典型的异步操作：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">'fs'</span>;

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>);

<span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">resolve, reject</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">3</span>); <span class="hljs-comment">// 同步执行</span>
  fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'./b.txt'</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (err) {
      <span class="hljs-title function_">reject</span>(err);
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-title function_">resolve</span>(data.<span class="hljs-title function_">toString</span>());
  });
});

p.<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data, <span class="hljs-string">'//////'</span>);
}).<span class="hljs-title function_">catch</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err, <span class="hljs-string">'读取文件失败'</span>);
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">2</span>);
</code></pre>
<p>执行顺序：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-number">1</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">3</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">2</span> <span class="hljs-punctuation">-&gt;</span> &lt;文件内容&gt; <span class="hljs-comment">///////</span>
</code></pre>
<p>解释：</p>
<ul>
<li><code>fs.readFile</code> 是 Node 的异步 I/O 操作；</li>
<li>读取文件的任务被交给系统底层；</li>
<li>主线程不会等待；</li>
<li>当读取完成后，通过事件循环回到主线程执行 <code>.then()</code>。</li>
</ul>
<hr/>
<h2 data-id="heading-7">八、fetch 与异步请求</h2>
<p>浏览器端的 <code>fetch</code> 也是基于 Promise 的异步操作。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.github.com/orgs/lemoncode/members'</span>));
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>🧠<code>fetch()</code> 返回的是一个 Promise 对象。我们可以使用 <code>.then()</code> 来获取返回的数据：</p>
<pre><code class="hljs language-ini" lang="ini">fetch('https://api.github.com/orgs/lemoncode/members')
  .then(<span class="hljs-attr">res</span> =&gt; res.json())
  .then(<span class="hljs-attr">data</span> =&gt; {
    document.getElementById('member').<span class="hljs-attr">innerHTML</span> =
      data.map(<span class="hljs-attr">item</span> =&gt; `&lt;li&gt;<span class="hljs-variable">${item.login}</span>&lt;/li&gt;`).join(<span class="hljs-string">''</span>)<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h2 data-id="heading-8">九、总结</h2>






























<table><thead><tr><th>概念</th><th>含义</th><th>示例</th></tr></thead><tbody><tr><td><strong>同步代码</strong></td><td>从上到下顺序执行</td><td><code>console.log()</code></td></tr><tr><td><strong>异步代码</strong></td><td>延后执行，不阻塞主线程</td><td><code>setTimeout</code>、<code>fetch</code>、<code>fs.readFile</code></td></tr><tr><td><strong>事件循环</strong></td><td>调度同步和异步任务</td><td>异步任务完成后放入任务队列等待执行</td></tr><tr><td><strong>Promise</strong></td><td>用于优雅地处理异步</td><td><code>.then()</code>、<code>.catch()</code></td></tr></tbody></table>
<blockquote>
<p>🧩<strong>一句话总结：</strong><br/>
JavaScript 虽然是单线程的，但通过事件循环和 Promise 等机制，实现了强大的异步能力，让我们能够同时处理多个任务，而不影响页面或程序的流畅运行。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[让Qwen-VL的检测能力像YOLO一样强，VLM-FO1如何打通大模型的视觉任督二脉]]></title>    <link>https://juejin.cn/post/7571678763782258722</link>    <guid>https://juejin.cn/post/7571678763782258722</guid>    <pubDate>2025-11-13T01:53:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571678763782258722" data-draft-id="7571702660933173263" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="让Qwen-VL的检测能力像YOLO一样强，VLM-FO1如何打通大模型的视觉任督二脉"/> <meta itemprop="keywords" content="算法,计算机视觉,深度学习"/> <meta itemprop="datePublished" content="2025-11-13T01:53:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            让Qwen-VL的检测能力像YOLO一样强，VLM-FO1如何打通大模型的视觉任督二脉
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T01:53:33.000Z" title="Thu Nov 13 2025 01:53:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在当今多模态大模型（VLMs）飞速发展的时代，一个令人尴尬的问题依然存在：<strong>为什么这些能看懂图像、生成描述的模型，却难以精确地定位图像中的物体？</strong></p>
<p>答案在于一个根本性矛盾：让一个为语言生成而设计的模型，去输出精确的浮点数坐标，就像让一位诗人去做微积分——虽然都是处理“符号”，但思维方式截然不同。</p>
<h2 data-id="heading-0"><strong>坐标生成的困境</strong></h2>
<p>现有的多模态大模型在生成边界框时面临两大挑战：</p>
<ul>
<li><strong>格式敏感性：</strong> 一个坐标值的轻微偏差就可能导致整个检测框无效</li>
<li><strong>多实例处理困难：</strong> 长序列的坐标生成容易超出模型的注意力范围</li>
</ul>
<p>结果就是，即使在COCO这样的标准检测数据集上，顶尖的开源VLM模型召回率也不到40%，远低于专用检测器50-60%的水平。</p>
<h2 data-id="heading-1"><strong>VLM-FO1的突破</strong></h2>
<p>浙江大学与Om AI Research团队提出的VLM-FO1框架带来了全新的思路：与其让大模型艰难地生成坐标，不如让它直接理解区域内容。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65ae036ea023406eb4b2efbe03c5d8ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=27TiYCFvcdynPSN933hXx7aapo8%3D" alt="screenshot_2025-11-12_11-28-02.png" loading="lazy"/></p>
<h2 data-id="heading-2"><strong>核心创新</strong></h2>
<ul>
<li><strong>即插即用的模块化设计</strong></li>
</ul>
<p>VLM-FO1不需要重新训练整个大模型，而是作为一个增强模块接入现有的预训练VLM。这意味着开发者可以快速为已有模型赋予检测能力，而不用担心破坏其原有的语言理解能力。</p>
<ul>
<li><strong>双视觉编码器架构</strong></li>
</ul>
<p>团队设计了混合细粒度区域编码器（HFRE），包含两个并行的视觉编码器：</p>
<p>主编码器：沿用原VLM的视觉编码器，提供丰富的语义信息</p>
<p>辅助编码器：采用高分辨率处理的DaViT模型，捕捉细节特征</p>
<p>两者特征融合后，形成了既懂“是什么”又知“在哪里”的区域表示。</p>
<ul>
<li><strong>两阶段训练策略</strong></li>
</ul>
<p>阶段一：只训练新添加的模块，学习将区域特征映射到语言空间</p>
<p>阶段二：开放更多参数进行指令微调，全面提升感知能力</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f29f5f7c52314202818c6e8ef262b915~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=8laX5C0uUAZBfQc9tQ4xcTEnmX4%3D" alt="screenshot_2025-11-12_11-26-41.png" loading="lazy"/></p>
<h2 data-id="heading-3"><strong>性能表现：小模型的大能量</strong></h2>
<p>在多项基准测试中，VLM-FO1展现出了令人印象深刻的性能：</p>
<ul>
<li><strong>目标定位能力显著提升</strong></li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0997010f19be4c958dfcc4b4b2a36dcf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=mBuDkUfK1u6Oj%2F0aIrf4cOQsgzw%3D" alt="screenshot_2025-11-12_11-30-08.png" loading="lazy"/></p>
<p>在COCO目标检测任务上，仅3B参数的VLM-FO1达到了44.4 mAP，比同类VLM方法提升超过20个点，甚至超越了部分专用检测器。</p>
<p>特别是在包含困难负样本的OVDEval数据集上，VLM-FO1的43.7 mAP显著高于Grounding DINO等专业模型，证明其能有效利用大模型的世界知识进行推理。</p>
<ul>
<li><strong>区域理解全面领先</strong></li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50be8eb2999e4d318cf8ea69b84dd313~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=RZYbOIt2J2quS%2BDN5V4vqoVHnAI%3D" alt="screenshot_2025-11-12_11-31-20.png" loading="lazy"/></p>
<p>区域分类：在LVIS数据集上达到92.4% 的语义相似度</p>
<p>区域OCR：在COCO文本上以59.0% 的准确率大幅领先</p>
<p>指代表达理解：在Ferret Bench上以80.1分刷新纪录</p>
<ul>
<li><strong>复杂推理表现出色</strong></li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cc1649f46b14145a29f56dbd1f8efc4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=vwMBkM7B%2B%2FIu3TQeXXpn7NP%2FJxE%3D" alt="screenshot_2025-11-12_11-31-32.png" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c2036b4bab6426082c5cd70c8868d4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=72kVjOhWj1kX0DHe74SkcyC%2Bw1E%3D" alt="screenshot_2025-11-12_11-31-40.png" loading="lazy"/></p>
<p>在需要结合语言理解和视觉定位的指代表达理解任务中，VLM-FO1在多个数据集上保持领先。在对象计数任务中，其“先检测再计数”的策略在PixMo-Count上达到86.0% 的准确率，超越了众多参数量大得多的模型。</p>
<ul>
<li><strong>不影响原有能力：真正的“增强”而非“替换”</strong></li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/745f4d395f604c44a0afcd8665daa367~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=Krm64cVsMnA1fSbUDepKaWDHMoA%3D" alt="screenshot_2025-11-12_11-31-47.png" loading="lazy"/></p>
<p>最令人惊喜的是，VLM-FO1在增强细粒度感知的同时，完全保留了基础模型的通用视觉理解能力。在OpenCompass综合评测中，VLM-FO1-3B与原始Qwen2.5-VL-3B的表现基本持平，证明其没有出现灾难性遗忘。</p>
<h2 data-id="heading-4"><strong>实际应用展示</strong></h2>
<p>论文中展示了丰富的可视化结果，包括：</p>
<ul>
<li><strong>目标检测：</strong> 准确框出人物、笔记本电脑等物体</li>
<li><strong>指代表达理解：</strong> 根据语言描述定位特定对象</li>
<li><strong>对象计数：</strong> 复杂场景下的数量统计</li>
<li><strong>区域描述：</strong> 针对特定区域生成详细描述</li>
<li><strong>视觉推理：</strong> 结合逻辑推理的区域分析</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7958de31e7224590b487a59c5ccb4174~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=BMbPgrxAUVFiu8CZ4rJjQzw%2Ft3g%3D" alt="screenshot_2025-11-12_11-32-23.png" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39b513f6bf304cef9469f683fd994040~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=YcWxza3Hl%2FQW5LZXTYefyIzGihY%3D" alt="screenshot_2025-11-12_11-32-31.png" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3eea2e74b6134450ad3459935266ab92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=24LQ%2FOYh7TnJm2R8Y4YrIW201KM%3D" alt="screenshot_2025-11-12_11-32-38.png" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acc638ac3f22464ab67da8f192d2919d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=bqUrMwtDF9bjnZA3HOPB1DhyS2M%3D" alt="screenshot_2025-11-12_11-33-46.png" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/743a48113571463fb706f6a43aa633b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=od4RRrG%2F38ufKpyLRp3PxJI1gHI%3D" alt="screenshot_2025-11-12_11-52-58.png" loading="lazy"/></p>
<p>特别是在复杂推理任务中，模型能够展示出清晰的思维链条，如通过排除法找到“没有打领带的人”，逐步推理定位“盛放黑色甜甜圈的盘子”。</p>
<h2 data-id="heading-5"><strong>技术启示</strong></h2>
<p>VLM-FO1的成功为多模态大模型的发展提供了重要启示：</p>
<ul>
<li><strong>扬长避短</strong></li>
</ul>
<p>不强求大模型完成所有任务，而是将其核心的语言理解和推理能力与专门的视觉处理模块相结合。</p>
<ul>
<li><strong>模块化设计</strong></li>
</ul>
<p>通过即插即用的方式增强模型能力，避免每次升级都要推倒重来。</p>
<ul>
<li><strong>训练策略创新</strong></li>
</ul>
<p>分阶段、有针对性的训练策略能够在引入新能力的同时保护已有知识。</p>
<h2 data-id="heading-6"><strong>结语</strong></h2>
<p>VLM-FO1架起了一座桥梁，连接了大模型的高层推理能力与细粒度视觉感知需求。这种“理解内容而非生成坐标”的范式转变，不仅解决了当前VLM在定位任务上的瓶颈，更为构建真正理解视觉世界的多模态模型指明了方向。</p>
<p>随着这种技术的成熟，我们离能够真正“看懂”图像、在像素世界中自由“对话”的AI助手又近了一步。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue scoped CSS 与 Element Plus Drawer 样式失效问题深度解析]]></title>    <link>https://juejin.cn/post/7571650164843773986</link>    <guid>https://juejin.cn/post/7571650164843773986</guid>    <pubDate>2025-11-12T11:11:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571650164843773986" data-draft-id="7571559178743365667" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue scoped CSS 与 Element Plus Drawer 样式失效问题深度解析"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-12T11:11:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一只叁木Meow"/> <meta itemprop="url" content="https://juejin.cn/user/231371762837604"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue scoped CSS 与 Element Plus Drawer 样式失效问题深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/231371762837604/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一只叁木Meow
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T11:11:01.000Z" title="Wed Nov 12 2025 11:11:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问题概述</h2>
<p>在使用 Vue 3 + Element Plus 开发组件库时，我们遇到了一个棘手的样式问题：当将 <code>el-drawer</code> 组件抽离到子组件中，并且 <code>el-drawer</code> 直接作为子组件 <code>template</code> 的根元素时，<code>scoped</code> 样式无法正确应用到 drawer 上。然而，当在 <code>el-drawer</code> 外层包装一个 <code>div</code> 容器后，样式又能够正常工作。</p>
<p>这个问题不仅影响了我们的组件抽离工作，也暴露了对 Vue scoped CSS 和 Element Plus 组件内部机制理解的不足。</p>
<h2 data-id="heading-1">问题现象</h2>
<h3 data-id="heading-2">场景一：样式失效的实现</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- problematic-drawer.vue --&gt;
&lt;template&gt;
  &lt;!-- el-drawer 直接作为 template 根元素 --&gt;
  &lt;el-drawer
    :model-value="drawerVisible"
    direction="btt"
    size="300px"
    title="子组件抽屉 - 样式失效"
    @update:model-value="$emit('update:drawerVisible', $event)"
  &gt;
    &lt;div class="drawer-content"&gt;
      这个抽屉的样式无法生效！
    &lt;/div&gt;
  &lt;/el-drawer&gt;
&lt;/template&gt;

&lt;style scoped&gt;
/* 这些样式不会生效 */
:deep(.el-drawer) {
  border-top-left-radius: 20px !important;
  border-top-right-radius: 20px !important;
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
}

:deep(.el-drawer__header) {
  background: rgba(255, 255, 255, 0.1) !important;
  color: white !important;
  border-bottom: 2px solid rgba(255, 255, 255, 0.3) !important;
}

:deep(.el-drawer__body) {
  color: white !important;
  font-size: 16px !important;
}
&lt;/style&gt;
</code></pre>
<p><img src="https://img.sanmu7.com/sanmu/20251112/article-content/d16b48fe-9f7d-4dcd-b82f-b7f46fd656d2.png" alt="1762929206541.png" loading="lazy"/></p>
<h3 data-id="heading-3">场景二：样式正常的实现</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- fixed-drawer.vue --&gt;
&lt;template&gt;
  &lt;!-- el-drawer 被 div 包装 --&gt;
  &lt;div class="drawer-container"&gt;
    &lt;el-drawer
      :model-value="drawerVisible"
      direction="btt"
      size="300px"
      title="修复后的子组件抽屉 - 样式正常"
      @update:model-value="$emit('update:drawerVisible', $event)"
    &gt;
      &lt;div class="drawer-content"&gt;
        现在样式可以正常工作了！
      &lt;/div&gt;
    &lt;/el-drawer&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
/* 这些样式现在可以正常工作 */
.drawer-container :deep(.el-drawer) {
  border-top-left-radius: 20px !important;
  border-top-right-radius: 20px !important;
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%) !important;
}

.drawer-container :deep(.el-drawer__header) {
  background: rgba(255, 255, 255, 0.1) !important;
  color: white !important;
  border-bottom: 2px solid rgba(255, 255, 255, 0.3) !important;
}

.drawer-container :deep(.el-drawer__body) {
  color: white !important;
  font-size: 16px !important;
}
&lt;/style&gt;
</code></pre>
<p><img src="https://img.sanmu7.com/sanmu/20251112/article-content/1a162eb3-ad7b-4ffb-8c6b-df5874d1bad3.png" alt="1762929256553.png" loading="lazy"/></p>
<h2 data-id="heading-4">技术原理解析</h2>
<h3 data-id="heading-5">Vue scoped CSS 的工作机制</h3>
<p>Vue 的 scoped CSS 通过以下两个步骤实现样式隔离：</p>
<ol>
<li><strong>属性注入</strong>：Vue 编译器会给组件模板中的每个元素添加唯一的 <code>data-v-*</code> 属性</li>
<li><strong>选择器重写</strong>：将 CSS 选择器重写为包含对应 <code>data-v-*</code> 属性的选择器</li>
</ol>
<p>例如，对于下面的模板和样式：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="container"&gt;Hello&lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.container { color: red; }
&lt;/style&gt;
</code></pre>
<p>Vue 编译后会变成：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span> <span class="hljs-attr">data-v-xxxxxxx</span>&gt;</span>Hello<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span><span class="hljs-selector-attr">[data-v-xxxxxxx]</span> { <span class="hljs-attribute">color</span>: red; }
</code></pre>
<h3 data-id="heading-6">Element Plus Drawer 的内部机制</h3>
<p>Element Plus 的 <code>el-drawer</code> 组件内部结构较为复杂，它会：</p>
<ol>
<li>创建多个内部 DOM 元素（如 <code>.el-drawer__header</code>、<code>.el-drawer__body</code> 等）</li>
<li>这些内部元素是由组件动态生成的，不会继承父组件的 <code>data-v-*</code> 属性</li>
</ol>
<h3 data-id="heading-7">问题根源分析</h3>
<h4 data-id="heading-8">场景一的问题</h4>
<p>当 <code>el-drawer</code> 直接作为子组件的根元素时：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-drawer&gt;...&lt;/el-drawer&gt;
&lt;/template&gt;

&lt;style scoped&gt;
:deep(.el-drawer) { /* 样式 */ }
&lt;/style&gt;
</code></pre>
<p>编译后的结果：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">el-drawer</span> <span class="hljs-attr">data-v-xxxxxxx</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">el-drawer</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[data-v-xxxxxxx]</span> <span class="hljs-selector-class">.el-drawer</span> { <span class="hljs-comment">/* 样式 */</span> }
</code></pre>
<p><strong>问题在于</strong>：虽然 <code>el-drawer</code> 元素本身有 <code>data-v-xxxxxxx</code> 属性，但 Element Plus 在其内部创建的 <code>.el-drawer__header</code>、<code>.el-drawer__body</code> 等元素<strong>没有这个属性</strong>，导致选择器 <code>[data-v-xxxxxxx] .el-drawer__header</code> 无法匹配到目标元素。</p>
<h4 data-id="heading-9">场景二的解决方案</h4>
<p>当使用 <code>div</code> 包装 <code>el-drawer</code> 时：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="drawer-container"&gt;
    &lt;el-drawer&gt;...&lt;/el-drawer&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.drawer-container :deep(.el-drawer) { /* 样式 */ }
&lt;/style&gt;
</code></pre>
<p>编译后的结果：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"drawer-container"</span> <span class="hljs-attr">data-v-yyyyyyy</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">el-drawer</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">el-drawer</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[data-v-yyyyyyy]</span> <span class="hljs-selector-class">.drawer-container</span> <span class="hljs-selector-class">.el-drawer</span> { <span class="hljs-comment">/* 样式 */</span> }
</code></pre>
<p><strong>为什么能成功</strong>：</p>
<ol>
<li><strong>正确的属性承载</strong>：外层 <code>div</code> 容器获得了 <code>data-v-yyyyyyy</code> 属性</li>
<li><strong>更高的 CSS 特异性</strong>：选择器 <code>[data-v-yyyyyyy] .drawer-container .el-drawer</code> 具有更高的特异性</li>
<li><strong>样式继承和覆盖</strong>：更高特异性的选择器能够成功覆盖 Element Plus 的默认样式</li>
</ol>
<h2 data-id="heading-10">解决方案</h2>
<h3 data-id="heading-11">方案一：容器包装法（推荐）</h3>
<p>这是最简单有效的解决方案：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="drawer-wrapper"&gt;
    &lt;el-drawer
      v-model="visible"
      title="抽屉标题"
    &gt;
      &lt;!-- 抽屉内容 --&gt;
    &lt;/el-drawer&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.drawer-wrapper :deep(.el-drawer) {
  /* 自定义样式 */
  border-radius: 8px;
}

.drawer-wrapper :deep(.el-drawer__header) {
  background: #f0f0f0;
}

.drawer-wrapper :deep(.el-drawer__body) {
  padding: 20px;
}
&lt;/style&gt;
</code></pre>
<h3 data-id="heading-12">方案二：全局样式法</h3>
<p>如果组件需要在多个地方复用，可以考虑使用全局样式：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-drawer
    v-model="visible"
    class="custom-drawer"
    title="抽屉标题"
  &gt;
    &lt;!-- 抽屉内容 --&gt;
  &lt;/el-drawer&gt;
&lt;/template&gt;

&lt;style&gt;
/* 注意：这里没有 scoped */
.custom-drawer {
  border-radius: 8px;
}

.custom-drawer .el-drawer__header {
  background: #f0f0f0;
}

.custom-drawer .el-drawer__body {
  padding: 20px;
}
&lt;/style&gt;
</code></pre>
<h3 data-id="heading-13">方案三：CSS Modules 方案</h3>
<p>使用 CSS Modules 可以避免样式冲突：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-drawer
    v-model="visible"
    :class="$style.customDrawer"
    title="抽屉标题"
  &gt;
    &lt;!-- 抽屉内容 --&gt;
  &lt;/el-drawer&gt;
&lt;/template&gt;

&lt;style module&gt;
.customDrawer {
  border-radius: 8px;
}

.customDrawer :global(.el-drawer__header) {
  background: #f0f0f0;
}

.customDrawer :global(.el-drawer__body) {
  padding: 20px;
}
&lt;/style&gt;
</code></pre>
<h2 data-id="heading-14">最佳实践建议</h2>
<h3 data-id="heading-15">1. 组件结构设计原则</h3>
<ul>
<li><strong>避免直接暴露第三方组件</strong>：尽量用容器元素包装第三方组件</li>
<li><strong>保持组件层级清晰</strong>：每个组件都应该有明确的根容器</li>
<li><strong>考虑样式复用性</strong>：设计时考虑样式是否需要在多个地方复用</li>
</ul>
<h3 data-id="heading-16">2. scoped CSS 使用技巧</h3>
<ul>
<li><strong>合理使用 <code>:deep()</code></strong>：只在必要时使用深度选择器</li>
<li><strong>选择器特异性平衡</strong>：避免过度依赖 <code>!important</code></li>
<li><strong>样式隔离优先</strong>：优先使用 scoped 样式，必要时才使用全局样式</li>
</ul>
<h3 data-id="heading-17">3. 第三方组件集成策略</h3>
<ul>
<li><strong>了解组件内部机制</strong>：使用前了解第三方组件的 DOM 结构</li>
<li><strong>建立组件包装层</strong>：为第三方组件创建包装组件</li>
<li><strong>文档化样式定制</strong>：记录样式定制的最佳实践</li>
</ul>
<h3 data-id="heading-18">4. 开发调试技巧</h3>
<ul>
<li><strong>使用浏览器开发者工具</strong>：检查实际的 DOM 结构和 CSS 选择器</li>
<li><strong>关注编译后的代码</strong>：了解 Vue 编译器如何处理 scoped CSS</li>
<li><strong>建立样式测试</strong>：为关键样式建立测试用例</li>
</ul>
<h2 data-id="heading-19">总结</h2>
<p>Vue scoped CSS 与 Element Plus Drawer 的样式问题，本质上是由 Vue 的样式隔离机制与第三方组件的内部实现之间的冲突造成的。通过添加容器元素，我们为 scoped CSS 提供了正确的属性承载上下文，从而解决了样式匹配问题。</p>
<p>这个问题的解决过程告诉我们：</p>
<ol>
<li><strong>理解底层机制很重要</strong>：深入了解 Vue 和第三方组件的工作原理</li>
<li><strong>简单的解决方案往往有效</strong>：添加容器元素是最简单有效的解决方案</li>
<li><strong>设计时需要考虑扩展性</strong>：良好的组件设计可以避免后续的样式问题</li>
<li><strong>文档化经验很重要</strong>：将遇到的问题和解决方案记录下来，避免重复踩坑</li>
</ol>
<p>希望这篇文章能够帮助开发者更好地理解 Vue scoped CSS 的工作机制，并在实际开发中避免类似的样式问题。</p>
<h2 data-id="heading-20">参考资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2Fapi%2Fsfc-css-features.html%23scoped-css" target="_blank" title="https://vuejs.org/api/sfc-css-features.html#scoped-css" ref="nofollow noopener noreferrer">Vue 3 官方文档 - Scoped CSS</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Felement-plus.org%2F" target="_blank" title="https://element-plus.org/" ref="nofollow noopener noreferrer">Element Plus 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FCSS%2FSpecificity" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/CSS/Specificity" ref="nofollow noopener noreferrer">CSS 特异性计算规则</a></li>
</ul>
<hr/>
<p><em>本文基于实际项目中的问题总结而成，如有不当之处，欢迎指正和讨论。</em></p>
<p>文章最后，给大家介绍一下个人博客网站：<a href="https://link.juejin.cn?target=https%3A%2F%2Fsanmu7.com%2F" target="_blank" title="https://sanmu7.com/" ref="nofollow noopener noreferrer">叁木の小屋</a>。欢迎各位捧场。笔芯❤。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 数组：从内存布局到遍历策略的深度解析]]></title>    <link>https://juejin.cn/post/7571648135585169451</link>    <guid>https://juejin.cn/post/7571648135585169451</guid>    <pubDate>2025-11-12T11:59:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571648135585169451" data-draft-id="7571648135585136683" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 数组：从内存布局到遍历策略的深度解析"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-11-12T11:59:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Zyx2007"/> <meta itemprop="url" content="https://juejin.cn/user/3924597867554890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 数组：从内存布局到遍历策略的深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3924597867554890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Zyx2007
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T11:59:16.000Z" title="Wed Nov 12 2025 11:59:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：数组为何“开箱即用”？</h2>
<p>在 JavaScript 开发中，数组（Array）是最常用、最直观的数据结构。我们几乎每天都在写 <code>const arr = [1, 2, 3]</code>，却很少思考：这个看似简单的结构背后，究竟隐藏着怎样的内存机制与性能权衡？为什么说数组是“开箱即用”的数据结构？它与链表相比有何优劣？不同的遍历方式又如何影响程序效率？</p>
<p>本文将从<strong>内存分配、动态扩容、遍历方法</strong>三个维度，深入剖析 JavaScript 数组的本质，并结合实际代码，揭示高效使用数组的最佳实践。</p>
<hr/>
<h2 data-id="heading-1">一、数组的内存模型：栈与堆的协作</h2>
<h3 data-id="heading-2">1.1 引用类型 vs 值类型</h3>
<p>在 JavaScript 中，数组属于<strong>引用类型</strong>。当我们声明：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]<span class="hljs-comment">;</span>
</code></pre>
<p>实际上发生了两件事：</p>
<ul>
<li><strong>栈内存</strong>中存储变量 <code>arr</code>，其值是一个<strong>指向堆内存的引用地址</strong></li>
<li><strong>堆内存</strong>中分配一块连续空间，存放 <code>[1, 2, 3]</code> 的实际数据</li>
</ul>
<p>这种设计使得多个变量可以共享同一数组（通过引用），也解释了为何修改一个引用会影响所有指向它的变量。</p>
<h3 data-id="heading-3">1.2 数组的创建方式与初始化</h3>
<p>JS 提供多种创建数组的方式，但效果截然不同：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> arr1 = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];               <span class="hljs-comment">// 字面量：元素和长度均确定</span>
<span class="hljs-keyword">const</span> arr2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">3</span>);            <span class="hljs-comment">// 长度为3，但内容为 empty（稀疏数组）</span>
<span class="hljs-keyword">const</span> arr3 = (<span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">3</span>)).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>);  <span class="hljs-comment">// 长度为3，每个元素初始化为0</span>
</code></pre>
<p>特别注意：<code>new Array(3)</code> 创建的是一个<strong>稀疏数组（sparse array）</strong> ，其内部并未真正分配三个值为 <code>undefined</code> 的槽位，而是仅记录长度。这在某些遍历方法（如 <code>forEach</code>）中会导致跳过这些“空洞”。</p>
<p>而 <code>fill(0)</code> 则确保每个位置都被显式赋值，避免意外行为。</p>
<hr/>
<h2 data-id="heading-4">二、动态扩容：便利背后的代价</h2>
<h3 data-id="heading-5">2.1 连续内存的优势与局限</h3>
<p>数组的核心优势在于<strong>连续内存布局</strong>，这使得通过索引访问元素的时间复杂度为 <strong>O(1)</strong> ——无论数组多大，<code>arr[1000]</code> 都能瞬间定位。</p>
<p>然而，连续性也带来了挑战：<strong>当数组容量不足时，必须扩容</strong>。</p>
<p>JavaScript 引擎（如 V8）采用以下策略：</p>
<ol>
<li>申请一块更大的连续内存（通常按倍数增长，如 1.5 倍）</li>
<li>将原数组所有元素<strong>逐个复制</strong>到新内存</li>
<li>释放旧内存</li>
</ol>
<p>这个过程称为“<strong>搬家</strong>”，虽然对开发者透明，但<strong>开销较大</strong>——尤其在频繁 push 大量元素时。</p>
<h3 data-id="heading-6">2.2 数组 vs 链表：动态性的权衡</h3>
<p>笔记中提到：“考虑动态性时，数组比链表差”。这是因为在链表中：</p>
<ul>
<li>插入/删除只需修改指针，无需移动数据</li>
<li>内存可离散分布，无扩容压力</li>
</ul>
<p>但链表也有致命缺点：</p>
<ul>
<li>访问任意元素需从头遍历，时间复杂度 O(n)</li>
<li>每个节点需额外存储指针，内存开销更大</li>
</ul>
<p>因此，在<strong>数据量较小、读多写少</strong>的场景下，数组凭借其缓存友好性和快速随机访问，仍是更优选择。</p>
<blockquote>
<p>正如笔记所言：“少数数据的情况下，数组是更加优秀的。”</p>
</blockquote>
<hr/>
<h2 data-id="heading-7">三、遍历策略：性能与可读性的平衡</h2>
<p>JavaScript 提供多种数组遍历方式，各有适用场景：</p>
<h3 data-id="heading-8">3.1 计数循环（for）</h3>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">len</span> = arr.length<span class="hljs-comment">;</span>
for (let <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; len; i++) {</span>
    console.log(arr<span class="hljs-section">[i]</span>)<span class="hljs-comment">;</span>
}
</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>性能最佳：无函数调用开销，CPU 友好</li>
<li>支持 <code>break</code> 和 <code>continue</code></li>
</ul>
<p><strong>注意</strong>：应缓存 <code>arr.length</code>，避免每次循环都访问对象属性（虽现代引擎已优化，但仍是良好习惯）。</p>
<h3 data-id="heading-9">3.2 for...of</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> item <span class="hljs-keyword">of</span> arr) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(item);
}
</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>可读性强：直接获取元素值，无需索引</li>
<li>支持 <code>break</code>/<code>continue</code></li>
<li>兼容所有可迭代对象（包括字符串、Set 等）</li>
</ul>
<p><strong>适用场景</strong>：只需元素值，不关心索引时。</p>
<h3 data-id="heading-10">3.3 forEach</h3>
<pre><code class="hljs language-javascript" lang="javascript">arr.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(item, index);
});
</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>语义清晰：明确表达“对每个元素执行操作”</li>
<li>自动处理稀疏数组（跳过 empty slots）</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li><strong>无法使用 <code>break</code> 或 <code>continue</code></strong>（会报错）</li>
<li>函数调用带来额外开销（入栈/出栈）</li>
<li>性能低于 for 循环</li>
</ul>
<blockquote>
<p>因此，<strong>性能敏感场景应避免 forEach</strong>。</p>
</blockquote>
<h3 data-id="heading-11">3.4 for...in 的陷阱</h3>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-keyword">key</span> <span class="hljs-keyword">in</span> arr) {
    console.log(<span class="hljs-keyword">key</span>, arr[<span class="hljs-keyword">key</span>]);
}
</code></pre>
<p>虽然数组是对象，<code>for...in</code> 能遍历其索引，但存在严重问题：</p>
<ul>
<li>遍历的是<strong>所有可枚举属性</strong>，包括原型链上的（若未正确设置）</li>
<li>索引以<strong>字符串形式</strong>返回（"0", "1"）</li>
<li>不保证顺序（尽管现代引擎通常按索引顺序）</li>
</ul>
<p><strong>强烈建议</strong>：遍历数组时不要使用 <code>for...in</code>。</p>
<hr/>
<h2 data-id="heading-12">四、实战建议：如何高效使用数组？</h2>
<h3 data-id="heading-13">4.1 初始化时预估容量</h3>
<p>若已知数组大致大小，可预先分配：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = new Array(expectedSize).fill(<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
</code></pre>
<p>减少后续扩容次数。</p>
<h3 data-id="heading-14">4.2 选择合适的遍历方式</h3>

























<table><thead><tr><th>需求</th><th>推荐方法</th></tr></thead><tbody><tr><td>最高性能</td><td><code>for (let i=0; i&lt;len; i++)</code></td></tr><tr><td>只需元素值</td><td><code>for...of</code></td></tr><tr><td>函数式风格</td><td><code>map</code>, <code>filter</code>（但注意性能）</td></tr><tr><td>避免</td><td><code>forEach</code>（需中断时）、<code>for...in</code></td></tr></tbody></table>
<h3 data-id="heading-15">4.3 理解 map 与 forEach 的区别</h3>
<ul>
<li><code>forEach</code>：仅遍历，无返回值</li>
<li><code>map</code>：遍历并<strong>返回新数组</strong>，用于数据转换</li>
</ul>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">const</span> doubled = arr.<span class="hljs-built_in">map</span>(x =&gt; x * <span class="hljs-number">2</span>); <span class="hljs-comment">// [2,4,6,...]</span>
</code></pre>
<p>不要为了遍历而滥用 <code>map</code>——若不需要新数组，用 <code>forEach</code> 或 <code>for...of</code> 更合适。</p>
<hr/>
<h2 data-id="heading-16">结语：理解底层，方能驾驭上层</h2>
<p>JavaScript 数组的“简单”是精心设计的结果。它在连续内存、动态扩容、丰富 API 之间取得了精妙平衡，成为开发者最信赖的工具之一。</p>
<blockquote>
<p>“开箱即用”不等于“无需思考”。<br/>
对数据结构的敬畏，是写出高效、可靠代码的第一步。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS 定位系统全解析：从文档流到 sticky 的实战指南]]></title>    <link>https://juejin.cn/post/7571693273728040996</link>    <guid>https://juejin.cn/post/7571693273728040996</guid>    <pubDate>2025-11-12T12:23:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571693273728040996" data-draft-id="7571657746346131510" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS 定位系统全解析：从文档流到 sticky 的实战指南"/> <meta itemprop="keywords" content="CSS"/> <meta itemprop="datePublished" content="2025-11-12T12:23:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Zyx2007"/> <meta itemprop="url" content="https://juejin.cn/user/3924597867554890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS 定位系统全解析：从文档流到 sticky 的实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3924597867554890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Zyx2007
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T12:23:59.000Z" title="Wed Nov 12 2025 12:23:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：布局的基石——理解“文档流”</h2>
<p>在前端开发中，页面元素如何排列？为何有的元素会“漂浮”起来，而有的始终按顺序堆叠？这一切的答案，都藏在一个核心概念中——<strong>文档流（Document Flow）</strong> 。</p>
<p>文档流是 HTML 元素在页面中的默认布局方式：块级元素垂直排列，行内元素水平排列，整体遵循“从上到下、从左到右”的自然顺序。每个元素默认采用 <strong><code>position: static</code></strong>（静态定位），乖乖待在自己的位置上，既不影响别人，也不被别人影响。</p>
<p>然而，一旦我们引入 CSS 定位（<code>position</code>），元素就可能<strong>离开或部分脱离文档流</strong>，从而实现复杂布局。本文将结合代码实例，深入剖析 <code>relative</code>、<code>absolute</code>、<code>fixed</code>、<code>sticky</code> 四种定位方式的本质区别、使用场景与常见陷阱。</p>
<hr/>
<h2 data-id="heading-1">一、relative：相对定位，不离不弃</h2>
<h3 data-id="heading-2">1.1 行为特征</h3>
<p><code>position: relative</code> 是最温和的定位方式。它让元素<strong>相对于自身原始位置进行偏移</strong>，但关键在于：<strong>它仍然占据文档流中的原始空间</strong>。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 1.html --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"parent"</span>&gt;</span> <span class="hljs-comment">&lt;!-- pink, 500x500 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"child"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span> <span class="hljs-comment">&lt;!-- skyblue --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span> <span class="hljs-comment">&lt;!-- green --&gt;</span>
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.parent</span> {
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">100px</span>;
}
</code></pre>
<p>效果：</p>
<ul>
<li><code>.parent</code> 视觉上向右下移动了 100px</li>
<li>但 <code>.box</code>（绿色方块）依然紧贴在 <code>.parent</code> <strong>原始位置的下方</strong>，仿佛 <code>.parent</code> 没动过</li>
</ul>
<p>这说明：<strong>relative 不脱离文档流</strong>，后续元素仍按标准流对待它。</p>
<h3 data-id="heading-3">1.2 实战价值</h3>
<ul>
<li>作为 <code>absolute</code> 子元素的<strong>定位上下文容器</strong></li>
<li>微调元素位置而不破坏整体布局</li>
<li>配合 <code>z-index</code> 控制层叠顺序</li>
</ul>
<blockquote>
<p>笔记提醒：“用 <code>static</code> 可取消元素的定位属性”——这在动态切换布局时非常有用（如 1.html 中 5 秒后恢复 static）。</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">二、absolute：绝对定位，彻底脱离</h2>
<h3 data-id="heading-5">2.1 脱离文档流</h3>
<p><code>position: absolute</code> 会让元素<strong>完全脱离文档流</strong>。这意味着：</p>
<ul>
<li>原始位置不再被占据</li>
<li>后续元素会“无视”它，直接填补其空缺</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 2.html --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"parent"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"child"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span> <span class="hljs-comment">&lt;!-- absolute --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>123<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>456<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p><code>.child</code> 使用 <code>absolute</code> 后，<code>&lt;div&gt;123&lt;/div&gt;</code> 和 <code>&lt;div&gt;456&lt;/div&gt;</code> 的排布不受其影响。</p>
<h3 data-id="heading-6">2.2 定位参考点：寻找“最近的定位祖先”</h3>
<p>绝对定位的元素不会凭空定位，它需要一个<strong>参考坐标系</strong>。规则如下：</p>
<ol>
<li>向上查找父元素，寻找第一个 <code>position</code> <strong>不为 <code>static</code></strong> 的祖先</li>
<li>若找到，则以该祖先的<strong>边框盒（border box）</strong> 为参考</li>
<li>若未找到，则以 <code>&lt;body&gt;</code> 为参考</li>
</ol>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.parent</span> { <span class="hljs-attribute">position</span>: relative; } <span class="hljs-comment">/* 成为 .child 的定位上下文 */</span>
<span class="hljs-selector-class">.child</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">100px</span>; <span class="hljs-comment">/* 相对于 .parent 内部偏移 */</span>
}
</code></pre>
<p>若 <code>.parent</code> 没有设置 <code>position: relative</code>，<code>.child</code> 将相对于整个页面定位。</p>
<h3 data-id="heading-7">2.3 经典应用：居中技巧</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>);
}
</code></pre>
<p>这是实现<strong>绝对居中</strong>的黄金组合：先移到中心点，再用 <code>transform</code> 反向偏移自身一半尺寸。</p>
<hr/>
<h2 data-id="heading-8">三、fixed：固定定位，锁定视口</h2>
<h3 data-id="heading-9">3.1 以浏览器窗口为基准</h3>
<p><code>position: fixed</code> 是 <code>absolute</code> 的“特殊版本”——它的参考点永远是<strong>浏览器视口（viewport）</strong> ，而非任何父元素。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 3.html --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"child"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"position: fixed; right: 100px; bottom: 100px;"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>无论页面如何滚动，该元素始终固定在距离右下角 100px 的位置。</p>
<h3 data-id="heading-10">3.2 完全脱离文档流</h3>
<p>和 <code>absolute</code> 一样，<code>fixed</code> 元素：</p>
<ul>
<li>不占据原始空间</li>
<li>后续元素会忽略它</li>
<li>可能覆盖其他内容（需注意 <code>z-index</code>）</li>
</ul>
<blockquote>
<p>注意：在移动端，某些浏览器对 <code>fixed</code> 支持不佳（尤其在软键盘弹出时），需谨慎使用。</p>
</blockquote>
<hr/>
<h2 data-id="heading-11">四、sticky：智能粘连，动静结合</h2>
<h3 data-id="heading-12">4.1 hybrid 定位：relative + fixed</h3>
<p><code>position: sticky</code> 是 CSS 最具智慧的定位方式。它表现为：</p>
<ul>
<li><strong>默认行为像 <code>relative</code></strong>：在文档流中正常占位</li>
<li><strong>当滚动到阈值时，行为像 <code>fixed</code></strong>：固定在视口某处</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 4.html --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"position: sticky; top: 100px;"</span>&gt;</span>hello world<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>效果：</p>
<ul>
<li>页面未滚动时，<code>.box</code> 在正常位置</li>
<li>当其<strong>顶部距离视口顶部 ≤ 100px</strong> 时，自动变为 <code>fixed</code>，吸附在 <code>top: 100px</code> 处</li>
<li>向上滚动回原位置时，又恢复为 <code>relative</code></li>
</ul>
<h3 data-id="heading-13">4.2 必须指定阈值</h3>
<p><code>sticky</code> 必须配合 <code>top</code>/<code>bottom</code>/<code>left</code>/<code>right</code> 使用，否则无效。最常见的是 <code>top</code>（用于表头、导航栏固定）。</p>
<h3 data-id="heading-14">4.3 父容器限制</h3>
<p><code>sticky</code> 元素的“固定范围”受其<strong>最近的具有 overflow 非 visible 的祖先</strong>限制。若父容器高度不足，可能无法 sticky 到预期位置。</p>
<hr/>
<h2 data-id="heading-15">五、对比总结：何时使用哪种定位？</h2>









































<table><thead><tr><th>定位类型</th><th>是否脱离文档流</th><th>参考点</th><th>典型用途</th></tr></thead><tbody><tr><td><code>static</code></td><td>否</td><td>—</td><td>默认状态，取消定位</td></tr><tr><td><code>relative</code></td><td>否</td><td>自身原始位置</td><td>微调位置，作为 absolute 容器</td></tr><tr><td><code>absolute</code></td><td>是</td><td>最近的非 static 祖先</td><td>弹窗、tooltip、脱离流的装饰元素</td></tr><tr><td><code>fixed</code></td><td>是</td><td>浏览器视口</td><td>导航栏、返回顶部按钮</td></tr><tr><td><code>sticky</code></td><td><strong>部分</strong></td><td>视口（滚动时）</td><td>表头固定、侧边目录</td></tr></tbody></table>
<blockquote>
<p>特别注意：<code>display: none</code> 与定位无关——它直接<strong>移除元素</strong>，不占空间；而 <code>opacity: 0</code> 仅隐藏视觉，仍占空间（如 2.html 所示）。</p>
</blockquote>
<hr/>
<h2 data-id="heading-16">六、避坑指南：常见误区</h2>
<ol>
<li><strong>误以为 relative 会腾出空间</strong><br/>
→ 错！它只是“视觉偏移”，原始位置仍被占据。</li>
<li><strong>absolute 元素找不到定位祖先</strong><br/>
→ 结果会相对于 body 定位，导致布局错乱。务必检查父容器是否设置了 <code>position: relative/absolute/fixed</code>。</li>
<li><strong>sticky 不生效</strong><br/>
→ 检查是否设置了 <code>top</code> 等阈值；检查父容器是否有 <code>overflow: hidden</code> 限制。</li>
<li><strong>滥用 fixed 导致移动端体验差</strong><br/>
→ 在 iOS Safari 等环境中，fixed 元素可能在输入框聚焦时错位。</li>
</ol>
<hr/>
<h2 data-id="heading-17">结语：定位是布局的灵魂</h2>
<p>CSS 定位系统看似简单，实则蕴含精妙的设计哲学。<code>relative</code> 的克制、<code>absolute</code> 的自由、<code>fixed</code> 的坚定、<code>sticky</code> 的智能，共同构成了现代 Web 布局的强大工具集。</p>
<p>掌握它们的关键，在于理解<strong>文档流</strong>这一底层逻辑。只有明白元素“原本在哪里”，才能精准控制它“应该去哪里”。</p>
<blockquote>
<p>正如笔记开篇所问：“离开文档流？”——答案不是简单的“是”或“否”，而是：<strong>根据需求，恰到好处地脱离或保留</strong>。这才是前端布局的艺术所在。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[WebSocket指南：从原理到生产环境实战]]></title>    <link>https://juejin.cn/post/7571650164843986978</link>    <guid>https://juejin.cn/post/7571650164843986978</guid>    <pubDate>2025-11-12T13:07:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571650164843986978" data-draft-id="7571655312799072282" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="WebSocket指南：从原理到生产环境实战"/> <meta itemprop="keywords" content="前端,WebSocket"/> <meta itemprop="datePublished" content="2025-11-12T13:07:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ZKshun"/> <meta itemprop="url" content="https://juejin.cn/user/4106030135654128"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            WebSocket指南：从原理到生产环境实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4106030135654128/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ZKshun
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T13:07:16.000Z" title="Wed Nov 12 2025 13:07:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.7;font-weight:400;font-size:16px;overflow-x:hidden;color:#212122}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:8px;padding-bottom:8px}.markdown-body h1{color:#a0a0a0;font-size:38px;margin-top:32px;padding-top:32px}.markdown-body h2{color:#fff;background-color:#212122;width:fit-content;border-bottom-right-radius:100px;margin-top:47px;margin-bottom:16px;padding:4px 48px 4px 8px;line-height:1.7;font-size:30px;transition:all .3s ease-out}.markdown-body h2:hover{border-bottom-right-radius:50px;transition:all .3s ease-out}.markdown-body h3{font-size:24px;padding-left:8px;margin-top:32px;border-bottom:2px solid #c6c4c4;line-height:1.7}.markdown-body h4{font-size:20px;padding-left:8px;margin-top:32px;border-bottom:1px solid #ddd}.markdown-body h5{font-size:16px;margin-top:24px}.markdown-body h6{margin-top:16px;line-height:1.1}.markdown-body p{font-size:16px;text-align:start;white-space:normal;text-size-adjust:auto;line-height:2;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%;margin:auto;padding-left:8px;padding-right:8px}.markdown-body hr{border:none;border-top:4px double #212122;margin-top:32px;margin-bottom:32px;text-align:center}.markdown-body hr:after{content:"♥";display:inline-block;position:relative;top:-15px;padding:0 10px;color:#212122;font-size:18px}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f1f1f1;color:#ef7060;font-size:14px;padding:.065em 6px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.7;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);margin:32px 16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-color:#212122;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);background-size:40px}.markdown-body pre&gt;code{font-size:14px;padding:16px 8px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#fff;background:#272822}.markdown-body pre&gt;code::-webkit-scrollbar{height:10px;background-color:#f5f5f5}.markdown-body pre&gt;code::-webkit-scrollbar-track{box-shadow:inset 0 0 6px rgba(0,0,0,.3);border-radius:3px;background-color:#f5f5f5}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{border-radius:3px;box-shadow:inset 0 0 6px rgba(0,0,0,.3);background-color:#555}.markdown-body a{color:#ef7060;padding:2px;text-decoration:none;border-bottom:.125em solid #ef7060;border-radius:2px;box-shadow:inset 0 -.025em 0 #ef7060;transition:box-shadow .27s cubic-bezier(.77,0,.175,1),color .27s cubic-bezier(.77,0,.175,1)}.markdown-body a:focus,.markdown-body a:hover{outline:none;box-shadow:inset 0 -1.5em 0 #ef7060;color:#fff}.markdown-body a:before{content:"⇲ ";vertical-align:top;margin-left:2px;font-family:dart!important;font-size:12px;color:inherit;opacity:.7}.markdown-body table{background:#fbfbfb;border-radius:4px;border-collapse:collapse;margin:auto;padding:5px;width:95%;box-shadow:0 5px 10px rgba(0,0,0,.1);animation:float 5s infinite}.markdown-body table th{color:#fff;background:#212122;border-bottom:1px solid #9ea7af;border-right:1px solid #343a45;font-size:18px;padding:16px;text-align:left;vertical-align:middle}.markdown-body table th:first-child{border-top-left-radius:4px}.markdown-body table th:last-child{border-top-right-radius:4px;border-right:none}.markdown-body table tr{border-top:1px solid #c1c3d1;border-bottom:1px solid #c1c3d1;color:#666b85}.markdown-body table tr:hover td{background:#212122;color:#fff;border-top:1px solid #22262e}.markdown-body table tr:first-child{border-top:none}.markdown-body table tr:last-child{border-bottom:none}.markdown-body table tr:nth-child(odd) td{background:#f1f1f1}.markdown-body table tr:nth-child(odd):hover td{background:#212122}.markdown-body table tr:last-child td:first-child{border-bottom-left-radius:4px}.markdown-body table tr:last-child td:last-child{border-bottom-right-radius:4px}.markdown-body table td{background:#fbfbfb;padding:16px;text-align:left;vertical-align:middle;font-size:16px;border-right:1px solid #c1c3d1}.markdown-body table td:last-child{border-right:0}.markdown-body blockquote{color:#777;padding:1px 16px;margin:24px 0;border-left:4px solid #c6c4c4;background-color:#f1f1f1;transition:all .3s ease-out;border-radius:4px}.markdown-body blockquote:hover{border-left-color:#212122;background-color:#212122;color:#fff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:24px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body span.math{margin-left:32px;font-size:18px;font-weight:700}@media (max-width:720px){.markdown-body h1{font-size:30.4px}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:19.2px}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:12.8px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><h2 data-id="heading-0">一、为什么选 WebSocket ？</h2>
<p>WebSocket是一个在单个TCP连接上实现全双工通信的网络协议，专为web应用设计，由HTML5规范引入前端开发。</p>
<ul>
<li><strong>全双工</strong>：客户端和服务端可以<strong>同时</strong>独立发送和接收数据，不需要像HTTP/HTTPS协议那样只能单次请求-响应</li>
<li><strong>持久连接</strong>：一旦连接建立之后就会保持连接状态，除非有一端取消连接，避免了HTTP的频繁握手开销，适用于实时聊天、需实时获取数据状态等场景</li>
<li><strong>基于HTTP升级</strong>：连接通过HTTP/HTTPS的**"Upgrade"机制**建立（即websocket握手），初始使用ws://或wss://协议</li>
</ul>
<p><strong>适用场景</strong>：实时聊天、在线协作、多人游戏、直播弹幕等需要低延迟、高频率使用的场景</p>
<blockquote>
<p><strong>通信模式对比</strong></p>
<ul>
<li>单工：数据只能单向传输，如服务端推送（SSE）、
</li><li>半双工：数据可以双向传输、但不能同时进行，如常规的REST API、Fetch/XMLHttpRequest</li>
<li>全双工：数据可以双向同时传输，如WebSocket、WebRTC</li>
</ul>
</blockquote>
<p>本文以小编在一个在线代码评测系统使用websocket来实时获取用户代码的评测信息功能，来介绍小编对于websocket的理解！</p>
<h2 data-id="heading-1">二、WebSocket握手与协议升级</h2>
<p><strong>"Upgrade"机制</strong>是一种协议协商方式，允许客户端和服务器在已有HTTP连接的基础上，将通信协议从HTTP切换为另一种协议WebSocket。这一过程又被称为<strong>协议升级</strong>，所以发送websocket请求也可以理解为一次协议升级的过程，具体过程包括：</p>
<ol>
<li>客户端发起websocket请求，该请求的类型会显示为websocket请求，请求头通常包含几个upgrade的关键字段，如下图所示为ws连接的请求头：</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0464b53ea0cb4d728c04e3c884353bd2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWktzaHVu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763557837&amp;x-signature=mxYsfU97IqOlRj7AVK6ccQdQiDY%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d51e6774c52f465faf19ff95dea37c0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWktzaHVu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763557837&amp;x-signature=74EoqYOx%2B3ajfsqjM9WQ7%2BvLfcY%3D" alt="image.png" loading="lazy"/>
2. 如果服务器支持websocket协议并同意升级，他就会返回一个<strong>101 Switching Protocols</strong> 状态码，并且包含特定的响应头：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f82f7372a611418dbd3a00feabf1b228~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWktzaHVu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763557837&amp;x-signature=HO7BH205btco4qWJAdOyohDqYEw%3D" alt="image.png" loading="lazy"/>
3. 一旦客户端收到<strong>101响应，TCP连接就会从HTTP模式切换到WebSocket模式</strong>，就会发生以下变化：</p>
<ul>
<li>后续所有的数据都以<code>WebSocket帧（frame，如下图）</code>格式传输（不再是原来的HTTP提交）</li>
<li>双方可以随时主动发送消息（全双工）</li>
<li>连接保持打开，直到一方发送<code>关闭帧</code>或连接中断。在小编对接的过程中，由于后端同学并没有在沙箱判题结束之后发送关闭帧主动关闭连接通道，所以小编采用的是判断最后一帧信息的状态来主动关闭连接。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c57e33429a194c1daa938a17a859dedf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWktzaHVu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763557837&amp;x-signature=ZLZsqdbkiODvwJgVRl038k4U6b0%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>简言之：WebSocket 不是全新连接，而是"借用"HTTP连接完成一次安全握手后，将通道"改造"为实时通信管道。</p>
</blockquote>
<h2 data-id="heading-2">三、快速上手-基础语法</h2>
<h3 data-id="heading-3">1、创建 WebSocket 连接</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> socket = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-string">'ws://localhost:8080'</span>); <span class="hljs-comment">// 传入后端给你的ws连接地址</span>
</code></pre>
<h3 data-id="heading-4">2、Websocket 的四个事件</h3>
<ul>
<li><code>onopen</code>：连接建立时触发</li>
<li><code>onmessage</code>：收到服务器消息触发</li>
<li><code>onerror</code>：连接发生错误时触发</li>
<li><code>onclose</code>：连接关闭时触发</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript">socket.<span class="hljs-property">onopen</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'连接建立'</span>);
  <span class="hljs-comment">// socket.send('Hello Server!'); 一般在连接建立成功之后就可以给服务端发消息了</span>
};

socket.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到消息:'</span>, event.<span class="hljs-property">data</span>);
  <span class="hljs-comment">// event.data 是服务器发送的数据</span>
};

socket.<span class="hljs-property">onerror</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'错误:'</span>, error);
};

socket.<span class="hljs-property">onclose</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'连接关闭'</span>, event);
};
</code></pre>
<h3 data-id="heading-5">3、发送消息</h3>
<pre><code class="hljs language-javascript" lang="javascript">socket.<span class="hljs-title function_">send</span>(<span class="hljs-string">'Hello Server!'</span>);
</code></pre>
<h3 data-id="heading-6">4、关闭连接</h3>
<pre><code class="hljs language-javascript" lang="javascript">socket.<span class="hljs-title function_">close</span>();
</code></pre>
<h3 data-id="heading-7">5、四种状态</h3>
<p>websocket有四种只读的状态：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// WebSocket 的四种状态常量</span>
<span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">CONNECTING</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// 连接中</span>
<span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">OPEN</span> = <span class="hljs-number">1</span>; <span class="hljs-comment">// 连接已打开，可以通信</span>
<span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">CLOSING</span> = <span class="hljs-number">2</span>; <span class="hljs-comment">// 连接正在关闭中</span>
<span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">CLOSED</span> = <span class="hljs-number">3</span>; <span class="hljs-comment">// 连接已关闭或无法打开</span>

<span class="hljs-comment">// 实例的readyState属性为当前的状态，使用当前状态和四个状态常量对比即可的得到不同的判断条件</span>
<span class="hljs-comment">// 如</span>
<span class="hljs-keyword">if</span>(socket.<span class="hljs-property">readyState</span> === <span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">OPEN</span>){
  <span class="hljs-comment">// 检测连接正常时触发</span>
}
</code></pre>
<h2 data-id="heading-8">四、具体实战例子</h2>
<blockquote>
<p>以下示例为小编自己的项目在通过WebSocket实时获取沙箱判题状态时的实现👇</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eee1fcda4843492cae0c0bcbc37a85fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWktzaHVu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763557837&amp;x-signature=oSmjj4L%2FM1Jbag4o0mj6lNYlk6s%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-scss" lang="scss">用户提交代码
↓
创建提交记录 (HTTP POST)
↓
建立 WebSocket 连接
↓
接收实时消息 → 更新状态 → UI 刷新
↓
收到 final_result → 自动关闭连接
↓
显示最终结果
</code></pre>
<h3 data-id="heading-9">1、用户点击提交按钮</h3>
<p>用户点击提交之后，首先调用提交代码接口，此时服务端就会启动一个<code>沙箱服务</code>，将用户编写的代码作为沙箱的程序代码，并自动运行测试用例至沙箱内，然后响应本次提交的ID至客户端，<strong>客户端立即基于提交ID建立与服务端的WebSocket连接，实时获取沙箱程序的运行状态展示到页面中！</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 调用提交代码接口（传递题目id、代码、语言）</span>
<span class="hljs-keyword">async</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">problemId: <span class="hljs-built_in">number</span>, code: <span class="hljs-built_in">string</span>, language: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-comment">// 1. 发送 HTTP 请求创建提交记录</span>
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/submit'</span>, {
    <span class="hljs-attr">problem_id</span>: problemId,
    code,
    language
  })
  <span class="hljs-keyword">const</span> submit = response.<span class="hljs-property">data</span>

  <span class="hljs-comment">// 2. 自动建立 WebSocket 连接监听结果（传递响应的提交id）</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setupWebSocketConnection</span>(submit.<span class="hljs-property">id</span>)
}
</code></pre>
<h3 data-id="heading-10">2、Websocket连接管理</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 声明一个建立连接类，在类内部再声明一个connect连接方法</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SubmitWebSocket</span> {
  <span class="hljs-comment">// 建立连接方法</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">connect</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-keyword">const</span> url = <span class="hljs-string">`<span class="hljs-subst">${baseUrl}</span>/ws/submit/<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.submitId}</span>?token=<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.token}</span>`</span>
    <span class="hljs-comment">// 1. 实例化一个websocket</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(url)

    <span class="hljs-comment">// 2. 设置消息监听器</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> message = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(event.<span class="hljs-property">data</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">WebSocketMessage</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">onMessage</span>?.(message) <span class="hljs-comment">// 触发回调函数</span>
    }
  }
}
</code></pre>
<h3 data-id="heading-11">3、实时消息处理</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 在 store 中处理 WebSocket 消息</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">setupWebSocketConnection</span>(<span class="hljs-params">submitId: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">const</span> websocket = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SubmitWebSocket</span>(submitId, <span class="hljs-variable language_">this</span>.<span class="hljs-property">token</span>)

  websocket.<span class="hljs-property">onMessage</span> = <span class="hljs-function">(<span class="hljs-params">message: WebSocketMessage</span>) =&gt;</span> {
    <span class="hljs-comment">// 根据消息类型更新状态</span>
    <span class="hljs-keyword">switch</span> (message.<span class="hljs-property">type</span>) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'status_update'</span>:
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentSubmit</span>!.<span class="hljs-property">status</span> = message.<span class="hljs-property">data</span>.<span class="hljs-property">status</span>
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-string">'test_case_result'</span>:
        <span class="hljs-comment">// 更新测试用例结果</span>
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-string">'final_result'</span>:
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentSubmit</span>!.<span class="hljs-property">result</span> = message.<span class="hljs-property">data</span>
        websocket.<span class="hljs-title function_">close</span>() <span class="hljs-comment">// 收到最终结果后关闭连接</span>
        <span class="hljs-keyword">break</span>
    }
  }
}
</code></pre>
<h2 data-id="heading-12">五、生产环境避坑（重点）</h2>
<p>小编在完成这个功能之后，发现<strong>开发环境正常</strong>，但是<strong>生产环境会报错无法升级HTTP-&gt;WebSocket</strong>，经过一个老师的提醒，发现如果使用nginx来部署前端应用，我们还要<strong>完成nginx的相关配置</strong>才能使用WebSocket功能，具体配置如下：</p>
<pre><code class="hljs language-nginx" lang="nginx">server {
  listen 80;
  server_name http://your-domain.com;

  location /ws/ {
    proxy_pass http://localhost:8080; # 你的 WebSocket 服务器地址

    # WebSocket 必需的三行配置
    proxy_http_version 1.1; # 必需：HTTP 1.1 支持协议升级
    proxy_set_header Upgrade $http_upgrade; # 必需：处理升级头
    proxy_set_header Connection "upgrade"; # 必需：设置连接类型
    proxy_read_timeout 3600s; # 重要：长连接超时

    # 可选的基础头信息
    proxy_set_header Host $host;
  }

  # 其它配置...
}
</code></pre>
<p><strong>那么为什么开发环境正常，生产环境却需要进行websocket的相关配置呢？</strong></p>
<ul>
<li><strong>开发环境</strong></li>
</ul>

<pre><code class="hljs language-scss" lang="scss">前端 (http://localhost:<span class="hljs-number">3000</span>)
↓ 直接连接
后端 WebSocket (后端ws接口地址)
</code></pre>
<p>开发环境下前端直连后端服务，不经过Nginx的反向代理，所以可以直接升级为WebSocket连接</p>
<ul>
<li><strong>生产环境（需要Nginx代理）</strong></li>
</ul>

<pre><code class="hljs language-less" lang="less">用户浏览器 → <span class="hljs-selector-tag">Nginx</span> (<span class="hljs-attribute">https</span>:<span class="hljs-comment">//your-domain.com) → 多个后端服务器</span>
</code></pre>
<p>WebSocket 使用 HTTP 协议升级机制，在生产环境下前端调用接口服务需要经过 Nginx代理，所以Nginx需要正确处理这个升级过程</p>
<blockquote>
<p>以上是小编通过自己在websocket功能的实现过程中总结出来的一些东西，如果有误请各位大佬指出，感激不尽！</p>
</blockquote>
<h2 data-id="heading-13">六、状态管理和重连机制</h2>
<p>websocket的连接有时候会意外断开（网络问题、服务器故障等等），为了保证用户体验，对于意外断开的连接一般情况下会有重连机制进行处理</p>
<h3 data-id="heading-14">1. 简单实现</h3>
<p>声明一个标志变量<code>isManualClose</code>表示是否为正常关闭连接，在用户主动关闭连接事件中设置其值为true，其余情况下皆为false，<strong>在连接关闭事件中据此值来决定是否重连</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> isManualClose = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 默认不是手动关闭</span>

ws.<span class="hljs-property">onclose</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (!isManualClose) {
    <span class="hljs-comment">// 只有意外断开才重连</span>
    <span class="hljs-title function_">startReconnect</span>();
  }
};

<span class="hljs-comment">// 用户主动断开连接</span>
disconnectButton.<span class="hljs-property">onclick</span> = <span class="hljs-function">() =&gt;</span> {
  isManualClose = <span class="hljs-literal">true</span>; <span class="hljs-comment">// ⭐ 标记为手动关闭</span>
  ws.<span class="hljs-title function_">close</span>(); <span class="hljs-comment">// 现在 onclose 不会触发重连</span>
};

<span class="hljs-comment">// 用户跳转到其他页面，主动关闭WebSocket</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-function">() =&gt;</span> {
  isManualClose = <span class="hljs-literal">true</span>;
  ws.<span class="hljs-title function_">close</span>();
});
</code></pre>
<blockquote>
<p><code>isManualClose</code>的值可以有很多标识和判断来决定，小编觉得具体的可以与后端的同学一起来制定约束</p>
</blockquote>
<h3 data-id="heading-15">2. 指数退避+有限尝试</h3>
<p>利用指数退避算法来计算重连的间隔，并设置最大间隔来防止客户端无限重连（浪费带宽）。根据业务场景，如需要的话还可以设置最大重连次数，当达到最大重连次数时，停止重连逻辑（有限尝试），思路与指数退避是类似的！</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 关键参数</span>
<span class="hljs-keyword">let</span> reconnectInterval = <span class="hljs-number">1000</span>; <span class="hljs-comment">// 初始间隔：1秒</span>
<span class="hljs-keyword">let</span> maxReconnectInterval = <span class="hljs-number">30000</span>; <span class="hljs-comment">// 最大间隔：30秒</span>
<span class="hljs-keyword">let</span> reconnectDecay = <span class="hljs-number">1.5</span>; <span class="hljs-comment">// 增长倍数：1.5倍</span>
<span class="hljs-keyword">let</span> reconnectAttempts = <span class="hljs-number">0</span>; <span class="hljs-comment">// 重连次数</span>
<span class="hljs-keyword">let</span> maxAttempts = <span class="hljs-number">50</span>; <span class="hljs-comment">// 最大尝试次数</span>

<span class="hljs-comment">// 每次重连时计算新间隔</span>
reconnectInterval = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(reconnectInterval * reconnectDecay, maxReconnectInterval);

<span class="hljs-comment">// 第1次重连: 1秒后</span>
<span class="hljs-comment">// 第2次重连: 1.5秒后 (1000 × 1.5)</span>
<span class="hljs-comment">// 第3次重连: 2.25秒后 (1500 × 1.5)</span>
<span class="hljs-comment">// 第4次重连: 3.375秒后 (2250 × 1.5)</span>
<span class="hljs-comment">// ...</span>
<span class="hljs-comment">// 直到达到最大30秒间隔</span>
<span class="hljs-comment">// 当间隔达到30秒时，重连频率很低，相当于软限制</span>

<span class="hljs-comment">// 判断是否需要重连</span>
<span class="hljs-title function_">shouldReconnect</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> !<span class="hljs-variable language_">this</span>.<span class="hljs-property">isManualClose</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">reconnectAttempts</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxAttempts</span>;
}

<span class="hljs-comment">// 计算下一次重连间隔</span>
<span class="hljs-title function_">calculateNextInterval</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 基础指数退避计算</span>
  reconnectInterval = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(reconnectInterval * reconnectDecay, maxReconnectInterval);
  <span class="hljs-keyword">return</span> reconnectInterval
}

<span class="hljs-comment">// 启动重连</span>
<span class="hljs-title function_">startReconnect</span>(<span class="hljs-params"/>){
  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">shouldReconnect</span>()) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'不满足重连条件，停止重连'</span>);
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-comment">// 避免重复启动（每次重连先清理上一次的定时器）</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">reconnectTimer</span>) {
    <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">reconnectTimer</span>);
  }
  <span class="hljs-comment">// 更新重连状态</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">reconnectAttempts</span>++;<span class="hljs-variable language_">this</span>.<span class="hljs-property">isReconnecting</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-comment">// 计算下一次重连间隔（指数退避）</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentInterval</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calculateNextInterval</span>();

  <span class="hljs-comment">// 设置重连定时器</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">reconnectTimer</span> = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeReconnect</span>(); <span class="hljs-comment">// 需要重新建立ws连接</span>
  },<span class="hljs-variable language_">this</span>.<span class="hljs-property">reconnectInterval</span>);
}

socket.<span class="hljs-property">onclose</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">shouldReconnect</span>()) {
    <span class="hljs-comment">// 只有意外断开才重连</span>
    <span class="hljs-title function_">startReconnect</span>();
  }
};

socket.<span class="hljs-property">onopen</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
  <span class="hljs-comment">// 连接成功时重置所有重连参数</span>
  reconnectInterval = <span class="hljs-number">1000</span>;
  reconnectAttempts = <span class="hljs-number">0</span>;
};
</code></pre>
<h2 data-id="heading-16">七、心跳机制</h2>
<p>websocket的心跳机制作用于检测连接是否真实存活（避免假连接，适用于生产环境），并在连接断开时及时发现。为什么需要心跳？</p>
<ul>
<li>WebSocket 基于 TCP，但 <code>TCP Keep-Alive</code> 默认关闭或周期极长</li>
<li>中间设备（如我们使用的Nginx代理）一般会设置<strong>空闲超时</strong></li>
<li>若应用层长时间无数据传输，<strong>连接会被静默断开，而客户端毫无感知</strong></li>
</ul>
<p>以下为基于<strong>Ping-Pong模型</strong>实现的心跳机制简易版：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> heartbeatInterval; <span class="hljs-comment">// 心跳定时器</span>
<span class="hljs-keyword">let</span> heartbeatIntervalTime = <span class="hljs-number">30000</span>; <span class="hljs-comment">// 心跳间隔时间（毫秒），默认30秒</span>
<span class="hljs-comment">// 注意：心跳间隔 &lt; min(防火墙超时, 服务端超时, 客户端容忍延迟) / 2 ，否则无效</span>
<span class="hljs-keyword">let</span> heartbeatTimeout; <span class="hljs-comment">// 心跳超时定时器</span>
<span class="hljs-keyword">let</span> heartbeatTimeoutTime = <span class="hljs-number">5000</span>; <span class="hljs-comment">// 心跳超时时间（毫秒），默认5秒</span>

socket.<span class="hljs-property">onopen</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// 其余代码...</span>
  <span class="hljs-comment">// 在连接成功之后启动心跳机制</span>
  <span class="hljs-title function_">startHeartbeat</span>();
}

<span class="hljs-comment">// 收到服务器消息时触发判断</span>
socket.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// 处理心跳响应</span>
  <span class="hljs-keyword">if</span>(event.<span class="hljs-property">data</span> === <span class="hljs-string">'pong'</span>){
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到心跳响应！'</span>);
    <span class="hljs-keyword">if</span>(heartbeatTimeout){
      <span class="hljs-built_in">clearTimeout</span>(heartbeatTimeout);
    }
    <span class="hljs-keyword">return</span>
  }
  <span class="hljs-comment">// 其它代码...</span>
}

<span class="hljs-comment">// 连接关闭时触发</span>
socket.<span class="hljs-property">onclose</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// 其它代码...</span>
  <span class="hljs-comment">// 停止心跳机制</span>
  <span class="hljs-title function_">stopHeartbeat</span>();
  <span class="hljs-comment">// 判断是否需要重连...</span>
}

<span class="hljs-comment">// 发生错误时触发</span>
socket.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// other...</span>
  <span class="hljs-comment">// 停止心跳机制</span>
  <span class="hljs-title function_">stopHeartbeat</span>();
}

<span class="hljs-comment">// 启动心跳机制</span>
<span class="hljs-title function_">startHeartbeat</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 清除之前的心跳定时器</span>
  <span class="hljs-keyword">if</span> (heartbeatInterval) {
    <span class="hljs-built_in">clearInterval</span>(heartbeatInterval);
  }
  <span class="hljs-comment">// 设置心跳定时器，定期发送心跳消息</span>
  heartbeatInterval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (socket &amp;&amp; socket.<span class="hljs-property">readyState</span> === <span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">OPEN</span>) {
      socket.<span class="hljs-title function_">send</span>(<span class="hljs-string">'ping'</span>);
      <span class="hljs-comment">// 设置心跳超时定时器（目的是检测是否收到pong）</span>
      heartbeatTimeout = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'心跳超时，连接可能已断开'</span>);
        <span class="hljs-title function_">addMessage</span>(<span class="hljs-string">'心跳超时，连接可能已断开'</span>, <span class="hljs-string">'received'</span>);
        <span class="hljs-comment">// 主动关闭连接以触发重连机制</span>
        <span class="hljs-keyword">if</span> (socket) {
          socket.<span class="hljs-title function_">close</span>();
        }
      }, heartbeatTimeoutTime);
    }
  }, heartbeatIntervalTime);
}

<span class="hljs-comment">// 停止心跳机制</span>
<span class="hljs-title function_">stopHeartbeat</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (heartbeatInterval) {
    <span class="hljs-built_in">clearInterval</span>(heartbeatInterval);
    heartbeatInterval = <span class="hljs-literal">null</span>;
  }
  <span class="hljs-keyword">if</span> (heartbeatTimeout) {
    <span class="hljs-built_in">clearTimeout</span>(heartbeatTimeout);
    heartbeatTimeout = <span class="hljs-literal">null</span>;
  }
}
</code></pre>
<h2 data-id="heading-17">八、消息队列与流量控制</h2>
<p>如果你使用的websocket涉及到大量、密集的消息需要同段事件发送，为了防止网络拥塞，可以通过消息队列来进行缓冲，将待发送的消息推入消息队列缓冲，以此保证消息数据在网络拥塞/连接断开的时候不会丢失。</p>
<p>消息队列的工作流程大致为：</p>
<pre><code class="hljs">应用层发送消息
↓
检查连接状态
↓
连接可用 → 立即发送
连接不可用 → 加入队列
↓
监听连接恢复事件
↓
连接恢复 → 按顺序发送队列中消息
↓
发送成功 → 从队列移除
发送失败 → 标记重试或丢弃
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> messageQueue = []; <span class="hljs-comment">// 消息队列</span>
<span class="hljs-keyword">let</span> isSending = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 是否正在发送消息</span>
<span class="hljs-keyword">let</span> sendRateLimit = <span class="hljs-number">10</span>; <span class="hljs-comment">// 每秒最大发送消息数</span>
<span class="hljs-keyword">let</span> sendInterval = <span class="hljs-number">1000</span> / sendRateLimit; <span class="hljs-comment">// 发送间隔（毫秒）</span>
<span class="hljs-keyword">let</span> sendTimer = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 发送定时器</span>

socket.<span class="hljs-property">onopen</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// 其余代码...</span>
  <span class="hljs-comment">// 开始处理消息队列</span>
  <span class="hljs-title function_">processMessageQueue</span>();
}

<span class="hljs-comment">// 连接关闭时触发</span>
socket.<span class="hljs-property">onclose</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// 其它代码...</span>
  <span class="hljs-comment">// 停止消息推送</span>
  <span class="hljs-title function_">stopMessageSending</span>();
  <span class="hljs-comment">// 判断是否需要重连...</span>
}

<span class="hljs-comment">// 发生错误时触发</span>
socket.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// other...</span>
  <span class="hljs-comment">// 停止消息推送</span>
  <span class="hljs-title function_">stopMessageSending</span>();
}

<span class="hljs-comment">// 将消息添加到队列</span>
<span class="hljs-title function_">enqueueMessage</span>(<span class="hljs-params">message, priority = <span class="hljs-number">0</span></span>) {
  <span class="hljs-comment">// 创建消息对象</span>
  <span class="hljs-keyword">const</span> messageObj = {
    <span class="hljs-attr">content</span>: message,
    <span class="hljs-attr">priority</span>: priority, <span class="hljs-comment">// 优先级，数值越大优先级越高</span>
    <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() <span class="hljs-comment">// 时间戳</span>
  };

  <span class="hljs-comment">//if (priority &gt; 0) {</span>
  <span class="hljs-comment">// //根据优先级插入消息队列</span>
  <span class="hljs-comment">//} else {</span>
  <span class="hljs-comment">// // 普通消息添加到队列末尾</span>
  <span class="hljs-comment">//}</span>

  messageQueue.<span class="hljs-title function_">push</span>(messageObj);
}

<span class="hljs-comment">// 处理消息队列</span>
<span class="hljs-title function_">processMessageQueue</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (sendTimer) {
    <span class="hljs-built_in">clearInterval</span>(sendTimer);
  }
  <span class="hljs-comment">// 定时处理消息队列</span>
  sendTimer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (messageQueue.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> &amp;&amp; socket &amp;&amp; socket.<span class="hljs-property">readyState</span> === <span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">OPEN</span>) {
      <span class="hljs-comment">// 取出队列中的第一条消息</span>
      <span class="hljs-keyword">const</span> messageObj = messageQueue.<span class="hljs-title function_">shift</span>();
      socket.<span class="hljs-title function_">send</span>(messageObj.<span class="hljs-property">content</span>);
    }
  }, sendInterval);
}

<span class="hljs-comment">// 停止消息发送</span>
<span class="hljs-title function_">stopMessageSending</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (sendTimer) {
    <span class="hljs-built_in">clearInterval</span>(sendTimer);
    sendTimer = <span class="hljs-literal">null</span>;
  }
}

<span class="hljs-comment">// 设置发送速率（每秒消息数）</span>
<span class="hljs-title function_">setSendRate</span>(<span class="hljs-params">rate</span>) {
  <span class="hljs-keyword">if</span> (rate &gt; <span class="hljs-number">0</span> &amp;&amp; rate &lt;= <span class="hljs-number">100</span>) {
    sendRateLimit = rate;
    sendInterval = <span class="hljs-number">1000</span> / sendRateLimit;

    <span class="hljs-comment">// 重新启动消息处理定时器</span>
    <span class="hljs-keyword">if</span> (socket &amp;&amp; socket.<span class="hljs-property">readyState</span> === <span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">OPEN</span>) {
      <span class="hljs-title function_">processMessageQueue</span>();
    }
  }
}
</code></pre>
<blockquote>
<p>本文到此结束，文中的理解和总结难免有不足之处，如有纰漏或错误，请大家直接指出，小编虚心求教！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>