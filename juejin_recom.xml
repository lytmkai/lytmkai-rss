<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[JavaScript 中 this 的终极解析：从 call、bind 到箭头函数的深度探索]]></title>    <link>https://juejin.cn/post/7585808181240102963</link>    <guid>https://juejin.cn/post/7585808181240102963</guid>    <pubDate>2025-12-22T02:47:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585808181240102963" data-draft-id="7585839411123191854" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 中 this 的终极解析：从 call、bind 到箭头函数的深度探索"/> <meta itemprop="keywords" content="前端,JavaScript,ECMAScript 6"/> <meta itemprop="datePublished" content="2025-12-22T02:47:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AAA阿giao"/> <meta itemprop="url" content="https://juejin.cn/user/473218785740627"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 中 this 的终极解析：从 call、bind 到箭头函数的深度探索
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/473218785740627/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AAA阿giao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:47:59.000Z" title="Mon Dec 22 2025 02:47:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在 JavaScript 编程的世界里，<code>this</code> 是一个既基础又令人困惑的概念。它看似简单，却常常在不经意间“背叛”我们的预期；它灵活多变，却又遵循着一套严格的规则。尤其当与 <code>call</code>、<code>apply</code>、<code>bind</code> 以及 ES6 引入的<strong>箭头函数</strong>结合时，<code>this</code> 的行为变得更加微妙而强大。</p>
<p>本文将结合代码，对 <code>this</code> 的机制进行一次全面、深入且生动的剖析。我们将逐字引用原始代码片段，还原其技术含义，并通过大量示例揭示背后的原理。无论你是初学者还是资深开发者，相信都能从中获得新的洞见。</p>
<hr/>
<h2 data-id="heading-1">一、核心内容</h2>
<p>我们可以将this问题拆解为几个核心命题：</p>
<ol>
<li><strong><code>this</code> 可以被覆盖</strong></li>
<li><strong><code>bind</code> 用于定时器中绑定 <code>this</code>，延迟执行</strong></li>
<li><strong><code>call</code> / <code>apply</code> 可指定 <code>this</code> 指向，并立即运行</strong></li>
<li><strong><code>that = this</code> 利用作用域链保存 <code>this</code></strong></li>
<li><strong>箭头函数没有自己的 <code>this</code>，而是继承父级作用域的 <code>this</code></strong></li>
</ol>
<p>接下来，我们将围绕这五点展开详细论述。</p>
<p>源代码链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2FgiaoZou%2Flesson_zp%2Ftree%2Fmaster%2Fbatjtmd%2Fthis" title="https://gitee.com/giaoZou/lesson_zp/tree/master/batjtmd/this" target="_blank" ref="nofollow noopener noreferrer">lesson_zp/batjtmd/this: AI + 全栈学习仓库</a></p>
<hr/>
<h2 data-id="heading-2">二、this 的默认行为：谁调用，就属于谁</h2>
<p>在深入高级技巧前，必须先理解 <code>this</code> 的<strong>默认绑定规则</strong>。</p>
<h3 data-id="heading-3">1. 全局上下文中的 this</h3>
<p>在非严格模式下，全局作用域中的 <code>this</code> 指向全局对象（浏览器中是 <code>window</code>，Node.js 中是 <code>global</code>）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span> === <span class="hljs-variable language_">window</span>); <span class="hljs-comment">// true (浏览器)</span>
</code></pre>
<p>在严格模式下，全局函数中的 <code>this</code> 为 <code>undefined</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-meta">'use strict'</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">f</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>); }
<span class="hljs-title function_">f</span>(); <span class="hljs-comment">// undefined</span>
</code></pre>
<h3 data-id="heading-4">2. 对象方法中的 this</h3>
<p>当函数作为对象的方法被调用时，<code>this</code> 指向该对象：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>,
  <span class="hljs-title function_">greet</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
  }
};
obj.<span class="hljs-title function_">greet</span>(); <span class="hljs-comment">// "Alice"</span>
</code></pre>
<p>但注意：<strong>函数一旦脱离对象调用，this 就会丢失</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">fn</span> = obj.greet<span class="hljs-comment">;</span>
fn()<span class="hljs-comment">; // 非严格模式下输出 undefined（this 指向 window）</span>
</code></pre>
<p>这就是为什么我们需要 <code>call</code>、<code>bind</code> 等工具来“拯救”迷失的 <code>this</code>。</p>
<hr/>
<h2 data-id="heading-5">三、call 与 apply：强制指定 this，立即执行！</h2>
<h3 data-id="heading-6">原理与语法</h3>
<ul>
<li><code>func.call(thisArg, arg1, arg2, ...)</code></li>
<li><code>func.apply(thisArg, [arg1, arg2, ...])</code></li>
</ul>
<p>两者功能相同，区别仅在于参数传递方式。</p>
<blockquote>
<p>“call apply 指定this 指向 立即运行”</p>
</blockquote>
<p><code>call</code> 和 <code>apply</code> 的核心作用就是在<strong>调用函数的同时</strong>，显式指定 <code>this</code> 的值，并<strong>立刻执行</strong>该函数。</p>
<h3 data-id="heading-7">示例演示</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">introduce</span>(<span class="hljs-params">age</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`I'm <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>, <span class="hljs-subst">${age}</span> years old.`</span>);
}

<span class="hljs-keyword">const</span> person = { <span class="hljs-attr">name</span>: <span class="hljs-string">'Bob'</span> };

introduce.<span class="hljs-title function_">call</span>(person, <span class="hljs-number">25</span>);   <span class="hljs-comment">// I'm Bob, 25 years old.</span>
introduce.<span class="hljs-title function_">apply</span>(person, [<span class="hljs-number">30</span>]); <span class="hljs-comment">// I'm Bob, 30 years old.</span>
</code></pre>
<p>即使 <code>introduce</code> 不是 <code>person</code> 的方法，我们也能让它“假装”是——这就是 <code>this</code> 的灵活性。</p>
<h3 data-id="heading-8">实际应用场景</h3>
<ul>
<li>
<p>数组方法借用（如将类数组转为真数组）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> args = <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">slice</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">arguments</span>);
</code></pre>
</li>
<li>
<p>通用工具函数适配不同上下文。</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-9">四、bind：永久绑定 this，延迟执行</h2>
<h3 data-id="heading-10">原理与语法</h3>
<p><code>func.bind(thisArg, arg1, arg2, ...)</code> 返回一个<strong>新函数</strong>，该函数的 <code>this</code> 被永久绑定到 <code>thisArg</code>，且可预设部分参数（柯里化）。</p>
<blockquote>
<p>“bind 定时器this绑定(a) 以后再执行”</p>
</blockquote>
<p>这句话精准指出了 <code>bind</code> 的两大特点：</p>
<ol>
<li><strong>常用于定时器等异步回调中绑定 <code>this</code></strong></li>
<li><strong>不立即执行，而是返回一个可稍后调用的函数</strong></li>
</ol>
<h3 data-id="heading-11">经典问题：setTimeout 中的 this 丢失</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> timer = {
  <span class="hljs-attr">seconds</span>: <span class="hljs-number">0</span>,
  <span class="hljs-title function_">start</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">setInterval</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">seconds</span>++; <span class="hljs-comment">// ❌ this 指向 global/window</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">seconds</span>);
    }, <span class="hljs-number">1000</span>);
  }
};
timer.<span class="hljs-title function_">start</span>(); <span class="hljs-comment">// 输出 NaN（因为 window.seconds 未定义）</span>
</code></pre>
<h3 data-id="heading-12">解决方案一：使用 bind</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> timer = {
  <span class="hljs-attr">seconds</span>: <span class="hljs-number">0</span>,
  <span class="hljs-title function_">start</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">setInterval</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">seconds</span>++;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">seconds</span>);
    }.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>), <span class="hljs-number">1000</span>); <span class="hljs-comment">// ✅ 绑定外层 this</span>
  }
};
timer.<span class="hljs-title function_">start</span>(); <span class="hljs-comment">// 1, 2, 3...</span>
</code></pre>
<p>这里，<code>.bind(this)</code> 创建了一个新函数，其 <code>this</code> 永久指向 <code>timer</code> 对象，无论何时被调用都不会改变。</p>
<h3 data-id="heading-13">解决方案二：that = this（闭包保存）</h3>
<blockquote>
<p>“that = this; 作用域链保存this且指向”</p>
</blockquote>
<p>这是 ES5 时代的经典写法：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> timer = {
  <span class="hljs-attr">seconds</span>: <span class="hljs-number">0</span>,
  <span class="hljs-title function_">start</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> that = <span class="hljs-variable language_">this</span>; <span class="hljs-comment">// 保存 this 到变量</span>
    <span class="hljs-built_in">setInterval</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      that.<span class="hljs-property">seconds</span>++; <span class="hljs-comment">// 通过闭包访问</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(that.<span class="hljs-property">seconds</span>);
    }, <span class="hljs-number">1000</span>);
  }
};
</code></pre>
<p>虽然有效，但需要额外变量，且在深层嵌套中容易混乱。<code>bind</code> 更加声明式和安全。</p>
<hr/>
<h2 data-id="heading-14">五、箭头函数：没有 this 的“佛系”函数</h2>
<h3 data-id="heading-15">核心特性</h3>
<p>箭头函数（Arrow Function）<strong>没有自己的 <code>this</code></strong>。它不会创建新的 <code>this</code> 上下文，而是<strong>词法地继承外层作用域的 <code>this</code></strong>。</p>
<blockquote>
<p>“Cherry箭头函数放弃了自己的this，没有this 指向指向 父级作用域的this”</p>
</blockquote>
<p>这句话堪称对箭头函数 <code>this</code> 行为的完美概括！</p>
<ul>
<li>“放弃了自己的 this” → 箭头函数内部不存在 <code>this</code> 绑定。</li>
<li>“指向父级作用域的 this” → 它的 <code>this</code> 由定义时的外层作用域决定，与调用方式无关。</li>
</ul>
<h3 data-id="heading-16">示例对比</h3>
<h4 data-id="heading-17">普通函数（this 丢失）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'David'</span>,
  <span class="hljs-title function_">delayedLog</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>); <span class="hljs-comment">// ❌ undefined</span>
    }, <span class="hljs-number">100</span>);
  }
};
obj.<span class="hljs-title function_">delayedLog</span>();
</code></pre>
<h4 data-id="heading-18">箭头函数（自动继承）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Cherry'</span>, <span class="hljs-comment">// 注意：原文特意用了 "Cherry"</span>
  <span class="hljs-title function_">delayedLog</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>); <span class="hljs-comment">// ✅ "Cherry"</span>
    }, <span class="hljs-number">100</span>);
  }
};
obj.<span class="hljs-title function_">delayedLog</span>();
</code></pre>
<p>为什么能成功？因为箭头函数的 <code>this</code> 继承自 <code>delayedLog</code> 方法，而 <code>delayedLog</code> 的 <code>this</code> 指向 <code>obj</code>。</p>
<h3 data-id="heading-19">箭头函数的不可变性</h3>
<p>由于箭头函数没有 <code>this</code>，所以以下操作无效：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">fn</span> = () =&gt; console.log(this.name)<span class="hljs-comment">;</span>
const <span class="hljs-attr">obj</span> = { name: <span class="hljs-string">'Eve'</span> }<span class="hljs-comment">;</span>

fn.call(obj)<span class="hljs-comment">;   // 仍输出全局作用域的 name（或 undefined）</span>
fn.bind(obj)()<span class="hljs-comment">; // 同上</span>
</code></pre>
<p><code>call</code>、<code>apply</code>、<code>bind</code> 对箭头函数的 <code>this</code> <strong>毫无影响</strong>。</p>
<h3 data-id="heading-20">适用场景 vs 陷阱</h3>
<p>✅ <strong>适合</strong>：</p>
<ul>
<li>回调函数（如 <code>map</code>, <code>filter</code>, <code>setTimeout</code>）</li>
<li>避免 <code>that = this</code> 的样板代码</li>
</ul>
<p>❌ <strong>不适合</strong>：</p>
<ul>
<li>对象方法（会继承外层 this，可能不是对象本身）</li>
<li>构造函数（箭头函数不能用 <code>new</code> 调用）</li>
<li>需要动态 <code>this</code> 的场景</li>
</ul>
<hr/>
<h2 data-id="heading-21">六、综合案例：四种方式对比</h2>
<p>假设我们有一个计数器对象，需要在 1 秒后打印当前值：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> counter = {
  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
  
  <span class="hljs-comment">// 方式1：普通函数 + that = this</span>
  <span class="hljs-title function_">method1</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> self = <span class="hljs-variable language_">this</span>;
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'method1:'</span>, self.<span class="hljs-property">count</span>);
    }, <span class="hljs-number">1000</span>);
  },

  <span class="hljs-comment">// 方式2：bind</span>
  <span class="hljs-title function_">method2</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'method2:'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>);
    }.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>), <span class="hljs-number">1000</span>);
  },

  <span class="hljs-comment">// 方式3：箭头函数</span>
  <span class="hljs-title function_">method3</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'method3:'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>);
    }, <span class="hljs-number">1000</span>);
  },

  <span class="hljs-comment">// 方式4：call（需立即执行，不适合定时器，但可模拟）</span>
  <span class="hljs-title function_">method4</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> fn = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'method4:'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>); };
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> fn.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>), <span class="hljs-number">1000</span>); <span class="hljs-comment">// 结合箭头+call</span>
  }
};

counter.<span class="hljs-title function_">method1</span>(); <span class="hljs-comment">// 0</span>
counter.<span class="hljs-title function_">method2</span>(); <span class="hljs-comment">// 0</span>
counter.<span class="hljs-title function_">method3</span>(); <span class="hljs-comment">// 0</span>
counter.<span class="hljs-title function_">method4</span>(); <span class="hljs-comment">// 0</span>
</code></pre>
<p>四种方式都能正确输出，但<strong>箭头函数最简洁</strong>，<strong>bind 最显式</strong>，<strong>that = this 最传统</strong>。</p>
<hr/>
<h2 data-id="heading-22">七、this 绑定优先级总结</h2>
<p>当多个规则同时存在时，JavaScript 按以下优先级确定 <code>this</code>：</p>
<ol>
<li><strong>new 绑定</strong>（构造函数）→ 最高</li>
<li><strong>显式绑定</strong>（<code>call</code> / <code>apply</code> / <code>bind</code>）</li>
<li><strong>隐式绑定</strong>（对象方法调用，如 <code>obj.fn()</code>）</li>
<li><strong>默认绑定</strong>（独立函数调用）</li>
</ol>
<blockquote>
<p>箭头函数不参与此规则，因为它根本没有 <code>this</code>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-23">八、常见误区与最佳实践</h2>
<h3 data-id="heading-24">误区1：认为箭头函数总是更好</h3>
<p>错！箭头函数在对象方法中会导致 <code>this</code> 指向外层（可能是全局）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> badObj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Bad'</span>,
  <span class="hljs-attr">getName</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> <span class="hljs-comment">// ❌ this 指向全局</span>
};
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(badObj.<span class="hljs-title function_">getName</span>()); <span class="hljs-comment">// undefined</span>
</code></pre>
<p>应使用普通函数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> goodObj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Good'</span>,
  <span class="hljs-title function_">getName</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>; } <span class="hljs-comment">// ✅</span>
};
</code></pre>
<h3 data-id="heading-25">误区2：bind 后还能被 call 覆盖</h3>
<p>不能！<code>bind</code> 创建的函数其 <code>this</code> 是<strong>永久锁定</strong>的：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">f</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>); }
<span class="hljs-keyword">const</span> bound = f.<span class="hljs-title function_">bind</span>({<span class="hljs-attr">x</span>: <span class="hljs-number">1</span>});
bound.<span class="hljs-title function_">call</span>({<span class="hljs-attr">x</span>: <span class="hljs-number">2</span>}); <span class="hljs-comment">// 输出 1，不是 2！</span>
</code></pre>
<h3 data-id="heading-26">最佳实践</h3>
<ul>
<li>在类方法或对象方法中，使用普通函数。</li>
<li>在回调、事件监听、定时器中，优先考虑箭头函数。</li>
<li>若需兼容旧环境或需要预设参数，使用 <code>bind</code>。</li>
<li>避免过度使用 <code>that = this</code>，除非在不支持箭头函数的环境中。</li>
</ul>
<hr/>
<h2 data-id="heading-27">九、结语：掌握 this，就是掌握 JavaScript 的灵魂</h2>
<p>现在，我们不仅读懂了它，更理解了其背后的技术哲学：</p>
<ul>
<li><strong><code>call</code>/<code>apply</code></strong> 是“命令式”的干预——我要你现在就用这个 <code>this</code>！</li>
<li><strong><code>bind</code></strong> 是“防御式”的设计——无论何时调用，都必须用这个 <code>this</code>！</li>
<li><strong><code>that = this</code></strong> 是“妥协式”的智慧——既然你靠不住，我就自己存一份！</li>
<li><strong>箭头函数</strong> 是“声明式”的优雅——我不需要 <code>this</code>，我信任我的上下文！</li>
</ul>
<p>JavaScript 的魅力，正在于这种灵活性与规则性的统一。当你能自如地在这些工具之间切换，你就不再是 <code>this</code> 的奴隶，而是它的主人。</p>
<p>愿你在未来的代码中，不再对 <code>this</code> 感到迷茫，而是微笑着说：</p>
<blockquote>
<p>“我知道你是谁，也知道你该去哪。”</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在 Kubernetes 上通过 .NET + Argo Workflows 实现大规模并行仿真实验]]></title>    <link>https://juejin.cn/post/7586208617603366946</link>    <guid>https://juejin.cn/post/7586208617603366946</guid>    <pubDate>2025-12-22T03:23:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586208617603366946" data-draft-id="7585888537642450959" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在 Kubernetes 上通过 .NET + Argo Workflows 实现大规模并行仿真实验"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-12-22T03:23:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="gohchunlin"/> <meta itemprop="url" content="https://juejin.cn/user/3491704660036302"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在 Kubernetes 上通过 .NET + Argo Workflows 实现大规模并行仿真实验
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3491704660036302/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    gohchunlin
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:23:47.000Z" title="Mon Dec 22 2025 03:23:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>最近我处理了一个离散事件仿真（Discrete Event Simulation，DES）的项目，面临一个经典难题：代码逻辑完全正确，但运行速度慢到令人绝望。</p>
<p>如果按照传统的单机思路，完成一次可靠的蒙特卡洛（Monte Carlo）实验需要到 2026 年才能跑出结果。本文将分享我如何打利用 Kubernetes （K8s） 和 Argo Workflows 构建一套“仿真实验室”，实现算力跃升。</p>
<h2 data-id="heading-1">核心痛点：为什么“加 CPU”解决不了问题？</h2>
<p>在离散事件仿真中，系统的完整性依赖于一个<strong>统一的虚拟时钟</strong>和<strong>中央未来事件列表（Future Event List, FEL）</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/197ecf5cebc8414185371a5a5139fb12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29oY2h1bmxpbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978627&amp;x-signature=9FuJE1Ep44sZTIiI3o6yRJMnhIg%3D" alt="" loading="lazy"/></p>
<p>DES 的核心逻辑是严格按时间顺序处理事件。这意味着：</p>
<ul>
<li>你无法将单个仿真任务拆分到多个 Pod 上跑。</li>
<li>各节点间的网络延迟会彻底摧毁事件的因果链。</li>
<li><strong>结论：</strong> 单次仿真任务在架构上是<strong>天然单线程</strong>的。</li>
</ul>
<p>虽然我们无法并行化“单个仿真”，但我们可以并行化“整个实验”。这是一个典型的 <strong>“尴尬并行”（Embarrassingly Parallel）</strong> 场景。</p>
<h2 data-id="heading-2">架构设计：从“服务器”转向“实验室”</h2>
<p>为了解决 5,000 次参数扫频（Parameter Sweeps）的需求，我将 Kubernetes 从一个“托管网站的平台”转化为一台“按需使用的超级计算机”。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52d10789b1b24dde827de9d864ee11ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29oY2h1bmxpbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978627&amp;x-signature=zm80z4Mqx9u6FbuSlCnVbaydhxw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">执行引擎：Headless .NET 10</h3>
<p>底层基于 .NET Console 程序，关键点在于利用 System.CommandLine 建立容器与编排器之间的<strong>严格契约</strong>。</p>
<p>我们将仿真变量设置为 CLI 参数。</p>
<pre><code class="hljs language-dart" lang="dart">using System.CommandLine;

<span class="hljs-comment">// 定义根命令</span>
<span class="hljs-keyword">var</span> rootCommand = <span class="hljs-keyword">new</span> RootCommand { Description = <span class="hljs-string">"离散事件仿真 CLI 工具"</span> };

<span class="hljs-comment">// 核心参数：平均到达时间</span>
<span class="hljs-keyword">var</span> meanArrivalSecondsOption = <span class="hljs-keyword">new</span> Option&lt;<span class="hljs-built_in">double</span>&gt;(
    name: <span class="hljs-string">"--arrival-secs"</span>,
    description: <span class="hljs-string">"Mean arrival time in seconds."</span>,
    getDefaultValue: () =&gt; <span class="hljs-number">5.0</span>
);

<span class="hljs-keyword">var</span> simpleServerCommand = <span class="hljs-keyword">new</span> Command(<span class="hljs-string">"simple-server"</span>, <span class="hljs-string">"运行仿真演示"</span>);
simpleServerCommand.AddOption(meanArrivalSecondsOption);

simpleServerCommand.SetHandler((<span class="hljs-built_in">double</span> meanArrivalSeconds) =&gt;
{
    <span class="hljs-comment">// 这里的逻辑是单线程的，但它是可配置的</span>
    SimpleServerAndGenerator.RunDemo(loggerFactory, meanArrivalSeconds);
}, meanArrivalSecondsOption);
</code></pre>
<h3 data-id="heading-4">任务编排：Argo Workflows</h3>
<p>很多人第一反应是使用原生 K8s Job。但在大规模场景下，原生 Job 太过简陋，难以可视化，且异常处理成本极高。</p>
<p>我选择了 <strong>Argo Workflows</strong>。它的杀手锏是 withItems（或 withParam），可以轻松实现<strong>扇出（Fan-out）</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">argoproj.io/v1alpha1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Workflow</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">generateName:</span> <span class="hljs-string">sna-parallel-experiment-</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">entrypoint:</span> <span class="hljs-string">sna-demo</span>
  <span class="hljs-attr">templates:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">sna-demo</span>
    <span class="hljs-attr">steps:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">run-simulation</span>
        <span class="hljs-attr">template:</span> <span class="hljs-string">simulation-job</span>
        <span class="hljs-attr">arguments:</span>
          <span class="hljs-attr">parameters:</span> [{<span class="hljs-attr">name:</span> <span class="hljs-string">arrival-secs</span>, <span class="hljs-attr">value:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{item}}</span>"</span>}]
        <span class="hljs-comment"># 核心：定义参数池，Argo 会自动调度成百上千的 Pod 并发执行</span>
        <span class="hljs-attr">withItems:</span> [<span class="hljs-string">"5"</span>, <span class="hljs-string">"10"</span>, <span class="hljs-string">"15"</span>, <span class="hljs-string">"20"</span>, <span class="hljs-string">"25"</span>] 

  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">simulation-job</span>
    <span class="hljs-attr">inputs:</span>
      <span class="hljs-attr">parameters:</span> [{<span class="hljs-attr">name:</span> <span class="hljs-string">arrival-secs</span>}]
    <span class="hljs-attr">container:</span>
      <span class="hljs-attr">image:</span> <span class="hljs-string">my-registry/sna-demo:latest</span>
      <span class="hljs-attr">args:</span> [<span class="hljs-string">"demo"</span>, <span class="hljs-string">"simple-server"</span>, <span class="hljs-string">"--arrival-secs"</span>, <span class="hljs-string">"<span class="hljs-template-variable">{{inputs.parameters.arrival-secs}}</span>"</span>]
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/276d08d3e8df4167811067428bc28dd2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29oY2h1bmxpbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978627&amp;x-signature=V21tZI4TjxDMLIK6KcqmGE0Tce4%3D" alt="" loading="lazy"/></p>
<p>Argo 帮我们处理了节流（Throttling）、并发控制和失败重试，我们只需声明实验目标。</p>
<h3 data-id="heading-5">结构化日志</h3>
<p>当一千个 Pod 同时运行时，kubectl logs 毫无意义。我们所要面对的是每分钟数大量的文本流。</p>
<p>因此，我们必须弃用纯文本日志，改用 <strong>结构化日志 (Structured Logging)</strong>。通过 Serilog 将参数和结果绑定为 JSON：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"Timestamp"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-05-20T10:00:00"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"Level"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Information"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"Message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Simulation Completed"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"Properties"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"WorkerCount"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ServiceTime"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">12.5</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"Throughput"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.98</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c7724ded21d4b06873313af21e0473e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29oY2h1bmxpbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978627&amp;x-signature=HllnWYa%2FFXwdWVDHWfE1caaaHJk%3D" alt="" loading="lazy"/></p>
<p>配合 <strong>Seq</strong> 或 <strong>ELK</strong>，我们就可以直接通过 SQL 语句在几万份实验结果中精准定位异常点。</p>
<h2 data-id="heading-6">实战复盘</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a022624743dc46329e69c114b26353d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29oY2h1bmxpbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978627&amp;x-signature=286usV3R9RNVSKwDuvb%2BFWBya2Q%3D" alt="" loading="lazy"/></p>
<p>在最近的台北 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fhwdc.ithome.com.tw%2F2025%2Fsession-page%2F4063" target="_blank" title="https://hwdc.ithome.com.tw/2025/session-page/4063" ref="nofollow noopener noreferrer">Hello World Developer Conference 2025</a></strong> 上，我也分享了这一模型。通过这套架构：</p>
<ol>
<li><strong>开发效率：</strong> C# 核心逻辑无需任何分布式改造。</li>
<li><strong>算力利用：</strong> 以前单机跑一周的实验，现在在 K8s 集群上 10 分钟内跑完。</li>
<li><strong>可维护性：</strong> 所有的实验参数都是声明式的，可追溯、可重现。</li>
</ol>
<h3 data-id="heading-7">总结</h3>
<p>Kubernetes 的强大不仅在于托管微服务，更在于它处理<strong>大规模并发计算</strong>的能力。通过将“执行引擎”与“编排大脑”解耦，我们能让老旧的单线程程序在云原生时代焕发新生。</p>
<p><strong>项目开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgcl-team%2FSNA**" target="_blank" title="https://github.com/gcl-team/SNA**" ref="nofollow noopener noreferrer">github.com/gcl-team/SN…</a> (欢迎交流指正)</p>
<p>--------</p>
<p><em>作者简介：坐标新加坡，20年架构/SRE经验。专注可观测性 (O11y) 与系统稳定性。Grafana &amp; Friends SG 社区主理人。 业余项目：正在开发 SNA。试图用算法模拟高并发场景下的排队论与系统瓶颈（用 AI 辅助构建）。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[利用 WebMKS 和 Java 实现前端访问虚拟机网页]]></title>    <link>https://juejin.cn/post/7586157459971538996</link>    <guid>https://juejin.cn/post/7586157459971538996</guid>    <pubDate>2025-12-22T02:55:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586157459971538996" data-draft-id="7585850609017110543" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="利用 WebMKS 和 Java 实现前端访问虚拟机网页"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-22T02:55:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="404NotFound305"/> <meta itemprop="url" content="https://juejin.cn/user/270910253182796"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            利用 WebMKS 和 Java 实现前端访问虚拟机网页
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/270910253182796/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    404NotFound305
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:55:56.000Z" title="Mon Dec 22 2025 02:55:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">实战干货：手把手教你用 WebMKS 和 Java 搞定 ESXi 虚拟机网页控制台</h2>
<p>最近在折腾虚拟机网页控制台，发现用 VMware 原生的 WebMKS SDK 配合 ESXi 的 API 效果最好。这套方案不用装插件，直接在浏览器里就能操作。把中间踩过的坑和实现逻辑整理出来，希望能帮到大家。</p>
<hr/>
<h3 data-id="heading-1">1. 准备工作：依赖得放本地</h3>
<p>WebMKS 这个 SDK 比较老派，它离不开 <strong>jQuery</strong>。为了稳妥，别用 CDN，直接把这几个文件下载下来放到你项目的 <code>public/static/wmks</code> 目录下。</p>
<h4 data-id="heading-2">怎么引入？</h4>
<p>在 <code>index.html</code> 里按这个顺序排好，jQuery 必须在最前面，不然 SDK 报错。</p>
<p>HTML</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/static/wmks/css/wmks-all.css"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/static/wmks/jquery.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/static/wmks/jquery-ui.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/static/wmks/wmks.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-3">2. 后端：Java 怎么拿 Ticket</h3>
<p>控制台连接前得先要个“门票”（Ticket）。后端用 Java 调用官方的 <code>vijava</code> 库，去 ESXi 那里申请一个。</p>
<p><strong>核心逻辑：</strong></p>
<ol>
<li>连上 ESXi。</li>
<li>靠 UUID 找到那台虚拟机。</li>
<li>申请一个类型叫 <code>webmks</code> 的票据。</li>
</ol>
<p>Java</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> TicketInfo <span class="hljs-title function_">getVmTicket</span><span class="hljs-params">(String host, String user, String pwd, String vmUuid)</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-comment">// 建立连接</span>
    <span class="hljs-type">ServiceInstance</span> <span class="hljs-variable">si</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceInstance</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">"https://"</span> + host + <span class="hljs-string">"/sdk"</span>), user, pwd, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">InventoryNavigator</span> <span class="hljs-variable">nav</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InventoryNavigator</span>(si.getRootFolder());
        <span class="hljs-type">VirtualMachine</span> <span class="hljs-variable">vm</span> <span class="hljs-operator">=</span> (VirtualMachine) nav.searchManagedEntity(<span class="hljs-string">"VirtualMachine"</span>, vmUuid);
        
        <span class="hljs-comment">// 关键：拿 webmks 票据</span>
        <span class="hljs-type">VirtualMachineTicket</span> <span class="hljs-variable">vmt</span> <span class="hljs-operator">=</span> vm.acquireTicket(<span class="hljs-string">"webmks"</span>);
        
        <span class="hljs-comment">// 把票据、主机IP、端口发给前端</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TicketInfo</span>(vmt.getTicket(), vmt.getHost(), <span class="hljs-number">443</span>);
    } <span class="hljs-keyword">finally</span> {
        si.getServerConnection().logout(); <span class="hljs-comment">// 记得退出登录，不然会话堆积</span>
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-4">3. 前端：Vue 3 里的核心控制</h3>
<h4 data-id="heading-5">初始化连接</h4>
<p>在 Vue 里的思路是：拿到票据后，立刻初始化 SDK 并连上 WebSocket。</p>
<p>TypeScript</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">startWMKS</span> = (<span class="hljs-params">ticket: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">WMKS_LIB</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">WMKS</span>;
  
  <span class="hljs-comment">// 初始化配置</span>
  wmksInstance.<span class="hljs-property">value</span> = <span class="hljs-variable constant_">WMKS_LIB</span>.<span class="hljs-title function_">createWMKS</span>(<span class="hljs-string">"wmks-container"</span>, {
    <span class="hljs-attr">enableHints</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">changeResolutionOnResizing</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 窗口变了，分辨率也跟着变</span>
    <span class="hljs-attr">rescaleOnParentResize</span>: <span class="hljs-literal">true</span>,      <span class="hljs-comment">// 自动缩放</span>
    <span class="hljs-attr">position</span>: <span class="hljs-string">'absolute'</span>
  });

  <span class="hljs-comment">// 连上 ESXi 的 443 端口</span>
  wmksInstance.<span class="hljs-property">value</span>.<span class="hljs-title function_">connect</span>(<span class="hljs-string">`wss://<span class="hljs-subst">${activeVM.value.host}</span>:443/ticket/<span class="hljs-subst">${ticket}</span>`</span>);
};
</code></pre>
<h4 data-id="heading-6">全屏怎么变清晰？</h4>
<p>全屏时如果直接拉伸，画面会糊。我的办法是：<strong>先断开，变全屏，再重连</strong>。虽然多等了半秒，但画面会根据全屏后的尺寸重新协商，清晰度瞬间提升。</p>
<hr/>
<h3 data-id="heading-7">4. Windows 虚拟机的专项关照</h3>
<p>搞 Linux 基本没啥事，但 Windows 挺挑剔，这几点没做到肯定出问题：</p>
<ol>
<li><strong>必装 VMware Tools</strong>：不装的话，显卡驱动不行，画面传输慢甚至直接黑屏。</li>
<li><strong>显存给够</strong>：Windows 10 这种系统，显存起码给到 <strong>128MB</strong>。</li>
<li><strong>CAD 按钮</strong>：Windows 登录得按 <code>Ctrl+Alt+Del</code>。网页里按没用，必须给用户做个按钮调用 <code>wmksInstance.sendCAD()</code>。</li>
</ol>
<hr/>
<h3 data-id="heading-8">5. 样式：别留白边</h3>
<p>为了让黑色背景铺满整个弹窗，CSS 得这么写：</p>
<p>SCSS</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 弹窗样式 */</span>
:<span class="hljs-built_in">deep</span>(.vnc-session-dialog) {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-direction</span>: column;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#000</span> <span class="hljs-meta">!important</span>;

  <span class="hljs-comment">/* 全屏模式强行占满 */</span>
  &amp;<span class="hljs-selector-class">.is-fullscreen</span> { 
    <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span> <span class="hljs-meta">!important</span>;
    <span class="hljs-selector-class">.el-dialog__body</span> { <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>; <span class="hljs-attribute">display</span>: flex; <span class="hljs-attribute">flex-direction</span>: column; }
  }

  <span class="hljs-comment">/* 核心：让 body 自动撑开 */</span>
  <span class="hljs-selector-class">.el-dialog__body</span> {
    <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">overflow</span>: hidden;
  }
}
</code></pre>
<hr/>
<h3 data-id="heading-9">总结一下</h3>
<p>做这玩意儿逻辑其实不难，关键在于细节：</p>
<ul>
<li><strong>顺序</strong>：jQuery 必须先引。</li>
<li><strong>时机</strong>：全屏重连能解决画面糊的问题。</li>
<li><strong>补丁</strong>：给 Windows 留个 CAD 按钮，装好 VMware Tools。</li>
</ul>
<p>只要这几点对齐了，剩下的就是调 UI 让它看着更顺手的事儿了。
最后放上图片和源码</p>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vnc-app-wrapper"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"page-header"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"brand"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-icon</span> <span class="hljs-attr">:size</span>=<span class="hljs-string">"28"</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"#409eff"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">Monitor</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-icon</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>VMware 虚拟化资源管理<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vm-grid"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(vm, index) in vmList"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"index"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vm-mini-card"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vm-status-bar"</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"vm.status"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vm-card-body"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vm-icon"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Platform</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"vm.os === 'windows'"</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Cpu</span> <span class="hljs-attr">v-else</span> /&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vm-details"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vm-name"</span>&gt;</span>{{ vm.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vm-ip"</span>&gt;</span>{{ vm.host }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vm-actions"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">plain</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"openConsole(vm)"</span>&gt;</span>
              连接控制台
            <span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vm-footer"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>UUID: {{ vm.vmUuid.substring(0, 14) }}...<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">el-dialog</span> 
      <span class="hljs-attr">v-model</span>=<span class="hljs-string">"vncDialogVisible"</span> 
      <span class="hljs-attr">:fullscreen</span>=<span class="hljs-string">"isFullscreen"</span>
      <span class="hljs-attr">:width</span>=<span class="hljs-string">"isFullscreen ? '100%' : '1100px'"</span> 
      <span class="hljs-attr">top</span>=<span class="hljs-string">"5vh"</span>
      <span class="hljs-attr">:draggable</span>=<span class="hljs-string">"true"</span>
      <span class="hljs-attr">:show-close</span>=<span class="hljs-string">"false"</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"vnc-session-dialog"</span>
      <span class="hljs-attr">:before-close</span>=<span class="hljs-string">"handleCloseVNC"</span>
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">header</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"session-header drag-area"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"session-info"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"status-indicator"</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"connectionClass"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"session-name"</span>&gt;</span>
              {{ activeVM?.name }} | {{ activeVM?.host }}
            <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"session-controls"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span> <span class="hljs-attr">link</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"sendCAD"</span>&gt;</span>CAD<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"divider"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span> <span class="hljs-attr">link</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"toggleFullscreen"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">el-icon</span> <span class="hljs-attr">:size</span>=<span class="hljs-string">"16"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">FullScreen</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"!isFullscreen"</span> /&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">CopyDocument</span> <span class="hljs-attr">v-else</span> /&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">el-icon</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span> <span class="hljs-attr">link</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"danger"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleCloseVNC"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">el-icon</span> <span class="hljs-attr">:size</span>=<span class="hljs-string">"16"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">Close</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-icon</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> 
        <span class="hljs-attr">class</span>=<span class="hljs-string">"session-stage"</span> 
        <span class="hljs-attr">v-loading</span>=<span class="hljs-string">"reloading"</span> 
        <span class="hljs-attr">element-loading-background</span>=<span class="hljs-string">"rgba(0, 0, 0, 0.9)"</span>
        <span class="hljs-attr">element-loading-text</span>=<span class="hljs-string">"正在重构画面..."</span>
      &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"wmks-container"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-dialog</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref, nextTick, computed, onBeforeUnmount } from 'vue'
import { ElMessage } from 'element-plus'
import { Monitor, FullScreen, Close, CopyDocument, Platform, Cpu } from '@element-plus/icons-vue'
import { getVmConsoleTicket } from '@/api/taskManagement/vmConsole'


const vmList = ref([
  { 
    name: 'Windows-测试机', 
    host: '', 
    username: '', 
    password: '', 
    vmUuid: '',
    os: 'windows',
    status: 'online'
  },
  { 
    name: 'Linux-生产机', 
    host: '', 
    username: '', 
    password: '', 
    vmUuid: '',
    os: 'linux',
    status: 'online'
  }
])

const activeVM = ref&lt;any&gt;(null)
const vncDialogVisible = ref(false)
const isFullscreen = ref(false)
const reloading = ref(false)
const vncStatus = ref('disconnected')
const wmksInstance = ref&lt;any&gt;(null)

const connectionClass = computed(() =&gt; ({
  'is-connecting': vncStatus.value === 'connecting',
  'is-connected': vncStatus.value === 'connected'
}))


const openConsole = (vm: any) =&gt; {
  activeVM.value = vm;
  handleConnect(false);
}

const toggleFullscreen = async () =&gt; {
  reloading.value = true;
  if (wmksInstance.value) {
    wmksInstance.value.disconnect();
    wmksInstance.value.destroy();
    wmksInstance.value = null;
  }
  isFullscreen.value = !isFullscreen.value;
  await nextTick();
  setTimeout(async () =&gt; {
    try { await handleConnect(true); } finally { reloading.value = false; }
  }, 500);
}

const handleConnect = async (isRetry = false) =&gt; {
  const win = window as any;
  if (!win.WMKS) return ElMessage.error("SDK 未加载");

  try {
    vncStatus.value = 'connecting';
    if (!isRetry) vncDialogVisible.value = true;

    const res = await getVmConsoleTicket({
      host: activeVM.value.host,
      username: activeVM.value.username,
      password: activeVM.value.password,
      vmUuid: activeVM.value.vmUuid
    });
    
    const ticket = res.data?.ticket || res.ticket || res;
    await nextTick();
    startWMKS(ticket);
  } catch (err) {
    ElMessage.error("Ticket 申请失败，请检查机房连接");
    vncStatus.value = 'disconnected';
  }
}

const startWMKS = (ticket: string) =&gt; {
  const WMKS_LIB = (window as any).WMKS;
  wmksInstance.value = WMKS_LIB.createWMKS("wmks-container", {
    enableHints: true,
    useVNCHandshake: false,
    changeResolutionOnResizing: true,
    rescaleOnParentResize: true,
    position: 'absolute'
  });
  
  wmksInstance.value.register(WMKS_LIB.CONST.Events.CONNECTION_STATE_CHANGE, (evt: any, data: any) =&gt; {
    if (data.state === WMKS_LIB.CONST.ConnectionState.CONNECTED) {
      vncStatus.value = 'connected';
    }
  });

  wmksInstance.value.connect(`wss://${activeVM.value.host}:443/ticket/${ticket}`);
}

const sendCAD = () =&gt; wmksInstance.value?.sendCAD();
const handleCloseVNC = () =&gt; {
  if (wmksInstance.value) {
    wmksInstance.value.disconnect();
    wmksInstance.value.destroy();
    wmksInstance.value = null;
  }
  vncDialogVisible.value = false;
  isFullscreen.value = false;
  vncStatus.value = 'disconnected';
}

onBeforeUnmount(handleCloseVNC);
&lt;/script&gt;

&lt;style scoped lang="scss"&gt;
.vnc-app-wrapper {
  padding: 40px;
  background-color: #f8fafc;
  min-height: 100vh;
}

.page-header {
  max-width: 1200px;
  margin: 0 auto 40px;
  .brand {
    display: flex; align-items: center; gap: 12px;
    h1 { font-size: 22px; color: #334155; margin: 0; }
  }
}

.vm-grid {
  max-width: 1200px;
  margin: 0 auto;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 24px;
}

.vm-mini-card {
  background: #fff; border-radius: 12px; overflow: hidden;
  border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
  transition: transform 0.2s;
  &amp;:hover { transform: translateY(-4px); }

  .vm-status-bar { 
    height: 4px; background: #cbd5e1;
    &amp;.online { background: #10b981; }
  }
  
  .vm-card-body {
    padding: 24px; display: flex; flex-direction: column; align-items: center;
    .vm-icon {
      font-size: 32px; color: #3b82f6; margin-bottom: 16px;
      padding: 12px; background: #eff6ff; border-radius: 12px;
    }
    .vm-name { font-size: 17px; font-weight: 600; color: #1e293b; margin: 0 0 4px; }
    .vm-ip { font-size: 13px; color: #64748b; margin-bottom: 24px; }
    .vm-actions { width: 100%; .el-button { width: 100%; } }
  }

  .vm-footer {
    padding: 12px 20px; background: #f8fafc; border-top: 1px solid #f1f5f9;
    font-size: 11px; color: #94a3b8; font-family: ui-monospace, SFMono-Regular;
  }
}

:deep(.vnc-session-dialog) {
  display: flex; flex-direction: column;
  background: #000 !important; border-radius: 12px; overflow: hidden;
  
  .el-dialog__header {
    padding: 0 !important;
    margin: 0 !important;
    height: 50px;
    cursor: move; 
  }

  .el-dialog__body {
    flex: 1; display: flex; flex-direction: column;
    padding: 0 !important;
  }
  
  &amp;.is-fullscreen { border-radius: 0; }
}

.session-header {
  height: 50px; background: #1e293b; padding: 0 20px;
  display: flex; justify-content: space-between; align-items: center;
  
  .session-info {
    display: flex; align-items: center; gap: 10px;
    pointer-events: none; 
    .status-indicator { 
      width: 8px; height: 8px; border-radius: 50%; background: #64748b;
      &amp;.is-connected { background: #10b981; box-shadow: 0 0 8px #10b981; }
    }
    .session-name { color: #f1f5f9; font-size: 14px; font-weight: 500; }
  }
  
  .session-controls {
    pointer-events: auto;
    display: flex; align-items: center; gap: 10px;
    .divider { width: 1px; height: 16px; background: #334155; }
    .el-button { color: #94a3b8; &amp;:hover { color: #fff; } }
  }
}

.session-stage {
  flex: 1; width: 100%; min-height: 600px;
  background: #000; position: relative;
  #wmks-container { width: 100% !important; height: 100% !important; position: absolute; }
}

:deep(.el-dialog__headerbtn) { display: none; }
&lt;/style&gt;
</code></pre>
<p>这是index.html下面需要引入的内容</p>
<pre><code class="hljs language-js" lang="js">    &lt;link rel=<span class="hljs-string">"stylesheet"</span> href=<span class="hljs-string">"/WebMKS_SDK_2.2.0/css/wmks-all.css"</span>&gt;

    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://code.jquery.com/jquery-3.6.0.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
    
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-variable language_">window</span>.<span class="hljs-property">jQuery</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">$</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">jQuery</span>;
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'JQuery Check:'</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">jQuery</span>.<span class="hljs-property">fn</span>.<span class="hljs-property">jquery</span>);
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/jquery-ui.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/WebMKS_SDK_2.2.0/wmks.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">jQuery</span> &amp;&amp; (<span class="hljs-variable language_">window</span>.<span class="hljs-property">jQuery</span>.<span class="hljs-property">ui</span> || <span class="hljs-variable language_">window</span>.<span class="hljs-property">jQuery</span>.<span class="hljs-property">widget</span>)) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Result: jQuery UI is fully loaded and attached to jQuery.'</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Result: jQuery UI failed to attach to window.jQuery!'</span>);
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eaddee8e7016447088ca752d2d4960da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNDA0Tm90Rm91bmQzMDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976955&amp;x-signature=4yNg4PNckCnrq4fr35duMAE5rx4%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[插件开发实录：我用Comate在VS Code里造了一场“能被代码融化”的初雪]]></title>    <link>https://juejin.cn/post/7586482851098165288</link>    <guid>https://juejin.cn/post/7586482851098165288</guid>    <pubDate>2025-12-22T03:25:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586482851098165288" data-draft-id="7585948869844795427" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="插件开发实录：我用Comate在VS Code里造了一场“能被代码融化”的初雪"/> <meta itemprop="keywords" content="前端,后端,前端框架"/> <meta itemprop="datePublished" content="2025-12-22T03:25:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="文心快码BaiduComate"/> <meta itemprop="url" content="https://juejin.cn/user/992209294070809"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            插件开发实录：我用Comate在VS Code里造了一场“能被代码融化”的初雪
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/992209294070809/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    文心快码BaiduComate
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:25:58.000Z" title="Mon Dec 22 2025 03:25:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>2025年的第一场雪，我是在报错日志里度过的😭</p>
<p>朋友圈在晒雪景，我在盯着 VS Code 万年不变的界面发呆。</p>
<p>既然错过了现实里的初雪，那我为什么不能在我的 IDE 里下一场雪？</p>
<p>于是，一个极其离谱又带感的脑洞诞生了——我想做一个VS Code插件，实现：</p>
<ul>
<li>落雪：当我停下来思考或者单纯摸鱼时，让屏幕飘落初雪，积雪慢慢覆盖代码，假装我也在过冬。</li>
<li>燃火：一旦我开始狂修 Bug，指尖的每一次敲击都要在屏幕底部点燃烈火。手速越快，火势越旺，甚至要让火星子溅满整个屏幕，主打一个物理取暖和辛劳可视化。</li>
<li>互动：圣诞节快到了，在没有操作的时候，跳出NPC和我互动，增添圣诞氛围。</li>
</ul>
<p>想法很丰满，现实很骨感。</p>
<p>要在 VS Code 极其受限的 Webview 环境里，同时跑通物理积雪堆叠算法和 Doom Fire 火焰渲染，还要保证不卡顿，这对我这个只有碎片时间的开发者来说，简直是降维打击。</p>
<p>好在，这个冬天，虽然没有女朋友暖手，但我有随叫随到的 文心快码（Comate） 暖心🐶</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f6018bc8df3430d9ea0a86424d2cf2a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978758&amp;x-signature=qsGAUFFmMbRqdHUD16zveDlvSdE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-0">01 智能规划：从一句话需求到 MVP落地</h2>
<p>﻿项目启动阶段，我面临的最大挑战是架构设计。VS Code 插件开发涉及 Extension 主进程与 Webview 渲染进程的通信，配置繁琐且容易出错。这次我没有直接写代码，而是使用了 Comate 的 Spec 模式。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d85396cb8fcc40cd8fc933d50ca1d759~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978758&amp;x-signature=RwlFV%2B3qe7DhHPyB4e9vLnO2fjE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>我向 Comate 抛出了我的核心构想：</p>
<blockquote>
<p>“我要做一个 VS Code 插件，核心逻辑是监听键盘输入。输入频率高时底部渲染火焰，闲置时顶部下雪并积雪。请帮我设计架构并生成代码。”</p>
</blockquote>
<p>Comate 迅速进入了需求分析模式，几秒钟后，它返还了一份结构完整的 FrostFire 插件需求文档。我仔细审视了这份文档，发现大框架非常完美，逻辑层和渲染层分得清清楚楚。</p>
<p>插件需求文档见文章末尾【附录1】</p>
<p>为了把错误拦截在开发之前，我基于这份文档进行了一些微调：</p>
<ul>
<li>package.json：我补充了 activationEvents 配置，确保插件在打开任何文件时都能自动激活，而不仅仅是特定语言。</li>
<li>src/webview/index.html：我特别强调了要配置 CSP 策略，并将背景强制设为纯黑，以配合 Canvas 的渲染效果。</li>
</ul>
<p>确认修改后，Comate 自动根据需求文档拆解出了具体的开发任务列表（Tasks），从环境配置到核心算法实现，条理清晰。</p>
<p>插件开发任务计划见文章末尾【附录2】</p>
<p>随着一个个 Task 被自动执行，仅仅10分钟，FrostFire 的 V1.0 版本（MVP）诞生了。</p>
<p>生成完毕后，Comate还给出了贴心的下一步引导，清晰地告诉了我们如何迁移到VS Code里使用插件⬇️</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df89bc9d45c24cb2b71654509a4e2e73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978758&amp;x-signature=5iu8bNfYhcCEmbUt2eEbyEMeofg%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>我打开VS Code，按照它说的一步步做，屏幕上真的燃起了火焰！</p>
<p>👉观看燃起火焰效果视频<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FzDAbDvEc-2-8yKNBEeY86A" target="_blank" title="https://mp.weixin.qq.com/s/zDAbDvEc-2-8yKNBEeY86A" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/zDAbDvEc-…</a></p>
<p>对了，VS Code里也支持文心快码插件～插件市场搜索文心快码，即可下载～</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7813a94ce9f4c96b9190fbda78d6255~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978758&amp;x-signature=GntUHX9i3D%2BWa2vu7qOZE9G6Q18%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>文心快码插件下载下来后，会自动出生在左边，有点和文件目录重合了。没关系，我们可以点击左侧项目栏中文心快码标识，把它拖到右边</p>
<p>👉观看具体操作视频<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FzDAbDvEc-2-8yKNBEeY86A" target="_blank" title="https://mp.weixin.qq.com/s/zDAbDvEc-2-8yKNBEeY86A" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/zDAbDvEc-…</a></p>
<h2 data-id="heading-1">02 核心维稳：用“记忆”根除鬼火Bug</h2>
<p>然而，V1 版本很快暴露出了严重的稳定性问题——幽灵火。</p>
<p>症状非常诡异：</p>
<ol>
<li>有时候我明明双手离开了键盘，屏幕上的火却突然烧了起来。</li>
<li>刚打开 VS Code，还没开始工作，火焰就直接铺满了屏幕。</li>
</ol>
<p>经过排查，原来是后端的心跳包和自动保存机制干扰了 idleTime 的计算，导致系统误判我有输入。</p>
<p>为了解决这个问题，我与 Comate 进行了多次深度的 Debug 交互。最终，我们共同制定了一套基于趋势判定的“安全栓”逻辑：只有当监测到闲置时间出现骤降（时间倒流）时，才认定为有效输入，绝不能仅依赖数值大小来判断。</p>
<p>这段逻辑非常关键，为了防止在未来的迭代中 Comate 忘记这个核心规则，我使用了 Comate 的 Memory（记忆） 功能。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a32661a4995e4cf6abbbbbb72ccabdb1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978758&amp;x-signature=aMzE9hexqU1vd7DooVSmpCp266A%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>我在 Memory 设置中手动录入了一条核心指令：</p>
<blockquote>
<p>“在 FrostFire 项目中，必须始终保留基于‘安全栓’（如 hasWitnessedDrop 变量）的逻辑：只有当检测到 idleTime 确实发生下降（current &lt; prev）时才允许解锁点火功能，绝对不能仅依赖 idleTime的绝对数值来判定打字状态，以防止‘刚打开或静止时自动起火’的 Bug 复发。”</p>
</blockquote>
<p>这一步操作至关重要。 从此之后，无论我要求 Comate 如何重构代码，它都会死死守住这条“安全底线”。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c89006bc7dbc4376b7defcdd09d114af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978758&amp;x-signature=mfalusOizTnIuGjgy1mIXl4mnZ4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>当 Comate 生成了最终修复版的代码后，我点击了对话框下方的 “赞” 按钮反馈了满意度，并使用了 “全文复制”功能，一键将这段复杂的逻辑同步到了我的项目中。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e5200c18e0d4d49a8a198abe647182c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978758&amp;x-signature=iHTCJqaboYuHTAJ0L9AhxhNuMsA%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-2">03 迭代开发：从“能用”到“惊艳”</h2>
<p>搞定了稳定性之后，FrostFire 虽然能跑了，但看起来还很廉价。我决定给它注入灵魂，开启了三次关键的迭代。</p>
<h3 data-id="heading-3">迭代一：挑战“物理积雪”算法</h3>
<p>我希望雪花落下时，能像真实的沙堆一样，形成中间高、两边低的自然坡度，而不是像水一样平铺。但这需要编写复杂的“休止角”算法，涉及大量的数据结构计算。</p>
<p>我向 Comate 描述了需求：</p>
<blockquote>
<p>“我需要积雪堆叠的感觉，最高堆叠到屏幕最上方。”</p>
</blockquote>
<p>Comate 完美执行了我的指令。它在 snowEffect.js 中重构了数据结构，引入了一个双向平滑算法。 现在的积雪，不仅有自然的起伏，甚至能把代码编辑器底部的状态栏慢慢“埋”起来，那种沉浸感简直绝了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/457d367cd28e45b58ba3895ec021962b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978758&amp;x-signature=lvkEZk3x9Ufxk9c7N66JMFoaMi8%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-4">迭代二：手感调优与温和模式</h3>
<p>V1 的火焰太暴躁了，稍微打几个字就满屏火光。我希望它能更优雅一些，引入一种温和模式：平时只是小火苗，只有在疯狂输出时才会有火星四溅的效果。而且，单纯的“不打字下雪，打字起火”太生硬了。我想要一种线性的对抗感。</p>
<p>怕智能体乱改改错，我换成了Ask智能体，觉得AI说的有道理，就点插入，代码就自动插入到了我的光标位置，体验感十分丝滑。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62213cd3f4fe4cda8f256dfa4c2a6fdc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978758&amp;x-signature=m8qfuWaj27K%2BZbmOJ7B3Q732460%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-5">迭代三：节日限定的浪漫</h3>
<p>既然是圣诞特供，怎么能少了节日气氛？</p>
<p>我给 Comate 下达了新的增量需求：</p>
<blockquote>
<p>“我需要增加两个彩蛋。第一，当积雪变厚时，雪地里要钻出一个雪人；一旦我开始打字起火，雪人要表现得很惊恐并逃跑。第二，在火势旺盛时，偶尔要有圣诞老人坐雪橇飞过，投递礼物。”</p>
</blockquote>
<p>Comate 的表现令人惊喜：</p>
<ul>
<li>怕热的雪人：它设计了一个简易的状态机。雪人平时在发呆，检测到热量上升时，会绘制出流汗和颤抖的动画，并加速移出屏幕。</li>
<li>圣诞空投：它完美实现了雪橇的飞行轨迹和礼物盒的物理抛物线。</li>
</ul>
<p>最让我感动的是，Comate 还记得我之前的 Memory。在实现这些新功能时，它依然严格遵守了“安全栓”逻辑，确保雪人和圣诞老人不会因为误触而乱跑。</p>
<p>最后，让我们一起来看看最终版本视频🤩：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FzDAbDvEc-2-8yKNBEeY86A" target="_blank" title="https://mp.weixin.qq.com/s/zDAbDvEc-2-8yKNBEeY86A" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/zDAbDvEc-…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce901f063c1843b2ad31cbc12418556c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978758&amp;x-signature=tvXwEXmdcTtd4zzbWJOJ8sCSOG4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-6">04 总结：AI 时代的开发新范式</h2>
<p>回看 FrostFire 的开发历程，从解决底层的“幽灵火”逻辑漏洞，到实现细腻的物理积雪，再到充满创意的圣诞彩蛋，文心快码（Comate） 展现出的能力远超一个代码补全工具。</p>
<ul>
<li>Spec 模式 让架构设计不再是难题，将我的抽象想法快速转化为可执行的代码框架。</li>
<li>Memory 机制 解决了 AI 容易“遗忘上下文”的痛点，让它成为了一个越用越懂我的专属工程师。</li>
<li>流畅的交互体验（如可编辑输入、一键复制）则极大地降低了沟通成本，让开发过程如丝般顺滑。</li>
</ul>
<p>现在的 FrostFire，已经不仅仅是一个插件，它是我在 Comate 协助下，送给自己和所有开发者的一份冬日礼物。</p>
<p>在这个项目中，我只需负责构想和决策，而那些繁琐的实现细节，全部交给了 AI。</p>
<p>如果你也想体验这种心想事成的开发快感，不妨试试让文心快码成为你的AI编程助手。或许你的下一个脑洞，就是下一个爆款。</p>
<h2 data-id="heading-7">【附录1】插件需求文档</h2>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># FrostFire VS Code 插件需求文档</span>

<span class="hljs-comment">## 1. 项目概述</span>

**FrostFire** 是一个增加编程趣味性的 VS Code 视觉增强插件，通过在编辑器中渲染动态视觉效果（火焰和雪花），让编程体验更加生动有趣。

<span class="hljs-comment">## 2. 核心功能</span>

<span class="hljs-comment">### 2.1 Fire 状态（火焰效果）</span>
- **触发条件**：用户键盘输入频率（Keystrokes per minute, KPM）较高时触发
- **视觉效果**：编辑器底部渲染像素风格火焰（基于 Doom Fire Algorithm）
- **动态响应**：输入越快，火焰越高越旺盛
- **热度计算**：根据最近一段时间内的按键频率计算"热度值"

<span class="hljs-comment">### 2.2 Ice 状态（雪花效果）</span>
- **触发条件**：用户停止输入超过 15 秒
- **视觉效果**：编辑器顶部开始下雪
- **积雪机制**：停止输入超过 60 秒后，雪花在底部积累形成积雪层
- **遮挡效果**：积雪可轻微遮挡代码区域，增强沉浸感

<span class="hljs-comment">### 2.3 状态切换</span>
- Fire 和 Ice 状态互斥，不会同时出现
- 用户开始输入时，雪花效果逐渐消失，火焰效果逐渐出现
- 状态切换有平滑过渡动画

<span class="hljs-comment">## 3. 技术架构</span>

<span class="hljs-comment">### 3.1 技术栈</span>
- **语言**：TypeScript
- **API**：VS Code Extension API
- **渲染**：HTML5 Canvas（在 Webview 中运行）

<span class="hljs-comment">### 3.2 项目目录结构</span>
```
frostfire/
├── .vscode/
│   └── launch.json              <span class="hljs-comment"># 调试配置</span>
├── src/
│   ├── extension.ts             <span class="hljs-comment"># 插件入口，注册命令和监听器</span>
│   ├── activityTracker.ts       <span class="hljs-comment"># 用户活跃度追踪器</span>
│   ├── webviewProvider.ts       <span class="hljs-comment"># Webview 面板管理</span>
│   └── webview/
│       ├── index.html           <span class="hljs-comment"># Webview HTML 模板</span>
│       ├── main.js              <span class="hljs-comment"># Webview 主逻辑</span>
│       ├── fireEffect.js        <span class="hljs-comment"># Doom Fire 火焰算法实现</span>
│       └── snowEffect.js        <span class="hljs-comment"># 雪花和积雪效果实现</span>
├── package.json                 <span class="hljs-comment"># 插件配置清单</span>
├── tsconfig.json                <span class="hljs-comment"># TypeScript 配置</span>
└── README.md                    <span class="hljs-comment"># 项目说明</span>
```

<span class="hljs-comment">### 3.3 架构设计</span>

```
┌─────────────────────────────────────────────────────────────┐
│                     VS Code Extension Host                   │
├─────────────────────────────────────────────────────────────┤
│  extension.ts                                                │
│  ┌─────────────────┐    ┌──────────────────┐                │
│  │ ActivityTracker │───▶│ WebviewProvider  │                │
│  │ - 监听文档变化   │    │ - 管理 Webview   │                │
│  │ - 计算热度值     │    │ - 发送状态消息    │                │
│  │ - 判断状态切换   │    │                  │                │
│  └─────────────────┘    └────────┬─────────┘                │
│                                  │ postMessage               │
└──────────────────────────────────┼──────────────────────────┘
                                   ▼
┌─────────────────────────────────────────────────────────────┐
│                        Webview (Canvas)                      │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐    ┌──────────────────┐                │
│  │   FireEffect    │    │   SnowEffect     │                │
│  │ - Doom Fire算法  │    │ - 雪花粒子系统   │                │
│  │ - 火焰高度控制   │    │ - 积雪累积逻辑   │                │
│  └─────────────────┘    └──────────────────┘                │
│                    main.js (消息调度)                        │
└─────────────────────────────────────────────────────────────┘
```

<span class="hljs-comment">## 4. 实现细节</span>

<span class="hljs-comment">### 4.1 ActivityTracker（活跃度追踪器）</span>

```typescript
// src/activityTracker.ts
export class ActivityTracker {
    private keystrokeTimestamps: number<span class="hljs-section">[]</span> = <span class="hljs-section">[]</span><span class="hljs-comment">;  // 记录按键时间戳</span>
    private readonly <span class="hljs-attr">WINDOW_SIZE</span> = <span class="hljs-number">60000</span><span class="hljs-comment">;         // 统计窗口：60秒</span>
    private readonly <span class="hljs-attr">IDLE_THRESHOLD</span> = <span class="hljs-number">15000</span><span class="hljs-comment">;      // 空闲阈值：15秒</span>
    private readonly <span class="hljs-attr">SNOW_ACCUMULATE_THRESHOLD</span> = <span class="hljs-number">60000</span><span class="hljs-comment">; // 积雪阈值：60秒</span>
    
    // 记录一次按键
    public recordKeystroke(): void {
        const <span class="hljs-attr">now</span> = Date.now()<span class="hljs-comment">;</span>
        this.keystrokeTimestamps.push(now)<span class="hljs-comment">;</span>
        this.cleanOldTimestamps(now)<span class="hljs-comment">;</span>
    }
    
    // 清理过期的时间戳
    private cleanOldTimestamps(now: number): void {
        <span class="hljs-attr">this.keystrokeTimestamps</span> = this.keystrokeTimestamps.filter(
            <span class="hljs-attr">ts</span> =&gt; now - ts &lt; this.WINDOW_SIZE
        )<span class="hljs-comment">;</span>
    }
    
    // 计算当前热度值 (0-100)
    public getHeatLevel(): number {
        const <span class="hljs-attr">now</span> = Date.now()<span class="hljs-comment">;</span>
        this.cleanOldTimestamps(now)<span class="hljs-comment">;</span>
        // 基于最近10秒的按键数计算热度
        const <span class="hljs-attr">recentKeystrokes</span> = this.keystrokeTimestamps.filter(
            <span class="hljs-attr">ts</span> =&gt; now - ts &lt; <span class="hljs-number">10000</span>
        ).length<span class="hljs-comment">;</span>
        // 假设每秒6次按键为满热度
        return Math.min(100, (recentKeystrokes / 60) * 100)<span class="hljs-comment">;</span>
    }
    
    // 获取空闲时间（毫秒）
    public getIdleTime(): number {
        if (<span class="hljs-attr">this.keystrokeTimestamps.length</span> === <span class="hljs-number">0</span>) return Infinity<span class="hljs-comment">;</span>
        const <span class="hljs-attr">lastKeystroke</span> = Math.max(...this.keystrokeTimestamps)<span class="hljs-comment">;</span>
        return Date.now() - lastKeystroke<span class="hljs-comment">;</span>
    }
    
    // 判断当前状态
    public getCurrentState(): 'fire' | 'idle' | 'snow' | 'snow_accumulate' {
        const <span class="hljs-attr">idleTime</span> = this.getIdleTime()<span class="hljs-comment">;</span>
        if (idleTime &gt;= this.SNOW_ACCUMULATE_THRESHOLD) return 'snow_accumulate'<span class="hljs-comment">;</span>
        if (idleTime &gt;= this.IDLE_THRESHOLD) return 'snow'<span class="hljs-comment">;</span>
        if (this.getHeatLevel() &gt; 10) return 'fire'<span class="hljs-comment">;</span>
        return 'idle'<span class="hljs-comment">;</span>
    }
}
```

<span class="hljs-comment">### 4.2 Extension 核心逻辑</span>

```typescript
// src/extension.ts
import * as vscode from 'vscode'<span class="hljs-comment">;</span>
import { ActivityTracker } from './activityTracker'<span class="hljs-comment">;</span>
import { FrostFireWebviewProvider } from './webviewProvider'<span class="hljs-comment">;</span>

let activityTracker: ActivityTracker<span class="hljs-comment">;</span>
let webviewProvider: FrostFireWebviewProvider<span class="hljs-comment">;</span>
let updateInterval: NodeJS.Timeout<span class="hljs-comment">;</span>

export function activate(context: vscode.ExtensionContext) {
    <span class="hljs-attr">activityTracker</span> = new ActivityTracker()<span class="hljs-comment">;</span>
    <span class="hljs-attr">webviewProvider</span> = new FrostFireWebviewProvider(context.extensionUri)<span class="hljs-comment">;</span>
    
    // 注册 Webview 视图
    context.subscriptions.push(
        vscode.window.registerWebviewViewProvider(
            'frostfire.effectView',
            webviewProvider
        )
    )<span class="hljs-comment">;</span>
    
    // 注册启动命令
    context.subscriptions.push(
        vscode.commands.registerCommand('frostfire.start', () =&gt; {
            vscode.commands.executeCommand('frostfire.effectView.focus')<span class="hljs-comment">;</span>
        })
    )<span class="hljs-comment">;</span>
    
    // 监听文档变化（用户输入）
    context.subscriptions.push(
        vscode.workspace.onDidChangeTextDocument((event) =&gt; {
            // 只统计实际的文本变化
            if (event.contentChanges.length &gt; 0) {
                activityTracker.recordKeystroke()<span class="hljs-comment">;</span>
            }
        })
    )<span class="hljs-comment">;</span>
    
    // 定时更新状态到 Webview
    <span class="hljs-attr">updateInterval</span> = setInterval(() =&gt; {
        const <span class="hljs-attr">state</span> = activityTracker.getCurrentState()<span class="hljs-comment">;</span>
        const <span class="hljs-attr">heatLevel</span> = activityTracker.getHeatLevel()<span class="hljs-comment">;</span>
        const <span class="hljs-attr">idleTime</span> = activityTracker.getIdleTime()<span class="hljs-comment">;</span>
        
        webviewProvider.postMessage({
            type: 'stateUpdate',
            state: state,
            heatLevel: heatLevel,
            idleTime: idleTime
        })<span class="hljs-comment">;</span>
    }, 100)<span class="hljs-comment">; // 每100ms更新一次</span>
    
    context.subscriptions.push({
        dispose: () =&gt; clearInterval(updateInterval)
    })<span class="hljs-comment">;</span>
}

export function deactivate() {
    if (updateInterval) {
        clearInterval(updateInterval)<span class="hljs-comment">;</span>
    }
}
```

<span class="hljs-comment">### 4.3 Doom Fire 火焰算法</span>

```javascript
// src/webview/fireEffect.js
class FireEffect {
    constructor(canvas) {
        <span class="hljs-attr">this.canvas</span> = canvas<span class="hljs-comment">;</span>
        <span class="hljs-attr">this.ctx</span> = canvas.getContext(<span class="hljs-string">'2d'</span>)<span class="hljs-comment">;</span>
        <span class="hljs-attr">this.fireWidth</span> = <span class="hljs-number">80</span><span class="hljs-comment">;  // 火焰像素宽度</span>
        <span class="hljs-attr">this.fireHeight</span> = <span class="hljs-number">50</span><span class="hljs-comment">; // 火焰像素高度</span>
        <span class="hljs-attr">this.firePixels</span> = []<span class="hljs-comment">;</span>
        <span class="hljs-attr">this.fireColorPalette</span> = this.createPalette()<span class="hljs-comment">;</span>
        <span class="hljs-attr">this.intensity</span> = <span class="hljs-number">0</span><span class="hljs-comment">;   // 火焰强度 0-100</span>
        this.initFire()<span class="hljs-comment">;</span>
    }
    
    // 创建火焰颜色调色板（36色）
    createPalette() {
        return <span class="hljs-section">[
            {r:7,g:7,b:7}, {r:31,g:7,b:7}, {r:47,g:15,b:7}, {r:71,g:15,b:7},
            {r:87,g:23,b:7}, {r:103,g:31,b:7}, {r:119,g:31,b:7}, {r:143,g:39,b:7},
            {r:159,g:47,b:7}, {r:175,g:63,b:7}, {r:191,g:71,b:7}, {r:199,g:71,b:7},
            {r:223,g:79,b:7}, {r:223,g:87,b:7}, {r:223,g:87,b:7}, {r:215,g:95,b:7},
            {r:215,g:103,b:15}, {r:207,g:111,b:15}, {r:207,g:119,b:15}, {r:207,g:127,b:15},
            {r:207,g:135,b:23}, {r:199,g:135,b:23}, {r:199,g:143,b:23}, {r:199,g:151,b:31},
            {r:191,g:159,b:31}, {r:191,g:159,b:31}, {r:191,g:167,b:39}, {r:191,g:167,b:39},
            {r:191,g:175,b:47}, {r:183,g:175,b:47}, {r:183,g:183,b:47}, {r:183,g:183,b:55},
            {r:207,g:207,b:111}, {r:223,g:223,b:159}, {r:239,g:239,b:199}, {r:255,g:255,b:255}
        ]</span><span class="hljs-comment">;</span>
    }
    
    // 初始化火焰数组
    initFire() {
        const <span class="hljs-attr">totalPixels</span> = this.fireWidth * this.fireHeight<span class="hljs-comment">;</span>
        <span class="hljs-attr">this.firePixels</span> = new Array(totalPixels).fill(<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
    }
    
    // 设置火焰强度
    setIntensity(level) {
        <span class="hljs-attr">this.intensity</span> = Math.max(<span class="hljs-number">0</span>, Math.min(<span class="hljs-number">100</span>, level))<span class="hljs-comment">;</span>
        // 根据强度设置底部火源
        const <span class="hljs-attr">maxColorIndex</span> = Math.floor((this.intensity / <span class="hljs-number">100</span>) * <span class="hljs-number">35</span>)<span class="hljs-comment">;</span>
        for (let <span class="hljs-attr">x</span> = <span class="hljs-number">0</span><span class="hljs-comment">; x &lt; this.fireWidth; x++) {</span>
            const <span class="hljs-attr">bottomIndex</span> = (this.fireHeight - <span class="hljs-number">1</span>) * this.fireWidth + x<span class="hljs-comment">;</span>
            this.firePixels<span class="hljs-section">[bottomIndex]</span> = this.intensity &gt; 5 ? maxColorIndex : 0<span class="hljs-comment">;</span>
        }
    }
    
    // 火焰传播算法
    spreadFire() {
        for (let <span class="hljs-attr">x</span> = <span class="hljs-number">0</span><span class="hljs-comment">; x &lt; this.fireWidth; x++) {</span>
            for (let <span class="hljs-attr">y</span> = <span class="hljs-number">1</span><span class="hljs-comment">; y &lt; this.fireHeight; y++) {</span>
                const <span class="hljs-attr">srcIndex</span> = y * this.fireWidth + x<span class="hljs-comment">;</span>
                const <span class="hljs-attr">pixel</span> = this.firePixels[srcIndex]<span class="hljs-comment">;</span>
                
                if (<span class="hljs-attr">pixel</span> === <span class="hljs-number">0</span>) {
                    this.firePixels<span class="hljs-section">[(y - 1) * this.fireWidth + x]</span> = 0<span class="hljs-comment">;</span>
                } else {
                    // 随机偏移产生飘动效果
                    const <span class="hljs-attr">randIdx</span> = Math.floor(Math.random() * <span class="hljs-number">3</span>)<span class="hljs-comment">;</span>
                    const <span class="hljs-attr">dstX</span> = Math.min(this.fireWidth - <span class="hljs-number">1</span>, Math.max(<span class="hljs-number">0</span>, x - randIdx + <span class="hljs-number">1</span>))<span class="hljs-comment">;</span>
                    const <span class="hljs-attr">dstIndex</span> = (y - <span class="hljs-number">1</span>) * this.fireWidth + dstX<span class="hljs-comment">;</span>
                    this.firePixels<span class="hljs-section">[dstIndex]</span> = Math.max(0, pixel - (randIdx &amp; 1))<span class="hljs-comment">;</span>
                }
            }
        }
    }
    
    // 渲染火焰
    render() {
        this.spreadFire()<span class="hljs-comment">;</span>
        
        const <span class="hljs-attr">pixelWidth</span> = this.canvas.width / this.fireWidth<span class="hljs-comment">;</span>
        const <span class="hljs-attr">pixelHeight</span> = this.canvas.height / this.fireHeight<span class="hljs-comment">;</span>
        
        for (let <span class="hljs-attr">y</span> = <span class="hljs-number">0</span><span class="hljs-comment">; y &lt; this.fireHeight; y++) {</span>
            for (let <span class="hljs-attr">x</span> = <span class="hljs-number">0</span><span class="hljs-comment">; x &lt; this.fireWidth; x++) {</span>
                const <span class="hljs-attr">colorIndex</span> = this.firePixels[y * this.fireWidth + x]<span class="hljs-comment">;</span>
                const <span class="hljs-attr">color</span> = this.fireColorPalette[colorIndex]<span class="hljs-comment">;</span>
                
                if (colorIndex &gt; 0) {
                    <span class="hljs-attr">this.ctx.fillStyle</span> = `rgba(<span class="hljs-variable">${color.r}</span>,<span class="hljs-variable">${color.g}</span>,<span class="hljs-variable">${color.b}</span>,<span class="hljs-number">0.9</span>)`<span class="hljs-comment">;</span>
                    this.ctx.fillRect(
                        x * pixelWidth,
                        y * pixelHeight,
                        pixelWidth + 1,
                        pixelHeight + 1
                    )<span class="hljs-comment">;</span>
                }
            }
        }
    }
}
```

<span class="hljs-comment">### 4.4 雪花效果</span>

```javascript
// src/webview/snowEffect.js
class SnowEffect {
    constructor(canvas) {
        <span class="hljs-attr">this.canvas</span> = canvas<span class="hljs-comment">;</span>
        <span class="hljs-attr">this.ctx</span> = canvas.getContext(<span class="hljs-string">'2d'</span>)<span class="hljs-comment">;</span>
        <span class="hljs-attr">this.snowflakes</span> = []<span class="hljs-comment">;</span>
        <span class="hljs-attr">this.snowAccumulation</span> = []<span class="hljs-comment">; // 积雪层高度数组</span>
        <span class="hljs-attr">this.maxSnowflakes</span> = <span class="hljs-number">200</span><span class="hljs-comment">;</span>
        <span class="hljs-attr">this.isSnowing</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
        <span class="hljs-attr">this.isAccumulating</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
        this.initAccumulation()<span class="hljs-comment">;</span>
    }
    
    // 初始化积雪层
    initAccumulation() {
        const <span class="hljs-attr">segments</span> = Math.floor(this.canvas.width / <span class="hljs-number">5</span>)<span class="hljs-comment">;</span>
        <span class="hljs-attr">this.snowAccumulation</span> = new Array(segments).fill(<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
    }
    
    // 创建雪花
    createSnowflake() {
        return {
            x: Math.random() * this.canvas.width,
            y: -10,
            radius: Math.random() * 3 + 1,
            speed: Math.random() * 1 + 0.5,
            wind: Math.random() * 0.5 - 0.25,
            opacity: Math.random() * 0.5 + 0.5
        }<span class="hljs-comment">;</span>
    }
    
    // 开始下雪
    startSnow(<span class="hljs-attr">accumulate</span> = <span class="hljs-literal">false</span>) {
        <span class="hljs-attr">this.isSnowing</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
        <span class="hljs-attr">this.isAccumulating</span> = accumulate<span class="hljs-comment">;</span>
    }
    
    // 停止下雪
    stopSnow() {
        <span class="hljs-attr">this.isSnowing</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
        <span class="hljs-attr">this.isAccumulating</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
    }
    
    // 清除效果
    clear() {
        <span class="hljs-attr">this.snowflakes</span> = []<span class="hljs-comment">;</span>
        this.initAccumulation()<span class="hljs-comment">;</span>
        <span class="hljs-attr">this.isSnowing</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
        <span class="hljs-attr">this.isAccumulating</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
    }
    
    // 更新雪花位置
    update() {
        // 添加新雪花
        if (this.isSnowing &amp;&amp; this.snowflakes.length &lt; this.maxSnowflakes) {
            if (Math.random() &lt; 0.3) {
                this.snowflakes.push(this.createSnowflake())<span class="hljs-comment">;</span>
            }
        }
        
        // 更新雪花位置
        for (let <span class="hljs-attr">i</span> = this.snowflakes.length - <span class="hljs-number">1</span><span class="hljs-comment">; i &gt;= 0; i--) {</span>
            const <span class="hljs-attr">flake</span> = this.snowflakes[i]<span class="hljs-comment">;</span>
            flake.y += flake.speed<span class="hljs-comment">;</span>
            flake.x += flake.wind<span class="hljs-comment">;</span>
            
            // 检查是否落到底部或积雪上
            const <span class="hljs-attr">segmentIndex</span> = Math.floor(flake.x / <span class="hljs-number">5</span>)<span class="hljs-comment">;</span>
            const <span class="hljs-attr">groundLevel</span> = this.canvas.height - (this.snowAccumulation[segmentIndex] || <span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
            
            if (flake.y &gt;= groundLevel) {
                // 积雪
                if (this.isAccumulating &amp;&amp; segmentIndex &gt;= 0 &amp;&amp; segmentIndex &lt; this.snowAccumulation.length) {
                    this.snowAccumulation<span class="hljs-section">[segmentIndex]</span> = Math.min(
                        this.snowAccumulation<span class="hljs-section">[segmentIndex]</span> + 0.2,
                        this.canvas.height * 0.3 // 最大积雪高度30%
                    )<span class="hljs-comment">;</span>
                }
                this.snowflakes.splice(i, 1)<span class="hljs-comment">;</span>
            } else if (flake.x &lt; 0 || flake.x &gt; this.canvas.width) {
                this.snowflakes.splice(i, 1)<span class="hljs-comment">;</span>
            }
        }
    }
    
    // 渲染雪花和积雪
    render() {
        this.update()<span class="hljs-comment">;</span>
        
        // 绘制雪花
        <span class="hljs-attr">this.ctx.fillStyle</span> = <span class="hljs-string">'white'</span><span class="hljs-comment">;</span>
        for (const flake of this.snowflakes) {
            <span class="hljs-attr">this.ctx.globalAlpha</span> = flake.opacity<span class="hljs-comment">;</span>
            this.ctx.beginPath()<span class="hljs-comment">;</span>
            this.ctx.arc(flake.x, flake.y, flake.radius, 0, Math.PI * 2)<span class="hljs-comment">;</span>
            this.ctx.fill()<span class="hljs-comment">;</span>
        }
        <span class="hljs-attr">this.ctx.globalAlpha</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
        
        // 绘制积雪
        if (this.isAccumulating) {
            <span class="hljs-attr">this.ctx.fillStyle</span> = <span class="hljs-string">'rgba(255, 255, 255, 0.8)'</span><span class="hljs-comment">;</span>
            this.ctx.beginPath()<span class="hljs-comment">;</span>
            this.ctx.moveTo(0, this.canvas.height)<span class="hljs-comment">;</span>
            
            for (let <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; this.snowAccumulation.length; i++) {</span>
                const <span class="hljs-attr">x</span> = i * <span class="hljs-number">5</span><span class="hljs-comment">;</span>
                const <span class="hljs-attr">y</span> = this.canvas.height - this.snowAccumulation[i]<span class="hljs-comment">;</span>
                this.ctx.lineTo(x, y)<span class="hljs-comment">;</span>
            }
            
            this.ctx.lineTo(this.canvas.width, this.canvas.height)<span class="hljs-comment">;</span>
            this.ctx.closePath()<span class="hljs-comment">;</span>
            this.ctx.fill()<span class="hljs-comment">;</span>
        }
    }
}
```

<span class="hljs-comment">### 4.5 Webview 主逻辑</span>

```javascript
// src/webview/main.js
(function() {
    const <span class="hljs-attr">vscode</span> = acquireVsCodeApi()<span class="hljs-comment">;</span>
    const <span class="hljs-attr">canvas</span> = document.getElementById(<span class="hljs-string">'effectCanvas'</span>)<span class="hljs-comment">;</span>
    const <span class="hljs-attr">ctx</span> = canvas.getContext(<span class="hljs-string">'2d'</span>)<span class="hljs-comment">;</span>
    
    let fireEffect, snowEffect<span class="hljs-comment">;</span>
    let <span class="hljs-attr">currentState</span> = <span class="hljs-string">'idle'</span><span class="hljs-comment">;</span>
    let animationId<span class="hljs-comment">;</span>
    
    // 初始化
    function init() {
        resizeCanvas()<span class="hljs-comment">;</span>
        <span class="hljs-attr">fireEffect</span> = new FireEffect(canvas)<span class="hljs-comment">;</span>
        <span class="hljs-attr">snowEffect</span> = new SnowEffect(canvas)<span class="hljs-comment">;</span>
        animate()<span class="hljs-comment">;</span>
    }
    
    // 调整画布大小
    function resizeCanvas() {
        <span class="hljs-attr">canvas.width</span> = window.innerWidth<span class="hljs-comment">;</span>
        <span class="hljs-attr">canvas.height</span> = window.innerHeight<span class="hljs-comment">;</span>
    }
    
    // 动画循环
    function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height)<span class="hljs-comment">;</span>
        
        if (<span class="hljs-attr">currentState</span> === <span class="hljs-string">'fire'</span>) {
            fireEffect.render()<span class="hljs-comment">;</span>
        } else if (<span class="hljs-attr">currentState</span> === <span class="hljs-string">'snow'</span> || currentState === <span class="hljs-string">'snow_accumulate'</span>) {
            snowEffect.render()<span class="hljs-comment">;</span>
        }
        
        <span class="hljs-attr">animationId</span> = requestAnimationFrame(animate)<span class="hljs-comment">;</span>
    }
    
    // 处理来自扩展的消息
    window.addEventListener('message', <span class="hljs-attr">event</span> =&gt; {
        const <span class="hljs-attr">message</span> = event.data<span class="hljs-comment">;</span>
        
        if (<span class="hljs-attr">message.type</span> === <span class="hljs-string">'stateUpdate'</span>) {
            handleStateUpdate(message)<span class="hljs-comment">;</span>
        }
    })<span class="hljs-comment">;</span>
    
    // 处理状态更新
    function handleStateUpdate(message) {
        const <span class="hljs-attr">newState</span> = message.state<span class="hljs-comment">;</span>
        
        if (newState !== currentState) {
            // 状态切换
            if (<span class="hljs-attr">newState</span> === <span class="hljs-string">'fire'</span>) {
                snowEffect.clear()<span class="hljs-comment">;</span>
            } else if (<span class="hljs-attr">newState</span> === <span class="hljs-string">'snow'</span> || newState === <span class="hljs-string">'snow_accumulate'</span>) {
                fireEffect.setIntensity(0)<span class="hljs-comment">;</span>
            }
            <span class="hljs-attr">currentState</span> = newState<span class="hljs-comment">;</span>
        }
        
        // 更新效果参数
        if (<span class="hljs-attr">currentState</span> === <span class="hljs-string">'fire'</span>) {
            fireEffect.setIntensity(message.heatLevel)<span class="hljs-comment">;</span>
        } else if (<span class="hljs-attr">currentState</span> === <span class="hljs-string">'snow'</span>) {
            snowEffect.startSnow(false)<span class="hljs-comment">;</span>
        } else if (<span class="hljs-attr">currentState</span> === <span class="hljs-string">'snow_accumulate'</span>) {
            snowEffect.startSnow(true)<span class="hljs-comment">;</span>
        } else {
            fireEffect.setIntensity(0)<span class="hljs-comment">;</span>
            snowEffect.stopSnow()<span class="hljs-comment">;</span>
        }
    }
    
    // 窗口大小改变时重新调整
    window.addEventListener('resize', () =&gt; {
        resizeCanvas()<span class="hljs-comment">;</span>
        if (snowEffect) snowEffect.initAccumulation()<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>
    
    // 启动
    init()<span class="hljs-comment">;</span>
})()<span class="hljs-comment">;</span>
```

<span class="hljs-comment">## 5. 边界条件与异常处理</span>

<span class="hljs-comment">### 5.1 输入边界</span>
- 热度值范围：0-100，超出范围自动截断
- 空闲时间：使用 Infinity 表示从未输入
- 按键时间戳数组：定期清理过期数据，避免内存泄漏

<span class="hljs-comment">### 5.2 状态切换</span>
- 状态切换时清理前一状态的视觉残留
- 使用平滑过渡避免突兀感

<span class="hljs-comment">### 5.3 性能优化</span>
- 火焰像素矩阵使用固定大小（80x50），通过缩放渲染到实际尺寸
- 雪花数量上限 200 个，避免性能问题
- 使用 requestAnimationFrame 保证动画流畅

<span class="hljs-comment">### 5.4 Webview 生命周期</span>
- Webview 隐藏时暂停动画
- Webview 销毁时清理资源
- 重新显示时恢复状态

<span class="hljs-comment">## 6. 数据流动路径</span>

```
用户输入 → onDidChangeTextDocument → ActivityTracker.recordKeystroke()
                                            ↓
                                    计算热度值/空闲时间
                                            ↓
                              定时器(100ms) → getCurrentState()
                                            ↓
                              WebviewProvider.postMessage()
                                            ↓
                              Webview 接收消息 → handleStateUpdate()
                                            ↓
                              更新 FireEffect/SnowEffect 参数
                                            ↓
                              requestAnimationFrame → render()
```

<span class="hljs-comment">## 7. 预期成果</span>

完成后的 MVP 应具备：
1. ✅ 一键启动视觉效果面板
2. ✅ 实时响应用户输入，渲染火焰效果
3. ✅ 空闲时自动切换到雪花效果
4. ✅ 长时间空闲产生积雪效果
5. ✅ 流畅的动画和状态切换
6. ✅ 详细的代码注释，便于理解和扩展
</code></pre>
<h2 data-id="heading-8">【附录2】插件开发任务计划</h2>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># FrostFire VS Code 插件开发任务计划</span>

<span class="hljs-bullet">-</span> [ ] <span class="hljs-string">任务</span> <span class="hljs-number">1</span><span class="hljs-string">：初始化项目结构与配置文件</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">1.1:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`package.json`，配置插件元信息、activationEvents、commands</span> <span class="hljs-string">和</span> <span class="hljs-string">views（侧边栏注册）</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">1.2:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`tsconfig.json`，配置</span> <span class="hljs-string">TypeScript</span> <span class="hljs-string">编译选项</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">1.3:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`.vscode/launch.json`，配置调试启动项</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">1.4:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`.vscode/tasks.json`，配置</span> <span class="hljs-string">watch</span> <span class="hljs-string">编译任务</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">1.5:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`README.md`，说明项目用途和使用方法</span>

<span class="hljs-bullet">-</span> [ ] <span class="hljs-string">任务</span> <span class="hljs-number">2</span><span class="hljs-string">：实现</span> <span class="hljs-string">ActivityTracker</span> <span class="hljs-string">活跃度追踪模块</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">2.1:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`src/activityTracker.ts`，定义</span> <span class="hljs-string">ActivityTracker</span> <span class="hljs-string">类</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">2.2:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`recordKeystroke()`</span> <span class="hljs-string">方法，记录按键时间戳</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">2.3:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`getHeatLevel()`</span> <span class="hljs-string">方法，计算热度值（0-100）</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">2.4:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`getIdleTime()`</span> <span class="hljs-string">方法，计算空闲时间</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">2.5:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`getCurrentState()`</span> <span class="hljs-string">方法，判断当前状态（fire/idle/snow/snow_accumulate）</span>

<span class="hljs-bullet">-</span> [ ] <span class="hljs-string">任务</span> <span class="hljs-number">3</span><span class="hljs-string">：实现</span> <span class="hljs-string">WebviewProvider</span> <span class="hljs-string">面板管理模块</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">3.1:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`src/webviewProvider.ts`，定义</span> <span class="hljs-string">FrostFireWebviewProvider</span> <span class="hljs-string">类</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">3.2:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`resolveWebviewView()`</span> <span class="hljs-string">方法，创建并配置</span> <span class="hljs-string">Webview</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">3.3:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`getHtmlContent()`</span> <span class="hljs-string">方法，生成包含</span> <span class="hljs-string">Canvas</span> <span class="hljs-string">和脚本的</span> <span class="hljs-string">HTML</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">3.4:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`postMessage()`</span> <span class="hljs-string">方法，向</span> <span class="hljs-string">Webview</span> <span class="hljs-string">发送状态更新消息</span>

<span class="hljs-bullet">-</span> [ ] <span class="hljs-string">任务</span> <span class="hljs-number">4</span><span class="hljs-string">：实现插件主入口</span> <span class="hljs-string">extension.ts</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">4.1:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`src/extension.ts`，实现</span> <span class="hljs-string">`activate()`</span> <span class="hljs-string">函数</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">4.2:</span> <span class="hljs-string">注册</span> <span class="hljs-string">WebviewViewProvider</span> <span class="hljs-string">到</span> <span class="hljs-string">frostfire.effectView</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">4.3:</span> <span class="hljs-string">注册</span> <span class="hljs-string">frostfire.start</span> <span class="hljs-string">和</span> <span class="hljs-string">frostfire.stop</span> <span class="hljs-string">命令</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">4.4:</span> <span class="hljs-string">添加</span> <span class="hljs-string">`onDidChangeTextDocument`</span> <span class="hljs-string">监听器，记录用户输入</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">4.5:</span> <span class="hljs-string">设置定时器（100ms），定期向</span> <span class="hljs-string">Webview</span> <span class="hljs-string">发送状态更新</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">4.6:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`deactivate()`</span> <span class="hljs-string">函数，清理资源</span>

<span class="hljs-bullet">-</span> [ ] <span class="hljs-string">任务</span> <span class="hljs-number">5</span><span class="hljs-string">：实现</span> <span class="hljs-string">Webview</span> <span class="hljs-string">前端效果（火焰效果）</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">5.1:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`src/webview/fireEffect.js`，定义</span> <span class="hljs-string">FireEffect</span> <span class="hljs-string">类</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">5.2:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`createPalette()`</span> <span class="hljs-string">方法，创建</span> <span class="hljs-number">36</span> <span class="hljs-string">色火焰调色板</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">5.3:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`setIntensity()`</span> <span class="hljs-string">方法，根据热度设置火焰强度</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">5.4:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`spreadFire()`</span> <span class="hljs-string">方法，Doom</span> <span class="hljs-string">Fire</span> <span class="hljs-string">传播算法</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">5.5:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`render()`</span> <span class="hljs-string">方法，渲染火焰到</span> <span class="hljs-string">Canvas</span>

<span class="hljs-bullet">-</span> [ ] <span class="hljs-string">任务</span> <span class="hljs-number">6</span><span class="hljs-string">：实现</span> <span class="hljs-string">Webview</span> <span class="hljs-string">前端效果（雪花效果）</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">6.1:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`src/webview/snowEffect.js`，定义</span> <span class="hljs-string">SnowEffect</span> <span class="hljs-string">类</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">6.2:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`createSnowflake()`</span> <span class="hljs-string">方法，生成随机雪花粒子</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">6.3:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`startSnow()`</span> <span class="hljs-string">/</span> <span class="hljs-string">`stopSnow()`</span> <span class="hljs-string">/</span> <span class="hljs-string">`clear()`</span> <span class="hljs-string">控制方法</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">6.4:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`update()`</span> <span class="hljs-string">方法，更新雪花位置和积雪层</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">6.5:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`render()`</span> <span class="hljs-string">方法，渲染雪花和积雪到</span> <span class="hljs-string">Canvas</span>

<span class="hljs-bullet">-</span> [ ] <span class="hljs-string">任务</span> <span class="hljs-number">7</span><span class="hljs-string">：实现</span> <span class="hljs-string">Webview</span> <span class="hljs-string">主逻辑与</span> <span class="hljs-string">HTML</span> <span class="hljs-string">模板</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">7.1:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`src/webview/main.js`，实现消息监听和状态调度</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">7.2:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`handleStateUpdate()`</span> <span class="hljs-string">方法，根据状态切换效果</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">7.3:</span> <span class="hljs-string">实现动画循环</span> <span class="hljs-string">`animate()`，使用</span> <span class="hljs-string">requestAnimationFrame</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">7.4:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`src/webview/index.html`，纯黑背景</span> <span class="hljs-string">Canvas</span> <span class="hljs-string">模板</span>

<span class="hljs-bullet">-</span> [ ] <span class="hljs-string">任务</span> <span class="hljs-number">8</span><span class="hljs-string">：安装依赖并编译验证</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">8.1:</span> <span class="hljs-string">执行</span> <span class="hljs-string">`npm</span> <span class="hljs-string">install`</span> <span class="hljs-string">安装</span> <span class="hljs-string">TypeScript</span> <span class="hljs-string">和</span> <span class="hljs-string">VS</span> <span class="hljs-string">Code</span> <span class="hljs-string">类型定义</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">8.2:</span> <span class="hljs-string">执行</span> <span class="hljs-string">`npm</span> <span class="hljs-string">run</span> <span class="hljs-string">compile`</span> <span class="hljs-string">编译</span> <span class="hljs-string">TypeScript</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">8.3:</span> <span class="hljs-string">检查编译输出，确保无报错</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">8.4:</span> <span class="hljs-string">提供调试启动指南，确认</span> <span class="hljs-string">MVP</span> <span class="hljs-string">可运行</span>
<span class="hljs-string">有问题吗</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 组件通讯全攻略：拒绝 "Props" 焦虑，掌握数据流动的艺术]]></title>    <link>https://juejin.cn/post/7586482851097968680</link>    <guid>https://juejin.cn/post/7586482851097968680</guid>    <pubDate>2025-12-22T03:06:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586482851097968680" data-draft-id="7585850609015914511" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 组件通讯全攻略：拒绝 &quot;Props&quot; 焦虑，掌握数据流动的艺术"/> <meta itemprop="keywords" content="React.js,前端框架,前端"/> <meta itemprop="datePublished" content="2025-12-22T03:06:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="漫天黄叶远飞"/> <meta itemprop="url" content="https://juejin.cn/user/2948205649344634"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 组件通讯全攻略：拒绝 "Props" 焦虑，掌握数据流动的艺术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2948205649344634/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    漫天黄叶远飞
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:06:38.000Z" title="Mon Dec 22 2025 03:06:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><h2 data-id="heading-0">前言</h2>
<p>在 <strong>React</strong> 的开发旅程中，组件就像是乐高积木，我们把它们一个个搭起来构建出复杂的页面。但光搭起来还不够，这些积木之间必须有“电流”流通——这就是数据。<br/>
<strong>React</strong> 的设计哲学是单向数据流，就像瀑布一样，水流默认只能从高处流向低处。但在实际业务中，我们经常需要逆流而上，或者在两个平行的水池间交换水流。今天我们就来盘点 <strong>React</strong> 中最主流的四种“引水”方式，打通你的组件经脉。</p>
<hr/>
<h2 data-id="heading-1">1. 父传子：顺流而下的 Props</h2>
<p>这是 <strong>React</strong> 中最自然、最基础的通信方式。想象一下，父亲给孩子零花钱，父亲（父组件）只需要要把钱（数据）递过去，孩子（子组件）伸手接着就行。<br/>
在代码层面，父组件通过在子组件标签上写上自定义属性（msg）来传递数据。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./Child"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> state = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'小饶'</span>
  }
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>父组件<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      {/* 父亲把 '小饶' 这个名字打包进 msg 属性传给孩子 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">msg</span>=<span class="hljs-string">{state.name}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p>孩子组件这边，所有接收到的礼物都装在一个叫 <code>props</code> 的盒子里。不过要注意，<code>Props</code> 是只读的——这意味着孩子只能使用这些数据，不能直接修改它。就像孩子不能自己修改父亲银行卡的余额一样，如果要改，必须请求父亲操作。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-comment">// 打开盒子看看收到了什么</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(props);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>子组件 -- {props.msg}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span></span>
  )
}
</code></pre>
<hr/>
<h2 data-id="heading-2">2. 子传父：给孩子一个“遥控器”</h2>
<p>既然水流默认向下，那子组件想要改变父组件的数据该怎么办？比如，孩子想告诉父亲：“我考了 100 分，请更新一下你的心情状态”。<br/>
这时候，父组件需要提前准备一个“遥控器”——也就是一个函数。父组件把这个函数通过 <code>props</code> 传给子组件，当子组件需要通信时，就按下这个遥控器（调用函数），并把数据作为参数传回去。
**父组件： 准备好 <code>getNum</code> 函数，用来接收数据并更新自己的 <code>count</code>。 **</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./Child"</span>
<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">1</span>)  

  <span class="hljs-comment">// 这就是那个“遥控器”函数</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">getNum</span> = (<span class="hljs-params">n</span>) =&gt; {
    <span class="hljs-title function_">setCount</span>(n)
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>父组件二 -- {count}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      {/* 把遥控器交给孩子 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">getNum</span>=<span class="hljs-string">{getNum}</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">Child</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p><strong>子组件： 在合适的时机（比如点击按钮时），通过 props 拿到并按下这个“遥控器”。</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params">props</span>) {
  
  <span class="hljs-keyword">const</span> state = {
    <span class="hljs-attr">num</span>: <span class="hljs-number">100</span>
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">send</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 此时调用的是父组件里的函数，把 100 传了回去</span>
    props.<span class="hljs-title function_">getNum</span>(state.<span class="hljs-property">num</span>)
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>子组件二<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{send}</span>&gt;</span>发送<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<hr/>
<h2 data-id="heading-3">3. 兄弟组件：找个共同的“家长”</h2>
<p>兄弟组件之间没有直接的连线，就像你和你的表弟住在不同的屋子里，想聊天得通过大厅里的长辈传话。
这种模式在 <strong>React</strong> 中通常被称为状态提升。既然 <strong>Brother1</strong> 想要给 <strong>Brother2</strong> 传值，那我们就把这个值保存在他们共同的父亲身上。</p>
<ul>
<li>Brother1 -&gt; Parent：Brother1 先把数据传给父亲（利用上面的子传父技巧）。</li>
<li>Parent -&gt; Brother2：父亲拿到数据后，更新自己的状态，再把这个新状态顺手传给 Brother2（利用父传子技巧）。</li>
</ul>
<p><strong>父组件（中间枢纽）：</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Child1</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./Child1"</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Child2</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./Child2"</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> [message, setMessage] = <span class="hljs-title function_">useState</span>()

  <span class="hljs-comment">// 接收老大传来的消息</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">getMsg</span> = (<span class="hljs-params">msg</span>) =&gt; {
    <span class="hljs-title function_">setMessage</span>(msg)
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span> 父组件三 <span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      {/* 接收者：从 Child1 收信 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Child1</span> <span class="hljs-attr">getMsg</span>=<span class="hljs-string">{getMsg}</span> /&gt;</span>
      {/* 发送者：把信转交给 Child2 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Child2</span> <span class="hljs-attr">message</span>=<span class="hljs-string">{message}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p><strong>Child1（消息发送方）：</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Child1</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-keyword">const</span> state = {
    <span class="hljs-attr">msg</span>: <span class="hljs-string">'1 中的数据'</span>
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">send</span>(<span class="hljs-params"/>) {
    props.<span class="hljs-title function_">getMsg</span>(state.<span class="hljs-property">msg</span>)
  }
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>子组件1<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{send}</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p><strong>Child2（消息接收方）：</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Child2</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {/* 坐等父亲把兄弟的消息送过来 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>子组件2 --- {props.message}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<hr/>
<h2 data-id="heading-4">4. 跨代组件通信：Context 传送门</h2>
<p>如果组件层级很深，比如“爷爷 -&gt; 爸爸 -&gt; 儿子 -&gt; 孙子”，如果还用 <strong>Props</strong> 一层层传，那中间的爸爸和儿子就成了无辜的“搬运工”，代码会变得非常臃肿麻烦。<br/>
为了解决这个问题，<strong>React</strong> 提供了一个 <strong>Context</strong>（上下文）机制。这就像在家族里设立了一个“广播站”，爷爷在顶层广播，底下的任何一代子孙，只要想听，就可以直接接收信号，完全不需要中间人转手。<br/>
<strong>爷组件（数据源头）：</strong><br/>
我们需要先 <code>createContext</code> 创建一个信号塔，然后用 <code>&lt;Context.Provider&gt;</code> 把所有后代包起来，<code>value</code> 就是我们要广播的数据。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Parent</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./Parent"</span>
<span class="hljs-keyword">import</span> { createContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">Context</span> = <span class="hljs-title function_">createContext</span>()  <span class="hljs-comment">// 1. 建立信号塔</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Grand</span>(<span class="hljs-params"/>) {

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span> 爷组件 <span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      {/* 2. 发射信号，内容是 value 中的数据 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Context.Provider</span> <span class="hljs-attr">value</span>= <span class="hljs-string">{</span>'<span class="hljs-attr">爷组件的数据</span>'}&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Parent</span>/&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Context.Provider</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p><strong>父组件（路人甲）：</strong><br/>
你看，父组件完全不需要碰这些数据，它只需要安静地渲染它的子组件即可。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./Child"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"/>) {

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>父组件<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Child</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">Child</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p><strong>孙子组件（数据接收者）：</strong><br/>
孙子组件不需要管它离爷爷隔了多少代，直接用 <code>useContext</code> 这个钩子函数，就能连上信号塔拿到数据。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Context</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./Grand'</span>  <span class="hljs-comment">// 3. 引入信号塔定义</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 4. 接收信号</span>
  <span class="hljs-keyword">const</span> msg = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">Context</span>)

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>孙子组件 --- {msg}<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<h2 data-id="heading-5">结语</h2>
<p>组件通信是 <strong>React</strong> 开发中最基本也最重要的内功。</p>
<ul>
<li>简单的父子关系，<strong>Props</strong> 和 <strong>Callback</strong> 是最轻量的选择；</li>
<li>兄弟组件，记得找共同的父级帮忙周转；</li>
<li>当层级太深感到繁琐时，<strong>Context</strong> 就是你的救星。</li>
</ul>
<p>掌握了这四招，你就能从容应对绝大多数的组件交互场景，让数据在你的应用中流动得井井有条。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【vue3】 + 【vite】 + 【vite-plugin-obfuscator】混淆打包 => 放弃了，样式会丢]]></title>    <link>https://juejin.cn/post/7586509410567405609</link>    <guid>https://juejin.cn/post/7586509410567405609</guid>    <pubDate>2025-12-22T03:15:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586509410567405609" data-draft-id="7585789195869388836" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【vue3】 + 【vite】 + 【vite-plugin-obfuscator】混淆打包  =&gt;  放弃了，样式会丢"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-12-22T03:15:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="梦想是准点下班"/> <meta itemprop="url" content="https://juejin.cn/user/2192851914196873"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【vue3】 + 【vite】 + 【vite-plugin-obfuscator】混淆打包  =&gt;  放弃了，样式会丢
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2192851914196873/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    梦想是准点下班
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:15:40.000Z" title="Mon Dec 22 2025 03:15:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>vite-plugin-obfuscator</code> 可以将你的代码进行混淆，一个依赖</p>
<hr/>
<p>安装</p>
<p>npm install vite-plugin-obfuscator --save-dev</p>
<p>配置文件引入和配置</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { viteObfuscateFile } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-obfuscator'</span>;

<span class="hljs-comment">// https://vitejs.dev/config/</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">vue</span>(),
    <span class="hljs-title function_">vueJsx</span>(),
    <span class="hljs-title function_">viteMockServe</span>({
      <span class="hljs-attr">mockPath</span>: <span class="hljs-string">'mock'</span>,
      <span class="hljs-attr">localEnabled</span>: <span class="hljs-literal">true</span>
    }),
    <span class="hljs-title function_">viteObfuscateFile</span>({
      <span class="hljs-attr">options</span>: {
        <span class="hljs-attr">debugProtection</span>: <span class="hljs-literal">true</span>
      }
    })
  ],
</code></pre>
<p>报错：</p>
<p>无法找到模块“vite-plugin-obfuscator”的声明文件。</p>
<p>没有具体步骤，这个依赖缺少类型声明，ts进行报错，给它一个声明就行，例如：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 添加 vite-plugin-obfuscator 的类型声明</span>
declare <span class="hljs-variable language_">module</span> <span class="hljs-string">'vite-plugin-obfuscator'</span> {
  <span class="hljs-keyword">import</span> { <span class="hljs-title class_">Plugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>;

  interface <span class="hljs-title class_">ViteObfuscateFileOptions</span> {
    options?: any;
  }

  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">viteObfuscateFile</span>(<span class="hljs-params">options?: ViteObfuscateFileOptions</span>): <span class="hljs-title class_">Plugin</span>;
}
</code></pre>
<p>具体的混淆配置：</p>








































<table><thead><tr><th><code>compact</code></th><th><code>boolean</code></th><th><code>true</code></th><th>压缩代码，移除空格和换行符。</th><th>样式丢失</th></tr></thead><tbody><tr><td><code>debugProtection</code></td><td><code>boolean</code></td><td><code>false</code></td><td>防止在开发者工具中调试代码。</td><td/></tr><tr><td>-----------------</td><td>---------</td><td>-------</td><td>--------------</td><td/></tr><tr><td><code>renameGlobals</code></td><td><code>boolean</code></td><td><code>false</code></td><td>重命名全局变量和函数名。</td><td>接口路径失效</td></tr><tr><td>---------------</td><td>---------</td><td>-------</td><td>------------</td><td>---</td></tr></tbody></table>










<table><thead><tr><th><code>renameProperties</code></th><th><code>boolean</code></th><th><code>false</code></th><th>重命名对象的属性名。</th><th>样式丢失？</th></tr></thead></table>










<table><thead><tr><th><code>transformObjectKeys</code></th><th><code>boolean</code></th><th><code>false</code></th><th>转换对象的键名，增加代码的复杂性。</th><th>样式丢失？</th></tr></thead></table>
<p>难搞啊，样式会丢</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[高德地图-物流路线]]></title>    <link>https://juejin.cn/post/7586208617603285026</link>    <guid>https://juejin.cn/post/7586208617603285026</guid>    <pubDate>2025-12-22T03:13:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586208617603285026" data-draft-id="7585920796100395035" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="高德地图-物流路线"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-12-22T03:13:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="星_离"/> <meta itemprop="url" content="https://juejin.cn/user/2652464856962254"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            高德地图-物流路线
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2652464856962254/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    星_离
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:13:59.000Z" title="Mon Dec 22 2025 03:13:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>有些时候我们的项目只使用原生一些内容是无法实现一些功能的，所以今天我带来了一个大家都熟悉的，也是生活中常见的一个功能，也就是大家在网购的时候，下单成功后就可以看到自己的订单，当然也可以查看物流信息，那么物流信息中有一个部分就是地图部分，这部分可以让用户看到自己购买的商品到了哪里。那这个功能我们使用原生大概率是无法完成的，这就需要我们使用高德地图、百度地图或者腾讯之类的开放地图类 API 的功能，那么今天我就来和大家分享一下如何去使用高德地图实现这一功能。</p>
<h2 data-id="heading-0">1. 准备工作</h2>
<h3 data-id="heading-1">1.1. 官方文档</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flbs.amap.com%2Fapi%2Fjavascript-api-v2%2Fguide%2Fabc%2Famap-vue" target="_blank" title="https://lbs.amap.com/api/javascript-api-v2/guide/abc/amap-vue" ref="nofollow noopener noreferrer">lbs.amap.com/api/javascr…</a></p>
<h3 data-id="heading-2">1.2. 需要安装的依赖</h3>
<pre><code class="hljs language-css" lang="css">npm <span class="hljs-selector-tag">i</span> <span class="hljs-keyword">@amap</span>/amap-jsapi-loader --save
</code></pre>
<h2 data-id="heading-3">2. 开始</h2>
<p>首先我们需要给地图设置一个容器，命名为<code>container</code></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"container"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>设置样式</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>  <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
  <span class="hljs-selector-id">#container</span>{
      <span class="hljs-attribute">padding</span>:<span class="hljs-number">0px</span>;
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">0px</span>;
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">800px</span>;
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h3 data-id="heading-4">2.1. 创建地图组件</h3>
<p>首先我们需要去扩展 window 接口类型的定义，如果不配置就会出现错误：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f0385debae646ab83e710854d3b0ac3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pifX-emuw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978039&amp;x-signature=O8Y5ucWsYVL8ETeID06i8MZzUGk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/117de5c26e2a46d782e2e04bf551cbcb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pifX-emuw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978039&amp;x-signature=ymA2M1Ncx6aRcZ%2BWVgVHYCIGpLA%3D" alt="" loading="lazy"/></p>
<p>核心原因：</p>
<p>TypeScript 对 <code>window</code> 的类型有严格定义，默认的 <code>Window</code> 接口里没有 <code>_AMapSecurityConfig</code>，所以会提示 “该属性不存在”。但是高德地图又需要这个属性来配置安全密钥，所以我们就需要来扩展一下 window 类型。</p>
<p>那么我们就需要先来配置一下：按照以下路径创建 global.d.ts 文件</p>
<p>src--&gt;types--&gt;global.d.ts</p>
<p>进入文件配置以下内容：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">interface</span> <span class="hljs-title">Window</span> {
  _AMapSecurityConfig: {
      securityJsCode: <span class="hljs-built_in">string</span>
  }
}
</code></pre>
<h3 data-id="heading-5">2.2. 初始化地图组件</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span>  {onMounted,onUnmounted} <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">AMapLoader</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@amap/amap-jsapi-loader'</span>;

<span class="hljs-keyword">let</span> map = <span class="hljs-literal">null</span>;
<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">()=&gt;</span>{
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">_AMapSecurityConfig</span> = {
    <span class="hljs-attr">securityJsCode</span>: <span class="hljs-string">"379c75538f6ae27ee95c983a6feaf358"</span>,
  };
  <span class="hljs-title class_">AMapLoader</span>.<span class="hljs-title function_">load</span>({
    <span class="hljs-attr">key</span>:<span class="hljs-string">"3d0735cef9dc47489452066b7dbe2510"</span>,
    <span class="hljs-attr">version</span>:<span class="hljs-string">"2.0"</span>,
    <span class="hljs-attr">plugins</span>:[<span class="hljs-string">"AMap.scale"</span>]
  })
    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">AMap</span>)=&gt;</span>{
      map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-title class_">Map</span>(<span class="hljs-string">"container"</span>,{
        <span class="hljs-comment">//设置地图容器的Id</span>
        <span class="hljs-attr">viewMode</span>:<span class="hljs-string">"3D"</span>,<span class="hljs-comment">//是否为3D地图模式</span>
        <span class="hljs-attr">zoom</span>:<span class="hljs-number">11</span>,<span class="hljs-comment">//初始化地图级别</span>
        <span class="hljs-attr">center</span>:[<span class="hljs-number">116.397428</span>, <span class="hljs-number">39.90923</span>]
      })
    })
    .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e</span>)=&gt;</span>{
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(e)
    })
})
<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">()=&gt;</span>{
  map?.<span class="hljs-title function_">destroy</span>();
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h2 data-id="heading-6">3. 路线规划</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flbs.amap.com%2Fdemo%2Fjavascript-api-v2%2Fexample%2Fdriving-route%2Fplan-route-according-to-lnglat" target="_blank" title="https://lbs.amap.com/demo/javascript-api-v2/example/driving-route/plan-route-according-to-lnglat" ref="nofollow noopener noreferrer">lbs.amap.com/demo/javasc…</a></p>
<p>通过数据处理出起始点和途径点的坐标：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">logisticsInfo</span> = [
  {
    <span class="hljs-string">"latitude"</span>: <span class="hljs-string">"23.129152403638752"</span>,
    <span class="hljs-string">"longitude"</span>: <span class="hljs-string">"113.42775362698366"</span>
  },
  {
    <span class="hljs-string">"latitude"</span>: <span class="hljs-string">"30.454012"</span>,
    <span class="hljs-string">"longitude"</span>: <span class="hljs-string">"114.42659"</span>
  },
  {
    <span class="hljs-string">"latitude"</span>: <span class="hljs-string">"31.93182"</span>,
    <span class="hljs-string">"longitude"</span>: <span class="hljs-string">"118.633415"</span>
  },
  {
    <span class="hljs-string">"latitude"</span>: <span class="hljs-string">"31.035032"</span>,
    <span class="hljs-string">"longitude"</span>: <span class="hljs-string">"121.611504"</span>
  }
]
</code></pre>

<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 物流轨迹的起始点</span>
  <span class="hljs-type">const</span> start = logisticsInfo.<span class="hljs-built_in">shift</span>()<span class="hljs-comment">//起点</span>
  <span class="hljs-type">const</span> end = logisticsInfo.<span class="hljs-built_in">pop</span>()<span class="hljs-comment">//终点</span>
  <span class="hljs-type">const</span> ways = logisticsInfo.<span class="hljs-built_in">map</span>(item =&gt; [item.longitude, item.latitude])<span class="hljs-comment">//途径点数组</span>
</code></pre>

<pre><code class="hljs language-arduino" lang="arduino">AMap.<span class="hljs-built_in">plugin</span>(<span class="hljs-string">'AMap.Driving'</span>, () =&gt; {
  <span class="hljs-comment">//构造路线导航类</span>
  var driving = <span class="hljs-keyword">new</span> AMap.<span class="hljs-built_in">Driving</span>({
    map: map, <span class="hljs-comment">// 指定绘制的路线轨迹显示到map地图</span>
    showTraffic: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 关闭实时交通路况</span>
    hideMarkers: <span class="hljs-literal">false</span> <span class="hljs-comment">// 隐藏默认的图标</span>
  });
  <span class="hljs-comment">// 根据起终点经纬度规划驾车导航路线</span>
  driving.<span class="hljs-built_in">search</span>(<span class="hljs-keyword">new</span> AMap.<span class="hljs-built_in">LngLat</span>(start.longitude, start.latitude), <span class="hljs-keyword">new</span> AMap.<span class="hljs-built_in">LngLat</span>(end.longitude, end.latitude), {
    waypoints:ways, <span class="hljs-comment">// 途经点这里是一个二维数组的格式[[经度, 维度], [经度, 维度]]</span>
  },<span class="hljs-built_in">function</span> (status: string, result: object) {

    <span class="hljs-keyword">if</span> (status === <span class="hljs-string">'complete'</span>) {
      console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'绘制驾车路线完成'</span>)
      <span class="hljs-comment">// 调整视野达到最佳显示区域</span>
      map.<span class="hljs-built_in">setFitView</span>([ startMarker, endMarker, currentMarker ])
    } <span class="hljs-keyword">else</span> {
      console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'获取驾车数据失败：'</span> + result)
    }
  })
})
</code></pre>
<h2 data-id="heading-7">4. 自定义图标</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de6dc325047142c19f81746b5cb14ba1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pifX-emuw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978039&amp;x-signature=xhm3Jn3jEWk4eZt2q9BImk%2FzHmQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a63a855fae740b7ae3907546cc372bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pifX-emuw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978039&amp;x-signature=%2FFhHSgxw4JKWXH%2Fk7ea3Dv%2BtvCs%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8322b3e6b50a459196d3e85bd56e3b3e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pifX-emuw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978039&amp;x-signature=CAVa0FgeYxN%2Fw9ERK8m9RarXZPg%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> startImg <span class="hljs-keyword">from</span> <span class="hljs-string">'../public/start.png'</span>
<span class="hljs-keyword">import</span> endImg <span class="hljs-keyword">from</span> <span class="hljs-string">'../public/end.png'</span>
<span class="hljs-keyword">import</span> carImg <span class="hljs-keyword">from</span> <span class="hljs-string">'../public/car.png'</span>
</code></pre>
<p>自定义图标需要使用到 marker 类</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 自定义开始坐标图片</span>
<span class="hljs-type">const</span> startMarker = <span class="hljs-keyword">new</span> AMap.<span class="hljs-built_in">Marker</span>({
  position: [start.longitude, start.latitude], <span class="hljs-comment">// 自定义图标位置</span>
  icon:startImg,
  map: map <span class="hljs-comment">// 指定图标显示在哪个地图实例</span>
})
<span class="hljs-comment">// 自定义终点坐标图片</span>
<span class="hljs-type">const</span> endMarker = <span class="hljs-keyword">new</span> AMap.<span class="hljs-built_in">Marker</span>({
  position: [end.longitude, end.latitude],
  icon:endImg,
  map: map
})
<span class="hljs-comment">// 自定义当前坐标图片</span>
<span class="hljs-type">const</span> currentMarker = <span class="hljs-keyword">new</span> AMap.<span class="hljs-built_in">Marker</span>({
  position: [currentLocationInfo.longitude, currentLocationInfo.latitude],
  icon:carImg,
  map: map
})
</code></pre>
<h2 data-id="heading-8">5. 完整代码实现</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>地图组件<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"container"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width:100%; height: 500px;"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">AMapLoader</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@amap/amap-jsapi-loader'</span>
<span class="hljs-keyword">import</span> startImg <span class="hljs-keyword">from</span> <span class="hljs-string">'../public/start.png'</span>
<span class="hljs-keyword">import</span> endImg <span class="hljs-keyword">from</span> <span class="hljs-string">'../public/end.png'</span>
<span class="hljs-keyword">import</span> carImg <span class="hljs-keyword">from</span> <span class="hljs-string">'../public/car.png'</span>
<span class="hljs-comment">// 接口返回的数据</span>
<span class="hljs-keyword">const</span> logisticsInfo = [
  {
    <span class="hljs-string">"latitude"</span>: <span class="hljs-string">"23.129152403638752"</span>,
    <span class="hljs-string">"longitude"</span>: <span class="hljs-string">"113.42775362698366"</span>
  },
  {
    <span class="hljs-string">"latitude"</span>: <span class="hljs-string">"30.454012"</span>,
    <span class="hljs-string">"longitude"</span>: <span class="hljs-string">"114.42659"</span>
  },
  {
    <span class="hljs-string">"latitude"</span>: <span class="hljs-string">"31.93182"</span>,
    <span class="hljs-string">"longitude"</span>: <span class="hljs-string">"118.633415"</span>
  },
  {
    <span class="hljs-string">"latitude"</span>: <span class="hljs-string">"31.035032"</span>,
    <span class="hljs-string">"longitude"</span>: <span class="hljs-string">"121.611504"</span>
  }
]
<span class="hljs-comment">// 当前坐标</span>
<span class="hljs-keyword">const</span> currentLocationInfo = {
  <span class="hljs-attr">latitude</span>: <span class="hljs-string">"31.93182"</span>,
  <span class="hljs-attr">longitude</span>: <span class="hljs-string">"118.633415"</span>
}
<span class="hljs-variable language_">window</span>.<span class="hljs-property">_AMapSecurityConfig</span> = {
  <span class="hljs-attr">securityJsCode</span>: <span class="hljs-string">'2af1e64a8f6b16d6d79bfa8162c46755'</span>
}
<span class="hljs-title function_">onMounted</span>(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">AMap</span> = <span class="hljs-keyword">await</span> <span class="hljs-title class_">AMapLoader</span>.<span class="hljs-title function_">load</span>({
    <span class="hljs-attr">key</span>: <span class="hljs-string">'9ac7a2671565e21bc21aca6df07eb5cb'</span>,
    <span class="hljs-attr">version</span>: <span class="hljs-string">'2.0'</span>
  })
  <span class="hljs-comment">// 地图的创建</span>
  <span class="hljs-keyword">var</span> map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-title class_">Map</span>(<span class="hljs-string">'container'</span>, {
    <span class="hljs-attr">viewMode</span>: <span class="hljs-string">'2D'</span>, <span class="hljs-comment">// 默认使用 2D 模式，如果希望使用带有俯仰角的 3D 模式，请设置 viewMode: '3D'</span>
    <span class="hljs-attr">zoom</span>:<span class="hljs-number">16</span>, <span class="hljs-comment">// 初始化地图层级</span>
    <span class="hljs-attr">center</span>: [<span class="hljs-number">116.209804</span>,<span class="hljs-number">40.149393</span>], <span class="hljs-comment">// 初始化地图中心点</span>
    <span class="hljs-attr">plugins</span>:[<span class="hljs-string">"AMap.Driving"</span>]
  });


  <span class="hljs-comment">// 物流轨迹的起始点</span>
  <span class="hljs-keyword">const</span> start = logisticsInfo.<span class="hljs-title function_">shift</span>()
  <span class="hljs-keyword">const</span> end = logisticsInfo.<span class="hljs-title function_">pop</span>()
  <span class="hljs-keyword">const</span> ways = logisticsInfo.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> [item.<span class="hljs-property">longitude</span>, item.<span class="hljs-property">latitude</span>])
  <span class="hljs-comment">// 自定义开始坐标图片</span>
  <span class="hljs-keyword">const</span> startMarker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-title class_">Marker</span>({
    <span class="hljs-attr">position</span>: [start.<span class="hljs-property">longitude</span>, start.<span class="hljs-property">latitude</span>], <span class="hljs-comment">// 自定义图标位置</span>
    <span class="hljs-attr">icon</span>:startImg,
    <span class="hljs-attr">map</span>: map <span class="hljs-comment">// 指定图标显示在哪个地图实例</span>
  })
  <span class="hljs-comment">// 自定义终点坐标图片</span>
  <span class="hljs-keyword">const</span> endMarker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-title class_">Marker</span>({
    <span class="hljs-attr">position</span>: [end.<span class="hljs-property">longitude</span>, end.<span class="hljs-property">latitude</span>],
    <span class="hljs-attr">icon</span>:endImg,
    <span class="hljs-attr">map</span>: map
  })
<span class="hljs-comment">// 自定义当前坐标图片</span>
  <span class="hljs-keyword">const</span> currentMarker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-title class_">Marker</span>({
    <span class="hljs-attr">position</span>: [currentLocationInfo.<span class="hljs-property">longitude</span>, currentLocationInfo.<span class="hljs-property">latitude</span>],
    <span class="hljs-attr">icon</span>:carImg,
    <span class="hljs-attr">map</span>: map
  })

  <span class="hljs-comment">// 绘制物流轨迹</span>
  <span class="hljs-title class_">AMap</span>.<span class="hljs-title function_">plugin</span>(<span class="hljs-string">'AMap.Driving'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">//构造路线导航类</span>
    <span class="hljs-keyword">var</span> driving = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-title class_">Driving</span>({
      <span class="hljs-attr">map</span>: map, <span class="hljs-comment">// 指定绘制的路线轨迹显示到map地图</span>
      <span class="hljs-attr">showTraffic</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 关闭实时交通路况</span>
      <span class="hljs-attr">hideMarkers</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 隐藏默认的图标</span>
    });
    <span class="hljs-comment">// 根据起终点经纬度规划驾车导航路线</span>
    driving.<span class="hljs-title function_">search</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-title class_">LngLat</span>(start.<span class="hljs-property">longitude</span>, start.<span class="hljs-property">latitude</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-title class_">LngLat</span>(end.<span class="hljs-property">longitude</span>, end.<span class="hljs-property">latitude</span>), {
      <span class="hljs-attr">waypoints</span>:ways, <span class="hljs-comment">// 途经点这里是一个二维数组的格式[[经度, 维度], [经度, 维度]]</span>
    },<span class="hljs-keyword">function</span> (<span class="hljs-params">status: string, result: object</span>) {

      <span class="hljs-keyword">if</span> (status === <span class="hljs-string">'complete'</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'绘制驾车路线完成'</span>)
        <span class="hljs-comment">// 调整视野达到最佳显示区域</span>
        map.<span class="hljs-title function_">setFitView</span>([ startMarker, endMarker, currentMarker ])
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'获取驾车数据失败：'</span> + result)
      }
    })
  })

})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Lexical 富文本编辑器组件详解]]></title>    <link>https://juejin.cn/post/7586509410567438377</link>    <guid>https://juejin.cn/post/7586509410567438377</guid>    <pubDate>2025-12-22T03:18:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586509410567438377" data-draft-id="7586136543954354214" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Lexical 富文本编辑器组件详解"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-22T03:18:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="细心细心再细心"/> <meta itemprop="url" content="https://juejin.cn/user/721738373803879"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Lexical 富文本编辑器组件详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/721738373803879/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    细心细心再细心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:18:04.000Z" title="Mon Dec 22 2025 03:18:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">📚 Lexical 简介</h3>
<p><strong>Lexical</strong> 是 Meta 开源的基于 React 的富文本编辑器框架，用于替代 Draft.js，具有更好的性能、扩展性和稳定性。</p>
<h3 data-id="heading-1">🎯 核心特性</h3>
<ul>
<li>✅ 高性能、可扩展</li>
<li>✅ 无依赖、轻量级</li>
<li>✅ 完整的 TypeScript 支持</li>
<li>✅ 插件化架构</li>
<li>✅ 嵌套编辑器支持</li>
</ul>
<h3 data-id="heading-2">🔧 基础组件</h3>
<h4 data-id="heading-3">1. <strong>LexicalComposer</strong> - 编辑器容器</h4>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">LexicalComposer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalComposer'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> initialConfig = {
    <span class="hljs-attr">namespace</span>: <span class="hljs-string">'MyEditor'</span>,
    <span class="hljs-attr">theme</span>: theme,
    <span class="hljs-attr">nodes</span>: [],
    <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error),
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">LexicalComposer</span> <span class="hljs-attr">initialConfig</span>=<span class="hljs-string">{initialConfig}</span>&gt;</span>
      {/* 其他插件组件 */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">LexicalComposer</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-4">2. <strong>RichTextPlugin</strong> - 富文本核心</h4>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">RichTextPlugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalRichTextPlugin'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ContentEditable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalContentEditable'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">HistoryPlugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalHistoryPlugin'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Editor</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">RichTextPlugin</span>
        <span class="hljs-attr">contentEditable</span>=<span class="hljs-string">{</span>
          &lt;<span class="hljs-attr">ContentEditable</span>
            <span class="hljs-attr">className</span>=<span class="hljs-string">"editor-input"</span>
            <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
              <span class="hljs-attr">minHeight:</span> '<span class="hljs-attr">150px</span>',
              <span class="hljs-attr">border:</span> '<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">ccc</span>',
              <span class="hljs-attr">padding:</span> '<span class="hljs-attr">10px</span>',
            }}
          /&gt;</span>
        }
        placeholder={
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"editor-placeholder"</span>&gt;</span>输入内容...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        }
        ErrorBoundary={LexicalErrorBoundary}
      /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">HistoryPlugin</span> /&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-5">3. <strong>完整的基础编辑器</strong></h4>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { 
  <span class="hljs-title class_">LexicalComposer</span>, 
  <span class="hljs-title class_">RichTextPlugin</span>,
  <span class="hljs-title class_">ContentEditable</span>,
  <span class="hljs-title class_">HistoryPlugin</span>,
  <span class="hljs-title class_">AutoFocusPlugin</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">HeadingNode</span>, <span class="hljs-title class_">QuoteNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/rich-text'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TableCellNode</span>, <span class="hljs-title class_">TableNode</span>, <span class="hljs-title class_">TableRowNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/table'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ListNode</span>, <span class="hljs-title class_">ListItemNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/list'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CodeHighlightNode</span>, <span class="hljs-title class_">CodeNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/code'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AutoLinkNode</span>, <span class="hljs-title class_">LinkNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/link'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">TRANSFORMERS</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/markdown'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">MarkdownShortcutPlugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalMarkdownShortcutPlugin'</span>;

<span class="hljs-keyword">const</span> theme = {
  <span class="hljs-comment">// 自定义样式</span>
  <span class="hljs-attr">text</span>: {
    <span class="hljs-attr">bold</span>: <span class="hljs-string">'editor-text-bold'</span>,
    <span class="hljs-attr">italic</span>: <span class="hljs-string">'editor-text-italic'</span>,
    <span class="hljs-attr">underline</span>: <span class="hljs-string">'editor-text-underline'</span>,
    <span class="hljs-attr">strikethrough</span>: <span class="hljs-string">'editor-text-strikethrough'</span>,
  }
};

<span class="hljs-keyword">const</span> initialConfig = {
  <span class="hljs-attr">namespace</span>: <span class="hljs-string">'MyEditor'</span>,
  theme,
  <span class="hljs-attr">nodes</span>: [
    <span class="hljs-title class_">HeadingNode</span>,
    <span class="hljs-title class_">QuoteNode</span>,
    <span class="hljs-title class_">TableNode</span>,
    <span class="hljs-title class_">TableCellNode</span>,
    <span class="hljs-title class_">TableRowNode</span>,
    <span class="hljs-title class_">ListNode</span>,
    <span class="hljs-title class_">ListItemNode</span>,
    <span class="hljs-title class_">CodeNode</span>,
    <span class="hljs-title class_">CodeHighlightNode</span>,
    <span class="hljs-title class_">AutoLinkNode</span>,
    <span class="hljs-title class_">LinkNode</span>
  ],
  <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error),
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyEditor</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">LexicalComposer</span> <span class="hljs-attr">initialConfig</span>=<span class="hljs-string">{initialConfig}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"editor-container"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">RichTextPlugin</span>
          <span class="hljs-attr">contentEditable</span>=<span class="hljs-string">{</span>
            &lt;<span class="hljs-attr">ContentEditable</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"editor-input"</span> /&gt;</span>
          }
          placeholder={
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"editor-placeholder"</span>&gt;</span>开始写作...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          }
        /&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">HistoryPlugin</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">AutoFocusPlugin</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">MarkdownShortcutPlugin</span> <span class="hljs-attr">transformers</span>=<span class="hljs-string">{TRANSFORMERS}</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">LexicalComposer</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-6">🔌 常用插件组件</h3>
<h4 data-id="heading-7">1. <strong>ToolbarPlugin</strong> - 工具栏组件</h4>
<p>jsx</p>
<pre><code class="hljs language-ini" lang="ini">import { 
  $getSelection, 
  $isRangeSelection, 
  FORMAT_TEXT_COMMAND 
} from 'lexical'<span class="hljs-comment">;</span>

function ToolbarPlugin() {
  const <span class="hljs-section">[isBold, setIsBold]</span> = useState(false)<span class="hljs-comment">;</span>
  const <span class="hljs-section">[isItalic, setIsItalic]</span> = useState(false)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">editor</span> = useLexicalComposerContext()<span class="hljs-comment">;</span>

  const <span class="hljs-attr">updateToolbar</span> = useCallback(() =&gt; {
    const <span class="hljs-attr">selection</span> = <span class="hljs-variable">$getSelection</span>()<span class="hljs-comment">;</span>
    if ($isRangeSelection(selection)) {
      setIsBold(selection.hasFormat('bold'))<span class="hljs-comment">;</span>
      setIsItalic(selection.hasFormat('italic'))<span class="hljs-comment">;</span>
    }
  }, <span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>

  // 监听编辑器状态变化
  useEffect(() =&gt; {
    return editor.registerUpdateListener(({ editorState }) =&gt; {
      editorState.read(() =&gt; {
        updateToolbar()<span class="hljs-comment">;</span>
      })<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>
  }, <span class="hljs-section">[editor, updateToolbar]</span>)<span class="hljs-comment">;</span>

  return (
    &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"toolbar"</span>&gt;
      &lt;button
        <span class="hljs-attr">className</span>={isBold ? <span class="hljs-string">'active'</span> : <span class="hljs-string">''</span>}
        <span class="hljs-attr">onClick</span>={() =&gt; editor.dispatchCommand(FORMAT_TEXT_COMMAND, <span class="hljs-string">'bold'</span>)}
      &gt;
        加粗
      &lt;/button&gt;
      &lt;button
        <span class="hljs-attr">className</span>={isItalic ? <span class="hljs-string">'active'</span> : <span class="hljs-string">''</span>}
        <span class="hljs-attr">onClick</span>={() =&gt; editor.dispatchCommand(FORMAT_TEXT_COMMAND, <span class="hljs-string">'italic'</span>)}
      &gt;
        斜体
      &lt;/button&gt;
      &lt;button
        <span class="hljs-attr">onClick</span>={() =&gt; editor.dispatchCommand(FORMAT_TEXT_COMMAND, <span class="hljs-string">'underline'</span>)}
      &gt;
        下划线
      &lt;/button&gt;
    &lt;/div&gt;
  )<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-8">2. <strong>ImagePlugin</strong> - 图片上传</h4>
<p>jsx</p>
<pre><code class="hljs language-ini" lang="ini">import { INSERT_IMAGE_COMMAND } from './ImagePlugin'<span class="hljs-comment">;</span>

function ImagePlugin() {
  const <span class="hljs-section">[editor]</span> = useLexicalComposerContext()<span class="hljs-comment">;</span>

  const <span class="hljs-attr">handleImageUpload</span> = useCallback((files: FileList) =&gt; {
    const <span class="hljs-attr">reader</span> = new FileReader()<span class="hljs-comment">;</span>
    <span class="hljs-attr">reader.onload</span> = function () {
      if (typeof <span class="hljs-attr">reader.result</span> === <span class="hljs-string">'string'</span>) {
        editor.dispatchCommand(INSERT_IMAGE_COMMAND, {
          altText: '图片',
          src: reader.result,
        })<span class="hljs-comment">;</span>
      }
    }<span class="hljs-comment">;</span>
    reader.readAsDataURL(files<span class="hljs-section">[0]</span>)<span class="hljs-comment">;</span>
  }, <span class="hljs-section">[editor]</span>)<span class="hljs-comment">;</span>

  return (
    &lt;input
      <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span>
      <span class="hljs-attr">accept</span>=<span class="hljs-string">"image/*"</span>
      <span class="hljs-attr">onChange</span>={(e) =&gt; handleImageUpload(e.target.files)}
    /&gt;
  )<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-9">3. <strong>LinkPlugin</strong> - 链接处理</h4>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">LinkPlugin</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">LexicalLinkPlugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalLinkPlugin'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">LinkNode</span>, <span class="hljs-variable constant_">TOGGLE_LINK_COMMAND</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/link'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">LinkPlugin</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [editor] = <span class="hljs-title function_">useLexicalComposerContext</span>();
  <span class="hljs-keyword">const</span> [isLink, setIsLink] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-keyword">const</span> insertLink = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!isLink) {
      <span class="hljs-keyword">const</span> url = <span class="hljs-title function_">prompt</span>(<span class="hljs-string">'输入链接地址:'</span>, <span class="hljs-string">'https://'</span>);
      <span class="hljs-keyword">if</span> (url) {
        editor.<span class="hljs-title function_">dispatchCommand</span>(<span class="hljs-variable constant_">TOGGLE_LINK_COMMAND</span>, url);
      }
    } <span class="hljs-keyword">else</span> {
      editor.<span class="hljs-title function_">dispatchCommand</span>(<span class="hljs-variable constant_">TOGGLE_LINK_COMMAND</span>, <span class="hljs-literal">null</span>);
    }
  }, [editor, isLink]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{insertLink}</span>&gt;</span>
        {isLink ? '取消链接' : '添加链接'}
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">LexicalLinkPlugin</span> /&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-10">📋 自定义节点组件</h3>
<h4 data-id="heading-11">1. <strong>自定义节点定义</strong></h4>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// CustomNode.js</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">DecoratorNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'lexical'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomNode</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">DecoratorNode</span> {
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">getType</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'custom'</span>;
  }

  <span class="hljs-keyword">static</span> <span class="hljs-title function_">clone</span>(<span class="hljs-params">node</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomNode</span>(node.<span class="hljs-property">__key</span>);
  }

  <span class="hljs-title function_">createDOM</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> div = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
    div.<span class="hljs-property">className</span> = <span class="hljs-string">'custom-node'</span>;
    <span class="hljs-keyword">return</span> div;
  }

  <span class="hljs-title function_">updateDOM</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-title function_">decorate</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">CustomComponent</span> <span class="hljs-attr">nodeKey</span>=<span class="hljs-string">{this.__key}</span> /&gt;</span></span>;
  }
}

<span class="hljs-comment">// 自定义组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">CustomComponent</span>(<span class="hljs-params">{ nodeKey }</span>) {
  <span class="hljs-keyword">const</span> [value, setValue] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'自定义内容'</span>);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"custom-component"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setValue(e.target.value)}
      /&gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 在配置中注册</span>
<span class="hljs-keyword">const</span> initialConfig = {
  <span class="hljs-attr">nodes</span>: [<span class="hljs-title class_">CustomNode</span>, ...其他节点],
};
</code></pre>
<h4 data-id="heading-12">2. <strong>自定义插件示例</strong></h4>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useLexicalComposerContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalComposerContext'</span>;


<span class="hljs-comment">// 自定义键盘快捷键插件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">KeyboardShortcutPlugin</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [editor] = <span class="hljs-title function_">useLexicalComposerContext</span>();

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleKeyDown</span> = (<span class="hljs-params">event</span>) =&gt; {
      <span class="hljs-comment">// Ctrl + S 保存</span>
      <span class="hljs-keyword">if</span> ((event.<span class="hljs-property">ctrlKey</span> || event.<span class="hljs-property">metaKey</span>) &amp;&amp; event.<span class="hljs-property">key</span> === <span class="hljs-string">'s'</span>) {
        event.<span class="hljs-title function_">preventDefault</span>();
        <span class="hljs-comment">// 保存逻辑</span>
        editor.<span class="hljs-title function_">update</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-keyword">const</span> editorState = editor.<span class="hljs-title function_">getEditorState</span>();
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'保存内容:'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(editorState.<span class="hljs-title function_">toJSON</span>()));
        });
      }
      
      <span class="hljs-comment">// Ctrl + B 加粗</span>
      <span class="hljs-keyword">if</span> ((event.<span class="hljs-property">ctrlKey</span> || event.<span class="hljs-property">metaKey</span>) &amp;&amp; event.<span class="hljs-property">key</span> === <span class="hljs-string">'b'</span>) {
        event.<span class="hljs-title function_">preventDefault</span>();
        editor.<span class="hljs-title function_">dispatchCommand</span>(<span class="hljs-variable constant_">FORMAT_TEXT_COMMAND</span>, <span class="hljs-string">'bold'</span>);
      }
    };

    <span class="hljs-keyword">return</span> editor.<span class="hljs-title function_">registerRootListener</span>(<span class="hljs-function">(<span class="hljs-params">rootElement</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (rootElement) {
        rootElement.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keydown'</span>, handleKeyDown);
        <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
          rootElement.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'keydown'</span>, handleKeyDown);
        };
      }
    });
  }, [editor]);

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<h2 data-id="heading-13">实际使用</h2>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">LexicalComposer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalComposer'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">LexicalComposer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalComposer'</span>;
<span class="hljs-keyword">import</span> { useLexicalComposerContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalComposerContext'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ContentEditable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalContentEditable'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">LexicalErrorBoundary</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalErrorBoundary'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">HistoryPlugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalHistoryPlugin'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">OnChangePlugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalOnChangePlugin'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">RichTextPlugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalRichTextPlugin'</span>;


<span class="hljs-keyword">import</span> { <span class="hljs-title class_">VariableTextNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./node'</span>;
<span class="hljs-keyword">import</span> styles <span class="hljs-keyword">from</span> <span class="hljs-string">'./style.module.css'</span>;

  <span class="hljs-keyword">const</span> initialConfig = {
    <span class="hljs-attr">namespace</span>: <span class="hljs-string">'prompt-composer'</span>,
    <span class="hljs-attr">nodes</span>: [<span class="hljs-title class_">VariableTextNode</span>],
    <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">error: <span class="hljs-built_in">Error</span></span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);
    },
    <span class="hljs-attr">theme</span>: {
      <span class="hljs-attr">paragraph</span>: styles.<span class="hljs-property">editorParagraph</span>,
    },
  };



<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.editorWrapper}</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">LexicalComposer</span> <span class="hljs-attr">initialConfig</span>=<span class="hljs-string">{initialConfig}</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
      <span class="hljs-attr">className</span>=<span class="hljs-string">{cx(styles.editor,</span> <span class="hljs-attr">readOnly</span> &amp;&amp; <span class="hljs-attr">styles.editorReadonly</span>)}
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">height</span>, <span class="hljs-attr">minHeight</span> }}
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">RichTextPlugin</span>
        <span class="hljs-attr">contentEditable</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">ContentEditable</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.contentEditable}</span> /&gt;</span>}
        placeholder={<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.placeholder}</span>&gt;</span>{placeholder || ''}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}
        ErrorBoundary={LexicalErrorBoundary}
      /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">OnChangePlugin</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleEditorChange}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">HistoryPlugin</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">VariablePlugin</span> <span class="hljs-attr">variables</span>=<span class="hljs-string">{variables}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">VariableTransformerPlugin</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">EditorUpdatePlugin</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">OnBlurPlugin</span> <span class="hljs-attr">onBlur</span>=<span class="hljs-string">{onBlur}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">LexicalComposer</span>&gt;</span>
  {!readOnly &amp;&amp; (
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.resizeHandle}</span> <span class="hljs-attr">onMouseDown</span>=<span class="hljs-string">{beginResize}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.resizeIcon}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  )}
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
</code></pre>
<pre><code class="hljs language-style.module.css" lang="style.module.css">//样式文件
.editorParagraph {
  margin: 0;
  position: relative;
}
</code></pre>
<pre><code class="hljs language-node.ts" lang="node.ts">//自定义节点
import { TextNode, SerializedTextNode, Spread, NodeKey, $applyNodeReplacement } from 'lexical';

import styles from './style.module.css';

export type SerializedVariableTextNode = Spread&lt;
  {
    variableName: string;
  },
  SerializedTextNode
&gt;;

// Custom Text Node to handle variable highlighting
export class VariableTextNode extends TextNode {
  __variableName: string;

  constructor(text: string, variableName: string, key?: NodeKey) {
    super(text, key);
    this.__variableName = variableName;
  }

  static getType(): string {
    return 'variable-text';
  }

  isSimpleText(): boolean {
    return false;
  }

  // Make this node behave as a single unit - cannot be partially selected or edited
  isTextEntity(): boolean {
    return true;
  }

  static clone(node: VariableTextNode): VariableTextNode {
    return new VariableTextNode(node.getTextContent(), node.__variableName, node.getKey());
  }

  createDOM(config: any): HTMLElement {
    const element = super.createDOM(config);
    element.className = styles.variableToken;
    element.dataset.variable = this.__variableName;
    return element;
  }

  updateDOM(prevNode: VariableTextNode, dom: HTMLElement, config: any): boolean {
    const isUpdated = super.updateDOM(prevNode as any, dom, config);
    if (prevNode.__variableName !== this.__variableName) {
      dom.dataset.variable = this.__variableName;
      return true;
    }
    return isUpdated;
  }

  exportJSON(): SerializedVariableTextNode {
    return {
      ...super.exportJSON(),
      variableName: this.__variableName,
      type: 'variable-text',
    };
  }

  static importJSON(serializedNode: SerializedVariableTextNode): VariableTextNode {
    const node = new VariableTextNode(serializedNode.text, serializedNode.variableName);
    node.setFormat(serializedNode.format);
    node.setDetail(serializedNode.detail);
    node.setMode(serializedNode.mode);
    node.setStyle(serializedNode.style);
    return node;
  }
}

export function $createVariableTextNode(text: string, variableName: string): VariableTextNode {
  return $applyNodeReplacement(new VariableTextNode(text, variableName));
}//创建并注册一个VariableTextNode节点实例



</code></pre>
<ul>
<li>$applyNodeReplacement的作用</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"/></pre>
<p>// 这是 Lexical 的内部工具函数
import { $applyNodeReplacement } from 'lexical';</p>
<p>// 它主要做三件事：
function $applyNodeReplacement(newNode) {
// 1. ✅ 检查节点是否已存在（通过 key）
// 2. ✅ 如果存在，返回已存在的节点（避免重复）
// 3. ✅ 如果不存在，注册新节点到编辑器状态
// 4. ✅ 确保节点在编辑器中被正确追踪
}</p>
<pre><code class="hljs"/></pre>
<h3 data-id="heading-14">📝 总结</h3>
<p>Lexical 提供了：</p>
<ol>
<li><strong>模块化架构</strong> - 按需加载插件</li>
<li><strong>完全控制</strong> - 自定义节点和命令</li>
<li><strong>高性能</strong> - 基于不可变数据</li>
<li><strong>扩展性强</strong> - 支持复杂需求</li>
</ol>
<p>推荐使用模式：</p>
<p>jsx</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">LexicalComposer</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Toolbar</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">RichTextPlugin</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">EssentialPlugins</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">CustomPlugins</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">UtilityPlugins</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">LexicalComposer</span>&gt;</span>
</code></pre>
<ul>
<li>"@lexical/code": "^0.38.2"</li>
<li>"@lexical/link": "^0.38.2"</li>
<li>"@lexical/list": "^0.38.2"</li>
<li>"@lexical/react": "^0.16.0"</li>
<li>"@lexical/selection": "^0.38.2"</li>
<li>"@lexical/text": "^0.38.2"</li>
<li>"@lexical/utils": "^0.38.2"</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kuikly 实战：手把手撸一个跨平台 AI 聊天助手 (ChatDemo)]]></title>    <link>https://juejin.cn/post/7586157459971506228</link>    <guid>https://juejin.cn/post/7586157459971506228</guid>    <pubDate>2025-12-22T02:54:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586157459971506228" data-draft-id="7585888537642270735" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kuikly 实战：手把手撸一个跨平台 AI 聊天助手 (ChatDemo)"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-22T02:54:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我有与与症"/> <meta itemprop="url" content="https://juejin.cn/user/4466629837071787"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kuikly 实战：手把手撸一个跨平台 AI 聊天助手 (ChatDemo)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4466629837071787/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我有与与症
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:54:08.000Z" title="Mon Dec 22 2025 02:54:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTencent-TDS%2FKuiklyUI%2Ftree%2Fmain%2Fdemo%2Fsrc%2FcommonMain%2Fkotlin%2Fcom%2Ftencent%2Fkuikly%2Fdemo%2Fpages%2Fcompose%2FchatDemo" target="_blank" title="https://github.com/Tencent-TDS/KuiklyUI/tree/main/demo/src/commonMain/kotlin/com/tencent/kuikly/demo/pages/compose/chatDemo" ref="nofollow noopener noreferrer">GitHub</a></p>
<p> </p>
<p>在这个 AI 大模型满天飞的时代，谁不想拥有一个属于自己的 AI 助手呢？今天，我们就以 ChatDemo 为例，看看如何用一套 Kotlin 代码，在 Android、iOS 和 HarmonyOS 三端上通过 Kuikly Compose 完美复刻 ChatGPT 的流式对话体验。</p>
<p> </p>
<p>别被 AI 的高大上吓跑了，其实拆解下来，核心逻辑就像搭积木一样简单。准备好了吗？发车！</p>
<p> </p>
<h2 data-id="heading-0">页面结构分析</h2>
<p>打开 <code>ChatDemo.kt</code>，我们仿佛看到了一位身材曼妙的“美女”——哦不，是一段结构清晰的代码。整个聊天页面 (<code>ChatScreen</code>) 主要由三部分组成：</p>
<p> </p>
<ol>
<li>
<p>顶部导航栏 (NavBar)：展示标题和返回按钮，雷打不动的“天灵盖”。</p>
</li>
<li>
<p>聊天内容区 (MessageList)：显示对话流，这是核心的“躯干”。</p>
</li>
<li>
<p>底部输入区 (InputArea)：输入框和发送按钮，负责交互的“四肢”。</p>
</li>
</ol>
<p> </p>
<p>这种结构在 Kuikly Compose 中实现起来异常清爽，简直就是“所见即所得”：</p>
<p> </p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 伪代码结构演示</span>

Box(modifier = Modifier.fillMaxSize()) {

    Column {

        NavBar() <span class="hljs-comment">// 1. 天灵盖</span>

        ChatList() <span class="hljs-comment">// 2. 躯干</span>

        InputArea() <span class="hljs-comment">// 3. 四肢</span>
    }
}

</code></pre>
<p> </p>
<h2 data-id="heading-1">Kuikly Compose 写法</h2>
<p> </p>
<h3 data-id="heading-2">页面定义</h3>
<p>不同于之前的 <code>BasePager</code> + DSL，Compose 风格的页面继承自 <code>ComposeContainer</code>，通过 <code>setContent</code> 开启 Compose 的世界：</p>
<p> </p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-meta">@Page(<span class="hljs-string">"ChatDemo"</span>)</span>

<span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatDemo</span> : <span class="hljs-type">ComposeContainer</span>() {

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">willInit</span><span class="hljs-params">()</span></span> {

        <span class="hljs-keyword">super</span>.willInit()

        setContent {

            ChatScreen() <span class="hljs-comment">// 进入 Compose 的声明式 UI 世界</span>

        }
    }
}

</code></pre>
<p>简单粗暴，直接入题！</p>
<p> </p>
<h3 data-id="heading-3">组件与布局</h3>
<p>Kuikly Compose 完美复刻了 Jetpack Compose 的开发体验，让习惯了 Android 开发的同学们倍感亲切。</p>
<p> </p>
<h4 data-id="heading-4">1. 列表组件 (LazyColumn)</h4>
<p>聊天记录怎么展示？<code>LazyColumn</code> 也就是我们常说的 RecyclerView 的“升级版”。</p>
<p> </p>
<pre><code class="hljs language-kotlin" lang="kotlin">
LazyColumn(

    state = listState,

    modifier = Modifier.weight(<span class="hljs-number">1f</span>)

) {

    itemsIndexed(chatList) { index, message -&gt;

        <span class="hljs-comment">// 根据 index 判断是用户还是 AI，渲染不同的气泡</span>

        ChatMessageItem(message, isUser = (index % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>))

    }
}

</code></pre>
<p>看到没？没有 Adapter，没有 ViewHolder，就是一个简单的 Lambda，数据驱动 UI，清爽！</p>
<p> </p>
<h4 data-id="heading-5">2. 输入框 (TextField)</h4>
<p>底部的输入框使用了 <code>TextField</code>，这里有一个亮点——键盘避让。Kuikly 贴心地提供了 <code>keyboardHeightChange</code> 修饰符：</p>
<p> </p>
<pre><code class="hljs language-kotlin" lang="kotlin">
TextField(

    modifier = Modifier

    .keyboardHeightChange {

        <span class="hljs-comment">// 键盘弹起时，自动调整高度，避免遮挡输入框</span>

        keyboardHeight = it.height
    }

)

</code></pre>
<p>这行代码一加，键盘弹起时的页面抖动、遮挡问题统统不见，丝般顺滑。</p>
<p> </p>
<h3 data-id="heading-6">样式与修饰符 (Modifier)</h3>
<p>在 Kuikly Compose 中，<code>attr {}</code> 变成了更强大的 <code>Modifier</code> 链式调用。比如首页那个好看的渐变色卡片：</p>
<p> </p>
<pre><code class="hljs language-kotlin" lang="kotlin">
Box(
    modifier = Modifier

    .clip(RoundedCornerShape(<span class="hljs-number">16.</span>dp)) <span class="hljs-comment">// 裁个圆角</span>

    .background(

        <span class="hljs-comment">// 来个渐变色</span>

        Brush.horizontalGradient(listOf(box.startColor, box.endColor))
    )
    .clickable { ... } <span class="hljs-comment">// 加个点击事件</span>
)

</code></pre>
<p>这就是声明式 UI 的魅力，你要什么效果，直接往上“叠”就行了。</p>
<p> </p>
<h2 data-id="heading-7">核心黑科技：跨平台流式响应</h2>
<p> </p>
<p>界面画好了，怎么让 AI “动”起来？ChatDemo 的核心在于流式响应 (SSE)，也就是那个酷炫的“打字机”效果。这里展示了 Kuikly 强大的跨平台能力。</p>
<p> </p>
<h3 data-id="heading-8">Android &amp; iOS (Ktor 协程)</h3>
<p>这两兄弟关系好，直接用 Kotlin 协程配合 Ktor 网络库，处理起来行云流水：</p>
<p> </p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-comment">// ChatDemo.kt</span>

<span class="hljs-keyword">val</span> channel = response.bodyAsChannel()

<span class="hljs-keyword">while</span> (!channel.isClosedForRead) {

    <span class="hljs-keyword">val</span> line = channel.readUTF8Line()

    <span class="hljs-keyword">if</span> (line.startsWith(<span class="hljs-string">"data:"</span>)) {
        <span class="hljs-comment">// 收到数据，更新 UI</span>
        withContext(Dispatchers.Main) {
            chatList[msgIndex] += delta <span class="hljs-comment">// 界面自动刷新</span>
        }
    }
}

</code></pre>
<p> </p>
<h3 data-id="heading-9">HarmonyOS (Native Module 桥接)</h3>
<p>鸿蒙这位新朋友，Kuikly 也有妙招。在第三方组件Ktor还未完善对鸿蒙的支持情况下，Kuikly提供了Module 桥接机制，99% 的代码用 KMP 共享，剩下 1% 搞不定的平台特性，通过 Module 轻松桥接原生能力。通过 <code>OhosStreamRequestModule</code>，我们能轻松调用鸿蒙原生的 ArkTS 能力：</p>
<p> </p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-comment">// OhosStreamRequestModule.kt</span>

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">request</span><span class="hljs-params">(...)</span></span> {

    <span class="hljs-comment">// 呼叫鸿蒙原生层：帮我发个请求！</span>

    toNative(<span class="hljs-literal">true</span>, <span class="hljs-string">"request"</span>, params) { retEvent -&gt;
        <span class="hljs-comment">// 原生层收到 SSE 数据，回传给 Kotlin</span>
        callbackFn.invoke(eventObj)
    }
}

</code></pre>
<p>这就是 Kuikly 的哲学：能通用的通用，不能通用的桥接。一套架构，搞定所有平台。</p>
<p> </p>
<h2 data-id="heading-10">细节打磨：Markdown 渲染</h2>
<p>AI 返回的代码块、加粗字体怎么显示？直接塞进 <code>Text</code> 肯定不行。Kuikly 提供了 <code>Markdown</code> 组件：</p>
<p> </p>
<pre><code class="hljs language-kotlin" lang="kotlin">
Markdown(
    state = markdownState,
    colors = markdownColor(text = Color.Black), <span class="hljs-comment">// 定制颜色</span>
    typography = markdownTypography() <span class="hljs-comment">// 定制排版</span>
)

</code></pre>
<p>它能实时解析流式传输过来的 Markdown 文本，渲染过程毫无闪烁，稳如老狗。</p>
<p> </p>
<h2 data-id="heading-11">总结</h2>
<p>通过 Review <code>ChatDemo</code> 的源码，我们不仅学会了如何画界面，更解锁了 AI 应用开发的核心技能：</p>
<p> </p>
<ol>
<li>
<p>Compose 写法：用 <code>Modifier</code> 和声明式组件构建 UI，效率起飞。</p>
</li>
<li>
<p>状态管理：<code>mutableState</code> 让数据驱动界面更新，告别繁琐的 <code>setText</code>。</p>
</li>
<li>
<p>跨平台架构：Ktor 处理标准平台，Module 桥接新兴平台（鸿蒙），游刃有余。</p>
</li>
</ol>
<p> </p>
<p>Kuikly 已经把“地基”打好了，剩下的就看你们如何在上面盖出万丈高楼了！今天的代码 Review 就到这里，还不快去 Clone 下来跑一跑？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【vue3】 + 【vite】 + 【rollup-plugin-obfuscator】混淆打包 => 打包报错]]></title>    <link>https://juejin.cn/post/7586509410567585833</link>    <guid>https://juejin.cn/post/7586509410567585833</guid>    <pubDate>2025-12-22T03:33:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586509410567585833" data-draft-id="7585751355593703443" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【vue3】 + 【vite】 + 【rollup-plugin-obfuscator】混淆打包 =&gt; 打包报错"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-12-22T03:33:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="梦想是准点下班"/> <meta itemprop="url" content="https://juejin.cn/user/2192851914196873"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【vue3】 + 【vite】 + 【rollup-plugin-obfuscator】混淆打包 =&gt; 打包报错
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2192851914196873/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    梦想是准点下班
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:33:26.000Z" title="Mon Dec 22 2025 03:33:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>rollup-plugin-obfuscator</code> 可以在基于 Vite 的 Vue 3 项目中使用，因为 Vite 本身就是基于 Rollup 构建的</p>
<p>npm install --save-dev rollup-plugin-obfuscator javascript-obfuscator</p>
<p>yarn add javascript-obfuscator -D</p>
<pre><code class="hljs language-js" lang="js">
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>
<span class="hljs-keyword">import</span> obfuscator <span class="hljs-keyword">from</span> <span class="hljs-string">'rollup-plugin-obfuscator'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-comment">// base: "",</span>
  <span class="hljs-attr">build</span>: {
    <span class="hljs-attr">minify</span>: <span class="hljs-string">'esbuild'</span>, <span class="hljs-comment">// 默认</span>
  },
  <span class="hljs-attr">esbuild</span>: {
    <span class="hljs-attr">drop</span>: [<span class="hljs-string">'console'</span>, <span class="hljs-string">'debugger'</span>],<span class="hljs-comment">//打包去除</span>
  },
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">vue</span>(),
    <span class="hljs-title function_">obfuscator</span>({
      <span class="hljs-attr">global</span>:<span class="hljs-literal">false</span>,
      <span class="hljs-comment">// options配置项实际为 javascript-obfuscator 选项，具体可查看https://github.com/javascript-obfuscator/javascript-obfuscator</span>
      <span class="hljs-attr">options</span>: {
        <span class="hljs-attr">compact</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">controlFlowFlattening</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">controlFlowFlatteningThreshold</span>: <span class="hljs-number">0.75</span>,
        <span class="hljs-attr">numbersToExpressions</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">simplify</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">stringArrayShuffle</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">splitStrings</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">splitStringsChunkLength</span>: <span class="hljs-number">10</span>,
        <span class="hljs-attr">rotateUnicodeArray</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">deadCodeInjection</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">deadCodeInjectionThreshold</span>: <span class="hljs-number">0.4</span>,
        <span class="hljs-attr">debugProtection</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">debugProtectionInterval</span>: <span class="hljs-number">2000</span>,
        <span class="hljs-attr">disableConsoleOutput</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">domainLock</span>: [],
        <span class="hljs-attr">identifierNamesGenerator</span>: <span class="hljs-string">"hexadecimal"</span>,
        <span class="hljs-attr">identifiersPrefix</span>: <span class="hljs-string">""</span>,
        <span class="hljs-attr">inputFileName</span>: <span class="hljs-string">""</span>,
        <span class="hljs-attr">log</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">renameGlobals</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">reservedNames</span>: [],
        <span class="hljs-attr">reservedStrings</span>: [],
        <span class="hljs-attr">seed</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">selfDefending</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">sourceMap</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">sourceMapBaseUrl</span>: <span class="hljs-string">""</span>,
        <span class="hljs-attr">sourceMapFileName</span>: <span class="hljs-string">""</span>,
        <span class="hljs-attr">sourceMapMode</span>: <span class="hljs-string">"separate"</span>,
        <span class="hljs-attr">stringArray</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">stringArrayEncoding</span>: [<span class="hljs-string">"base64"</span>],
        <span class="hljs-attr">stringArrayThreshold</span>: <span class="hljs-number">0.75</span>,
        <span class="hljs-attr">target</span>: <span class="hljs-string">"browser"</span>,
        <span class="hljs-attr">transformObjectKeys</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">unicodeEscapeSequence</span>: <span class="hljs-literal">true</span>,

        <span class="hljs-attr">domainLockRedirectUrl</span>: <span class="hljs-string">"about:blank"</span>,
        <span class="hljs-attr">forceTransformStrings</span>: [],
        <span class="hljs-attr">identifierNamesCache</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">identifiersDictionary</span>: [],
        <span class="hljs-attr">ignoreImports</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">optionsPreset</span>: <span class="hljs-string">"default"</span>,
        <span class="hljs-attr">renameProperties</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">renamePropertiesMode</span>: <span class="hljs-string">"safe"</span>,
        <span class="hljs-attr">sourceMapSourcesMode</span>: <span class="hljs-string">"sources-content"</span>,
       
        <span class="hljs-attr">stringArrayCallsTransform</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">stringArrayCallsTransformThreshold</span>: <span class="hljs-number">0.5</span>,
       
        <span class="hljs-attr">stringArrayIndexesType</span>: [<span class="hljs-string">"hexadecimal-number"</span>],
        <span class="hljs-attr">stringArrayIndexShift</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">stringArrayRotate</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">stringArrayWrappersCount</span>: <span class="hljs-number">1</span>,
        <span class="hljs-attr">stringArrayWrappersChainedCalls</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">stringArrayWrappersParametersMaxCount</span>: <span class="hljs-number">2</span>,
        <span class="hljs-attr">stringArrayWrappersType</span>: <span class="hljs-string">"variable"</span>,
      }
    })
  ]
})

</code></pre>
<p>打包报错……</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 自定义 View 实战：打造一个跟随滑动的丝滑指示器]]></title>    <link>https://juejin.cn/post/7585751355593834515</link>    <guid>https://juejin.cn/post/7585751355593834515</guid>    <pubDate>2025-12-22T03:33:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585751355593834515" data-draft-id="7586509410567536681" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 自定义 View 实战：打造一个跟随滑动的丝滑指示器 "/> <meta itemprop="keywords" content="Android,Kotlin"/> <meta itemprop="datePublished" content="2025-12-22T03:33:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="儿歌八万首"/> <meta itemprop="url" content="https://juejin.cn/user/3034307822894333"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 自定义 View 实战：打造一个跟随滑动的丝滑指示器 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3034307822894333/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    儿歌八万首
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:33:37.000Z" title="Mon Dec 22 2025 03:33:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Android 开发中，我们经常需要为 <code>RecyclerView</code>、<code>ViewPager</code> 或 <code>HorizontalScrollView</code> 添加一个可视化的滚动指示器。虽然系统自带的 ScrollBar 能满足基本需求，但如果 UI 设计要求指示器有固定的宽度、圆角以及特定的颜色，自定义 View 往往是最佳选择。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a0c083739fd4b53a2c868c8355b1731~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YS_5q2M5YWr5LiH6aaW:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979217&amp;x-signature=YBCuhfCI3YuEJoPIIuQwPwpfeV8%3D" alt="" loading="lazy"/></p>
<p>本文将带你使用 Kotlin 实现一个轻量级、高性能的水平滑动指示器组件 <code>BottomLineView</code>，并详细讲解如何适配主流的滚动控件。</p>
<h2 data-id="heading-0">1. 核心组件实现：BottomLineView</h2>
<p>我们创建一个继承自 <code>View</code> 的类 <code>BottomLineView</code>。它不依赖具体的滚动控件，只接收<strong>指示器宽度</strong>和<strong>滚动比例</strong>两个参数，实现了高度解耦。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BottomLineView</span> <span class="hljs-meta">@JvmOverloads</span> <span class="hljs-keyword">constructor</span>(
    context: Context,
    attrs: AttributeSet? = <span class="hljs-literal">null</span>,
    defStyleAttr: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
) : View(context, attrs, defStyleAttr) {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> paintGray: Paint  <span class="hljs-comment">// 背景线画笔</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> paintGreen: Paint <span class="hljs-comment">// 指示器画笔</span>
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> indicatorWidth = <span class="hljs-number">0f</span> <span class="hljs-comment">// 指示器的固定宽度</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> currentOffset = <span class="hljs-number">0f</span>  <span class="hljs-comment">// 当前偏移量</span>

    <span class="hljs-keyword">init</span> {
        initPaint()
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">initPaint</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 背景线：灰色，圆角</span>
        paintGray = Paint().apply {
            color = -<span class="hljs-number">0x333334</span> <span class="hljs-comment">// 0xFFCCCCCC</span>
            strokeCap = Paint.Cap.ROUND
            strokeWidth = <span class="hljs-number">10f</span>
            isAntiAlias = <span class="hljs-literal">true</span>
        }
        <span class="hljs-comment">// 指示器：绿色，圆角</span>
        paintGreen = Paint().apply {
            color = -<span class="hljs-number">0xff0100</span> <span class="hljs-comment">// 0xFF00FF00</span>
            strokeCap = Paint.Cap.ROUND
            strokeWidth = <span class="hljs-number">10f</span>
            isAntiAlias = <span class="hljs-literal">true</span>
        }
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDraw</span><span class="hljs-params">(canvas: <span class="hljs-type">Canvas</span>)</span></span> {
        <span class="hljs-keyword">super</span>.onDraw(canvas)
        <span class="hljs-keyword">val</span> centerY = height / <span class="hljs-number">2f</span>
        <span class="hljs-keyword">val</span> totalWidth = width.toFloat()

        <span class="hljs-comment">// 1. 绘制背景线</span>
        canvas.drawLine(<span class="hljs-number">0f</span>, centerY, totalWidth, centerY, paintGray)

        <span class="hljs-comment">// 2. 绘制指示器（确保不越界）</span>
        <span class="hljs-keyword">val</span> start = max(<span class="hljs-number">0f</span>, min(currentOffset, totalWidth - indicatorWidth))
        <span class="hljs-keyword">val</span> end = start + indicatorWidth

        <span class="hljs-keyword">if</span> (indicatorWidth &gt; <span class="hljs-number">0</span>) {
            canvas.drawLine(start, centerY, end, centerY, paintGreen)
        }
    }

    <span class="hljs-comment">/** 设置指示器物理宽度 */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setIndicatorWidth</span><span class="hljs-params">(width: <span class="hljs-type">Float</span>)</span></span> {
        <span class="hljs-keyword">this</span>.indicatorWidth = width
        invalidate()
    }

    <span class="hljs-comment">/** 更新滚动比例 (0.0 ~ 1.0) */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateScrollRatio</span><span class="hljs-params">(ratio: <span class="hljs-type">Float</span>)</span></span> {
        <span class="hljs-keyword">val</span> maxOffset = width - indicatorWidth
        <span class="hljs-keyword">this</span>.currentOffset = maxOffset * ratio
        invalidate()
    }
}
</code></pre>
<h2 data-id="heading-1">2. 场景适配指南</h2>
<p>下面是三种最常见的滚动控件适配方案。</p>
<h3 data-id="heading-2">场景一：与 RecyclerView 联动</h3>
<p>这是最常用的场景。利用 <code>computeHorizontalScrollXXX</code> 系列方法可以精确计算滚动位置。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 设置指示器宽度</span>
bottomLineView.setIndicatorWidth(<span class="hljs-number">100f</span>)

<span class="hljs-comment">// 2. 监听滚动</span>
recyclerView.addOnScrollListener(<span class="hljs-keyword">object</span> : RecyclerView.OnScrollListener() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onScrolled</span><span class="hljs-params">(recyclerView: <span class="hljs-type">RecyclerView</span>, dx: <span class="hljs-type">Int</span>, dy: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-comment">// 获取滚动参数</span>
        <span class="hljs-keyword">val</span> offset = recyclerView.computeHorizontalScrollOffset() <span class="hljs-comment">// 当前偏移</span>
        <span class="hljs-keyword">val</span> range = recyclerView.computeHorizontalScrollRange()   <span class="hljs-comment">// 内容总宽</span>
        <span class="hljs-keyword">val</span> extent = recyclerView.computeHorizontalScrollExtent() <span class="hljs-comment">// 可见宽度</span>
        
        <span class="hljs-comment">// 计算最大可滚动距离</span>
        <span class="hljs-keyword">val</span> maxScroll = range - extent
        
        <span class="hljs-keyword">if</span> (maxScroll &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">val</span> ratio = offset.toFloat() / maxScroll
            bottomLineView.updateScrollRatio(ratio)
        }
    }
})
</code></pre>
<h3 data-id="heading-3">场景二：与 HorizontalScrollView 联动</h3>
<p><code>HorizontalScrollView</code> 需要 API 23 (Android 6.0) 以上才能通过 <code>setOnScrollChangeListener</code> 监听。如果是低版本，可能需要继承并重写 <code>onScrollChanged</code>。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">horizontalScrollView.setOnScrollChangeListener { _, scrollX, _, _, _ -&gt;
    <span class="hljs-comment">// 1. 获取子 View (内容)</span>
    <span class="hljs-keyword">val</span> contentView = horizontalScrollView.getChildAt(<span class="hljs-number">0</span>) ?: <span class="hljs-keyword">return</span><span class="hljs-symbol">@setOnScrollChangeListener</span>
    
    <span class="hljs-comment">// 2. 计算最大可滚动距离 = 内容宽度 - 容器宽度</span>
    <span class="hljs-keyword">val</span> maxScroll = contentView.width - horizontalScrollView.width
    
    <span class="hljs-keyword">if</span> (maxScroll &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">val</span> ratio = scrollX.toFloat() / maxScroll
        bottomLineView.updateScrollRatio(ratio)
    }
}
</code></pre>
<h3 data-id="heading-4">场景三：与 ViewPager2 联动</h3>
<p><code>ViewPager2</code> 的计算逻辑略有不同，因为它是按“页”滚动的。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">viewPager2.registerOnPageChangeCallback(<span class="hljs-keyword">object</span> : ViewPager2.OnPageChangeCallback() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onPageScrolled</span><span class="hljs-params">(position: <span class="hljs-type">Int</span>, positionOffset: <span class="hljs-type">Float</span>, positionOffsetPixels: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">super</span>.onPageScrolled(position, positionOffset, positionOffsetPixels)
        
        <span class="hljs-comment">// 假设 Adapter 中有 itemCount</span>
        <span class="hljs-keyword">val</span> itemCount = adapter.itemCount
        
        <span class="hljs-keyword">if</span> (itemCount &gt; <span class="hljs-number">1</span>) {
            <span class="hljs-comment">// 计算总进度</span>
            <span class="hljs-comment">// 当前页索引 + 当前页偏移百分比</span>
            <span class="hljs-keyword">val</span> currentProgress = position + positionOffset
            
            <span class="hljs-comment">// 总的可移动页数 = 总页数 - 1</span>
            <span class="hljs-keyword">val</span> totalProgress = (itemCount - <span class="hljs-number">1</span>).toFloat()
            
            <span class="hljs-keyword">val</span> ratio = currentProgress / totalProgress
            bottomLineView.updateScrollRatio(ratio)
        }
    }
})
</code></pre>
<h2 data-id="heading-5">3. 总结</h2>
<p>通过将 UI 绘制逻辑封装在 <code>BottomLineView</code> 内部，并将状态更新抽象为 <code>updateScrollRatio(0.0~1.0)</code> 接口，我们成功地让这个指示器适配了 Android 所有的水平滚动组件。无论底层是用 RecyclerView 还是 ViewPager，UI 层的表现都一样丝滑流畅。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[VS code为python文件配置默认模板]]></title>    <link>https://juejin.cn/post/7585948869844942883</link>    <guid>https://juejin.cn/post/7585948869844942883</guid>    <pubDate>2025-12-22T02:53:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585948869844942883" data-draft-id="7585929179319533603" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VS code为python文件配置默认模板"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-22T02:53:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="波克布林的矩阵633"/> <meta itemprop="url" content="https://juejin.cn/user/3762989890536400"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VS code为python文件配置默认模板
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3762989890536400/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    波克布林的矩阵633
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:53:23.000Z" title="Mon Dec 22 2025 02:53:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>有些大体积的IDE会有自带头部信息的功能，</p>
<p>刚开始学python的我，使用的是VSCode，没有发现有插件可以完成（似乎有C的）</p>
<p>但是也可以通过在VSCode中自定义User Snippets(用户代码段)来实现类似的功能</p>
<h2 data-id="heading-0">1 配置方法</h2>
<p>打开VScode——File——Preference——Configure Snippets
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f2d92ceb8a6435b9dd84cc4f77bf2c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rOi5YWL5biD5p6X55qE55-p6Zi1NjMz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976802&amp;x-signature=XYmZnjFJKx0isumHyGDpw%2Bmk3JE%3D" alt="image.png" loading="lazy"/></p>
<p>我之前已经配置过了，未配置过，这里需要找到python.json</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1dd0878e44fc491a8e61fdedc1bb73b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rOi5YWL5biD5p6X55qE55-p6Zi1NjMz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976802&amp;x-signature=FcmdhwUF3JzIp9fMKHboYIQbOvs%3D" alt="image.png" loading="lazy"/></p>
<p>在弹出的python.json文件中注释掉原来的，加入以下自定义的代码段，保存退出</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"HEADER"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"prefix"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"header"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"body"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-comment">// "#!/usr/bin/env python",</span>
        <span class="hljs-string">"# -*- encoding: utf-8 -*-"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"'''"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"@File    :   $TM_FILENAME"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"@Time    :   $CURRENT_YEAR/$CURRENT_MONTH/$CURRENT_DATE $CURRENT_HOUR:$CURRENT_MINUTE:$CURRENT_SECOND"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"@Author  :   Jiahao Chen "</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"@Version :   1.0"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"@Contact :  244671870@qq.com"</span><span class="hljs-punctuation">,</span>
        
        <span class="hljs-string">"'''"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"# here put the import lib"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"$0"</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">}</span>
    
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-1">2 使用方法</h2>
<p>在文档中输入header就可以头部注释 了</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2c8cd94bfb746dc8b71ea37d329e416~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rOi5YWL5biD5p6X55qE55-p6Zi1NjMz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976802&amp;x-signature=ElC8Z9giBx0a1RRKUwdRJqTXov4%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbb93c72046d4b6daa6235d938b0b922~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rOi5YWL5biD5p6X55qE55-p6Zi1NjMz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976802&amp;x-signature=qceDbXx7ZOHvoBlE6lQ2Xkzt83g%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter UI 设计库解耦重构进度，官方解答未来如何适配]]></title>    <link>https://juejin.cn/post/7585751355593850899</link>    <guid>https://juejin.cn/post/7585751355593850899</guid>    <pubDate>2025-12-22T03:34:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585751355593850899" data-draft-id="7585969437032267818" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter UI 设计库解耦重构进度，官方解答未来如何适配"/> <meta itemprop="keywords" content="前端,Flutter,Android"/> <meta itemprop="datePublished" content="2025-12-22T03:34:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="恋猫de小郭"/> <meta itemprop="url" content="https://juejin.cn/user/817692379985752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter UI 设计库解耦重构进度，官方解答未来如何适配
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/817692379985752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    恋猫de小郭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:34:11.000Z" title="Mon Dec 22 2025 03:34:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在目前的 Flutter 架构中，Material（Android ）和 Cupertino（iOS）的 UI 库是与核心框架捆绑在一起的，也就是常见的 "batteries included" 原则，为的是方便开发者开箱即用，但是也导致了 Widgets、Material 和 Cupertino 这三个 lib 紧密耦合。</p>
<p>而今年提出的 decoupling design 重构，就是<strong>计划将这两个设计库从核心框架中解耦，并调整到独立的 Pub 包</strong>，也就是核心框架将只包含基础的 <code>Widgets</code> 库，而特定的设计风格将变为可选的插件 ：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7f08af96f354221ab52520890f27380~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=r95H8TJV7oMzVG70mcSaJ8gnn8M%3D" alt="" loading="lazy"/></p>
<p>之所以会有这个调整，最主要还是因为在最新的 Material 3 Expressive 和 Liquid Glass 风格发布之后，UI 在 Framework 层的适配成本变高，并且 <strong>Framework 的更新节奏也无法很好适应这种 UI 风格调整</strong>，所以在社区的呼声下，官方正式开始了 decoupling design 计划。</p>
<p>实际上在之前，很多基础组件对特定设计库有不必要的依赖，你以为框架的代码结构是下图 A ，但是在多年维护后，目前已经是下图 B 的情况：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/369d602fb81d4fe1b65e446997de2572~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=6qAsbJsdiaILfSsykRKpbhEQOnQ%3D" alt="" loading="lazy"/></p>
<p>另外，类似 <code>SelectionArea</code> 组件，它看起来是一个纯 Widget 的基础组件，但为了实现跨平台适配，底层却必须依赖 Material 和 Cupertino 库 ，如果没有，你就会发现：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5259133efa5c48faa624e75b8dc5dfa5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=npmC5nlW3N6ZY9HEKsRLclLt73Q%3D" alt="" loading="lazy"/></p>
<p>因为在之前的 "batteries included" 原则，实际上控件内部会根据使用的风格或者运行的平台，主动为用户采用对应的主题风格，这样的话好处肯定是开箱即用，但是实际上用户很多时候并不理解这一点，并且最重要的是：</p>
<blockquote>
<p><strong>由于设计库与框架发布周期绑定，新设计的跟进趋势会让适应速度变慢很多，同时紧密的耦合也让 PR 变得复杂，每次调整风险更高，容易引发回归错误</strong> 。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b2278e0a4c947a0a189036864f45187~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=4lT3LjEFHBWBGzGN194n4Ek8ni0%3D" alt="" loading="lazy"/></p>
<p>另外，现阶段开发者如果想构建非 Material/Cupertino 的自定义设计系统，往往不得不从头开始，因为现有的基础组件的定制功能开发不足 ，所以 decoupling design 作为现阶段必须经历的产物，最终提上了日程。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f849dc87fb8b4a838b4bb5509b028c2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=YaEXHekZKeZOlUgDuC8Ed3zKvuY%3D" alt="" loading="lazy"/></p>
<p>当然，实际上解耦和重构设计库是一个非常大的底层调整，其中核心主要涉及了四个领域：</p>
<ul>
<li><strong>System UI</strong> ：需要重新界定设计库与平台之间的界限（例如文本选择、页面过渡） ，这个是最大的成本之一</li>
<li><strong>代码组织</strong> ：在基础 <code>Widgets</code> 库中创建更多的“原始组件抽象” (raw widget abstractions)，类似现在的 <code>RawRadio</code><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e79ad1ea8cf4bda87832255ae530e84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=OKahAaQVVHvPFPi6LwM6n9oIfZc%3D" alt="" loading="lazy"/></li>
<li><strong>主题</strong>：评估并改进主题系统，解决 Material 和 Cupertino 主题缺乏共同 BASE 的问题 ，因为之前 Widgets 完全没有主题体系，所以需要考虑是否引入更通用的 theme abstraction</li>
<li><strong>基础设施适配</strong>：迁移超过 200 个测试，并将相关的 CI 流程从主仓库迁移出去 ，避免交叉导入，建立独立的 CI 流程，让 PR 更便捷过审</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2dc792c8a50d4f9a90e6478487e2e0e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=nq3LVhvrxJxQD%2BAOWsZUX%2BQw2eU%3D" alt="" loading="lazy"/></p>
<p>而对于解耦完成的是假变，整个项目分三个阶段进行：</p>
<ul>
<li>
<p><strong>阶段一 (2025年12月)</strong> ：</p>
<ul>
<li>基础调整，将 Material/Cupertino 中的通用核心逻辑下沉移动到 <code>widgets</code> 库</li>
<li>搭建 Flutter packages 仓库的基础支持</li>
</ul>
</li>
<li>
<p><strong>阶段二 2026年</strong> ：</p>
<ul>
<li>正式解耦，将代码移至新的包中并发布到 Pub</li>
<li>在主框架中标记旧库为“已弃用” (deprecated)</li>
</ul>
</li>
<li>
<p><strong>阶段三 - 2026年晚些时候</strong> ：</p>
<ul>
<li>从核心框架中彻底移除已弃用的 Material 和 Cupertino 库</li>
</ul>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb4eda73d66a4a6a84a4bb3385cb4e2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=eYX2ZyzSg4ENvbGcvoTvAC9HAWw%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>也就是，2026 年我们就可以拥有全新的 Material 3 Expressive 和 Liquid Glass 风格支持，并且是可选 package</p>
</blockquote>
<p>当然，对开发者的影响的使用肯定有影响，这个影响有好有坏：</p>
<ul>
<li><strong>版本管理更灵活</strong>：解耦后，Material 和 Cupertino 将遵循语义化版本控制，开发者可以锁定特定版本，独立于 Flutter 框架的升级节奏 ，更加方便灵活，<strong>不必跟着 Flutter 升级 UI 设计</strong></li>
<li><strong>更容易构建自定义设计</strong>：通过使用底层的“原始组件” (raw widgets，如 <code>RawRadio</code>)，构建完全自定义的 UI 系统将变得更加容易，不再被迫基于 Material 组件修改</li>
<li><strong>破坏性变更 (Breaking Changes)</strong> ：虽然未来会提供快速修复工具 (quick fixes)，但解耦过程不可避免地会带来一些破坏性变更 ，这些是是需要开发者自己适配</li>
<li><strong>设计库更新暂停</strong>：为了减少迁移难度，在解耦完成前， Flutter 会将暂停引入新的重大设计更新（如 Material 3 Expressive 或 Liquid Glass） ，所以这个需要开发耐心等待</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3fa99b8f6d842f2acfc7786def5d092~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=P7KXXLTGu4fKwzFHOl8%2BkEvYgfs%3D" alt="" loading="lazy"/></p>
<p>当然，解耦之后，<strong>Framework 的 UI break change 会越来越少，而开发者也可以选择自己的 style package 进行 lock</strong> ，整体灵活性和可用度会更好。</p>
<p>不过，对于 Plugin开发者来说，可能会有更高的适配成本，<strong>因为需要考虑 UI 实现里使用的是哪个 version 的 style package ，也需要考虑会不会给用户带来版本冲突等</strong>，在这方面也许未来会出现类似 RN 的：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff1a70cf4a9347aba175551957b971b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=NLTo0F37w3rKBu1LOuWLfBf4LxI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">最后</h2>
<p>这次重构虽然是一项巨大的工程，但长远来看会让 Flutter 框架更耐用，也让设计库的迭代更迅速，并更好地支持第三方设计生态系统的发展 ，甚至未来 PC 平台的第三方 UI 风格也可以更好适配，这也引出另一个问题：</p>
<blockquote>
<p>Compose Multiplatform 是否也有类似问题，是否也会跟进？毕竟 CMP 也是以 Material 为主，不过目前看来 Compose 先天具备分层风格 function ，更倾向于平台层 UI 自己独立实现，实际上问题会小很多。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从"人工催办"到"AI 规则驱动"：我们如何解放测试团队的生产力]]></title>    <link>https://juejin.cn/post/7585969437032349738</link>    <guid>https://juejin.cn/post/7585969437032349738</guid>    <pubDate>2025-12-22T03:41:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585969437032349738" data-draft-id="7586509410567553065" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从&quot;人工催办&quot;到&quot;AI 规则驱动&quot;：我们如何解放测试团队的生产力"/> <meta itemprop="keywords" content="测试"/> <meta itemprop="datePublished" content="2025-12-22T03:41:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="转转技术团队"/> <meta itemprop="url" content="https://juejin.cn/user/606586148237431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从"人工催办"到"AI 规则驱动"：我们如何解放测试团队的生产力
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/606586148237431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    转转技术团队
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:41:41.000Z" title="Mon Dec 22 2025 03:41:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从"人工催办"到"AI 规则驱动"：我们如何解放测试团队的生产力</h2>
<p>很多测试同学除了本职工作，还承担着中小型项目的管理工作，却因此成了项目中的“人工待办清单”。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2145343fb245464ba1034dd25ab8b93e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979817&amp;x-signature=qVZD5C37p6hR1n2WA4DowsSn75Q%3D" alt="" loading="lazy"/></p>
<p>“人工待办”依赖记忆的流程节点去推动事情，我们发现：测试团队真正该做的测试工作（深度测试、质量分析、风险挖掘），正被流程管理悄悄偷走。</p>
<p>于是，我们打造了这个<strong>超轻量的项目管理工具</strong>，让规则在项目群“主动说话”，将“<strong>何时、谁、做什么</strong>”标准化，由程序收集信息、提醒推进。</p>
<h3 data-id="heading-1">Part 1. 从“混乱的记忆经验”到“动态的客观规则”</h3>
<p>认识到“依赖人工待办”的痛点只是第一步。核心挑战是：<strong>项目管理本身既有定式又有变化</strong>。</p>
<ul>
<li>3 人 3 天的紧急需求，与跨端日常迭代的管理差异？</li>
<li>内部协作项目，与外部频繁对接项目的节点区别？</li>
</ul>
<p>过去，全凭测试负责人的“个人经验”处理，可能出现的结果：</p>
<ul>
<li>小型项目被<strong>过度管理</strong>，徒增负担；</li>
<li>大型项目又<strong>管理不足</strong>，漏洞百出。</li>
</ul>
<p>我们意识到，项目管理规则不是统一模板，而是能应对不同“项目参数”的<strong>动态规则系统</strong>。</p>
<p>搭建这套系统，需围绕项目管理时的具体问题展开：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/098dd0bfb3844bf89047eb127571b589~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979817&amp;x-signature=9bqubVZxQfwUiRyRtG69YItsnXo%3D" alt="" loading="lazy"/></p>
<p>据此，我们得出三个解题方向。</p>
<h4 data-id="heading-2">1、按项目规模 控制管理粒度</h4>

























<table><thead><tr><th>项目类型</th><th>管理策略</th><th>关键动作</th></tr></thead><tbody><tr><td><strong>小型需求</strong></td><td>功能独立，迭代要“快”</td><td>只保留确保质量底线的关键检查点</td></tr><tr><td><strong>中型迭代</strong></td><td>保证速度 + 强调“稳”</td><td>加入技术评审、联调日会等节点，确保信息同步和风险前置</td></tr><tr><td><strong>大型项目</strong></td><td>在中型基础上强调“可控”与“对齐”</td><td>增加每日站会、细化联调计划等</td></tr></tbody></table>
<h4 data-id="heading-3">2、 按项目类型 区分差异节点</h4>
<ul>
<li><strong>含客户端项目</strong>：增加集测、上线前物料检查、发版等节点</li>
<li><strong>涉外部门项目</strong>：增加需求串讲、技术方案串讲、测试边界拉齐等节点</li>
</ul>
<h4 data-id="heading-4">3、 四个维度定规则 清晰可落地</h4>






























<table><thead><tr><th>维度</th><th>定义</th><th>示例（测试期每日站会）</th></tr></thead><tbody><tr><td><strong>谁</strong></td><td>负责人</td><td>测试负责人</td></tr><tr><td><strong>什么时间</strong></td><td>触发条件</td><td>测试期间</td></tr><tr><td><strong>干什么事(以什么标准)</strong></td><td>具体动作</td><td>固定时间组织站会<br/>会上发言模板：昨日、今日、风险依赖<br/>站会控制时间</td></tr><tr><td><strong>交付什么结果</strong></td><td>产出内容</td><td>群内发送站会记录</td></tr></tbody></table>
<blockquote>
<p><strong>产出结果举例：站会记录要求</strong></p>
<ul>
<li>清晰阐明整体进度是否正常，风险情况（高、中、低、无）</li>
<li>若不正常，阐明原因和应对解决方案</li>
<li>Todo 事项需包含：事项内容、跟进人、解决时间</li>
</ul>
</blockquote>
<p>我们推出一份详尽的项目管理规范，但<strong>落地不尽人意</strong>。<br/>
比如这份“差点意思”的站会记录：</p>
<blockquote>
<p><strong>会议内容</strong></p>
<ul>
<li>测试 A：昨天测首页，好多 bug，图片加载慢、按钮点不动，环境也卡。</li>
<li>测试 B：支付模块测一半，开发改了代码没说，之前的测试白做了，今天再重新测。</li>
<li>开发 C(临时参会)：A 说的按钮问题不是我写的，没法修，环境卡是运维的事。</li>
<li>待办 1：首页图片加载慢、按钮异常、环境卡顿</li>
<li>待办 2：支付模块需重新测试</li>
</ul>
</blockquote>
<p>深刻体会到：<strong>最难的从来不是“制定规则”，而是“让规则执行”</strong></p>
<p>![](&lt;<a href="https://link.juejin.cn?target=https%3A%2F%2Fpic4.zhuanstatic.com%2Fzhuanzh%2Fd7317dfb-0708-4c7a-accb-3f4d019e3f11.png%23pic_center%3D128x128" target="_blank" title="https://pic4.zhuanstatic.com/zhuanzh/d7317dfb-0708-4c7a-accb-3f4d019e3f11.png#pic_center=128x128" ref="nofollow noopener noreferrer">pic4.zhuanstatic.com/zhuanzh/d73…</a>)</p>
<h3 data-id="heading-5">Part 2. 如何让规则拥有“执行力”？</h3>
<h4 data-id="heading-6">1、思考：为何落地难？</h4>
<p>我们意识到执行问题可能出在三个“人性弱点”与规则的冲突：</p>
<ul>
<li><strong>记忆负担</strong>：流程节点多，易遗漏</li>
<li><strong>执行成本</strong>：写纪要等需额外思考格式，较麻烦</li>
<li><strong>缺失监督</strong>：无实时客观检查，全靠自觉</li>
</ul>
<p><strong>我们意识到：</strong><br/>
静态文档难以落地，规则必须进化为一个<strong>动态的、能够主动驱动行为的工具</strong>。</p>
<p>核心问题随之而来：<strong>什么样的工具，才能真正具备驱动团队遵守规则的“力”？</strong></p>
<p>![](<a href="https://link.juejin.cn?target=https%3A%2F%2Fpic6.zhuanstatic.com%2Fzhuanzh%2Fb48a93f0-b6e0-40db-b6bf-e0c2d54e4ad5.png%23pic_center" target="_blank" title="https://pic6.zhuanstatic.com/zhuanzh/b48a93f0-b6e0-40db-b6bf-e0c2d54e4ad5.png#pic_center" ref="nofollow noopener noreferrer">pic6.zhuanstatic.com/zhuanzh/b48…</a> =128x128)</p>
<h4 data-id="heading-7">2、 改变：融入而非对抗，赋能而非监控</h4>
<p>核心思路：<strong>必须深度融入大家已经形成习惯的、最自然、最高频的协作场景里</strong>。</p>
<p>在我们团队，这个场景就是 <strong>“项目群”</strong>。几乎所有的项目协作都发生在这里：</p>
<ul>
<li><strong>信息中枢</strong>：需求文档、技术方案、测试用例、项目排期等核心资产，都以群公告的形式沉淀</li>
<li><strong>协作广场</strong>：评审邀约、进度同步、问题讨论、决策拍板，所有沟通都在群聊中实时发生</li>
</ul>
<p>破局路径由此明确：
<strong>以“项目群”为基础，将规则引擎悄无声息地编织进去</strong>。<br/>
我们不再要求大家“看文档”，而是让规则在群里“<strong>主动说话</strong>”、“<strong>主动办事</strong>”。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ebcc6ac1ff674559a8aa4ca9e7609bcd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979817&amp;x-signature=Js82m6uRTbng60AGKDlGUwQp6MY%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-8">1. 低成本：简单智能交互</h5>
<p>关键信息发送至群内周知时，仅需增加 <strong>@项目管理助手</strong></p>
<ul>
<li>系统<strong>自动识别意图，存储</strong>至项目管理表格</li>
<li><strong>将接入和信息同步成本降到最低</strong></li>
</ul>
<h5 data-id="heading-9">2. 节点推送：变“人找事”为“事找人”</h5>
<p>规则引擎按项目排期自动推送信息：</p>
<ul>
<li><strong>事前提醒</strong>：<br/>
“下个工作日就要进入测试啦，辛苦测试负责人 @xx 申请测试环境，同步至群内并 @项目管理机器人”</li>
<li><strong>过程赋能</strong>：<br/>
“xxx 环境所部署分支覆盖率不足，请测试负责人 @xx 关注”</li>
<li><strong>结果校验</strong>：<br/>
“会议纪要内容风险为高，但无原因和对应解决措施”<br/>
“项目已上线，但存在未关闭缺陷，请及时关注”</li>
</ul>
<h3 data-id="heading-10">Part 3. 我们是如何实现落地的？</h3>
<h4 data-id="heading-11">三层框架</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23d3b1cc65d549358a5bfe0ffddf2be3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979817&amp;x-signature=l2EzqWj8ln88dRoGchMsI4VH96Y%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-12">1. 交互层：企微群机器人</h5>
<ul>
<li><strong>智能机器人</strong>：接收群内消息，理解用户意图</li>
<li><strong>普通机器人</strong>：负责定时消息推送</li>
</ul>
<h5 data-id="heading-13">2. 中间层：转换层</h5>
<ul>
<li>将智能机器人接收到的消息传递给 Coze</li>
<li>封装代码逻辑供 Coze 调用，实现群推送等功能</li>
</ul>
<h5 data-id="heading-14">3. 执行层：基于 Coze 搭建的自动化流程</h5>
<ul>
<li>
<p><strong>接收用户消息</strong></p>
<ul>
<li>使用大模型识别意图、提取关键信息</li>
<li>评估输入是否符合要求</li>
<li>更新至项目管理表格</li>
</ul>
</li>
<li>
<p><strong>定时推送</strong></p>
<ul>
<li>设置触发器定时执行</li>
<li>根据项目管理表 + 当前日期 → 判断节点 → 推送信息</li>
</ul>
</li>
<li>
<p><strong>通用能力</strong></p>
<ul>
<li>覆盖率获取、静态扫描结果获取等</li>
</ul>
</li>
<li>
<p><strong>自定义 Coze 插件</strong></p>
<ul>
<li>飞书官方插件不能实现期望功能 → 开发飞书插件并上架商店（复制工作表、Sheet 页、追加数据）
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/504f77c97b4240319dbb883329ab7479~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979817&amp;x-signature=%2FmctEiEdl%2BsvjisjZFKMfFBIm0U%3D" alt="" loading="lazy"/></li>
</ul>
</li>
</ul>
<h4 data-id="heading-15">简单架构图</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7ec97a6f51c4db0ba6daf403b69ff14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979817&amp;x-signature=M9Lhyb6TXyKDlZLfyDSl8fHUHBE%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-16">核心数据表格</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25bf6d8d47984c5397d884456a28f517~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979817&amp;x-signature=hTuGVvlI8JpBFiWcjtYCtptmw7I%3D" alt="" loading="lazy"/></p>

















<table><thead><tr><th>表名</th><th>作用</th></tr></thead><tbody><tr><td><strong>项目总览表</strong></td><td>接入表，记录项目关键信息：<br/>群聊 ID、项目名称、项目管理表格（自动创建）、TAPD 地址、群消息机器人</td></tr><tr><td><strong>项目管理表</strong></td><td>基于 PART1 沉淀的规则，记录项目关键节点与状态</td></tr></tbody></table>
<h4 data-id="heading-17">具体功能说明</h4>
<ol>
<li><strong>自动接入</strong>：基于群内标准化输入，自动写入总览表</li>
<li><strong>自动更新</strong>：用户主动推送信息 → 自动更新项目管理表，无需额外维护</li>
<li><strong>定时提醒</strong>：需执行动作/关注内容 → 自动 @ 具体人员</li>
<li><strong>工具赋能</strong>：联动 TAPD、公司平台，通过接口获取节点信息 → Coze 处理 → 推送</li>
<li><strong>自动闭环</strong>：上线后持续跟进 TAPD 状态和 Bug 情况 → 全部处理后 → 自动标记为“已上线”</li>
</ol>
<h4 data-id="heading-18">落地效果示例</h4>
<blockquote>
<hr/>
<ul>
<li>✅ 输入信息自动接入
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e26c7aada0d64214b79f9b30d5a2dc01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979817&amp;x-signature=i47%2BnfkXRfHI2kpPt99BMzuM0QE%3D" alt="" loading="lazy"/></li>
</ul>
<hr/>
<ul>
<li>✅ 测试进度上报校验 + Bug 情况总结
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7376f7d936c4871982db4f5e2081bde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979817&amp;x-signature=MpNZqiiWWf6evi9J4vUPUAVzDZE%3D" alt="" loading="lazy"/></li>
</ul>
<hr/>
<ul>
<li>✅ 分支覆盖率结果推送
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac203d2a79d042919b29f06f51ce6a37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979817&amp;x-signature=oY5E6q2oA0TJNI%2FuMXon6OyxEpo%3D" alt="" loading="lazy"/></li>
</ul>
<hr/>
<ul>
<li>✅ 提前一天事项提醒｜静态扫描结果提醒
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0106c915d8443369f8b58a589b3af94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979817&amp;x-signature=P6eA4HBUm4xBx%2BJVuzGqpWhFROw%3D" alt="" loading="lazy"/></li>
</ul>
<hr/>
</blockquote>
<h4 data-id="heading-19">大家可能有的小疑问</h4>
<blockquote>
<p><strong>Q：为什么要用 2 个机器人？</strong><br/>
A：受企业微信限制，智能机器人只能被动响应用户主动 @ 的消息，无法主动推送。普通机器人用于定时任务。</p>
<p><strong>Q：为什么不用企业微信文档？</strong><br/>
A：企微文档能力受限，且与 Coze 集成弱；而<strong>飞书 + Coze 集成成熟</strong>，可自行开发插件，灵活度高。</p>
</blockquote>
<hr/>
<h4 data-id="heading-20">相关资料合集</h4>
<blockquote>
<ul>
<li>
<p>企微智能机器人：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.work.weixin.qq.com%2Fdocument%2Fpath%2F100719" target="_blank" title="https://developer.work.weixin.qq.com/document/path/100719" ref="nofollow noopener noreferrer">developer.work.weixin.qq.com/document/pa…</a></p>
</li>
<li>
<p>企微普通群机器人：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.work.weixin.qq.com%2Fdocument%2Fpath%2F99110" target="_blank" title="https://developer.work.weixin.qq.com/document/path/99110" ref="nofollow noopener noreferrer">developer.work.weixin.qq.com/document/pa…</a></p>
</li>
<li>
<p>飞书电子表格 API：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.feishu.cn%2Fdocument%2Fserver-docs%2Fdocs%2Fsheets-v3%2Foverview" target="_blank" title="https://open.feishu.cn/document/server-docs/docs/sheets-v3/overview" ref="nofollow noopener noreferrer">open.feishu.cn/document/se…</a></p>
</li>
<li>
<p>Coze 基于 API 创建插件：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.coze.cn%2Fopen%2Fdocs%2Fguides%2Fservices" target="_blank" title="https://www.coze.cn/open/docs/guides/services" ref="nofollow noopener noreferrer">www.coze.cn/open/docs/g…</a></p>
</li>
</ul>
</blockquote>
<h4 data-id="heading-21">应用效果</h4>
<h5 data-id="heading-22">实际反馈：</h5>
<blockquote>
<ul>
<li>“事项并行时，会忘记一些节点。接入后，到关键节点自动提醒，不会忘啦！”</li>
<li>“Bug 情况的推送很给力，之前总有人不及时解决，需要一直催。现在每天推送后，解决进度都变快了。”</li>
<li>“各分支的覆盖率是否达标一目了然，再也不用一个个检查了。”</li>
</ul>
</blockquote>
<h5 data-id="heading-23">团队建议：</h5>
<blockquote>
<ul>
<li>对未完成的 Todo 列表进行提醒</li>
<li>根据上线计划，Check 是否执行到位（如定时任务是否配置并开启）</li>
<li>通过冒烟任务执行情况校验联调进度是否正常</li>
</ul>
</blockquote>
<h3 data-id="heading-24">写在最后</h3>
<p>这个工具把我们过去<strong>靠人脑记忆、靠人工催促的规则，交给了程序</strong>。带来切实改变：：</p>
<blockquote>
<ul>
<li>不再费心记忆每个时间节点该做什么</li>
<li>不用自己一个个查覆盖率、人工汇总 Bug</li>
<li>产出内容是否合理，不用组长盯，工具会自动告诉你问题在哪</li>
</ul>
<p><strong>最重要的是：测试团队终于能把主要精力，逐步放回测试本身</strong>。</p>
</blockquote>
<p>我们仍在起步阶段，后续将赋能更多流程节点。让项目过程管理越来越轻松。</p>
<p>如果你也受困于“人工待办”，或也想用 Coze 做一些工具赋能，欢迎一起交流！</p>
<p><code>&gt; 转转研发中心及业界小伙伴们的技术学习交流平台，定期分享一线的实战经验及业界前沿的技术话题。</code></p>
<p><code>&gt; 关注公众号「转转技术」（综合性）、「大转转FE」（专注于FE）、「转转QA」（专注于QA），更多干货实践，欢迎交流分享~</code></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[流式计算框架简单综述-第一篇]]></title>    <link>https://juejin.cn/post/7586136543954747430</link>    <guid>https://juejin.cn/post/7586136543954747430</guid>    <pubDate>2025-12-22T03:43:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586136543954747430" data-draft-id="7585920796100509723" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="流式计算框架简单综述-第一篇"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-12-22T03:43:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="自由生长2024"/> <meta itemprop="url" content="https://juejin.cn/user/1591748569862670"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            流式计算框架简单综述-第一篇
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1591748569862670/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    自由生长2024
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:43:21.000Z" title="Mon Dec 22 2025 03:43:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">摘要</h2>
<p>本文深入剖析流式计算原理、流批一体架构、Lambda与Kappa架构优劣，并结合实际场景，全面阐述实时数据处理的技术演进与工程实践。</p>
<h2 data-id="heading-1">引言</h2>
<h3 data-id="heading-2">流式计算的背景和场景</h3>
<p>在日常生活中，我们通常会先把数据存储在一张表中，然后再进行加工、分析，这里就涉及到一个时效性的问题。如果我们处理以年、月为单位的级别的数据，那么多数据的实时性要求并不高；但如果我们处理的是以天、小时，甚至分钟为单位的数据，那么对数据的时效性要求就比较高。在第二种场景下，如果我们仍旧采用传统的数据处理方式，统一收集数据，存储到数据库中，之后在进行分析，就可能无法满足时效性的要求。</p>
<p>通过大数据处理我们获取了数据的价值，但是数据的价值显然不是恒定不变的。一些数据在事情发生后不久就有了更高的价值，而且这种价值会随着时间的推移而迅速减少。流处理的关键优势在于它能够更快地提供洞察力，通常在毫秒到秒之间。</p>
<p>流式处理可以用于两种不同场景： 事件流和持续计算。</p>
<p>1、事件流</p>
<p>事件流能够持续产生大量的数据，这类数据最早出现与传统的银行和股票交易领域，也在互联网监控、无线通信网等领域出现、<strong>需要以近实时的方式对更新数据流进行复杂分析如趋势分析、预测、监控等</strong>。简单来说，事件流采用的是查询保持静态，语句是固定的，数据不断变化的方式。</p>
<p>2、持续计算</p>
<p>比如对于大型网站的流式数据：网站的访问PV/UV、用户访问了什么内容、搜索了什么内容等，实时的数据计算和分析可以动态实时地刷新用户访问数据，展示网站实时流量的变化情况，<strong>分析每天各小时的流量和用户分布情况</strong>；</p>
<p><strong>比如金融行业，毫秒级延迟的需求至关重要</strong>。一些需要实时处理数据的场景也可以应用Storm，比如根据用户行为产生的日志文件进行实时分析，<strong>对用户进行商品的实时推荐等</strong>。</p>
<p>其实这两种，事件流和持续计算本质上都是事件流。</p>
<h3 data-id="heading-3">流式计算与批量计算</h3>
<p>大数据的计算模式主要分为批量计算(batch computing)、流式计算(stream computing)、交互计算(interactive computing)、图计算(graph computing)等。其中，流式计算和批量计算是两种主要的大数据计算模式，分别适用于不同的大数据应用场景。</p>
<p>流数据（或数据流）是指在时间分布和数量上无限的一系列动态数据集合体，数据的价值随着时间的流逝而降低，因此必须实时计算给出秒级响应。流式计算，顾名思义，就是对数据流进行处理，是实时计算。批量计算则统一收集数据，存储到数据库中，然后对数据进行批量处理的数据计算方式。主要体现在以下几个方面：</p>
<p>1、数据时效性不同：流式计算实时、低延迟， 批量计算非实时、高延迟。</p>
<p>2、数据特征不同：流式计算的数据一般是动态的、没有边界的，而批处理的数据一般则是静态数据。</p>
<p>3、应用场景不同：流式计算应用在实时场景，时效性要求比较高的场景，如实时推荐、业务监控…批量计算一般说批处理，应用在实时性要求不高、离线计算的场景下，数据分析、离线报表等。</p>
<p>4、运行方式不同，流式计算的任务持续进行的，批量计算的任务则一次性完成。</p>
<h3 data-id="heading-4">流式计算框架、平台与相关产品</h3>
<p>第一类，商业级流式计算平台（IBM InfoSphere Streams、IBM StreamBase等）；</p>
<p>第二类，开源流式计算框架（Twitter Storm、S4等）；</p>
<p>第三类，公司为支持自身业务开发的流式计算框架。</p>
<p>Strom：Twitter 开发的第一代流处理系统。1</p>
<p>Heron：Twitter 开发的第二代流处理系统。</p>
<p>Spark streaming：是Spark核心API的一个扩展，可以实现高吞吐量的、具备容错机制的实时流数据的处理。</p>
<p>Flink：是一个针对流数据和批数据的分布式处理引擎。</p>
<p>Apache Kafka：Linkedin开发的大数据消息队列，由Scala写成。该项目的目标是为处理实时数据提供一个统一、高通量、低等待的平台。</p>
<p>Apache Samza, Linkedin开发的大数据流式处理系统， 可以实现流批一体的分布式处理引擎。</p>
<h2 data-id="heading-5">流式计算术语简介</h2>
<p>水位：</p>
<p>连接：</p>
<p>状态：</p>
<p>exactly-once: 在消息队列中，生产者重试发送消息，也只会让消息被发送给消费者一次。[2]</p>
<h2 data-id="heading-6">Lamda计算框架架构</h2>
<p>如何实时地在任意大数据集上进行查询？大数据再加上实时计算，问题的难度比较大。Lambda架构通过分解的三层架构来解决该问题：Batch Layer，Speed Layer和Serving Layer。</p>
<h3 data-id="heading-7">Batch Layer</h3>
<p>理想状态下，任何数据访问都可以从表达式Query= function(all data)开始，但是，若数据达到相当大的一个级别（例如PB），且还需要支持实时查询时，就需要耗费非常庞大的资源。一个解决方式是预运算查询函数（precomputed query function）。书中将这种预运算查询函数称之为Batch View（A），这样当需要执行查询时，可以从Batch View中读取结果。这样一个预先运算好的View是可以建立索引的，因而可以支持随机读取（B）。于是系统就变成：</p>
<p>（A）batch view = function(all data)</p>
<p>（B）query = function(batch view)</p>
<p>在Lambda架构中，实现（A）batch view =function(all data)的部分称之为Batch Layer。Batch Layer的功能主要有两点：</p>
<ul>
<li>存储master dataset, 这是一个不变的持续增长的数据集</li>
<li>在master dataset上预先计算查询函数，构建查询所对应的View</li>
</ul>
<p>View是一个和业务关联性比较大的概念，View的创建需要从业务自身的需求出发。一个通用的数据库查询系统，查询对应的函数千变万化，不可能穷举。但是如果从业务自身的需求出发，可以发现业务所需要的查询常常是有限的。Batch Layer需要做的一件重要的工作就是根据业务的需求，考察可能需要的各种查询，根据查询定义其在数据集上对应的Views。</p>
<p><strong>view可以理解为是等同于关系型数据库中的物化视图的概念。</strong></p>
<h3 data-id="heading-8">Speed Layer</h3>
<p>Batch Layer可以很好的处理离线数据，但有很多场景数据不断实时生成，并且需要实时查询处理。Speed Layer正是用来处理增量的实时数据。</p>
<p>Speed Layer和Batch Layer比较类似，对数据进行计算并生成Realtime View，其主要区别在于：</p>
<ul>
<li>Speed Layer处理的数据是最近的增量数据流，Batch Layer处理的全体数据集</li>
<li>Speed Layer为了效率，接收到新数据时不断更新Realtime View，而Batch Layer根据全体离线数据集直接得到Batch View。Speed Layer是一种增量计算，而非重新计算（recomputation）</li>
<li>Speed Layer因为采用增量计算，所以延迟小，而Batch Layer是全数据集的计算，耗时比较长</li>
</ul>
<p>综上所诉，Speed Layer是Batch Layer在实时性上的一个补充。Speed Layer可总结为：</p>
<p>（C）realtime view＝function(realtime view，new data)</p>
<p>注意，realtime view是基于新数据和已有的realtime view。</p>
<p>Lambda架构将数据处理分解为Batch Layer和Speed Layer有如下优点：</p>
<ul>
<li>容错性。Speed Layer中处理的数据也不断写入Batch Layer，当Batch Layer中重新计算的数据集包含Speed Layer处理的数据集后，当前的Realtime View就可以丢弃，这也就意味着Speed Layer处理中引入的错误，在Batch Layer重新计算时都可以得到修正。这点也可以看成是CAP理论中的最终一致性（Eventual Consistency）的体现。</li>
<li>复杂性隔离。Batch Layer处理的是离线数据，可以很好的掌控。Speed Layer采用增量算法处理实时数据，复杂性比Batch Layer要高很多。通过分开Batch Layer和Speed Layer，把复杂性隔离到Speed Layer，可以很好的提高整个系统的鲁棒性和可靠性。</li>
</ul>
<h3 data-id="heading-9">Serving Layer</h3>
<p>有一类称为Monoid特性的函数应用非常广泛。Monoid的概念来源于范畴学（Category Theory），其一个重要特性是满足结合律。如整数的加法就满足Monoid（结合律）特性：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">(a+b)+c=a+(b+c)
</code></pre>
<p>不满足Monoid特性的函数很多时候可以转化成多个满足Monoid特性的函数的运算。如多个数的平均值Avg函数，多个平均值没法直接通过结合来得到最终的平均值，但是可以拆成分母除以分子，分母和分子都是整数的加法，从而满足Monoid特性。</p>
<p>Monoid的结合律特性在分布式计算中极其重要，满足Monoid特性意味着我们可以将计算分解到多台机器并行运算，然后再结合各自的部分运算结果得到最终结果。同时也意味着部分运算结果可以储存下来被别的运算共享利用（如果该运算也包含相同的部分子运算），从而减少重复运算的工作量。</p>
<p>Lambda架构的Serving Layer用于响应用户的查询请求，合并Batch View和Realtime View中的结果数据集到最终的数据集。</p>
<p>这儿涉及到数据如何合并的问题。前面我们讨论了查询函数的Monoid性质，如果查询函数满足Monoid性质，即满足结合律，只需要简单的合并Batch View和Realtime View中的结果数据集即可。否则的话，可以把查询函数转换成多个满足Monoid性质的查询函数的运算，单独对每个满足Monoid性质的查询函数进行Batch View和Realtime View中的结果数据集合并，然后再计算得到最终的结果数据集。另外也可以根据业务自身的特性，运用业务自身的规则来对Batch View和Realtime View中的结果数据集合并。</p>
<p>综上所诉，Serving Layer采用如下等式表示：</p>
<p>（D）query<strong>＝</strong>function(batch view, realtime view)</p>
<h3 data-id="heading-10">Lambda架构组件选型</h3>
<p>上面分别讨论了Lambda架构的三层：Batch Layer，Speed Layer和Serving Layer。总结下来，Lambda架构就是如下的三个等式：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">batch view = function(all data)
realtime view = function(realtime view, new data)
query = function(batch view, realtime view)
</code></pre>
<p>数据流进入系统后，同时发往Batch Layer和Speed Layer处理。Batch Layer以不可变模型离线存储所有数据集，通过在全体数据集上不断重新计算构建查询所对应的Batch Views。Speed Layer处理增量的实时数据流，不断更新查询所对应的Realtime Views。Serving Layer响应用户的查询请求，合并Batch View和Realtime View中的结果数据集到最终的数据集。</p>
<p>下图给出了Lambda架构中各组件在大数据生态系统中和阿里集团的常用组件。数据流存储选用不可变日志的分布式系统Kafka、TT、Metaq；BatchLayer数据集的存储选用Hadoop的HDFS或者阿里云的ODPS；BatchView的加工采用MapReduce；BatchView数据的存储采用Mysql（查询少量的最近结果数据）、Hbase（查询大量的历史结果数据）。SpeedLayer采用增量数据处理Storm、Flink；RealtimeView增量结果数据集采用内存数据库Redis。</p>
<h4 data-id="heading-11">Lambda架构总结</h4>
<p>数据从底层的数据源开始，经过各种各样的格式进入大数据平台，在大数据平台中经过Kafka、Flume等数据组件进行收集，然后分成两条线进行计算。一条线是进入流式计算平台（例如 Storm、Flink或者Spark Streaming），去计算实时的一些指标；另一条线进入批量数据处理离线计算平台（例如Mapreduce、Hive，Spark SQL），去计算T+1的相关业务指标，这些指标需要隔日才能看见。</p>
<p>Lambda架构经历多年的发展，其优点是稳定，对于实时计算部分的计算成本可控，批量处理可以用晚上的时间来整体批量计算，这样把实时计算和离线计算高峰分开，这种架构支撑了数据行业的早期发展，但是它也有一些致命缺点，并在大数据3.0时代越来越不适应数据分析业务的需求。缺点如下：</p>
<ul>
<li><strong>实时与批量计算结果不一致引起的数据口径问题</strong>：因为批量和实时计算走的是两个计算框架和计算程序，算出的结果往往不同，经常看到一个数字当天看是一个数据，第二天看昨天的数据反而发生了变化。</li>
<li><strong>批量计算在计算窗口内无法完成</strong>：在IOT时代，数据量级越来越大，经常发现夜间只有4、5个小时的时间窗口，已经无法完成白天20多个小时累计的数据，保证早上上班前准时出数据已成为每个大数据团队头疼的问题。</li>
<li><strong>开发和维护的复杂性问题</strong>：Lambda 架构需要在两个不同的 API（application programming interface，应用程序编程接口）中对同样的业务逻辑进行两次编程：一次为批量计算的ETL系统，一次为流式计算的Streaming系统。针对同一个业务问题产生了两个代码库，各有不同的漏洞。这种系统实际上非常难维护</li>
<li><strong>服务器存储大</strong>：数据仓库的典型设计，会产生大量的中间结果表，造成数据急速膨胀，加大服务器存储压力。</li>
</ul>
<p>因此上有了Kappa架构。</p>
<h3 data-id="heading-12">Kappa架构</h3>
<p>Kafka的创始人Jay Kreps认为在很多场景下，维护一套Lambda架构的大数据处理平台耗时耗力，于是提出在某些场景下，没有必要维护一个批处理层，直接使用一个流处理层即可满足需求，Kappa架构。</p>
<p>Kappa架构的兴起主要原因：</p>
<ul>
<li>
<p>批处理被被认为是流式处理的一个子集，所以可以省略掉。</p>
</li>
<li>
<p>Kappa架构相对更简单，实时性更好，所需的计算资源远小于Lambda架构，随着实时处理的需求在不断增长，更多的企业开始使用Kappa架构。</p>
</li>
</ul>
<p>Kappa架构的流行并不意味着不再需要批处理，批处理在一些特定场景上仍然有自己的优势。比如进行一些数据探索、机器学习实验，需要使用批处理来反复验证不同的算法。Kappa架构适用于一些逻辑固定的数据预处理流程，如统计一个时间段内商品的曝光和购买次数、某些关键词的搜索次数等。</p>
<h2 data-id="heading-13">相关工作</h2>
<p>mob604756ebed9f在他的博客[1]里通过问答的形式，讲解了具体的Flink的使用方式和面试常见问题。</p>
<p>阿凡卢在他的博客[2]里详细解释了如何实现exactly-once, at-least once, atmost once等语义和实现原理。</p>
<p>大数据流动在他的博客[3]里详细介绍了Flink的简单历史、环境搭建、测试、编程模型和Flink DataStreaming API的使用。</p>
<p>独孤风在他的公众号文章[4]里介绍了Flink流批一体的实现原理。</p>
<p>kk大数据在腾讯云+社区里发表了文章[5]介绍了Flink水位和窗口的关系，介绍了几种窗口以及水位的概念。</p>
<p>先荐在他的博客[6]里介绍了流式计算的背景.</p>
<p>Heriam在他的博文[7]里详细并且通俗易懂介绍了Lamda架构出现的历史原因，Lambda三层架构的理解。介绍Lambda架构的文章很多，但是通俗易懂的介绍Lambda架构的博客不多，能深入浅出讲明白的更是珍贵。</p>
<p>废物大师兄在他的文章《Flink入门》[9]里，介绍了Flink适配的计算集群资源、介绍了Flink的基本概念，比如状态、时间相关的特性等。</p>
<h2 data-id="heading-14">参考</h2>
<p>[1]mob604756ebed9f, 一网打尽Flink高频面试题,<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.51cto.com%2Fu_15127538%2F2659011" target="_blank" title="https://blog.51cto.com/u_15127538/2659011" ref="nofollow noopener noreferrer">blog.51cto.com/u_15127538/…</a></p>
<p>[2]阿凡卢,Kafka中的exactly-once,<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fluxiaoxun%2Fp%2F13048474.html" target="_blank" title="https://www.cnblogs.com/luxiaoxun/p/13048474.html" ref="nofollow noopener noreferrer">www.cnblogs.com/luxiaoxun/p…</a></p>
<p>[3]大数据流动,Flink入门宝典（详细截图版）,<a href="https://juejin.cn/post/684490394427195392" target="_blank" title="https://juejin.cn/post/684490394427195392">juejin.cn/post/684490…</a></p>
<p>[4]独孤风/大数据流动，Flink流批一体实现原理，<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fo8ZIinTSeGZvfT19gyU2Eg" target="_blank" title="https://mp.weixin.qq.com/s/o8ZIinTSeGZvfT19gyU2Eg" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/o8ZIinTSe…</a></p>
<p>[5]kk大数据，水位和窗口，<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fdeveloper%2Farticle%2F1539213" target="_blank" title="https://cloud.tencent.com/developer/article/1539213" ref="nofollow noopener noreferrer">cloud.tencent.com/developer/a…</a></p>
<p>[6]先荐，流式计算简介，<a href="https://link.juejin.cn?target=https%3A%2F%2Faijishu.com%2Fa%2F1060000000009451" target="_blank" title="https://aijishu.com/a/1060000000009451" ref="nofollow noopener noreferrer">aijishu.com/a/106000000…</a></p>
<p>[7]Heriam，深入理解Lamda架构，<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fcciejh%2Fp%2Flambda-architecture.html" target="_blank" title="https://www.cnblogs.com/cciejh/p/lambda-architecture.html" ref="nofollow noopener noreferrer">www.cnblogs.com/cciejh/p/la…</a></p>
<p>[8]皮皮鲁的科技星球,大数据处理平台从Lambda到Kappa的演进,<a href="https://juejin.cn/post/6844904013217923086" target="_blank" title="https://juejin.cn/post/6844904013217923086">juejin.cn/post/684490…</a></p>
<p>[9]废物大师兄, Flink 入门, <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fcjsblog%2Fp%2F12905871.html" target="_blank" title="https://www.cnblogs.com/cjsblog/p/12905871.html" ref="nofollow noopener noreferrer">www.cnblogs.com/cjsblog/p/1…</a></p>
<p>[10]zhisheng, Flink从0到1学习—— 分享四本 Flink 国外的书和二十多篇 Paper 论文,<a href="https://link.juejin.cn?target=https%3A%2F%2Faijishu.com%2Fa%2F1060000000002768" target="_blank" title="https://aijishu.com/a/1060000000002768" ref="nofollow noopener noreferrer">aijishu.com/a/106000000…</a></p>
<p>[11]Flink官方，Flink的容错机制，<a href="https://link.juejin.cn?target=https%3A%2F%2Fnightlies.apache.org%2Fflink%2Fflink-docs-master%2Fzh%2Fdocs%2Flearn-flink%2Ffault_tolerance%2F" target="_blank" title="https://nightlies.apache.org/flink/flink-docs-master/zh/docs/learn-flink/fault_tolerance/" ref="nofollow noopener noreferrer">nightlies.apache.org/flink/flink…</a></p>
<p>[12]林小铂，Flink容错，<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.whitewood.me%2F2019%2F07%2F28%2F%25E6%25B7%25B1%25E5%2585%25A5%25E7%2590%2586%25E8%25A7%25A3-Flink-%25E5%25AE%25B9%25E9%2594%2599%25E6%259C%25BA%25E5%2588%25B6%2F" target="_blank" title="http://www.whitewood.me/2019/07/28/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-Flink-%E5%AE%B9%E9%94%99%E6%9C%BA%E5%88%B6/" ref="nofollow noopener noreferrer">www.whitewood.me/2019/07/28/…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Web 抓包在浏览器、代理、设备侧等不同层面的作用]]></title>    <link>https://juejin.cn/post/7585825055437963270</link>    <guid>https://juejin.cn/post/7585825055437963270</guid>    <pubDate>2025-12-22T03:42:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585825055437963270" data-draft-id="7585789195870224420" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Web 抓包在浏览器、代理、设备侧等不同层面的作用"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-22T03:42:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="疯狂的程序猴"/> <meta itemprop="url" content="https://juejin.cn/user/2760245749234147"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Web 抓包在浏览器、代理、设备侧等不同层面的作用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2760245749234147/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    疯狂的程序猴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:42:56.000Z" title="Mon Dec 22 2025 03:42:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Web 项目里，抓包常常被当作一件理所当然的事情。
打开浏览器开发者工具，看 Network 面板，请求、响应、状态码都在那里，似乎已经足够。</p>
<p>但真正经常会发生前端说请求已经发出，后端说日志里没看到；后端确认已经返回，前端却始终拿不到数据。</p>
<p>这种时候，Web 抓包才真正进入视野。</p>
<hr/>
<h2 data-id="heading-0"><strong>浏览器 Network 面板：最熟悉，也最容易被高估</strong></h2>
<p>对 Web 开发来说，浏览器自带的 Network 面板几乎是默认工具。
它非常适合做一件事：<strong>验证浏览器内部发生了什么</strong>。</p>
<p>你可以清楚看到：</p>
<ul>
<li>请求的发起时机</li>
<li>Header 是否符合预期</li>
<li>返回内容是否被浏览器正确解析</li>
<li>请求是否被缓存或重定向</li>
</ul>
<p>在调试前端逻辑时，这已经解决了大部分问题。</p>
<p>但 Network 面板有一个天然限制：它只能反映<strong>浏览器视角</strong>下的网络行为。</p>
<hr/>
<h2 data-id="heading-1"><strong>当问题不再只发生在浏览器里</strong></h2>
<p>Web 抓包开始变复杂，通常是因为系统结构变复杂了。</p>
<p>比如：</p>
<ul>
<li>Web 页面请求的是中间层接口</li>
<li>同一个接口被多个客户端调用</li>
<li>请求经过了 CDN、网关或安全设备</li>
<li>页面依赖第三方脚本或 SDK</li>
</ul>
<p>这时，仅看浏览器 Network，很难回答一个关键问题：</p>
<blockquote>
<p>请求在离开浏览器之后，究竟发生了什么？</p>
</blockquote>
<hr/>
<h2 data-id="heading-2"><strong>代理抓包：把 Web 请求放到“网络路径”中看</strong></h2>
<p>在这种情况下，我通常会引入代理抓包工具，比如Charles，Fiddler。</p>
<p>代理抓包的意义，不是替代浏览器工具，而是换一个观察位置。
它能看到请求在浏览器之外的表现，比如：</p>
<ul>
<li>实际访问的域名和 IP</li>
<li>Header 是否被中间层修改</li>
<li>请求是否被重试或重定向</li>
<li>HTTPS 解密后的完整内容</li>
</ul>
<p>在 Web 抓包中，代理工具非常适合用来确认：<strong>是不是浏览器之外的某个环节改变了请求。</strong></p>
<hr/>
<h2 data-id="heading-3"><strong>HTTPS 之后，Web 抓包也会遇到“看不清”的问题</strong></h2>
<p>当 Web 项目全面切换到 HTTPS 之后，抓包并不总是那么顺利。</p>
<p>如果页面请求来自 WebView、Hybrid 应用，或者某些请求并不走系统代理路径，代理抓包工具看到的内容就会变得不完整。</p>
<p>这时继续纠结“为什么抓不到”，不如先确认一个事实：请求是否真的按你认为的方式发送了。</p>
<hr/>
<h2 data-id="heading-4"><strong>设备侧抓包，在 Web 场景下也有价值</strong></h2>
<p>在分析 WebView、Hybrid 页面或嵌入式 Web 请求时，我会用 <strong>抓包大师（Sniff Master）</strong> 从设备侧抓取通信数据。</p>
<p>它在 Web 抓包中的作用，并不是替代浏览器或代理工具，而是解决一个特定问题：</p>
<blockquote>
<p>当 Web 请求运行在 App 或设备环境中时，我能否看到它真实发出的网络行为？</p>
</blockquote>
<p>由于不依赖系统代理，也不需要越狱或 root，它更接近真实运行环境。
这在排查“Web 页面在 App 内行为异常”时尤其有用。</p>
<hr/>
<h2 data-id="heading-5"><strong>只抓目标流量，Web 抓包才能继续推进</strong></h2>
<p>在真实环境下抓 Web 流量，很容易被噪音干扰。
后台同步、系统服务、其他页面请求，很快就会让分析变得混乱。</p>
<p>支持只抓取指定 App 或指定流量的工具，在这种情况下价值会非常明显。
当你能把注意力限制在一个 Web 页面或一个接口上，很多模糊的问题反而会变得具体。</p>
<hr/>
<h2 data-id="heading-6"><strong>Web 抓包并不总是 HTTP 层的问题</strong></h2>
<p>在一些复杂场景中，Web 请求只是整个通信过程的一部分。</p>
<p>例如：</p>
<ul>
<li>Web 页面触发接口，接口再建立长连接</li>
<li>Web 配置请求成功，但数据推送失败</li>
<li>Web 行为依赖 TCP 或 WebSocket 通信</li>
</ul>
<p>如果只停留在 HTTP 抓包层面，很容易误判“请求已经完成”。</p>
<p>这时，就需要结合数据流抓包，去确认连接是否建立、是否保持。
抓包大师支持 TCP / UDP 数据流抓取，在分析这类混合通信模型时，能补齐 HTTP 看不到的部分。</p>
<hr/>
<h2 data-id="heading-7"><strong>Wireshark 可以用来解析更细节的请求</strong></h2>
<p>在 Web 抓包分析中，我并不会频繁使用 Wireshark。
它更像是一个在关键节点出现的工具，用来确认一些底层事实，比如：</p>
<ul>
<li>TCP 连接是否被重置</li>
<li>数据是否发生重传</li>
<li>网络层是否存在异常</li>
</ul>
<p>在没有明确方向之前，过早使用 Wireshark，反而容易让人迷失在细节里。</p>
<hr/>
<h2 data-id="heading-8"><strong>拦截和修改，用来验证理解是否正确</strong></h2>
<p>理解 Web 抓包的另一种方式，是主动改变请求。</p>
<p>在排查过程中，我经常会修改 Header、返回状态码或响应内容，观察前端行为变化。
这种做法，比单纯“看数据”更容易验证对系统的理解是否正确。</p>
<p>抓包大师支持通过脚本拦截和修改请求、响应，在这一步更像是一个实验工具，而不是分析工具。</p>
<hr/>
<h2 data-id="heading-9"><strong>对 Web 抓包的一点实际体会</strong></h2>
<p>做过几次复杂排查之后，我对 Web 抓包的看法变得更加谨慎：</p>
<ul>
<li>浏览器工具解决的是“页面内部”的问题</li>
<li>代理抓包解决的是“网络路径”的问题</li>
<li>设备侧抓包解决的是“真实运行环境”的问题</li>
<li>数据流抓包解决的是“连接是否成立”的问题</li>
</ul>
<p>多工具组合，并不是为了显得复杂，而是为了避免在错误层面反复纠结。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：用 JavaScript/Lua 解锁动态业务扩展能力]]></title>    <link>https://juejin.cn/post/7585897699603562522</link>    <guid>https://juejin.cn/post/7585897699603562522</guid>    <pubDate>2025-12-22T03:49:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585897699603562522" data-draft-id="7586167377381818394" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：用 JavaScript/Lua 解锁动态业务扩展能力"/> <meta itemprop="keywords" content="Go,JavaScript,Lua"/> <meta itemprop="datePublished" content="2025-12-22T03:49:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="喵个咪"/> <meta itemprop="url" content="https://juejin.cn/user/1350630784901262"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：用 JavaScript/Lua 解锁动态业务扩展能力
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1350630784901262/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    喵个咪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:49:37.000Z" title="Mon Dec 22 2025 03:49:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：用 JavaScript/Lua 解锁动态业务扩展能力</h2>
<p>在企业级中后台系统开发领域，「业务规则频繁迭代」与「个性化需求快速响应」始终是困扰开发团队的核心痛点。试想这样的场景：电商平台的促销规则需随节日实时调整， SaaS 系统需为不同行业客户定制专属审批流程，风控系统需根据最新风险模型动态更新校验逻辑…… 传统「代码开发 - 编译打包 - 部署上线」的全流程，往往需要数小时甚至数天才能完成迭代，严重滞后于业务节奏。</p>
<p>脚本引擎的嵌入式集成，为这一困境提供了优雅的破局思路——通过动态执行脚本代码，实现业务逻辑的「热更新、热部署」，无需重启服务即可完成规则迭代与需求适配。GoWind Admin（风行）作为一款主打「开箱即用」的企业级前后端一体中后台框架，精准洞察这一需求，深度整合 <code>kratos-bootstrap</code> 生态中的 <code>script_engine</code> 组件（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftx7do%2Fkratos-bootstrap%2Ftree%2Fmain%2Fscript_engine" target="_blank" title="https://github.com/tx7do/kratos-bootstrap/tree/main/script_engine" ref="nofollow noopener noreferrer">github.com/tx7do/krato…</a>），实现了对 JavaScript、Lua 两种主流脚本语言的无缝支持，让开发者能够以极低成本嵌入动态逻辑，为中后台系统注入「随需而变」的灵活基因。</p>
<h3 data-id="heading-1">为什么选择 script_engine？Go 生态下的嵌入式脚本引擎优选</h3>
<p>在 Go 应用中实现动态脚本能力，并非只有<code>script_engine</code> 一种选择，但结合企业级中后台系统「高性能、高可靠、易集成」的核心诉求，它成为了 GoWind Admin 的最优解。这款专为 Go 应用设计的嵌入式脚本引擎组件，核心优势体现在四个维度：</p>
<h4 data-id="heading-2">1. 多语言覆盖，适配全场景动态需求</h4>
<p>原生支持 Lua 与 JavaScript 两种主流脚本语言，精准匹配不同业务场景与开发团队的技术栈：</p>
<ul>
<li><strong>Lua</strong>：以轻量、高效、低资源占用著称，字节码执行速度快，内存开销小，特别适合高频执行的轻量级业务逻辑（如订单金额计算、风控规则校验、数据格式转换等）；</li>
<li><strong>JavaScript</strong>：前端开发者的「母语」，无需额外学习成本即可参与后端动态逻辑开发，完美适配前后端协同场景（如表单校验规则同步、页面交互逻辑复用等）。</li>
</ul>
<p>两种语言的无缝切换，让开发团队可根据业务特性灵活选型，避免「为适配脚本语言而调整技术栈」的尴尬。</p>
<h4 data-id="heading-3">2. 智能池化管理，平衡性能与资源开销</h4>
<p>脚本引擎的创建与销毁是典型的「重操作」，若每次脚本执行都重新初始化引擎，会产生大量性能损耗，尤其在中后台系统高并发场景下，可能成为性能瓶颈。<code>script_engine</code> 提供两种成熟的引擎池实现，通过实例复用彻底解决这一问题：</p>
<ul>
<li><strong>EnginePool（固定大小池）</strong>：初始化时创建固定数量的引擎实例，适用于并发量稳定的场景，资源占用可预测，避免不必要的扩容开销；</li>
<li><strong>AutoGrowEnginePool（自动扩容池）</strong>：支持根据请求量动态扩容，初始创建少量实例节省资源，当并发请求激增时自动新增实例（不超过上限），流量回落时释放空闲实例，完美适配中后台系统「潮汐式流量」特征（如财务结算高峰期、报表导出峰值等）。</li>
</ul>
<p>池化机制的引入，让动态脚本执行的性能损耗降低 80% 以上，同时通过实例上限控制，避免资源耗尽风险，兼顾灵活性与稳定性。</p>
<h4 data-id="heading-4">3. 双向深度交互，打通 Go 与脚本的能力边界</h4>
<p>优秀的嵌入式脚本引擎，核心在于「不孤立」——能够与宿主应用（Go 程序）实现深度协同。<code>script_engine</code> 支持 Go 与脚本语言的双向通信，实现业务逻辑的灵活拆分与组合：</p>
<ul>
<li><strong>Go 向脚本注入能力</strong>：可将 Go 中的全局变量、业务函数、结构体实例注册到脚本环境，让脚本直接调用框架核心能力（如用户认证、数据查询、消息推送等），无需重复开发；</li>
<li><strong>脚本向 Go 反馈结果</strong>：Go 可直接调用脚本中定义的函数，获取返回结果并集成到核心流程中，实现「固定框架 + 动态逻辑」的架构模式。</li>
</ul>
<h4 data-id="heading-5">4. 标准化集成，开箱即用零门槛</h4>
<p>作为 <code>kratos-bootstrap</code> 生态的核心组件，`script_engine遵循标准化的接口设计，与 GoWind Admin 的架构体系无缝融合。开发者无需关注底层引擎实现、内存管理、并发控制等细节，只需通过简单的 API 调用，即可完成脚本引擎的初始化、资源注册、脚本执行等操作，真正实现「开箱即用」。</p>
<h3 data-id="heading-6">核心实践：GoWind Admin 中动态脚本能力的落地步骤</h3>
<p>GoWind Admin 基于 <code>script_engine</code> 实现动态业务扩展的核心流程，可概括为「初始化引擎池 - 注册交互资源 - 执行动态脚本 - 跨语言函数调用」四步闭环。以下结合企业级真实场景，拆解每一步的实现细节与最佳实践：</p>
<h4 data-id="heading-7">1. 引擎池初始化：按需选型，适配并发场景</h4>
<p>中后台系统的并发特征差异较大（如后台管理系统并发低但场景复杂，交易系统并发高且实时性要求高），GoWind Admin 支持根据业务场景选择合适的引擎池类型。以下以最常用的「自动扩容引擎池」为例，展示 JavaScript 引擎的初始化过程：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">import</span> (
	<span class="hljs-string">"context"</span>
	<span class="hljs-string">"fmt"</span>
	<span class="hljs-string">"log"</span>

	conf <span class="hljs-string">"github.com/tx7do/kratos-bootstrap/api/gen/go/conf/v1"</span>
	<span class="hljs-string">"github.com/tx7do/kratos-bootstrap/script_engine"</span>
	_ <span class="hljs-string">"github.com/tx7do/go-scripts/javascript"</span> <span class="hljs-comment">// 注册JavaScript引擎驱动</span>

	<span class="hljs-string">"google.golang.org/protobuf/types/known/wrapperspb"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">initScriptEngine</span><span class="hljs-params">()</span></span> (script_engine.ScriptEngine, <span class="hljs-type">error</span>) {
	<span class="hljs-comment">// 1. 配置引擎参数：指定脚本语言、池化策略</span>
	cfg := &amp;conf.Script{
		Engine: conf.Script_JAVASCRIPT, <span class="hljs-comment">// 选择JavaScript引擎</span>
		Pool: &amp;conf.Script_Pool{
			Initial: &amp;wrapperspb.Int32Value{Value: <span class="hljs-number">2</span>}, <span class="hljs-comment">// 初始实例数：2个</span>
			Max:     &amp;wrapperspb.Int32Value{Value: <span class="hljs-number">10</span>}, <span class="hljs-comment">// 最大实例数：10个（避免资源耗尽）</span>
			IdleTimeout: &amp;wrapperspb.DurationValue{Value: <span class="hljs-number">300</span>}, <span class="hljs-comment">// 空闲实例超时销毁：300秒</span>
		},
	}

	<span class="hljs-comment">// 2. 初始化引擎池</span>
	enginePool, err := script_engine.NewAutoGrowScriptEnginePool(cfg)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Printf(<span class="hljs-string">"引擎池初始化失败：%v"</span>, err)
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
	}

	<span class="hljs-comment">// 3. 延迟关闭引擎池（程序退出时释放资源）</span>
	<span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
		<span class="hljs-keyword">if</span> err := enginePool.Close(); err != <span class="hljs-literal">nil</span> {
			log.Printf(<span class="hljs-string">"引擎池关闭失败：%v"</span>, err)
		}
	}()

	<span class="hljs-keyword">return</span> enginePool, <span class="hljs-literal">nil</span>
}
</code></pre>
<blockquote>
<p>最佳实践：初始化时建议根据业务峰值预估最大实例数，避免设置过高导致内存溢出；同时配置空闲超时时间，释放长期闲置的引擎实例，节省资源。</p>
</blockquote>
<h4 data-id="heading-8">2. 注册交互资源：打通 Go 与脚本的能力通道</h4>
<p>为让脚本能够复用 GoWind Admin 的核心业务能力，需将框架中的函数、数据结构注册到脚本环境。以下以「用户状态管理」场景为例，展示 Go 函数向 <code>JavaScript</code> 脚本的注册过程：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 定义Go中的核心业务函数：更新用户状态（真实场景中会对接数据库、缓存等）</span>
<span class="hljs-keyword">type</span> UserService <span class="hljs-keyword">struct</span>{}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *UserService)</span></span> UpdateUserStatus(userId <span class="hljs-type">int64</span>, status <span class="hljs-type">string</span>) (<span class="hljs-type">bool</span>, <span class="hljs-type">error</span>) {
	<span class="hljs-comment">// 模拟业务逻辑：校验用户存在性、更新状态</span>
	<span class="hljs-keyword">if</span> userId &lt;= <span class="hljs-number">0</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, fmt.Errorf(<span class="hljs-string">"无效用户ID"</span>)
	}
	<span class="hljs-comment">// 实际场景：调用ORM框架更新数据库</span>
	log.Printf(<span class="hljs-string">"用户[%d]状态更新为：%s"</span>, userId, status)
	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>, <span class="hljs-literal">nil</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">registerResources</span><span class="hljs-params">(eng script_engine.Engine)</span></span> <span class="hljs-type">error</span> {
	<span class="hljs-comment">// 1. 初始化业务服务实例</span>
	userService := &amp;UserService{}

	<span class="hljs-comment">// 2. 注册业务函数到脚本环境，脚本中可通过"updateUserStatus"直接调用</span>
	err := eng.RegisterFunction(<span class="hljs-string">"updateUserStatus"</span>, userService.UpdateUserStatus)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">"注册UpdateUserStatus失败：%v"</span>, err)
	}

	<span class="hljs-comment">// 3. 注册全局变量到脚本环境（如系统配置、常量等）</span>
	err = eng.RegisterVariable(<span class="hljs-string">"SYSTEM_ENV"</span>, <span class="hljs-string">"production"</span>)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">"注册全局变量失败：%v"</span>, err)
	}

	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}
</code></pre>
<p>注册完成后，JavaScript 脚本即可直接调用这些资源，实现与框架核心逻辑的协同：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// JavaScript脚本中调用Go注册的函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleUserStatus</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> userId = <span class="hljs-number">10086</span>;
    <span class="hljs-keyword">const</span> targetStatus = <span class="hljs-string">"active"</span>;
    
    <span class="hljs-comment">// 调用Go注册的updateUserStatus函数</span>
    <span class="hljs-keyword">const</span> [success, err] = <span class="hljs-keyword">await</span> <span class="hljs-title function_">updateUserStatus</span>(userId, targetStatus);
    
    <span class="hljs-keyword">if</span> (success) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`用户<span class="hljs-subst">${userId}</span>状态更新成功，当前环境：<span class="hljs-subst">${SYSTEM_ENV}</span>`</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`更新失败：<span class="hljs-subst">${err.message}</span>`</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
}
</code></pre>
<h4 data-id="heading-9">3. 执行动态脚本：加载并运行自定义业务逻辑</h4>
<p>GoWind Admin 支持通过「字符串、本地文件、远程流」三种方式加载脚本，适配不同场景的动态逻辑部署需求（如本地调试用字符串、生产环境用远程配置中心加载脚本）。以下以「订单金额计算」场景为例，展示 <code>Lua</code> 脚本的文件加载与执行过程：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">executeScript</span><span class="hljs-params">(eng script_engine.Engine)</span></span> (<span class="hljs-keyword">interface</span>{}, <span class="hljs-type">error</span>) {
	<span class="hljs-comment">// 场景：电商促销活动，订单金额计算规则频繁变更，用Lua脚本动态实现</span>
	<span class="hljs-comment">// 从本地文件加载Lua脚本（生产环境可改为从配置中心、对象存储加载）</span>
	result, err := eng.ExecuteFile(context.Background(), <span class="hljs-string">"./scripts/calculate_order.lua"</span>)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"脚本执行失败：%v"</span>, err)
	}
	<span class="hljs-keyword">return</span> result, <span class="hljs-literal">nil</span>
}
</code></pre>
<p>Lua 脚本（<code>calculate_order.lua</code>）：实现含阶梯折扣的订单金额计算逻辑（可动态更新）</p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- 阶梯折扣规则：满3件9折，满5件8折，满10件7折</span>
<span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">calculateOrderAmount</span><span class="hljs-params">(price, quantity, baseDiscount)</span></span>
    <span class="hljs-keyword">local</span> discount = baseDiscount
    <span class="hljs-comment">-- 动态调整折扣</span>
    <span class="hljs-keyword">if</span> quantity &gt;= <span class="hljs-number">10</span> <span class="hljs-keyword">then</span>
        discount = <span class="hljs-number">0.7</span>
    <span class="hljs-keyword">elseif</span> quantity &gt;= <span class="hljs-number">5</span> <span class="hljs-keyword">then</span>
        discount = <span class="hljs-number">0.8</span>
    <span class="hljs-keyword">elseif</span> quantity &gt;= <span class="hljs-number">3</span> <span class="hljs-keyword">then</span>
        discount = <span class="hljs-number">0.9</span>
    <span class="hljs-keyword">end</span>
    <span class="hljs-comment">-- 计算最终金额（保留2位小数）</span>
    <span class="hljs-keyword">local</span> finalAmount = price * quantity * discount
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">floor</span>(finalAmount * <span class="hljs-number">100</span>) / <span class="hljs-number">100</span>
<span class="hljs-keyword">end</span>

<span class="hljs-comment">-- 业务参数：单价99.9元，数量5件，基础折扣0.95</span>
<span class="hljs-keyword">return</span> calculateOrderAmount(<span class="hljs-number">99.9</span>, <span class="hljs-number">5</span>, <span class="hljs-number">0.95</span>)
</code></pre>
<p>当促销规则变更时（如新增「会员额外9.5折」），只需修改 Lua 脚本并重新加载，无需重启 GoWind Admin 服务，实现「秒级迭代」。</p>
<h4 data-id="heading-10">4. 函数调用：精细化跨语言逻辑交互</h4>
<p>除了执行完整脚本，<code>script_engine</code> 还支持在 Go 中直接调用脚本中定义的特定函数，实现更精细化的逻辑交互。以下以「权限校验」场景为例，展示 Go 调用 JavaScript 函数的过程：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">callScriptFunction</span><span class="hljs-params">(eng script_engine.Engine)</span></span> (<span class="hljs-type">bool</span>, <span class="hljs-type">error</span>) {
	<span class="hljs-comment">// 场景：用户操作前的权限校验，校验规则动态配置</span>
	userId := <span class="hljs-type">int64</span>(<span class="hljs-number">10086</span>)
	requiredPermission := <span class="hljs-string">"order:edit"</span> <span class="hljs-comment">// 所需权限：编辑订单</span>

	<span class="hljs-comment">// 调用JavaScript脚本中定义的checkPermission函数</span>
	result, err := eng.CallFunction(
		context.Background(),
		<span class="hljs-string">"checkPermission"</span>, <span class="hljs-comment">// 脚本中函数名</span>
		userId,            <span class="hljs-comment">// 参数1：用户ID</span>
		requiredPermission,<span class="hljs-comment">// 参数2：所需权限</span>
	)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, fmt.Errorf(<span class="hljs-string">"调用权限校验函数失败：%v"</span>, err)
	}

	<span class="hljs-comment">// 解析返回结果（脚本返回bool类型）</span>
	hasPermission, ok := result.(<span class="hljs-type">bool</span>)
	<span class="hljs-keyword">if</span> !ok {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, fmt.Errorf(<span class="hljs-string">"权限校验结果格式错误"</span>)
	}

	<span class="hljs-keyword">return</span> hasPermission, <span class="hljs-literal">nil</span>
}
</code></pre>
<p>JavaScript 脚本中定义的权限校验函数（支持动态更新校验规则）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 权限校验函数：支持角色继承、临时权限叠加逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">checkPermission</span>(<span class="hljs-params">userId, requiredPermission</span>) {
    <span class="hljs-comment">// 模拟从缓存获取用户权限（真实场景可调用Go注册的缓存查询函数）</span>
    <span class="hljs-keyword">const</span> userRoles = <span class="hljs-title function_">getUserRoles</span>(userId); <span class="hljs-comment">// 脚本内部函数</span>
    <span class="hljs-keyword">const</span> userPermissions = <span class="hljs-title function_">getPermissionsByRoles</span>(userRoles); <span class="hljs-comment">// 脚本内部函数</span>
    
    <span class="hljs-comment">// 临时权限：为测试账号开放所有权限（动态配置）</span>
    <span class="hljs-keyword">if</span> (userId === <span class="hljs-number">10000</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-comment">// 校验核心权限</span>
    <span class="hljs-keyword">return</span> userPermissions.<span class="hljs-title function_">includes</span>(requiredPermission);
}

<span class="hljs-comment">// 辅助函数：根据用户ID获取角色</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserRoles</span>(<span class="hljs-params">userId</span>) {
    <span class="hljs-comment">// 模拟数据：实际可调用Go注册的用户角色查询函数</span>
    <span class="hljs-keyword">const</span> roleMap = {
        <span class="hljs-number">10086</span>: [<span class="hljs-string">"order_manager"</span>, <span class="hljs-string">"user_manager"</span>],
        <span class="hljs-number">10087</span>: [<span class="hljs-string">"order_viewer"</span>]
    };
    <span class="hljs-keyword">return</span> roleMap[userId] || [];
}

<span class="hljs-comment">// 辅助函数：根据角色获取权限</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getPermissionsByRoles</span>(<span class="hljs-params">roles</span>) {
    <span class="hljs-keyword">const</span> permissionMap = {
        <span class="hljs-attr">order_manager</span>: [<span class="hljs-string">"order:view"</span>, <span class="hljs-string">"order:edit"</span>, <span class="hljs-string">"order:delete"</span>],
        <span class="hljs-attr">user_manager</span>: [<span class="hljs-string">"user:view"</span>, <span class="hljs-string">"user:edit"</span>],
        <span class="hljs-attr">order_viewer</span>: [<span class="hljs-string">"order:view"</span>]
    };
    <span class="hljs-keyword">let</span> permissions = [];
    roles.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">role</span> =&gt;</span> {
        permissions = [...permissions, ...(permissionMap[role] || [])];
    });
    <span class="hljs-keyword">return</span> [...<span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(permissions)]; <span class="hljs-comment">// 去重</span>
}
</code></pre>
<h3 data-id="heading-11">企业级价值：动态扩展能力如何赋能业务增长？</h3>
<p>GoWind Admin 整合 script_engine 后，为企业级中后台系统带来多维度的能力跃升，直接赋能业务增长：</p>
<h4 data-id="heading-12">1. 缩短业务迭代周期，提升市场响应速度</h4>
<p>促销规则、定价策略、审批流程等高频变更的业务逻辑，无需经过「开发 - 测试 - 部署」全流程，只需修改脚本并加载即可生效。以电商平台为例，节日大促期间的规则调整可从「天级」缩短至「秒级」，精准抓住流量峰值的转化机会。</p>
<h4 data-id="heading-13">2. 降低定制化成本，支撑规模化 SaaS 运营</h4>
<p>对于 SaaS 型中后台系统，不同行业、不同规模的客户往往有个性化需求。通过脚本实现差异化逻辑，可避免核心代码分支爆炸（如为每个客户维护一个代码分支），降低开发与维护成本。例如，为金融客户定制「多维度风控校验」，为零售客户定制「进销存专属报表逻辑」，均无需修改框架核心代码。</p>
<h4 data-id="heading-14">3. 打破技术壁垒，提升团队协作效率</h4>
<p>前端开发者可直接使用 JavaScript 编写后端动态逻辑，无需学习 Go 语言；运维人员可通过脚本快速调整系统配置、修复小问题，无需依赖开发团队。技术壁垒的打破，让团队协作更高效，资源调度更灵活。</p>
<h4 data-id="heading-15">4. 保障系统稳定性，平衡灵活与可靠</h4>
<p>引擎池的资源限制与实例复用机制，让动态脚本执行的资源占用可预测、可控制，避免因脚本异常导致整个系统崩溃。同时，脚本执行失败不会影响 Go 核心流程的运行，实现「动态逻辑故障隔离」，平衡了业务灵活性与系统稳定性。</p>
<h3 data-id="heading-16">总结：以动态能力驱动中后台系统进化</h3>
<p>在数字化转型加速的今天，企业对中后台系统的「敏捷性」要求越来越高。GoWind Admin 借助 <code>go-scripts</code> 与 <code>kratos-bootstrap</code> 的 <code>script_engine</code> 组件，成功将「动态脚本扩展能力」融入企业级框架的核心架构，既保留了 Go 语言的高性能、高可靠优势，又弥补了传统编译型语言的灵活性不足。</p>
<p>从高频变更的业务规则，到个性化的客户需求，再到跨团队的协同效率提升，GoWind Admin 的动态扩展能力正在重新定义中后台系统的开发与运营模式。对于开发团队而言，无需再为「快速迭代」与「系统稳定」的矛盾纠结，只需聚焦业务本身，通过简单的脚本交互即可实现需求落地；对于企业而言，这意味着更低的研发成本、更快的市场响应速度，以及更强的业务创新能力。</p>
<p>如需快速上手实践，可直接参考以下资源：</p>
<ul>
<li><code>script_engine</code> 组件文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftx7do%2Fkratos-bootstrap%2Ftree%2Fmain%2Fscript_engine" target="_blank" title="https://github.com/tx7do/kratos-bootstrap/tree/main/script_engine" ref="nofollow noopener noreferrer">github.com/tx7do/krato…</a></li>
<li><code>go-scripts</code> 引擎封装代码库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftx7do%2Fgo-scripts" target="_blank" title="https://github.com/tx7do/go-scripts" ref="nofollow noopener noreferrer">github.com/tx7do/go-sc…</a></li>
<li><code>GoWind Admin</code> 官方代码库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftx7do%2Fgo-wind-admin" target="_blank" title="https://github.com/tx7do/go-wind-admin" ref="nofollow noopener noreferrer">github.com/tx7do/go-wi…</a></li>
</ul>
<p>解锁动态业务扩展能力，让你的中后台系统在快速迭代中始终保持「风行」之势。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型学习教程：RAG技术全景解析]]></title>    <link>https://juejin.cn/post/7585920796100624411</link>    <guid>https://juejin.cn/post/7585920796100624411</guid>    <pubDate>2025-12-22T03:55:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585920796100624411" data-draft-id="7586182451597918254" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型学习教程：RAG技术全景解析"/> <meta itemprop="keywords" content="Agent,LLM,程序员"/> <meta itemprop="datePublished" content="2025-12-22T03:55:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型学习教程：RAG技术全景解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:55:35.000Z" title="Mon Dec 22 2025 03:55:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读52分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote>
<p>在大语言模型基础知识一文中，检索增强生成（Retrieval-Augmented Generation，简称 RAG）技术作为构建大语言模型（Large Language Model，简称 LLM）应用的一种方式已被简要提及，本文将详细介绍RAG技术的实现流程及其演进趋势。</p>
<p>关于RAG技术更全面更系统的介绍，可以阅读以下论文：</p>
<ul>
<li>Retrieval-Augmented Generation for AI-Generated Content: A Survey[1]</li>
<li>Retrieval-Augmented Generation for Large Language Models: A Survey[2]</li>
</ul>
<h2 data-id="heading-0">1 RAG技术解析</h2>
<h3 data-id="heading-1">1.1 RAG技术的重要性</h3>
<p><strong>仅依赖LLM的局限性</strong></p>
<p>尽管LLM的参数规模与训练数据量显著增长，使其在自然语言处理任务中的能力快速提升，但模型的知识记忆能力仍受限于架构与训练范式。由于通常需要预训练数据对同一知识点进行多次曝光才能实现有效记忆，导致其记忆效率偏低，且难以全面覆盖各领域知识。</p>
<p>更核心的局限在于，LLM的性能高度依赖训练阶段接触的静态数据。这使其在处理实时更新信息（如最新科技、时事新闻）、长尾知识（即罕见或未纳入训练数据的内容）及动态变化内容时表现不佳，可能生成错误、不完整甚至虚构的信息，即出现 “幻觉” 问题。</p>
<p>此外，针对特定领域的复杂专业知识，LLM的处理效率与深度理解能力也显不足。仅依靠模型无法动态访问外部知识库，这在需依赖精确、最新信息的场景（如问答、医疗诊断、法律咨询、实时信息查询等）中尤为受限。因此，如何克服对静态数据的依赖、提升知识获取的效率与实时性、减少幻觉现象并增强领域深度理解能力，已成为当前LLM发展面临的关键挑战。</p>
<p><strong>RAG技术的诞生</strong></p>
<p>为弥补LLM单独使用时的局限性，检索增强生成技术应运而生。其核心原理是融合“检索”与“生成”：在接收用户查询时，系统先从外部大规模知识源（如文档、数据库）中动态检索相关信息片段，再将这些片段作为附加上下文输入生成模型，辅助其完成答案创作。借助这一机制，模型能够生成更精准、可靠且贴合上下文的答案，不仅大幅提升了生成内容的准确性、相关性与实时性，有效缓解了“幻觉”问题，还增强了答案的可追溯性与可信度；同时，通过动态引入最新信息源，RAG技术显著加快了知识更新效率。</p>
<p>此外，RAG技术赋予模型处理复杂任务的能力，例如串联整合多步骤推理、融合不同领域知识等。以“近期哪个品牌的新款手机拍照功能最优”这一问题为例，其可快速调取最新测评文章，并基于这些内容给出详尽解答，因此在需精准且及时信息的场景中优势显著。</p>
<p>简言之，RAG技术是一种通过融入外部知识库优化LLM性能的模式。关于RAG技术的起源可以参考RAG起源、演进与思考[3]。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af972421e6954f6790fc2dd9cfaa369b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=KB6m5kfAEVMGQUAxEDfUAaJFu3s%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.to%2Fazubuike" target="_blank" title="https://dev.to/azubuike" ref="nofollow noopener noreferrer">dev.to/azubuike</a>_alexmmaghiri_9e/revolutionizing-ai-with-retrieval-augmented-generation-rag-architectures-workflows-and-9c4</p>
<p><strong>RAG技术的应用场景</strong></p>
<p>RAG技术的核心优势在于整合信息检索与文本生成能力，有效突破了LLM在时效性与准确性不足等固有局限，凭借这一核心优势，其应用已延伸至智能问答、文本摘要、对话系统、教育培训、知识增强型问答与推理、个性化推荐及决策支持等多个领域。典型如：</p>
<ul>
<li>在企业知识库管理中，可快速定位内部文档中的关键信息并生成结构化解读，提升团队协作效率；</li>
<li>在金融领域，能实时整合市场动态、政策变动等数据，为投资分析提供基于多源信息的趋势预判；</li>
<li>在客服场景中，可结合用户历史交互记录与产品知识库，生成贴合需求的精准回复，优化服务体验；</li>
<li>在科研领域，助力研究者整合跨学科文献、实验数据，生成具有针对性的研究思路与文献综述框架。</li>
</ul>
<p>随着LLM的兴起，以RAG技术为核心驱动力的新一代智能搜索系统迅猛发展，深刻重塑着信息获取模式。与传统搜索引擎不同，微软Bing Chat、百度文心一言等基于RAG的系统，不仅能更智能地理解用户意图，更能提供高度个性化、上下文关联的交互体验，其角色也从单纯的信息检索工具，演进为可直接输出经信息整合与分析的精确答案的智能系统。</p>
<h3 data-id="heading-2">1.2 RAG系统简介</h3>
<p><strong>RAG系统工作流程概览</strong></p>
<p>RAG系统的核心在于检索与生成流程的深度融合，其核心逻辑是通过动态引入外部知识，大幅提升输出内容的准确性与相关性。具体工作流程以用户查询为起点：首先，检索模块借助向量检索等技术，将用户查询转化为向量形式，从文档库、知识图谱或搜索引擎等外部知识源中快速定位、筛选并提取高度相关的信息片段；随后，以LLM为基础的生成模块会整合查询内容与检索到的上下文信息，经推理、整合与重组，最终生成连贯且精准的答案。</p>
<p>例如，当用户询问“2024年夏季奥运会的举办城市是哪里，有哪些特色比赛项目？”时，RAG系统会率先检索2024年奥运会的相关资料，获取举办城市为巴黎，以及新增的冲浪、滑板等特色项目，还有巴黎奥运会在塞纳河举办公开水域比赛等信息。接着，将这些信息整合，生成“2024年夏季奥运会的举办城市是法国巴黎。该届奥运会新增了冲浪、滑板等深受年轻人喜爱的项目”的回答。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/088e65d15c39486ca40a67905eab6c43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=swsg9ERcLFMzRdVlxK2HgX3aurc%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2402.19473" target="_blank" title="https://arxiv.org/abs/2402.19473" ref="nofollow noopener noreferrer">arxiv.org/abs/2402.19…</a></p>
<p><strong>基础的RAG系统</strong></p>
<p>为清晰阐述RAG系统的基本原理与实现逻辑，本部分聚焦其核心流程（检索+生成）的简化模型展开说明。</p>
<p>RAG系统的核心机制是在生成答案前，先从知识库中检索相关信息，再以这些信息为依据引导生成过程。这一机制带来多重优势：既能显著提升结果的准确性与相关性，有效缓解模型幻觉问题；又能通过仅更新知识库即可纳入新知识（无需重新训练模型），实现快速迭代；同时增强结果可追溯性，大幅提升大模型应用的可靠性与实用性。基础RAG系统更加详细介绍可以参考：RAG到底咋工作的[4]。</p>
<p>一个基础的RAG系统通过以下核心模块协同实现上述流程：</p>
<ol start="0">
<li>文档处理模块：负责加载文章、书籍、对话、代码等各类原始文本，并将其切分为便于处理的片段。切分通常以句子为单位，且会特意保留片段间的部分重叠内容。此举可避免语义被生硬割裂，从而提高后续检索准确性。</li>
<li>向量编码器：借助Embedding模型将文本片段转化为向量。通俗而言，就是将文字“翻译”为计算机可理解的数字向量，使文本语义转化为可计算的数值特征。</li>
<li>向量数据库：作为专门存储文档片段及其对应向量的载体，在文本切分与向量编码完成后，会集中存储这些数据，为后续快速检索奠定基础。</li>
<li>检索器：作为连接用户查询与数据库的“桥梁”，接收用户查询（Query）后，通过计算查询向量与数据库中向量的相似度，快速定位最相关的文档片段。</li>
<li>LLM：以检索到的相关文档片段为上下文，结合自身语言理解能力生成贴合用户需求的自然语言答案，最终实现“基于事实的智能回答”。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/692772bd61454d62b607d4168359a5f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=EjxSAaYxePSuv7FI4cU1ZoG6M0U%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2312.10997v5" target="_blank" title="https://arxiv.org/abs/2312.10997v5" ref="nofollow noopener noreferrer">arxiv.org/abs/2312.10…</a></p>
<p>上述模块的协作可梳理为RAG的基础流程，即索引、检索、生成三个核心环节，各环节与模块的对应关系如下：</p>
<ol start="0">
<li>索引：借助文档处理模块、向量编码器、向量数据库，将文档库分割为较短片段，再通过编码器构建向量索引。</li>
<li>检索：依托上述三者，根据问题与片段的相似度检索相关文档片段。</li>
<li>生成：由LLM以检索到的上下文为条件，生成问题的回答。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4216f0c88d934d9aa7ddd0fe0f5b5030~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=9VFhRxlhfLcDvv2jmqlW0h0YxUg%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.dailydoseofds.com%2Fp%2F5-chunking-strategies-for-rag%3Fref%3Ddailydoseofds.com" target="_blank" title="https://blog.dailydoseofds.com/p/5-chunking-strategies-for-rag?ref=dailydoseofds.com" ref="nofollow noopener noreferrer">blog.dailydoseofds.com/p/5-chunkin…</a></p>
<h3 data-id="heading-3">1.3 RAG系统工作流程详细介绍</h3>
<p>本节主要在1.2节基础上详细介绍RAG系统的工作流程，相关内容更加详细的介绍可以见：16 Techniques to Supercharge and Build Real-world RAG Systems[5]。</p>
<p>1.文本分段</p>
<p>文档处理模块首先将外部文档拆分为文本片段，目的是避免因文档过长导致的检索效率低、语义理解受限、资源浪费、生成质量下降及歧义风险增加等问题。合理分段是保障后续检索上下文有效性的前提。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f784d57cb9624fb2bd02eca14c42b58d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=z0sDqD0gimY37g3g0t10qZ3UGOw%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.dailydoseofds.com%2F16-techniques-to-supercharge-and-build-real-world-rag-systems-part-1%2F" target="_blank" title="https://www.dailydoseofds.com/16-techniques-to-supercharge-and-build-real-world-rag-systems-part-1/" ref="nofollow noopener noreferrer">www.dailydoseofds.com/16-techniqu…</a></p>
<ol start="2">
<li>文本片段向量化</li>
</ol>
<p>完成文本分段后，借助向量编码器将各文本片段转化为语义向量。目前主流的做法是采用Transformer模型，其强大的上下文理解能力，正是生成高质量语义向量的关键。关于文本向量的提取方法，可参考文章：Bi-encoders and Cross-encoders for Sentence Pair Similarity Scoring[6]。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0906e629cb994648883c39ee97e4db9f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=UTKcSOCVRQDeD%2FO3BDVEx31QXcw%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.dailydoseofds.com%2F16-techniques-to-supercharge-and-build-real-world-rag-systems-part-1%2F" target="_blank" title="https://www.dailydoseofds.com/16-techniques-to-supercharge-and-build-real-world-rag-systems-part-1/" ref="nofollow noopener noreferrer">www.dailydoseofds.com/16-techniqu…</a></p>
<ol start="3">
<li>向量存储与知识库构建</li>
</ol>
<p>将文本向量存入向量数据库，数据库通过关联存储原始内容与对应向量构建外部知识文本库。作为RAG的知识存储层，向量数据库聚合各类知识，为查询响应提供精准依据。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00b4a6703d09474a9c9e1a9d24b89403~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=eRTsXSAZLSA8fvM3Xrch%2BfgjPTQ%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.dailydoseofds.com%2F16-techniques-to-supercharge-and-build-real-world-rag-systems-part-1%2F" target="_blank" title="https://www.dailydoseofds.com/16-techniques-to-supercharge-and-build-real-world-rag-systems-part-1/" ref="nofollow noopener noreferrer">www.dailydoseofds.com/16-techniqu…</a></p>
<ol start="4">
<li>用户查询向量化</li>
</ol>
<p>用户输入查询文本（query）后，系统使用与构建知识库时一致的向量编码器将其转化为向量，确保语义空间一致性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00bd8add6a3b44b8bb802724f5add87e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=1b1qLZhfun6qfB3rwb45AlMLqng%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.dailydoseofds.com%2F16-techniques-to-supercharge-and-build-real-world-rag-systems-part-1%2F" target="_blank" title="https://www.dailydoseofds.com/16-techniques-to-supercharge-and-build-real-world-rag-systems-part-1/" ref="nofollow noopener noreferrer">www.dailydoseofds.com/16-techniqu…</a></p>
<ol start="5">
<li>相似片段检索</li>
</ol>
<p>检索器通过比对查询向量与数据库中存储的文本向量，定位相似度最高的信息。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb7806ab8fcc4fc99f40b7039bda3483~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=ejQzhkE7eCgDnKYFUYrLw1PtYUM%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.dailydoseofds.com%2F16-techniques-to-supercharge-and-build-real-world-rag-systems-part-1%2F" target="_blank" title="https://www.dailydoseofds.com/16-techniques-to-supercharge-and-build-real-world-rag-systems-part-1/" ref="nofollow noopener noreferrer">www.dailydoseofds.com/16-techniqu…</a></p>
<p>实际应用中，检索器通过近似最近邻搜索返回前k个（topk）最相似片段，这是因为复杂查询常关联多个相关内容，多结果能避免关键信息遗漏，为响应生成提供全面依据。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/170337bf91f74913b4ab004dceed526c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=ygIgqz%2FSLgZb%2BOsAw3PQ%2B%2F9VLHo%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.dailydoseofds.com%2F16-techniques-to-supercharge-and-build-real-world-rag-systems-part-1%2F" target="_blank" title="https://www.dailydoseofds.com/16-techniques-to-supercharge-and-build-real-world-rag-systems-part-1/" ref="nofollow noopener noreferrer">www.dailydoseofds.com/16-techniqu…</a></p>
<ol start="6">
<li>文本片段重排序</li>
</ol>
<p>检索完成后，需进一步处理挑选出的文档片段，将相关性最高的文本段落置于最前，这一过程称为重排序。此步骤通常使用Reranker模型，这类模型多为交叉编码器，会评估查询与各候选段落的相关性并给出精确相关度分数，随后依分数重新排序，将最相关段落置于前列，便于生成模型优先选用。</p>
<p>这样做能提升后续生成内容的准确性和针对性，不过并非所有RAG应用都包含此步骤。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a699ebfdcbb4851bad31f00c52c9113~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=xm0MI6pzYFuM4g1y0jHCBjw9tbk%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.dailydoseofds.com%2F16-techniques-to-supercharge-and-build-real-world-rag-systems-part-1%2F" target="_blank" title="https://www.dailydoseofds.com/16-techniques-to-supercharge-and-build-real-world-rag-systems-part-1/" ref="nofollow noopener noreferrer">www.dailydoseofds.com/16-techniqu…</a></p>
<ol start="7">
<li>生成回答</li>
</ol>
<p>将用户原始查询与检索到的文本片段整合为提示模板，输入至LLM。模型以文本片段为上下文，生成既融合文档信息、又具备连贯性和相关性的回答，直接回应用户查询。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd466cde49414810aca47e65ad2e4720~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=yXp%2BCe7jPb%2Febdp1I65UN5vZdHg%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.dailydoseofds.com%2F16-techniques-to-supercharge-and-build-real-world-rag-systems-part-1%2F" target="_blank" title="https://www.dailydoseofds.com/16-techniques-to-supercharge-and-build-real-world-rag-systems-part-1/" ref="nofollow noopener noreferrer">www.dailydoseofds.com/16-techniqu…</a></p>
<h2 data-id="heading-4">2 RAG技术演进趋势和常见问题</h2>
<h3 data-id="heading-5">2.1 RAG技术优化与演进趋势</h3>
<h4 data-id="heading-6">2.1.1 RAG技术增强路径</h4>
<p>随着LLM的迅猛发展，RAG技术同步进入快速演进阶段。目前，已有大量研究与实践从多维度切入。下面将从增强阶段、增强来源和增强过程三个方面，介绍现有技术如何通过多样化手段提升RAG的检索精度并优化运行效率。</p>
<p><strong>增强阶段</strong></p>
<p>从技术增强的阶段特性来看，LLM在预训练、微调和推理环节的优化方式具体如下：</p>
<ul>
<li>Pre-training（预训练阶段）：引入检索增强机制，强化模型对外部知识的融合能力</li>
<li>Fine-tuning（微调阶段）：依托检索优化手段，提升模型对特定任务的适配性能</li>
<li>Inference（推理阶段）：通过动态检索知识辅助生成过程，这也是RAG技术最核心的应用场景</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f303b2ac049940dd82060d4967e1d543~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=xboNx6WnLbB5grmkOTltbkuVPZM%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2312.10997v4" target="_blank" title="https://arxiv.org/abs/2312.10997v4" ref="nofollow noopener noreferrer">arxiv.org/abs/2312.10…</a></p>
<p><strong>增强来源</strong></p>
<p>在RAG技术中，增强来源指通过外部数据弥补模型固有缺陷的信息渠道，主要包括三类：</p>
<ol start="0">
<li>非结构化数据（天然文本形式，如文章、小说）</li>
</ol>
<ul>
<li>定义：无固定格式的文本内容，涵盖新闻、论文、小说、网页段落等。</li>
<li>示例：</li>
</ul>

<ul>
<li>模型预训练时学习的百科“李白生平”纯文字词条；</li>
<li>推理阶段检索的问答网站“如何评价李白”的散文式用户回答。</li>
</ul>

<ul>
<li>特点：人类可直接阅读，但提取关键信息需“大海捞针”（例如从一篇论文中定位某句话）。</li>
</ul>
<ol start="2">
<li>结构化数据（规整格式呈现，如表格、数据库）</li>
</ol>
<ul>
<li>定义：格式明确的数据形态，包括Excel表格、数据库表、知识图谱（含节点与关系）等。</li>
<li>示例：</li>
</ul>

<ul>
<li>模型预训练时学习的“中国诗人朝代表”（表格中包含“姓名-朝代-代表作”字段）；</li>
<li>推理时查询知识图谱中“李白→好友→杜甫”的关联关系。</li>
</ul>

<ul>
<li>特点：数据排列规整，可精准提取信息（如直接获取表格中的“李白生卒年”），但要求模型具备解析格式的能力（如表格解析能力）。</li>
</ul>
<ol start="3">
<li>LLM生成内容（模型实时生成的思考草稿）</li>
</ol>
<ul>
<li>定义：模型在推理过程中临时产生的文本（非外部现成信息，属于思考阶段的动态产物）。</li>
<li>示例：</li>
</ul>

<ul>
<li>回答“李白与杜甫的关系”时，模型先自主生成假设：“他们是好友，杜甫曾作《赠李白》”（此为模型实时构思的内容）；</li>
<li>随后以该假设为线索，检索《杜工部集》中的诗句进行验证。</li>
</ul>

<ul>
<li>特点：具备动态性与灵活性（模型边思考边生成），但可能存在误差（如假设错误需通过检索修正）。</li>
</ul>
<p>一句话总结差异：</p>
<ul>
<li>非结构化数据与结构化数据：借助外部现成的“知识储备”（他人撰写的文章、表格等）；</li>
<li>LLM生成内容：借助自身临时的“脑暴草稿”（模型推理中动态生成的内容，用作检索线索）。</li>
</ul>
<p><strong>增强过程</strong></p>
<p>增强过程指模型通过检索知识辅助生成内容的机制，核心在于检索策略的逻辑设计，具体包括以下几类：</p>
<ol start="0">
<li>一次检索（Once Retrieval）</li>
</ol>
<ul>
<li>定义：针对问题仅执行单次检索，直接用结果生成答案。</li>
<li>类比：查字典时只翻一次页码，不论解释是否准确便直接引用。</li>
<li>特点：操作简单、效率高，但可能因检索结果不全或问题需多维度知识而遗漏信息。</li>
</ul>
<ol start="2">
<li>迭代检索（Iterative Retrieval）</li>
</ol>
<ul>
<li>定义：基于首次生成的内容反复检索补充知识，逐步优化答案。</li>
<li>类比：写作文时先列大纲（首次生成），发现“李白的好友”仅提及杜甫，便再查高适、王昌龄等资料（迭代检索）以补充内容。</li>
<li>特点：形成“生成→反馈→再检索”的循环，类似“游戏中复活后继续闯关”。</li>
</ul>
<ol start="3">
<li>自适应检索（Adaptive Pattern）</li>
</ol>
<ul>
<li>定义：根据任务类型或生成状态动态调整检索策略，例如切换数据库、调整检索范围等。</li>
<li>类比：玩游戏时，遇“历史题”切换至历史数据库，遇“数学题”切换至公式库；或发现生成内容模糊时，扩大检索范围。</li>
<li>特点：灵活性强，如同“智能切换武器”，但需模型具备判断“何时使用何种策略”的能力。</li>
</ul>
<ol start="4">
<li>递归检索（Recursive Retrieval）</li>
</ol>
<ul>
<li>定义：将复杂问题拆解为子问题，逐层递归检索，像“俄罗斯套娃”般深入探究。</li>
<li>类比：破案时，先查“李白的死因”（主问题），拆解为“李白晚年健康状况”（子问题1），再拆解为“唐朝医疗水平”（子问题2），每层均进行检索。</li>
<li>核心逻辑：遵循“问题→拆解→子检索→再拆解→深层检索”的路径，与递归函数思路一致。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e1717c1aad44211851d192db95ded15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=I1%2BkZVGi6ScefsidfLE8SagNfQM%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2312.10997v4" target="_blank" title="https://arxiv.org/abs/2312.10997v4" ref="nofollow noopener noreferrer">arxiv.org/abs/2312.10…</a></p>
<p>总之，RAG发展的三大关键技术包括增强阶段、数据来源及处理过程，这三大技术能够清晰呈现RAG核心组件的分类体系，同时RAG的实现模式也在不断演变。早期的RAG可能只是 “简单检索+直接生成” 的模式，而随着技术进步，其实现中已融入更复杂的环节，这些具体实现方法始终处于动态变化中，愈发精细且能更好地适配不同场景。</p>
<p>搭建RAG系统时，技术选型的应该以需求适配为导向，兼顾效果的评估与优化，选择能高效支撑目标场景且表现更优的方案。关于RAG系统的构建和技术选型可以参考：文章<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzIyNTA3NDY2NQ%3D%3D%26mid%3D2247487604%26idx%3D1%26sn%3D38ef1ad966a816275f47cf4e28f80d2f%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzIyNTA3NDY2NQ==&amp;mid=2247487604&amp;idx=1&amp;sn=38ef1ad966a816275f47cf4e28f80d2f&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">17种RAG架构实现原理与选型</a>或参考下一节内容。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff99103122194482a685093d129675b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=FO%2B8d6eEYgooMlp9s2FCu4HVgf0%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.abacus.ai%2Fblog%2F2023%2F08%2F10%2Fcreate-your-custom-chatgpt-pick-the-best-llm-that-works-for-you%2F" target="_blank" title="https://blog.abacus.ai/blog/2023/08/10/create-your-custom-chatgpt-pick-the-best-llm-that-works-for-you/" ref="nofollow noopener noreferrer">blog.abacus.ai/blog/2023/0…</a></p>
<h4 data-id="heading-7">2.1.2 RAG系统实现模式的演化</h4>
<p>实现高效文档检索需要解决三大核心问题：</p>
<ol start="0">
<li>构建精确的语义表示，确保文档和查询的嵌入能准确捕捉其含义。</li>
<li>对齐查询与文档的语义空间，缩小检索模型理解的查询意图与文档实际内容之间的语义鸿沟。</li>
<li>适配检索器输出与LLM偏好，使检索到的上下文信息更符合下游大型语言模型的生成需求。</li>
</ol>
<p>为应对上述挑战，在RAG架构之上引入了检索前优化和检索后优化的策略。</p>
<ol start="0">
<li>检索前优化，提升索引质量如文档切分粒度优化、元数据增强和查询处理如语义转换、关键词扩展，旨在改善检索相关性。</li>
<li>检索后优化，对检索结果进行过滤、去冗余、重排序按重要性和信息压缩整合，确保输入LLM的上下文信息更精炼相关。</li>
</ol>
<p>基于优化策略的应用深度，当前RAG研究形成了三种主要范式：</p>
<ol start="0">
<li>基础RAG（Naive RAG）</li>
</ol>
<ul>
<li>检索质量低，导致检索结果不精准不全面。</li>
<li>生成质量受限，LLM易产生幻觉，难以有效融合检索到的上下文与当前生成任务。</li>
<li>信息冗余与风格冲突，检索结果常包含重复冗余信息，且不同来源文本风格语气不一致，影响生成连贯性。</li>
<li>过度依赖风险，LLM可能过度依赖有时不准确的检索信息。</li>
<li>遵循基础流程索引、检索、生成。</li>
<li>主要痛点：</li>
</ul>
<ol start="2">
<li>进阶RAG（Advanced RAG）</li>
</ol>
<ul>
<li>通过强化检索前和检索后优化的流程，并改进索引如滑动窗口、细粒度分割、元数据利用，以解决基础RAG的缺陷。</li>
<li>检索前优化：包括数据粒度优化、索引结构调整、元数据注入、向量对齐、混合检索如结合稀疏与稠密检索等。</li>
<li>检索核心：依赖嵌入模型计算查询与文档块的相似度。</li>
<li>检索后优化：采用重排序和提示压缩技术，克服上下文窗口限制，提炼关键信息。</li>
<li>潜在挑战：以复杂度换效果，提升了基础RAG性能，但其额外模块的引入也带来了效率、泛化性和可维护性的新挑战。</li>
</ul>
<ol start="3">
<li>模块化RAG（Modular RAG）</li>
</ol>
<ul>
<li>提升信息效率与质量，整合多种检索技术，优化检索步骤如引入认知回溯机制，实施多样化查询策略，有效利用嵌入相似性。</li>
<li>支持复杂交互，模块化设计便于处理迭代检索与多轮生成，如对回溯提示的响应。</li>
<li>强调框架的高度灵活性与适应性，可将RAG流程拆解为可替换可重组的模块，以解决特定问题。</li>
<li>优化方向：</li>
<li>潜在挑战：当LLM对主题知识匮乏时，依赖检索信息可能导致错误率上升。</li>
</ul>
<p>事实上除了这三种RAG范式，还有其他更多的范式，具体可参考：一篇搞明白RAG的几种不同类型[7]。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24d6fd434ed1452292cb21288ddc03f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=kw0lmJ67SN4UMcM5XpSErMAffnU%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2312.10997v5" target="_blank" title="https://arxiv.org/abs/2312.10997v5" ref="nofollow noopener noreferrer">arxiv.org/abs/2312.10…</a></p>
<p>总之，RAG技术及其构成体系具有较强的复杂性，涵盖知识获取、数据预处理、索引构建、检索策略优化、生成模型调优等多个环节。对于应用层面者而言，优先聚焦于检索模块的精准性提升（如向量数据库选型、相似度算法优化）与生成模块的语义连贯性构建（如提示词工程、大模型适配）这两大核心基础，是快速掌握技术应用逻辑的有效路径。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2418a5255a147f3925c93f76c72681c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=JNNu3Iv1mUIirQ2wKA3liqFRmMQ%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2312.10997v5" target="_blank" title="https://arxiv.org/abs/2312.10997v5" ref="nofollow noopener noreferrer">arxiv.org/abs/2312.10…</a></p>
<h3 data-id="heading-8">2.2 RAG技术典型问题与优化方案</h3>
<h4 data-id="heading-9">2.2.1 RAG技术常见问题及解决办法</h4>
<p>本节主要介绍RAG技术的常见问题及相应解决办法，更详细的内容可参考文章Traditional RAG vs. HyDE[8]。</p>
<ol start="0">
<li>问题与答案语义不匹配</li>
</ol>
<p>检索到的文档可能与问题无关，甚至无关文档的余弦相似度可能高于含答案的文档。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8593413ba0a545188e6da035d0dbcf8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=9AKfhqbFX2VDZUN1jezEEW5yrzc%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.dailydoseofds.com%2Fp%2Ftraditional-rag-vs-hyde" target="_blank" title="https://blog.dailydoseofds.com/p/traditional-rag-vs-hyde" ref="nofollow noopener noreferrer">blog.dailydoseofds.com/p/tradition…</a></p>
<p>一种优化方案为：先用LLM针对问题生成假设答案，弥补表述模糊以明确语义指向；再将问题与假设答案转化为文本向量，通过向量拼接或加权求和等方式；最后用该文本向量查询向量数据库，提升匹配精度。</p>
<p>例如，对于问题“需要适合新手，考虑学习难度低，入门成本适中，便于携带的入门乐器”，LLM可生成假设答案以明确指向；再结合该问题与假设答案的语义向量查询数据库，就能精准匹配到“尤克里里学习难度低，入门成本低，体积小便于携带，适合新手入门”这类结果。</p>
<p>需注意这种方法只能在一定程度上减轻问题影响，无法完全消除问题本身的局限性。</p>
<ol start="2">
<li>语义相似性可能被弱化</li>
</ol>
<p>部分含重要信息的长文本常夹杂背景描述、细节补充等无关内容，会稀释核心信息。如同糖水加水后味道变淡，导致RAG计算语义相似度时，与搜索内容的匹配度下降。反观短文本，即便内容不重要，若含少量相关词，因干扰少且相关词集中，与搜索内容的相似度反而更高。最终可能导致系统输出无关信息或遗漏关键信息，影响整体效果。</p>
<p>采用文本摘要或关键句抽取技术预处理长文档，同步进行精准分段、冗余清洗与核心内容提取，仅将浓缩后的核心信息存入语义向量库，再结合优化的检索策略精准匹配相关片段，是应对该问题的有效方法。</p>
<ol start="3">
<li>检索文档的关注偏差</li>
</ol>
<p>基于相似性搜索从数据库检索文档时，通常按相似性度量排序，但LLM基于这些文档生成回答时，虽能通过位置编码明确感知输入顺序，其关注重点却不遵循人类“前序优先”的主观倾向，而是由注意力机制与上下文长度共同决定，短上下文时处理更均匀，长上下文则因“注意力稀释”更关注首尾文档。若高相似文档因位置靠后被忽略，会造成“检索优质但利用低效”，最终降低回答质量。</p>
<p>例如问“缓解颈椎痛的好办法”，数据库检索出6篇文档，按相似性从高到低排序，第4篇最相关，写了具体的穴位按摩法，第1篇只说“别久坐”。LLM处理这6篇长上下文时，注意力稀释，主要关注首尾，未太关注第4篇，最终回答只提“别久坐”，遗漏了最有效的穴位按摩法。明明检索到了优质信息却没用好，回答自然不够好。</p>
<p>应对方案可采用“关键文档首尾双曝光”策略：将检索结果中最相关的文档交替置于输入序列的头部和尾部，如复制最关键的1-3篇文档到首尾位置；利用LLM在长上下文中天然关注首尾的“注意力锚点效应”，首尾信息稀释度最低；确保高价值内容不被中间位置淹没，同时辅以文档内容浓缩，通过摘要压缩文本减少冗余干扰，以及显式指令引导，在输入中标注“请重点参考以下高相关文档”。三重措施协同突破注意力稀释瓶颈，显著提升优质检索结果的利用率。</p>
<ol start="4">
<li>需避免询问需整合全局信息的问题</li>
</ol>
<p>使用RAG系统时，需避免需要全局信息汇总的问题，这类问题需整合大量分散数据，而RAG系统依赖的相似性搜索通常只能定位少数最相关文档，难以覆盖全部必要信息源，导致答案常出错。若答案集中在一两份文档中，相似性搜索精准高效，RAG系统表现良好，但若答案需遍历所有文档、聚合分散信息，相似性搜索则力不从心。本质上，RAG系统是检索增强工具，而非全局数据聚合器，处理跨文档汇总和统计类问题时存在天然局限。</p>
<p>在RAG系统中缓解全局汇总问题，核心是结合混合检索向量+关键词提升覆盖度，并通过查询分解让RAG系统分步处理子问题，最后聚合结果。若需强统计能力，需整合传统数据库执行聚合计算。</p>
<h4 data-id="heading-10">2.2.2 RAG系统固有挑战</h4>
<p>除上述问题外，RAG系统还存在以下固有挑战：</p>
<ol start="0">
<li>检索效率与延迟问题：面对百万级文档等大规模知识库时，检索易产生高延迟，难以满足实时交互需求。</li>
<li>对知识库质量的高度依赖：生成结果直接受检索内容影响。若知识库存在数据过时、信息不完整或包含噪声等问题，会导致输出错误；同时，在小众领域等未覆盖场景中，其领域适应性较差。</li>
<li>上下文窗口限制：受生成模型上下文窗口容量所限，检索到的长文档可能被截断，造成关键信息丢失。</li>
<li>生成与检索的协同问题：</li>
</ol>
<ul>
<li>模型可能忽略检索结果，仅依赖自身参数生成错误信息（即"检索无用"）；</li>
<li>或过度依赖检索内容，机械复制片段而缺乏逻辑整合。</li>
</ul>
<ol start="5">
<li>评估体系缺失：目前缺乏统一的量化指标来评估检索与生成的协同效果，人工评估成本高且难以标准化，阻碍了模型迭代优化。</li>
</ol>
<p>RAG的这些固有挑战，源于检索与生成这两个复杂系统的耦合，其中涉及算法、数据及工程等多方面的权衡。由于目前这些挑战尚无法完全解决，因此在使用RAG技术时需要加以考量。关于这些固有挑战的详细介绍，可参考论文：Seven Failure Points When Engineering a Retrieval Augmented Generation System[9]。</p>
<h4 data-id="heading-11">2.2.3 RAG技术与模型指令微调的对比</h4>
<p>在构建LLM应用时，除了RAG技术，模型指令微调也是一种被广泛采用的技术路径。关于这两种技术的详细对比，可以参考文章Full-model Fine-tuning vs. LoRA vs. RAG[10]。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b02cfa8628146ecbc37abcc6521348e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=k8ucCA0f85WWN4s2VmBF7o9n8ZU%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.dailydoseofds.com%2Fp%2Ffull-model-fine-tuning-vs-lora-vs" target="_blank" title="https://blog.dailydoseofds.com/p/full-model-fine-tuning-vs-lora-vs" ref="nofollow noopener noreferrer">blog.dailydoseofds.com/p/full-mode…</a></p>
<p>对比内容概览如下：</p>
<ol start="0">
<li>基础机制与数据需求</li>
</ol>
<ul>
<li>RAG ：通过检索外部知识库（文档、数据库等）获取信息，结合生成模型输出答案；无需修改模型参数，依赖知识库质量，无需标注训练数据。</li>
<li>指令微调 ：在特定标注数据集上调整预训练模型参数，适配特定任务/领域；需高质量标注数据，直接修改模型参数。</li>
</ul>
<ol start="2">
<li>更新机制与成本</li>
</ol>
<ul>
<li>RAG ：支持实时更新知识库，模型无需重新训练；仅涉及检索+生成，推理成本低。</li>
<li>指令微调 ：知识更新需重新微调或增量训练，成本高（依赖GPU资源）；无检索步骤，推理速度快。</li>
</ul>
<ol start="3">
<li>优势与局限</li>
</ol>
<ul>
<li>RAG ： ✅ 优势：灵活适应新知识、降低幻觉风险（依赖权威数据源）、无需训练数据。 ❌ 局限：检索延迟可能影响响应速度、依赖知识库质量、生成逻辑受限于检索片段。</li>
<li>指令微调 ： ✅ 优势：输出风格可控、领域内任务性能更优、推理速度快（无检索步骤）。 ❌ 局限：数据不足时易过拟合、知识更新需重新训练、可能产生事实性幻觉。</li>
</ul>
<ol start="4">
<li>适用场景与典型应用</li>
</ol>
<ul>
<li>RAG ：适用于知识密集型任务（需动态/领域外知识），如开放域问答、医疗咨询、产品文档客服。</li>
<li>指令微调 ：适用于需特定输出风格或领域专精的任务，如代码生成、情感分析、法律文本生成、专业术语翻译。</li>
</ul>
<ol start="5">
<li>技术代表</li>
</ol>
<ul>
<li>RAG ：FAISS + GPT、DPR + BART</li>
<li>指令微调 ：LoRA、Adapter、全参数微调</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be2f31b2a22240e4a4d71fa4db126a1e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980534&amp;x-signature=2xAWqOTCfkbGwfrx%2B8DV%2BmAqzgs%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2312.10997v5" target="_blank" title="https://arxiv.org/abs/2312.10997v5" ref="nofollow noopener noreferrer">arxiv.org/abs/2312.10…</a></p>
<h2 data-id="heading-12">3 实战</h2>
<h3 data-id="heading-13">3.1 RAG系统示例代码</h3>
<p>本文第一章已详细阐述了RAG系统的基本工作流程，其核心环节涵盖：文本分段、文本片段向量化、向量存储与知识库构建、用户查询向量化、相似片段检索、文本片段重排序以及生成回答。 为了更好地解释RAG模型的原理和实现，本章将提供完整的示例代码，系统性地演示如何实现上述各个环节，从而构建一个可运行的最小化RAG应用系统。该部分内容参考自：Happy-LLM[11]。</p>
<p>下面将介绍该示例各部分代码。所有代码需放在同一文件夹中，<strong>最后一个模块，即生成回答的代码为运行入口。请注意，代码中使用的均为基础版模型</strong>。</p>
<p>若回答效果欠佳，可能源于多方面因素：文档分块不合理、向量提取模型对领域语义捕捉不足、检索策略未返回最相关上下文、大语言模型对检索内容利用不充分，或测试文件与问题相关性低、对话历史累积造成干扰等。这些环节都会影响最终回答的准确性和针对性。实际搭建RAG系统可参考本文3.2节内容</p>
<p><strong>0. 生成示例数据</strong></p>
<p>这段代码文件是一个用于生成RAG系统测试文件的Python脚本，主要功能是创建几个包含特定内容的文本文件，注意输出文件都为txt格式。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Generate.py  </span>
<span class="hljs-keyword">import</span> os  
  
defgenerate_rag_test_files(folder_name:<span class="hljs-built_in">str</span> =<span class="hljs-string">"rag_test_files"</span>):  
<span class="hljs-string">"""生成RAG测试文件并保存到指定文件夹"""</span>  
<span class="hljs-comment"># 创建存放文件的文件夹  </span>
ifnot os.path.exists(folder_name):  
        os.makedirs(folder_name)  
  
<span class="hljs-comment"># 定义文件内容  </span>
    planets_content = <span class="hljs-string">"""太阳系行星基础知识  
  
1. 水星（Mercury）  
- 位置：距离太阳最近的行星（约0.39天文单位）  
- 特征：表面布满陨石坑，没有大气层保护，昼夜温差极大（白天约430℃，夜晚约-180℃）  
- 自转周期：58.6地球日，公转周期：88地球日  
  
2. 金星（Venus）  
- 位置：距离太阳第二近（约0.72天文单位）  
- 特征：被浓密的二氧化碳大气层覆盖，产生强烈温室效应，表面温度约467℃（太阳系中最热的行星）  
- 特殊点：自转方向与其他行星相反（自东向西），自转周期243地球日，公转周期225地球日  
  
3. 地球（Earth）  
- 位置：距离太阳第三近（约1天文单位）  
- 唯一已知存在液态水和生命的行星，大气层以氮和氧为主  
- 自转周期23小时56分，公转周期365.24天  
  
4. 火星（Mars）  
- 位置：距离太阳第四近（约1.52天文单位）  
- 特征：表面呈红色（因富含氧化铁），有稀薄的二氧化碳大气层，存在极地冰盖（主要是干冰和水冰）  
- 地标：奥林匹斯山（太阳系最高山峰，约21千米）、水手谷（长约4000千米的峡谷）  
  
5. 木星（Jupiter）  
- 位置：距离太阳第五近（约5.2天文单位）  
- 特征：太阳系中最大的行星（质量是其他所有行星总和的2.5倍），由氢和氦组成，表面有明显的条纹和“大红斑”（持续数百年的风暴）  
- 卫星：已知有95颗卫星，其中最大的4颗是“伽利略卫星”（木卫一至木卫四）  
"""</span>  
  
    purifier_content = <span class="hljs-string">"""家用空气净化器（型号：CleanAir X5）使用指南  
  
一、核心功能  
1. 净化范围：适用面积20-30㎡（密闭空间）  
2. 过滤系统：  
   - 初级滤网：拦截毛发、灰尘等大颗粒  
   - HEPA滤网：过滤PM2.5、花粉、细菌（效率99.97%@0.3μm）  
   - 活性炭滤网：吸附甲醛、TVOC等有害气体  
3. 运行模式：  
   - 自动模式：根据内置传感器检测的空气质量自动调节风速  
   - 睡眠模式：风速最低，噪音≤30分贝，适合夜间使用  
  
二、操作步骤  
1. 首次使用：  
   - 拆除滤网外层的塑料包装（否则会影响净化效果）  
   - 连接电源，按机身“电源键”开机（默认进入自动模式）  
2. 更换滤网提示：  
   - 当机身“滤网指示灯”亮起时，需更换对应滤网（HEPA滤网建议6-8个月更换一次，活性炭滤网建议3-4个月更换一次）  
   - 更换方法：打开机器背部面板，取出旧滤网，按标识方向装入新滤网  
  
三、注意事项  
1. 避免在潮湿环境（如浴室）使用，以免滤网受潮发霉  
2. 长期不使用时，需断开电源并清洁机身表面  
3. 若出现异响或净化效果下降，检查是否滤网安装错误或风扇故障  
"""</span>  
  
    reimbursement_content = <span class="hljs-string">"""HelloWorld公司员工报销流程指南（2024版）  
  
一、可报销费用类型  
1. 差旅费用：  
   - 包含：交通（机票/高铁票需提供行程单）、住宿（需提供酒店发票和住宿清单）、市内交通（地铁/打车票，单日上限200元）  
   - 标准：一线城市住宿上限800元/晚，二线城市600元/晚  
2. 办公采购：  
   - 需提前在OA系统提交“采购申请单”，审批通过后凭发票报销（单笔超过5000元需走对公转账）  
3. 业务招待：  
   - 需注明招待对象、事由，单次招待金额超过2000元需部门总监审批  
  
二、报销流程步骤  
1. 收集凭证：保留所有费用的原始发票（电子发票需打印纸质版并签字）  
2. 提交申请：在OA系统“报销模块”填写报销单，上传发票照片并关联对应项目编号  
3. 审批环节：  
   - 单笔≤1000元：部门经理审批→财务审核→打款  
   - 单笔＞1000元：部门经理→财务主管→总经理→财务审核→打款  
4. 到账时间：财务审核通过后3个工作日内，款项将打入员工工资卡  
  
三、常见问题  
1. 发票抬头必须为“XX科技有限公司”，否则不予报销  
2. 差旅报销需在出差结束后15天内提交，逾期视为自动放弃  
3. 虚报费用将扣除当月绩效20%，并记录违规一次  
"""</span>  
  
<span class="hljs-comment"># 定义要创建的文件列表  </span>
    files = [  
        {<span class="hljs-string">"name"</span>: <span class="hljs-string">"太阳系行星知识.txt"</span>, <span class="hljs-string">"content"</span>: planets_content},  
        {<span class="hljs-string">"name"</span>: <span class="hljs-string">"家用空气净化器使用指南.txt"</span>, <span class="hljs-string">"content"</span>: purifier_content},  
        {<span class="hljs-string">"name"</span>: <span class="hljs-string">"公司报销流程指南.txt"</span>, <span class="hljs-string">"content"</span>: reimbursement_content}  
    ]  
  
<span class="hljs-comment"># 将内容写入文件  </span>
<span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> files:  
        file_path = os.path.join(folder_name, file[<span class="hljs-string">"name"</span>])  
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">"w"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:  
            f.write(file[<span class="hljs-string">"content"</span>])  
  
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"已生成3个RAG测试文件，存放于：<span class="hljs-subst">{os.path.abspath(folder_name)}</span>"</span>)  
<span class="hljs-keyword">return</span> folder_name  
  
<span class="hljs-comment"># 调用函数生成文件  </span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:  
    generate_rag_test_files()
</code></pre>
<p><strong>1. 文本分段</strong></p>
<p>以下代码文件实现了ReadFiles类，用于文档加载与切分：读取指定文件夹中的所有txt文件，以最大token长度为依据，先按换行符初步切分，单行token超限时则进一步按token分割，同时保留相邻片段的重叠内容以提升后续检索准确性。此外，该文件还包含Documents类，用于将数据解析结果存入JSON格式文档，并返回相应接口。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Utils.py  </span>
<span class="hljs-keyword">import</span> os  
<span class="hljs-keyword">import</span> json  
<span class="hljs-keyword">import</span> tiktoken  <span class="hljs-comment"># 导入tiktoken库，用于计算文本的token数量  </span>
  
<span class="hljs-comment"># 初始化编码器，使用cl100k_base编码方式  </span>
enc = tiktoken.get_encoding(<span class="hljs-string">"cl100k_base"</span>)  
  
classReadFiles:  
<span class="hljs-string">"""  
    读取指定目录下的文本文件，并根据token长度进行分块处理的类  
    主要用于将长文本分割为适合大语言模型处理的小块  
    """</span>  
  
def__init__(self, path: <span class="hljs-built_in">str</span>) -&gt; <span class="hljs-literal">None</span>:  
<span class="hljs-string">"""  
        初始化ReadFiles实例  
        :param path: 目标文件夹路径，用于读取其中的文本文件  
        """</span>  
        self._path = path  <span class="hljs-comment"># 存储目标文件夹路径  </span>
        self.file_list = self.get_files()  <span class="hljs-comment"># 获取文件夹中所有符合条件的文件路径列表  </span>
  
defget_files(self):  
<span class="hljs-string">"""  
        遍历指定文件夹及其子文件夹，收集所有.txt后缀的文件路径  
        :return: 包含所有txt文件绝对路径的列表  
        """</span>  
        file_list = []  
<span class="hljs-comment"># os.walk递归遍历文件夹：返回当前路径、子文件夹列表、文件列表  </span>
<span class="hljs-keyword">for</span> filepath, dirnames, filenames <span class="hljs-keyword">in</span> os.walk(self._path):  
<span class="hljs-keyword">for</span> filename <span class="hljs-keyword">in</span> filenames:  
<span class="hljs-comment"># 筛选出后缀为.txt的文件  </span>
<span class="hljs-keyword">if</span> filename.endswith(<span class="hljs-string">".txt"</span>):  
<span class="hljs-comment"># 拼接完整文件路径并添加到列表  </span>
                    file_list.append(os.path.join(filepath, filename))  
<span class="hljs-keyword">return</span> file_list  
  
defget_content(self, max_token_len: <span class="hljs-built_in">int</span> = <span class="hljs-number">600</span>, cover_content: <span class="hljs-built_in">int</span> = <span class="hljs-number">150</span>):  
<span class="hljs-string">"""  
        读取所有文件内容，并按指定token长度进行分块处理  
        :param max_token_len: 每个块的最大token长度，默认600  
        :param cover_content: 块之间重叠的内容长度（字符数），用于保持上下文连贯性，默认150  
        :return: 所有文件分块后的内容列表  
        """</span>  
        docs = []  
<span class="hljs-comment"># 遍历每个文件并处理  </span>
<span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> self.file_list:  
<span class="hljs-comment"># 读取文件内容  </span>
            content = self.read_file_content(file)  
<span class="hljs-comment"># 对内容进行分块  </span>
            chunk_content = self.get_chunk(  
                content, max_token_len=max_token_len, cover_content=cover_content)  
<span class="hljs-comment"># 将分块结果添加到总列表  </span>
            docs.extend(chunk_content)  
<span class="hljs-keyword">return</span> docs  
  
    @<span class="hljs-built_in">classmethod</span>  
defget_chunk(cls, text: <span class="hljs-built_in">str</span>, max_token_len: <span class="hljs-built_in">int</span> = <span class="hljs-number">600</span>, cover_content: <span class="hljs-built_in">int</span> = <span class="hljs-number">150</span>):  
<span class="hljs-string">"""  
        将文本按token长度分块，处理长文本并保持块之间的重叠  
        :param text: 要分块的原始文本  
        :param max_token_len: 每个块的最大token长度  
        :param cover_content: 块之间重叠的内容长度（字符数）  
        :return: 分块后的文本列表  
        """</span>  
        chunk_text = []  <span class="hljs-comment"># 存储分块结果  </span>
  
        curr_len = <span class="hljs-number">0</span><span class="hljs-comment"># 当前块的token长度  </span>
        curr_chunk = <span class="hljs-string">''</span><span class="hljs-comment"># 当前块的文本内容  </span>
  
<span class="hljs-comment"># 实际可用的token长度 = 最大长度 - 重叠部分（为重叠内容预留空间）  </span>
        token_len = max_token_len - cover_content  
<span class="hljs-comment"># 按行分割文本（假设行是有意义的文本单元）  </span>
        lines = text.splitlines()  
  
<span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> lines:  
<span class="hljs-comment"># 去除行首尾空格，但保留行内空格  </span>
            line = line.strip()  
<span class="hljs-comment"># 计算当前行的token长度  </span>
            line_len = <span class="hljs-built_in">len</span>(enc.encode(line))  
  
<span class="hljs-comment"># 情况1：当前行的token长度超过最大限制  </span>
<span class="hljs-keyword">if</span> line_len &gt; max_token_len:  
<span class="hljs-comment"># 如果当前块有内容，先保存  </span>
<span class="hljs-keyword">if</span> curr_chunk:  
                    chunk_text.append(curr_chunk)  
                    curr_chunk = <span class="hljs-string">''</span>  
                    curr_len = <span class="hljs-number">0</span>  
  
<span class="hljs-comment"># 将超长行按token长度分割成多个块  </span>
                line_tokens = enc.encode(line)  
<span class="hljs-comment"># 计算需要分成多少块  </span>
                num_chunks = (<span class="hljs-built_in">len</span>(line_tokens) + token_len - <span class="hljs-number">1</span>) // token_len  
  
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_chunks):  
<span class="hljs-comment"># 计算当前块的token起始和结束位置  </span>
                    start_token = i * token_len  
                    end_token = <span class="hljs-built_in">min</span>(start_token + token_len, <span class="hljs-built_in">len</span>(line_tokens))  
  
<span class="hljs-comment"># 将token片段解码回文本  </span>
                    chunk_tokens = line_tokens[start_token:end_token]  
                    chunk_part = enc.decode(chunk_tokens)  
  
<span class="hljs-comment"># 除了第一个块，其他块都添加前一个块的结尾作为重叠内容  </span>
<span class="hljs-keyword">if</span> i &gt; <span class="hljs-number">0</span><span class="hljs-keyword">and</span> chunk_text:  
                        prev_chunk = chunk_text[-<span class="hljs-number">1</span>]  
<span class="hljs-comment"># 取前一个块的最后cover_content个字符作为重叠内容  </span>
                        cover_part = prev_chunk[-cover_content:] <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(prev_chunk) &gt; cover_content <span class="hljs-keyword">else</span> prev_chunk  
                        chunk_part = cover_part + chunk_part  
  
                    chunk_text.append(chunk_part)  
  
<span class="hljs-comment"># 重置当前块状态  </span>
                curr_chunk = <span class="hljs-string">''</span>  
                curr_len = <span class="hljs-number">0</span>  
  
<span class="hljs-comment"># 情况2：当前行可以加入当前块（加上换行符的1个token）  </span>
<span class="hljs-keyword">elif</span> curr_len + line_len + <span class="hljs-number">1</span> &lt;= token_len:  <span class="hljs-comment"># +1 是为换行符预留的token  </span>
<span class="hljs-keyword">if</span> curr_chunk:  <span class="hljs-comment"># 如果当前块已有内容，先加换行符  </span>
                    curr_chunk += <span class="hljs-string">'\n'</span>  
                    curr_len += <span class="hljs-number">1</span><span class="hljs-comment"># 换行符算1个token  </span>
                curr_chunk += line  <span class="hljs-comment"># 添加当前行文本  </span>
                curr_len += line_len  <span class="hljs-comment"># 更新当前块的token长度  </span>
<span class="hljs-comment"># 情况3：当前行无法加入当前块，需要开始新块  </span>
<span class="hljs-keyword">else</span>:  
<span class="hljs-comment"># 保存当前块  </span>
<span class="hljs-keyword">if</span> curr_chunk:  
                    chunk_text.append(curr_chunk)  
  
<span class="hljs-comment"># 开始新块，添加与前一块的重叠内容  </span>
<span class="hljs-keyword">if</span> chunk_text:  <span class="hljs-comment"># 如果已有块，添加重叠部分  </span>
                    prev_chunk = chunk_text[-<span class="hljs-number">1</span>]  
                    cover_part = prev_chunk[-cover_content:] <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(prev_chunk) &gt; cover_content <span class="hljs-keyword">else</span> prev_chunk  
                    curr_chunk = cover_part + <span class="hljs-string">'\n'</span> + line  
<span class="hljs-comment"># 计算新块的初始token长度（重叠部分+换行符+当前行）  </span>
                    curr_len = <span class="hljs-built_in">len</span>(enc.encode(cover_part)) + <span class="hljs-number">1</span> + line_len  
<span class="hljs-keyword">else</span>:  <span class="hljs-comment"># 如果是第一个块，直接添加当前行  </span>
                    curr_chunk = line  
                    curr_len = line_len  
  
<span class="hljs-comment"># 添加最后一个未处理的块（如果有内容）  </span>
<span class="hljs-keyword">if</span> curr_chunk:  
            chunk_text.append(curr_chunk)  
  
<span class="hljs-keyword">return</span> chunk_text  
  
    @<span class="hljs-built_in">classmethod</span>  
defread_file_content(cls, file_path: <span class="hljs-built_in">str</span>):  
<span class="hljs-string">"""  
        根据文件类型读取内容（目前仅支持txt文件）  
        :param file_path: 文件路径  
        :return: 文件内容字符串  
        :raises ValueError: 如果文件类型不支持  
        """</span>  
<span class="hljs-keyword">if</span> file_path.endswith(<span class="hljs-string">'.txt'</span>):  
<span class="hljs-keyword">return</span> cls.read_text(file_path)  
<span class="hljs-keyword">else</span>:  
<span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"Unsupported file type"</span>)  <span class="hljs-comment"># 抛出不支持文件类型的异常  </span>
  
    @<span class="hljs-built_in">classmethod</span>  
defread_text(cls, file_path: <span class="hljs-built_in">str</span>):  
<span class="hljs-string">"""  
        读取文本文件内容  
        :param file_path: txt文件路径  
        :return: 文件内容字符串  
        """</span>  
<span class="hljs-comment"># 使用utf-8编码打开并读取文件  </span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> file:  
<span class="hljs-keyword">return</span> file.read()  
  
  
classDocuments:  
<span class="hljs-string">"""  
    读取已分类的JSON格式文档的类  
    用于获取预先处理好的JSON格式内容  
    """</span>  
def__init__(self, path: <span class="hljs-built_in">str</span> = <span class="hljs-string">''</span>) -&gt; <span class="hljs-literal">None</span>:  
<span class="hljs-string">"""  
        初始化Documents实例  
        :param path: JSON文件路径，默认为空字符串  
        """</span>  
        self.path = path  <span class="hljs-comment"># 存储JSON文件路径  </span>
  
defget_content(self):  
<span class="hljs-string">"""  
        读取并解析JSON文件内容  
        :return: 解析后的JSON数据（通常为字典或列表）  
        """</span>  
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(self.path, mode=<span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:  
            content = json.load(f)  <span class="hljs-comment"># 加载并解析JSON数据  </span>
<span class="hljs-keyword">return</span> content
</code></pre>
<p><strong>2. 文本片段向量化</strong></p>
<p>以下代码文件主要实现了文本片段向量化相关功能，核心是将文本转换为数值向量并提供向量相似度计算能力，具体包括：</p>
<ol start="0">
<li>定义了抽象基类<code>BaseEmbeddings</code>，规定了向量提取模型（嵌入模型）的基本接口：</li>
</ol>
<ul>
<li>存储模型路径的初始化方法</li>
<li>抽象方法<code>get_embedding</code>（需子类实现文本到向量的转换）</li>
<li>类方法<code>cosine_similarity</code>（计算两个向量的余弦相似度，衡量文本相似度）</li>
</ul>
<ol start="2">
<li>实现了具体子类<code>SentenceEmbedding</code>：</li>
</ol>
<ul>
<li>基于Sentence-BERT模型实现文本嵌入功能</li>
<li>支持从Hugging Face或ModelScope加载预训练模型</li>
<li>实现<code>get_embedding</code>方法，将文本预处理后转换为向量</li>
</ul>
<ol start="3">
<li>提供了测试代码：</li>
</ol>
<ul>
<li>初始化默认模型（sentence-transformers/all-MiniLM-L6-v2）</li>
<li>演示文本嵌入过程并输出向量维度和示例值</li>
<li>向量输出维度默认为384</li>
</ul>
<p>总之，该代码整体功能是将文本转化为计算机可理解的向量表示，为后续的文本相似度计算、语义搜索等任务提供基础。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Embeddings.py  </span>
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>  
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np  
  
classBaseEmbeddings:  
<span class="hljs-string">"""  
    嵌入模型的基类，定义了所有嵌入模型应实现的基本接口  
    作为抽象基类，不能直接实例化，需通过子类实现具体功能  
    """</span>  
def__init__(self, path: <span class="hljs-built_in">str</span>) -&gt; <span class="hljs-literal">None</span>:  
<span class="hljs-string">"""  
        初始化嵌入基类，存储模型或数据的路径  
  
        Args:  
            path (str): 模型或数据的路径，可以是本地路径或远程仓库地址  
        """</span>  
        self.path = path  <span class="hljs-comment"># 存储模型路径供后续使用  </span>
  
defget_embedding(self, text: <span class="hljs-built_in">str</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">float</span>]:  
<span class="hljs-string">"""  
        获取文本的嵌入向量表示的抽象方法  
        子类必须实现此方法以提供具体的嵌入计算逻辑  
  
        Args:  
            text (str): 需要转换为嵌入向量的输入文本  
  
        Returns:  
            List[float]: 文本对应的嵌入向量，以浮点数列表形式返回  
  
        Raises:  
            NotImplementedError: 如果子类未实现此方法则会抛出此异常  
        """</span>  
<span class="hljs-comment"># 抛出未实现异常，强制子类实现该方法  </span>
<span class="hljs-keyword">raise</span> NotImplementedError  
  
    @<span class="hljs-built_in">classmethod</span>  
defcosine_similarity(cls, vector1: <span class="hljs-type">List</span>[<span class="hljs-built_in">float</span>], vector2: <span class="hljs-type">List</span>[<span class="hljs-built_in">float</span>]) -&gt; <span class="hljs-built_in">float</span>:  
<span class="hljs-string">"""  
        计算两个向量之间的余弦相似度  
        余弦相似度是衡量两个向量方向相似性的指标，值越接近1表示方向越相似  
  
        Args:  
            vector1 (List[float]): 第一个向量  
            vector2 (List[float]): 第二个向量  
  
        Returns:  
            float: 两个向量的余弦相似度，范围在[-1, 1]之间  
                  1表示完全相似，-1表示完全相反，0表示正交  
        """</span>  
<span class="hljs-comment"># 将输入的Python列表转换为numpy数组，并指定数据类型为float32以节省内存  </span>
        v1 = np.array(vector1, dtype=np.float32)  
        v2 = np.array(vector2, dtype=np.float32)  
  
<span class="hljs-comment"># 检查向量中是否包含无穷大或NaN值，这些值会导致计算错误  </span>
ifnot np.<span class="hljs-built_in">all</span>(np.isfinite(v1)) ornot np.<span class="hljs-built_in">all</span>(np.isfinite(v2)):  
return0<span class="hljs-number">.0</span><span class="hljs-comment"># 存在无效值时返回0表示无相似性  </span>
  
<span class="hljs-comment"># 计算两个向量的点积（内积）  </span>
        dot_product = np.dot(v1, v2)  
<span class="hljs-comment"># 计算每个向量的L2范数（欧几里得长度）  </span>
        norm_v1 = np.linalg.norm(v1)  
        norm_v2 = np.linalg.norm(v2)  
  
<span class="hljs-comment"># 计算两个向量范数的乘积作为分母  </span>
        magnitude = norm_v1 * norm_v2  
<span class="hljs-comment"># 处理分母为0的特殊情况（避免除以零错误）  </span>
<span class="hljs-keyword">if</span> magnitude == <span class="hljs-number">0</span>:  
return0<span class="hljs-number">.0</span><span class="hljs-comment"># 零向量之间的相似度定义为0  </span>
  
<span class="hljs-comment"># 返回余弦相似度：点积除以范数乘积  </span>
<span class="hljs-keyword">return</span> dot_product / magnitude  
  
classSentenceEmbedding(BaseEmbeddings):  
<span class="hljs-string">"""  
    基于Sentence-BERT的句子嵌入实现类  
    继承自BaseEmbeddings，实现了具体的句子嵌入计算功能  
    """</span>  
def__init__(self, path: <span class="hljs-built_in">str</span> = <span class="hljs-string">"sentence-transformers/all-MiniLM-L6-v2"</span>) -&gt; <span class="hljs-literal">None</span>:  
<span class="hljs-string">"""  
        初始化SentenceEmbedding实例，加载指定的句子嵌入模型  
  
        Args:  
            path (str, optional): 模型路径，默认为预训练模型"sentence-transformers/all-MiniLM-L6-v2"  
                                 可以是modelscope模型仓库名称或本地模型路径  
        """</span>  
<span class="hljs-comment"># 调用父类的初始化方法，存储模型路径  </span>
        <span class="hljs-built_in">super</span>().__init__(path)  
<span class="hljs-keyword">try</span>:  
<span class="hljs-keyword">from</span> sentence_transformers <span class="hljs-keyword">import</span> SentenceTransformer  
<span class="hljs-comment"># 利用modelscope加速下载  </span>
<span class="hljs-keyword">from</span> modelscope <span class="hljs-keyword">import</span> snapshot_download  
  
            model_name = path  <span class="hljs-comment"># 模型名称/路径  </span>
<span class="hljs-comment"># 从模型仓库下载模型到本地（如果本地已存在则直接使用）  </span>
            model_dir = snapshot_download(model_name)  
<span class="hljs-comment"># 初始化SentenceTransformer模型实例  </span>
            self.model = SentenceTransformer(model_dir)  
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:  
<span class="hljs-comment"># 捕获所有可能的异常并包装为运行时错误，提供更明确的错误信息  </span>
<span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">f"加载SentenceTransformer模型失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)  
  
defget_embedding(self, text: <span class="hljs-built_in">str</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">float</span>]:  
<span class="hljs-string">"""  
        实现父类的抽象方法，获取文本的嵌入向量  
  
        Args:  
            text (str): 需要转换为嵌入向量的输入文本  
  
        Returns:  
            List[float]: 文本对应的嵌入向量，以浮点数列表形式返回  
        """</span>  
<span class="hljs-comment"># 文本预处理：将换行符替换为空格，避免模型处理换行符可能带来的问题  </span>
        text = text.replace(<span class="hljs-string">"\n"</span>, <span class="hljs-string">" "</span>)  
<span class="hljs-comment"># 使用加载的模型对文本进行编码，获取嵌入向量（numpy数组格式）  </span>
        embedding = self.model.encode(text)  
  
<span class="hljs-comment"># 将numpy数组转换为Python列表并返回  </span>
<span class="hljs-keyword">return</span> embedding.tolist()  
  
<span class="hljs-comment"># 当脚本作为主程序运行时执行以下代码  </span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:  
<span class="hljs-comment"># 创建SentenceEmbedding实例，使用默认模型  </span>
    embedding = SentenceEmbedding()  
  
<span class="hljs-comment"># 定义测试文本  </span>
    text = <span class="hljs-string">"这是一个测试文本"</span>  
<span class="hljs-comment"># 获取文本的嵌入向量  </span>
    vectors = embedding.get_embedding(text)  
  
<span class="hljs-comment"># 打印嵌入向量的维度和前10个元素，验证功能是否正常  </span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"嵌入向量维度: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(vectors)}</span>"</span>)  
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"嵌入向量示例: <span class="hljs-subst">{vectors[:<span class="hljs-number">10</span>]}</span>..."</span>)
</code></pre>
<p><strong>3. 向量存储与知识库构建</strong></p>
<p>完成文档切分与Embedding模型加载后，需构建向量数据库存储文档片段及其向量表示，并设计检索模块实现查询响应。以下代码文件实现了一个向量存储与知识库构建类，主要功能如下：</p>
<ul>
<li>管理文档及其对应的向量：存储文本文档及其对应的向量表示</li>
<li>向量生成：通过文本片段向量化将文档转换为向量</li>
<li>持久化存储：将文档和向量数据保存到本地文件系统，也可从本地加载</li>
<li>相似度计算：提供向量间的余弦相似度计算功能</li>
<li>相似性查询：根据输入的查询文本，找到最相似的前k个文档</li>
</ul>

<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># VectorBase.py  </span>
<span class="hljs-keyword">import</span> os  
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>  
<span class="hljs-keyword">import</span> json  
<span class="hljs-keyword">from</span> Embeddings <span class="hljs-keyword">import</span> BaseEmbeddings  
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np  
<span class="hljs-comment"># 导入进度条库，用于显示处理进度  </span>
<span class="hljs-keyword">from</span> tqdm <span class="hljs-keyword">import</span> tqdm  
  
classVectorStore:  
<span class="hljs-string">"""  
    向量存储类，用于管理文档及其对应的向量表示  
    提供向量计算、持久化存储、相似度查询等功能  
    """</span>  
def__init__(self, document: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>] = [<span class="hljs-string">''</span>]) -&gt; <span class="hljs-literal">None</span>:  
<span class="hljs-string">"""  
        初始化向量存储实例  
  
        参数:  
            document: 初始文档列表，默认为包含一个空字符串的列表  
        """</span>  
        self.document = document  <span class="hljs-comment"># 存储文档内容的列表  </span>
        self.vectors = []  <span class="hljs-comment"># 存储文档对应的向量表示  </span>
  
defget_vector(self, EmbeddingModel: BaseEmbeddings) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">float</span>]]:  
<span class="hljs-string">"""  
        使用嵌入模型为文档生成向量表示  
  
        参数:  
            EmbeddingModel: 用于生成嵌入向量的模型实例，需继承自BaseEmbeddings  
  
        返回:  
            文档列表对应的向量列表，每个向量是一个浮点数列表  
        """</span>  
        self.vectors = []  
<span class="hljs-comment"># 使用tqdm显示处理进度，desc设置进度条描述  </span>
<span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> tqdm(self.document, desc=<span class="hljs-string">"Calculating embeddings"</span>):  
<span class="hljs-comment"># 为每个文档生成嵌入向量并添加到列表  </span>
            self.vectors.append(EmbeddingModel.get_embedding(doc))  
<span class="hljs-keyword">return</span> self.vectors  
  
defpersist(self, path: <span class="hljs-built_in">str</span> = <span class="hljs-string">'storage'</span>):  
<span class="hljs-string">"""  
        将文档和向量数据持久化存储到文件系统  
  
        参数:  
            path: 存储目录路径，默认为'storage'  
        """</span>  
<span class="hljs-comment"># 如果目录不存在则创建  </span>
ifnot os.path.exists(path):  
            os.makedirs(path)  
<span class="hljs-comment"># 保存文档内容到JSON文件  </span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">f"<span class="hljs-subst">{path}</span>/doecment.json"</span>, <span class="hljs-string">'w'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:  
            json.dump(self.document, f, ensure_ascii=<span class="hljs-literal">False</span>)  
<span class="hljs-comment"># 如果存在向量数据，则保存向量到JSON文件  </span>
<span class="hljs-keyword">if</span> self.vectors:  
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">f"<span class="hljs-subst">{path}</span>/vectors.json"</span>, <span class="hljs-string">'w'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:  
                json.dump(self.vectors, f)  
  
defload_vector(self, path: <span class="hljs-built_in">str</span> = <span class="hljs-string">'storage'</span>):  
<span class="hljs-string">"""  
        从文件系统加载已持久化的文档和向量数据  
  
        参数:  
            path: 存储目录路径，默认为'storage'  
        """</span>  
<span class="hljs-comment"># 加载向量数据  </span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">f"<span class="hljs-subst">{path}</span>/vectors.json"</span>, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:  
            self.vectors = json.load(f)  
<span class="hljs-comment"># 加载文档内容  </span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">f"<span class="hljs-subst">{path}</span>/doecment.json"</span>, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:  
            self.document = json.load(f)  
  
defget_similarity(self, vector1: <span class="hljs-type">List</span>[<span class="hljs-built_in">float</span>], vector2: <span class="hljs-type">List</span>[<span class="hljs-built_in">float</span>]) -&gt; <span class="hljs-built_in">float</span>:  
<span class="hljs-string">"""  
        计算两个向量之间的余弦相似度  
  
        参数:  
            vector1: 第一个向量  
            vector2: 第二个向量  
  
        返回:  
            两个向量的余弦相似度，值越接近1表示越相似  
        """</span>  
<span class="hljs-keyword">return</span> BaseEmbeddings.cosine_similarity(vector1, vector2)  
  
defquery(self, query: <span class="hljs-built_in">str</span>, EmbeddingModel: BaseEmbeddings, k: <span class="hljs-built_in">int</span> = <span class="hljs-number">1</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:  
<span class="hljs-string">"""  
        根据查询文本，返回最相似的k个文档  
  
        参数:  
            query: 查询文本  
            EmbeddingModel: 用于生成嵌入向量的模型实例  
            k: 返回的相似文档数量，默认为1  
  
        返回:  
            与查询文本最相似的k个文档列表  
        """</span>  
<span class="hljs-comment"># 生成查询文本的向量表示  </span>
        query_vector = EmbeddingModel.get_embedding(query)  
<span class="hljs-comment"># 计算查询向量与所有文档向量的相似度  </span>
        result = np.array([self.get_similarity(query_vector, vector)  
<span class="hljs-keyword">for</span> vector <span class="hljs-keyword">in</span> self.vectors])  
<span class="hljs-comment"># 对相似度排序，取前k个最相似的文档并返回  </span>
<span class="hljs-comment"># argsort()[-k:][::-1] 用于获取相似度最高的k个文档的索引  </span>
<span class="hljs-keyword">return</span> np.array(self.document)[result.argsort()[-k:][::-<span class="hljs-number">1</span>]].tolist()
</code></pre>
<p><strong>4. 生成回答</strong></p>
<p>这段代码实现了基于DeepSeek模型的RAG问答助手，可结合上下文按规则生成回答，包含模型加载与对话示例。为便于扩展，定义了含chat和oad_model法的基类BaseModel，本地开源模型需实现load_model方法。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># LLM.py  </span>
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>  
<span class="hljs-keyword">from</span> unsloth <span class="hljs-keyword">import</span> FastLanguageModel  
<span class="hljs-comment"># torch2.5版本以下防止unsloth加载出问题  </span>
<span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> modeling_utils  
ifnot <span class="hljs-built_in">hasattr</span>(modeling_utils, <span class="hljs-string">"ALL_PARALLEL_STYLES"</span>) <span class="hljs-keyword">or</span> modeling_utils.ALL_PARALLEL_STYLES isNone:  
    modeling_utils.ALL_PARALLEL_STYLES = [<span class="hljs-string">"tp"</span>, <span class="hljs-string">"none"</span>,<span class="hljs-string">"colwise"</span>,<span class="hljs-string">'rowwise'</span>]  
  
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv, find_dotenv  
_ = load_dotenv(find_dotenv())  
  
RAG_PROMPT_TEMPLATE=<span class="hljs-string">"""  
  
# 你是一个专业的RAG回答助手  
  
## 可参考的上下文：  
  
{context}  
  
## 请严格按以下规则回答：  
  
1. 必须优先使用上下文信息，禁止主动引入外部知识  
2. 必须对问题和上下文进行理解，而不仅仅是凭借字面意思回答。在提供的上下文中，仔细查找与问题核心直接相关的语句。同时，注意查找能支持推理出答案的信息（例如：因果关系、定义、属性描述、时间顺序、比较关系等）  
3. 回答逻辑：  
   - 若上下文直接包含问题答案：输出答案并引用原文  
   - 若上下文否定问题陈述：回答"不对"并引用原文  
   - 若不能通过上下文回答问题： 回答"上下文未提供相关信息"  
   - 注意代词（它、他、他们、这个、那个）在上下文中的具体指代对象  
4. 输出格式：  
   - 仅用中文回答  
   - 答案应简洁直接，聚焦于回答问题本身  
   - 禁止主观解释  
   - 必须标注引用位置（例：据上下文第X段）  
"""</span>  
  
classBaseModel:  
def__init__(self, model_name) -&gt; <span class="hljs-literal">None</span>:  
        self.model_name = model_name  
  
defchat(self, prompt, history, content) -&gt; <span class="hljs-built_in">str</span>:  
<span class="hljs-keyword">pass</span>  
  
defload_model(self):  
<span class="hljs-keyword">pass</span>  
  
classDeepSeekChat(BaseModel):  
def__init__(self, model_name: <span class="hljs-built_in">str</span> = <span class="hljs-string">"deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B"</span>) -&gt; <span class="hljs-literal">None</span>:  
        <span class="hljs-built_in">super</span>().__init__(model_name)  
        self.model, self.tokenizer = self.load_model()  
        self.max_length = <span class="hljs-number">2048</span>  
        self.temperature = <span class="hljs-number">0.1</span>  
  
defload_model(self):  
<span class="hljs-keyword">try</span>:  
<span class="hljs-comment"># 原始模型地址：https://huggingface.co/unsloth/DeepSeek-R1-Distill-Qwen-1.5B  </span>
<span class="hljs-comment"># 1. 利用modelscope库下载模型到本地，然后通过unsloth加载模型  </span>
<span class="hljs-keyword">from</span> modelscope <span class="hljs-keyword">import</span> snapshot_download  
<span class="hljs-comment"># 加载预训练模型 ,利用modelscope库  </span>
            model_name = self.model_name  <span class="hljs-comment"># 假设这是支持分词的模型名称  </span>
<span class="hljs-comment"># 下载模型  </span>
            model_dir = snapshot_download(model_name)  
  
<span class="hljs-comment"># 从huggingface的镜像https://hf-mirror.com/中下载模型到本地  </span>
<span class="hljs-comment"># model_dir= "./DeepSeek-R1-Distill-Qwen-1.5B"  </span>
  
<span class="hljs-comment"># 设置最大序列长度，表示模型在一次前向传递中可以处理的最大令牌数量。  </span>
            max_seq_length = <span class="hljs-number">2048</span>  
  
<span class="hljs-comment"># https://hf-mirror.com/  </span>
<span class="hljs-comment"># 调用FastLanguageModel.from_pretrained()方法加载预训练的模型和对应的Tokenizer（分词器）。  </span>
            model, tokenizer = FastLanguageModel.from_pretrained(  
                model_name = model_dir, <span class="hljs-comment"># 从hf中直接调用：model_name = unsloth/DeepSeek-R1-Distill-Qwen-1.5B  </span>
                max_seq_length = max_seq_length,  <span class="hljs-comment"># 最大序列长度，表示模型在一次前向传递中可以处理的最大令牌数量。  </span>
                dtype = <span class="hljs-literal">None</span>,           <span class="hljs-comment"># 自动检测（BF16或FP16）。BF16范围大，FP16精度高  </span>
                local_files_only=<span class="hljs-literal">True</span><span class="hljs-comment"># 只用本地文件  </span>
            )  
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:  
<span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">f"加载 DeepSeek 模型失败"</span>)  
<span class="hljs-keyword">return</span> model, tokenizer  
  
defchat(self, prompt: <span class="hljs-built_in">str</span>, history: <span class="hljs-type">List</span>[<span class="hljs-built_in">dict</span>], content: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]) -&gt; <span class="hljs-built_in">str</span>:  
<span class="hljs-comment"># 构建上下文（优化格式）  </span>
        formatted_context = <span class="hljs-string">"\n"</span>.join(  
            [<span class="hljs-string">f"【上下文第<span class="hljs-subst">{idx}</span>段】<span class="hljs-subst">{text}</span>"</span>  
<span class="hljs-keyword">for</span> idx, text <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(content, <span class="hljs-number">1</span>) <span class="hljs-keyword">if</span> text.strip()]  
        )  
  
<span class="hljs-comment"># 构建系统提示  </span>
        system_prompt = RAG_PROMPT_TEMPLATE.<span class="hljs-built_in">format</span>(context=formatted_context.strip())  
  
<span class="hljs-comment"># 构建完整消息队列  </span>
        messages = []  
  
<span class="hljs-comment"># 1. 添加当前系统提示  </span>
        messages.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: system_prompt})  
  
<span class="hljs-comment"># 2. 添加历史对话（过滤旧系统消息）  </span>
<span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> history:  
<span class="hljs-keyword">if</span> msg[<span class="hljs-string">"role"</span>] != <span class="hljs-string">"system"</span>:  <span class="hljs-comment"># 过滤历史中的系统消息  </span>
                messages.append(msg)  
  
<span class="hljs-comment"># 3. 添加当前用户问题  </span>
        messages.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: prompt})  
  
<span class="hljs-comment"># 应用对话模板，添加生成引导符  </span>
        inputs = self.tokenizer.apply_chat_template(  
            messages,  
            tokenize=<span class="hljs-literal">False</span>,  
            add_generation_prompt=<span class="hljs-literal">True</span>  
        )  
        inputs = self.tokenizer(inputs, return_tensors=<span class="hljs-string">"pt"</span>, padding=<span class="hljs-literal">True</span>, truncation=<span class="hljs-literal">True</span>).to(<span class="hljs-string">"cuda"</span>)  
        input_length = inputs[<span class="hljs-string">"input_ids"</span>].shape[<span class="hljs-number">1</span>]  <span class="hljs-comment"># 记录输入长度用于截取生成内容  </span>
  
        outputs = self.model.generate(  
            **inputs,  
            max_new_tokens=self.max_length,  
            temperature=self.temperature,  
            pad_token_id=self.tokenizer.eos_token_id         
            )  
  
<span class="hljs-comment"># 只返回新生成的文本（去掉输入提示）  </span>
        generated_tokens = outputs[<span class="hljs-number">0</span>][input_length:]  <span class="hljs-comment"># 直接截取生成的token  </span>
        response = self.tokenizer.decode(generated_tokens, skip_special_tokens=<span class="hljs-literal">True</span>).strip()  
  
<span class="hljs-keyword">return</span> response  
  
<span class="hljs-comment"># 示例：使用 DeepSeekChat 进行对话  </span>
defmain():  
<span class="hljs-comment"># 初始化模型  </span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"正在加载 DeepSeek 模型..."</span>)  
    chat_model = DeepSeekChat()  <span class="hljs-comment"># 也可以尝试其他 DeepSeek 模型  </span>
  
<span class="hljs-comment"># 示例上下文，内容为假数据  </span>
    context = [<span class="hljs-string">"""  
    DeepSeek 是深度求索公司开发的大语言模型。  
    当前最新版本是 DeepSeek-V3，知识截止日期为2024年7月。  
    该模型支持最大128K上下文长度，擅长中文和英文任务。  
    """</span>]  
  
<span class="hljs-comment"># 示例对话历史  </span>
    history = [  
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你是一个乐于助人的AI助手。"</span>},  
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你好，请介绍一下你自己"</span>},  
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"我是基于DeepSeek模型构建的AI助手，很高兴为您服务。"</span>}  
    ]  
  
<span class="hljs-comment"># 第一个问题  </span>
    question1 = <span class="hljs-string">"DeepSeek模型最新版本的知识截止日期是什么？"</span>  
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n用户提问: <span class="hljs-subst">{question1}</span>"</span>)  
    response1 = chat_model.chat(question1, history, context)  
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"AI回答: <span class="hljs-subst">{response1}</span>"</span>)  
  
<span class="hljs-comment"># 将回答添加到历史记录中  </span>
    history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: question1})  
    history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: response1})  
  
<span class="hljs-comment"># 第二个问题（测试历史对话+上下文）  </span>
    question2 = <span class="hljs-string">"它支持最大的上下文长度是多少？"</span><span class="hljs-comment"># "它"指代历史对话中的DeepSeek模型  </span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n用户提问: <span class="hljs-subst">{question2}</span>"</span>)  
    response2 = chat_model.chat(question2, history, context)  
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"AI回答: <span class="hljs-subst">{response2}</span>"</span>)  
  
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:  
    main()
</code></pre>
<p><strong>5. 调用代码</strong></p>
<p>以下代码实现了一个简单RAG系统的调用流程：生成测试文件后，智能加载或新建向量数据库，再通过DeepSeek模型结合检索到的相关上下文与对话历史，依次处理预设问题并生成回答，核心是借助向量检索提升回答准确性。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># main.py  </span>
<span class="hljs-keyword">import</span> os  
<span class="hljs-keyword">from</span> Generate <span class="hljs-keyword">import</span> generate_rag_test_files  
<span class="hljs-keyword">from</span> VectorBase <span class="hljs-keyword">import</span> VectorStore  
<span class="hljs-keyword">from</span> Utils <span class="hljs-keyword">import</span> ReadFiles  
<span class="hljs-keyword">from</span> LLM <span class="hljs-keyword">import</span> DeepSeekChat  
<span class="hljs-keyword">from</span> Embeddings <span class="hljs-keyword">import</span> SentenceEmbedding  
  
defmain():  
<span class="hljs-comment"># 生成测试文件  </span>
    folder_name = generate_rag_test_files()  
  
<span class="hljs-comment"># 向量存储路径  </span>
    vector_path = <span class="hljs-string">'storage'</span>  
  
<span class="hljs-comment"># 初始化嵌入模型  </span>
    embedding = SentenceEmbedding()  
  
<span class="hljs-comment"># 智能加载向量存储：存在则加载，否则生成并持久化  </span>
<span class="hljs-keyword">if</span> os.path.exists(vector_path):  
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"加载本地向量数据库..."</span>)  
        vector = VectorStore([])  <span class="hljs-comment"># 空文档初始化，后续加载本地数据  </span>
        vector.load_vector(vector_path)  
<span class="hljs-keyword">else</span>:  
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"生成新的向量数据库..."</span>)  
<span class="hljs-comment"># 读取并分割文档  </span>
        docs = ReadFiles(folder_name).get_content(max_token_len=<span class="hljs-number">600</span>, cover_content=<span class="hljs-number">150</span>)  
        vector = VectorStore(docs)  
<span class="hljs-comment"># 生成并持久化向量  </span>
        vector.get_vector(EmbeddingModel=embedding)  
        vector.persist(path=vector_path)  
  
<span class="hljs-comment"># 初始化对话模型  </span>
    chat = DeepSeekChat()  
  
<span class="hljs-comment"># 初始化对话历史  </span>
    chat_history = []  
  
<span class="hljs-comment"># 待处理的问题列表  </span>
    questions = [  
<span class="hljs-string">"HelloWorld公司三线城市住宿上限是多少？"</span>,  
<span class="hljs-string">"HelloWorld公司差旅报销在出差结束后20天提交，有什么后果？"</span>,  
<span class="hljs-comment"># "CleanAir X5空气净化器若净化效果下降，怎么解决？",  </span>
<span class="hljs-comment"># "地球自转周期是48小时吗？",  </span>
<span class="hljs-comment"># "太阳系行星距离太阳第四近的是哪个？"  </span>
    ]  
  
<span class="hljs-comment"># 依次处理每个问题，维护对话历史  </span>
<span class="hljs-keyword">for</span> idx, question <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(questions, <span class="hljs-number">1</span>):  
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n===== 问题 <span class="hljs-subst">{idx}</span> ====="</span>)  
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"用户: <span class="hljs-subst">{question}</span>"</span>)  
  
<span class="hljs-comment"># 检索相关上下文  </span>
        content = vector.query(question, EmbeddingModel=embedding, k=<span class="hljs-number">2</span>)  
  
<span class="hljs-comment"># 调用模型生成回答（传入历史记录）  </span>
        response = chat.chat(question, chat_history, content)  
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"AI: <span class="hljs-subst">{response}</span>"</span>)  
  
<span class="hljs-comment"># 更新对话历史  </span>
        chat_history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: question})  
        chat_history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: response})  
  
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:  
    main()
</code></pre>
<h3 data-id="heading-14">3.2 主流开源RAG框架概览</h3>
<p>前文介绍的自建RAG系统更适用于学习与演示场景；而在实际开发过程中，基于成熟的开源框架搭建RAG系统则是更优选择。以下为当前主流的15个开源RAG框架排名及核心特性解析：</p>





















































































































































<table><thead><tr><th>排名</th><th>框架</th><th>核心聚焦</th><th>最佳适用场景</th><th>核心功能</th><th>部署复杂度</th><th>GitHub星标数</th></tr></thead><tbody><tr><td>1</td><td>LangChain</td><td>组件链合</td><td>通用RAG应用</td><td>数据连接、模型灵活性</td><td>中</td><td>105k</td></tr><tr><td>2</td><td>Dify</td><td>可视化开发</td><td>非技术用户、企业</td><td>可视化编辑器、多模型支持</td><td>低</td><td>90.5k</td></tr><tr><td>3</td><td>RAGFlow</td><td>文档处理</td><td>复杂文档handling</td><td>深度文档理解、GraphRAG</td><td>中</td><td>48.5k</td></tr><tr><td>4</td><td>LlamaIndex</td><td>数据索引</td><td>自定义知识源</td><td>灵活连接器、自定义索引</td><td>低</td><td>40.8k</td></tr><tr><td>5</td><td>Milvus</td><td>向量存储</td><td>大规模向量搜索</td><td>高级向量搜索、水平扩展</td><td>中</td><td>33.9k</td></tr><tr><td>6</td><td>mem0</td><td>持久记忆</td><td>需上下文保留的助手</td><td>多级记忆、自动处理</td><td>低</td><td>27.3k</td></tr><tr><td>7</td><td>DSPy</td><td>提示优化</td><td>需自我改进的系统</td><td>自动优化、模块化</td><td>中</td><td>23k</td></tr><tr><td>8</td><td>Haystack</td><td>管道编排</td><td>生产应用</td><td>灵活组件、技术无关</td><td>中</td><td>20.2k</td></tr><tr><td>9</td><td>LightRAG</td><td>性能</td><td>速度关键应用</td><td>简单架构、高效检索</td><td>低</td><td>14.6k</td></tr><tr><td>10</td><td>LLMWare</td><td>资源效率</td><td>边缘/CPU部署</td><td>小型模型、并行解析</td><td>低</td><td>12.7k</td></tr><tr><td>11</td><td>txtai</td><td>一体化解决方案</td><td>简化实现</td><td>嵌入数据库、多模态</td><td>低</td><td>10.7k</td></tr><tr><td>12</td><td>RAGAS</td><td>评估</td><td>RAG系统测试</td><td>客观指标、测试生成</td><td>低</td><td>8.7k</td></tr><tr><td>13</td><td>R2R</td><td>代理式RAG</td><td>复杂查询</td><td>多模态摄入、代理推理</td><td>中</td><td>6.3k</td></tr><tr><td>14</td><td>Ragatouille</td><td>高级检索</td><td>高精度搜索</td><td>晚期交互检索、微调</td><td>中</td><td>3.4k</td></tr><tr><td>15</td><td>FlashRAG</td><td>研究</td><td>实验与基准测试</td><td>预处理数据集、多算法</td><td>中</td><td>2.1k</td></tr></tbody></table>
<p>以上内容参考自：15 Best Open-Source RAG Frameworks in 2025[12]。不同开源RAG框架的核心差异主要体现在技术定位与功能特性上，在进行框架选型时，需结合应用规模、性能指标、开发周期等实际需求综合判断。需要特别强调的是，无论选择何种框架，知识库的质量始终是决定RAG系统效果的核心因素。</p>
<p>具体选型建议如下：</p>
<ul>
<li>若以易用性为优先考量：推荐Dify、LlamaIndex、mem0、LightRAG、txtai</li>
<li>针对文档密集型应用：优先考虑RAGFlow、LLMWare</li>
<li>面向大规模生产部署：适合选择Milvus、Haystack、LangChain</li>
<li>硬件资源受限场景：优先选用LLMWare、LightRAG</li>
<li>存在复杂推理需求的场景：建议探索R2R、DSPy</li>
<li>需进行系统评估的场景：推荐使用RAGAS</li>
<li>研究与实验场景：适合选择FlashRAG</li>
</ul>
<hr/>
<h3 data-id="heading-15">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RAG实践指南：一文搞定大模型RAG过程]]></title>    <link>https://juejin.cn/post/7585920796100657179</link>    <guid>https://juejin.cn/post/7585920796100657179</guid>    <pubDate>2025-12-22T03:58:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585920796100657179" data-draft-id="7585920796100640795" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RAG实践指南：一文搞定大模型RAG过程"/> <meta itemprop="keywords" content="LLM,Agent,程序员"/> <meta itemprop="datePublished" content="2025-12-22T03:58:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RAG实践指南：一文搞定大模型RAG过程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:58:49.000Z" title="Mon Dec 22 2025 03:58:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote>
<h2 data-id="heading-0"><strong>RAG是什么？</strong></h2>
<p><strong>RAG（Retrieval-Augmented Generation，检索增强生成）</strong> , 一种AI框架，将传统的信息检索系统(例如数据库)的优势与生成式大语言模型(LLM)的功能结合在一起。不再依赖LLM训练时的固有知识，而是在回答问题前，先从外部资料库中“翻书”找资料，基于这些资料生成更准确的答案。</p>
<p>RAG技术核心缓解大模型落地应用的几个关键问题：</p>
<ul>
<li><strong>知识新鲜度</strong>：大模型突破模型训练数据的时间限制</li>
<li><strong>幻觉问题</strong>：降低生成答案的虚构概率，提供参照来源</li>
<li><strong>信息安全</strong>：通过外挂知识库而不是内部训练数据，减少隐私泄露</li>
<li><strong>垂直领域知识</strong>：无需训练直接整合垂直领域知识</li>
</ul>
<p><strong>RAG核心流程</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77afaa25fe4943f5927219aef16e3128~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980728&amp;x-signature=iTkOV3hhkqco7ucMwRVc%2B8abfNI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">2.1 知识准备阶段</h2>
<h4 data-id="heading-2">2.1.1 数据预处理</h4>
<h4 data-id="heading-3">a. 文档解析</h4>
<p><strong>输入</strong>：原始文档（如Markdown/PDF/HTML）</p>
<p><strong>操作</strong>：</p>
<ul>
<li>提取纯文本（如解析Markdown标题、段落）</li>
<li>处理特殊格式（如代码块、表格、图片、视频等）</li>
</ul>
<p>例如：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[标题]</span> 什么是 ROMA？
<span class="hljs-selector-attr">[段落]</span> ROMA 是一个全自主研发的前端开发基于自定义<span class="hljs-built_in">DSL</span>(Jue语言)，一份代码，可在iOS、Android、Harmony、Web四端运行的跨平台解决方案。
<span class="hljs-selector-attr">[段落]</span> ROMA 框架的中文名为罗码。
<span class="hljs-selector-attr">[标题]</span> 今天天气
<span class="hljs-selector-attr">[列表项]</span> 今天的室外温度为<span class="hljs-number">35</span>°C，天气晴朗。
</code></pre>
<h5 data-id="heading-4"><strong>文档的解析过程需要考虑不同文档内容例如文本、图片、表格等场景，以及文档的语言，布局情况，可以考虑使用一些优秀的三方工具或者一些视觉模型，布局分析模型，语义理解模型来辅助解析。</strong></h5>
<h5 data-id="heading-5"><strong>b. 数据清洗与标准化处理</strong></h5>
<p>提升文本质量和一致性，使向量表示更准确，从而增强检索相关性和LLM回答质量；同时消除噪声和不规则格式，确保系统能正确理解和处理文档内容。包括: </p>
<ul>
<li>去除特殊字符、标签、乱码、重复内容。</li>
<li>文本标准化，例如 时间、单位标准化（如“今天” → “2025-07-17”）。</li>
<li>其他处理</li>
</ul>
<p>数据的清洗和标准化过程可以使用一些工具或<strong>NLTK、spaCy</strong>等NLP工具进行处理。</p>
<p>例如: </p>
<pre><code class="hljs language-bash" lang="bash">&lt;p&gt;ROMA框架&lt;/p&gt;
处理：
<span class="hljs-string">"ROMA框架"</span>
今天的室外温度为35°C，天气晴朗。
处理：
<span class="hljs-string">"2025-07-17 的室外温度为35°C，天气晴朗"</span>
</code></pre>
<p>c. 元数据提取</p>
<p>关于数据的数据，用于描述和提供有关数据的附加信息。</p>
<ul>
<li><strong>文档来源</strong>：文档的出处，例如URL、文件名、数据库记录等。</li>
<li><strong>创建时间</strong>：文档的创建或更新时间。</li>
<li><strong>作者信息</strong>：文档的作者或编辑者。</li>
<li><strong>文档类型</strong>：文档的类型，如新闻文章、学术论文、博客等。</li>
</ul>
<p>元数据在RAG中也非常重要，不仅提供了额外的上下文信息，还能提升检索质量：</p>
<ol>
<li><strong>检索增强</strong></li>
</ol>
<ul>
<li>精准过滤：按时间、作者、主题等缩小搜索范围</li>
<li>相关性提升：结合向量相似度和元数据特征提高检索准确性</li>
</ul>
<p>ii. 上下文丰富</p>
<ul>
<li>来源标注：提供文档来源、作者、发布日期等信息</li>
<li>文档关系：展示文档间的层级或引用关系</li>
</ul>
<p>iii. 常见的元数据提取方式:</p>
<ul>
<li>正则/HTML/... 等解析工具，提取标题、作者、日期等</li>
<li>自然语言处理: 使用NLP技术（如命名实体识别、关键词提取）从文档内容中提取元数据，如人名、地名、组织名、关键词等</li>
<li>机器学习模型:  训练机器学习模型来自动提取元数据</li>
<li>通过调用外部API（如Google Scholar API、Wikipedia API）获取文档的元数据</li>
</ul>
<p>例如：</p>
<pre><code class="hljs language-bash" lang="bash">complete_metadata_chunk1 = {
<span class="hljs-string">'file_path'</span>: <span class="hljs-string">'/mydocs/roma_intro.md'</span>,
<span class="hljs-string">'file_name'</span>: <span class="hljs-string">'roma_intro.md'</span>,
<span class="hljs-string">'chunk_id'</span>: 0,
<span class="hljs-string">'section_title'</span>: <span class="hljs-string">'# 什么是 ROMA？'</span>,
<span class="hljs-string">'subsection_title'</span>: <span class="hljs-string">''</span>,
<span class="hljs-string">'section_type'</span>: <span class="hljs-string">'section'</span>,
<span class="hljs-string">'chunking_strategy'</span>: 3,
<span class="hljs-string">'content_type'</span>: <span class="hljs-string">'product_description'</span>,
<span class="hljs-string">'main_entity'</span>: <span class="hljs-string">'ROMA'</span>,
<span class="hljs-string">'language'</span>: <span class="hljs-string">'zh-CN'</span>,
<span class="hljs-string">'creation_date'</span>: <span class="hljs-string">'2025-07-02'</span>,  <span class="hljs-comment"># 从文件系统获取</span>
<span class="hljs-string">'word_count'</span>: 42  <span class="hljs-comment"># 计算得出,</span>
<span class="hljs-string">'topics'</span>: [<span class="hljs-string">'ROMA'</span>, <span class="hljs-string">'前端框架'</span>, <span class="hljs-string">'跨平台开发'</span>],
<span class="hljs-string">'entities'</span>: {
<span class="hljs-string">'products'</span>: [<span class="hljs-string">'ROMA'</span>, <span class="hljs-string">'Jue语言'</span>], <span class="hljs-comment"># 实体识别</span>
<span class="hljs-string">'platforms'</span>: [<span class="hljs-string">'iOS'</span>, <span class="hljs-string">'Android'</span>, <span class="hljs-string">'Web'</span>]
},
}
</code></pre>
<h4 data-id="heading-6">2.1.2 内容分块(Chunking)</h4>
<p>在RAG架构中，分块既是核心，也是挑战，它直接影响检索精度、生成质量，需要在检索精度、语境完整性和计算性能之间取得平衡。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fca9df08e1a047bbb20cd8cf9d5e09e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980728&amp;x-signature=%2Ff5qw79v4IgksDvgiSHT82amS8I%3D" alt="" loading="lazy"/></p>
<p>内容分块将长文档切分成小块，可以解决向量模型的token长度限制，使RAG更精确定位相关信息，提升检索精度和计算效率。</p>
<ul>
<li>AutoBots(JoyAgent)功能分块：</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da2e1bbf0f064702b64ba20593815329~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980728&amp;x-signature=aAjaqAE4LGImYEJJPuMDT1XeBHI%3D" alt="" loading="lazy"/></p>
<p>实际RAG框架中按照文档的特性选择合适的分块策略进行分块。</p>
<ul>
<li>
<h5 data-id="heading-7">常见的分块策略：</h5>
</li>
</ul>
<p><strong>a. 按大小分块</strong></p>
<p>按固定字符数进行分块，实现简单但可能切断语义单元。</p>
<p>优点：实现简单且计算开销小，块大小均匀便于管理。</p>
<p><strong>缺点</strong>：可能切断语义单元，如句子或段落被分到不同块中。</p>
<p>例如：</p>
<pre><code class="hljs language-scss" lang="scss">第一段：# ROMA框架介绍ROMA是一个全自主研发的前端开发框架，基于自定义<span class="hljs-built_in">DSL</span>(Jue语言)。
一份代码，可在iOS、Android、Harmony
第二段：、Web三端运行的跨平台解决方案。ROMA框架的中文名为罗码。
</code></pre>
<p>句子被截断，"一份代码，可在iOS、Android、Harmony" 和 "、Web三端运行的跨平台解决方案" 被分到不同块，影响理解。</p>
<p>b. 按段落分块</p>
<p>以段落为基本单位进行分块，保持段落完整性，但段落长度可能差异很大。</p>
<p><strong>优点</strong>：尊重文档自然结构，保留完整语义单元。</p>
<p><strong>缺点</strong>：段落长度差异大，可能导致块大小不均衡。</p>
<p>例如：</p>
<pre><code class="hljs language-bash" lang="bash">第一段：<span class="hljs-comment"># ROMA框架介绍ROMA是一个全自主研发的前端开发框架，基于自定义DSL(Jue语言)。</span>
一份代码，可在iOS、Android、Harmony、Web三端运行的跨平台解决方案。ROMA框架的中文名为罗码。
第二段：<span class="hljs-comment"># 核心特性1. 跨平台：一套代码运行于多端2. 高性能：接近原生的性能表现3. 可扩展：丰富的插件系统</span>
</code></pre>
<p>第一段包含标题和多行内容，而其他段落相对较短，可能导致检索不均衡。</p>
<p><strong>c. 按语义分块</strong></p>
<p>基于文本语义相似度进行动态分块，保持语义连贯性，但计算开销大。</p>
<p><strong>说明</strong>：基于文本语义相似度动态调整分块边界。</p>
<p><strong>优点</strong>：保持语义连贯性，能识别内容主题边界。</p>
<p>例如：</p>
<pre><code class="hljs language-bash" lang="bash">第一段：<span class="hljs-comment"># ROMA框架介绍ROMA是一个全自主研发的前端开发框架，基于自定义DSL(Jue语言)。</span>
一份代码，可在iOS、Android、Harmony、Web四端运行的跨平台解决方案。
第二段：ROMA框架的中文名为罗码。
<span class="hljs-comment">## 核心特性1. 跨平台：一套代码运行于多端</span>
</code></pre>
<p>使用依赖模型质量，相同文本在不同运行中可能产生不同分块结果。</p>
<p><strong>d. 分块策略总结</strong></p>
<p><strong><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68d8e50d5b2845f3bb68027ec0270090~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980728&amp;x-signature=i5q2elWGV7Sr3hxOt1YKwyyFJSY%3D" alt="" loading="lazy"/></strong></p>
<p><strong>e. 优化方式</strong></p>
<ul>
<li><strong>混合分块策略</strong></li>
</ul>
<p>结合多种分块方法的优点，如先按段落分块，再根据块大小调整，做到既保持语义完整性，又能控制块大小均匀</p>
<ul>
<li>优化重叠区域</li>
</ul>
<p>根据内容特性动态调整块之间的重叠区域大小，关键信息出现在多个块中，提高检索召回率</p>
<h5 data-id="heading-8"><strong>f. 常用的分块工具</strong></h5>
<ul>
<li><strong>Lang Chain框架</strong>：提供多种分块策略，包括RecursiveCharacterTextSplitter、MarkdownTextSplitter等</li>
<li><strong>NLTK</strong>：用于基于自然语言句子的分块</li>
<li><strong>spaCy</strong>：提供语言学感知的文本分割</li>
</ul>
<h4 data-id="heading-9">2.1.3 向量化</h4>
<p>将高维文本数据压缩到低维空间，便于处理和存储。将文本转换为计算机可以理解的数值，使得计算机能够理解和处理语义信息，从而在海量数据文本中实现快速、高效的相似度计算和检索。</p>
<p>简单理解：通过一组数字来代表文本内容的“本质”。</p>
<p>例如，“ROMA是一个跨平台解决方案...”这句话可能被转换为一个384维的向量：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[块1]</span> 什么是ROMA？
ROMA是一个全自主研发的前端开发框架，基于自定义<span class="hljs-built_in">DSL</span>(Jue语言)...
<span class="hljs-selector-attr">[{<span class="hljs-string">"chunk_id"</span>: <span class="hljs-string">"doc1_chunk1"</span>,<span class="hljs-string">"text"</span>: <span class="hljs-string">"# 什么是 ROMA？\nROMA 是一个全自主研发的前端开发基于自定义DSL(Jue语言)，一份代码，可在iOS、Android、Harmony、Web端运行的跨平台解决方案。"</span>,<span class="hljs-string">"vector"</span>: [0.041, -0.018, 0.063, ..., 0.027]</span>,
"metadata": {
"source": <span class="hljs-string">"roma_introduction.md"</span>,
<span class="hljs-string">"position"</span>: <span class="hljs-number">0</span>,
<span class="hljs-string">"title"</span>: <span class="hljs-string">"ROMA框架介绍"</span>
}
},
<span class="hljs-comment">// 更多文档块...</span>
]
</code></pre>
<ul>
<li><strong>常用的Embedding模型：</strong></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49b17a48baec40a386bc5e9eddc89dd5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980728&amp;x-signature=HyRwgbb0Z%2BltqJSPQl7AMv24%2Fg8%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-10"/>
<h4 data-id="heading-11"><strong>2.1.4 向量数据库入库</strong></h4>
<p>将生成的向量数据和元数据进行存储，同时创建索引结构来支持快速相似性搜索。</p>
<ul>
<li><strong>常用的向量数据库包括：</strong></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1e98e85a42240f298306e1e8be66efc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980728&amp;x-signature=QXr85eJQIrEbQSauR6AJemfnbqY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">2.2 问答阶段</h3>
<h3 data-id="heading-13">2.2.1 查询预处理</h3>
<ul>
<li>
<h3 data-id="heading-14">意图识别：使用分类模型区分问题类型（事实查询、建议、闲聊等）。</h3>
</li>
<li>
<h3 data-id="heading-15">问题预处理：问题内容清洗和标准化，过程与前面数据预处理类似。</h3>
</li>
<li>
<h3 data-id="heading-16">查询增强：使用知识库或LLM生成同义词（如“动态化” → “Roma”），上下文补全可以结合历史会话总结（例如用户之前问过“Roma是什么”）。</h3>
</li>
</ul>
<h4 data-id="heading-17"><strong>2.2.2 数据检索(召回)</strong></h4>
<h4 data-id="heading-18"><strong>a. 向量化</strong></h4>
<p>使用与入库前数据向量化相同的模型，将处理后的问题内容向量化。</p>
<p>例如：</p>
<pre><code class="hljs language-css" lang="css">问题: <span class="hljs-string">"ROMA是什么?"</span>
处理后
{
"vector": [<span class="hljs-number">0.052</span>, -<span class="hljs-number">0.021</span>, <span class="hljs-number">0.075</span>, ..., <span class="hljs-number">0.033</span>],
<span class="hljs-string">"top_k"</span>: <span class="hljs-number">3</span>,
<span class="hljs-string">"score_threshold"</span>: <span class="hljs-number">0.8</span>,
<span class="hljs-string">"filter"</span>: {"doc_type": <span class="hljs-string">"技术文档"</span>}
}
</code></pre>
<h5 data-id="heading-19"><strong>b. 检索</strong></h5>
<ul>
<li>相似度检索：查询向量与所存储的向量最相似(通过余弦相似度匹配)的前 top_k 个文档块。</li>
<li>关键词检索：倒排索引的传统方法,检索包含“Roma”、“优势”等精确关键词的文档。</li>
<li>混合检索：合并上面多种检索结果，效果最优。</li>
</ul>
<p>例如：检索“ROMA是什么?”</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8507791f9d7e465baa630696eeaeab63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980728&amp;x-signature=XHBPEWzm5Qxfs1Qywlz37aTN1Ys%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-20"><strong>c. 重排序(Reranking)</strong></h5>
<p>初步检索在精度和语义理解上的不足，通过更精细的上下文分析提升结果相关性。它能更好处理同义词替换、一词多义等语义细微差异，使最终结果准确。</p>
<ul>
<li>原理：使用模型对每个检索结果计算相关性分数。</li>
<li>归一化：重排序模型原始输出分数没有固定的范围，它可能是任意实数，将结果归一化处理，将分数映射到 [0, 1] 范围内，使其更容易与向量相似度分数进行比较。</li>
</ul>
<p>例如：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7edad535c0942678b7403740b1d8876~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980728&amp;x-signature=AlUML6Pn%2BV1n5p84JW6MtPdrPDk%3D" alt="" loading="lazy"/></p>
<ul>
<li>常用的重排序模型：</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bd66d6756f34e6284f39d99a59a4106~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980728&amp;x-signature=E4nZM4Ry7EfTDxruh8G2SpsPSM0%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-21"><strong>2.2.3 信息整合</strong></h4>
<p>格式化检索的结果，构建提示词模板，同时将搜索的内容截断或摘要长文本以适应LLM上下文窗口token。</p>
<p>提示词优化：</p>
<ol>
<li>限定回答范围</li>
<li>要求标注来源</li>
<li>设置拒绝回答规则</li>
<li>...</li>
</ol>
<p>例如：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">prompt</span> 模板：
你是一名<span class="hljs-selector-tag">ROMA</span>框架专家，请基于以下上下文回答：
参考信息:
<span class="hljs-selector-attr">[文档1]</span> 什么是 <span class="hljs-selector-tag">ROMA</span>？
<span class="hljs-selector-tag">ROMA</span> 是一个全自主研发的前端开发基于自定义<span class="hljs-selector-tag">DSL</span>(Jue语言)，一份代码，可在<span class="hljs-selector-tag">iOS</span>、<span class="hljs-selector-tag">Android</span>、<span class="hljs-selector-tag">Harmony</span>、<span class="hljs-selector-tag">Web</span>四端运行的跨平台解决方案。
<span class="hljs-selector-tag">ROMA</span> 框架的中文名为罗码。
<span class="hljs-selector-attr">[文档2]</span> <span class="hljs-selector-tag">Roma</span>介绍？
<span class="hljs-selector-attr">[Roma介绍]</span>(docs/guide/guide/introduction.md)
文档地址: <span class="hljs-selector-tag">https</span>:<span class="hljs-comment">//roma-design.jd.com/docs/guide/guide/introduction.html</span>
要求：
<span class="hljs-number">1</span>. 分步骤说明，含代码示例
<span class="hljs-number">2</span>. 标注来源文档版本
<span class="hljs-number">3</span>. 如果参考信息中没有相关内容，请直接说明无法回答，不要编造信息
请基于以下参考信息回答用户的问题。如果参考信息中没有相关内容，请直接说明无法回答，不要编造信息。
用户问题: <span class="hljs-selector-tag">ROMA</span>是什么？
回答: {<span class="hljs-selector-tag">answer</span>}
</code></pre>
<h4 data-id="heading-22"><strong>2.2.4 LLM生成</strong></h4>
<p>向LLM（如GPT-4、Claude）发送提示，获取生成结果。</p>
<ul>
<li>AutoBots(JoyAgent)示例：</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4a819d3c165478db42301782cdcd42e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980728&amp;x-signature=b6dqJn%2FQqhBs00o%2BiQBGlPLzVmM%3D" alt="" loading="lazy"/></p>
<p>以上，实现了最简单的RAG流程。实际的RAG过程会比上述麻烦更多，包括图片、表格等多模态内容的处理，更复杂的文本解析和预处理过程，文档格式的兼容，结构化与非结构化数据的兼容等等。</p>
<p>最后，展示一下RAG各阶段的优化方式：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/448a68ba3ccf40b1b2cfd0f34880f184~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766980728&amp;x-signature=dycYOqrUNMnDkw9JdDEYlsG9sbc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-23">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js 原生功能狂飙，15 个热门 npm 包要失业了]]></title>    <link>https://juejin.cn/post/7586192313635389474</link>    <guid>https://juejin.cn/post/7586192313635389474</guid>    <pubDate>2025-12-22T04:00:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586192313635389474" data-draft-id="7586136543954812966" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js 原生功能狂飙，15 个热门 npm 包要失业了"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2025-12-22T04:00:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Immerse"/> <meta itemprop="url" content="https://juejin.cn/user/2708812817761752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js 原生功能狂飙，15 个热门 npm 包要失业了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2708812817761752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Immerse
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T04:00:10.000Z" title="Mon Dec 22 2025 04:00:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是 Immerse，一名独立开发者、内容创作者、AGI 实践者。</p>
<p>关注公众号：<a href="https://link.juejin.cn?target=https%3A%2F%2Fyaolifeng.com%2Fother%2Fwx_public_account.webp" target="_blank" title="https://yaolifeng.com/other/wx_public_account.webp" ref="nofollow noopener noreferrer">沉浸式趣谈</a>，获取最新文章（更多内容只在公众号更新）</p>
<p>个人网站：<a href="https://link.juejin.cn?target=https%3A%2F%2Fyaolifeng.com" target="_blank" title="https://yaolifeng.com" ref="nofollow noopener noreferrer">yaolifeng.com</a> 也同步更新。</p>
<p>转载请在文章开头注明出处和版权信息。</p>
<p>我会在这里分享关于<code>编程</code>、<code>独立开发</code>、<code>AI干货</code>、<code>开源</code>、<code>个人思考</code>等内容。</p>
<p>如果本文对您有所帮助，欢迎动动小手指一键三连(<code>点赞</code>、<code>评论</code>、<code>转发</code>)，给我一些支持和鼓励，谢谢！</p>
<hr/>
<p>之前装个 Node.js 项目，npm 包能装一大堆。</p>
<p>现在发现很多包其实不用装了，Node.js 自己就支持。</p>
<p>这次整理了 15 个已经被 Node.js 原生功能替代的热门 npm 包。</p>
<p>有些已经稳定了，有些还在实验阶段，但都能用起来了。</p>
<h2 data-id="heading-0">fetch 终于成全局函数了</h2>
<p>以前在 Node.js 里用 fetch，必须装 node-fetch。</p>
<p>现在 Node.js 18 开始，fetch 已经是全局函数了，和浏览器里的用法完全一样。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">"https://api.github.com/repos/nodejs/node"</span>);
<span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data.<span class="hljs-property">full_name</span>);
</code></pre>
<p>直接就能用，不用装任何包。</p>
<p>Node.js 17.5 开始实验性支持，到 18 就稳定了。</p>
<p>如果你的项目还在用 Node.js 18 之前的版本，那还是得装 node-fetch。</p>
<h2 data-id="heading-1">WebSocket 也原生支持了</h2>
<p>之前做 WebSocket 客户端，基本都用 ws 这个包。</p>
<p>现在 Node.js 有了全局的 WebSocket 类。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> ws = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-string">"wss://echo.websocket.org"</span>);

ws.<span class="hljs-property">onopen</span> = <span class="hljs-function">() =&gt;</span> ws.<span class="hljs-title function_">send</span>(<span class="hljs-string">"Hello!"</span>);
ws.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Received:"</span>, event.<span class="hljs-property">data</span>);
</code></pre>
<p>Node.js 21 加的，不过还是实验性的。</p>
<p>要注意的是，这只是客户端支持。</p>
<p>如果要做 WebSocket 服务端，还是得用 ws 或者其他库。</p>
<h2 data-id="heading-2">测试框架不用装了</h2>
<p>以前写测试，要装 mocha、jest 这些框架。</p>
<p>现在 Node.js 自带测试模块 node:test。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> test <span class="hljs-keyword">from</span> <span class="hljs-string">"node:test"</span>;
<span class="hljs-keyword">import</span> assert <span class="hljs-keyword">from</span> <span class="hljs-string">"node:assert"</span>;

<span class="hljs-title function_">test</span>(<span class="hljs-string">"addition works"</span>, <span class="hljs-function">() =&gt;</span> {
  assert.<span class="hljs-title function_">strictEqual</span>(<span class="hljs-number">2</span> + <span class="hljs-number">2</span>, <span class="hljs-number">4</span>);
});
</code></pre>
<p>Node.js 18 加的实验性功能，到 20 就稳定了。</p>
<p>如果需要快照测试、mock 这些高级功能，第三方框架还是更强。</p>
<p>不过对于模块级别的测试，node:test 完全够用了。</p>
<h2 data-id="heading-3">SQLite 也要原生支持了</h2>
<p>之前用 SQLite，要装 sqlite3 或 better-sqlite3。</p>
<p>这俩包都需要编译原生模块，升级 Node.js 版本经常出问题。</p>
<p>现在 Node.js 在开发 node:sqlite 模块。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { open } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:sqlite"</span>;

<span class="hljs-keyword">const</span> db = <span class="hljs-keyword">await</span> <span class="hljs-title function_">open</span>(<span class="hljs-string">":memory:"</span>);
<span class="hljs-keyword">await</span> db.<span class="hljs-title function_">exec</span>(<span class="hljs-string">"CREATE TABLE users (id INTEGER, name TEXT)"</span>);
</code></pre>
<p>不过还是实验性的，等稳定了就能彻底告别编译问题了。</p>
<h2 data-id="heading-4">控制台彩色输出不用装 chalk 了</h2>
<p>给控制台输出加颜色，以前都用 chalk 或 kleur。</p>
<p>现在 Node.js 有 util.styleText 函数。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { styleText } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:util"</span>;

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">styleText</span>(<span class="hljs-string">"red"</span>, <span class="hljs-string">"Error!"</span>));
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">styleText</span>([<span class="hljs-string">"bold"</span>, <span class="hljs-string">"green"</span>], <span class="hljs-string">"Success!"</span>));
</code></pre>
<p>Node.js 20.12 加的，到 22.17 就稳定了。</p>
<p>如果需要复杂的主题配置或链式调用，chalk 还是更好用。</p>
<p>但简单的颜色输出，原生的就够了。</p>
<h2 data-id="heading-5">清理 ANSI 码也不用装包了</h2>
<p>以前要去掉日志里的 ANSI 转义码，得装 strip-ansi。</p>
<p>现在有 util.stripVTControlCharacters 函数。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { stripVTControlCharacters } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:util"</span>;

<span class="hljs-keyword">const</span> text = <span class="hljs-string">"\u001B[4mUnderlined\u001B[0m"</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">stripVTControlCharacters</span>(text));
</code></pre>
<p>原生处理，稳定可靠。</p>
<p>基本不需要再装第三方包了。</p>
<h2 data-id="heading-6">glob 匹配文件也原生了</h2>
<p>匹配文件路径，以前必须用 glob 包。</p>
<p>Node.js 22 开始有 fs.glob 函数了。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">"node:fs/promises"</span>;

<span class="hljs-keyword">const</span> files = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">glob</span>(<span class="hljs-string">"**/*.js"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(files);
</code></pre>
<p>22 版本就稳定了，可以放心用。</p>
<p>老项目还在用旧版本 Node.js 的话，还是得继续用 glob 包。</p>
<h2 data-id="heading-7">递归删除目录不用 rimraf 了</h2>
<p>删除整个目录树，以前都用 rimraf。</p>
<p>现在 fs.rm 直接支持递归删除。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">"node:fs/promises"</span>;

<span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">rm</span>(<span class="hljs-string">"dist"</span>, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">force</span>: <span class="hljs-literal">true</span> });
</code></pre>
<p>Node.js 12.10 就有了，现在所有 LTS 版本都稳定支持。</p>
<h2 data-id="heading-8">递归创建目录也不用 mkdir 了</h2>
<p>创建多级目录，以前要装 mkdir。</p>
<p>现在 fs.mkdir 原生支持。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">mkdir</span>(<span class="hljs-string">"logs/app"</span>, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> });
</code></pre>
<p>Node.js 10.12 就加了，早就稳定了。</p>
<h2 data-id="heading-9">UUID 生成不用装包了</h2>
<p>生成 UUID v4，以前要装 uuid 包。</p>
<p>现在 crypto 模块自带 randomUUID 函数。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { randomUUID } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:crypto"</span>;

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">randomUUID</span>());
</code></pre>
<p>Node.js 14.17 就有了，稳定版本。</p>
<h2 data-id="heading-10">Base64 编解码也原生支持了</h2>
<p>以前要 polyfill atob 和 btoa 函数。</p>
<p>现在这俩已经是全局函数了。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> encoded = <span class="hljs-title function_">btoa</span>(<span class="hljs-string">"hello"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(encoded);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">atob</span>(encoded));
</code></pre>
<p>Buffer 一直都有，现在加上 atob 和 btoa，浏览器和 Node.js 的代码终于统一了。</p>
<p>Node.js 20 左右加的，现在 LTS 版本都有。</p>
<h2 data-id="heading-11">URL 路由匹配有了 URLPattern</h2>
<p>做路由匹配，以前要装 url-pattern。</p>
<p>现在有全局的 URLPattern API。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> pattern = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLPattern</span>({ <span class="hljs-attr">pathname</span>: <span class="hljs-string">"/users/:id"</span> });
<span class="hljs-keyword">const</span> match = pattern.<span class="hljs-title function_">exec</span>(<span class="hljs-string">"/users/42"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(match.<span class="hljs-property">pathname</span>.<span class="hljs-property">groups</span>.<span class="hljs-property">id</span>);
</code></pre>
<p>Node.js 20 加的，不过还是实验性的。</p>
<p>但已经能用了，而且和浏览器的 URLPattern 完全一样。</p>
<h2 data-id="heading-12">加载 .env 文件不一定要 dotenv 了</h2>
<p>之前加载环境变量文件，必须装 dotenv。</p>
<p>现在可以用 --env-file 参数。</p>
<pre><code class="hljs language-ini" lang="ini">node <span class="hljs-attr">--env-file</span>=.env app.js
</code></pre>
<p>Node.js 20.10 加的实验性功能。</p>
<p>如果需要变量展开或多文件支持，dotenv 还是更强。</p>
<p>但简单场景下，原生的就够了。</p>
<h2 data-id="heading-13">EventTarget 也是全局的了</h2>
<p>以前 Node.js 只有 EventEmitter，要用 Web 标准的 EventTarget 得装 event-target-shim。</p>
<p>现在 EventTarget 已经是全局的了。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> target = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventTarget</span>();
target.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"ping"</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"pong"</span>));
target.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">"ping"</span>));
</code></pre>
<p>Node.js 15 加的，15.4 就稳定了。</p>
<p>浏览器和 Node.js 终于可以用同样的事件 API 了。</p>
<h2 data-id="heading-14">运行 TypeScript 不一定要 tsc 了</h2>
<p>以前运行 .ts 文件，要装 TypeScript 编译器或 ts-node。</p>
<p>现在 Node.js 有实验性的 TypeScript 支持。</p>
<pre><code class="hljs language-css" lang="css">node <span class="hljs-attr">--experimental-strip-types</span> app<span class="hljs-selector-class">.ts</span>
</code></pre>
<p>Node.js 21 加的实验性功能。</p>
<p>不过这只是去掉类型标注，不做类型检查。</p>
<p>生产环境还是得用完整的 TypeScript 工具链。</p>
<h2 data-id="heading-15">为啥 Node.js 要把这些功能内置</h2>
<p>看这些变化，能发现一个趋势。</p>
<p>以前需要外部依赖的功能，现在越来越多变成了核心功能。</p>
<p>这样做有几个好处。</p>
<p>减少依赖数量，项目更轻量。</p>
<p>降低供应链攻击风险，不用担心某个包被投毒。</p>
<p>代码在浏览器和服务端之间更容易移植。</p>
<h2 data-id="heading-16">能用就用起来</h2>
<p>这些原生功能，浏览器支持好的就可以直接用了。</p>
<p>实验性的功能可以在开发环境先试试。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[nest.js / hono.js 一起学！日志功能/统一返回格式/错误处理]]></title>    <link>https://juejin.cn/post/7585798113547829298</link>    <guid>https://juejin.cn/post/7585798113547829298</guid>    <pubDate>2025-12-22T02:14:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585798113547829298" data-draft-id="7450771973871091724" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="nest.js / hono.js 一起学！日志功能/统一返回格式/错误处理"/> <meta itemprop="keywords" content="Node.js,前端"/> <meta itemprop="datePublished" content="2025-12-22T02:14:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="孟祥_成都"/> <meta itemprop="url" content="https://juejin.cn/user/96412752684744"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            nest.js / hono.js 一起学！日志功能/统一返回格式/错误处理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/96412752684744/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    孟祥_成都
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:14:42.000Z" title="Mon Dec 22 2025 02:14:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在继续搭建 <strong>NestJS</strong> 和 <strong>Hono.js</strong> 的通用框架之前，可以先回顾一下前几篇文章：</p>
<ul>
<li><a href="https://juejin.cn/post/7576555431943503882" target="_blank" title="https://juejin.cn/post/7576555431943503882">深入 NestJS 底层概念（1）：依赖注入和面向切面编程 AOP</a></li>
<li><a href="https://juejin.cn/post/7580564126403362866" target="_blank" title="https://juejin.cn/post/7580564126403362866">NestJS / Hono.js 一起学！Hono 的设计思想</a></li>
<li><a href="https://juejin.cn/post/7581448482544713754" target="_blank" title="https://juejin.cn/post/7581448482544713754">NestJS / Hono.js 一起学！开发前必备</a></li>
<li><a href="https://juejin.cn/post/7583727768543199268" target="_blank" title="https://juejin.cn/post/7583727768543199268">NestJS / Hono.js 一起学！字节团队如何配置多环境攻略</a></li>
</ul>
<p>本篇文章主要实现 <strong>NestJS 与 Hono.js</strong> 的以下功能：</p>
<ol>
<li><strong>打印日志 &amp; 收集日志</strong></li>
<li><strong>统一返回前端的数据格式</strong></li>
<li><strong>统一错误处理</strong></li>
</ol>
<p>这些功能在很多 NestJS 教程中都有覆盖，但我们会在此基础上做一些增强：</p>
<ul>
<li>
<p><strong>日志打印增加 <code>traceId</code> 功能</strong></p>
<ul>
<li>在 Node.js 高并发场景下，<strong>每个请求的 traceId 必须独立</strong>，因为它是<strong>单线程异步</strong>模型，如果我们像写传统同步代码那样直接定义一个全局变量来存 <code>traceId</code>，就会发生严重的“串号”现象。</li>
</ul>
</li>
</ul>
<p><strong>案例：</strong></p>
<p>假设我们有一个 Web 服务，同时收到两个用户请求：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> traceId; <span class="hljs-comment">// 全局变量</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleRequest</span>(<span class="hljs-params">user</span>) {
  traceId = <span class="hljs-string">`trace-<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">1000</span>)}</span>`</span>; <span class="hljs-comment">// 给当前请求生成 traceId</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[<span class="hljs-subst">${traceId}</span>] 开始处理 <span class="hljs-subst">${user}</span> 的请求`</span>);

  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 异步操作，可能晚于其他请求执行</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[<span class="hljs-subst">${traceId}</span>] 完成处理 <span class="hljs-subst">${user}</span> 的请求`</span>);
  }, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">1000</span>);
}

<span class="hljs-comment">// 模拟两个用户几乎同时发起请求</span>
<span class="hljs-title function_">handleRequest</span>(<span class="hljs-string">'Alice'</span>);
<span class="hljs-title function_">handleRequest</span>(<span class="hljs-string">'Bob'</span>);
</code></pre>
<p><strong>可能的输出（串号）</strong> ：</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">trace-532</span>] 开始处理 Alice 的请求
[<span class="hljs-meta">trace-764</span>] 开始处理 Bob 的请求
[<span class="hljs-meta">trace-764</span>] 完成处理 Alice 的请求   ← 错误，日志 traceId 被覆盖，因为全局目前的 traceId 已经是 trace<span class="hljs-number">-764</span> 了
[<span class="hljs-meta">trace-764</span>] 完成处理 Bob 的请求
</code></pre>
<p>以上的问题有些笨办法可以处理，但我们最终会借助 node.js AsyncLocalStorage（在 nest.js 有对应模块，简单实现，在 hono.js 中我们自己封装一个类似功能的模块。）</p>
<p>还有一个必须了解的，这个 traceId 是服务端必须有的，因为我们的处理一个用户请求会经过很多中间件很多不同的模块处理，如何判断经过这么多模块的某个请求是同一个请求，就要用这个 traceId 来记录。</p>
<ul>
<li>
<p><strong>统一返回前端的数据格式</strong>，例如，我们希望所有接口返回：</p>
<pre><code class="hljs language-css" lang="css">```
{
  "<span class="hljs-selector-tag">code</span>": <span class="hljs-number">0</span>,
  <span class="hljs-string">"data"</span>: {...},
  "message": <span class="hljs-string">"success"</span>
}
```
</code></pre>
<ul>
<li><strong>可选配置</strong>：某些路由可以跳过统一格式返回。</li>
</ul>
</li>
</ul>
<hr/>
<p>接下来，我们将先从 nest.js 框架开始，逐步实现这些功能。</p>
<h2 data-id="heading-1">nest.js 配置</h2>
<h3 data-id="heading-2">链路日志追踪功能</h3>
<p>这套系统的灵魂在于 <code>nestjs-cls</code> 和 <code>Winston</code> 的结合。</p>
<p>为什么要这么做？</p>
<p>在 Node.js 异步环境中，传统的全局变量无法区分哪个日志属于哪个用户请求。</p>
<ul>
<li><strong>ClsModule (上下文存储)</strong> ：就像给每个进站的乘客（请求）发一个专属的“透明信封”。这个信封里装着 <code>traceId</code>。</li>
<li><strong>Winston (记录员)</strong> ：当程序需要记录日志时，记录员会从这个“信封”里掏出 <code>traceId</code> 盖在日志条目上。</li>
</ul>
<p>这样，即便服务器同时处理 1000 个请求，你只需要在日志里搜索特定的 <code>traceId</code>，就能看到该请求从“进入”到“报错”的所有心路历程。</p>
<hr/>
<h3 data-id="heading-3">代码功能深度拆解</h3>
<p>我们将代码逻辑分为三个核心模块来理解：</p>
<h4 data-id="heading-4">第一部分：CLS 上下文初始化 (AppModule)</h4>
<p>这是全链路追踪的起点。在根 module 配置，也就是 app.module.ts中增加：</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigModule</span>, <span class="hljs-title class_">ConfigService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ClsModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'nestjs-cls'</span>;
<span class="hljs-keyword">import</span> { randomUUID } <span class="hljs-keyword">from</span> <span class="hljs-string">'crypto'</span>;

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [
    <span class="hljs-comment">// 之前文章讲的环境变量配置模块</span>
    <span class="hljs-title class_">ConfigModule</span>.<span class="hljs-title function_">forRoot</span>({
      <span class="hljs-attr">isGlobal</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 全局可用，无需在每个模块导入</span>
      <span class="hljs-attr">load</span>: [initConfig], <span class="hljs-comment">// 使用自定义加载器</span>
    }),
    <span class="hljs-comment">// 1. 初始化 CLS 上下文，并自动生成 traceId</span>
    <span class="hljs-title class_">ClsModule</span>.<span class="hljs-title function_">forRoot</span>({
      <span class="hljs-attr">global</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">middleware</span>: {
        <span class="hljs-attr">mount</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">generateId</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">idGenerator</span>: <span class="hljs-function">(<span class="hljs-params">req: <span class="hljs-built_in">any</span></span>) =&gt;</span>
          (req.<span class="hljs-property">headers</span>[<span class="hljs-string">'x-request-id'</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>) ?? <span class="hljs-title function_">randomUUID</span>(), <span class="hljs-comment">// 优先使用 header 中的 ID</span>
      },
    }),
  ],
  <span class="hljs-attr">controllers</span>: [],
  <span class="hljs-attr">providers</span>: [],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppModule</span> {}

</code></pre>
<p>通过优先读取 <code>x-request-id</code>，我们可以实现跨系统的全链路追踪（如果你的前端或上游网关也带了这个 ID，就能实现真正的端到端打通）。</p>
<p>这里我们简单说下 ClsModule 实现的基本原理：</p>
<p>我们分三步来实现：</p>
<ul>
<li>第一步：封装 ALS 工具类</li>
</ul>
<p>这是我们的“储物柜”管理器。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// cls.service.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AsyncLocalStorage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'async_hooks'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClsService</span> {
  <span class="hljs-comment">// 1. 创建一个物理存储对象</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> storage = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncLocalStorage</span>&lt;<span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;&gt;();

  <span class="hljs-comment">// 2. 启动上下文（包裹请求）</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">callback: () =&gt; <span class="hljs-built_in">void</span></span>) {
    <span class="hljs-keyword">const</span> store = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span>.<span class="hljs-title function_">run</span>(store, callback);
  }

  <span class="hljs-comment">// 3. 存储数据</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">set</span>(<span class="hljs-params">key: <span class="hljs-built_in">string</span>, value: <span class="hljs-built_in">any</span></span>) {
    <span class="hljs-keyword">const</span> store = <span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span>.<span class="hljs-title function_">getStore</span>();
    <span class="hljs-keyword">if</span> (store) store.<span class="hljs-title function_">set</span>(key, value);
  }

  <span class="hljs-comment">// 4. 获取数据</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">key: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-keyword">const</span> store = <span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span>.<span class="hljs-title function_">getStore</span>();
    <span class="hljs-keyword">return</span> store?.<span class="hljs-title function_">get</span>(key);
  }
}
</code></pre>
<ul>
<li>编写中间件 (Middleware)</li>
</ul>
<p>在 NestJS 中，中间件是请求进来的第一站，我们在这里“开启”储物柜。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// cls.middleware.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span>, <span class="hljs-title class_">NestMiddleware</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { randomUUID } <span class="hljs-keyword">from</span> <span class="hljs-string">'crypto'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">MyClsService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./cls.service'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClsMiddleware</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NestMiddleware</span> {
  <span class="hljs-title function_">use</span>(<span class="hljs-params">req: <span class="hljs-built_in">any</span>, res: <span class="hljs-built_in">any</span>, next: () =&gt; <span class="hljs-built_in">void</span></span>) {
    <span class="hljs-comment">// 关键点：将后续所有的逻辑（next）都运行在 MyClsService.run 的回调里</span>
    <span class="hljs-title class_">MyClsService</span>.<span class="hljs-title function_">run</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> traceId = req.<span class="hljs-property">headers</span>[<span class="hljs-string">'x-request-id'</span>] || <span class="hljs-title function_">randomUUID</span>();
      <span class="hljs-title class_">MyClsService</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">'traceId'</span>, traceId); <span class="hljs-comment">// 存入 traceId</span>
      <span class="hljs-title function_">next</span>();
    });
  }
}
</code></pre>
<p>这个中间件添加之后，意味着所有的请求都会有一个 traceId 值，那在其它地方如何调用呢？请看</p>
<ul>
<li>第三步：在任何地方使用</li>
</ul>
<p>由于 <code>AsyncLocalStorage</code> 跟踪的是异步调用栈，你不再需要通过参数传递 <code>traceId</code>。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// any.service.ts</span>
<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AnyService</span> {
  <span class="hljs-title function_">doSomething</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 像变魔术一样，直接拿！</span>
    <span class="hljs-keyword">const</span> traceId = <span class="hljs-title class_">MyClsService</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'traceId'</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[当前任务] TraceID 是: <span class="hljs-subst">${traceId}</span>`</span>);
  }
}
</code></pre>
<p>我们接着讲日志功能，</p>
<h3 data-id="heading-5">第二部分：Winston 动态工厂 (common/logger)</h3>
<p>这里体现了<strong>环境差异化处理</strong>的思想。</p>

























<table><thead><tr><th><strong>特性</strong></th><th><strong>开发环境 (Development)</strong></th><th><strong>生产环境 (Production)</strong></th></tr></thead><tbody><tr><td><strong>输出目标</strong></td><td>只有控制台 (Console)</td><td>控制台 + 每日滚动文件 (Daily File)</td></tr><tr><td><strong>展示样式</strong></td><td>漂亮的彩色、缩进、Nest 风格</td><td>严谨的 JSON 格式（方便日志分析系统 ELK 抓取）</td></tr><tr><td><strong>日志保留</strong></td><td>随启随看</td><td>保留 14 天，单文件 20MB（防止硬盘爆掉）</td></tr></tbody></table>
<h3 data-id="heading-6">第三部分：异步注入 (WinstonModule.forRootAsync)</h3>
<p>这是 NestJS 的高级用法，确保日志配置是在获取到系统配置（ConfigService）之后才生成的。</p>
<p>在 app.module.ts 中增加 winston配置</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">WinstonModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'nest-winston'</span>;
<span class="hljs-keyword">import</span> { winstonConfigFactory } <span class="hljs-keyword">from</span> <span class="hljs-string">'./common/logger'</span>;

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [
     <span class="hljs-comment">// ... 其它配置</span>
    <span class="hljs-comment">// 2. 注入 Winston</span>
    <span class="hljs-comment">// 3. 使用 forRootAsync 异步加载配置</span>
    <span class="hljs-title class_">WinstonModule</span>.<span class="hljs-title function_">forRootAsync</span>({
      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">ConfigModule</span>], <span class="hljs-comment">// 导入 ConfigModule 以便使用 ConfigService</span>
      <span class="hljs-attr">inject</span>: [<span class="hljs-title class_">ConfigService</span>], <span class="hljs-comment">// 注入 ConfigService</span>
      <span class="hljs-attr">useFactory</span>: <span class="hljs-function">(<span class="hljs-params">configService: ConfigService</span>) =&gt;</span> {
        <span class="hljs-comment">// 调用我们抽离出去的配置函数</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">winstonConfigFactory</span>(configService);
      },
    }),
  ],
  <span class="hljs-attr">controllers</span>: [],
  <span class="hljs-attr">providers</span>: [],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppModule</span> {}

</code></pre>
<p>其中  winstonConfigFactory 的代码如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> winston, { transports, format } <span class="hljs-keyword">from</span> <span class="hljs-string">'winston'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'winston-daily-rotate-file'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;
<span class="hljs-keyword">import</span> { utilities <span class="hljs-keyword">as</span> nestWinstonModuleUtilities } <span class="hljs-keyword">from</span> <span class="hljs-string">'nest-winston'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ClsServiceManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'nestjs-cls'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">DEFAULT_LOG_DIR</span>, <span class="hljs-variable constant_">DIR_NAME</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'src/config/constants'</span>;

<span class="hljs-comment">// 保持之前的 format 定义不变</span>
<span class="hljs-keyword">const</span> appendRequestId = <span class="hljs-title function_">format</span>(<span class="hljs-function">(<span class="hljs-params">info</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> cls = <span class="hljs-title class_">ClsServiceManager</span>.<span class="hljs-title function_">getClsService</span>();
  <span class="hljs-keyword">const</span> traceId = cls?.<span class="hljs-property">get</span>&lt;string&gt;(<span class="hljs-string">'traceId'</span>);
  <span class="hljs-keyword">if</span> (traceId) {
    info.<span class="hljs-property">traceId</span> = traceId;
  }
  <span class="hljs-keyword">return</span> info;
});

<span class="hljs-comment">// 核心修改：导出一个 Factory 函数，而不是静态对象</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">winstonConfigFactory</span> = (<span class="hljs-params">configService: ConfigService</span>) =&gt; {
  <span class="hljs-comment">// 1. 从 ConfigService 获取配置，提供默认值</span>
  <span class="hljs-keyword">const</span> logDir = configService.<span class="hljs-property">get</span>&lt;string&gt;(<span class="hljs-variable constant_">DIR_NAME</span>, <span class="hljs-variable constant_">DEFAULT_LOG_DIR</span>);
  <span class="hljs-keyword">const</span> isProduction = configService.<span class="hljs-property">get</span>&lt;string&gt;(<span class="hljs-string">'NODE_ENV'</span>) === <span class="hljs-string">'production'</span>;

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">transports</span>: isProduction
      ? [
          <span class="hljs-comment">// 2. 定义 DailyRotateFile (使用动态路径)</span>
          <span class="hljs-comment">// 错误日志按天滚动，保留 14 天，每个文件最大 20MB</span>
          <span class="hljs-comment">// 仍然把错误打印到控制台（k8s / docker 日志）</span>
          <span class="hljs-keyword">new</span> winston.<span class="hljs-property">transports</span>.<span class="hljs-title class_">Console</span>({
            <span class="hljs-attr">level</span>: <span class="hljs-string">'error'</span>,
            <span class="hljs-attr">format</span>: winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">combine</span>(
              winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">colorize</span>(),
              winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">printf</span>(<span class="hljs-function">(<span class="hljs-params">info: any</span>) =&gt;</span> {
                <span class="hljs-keyword">const</span> trace = info.<span class="hljs-property">traceId</span> ? <span class="hljs-string">` [trace:<span class="hljs-subst">${info.traceId}</span>]`</span> : <span class="hljs-string">''</span>;
                <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${info.timestamp}</span> <span class="hljs-subst">${info.level}</span><span class="hljs-subst">${trace}</span>: <span class="hljs-subst">${info.message}</span>`</span>;
              }),
            ),
          }),
          <span class="hljs-keyword">new</span> transports.<span class="hljs-title class_">DailyRotateFile</span>({
            <span class="hljs-attr">dirname</span>: logDir, <span class="hljs-comment">// &lt;--- 这里使用了配置中的路径</span>
            <span class="hljs-attr">filename</span>: <span class="hljs-string">'error-%DATE%.log'</span>,
            <span class="hljs-attr">datePattern</span>: <span class="hljs-string">'YYYY-MM-DD'</span>,
            <span class="hljs-attr">maxSize</span>: <span class="hljs-string">'20m'</span>,
            <span class="hljs-attr">maxFiles</span>: <span class="hljs-string">'14d'</span>,
            <span class="hljs-attr">level</span>: <span class="hljs-string">'error'</span>,
            <span class="hljs-attr">format</span>: format.<span class="hljs-title function_">combine</span>(
              <span class="hljs-title function_">appendRequestId</span>(),
              format.<span class="hljs-title function_">timestamp</span>(),
              format.<span class="hljs-title function_">json</span>(),
            ),
          }),
        ]
      : [
          <span class="hljs-comment">// 3. 定义 Console Transport</span>
          <span class="hljs-comment">// 开发环境通常只需要 Console，也可以按需加 File</span>
          <span class="hljs-keyword">new</span> transports.<span class="hljs-title class_">Console</span>({
            <span class="hljs-attr">level</span>: <span class="hljs-string">'info'</span>,
            <span class="hljs-attr">format</span>: format.<span class="hljs-title function_">combine</span>(
              format.<span class="hljs-title function_">timestamp</span>(),
              nestWinstonModuleUtilities.<span class="hljs-property">format</span>.<span class="hljs-title function_">nestLike</span>(<span class="hljs-string">'MyApp'</span>, {
                <span class="hljs-attr">colors</span>: <span class="hljs-literal">true</span>,
                <span class="hljs-attr">prettyPrint</span>: <span class="hljs-literal">true</span>,
              }),
            ),
          }),
        ],
  };
};
</code></pre>
<p>注意，上面的例子，我们后续例如单机使用 docker-compose 部署也好，还是使用k8s/k3s部署也好，就不需要使用winston本身的 DailyRotateFile 功能了，可以借助 docker 或者 k8s/k3s 本身的日志轮转功能实现</p>
<p>为了让这套系统更完美，在实际应用中，你可以这样使用：</p>
<h3 data-id="heading-7">如何在 Service 中打印带 TraceId 的日志？</h3>
<p>这里使用 <code>this.logger.log</code> 的时候，你不需要手动去取 ID，因为我们在 <code>winstonConfigFactory</code> 里的 <code>appendRequestId</code> 已经自动处理了。所以会自带 traceId 属性在日志里。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Logger</span>, <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppService</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> logger = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Logger</span>(<span class="hljs-title class_">AppService</span>.<span class="hljs-property">name</span>);

  <span class="hljs-title function_">doSomething</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'这是一条带有 traceId 的业务日志！'</span>); 
    <span class="hljs-comment">// 输出结果会自动带上: {"traceId":"...", "message":"...", "timestamp":"..."}</span>
  }
}
</code></pre>
<p>接下来实现第二个功能，将返回前端的格式统一</p>
<h3 data-id="heading-8">统一返回格式</h3>
<p>统一格式，在 nest.js 中有拦截器实现（hono.js就没有拦截器的概念），很简单：</p>
<h4 data-id="heading-9">nest.js 统一返回格式：用拦截器实现标准响应结构</h4>
<p>在前后端分离的业务架构中，<strong>统一接口返回格式</strong>已成为标配：<br/>
无论后端返回什么，都应该在一层标准的格式中输出，例如：</p>
<pre><code class="hljs language-typescript" lang="typescript">{
  <span class="hljs-string">"code"</span>: <span class="hljs-number">0</span>,
  <span class="hljs-string">"message"</span>: <span class="hljs-string">"OK"</span>,
  <span class="hljs-string">"data"</span>: {...},
  <span class="hljs-string">"traceId"</span>: <span class="hljs-string">"xxx"</span>
}
</code></pre>
<p>这样做有几个直接收益：</p>
<ol>
<li>前端更容易做异常和展示逻辑，不需要每个接口单独处理。</li>
<li>服务端可以统一标记 traceId，方便链路排查问题。</li>
<li>协议一致后，可快速扩展错误码体系。</li>
</ol>
<p>在 nest.js 中，我们可以使用 <strong>Interceptors（拦截器）</strong> 来完成这一目标。下面是一段完整的拦截器代码。</p>
<h4 data-id="heading-10">拦截器核心代码示例</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">Injectable</span>,
  <span class="hljs-title class_">NestInterceptor</span>,
  <span class="hljs-title class_">ExecutionContext</span>,
  <span class="hljs-title class_">CallHandler</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { map } <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ClsService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'nestjs-cls'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ErrorCodes</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../constants'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">StandardResponse</span>&lt;T&gt; {
  <span class="hljs-attr">code</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">data</span>: T;
  traceId?: <span class="hljs-built_in">string</span>;
}

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StandardResponseInterceptor</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NestInterceptor</span>&lt;
  T,
  <span class="hljs-title class_">StandardResponse</span>&lt;T&gt;
&gt; {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> cls: ClsService</span>) {}

  <span class="hljs-title function_">intercept</span>(<span class="hljs-params">context: ExecutionContext, next: CallHandler</span>) {
    <span class="hljs-keyword">if</span> (context.<span class="hljs-title function_">getType</span>() !== <span class="hljs-string">'http'</span>) {
      <span class="hljs-keyword">return</span> next.<span class="hljs-title function_">handle</span>();
    }

    <span class="hljs-keyword">const</span> handler = context.<span class="hljs-title function_">getHandler</span>();
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">getMetadata</span>(<span class="hljs-string">'skip_transform'</span>, handler)) {
      <span class="hljs-keyword">return</span> next.<span class="hljs-title function_">handle</span>();
    }

    <span class="hljs-keyword">const</span> traceId = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cls</span>.<span class="hljs-title function_">getId</span>();

    <span class="hljs-keyword">return</span> next.<span class="hljs-title function_">handle</span>().<span class="hljs-title function_">pipe</span>(
      <span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> ({
        <span class="hljs-attr">code</span>: <span class="hljs-title class_">ErrorCodes</span>.<span class="hljs-property">SUCCESS</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">'OK'</span>,
        data,
        traceId,
      })),
    );
  }
}
</code></pre>
<p>说明：</p>
<ul>
<li>ClsService 用于获取当前请求的 traceId</li>
<li>map() 包裹所有返回内容</li>
<li>拦截器只在 HTTP 请求上执行（GraphQL、Microservice 可以忽略）</li>
<li>可通过自定义 Decorator 跳过包装</li>
</ul>
<h4 data-id="heading-11">如何注册拦截器（全局启用）</h4>
<p>在 <code>main.ts</code> 中：</p>
<pre><code class="hljs language-typescript" lang="typescript">app.<span class="hljs-title function_">useGlobalInterceptors</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardResponseInterceptor</span>(app.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">ClsService</span>)));
</code></pre>
<p>这样所有路由默认都统一格式输出。</p>
<h4 data-id="heading-12">某些接口不想被统一格式怎么办？</h4>
<p>例如导出文件等特殊接口，不希望包裹。</p>
<p>你可以加自定义装饰器：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-string">'reflect-metadata'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">SkipTransform</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title class_">SetMetadata</span>(<span class="hljs-string">'skip_transform'</span>, <span class="hljs-literal">true</span>);
</code></pre>
<p>使用方式：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Get</span>(<span class="hljs-string">'upload'</span>)
<span class="hljs-meta">@SkipTransform</span>()
<span class="hljs-title function_">getCaptcha</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> someRawBinary;
}
</code></pre>
<p>当前路由会跳过统一包裹。</p>
<h4 data-id="heading-13">实际效果展示</h4>
<p>原本控制器返回：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Get</span>(<span class="hljs-string">'user'</span>)
<span class="hljs-title function_">getUser</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Tom'</span> };
}
</code></pre>
<p>最终前端收到：</p>
<pre><code class="hljs language-typescript" lang="typescript">{
  <span class="hljs-string">"code"</span>: <span class="hljs-number">0</span>,
  <span class="hljs-string">"message"</span>: <span class="hljs-string">"OK"</span>,
  <span class="hljs-string">"data"</span>: {
    <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"Tom"</span>
  },
  <span class="hljs-string">"traceId"</span>: <span class="hljs-string">"abc-123-xyz"</span>
}
</code></pre>
<h2 data-id="heading-14">通用错误处理</h2>
<p>在后端系统中，错误处理往往经历三个阶段：</p>
<ol>
<li>能跑（框架兜底）</li>
<li>能返回（让前端知道错哪里）</li>
<li>能排障（日志链路、定位效率）</li>
</ol>
<p>nestjs 的 <code>ExceptionFilter</code> 为第三阶段提供了完整治理能力。本节通过自定义 <code>AllExceptionsFilter</code>，从“拦截错误”开始，一层层增强错误输出、业务语义、日志能力和 traceId 支持。</p>
<h3 data-id="heading-15">第一层：拦截所有异常，而不是依赖框架默认行为</h3>
<p>默认情况下，框架会尝试处理异常，但格式、内容和处理方式不可控。<br/>
通过 <code>@Catch()</code> 拦截全场景错误，我们将接管所有异常通道：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Catch</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AllExceptionsFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ExceptionFilter</span> {
  <span class="hljs-keyword">catch</span>(<span class="hljs-attr">exception</span>: <span class="hljs-built_in">unknown</span>, <span class="hljs-attr">host</span>: <span class="hljs-title class_">ArgumentsHost</span>) {
</code></pre>
<p>借助 <code>ArgumentsHost</code>，我们拿到 HTTP 请求上下文，后续就能构造专属响应：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> ctx = host.<span class="hljs-title function_">switchToHttp</span>();
<span class="hljs-keyword">const</span> response = ctx.<span class="hljs-property">getResponse</span>&lt;<span class="hljs-title class_">Response</span>&gt;();
<span class="hljs-keyword">const</span> request = ctx.<span class="hljs-property">getRequest</span>&lt;<span class="hljs-title class_">Request</span>&gt;();
</code></pre>
<p>此时的目标是“掌控入口”。</p>
<h3 data-id="heading-16">第二层：区分 HTTP 状态码，让协议正确表达成功或失败</h3>
<p>框架层能力拦截之后，下一层诉求是协议语义正确。<br/>
对客户端返回的 HTTP Status 必须准确，否则代理、浏览器、监控系统均无法判断请求情况：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> httpStatus =
  exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HttpException</span>
    ? exception.<span class="hljs-title function_">getStatus</span>()
    : <span class="hljs-title class_">HttpStatus</span>.<span class="hljs-property">INTERNAL_SERVER_ERROR</span>;
</code></pre>
<p>简单讲：</p>
<ul>
<li>可预期的业务错误维持 4xx</li>
<li>其它错误不想让前端知道具体错误，直接返回  <code>INTERNAL_SERVER_ERROR</code>。</li>
</ul>
<p>这实现了“系统对外的协议治理”。</p>
<h3 data-id="heading-17">第三层：建立业务错误码体系，与协议语义解耦</h3>
<p>HTTP Status 永远不适合作为业务判断依据。<br/>
因此体系化项目会分离“协议错误码”和“业务错误码”。这一步实现业务语义治理：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> <span class="hljs-attr">businessCode</span>: <span class="hljs-built_in">number</span>;
<span class="hljs-keyword">if</span> (httpStatus &gt;= <span class="hljs-number">400</span> &amp;&amp; httpStatus &lt; <span class="hljs-number">500</span>) {
  businessCode = <span class="hljs-title class_">ErrorCodes</span>.<span class="hljs-property">BUSINESS_ERROR</span>;
} <span class="hljs-keyword">else</span> {
  businessCode = <span class="hljs-title class_">ErrorCodes</span>.<span class="hljs-property">SYSTEM_ERROR</span>;
}
</code></pre>
<p>从此，前端不再需要看 400/500 决策，而是看业务码 1000/5000 做逻辑分支(如果需要有业务错误码的话，一般可以不加业务状态码)。</p>
<h3 data-id="heading-18">第四层：控制返回给用户的 message，不泄漏内部实现</h3>
<p>继续向下走，我们需要控制“用户可见信息”。</p>
<p>对于 <code>HttpException</code>，返回异常信息安全可控；<br/>
而普通异常有堆栈、内部错误，不可直给客户端：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> <span class="hljs-attr">userMessage</span>: <span class="hljs-built_in">string</span>;
<span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HttpException</span>) {
  <span class="hljs-keyword">const</span> exceptionResponse = exception.<span class="hljs-title function_">getResponse</span>() <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>;
  userMessage = exceptionResponse.<span class="hljs-property">message</span> || exception.<span class="hljs-property">message</span>;
} <span class="hljs-keyword">else</span> {
  userMessage = <span class="hljs-string">'Server Internal Error'</span>;
}
</code></pre>
<h3 data-id="heading-19">第五层：注入 traceId，将错误纳入链路追踪体系</h3>
<p>协议治理与安全治理之后，我们需要可观测性。<br/>
依赖 <code>ClsService</code> 获取 traceId，使任意异常都能与一次请求绑定：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> traceId = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cls</span>.<span class="hljs-title function_">getId</span>();
</code></pre>
<p>这让后续日志检索有了线索，从“出错”变为“定位在哪个请求出错”。</p>
<hr/>
<h3 data-id="heading-20">第六层：构造统一错误返回体，让前端接收结构稳定</h3>
<p>业务响应格式统一之后，客户端解析与 UI 逻辑才能标准化：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> finalClientResponse = {
  <span class="hljs-attr">code</span>: businessCode,
  <span class="hljs-attr">message</span>: userMessage,
  traceId,
  <span class="hljs-attr">error</span>: {
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
    <span class="hljs-attr">path</span>: request.<span class="hljs-property">url</span>,
    <span class="hljs-attr">method</span>: request.<span class="hljs-property">method</span>,
    httpStatus,
  },
};
</code></pre>
<p>这一层，从“不固定字段”变为“返回契约统一”。</p>
<hr/>
<h3 data-id="heading-21">第七层：按严重程度结构化日志，结合 traceId 可查可追</h3>
<p>有了 traceId 后，日志才具备上下文意义。<br/>
对非预期错误记录堆栈并升为 <code>error</code>，对客户端调用错误降级为 <code>warn</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (httpStatus &gt;= <span class="hljs-number">500</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`[<span class="hljs-subst">${httpStatus}</span>] Unhandled Exception: <span class="hljs-subst">${userMessage}</span>`</span>, {
    <span class="hljs-attr">clientResponse</span>: finalClientResponse,
    <span class="hljs-attr">stack</span>: (exception <span class="hljs-keyword">as</span> <span class="hljs-title class_">Error</span>).<span class="hljs-property">stack</span>,
    traceId,
  });
} <span class="hljs-keyword">else</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`[<span class="hljs-subst">${httpStatus}</span>] Client Error: <span class="hljs-subst">${userMessage}</span>`</span>, {
    <span class="hljs-attr">clientResponse</span>: finalClientResponse,
    traceId,
  });
}
</code></pre>
<p>此处是“日志治理 + 可观测性治理”。</p>
<hr/>
<h3 data-id="heading-22">第八层：保持 HTTP 状态原样返回，确保协议链路正常识别</h3>
<p>最终输出必须保留协议语义，否则监控、负载均衡、浏览器都将错误判断请求：</p>
<pre><code class="hljs language-typescript" lang="typescript">response.<span class="hljs-title function_">status</span>(httpStatus).<span class="hljs-title function_">json</span>(finalClientResponse);
</code></pre>
<p>接下来就可以在 main.ts 中使用这个全局错误管理器了。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NestFactory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/core'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.module'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ClsService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'nestjs-cls'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AllExceptionsFilter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./common/filters/http-exception.filter'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-keyword">type</span> <span class="hljs-title class_">NestExpressApplication</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/platform-express'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-keyword">type</span> <span class="hljs-title class_">LoggerService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NestFactory</span>.<span class="hljs-property">create</span>&lt;<span class="hljs-title class_">NestExpressApplication</span>&gt;(<span class="hljs-title class_">AppModule</span>, {
    <span class="hljs-attr">bufferLogs</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 先缓存日志，直到 Logger 替换完成</span>
  });

  <span class="hljs-keyword">const</span> configService = app.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">ConfigService</span>);

  <span class="hljs-comment">// 1. 替换 Nest 默认 Logger 为 Winston</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">logger</span>: <span class="hljs-title class_">LoggerService</span> = app.<span class="hljs-title function_">get</span>(<span class="hljs-variable constant_">WINSTON_MODULE_NEST_PROVIDER</span>);

  app.<span class="hljs-title function_">useLogger</span>(logger);

  <span class="hljs-comment">// 获取 CLS 服务实例</span>
  <span class="hljs-keyword">const</span> clsService = app.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">ClsService</span>);

  <span class="hljs-comment">// 4. 注册全局异常过滤器：捕获所有异常并打印日志 + 返回统一结构</span>
  app.<span class="hljs-title function_">useGlobalFilters</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AllExceptionsFilter</span>(clsService, logger));

  <span class="hljs-keyword">const</span> port = configService.<span class="hljs-property">get</span>&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-string">'port'</span>) ?? <span class="hljs-number">3000</span>;

  <span class="hljs-keyword">await</span> app.<span class="hljs-title function_">listen</span>(port, <span class="hljs-function">() =&gt;</span> {
    logger.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Server on :<span class="hljs-subst">${port}</span>`</span>);
  });
}
<span class="hljs-title function_">bootstrap</span>();
</code></pre>
<h2 data-id="heading-23">honojs 配置</h2>
<h3 data-id="heading-24">第一部分：链路日志追踪功能</h3>
<p>首先我们封装记录 traceId 的功能，我们通过编写一个中间件来实现，这个中间件是所有请求过来，经过的第一步，这样所有请求就带了 traceId，具体实现如下：</p>
<p>首先我们要创建一个 AsyncLocalStorage 实例，让后续的中间件调用其 run 方法，为每个请求创建独立的上下文。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AsyncLocalStorage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:async_hooks"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RequestContext</span> {
  <span class="hljs-attr">traceId</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-comment">// 初始化全局存储</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> ctx = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncLocalStorage</span>&lt;<span class="hljs-title class_">RequestContext</span>&gt;();

<span class="hljs-comment">// 封装一个获取 traceId 的快捷方法</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getTraceId = (): <span class="hljs-built_in">string</span> | <span class="hljs-function"><span class="hljs-params">undefined</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> store = ctx.<span class="hljs-title function_">getStore</span>();
  <span class="hljs-keyword">return</span> store?.<span class="hljs-property">traceId</span>;
};

</code></pre>
<p>以下是 middleware 的实现</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createMiddleware } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono/factory"</span>;
<span class="hljs-keyword">import</span> { ctx } <span class="hljs-keyword">from</span> <span class="hljs-string">"../context"</span>; <span class="hljs-comment">// 导入您的 ctx</span>

<span class="hljs-comment">// 确保在 Node.js 环境下使用</span>
<span class="hljs-keyword">import</span> { randomUUID } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:crypto"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> traceMiddleware = <span class="hljs-title function_">createMiddleware</span>(<span class="hljs-keyword">async</span> (c, next) =&gt; {
  <span class="hljs-comment">// 1. 生成唯一的 Trace ID</span>
    <span class="hljs-keyword">const</span> traceId = c.<span class="hljs-property">req</span>.<span class="hljs-title function_">header</span>(<span class="hljs-string">"x-request-id"</span>) || <span class="hljs-title function_">randomUUID</span>();

  <span class="hljs-comment">// 2. 将 Trace ID 存储在 AsyncLocalStorage 中，并运行后续的处理链</span>
  <span class="hljs-keyword">await</span> ctx.<span class="hljs-title function_">run</span>({ traceId }, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-comment">// 3. (可选) 记录请求开始日志</span>
    <span class="hljs-comment">// logger.info(`Request started: ${c.req.method} ${c.req.url}`, {</span>
    <span class="hljs-comment">//   traceId: getTraceId(),</span>
    <span class="hljs-comment">// });</span>

    <span class="hljs-comment">// 4. 继续处理链</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();

    <span class="hljs-comment">// 5. (可选) 设置响应头</span>
    c.<span class="hljs-property">res</span>.<span class="hljs-property">headers</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">"X-Trace-ID"</span>, traceId);

    <span class="hljs-comment">// // 6. (可选) 记录请求结束日志</span>
    <span class="hljs-comment">// logger.info(`Request finished: ${c.req.method} ${c.req.url}`, {</span>
    <span class="hljs-comment">//   traceId: getTraceId(),</span>
    <span class="hljs-comment">//   status: c.res.status,</span>
    <span class="hljs-comment">// });</span>
  });
});
</code></pre>
<p>通过优先读取 <code>x-request-id</code>，我们可以实现跨系统的全链路追踪（如果你的前端或上游网关也带了这个 ID，就能实现真正的端到端打通）。</p>
<p>主要代码就是 ctx.run({ traceId }, async () =&gt; { xxx }), 将后所有内容，包含在 AsyncLocalStorage 上下文中，也就是 traceId 会伴随整个请求的生命周期。</p>
<h3 data-id="heading-25">第二部分：Winston 动态工厂 (common/logger)</h3>
<p>这里体现了<strong>环境差异化处理</strong>的思想。</p>

























<table><thead><tr><th><strong>特性</strong></th><th><strong>开发环境 (Development)</strong></th><th><strong>生产环境 (Production)</strong></th></tr></thead><tbody><tr><td><strong>输出目标</strong></td><td>只有控制台 (Console)</td><td>控制台 + 每日滚动文件 (Daily File)</td></tr><tr><td><strong>展示样式</strong></td><td>漂亮的彩色、缩进、Nest 风格</td><td>严谨的 JSON 格式（方便日志分析系统 ELK 抓取）</td></tr><tr><td><strong>日志保留</strong></td><td>随启随看</td><td>保留 14 天，单文件 20MB（防止硬盘爆掉）</td></tr></tbody></table>
<p>以上的功能，我们封装到一个 logger.ts 中，代码如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { format, transports, createLogger } <span class="hljs-keyword">from</span> <span class="hljs-string">"winston"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"winston-daily-rotate-file"</span>;
<span class="hljs-keyword">import</span> { getTraceId } <span class="hljs-keyword">from</span> <span class="hljs-string">"../context"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">PROD_ENV</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../../../constant"</span>;

<span class="hljs-comment">// 1. 自定义 Format：自动从 ALS 获取 Trace ID</span>
<span class="hljs-keyword">const</span> appendTraceId = <span class="hljs-title function_">format</span>(<span class="hljs-function">(<span class="hljs-params">info</span>) =&gt;</span> {
  <span class="hljs-comment">// 使用 ctx.getStore() 获得</span>
  <span class="hljs-keyword">const</span> traceId = <span class="hljs-title function_">getTraceId</span>();
  <span class="hljs-keyword">if</span> (!traceId) {
    info.<span class="hljs-property">traceId</span> = traceId;
  }
  <span class="hljs-keyword">return</span> info;
});

<span class="hljs-comment">/// 2. 基础配置</span>
<span class="hljs-keyword">const</span> logFormat = format.<span class="hljs-title function_">combine</span>(
  <span class="hljs-title function_">appendTraceId</span>(),
  format.<span class="hljs-title function_">timestamp</span>({ <span class="hljs-attr">format</span>: <span class="hljs-string">"YYYY-MM-DD HH:mm:ss"</span> }),
  format.<span class="hljs-title function_">errors</span>({ <span class="hljs-attr">stack</span>: <span class="hljs-literal">true</span> }), <span class="hljs-comment">// 自动捕获 error stack</span>
  format.<span class="hljs-title function_">json</span>()
);

<span class="hljs-keyword">const</span> devTransport = <span class="hljs-keyword">new</span> transports.<span class="hljs-title class_">Console</span>({
  <span class="hljs-attr">level</span>: <span class="hljs-string">"info"</span>,
  <span class="hljs-attr">format</span>: format.<span class="hljs-title function_">combine</span>(
    format.<span class="hljs-title function_">colorize</span>(),
    format.<span class="hljs-title function_">printf</span>(<span class="hljs-function">(<span class="hljs-params">{ timestamp, level, message, traceId, stack }</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> tid = traceId ? <span class="hljs-string">`[Trace: <span class="hljs-subst">${traceId}</span>]`</span> : <span class="hljs-string">""</span>;
      <span class="hljs-keyword">const</span> output = <span class="hljs-string">`<span class="hljs-subst">${timestamp}</span> <span class="hljs-subst">${level}</span> <span class="hljs-subst">${tid}</span>: <span class="hljs-subst">${message}</span>`</span>;
      <span class="hljs-keyword">return</span> stack ? <span class="hljs-string">`<span class="hljs-subst">${output}</span>\n<span class="hljs-subst">${stack}</span>`</span> : output;
    })
  ),
});

<span class="hljs-comment">// 导出 Logger 实例</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> logger = <span class="hljs-title function_">createLogger</span>({
  <span class="hljs-attr">format</span>: logFormat,
  <span class="hljs-attr">transports</span>:
    process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-variable constant_">PROD_ENV</span>
      ? <span class="hljs-comment">// 生产环境 Transports</span>
        [
          <span class="hljs-keyword">new</span> transports.<span class="hljs-title class_">DailyRotateFile</span>({
            <span class="hljs-attr">filename</span>: <span class="hljs-string">"logs/error-%DATE%.log"</span>,
            <span class="hljs-attr">datePattern</span>: <span class="hljs-string">"YYYY-MM-DD"</span>,
            <span class="hljs-attr">level</span>: <span class="hljs-string">"error"</span>,
            <span class="hljs-attr">maxSize</span>: <span class="hljs-string">"20m"</span>,
            <span class="hljs-attr">maxFiles</span>: <span class="hljs-string">"14d"</span>,
          }),
          <span class="hljs-keyword">new</span> transports.<span class="hljs-title class_">Console</span>({
            <span class="hljs-attr">level</span>: <span class="hljs-string">"error"</span>,
            <span class="hljs-attr">format</span>: format.<span class="hljs-title function_">combine</span>(
              format.<span class="hljs-title function_">colorize</span>(),
              format.<span class="hljs-title function_">printf</span>(<span class="hljs-function">(<span class="hljs-params">{ timestamp, level, message, traceId, stack }</span>) =&gt;</span> {
                <span class="hljs-keyword">const</span> tid = traceId ? <span class="hljs-string">`[Trace: <span class="hljs-subst">${traceId}</span>]`</span> : <span class="hljs-string">""</span>;
                <span class="hljs-keyword">const</span> output = <span class="hljs-string">`<span class="hljs-subst">${timestamp}</span> <span class="hljs-subst">${level}</span> <span class="hljs-subst">${tid}</span>: <span class="hljs-subst">${message}</span>`</span>;
                <span class="hljs-keyword">return</span> stack ? <span class="hljs-string">`<span class="hljs-subst">${output}</span>\n<span class="hljs-subst">${stack}</span>`</span> : output;
              })
            ),
          }),
        ]
      : <span class="hljs-comment">// 开发环境 Transport</span>
        [devTransport],
});

</code></pre>
<p>注意，上面的例子，我们后续例如单机使用 docker-compose 部署也好，还是使用k8s/k3s部署也好，就不需要使用winston本身的 DailyRotateFile 功能了，可以借助 docker 或者 k8s/k3s 本身的日志轮转功能实现</p>
<h3 data-id="heading-26">如何在 Service 中打印带 TraceId 的日志？</h3>
<p>如下，我们就可以在路由中使用 logger 功能，就会自带 traceId 了</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Hono</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono"</span>;
<span class="hljs-keyword">import</span> { logger } <span class="hljs-keyword">from</span> <span class="hljs-string">"./common/logger"</span>;
<span class="hljs-keyword">import</span> { standardResponse } <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils"</span>;
<span class="hljs-keyword">import</span> { getTraceId } <span class="hljs-keyword">from</span> <span class="hljs-string">"./context"</span>;

<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hono</span>();

app.<span class="hljs-title function_">get</span>(<span class="hljs-string">"/users"</span>, <span class="hljs-keyword">async</span> (c) =&gt; {
  logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"开始处理 /users 请求"</span>);

  <span class="hljs-keyword">const</span> list = [{ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Tom"</span> }];

  logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">`查询用户数量=<span class="hljs-subst">${list.length}</span>`</span>);

  <span class="hljs-keyword">return</span> <span class="hljs-title function_">standardResponse</span>(c, { list });
});
</code></pre>
<p>访问结果输出（示例）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-number">2025-01-05 22:11:01 </span><span class="hljs-string">info</span> [<span class="hljs-attr">Trace:</span> <span class="hljs-string">099f42...</span>] <span class="hljs-string">开始处理</span> <span class="hljs-string">/users</span> <span class="hljs-string">请求</span>
<span class="hljs-number">2025-01-05 22:11:01 </span><span class="hljs-string">info</span> [<span class="hljs-attr">Trace:</span> <span class="hljs-string">099f42...</span>] <span class="hljs-string">查询用户数量=1</span>
</code></pre>
<h3 data-id="heading-27">在 hono.js 中封装统一返回格式</h3>
<p>与 nest.js 不同，hono.js 没有 <strong>Interceptor</strong> 的概念，因此无法在框架层自动包装所有路由的返回值。hono 更偏向极简设计：框架提供 Context（<code>c</code>）与响应方法（如 <code>c.json()</code>），开发者通过 middleware 或工具函数扩展能力。</p>
<p>在这种模式下，一个常见策略是：<strong>在 utils 层封装一个标准响应函数</strong>，每当路由处理完成业务逻辑后，调用该函数输出标准格式。示例如下：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// utils/response.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-keyword">type</span> <span class="hljs-title class_">Context</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono"</span>;
<span class="hljs-keyword">import</span> { getTraceId } <span class="hljs-keyword">from</span> <span class="hljs-string">"../common/context"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">CODES</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../common/constants/codes"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">ContentfulStatusCode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono/utils/http-status"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SUCCESS_MESSAGE</span> = <span class="hljs-string">"OK"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> standardResponse = &lt;T&gt;(
  <span class="hljs-attr">c</span>: <span class="hljs-title class_">Context</span>,
  <span class="hljs-attr">data</span>: T,
  <span class="hljs-attr">httpStatus</span>: <span class="hljs-title class_">ContentfulStatusCode</span> = <span class="hljs-number">200</span>
): <span class="hljs-function"><span class="hljs-params">Response</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> traceId = <span class="hljs-title function_">getTraceId</span>();

  <span class="hljs-keyword">const</span> finalResponse = {
    <span class="hljs-attr">code</span>: <span class="hljs-variable constant_">CODES</span>.<span class="hljs-property">SUCCESS</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-variable constant_">SUCCESS_MESSAGE</span>,
    data,
    traceId,
  };
  
   <span class="hljs-comment">// 使用 c.json() 返回 Response</span>
  <span class="hljs-comment">// c.json() 负责设置 Content-Type: application/json</span>
  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>(finalResponse, httpStatus);
};
</code></pre>
<p>这一函数实现了几个能力：</p>
<ol>
<li><strong>统一业务结构</strong>：code / message / data 统一格式化。</li>
<li><strong>链路可观测性</strong>：自动从 ALS 中获取 traceId，可跨路由跟踪调用链路。</li>
<li><strong>控制协议行为</strong>：可指定 HTTP status，而不影响业务 code。</li>
<li><strong>无框架侵入性</strong>：不需要全局 patch，路由自由决定是否使用。</li>
</ol>
<p>实际使用方式非常直接：在路由处理函数中调用该函数包裹输出即可：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { standardResponse } <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils/response"</span>;

app.<span class="hljs-title function_">get</span>(<span class="hljs-string">"/user"</span>, <span class="hljs-function">(<span class="hljs-params">c</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> user = { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Tom"</span> };
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">standardResponse</span>(c, user);
});
</code></pre>
<p>输出结构：</p>
<pre><code class="hljs language-typescript" lang="typescript">{
  <span class="hljs-string">"code"</span>: <span class="hljs-number">0</span>,
  <span class="hljs-string">"message"</span>: <span class="hljs-string">"OK"</span>,
  <span class="hljs-string">"data"</span>: {
    <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"Tom"</span>
  },
  <span class="hljs-string">"traceId"</span>: <span class="hljs-string">"abc-123-xyz"</span>
}
</code></pre>
<h3 data-id="heading-28">错误处理</h3>
<p>hono.js 并没有 nest.js 中那样的 exception（异常）处理器，但 hono 官方提供了两个方法来处理全局异常。</p>
<ul>
<li>Error Handling 回调函数</li>
<li>Not Found 回调函数</li>
</ul>
<p>其中 <code>app.onError</code> 允许我们处理未捕获的错误并返回自定义响应。例如</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hono</span>();
app.<span class="hljs-title function_">onError</span>(<span class="hljs-function">(<span class="hljs-params">err, c</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`<span class="hljs-subst">${err}</span>`</span>);
  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">text</span>(<span class="hljs-string">"Custom Error Message"</span>, <span class="hljs-number">500</span>);
});
</code></pre>
<p>接下来我们实现一个生产级别的全局错误处理函数，代替上面的 onError 中的函数：</p>
<h4 data-id="heading-29">阶段一：只实现兜底，确保不会爆栈到框架</h4>
<p>目标：任何异常都返回 500，避免框架直接输出默认错误页面。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">customErrorHandler</span> = (<span class="hljs-params">exception: <span class="hljs-built_in">unknown</span>, c: Context</span>) =&gt; {
  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>(
    {
      <span class="hljs-attr">message</span>: <span class="hljs-string">"Internal Server Error"</span>,
    },
    <span class="hljs-number">500</span>,
  );
};
</code></pre>
<p>此阶段的函数虽然简陋，但实现了基本“拦截能力”。技术人员可以理解到：不允许异常直接泄漏给框架。</p>
<h4 data-id="heading-30">阶段二：支持错误分类（业务可控错误 vs 系统错误）</h4>
<p>需求出现：业务层需要显式抛出 4xx，不应该全部变成 500。因此我们引入 Hono 的 HTTPException。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">HTTPException</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono/http-exception"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">customErrorHandler</span> = (<span class="hljs-params">exception: <span class="hljs-built_in">unknown</span>, c: Context</span>) =&gt; {
  <span class="hljs-keyword">let</span> httpStatus = <span class="hljs-number">500</span>;
  <span class="hljs-keyword">let</span> message = <span class="hljs-string">"Internal Server Error"</span>;

  <span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HTTPException</span>) {
    httpStatus = exception.<span class="hljs-property">status</span>;
    message = exception.<span class="hljs-property">message</span>;
  }

  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>({ message }, httpStatus);
};
</code></pre>
<p>团队到此能看到两个差异：</p>
<ul>
<li>不再一刀切地用 500</li>
<li>支持框架级错误语义</li>
</ul>
<h4 data-id="heading-31">阶段三：支持普通 Error，并提取堆栈</h4>
<p>当后端代码抛出 Error 对象时，我们不希望把内部堆栈暴露给客户端，但日志需要保留：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span>) {
  httpStatus = <span class="hljs-number">500</span>;
  message = exception.<span class="hljs-property">message</span>;
  stack = exception.<span class="hljs-property">stack</span>;
}
</code></pre>
<p>与第二阶段结合后，代码局部已经具备三类来源：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HTTPException</span>) {
  <span class="hljs-comment">// 合法业务错误</span>
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span>) {
  <span class="hljs-comment">// 非预期系统错误</span>
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// 字符串或其他类型，兜底转字符串</span>
}
</code></pre>
<p>这一阶段解决“所有类型异常都能进入统一通路”。</p>
<h4 data-id="heading-32">阶段四：对外 Message 安全脱敏</h4>
<p>生产会提出安全要求：500 段错误不能暴露内部 message。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> userMessage =
  httpStatus &gt;= <span class="hljs-number">500</span> ? <span class="hljs-string">"Server Internal Error"</span> : exceptionMessage;
</code></pre>
<h4 data-id="heading-33">阶段五：加入 Trace ID，实现可观测能力</h4>
<p>在前几阶段之后，团队开始发现：仅凭日志很难定位请求调用链。因此引入 Trace ID：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { getTraceId } <span class="hljs-keyword">from</span> <span class="hljs-string">"../context"</span>;

<span class="hljs-keyword">const</span> traceId = <span class="hljs-title function_">getTraceId</span>();
</code></pre>
<p>并将其放入响应，用于 API 与日志上下游联动。</p>
<h4 data-id="heading-34">阶段六：构建统一响应协议</h4>
<p>现在错误信息、trace 信息都有了，我们需要形成一致返回结构，便于前端或 API 网关解析：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> finalClientResponse = {
  <span class="hljs-attr">code</span>: <span class="hljs-number">500</span>,
  <span class="hljs-attr">message</span>: userMessage,
  <span class="hljs-attr">traceId</span>: traceId,
  <span class="hljs-attr">error</span>: {
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
    <span class="hljs-attr">path</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">path</span>,
    <span class="hljs-attr">method</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">method</span>,
    <span class="hljs-attr">httpStatus</span>: httpStatus,
  },
};
</code></pre>
<p>这样可以回复格式统一的响应。</p>
<h4 data-id="heading-35">阶段七：结构化日志分级输出</h4>
<p>生产要求日志可检索、可告警，因此需要按状态区分 error 与 warn，并携带堆栈：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (httpStatus &gt;= <span class="hljs-number">500</span>) {
  logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">`[<span class="hljs-subst">${httpStatus}</span>] Unhandled Exception: <span class="hljs-subst">${exceptionMessage}</span>`</span>, {
    <span class="hljs-attr">clientResponse</span>: finalClientResponse,
    <span class="hljs-attr">stack</span>: exceptionStack,
    <span class="hljs-attr">traceId</span>: traceId,
    <span class="hljs-attr">path</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">path</span>,
  });
} <span class="hljs-keyword">else</span> {
  logger.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`[<span class="hljs-subst">${httpStatus}</span>] Client Error: <span class="hljs-subst">${exceptionMessage}</span>`</span>, {
    <span class="hljs-attr">clientResponse</span>: finalClientResponse,
    <span class="hljs-attr">traceId</span>: traceId,
    <span class="hljs-attr">path</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">path</span>,
  });
}
</code></pre>
<p>团队能看到：</p>
<ul>
<li>500+ 是告警级别</li>
<li>4xx 只是用户请求问题，不污染告警系统</li>
</ul>
<h4 data-id="heading-36">阶段八：最终闭环，按状态返回响应</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>(finalClientResponse, httpStatus);
</code></pre>
<p>请求闭环如下：</p>
<ol>
<li>识别异常</li>
<li>分类</li>
<li>安全脱敏</li>
<li>绑定 Trace</li>
<li>构建协议</li>
<li>结构化日志</li>
<li>返回状态码与响应体</li>
</ol>
<p>最终成果（合并段落）即为我们起初提供的完整生产代码：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-keyword">type</span> <span class="hljs-title class_">Context</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono"</span>;
<span class="hljs-keyword">import</span> { getTraceId } <span class="hljs-keyword">from</span> <span class="hljs-string">"../context"</span>;
<span class="hljs-keyword">import</span> { logger } <span class="hljs-keyword">from</span> <span class="hljs-string">"../logger"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">HTTPException</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono/http-exception"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-keyword">type</span> <span class="hljs-title class_">ContentfulStatusCode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono/utils/http-status"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">customErrorHandler</span> = (<span class="hljs-params">exception: <span class="hljs-built_in">unknown</span>, c: Context</span>) =&gt; {
  <span class="hljs-keyword">let</span> <span class="hljs-attr">httpStatus</span>: <span class="hljs-title class_">ContentfulStatusCode</span>;
  <span class="hljs-keyword">let</span> <span class="hljs-attr">exceptionMessage</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"Internal Server Error"</span>;
  <span class="hljs-keyword">let</span> <span class="hljs-attr">exceptionStack</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span>;

  <span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HTTPException</span>) {
    httpStatus = exception.<span class="hljs-property">status</span>;
    exceptionMessage = exception.<span class="hljs-property">message</span>;
    exceptionStack = exception.<span class="hljs-property">stack</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span>) {
    httpStatus = <span class="hljs-number">500</span>;
    exceptionMessage = exception.<span class="hljs-property">message</span>;
    exceptionStack = exception.<span class="hljs-property">stack</span>;
  } <span class="hljs-keyword">else</span> {
    httpStatus = <span class="hljs-number">500</span>;
    exceptionMessage = <span class="hljs-title class_">String</span>(exception);
  }

  <span class="hljs-keyword">const</span> userMessage =
    httpStatus &gt;= <span class="hljs-number">500</span> ? <span class="hljs-string">"Server Internal Error"</span> : exceptionMessage;

  <span class="hljs-keyword">const</span> traceId = <span class="hljs-title function_">getTraceId</span>();

  <span class="hljs-keyword">const</span> finalClientResponse = {
    <span class="hljs-attr">code</span>: <span class="hljs-number">500</span>,
    <span class="hljs-attr">message</span>: userMessage,
    <span class="hljs-attr">traceId</span>: traceId,
    <span class="hljs-attr">error</span>: {
      <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
      <span class="hljs-attr">path</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">path</span>,
      <span class="hljs-attr">method</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">method</span>,
      <span class="hljs-attr">httpStatus</span>: httpStatus,
    },
  };

  <span class="hljs-keyword">if</span> (httpStatus &gt;= <span class="hljs-number">500</span>) {
    logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">`[<span class="hljs-subst">${httpStatus}</span>] Unhandled Exception: <span class="hljs-subst">${exceptionMessage}</span>`</span>, {
      <span class="hljs-attr">clientResponse</span>: finalClientResponse,
      <span class="hljs-attr">stack</span>: exceptionStack,
      <span class="hljs-attr">traceId</span>: traceId,
      <span class="hljs-attr">path</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">path</span>,
    });
  } <span class="hljs-keyword">else</span> {
    logger.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`[<span class="hljs-subst">${httpStatus}</span>] Client Error: <span class="hljs-subst">${exceptionMessage}</span>`</span>, {
      <span class="hljs-attr">clientResponse</span>: finalClientResponse,
      <span class="hljs-attr">traceId</span>: traceId,
      <span class="hljs-attr">path</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">path</span>,
    });
  }

  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>(finalClientResponse, httpStatus);
};
</code></pre>
<p>接下来我们来处理全局捕获的 404 回调，也就是自定义 Not Found Response, 个人感觉生产环境就简单返回 404 状态码就足够了，所以函数定义如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">notFoundHandler</span> = (<span class="hljs-params">c: Context</span>) =&gt; {
  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">"Resource not found"</span> }, <span class="hljs-number">404</span>);
};
</code></pre>
<h2 data-id="heading-37">欢迎一起交流</h2>
<p>欢迎大家一起进群讨论前端全栈技术和 ai agent ，一起进步！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从空地对抗到空战：首个无人机间追踪百万级基准与时空语义基线MambaSTS深度解析]]></title>    <link>https://juejin.cn/post/7585948869844746275</link>    <guid>https://juejin.cn/post/7585948869844746275</guid>    <pubDate>2025-12-22T02:14:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585948869844746275" data-draft-id="7585888537641762831" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从空地对抗到空战：首个无人机间追踪百万级基准与时空语义基线MambaSTS深度解析"/> <meta itemprop="keywords" content="算法,计算机视觉,深度学习"/> <meta itemprop="datePublished" content="2025-12-22T02:14:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从空地对抗到空战：首个无人机间追踪百万级基准与时空语义基线MambaSTS深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:14:31.000Z" title="Mon Dec 22 2025 02:14:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>当今视觉追踪领域，一项全新任务正引发学术界和工业界的关注。这项被称为「无人机对抗无人机」的挑战将追踪技术的难度推向了全新高度。</p>
<p>近期，来自香港科技大学（广州）、上海交通大学、中山大学、中国科学院信息工程研究所和云从科技的联合团队发布了题为《How Far are Modern Trackers from UAV-Anti-UAV? A Million-Scale Benchmark and New Baseline》的突破性研究。</p>
<p>这项研究不仅仅提出了新的任务范式，更是构建了<strong>一个百万级规模的基准数据集</strong>，并对现有50种先进追踪器进行了全面测评，结果令人震惊。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68829052a96c4406ae709ada68f3356a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974471&amp;x-signature=qZTBVb7uRqPVl4s3s9js0%2BwH0Oo%3D" alt="图片1.png" loading="lazy"/></p>
<blockquote>
<p><strong>论文地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2512.07385" target="_blank" title="https://arxiv.org/pdf/2512.07385" ref="nofollow noopener noreferrer">arxiv.org/pdf/2512.07…</a></strong></p>
<p><strong>项目地址：</strong> <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F983632847%2FAwesome-Multimodal-Object-Tracking" target="_blank" title="https://github.com/983632847/Awesome-Multimodal-Object-Tracking" ref="nofollow noopener noreferrer">github.com/983632847/A…</a></strong></p>
</blockquote>
<h2 data-id="heading-0"><strong>无人机追踪新篇章：从“空地对抗”到“空战”</strong></h2>
<p>当前的无人机相关追踪研究主要分为两种模式。第一种是无人机追踪地面目标，如车辆或行人，此时追踪平台动态但目标相对静止。</p>
<p>另一种是地面摄像头追踪空中无人机，目标动态而观测平台静止。</p>
<p>这两种模式都无法模拟真实的空中对抗环境——当一架无人机需要追击另一架无人机时，双方都处于高速、剧烈的运动中。</p>
<p>研究团队将这种双向动态干扰称为“dual-dynamic disturbances”，它导致了视角急剧变化、背景快速移动和目标运动模糊等一系列复杂问题。</p>
<p>这正是UAV-Anti-UAV任务的核心挑战所在。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56c97ba5b71846cca733922ad0f2b49f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974471&amp;x-signature=B%2FgfRPS0xuGENo1hkDDavNH9SFs%3D" alt="图片2.png" loading="lazy"/></p>
<h2 data-id="heading-1"><strong>百万级基准：打造真实世界的空中战</strong></h2>
<p>为了推动这一新兴领域的发展，研究团队从零构建了一个超大规模、高质量标注的数据集。</p>
<p>这个数据集包含 1810个视频序列，总计105万标注帧，涵盖了固定翼、多旋翼、垂直起降、FPV无人机和无人直升机等五种目标无人机类型。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9726a836f4d4cfaa902ed92ce116d4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974471&amp;x-signature=3VTVyf%2F3d%2FugsoDNnhrR%2FUZgQYw%3D" alt="图片3.png" loading="lazy"/></p>
<p>与UAV123、Anti-UAV318等现有基准相比，新数据集不仅在规模上遥遥领先，更在多个维度上实现了突破：</p>
<ul>
<li>多模态创新：首次为每个视频序列提供简洁的自然语言描述，为视觉-语言多模态追踪开辟了新途径；</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62834470f9164395955db8afcc30772a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974471&amp;x-signature=TkkX0kqy5%2BQzLggJ0i0fmJvUtEI%3D" alt="图片4.png" loading="lazy"/></p>
<ul>
<li>极端挑战性：数据集标注了15种高难度追踪属性，如快速运动、光照变化和相似干扰物等。数据分析显示，新数据集在光照变化范围和目标相对速度上比现有基准更为“极端”，更贴近真实复杂环境；</li>
</ul>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52870b36678c411bb6f26f75b7a7716c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974471&amp;x-signature=FfSip5BM2Fccn0h8qdLpRf%2BP1xY%3D" alt="图片5.png" loading="lazy"/></p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7652c94003a94beeb44064558f9c6987~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974471&amp;x-signature=Euydw%2FgIvVcIdyvNrQRDxH7K0Yk%3D" alt="图片6.png" loading="lazy"/></p>
<p align="left"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/629b28c2f6a541ac8c9f90f2449f82fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974471&amp;x-signature=C36bJcHEf2%2F9EFPoZOJwwJ5LnyE%3D" alt="图片7.png" loading="lazy"/></p>
<ul>
<li>真实场景覆盖：数据采集自多样化真实环境，确保算法在实际应用中的鲁棒性。</li>
</ul>
<p><strong>目前Coovally官网已有Vistrone等权威无人机开源数据集免费为用户提供，并且还有可直接部署应用于大疆无人机的算法模型，无需重新修改部署转换</strong>，具体文章可参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkzOTg3NTAyNA%3D%3D%26mid%3D2247490614%26idx%3D2%26sn%3D4cdaf1278f908fc12877d8aa26de6211%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkzOTg3NTAyNA==&amp;mid=2247490614&amp;idx=2&amp;sn=4cdaf1278f908fc12877d8aa26de6211&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">VisDrone数据集，专为无人机视觉任务打造</a></p>
<p>Coovally平台不仅提供模型资源，还可以帮助你提供<strong>AI解决方案</strong>，可以扫描二维码，我们来给你提供解决方案！！</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/994fd8b13bf64e88a3790ab8a2b892e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974471&amp;x-signature=t6dbHdwgJpKsPPgLMwv4tVVtoh4%3D" alt="小助手二维码.png" loading="lazy"/></p>
<p>点击<strong>阅读原文</strong>，即可体验Coovally平台！</p>
<h2 data-id="heading-2"><strong>MambaSTS：时空语义融合的追踪新框架</strong></h2>
<p>面对这一高难度任务，研究团队提出了MambaSTS——一种专为时空语义集成学习设计的新框架。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60ab660f94b5416495b3507836eb1990~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974471&amp;x-signature=luQKPXckHhVRA3ypU9fTFmobzaI%3D" alt="图片8.png" loading="lazy"/></p>
<p>MambaSTS的核心创新在于巧妙地结合了Transformer和Mamba两大架构的优势：</p>
<ul>
<li>Transformer提供强大的全局空间建模能力，提取丰富的视觉特征；</li>
<li>Mamba以线性复杂度高效处理长序列数据，建立视频帧间的长期上下文关系。</li>
</ul>
<p>具体实现中，模型将模板图像、搜索图像和语言描述作为多模态输入。设计了一个“时间令牌传播”机制，可视为一个“记忆单元”。</p>
<p>这个单元持续收集和压缩过去帧中关于目标的关键信息（如外观、运动状态），然后将这份“记忆”传递给当前帧的处理过程。</p>
<p>即使目标在某一瞬间被完全遮挡或因高速运动而变得模糊，模型依然能依靠长期记忆保持对目标的稳定认知。最终，统一的时空语义网络将这些信息深度融合，通过无锚框追踪头预测目标的精确位置。</p>
<h2 data-id="heading-3"><strong>实验结果：现有追踪器在“空战”中全面溃败</strong></h2>
<p>研究团队对50种当前最先进的追踪器进行了全面评估，结果令人深思：现有方法在UAV-Anti-UAV任务上表现普遍不足。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/074358b325904be7934f23d0270efdf0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974471&amp;x-signature=Jfd6DKIs45gU0K7Rqm7WDfEuLqI%3D" alt="图片9.png" loading="lazy"/></p>
<p>从整体性能曲线看，大部分追踪器的成功率（Success/AUC）都处于较低水平。而论文提出的MambaSTS基线模型凭借其出色的时空建模能力，取得了43.7%的AUC得分，显著领先于其他方法。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9510fcea629b4d659d265d2ecc363d20~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974471&amp;x-signature=rxEuHQQS%2BaXcm92gUF5H9OItbt0%3D" alt="图片10.png" loading="lazy"/></p>
<p>分析不同追踪属性下的表现发现，现有追踪器在处理光照剧烈变化、相似物体干扰、运动模糊和完全遮挡等挑战时尤其力不从心。</p>
<p>消融实验充分证明了MambaSTS各个组件的有效性。从强大的基线模型OSTrack（AUC 27.8%）开始，通过逐步加入时间建模、空间建模和语义建模模块，性能最终提升至43.7%，相对涨幅超过57%，效果显著。</p>
<h2 data-id="heading-4"><strong>意义与展望</strong></h2>
<p>这项研究的价值不仅在于技术突破，更在于它为低空经济安全提供了关键技术支撑。随着无人机在物流、巡检、娱乐等领域的广泛应用，如何防止无人机滥用、保障低空安全已成为迫在眉睫的问题。</p>
<p>UAV-Anti-UAV技术有望应用于无人机拦截、禁飞区防护、重要设施保护等场景，成为低空安全的“智能守护者”。</p>
<p>从学术角度看，这项研究开辟了视觉追踪的新方向，挑战了现有算法的极限，推动了多模态、长时序理解等技术的发展。</p>
<p>随着低空经济的蓬勃发展，无人机对抗无人机的技术将成为保障安全的关键屏障。这项研究不仅提出了挑战，更指明了方向——在这个全新的“空战”时代，视觉追踪技术必须迎接更复杂、更动态、更真实的考验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot自动配置：为什么你的应用能“开箱即用]]></title>    <link>https://juejin.cn/post/7585839411122913326</link>    <guid>https://juejin.cn/post/7585839411122913326</guid>    <pubDate>2025-12-22T02:11:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585839411122913326" data-draft-id="7585897699602808858" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot自动配置：为什么你的应用能“开箱即用"/> <meta itemprop="keywords" content="后端,Java,Spring Boot"/> <meta itemprop="datePublished" content="2025-12-22T02:11:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小坏说Java"/> <meta itemprop="url" content="https://juejin.cn/user/3898184413750203"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot自动配置：为什么你的应用能“开箱即用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3898184413750203/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小坏说Java
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:11:21.000Z" title="Mon Dec 22 2025 02:11:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">《SpringBoot自动配置：为什么你的应用能“开箱即用」？》</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<blockquote>
<p>每天5分钟，掌握一个SpringBoot核心知识点。大家好，我是SpringBoot指南的创始人小坏。</p>
</blockquote>
<p><strong>可以关注公众号：小坏说Java</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<h3 data-id="heading-1">引言</h3>
<p>你是否曾经好奇，为什么创建一个SpringBoot应用只需要几行代码，就能自动获得Web服务器、数据库连接、安全配置等功能？今天我们就来揭开SpringBoot最核心的特性——自动配置的神秘面纱。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<p>先看一个经典对比：</p>
<p><strong>传统Spring MVC项目</strong>：需要配置web.xml、DispatcherServlet、视图解析器、数据源等数十个配置项。</p>
<p><strong>SpringBoot项目</strong>：只需要一个main方法加上<code>@SpringBootApplication</code>注解。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 就是这么简单！</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyApplication</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(MyApplication.class, args);
    }
}
</code></pre>
<h3 data-id="heading-2">一、@SpringBootApplication的三重魔法</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<p>这个看似简单的注解，实际上是一个<strong>复合注解</strong>，包含了三个核心注解：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Target(ElementType.TYPE)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Documented</span>
<span class="hljs-meta">@Inherited</span>
<span class="hljs-meta">@SpringBootConfiguration</span>
<span class="hljs-meta">@EnableAutoConfiguration</span>
<span class="hljs-meta">@ComponentScan(excludeFilters = { 
    @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),
    @Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) 
})</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> SpringBootApplication {
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>让我们逐一解析这三个核心注解的作用：</p>
<h4 data-id="heading-3">1. @SpringBootConfiguration</h4>
<p>这是<code>@Configuration</code>的特化版本，表明这个类是一个配置类。它允许我们在同一个类中定义Bean。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 等价于传统的@Configuration</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppConfig</span> {
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> UserService <span class="hljs-title function_">userService</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceImpl</span>();
    }
}
</code></pre>
<h4 data-id="heading-4">2. @ComponentScan</h4>
<p>这个注解告诉Spring在哪些包下扫描组件（@Component、@Service、@Controller等）。默认扫描的是<strong>当前包及其子包</strong>。</p>
<h4 data-id="heading-5">3. @EnableAutoConfiguration（重点！）</h4>
<p>这是自动配置的<strong>核心开关</strong>。让我们看看它的源码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Target(ElementType.TYPE)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Documented</span>
<span class="hljs-meta">@Inherited</span>
<span class="hljs-meta">@AutoConfigurationPackage</span>
<span class="hljs-meta">@Import(AutoConfigurationImportSelector.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> EnableAutoConfiguration {
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>关键点在于<code>@Import(AutoConfigurationImportSelector.class)</code>，这个类负责加载所有自动配置类。</p>
<h3 data-id="heading-6">二、自动配置的加载机制</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<h4 data-id="heading-7">1. spring.factories文件的作用</h4>
<p>SpringBoot启动时，<code>AutoConfigurationImportSelector</code>会读取<code>META-INF/spring.factories</code>文件，这个文件在spring-boot-autoconfigure包中：</p>
<pre><code class="hljs language-properties" lang="properties"># 文件位置: spring-boot-autoconfigure-2.7.x.jar!/META-INF/spring.factories

# Auto Configure
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,\
org.springframework.boot.autoconfigure.aop.AopAutoConfiguration,\
org.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration,\
org.springframework.boot.autoconfigure.batch.BatchAutoConfiguration,\
# ... 上百个自动配置类
</code></pre>
<p>目前SpringBoot 2.7.x版本中，这个文件列出了<strong>140多个自动配置类</strong>！这就是SpringBoot"开箱即用"能力的来源。</p>
<h4 data-id="heading-8">2. 按需加载机制</h4>
<p>你可能会担心：加载这么多配置类，不会影响启动速度吗？</p>
<p>实际上，SpringBoot使用了<strong>条件化配置</strong>机制。每个自动配置类都有各种<code>@ConditionalOnXxx</code>注解，只有在条件满足时才会生效。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-comment">// 条件1：类路径下有DataSource类</span>
<span class="hljs-meta">@ConditionalOnClass(DataSource.class)</span>
<span class="hljs-comment">// 条件2：有DataSource类型的Bean</span>
<span class="hljs-meta">@ConditionalOnBean(DataSource.class)</span>
<span class="hljs-comment">// 条件3：配置了spring.datasource属性</span>
<span class="hljs-meta">@ConditionalOnProperty(prefix = "spring.datasource", name = "url")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceAutoConfiguration</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-comment">// 条件4：不存在DataSource类型的Bean时才创建</span>
    <span class="hljs-meta">@ConditionalOnMissingBean(DataSource.class)</span>
    <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">dataSource</span><span class="hljs-params">(DataSourceProperties properties)</span> {
        <span class="hljs-keyword">return</span> properties.initializeDataSourceBuilder().build();
    }
}
</code></pre>
<h3 data-id="heading-9">三、条件注解详解</h3>
<p>SpringBoot提供了一系列条件注解，让我们看看最常用的几个：</p>













































<table><thead><tr><th>条件注解</th><th>作用</th><th>示例</th></tr></thead><tbody><tr><td>@ConditionalOnClass</td><td>类路径下存在指定类时生效</td><td><code>@ConditionalOnClass(RedisTemplate.class)</code></td></tr><tr><td>@ConditionalOnMissingClass</td><td>类路径下不存在指定类时生效</td><td><code>@ConditionalOnMissingClass("javax.servlet.Servlet")</code></td></tr><tr><td>@ConditionalOnBean</td><td>容器中存在指定Bean时生效</td><td><code>@ConditionalOnBean(DataSource.class)</code></td></tr><tr><td>@ConditionalOnMissingBean</td><td>容器中不存在指定Bean时生效</td><td><code>@ConditionalOnMissingBean(RedisTemplate.class)</code></td></tr><tr><td>@ConditionalOnProperty</td><td>配置文件中存在指定属性时生效</td><td><code>@ConditionalOnProperty(prefix="redis", name="enabled")</code></td></tr><tr><td>@ConditionalOnWebApplication</td><td>是Web应用时生效</td><td><code>@ConditionalOnWebApplication</code></td></tr><tr><td>@ConditionalOnNotWebApplication</td><td>不是Web应用时生效</td><td><code>@ConditionalOnNotWebApplication</code></td></tr></tbody></table>
<h3 data-id="heading-10">四、实战：创建自定义Starter</h3>
<p>理解了原理后，我们来自定义一个Starter，实现一个简单的短信服务。</p>
<h4 data-id="heading-11">步骤1：创建Starter项目结构</h4>
<pre><code class="hljs language-css" lang="css">sms-spring-boot-starter/
├── <span class="hljs-attribute">src</span>/
│   ├── <span class="hljs-selector-tag">main</span>/
│   │   ├── java/com/example/sms/
│   │   │   ├── SmsAutoConfiguration<span class="hljs-selector-class">.java</span>
│   │   │   ├── SmsProperties<span class="hljs-selector-class">.java</span>
│   │   │   ├── SmsService<span class="hljs-selector-class">.java</span>
│   │   │   └── SmsServiceImpl<span class="hljs-selector-class">.java</span>
│   │   └── resources/
│   │       └── META-INF/
│   │           └── spring<span class="hljs-selector-class">.factories</span>
│   └── pom<span class="hljs-selector-class">.xml</span>
</code></pre>
<h4 data-id="heading-12">步骤2：创建配置属性类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// SmsProperties.java</span>
<span class="hljs-meta">@ConfigurationProperties(prefix = "sms")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SmsProperties</span> {
    <span class="hljs-keyword">private</span> String accessKey;
    <span class="hljs-keyword">private</span> String secretKey;
    <span class="hljs-keyword">private</span> String signName;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">endpoint</span> <span class="hljs-operator">=</span> <span class="hljs-string">"https://dysmsapi.aliyuncs.com"</span>;
    
    <span class="hljs-comment">// getters and setters</span>
}
</code></pre>
<h4 data-id="heading-13">步骤3：创建自动配置类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// SmsAutoConfiguration.java</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableConfigurationProperties(SmsProperties.class)</span>  <span class="hljs-comment">// 启用配置属性</span>
<span class="hljs-meta">@ConditionalOnClass(SmsService.class)</span>  <span class="hljs-comment">// 当SmsService在类路径时生效</span>
<span class="hljs-meta">@ConditionalOnProperty(prefix = "sms", value = "enabled", havingValue = "true", matchIfMissing = true)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SmsAutoConfiguration</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@ConditionalOnMissingBean(SmsService.class)</span>  <span class="hljs-comment">// 容器中没有SmsService时才创建</span>
    <span class="hljs-keyword">public</span> SmsService <span class="hljs-title function_">smsService</span><span class="hljs-params">(SmsProperties properties)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SmsServiceImpl</span>(properties);
    }
}
</code></pre>
<h4 data-id="heading-14">步骤4：创建服务接口和实现</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// SmsService.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SmsService</span> {
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">send</span><span class="hljs-params">(String phone, String content)</span>;
}

<span class="hljs-comment">// SmsServiceImpl.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SmsServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SmsService</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SmsProperties properties;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SmsServiceImpl</span><span class="hljs-params">(SmsProperties properties)</span> {
        <span class="hljs-built_in">this</span>.properties = properties;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">send</span><span class="hljs-params">(String phone, String content)</span> {
        System.out.printf(<span class="hljs-string">"发送短信到%s: %s [使用配置: %s]%n"</span>, 
            phone, content, properties.getEndpoint());
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<h4 data-id="heading-15">步骤5：注册自动配置</h4>
<p>在<code>resources/META-INF/spring.factories</code>中：</p>
<pre><code class="hljs language-properties" lang="properties">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
com.example.sms.SmsAutoConfiguration
</code></pre>
<h4 data-id="heading-16">步骤6：在其他项目中使用</h4>
<ol>
<li>引入依赖：</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sms-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<ol start="2">
<li>添加配置：</li>
</ol>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml</span>
<span class="hljs-attr">sms:</span>
  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">access-key:</span> <span class="hljs-string">your-access-key</span>
  <span class="hljs-attr">secret-key:</span> <span class="hljs-string">your-secret-key</span>
  <span class="hljs-attr">sign-name:</span> <span class="hljs-string">阿里云</span>
</code></pre>
<ol start="3">
<li>直接注入使用：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> SmsService smsService;  <span class="hljs-comment">// 自动注入</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-comment">// 注册逻辑...</span>
        smsService.send(user.getPhone(), <span class="hljs-string">"注册验证码: 123456"</span>);
    }
}
</code></pre>
<h3 data-id="heading-17">五、自动配置的调试技巧</h3>
<p>当你遇到配置不生效的问题时，可以使用以下方法调试：</p>
<h4 data-id="heading-18">1. 开启调试日志</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml</span>
<span class="hljs-attr">debug:</span> <span class="hljs-literal">true</span>
</code></pre>
<p>启动时会打印哪些自动配置类生效了，哪些没有生效及其原因。</p>
<h4 data-id="heading-19">2. 使用ConditionEvaluationReport</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Application</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ConfigurableApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> 
            SpringApplication.run(Application.class, args);
        
        <span class="hljs-comment">// 打印条件评估报告</span>
        <span class="hljs-type">ConditionEvaluationReport</span> <span class="hljs-variable">report</span> <span class="hljs-operator">=</span> 
            ConditionEvaluationReport.get(context.getBeanFactory());
        report.getConditionAndOutcomesBySource().forEach((source, outcomes) -&gt; {
            System.out.println(source);
            outcomes.forEach(outcome -&gt; {
                System.out.println(<span class="hljs-string">"\t"</span> + outcome.getOutcome());
            });
        });
    }
}
</code></pre>
<h3 data-id="heading-20">六、自动配置的最佳实践</h3>
<ol>
<li><strong>合理使用条件注解</strong>：避免过度配置，只在条件满足时生效</li>
<li><strong>提供合理的默认值</strong>：让用户无需配置就能使用</li>
<li><strong>允许用户覆盖</strong>：使用<code>@ConditionalOnMissingBean</code>让用户能自定义Bean</li>
<li><strong>良好的配置前缀</strong>：使用清晰的前缀，如<code>spring.datasource</code></li>
<li><strong>提供配置提示</strong>：创建<code>spring-configuration-metadata.json</code>提供IDE提示</li>
</ol>
<h3 data-id="heading-21">总结</h3>
<p>SpringBoot的自动配置通过以下机制实现"约定优于配置"：</p>
<ol>
<li><strong>启动注解复合</strong>：<code>@SpringBootApplication</code>集成了配置、扫描和自动配置</li>
<li><strong>工厂加载机制</strong>：通过<code>spring.factories</code>加载所有自动配置类</li>
<li><strong>条件化装配</strong>：根据环境按需加载，避免不必要的配置</li>
<li><strong>合理的默认值</strong>：提供开箱即用的默认配置</li>
</ol>
<h3 data-id="heading-22">今日思考题</h3>
<p>如果我想创建一个数据库连接池的Starter，需要满足以下条件：</p>
<ol>
<li>当类路径下有HikariCP时使用HikariCP</li>
<li>当类路径下有Druid时使用Druid</li>
<li>用户可以通过配置选择使用哪个连接池</li>
</ol>
<p>该如何设计这个自动配置类呢？欢迎在评论区分享你的思路！</p>
<p>可以关注公众号：小坏说Java</p>
<hr/>
<p><strong>下期预告</strong>：明天我们将探讨《SpringBoot全局异常处理：别再到处try-catch了！》，学习如何优雅地处理异常，打造健壮的应用。</p>
<p><strong>互动时间</strong>：你在使用SpringBoot自动配置时遇到过哪些有趣的问题或技巧？欢迎留言分享！</p>
<p><strong>资源获取</strong>：关注公众号回复"自动配置源码"，获取本文所有示例代码及自定义Starter完整项目。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS Swift 可选值（Optional）详解]]></title>    <link>https://juejin.cn/post/7586482851097706536</link>    <guid>https://juejin.cn/post/7586482851097706536</guid>    <pubDate>2025-12-22T02:16:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586482851097706536" data-draft-id="7581036773607800832" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS Swift 可选值（Optional）详解"/> <meta itemprop="keywords" content="前端,iOS"/> <meta itemprop="datePublished" content="2025-12-22T02:16:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="tangbin583085"/> <meta itemprop="url" content="https://juejin.cn/user/95026578465675"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS Swift 可选值（Optional）详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/95026578465675/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    tangbin583085
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:16:22.000Z" title="Mon Dec 22 2025 02:16:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Swift 与 Objective-C 最大的区别之一，就是 <strong>Optional（可选值）机制</strong>。<br/>
它从语言层面解决了“空指针崩溃”的问题，但如果使用不当，也可能引入新的 Crash。</p>
<p>在日常开发中，我们经常看到下面这些写法：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">var</span> name: <span class="hljs-type">String</span>?
<span class="hljs-keyword">var</span> age: <span class="hljs-type">Int</span>!

<span class="hljs-keyword">let</span> title <span class="hljs-operator">=</span> text <span class="hljs-operator">??</span> <span class="hljs-string">"默认标题"</span>
imageView.image <span class="hljs-operator">=</span> <span class="hljs-type">UIImage</span>(named: imgName <span class="hljs-operator">??</span> <span class="hljs-string">""</span>)
</code></pre>
<p>本文将<strong>系统讲解 <code>?</code>、<code>!</code>、<code>??</code> 的含义、区别、适用场景与工程级最佳实践</strong>，帮助你在 Swift 项目中写出更安全、更专业的代码。</p>
<hr/>
<h2 data-id="heading-0">什么是 Optional（可选值）</h2>
<p>在 Swift 中，<strong>Optional 表示一个变量「可能有值，也可能为 nil」</strong>。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">var</span> name: <span class="hljs-type">String</span>? <span class="hljs-operator">=</span> <span class="hljs-string">"Hello World"</span>
name <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>
</code></pre>
<p>等价理解为：</p>
<blockquote>
<p>「这个变量可以为空，编译器强制你在使用前处理好为空的情况」</p>
</blockquote>
<p>这与 OC 中的 <code>id</code>、<code>NSString *</code> 完全不同，是 <strong>编译器层面的安全保障</strong>。</p>
<hr/>
<h2 data-id="heading-1">Optional 本质是什么？</h2>
<p>从语言层面来看：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> value: <span class="hljs-type">Int</span>?
</code></pre>
<p>本质上相当于一个枚举：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Optional</span>&lt;<span class="hljs-title class_">Int</span>&gt; {
    <span class="hljs-keyword">case</span> <span class="hljs-keyword">some</span>(<span class="hljs-type">Int</span>)
    <span class="hljs-keyword">case</span> none
}
</code></pre>
<p>也正是因为这样，<strong>Swift 不允许你直接使用 Optional 的值</strong>。</p>
<hr/>
<h2 data-id="heading-2">一、<code>?</code> —— 可选类型（Optional）</h2>
<h3 data-id="heading-3">定义方式</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">var</span> username: <span class="hljs-type">String</span>?
</code></pre>
<p>表示：</p>
<ul>
<li>可能有值</li>
<li>也可能为 <code>nil</code></li>
</ul>
<h3 data-id="heading-4">使用限制</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> len <span class="hljs-operator">=</span> username.count <span class="hljs-operator">❌</span> 编译错误
</code></pre>
<p>你必须 <strong>先解包（unwrap）</strong> ，才能使用。</p>
<hr/>
<h3 data-id="heading-5">安全解包方式一：<code>if let</code></h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> name <span class="hljs-operator">=</span> username {
    <span class="hljs-built_in">print</span>(name.count)
} <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"username 为 nil"</span>)
}
</code></pre>
<hr/>
<h3 data-id="heading-6">安全解包方式二：<code>guard let</code></h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">printName</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">username</span>: <span class="hljs-type">String</span>?) {
    <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> name <span class="hljs-operator">=</span> username <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"name 为 nil，提前返回"</span>)
        <span class="hljs-keyword">return</span>
    }
    
    <span class="hljs-built_in">print</span>(name.count)
}
</code></pre>
<hr/>
<h2 data-id="heading-7">二、<code>!</code> —— 强制解包（Force Unwrap）</h2>
<h3 data-id="heading-8">定义方式</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">var</span> age: <span class="hljs-type">Int</span>! <span class="hljs-operator">=</span> <span class="hljs-number">18</span>
</code></pre>
<p>表示：</p>
<blockquote>
<p>“我<strong>确信</strong>这个变量在使用时一定不为 nil”</p>
</blockquote>
<hr/>
<h3 data-id="heading-9">使用方式</h3>
<p>swift</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">print</span>(age + <span class="hljs-number">1</span>)   <span class="hljs-comment">// 看起来像非 Optional</span>
</code></pre>
<p><strong>风险点</strong></p>
<pre><code class="hljs language-swift" lang="swift">age <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>
<span class="hljs-built_in">print</span>(age <span class="hljs-operator">+</span> <span class="hljs-number">1</span>)  <span class="hljs-comment">// 运行时崩溃</span>
</code></pre>
<hr/>
<h3 data-id="heading-10">"!"的正确使用场景</h3>
<p>IBOutlet<br/>
生命周期受控变量</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">@IBOutlet</span> <span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> titleLabel: <span class="hljs-type">UILabel</span>!
</code></pre>
<p>原因：</p>
<ul>
<li>view 加载完成后一定存在</li>
<li>系统保证初始化时机</li>
</ul>
<p>某些依赖注入后一定存在的对象</p>
<hr/>
<h3 data-id="heading-11">不推荐的用法</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">var</span> userName: <span class="hljs-type">String</span>!
<span class="hljs-built_in">print</span>(userName.count) <span class="hljs-comment">// 非常危险 ❌</span>
</code></pre>
<p><strong>总结一句话</strong>：</p>
<blockquote>
<p><code>!</code> 是写给“你未来的自己看的承诺”，一旦违背就会 Crash</p>
</blockquote>
<hr/>
<h2 data-id="heading-12">三、<code>??</code> —— 空值合并运算符（Nil-Coalescing）</h2>
<h3 data-id="heading-13">基本用法</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> displayName <span class="hljs-operator">=</span> username <span class="hljs-operator">??</span> <span class="hljs-string">"匿名用户"</span>
</code></pre>
<p>含义：</p>
<blockquote>
<p>如果 <code>username</code> 不为 nil，使用它<br/>
否则使用 <code>"匿名用户"</code></p>
</blockquote>
<hr/>
<h3 data-id="heading-14">常见使用场景</h3>
<h4 data-id="heading-15">场景 1：UI 显示兜底</h4>
<pre><code class="hljs language-swift" lang="swift">titleLabel.text <span class="hljs-operator">=</span> model.title <span class="hljs-operator">??</span> <span class="hljs-string">"暂无标题"</span>
</code></pre>
<h4 data-id="heading-16">场景 2：参数默认值</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">loadData</span>(<span class="hljs-params">page</span>: <span class="hljs-type">Int</span>?) {
    <span class="hljs-keyword">let</span> currentPage <span class="hljs-operator">=</span> page <span class="hljs-operator">??</span> <span class="hljs-number">1</span>
    <span class="hljs-built_in">print</span>(currentPage)
}
</code></pre>
<h4 data-id="heading-17">场景 3：Data / String 转换兜底</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> data <span class="hljs-operator">=</span> <span class="hljs-type">Data</span>(base64Encoded: base64Str <span class="hljs-operator">??</span> <span class="hljs-string">""</span>)
</code></pre>
<hr/>
<h2 data-id="heading-18"><code>?</code> + <code>?.</code> —— 可选链（Optional Chaining）</h2>
<h3 data-id="heading-19">示例</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> length <span class="hljs-operator">=</span> username<span class="hljs-operator">?</span>.count
</code></pre>
<p>返回值类型：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-type">Int</span>?
</code></pre>
<p>如果 <code>username == nil</code>：</p>
<ul>
<li>不会执行 <code>.count</code></li>
<li>整个表达式返回 nil</li>
</ul>
<hr/>
<h3 data-id="heading-20">常见链式调用</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> city <span class="hljs-operator">=</span> user<span class="hljs-operator">?</span>.profile<span class="hljs-operator">?</span>.address<span class="hljs-operator">?</span>.city
</code></pre>
<h3 data-id="heading-21">从服务器返回数据解析</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-keyword">let</span> name: <span class="hljs-type">String</span>?
    <span class="hljs-keyword">let</span> age: <span class="hljs-type">Int</span>?
}

<span class="hljs-keyword">func</span> <span class="hljs-title function_">showUser</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">user</span>: <span class="hljs-type">User</span>?) {
    <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> user <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"user 不存在"</span>)
        <span class="hljs-keyword">return</span>
    }
    
    <span class="hljs-keyword">let</span> name <span class="hljs-operator">=</span> user.name <span class="hljs-operator">??</span> <span class="hljs-string">"未知"</span>
    <span class="hljs-keyword">let</span> age <span class="hljs-operator">=</span> user.age <span class="hljs-operator">??</span> <span class="hljs-number">0</span>
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"(name)，(age) 岁"</span>)
}
</code></pre>
<hr/>
<h2 data-id="heading-22">常见错误用法总结</h2>
<p>滥用 <code>!</code></p>
<pre><code class="hljs language-swift" lang="swift">user<span class="hljs-operator">!</span>.name<span class="hljs-operator">!</span>.count <span class="hljs-operator">❌</span>
</code></pre>
<p>嵌套 if let 过深</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> a <span class="hljs-operator">=</span> a {
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> b <span class="hljs-operator">=</span> b {
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> c <span class="hljs-operator">=</span> c {
            <span class="hljs-operator">...</span>
        }
    }
}
</code></pre>
<p>更优写法：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> a, <span class="hljs-keyword">let</span> b, <span class="hljs-keyword">let</span> c <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }
</code></pre>
<h2 data-id="heading-23">总结</h2>
<p>Swift 的 Optional 不是语法糖，而是 <strong>逼着你在代码层面提前思考风险</strong>。</p>
<p>如有说错的地方，满发指正相互学习，谢谢~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Next.js第十五章(Image)]]></title>    <link>https://juejin.cn/post/7585897699602923546</link>    <guid>https://juejin.cn/post/7585897699602923546</guid>    <pubDate>2025-12-22T02:17:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585897699602923546" data-draft-id="7585808181239873587" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Next.js第十五章(Image)"/> <meta itemprop="keywords" content="前端,Next.js"/> <meta itemprop="datePublished" content="2025-12-22T02:17:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小满zs"/> <meta itemprop="url" content="https://juejin.cn/user/2463384809252397"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Next.js第十五章(Image)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2463384809252397/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小满zs
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:17:09.000Z" title="Mon Dec 22 2025 02:17:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Image组件</h2>
<p>该组件是Next.js内置的图片组件，是基于原生<code>img</code>标签进行扩展，并不代表原生<code>img</code>标签不能使用。</p>
<ul>
<li>尺寸优化：支持使用现代化图片格式，如<code>webp</code>，<code>avif</code>，<code>apng</code>等,并自动根据设备提供正确的尺寸。</li>
<li>视觉稳定性：防止图片加载时发生布局偏移，具体参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fweb.dev%2Farticles%2Fcls%3Fhl%3Dzh-cn" target="_blank" title="https://web.dev/articles/cls?hl=zh-cn" ref="nofollow noopener noreferrer">CLS</a></li>
<li>懒加载：在图片进入视口才会加载，使用浏览器原生懒加载，并可选择添加模糊显示占位符。</li>
<li>灵活性：可按需调整图像大小，即使是存储在远程服务器上的图像也可以调整。</li>
</ul>
<h4 data-id="heading-1">图片引入</h4>
<h5 data-id="heading-2">1. src本地图片引入</h5>
<p>Next.js建议我们把图片放在根目录下的<code>public</code>文件夹中，然后使用<code>/</code>开头访问。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a73a9cf6e7c4be8b3f3b61e531a778f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974628&amp;x-signature=GFjfFcsoNvoSwKUNnkb9VH%2F68kc%3D" alt="public.png" loading="lazy"/></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/image"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
                <span class="hljs-attr">src</span>=<span class="hljs-string">"/1.png"</span>
                <span class="hljs-attr">width</span>=<span class="hljs-string">{100}</span>
                <span class="hljs-attr">height</span>=<span class="hljs-string">{100}</span>
                <span class="hljs-attr">alt</span>=<span class="hljs-string">"1"</span>
            /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<h5 data-id="heading-3">2. import静态引入</h5>
<p>使用<code>import</code>引入图片，是不需要填写宽度和高度，Next.js会自动确定图片的尺寸。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"@/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./src/*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"@/public/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./public/*"</span><span class="hljs-punctuation">]</span> <span class="hljs-comment">// 新增这一行代码，配置图片路径。</span>
        <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>使用静态<code>import</code>引入图片，你会发现无需填写宽度和高度，Next.js会自动确定图片的尺寸。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/image"</span>
<span class="hljs-keyword">import</span> test <span class="hljs-keyword">from</span> <span class="hljs-string">'@/public/1.png'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
                <span class="hljs-attr">src</span>=<span class="hljs-string">{test}</span>
                <span class="hljs-attr">alt</span>=<span class="hljs-string">"1"</span>
            /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<h5 data-id="heading-4">3. 远程图片引入</h5>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/image"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> len = <span class="hljs-number">20</span>;
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            {Array.from({ length: len }).map((_, index) =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
                    <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>
                    <span class="hljs-attr">src</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">https:</span>//<span class="hljs-attr">eo-img.521799.xyz</span>/<span class="hljs-attr">i</span>/<span class="hljs-attr">pc</span>/<span class="hljs-attr">img</span>${<span class="hljs-attr">index</span> + <span class="hljs-attr">1</span>}<span class="hljs-attr">.webp</span>`}
                    <span class="hljs-attr">alt</span>=<span class="hljs-string">"1"</span>
                    <span class="hljs-attr">width</span>=<span class="hljs-string">{192}</span>
                    <span class="hljs-attr">height</span>=<span class="hljs-string">{108}</span>
                /&gt;</span>
            ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p>当我们直接使用远程图片引入的时候Next.js会报错，因为Next.js默认只允许加载本地图片，如果需要加载远程图片，需要配置<code>next.config.js</code>文件。</p>
<p>image-loader.ts:86 Uncaught Error: Invalid src prop (<a href="https://link.juejin.cn?target=https%3A%2F%2Feo-img.521799.xyz%2Fi%2Fpc%2Fimg1.webp" target="_blank" title="https://eo-img.521799.xyz/i/pc/img1.webp" ref="nofollow noopener noreferrer">eo-img.521799.xyz/i/pc/img1.w…</a>) on <code>next/image</code>, hostname "eo-img.521799.xyz" is not configured under images in your <code>next.config.js</code></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">NextConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-attr">nextConfig</span>: <span class="hljs-title class_">NextConfig</span> = {
  <span class="hljs-comment">/* config options here */</span>
  <span class="hljs-attr">images</span>: {
    <span class="hljs-attr">remotePatterns</span>: [
      {
        <span class="hljs-attr">protocol</span>: <span class="hljs-string">'https'</span>, <span class="hljs-comment">// 协议</span>
        <span class="hljs-attr">hostname</span>: <span class="hljs-string">'eo-img.521799.xyz'</span>, <span class="hljs-comment">// 主机名</span>
        <span class="hljs-attr">pathname</span>: <span class="hljs-string">'/i/pc/**'</span>, <span class="hljs-comment">// 路径</span>
        <span class="hljs-attr">port</span>: <span class="hljs-string">''</span>, <span class="hljs-comment">// 端口</span>
      },
    ],
  },
};
</code></pre>
<h5 data-id="heading-5">4. LCP警告</h5>
<p>如果图片是首屏或者LCP图片，需要添加<code>loading="eager"</code>属性，否则会触发LCP警告,因为Image组件默认是懒加载的。</p>
<ul>
<li>lazy: 懒加载，默认值，在图片进入视口才会加载。</li>
<li>eager: 立即加载，在图片进入视口就会加载。</li>
</ul>
<p>Image with src "<a href="https://link.juejin.cn?target=https%3A%2F%2Feo-img.521799.xyz%2Fi%2Fpc%2Fimg1.webp" target="_blank" title="https://eo-img.521799.xyz/i/pc/img1.webp" ref="nofollow noopener noreferrer">eo-img.521799.xyz/i/pc/img1.w…</a>" was detected as the Largest Contentful Paint (LCP). Please add the <code>loading="eager"</code> property if this image is above the fold.
Read more: <a href="https://link.juejin.cn?target=https%3A%2F%2Fnextjs.org%2Fdocs%2Fapp%2Fapi-reference%2Fcomponents%2Fimage%23loading" target="_blank" title="https://nextjs.org/docs/app/api-reference/components/image#loading" ref="nofollow noopener noreferrer">nextjs.org/docs/app/ap…</a></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/image"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> len = <span class="hljs-number">20</span>
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            {Array.from({ length: len }).map((_, index) =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
                    <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>
                    <span class="hljs-attr">src</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">https:</span>//<span class="hljs-attr">eo-img.521799.xyz</span>/<span class="hljs-attr">i</span>/<span class="hljs-attr">pc</span>/<span class="hljs-attr">img</span>${<span class="hljs-attr">index</span> + <span class="hljs-attr">1</span>}<span class="hljs-attr">.webp</span>`}
                    <span class="hljs-attr">alt</span>=<span class="hljs-string">"1"</span>
                    <span class="hljs-attr">width</span>=<span class="hljs-string">{192}</span>
                    <span class="hljs-attr">height</span>=<span class="hljs-string">{108}</span>
                    <span class="hljs-attr">loading</span>=<span class="hljs-string">"eager"</span> // <span class="hljs-attr">立即加载</span>
                /&gt;</span>
            ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p>第二种解决方案使用<code>preload</code>属性加载图片，表示提前预加载图片，不过Next.js还是更加推荐使用<code>loading="eager"</code>属性加载图片。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/image"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> len = <span class="hljs-number">20</span>
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            {Array.from({ length: len }).map((_, index) =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
                    <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>
                    <span class="hljs-attr">src</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">https:</span>//<span class="hljs-attr">eo-img.521799.xyz</span>/<span class="hljs-attr">i</span>/<span class="hljs-attr">pc</span>/<span class="hljs-attr">img</span>${<span class="hljs-attr">index</span> + <span class="hljs-attr">1</span>}<span class="hljs-attr">.webp</span>`}
                    <span class="hljs-attr">alt</span>=<span class="hljs-string">"1"</span>
                    <span class="hljs-attr">width</span>=<span class="hljs-string">{192}</span>
                    <span class="hljs-attr">height</span>=<span class="hljs-string">{108}</span>
                    <span class="hljs-attr">preload</span>=<span class="hljs-string">{index</span> &lt; <span class="hljs-attr">10</span>} // <span class="hljs-attr">优先加载策略</span>
                /&gt;</span>
            ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<h5 data-id="heading-6">5. 图片格式优化</h5>
<p>Next.js 会通过请求Accept头自动检测浏览器支持的图像格式，以确定最佳输出格式</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title class_">Accept</span>:image/avif,image/webp,image/apng,image/svg+xml,image<span class="hljs-comment">/*,*/</span>*;q=<span class="hljs-number">0.8</span>
</code></pre>
<p>我们可以同时启用 AVIF 和 WebP 格式。对于支持 AVIF 的浏览器，系统将优先使用 AVIF 格式，WebP 格式作为备选方案。目前AVIF格式最优。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-attr">nextConfig</span>: <span class="hljs-title class_">NextConfig</span> = {
  <span class="hljs-comment">/* config options here */</span>
  <span class="hljs-attr">images</span>: {
    <span class="hljs-attr">formats</span>: [<span class="hljs-string">'image/avif'</span>, <span class="hljs-string">'image/webp'</span>], <span class="hljs-comment">//默认是 ['image/webp']</span>
  },
};
</code></pre>
<h5 data-id="heading-7">6. 设备适配</h5>
<p>如果你的老板告诉你要兼容哪些设备，你可以使用<code>deviceSizes</code>和<code>imageSizes</code>属性来配置。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-attr">nextConfig</span>: <span class="hljs-title class_">NextConfig</span> = {
  <span class="hljs-comment">/* config options here */</span>
  <span class="hljs-attr">images</span>: {
    <span class="hljs-attr">deviceSizes</span>: [<span class="hljs-number">640</span>, <span class="hljs-number">750</span>, <span class="hljs-number">828</span>, <span class="hljs-number">1080</span>, <span class="hljs-number">1200</span>, <span class="hljs-number">1920</span>, <span class="hljs-number">2048</span>, <span class="hljs-number">3840</span>], <span class="hljs-comment">// 设备尺寸</span>
    <span class="hljs-attr">imageSizes</span>: [<span class="hljs-number">16</span>, <span class="hljs-number">32</span>, <span class="hljs-number">48</span>, <span class="hljs-number">64</span>, <span class="hljs-number">96</span>, <span class="hljs-number">128</span>, <span class="hljs-number">256</span>, <span class="hljs-number">384</span>], <span class="hljs-comment">// 图片尺寸</span>
  },
};
</code></pre>
<p>这两个属性结合会最终生成一个<code>srcset</code>属性，用于浏览器选择最佳图片。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bed6fc34c0a414484df71bcf1dbe922~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974628&amp;x-signature=vOdeCraZzznSMXE%2FFPdALioNi2Y%3D" alt="srcset.png" loading="lazy"/></p>
<p>那为什么需要两个数组去实现呢？</p>
<p>我们观察上图可以发现，<code>imageSizes</code>用于生成小图片尺寸例如(缩略图，头像等)，而<code>deviceSizes</code>用于生成大图片尺寸例如(横幅图、背景图、全屏展示图)。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/image"</span>

<span class="hljs-comment">// 头像 - 固定 64px</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Avatar</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
      <span class="hljs-attr">src</span>=<span class="hljs-string">"/avatar.jpg"</span>
      <span class="hljs-attr">width</span>=<span class="hljs-string">{64}</span>
      <span class="hljs-attr">height</span>=<span class="hljs-string">{64}</span>
      <span class="hljs-attr">alt</span>=<span class="hljs-string">"用户头像"</span>
      <span class="hljs-attr">sizes</span>=<span class="hljs-string">"64px"</span>  // ← <span class="hljs-attr">告诉浏览器这张图只需要</span> <span class="hljs-attr">64px</span>
    /&gt;</span></span>
  )
}

<span class="hljs-comment">// 横幅图 - 响应式全宽</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Banner</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
      <span class="hljs-attr">src</span>=<span class="hljs-string">"/banner.jpg"</span>
      <span class="hljs-attr">width</span>=<span class="hljs-string">{1920}</span>
      <span class="hljs-attr">height</span>=<span class="hljs-string">{600}</span>
      <span class="hljs-attr">alt</span>=<span class="hljs-string">"横幅"</span>
      <span class="hljs-attr">sizes</span>=<span class="hljs-string">"100vw"</span>  // ← <span class="hljs-attr">占满整个视口宽度</span>，<span class="hljs-attr">使用</span> <span class="hljs-attr">deviceSizes</span>
    /&gt;</span></span>
  )
}

<span class="hljs-comment">// 响应式内容图</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ContentImage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
      <span class="hljs-attr">src</span>=<span class="hljs-string">"/content.jpg"</span>
      <span class="hljs-attr">width</span>=<span class="hljs-string">{1200}</span>
      <span class="hljs-attr">height</span>=<span class="hljs-string">{800}</span>
      <span class="hljs-attr">alt</span>=<span class="hljs-string">"内容图"</span>
      <span class="hljs-attr">sizes</span>=<span class="hljs-string">"(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 1200px"</span>
      // ↑ <span class="hljs-attr">手机上</span> <span class="hljs-attr">100</span>% <span class="hljs-attr">宽度</span>，<span class="hljs-attr">平板上</span> <span class="hljs-attr">50</span>%，<span class="hljs-attr">桌面最大</span> <span class="hljs-attr">1200px</span>
    /&gt;</span></span>
  )
}
</code></pre>
<h4 data-id="heading-8">Props</h4>
<p>以下是 Image 组件可用的属性：</p>
<h5 data-id="heading-9">必需属性</h5>























<table><thead><tr><th>属性</th><th>类型</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>src</td><td>String</td><td><code>src="/profile.png"</code></td><td>图片源路径，支持本地路径或远程 URL</td></tr><tr><td>alt</td><td>String</td><td><code>alt="Picture of the author"</code></td><td>图片替代文本，用于无障碍访问和 SEO</td></tr></tbody></table>
<h5 data-id="heading-10">尺寸相关</h5>



































<table><thead><tr><th>属性</th><th>类型</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>width</td><td>Integer (px)</td><td><code>width={500}</code></td><td>图片宽度，静态导入时可选</td></tr><tr><td>height</td><td>Integer (px)</td><td><code>height={500}</code></td><td>图片高度，静态导入时可选</td></tr><tr><td>fill</td><td>Boolean</td><td><code>fill={true}</code></td><td>填充父容器，替代 width 和 height</td></tr><tr><td>sizes</td><td>String</td><td><code>sizes="(max-width: 768px) 100vw"</code></td><td>响应式图片尺寸</td></tr></tbody></table>
<h5 data-id="heading-11">优化相关</h5>





























<table><thead><tr><th>属性</th><th>类型</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>quality</td><td>Integer (1-100)</td><td><code>quality={80}</code></td><td>图片压缩质量，默认为 75</td></tr><tr><td>loader</td><td>Function</td><td><code>loader={imageLoader}</code></td><td>自定义图片加载器函数</td></tr><tr><td>unoptimized</td><td>Boolean</td><td><code>unoptimized={true}</code></td><td>禁用图片优化，使用原图</td></tr></tbody></table>
<h5 data-id="heading-12">加载相关</h5>



































<table><thead><tr><th>属性</th><th>类型</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>loading</td><td>String</td><td><code>loading="lazy"</code></td><td>加载策略，"lazy" 或 "eager"</td></tr><tr><td>preload</td><td>Boolean</td><td><code>preload={true}</code></td><td>是否预加载，用于 LCP 元素</td></tr><tr><td>placeholder</td><td>String</td><td><code>placeholder="blur"</code></td><td>占位符类型，"blur" 或 "empty"</td></tr><tr><td>blurDataURL</td><td>String</td><td><code>blurDataURL="data:image/jpeg..."</code></td><td>模糊占位符的 Data URL</td></tr></tbody></table>
<h5 data-id="heading-13">事件回调</h5>























<table><thead><tr><th>属性</th><th>类型</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>onLoad</td><td>Function</td><td><code>onLoad={e =&gt; done()}</code></td><td>图片加载完成时的回调</td></tr><tr><td>onError</td><td>Function</td><td><code>onError={e =&gt; fail()}</code></td><td>图片加载失败时的回调</td></tr></tbody></table>
<h5 data-id="heading-14">其他属性</h5>





























<table><thead><tr><th>属性</th><th>类型</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>style</td><td>Object</td><td><code>style={{objectFit: "contain"}}</code></td><td>内联样式对象</td></tr><tr><td>overrideSrc</td><td>String</td><td><code>overrideSrc="/seo.png"</code></td><td>覆盖 src，用于 SEO 优化</td></tr><tr><td>decoding</td><td>String</td><td><code>decoding="async"</code></td><td>解码方式，"async"/"sync"/"auto"</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[antd 5 + react 18 + vite 7 升级]]></title>    <link>https://juejin.cn/post/7585948869844762659</link>    <guid>https://juejin.cn/post/7585948869844762659</guid>    <pubDate>2025-12-22T02:17:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585948869844762659" data-draft-id="7584719268044668962" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="antd 5 + react 18 + vite 7 升级"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2025-12-22T02:17:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="holidaypenguin"/> <meta itemprop="url" content="https://juejin.cn/user/2313028194801421"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            antd 5 + react 18 + vite 7 升级
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2313028194801421/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    holidaypenguin
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:17:19.000Z" title="Mon Dec 22 2025 02:17:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一年前react + vite + antd 项目 升级</h2>
<blockquote>
<p>目标升级到 antd 6 、 react 19、vite 8、babel-plugin-react-compiler</p>
<p>还有其他依赖项目 如 echarts</p>
</blockquote>
<h3 data-id="heading-1">升级 antd6 和 vite 8</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fant-design.antgroup.com%2Fdocs%2Freact%2Fmigration-v6-cn" target="_blank" title="https://ant-design.antgroup.com/docs/react/migration-v6-cn" ref="nofollow noopener noreferrer">从 v5 到 v6 - Ant Design</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.vite.dev%2Fblog%2Fannouncing-vite8-beta" target="_blank" title="https://cn.vite.dev/blog/announcing-vite8-beta" ref="nofollow noopener noreferrer">Vite 8 Beta: The Rolldown-powered Vite | Vite 官方中文文档</a></li>
</ul>
<h4 data-id="heading-2">更新相关依赖</h4>
<ul>
<li>手动查看相关依赖版本，修改antd和vite相关依赖版本
<ul>
<li>antd</li>
<li>@ant-design/icons</li>
<li>@vitejs/plugin-react-oxc -&gt; @vitejs/plugin-react</li>
<li>vite</li>
<li>其他一些无关紧要的依赖版本升级</li>
</ul>
</li>
<li><code>antd@6</code> 要求 <code>@ant-design/icons</code> 版本 &gt;= 6.0.0</li>
<li>@vitejs/plugin-react-oxc is deprecated. Please use @vitejs/plugin-react instead. The changes of this plugin is now included in @vitejs/plugin-react.</li>
</ul>
<p>修改相关依赖项版本然后安装依赖</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d3deef43a06436dbb7d4fb673986fed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaG9saWRheXBlbmd1aW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974639&amp;x-signature=yWn3N%2F%2FcTv0aoePwoglLwaINhF0%3D" alt="image.png" loading="lazy"/></p>
<p>第一次启动</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa81367939e140f5bfe49ee0b5b650c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaG9saWRheXBlbmd1aW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974639&amp;x-signature=z0FUwfMVE7rO31XEiRMtBgm35gQ%3D" alt="image.png" loading="lazy"/></p>
<p>@vitejs/plugin-react</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a41ac2e84c149dc97e71d8a787165f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaG9saWRheXBlbmd1aW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974639&amp;x-signature=xCWgBB15u25WX1glTRlpxYYgf0I%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-3">修改 antd 6 的API调整</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fant-design.antgroup.com%2Fdocs%2Freact%2Fmigration-v6-cn%23api-%25E8%25B0%2583%25E6%2595%25B4" target="_blank" title="https://ant-design.antgroup.com/docs/react/migration-v6-cn#api-%E8%B0%83%E6%95%B4" ref="nofollow noopener noreferrer">从 v5 到 v6 - Ant Design</a></p>
<h5 data-id="heading-4"><code>Alert</code></h5>
<p>message  属性改成 title</p>
<h5 data-id="heading-5"><code>Card</code></h5>
<p>bodyStyle 属性没有了，组件中 styles 属性中 body 自定义的时候报错
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ef092b66e2d4dad884826b2200990e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaG9saWRheXBlbmd1aW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974639&amp;x-signature=rft%2BS7qR1DEoh1meMlf%2BtE6CoSo%3D" alt="image.png" loading="lazy"/></p>
<p>因为  <code>styles</code> 的类型   Record&lt;<a href="https://link.juejin.cn?target=https%3A%2F%2Fant-design.antgroup.com%2Fcomponents%2Fcard-cn%23semantic-dom" target="_blank" title="https://ant-design.antgroup.com/components/card-cn#semantic-dom" ref="nofollow noopener noreferrer">SemanticDOM</a>, CSSProperties&gt; | (info: { props })=&gt; Record&lt;<a href="https://link.juejin.cn?target=https%3A%2F%2Fant-design.antgroup.com%2Fcomponents%2Fcard-cn%23semantic-dom" target="_blank" title="https://ant-design.antgroup.com/components/card-cn#semantic-dom" ref="nofollow noopener noreferrer">SemanticDOM</a>, CSSProperties&gt;</p>
<p>增加一个代理属性</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">stylesProxy</span> = (<span class="hljs-params">info</span>) =&gt; {
    <span class="hljs-keyword">const</span> stylesObj = <span class="hljs-keyword">typeof</span> styles === <span class="hljs-string">'function'</span> ? <span class="hljs-title function_">styles</span>(info) : styles
    <span class="hljs-keyword">return</span> {
        ...stylesObj,
        <span class="hljs-attr">body</span>: {
            ...(stylesObj.<span class="hljs-property">body</span> || {}),
            <span class="hljs-attr">height</span>: full ? <span class="hljs-string">'100%'</span> : stylesObj?.<span class="hljs-property">body</span>?.<span class="hljs-property">height</span> || <span class="hljs-string">'auto'</span>,
        }
    }
}

&lt;<span class="hljs-title class_">Card</span> 
    {...args}
    styles={stylesProxy}
/&gt;
</code></pre>
<h5 data-id="heading-6"><code>Dropdown</code> <code>Button</code></h5>
<blockquote>
<p>hover显示的时候点击会消失，再次hover也不显示，等组件库升级好以后，在升级react 19 看看是否能解决。</p>
</blockquote>
<h5 data-id="heading-7"><code>Input</code> 和 <code>InputNumber</code>   <code>addonAfter</code>  <code>addonAfter</code> 属性废弃</h5>
<blockquote>
<p>预留问题：因为暂时还能用，先整体升级完再解决</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87fafaa096fc435a86c70fb68bb450d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaG9saWRheXBlbmd1aW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974639&amp;x-signature=e3xGEsIOXB187Bm1nJlBaAIauTo%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-8"><code>Progress</code></h5>
<p><code>strokeWidth</code> 弃用，变为 <code>size</code>。当  <code>type="circle"</code>  <code>type="dashboard"</code> 的时候 strokeWidth 还是保留的</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed8cb8242a404fd38a583a4773f52058~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaG9saWRheXBlbmd1aW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974639&amp;x-signature=C9ZiJcpSGeRin94oDYJ%2BiiLjf4U%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-9"><code>Select</code></h5>
<p>filterOption 废弃，使用 showSearch.filterOption</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fef1f97fde94ba7b628e75f2e0cc8b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaG9saWRheXBlbmd1aW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974639&amp;x-signature=aTWqmJ%2BOf0AA0LqJGedPDle8dIQ%3D" alt="image.png" loading="lazy"/></p>
<p>通用组件类型定义</p>
<pre><code class="hljs language-java" lang="java">export <span class="hljs-keyword">interface</span> <span class="hljs-title class_">FISelectProps</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Omit</span>&lt;SelectProps, <span class="hljs-string">'filterOption'</span>&gt; {}
</code></pre>
<p>通用组件制定默认搜索方法</p>
<pre><code class="hljs language-tsx" lang="tsx">
<span class="hljs-keyword">const</span> <span class="hljs-attr">showSearchProxy</span>: <span class="hljs-title class_">SelectProps</span>[<span class="hljs-string">'showSearch'</span>] = <span class="hljs-keyword">typeof</span> showSearch === <span class="hljs-string">'boolean'</span> &amp;&amp; showSearch === <span class="hljs-literal">true</span>
    ? {
        <span class="hljs-attr">filterOption</span>: filterOptionProxy,
    }
    : <span class="hljs-keyword">typeof</span> showSearch !== <span class="hljs-string">'boolean'</span>
        ? {
            ...showSearch,
            <span class="hljs-attr">filterOption</span>: showSearch.<span class="hljs-property">filterOption</span> || filterOptionProxy,
        }
        : showSearch
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fant-design%2Fant-design%2Fissues%2F55877" target="_blank" title="https://github.com/ant-design/ant-design/issues/55877" ref="nofollow noopener noreferrer">[Bug 6.0] Select 组件的 options 选项存在 label/value 等它支持的属性外的其他属性时 React 报警告错误 · Issue #55877 · ant-design/ant-design</a></p>
<p>这个警告是因为 Select 的 options 里自定义属性（比如 labelPinyin）被直接传递到 DOM 元素上，React 19 对未知属性检查更严格，所以会报错。Ant Design 6.0.0 没有自动过滤这些非标准属性，导致自定义字段会被当作 DOM 属性渲染，触发警告 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fant-design%2Fant-design%2Fblob%2F816912441c855a2bc17c06d697299f312d81a4a2%2Fcomponents%2Fselect%2Findex.tsx%23L3-L419" target="_blank" title="https://github.com/ant-design/ant-design/blob/816912441c855a2bc17c06d697299f312d81a4a2/components/select/index.tsx#L3-L419" ref="nofollow noopener noreferrer">源码分析</a>。</p>
<p>Issue 推荐做法是用 <code>optionRender</code>，只在渲染时取出自定义属性，不让它们直接传递到 DOM。例如：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">options</span> = [
  { label: <span class="hljs-string">'苹果'</span>, value: <span class="hljs-string">'apple'</span>, labelPinyin: <span class="hljs-string">'pingguo'</span> },
  { label: <span class="hljs-string">'香蕉'</span>, value: <span class="hljs-string">'banana'</span>, labelPinyin: <span class="hljs-string">'xiangjiao'</span> },
]<span class="hljs-comment">;</span>

&lt;Select
  <span class="hljs-attr">options</span>={options}
  <span class="hljs-attr">optionRender</span>={option =&gt; (
    &lt;span&gt;
      {option.data.label} &lt;span <span class="hljs-attr">style</span>={{ color: <span class="hljs-string">'#aaa'</span> }}&gt;{option.data.labelPinyin}&lt;/span&gt;
    &lt;/span&gt;
  )}
/&gt;
</code></pre>
<p>结果试了下都不行，仍然没有结果警告。但是我发现即使没有 optionRender ，选项出现的时候也没有问题，但是问题出现在选中后的显示上，我虽然加了 labelRender ，也一样会有警告。</p>
<p>所以我最终采用的办法是使用一个统一组件去过滤非必要的属性</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { memo, useContext, useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Select</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">SelectProps</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>

<span class="hljs-keyword">import</span> { isArray, isEmpty, isString } <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">FISelectProps</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Omit</span>&lt;<span class="hljs-title class_">SelectProps</span>, 'filterOption'&gt; {
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">FISelect</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">FISelectProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{
    options,
    placeholder = <span class="hljs-string">'请选择'</span>,
    value,
    onChange = () =&gt; {},
    mode,
    allowClear = <span class="hljs-literal">true</span>,
    showSearch = <span class="hljs-literal">true</span>,
    fieldNames = {},
    optionRender,
    ...args
}</span>) =&gt;</span> {

    <span class="hljs-keyword">const</span> isMultiple = mode === <span class="hljs-string">'multiple'</span>
    <span class="hljs-keyword">const</span> [valueProxy, setValueProxy] = useState&lt;<span class="hljs-built_in">any</span>&gt;(isMultiple ? [] : <span class="hljs-string">''</span>)

    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">setValueProxy</span>(value)
    }, [value])


    <span class="hljs-keyword">const</span> <span class="hljs-title function_">getOptions</span> = (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-comment">// console.log('-- getOptions --')</span>
        <span class="hljs-keyword">return</span> (options || []).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
            <span class="hljs-keyword">return</span> {
                <span class="hljs-attr">origin_data</span>: item,
                <span class="hljs-attr">value</span>: item[fieldNames.<span class="hljs-property">value</span> || <span class="hljs-string">'value'</span>],
                <span class="hljs-attr">label</span>: item[fieldNames.<span class="hljs-property">label</span> || <span class="hljs-string">'label'</span>],
            }
        })
    }

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">onChangeProxy</span> = (<span class="hljs-params">value: <span class="hljs-built_in">any</span>, option: <span class="hljs-built_in">any</span></span>) =&gt; {
        <span class="hljs-comment">// console.log('--onChangeProxy--', value, option, getOuterValue(value))</span>
        <span class="hljs-title function_">onChange</span>(value, option.<span class="hljs-property">origin_data</span>)
    }

    <span class="hljs-keyword">const</span> <span class="hljs-attr">showSearchProxy</span>: <span class="hljs-title class_">SelectProps</span>[<span class="hljs-string">'showSearch'</span>] = <span class="hljs-keyword">typeof</span> showSearch === <span class="hljs-string">'boolean'</span> &amp;&amp; showSearch === <span class="hljs-literal">true</span>
        ? {
            <span class="hljs-attr">filterOption</span>: filterOptionProxy,
        }
        : <span class="hljs-keyword">typeof</span> showSearch !== <span class="hljs-string">'boolean'</span>
            ? {
                ...showSearch,
                <span class="hljs-attr">filterOption</span>: showSearch.<span class="hljs-property">filterOption</span> || filterOptionProxy,
            }
            : showSearch

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">filterOptionProxy</span> (<span class="hljs-attr">inputValue</span>: <span class="hljs-built_in">any</span>, <span class="hljs-attr">option</span>: <span class="hljs-built_in">any</span>) {
        <span class="hljs-comment">// console.log('-- filterOptionProxy --',inputValue, option)</span>
        <span class="hljs-keyword">const</span> { <span class="hljs-attr">value</span>: vf, <span class="hljs-attr">label</span>: vl } = fieldNames
        <span class="hljs-keyword">const</span> value = option.<span class="hljs-property">origin_data</span>[vf || <span class="hljs-string">'value'</span>]
        <span class="hljs-keyword">const</span> label = option.<span class="hljs-property">origin_data</span>[vl || <span class="hljs-string">'label'</span>]
        <span class="hljs-keyword">return</span> value?.<span class="hljs-property">toString</span>?.() === inputValue?.<span class="hljs-property">toString</span>?.() || <span class="hljs-title class_">String</span>(label).<span class="hljs-title function_">toLowerCase</span>().<span class="hljs-title function_">indexOf</span>(<span class="hljs-title class_">String</span>(inputValue).<span class="hljs-title function_">toLowerCase</span>()) &gt; -<span class="hljs-number">1</span>
    }

    <span class="hljs-keyword">const</span> <span class="hljs-attr">optionRenderProxy</span>: <span class="hljs-title class_">SelectProps</span>[<span class="hljs-string">'optionRender'</span>] = <span class="hljs-function">(<span class="hljs-params">option: <span class="hljs-built_in">any</span>, info</span>) =&gt;</span> {
        <span class="hljs-comment">// console.log('-- optionRenderProxy --',option, info)</span>
        <span class="hljs-keyword">const</span> value = option.<span class="hljs-property">data</span>.<span class="hljs-property">origin_data</span>[fieldNames.<span class="hljs-property">value</span> || <span class="hljs-string">'value'</span>]
        <span class="hljs-keyword">const</span> label = option.<span class="hljs-property">data</span>.<span class="hljs-property">origin_data</span>[fieldNames.<span class="hljs-property">label</span> || <span class="hljs-string">'label'</span>]
        <span class="hljs-keyword">if</span> (!optionRender) {
            <span class="hljs-keyword">return</span> (label)
        }
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">optionRender</span>(option.<span class="hljs-property">data</span>.<span class="hljs-property">origin_data</span>, info)
    }

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Select</span>
            {<span class="hljs-attr">...args</span>}
            <span class="hljs-attr">options</span>=<span class="hljs-string">{getOptions()}</span>
            <span class="hljs-attr">placeholder</span>=<span class="hljs-string">{placeholder}</span>
            <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">fi-select</span> ${<span class="hljs-attr">args.className</span> || ''}`}
            <span class="hljs-attr">value</span>=<span class="hljs-string">{valueProxy}</span>
            <span class="hljs-attr">onChange</span>=<span class="hljs-string">{onChangeProxy}</span>
            <span class="hljs-attr">mode</span>=<span class="hljs-string">{mode}</span>
            <span class="hljs-attr">allowClear</span>=<span class="hljs-string">{allowClear}</span>
            <span class="hljs-attr">showSearch</span>=<span class="hljs-string">{showSearchProxy}</span>
            <span class="hljs-attr">optionRender</span>=<span class="hljs-string">{optionRender</span> ? <span class="hljs-attr">optionRenderProxy</span> <span class="hljs-attr">:</span> <span class="hljs-attr">undefined</span>}
        /&gt;</span></span>
    )
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">memo</span>(<span class="hljs-title class_">FISelect</span>)
</code></pre>
<h3 data-id="heading-10">升级 react 19</h3>
<p>react-activation</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f888a448c4f34a2ebc984a9fe67ab974~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaG9saWRheXBlbmd1aW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974639&amp;x-signature=Wi3hVS%2FevhWk4wLfBd1X4%2FxR%2Fog%3D" alt="image.png" loading="lazy"/></p>
<p>使用 <code>keepalive-for-react</code> 替代 <code>react-activation</code></p>
<ol>
<li><strong>React Router v7 架构变更</strong>
<ul>
<li>React Router v7 使用了新的 Data Router 架构</li>
<li>要求所有 hooks 必须在正确的 router 上下文内使用</li>
<li>对组件嵌套和上下文传递有更严格的要求</li>
</ul>
</li>
<li><strong>react-activation 不兼容</strong>
<ul>
<li><code>react-activation</code> (v0.13.4) 还不支持 React 19,但是理论上是支持的</li>
<li>与 React Router v7 的新架构存在冲突</li>
<li><code>KeepAlive</code> 组件破坏了 Router 的上下文传递</li>
<li>查看了下组件的使用方式，发现原来的使用方法可能不正确，待后续解决</li>
</ul>
</li>
</ol>
<h3 data-id="heading-11">升级 babel-plugin-react-compiler</h3>
<h3 data-id="heading-12">升级其他组件库</h3>
<h3 data-id="heading-13">遗留问题</h3>
<ul>
<li>Input  InputNumber   addonAfter  addonAfter 属性废弃 解决方案</li>
<li>react-activation 无法运行</li>
<li>升级babel-plugin-react-compiler</li>
<li>升级其他组件库</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再到处try-catch了！SpringBoot全局异常处理这样设计]]></title>    <link>https://juejin.cn/post/7585808181239922739</link>    <guid>https://juejin.cn/post/7585808181239922739</guid>    <pubDate>2025-12-22T02:26:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585808181239922739" data-draft-id="7585920796100018203" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再到处try-catch了！SpringBoot全局异常处理这样设计"/> <meta itemprop="keywords" content="后端,Java,Spring Boot"/> <meta itemprop="datePublished" content="2025-12-22T02:26:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小坏说Java"/> <meta itemprop="url" content="https://juejin.cn/user/3898184413750203"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再到处try-catch了！SpringBoot全局异常处理这样设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3898184413750203/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小坏说Java
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:26:01.000Z" title="Mon Dec 22 2025 02:26:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">《别再到处try-catch了！SpringBoot全局异常处理这样设计》</h2>
<blockquote>
<p>每天5分钟，掌握一个SpringBoot核心知识点。大家好，我是SpringBoot指南的创始人小明。昨天我们讲解了自动配置，今天来聊聊异常处理。
<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
</blockquote>
<p><strong>资源获取</strong>：<strong>关注公众号：小坏睡说Java</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<h3 data-id="heading-1">引言</h3>
<p>想象一下这样的场景：你的项目有50个Controller，每个Controller方法里都有类似的try-catch代码，而且每个开发者处理异常的方式都不一样。线上出了问题，日志里要么没有记录，要么记录得乱七八糟...</p>
<p>这就是为什么我们需要统一的全局异常处理。今天，我将带你设计一个优雅的全局异常处理方案，让你的代码<strong>干净、统一、易于维护</strong>。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<p>先看两个对比：</p>
<p><strong>❌ 混乱的异常处理方式</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    <span class="hljs-meta">@PostMapping("/register")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;?&gt; register(<span class="hljs-meta">@RequestBody</span> UserDTO user) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">User</span> <span class="hljs-variable">registered</span> <span class="hljs-operator">=</span> userService.register(user);
            <span class="hljs-keyword">return</span> ResponseEntity.ok(registered);
        } <span class="hljs-keyword">catch</span> (ValidationException e) {
            <span class="hljs-keyword">return</span> ResponseEntity.badRequest().body(<span class="hljs-string">"参数错误："</span> + e.getMessage());
        } <span class="hljs-keyword">catch</span> (DuplicateException e) {
            <span class="hljs-keyword">return</span> ResponseEntity.status(<span class="hljs-number">409</span>).body(<span class="hljs-string">"用户已存在"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"注册失败"</span>, e);
            <span class="hljs-keyword">return</span> ResponseEntity.status(<span class="hljs-number">500</span>).body(<span class="hljs-string">"系统繁忙"</span>);
        }
    }
    
    <span class="hljs-meta">@GetMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;?&gt; getUser(<span class="hljs-meta">@PathVariable</span> Long id) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.findById(id);
            <span class="hljs-keyword">return</span> ResponseEntity.ok(user);
        } <span class="hljs-keyword">catch</span> (NotFoundException e) {
            <span class="hljs-keyword">return</span> ResponseEntity.status(<span class="hljs-number">404</span>).body(<span class="hljs-string">"用户不存在"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"查询用户失败"</span>, e);
            <span class="hljs-keyword">return</span> ResponseEntity.status(<span class="hljs-number">500</span>).body(<span class="hljs-string">"系统错误"</span>);
        }
    }
    <span class="hljs-comment">// ... 其他方法重复类似的模式</span>
}
</code></pre>
<p><strong>✅ 优雅的全局异常处理</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    <span class="hljs-meta">@PostMapping("/register")</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;User&gt; <span class="hljs-title function_">register</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> UserDTO user)</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">registered</span> <span class="hljs-operator">=</span> userService.register(user);
        <span class="hljs-keyword">return</span> ResponseResult.success(registered);
    }
    
    <span class="hljs-meta">@GetMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;User&gt; <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.findById(id);
        <span class="hljs-keyword">return</span> ResponseResult.success(user);
    }
    <span class="hljs-comment">// ... 干净的业务代码，不包含任何异常处理逻辑</span>
}
</code></pre>
<p>所有的异常都在<strong>一个地方统一处理</strong>！下面，让我们一步步实现这个目标。</p>
<h3 data-id="heading-2">一、SpringBoot异常处理核心注解</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<h4 data-id="heading-3">1. @ControllerAdvice：全局异常处理的基石</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Target(ElementType.TYPE)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Documented</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> ControllerAdvice {
    <span class="hljs-comment">// 可以指定要处理的包</span>
    String[] value() <span class="hljs-keyword">default</span> {};
    
    <span class="hljs-comment">// 指定要处理的Controller类型</span>
    Class&lt;?&gt;[] basePackageClasses() <span class="hljs-keyword">default</span> {};
    
    <span class="hljs-comment">// 指定要处理的注解</span>
    Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt;[] annotations() <span class="hljs-keyword">default</span> {};
}
</code></pre>
<p><strong>三种常见用法</strong>：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 方式1：处理所有Controller的异常（最常用）</span>
<span class="hljs-meta">@ControllerAdvice</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandler</span> {
    <span class="hljs-comment">// 处理逻辑...</span>
}

<span class="hljs-comment">// 方式2：只处理指定包下的Controller</span>
<span class="hljs-meta">@ControllerAdvice("com.example.user")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserExceptionHandler</span> {
    <span class="hljs-comment">// 只处理user模块的异常</span>
}

<span class="hljs-comment">// 方式3：只处理带有特定注解的Controller</span>
<span class="hljs-meta">@ControllerAdvice(annotations = RestController.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RestExceptionHandler</span> {
    <span class="hljs-comment">// 只处理@RestController注解的类</span>
}
</code></pre>
<h4 data-id="heading-4">2. @RestControllerAdvice：更便捷的选择</h4>
<p><code>@RestControllerAdvice</code> 是 <code>@ControllerAdvice</code> 和 <code>@ResponseBody</code> 的组合，专门用于REST API开发。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Target(ElementType.TYPE)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Documented</span>
<span class="hljs-meta">@ControllerAdvice</span>
<span class="hljs-meta">@ResponseBody</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> RestControllerAdvice {
    <span class="hljs-comment">// 同@ControllerAdvice</span>
}
</code></pre>
<h4 data-id="heading-5">3. @ExceptionHandler：指定处理什么异常</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Target(ElementType.METHOD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Documented</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> ExceptionHandler {
    <span class="hljs-comment">// 指定要处理的异常类型</span>
    Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Throwable</span>&gt;[] value() <span class="hljs-keyword">default</span> {};
}
</code></pre>
<h3 data-id="heading-6">二、设计优雅的异常体系</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<h4 data-id="heading-7">1. 异常分类策略</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-built_in">Throwable</span>
├── <span class="hljs-built_in">Error</span>（系统错误，如OutOfMemoryError，通常不捕获）
└── <span class="hljs-built_in">Exception</span>（异常）
    ├── <span class="hljs-built_in">RuntimeException</span>（运行时异常）
    │   ├── BusinessException（自定义业务异常）
    │   │   ├── ValidationException（参数校验异常）
    │   │   ├── DuplicateException（数据重复异常）
    │   │   ├── NotFoundException（数据不存在异常）
    │   │   └── PermissionException（权限异常）
    │   └── SystemException（自定义系统异常）
    └── 其他Checked <span class="hljs-built_in">Exception</span>（已检查异常）
</code></pre>
<h4 data-id="heading-8">2. 基础异常类设计</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 基础业务异常</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BusinessException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RuntimeException</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> code;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String message;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BusinessException</span><span class="hljs-params">(<span class="hljs-type">int</span> code, String message)</span> {
        <span class="hljs-built_in">super</span>(message);
        <span class="hljs-built_in">this</span>.code = code;
        <span class="hljs-built_in">this</span>.message = message;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BusinessException</span><span class="hljs-params">(ErrorCode errorCode)</span> {
        <span class="hljs-built_in">super</span>(errorCode.getMessage());
        <span class="hljs-built_in">this</span>.code = errorCode.getCode();
        <span class="hljs-built_in">this</span>.message = errorCode.getMessage();
    }
    
    <span class="hljs-comment">// getters...</span>
}

<span class="hljs-comment">// 错误码枚举</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ErrorCode</span> {
    <span class="hljs-comment">// 系统错误</span>
    SUCCESS(<span class="hljs-number">200</span>, <span class="hljs-string">"成功"</span>),
    SYSTEM_ERROR(<span class="hljs-number">500</span>, <span class="hljs-string">"系统错误"</span>),
    
    <span class="hljs-comment">// 业务错误</span>
    PARAM_VALID_ERROR(<span class="hljs-number">10001</span>, <span class="hljs-string">"参数校验失败"</span>),
    DATA_NOT_FOUND(<span class="hljs-number">10002</span>, <span class="hljs-string">"数据不存在"</span>),
    DATA_DUPLICATE(<span class="hljs-number">10003</span>, <span class="hljs-string">"数据已存在"</span>),
    PERMISSION_DENIED(<span class="hljs-number">10004</span>, <span class="hljs-string">"权限不足"</span>),
    USER_NOT_LOGIN(<span class="hljs-number">10005</span>, <span class="hljs-string">"用户未登录"</span>),
    
    <span class="hljs-comment">// 第三方服务错误</span>
    THIRD_PARTY_ERROR(<span class="hljs-number">20001</span>, <span class="hljs-string">"第三方服务异常"</span>);
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> code;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String message;
    
    ErrorCode(<span class="hljs-type">int</span> code, String message) {
        <span class="hljs-built_in">this</span>.code = code;
        <span class="hljs-built_in">this</span>.message = message;
    }
    
    <span class="hljs-comment">// getters...</span>
}

<span class="hljs-comment">// 具体的业务异常</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ValidationException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BusinessException</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ValidationException</span><span class="hljs-params">(String message)</span> {
        <span class="hljs-built_in">super</span>(ErrorCode.PARAM_VALID_ERROR.getCode(), message);
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NotFoundException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BusinessException</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">NotFoundException</span><span class="hljs-params">(String message)</span> {
        <span class="hljs-built_in">super</span>(ErrorCode.DATA_NOT_FOUND.getCode(), message);
    }
}
</code></pre>
<h3 data-id="heading-9">三、统一响应体设计</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<h4 data-id="heading-10">1. 响应体基础结构</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 统一响应体</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Builder</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResponseResult</span>&lt;T&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> code;        <span class="hljs-comment">// 状态码</span>
    <span class="hljs-keyword">private</span> String message;  <span class="hljs-comment">// 消息</span>
    <span class="hljs-keyword">private</span> T data;          <span class="hljs-comment">// 数据</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> timestamp;  <span class="hljs-comment">// 时间戳</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; ResponseResult&lt;T&gt; <span class="hljs-title function_">success</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> success(<span class="hljs-literal">null</span>);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; ResponseResult&lt;T&gt; <span class="hljs-title function_">success</span><span class="hljs-params">(T data)</span> {
        <span class="hljs-keyword">return</span> ResponseResult.&lt;T&gt;builder()
                .code(ErrorCode.SUCCESS.getCode())
                .message(ErrorCode.SUCCESS.getMessage())
                .data(data)
                .timestamp(System.currentTimeMillis())
                .build();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; ResponseResult&lt;T&gt; <span class="hljs-title function_">fail</span><span class="hljs-params">(<span class="hljs-type">int</span> code, String message)</span> {
        <span class="hljs-keyword">return</span> ResponseResult.&lt;T&gt;builder()
                .code(code)
                .message(message)
                .timestamp(System.currentTimeMillis())
                .build();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; ResponseResult&lt;T&gt; <span class="hljs-title function_">fail</span><span class="hljs-params">(ErrorCode errorCode)</span> {
        <span class="hljs-keyword">return</span> fail(errorCode.getCode(), errorCode.getMessage());
    }
}
</code></pre>
<h3 data-id="heading-11">四、实现全局异常处理器</h3>
<h4 data-id="heading-12">1. 完整异常处理器实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@RestControllerAdvice</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandler</span> {
    
    <span class="hljs-comment">/**
     * 处理业务异常
     */</span>
    <span class="hljs-meta">@ExceptionHandler(BusinessException.class)</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">handleBusinessException</span><span class="hljs-params">(BusinessException e)</span> {
        log.warn(<span class="hljs-string">"业务异常：code={}, message={}"</span>, e.getCode(), e.getMessage());
        <span class="hljs-keyword">return</span> ResponseResult.fail(e.getCode(), e.getMessage());
    }
    
    <span class="hljs-comment">/**
     * 处理参数校验异常（<span class="hljs-doctag">@Validated</span>触发的异常）
     */</span>
    <span class="hljs-meta">@ExceptionHandler(MethodArgumentNotValidException.class)</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">handleMethodArgumentNotValidException</span><span class="hljs-params">(
            MethodArgumentNotValidException e)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> e.getBindingResult().getAllErrors().stream()
                .map(DefaultMessageSourceResolvable::getDefaultMessage)
                .collect(Collectors.joining(<span class="hljs-string">", "</span>));
        log.warn(<span class="hljs-string">"参数校验失败：{}"</span>, message);
        <span class="hljs-keyword">return</span> ResponseResult.fail(ErrorCode.PARAM_VALID_ERROR.getCode(), message);
    }
    
    <span class="hljs-comment">/**
     * 处理请求参数绑定异常（类型转换错误等）
     */</span>
    <span class="hljs-meta">@ExceptionHandler(BindException.class)</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">handleBindException</span><span class="hljs-params">(BindException e)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> e.getBindingResult().getAllErrors().stream()
                .map(ObjectError::getDefaultMessage)
                .collect(Collectors.joining(<span class="hljs-string">", "</span>));
        log.warn(<span class="hljs-string">"参数绑定失败：{}"</span>, message);
        <span class="hljs-keyword">return</span> ResponseResult.fail(ErrorCode.PARAM_VALID_ERROR.getCode(), message);
    }
    
    <span class="hljs-comment">/**
     * 处理参数解析异常（JSON解析错误等）
     */</span>
    <span class="hljs-meta">@ExceptionHandler(HttpMessageNotReadableException.class)</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">handleHttpMessageNotReadableException</span><span class="hljs-params">(
            HttpMessageNotReadableException e)</span> {
        log.warn(<span class="hljs-string">"请求参数解析失败"</span>, e);
        <span class="hljs-keyword">return</span> ResponseResult.fail(ErrorCode.PARAM_VALID_ERROR.getCode(), <span class="hljs-string">"请求参数格式错误"</span>);
    }
    
    <span class="hljs-comment">/**
     * 处理404异常
     */</span>
    <span class="hljs-meta">@ExceptionHandler(NoHandlerFoundException.class)</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">handleNoHandlerFoundException</span><span class="hljs-params">(
            NoHandlerFoundException e)</span> {
        log.warn(<span class="hljs-string">"接口不存在：{} {}"</span>, e.getHttpMethod(), e.getRequestURL());
        <span class="hljs-keyword">return</span> ResponseResult.fail(<span class="hljs-number">404</span>, <span class="hljs-string">"接口不存在"</span>);
    }
    
    <span class="hljs-comment">/**
     * 处理请求方法不支持异常
     */</span>
    <span class="hljs-meta">@ExceptionHandler(HttpRequestMethodNotSupportedException.class)</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">handleHttpRequestMethodNotSupportedException</span><span class="hljs-params">(
            HttpRequestMethodNotSupportedException e)</span> {
        log.warn(<span class="hljs-string">"请求方法不支持：{}，支持的方法：{}"</span>, 
                e.getMethod(), e.getSupportedHttpMethods());
        <span class="hljs-keyword">return</span> ResponseResult.fail(<span class="hljs-number">405</span>, <span class="hljs-string">"请求方法不支持"</span>);
    }
    
    <span class="hljs-comment">/**
     * 处理所有未捕获的异常
     */</span>
    <span class="hljs-meta">@ExceptionHandler(Exception.class)</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">handleException</span><span class="hljs-params">(Exception e)</span> {
        log.error(<span class="hljs-string">"系统异常"</span>, e);
        
        <span class="hljs-comment">// 生产环境返回模糊的错误信息，开发环境返回详细错误</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> isProduction() ? <span class="hljs-string">"系统繁忙，请稍后重试"</span> : e.getMessage();
        <span class="hljs-keyword">return</span> ResponseResult.fail(ErrorCode.SYSTEM_ERROR.getCode(), message);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isProduction</span><span class="hljs-params">()</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">env</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">"spring.profiles.active"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"prod"</span>.equals(env);
    }
}
</code></pre>
<h4 data-id="heading-13">2. 增强版：带异常日志记录的处理器</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@RestControllerAdvice</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EnhancedGlobalExceptionHandler</span> {
    
    <span class="hljs-comment">/**
     * 异常信息上下文，用于记录额外信息
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;Map&lt;String, Object&gt;&gt; exceptionContext = 
            ThreadLocal.withInitial(HashMap::<span class="hljs-keyword">new</span>);
    
    <span class="hljs-comment">/**
     * 添加上下文信息（可在业务代码中调用）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addContext</span><span class="hljs-params">(String key, Object value)</span> {
        exceptionContext.get().put(key, value);
    }
    
    <span class="hljs-comment">/**
     * 清理上下文（在过滤器或拦截器中调用）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearContext</span><span class="hljs-params">()</span> {
        exceptionContext.remove();
    }
    
    <span class="hljs-meta">@ExceptionHandler(BusinessException.class)</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">handleBusinessException</span><span class="hljs-params">(
            BusinessException e, HttpServletRequest request)</span> {
        
        Map&lt;String, Object&gt; context = exceptionContext.get();
        log.warn(<span class="hljs-string">"业务异常 | 路径：{} | 参数：{} | 错误码：{} | 消息：{} | 上下文：{}"</span>,
                request.getRequestURI(),
                getRequestParams(request),
                e.getCode(),
                e.getMessage(),
                context);
        
        clearContext();
        <span class="hljs-keyword">return</span> ResponseResult.fail(e.getCode(), e.getMessage());
    }
    
    <span class="hljs-meta">@ExceptionHandler(Exception.class)</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">handleException</span><span class="hljs-params">(
            Exception e, HttpServletRequest request)</span> {
        
        Map&lt;String, Object&gt; context = exceptionContext.get();
        log.error(<span class="hljs-string">"系统异常 | 路径：{} | 参数：{} | 上下文：{}"</span>,
                request.getRequestURI(),
                getRequestParams(request),
                context,
                e);
        
        clearContext();
        <span class="hljs-keyword">return</span> ResponseResult.fail(ErrorCode.SYSTEM_ERROR.getCode(), 
                isProduction() ? <span class="hljs-string">"系统繁忙"</span> : e.getMessage());
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getRequestParams</span><span class="hljs-params">(HttpServletRequest request)</span> {
        Map&lt;String, String[]&gt; params = request.getParameterMap();
        <span class="hljs-keyword">return</span> params.entrySet().stream()
                .map(entry -&gt; entry.getKey() + <span class="hljs-string">"="</span> + 
                        Arrays.toString(entry.getValue()))
                .collect(Collectors.joining(<span class="hljs-string">", "</span>));
    }
    
    <span class="hljs-comment">// ... 其他异常处理方法</span>
}
</code></pre>
<h3 data-id="heading-14">五、最佳实践与高级用法</h3>
<h4 data-id="heading-15">1. 参数校验的优雅处理</h4>
<p><strong>传统方式</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    <span class="hljs-meta">@PostMapping("/user")</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;User&gt; <span class="hljs-title function_">createUser</span><span class="hljs-params">(<span class="hljs-meta">@Valid</span> <span class="hljs-meta">@RequestBody</span> UserDTO user)</span> {
        <span class="hljs-comment">// 需要手动处理BindingResult</span>
        <span class="hljs-comment">// 或者依赖全局异常处理器</span>
    }
}
</code></pre>
<p><strong>增强方式</strong>：自定义校验注解</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 自定义手机号校验注解</span>
<span class="hljs-meta">@Target({ElementType.FIELD})</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Constraint(validatedBy = PhoneValidator.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Phone {
    String <span class="hljs-title function_">message</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">"手机号格式错误"</span>;
    Class&lt;?&gt;[] groups() <span class="hljs-keyword">default</span> {};
    Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Payload</span>&gt;[] payload() <span class="hljs-keyword">default</span> {};
}

<span class="hljs-comment">// 实现校验逻辑</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PhoneValidator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConstraintValidator</span>&lt;Phone, String&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Pattern</span> <span class="hljs-variable">PHONE_PATTERN</span> <span class="hljs-operator">=</span> 
            Pattern.compile(<span class="hljs-string">"^1[3-9]\\d{9}$"</span>);
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValid</span><span class="hljs-params">(String value, ConstraintValidatorContext context)</span> {
        <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 由@NotNull处理空值</span>
        }
        <span class="hljs-keyword">return</span> PHONE_PATTERN.matcher(value).matches();
    }
}

<span class="hljs-comment">// 使用方式</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDTO</span> {
    <span class="hljs-meta">@NotBlank(message = "用户名不能为空")</span>
    <span class="hljs-meta">@Size(min = 2, max = 20, message = "用户名长度2-20")</span>
    <span class="hljs-keyword">private</span> String username;
    
    <span class="hljs-meta">@Phone</span>  <span class="hljs-comment">// 使用自定义注解</span>
    <span class="hljs-keyword">private</span> String phone;
}
</code></pre>
<h4 data-id="heading-16">2. 多环境差异化处理</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">profiles:</span>
    <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span>

<span class="hljs-attr">app:</span>
  <span class="hljs-attr">exception:</span>
    <span class="hljs-comment"># 开发环境返回详细错误</span>
    <span class="hljs-attr">detail-in-dev:</span> <span class="hljs-literal">true</span>
    <span class="hljs-comment"># 生产环境屏蔽堆栈</span>
    <span class="hljs-attr">hide-stack-in-prod:</span> <span class="hljs-literal">true</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@ConfigurationProperties(prefix = "app.exception")</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExceptionProperties</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">detailInDev</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">hideStackInProd</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
}

<span class="hljs-meta">@RestControllerAdvice</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EnvironmentAwareExceptionHandler</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ExceptionProperties properties;
    
    <span class="hljs-meta">@ExceptionHandler(Exception.class)</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">handleException</span><span class="hljs-params">(Exception e, 
            HttpServletRequest request)</span> {
        
        <span class="hljs-comment">// 记录异常日志（生产环境记录简要，开发环境记录详细）</span>
        <span class="hljs-keyword">if</span> (isProduction()) {
            log.error(<span class="hljs-string">"系统异常 | 路径：{} | 错误：{}"</span>, 
                    request.getRequestURI(), e.getMessage());
        } <span class="hljs-keyword">else</span> {
            log.error(<span class="hljs-string">"系统异常 | 路径：{}"</span>, request.getRequestURI(), e);
        }
        
        <span class="hljs-comment">// 构建响应</span>
        <span class="hljs-type">ErrorResponse</span> <span class="hljs-variable">error</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorResponse</span>();
        error.setCode(ErrorCode.SYSTEM_ERROR.getCode());
        error.setMessage(buildErrorMessage(e));
        
        <span class="hljs-keyword">if</span> (!isProduction() &amp;&amp; properties.isDetailInDev()) {
            error.setDetail(e.getMessage());
            error.setPath(request.getRequestURI());
            error.setException(e.getClass().getName());
        }
        
        <span class="hljs-keyword">if</span> (!isProduction() || !properties.isHideStackInProd()) {
            error.setTrace(getStackTrace(e));
        }
        
        <span class="hljs-keyword">return</span> ResponseResult.fail(error);
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">buildErrorMessage</span><span class="hljs-params">(Exception e)</span> {
        <span class="hljs-keyword">if</span> (isProduction()) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"系统繁忙，请稍后重试"</span>;
        }
        <span class="hljs-keyword">return</span> e.getMessage();
    }
}
</code></pre>
<h4 data-id="heading-17">3. 集成Sentinel进行流控异常处理</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SentinelExceptionHandler</span> {
    
    <span class="hljs-meta">@ExceptionHandler(BlockException.class)</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">handleBlockException</span><span class="hljs-params">(BlockException e)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">"系统繁忙，请稍后重试"</span>;
        
        <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> FlowException) {
            message = <span class="hljs-string">"接口限流，请稍后重试"</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> DegradeException) {
            message = <span class="hljs-string">"接口降级，请稍后重试"</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> ParamFlowException) {
            message = <span class="hljs-string">"热点参数限流"</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> SystemBlockException) {
            message = <span class="hljs-string">"系统保护（CPU/负载）"</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> AuthorityException) {
            message = <span class="hljs-string">"授权规则不通过"</span>;
        }
        
        log.warn(<span class="hljs-string">"Sentinel流控：{}"</span>, message);
        <span class="hljs-keyword">return</span> ResponseResult.fail(<span class="hljs-number">429</span>, message);
    }
}
</code></pre>
<h3 data-id="heading-18">六、完整示例：电商系统异常处理实战</h3>
<h4 data-id="heading-19">1. 业务异常定义</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 库存不足异常</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InsufficientStockException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BusinessException</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Long productId;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer requested;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer available;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InsufficientStockException</span><span class="hljs-params">(Long productId, 
            Integer requested, Integer available)</span> {
        <span class="hljs-built_in">super</span>(ErrorCode.INSUFFICIENT_STOCK);
        <span class="hljs-built_in">this</span>.productId = productId;
        <span class="hljs-built_in">this</span>.requested = requested;
        <span class="hljs-built_in">this</span>.available = available;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getMessage</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"商品[%d]库存不足，需要%d，可用%d"</span>, 
                productId, requested, available);
    }
}

<span class="hljs-comment">// 订单状态异常</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderStateException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BusinessException</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Long orderId;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String currentState;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String requiredState;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OrderStateException</span><span class="hljs-params">(Long orderId, 
            String currentState, String requiredState)</span> {
        <span class="hljs-built_in">super</span>(ErrorCode.ORDER_STATE_ERROR);
        <span class="hljs-built_in">this</span>.orderId = orderId;
        <span class="hljs-built_in">this</span>.currentState = currentState;
        <span class="hljs-built_in">this</span>.requiredState = requiredState;
    }
}
</code></pre>
<h4 data-id="heading-20">2. 业务使用示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OrderService</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrder</span><span class="hljs-params">(OrderCreateDTO dto)</span> {
        <span class="hljs-comment">// 参数校验（会自动抛出MethodArgumentNotValidException）</span>
        validateOrder(dto);
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 检查库存</span>
            checkStock(dto);
            
            <span class="hljs-comment">// 创建订单</span>
            <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> buildOrder(dto);
            orderRepository.save(order);
            
            <span class="hljs-comment">// 扣减库存</span>
            reduceStock(dto);
            
            <span class="hljs-comment">// 发送创建订单事件</span>
            eventPublisher.publishEvent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderCreatedEvent</span>(order));
            
            <span class="hljs-keyword">return</span> order;
            
        } <span class="hljs-keyword">catch</span> (InsufficientStockException e) {
            <span class="hljs-comment">// 添加上下文信息，便于日志记录</span>
            EnhancedGlobalExceptionHandler.addContext(<span class="hljs-string">"orderDTO"</span>, dto);
            <span class="hljs-keyword">throw</span> e;
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkStock</span><span class="hljs-params">(OrderCreateDTO dto)</span> {
        dto.getItems().forEach(item -&gt; {
            <span class="hljs-type">Integer</span> <span class="hljs-variable">available</span> <span class="hljs-operator">=</span> stockService.getAvailableStock(item.getProductId());
            <span class="hljs-keyword">if</span> (available &lt; item.getQuantity()) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InsufficientStockException</span>(
                        item.getProductId(), 
                        item.getQuantity(), 
                        available);
            }
        });
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validateOrder</span><span class="hljs-params">(OrderCreateDTO dto)</span> {
        <span class="hljs-keyword">if</span> (dto.getItems() == <span class="hljs-literal">null</span> || dto.getItems().isEmpty()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValidationException</span>(<span class="hljs-string">"订单商品不能为空"</span>);
        }
        
        <span class="hljs-keyword">if</span> (dto.getTotalAmount() == <span class="hljs-literal">null</span> || dto.getTotalAmount().compareTo(BigDecimal.ZERO) &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValidationException</span>(<span class="hljs-string">"订单金额必须大于0"</span>);
        }
    }
}
</code></pre>
<h4 data-id="heading-21">3. Controller层示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/orders")</span>
<span class="hljs-meta">@Validated</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderService orderService;
    
    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Order&gt; <span class="hljs-title function_">createOrder</span><span class="hljs-params">(
            <span class="hljs-meta">@Valid</span> <span class="hljs-meta">@RequestBody</span> OrderCreateDTO dto)</span> {
        
        log.info(<span class="hljs-string">"创建订单，用户：{}，商品数量：{}"</span>, 
                dto.getUserId(), dto.getItems().size());
        
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderService.createOrder(dto);
        <span class="hljs-keyword">return</span> ResponseResult.success(order);
    }
    
    <span class="hljs-meta">@PostMapping("/{orderId}/cancel")</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">cancelOrder</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long orderId)</span> {
        orderService.cancelOrder(orderId);
        <span class="hljs-keyword">return</span> ResponseResult.success();
    }
    
    <span class="hljs-meta">@GetMapping("/{orderId}")</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Order&gt; <span class="hljs-title function_">getOrder</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long orderId)</span> {
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderService.getOrder(orderId);
        <span class="hljs-keyword">return</span> ResponseResult.success(order);
    }
}
</code></pre>
<h3 data-id="heading-22">七、测试你的异常处理器</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<h4 data-id="heading-23">1. 单元测试</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SpringBootTest</span>
<span class="hljs-meta">@AutoConfigureMockMvc</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandlerTest</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> MockMvc mockMvc;
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testBusinessException</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        mockMvc.perform(get(<span class="hljs-string">"/api/test/business-error"</span>))
                .andExpect(status().isOk())
                .andExpect(jsonPath(<span class="hljs-string">"$.code"</span>).value(<span class="hljs-number">10001</span>))
                .andExpect(jsonPath(<span class="hljs-string">"$.message"</span>).value(<span class="hljs-string">"业务异常测试"</span>));
    }
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testValidationException</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        mockMvc.perform(post(<span class="hljs-string">"/api/users"</span>)
                .contentType(MediaType.APPLICATION_JSON)
                .content(<span class="hljs-string">"{\"username\":\"\"}"</span>))
                .andExpect(status().isOk())
                .andExpect(jsonPath(<span class="hljs-string">"$.code"</span>).value(<span class="hljs-number">10001</span>))
                .andExpect(jsonPath(<span class="hljs-string">"$.message"</span>).contains(<span class="hljs-string">"不能为空"</span>));
    }
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSystemException</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        mockMvc.perform(get(<span class="hljs-string">"/api/test/system-error"</span>))
                .andExpect(status().isOk())
                .andExpect(jsonPath(<span class="hljs-string">"$.code"</span>).value(<span class="hljs-number">500</span>));
    }
}
</code></pre>
<h4 data-id="heading-24">2. 集成测试异常处理器</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@WebMvcTest(OrderController.class)</span>
<span class="hljs-meta">@Import(GlobalExceptionHandler.class)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderControllerExceptionTest</span> {
    
    <span class="hljs-meta">@MockBean</span>
    <span class="hljs-keyword">private</span> OrderService orderService;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> MockMvc mockMvc;
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder_InsufficientStock</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 模拟库存不足异常</span>
        when(orderService.createOrder(any()))
                .thenThrow(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InsufficientStockException</span>(<span class="hljs-number">1L</span>, <span class="hljs-number">10</span>, <span class="hljs-number">5</span>));
        
        mockMvc.perform(post(<span class="hljs-string">"/orders"</span>)
                .contentType(MediaType.APPLICATION_JSON)
                .content(<span class="hljs-string">"{...}"</span>))
                .andExpect(status().isOk())
                .andExpect(jsonPath(<span class="hljs-string">"$.code"</span>).value(ErrorCode.INSUFFICIENT_STOCK.getCode()))
                .andExpect(jsonPath(<span class="hljs-string">"$.message"</span>).value(<span class="hljs-string">"商品[1]库存不足，需要10，可用5"</span>));
    }
}
</code></pre>
<h3 data-id="heading-25">八、个人建议性能与注意事项</h3>
<p><strong>资源获取</strong>：<strong>关注公众号：小坏睡说Java</strong></p>
<h4 data-id="heading-26">1. 性能考虑</h4>
<ul>
<li>异常创建开销：异常对象的创建比普通对象开销大</li>
<li>栈追踪开销：<code>fillInStackTrace()</code>方法比较耗时</li>
<li>建议：对于频繁发生的业务异常，考虑使用错误码而非异常</li>
</ul>
<h3 data-id="heading-27">总结</h3>
<p>今天我们一起构建了一个完整的全局异常处理体系：</p>
<ol>
<li><strong>核心机制</strong>：<code>@RestControllerAdvice</code> + <code>@ExceptionHandler</code></li>
<li><strong>异常体系</strong>：业务异常与系统异常分离</li>
<li><strong>统一响应</strong>：标准化的响应格式</li>
<li><strong>日志记录</strong>：完整的异常上下文信息</li>
<li><strong>多环境适配</strong>：开发/生产环境差异化处理</li>
<li><strong>最佳实践</strong>：参数校验、Sentinel集成等</li>
</ol>
<p>通过全局异常处理，我们实现了：</p>
<ul>
<li>✅ <strong>代码整洁</strong>：Controller层只有业务逻辑</li>
<li>✅ <strong>统一格式</strong>：所有异常响应格式一致</li>
<li>✅ <strong>易于维护</strong>：异常处理逻辑集中管理</li>
<li>✅ <strong>便于监控</strong>：异常日志完整记录</li>
</ul>
<h3 data-id="heading-28">今日思考题</h3>
<p>在你的项目中，有没有遇到过以下情况：</p>
<ol>
<li>某个第三方接口频繁超时，需要特殊处理</li>
<li>不同微服务之间的异常需要统一处理</li>
<li>需要根据用户类型返回不同的错误信息</li>
</ol>
<p>你是如何解决这些问题的？欢迎在评论区分享你的经验！</p>
<hr/>
<p><strong>下期预告</strong>：明天我们将探讨《SpringBoot配置文件：一个注解搞定多环境配置！》，学习如何优雅管理不同环境的配置。</p>
<p><strong>互动时间</strong>：你在异常处理中遇到过哪些"坑"？或者有哪些更好的实践建议？</p>
<p><strong>资源获取</strong>：<strong>关注公众号：小坏睡说Java</strong>     回复"异常处理源码"，获取本文所有示例代码及完整项目。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[自定义简易日历]]></title>    <link>https://juejin.cn/post/7585897699603071002</link>    <guid>https://juejin.cn/post/7585897699603071002</guid>    <pubDate>2025-12-22T02:25:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585897699603071002" data-draft-id="7585888537641959439" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="自定义简易日历"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-22T02:25:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风往哪边走"/> <meta itemprop="url" content="https://juejin.cn/user/3433151760706957"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            自定义简易日历
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3433151760706957/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风往哪边走
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:25:59.000Z" title="Mon Dec 22 2025 02:25:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial;color:#00325e}.markdown-body ::selection{background-color:#00325e;color:#fff}.markdown-body blockquote{padding:10px 20px;background-color:#fffaf0;box-shadow:0 3px 10px 0 rgba(255,172,194,.24);border:1px solid #f3ca8e;transition:all .2s;margin:1em 0;border-radius:5px}.markdown-body blockquote p{font-size:14px;line-height:25px;color:#795548}.markdown-body blockquote p:last-child{margin:0}.markdown-body blockquote:hover{border-color:#ff9800;background-color:#fff8e0;box-shadow:0 6px 10px -5px rgba(225,173,98,.3803921569)}.markdown-body blockquote code{color:#ff502c}.markdown-body pre{border:1px solid #8cc0f3;box-shadow:0 3px 10px 0 rgba(255,198,198,.28);border-radius:5px;transition:all .2s;overflow-x:auto;white-space:pre-wrap}.markdown-body pre:hover{border-color:#6d9dce}.markdown-body pre&gt;code{padding:10px 20px;color:#00325e;background:#f0f8ff;font-size:12px;line-height:1.6;display:block}.markdown-body code{background:#f6fbff;color:#0b5393;padding:2px 4px;border-radius:4px;font-size:12px}.markdown-body p{font-size:14px;line-height:28px;text-align:justify;margin-bottom:17px;color:#595959}.markdown-body a{color:#00325e;text-decoration:none}.markdown-body a:after{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAAXNSR0IArs4c6QAAAQdJREFUKFNt0DtLA0EUBeBzZle0Eks7rcUfEfBRCha7NorYa6NmVJzgyi4smUgKtdZGCJktLMVH4Y8QeztLWyE7VyLEuNFbXj4Oh0P8c8mZm+uJrEN4BJFTeP/MUVe3bnocfALwkOlo1zS7iZAzf6Cx7oXgbaqjxiDEWCcVaGyxQ8pSWo9XhqhoQ/xUFbaKjhe5V+CmR7mnSplEEF6GSmJ+F/d0KHvbCIIJCLc85U6BC5mONgbJNM3uFag++sX7z8O8MzsWBucifMx0dDGE1kmm458KDVukAlnNdDz/exEeW3dNkbfsYC0xtmgDWP6ELLZ0/F6BJu/UoFQN5AkoeUjeJPvx6+i+X5Sjah4tA6gYAAAAAElFTkSuQmCC);margin-left:2px}.markdown-body a:hover{box-shadow:0 1px}.markdown-body table{max-width:100%;border-collapse:collapse;border-spacing:0;box-shadow:0 3px 10px 0 rgba(255,238,172,.24);transition:all .2s}.markdown-body table:hover{box-shadow:0 3px 10px 0 rgba(185,169,103,.24)}.markdown-body table tr th{border:1px solid #8cc0f3;background-color:#f0f8ff;padding:12px 15px}.markdown-body table tr td{border:1px solid rgba(243,202,142,.4);padding:12px 15px}.markdown-body table tbody tr{transition:all .2s}.markdown-body table tbody tr:hover td{border-color:#f3ca8e;background-color:#fff8e0;z-index:1}.markdown-body img{max-width:100%}.markdown-body h1{font-size:20px;margin-top:30px;margin-bottom:10px;padding-left:30px;position:relative}.markdown-body h1&gt;code{font-size:20px}.markdown-body h1:before{content:"🍺";display:block;font-size:18px;width:18px;height:18px;left:0;position:absolute}.markdown-body h2{font-size:18px;margin-top:30px;margin-bottom:10px;padding-left:28px;position:relative}.markdown-body h2&gt;code{font-size:18px}.markdown-body h2:before{content:"🍻";display:block;font-size:16px;width:16px;height:16px;left:0;position:absolute}.markdown-body h3{font-size:16px;margin-top:30px;margin-bottom:10px;padding-left:26px;position:relative}.markdown-body h3&gt;code{font-size:16px}.markdown-body h3:before{content:"🥂";display:block;font-size:14px;width:14px;height:14px;left:0;position:absolute}.markdown-body h4{font-size:14px;margin-top:30px;margin-bottom:10px;padding-left:24px;position:relative}.markdown-body h4&gt;code{font-size:14px}.markdown-body h4:before{content:"🥃";display:block;font-size:12px;width:12px;height:12px;left:0;position:absolute}.markdown-body h5{font-size:12px;margin-top:30px;margin-bottom:10px}.markdown-body h5&gt;code{font-size:12px}.markdown-body h6{font-size:10px;margin-top:30px;margin-bottom:10px}.markdown-body h6&gt;code{font-size:10px}.markdown-body h1,.markdown-body h2{color:#ff502c}.markdown-body hr{height:4px;border:none;margin-top:32px;margin-bottom:32px;background-size:4px 1px;background-image:linear-gradient(270deg,#6d9dce,#8cc0f3 25%,transparent 50%)}.markdown-body hr:nth-child(2n){background-image:linear-gradient(270deg,#ff9800,#fff8e0 25%,transparent 50%)}.markdown-body ul{padding-inline-start:20px}.markdown-body ul li{list-style-type:"🔸"}.markdown-body ul li li{list-style-type:"◻️"}.markdown-body ul li li li{list-style-type:"▫️"}.markdown-body ol{padding-inline-start:20px}.markdown-body ol ::marker{color:#ff9800}.markdown-body ol,.markdown-body ul{line-height:2em}.markdown-body li{padding-inline-start:1ch}.markdown-body li.task-list-item{list-style:none;padding-inline-start:0}.markdown-body li input{padding-right:2px}.markdown-body li input[type=checkbox i]{appearance:none}.markdown-body li input:before{content:"🟩";display:block;width:13px;height:13px}.markdown-body li input:checked:before{content:"✅"}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atelier-sulphurpool-light">.hljs-comment,.hljs-quote{color:#6b7394}.hljs-attribute,.hljs-link,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#c94922}.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#c76b29}.hljs-bullet,.hljs-string,.hljs-symbol{color:#ac9739}.hljs-section,.hljs-title{color:#3d8fd1}.hljs-keyword,.hljs-selector-tag{color:#6679cc}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#f5f7ff;color:#5e6687}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">自定义简易日历</h2>
<ul>
<li>
<blockquote>
<p>当前月份日期可点击选中</p>
</blockquote>
</li>
<li>
<blockquote>
<p>今天日期有红色圆圈标记</p>
</blockquote>
</li>
<li>
<blockquote>
<p>跨月日期为灰色，不可点击</p>
</blockquote>
</li>
<li>
<blockquote>
<p>可切换上个月/下个月</p>
</blockquote>
</li>
<li>
<blockquote>
<p>支持回到今天</p>
</blockquote>
</li>
<li>
<blockquote>
<p>可以设置红点绿点日期。比如打卡日期</p>
</blockquote>
</li>
</ul>
<h2 data-id="heading-1">自定义日历<code>SimpleCalendarView.kt</code></h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> cn.nio.calendar


<span class="hljs-keyword">import</span> android.content.Context
<span class="hljs-keyword">import</span> android.graphics.Canvas
<span class="hljs-keyword">import</span> android.graphics.Color
<span class="hljs-keyword">import</span> android.graphics.Paint
<span class="hljs-keyword">import</span> android.graphics.RectF
<span class="hljs-keyword">import</span> android.graphics.Typeface
<span class="hljs-keyword">import</span> android.util.AttributeSet
<span class="hljs-keyword">import</span> android.view.MotionEvent
<span class="hljs-keyword">import</span> android.view.View
<span class="hljs-keyword">import</span> java.util.Calendar
<span class="hljs-keyword">import</span> kotlin.math.min

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleCalendarView</span> <span class="hljs-meta">@JvmOverloads</span> <span class="hljs-keyword">constructor</span>(
    context: Context,
    attrs: AttributeSet? = <span class="hljs-literal">null</span>,
    defStyleAttr: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>,
) : View(context, attrs, defStyleAttr) {

    <span class="hljs-comment">// 颜色</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> todayColor = Color.RED
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> selectedColor = Color.parseColor(<span class="hljs-string">"#00B594"</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> normalTextColor = Color.BLACK
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> selectedTextColor = Color.WHITE
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> otherMonthTextColor = Color.parseColor(<span class="hljs-string">"#CCCCCC"</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> gridLineColor = Color.parseColor(<span class="hljs-string">"#E0E0E0"</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> weekBackgroundColor = Color.parseColor(<span class="hljs-string">"#F5F5F5"</span>)

    <span class="hljs-comment">// 新增：红点和绿点颜色</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> redDotColor = Color.parseColor(<span class="hljs-string">"#FF4444"</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> greenDotColor = Color.parseColor(<span class="hljs-string">"#00B594"</span>)

    <span class="hljs-comment">// 数据</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> calendar = Calendar.getInstance()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> currentYear: <span class="hljs-built_in">Int</span> = calendar.<span class="hljs-keyword">get</span>(Calendar.YEAR)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> currentMonth: <span class="hljs-built_in">Int</span> = calendar.<span class="hljs-keyword">get</span>(Calendar.MONTH)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> selectedDate: Calendar? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> today: Calendar = Calendar.getInstance()

    <span class="hljs-comment">// 新增：存储需要显示点的日期</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> redDotDates = mutableSetOf&lt;String&gt;() <span class="hljs-comment">// 格式: "2024-01-15"</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> greenDotDates = mutableSetOf&lt;String&gt;()

    <span class="hljs-comment">// 画笔</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> paint = Paint(Paint.ANTI_ALIAS_FLAG)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> weekPaint = Paint(Paint.ANTI_ALIAS_FLAG)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> selectedPaint = Paint(Paint.ANTI_ALIAS_FLAG)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> todayPaint = Paint(Paint.ANTI_ALIAS_FLAG)

    <span class="hljs-comment">// 新增：点画笔</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> redDotPaint = Paint(Paint.ANTI_ALIAS_FLAG)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> greenDotPaint = Paint(Paint.ANTI_ALIAS_FLAG)

    <span class="hljs-comment">// 尺寸</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> cellWidth: <span class="hljs-built_in">Float</span> = <span class="hljs-number">0f</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> cellHeight: <span class="hljs-built_in">Float</span> = <span class="hljs-number">0f</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> weekHeight: <span class="hljs-built_in">Float</span> = <span class="hljs-number">0f</span>

    <span class="hljs-comment">// 新增：点相关尺寸</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> dotRadius: <span class="hljs-built_in">Float</span> = <span class="hljs-number">0f</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> dotSpacing: <span class="hljs-built_in">Float</span> = <span class="hljs-number">0f</span>

    <span class="hljs-comment">// 监听器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> onDateClickListener: ((year: <span class="hljs-built_in">Int</span>, month: <span class="hljs-built_in">Int</span>, day: <span class="hljs-built_in">Int</span>) -&gt; <span class="hljs-built_in">Unit</span>)? = <span class="hljs-literal">null</span>

    <span class="hljs-comment">// 星期标题</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> weekDays = arrayOf(<span class="hljs-string">"日"</span>, <span class="hljs-string">"一"</span>, <span class="hljs-string">"二"</span>, <span class="hljs-string">"三"</span>, <span class="hljs-string">"四"</span>, <span class="hljs-string">"五"</span>, <span class="hljs-string">"六"</span>)

    <span class="hljs-keyword">init</span> {
        <span class="hljs-comment">// 初始化画笔</span>
        paint.color = normalTextColor
        paint.textSize = spToPx(<span class="hljs-number">16f</span>)
        paint.textAlign = Paint.Align.CENTER

        weekPaint.color = normalTextColor
        weekPaint.textSize = spToPx(<span class="hljs-number">18f</span>)
        weekPaint.textAlign = Paint.Align.CENTER
        weekPaint.typeface = Typeface.DEFAULT_BOLD

        selectedPaint.color = selectedColor
        selectedPaint.style = Paint.Style.FILL

        todayPaint.color = todayColor
        todayPaint.style = Paint.Style.STROKE
        todayPaint.strokeWidth = <span class="hljs-number">3f</span>

        <span class="hljs-comment">// 初始化点画笔</span>
        redDotPaint.color = redDotColor
        redDotPaint.style = Paint.Style.FILL

        greenDotPaint.color = greenDotColor
        greenDotPaint.style = Paint.Style.FILL

        <span class="hljs-comment">// 设置初始选中日期为今天</span>
        selectedDate = today.clone() <span class="hljs-keyword">as</span> Calendar
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onMeasure</span><span class="hljs-params">(widthMeasureSpec: <span class="hljs-type">Int</span>, heightMeasureSpec: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">val</span> width = MeasureSpec.getSize(widthMeasureSpec)
<span class="hljs-comment">//        val height = (width * 6 / 7f).toInt()</span>
        setMeasuredDimension(width, width)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSizeChanged</span><span class="hljs-params">(w: <span class="hljs-type">Int</span>, h: <span class="hljs-type">Int</span>, oldw: <span class="hljs-type">Int</span>, oldh: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">super</span>.onSizeChanged(w, h, oldw, oldh)

        cellWidth = w / <span class="hljs-number">7f</span>
        weekHeight = h * <span class="hljs-number">0.15f</span>
        cellHeight = (h - weekHeight) / <span class="hljs-number">6f</span>

        <span class="hljs-comment">// 计算点的尺寸</span>
        dotRadius = dpToPx(<span class="hljs-number">2f</span>)
        dotSpacing = dpToPx(<span class="hljs-number">1f</span>)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDraw</span><span class="hljs-params">(canvas: <span class="hljs-type">Canvas</span>)</span></span> {
        <span class="hljs-keyword">super</span>.onDraw(canvas)

        <span class="hljs-comment">// 绘制白色背景</span>
        canvas.drawColor(Color.WHITE)

        <span class="hljs-comment">// 绘制星期栏</span>
        drawWeekBackground(canvas)
        drawWeekDays(canvas)

        <span class="hljs-comment">// 绘制日期</span>
        drawDates(canvas)
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">drawWeekBackground</span><span class="hljs-params">(canvas: <span class="hljs-type">Canvas</span>)</span></span> {
        <span class="hljs-keyword">val</span> rect = RectF(<span class="hljs-number">0f</span>, <span class="hljs-number">0f</span>, width.toFloat(), weekHeight)
        paint.color = weekBackgroundColor
        paint.style = Paint.Style.FILL
        canvas.drawRect(rect, paint)
        paint.style = Paint.Style.FILL
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">drawWeekDays</span><span class="hljs-params">(canvas: <span class="hljs-type">Canvas</span>)</span></span> {
        <span class="hljs-keyword">val</span> baseline = weekHeight * <span class="hljs-number">0.7f</span>

        <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> weekDays.indices) {
            <span class="hljs-keyword">val</span> x = i * cellWidth + cellWidth / <span class="hljs-number">2</span>
            canvas.drawText(weekDays[i], x, baseline, weekPaint)
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">drawDates</span><span class="hljs-params">(canvas: <span class="hljs-type">Canvas</span>)</span></span> {
        <span class="hljs-comment">// 设置当前月份第一天</span>
        calendar.<span class="hljs-keyword">set</span>(currentYear, currentMonth, <span class="hljs-number">1</span>)
        <span class="hljs-keyword">val</span> firstDayOfWeek = calendar.<span class="hljs-keyword">get</span>(Calendar.DAY_OF_WEEK) - <span class="hljs-number">1</span>

        <span class="hljs-comment">// 获取当月实际天数</span>
        <span class="hljs-keyword">val</span> daysInMonth = getMonthDays(currentYear, currentMonth)

        <span class="hljs-comment">// 绘制当前月份日期</span>
        <span class="hljs-keyword">for</span> (day <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span>.daysInMonth) {
            drawDateCell(canvas, day, firstDayOfWeek, daysInMonth, <span class="hljs-literal">true</span>)
        }

        <span class="hljs-comment">// 绘制跨月日期（灰色，不可点击）</span>
        drawOtherMonthDays(canvas, firstDayOfWeek, daysInMonth)

        <span class="hljs-comment">// 绘制网格线</span>
        drawGridLines(canvas)
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">drawDateCell</span><span class="hljs-params">(
        canvas: <span class="hljs-type">Canvas</span>,
        day: <span class="hljs-type">Int</span>,
        firstDayOfWeek: <span class="hljs-type">Int</span>,
        daysInMonth: <span class="hljs-type">Int</span>,
        isCurrentMonth: <span class="hljs-type">Boolean</span>,
    )</span></span> {
        <span class="hljs-keyword">val</span> position = firstDayOfWeek + (day - <span class="hljs-number">1</span>)
        <span class="hljs-keyword">val</span> row = position / <span class="hljs-number">7</span>
        <span class="hljs-keyword">val</span> col = position % <span class="hljs-number">7</span>

        <span class="hljs-keyword">val</span> x = col * cellWidth + cellWidth / <span class="hljs-number">2</span>
        <span class="hljs-keyword">val</span> y = weekHeight + row * cellHeight + cellHeight * <span class="hljs-number">0.6f</span>

        <span class="hljs-comment">// 检查是否为选中日期</span>
        <span class="hljs-keyword">val</span> isSelected = selectedDate?.let {
            it.<span class="hljs-keyword">get</span>(Calendar.YEAR) == currentYear &amp;&amp;
                    it.<span class="hljs-keyword">get</span>(Calendar.MONTH) == currentMonth &amp;&amp;
                    it.<span class="hljs-keyword">get</span>(Calendar.DAY_OF_MONTH) == day
        } ?: <span class="hljs-literal">false</span>

        <span class="hljs-comment">// 检查是否为今天</span>
        <span class="hljs-keyword">val</span> isToday = today.<span class="hljs-keyword">get</span>(Calendar.YEAR) == currentYear &amp;&amp;
                today.<span class="hljs-keyword">get</span>(Calendar.MONTH) == currentMonth &amp;&amp;
                today.<span class="hljs-keyword">get</span>(Calendar.DAY_OF_MONTH) == day

        <span class="hljs-comment">// 绘制选中背景</span>
        <span class="hljs-keyword">if</span> (isSelected &amp;&amp; isCurrentMonth) {
            <span class="hljs-keyword">val</span> radius = min(cellWidth, cellHeight) * <span class="hljs-number">0.3f</span>
            canvas.drawCircle(x, y - (paint.textSize / <span class="hljs-number">3</span>), radius, selectedPaint)
        }

        <span class="hljs-comment">// 绘制今天圆圈</span>
        <span class="hljs-keyword">if</span> (isToday &amp;&amp; isCurrentMonth) {
            <span class="hljs-keyword">val</span> radius = min(cellWidth, cellHeight) * <span class="hljs-number">0.35f</span>
            canvas.drawCircle(x, y - (paint.textSize / <span class="hljs-number">3</span>), radius, todayPaint)
        }

        <span class="hljs-comment">// 绘制日期文字</span>
        paint.color = <span class="hljs-keyword">when</span> {
            isSelected -&gt; selectedTextColor
            <span class="hljs-keyword">else</span> -&gt; normalTextColor
        }

        paint.textSize = spToPx(<span class="hljs-number">16f</span>)
        canvas.drawText(day.toString(), x, y, paint)

        <span class="hljs-comment">// 新增：绘制红点和绿点（仅在当前月份日期显示）</span>
        <span class="hljs-keyword">if</span> (isCurrentMonth) {
            <span class="hljs-keyword">val</span> dateKey = formatDateKey(currentYear, currentMonth, day)

            <span class="hljs-keyword">val</span> redDotExists = redDotDates.contains(dateKey)
            <span class="hljs-keyword">val</span> greenDotExists = greenDotDates.contains(dateKey)

            <span class="hljs-comment">// 计算点的位置</span>
            <span class="hljs-keyword">val</span> dotY = y + paint.textSize / <span class="hljs-number">2</span> + dotSpacing

            <span class="hljs-comment">// 如果只有一种点，居中显示</span>
            <span class="hljs-keyword">when</span> {
                redDotExists &amp;&amp; greenDotExists -&gt; {
                    <span class="hljs-comment">// 两种点都存在，在左右两侧显示</span>
                    <span class="hljs-keyword">val</span> leftX = x - dotRadius * <span class="hljs-number">1.5f</span>
                    <span class="hljs-keyword">val</span> rightX = x + dotRadius * <span class="hljs-number">1.5f</span>
                    canvas.drawCircle(leftX, dotY, dotRadius, redDotPaint)
                    canvas.drawCircle(rightX, dotY, dotRadius, greenDotPaint)
                }

                redDotExists -&gt; {
                    <span class="hljs-comment">// 只有红点</span>
                    canvas.drawCircle(x, dotY, dotRadius, redDotPaint)
                }

                greenDotExists -&gt; {
                    <span class="hljs-comment">// 只有绿点</span>
                    canvas.drawCircle(x, dotY, dotRadius, greenDotPaint)
                }
            }
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">drawOtherMonthDays</span><span class="hljs-params">(canvas: <span class="hljs-type">Canvas</span>, firstDayOfWeek: <span class="hljs-type">Int</span>, daysInMonth: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-comment">// 绘制上个月在当月日历中显示的日期</span>
        <span class="hljs-keyword">if</span> (firstDayOfWeek &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">val</span> prevMonthCalendar = Calendar.getInstance().apply {
                <span class="hljs-keyword">set</span>(currentYear, currentMonth, <span class="hljs-number">1</span>)
                add(Calendar.MONTH, -<span class="hljs-number">1</span>)
            }
            <span class="hljs-keyword">val</span> daysInPrevMonth = getMonthDays(
                prevMonthCalendar.<span class="hljs-keyword">get</span>(Calendar.YEAR),
                prevMonthCalendar.<span class="hljs-keyword">get</span>(Calendar.MONTH)
            )

            <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span> until firstDayOfWeek) {
                <span class="hljs-keyword">val</span> day = daysInPrevMonth - firstDayOfWeek + i + <span class="hljs-number">1</span>
                <span class="hljs-keyword">val</span> row = <span class="hljs-number">0</span>
                <span class="hljs-keyword">val</span> col = i
                drawOtherMonthDate(canvas, row, col, day)
            }
        }

        <span class="hljs-comment">// 绘制下个月在当月日历中显示的日期</span>
        <span class="hljs-keyword">val</span> totalRows = <span class="hljs-number">6</span>
        <span class="hljs-keyword">val</span> totalCells = totalRows * <span class="hljs-number">7</span>
        <span class="hljs-keyword">val</span> cellsUsedByCurrentMonth = firstDayOfWeek + daysInMonth
        <span class="hljs-keyword">val</span> remainingCells = totalCells - cellsUsedByCurrentMonth

        <span class="hljs-keyword">if</span> (remainingCells &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">var</span> nextMonthDay = <span class="hljs-number">1</span>
            <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span> until remainingCells) {
                <span class="hljs-keyword">val</span> position = cellsUsedByCurrentMonth + i
                <span class="hljs-keyword">val</span> row = position / <span class="hljs-number">7</span>
                <span class="hljs-keyword">val</span> col = position % <span class="hljs-number">7</span>
                drawOtherMonthDate(canvas, row, col, nextMonthDay)
                nextMonthDay++
            }
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">drawOtherMonthDate</span><span class="hljs-params">(canvas: <span class="hljs-type">Canvas</span>, row: <span class="hljs-type">Int</span>, col: <span class="hljs-type">Int</span>, day: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">val</span> x = col * cellWidth + cellWidth / <span class="hljs-number">2</span>
        <span class="hljs-keyword">val</span> y = weekHeight + row * cellHeight + cellHeight * <span class="hljs-number">0.6f</span>

        <span class="hljs-comment">// 保存当前画笔状态</span>
        <span class="hljs-keyword">val</span> originalColor = paint.color
        <span class="hljs-keyword">val</span> originalTextSize = paint.textSize

        <span class="hljs-comment">// 绘制跨月日期文字（灰色）</span>
        paint.color = otherMonthTextColor
        paint.textSize = spToPx(<span class="hljs-number">16f</span>)
        canvas.drawText(day.toString(), x, y, paint)

        <span class="hljs-comment">// 恢复画笔状态</span>
        paint.color = originalColor
        paint.textSize = originalTextSize
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">drawGridLines</span><span class="hljs-params">(canvas: <span class="hljs-type">Canvas</span>)</span></span> {
        paint.color = gridLineColor
        paint.strokeWidth = <span class="hljs-number">1f</span>

        <span class="hljs-comment">// 绘制星期栏底部分隔线</span>
        canvas.drawLine(<span class="hljs-number">0f</span>, weekHeight, width.toFloat(), weekHeight, paint)

        <span class="hljs-comment">// 绘制垂直线</span>
        <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">1</span> until <span class="hljs-number">7</span>) {
            <span class="hljs-keyword">val</span> x = i * cellWidth
            canvas.drawLine(x, weekHeight, x, height.toFloat(), paint)
        }

        <span class="hljs-comment">// 绘制水平线</span>
        <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.6</span>) {
            <span class="hljs-keyword">val</span> y = weekHeight + i * cellHeight
            canvas.drawLine(<span class="hljs-number">0f</span>, y, width.toFloat(), y, paint)
        }
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onTouchEvent</span><span class="hljs-params">(event: <span class="hljs-type">MotionEvent</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">when</span> (event.action) {
            MotionEvent.ACTION_DOWN -&gt; <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
            MotionEvent.ACTION_UP -&gt; {
                handleClick(event.x, event.y)
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.onTouchEvent(event)
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handleClick</span><span class="hljs-params">(x: <span class="hljs-type">Float</span>, y: <span class="hljs-type">Float</span>)</span></span> {
        <span class="hljs-keyword">if</span> (y &lt; weekHeight) <span class="hljs-keyword">return</span>

        <span class="hljs-comment">// 计算点击的行列</span>
        <span class="hljs-keyword">val</span> row = ((y - weekHeight) / cellHeight).toInt()
        <span class="hljs-keyword">val</span> col = (x / cellWidth).toInt()

        <span class="hljs-keyword">if</span> (row &lt; <span class="hljs-number">0</span> || row &gt;= <span class="hljs-number">6</span> || col &lt; <span class="hljs-number">0</span> || col &gt;= <span class="hljs-number">7</span>) <span class="hljs-keyword">return</span>

        <span class="hljs-comment">// 获取当前月份第一天是星期几</span>
        calendar.<span class="hljs-keyword">set</span>(currentYear, currentMonth, <span class="hljs-number">1</span>)
        <span class="hljs-keyword">val</span> firstDayOfWeek = calendar.<span class="hljs-keyword">get</span>(Calendar.DAY_OF_WEEK) - <span class="hljs-number">1</span>

        <span class="hljs-comment">// 获取当月天数</span>
        <span class="hljs-keyword">val</span> daysInMonth = getMonthDays(currentYear, currentMonth)

        <span class="hljs-comment">// 计算点击的日期索引</span>
        <span class="hljs-keyword">val</span> position = row * <span class="hljs-number">7</span> + col
        <span class="hljs-keyword">val</span> dayIndex = position - firstDayOfWeek + <span class="hljs-number">1</span>

        <span class="hljs-keyword">if</span> (dayIndex <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span>.daysInMonth) {
            <span class="hljs-comment">// 点击当前月份日期</span>
            selectDate(currentYear, currentMonth, dayIndex)
        }
        <span class="hljs-comment">// 跨月日期不可点击，不做任何处理</span>
    }

    <span class="hljs-comment">/**
     * 获取月份天数
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getMonthDays</span><span class="hljs-params">(year: <span class="hljs-type">Int</span>, month: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> {
        <span class="hljs-keyword">val</span> isLeapYear = (year % <span class="hljs-number">4</span> == <span class="hljs-number">0</span> &amp;&amp; year % <span class="hljs-number">100</span> != <span class="hljs-number">0</span>) || (year % <span class="hljs-number">400</span> == <span class="hljs-number">0</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> (month) {
            <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">9</span>, <span class="hljs-number">11</span> -&gt; <span class="hljs-number">31</span>
            <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">8</span>, <span class="hljs-number">10</span> -&gt; <span class="hljs-number">30</span>
            <span class="hljs-number">1</span> -&gt; <span class="hljs-keyword">if</span> (isLeapYear) <span class="hljs-number">29</span> <span class="hljs-keyword">else</span> <span class="hljs-number">28</span>
            <span class="hljs-keyword">else</span> -&gt; <span class="hljs-number">0</span>
        }
    }

    <span class="hljs-comment">/**
     * 选择日期
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">selectDate</span><span class="hljs-params">(year: <span class="hljs-type">Int</span>, month: <span class="hljs-type">Int</span>, day: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-comment">// 如果选择的日期不在当前月份，先切换到该月份</span>
        <span class="hljs-keyword">if</span> (year != currentYear || month != currentMonth) {
            currentYear = year
            currentMonth = month
        }

        <span class="hljs-comment">// 设置选中日期</span>
        selectedDate = Calendar.getInstance().apply {
            <span class="hljs-keyword">set</span>(year, month, day)
        }

        <span class="hljs-comment">// 重绘</span>
        invalidate()

        <span class="hljs-comment">// 回调</span>
        onDateClickListener?.invoke(year, month, day)
    }

    <span class="hljs-comment">/**
     * 新增：设置红点日期
     * <span class="hljs-doctag">@param</span> dates 日期列表，格式: "2024-01-15"
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setRedDotDates</span><span class="hljs-params">(dates: <span class="hljs-type">List</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span> {
        redDotDates.clear()
        redDotDates.addAll(dates)
        invalidate()
    }

    <span class="hljs-comment">/**
     * 新增：设置绿点日期
     * <span class="hljs-doctag">@param</span> dates 日期列表，格式: "2024-01-15"
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setGreenDotDates</span><span class="hljs-params">(dates: <span class="hljs-type">List</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span> {
        greenDotDates.clear()
        greenDotDates.addAll(dates)
        invalidate()
    }

    <span class="hljs-comment">/**
     * 新增：添加单个红点日期
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addRedDotDate</span><span class="hljs-params">(year: <span class="hljs-type">Int</span>, month: <span class="hljs-type">Int</span>, day: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">val</span> dateKey = formatDateKey(year, month, day)
        redDotDates.add(dateKey)
        invalidate()
    }

    <span class="hljs-comment">/**
     * 新增：添加单个绿点日期
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addGreenDotDate</span><span class="hljs-params">(year: <span class="hljs-type">Int</span>, month: <span class="hljs-type">Int</span>, day: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">val</span> dateKey = formatDateKey(year, month, day)
        greenDotDates.add(dateKey)
        invalidate()
    }

    <span class="hljs-comment">/**
     * 新增：移除红点日期
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">removeRedDotDate</span><span class="hljs-params">(year: <span class="hljs-type">Int</span>, month: <span class="hljs-type">Int</span>, day: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">val</span> dateKey = formatDateKey(year, month, day)
        redDotDates.remove(dateKey)
        invalidate()
    }

    <span class="hljs-comment">/**
     * 新增：移除绿点日期
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">removeGreenDotDate</span><span class="hljs-params">(year: <span class="hljs-type">Int</span>, month: <span class="hljs-type">Int</span>, day: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">val</span> dateKey = formatDateKey(year, month, day)
        greenDotDates.remove(dateKey)
        invalidate()
    }

    <span class="hljs-comment">/**
     * 新增：清空所有红点
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">clearRedDotDates</span><span class="hljs-params">()</span></span> {
        redDotDates.clear()
        invalidate()
    }

    <span class="hljs-comment">/**
     * 新增：清空所有绿点
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">clearGreenDotDates</span><span class="hljs-params">()</span></span> {
        greenDotDates.clear()
        invalidate()
    }

    <span class="hljs-comment">/**
     * 新增：格式化日期键
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">formatDateKey</span><span class="hljs-params">(year: <span class="hljs-type">Int</span>, month: <span class="hljs-type">Int</span>, day: <span class="hljs-type">Int</span>)</span></span>: String {
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"%d-%02d-%02d"</span>, year, month + <span class="hljs-number">1</span>, day)
    }

    <span class="hljs-comment">/**
     * 设置当前显示的月份
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setCurrentMonth</span><span class="hljs-params">(year: <span class="hljs-type">Int</span>, month: <span class="hljs-type">Int</span>)</span></span> {
        currentYear = year
        currentMonth = month
        invalidate()
    }

    <span class="hljs-comment">/**
     * 获取当前显示的月份
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getCurrentMonth</span><span class="hljs-params">()</span></span>: Pair&lt;<span class="hljs-built_in">Int</span>, <span class="hljs-built_in">Int</span>&gt; {
        <span class="hljs-keyword">return</span> Pair(currentYear, currentMonth)
    }

    <span class="hljs-comment">/**
     * 获取选中的日期
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getSelectedDate</span><span class="hljs-params">()</span></span>: Triple&lt;<span class="hljs-built_in">Int</span>, <span class="hljs-built_in">Int</span>, <span class="hljs-built_in">Int</span>&gt;? {
        <span class="hljs-keyword">return</span> selectedDate?.let {
            Triple(
                it.<span class="hljs-keyword">get</span>(Calendar.YEAR),
                it.<span class="hljs-keyword">get</span>(Calendar.MONTH),
                it.<span class="hljs-keyword">get</span>(Calendar.DAY_OF_MONTH)
            )
        }
    }

    <span class="hljs-comment">/**
     * 切换到上个月
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">previousMonth</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">var</span> newYear = currentYear
        <span class="hljs-keyword">var</span> newMonth = currentMonth - <span class="hljs-number">1</span>

        <span class="hljs-keyword">if</span> (newMonth &lt; <span class="hljs-number">0</span>) {
            newYear--
            newMonth = <span class="hljs-number">11</span>
        }

        setCurrentMonth(newYear, newMonth)
    }

    <span class="hljs-comment">/**
     * 切换到下个月
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">nextMonth</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">var</span> newYear = currentYear
        <span class="hljs-keyword">var</span> newMonth = currentMonth + <span class="hljs-number">1</span>

        <span class="hljs-keyword">if</span> (newMonth &gt; <span class="hljs-number">11</span>) {
            newYear++
            newMonth = <span class="hljs-number">0</span>
        }

        setCurrentMonth(newYear, newMonth)
    }

    <span class="hljs-comment">/**
     * 回到今天
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">goToToday</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> now = Calendar.getInstance()
        currentYear = now.<span class="hljs-keyword">get</span>(Calendar.YEAR)
        currentMonth = now.<span class="hljs-keyword">get</span>(Calendar.MONTH)
        selectedDate = now.clone() <span class="hljs-keyword">as</span> Calendar
        invalidate()

        <span class="hljs-comment">// 回调今天的日期</span>
        onDateClickListener?.invoke(
            currentYear,
            currentMonth,
            now.<span class="hljs-keyword">get</span>(Calendar.DAY_OF_MONTH)
        )
    }

    <span class="hljs-comment">/**
     * 设置日期点击监听器
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setOnDateClickListener</span><span class="hljs-params">(listener: (<span class="hljs-type">year</span>: <span class="hljs-type">Int</span>, <span class="hljs-type">month</span>: <span class="hljs-type">Int</span>, <span class="hljs-type">day</span>: <span class="hljs-type">Int</span>) -&gt; <span class="hljs-type">Unit</span>)</span></span> {
        <span class="hljs-keyword">this</span>.onDateClickListener = listener
    }

    <span class="hljs-comment">/**
     * sp转px
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">spToPx</span><span class="hljs-params">(sp: <span class="hljs-type">Float</span>)</span></span>: <span class="hljs-built_in">Float</span> {
        <span class="hljs-keyword">return</span> sp * resources.displayMetrics.scaledDensity
    }

    <span class="hljs-comment">/**
     * 新增：dp转px
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dpToPx</span><span class="hljs-params">(dp: <span class="hljs-type">Float</span>)</span></span>: <span class="hljs-built_in">Float</span> {
        <span class="hljs-keyword">return</span> dp * resources.displayMetrics.density
    }
}
</code></pre>
<h2 data-id="heading-2">样例布局<code>activity_main.xml</code></h2>
<pre><code class="hljs language-ini" lang="ini">&lt;?xml <span class="hljs-attr">version</span>=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;
&lt;LinearLayout xmlns:<span class="hljs-attr">android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    xmlns:<span class="hljs-attr">tools</span>=<span class="hljs-string">"http://schemas.android.com/tools"</span>
    android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/main"</span>
    android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
    android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"match_parent"</span>
    android:<span class="hljs-attr">orientation</span>=<span class="hljs-string">"vertical"</span>
    tools:<span class="hljs-attr">context</span>=<span class="hljs-string">".MainActivity"</span>&gt;

    &lt;!-- 标题 --&gt;
    &lt;TextView
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        android:<span class="hljs-attr">gravity</span>=<span class="hljs-string">"center"</span>
        android:<span class="hljs-attr">text</span>=<span class="hljs-string">"简易日历"</span>
        android:<span class="hljs-attr">textSize</span>=<span class="hljs-string">"18sp"</span>
        android:<span class="hljs-attr">textStyle</span>=<span class="hljs-string">"bold"</span> /&gt;

    &lt;!-- 月份导航 --&gt;
    &lt;LinearLayout
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        android:<span class="hljs-attr">gravity</span>=<span class="hljs-string">"center"</span>
        android:<span class="hljs-attr">orientation</span>=<span class="hljs-string">"horizontal"</span>&gt;

        &lt;Button
            android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/prevMonthButton"</span>
            android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"wrap_content"</span>
            android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
            android:<span class="hljs-attr">text</span>=<span class="hljs-string">"◀ 上个月"</span> /&gt;

        &lt;TextView
            android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/monthYearTextView"</span>
            android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"wrap_content"</span>
            android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
            android:<span class="hljs-attr">layout_marginHorizontal</span>=<span class="hljs-string">"16dp"</span>
            android:<span class="hljs-attr">text</span>=<span class="hljs-string">"2024年2月"</span>
            android:<span class="hljs-attr">textSize</span>=<span class="hljs-string">"18sp"</span>
            android:<span class="hljs-attr">textStyle</span>=<span class="hljs-string">"bold"</span> /&gt;

        &lt;Button
            android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/nextMonthButton"</span>
            android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"wrap_content"</span>
            android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
            android:<span class="hljs-attr">text</span>=<span class="hljs-string">"下个月 ▶"</span> /&gt;
    &lt;/LinearLayout&gt;

    &lt;!-- 日历视图 --&gt;
    &lt;cn.nio.calendar.SimpleCalendarView
        android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/calendarView"</span>
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span> /&gt;

    &lt;!-- 选中的日期 --&gt;
    &lt;TextView
        android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/selectedDateTextView"</span>
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        android:<span class="hljs-attr">gravity</span>=<span class="hljs-string">"center"</span>
        android:<span class="hljs-attr">text</span>=<span class="hljs-string">"选中: 2024年2月15日"</span>
        android:<span class="hljs-attr">textSize</span>=<span class="hljs-string">"13sp"</span>
        android:<span class="hljs-attr">textStyle</span>=<span class="hljs-string">"bold"</span> /&gt;

    &lt;!-- 回到今天按钮 --&gt;
    &lt;Button
        android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/todayButton"</span>
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        android:<span class="hljs-attr">layout_marginHorizontal</span>=<span class="hljs-string">"12dp"</span>
        android:<span class="hljs-attr">text</span>=<span class="hljs-string">"回到今天"</span> /&gt;


&lt;/LinearLayout&gt;
</code></pre>
<h2 data-id="heading-3">样例<code>MainActivity.kt</code></h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> cn.nio.calendar

<span class="hljs-keyword">import</span> android.os.Bundle
<span class="hljs-keyword">import</span> android.widget.Button
<span class="hljs-keyword">import</span> android.widget.TextView
<span class="hljs-keyword">import</span> androidx.activity.enableEdgeToEdge
<span class="hljs-keyword">import</span> androidx.appcompat.app.AppCompatActivity
<span class="hljs-keyword">import</span> androidx.core.view.ViewCompat
<span class="hljs-keyword">import</span> androidx.core.view.WindowInsetsCompat
<span class="hljs-keyword">import</span> java.text.SimpleDateFormat
<span class="hljs-keyword">import</span> java.util.Calendar
<span class="hljs-keyword">import</span> java.util.Locale

<span class="hljs-comment">/**
 * 简易日历
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> calendarView: SimpleCalendarView
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> monthYearTextView: TextView
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> selectedDateTextView: TextView
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> prevMonthButton: Button
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> nextMonthButton: Button
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> todayButton: Button

    <span class="hljs-comment">//    private val monthFormat = SimpleDateFormat("yyyy年MM月", Locale.getDefault())</span>
<span class="hljs-comment">//    private val dateFormat = SimpleDateFormat("yyyy年MM月dd日", Locale.getDefault())</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        enableEdgeToEdge()
        setContentView(R.layout.activity_main)
        ViewCompat.setOnApplyWindowInsetsListener(findViewById(R.id.main)) { v, insets -&gt;
            <span class="hljs-keyword">val</span> systemBars = insets.getInsets(WindowInsetsCompat.Type.systemBars())
            v.setPadding(systemBars.left, systemBars.top, systemBars.right, systemBars.bottom)
            insets
        }

        <span class="hljs-comment">// 初始化视图</span>
        calendarView = findViewById(R.id.calendarView)
        monthYearTextView = findViewById(R.id.monthYearTextView)
        selectedDateTextView = findViewById(R.id.selectedDateTextView)
        prevMonthButton = findViewById(R.id.prevMonthButton)
        nextMonthButton = findViewById(R.id.nextMonthButton)
        todayButton = findViewById(R.id.todayButton)

        <span class="hljs-comment">// 初始化显示</span>
        updateMonthYearText()
        updateSelectedDateText()

        <span class="hljs-comment">// 点击选中日期</span>
        calendarView.setOnDateClickListener { year, month, day -&gt;
            updateSelectedDateText()
        }

        <span class="hljs-comment">// 上个月</span>
        prevMonthButton.setOnClickListener {
            calendarView.previousMonth()
            updateMonthYearText()
        }
        <span class="hljs-comment">// 下个月</span>
        nextMonthButton.setOnClickListener {
            calendarView.nextMonth()
            updateMonthYearText()
        }
        <span class="hljs-comment">// 回到今天</span>
        todayButton.setOnClickListener {
            calendarView.goToToday()
            updateMonthYearText()
            updateSelectedDateText()
        }
        calculatePreviousDaysWithCalendar()
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateMonthYearText</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> (year, month) = calendarView.getCurrentMonth()
        monthYearTextView.text = <span class="hljs-string">"<span class="hljs-subst">${year}</span>年<span class="hljs-subst">${month + <span class="hljs-number">1</span>}</span>月"</span>
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateSelectedDateText</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> selectedDate = calendarView.getSelectedDate()
        selectedDate?.let { (year, month, day) -&gt;
            selectedDateTextView.text = <span class="hljs-string">"选中: <span class="hljs-subst">${year}</span>年<span class="hljs-subst">${month + <span class="hljs-number">1</span>}</span>月<span class="hljs-subst">${day}</span>日"</span>
        }
    }

    <span class="hljs-comment">/**
     *  设置红点绿点日期
     *
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">calculatePreviousDaysWithCalendar</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> calendar = Calendar.getInstance()
        <span class="hljs-keyword">val</span> sdf = SimpleDateFormat(<span class="hljs-string">"yyyy-MM-dd"</span>, Locale.getDefault()) <span class="hljs-comment">// 线程不安全，多线程需注意</span>

        <span class="hljs-comment">// 计算前1天</span>
        calendar.add(Calendar.DAY_OF_MONTH, -<span class="hljs-number">1</span>)
        <span class="hljs-keyword">val</span> previous1DayStr = sdf.format(calendar.time)
        <span class="hljs-comment">// 计算前2天（在原基础上再减1）</span>
        calendar.add(Calendar.DAY_OF_MONTH, -<span class="hljs-number">1</span>)
        <span class="hljs-keyword">val</span> previous2DayStr = sdf.format(calendar.time)
        <span class="hljs-comment">// 计算前3天</span>
        calendar.add(Calendar.DAY_OF_MONTH, -<span class="hljs-number">1</span>)
        <span class="hljs-keyword">val</span> previous3DayStr = sdf.format(calendar.time)

        <span class="hljs-comment">// 重置Calendar到当前时间（可选）</span>
        calendar.add(Calendar.DAY_OF_MONTH, <span class="hljs-number">3</span>)

        println(<span class="hljs-string">"当前日期：<span class="hljs-subst">${sdf.format(Calendar.getInstance().time)}</span>"</span>)
        println(<span class="hljs-string">"前1天：<span class="hljs-variable">$previous1DayStr</span>"</span>)
        println(<span class="hljs-string">"前2天：<span class="hljs-variable">$previous2DayStr</span>"</span>)
        println(<span class="hljs-string">"前3天：<span class="hljs-variable">$previous3DayStr</span>"</span>)
        calendarView.setGreenDotDates(listOf(previous1DayStr, previous3DayStr))
        calendarView.setRedDotDates(listOf(previous2DayStr))
    }

}
</code></pre>
<h2 data-id="heading-4">效果展示</h2>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d6c727db18440388ec3692f986b832b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5b6A5ZOq6L656LWw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975159&amp;x-signature=BcwkkKd7sz9gpiujJpXtA37S1W8%3D" alt="Screen_recording_20251222_100250 00_00_00-00_00_30.gif" width="50%" loading="lazy"/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零开始：MCP数据库助手（一）- 基础搭建]]></title>    <link>https://juejin.cn/post/7585866811717074971</link>    <guid>https://juejin.cn/post/7585866811717074971</guid>    <pubDate>2025-12-22T02:22:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585866811717074971" data-draft-id="7585897699602956314" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零开始：MCP数据库助手（一）- 基础搭建"/> <meta itemprop="keywords" content="MCP"/> <meta itemprop="datePublished" content="2025-12-22T02:22:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="红鼻子时代"/> <meta itemprop="url" content="https://juejin.cn/user/1743149753974384"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零开始：MCP数据库助手（一）- 基础搭建
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1743149753974384/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    红鼻子时代
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:22:22.000Z" title="Mon Dec 22 2025 02:22:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">MCP是什么？为什么要用它？</h2>
<p>MCP全称Model Context Protocol，简单说就是让AI助手能够调用外部工具的标准协议。想象一下，如果AI只能聊天，那就像一个很聪明但没有手的人。MCP就是给AI装上了"手"，让它能够真正操作数据库、文件系统等等。</p>
<p>对于数据库操作来说，MCP的优势特别明显：</p>
<ul>
<li><strong>一问即答</strong>：直接问AI就能获取数据库信息</li>
<li><strong>安全可控</strong>：AI只能调用你预设的工具函数</li>
<li><strong>智能分析</strong>：AI能理解数据关系，给出有用的建议</li>
</ul>
<h2 data-id="heading-1">第一步：项目结构搭建</h2>
<p>咱们先把项目的骨架搭起来。</p>
<pre><code class="hljs language-bash" lang="bash">v1/
├── pyproject.toml            <span class="hljs-comment"># uv 项目配置</span>
├── README.md                <span class="hljs-comment"># 项目说明</span>
├── src/
│   └── mcp_datatools/       <span class="hljs-comment"># 主包</span>
│       ├── __init__.py
│       ├── server.py        <span class="hljs-comment"># MCP 服务器</span>
│       └── database.py      <span class="hljs-comment"># 数据库管理</span>
├── data/
│   ├── init_scripts/
│   │   └── init_sqlite_db.py   <span class="hljs-comment"># 初始化 SQLite 数据库脚本</span>
│   └── test.db             <span class="hljs-comment"># SQLite 测试数据库</span>
└── tests/                  <span class="hljs-comment"># 测试文件目录</span>
</code></pre>
<p>为什么这样设计？</p>
<ul>
<li>使用 <code>uv</code> 作为包管理器，更现代更快速</li>
<li><code>src/</code> 目录让代码结构更清晰</li>
<li><code>data/</code> 存放测试数据和初始化脚本</li>
<li><code>tests/</code> 目录为后续单元测试预留</li>
<li>配置文件简洁，专注核心功能</li>
</ul>
<h2 data-id="heading-2">第二步：环境配置和依赖</h2>
<p>咱们使用现代的 <code>uv</code> 包管理器来管理依赖：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 uv (如果还没有安装)</span>
curl -LsSf https://astral.sh/uv/install.sh | sh

<span class="hljs-comment"># 进入项目目录</span>
<span class="hljs-built_in">cd</span> v1

<span class="hljs-comment"># 安装依赖</span>
uv <span class="hljs-built_in">sync</span>
</code></pre>
<p><code>pyproject.toml</code> 文件内容：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-section">[project]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"mcp-datatools"</span>
<span class="hljs-attr">version</span> = <span class="hljs-string">"0.1.0"</span>
<span class="hljs-attr">description</span> = <span class="hljs-string">"A MCP server that connects to your database"</span>
<span class="hljs-attr">requires-python</span> = <span class="hljs-string">"&gt;=3.10"</span>

<span class="hljs-attr">dependencies</span> = [
    <span class="hljs-string">"mcp&gt;=1.0.0"</span>,
    <span class="hljs-string">"sqlalchemy&gt;=2.0.0"</span>,
]

<span class="hljs-section">[build-system]</span>
<span class="hljs-attr">requires</span> = [<span class="hljs-string">"hatchling"</span>]
<span class="hljs-attr">build-backend</span> = <span class="hljs-string">"hatchling.build"</span>
</code></pre>
<p>为什么选择 <code>uv</code>？</p>
<ul>
<li><strong>速度极快</strong>：比 pip 快 10-100 倍</li>
<li><strong>依赖解析</strong>：更智能的依赖管理</li>
<li><strong>项目隔离</strong>：自动创建虚拟环境</li>
<li><strong>现代标准</strong>：支持最新的 Python 包管理标准</li>
</ul>
<h2 data-id="heading-3">第三步：数据库连接管理</h2>
<p>数据库连接是整个项目的基础，咱们先把这部分搞定。我设计了一个<code>DatabaseManager</code>类来管理连接：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
database.py - 数据库管理模块
"""</span>

<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>
<span class="hljs-keyword">from</span> contextlib <span class="hljs-keyword">import</span> contextmanager
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> create_engine,inspect,text
<span class="hljs-keyword">from</span> sqlalchemy.exc <span class="hljs-keyword">import</span> SQLAlchemyError
<span class="hljs-keyword">from</span> mcp.server.fastmcp.utilities.logging <span class="hljs-keyword">import</span> get_logger


logger = get_logger(__name__)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseManager</span>:
    <span class="hljs-string">"""数据库管理器"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""初始化数据库管理器"""</span>
        
        self.database_url = os.getenv(<span class="hljs-string">"DB_URL"</span>)
        self.engine = <span class="hljs-literal">None</span>
        self._connect()


    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_connect</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""连接数据库"""</span>
        <span class="hljs-keyword">try</span>:
            self.engine = create_engine(self.database_url, echo=<span class="hljs-literal">False</span>)
            logger.info(<span class="hljs-string">f"成功连接到数据库: <span class="hljs-subst">{self.database_url}</span>"</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"连接数据库时出错: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
            <span class="hljs-keyword">raise</span>

<span class="hljs-meta">    @contextmanager</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_connection</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""获取数据库连接的上下文管理器"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.engine:
            <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">"数据库未连接"</span>)
        
        conn = self.engine.connect()
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">yield</span> conn
        <span class="hljs-keyword">finally</span>:
            conn.close()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_table_names</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:
        <span class="hljs-string">"""获取数据库中的所有表名"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> self.get_connection() <span class="hljs-keyword">as</span> conn:
                inspector = inspect(conn)
                table_names = inspector.get_table_names()
                <span class="hljs-keyword">return</span> table_names
        <span class="hljs-keyword">except</span> SQLAlchemyError <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"获取表名失败: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_connection</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-string">"""测试数据库连接"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> self.get_connection() <span class="hljs-keyword">as</span> conn:

                result = conn.execute(text(<span class="hljs-string">"SELECT 1"</span>)).scalar()
                <span class="hljs-keyword">return</span> result == <span class="hljs-number">1</span>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"测试数据库连接时出错: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_db_info</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-keyword">try</span>:
            tables = self.get_table_names()
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"数据库URL: <span class="hljs-subst">{self.database_url}</span>\n共有 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(tables)}</span> 个表"</span>
        <span class="hljs-keyword">except</span> Exception:
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"数据库URL: <span class="hljs-subst">{self.database_url}</span>\n数据库连接失败"</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">close</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""关闭数据库连接"""</span>
        <span class="hljs-keyword">if</span> self.engine:
            self.engine.dispose()
            logger.info(<span class="hljs-string">"数据库连接已关闭"</span>)
        
</code></pre>
<h2 data-id="heading-4">第四步：第一个MCP工具函数</h2>
<p>现在是最重要的部分 - 实现第一个MCP工具函数<code>list_tables()</code>！</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
server.py - MCP服务器主文件
"""</span>

<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> mcp.server.fastmcp <span class="hljs-keyword">import</span> FastMCP
<span class="hljs-keyword">from</span> mcp.server.fastmcp.utilities.logging <span class="hljs-keyword">import</span> get_logger
<span class="hljs-keyword">from</span> .database <span class="hljs-keyword">import</span> DatabaseManager

mcp = FastMCP(<span class="hljs-string">"MCP DataTools"</span>)
logger = get_logger(__name__)
db_manager = <span class="hljs-literal">None</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_database_manager</span>():
    <span class="hljs-string">"""获取数据库管理器实例"""</span>
    <span class="hljs-keyword">global</span> db_manager
    <span class="hljs-keyword">if</span> db_manager <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
        db_manager = DatabaseManager()
    <span class="hljs-keyword">return</span> db_manager
    
<span class="hljs-meta">@mcp.tool(<span class="hljs-params">description=<span class="hljs-string">"查询数据库中的所有表"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">list_tables</span>() -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""获取数据库表列表"""</span>
    <span class="hljs-keyword">try</span>:
        db_mgr = get_database_manager()
        tables = db_mgr.get_table_names()
        
        <span class="hljs-keyword">if</span> tables:
            table_list = <span class="hljs-string">","</span>.join(tables)
            result = <span class="hljs-string">f"数据库中共有 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(tables)}</span> 个表:\n\n"</span>
            <span class="hljs-keyword">for</span> i,table <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(tables,<span class="hljs-number">1</span>):
                result += <span class="hljs-string">f"<span class="hljs-subst">{i}</span>. <span class="hljs-subst">{table}</span>\n"</span>
            logger.info(<span class="hljs-string">f"成功返回 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(tables)}</span> 个表: <span class="hljs-subst">{table_list}</span>"</span>)
            <span class="hljs-keyword">return</span> result
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">"数据库中没有表"</span>

    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        error_msg = <span class="hljs-string">f"获取数据库表列表失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
        logger.error(error_msg)
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{error_msg}</span>\n\n请检查数据库连接。"</span>


<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-keyword">try</span>:
        logger.info(<span class="hljs-string">"启动MCP DataTools服务器"</span>)

        db_mgr = get_database_manager()

        <span class="hljs-keyword">if</span> db_mgr.test_connection():
            logger.info(<span class="hljs-string">"数据库连接测试成功"</span>)
        <span class="hljs-keyword">else</span>:
            logger.warning(<span class="hljs-string">"数据库连接测试失败，但服务器仍会启动"</span>)
            logger.info(<span class="hljs-string">"提示：运行 'python data/init_scripts/init_sqlite_db.py' 创建测试数据库"</span>)

        logger.info(<span class="hljs-string">"当前功能：list_tables() - 获取数据库表列表"</span>)
        logger.info(<span class="hljs-string">"MCP服务器启动成功，等待客户端连接..."</span>)
        
        mcp.run()

    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        logger.error(<span class="hljs-string">f"服务器启动失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
        <span class="hljs-keyword">raise</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()
</code></pre>
<h2 data-id="heading-5">第五步：测试数据准备</h2>
<p>光有工具还不行，得有数据来测试。第1周我们创建一个超级简单的测试数据库，重点是能让<code>list_tables()</code>功能工作：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
data/init_sqlite_db.py - 初始化 SQLite 数据库
"""</span>

<span class="hljs-keyword">import</span> sqlite3
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path

<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_simple_test_database</span>():
    <span class="hljs-string">"""创建简单测试数据库"""</span>
    
    data_dir = Path(__file__).parent.parent / <span class="hljs-string">"data"</span>
    db_path = data_dir / <span class="hljs-string">"test.db"</span>
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">" 测试数据库创建器"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"数据库路径: <span class="hljs-subst">{db_path}</span>"</span>)
    
    <span class="hljs-keyword">if</span> db_path.exists():
        os.remove(db_path)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"删除旧数据库文件"</span>)
    
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()
    
    <span class="hljs-keyword">try</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"创建基础表结构..."</span>)
        
        <span class="hljs-comment"># 创建用户表</span>
        cursor.execute(<span class="hljs-string">"""
            CREATE TABLE users (
                id INTEGER PRIMARY KEY,
                name VARCHAR(50) NOT NULL,
                email VARCHAR(100) NOT NULL
            )
        """</span>)
        
        <span class="hljs-comment"># 创建产品表</span>
        cursor.execute(<span class="hljs-string">"""
            CREATE TABLE products (
                id INTEGER PRIMARY KEY,
                name VARCHAR(100) NOT NULL,
                price DECIMAL(10, 2) NOT NULL
            )
        """</span>)
        
        <span class="hljs-comment"># 创建订单表</span>
        cursor.execute(<span class="hljs-string">"""
            CREATE TABLE orders (
                id INTEGER PRIMARY KEY,
                user_id INTEGER,
                total_amount DECIMAL(10, 2)
            )
        """</span>)
        
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"插入测试数据..."</span>)
        
        <span class="hljs-comment"># 插入测试数据</span>
        cursor.execute(<span class="hljs-string">"INSERT INTO users (name, email) VALUES ('Alice', 'alice@test.com')"</span>)
        cursor.execute(<span class="hljs-string">"INSERT INTO users (name, email) VALUES ('Bob', 'bob@test.com')"</span>)
        
        cursor.execute(<span class="hljs-string">"INSERT INTO products (name, price) VALUES ('笔记本电脑', 5999.99)"</span>)
        cursor.execute(<span class="hljs-string">"INSERT INTO products (name, price) VALUES ('鼠标', 129.99)"</span>)
        
        cursor.execute(<span class="hljs-string">"INSERT INTO orders (user_id, total_amount) VALUES (1, 6129.98)"</span>)
        cursor.execute(<span class="hljs-string">"INSERT INTO orders (user_id, total_amount) VALUES (2, 129.99)"</span>)
        
        conn.commit()
        
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"测试数据库创建成功！"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"数据库包含表:"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"  1. users - 用户表 (2条记录)"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"  2. products - 产品表 (2条记录)"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"  3. orders - 订单表 (2条记录)"</span>)
        
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"创建数据库时出错: <span class="hljs-subst">{e}</span>"</span>)
        conn.rollback()
        <span class="hljs-keyword">raise</span>
    <span class="hljs-keyword">finally</span>:
        conn.close()

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    create_simple_test_database()
</code></pre>
<p>运行这个脚本：</p>
<pre><code class="hljs language-bash" lang="bash">python data/init_scripts/init_sqlite_db.py
</code></pre>
<p>你就会得到一个包含3个基础表的测试数据库。</p>
<h2 data-id="heading-6">第六步：Cursor 集成测试</h2>
<h3 data-id="heading-7">配置 Cursor</h3>
<p>在 Cursor 的 MCP 配置中添加我们的服务器。打开 Cursor 设置，找到 MCP 配置部分：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"mcp-datatools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"uv"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"run"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"--project"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"/path"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"python"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"-m"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"mcp_datatools.server"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"DB_URL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sqlite:///data/test.db"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>正常来说是能开启的：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/783a37f73f6b4888a9d9043909d95d97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57qi6by75a2Q5pe25Luj:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975331&amp;x-signature=X1wJMrdM5Vf%2BYpcDC9WYTQv6f58%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-8">测试功能</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf55e82ab5ad4e9d9b7e7c5cf396c6ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57qi6by75a2Q5pe25Luj:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975331&amp;x-signature=v9mBfGnHWd35M5cyYjPUFD3CiT0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-9">总结与预告</h2>
<p>第1章我们成功搭建了MCP数据库智能助手的基础，下一章将实现更多的工具函数。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零开始：MCP数据库助手（二）- 核心功能实现]]></title>    <link>https://juejin.cn/post/7585897699603054618</link>    <guid>https://juejin.cn/post/7585897699603054618</guid>    <pubDate>2025-12-22T02:23:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585897699603054618" data-draft-id="7585920796100001819" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零开始：MCP数据库助手（二）- 核心功能实现"/> <meta itemprop="keywords" content="MCP"/> <meta itemprop="datePublished" content="2025-12-22T02:23:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="红鼻子时代"/> <meta itemprop="url" content="https://juejin.cn/user/1743149753974384"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零开始：MCP数据库助手（二）- 核心功能实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1743149753974384/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    红鼻子时代
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:23:58.000Z" title="Mon Dec 22 2025 02:23:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">为什么要实现这3个核心功能？</h2>
<p>上一篇我们搭建了基础框架，AI已经能"看到"数据库中有哪些表了。但这还远远不够，今天咱们要让AI变得更聪明，实现3个核心功能：</p>
<ul>
<li>能智能搜索相关的表</li>
<li>能深度理解表的结构</li>
<li>能安全地执行SQL查询</li>
</ul>
<h2 data-id="heading-1">第一步：filter_table_names() - 智能搜索表名</h2>
<p>第1周我们已经能获取所有表名了，但当数据库有几十个表的时候，你得能快速找到相关的表。这就像在图书馆里找书，你不可能一本本翻，得按分类找。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@mcp.tool(<span class="hljs-params">description=<span class="hljs-string">"根据关键词搜索相关的表名。支持模糊匹配，不区分大小写。"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">filter_table_names</span>(<span class="hljs-params">keyword: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""根据关键词搜索相关的表名"""</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> keyword <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> keyword.strip():
            <span class="hljs-keyword">return</span> <span class="hljs-string">"请提供搜索关键词"</span>

        db_mgr = get_database_manager()
        matching_tables = db_mgr.filter_table_names(keyword.strip())
        
        <span class="hljs-keyword">if</span> matching_tables:
            table_list = <span class="hljs-string">", "</span>.join(matching_tables)
            result = <span class="hljs-string">f"搜索关键词 '<span class="hljs-subst">{keyword}</span>' 找到 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(matching_tables)}</span> 个相关表:\n"</span>
            result += <span class="hljs-string">f"匹配的表: <span class="hljs-subst">{table_list}</span>"</span>
            logger.info(<span class="hljs-string">f"关键词 '<span class="hljs-subst">{keyword}</span>' 匹配到: <span class="hljs-subst">{table_list}</span>"</span>)
            <span class="hljs-keyword">return</span> result
        <span class="hljs-keyword">else</span>:
            all_tables = db_mgr.get_table_names()
            all_table_list = <span class="hljs-string">", "</span>.join(all_tables) <span class="hljs-keyword">if</span> all_tables <span class="hljs-keyword">else</span> <span class="hljs-string">"无"</span>
            result = <span class="hljs-string">f"搜索关键词 '<span class="hljs-subst">{keyword}</span>' 没有找到匹配的表。\n"</span>
            result += <span class="hljs-string">f"数据库中的所有表: <span class="hljs-subst">{all_table_list}</span>\n"</span>
            result += <span class="hljs-string">f"建议尝试其他关键词，如表名的一部分。"</span>
            logger.info(<span class="hljs-string">f"关键词 '<span class="hljs-subst">{keyword}</span>' 没有找到匹配的表。"</span>)
            <span class="hljs-keyword">return</span> result
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        error_msg = <span class="hljs-string">f"搜索表名失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
        logger.error(error_msg)
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{error_msg}</span>"</span>
</code></pre>
<p>数据库管理器中的搜索逻辑：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">filter_table_names</span>(<span class="hljs-params">self, keyword: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:
    <span class="hljs-string">"""根据关键词搜索相关表名"""</span>
    <span class="hljs-keyword">try</span>:
        all_tables = self.get_table_names()
        <span class="hljs-comment"># 不区分大小写的模糊匹配</span>
        matching_tables = [
            table <span class="hljs-keyword">for</span> table <span class="hljs-keyword">in</span> all_tables 
            <span class="hljs-keyword">if</span> keyword.lower() <span class="hljs-keyword">in</span> table.lower()
        ]
        <span class="hljs-keyword">return</span> matching_tables
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        logger.error(<span class="hljs-string">f"搜索表名失败: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">raise</span>
</code></pre>
<p>这个功能在大型项目中特别有用，想象一下在一个有100个表的电商系统中快速找到所有支付相关的表！</p>
<h2 data-id="heading-2">第二步：schema_definitions() - 深度解析表结构</h2>
<p>知道表名还不够，得知道表里有什么字段、什么类型、什么关系。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@mcp.tool(<span class="hljs-params">description=<span class="hljs-string">"获取指定表的详细结构信息，包括列、类型、主键、索引、外键等。支持同时查询多个表。"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">schema_info</span>(<span class="hljs-params">table_names: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""获取指定表的详细结构信息"""</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> table_names:
            <span class="hljs-keyword">return</span> <span class="hljs-string">"请提供要查询的表名"</span>

        db_mgr = get_database_manager()
        result_parts = []

        <span class="hljs-keyword">for</span> table_name <span class="hljs-keyword">in</span> table_names:
            <span class="hljs-keyword">try</span>:
                schema_info = db_mgr.get_table_schema(table_name)
                
                <span class="hljs-comment"># 格式化表结构信息</span>
                table_section = <span class="hljs-string">f"\n<span class="hljs-subst">{<span class="hljs-string">'='</span>*<span class="hljs-number">50</span>}</span>\n"</span>
                table_section += <span class="hljs-string">f"表名：<span class="hljs-subst">{table_name}</span>\n"</span>
                table_section += <span class="hljs-string">f"列：<span class="hljs-subst">{schema_info[<span class="hljs-string">'columns'</span>]}</span>\n"</span>
                table_section += <span class="hljs-string">f"<span class="hljs-subst">{<span class="hljs-string">'='</span>*<span class="hljs-number">50</span>}</span>\n"</span>

                <span class="hljs-comment"># 列信息</span>
                column_section = <span class="hljs-string">"列信息：\n"</span>
                <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> schema_info[<span class="hljs-string">'columns'</span>]:
                    col_type = col[<span class="hljs-string">'type'</span>]
                    nullable = <span class="hljs-string">"可空"</span> <span class="hljs-keyword">if</span> col[<span class="hljs-string">'nullable'</span>] <span class="hljs-keyword">else</span> <span class="hljs-string">"不可空"</span>
                    pk_mark = <span class="hljs-string">" 主键"</span> <span class="hljs-keyword">if</span> col[<span class="hljs-string">'is_primary_key'</span>] <span class="hljs-keyword">else</span> <span class="hljs-string">""</span>
                    default_info = <span class="hljs-string">f" (默认: <span class="hljs-subst">{col[<span class="hljs-string">'default'</span>]}</span>)"</span> <span class="hljs-keyword">if</span> col[<span class="hljs-string">'default'</span>] <span class="hljs-keyword">else</span> <span class="hljs-string">""</span>

                    table_section += <span class="hljs-string">f"  • <span class="hljs-subst">{col[<span class="hljs-string">'name'</span>]}</span>: <span class="hljs-subst">{col_type}</span> - <span class="hljs-subst">{nullable}</span><span class="hljs-subst">{pk_mark}</span><span class="hljs-subst">{default_info}</span>\n"</span>
                
                <span class="hljs-comment"># 主键信息</span>
                <span class="hljs-keyword">if</span> schema_info[<span class="hljs-string">'primary_keys'</span>]:
                    table_section += <span class="hljs-string">f"\n主键: <span class="hljs-subst">{<span class="hljs-string">', '</span>.join(schema_info[<span class="hljs-string">'primary_keys'</span>])}</span>\n"</span>

                <span class="hljs-comment"># 索引信息</span>
                <span class="hljs-keyword">if</span> schema_info[<span class="hljs-string">'indexes'</span>]:
                    table_section += <span class="hljs-string">"\n索引信息:\n"</span>
                    <span class="hljs-keyword">for</span> idx <span class="hljs-keyword">in</span> schema_info[<span class="hljs-string">'indexes'</span>]:
                        unique_mark = <span class="hljs-string">"唯一索引"</span> <span class="hljs-keyword">if</span> idx.get(<span class="hljs-string">'unique'</span>, <span class="hljs-literal">False</span>) <span class="hljs-keyword">else</span> <span class="hljs-string">"普通索引"</span>
                        columns = <span class="hljs-string">', '</span>.join(idx[<span class="hljs-string">'column_names'</span>])
                        table_section += <span class="hljs-string">f"  • <span class="hljs-subst">{idx[<span class="hljs-string">'name'</span>]}</span>: <span class="hljs-subst">{unique_mark}</span> (<span class="hljs-subst">{columns}</span>)\n"</span>

                <span class="hljs-comment"># 外键信息</span>
                <span class="hljs-keyword">if</span> schema_info[<span class="hljs-string">'foreign_keys'</span>]:
                    table_section += <span class="hljs-string">"\n外键关系:\n"</span>
                    <span class="hljs-keyword">for</span> fk <span class="hljs-keyword">in</span> schema_info[<span class="hljs-string">'foreign_keys'</span>]:
                        local_cols = <span class="hljs-string">', '</span>.join(fk[<span class="hljs-string">'constrained_columns'</span>])
                        ref_table = fk[<span class="hljs-string">'referred_table'</span>]
                        ref_cols = <span class="hljs-string">', '</span>.join(fk[<span class="hljs-string">'referred_columns'</span>])
                        table_section += <span class="hljs-string">f"  • <span class="hljs-subst">{local_cols}</span> → <span class="hljs-subst">{ref_table}</span>.<span class="hljs-subst">{ref_cols}</span>\n"</span>
                
                result_parts.append(table_section)
            
            <span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> e:
                result_parts.append(<span class="hljs-string">f"\n表 '<span class="hljs-subst">{table_name}</span>': <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>\n"</span>)
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                result_parts.append(<span class="hljs-string">f"\n表 '<span class="hljs-subst">{table_name}</span>' 解析失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>\n"</span>)

        final_result = <span class="hljs-string">'\n'</span>.join(result_parts)
        logger.info(<span class="hljs-string">f"成功解析 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(table_names)}</span> 个表的结构"</span>)

        <span class="hljs-keyword">return</span> final_result
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        error_msg = <span class="hljs-string">f"获取表结构信息失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
        logger.error(error_msg)
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{error_msg}</span>"</span>
</code></pre>
<p>数据库管理器中的解析逻辑：</p>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_table_schema</span>(<span class="hljs-params">self, table_name: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:
        <span class="hljs-string">"""获取指定表的详细结构信息"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> self.get_connection() <span class="hljs-keyword">as</span> conn:
                inspector = inspect(conn)

                <span class="hljs-comment"># 验证表是否存在</span>
                <span class="hljs-keyword">if</span> table_name <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> inspector.get_table_names():
                    <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"表 '<span class="hljs-subst">{table_name}</span>' 不存在"</span>)
                
                <span class="hljs-comment"># 获取列信息</span>
                columns = inspector.get_columns(table_name)
                
                <span class="hljs-comment"># 获取主键信息</span>
                pk_constraint = inspector.get_pk_constraint(table_name)
                primary_keys = <span class="hljs-built_in">set</span>(pk_constraint[<span class="hljs-string">"constrained_columns"</span>])
                           
                <span class="hljs-comment"># 获取索引信息</span>
                indexes = inspector.get_indexes(table_name)
                
                <span class="hljs-comment"># 获取外键信息</span>
                foreign_keys = inspector.get_foreign_keys(table_name)

                <span class="hljs-comment"># 格式化列信息</span>
                formatted_columns = []
                <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> columns:
                    col_info = {
                        <span class="hljs-string">"name"</span>: col[<span class="hljs-string">"name"</span>],
                        <span class="hljs-string">"type"</span>: <span class="hljs-built_in">str</span>(col[<span class="hljs-string">"type"</span>]),
                        <span class="hljs-string">"nullable"</span>: col[<span class="hljs-string">"nullable"</span>],
                        <span class="hljs-string">"default"</span>: col.get(<span class="hljs-string">"default"</span>),
                        <span class="hljs-string">"is_primary_key"</span>: col[<span class="hljs-string">"name"</span>] <span class="hljs-keyword">in</span> primary_keys
                    }
                    formatted_columns.append(col_info)

                schema_info = {
                    <span class="hljs-string">"table_name"</span>: table_name,
                    <span class="hljs-string">"columns"</span>: formatted_columns,
                    <span class="hljs-string">"primary_keys"</span>: <span class="hljs-built_in">list</span>(primary_keys),
                    <span class="hljs-string">"indexes"</span>: indexes,
                    <span class="hljs-string">"foreign_keys"</span>: foreign_keys,
                    <span class="hljs-string">"column_count"</span>: <span class="hljs-built_in">len</span>(columns)
                }

                <span class="hljs-keyword">return</span> schema_info
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"获取表结构信息失败: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>

</code></pre>
<h2 data-id="heading-3">第三步：execute_query() - 安全执行SQL查询</h2>
<p>最后这个功能是核心中的核心！让AI能执行SQL查询，但必须确保安全性。我们只允许SELECT查询，并且有完整的防护措施。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@mcp.tool(<span class="hljs-params">description=<span class="hljs-string">"安全执行SQL查询语句。只支持SELECT查询，自动添加结果限制，支持参数化查询防止SQL注入。"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_query</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span>, params: <span class="hljs-built_in">dict</span> = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> query <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> query.strip():
                <span class="hljs-keyword">return</span> <span class="hljs-string">"请提供查询语句"</span>
            
        db_mgr = get_database_manager()
        
        <span class="hljs-comment"># 如果没有提供参数，设为None</span>
        query_params = params <span class="hljs-keyword">if</span> params <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>

        <span class="hljs-comment"># 执行查询</span>
        result = db_mgr.execute_query(query.strip(), query_params)

        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> result:
                <span class="hljs-keyword">return</span> <span class="hljs-string">"查询结果为空"</span>
            
        <span class="hljs-comment">#格式化返结果</span>
        result_text = <span class="hljs-string">"查询结果:\n"</span>
        <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> result:
                result_text += <span class="hljs-string">f"<span class="hljs-subst">{row}</span>\n"</span>
                
        <span class="hljs-keyword">return</span> result_text
    
    <span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> e:
        <span class="hljs-comment"># 安全验证失败</span>
        error_msg = <span class="hljs-string">f"查询安全验证失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
        logger.warning(error_msg)
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{error_msg}</span>\n\n 提示：本工具只支持 SELECT 查询，且会自动添加安全限制。"</span>
        
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        error_msg = <span class="hljs-string">f"执行查询失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
        logger.error(error_msg)
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{error_msg}</span>"</span>
</code></pre>
<p>数据库管理器中也要有验证：</p>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_validate_query</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""验证查询安全性"""</span>
        query_upper = query.upper().strip()
        
        <span class="hljs-comment"># 检查危险的SQL操作</span>
        dangerous_keywords = [
            <span class="hljs-string">"DROP"</span>, <span class="hljs-string">"DELETE"</span>, <span class="hljs-string">"UPDATE"</span>, <span class="hljs-string">"INSERT"</span>, <span class="hljs-string">"ALTER"</span>, <span class="hljs-string">"CREATE"</span>, <span class="hljs-string">"TRUNCATE"</span>
        ]
        
        <span class="hljs-keyword">for</span> keyword <span class="hljs-keyword">in</span> dangerous_keywords:
            <span class="hljs-keyword">if</span> keyword <span class="hljs-keyword">in</span> query_upper:
                <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"查询包含危险操作: <span class="hljs-subst">{keyword}</span>"</span>)
        
        <span class="hljs-comment"># 检查是否是SELECT查询</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> query_upper.startswith(<span class="hljs-string">"SELECT"</span>):
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"只允许执行SELECT查询"</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_add_limit_to_query</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, limit: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""为查询添加LIMIT子句"""</span>
        query_upper = query.upper()
        
        <span class="hljs-comment"># 如果已经有LIMIT，不再添加</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">"LIMIT"</span> <span class="hljs-keyword">in</span> query_upper:
            <span class="hljs-keyword">return</span> query
        
        <span class="hljs-comment"># 添加LIMIT子句</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{query.rstrip(<span class="hljs-string">';'</span>)}</span> LIMIT <span class="hljs-subst">{limit}</span>"</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_query</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, params: <span class="hljs-built_in">dict</span> = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]:
        <span class="hljs-string">"""安全执行SQL查询"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 验证查询安全性</span>
            self._validate_query(query)
            
            <span class="hljs-comment"># 添加默认限制</span>
            limited_query = self._add_limit_to_query(query, <span class="hljs-number">1000</span>)
            
            <span class="hljs-keyword">with</span> self.get_connection() <span class="hljs-keyword">as</span> conn:
                <span class="hljs-keyword">if</span> params:
                    <span class="hljs-comment"># 使用参数化查询</span>
                    result = conn.execute(text(limited_query), params)
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-comment"># 直接执行查询</span>
                    result = conn.execute(text(limited_query))
                
                <span class="hljs-comment"># 获取列名</span>
                columns = result.keys()
                
                <span class="hljs-comment"># 转换为字典列表</span>
                rows = []
                <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> result:
                    row_dict = <span class="hljs-built_in">dict</span>(<span class="hljs-built_in">zip</span>(columns, row))
                    rows.append(row_dict)
                
                <span class="hljs-keyword">return</span> rows
                
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"执行查询失败: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>
</code></pre>
<h2 data-id="heading-4">第四步：功能验证测试</h2>
<p>为了确保所有功能都正常工作，我们创建一个简单的验证脚本。这不是复杂的单元测试，而是帮助读者快速验证功能的工具。</p>
<h3 data-id="heading-5">创建验证脚本</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
tests/verify_functions.py - 功能验证脚本
"""</span>

<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path

<span class="hljs-comment"># 添加项目路径</span>
project_root = Path(__file__).parent.parent
sys.path.insert(<span class="hljs-number">0</span>, <span class="hljs-built_in">str</span>(project_root / <span class="hljs-string">"src"</span>))

<span class="hljs-keyword">def</span> <span class="hljs-title function_">verify_database_connection</span>():
    <span class="hljs-string">"""验证数据库连接"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 数据库连接验证 ==="</span>)
    
    <span class="hljs-comment"># 设置数据库URL</span>
    db_path = project_root / <span class="hljs-string">"data"</span> / <span class="hljs-string">"test.db"</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> db_path.exists():
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"测试数据库不存在！"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
    
    os.environ[<span class="hljs-string">'DB_URL'</span>] = <span class="hljs-string">f'sqlite:///<span class="hljs-subst">{db_path}</span>'</span>
    
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">from</span> mcp_datatools.database <span class="hljs-keyword">import</span> DatabaseManager
        db_mgr = DatabaseManager()
        
        <span class="hljs-keyword">if</span> db_mgr.test_connection():
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"数据库连接成功"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"数据库连接失败"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"数据库连接错误: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">verify_basic_functions</span>():
    <span class="hljs-string">"""验证基础功能"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 基础功能验证 ==="</span>)
    
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">from</span> mcp_datatools.database <span class="hljs-keyword">import</span> DatabaseManager
        db_mgr = DatabaseManager()
        
        <span class="hljs-comment"># 测试1: 获取表名</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"1. 测试 list_tables() 功能..."</span>)
        tables = db_mgr.get_table_names()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"   找到 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(tables)}</span> 个表: <span class="hljs-subst">{<span class="hljs-string">', '</span>.join(tables)}</span>"</span>)
        
        <span class="hljs-comment"># 测试2: 搜索表名</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"2. 测试 filter_table_names() 功能..."</span>)
        user_tables = db_mgr.filter_table_names(<span class="hljs-string">'user'</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"   搜索 'user' 找到: <span class="hljs-subst">{user_tables}</span>"</span>)
        
        <span class="hljs-comment"># 测试3: 获取表结构</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"3. 测试 get_table_schema() 功能..."</span>)
        <span class="hljs-keyword">if</span> tables:
            schema = db_mgr.get_table_schema(tables[<span class="hljs-number">0</span>])
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  表 '<span class="hljs-subst">{tables[<span class="hljs-number">0</span>]}</span>' 有 <span class="hljs-subst">{schema[<span class="hljs-string">'column_count'</span>]}</span> 个列"</span>)
        
        <span class="hljs-comment"># 测试4: 执行查询</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"4. 测试 execute_query() 功能..."</span>)
        result = db_mgr.execute_query(<span class="hljs-string">"SELECT COUNT(*) as count FROM users"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"   查询结果: <span class="hljs-subst">{result}</span>"</span>)
        
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"功能验证失败: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-string">"""主验证流程"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"MCP DataTools 功能验证"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
    
    <span class="hljs-comment"># 验证数据库连接</span>
    db_ok = verify_database_connection()
    
    <span class="hljs-keyword">if</span> db_ok:
        <span class="hljs-comment"># 验证基础功能</span>
        func_ok = verify_basic_functions()
        
        <span class="hljs-keyword">if</span> func_ok:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n 所有基础功能验证通过！"</span>)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n部分功能验证失败，请检查代码"</span>)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n数据库连接失败，请先创建测试数据库"</span>)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"验证完成！现在可以在Cursor中测试MCP功能了。"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()
</code></pre>
<h3 data-id="heading-6">运行验证</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 确保有测试数据</span>
python data/init_sqlite_db.py

<span class="hljs-comment"># 2. 运行功能验证</span>
python tests/verify_functions.py
</code></pre>
<h3 data-id="heading-7">验证结果示例</h3>
<pre><code class="hljs language-css" lang="css">MCP DataTools 功能验证
==================================================
=== 数据库连接验证 ===
数据库连接成功

=== 基础功能验证 ===
<span class="hljs-number">1</span>. 测试 list_tables() 功能...
   找到 <span class="hljs-number">3</span> 个表: orders, products, users
<span class="hljs-number">2</span>. 测试 <span class="hljs-built_in">filter_table_names</span>() 功能...
   搜索 <span class="hljs-string">'user'</span> 找到: [<span class="hljs-string">'users'</span>]
<span class="hljs-number">3</span>. 测试 <span class="hljs-built_in">get_table_schema</span>() 功能...
  表 <span class="hljs-string">'orders'</span> 有 <span class="hljs-number">3</span> 个列
<span class="hljs-number">4</span>. 测试 <span class="hljs-built_in">execute_query</span>() 功能...
   查询结果: [{'count': <span class="hljs-number">2</span>}]

 所有基础功能验证通过！

==================================================
验证完成！现在可以在<span class="hljs-attribute">Cursor</span>中测试MCP功能了。
</code></pre>
<h2 data-id="heading-8">第五步：功能演示效果</h2>
<p>现在让我们看看这些功能在实际使用中的效果：</p>
<h3 data-id="heading-9">1. 智能搜索表名</h3>
<p>试试问AI："找找用户相关的表"</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9aaf1817a1142ec8d64fc5e6abd1ea3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57qi6by75a2Q5pe25Luj:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975226&amp;x-signature=hPNGGSq%2FZQ%2B3cOM94IJFedhU99g%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>或者问："有哪些订单相关的表？"</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60fdae4b2f1749a480ca74749740d2ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57qi6by75a2Q5pe25Luj:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975226&amp;x-signature=4KDTd474mpK00bfGShmovx4jfSc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-10">2. 深度解析表结构</h3>
<p>问AI："users表的结构是什么样的？"
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c616716b2b5147d4bc59acb8a43e501c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57qi6by75a2Q5pe25Luj:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975226&amp;x-signature=Hrpqg2FSTe%2BIpa8GZAIH4RFnCk8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-11">3. 安全执行SQL查询</h3>
<p><strong>简单查询：</strong> "查询users表中的所有数据"
AI执行：<code>SELECT * FROM users</code>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26ae800e66a84824ae826b4bb7fb35a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57qi6by75a2Q5pe25Luj:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975226&amp;x-signature=K%2FqXHYIrcTFNldQ5y6MPzx4A5Ro%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>条件查询：</strong> "查询价格大于1000的产品"
AI执行：<code>SELECT * FROM products WHERE price &gt; 1000</code>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f13e52213a844868bfc6f1846dbe91a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57qi6by75a2Q5pe25Luj:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975226&amp;x-signature=GBIBwNm1C4OwUo1XVpHhth0QS6A%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>复杂查询：</strong> "查询每个用户的订单数量"
AI可以执行JOIN查询
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f7057d74bcd404685a17c71b52e843d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57qi6by75a2Q5pe25Luj:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975226&amp;x-signature=tsGmtk4qNW2NMH%2FZlBtc1kkMrqY%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-12">总结与预告</h2>
<p>第2篇我们成功实现了3个核心功能：表搜索、结构分析、安全SQL执行，让AI能够理解数据库结构并执行复杂查询。第3篇将实现PostgreSQL、MySQL等主流数据库支持，加上基础连接池配置和Docker部署，让这个工具真正走向生产环境。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JobFlow 背后：五个让我豁然开朗的设计瞬间]]></title>    <link>https://juejin.cn/post/7585751355593506835</link>    <guid>https://juejin.cn/post/7585751355593506835</guid>    <pubDate>2025-12-22T02:31:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585751355593506835" data-draft-id="7585825055437488134" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JobFlow 背后：五个让我豁然开朗的设计瞬间"/> <meta itemprop="keywords" content="后端,架构,分布式"/> <meta itemprop="datePublished" content="2025-12-22T02:31:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JobFlow 背后：五个让我豁然开朗的设计瞬间
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:31:20.000Z" title="Mon Dec 22 2025 02:31:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🔗 开源地址与系列文章</h2>
<ul>
<li><strong>开源地址</strong>：<code>https://gitee.com/sh_wangwanbao/job-flow</code></li>
<li><strong>系列文章：</strong>
<ul>
<li><a href="https://juejin.cn/post/7583469866007969827" target="_blank" title="https://juejin.cn/post/7583469866007969827">第一篇：基于Nacos的轻量任务调度方案 —— 从 XXL-Job 的痛点说起</a></li>
<li><a href="https://juejin.cn/post/7584353612501106729" target="_blank" title="https://juejin.cn/post/7584353612501106729">第二篇：JobFlow 实现方案：云原生时代的任务调度新思路</a></li>
<li><a href="https://juejin.cn/post/7585727457472823296" target="_blank" title="https://juejin.cn/post/7585727457472823296">第三篇：JobFlow 实战：无锁调度是怎么做到的</a></li>
<li><a href="https://juejin.cn/editor/drafts/7585825055437488134" target="_blank" title="https://juejin.cn/editor/drafts/7585825055437488134">第四篇：JobFlow 背后：五个让我豁然开朗的设计瞬间</a></li>
<li>第五篇：分布式调度的终极难题：超时、补偿与漏调（统写中）</li>
<li>第六篇：延时队列的设计与实现（统写中）</li>
</ul>
</li>
</ul>
<h2 data-id="heading-1">前言</h2>
<p>昨天晚上折腾到12点，把 JobFlow 的延时队列功能测试完，看着日志里一条条任务准时执行，突然有种感觉：<strong>这个东西，想通了就很简单。</strong></p>
<p>从最开始被 XXL-Job 的两套注册中心搞得头疼，到决定自己写一个调度框架，再到核心功能开发完成，前后不到两周时间。不是因为我写代码有多快，而是想清楚了几个关键问题之后，代码几乎是自己长出来的。</p>
<p>这篇文章不讲具体的代码实现，那些技术细节后面会有专门的文章。今天想聊的是：<strong>这两周我是怎么想的，为什么会这么设计。</strong></p>
<p><strong>先说清楚适用边界：</strong></p>
<p>JobFlow 不是要替代 XXL-Job，而是在特定场景下的一个轻量级选择。</p>
<p>适合用 JobFlow 的场景：</p>
<ul>
<li>技术栈 all-in Spring Cloud Alibaba + Nacos</li>
<li>业务团队自己维护调度系统（不需要中间件团队）</li>
<li>业务型调度 + 延时任务（订单超时、数据同步、定时清理）</li>
<li>中小规模（百万级以下任务量）</li>
</ul>
<p>不适合用 JobFlow 的场景：</p>
<ul>
<li>需要 Web 管理后台（JobFlow 没有 UI，通过数据库和配置文件管理）</li>
<li>跨公司、多租户的通用调度平台</li>
<li>强 SLA 的金融核心任务（秒级精度保证）</li>
<li>超大规模 Cron 平台（需要分库分表）</li>
</ul>
<p>如果你的场景不在上面的"适合"列表里，建议直接用 XXL-Job，功能完整、社区成熟。</p>
<p>好，边界说清楚了，开始正文。</p>
<p>写这篇文章有点冒险，因为不够"专业"。没有严谨的理论推导，没有完整的性能测试报告，就是记录一些想法和感悟。但我觉得这种"想通了"的过程，可能比代码本身更有价值。</p>
<h2 data-id="heading-2">痛点：两套注册中心的割裂感</h2>
<p>事情的起因很简单：我们的微服务用的是 Spring Cloud Alibaba + Nacos，项目里要加定时任务，自然就想到了 XXL-Job。</p>
<p>装上，配好，跑起来，一切正常。但用了一段时间之后，总觉得哪里别扭。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph Nacos体系
        N[Nacos&lt;br/&gt;服务发现]
        S1[订单服务]
        S2[用户服务]
        S3[支付服务]
    end
    
    subgraph XXL-Job体系
        A[XXL-Job Admin&lt;br/&gt;调度中心]
        E1[订单服务&lt;br/&gt;Executor]
        E2[用户服务&lt;br/&gt;Executor]
    end
    
    S1 --&gt; N
    S2 --&gt; N
    S3 --&gt; N
    
    E1 --&gt; A
    E2 --&gt; A
    
    S1 -.同一个应用.-&gt; E1
    S2 -.同一个应用.-&gt; E2
    
    style N fill:#90EE90
    style A fill:#FFB6C1
</code></pre>
<p>问题在哪？</p>
<p><strong>同一个服务，在 Nacos 里注册一次，在 XXL-Job 里又要注册一次。</strong></p>
<p>某天下午，订单服务在 Nacos 里显示下线了，运维同学说机器重启了。但 XXL-Job 的管理后台上，订单服务的执行器还是在线状态，定时任务还在往这个已经挂掉的实例上调度。</p>
<p>排查了半天才发现，XXL-Job 的心跳检测间隔比 Nacos 长，所以摘除得慢。</p>
<p>当时就在想：<strong>为什么要维护两套状态？</strong></p>
<p>还有个问题：排查任务执行失败的时候，得先去 XXL-Job 的管理后台查调度日志，然后再去 ELK 查执行器的业务日志。两个日志系统之间没有关联，只能靠时间戳对。</p>
<p>有一次半夜被叫起来排查问题，任务调度时间是凌晨 2:00:01，执行器日志是 2:00:03，中间差了 2 秒。这 2 秒里发生了什么？不知道。调度器到执行器之间的链路断了，查不到。</p>
<p><strong>两套注册中心，两套日志体系，割裂的。</strong></p>
<h2 data-id="heading-3">第一个想法：能不能只用 Nacos？</h2>
<p>周末在家躺着，脑子里一直在想这个问题。</p>
<p>XXL-Job 为什么要自己搞一套注册中心？因为它要做成通用的任务调度平台，不能绑定在某个具体的服务发现组件上。这个逻辑没问题，但对我们这种已经 all-in Nacos 的项目来说，就是重复建设了。</p>
<p><strong>如果调度器也是一个普通的微服务，直接注册到 Nacos 上呢？</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph Nacos统一体系
        N[Nacos]
        
        subgraph 调度层
            J1[JobFlow&lt;br/&gt;Scheduler-1]
            J2[JobFlow&lt;br/&gt;Scheduler-2]
        end
        
        subgraph 业务层
            S1[订单服务-1]
            S2[订单服务-2]
            S3[用户服务-1]
        end
    end
    
    J1 --&gt; N
    J2 --&gt; N
    S1 --&gt; N
    S2 --&gt; N
    S3 --&gt; N
    
    J1 -.发现服务.-&gt; N
    J1 --&gt; |HTTP调用| S1
    J1 --&gt; |HTTP调用| S2
    
    style N fill:#90EE90
</code></pre>
<p>这个想法一出来，后面的设计就顺了。</p>
<p>调度器不是独立的平台，而是业务中台的一部分：</p>
<ul>
<li>和业务服务部署在同一个 K8s 集群</li>
<li>用同一套 Prometheus 监控</li>
<li>日志输出到同一个 ELK</li>
<li>通过 Nacos 发现业务服务</li>
</ul>
<p><strong>不需要单独的管理后台，不需要单独的运维团队，业务团队自己就能维护。</strong></p>
<p>这个思路确定下来，很多问题就迎刃而解了。</p>
<h2 data-id="heading-4">第二个想法：调度器多实例怎么办？</h2>
<p>调度器是个微服务，那肯定要多实例部署（高可用）。问题来了：</p>
<pre><code class="hljs">假设部署 3 个调度器实例
有 50 个定时任务
每分钟都要执行

如果 3 个实例都去调度这 50 个任务
→ 每个任务会被调度 3 次
→ 重复执行
</code></pre>
<p>传统方案是用分布式锁：3 个实例去数据库抢锁，抢到的才能调度。</p>
<p>但这样有个问题：</p>
<pre><code class="hljs language-diff" lang="diff">每分钟：
<span class="hljs-deletion">- 3 个实例 × 50 个任务 = 150 次数据库 UPDATE</span>
<span class="hljs-deletion">- 但只有 50 次是有效的</span>
<span class="hljs-deletion">- 另外 100 次是浪费</span>

一天下来：
<span class="hljs-deletion">- 144,000 次无效操作</span>
</code></pre>
<p>周日晚上吃完饭，在阳台抽烟的时候想到一个点：<strong>为什么一定要抢锁？</strong></p>
<p>3 个实例都去抢，本质上是因为它们不知道自己该不该执行这个任务。那如果让每个实例自己算出来呢？</p>
<pre><code class="hljs language-diff" lang="diff">调度器实例列表（从 Nacos 拿到）：
<span class="hljs-deletion">- scheduler-001</span>
<span class="hljs-deletion">- scheduler-002  </span>
<span class="hljs-deletion">- scheduler-003</span>

任务列表：
<span class="hljs-deletion">- orderSync</span>
<span class="hljs-deletion">- userClean</span>
<span class="hljs-deletion">- reportGen</span>

分配规则：
<span class="hljs-deletion">- "orderSync".hashCode() % 3 = 0 → scheduler-001 负责</span>
<span class="hljs-deletion">- "userClean".hashCode() % 3 = 2 → scheduler-003 负责</span>
<span class="hljs-deletion">- "reportGen".hashCode() % 3 = 1 → scheduler-002 负责</span>
</code></pre>
<p><strong>每个实例自己算，算完之后只执行自己负责的任务，不需要去抢锁。</strong></p>
<p>这就是 Hash 分区 + Owner 判定。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph 传统方案
        A1[实例1] --&gt; L[分布式锁]
        A2[实例2] --&gt; L
        A3[实例3] --&gt; L
        L --&gt; T[任务执行]
    end
    
    subgraph JobFlow方案
        B1[实例1&lt;br/&gt;算出负责 A,D,G] --&gt; T1[执行 A,D,G]
        B2[实例2&lt;br/&gt;算出负责 B,E,H] --&gt; T2[执行 B,E,H]
        B3[实例3&lt;br/&gt;算出负责 C,F,I] --&gt; T3[执行 C,F,I]
    end
</code></pre>
<p>代码写起来也很简单：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 从 Nacos 获取所有调度器实例</span>
List&lt;Instance&gt; instances = namingService.getAllInstances(serviceName);

<span class="hljs-comment">// 排序（关键！所有实例看到的顺序要一致）</span>
instances.sort(Comparator.comparing(i -&gt; i.getIp() + <span class="hljs-string">":"</span> + i.getPort()));

<span class="hljs-comment">// 计算任务归谁</span>
<span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> Math.abs(jobName.hashCode());
<span class="hljs-type">int</span> <span class="hljs-variable">targetIndex</span> <span class="hljs-operator">=</span> hash % instances.size();

<span class="hljs-comment">// 判断是不是我</span>
<span class="hljs-keyword">return</span> currentIndex == targetIndex;
</code></pre>
<p>想通这个之后，我知道这事能成了。</p>
<h2 data-id="heading-5">第三个想法：会不会漏调？</h2>
<p>无锁设计解决了重复执行的问题，但带来了新问题：<strong>会不会漏调？</strong></p>
<pre><code class="hljs language-diff" lang="diff">场景：3 个调度器实例
<span class="hljs-deletion">- scheduler-001 负责 orderSync</span>
<span class="hljs-deletion">- scheduler-002 负责 userClean</span>
<span class="hljs-deletion">- scheduler-003 负责 reportGen</span>

如果 scheduler-001 挂了：
<span class="hljs-deletion">- Nacos 检测到（约 15 秒）</span>
<span class="hljs-deletion">- scheduler-002 和 003 重新计算 Hash</span>
<span class="hljs-deletion">- scheduler-002 接管 orderSync</span>

但这 15 秒内，orderSync 如果到期了呢？
→ 漏调了
</code></pre>
<p>这是无锁设计的代价。</p>
<p><strong>说清楚：我们牺牲了什么</strong></p>
<p>为了追求无锁的性能，我们放弃了一些东西：</p>
<p>放弃的保证：</p>
<ul>
<li>精确到秒的强保证 → 可能延迟 3-5 分钟（巡检周期）</li>
<li>调度瞬时一致性 → 实例切换期间可能漏调</li>
<li>完全无 DB 依赖 → 唯一索引兜底仍需数据库</li>
</ul>
<p>换来的好处：</p>
<ul>
<li>数据库压力降低 67%</li>
<li>无分布式锁开销</li>
<li>实例扩缩容自动生效</li>
</ul>
<p>这是典型的分布式权衡：<strong>不追求完美的一致性，而是用异步补偿换取更好的性能。</strong></p>
<p>周一上午写代码的时候一直在想这个问题。中午吃饭的时候突然想明白了：<strong>用巡检补偿。</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph 正常流程
        A[Hash分区] --&gt; B[Owner判定]
        B --&gt; C[执行任务]
    end
    
    subgraph 异常流程
        D[巡检任务&lt;br/&gt;最小节点负责] --&gt; E[扫描数据库]
        E --&gt; F{应该执行&lt;br/&gt;但没执行?}
        F --&gt; |是| G[补偿触发]
        F --&gt; |否| H[跳过]
    end
    
    C --&gt; |99%情况| I[任务完成]
    G --&gt; |1%情况| I
</code></pre>
<p>具体怎么做：</p>
<pre><code class="hljs language-markdown" lang="markdown">最小节点负责巡检（选主规则很简单）：
<span class="hljs-bullet">1.</span> 从 Nacos 获取所有实例
<span class="hljs-bullet">2.</span> 排序
<span class="hljs-bullet">3.</span> 最小的那个就是 Leader

巡检任务每 3 分钟执行一次：
<span class="hljs-bullet">1.</span> 查询所有启用的任务
<span class="hljs-bullet">2.</span> 判断：应该执行但没执行
<span class="hljs-bullet">3.</span> 补偿触发

即使漏调了，最多延迟 3 分钟
</code></pre>
<p>这是分布式系统的经典做法：<strong>正常流程追求效率，异常流程追求可靠性。</strong></p>
<p>周一下午把这块代码写完，测试了一下：停掉一个调度器实例，任务确实在 15 秒左右切换过去了；停掉所有实例再启动，巡检任务会补偿执行。</p>
<p>心里踏实了。</p>
<h2 data-id="heading-6">第四个想法：固定分片的妙处</h2>
<p>任务调度还有个常见场景：大数据量的批处理。</p>
<p>比如每天凌晨要给 100 万用户发推送，怎么办？</p>
<p>传统做法是动态分片：调度器根据执行器实例数，动态分配任务范围。比如有 10 个执行器实例，就分成 10 片。</p>
<p>但这样有个问题：</p>
<pre><code class="hljs language-diff" lang="diff">场景：10 个执行器实例，100 万用户

调度时刻：
<span class="hljs-deletion">- 实例 1 负责 0-10 万</span>
<span class="hljs-deletion">- 实例 2 负责 10-20 万</span>
<span class="hljs-deletion">- ...</span>

如果实例 5 挂了：
<span class="hljs-deletion">- 剩余 9 个实例</span>
<span class="hljs-deletion">- 需要重新分片：0-11.1 万、11.1-22.2 万...</span>
<span class="hljs-deletion">- 但已经在执行的分片怎么办？</span>
</code></pre>
<p>周二晚上在家想这个问题，想了很久。</p>
<p>周三早上洗澡的时候突然想通了：<strong>固定分片 + 回调驱动。</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">任务配置：固定 100 个分片（和实例数无关）

执行流程：
<span class="hljs-bullet">1.</span> 调度器创建 100 条分片记录（PENDING 状态）
<span class="hljs-bullet">2.</span> 初始分配：min(分片数, 实例数) 个分片
<span class="hljs-bullet">3.</span> 执行器执行完一个分片，回调调度器
<span class="hljs-bullet">4.</span> 调度器 CAS 更新状态，分配下一个 PENDING 分片
<span class="hljs-bullet">5.</span> 继续循环，直到所有分片完成
</code></pre>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant S as 调度器
    participant E1 as 执行器1
    participant E2 as 执行器2
    participant DB as 数据库
    
    S-&gt;&gt;DB: 创建100个分片&lt;br/&gt;状态=PENDING
    S-&gt;&gt;DB: CAS更新分片0&lt;br/&gt;PENDING→RUNNING
    S-&gt;&gt;E1: 执行分片0
    S-&gt;&gt;DB: CAS更新分片1&lt;br/&gt;PENDING→RUNNING
    S-&gt;&gt;E2: 执行分片1
    
    E1-&gt;&gt;E1: 执行业务逻辑
    E1-&gt;&gt;S: 回调：分片0完成
    S-&gt;&gt;DB: 更新分片0&lt;br/&gt;RUNNING→SUCCESS
    S-&gt;&gt;DB: CAS更新分片2&lt;br/&gt;PENDING→RUNNING
    S-&gt;&gt;E1: 执行分片2
    
    E2-&gt;&gt;E2: 执行业务逻辑
    E2-&gt;&gt;S: 回调：分片1完成
    S-&gt;&gt;DB: 更新分片1&lt;br/&gt;RUNNING→SUCCESS
    S-&gt;&gt;DB: CAS更新分片3&lt;br/&gt;PENDING→RUNNING
    S-&gt;&gt;E2: 执行分片3
</code></pre>
<p>这个设计的好处：</p>
<p><strong>1. 固定分片，不受实例数影响</strong></p>
<pre><code class="hljs">100 个分片，10 个实例：每个实例平均 10 个分片
100 个分片，5 个实例：每个实例平均 20 个分片
100 个分片，20 个实例：每个实例平均 5 个分片

分片数是固定的，实例数可以动态变化
</code></pre>
<p><strong>2. 回调驱动，动态负载均衡</strong></p>
<pre><code class="hljs">快的实例多执行几个分片
慢的实例少执行几个分片
自动负载均衡，不需要预先计算
</code></pre>
<p><strong>3. 状态可查，进度透明</strong></p>
<pre><code class="hljs language-diff" lang="diff">数据库里有每个分片的状态：
<span class="hljs-deletion">- PENDING：等待执行</span>
<span class="hljs-deletion">- RUNNING：执行中</span>
<span class="hljs-deletion">- SUCCESS：成功</span>
<span class="hljs-deletion">- FAILED：失败</span>

随时可以看到任务进度
</code></pre>
<p><strong>4. 断点续传，失败重试</strong></p>
<pre><code class="hljs language-diff" lang="diff">如果某个分片失败了：
<span class="hljs-deletion">- 状态标记为 FAILED</span>
<span class="hljs-deletion">- 巡检任务会重试</span>
<span class="hljs-deletion">- 重试次数可控</span>

不会因为一个分片失败，整个任务重来
</code></pre>
<p>这个设计想通了之后，代码写起来特别顺。父子记录结构、CAS 乐观锁、回调接口，一天就写完了。</p>
<h2 data-id="heading-7">第五个想法：TraceId 的威力</h2>
<p>前面说了，排查问题的时候，调度器和执行器的日志是割裂的。这个问题怎么解决？</p>
<p>周四上午在写日志的时候，突然想到一个点：<strong>能不能让 TraceId 从调度器贯穿到执行器？</strong></p>
<p>TraceId 的设计很简单：</p>
<pre><code class="hljs language-diff" lang="diff">格式：yyyyMMddHHmmss-shortuuid-shardindex

示例：
<span class="hljs-deletion">- 父记录：20241221100000-a1b2c3d4</span>
<span class="hljs-deletion">- 分片 0：20241221100000-a1b2c3d4-0</span>
<span class="hljs-deletion">- 分片 1：20241221100000-a1b2c3d4-1</span>
</code></pre>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[调度器创建TraceId&lt;br/&gt;20241221100000-a1b2c3d4] --&gt; B[HTTP Header传递]
    B --&gt; C[执行器接收TraceId]
    C --&gt; D[MDC.put]
    D --&gt; E[业务日志自动带上TraceId]
    
    E --&gt; F[ELK收集]
    F --&gt; G[搜索TraceId&lt;br/&gt;看到完整链路]
</code></pre>
<p>实际效果：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 调度器日志</span>
2024-12-21 10:00:00.123 <span class="hljs-section">[traceId=20241221100000-a1b2c3d4]</span> 
触发任务执行，<span class="hljs-attr">jobName</span>=orderSync

2024-12-21 10:00:00.456 <span class="hljs-section">[traceId=20241221100000-a1b2c3d4-0]</span> 
调用执行器，<span class="hljs-attr">url</span>=http://order-service:<span class="hljs-number">8081</span>/internal/job/orderSync

<span class="hljs-comment"># 执行器日志</span>
2024-12-21 10:00:00.600 <span class="hljs-section">[traceId=20241221100000-a1b2c3d4-0]</span> 
接收到任务请求，<span class="hljs-attr">handler</span>=orderSync

2024-12-21 10:00:01.800 <span class="hljs-section">[traceId=20241221100000-a1b2c3d4-0]</span> 
查询订单数据，<span class="hljs-attr">count</span>=<span class="hljs-number">1523</span>

2024-12-21 10:00:05.000 <span class="hljs-section">[traceId=20241221100000-a1b2c3d4-0]</span> 
任务执行完成，<span class="hljs-attr">duration</span>=<span class="hljs-number">4300</span>ms
</code></pre>
<p>在 ELK 里搜 <code>traceId="20241221100000-a1b2c3d4*"</code>，调度器和执行器的日志全出来了，按时间排序，完整链路一目了然。</p>
<p>这个设计成本几乎为零（就是在 HTTP Header 里加个字段），但价值巨大。</p>
<p><strong>日志打通了，排查问题的效率至少提升 10 倍。</strong></p>
<h2 data-id="heading-8">延时队列：复用的艺术</h2>
<p>周五上午，正在写文档的时候，看到一篇博客讲延时队列的实现。突然想到：<strong>我们的架构可以很快融入延时队列功能。</strong></p>
<p>为什么？因为 JobFlow 已经有了所有需要的基础设施：</p>
<pre><code class="hljs language-markdown" lang="markdown">延时队列需要什么：
<span class="hljs-bullet">1.</span> 定时扫描机制 → 已经有了（周期任务扫描）
<span class="hljs-bullet">2.</span> 服务发现 → 已经有了（Nacos）
<span class="hljs-bullet">3.</span> HTTP 调用 → 已经有了（调用执行器）
<span class="hljs-bullet">4.</span> TraceId 追踪 → 已经有了（全链路日志）
<span class="hljs-bullet">5.</span> 数据库存储 → 已经有了（MySQL）

新增什么：
<span class="hljs-bullet">1.</span> 独立的 job<span class="hljs-emphasis">_delay_</span>task 表
<span class="hljs-bullet">2.</span> 一次性执行的逻辑
<span class="hljs-bullet">3.</span> JSON Payload 透传
<span class="hljs-bullet">4.</span> 指数退避重试
</code></pre>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph 延时队列
        A[业务代码] --&gt; B[提交延时任务&lt;br/&gt;bizUuid + executeTime]
        B --&gt; C[(job_delay_task表)]
    end
    
    subgraph JobFlow基础设施
        D[定时扫描&lt;br/&gt;每5秒] --&gt; C
        C --&gt; E{到期?}
        E --&gt; |是| F[Nacos发现服务]
        F --&gt; G[HTTP调用执行器]
        G --&gt; H[TraceId追踪]
        H --&gt; I[执行器处理]
        I --&gt; J[回调更新状态]
    end
    
    J --&gt; K{成功?}
    K --&gt; |是| L[删除任务]
    K --&gt; |否| M[指数退避重试]
</code></pre>
<p>周五下午花了 3 个小时，把延时队列写完了。测试了一下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 业务代码</span>
delayTaskService.submit(DelayTask.builder()
    .bizUuid(<span class="hljs-string">"order_timeout_"</span> + orderId)
    .serviceName(<span class="hljs-string">"order-service"</span>)
    .handler(<span class="hljs-string">"orderTimeoutHandler"</span>)
    .executeTime(LocalDateTime.now().plusMinutes(<span class="hljs-number">30</span>))
    .payloadJson(JSON.toJSONString(Map.of(<span class="hljs-string">"orderId"</span>, orderId)))
    .build());

<span class="hljs-comment">// 30 分钟后</span>
<span class="hljs-comment">// 执行器自动收到调用</span>
<span class="hljs-meta">@JobHandler("orderTimeoutHandler")</span>
<span class="hljs-keyword">public</span> JobResult <span class="hljs-title function_">orderTimeout</span><span class="hljs-params">(JobContext context)</span> {
    Map&lt;String, Object&gt; payload = JSON.parseObject(
        context.getPayloadJson(), Map.class);
    <span class="hljs-type">Long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> (Long) payload.get(<span class="hljs-string">"orderId"</span>);
    
    <span class="hljs-comment">// 取消订单</span>
    orderService.cancel(orderId);
    
    <span class="hljs-keyword">return</span> JobResult.success();
}
</code></pre>
<p>完美。</p>
<p><strong>这就是复用的威力：基础设施搭好了，新功能几乎是自己长出来的。</strong></p>
<h2 data-id="heading-9">写代码的节奏</h2>
<p>回顾一下这两周的开发过程：</p>
<pre><code class="hljs language-objectivec" lang="objectivec">第一周（思考为主）：
周末：想清楚核心设计（Nacos + Hash分区）
周一：写 Owner 判定 + 定时扫描
周二：写固定分片 + 回调驱动
周三：写 TraceId + HTTP 调用
周四：写巡检补偿
周五：测试 + 修 Bug

第二周（完善功能）：
周一：优化 <span class="hljs-built_in">CAS</span> 逻辑
周二：完善超时确认
周三：写低频任务漏调检测
周四：写文档
周五：延时队列（意外之喜）
</code></pre>
<p>代码量其实不大，核心功能 3000 行左右。但设计想清楚之后，代码写起来特别快。</p>
<p><strong>很多时候不是代码难写，而是没想清楚。想清楚了，代码几乎是一气呵成的。</strong></p>
<h2 data-id="heading-10">几个关键突破</h2>
<p>回过头看，这两周有几个关键的思维突破：</p>
<h3 data-id="heading-11">1. 调度器即业务</h3>
<p><strong>不要把调度器当成独立的平台，而是当成业务中台的一部分。</strong></p>
<p>这个突破带来的好处：</p>
<ul>
<li>复用 Nacos，零额外依赖</li>
<li>复用监控日志，零运维成本</li>
<li>业务团队自己维护，零沟通成本</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph 传统思维
        A[调度平台&lt;br/&gt;独立部署] -.调用.-&gt; B[业务服务]
    end
    
    subgraph JobFlow思维
        C[调度器&lt;br/&gt;普通微服务]
        D[业务服务]
        E[消息中台]
        F[数据中台]
    end
    
    C --&gt; G[Nacos]
    D --&gt; G
    E --&gt; G
    F --&gt; G
</code></pre>
<h3 data-id="heading-12">2. 固定分片的简单</h3>
<p><strong>不要动态分片，固定分片数量，让回调驱动分配。</strong></p>
<p>这个突破带来的好处：</p>
<ul>
<li>不受实例数影响</li>
<li>自动负载均衡</li>
<li>状态可查可控</li>
<li>断点续传</li>
</ul>
<pre><code class="hljs language-diff" lang="diff">动态分片的复杂：
<span class="hljs-deletion">- 实例数变了，分片要重新计算</span>
<span class="hljs-deletion">- 计算逻辑复杂</span>
<span class="hljs-deletion">- 状态难以追踪</span>

固定分片的简单：
<span class="hljs-deletion">- 分片数固定</span>
<span class="hljs-deletion">- 回调驱动</span>
<span class="hljs-deletion">- 状态清晰</span>
</code></pre>
<h3 data-id="heading-13">3. 无锁的代价与补偿</h3>
<p><strong>不要追求完美的无锁，而是接受代价，用补偿解决。</strong></p>
<p>这个突破带来的好处：</p>
<ul>
<li>性能好（无锁）</li>
<li>可靠性高（补偿）</li>
<li>设计清晰（分层）</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[正常流程&lt;br/&gt;Hash分区&lt;br/&gt;99%情况] --&gt; C[任务执行]
    B[异常流程&lt;br/&gt;巡检补偿&lt;br/&gt;1%情况] --&gt; C
    
    style A fill:#90EE90
    style B fill:#FFB6C1
</code></pre>
<h3 data-id="heading-14">4. 复用的威力</h3>
<p><strong>不要重复造轮子，能复用就复用。</strong></p>
<p>这个突破带来的好处：</p>
<ul>
<li>Nacos 服务发现 → 复用</li>
<li>HTTP 调用 → 复用</li>
<li>TraceId 追踪 → 复用</li>
<li>监控日志 → 复用</li>
</ul>
<p>延时队列为什么能 3 小时写完？因为 90% 的代码都是复用的。</p>
<h2 data-id="heading-15">一些启示</h2>
<h3 data-id="heading-16">启示一：想清楚比写代码重要</h3>
<p>这两周，真正写代码的时间可能只有 30%，70% 的时间在想设计。</p>
<p>但正是这 70% 的思考，让 30% 的编码变得简单。</p>
<p><strong>架构设计不是拍脑袋，是一个持续思考、推翻重来、逐步清晰的过程。</strong></p>
<h3 data-id="heading-17">启示二：简单的设计更可靠</h3>
<p>最开始想过很多复杂的方案：</p>
<ul>
<li>用 Raft 协议选主</li>
<li>用 Redisson 分布式锁</li>
<li>用 ZooKeeper 协调</li>
</ul>
<p>后来发现，这些都不需要：</p>
<ul>
<li>选主？最小节点就是 Leader</li>
<li>分布式锁？Hash 分区 + 数据库兜底</li>
<li>协调？Nacos 服务发现就够了</li>
</ul>
<p><strong>复杂的方案不一定更好，简单的方案往往更可靠。</strong></p>
<h3 data-id="heading-18">启示三：分布式的本质是权衡</h3>
<p>无锁设计很快，但可能漏调 → 用巡检补偿
固定分片很简单，但可能不均匀 → 用回调驱动负载均衡
数据库兜底很可靠，但有性能损耗 → 99% 的场景无损耗</p>
<p><strong>没有完美的方案，只有合适的权衡。</strong></p>
<pre><code class="hljs language-diff" lang="diff">分布式系统的权衡：
<span class="hljs-deletion">- 性能 vs 一致性</span>
<span class="hljs-deletion">- 简单 vs 完美</span>
<span class="hljs-deletion">- 效率 vs 可靠</span>

关键是：知道自己在权衡什么，为什么这么权衡
</code></pre>
<h3 data-id="heading-19">启示四：复用是最大的创新</h3>
<p>延时队列不是新功能，但复用 JobFlow 的基础设施，就能很快实现。</p>
<p><strong>创新不一定是发明新东西，把已有的东西组合好，也是创新。</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[基础设施] --&gt; B[周期任务]
    A --&gt; C[延时队列]
    A --&gt; D[分片调度]
    A --&gt; E[巡检补偿]
    
    A --&gt; |Nacos| F[服务发现]
    A --&gt; |HTTP| G[远程调用]
    A --&gt; |TraceId| H[链路追踪]
    A --&gt; |MySQL| I[状态存储]
</code></pre>
<h3 data-id="heading-20">启示五：分布式就是这么回事</h3>
<p>回到开头那个问题：<strong>分布式到底在搞什么？</strong></p>
<p>做完 JobFlow 之后，我的答案是：</p>
<pre><code class="hljs language-markdown" lang="markdown">分布式就是在解决这些问题：
<span class="hljs-bullet">1.</span> 数据怎么复制（日志复制）
<span class="hljs-bullet">2.</span> 故障怎么切换（主从切换、Hash分区）
<span class="hljs-bullet">3.</span> 状态怎么同步（Nacos、数据库）
<span class="hljs-bullet">4.</span> 任务怎么分配（分片、负载均衡）
<span class="hljs-bullet">5.</span> 异常怎么处理（补偿、重试）
</code></pre>
<p>xxl-job 也好，RocketMQ 也好，Redis Cluster 也好，本质上都是在解决这些问题。</p>
<p><strong>想通了这些，再去看任何分布式系统，都能看到相同的影子。</strong></p>
<h2 data-id="heading-21">写在最后</h2>
<p>这两周开发 JobFlow 的经历，对我来说是一次思维突破。</p>
<p>不是说我做出了多么厉害的东西，而是想清楚了一些以前模糊的点：</p>
<ul>
<li>为什么要这么设计</li>
<li>设计的边界在哪里</li>
<li>什么时候该权衡什么</li>
</ul>
<p>这些东西，书上很难学到。它来自于实践，来自于思考，来自于一次次的推翻重来。</p>
<p>JobFlow 现在还很简陋：</p>
<ul>
<li>没有 Web 管理后台</li>
<li>没有完善的监控面板</li>
<li>没有丰富的路由策略</li>
</ul>
<p>但核心的设计理念是清晰的：</p>
<ul>
<li>复用优于重造</li>
<li>轻量级优先</li>
<li>高性价比容错</li>
</ul>
<p>后面会继续完善功能，但这个核心不会变。</p>
<h3 data-id="heading-22">如果重来一次</h3>
<p>写完之后，回过头看，有些地方我会换个做法：</p>
<p><strong>会保留的设计：</strong></p>
<ul>
<li>Hash 分区 + Owner 判定：这个设计经过验证，非常稳定</li>
<li>固定分片 + 回调驱动：比动态分片简单太多</li>
<li>TraceId 全链路追踪：成本低，价值大</li>
</ul>
<p><strong>会调整的设计：</strong></p>
<ul>
<li>巡检补偿的周期：3 分钟可能太长，应该做成可配置的</li>
<li>数据库表结构：父子记录有些字段是冗余的，可以优化</li>
<li>超时确认逻辑：现在的"反向询问"实现有点重，可以简化</li>
</ul>
<p><strong>写早了的代码：</strong></p>
<ul>
<li>低频任务漏调检测：这个功能用的人很少，应该后面再加</li>
<li>分片策略抽象：现在只有 MOD_HASH 一种，抽象层有点过度设计</li>
</ul>
<p><strong>后悔没做的：</strong></p>
<ul>
<li>单元测试：开发太快，测试覆盖不够，后面补测试很痛苦</li>
<li>配置校验：很多配置没做合法性检查，上线后才发现问题</li>
<li>监控指标：应该一开始就把 Prometheus 指标设计好</li>
</ul>
<p>这些反思，会在后续的迭代中慢慢调整。</p>
<p><strong>最重要的收获：</strong></p>
<p>分布式系统的设计，本质上是在做权衡：</p>
<ul>
<li>我接受什么代价</li>
<li>我换取什么好处</li>
<li>我用什么兜底</li>
</ul>
<p>想清楚这三点，代码自然就清晰了。</p>
<hr/>
<p><strong>最后想问问大家：</strong></p>
<p>你在做架构设计的时候，有没有类似的"突然想通"的时刻？</p>
<p>是什么让你想通的？一个具体的场景？一次失败的教训？还是某个偶然的灵感？</p>
<p>欢迎评论区聊聊。</p>
<p>架构这东西，很多时候不是看书看出来的，是踩坑踩出来的，是想出来的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[静态内容页该用HTML还是Next.js展示更好]]></title>    <link>https://juejin.cn/post/7585789195869782052</link>    <guid>https://juejin.cn/post/7585789195869782052</guid>    <pubDate>2025-12-22T02:33:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585789195869782052" data-draft-id="7586481379589914643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="静态内容页该用HTML还是Next.js展示更好"/> <meta itemprop="keywords" content="Next.js,HTML,前端"/> <meta itemprop="datePublished" content="2025-12-22T02:33:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            静态内容页该用HTML还是Next.js展示更好
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:33:25.000Z" title="Mon Dec 22 2025 02:33:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🧩 一、底层原理：两者到底在“生成什么”</h2>























<table><thead><tr><th align="left">技术</th><th align="left">核心机制</th><th align="left">输出形态</th><th align="left">架构思想</th></tr></thead><tbody><tr><td align="left"><strong>HTML</strong></td><td align="left">静态文件，浏览器直接渲染</td><td align="left"><code>.html</code> 文件 + 资源（CSS/JS）</td><td align="left">“写好了，就摆在那里”</td></tr><tr><td align="left"><strong>Next.js</strong></td><td align="left">React框架 + 渲染引擎（SSR/SSG/ISR）</td><td align="left">动态或预生成的HTML</td><td align="left">“根据数据和逻辑生成页面”</td></tr></tbody></table>
<h3 data-id="heading-1">💡理解重点：</h3>
<ul>
<li>HTML → 就像一本印好的书：内容确定、维护简单、永远高速。</li>
<li>Next.js → 像一台印刷机：可以随时重印、加内容、换封面。</li>
</ul>
<p>👉 若你确定内容永远不变，那HTML就够了。<br/>
👉 若内容随时间或数据变化，Next.js更合适。</p>
<hr/>
<h2 data-id="heading-2">⚙️ 二、从性能角度看：静态=快？不总是！</h2>
<p>现代Web性能已不只是“有多快”，而是“<strong>在不同情境下保持一致的快</strong>”。</p>



































<table><thead><tr><th align="left">场景</th><th align="left">HTML</th><th align="left">Next.js (SSG)</th><th align="left">Next.js (SSR)</th></tr></thead><tbody><tr><td align="left"><strong>首屏加载</strong></td><td align="left">🚀 极快</td><td align="left">🚀 几乎一样快</td><td align="left">🐢 稍慢（服务器渲染）</td></tr><tr><td align="left"><strong>CDN缓存分发</strong></td><td align="left">✅ 易实现</td><td align="left">✅ 可静态导出</td><td align="left">⚠️ 动态内容较难缓存</td></tr><tr><td align="left"><strong>动态更新</strong></td><td align="left">❌ 需要重新部署</td><td align="left">✅ SSG + revalidate</td><td align="left">✅ SSR即时更新</td></tr><tr><td align="left"><strong>维护成本</strong></td><td align="left">🪶 极低</td><td align="left">🧩 中等（依赖框架）</td><td align="left">🧩 较高（需要服务端）</td></tr></tbody></table>
<blockquote>
<p>如果你要维护一个<strong>纯内容型博客</strong>、<strong>文档中心</strong>、或<strong>品牌展示页</strong>：</p>
<ul>
<li>HTML = “轻量+稳定+没人改”。</li>
<li>Next.js（SSG 模式） = “灵活+自动化生成+易接入 CI/CD”。</li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-3">🧠 三、从工程生态和自动化角度讲</h2>
<p>工程师最怕什么？——<strong>重复劳动</strong>。</p>
<p>纯HTML：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- about.html --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>关于我们<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>我们是一家热爱代码与文化的团队。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">footer</span>&gt;</span>©2025 Company Name<span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span>
</code></pre>
<p>改一次页脚？所有文件都得动手改 👋。</p>
<p>Next.js 可以：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// components/Layout.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Layout</span>(<span class="hljs-params">{ children }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      {children}
      <span class="hljs-tag">&lt;<span class="hljs-name">footer</span>&gt;</span>©2025 Company Name<span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<p>一改全站同步 ✨<br/>
这就叫 <strong>“组件化思维”</strong> ：文化内容不该一次性雕刻，而应该能灵活演化。</p>
<hr/>
<h2 data-id="heading-4">🌏 四、从SEO与国际化角度</h2>
<p>如果你的静态内容需要：</p>
<ul>
<li>多语言版本（国际网站 🌍）；</li>
<li>动态Meta（自动生成标题、描述、OG图等）；</li>
<li>AIGC内容自动更新；</li>
</ul>
<p>👉 那Next.js压倒性更优秀。</p>
<p><strong>为什么？</strong><br/>
因为Next支持：</p>
<ul>
<li>内置 <strong>国际化路由（i18n）</strong> ；</li>
<li>动态<strong>Meta生成</strong>；</li>
<li><strong>ISR（增量静态再生成）</strong> ，可自动周期性刷新内容。</li>
</ul>
<p>HTML虽然也能做这些，但得靠“人肉更新”或“脚本拼接”，成本高、容易忘。</p>
<hr/>
<h2 data-id="heading-5">🎭 五、文化与表达层面：哪种更“有生命力”</h2>
<p>我们常说：</p>
<blockquote>
<p>“HTML 是碑文，Next 是生态。”</p>
</blockquote>
<p>当WebAIGC时代到来——网站上的内容不再静止，而是<strong>文化对话的持续生成体</strong>。</p>
<ul>
<li>HTML更像<strong>一幅挂在墙上的油画</strong>；</li>
<li>Next更像<strong>一片能生长的AI花园</strong>。 🌸</li>
</ul>
<p>如果你要做的是：</p>
<ul>
<li>数字展馆</li>
<li>互动式文化档案</li>
<li>AIGC内容展示<br/>
那Next.js是未来型选择，因为它能：</li>
<li>动态注入AI生成内容；</li>
<li>保留语义化；</li>
<li>实现Web动画交互；</li>
<li>与后端知识库联动（如LangChain、RAG架构）。</li>
</ul>
<hr/>
<h2 data-id="heading-6">🧭 六、最终建议表（决策参考）</h2>



































<table><thead><tr><th align="left">目标</th><th align="left">推荐方案</th><th align="left">理由</th></tr></thead><tbody><tr><td align="left"><strong>一次性公司官网（长年不改）</strong></td><td align="left">HTML</td><td align="left">简洁、快速、成本低</td></tr><tr><td align="left"><strong>学术或品牌介绍+多语种</strong></td><td align="left">Next.js（SSG + i18n）</td><td align="left">静态+多文化适配</td></tr><tr><td align="left"><strong>文化档案、教育平台</strong></td><td align="left">Next.js（SSR/ISR）</td><td align="left">支持动态内容更新</td></tr><tr><td align="left"><strong>AI生成内容展示（WebAIGC）</strong></td><td align="left">Next.js</td><td align="left">可读写AI接口、可交互</td></tr><tr><td align="left"><strong>极简Landing Page</strong></td><td align="left">HTML</td><td align="left">几KB即可部署</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-7">🔮 七、我的架构建议</h2>
<p>结合底层理解与文化项目的可持续性，我最推荐的组合是：</p>
<blockquote>
<p>“Next.js + Markdown内容仓库 + SSG导出 + CDN部署”</p>
</blockquote>
<p>也就是：</p>
<ul>
<li>编辑者写<code>Markdown</code>（文化内容）；</li>
<li>Next自动构建静态页；</li>
<li>CDN全球分发；</li>
<li>某些版块还能自动重生（ISR）。</li>
</ul>
<p>这就是所谓的“<strong>可演化的静态内容架构（Evolvable Static Web)</strong> ”。<br/>
既兼容文化传承的稳定性，也拥抱未来变化的AI逻辑。</p>
<hr/>
<h2 data-id="heading-8">🎯 最后一句话总结</h2>
<blockquote>
<p>💬 “静态HTML是记忆的容器；Next.js是文化的引擎。”</p>
</blockquote>
<p>——如果你只需要记住一件事：<br/>
👉 <strong>不变的内容用HTML，活着的文化用Next。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零开始：MCP数据库助手（三）- 多数据库支持]]></title>    <link>https://juejin.cn/post/7585839411122978862</link>    <guid>https://juejin.cn/post/7585839411122978862</guid>    <pubDate>2025-12-22T02:26:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585839411122978862" data-draft-id="7585866811717124123" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零开始：MCP数据库助手（三）- 多数据库支持"/> <meta itemprop="keywords" content="MCP"/> <meta itemprop="datePublished" content="2025-12-22T02:26:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="红鼻子时代"/> <meta itemprop="url" content="https://juejin.cn/user/1743149753974384"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零开始：MCP数据库助手（三）- 多数据库支持
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1743149753974384/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    红鼻子时代
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:26:25.000Z" title="Mon Dec 22 2025 02:26:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>代码已上传github上，这是<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbiao994%2Fmcp-datatools" target="_blank" title="https://github.com/biao994/mcp-datatools" ref="nofollow noopener noreferrer">github仓库地址</a>，如果项目对你有帮助，欢迎点个Star鼓励！</p>
<h2 data-id="heading-0">为什么要支持多数据库？</h2>
<p>前两章我们只支持SQLite，但现实中的企业环境需要：</p>
<ul>
<li><strong>PostgreSQL</strong> - 企业级应用的首选，功能强大</li>
<li><strong>MySQL</strong> - Web应用最流行的数据库</li>
<li><strong>配置管理</strong> - 一套代码支持多种环境</li>
</ul>
<p>今天我们要让MCP DataTools从"玩具"变成"工具"！</p>
<h2 data-id="heading-1">第一步：项目结构升级</h2>
<p>这次的项目结构更加完善：</p>
<pre><code class="hljs language-bash" lang="bash">mcp-datatools/
├── pyproject.toml              <span class="hljs-comment"># 升级依赖配置</span>
├── docker-compose.db.yml       <span class="hljs-comment"># 数据库环境（可选）</span>
├── config/
│   ├── __init__.py
│   └── settings.py             <span class="hljs-comment"># 应用配置管理</span>
├── src/
│   └── mcp_datatools/
│       ├── __init__.py
│       ├── server.py           <span class="hljs-comment"># 升级的MCP服务器</span>
│       ├── database.py         <span class="hljs-comment"># 多数据库管理器</span>
│       └── utils.py            <span class="hljs-comment"># 公共工具函数</span>
├── tests/
│   └── test_multi_database.py  <span class="hljs-comment"># 多数据库测试</span>
└── data/
    ├── test.db                <span class="hljs-comment"># SQLite测试数据</span>
    └── init_scripts/          <span class="hljs-comment"># 数据库初始化脚本</span>
        ├── init_sqlite_db.py   <span class="hljs-comment"># SQLite初始化脚本</span>
        ├── init_postgresql_db.py <span class="hljs-comment"># PostgreSQL初始化脚本</span>
        └── mysql.sql          <span class="hljs-comment"># MySQL初始化脚本</span>
</code></pre>
<h2 data-id="heading-2">第二步：依赖升级</h2>
<p>首先升级<code>pyproject.toml</code>，添加多数据库支持：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-comment"># MCP DataTools 项目配置文件</span>
<span class="hljs-comment"># 这是一个支持多数据库连接的MCP服务器项目</span>

<span class="hljs-section">[project]</span>
<span class="hljs-comment"># 项目基本信息</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"mcp-datatools"</span>
<span class="hljs-attr">version</span> = <span class="hljs-string">"0.3.0"</span>
<span class="hljs-attr">description</span> = <span class="hljs-string">"A MCP server that connects to multiple databases"</span>
<span class="hljs-attr">requires-python</span> = <span class="hljs-string">"&gt;=3.10"</span>  <span class="hljs-comment"># 最低Python版本要求</span>

<span class="hljs-comment"># 核心依赖包</span>
<span class="hljs-attr">dependencies</span> = [
    <span class="hljs-string">"mcp&gt;=1.0.0"</span>,                    <span class="hljs-comment"># MCP协议核心库</span>
    <span class="hljs-string">"sqlalchemy&gt;=2.0.0"</span>,             <span class="hljs-comment"># SQLAlchemy ORM，支持多种数据库</span>
    <span class="hljs-string">"psycopg2-binary&gt;=2.9.0"</span>,        <span class="hljs-comment"># PostgreSQL数据库驱动</span>
    <span class="hljs-string">"pymysql&gt;=1.1.0"</span>,                <span class="hljs-comment"># MySQL数据库驱动</span>
    <span class="hljs-string">"cryptography&gt;=41.0.0"</span>,          <span class="hljs-comment"># 加密支持，用于安全连接</span>
    <span class="hljs-string">"python-dotenv&gt;=1.0.0"</span>,          <span class="hljs-comment"># 环境变量管理</span>
    <span class="hljs-string">"pydantic&gt;=2.0.0"</span>,               <span class="hljs-comment"># 数据验证和序列化</span>
    <span class="hljs-string">"pydantic-settings&gt;=2.10.1"</span>,     <span class="hljs-comment"># 配置管理扩展</span>
]

<span class="hljs-comment"># 可选依赖包（开发环境）</span>
<span class="hljs-section">[project.optional-dependencies]</span>
<span class="hljs-attr">dev</span> = [
    <span class="hljs-string">"pytest&gt;=7.0.0"</span>,                 <span class="hljs-comment"># 测试框架</span>
    <span class="hljs-string">"pytest-asyncio&gt;=0.21.0"</span>,        <span class="hljs-comment"># 异步测试支持</span>
    <span class="hljs-string">"black&gt;=23.0.0"</span>,                 <span class="hljs-comment"># 代码格式化工具</span>
    <span class="hljs-string">"isort&gt;=5.12.0"</span>,                 <span class="hljs-comment"># 导入排序工具</span>
]

<span class="hljs-comment"># 构建系统配置</span>
<span class="hljs-section">[build-system]</span>
<span class="hljs-attr">requires</span> = [<span class="hljs-string">"hatchling"</span>]              <span class="hljs-comment"># 使用hatchling作为构建后端</span>
<span class="hljs-attr">build-backend</span> = <span class="hljs-string">"hatchling.build"</span>

<span class="hljs-comment"># 打包配置</span>
<span class="hljs-section">[tool.hatch.build.targets.wheel]</span>
<span class="hljs-attr">packages</span> = [<span class="hljs-string">"src/mcp_datatools"</span>]      <span class="hljs-comment"># 指定要打包的源码目录</span>

<span class="hljs-comment"># 命令行脚本配置</span>
<span class="hljs-section">[project.scripts]</span>
<span class="hljs-attr">mcp-datatools</span> = <span class="hljs-string">"mcp_datatools.server:main"</span>  <span class="hljs-comment"># 定义命令行入口点</span>

<span class="hljs-comment"># 测试配置</span>
<span class="hljs-section">[tool.pytest.ini_options]</span>
<span class="hljs-attr">pythonpath</span> = [<span class="hljs-string">"src"</span>]                  <span class="hljs-comment"># 添加src目录到Python路径</span>

<span class="hljs-comment"># 代码格式化配置</span>
<span class="hljs-section">[tool.black]</span>
<span class="hljs-attr">line-length</span> = <span class="hljs-number">88</span>                      <span class="hljs-comment"># 每行最大字符数</span>
<span class="hljs-attr">target-version</span> = [<span class="hljs-string">'py310'</span>]            <span class="hljs-comment"># 目标Python版本</span>

<span class="hljs-comment"># 导入排序配置</span>
<span class="hljs-section">[tool.isort]</span>
<span class="hljs-attr">profile</span> = <span class="hljs-string">"black"</span>                     <span class="hljs-comment"># 使用black兼容的配置</span>
<span class="hljs-attr">multi_line_output</span> = <span class="hljs-number">3</span>                 <span class="hljs-comment"># 多行导入的格式</span>
</code></pre>
<h2 data-id="heading-3">第三步：配置管理系统</h2>
<p>创建统一的配置管理系统：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
config/settings.py - 应用配置管理
"""</span>
<span class="hljs-keyword">from</span> pydantic_settings <span class="hljs-keyword">import</span> BaseSettings
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> Field, ConfigDict
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Dict</span>, <span class="hljs-type">Any</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseConfig</span>(<span class="hljs-title class_ inherited__">BaseSettings</span>):
    <span class="hljs-string">"""数据库配置"""</span>
    model_config = ConfigDict(env_prefix=<span class="hljs-string">"DB_"</span>)
    
    pool_size : <span class="hljs-built_in">int</span> = Field(default=<span class="hljs-number">20</span>, description=<span class="hljs-string">"连接池大小"</span>)
    max_overflow: <span class="hljs-built_in">int</span> = Field(default=<span class="hljs-number">10</span>, description=<span class="hljs-string">"连接池最大溢出数"</span>)
    pool_timeout: <span class="hljs-built_in">int</span> = Field(default=<span class="hljs-number">30</span>, description=<span class="hljs-string">"连接池超时时间"</span>)
    pool_recycle: <span class="hljs-built_in">int</span> = Field(default=<span class="hljs-number">3600</span>, description=<span class="hljs-string">"连接池回收时间"</span>)
    echo: <span class="hljs-built_in">bool</span> = Field(default=<span class="hljs-literal">False</span>, description=<span class="hljs-string">"是否打印SQL语句"</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AppConfig</span>(<span class="hljs-title class_ inherited__">BaseSettings</span>):
    <span class="hljs-string">"""应用配置"""</span>
    model_config = ConfigDict(env_prefix=<span class="hljs-string">"APP_"</span>)
    
    name: <span class="hljs-built_in">str</span> = Field(default=<span class="hljs-string">"MCP DataTools"</span>, description=<span class="hljs-string">"应用名称"</span>)
    version: <span class="hljs-built_in">str</span> = Field(default=<span class="hljs-string">"1.0.0"</span>, description=<span class="hljs-string">"应用版本"</span>)
    log_level: <span class="hljs-built_in">str</span> = Field(default=<span class="hljs-string">"INFO"</span>, description=<span class="hljs-string">"日志级别"</span>)
    max_query_results: <span class="hljs-built_in">int</span> = Field(default=<span class="hljs-number">1000</span>, description=<span class="hljs-string">"结果最大查询行数"</span>)

    <span class="hljs-comment"># 数据库配置</span>
    database: DatabaseConfig = Field(default_factory=DatabaseConfig, description=<span class="hljs-string">"数据库配置"</span>)

<span class="hljs-comment"># 全局配置实例</span>
config = AppConfig()
</code></pre>
<h2 data-id="heading-4">第四步：多数据库连接管理</h2>
<p>升级数据库管理器，支持多种数据库：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
src/mcp_datatools/database.py - 多数据库管理器
"""</span>

<span class="hljs-keyword">from</span> .utils <span class="hljs-keyword">import</span> setup_project_path
setup_project_path()

<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>, <span class="hljs-type">Any</span>
<span class="hljs-keyword">from</span> contextlib <span class="hljs-keyword">import</span> contextmanager
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> create_engine, inspect, text
<span class="hljs-keyword">from</span> sqlalchemy.exc <span class="hljs-keyword">import</span> SQLAlchemyError
<span class="hljs-keyword">from</span> sqlalchemy.pool <span class="hljs-keyword">import</span> QueuePool
<span class="hljs-keyword">from</span> mcp.server.fastmcp.utilities.logging <span class="hljs-keyword">import</span> get_logger

<span class="hljs-keyword">from</span> config.settings <span class="hljs-keyword">import</span> config
<span class="hljs-keyword">from</span> .utils <span class="hljs-keyword">import</span> mask_password

logger = get_logger(__name__)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiDatabaseManager</span>:
    <span class="hljs-string">"""多数据库管理器"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, database_url: <span class="hljs-built_in">str</span></span>):
        <span class="hljs-string">"""初始化数据库管理器（必须显式提供 database_url）"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> database_url <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(database_url, <span class="hljs-built_in">str</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> database_url.strip():
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"必须显式提供 database_url"</span>)
        self.database_url = database_url.strip()
        self.engine = <span class="hljs-literal">None</span>
        self.db_type = self._detect_database_type()
        self._connect()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_detect_database_type</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""检测数据库类型"""</span>
        url = self.database_url.lower()
        <span class="hljs-keyword">if</span> url.startswith(<span class="hljs-string">"postgresql://"</span>) <span class="hljs-keyword">or</span> url.startswith(<span class="hljs-string">"postgres://"</span>):
            <span class="hljs-keyword">return</span> <span class="hljs-string">"postgresql"</span>
        <span class="hljs-keyword">elif</span> url.startswith(<span class="hljs-string">"mysql://"</span>) <span class="hljs-keyword">or</span> url.startswith(<span class="hljs-string">"mysql+"</span>):
            <span class="hljs-keyword">return</span> <span class="hljs-string">"mysql"</span>
        <span class="hljs-keyword">elif</span> url.startswith(<span class="hljs-string">"sqlite://"</span>):
            <span class="hljs-keyword">return</span> <span class="hljs-string">"sqlite"</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">"unknown"</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_connect</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""连接数据库"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 根据数据库类型调整配置</span>
            <span class="hljs-keyword">if</span> self.db_type == <span class="hljs-string">"sqlite"</span>:
                <span class="hljs-comment"># SQLite使用最简配置，避免复杂的连接池</span>
                self.engine = create_engine(
                    self.database_url,
                    echo=config.database.echo,
                    connect_args={<span class="hljs-string">"check_same_thread"</span>: <span class="hljs-literal">False</span>}  <span class="hljs-comment"># 允许多线程</span>
                )
            <span class="hljs-keyword">else</span>:
                <span class="hljs-comment"># PostgreSQL和MySQL使用完整连接池配置</span>
                self.engine = create_engine(
                    self.database_url,
                    poolclass=QueuePool,  <span class="hljs-comment"># 明确指定队列式连接池</span>
                    pool_size=config.database.pool_size,
                    max_overflow=config.database.max_overflow,
                    pool_timeout=config.database.pool_timeout,
                    pool_recycle=config.database.pool_recycle,
                    echo=config.database.echo
                )
                        
            logger.info(<span class="hljs-string">f"成功连接到 <span class="hljs-subst">{self.db_type}</span> 数据库: <span class="hljs-subst">{mask_password(self.database_url)}</span>"</span>)
            
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"连接数据库时出错: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
            <span class="hljs-keyword">raise</span>
    
<span class="hljs-meta">    @contextmanager</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_connection</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""获取数据库连接的上下文管理器"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.engine:
            <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">"数据库未连接"</span>)
        
        conn = self.engine.connect()
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">yield</span> conn
        <span class="hljs-keyword">finally</span>:
            conn.close()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_database_info</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:
        <span class="hljs-string">"""获取数据库信息"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> self.get_connection() <span class="hljs-keyword">as</span> conn:
                info = {
                    <span class="hljs-string">"type"</span>: self.db_type,
                    <span class="hljs-string">"url"</span>: mask_password(self.database_url),
                    <span class="hljs-string">"tables_count"</span>: <span class="hljs-built_in">len</span>(self.get_table_names()),
                }
                
                <span class="hljs-comment"># 只为非SQLite数据库显示连接池信息</span>
                <span class="hljs-keyword">if</span> self.db_type != <span class="hljs-string">"sqlite"</span>:
                    <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(self.engine, <span class="hljs-string">'pool'</span>):
                        <span class="hljs-keyword">try</span>:
                            pool_info = {}
                            <span class="hljs-comment"># 统一尝试获取各种连接池信息</span>
                            <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(self.engine.pool, <span class="hljs-string">'size'</span>):
                                pool_info[<span class="hljs-string">"size"</span>] = self.engine.pool.size()
                            <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(self.engine.pool, <span class="hljs-string">'checkedout'</span>):
                                pool_info[<span class="hljs-string">"checked_out"</span>] = self.engine.pool.checkedout()
                            <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(self.engine.pool, <span class="hljs-string">'overflow'</span>):
                                pool_info[<span class="hljs-string">"overflow"</span>] = self.engine.pool.overflow()
                            <span class="hljs-comment"># 对于checked_in，不同的连接池实现可能不同</span>
                            <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(self.engine.pool, <span class="hljs-string">'checked_in'</span>):
                                pool_info[<span class="hljs-string">"checked_in"</span>] = self.engine.pool.checked_in()
                            <span class="hljs-keyword">elif</span> <span class="hljs-built_in">hasattr</span>(self.engine.pool, <span class="hljs-string">'checkedin'</span>):
                                pool_info[<span class="hljs-string">"checked_in"</span>] = self.engine.pool.checkedin()
                            <span class="hljs-keyword">else</span>:
                                <span class="hljs-comment"># 如果都没有，计算可用连接数</span>
                                <span class="hljs-keyword">if</span> <span class="hljs-string">"size"</span> <span class="hljs-keyword">in</span> pool_info <span class="hljs-keyword">and</span> <span class="hljs-string">"checked_out"</span> <span class="hljs-keyword">in</span> pool_info:
                                    pool_info[<span class="hljs-string">"checked_in"</span>] = pool_info[<span class="hljs-string">"size"</span>] - pool_info[<span class="hljs-string">"checked_out"</span>]
                            
                            info[<span class="hljs-string">"connection_pool"</span>] = pool_info <span class="hljs-keyword">if</span> pool_info <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>
                        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> pool_error:
                            logger.warning(<span class="hljs-string">f"获取连接池信息失败: <span class="hljs-subst">{pool_error}</span>"</span>)
                            info[<span class="hljs-string">"connection_pool"</span>] = <span class="hljs-literal">None</span>
                    <span class="hljs-keyword">else</span>:
                        info[<span class="hljs-string">"connection_pool"</span>] = <span class="hljs-literal">None</span>
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-comment"># SQLite 不显示连接池信息</span>
                    info[<span class="hljs-string">"connection_pool"</span>] = <span class="hljs-literal">None</span>
                
                <span class="hljs-keyword">return</span> info
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"获取数据库信息失败: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">return</span> {<span class="hljs-string">"type"</span>: self.db_type, <span class="hljs-string">"error"</span>: <span class="hljs-built_in">str</span>(e)}
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_table_names</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:
        <span class="hljs-string">"""获取数据库中的所有表名"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> self.get_connection() <span class="hljs-keyword">as</span> conn:
                inspector = inspect(conn)
                table_names = inspector.get_table_names()
                <span class="hljs-keyword">return</span> table_names
        <span class="hljs-keyword">except</span> SQLAlchemyError <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"获取表名失败: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_connection</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-string">"""测试数据库连接"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> self.get_connection() <span class="hljs-keyword">as</span> conn:

                result = conn.execute(text(<span class="hljs-string">"SELECT 1"</span>)).scalar()
                <span class="hljs-keyword">return</span> result == <span class="hljs-number">1</span>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"测试数据库连接时出错: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">filter_table_names</span>(<span class="hljs-params">self, keyword: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:
        <span class="hljs-string">"""根据关键词搜索相关表名"""</span>
        <span class="hljs-keyword">try</span>:
            all_tables = self.get_table_names()
            matching_tables = [
                table <span class="hljs-keyword">for</span> table <span class="hljs-keyword">in</span> all_tables 
                <span class="hljs-keyword">if</span> keyword.lower() <span class="hljs-keyword">in</span> table.lower()
            ]
            <span class="hljs-keyword">return</span> matching_tables
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"搜索表名失败: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_table_schema</span>(<span class="hljs-params">self, table_name: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:
        <span class="hljs-string">"""获取指定表的详细结构信息"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> self.get_connection() <span class="hljs-keyword">as</span> conn:
                inspector = inspect(conn)
                
                <span class="hljs-comment"># 验证表是否存在</span>
                <span class="hljs-keyword">if</span> table_name <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> inspector.get_table_names():
                    <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"表 '<span class="hljs-subst">{table_name}</span>' 不存在"</span>)
                
                <span class="hljs-comment"># 获取列信息</span>
                columns = inspector.get_columns(table_name)
                
                <span class="hljs-comment"># 获取主键信息</span>
                pk_constraint = inspector.get_pk_constraint(table_name)
                primary_keys = <span class="hljs-built_in">set</span>(pk_constraint[<span class="hljs-string">"constrained_columns"</span>])
                
                <span class="hljs-comment"># 获取索引信息</span>
                indexes = inspector.get_indexes(table_name)
                
                <span class="hljs-comment"># 获取外键信息</span>
                foreign_keys = inspector.get_foreign_keys(table_name)
                
                <span class="hljs-comment"># 格式化列信息</span>
                formatted_columns = []
                <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> columns:
                    col_info = {
                        <span class="hljs-string">"name"</span>: col[<span class="hljs-string">"name"</span>],
                        <span class="hljs-string">"type"</span>: <span class="hljs-built_in">str</span>(col[<span class="hljs-string">"type"</span>]),
                        <span class="hljs-string">"nullable"</span>: col[<span class="hljs-string">"nullable"</span>],
                        <span class="hljs-string">"default"</span>: col.get(<span class="hljs-string">"default"</span>),
                        <span class="hljs-string">"is_primary_key"</span>: col[<span class="hljs-string">"name"</span>] <span class="hljs-keyword">in</span> primary_keys
                    }
                    formatted_columns.append(col_info)
                
                schema_info = {
                    <span class="hljs-string">"table_name"</span>: table_name,
                    <span class="hljs-string">"columns"</span>: formatted_columns,
                    <span class="hljs-string">"primary_keys"</span>: <span class="hljs-built_in">list</span>(primary_keys),
                    <span class="hljs-string">"indexes"</span>: indexes,
                    <span class="hljs-string">"foreign_keys"</span>: foreign_keys,
                    <span class="hljs-string">"column_count"</span>: <span class="hljs-built_in">len</span>(columns)
                }
                
                <span class="hljs-keyword">return</span> schema_info
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"获取表结构信息失败: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_validate_query</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""验证查询安全性"""</span>
        query_upper = query.upper().strip()
        
        <span class="hljs-comment"># 检查危险的SQL操作</span>
        dangerous_keywords = [
            <span class="hljs-string">"DROP"</span>, <span class="hljs-string">"DELETE"</span>, <span class="hljs-string">"UPDATE"</span>, <span class="hljs-string">"INSERT"</span>, <span class="hljs-string">"ALTER"</span>, <span class="hljs-string">"CREATE"</span>, <span class="hljs-string">"TRUNCATE"</span>
        ]
        
        <span class="hljs-keyword">for</span> keyword <span class="hljs-keyword">in</span> dangerous_keywords:
            <span class="hljs-keyword">if</span> keyword <span class="hljs-keyword">in</span> query_upper:
                <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"查询包含危险操作: <span class="hljs-subst">{keyword}</span>"</span>)
        
        <span class="hljs-comment"># 检查是否是SELECT查询</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> query_upper.startswith(<span class="hljs-string">"SELECT"</span>):
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"只允许执行SELECT查询"</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_add_limit_to_query</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, limit: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""为查询添加LIMIT子句"""</span>
        query_upper = query.upper()
        
        <span class="hljs-comment"># 如果已经有LIMIT，不再添加</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">"LIMIT"</span> <span class="hljs-keyword">in</span> query_upper:
            <span class="hljs-keyword">return</span> query
        
        <span class="hljs-comment"># 添加LIMIT子句</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{query.rstrip(<span class="hljs-string">';'</span>)}</span> LIMIT <span class="hljs-subst">{limit}</span>"</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_query</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, params: <span class="hljs-built_in">dict</span> = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]:
        <span class="hljs-string">"""安全执行SQL查询"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 验证查询安全性</span>
            self._validate_query(query)
            
            <span class="hljs-comment"># 添加默认限制</span>
            limited_query = self._add_limit_to_query(query, config.max_query_results)
            
            <span class="hljs-keyword">with</span> self.get_connection() <span class="hljs-keyword">as</span> conn:
                <span class="hljs-keyword">if</span> params:
                    <span class="hljs-comment"># 使用参数化查询</span>
                    result = conn.execute(text(limited_query), params)
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-comment"># 直接执行查询</span>
                    result = conn.execute(text(limited_query))
                
                <span class="hljs-comment"># 获取列名</span>
                columns = result.keys()
                
                <span class="hljs-comment"># 转换为字典列表</span>
                rows = []
                <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> result:
                    row_dict = <span class="hljs-built_in">dict</span>(<span class="hljs-built_in">zip</span>(columns, row))
                    rows.append(row_dict)
                
                <span class="hljs-keyword">return</span> rows
                
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"执行查询失败: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">close</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""关闭数据库连接"""</span>
        <span class="hljs-keyword">if</span> self.engine:
            self.engine.dispose()
            logger.info(<span class="hljs-string">"数据库连接已关闭"</span>)
</code></pre>
<h2 data-id="heading-5">第五步：MCP服务器架构升级</h2>
<p><strong>重要变化</strong>：实际代码采用了更灵活的架构，所有工具函数都重新设计为 <code>*_by_url</code> 命名方式，必须显式传入 <code>database_url</code> 参数：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
src/mcp_datatools/server.py - 仅提供必须传入 database_url 的工具
"""</span>

<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>
<span class="hljs-keyword">from</span> .utils <span class="hljs-keyword">import</span> setup_project_path, database_operation
setup_project_path()

<span class="hljs-keyword">from</span> mcp.server.fastmcp <span class="hljs-keyword">import</span> FastMCP
<span class="hljs-keyword">from</span> mcp.server.fastmcp.utilities.logging <span class="hljs-keyword">import</span> get_logger

<span class="hljs-comment"># 支持相对导入和绝对导入</span>
<span class="hljs-keyword">try</span>:
    <span class="hljs-keyword">from</span> .database <span class="hljs-keyword">import</span> MultiDatabaseManager
<span class="hljs-keyword">except</span> ImportError:
    <span class="hljs-keyword">from</span> mcp_datatools.database <span class="hljs-keyword">import</span> MultiDatabaseManager

<span class="hljs-keyword">from</span> config.settings <span class="hljs-keyword">import</span> config

mcp = FastMCP(config.name)
logger = get_logger(__name__)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_database_manager</span>(<span class="hljs-params">database_url: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""根据显式指定的数据库URL返回管理器"""</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> database_url <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(database_url, <span class="hljs-built_in">str</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> database_url.strip():
        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"请提供有效的 database_url"</span>)
    <span class="hljs-keyword">return</span> MultiDatabaseManager(database_url.strip())

<span class="hljs-meta">@mcp.tool(<span class="hljs-params">description=<span class="hljs-string">"获取数据库信息（必须指定 database_url）。例如：get_database_info_by_url('postgresql://user:pass@host:5432/db')"</span></span>)</span>
<span class="hljs-meta">@database_operation(<span class="hljs-params"><span class="hljs-string">"获取数据库信息"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_database_info_by_url</span>(<span class="hljs-params">database_url: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""查询指定数据库的信息（必须传入 database_url）"""</span>
    db_mgr = get_database_manager(database_url)
    info = db_mgr.get_database_info()

    result = <span class="hljs-string">"数据库信息:\n"</span>
    result += <span class="hljs-string">f"类型: <span class="hljs-subst">{info.get(<span class="hljs-string">'type'</span>)}</span>\n"</span>
    result += <span class="hljs-string">f"连接: <span class="hljs-subst">{info.get(<span class="hljs-string">'url'</span>)}</span>\n"</span>
    result += <span class="hljs-string">f"表数量: <span class="hljs-subst">{info.get(<span class="hljs-string">'tables_count'</span>)}</span>\n"</span>

    pool = info.get(<span class="hljs-string">'connection_pool'</span>)
    <span class="hljs-keyword">if</span> pool:
        result += <span class="hljs-string">"\n连接池状态:\n"</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">'size'</span> <span class="hljs-keyword">in</span> pool:
            result += <span class="hljs-string">f"  池大小: <span class="hljs-subst">{pool[<span class="hljs-string">'size'</span>]}</span>\n"</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">'checked_out'</span> <span class="hljs-keyword">in</span> pool:
            result += <span class="hljs-string">f"  已连接: <span class="hljs-subst">{pool[<span class="hljs-string">'checked_out'</span>]}</span>\n"</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">'checked_in'</span> <span class="hljs-keyword">in</span> pool:
            result += <span class="hljs-string">f"  可用连接: <span class="hljs-subst">{pool[<span class="hljs-string">'checked_in'</span>]}</span>\n"</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">'overflow'</span> <span class="hljs-keyword">in</span> pool:
            result += <span class="hljs-string">f"  溢出连接: <span class="hljs-subst">{pool[<span class="hljs-string">'overflow'</span>]}</span>\n"</span>

    <span class="hljs-keyword">return</span> result

<span class="hljs-meta">@mcp.tool(<span class="hljs-params">description=<span class="hljs-string">"列出所有表（必须指定 database_url）。例如：list_tables_by_url('mysql+pymysql://user:pass@host:3306/db')"</span></span>)</span>
<span class="hljs-meta">@database_operation(<span class="hljs-params"><span class="hljs-string">"获取数据库表列表"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">list_tables_by_url</span>(<span class="hljs-params">database_url: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""查询指定数据库的表列表（必须传入 database_url）"""</span>
    db_mgr = get_database_manager(database_url)
    tables = db_mgr.get_table_names()

    <span class="hljs-keyword">if</span> tables:
        result = <span class="hljs-string">f"数据库中共有 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(tables)}</span> 个表:\n\n"</span>
        <span class="hljs-keyword">for</span> i, table <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(tables, <span class="hljs-number">1</span>):
            result += <span class="hljs-string">f"<span class="hljs-subst">{i}</span>. <span class="hljs-subst">{table}</span>\n"</span>
        <span class="hljs-keyword">return</span> result
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"数据库中没有表"</span>

<span class="hljs-meta">@mcp.tool(<span class="hljs-params">description=<span class="hljs-string">"获取表结构信息（必须指定 database_url）。例如：schema_info_by_url(['users'], 'sqlite:///path/to.db')"</span></span>)</span>
<span class="hljs-meta">@database_operation(<span class="hljs-params"><span class="hljs-string">"获取表结构信息"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">schema_info_by_url</span>(<span class="hljs-params">table_names: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>], database_url: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""获取指定数据库中表的详细结构信息（必须传入 database_url）"""</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> table_names:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"请提供要查询的表名"</span>

    db_mgr = get_database_manager(database_url)
    result_parts = []

    <span class="hljs-keyword">for</span> table_name <span class="hljs-keyword">in</span> table_names:
        <span class="hljs-keyword">try</span>:
            schema_info = db_mgr.get_table_schema(table_name)

            <span class="hljs-comment"># 格式化表结构信息</span>
            table_section = <span class="hljs-string">f"\n<span class="hljs-subst">{<span class="hljs-string">'='</span>*<span class="hljs-number">50</span>}</span>\n"</span>
            table_section += <span class="hljs-string">f"表名：<span class="hljs-subst">{table_name}</span>\n"</span>
            table_section += <span class="hljs-string">f"列：<span class="hljs-subst">{schema_info[<span class="hljs-string">'columns'</span>]}</span>\n"</span>
            table_section += <span class="hljs-string">f"<span class="hljs-subst">{<span class="hljs-string">'='</span>*<span class="hljs-number">50</span>}</span>\n"</span>

            <span class="hljs-comment"># 列信息</span>
            <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> schema_info[<span class="hljs-string">'columns'</span>]:
                col_type = col[<span class="hljs-string">'type'</span>]
                nullable = <span class="hljs-string">"可空"</span> <span class="hljs-keyword">if</span> col[<span class="hljs-string">'nullable'</span>] <span class="hljs-keyword">else</span> <span class="hljs-string">"不可空"</span>
                pk_mark = <span class="hljs-string">" 主键"</span> <span class="hljs-keyword">if</span> col[<span class="hljs-string">'is_primary_key'</span>] <span class="hljs-keyword">else</span> <span class="hljs-string">""</span>
                default_info = <span class="hljs-string">f" (默认: <span class="hljs-subst">{col[<span class="hljs-string">'default'</span>]}</span>)"</span> <span class="hljs-keyword">if</span> col[<span class="hljs-string">'default'</span>] <span class="hljs-keyword">else</span> <span class="hljs-string">""</span>
                table_section += <span class="hljs-string">f"  • <span class="hljs-subst">{col[<span class="hljs-string">'name'</span>]}</span>: <span class="hljs-subst">{col_type}</span> - <span class="hljs-subst">{nullable}</span><span class="hljs-subst">{pk_mark}</span><span class="hljs-subst">{default_info}</span>\n"</span>

            <span class="hljs-comment"># 主键信息</span>
            <span class="hljs-keyword">if</span> schema_info[<span class="hljs-string">'primary_keys'</span>]:
                table_section += <span class="hljs-string">f"\n主键: <span class="hljs-subst">{<span class="hljs-string">', '</span>.join(schema_info[<span class="hljs-string">'primary_keys'</span>])}</span>\n"</span>

            <span class="hljs-comment"># 索引信息</span>
            <span class="hljs-keyword">if</span> schema_info[<span class="hljs-string">'indexes'</span>]:
                table_section += <span class="hljs-string">"\n索引信息:\n"</span>
                <span class="hljs-keyword">for</span> idx <span class="hljs-keyword">in</span> schema_info[<span class="hljs-string">'indexes'</span>]:
                    unique_mark = <span class="hljs-string">"唯一索引"</span> <span class="hljs-keyword">if</span> idx.get(<span class="hljs-string">'unique'</span>, <span class="hljs-literal">False</span>) <span class="hljs-keyword">else</span> <span class="hljs-string">"普通索引"</span>
                    columns = <span class="hljs-string">', '</span>.join(idx[<span class="hljs-string">'column_names'</span>])
                    table_section += <span class="hljs-string">f"  • <span class="hljs-subst">{idx[<span class="hljs-string">'name'</span>]}</span>: <span class="hljs-subst">{unique_mark}</span> (<span class="hljs-subst">{columns}</span>)\n"</span>

            <span class="hljs-comment"># 外键信息</span>
            <span class="hljs-keyword">if</span> schema_info[<span class="hljs-string">'foreign_keys'</span>]:
                table_section += <span class="hljs-string">"\n外键关系:\n"</span>
                <span class="hljs-keyword">for</span> fk <span class="hljs-keyword">in</span> schema_info[<span class="hljs-string">'foreign_keys'</span>]:
                    local_cols = <span class="hljs-string">', '</span>.join(fk[<span class="hljs-string">'constrained_columns'</span>])
                    ref_table = fk[<span class="hljs-string">'referred_table'</span>]
                    ref_cols = <span class="hljs-string">', '</span>.join(fk[<span class="hljs-string">'referred_columns'</span>])
                    table_section += <span class="hljs-string">f"  • <span class="hljs-subst">{local_cols}</span> → <span class="hljs-subst">{ref_table}</span>.<span class="hljs-subst">{ref_cols}</span>\n"</span>

            result_parts.append(table_section)

        <span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> e:
            result_parts.append(<span class="hljs-string">f"\n表 '<span class="hljs-subst">{table_name}</span>': <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>\n"</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            result_parts.append(<span class="hljs-string">f"\n表 '<span class="hljs-subst">{table_name}</span>' 解析失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>\n"</span>)

    <span class="hljs-keyword">return</span> <span class="hljs-string">'\n'</span>.join(result_parts)

<span class="hljs-meta">@mcp.tool(<span class="hljs-params">description=<span class="hljs-string">"执行只读SQL查询（必须指定 database_url；仅支持SELECT，自动加行数限制，支持参数化查询）。例如：execute_query_by_url('SELECT 1', 'postgresql://...')"</span></span>)</span>
<span class="hljs-meta">@database_operation(<span class="hljs-params"><span class="hljs-string">"执行SQL查询"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_query_by_url</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span>, database_url: <span class="hljs-built_in">str</span>, params: <span class="hljs-built_in">dict</span> = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""执行只读查询（必须传入 database_url）"""</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> query <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> query.strip():
        <span class="hljs-keyword">return</span> <span class="hljs-string">"请提供查询语句"</span>

    db_mgr = get_database_manager(database_url)
    query_params = params <span class="hljs-keyword">if</span> params <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>

    result = db_mgr.execute_query(query.strip(), query_params)

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> result:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"查询结果为空"</span>

    result_text = <span class="hljs-string">"查询结果:\n"</span>
    <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> result:
        result_text += <span class="hljs-string">f"<span class="hljs-subst">{row}</span>\n"</span>
    <span class="hljs-keyword">return</span> result_text

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-keyword">try</span>:
        logger.info(<span class="hljs-string">f"启动<span class="hljs-subst">{config.name}</span> v<span class="hljs-subst">{config.version}</span>"</span>)

        logger.info(<span class="hljs-string">"当前功能："</span>)
        logger.info(<span class="hljs-string">"  - get_database_info_by_url(database_url) - 获取数据库信息"</span>)
        logger.info(<span class="hljs-string">"  - list_tables_by_url(database_url) - 获取数据库表列表"</span>)
        logger.info(<span class="hljs-string">"  - schema_info_by_url(table_names, database_url) - 获取表结构"</span>)
        logger.info(<span class="hljs-string">"  - execute_query_by_url(query, database_url, params=None) - 执行SQL只读查询"</span>)
        logger.info(<span class="hljs-string">"MCP服务器启动成功，等待客户端连接..."</span>)

        mcp.run()
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        logger.error(<span class="hljs-string">f"服务器启动失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
        <span class="hljs-keyword">raise</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()
</code></pre>
<p><strong>这种设计的优势</strong>：</p>
<ul>
<li><strong>真正的多数据库支持</strong>：可以同时连接和操作多个不同的数据库</li>
<li><strong>更高的灵活性</strong>：每个操作都可以针对不同的数据库实例</li>
<li><strong>无全局状态</strong>：避免并发问题，更加线程安全</li>
<li><strong>更好的扩展性</strong>：支持未来扩展到更多数据库类型</li>
<li><strong>统一错误处理</strong>：通过装饰器统一处理数据库操作错误</li>
</ul>
<h2 data-id="heading-6">第六步：公共工具函数</h2>
<p>新增的 <code>utils.py</code> 文件提供了重要的公共功能：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
src/mcp_datatools/utils.py - 公共工具函数
"""</span>

<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Any</span>, <span class="hljs-type">Callable</span>
<span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> wraps
<span class="hljs-keyword">from</span> mcp.server.fastmcp.utilities.logging <span class="hljs-keyword">import</span> get_logger

logger = get_logger(__name__)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">setup_project_path</span>():
    <span class="hljs-string">"""统一的项目路径设置"""</span>
    current_dir = os.path.dirname(os.path.abspath(__file__))
    <span class="hljs-comment"># 从 src/mcp_datatools 到项目根目录</span>
    project_root = os.path.dirname(os.path.dirname(current_dir))
    <span class="hljs-keyword">if</span> project_root <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> sys.path:
        sys.path.insert(<span class="hljs-number">0</span>, project_root)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_database_error</span>(<span class="hljs-params">operation: <span class="hljs-built_in">str</span>, error: Exception</span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""统一的数据库错误处理"""</span>
    error_msg = <span class="hljs-string">f"<span class="hljs-subst">{operation}</span>失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(error)}</span>"</span>
    logger.error(error_msg)
    <span class="hljs-keyword">return</span> error_msg

<span class="hljs-keyword">def</span> <span class="hljs-title function_">database_operation</span>(<span class="hljs-params">operation_name: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""数据库操作装饰器，统一错误处理"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decorator</span>(<span class="hljs-params">func: <span class="hljs-type">Callable</span></span>) -&gt; <span class="hljs-type">Callable</span>:
<span class="hljs-meta">        @wraps(<span class="hljs-params">func</span>)</span>
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>) -&gt; <span class="hljs-type">Any</span>:
            <span class="hljs-keyword">try</span>:
                result = func(*args, **kwargs)
                logger.info(<span class="hljs-string">f"成功<span class="hljs-subst">{operation_name}</span>"</span>)
                <span class="hljs-keyword">return</span> result
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                <span class="hljs-keyword">return</span> handle_database_error(operation_name, e)
        <span class="hljs-keyword">return</span> wrapper
    <span class="hljs-keyword">return</span> decorator

<span class="hljs-keyword">def</span> <span class="hljs-title function_">mask_password</span>(<span class="hljs-params">url: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""隐藏URL中的密码"""</span>
    <span class="hljs-keyword">if</span> <span class="hljs-string">"@"</span> <span class="hljs-keyword">in</span> url <span class="hljs-keyword">and</span> <span class="hljs-string">"://"</span> <span class="hljs-keyword">in</span> url:
        parts = url.split(<span class="hljs-string">"://"</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) == <span class="hljs-number">2</span>:
            protocol = parts[<span class="hljs-number">0</span>]
            rest = parts[<span class="hljs-number">1</span>]
            <span class="hljs-keyword">if</span> <span class="hljs-string">"@"</span> <span class="hljs-keyword">in</span> rest:
                user_pass, host_db = rest.split(<span class="hljs-string">"@"</span>, <span class="hljs-number">1</span>)
                <span class="hljs-keyword">if</span> <span class="hljs-string">":"</span> <span class="hljs-keyword">in</span> user_pass:
                    user, _ = user_pass.split(<span class="hljs-string">":"</span>, <span class="hljs-number">1</span>)
                    <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{protocol}</span>://<span class="hljs-subst">{user}</span>:***@<span class="hljs-subst">{host_db}</span>"</span>
    <span class="hljs-keyword">return</span> url
</code></pre>
<p><strong>工具函数的作用</strong>：</p>
<ul>
<li><strong>路径管理</strong>：<code>setup_project_path()</code> 解决模块导入问题</li>
<li><strong>错误处理</strong>：<code>database_operation</code> 装饰器统一处理数据库操作错误</li>
<li><strong>安全处理</strong>：<code>mask_password()</code> 隐藏连接字符串中的敏感信息</li>
</ul>
<h2 data-id="heading-7">第七步：数据库初始化脚本</h2>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- data/init_scripts/postgresql.sql</span>
<span class="hljs-comment">-- PostgreSQL测试数据库初始化</span>

<span class="hljs-comment">-- 创建用户表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> users (
    id SERIAL <span class="hljs-keyword">PRIMARY</span> KEY,
    name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">UNIQUE</span>,
    created_at <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
);

<span class="hljs-comment">-- 创建产品表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> products (
    id SERIAL <span class="hljs-keyword">PRIMARY</span> KEY,
    name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    price <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    category <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>),
    created_at <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
);

<span class="hljs-comment">-- 创建订单表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> orders (
    id SERIAL <span class="hljs-keyword">PRIMARY</span> KEY,
    user_id <span class="hljs-type">INTEGER</span> <span class="hljs-keyword">REFERENCES</span> users(id),
    total_amount <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    status <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'pending'</span>,
    created_at <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
);

<span class="hljs-comment">-- 插入测试数据</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users (name, email) <span class="hljs-keyword">VALUES</span> 
    (<span class="hljs-string">'吴邪'</span>, <span class="hljs-string">'wuxie@example.com'</span>),
    (<span class="hljs-string">'张起灵'</span>, <span class="hljs-string">'zhangqiling@example.com'</span>),
    (<span class="hljs-string">'王胖子'</span>, <span class="hljs-string">'wangpangzi@example.com'</span>);

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> products (name, price, category) <span class="hljs-keyword">VALUES</span> 
    (<span class="hljs-string">'洛阳铲'</span>, <span class="hljs-number">299.99</span>, <span class="hljs-string">'探测工具'</span>),
    (<span class="hljs-string">'夜明珠'</span>, <span class="hljs-number">9999.99</span>, <span class="hljs-string">'照明装备'</span>),
    (<span class="hljs-string">'黑驴蹄子'</span>, <span class="hljs-number">88.88</span>, <span class="hljs-string">'防护用品'</span>),
    (<span class="hljs-string">'金刚伞'</span>, <span class="hljs-number">1299.99</span>, <span class="hljs-string">'防御装备'</span>);

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders (user_id, total_amount, status) <span class="hljs-keyword">VALUES</span> 
    (<span class="hljs-number">1</span>, <span class="hljs-number">10299.98</span>, <span class="hljs-string">'completed'</span>),   <span class="hljs-comment">-- 吴邪：夜明珠+洛阳铲</span>
    (<span class="hljs-number">2</span>, <span class="hljs-number">88.88</span>, <span class="hljs-string">'pending'</span>),        <span class="hljs-comment">-- 张起灵：黑驴蹄子</span>
    (<span class="hljs-number">3</span>, <span class="hljs-number">1388.87</span>, <span class="hljs-string">'shipped'</span>);      <span class="hljs-comment">-- 王胖子：金刚伞+黑驴蹄子</span>

<span class="hljs-comment">-- 创建索引</span>
<span class="hljs-keyword">CREATE</span> INDEX IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> idx_users_email <span class="hljs-keyword">ON</span> users(email);
<span class="hljs-keyword">CREATE</span> INDEX IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> idx_products_category <span class="hljs-keyword">ON</span> products(category);
<span class="hljs-keyword">CREATE</span> INDEX IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> idx_orders_user_id <span class="hljs-keyword">ON</span> orders(user_id);
<span class="hljs-keyword">CREATE</span> INDEX IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> idx_orders_status <span class="hljs-keyword">ON</span> orders(status);
</code></pre>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- data/init_scripts/mysql.sql</span>
<span class="hljs-comment">-- MySQL测试数据库初始化</span>

<span class="hljs-comment">-- 创建用户表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> users (
    id <span class="hljs-type">INT</span> AUTO_INCREMENT <span class="hljs-keyword">PRIMARY</span> KEY,
    name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">UNIQUE</span>,
    created_at <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
);

<span class="hljs-comment">-- 创建产品表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> products (
    id <span class="hljs-type">INT</span> AUTO_INCREMENT <span class="hljs-keyword">PRIMARY</span> KEY,
    name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    price <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    category <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>),
    created_at <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
);

<span class="hljs-comment">-- 创建订单表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> orders (
    id <span class="hljs-type">INT</span> AUTO_INCREMENT <span class="hljs-keyword">PRIMARY</span> KEY,
    user_id <span class="hljs-type">INT</span>,
    total_amount <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    status <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'pending'</span>,
    created_at <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    <span class="hljs-keyword">FOREIGN</span> KEY (user_id) <span class="hljs-keyword">REFERENCES</span> users(id)
);

<span class="hljs-comment">-- 插入测试数据</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users (name, email) <span class="hljs-keyword">VALUES</span> 
    (<span class="hljs-string">'胡八一'</span>, <span class="hljs-string">'hubayii@example.com'</span>),
    (<span class="hljs-string">'王凯旋'</span>, <span class="hljs-string">'wangkaixuan@example.com'</span>),
    (<span class="hljs-string">'雪莉杨'</span>, <span class="hljs-string">'xueliyang@example.com'</span>);

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> products (name, price, category) <span class="hljs-keyword">VALUES</span> 
    (<span class="hljs-string">'摸金符'</span>, <span class="hljs-number">888.88</span>, <span class="hljs-string">'护身符'</span>),
    (<span class="hljs-string">'金刚伞'</span>, <span class="hljs-number">1588.88</span>, <span class="hljs-string">'防御装备'</span>),
    (<span class="hljs-string">'黑驴蹄子'</span>, <span class="hljs-number">66.66</span>, <span class="hljs-string">'镇邪用品'</span>),
    (<span class="hljs-string">'探照灯'</span>, <span class="hljs-number">299.99</span>, <span class="hljs-string">'照明装备'</span>);

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders (user_id, total_amount, status) <span class="hljs-keyword">VALUES</span> 
    (<span class="hljs-number">1</span>, <span class="hljs-number">955.54</span>, <span class="hljs-string">'completed'</span>),    <span class="hljs-comment">-- 胡八一：摸金符+黑驴蹄子</span>
    (<span class="hljs-number">2</span>, <span class="hljs-number">299.99</span>, <span class="hljs-string">'pending'</span>),      <span class="hljs-comment">-- 王凯旋：探照灯</span>
    (<span class="hljs-number">3</span>, <span class="hljs-number">1655.54</span>, <span class="hljs-string">'shipped'</span>);     <span class="hljs-comment">-- 雪莉杨：金刚伞+黑驴蹄子</span>

<span class="hljs-comment">-- 创建索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_users_email <span class="hljs-keyword">ON</span> users(email);
<span class="hljs-keyword">CREATE</span> INDEX idx_products_category <span class="hljs-keyword">ON</span> products(category);
<span class="hljs-keyword">CREATE</span> INDEX idx_orders_user_id <span class="hljs-keyword">ON</span> orders(user_id);
<span class="hljs-keyword">CREATE</span> INDEX idx_orders_status <span class="hljs-keyword">ON</span> orders(status);
</code></pre>
<h2 data-id="heading-8">第八步：使用 Docker 启动数据库（推荐），应用本地运行</h2>
<blockquote>
<p>你已在上一步准备好了 init.sql。首次启动容器（数据卷为空）时会自动执行这些脚本。</p>
</blockquote>
<p>在日常开发中，建议：</p>
<ul>
<li>应用代码直接在本地运行（便于调试与迭代）</li>
<li>PostgreSQL / MySQL 使用 Docker 启动（避免本机安装与版本差异）</li>
</ul>
<p>这样既轻量，又能快速切换数据库类型，满足“多数据库支持”的目标。</p>
<h3 data-id="heading-9">使用 docker-compose 启动数据库（PostgreSQL + MySQL）</h3>
<p>你可以为数据库单独准备一个 compose 文件（例如：docker-compose.db.yml），仅包含 Postgres 与 MySQL 服务：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># docker-compose.db.yml</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">postgres:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">postgres:15</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">POSTGRES_DB:</span> <span class="hljs-string">testdb_1</span>
      <span class="hljs-attr">POSTGRES_USER:</span> <span class="hljs-string">postgres</span>
      <span class="hljs-attr">POSTGRES_PASSWORD:</span> <span class="hljs-string">password</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"5432:5432"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">postgres_data:/var/lib/postgresql/data</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./data/init_scripts/postgresql.sql:/docker-entrypoint-initdb.d/init.sql</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">unless-stopped</span>
    <span class="hljs-attr">healthcheck:</span>
      <span class="hljs-attr">test:</span> [<span class="hljs-string">"CMD-SHELL"</span>, <span class="hljs-string">"pg_isready -U postgres -d testdb || exit 1"</span>]
      <span class="hljs-attr">interval:</span> <span class="hljs-string">10s</span>
      <span class="hljs-attr">timeout:</span> <span class="hljs-string">5s</span>
      <span class="hljs-attr">retries:</span> <span class="hljs-number">5</span>

  <span class="hljs-attr">mysql:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">mysql:8.0</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">MYSQL_ROOT_PASSWORD:</span> <span class="hljs-string">rootpassword</span>
      <span class="hljs-attr">MYSQL_DATABASE:</span> <span class="hljs-string">testdb_2</span>
      <span class="hljs-attr">MYSQL_USER:</span> <span class="hljs-string">testuser</span>
      <span class="hljs-attr">MYSQL_PASSWORD:</span> <span class="hljs-string">testpass</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"3306:3306"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">mysql_data:/var/lib/mysql</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./data/init_scripts/mysql.sql:/docker-entrypoint-initdb.d/init.sql</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">unless-stopped</span>
    <span class="hljs-attr">healthcheck:</span>
      <span class="hljs-attr">test:</span> [<span class="hljs-string">"CMD-SHELL"</span>, <span class="hljs-string">"mysqladmin ping -h 127.0.0.1 -ptestpass || exit 1"</span>]
      <span class="hljs-attr">interval:</span> <span class="hljs-string">10s</span>
      <span class="hljs-attr">timeout:</span> <span class="hljs-string">5s</span>
      <span class="hljs-attr">retries:</span> <span class="hljs-number">10</span>

<span class="hljs-attr">volumes:</span>
  <span class="hljs-attr">postgres_data:</span>
  <span class="hljs-attr">mysql_data:</span>
</code></pre>
<p>启动与验证：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动数据库容器</span>
docker-compose -f docker-compose.db.yml up -d

<span class="hljs-comment"># 查看状态</span>
docker-compose -f docker-compose.db.yml ps

<span class="hljs-comment"># 查看日志（可选）</span>
docker-compose -f docker-compose.db.yml logs -f postgres
docker-compose -f docker-compose.db.yml logs -f mysql
</code></pre>
<h3 data-id="heading-10">使用 docker run 启动单个数据库（不使用 compose）</h3>
<p>如果你只需要其中一个数据库：</p>
<p>PostgreSQL：</p>
<pre><code class="hljs language-bash" lang="bash">docker run -d --name pg15 \
  -e POSTGRES_DB=testdb \
  -e POSTGRES_USER=postgres \
  -e POSTGRES_PASSWORD=password \
  -p 5432:5432 \
  -v $(<span class="hljs-built_in">pwd</span>)/data/init_scripts/postgresql.sql:/docker-entrypoint-initdb.d/init.sql \
  postgres:15
</code></pre>
<p>MySQL：</p>
<pre><code class="hljs language-bash" lang="bash">docker run -d --name mysql8 \
  -e MYSQL_ROOT_PASSWORD=rootpassword \
  -e MYSQL_DATABASE=testdb \
  -e MYSQL_USER=testuser \
  -e MYSQL_PASSWORD=testpass \
  -p 3306:3306 \
  -v $(<span class="hljs-built_in">pwd</span>)/data/init_scripts/mysql.sql:/docker-entrypoint-initdb.d/init.sql \
  mysql:8.0
</code></pre>
<blockquote>
<p>Windows PowerShell 下将 <code>$(pwd)</code> 改为 <code>${PWD}</code>。</p>
</blockquote>
<h2 data-id="heading-11">第九步：测试脚本</h2>
<p>创建多数据库测试脚本：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
tests/test_mcp_tools.py - MCP 工具功能测试
"""</span>

<span class="hljs-keyword">import</span> pytest
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> mcp_datatools.database <span class="hljs-keyword">import</span> MultiDatabaseManager

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TestMCPTools</span>:
    <span class="hljs-string">"""MCP 工具功能测试类"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_database_type_detection</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""测试数据库类型检测 - MCP 工具需要知道数据库类型"""</span>
        <span class="hljs-comment"># SQLite</span>
        db_mgr = MultiDatabaseManager(<span class="hljs-string">"sqlite:///data/test.db"</span>)
        <span class="hljs-keyword">assert</span> db_mgr.db_type == <span class="hljs-string">"sqlite"</span>
        db_mgr.close()
        
        <span class="hljs-comment"># PostgreSQL</span>
        db_mgr = MultiDatabaseManager(<span class="hljs-string">"postgresql://user:pass@host:5432/db"</span>)
        <span class="hljs-keyword">assert</span> db_mgr.db_type == <span class="hljs-string">"postgresql"</span>
        db_mgr.close()
        
        <span class="hljs-comment"># MySQL</span>
        db_mgr = MultiDatabaseManager(<span class="hljs-string">"mysql+pymysql://user:pass@host:3306/db"</span>)
        <span class="hljs-keyword">assert</span> db_mgr.db_type == <span class="hljs-string">"mysql"</span>
        db_mgr.close()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_mcp_tool_get_database_info</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""测试 MCP 工具：获取数据库信息"""</span>
        db_url = <span class="hljs-string">"sqlite:///data/test.db"</span>
        db_mgr = MultiDatabaseManager(db_url)
        
        <span class="hljs-comment"># 测试 MCP 工具需要的数据库信息</span>
        info = db_mgr.get_database_info()
        
        <span class="hljs-comment"># 验证 MCP 工具返回的关键信息</span>
        <span class="hljs-keyword">assert</span> <span class="hljs-string">'type'</span> <span class="hljs-keyword">in</span> info
        <span class="hljs-keyword">assert</span> <span class="hljs-string">'url'</span> <span class="hljs-keyword">in</span> info
        <span class="hljs-keyword">assert</span> <span class="hljs-string">'tables_count'</span> <span class="hljs-keyword">in</span> info
        <span class="hljs-keyword">assert</span> info[<span class="hljs-string">'type'</span>] == <span class="hljs-string">"sqlite"</span>
        
        db_mgr.close()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_mcp_tool_list_tables</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""测试 MCP 工具：列出数据库表"""</span>
        db_url = <span class="hljs-string">"sqlite:///data/test.db"</span>
        db_mgr = MultiDatabaseManager(db_url)
        
        <span class="hljs-comment"># 测试 MCP 工具需要的表列表功能</span>
        tables = db_mgr.get_table_names()
        
        <span class="hljs-comment"># 验证返回格式</span>
        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">isinstance</span>(tables, <span class="hljs-built_in">list</span>)
        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(tables) &gt; <span class="hljs-number">0</span>  <span class="hljs-comment"># 应该有一些测试表</span>
        
        db_mgr.close()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_mcp_tool_execute_query</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""测试 MCP 工具：执行查询"""</span>
        db_url = <span class="hljs-string">"sqlite:///data/test.db"</span>
        db_mgr = MultiDatabaseManager(db_url)
        
        <span class="hljs-comment"># 测试 MCP 工具需要的查询功能</span>
        result = db_mgr.execute_query(<span class="hljs-string">"SELECT 1 as test_value"</span>)
        
        <span class="hljs-comment"># 验证返回格式</span>
        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">isinstance</span>(result, <span class="hljs-built_in">list</span>)
        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(result) == <span class="hljs-number">1</span>
        <span class="hljs-keyword">assert</span> result[<span class="hljs-number">0</span>][<span class="hljs-string">'test_value'</span>] == <span class="hljs-number">1</span>
        
        db_mgr.close()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_mcp_tool_query_safety</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""测试 MCP 工具：查询安全性"""</span>
        db_url = <span class="hljs-string">"sqlite:///data/test.db"</span>
        db_mgr = MultiDatabaseManager(db_url)
        
        <span class="hljs-comment"># 测试危险操作被阻止</span>
        dangerous_queries = [
            <span class="hljs-string">"DROP TABLE users"</span>,
            <span class="hljs-string">"DELETE FROM users"</span>,
            <span class="hljs-string">"UPDATE users SET name = 'hack'"</span>
        ]
        
        <span class="hljs-keyword">for</span> query <span class="hljs-keyword">in</span> dangerous_queries:
            <span class="hljs-keyword">with</span> pytest.raises(ValueError, <span class="hljs-keyword">match</span>=<span class="hljs-string">"查询包含危险操作"</span>):
                db_mgr.execute_query(query)
        
        db_mgr.close()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_postgresql_mcp_tools</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""测试 PostgreSQL 的 MCP 工具功能"""</span>
        db_url = <span class="hljs-string">"postgresql://postgres:password@localhost:5432/testdb_1"</span>
        
        <span class="hljs-keyword">try</span>:
            db_mgr = MultiDatabaseManager(db_url)
            
            <span class="hljs-comment"># 测试 MCP 工具在 PostgreSQL 上的功能</span>
            info = db_mgr.get_database_info()
            <span class="hljs-keyword">assert</span> info[<span class="hljs-string">'type'</span>] == <span class="hljs-string">"postgresql"</span>
            
            <span class="hljs-comment"># 测试查询</span>
            result = db_mgr.execute_query(<span class="hljs-string">"SELECT 1 as test"</span>)
            <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(result) == <span class="hljs-number">1</span>
            
            db_mgr.close()
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            pytest.skip(<span class="hljs-string">f"PostgreSQL不可用: <span class="hljs-subst">{e}</span>"</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_mysql_mcp_tools</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""测试 MySQL 的 MCP 工具功能"""</span>
        db_url = <span class="hljs-string">"mysql+pymysql://testuser:testpass@localhost:3306/testdb_2"</span>
        
        <span class="hljs-keyword">try</span>:
            db_mgr = MultiDatabaseManager(db_url)
            
            <span class="hljs-comment"># 测试 MCP 工具在 MySQL 上的功能</span>
            info = db_mgr.get_database_info()
            <span class="hljs-keyword">assert</span> info[<span class="hljs-string">'type'</span>] == <span class="hljs-string">"mysql"</span>
            
            <span class="hljs-comment"># 测试查询</span>
            result = db_mgr.execute_query(<span class="hljs-string">"SELECT 1 as test"</span>)
            <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(result) == <span class="hljs-number">1</span>
            
            db_mgr.close()
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            pytest.skip(<span class="hljs-string">f"MySQL不可用: <span class="hljs-subst">{e}</span>"</span>)
</code></pre>
<h2 data-id="heading-12">第十步：使用指南</h2>
<h3 data-id="heading-13">安装依赖</h3>
<pre><code class="hljs language-bash" lang="bash">uv <span class="hljs-built_in">sync</span>
</code></pre>
<h3 data-id="heading-14">启动MCP服务器</h3>
<pre><code class="hljs language-bash" lang="bash">uv run python -m mcp_datatools.server
</code></pre>
<h2 data-id="heading-15">第十一步：Cursor配置</h2>
<h3 data-id="heading-16">配置示例</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"mcp-datatools-sqlite"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"uv"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"run"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"--project"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"/path/to/project"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"python"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"-m"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"mcp_datatools.server"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"DB_URL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sqlite:///data/test.db"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"mcp-datatools-postgres"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"uv"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"run"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"--project"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"/path/to/project"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"python"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"-m"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"mcp_datatools.server"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"DB_URL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"postgresql://postgres:password@localhost:5432/testdb_1"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"mcp-datatools-mysql"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"uv"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"run"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"--project"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"/path/to/project"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"python"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"-m"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"mcp_datatools.server"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"DB_URL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"mysql+pymysql://testuser:testpass@localhost:3306/testdb_2"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-17">测试效果</h2>
<p>现在你可以测试多数据库功能：</p>
<p><strong>获取数据库信息：</strong></p>
<pre><code class="hljs">问：查询mysql数据库testdb_2的信息
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa8741cf63cd40698a0909837ac63062~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57qi6by75a2Q5pe25Luj:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975185&amp;x-signature=2WgX6z6TNJBJS31Pe7onVs4oYt0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>获取指定数据库的用户信息：</strong></p>
<pre><code class="hljs">问：testdb_1用户的信息
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/267c712062b34b15a347b1876e0ebeba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57qi6by75a2Q5pe25Luj:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975185&amp;x-signature=7gE0U69VuMlmEiilqI85bkeabfg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>连接池监控：</strong></p>
<pre><code class="hljs">问：testdb_1和testdb_2这2个数据库连接池状态如何？
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8824035a1ff44f85bb6e7ea47b5b4551~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57qi6by75a2Q5pe25Luj:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975185&amp;x-signature=wS6e9QahgLt1EdvIw%2BkIqogNDl4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-18">总结与预告</h2>
<p>这一篇我们成功实现了PostgreSQL、MySQL、SQLite多数据库支持，加上基础连接池配置、配置管理和使用 Docker 启动数据库环境，让MCP数据库工具从“玩具”升级为真正的生产级工具。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI智能体：完整课程(高级)]]></title>    <link>https://juejin.cn/post/7586136543954272294</link>    <guid>https://juejin.cn/post/7586136543954272294</guid>    <pubDate>2025-12-22T02:32:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586136543954272294" data-draft-id="7585808181239971891" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI智能体：完整课程(高级)"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-22T02:32:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="安思派Anspire"/> <meta itemprop="url" content="https://juejin.cn/user/3044964115417419"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI智能体：完整课程(高级)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3044964115417419/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    安思派Anspire
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:32:10.000Z" title="Mon Dec 22 2025 02:32:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">高级</h2>
<p>好了，欢迎来到高级部分。如果你已经走到这一步，说明你是认真想要构建能在现实世界中运行的真正的智能体系统。</p>
<p>那些让你从无到有做出原型的技术，却无法让你从原型走向量产。你需要不同的工具、不同的思维方式，以及更多的自律。</p>
<p>现在让我们来探讨一下这些内容。</p>
<h3 data-id="heading-1">多智能体系统的高级任务分解</h3>
<p>我们已经讨论过任务分解。但当你使用多智能体系统时，这会变得越来越复杂。</p>
<p>你可以使用四种主要模式来指导你做好这件事。BTW，我是从<a href="https://link.juejin.cn?target=https%3A%2F%2Fgerred.github.io%2Fbuilding-an-agentic-system%2Fcore-architecture.html" target="_blank" title="https://gerred.github.io/building-an-agentic-system/core-architecture.html" ref="nofollow noopener noreferrer">这篇很棒的博客</a>改编的 —— 查看更多细节！</p>
<p><strong>模式1：功能分解</strong></p>
<p>在这种模式下，我们按技术领域或专业知识来划分任务。这就是我们到目前为止在示例中一直在使用的方法——根据需要完成的工作类型来拆分任务。</p>
<p>按回车键或点击以查看全尺寸图像</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30eca7bbf0cd4809889cd27bd1e7f4b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a6J5oCd5rS-QW5zcGlyZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975560&amp;x-signature=B9w49YaiG8TSd7wiKYmBPNFxMiE%3D" alt="" loading="lazy"/></p>
<p>例如，你可以考虑全栈功能开发。这里有前端工作、后端逻辑、数据库变更，也许还有 API 更新。每一项都需要不同的知识和不同的工具。所以你要创建专门针对每个领域的智能体。</p>
<p><strong>模式2：空间分解</strong></p>
<p>你还可以按文件或目录结构进行拆分。当你处理包含许多可独立处理的文件的大型代码库时，这种方法尤其强大。</p>
<p>假设你正在进行大规模重构——也许是将所有 API 端点更新到新的身份验证系统，而且你在不同服务中有数十个文件。</p>
<p>你进行空间分解：</p>
<ul>
<li>
<p>代理1处理/services/users/*</p>
</li>
<li>
<p>代理2处理/services/orders/*</p>
</li>
<li>
<p>代理3处理 /services/payments/*</p>
</li>
<li>
<p>代理4处理/services/notifications/*</p>
</li>
</ul>
<p>在这种情况下，你可以通过确保代理在代码库的不同部分工作来减少冲突。他们可以并行工作。但如果你的文件相互之间存在复杂的依赖关系，空间分解就会失效。</p>
<p><strong>模式3：时间分解</strong></p>
<p>模式3是关于将任务分解为顺序阶段，其中后续阶段依赖于前期阶段的完成。</p>
<p>让我们以产品发布为例。你不能某天一觉醒来就开始发送促销邮件。这里有一个逻辑顺序：</p>
<p><strong>阶段1：市场调研</strong> — 分析竞争对手，调查目标客户，确定定位机会<strong>阶段2：发布规划</strong> — 确定信息传递内容，设定价格，制定时间表，确定渠道<strong>阶段3：资产创建</strong> — 撰写文案，设计图形，构建着陆页，准备邮件序列<strong>阶段4：发布与监控</strong> — 执行活动，跟踪指标，回应反馈，实时调整</p>
<p>每个阶段都有自己的代理或代理团队。阶段2直到阶段1完成并审核后才开始。</p>
<p><strong>模式4：数据驱动的分解</strong></p>
<p>最后，我们可以按数据分区进行拆分。这种方法不太常见，但对于某些用例非常强大，特别是涉及大型数据集的任务，在这些任务中，你可以对数据进行分区并独立处理各个数据块。</p>
<p>假设你正在分析应用程序日志以识别性能问题。你有上个月的数千兆字节的日志。</p>
<p>您可以按时间或按服务进行分区：</p>
<ul>
<li>
<p>代理1处理第1周的日志</p>
</li>
<li>
<p>代理2处理第2周的日志</p>
</li>
<li>
<p>代理3处理第3周的日志</p>
</li>
<li>
<p>代理4处理第4周的日志</p>
</li>
</ul>
<p>每个代理独立运行分析，然后在最后汇总结果。</p>
<p>你也可以混合使用这些模式。例如，一个全栈功能可能会对主要结构（前端、后端、数据库）使用功能分解，但后端代理在内部使用时间分解（设计 API → 实现逻辑 → 添加测试）。</p>
<h3 data-id="heading-2">提高质量</h3>
<p>好吧，假设到这一步我们已经有了一个运行中的系统，我们进行了全面评估以找出错误，但仍然对性能不满意。以下是应对措施。</p>
<p>首先要明白的是，你所处理的是两种根本不同类型的组件，它们需要不同的改进策略。</p>
<p>首先，我们有非大语言模型（LLM）组件。这些包括网络搜索、检索增强生成（RAG）检索、代码执行、语音识别、视觉模型、PDF解析器等。</p>
<p>这些可以通过两种主要方式加以改进：</p>
<ul>
<li>
<p>**调整参数。**调整诸如网络搜索日期范围、前k个结果、RAG块大小、相似度阈值等设置。</p>
</li>
<li>
<p>**或者，更换供应商。**尝试使用其他网络搜索 API、不同的 OCR 或视觉模型，等等。</p>
</li>
</ul>
<p>然后是大语言模型（LLM）组件。这些组件用于生成、提取、推理——在任何使用语言模型本身的地方。</p>
<p>我们可以做很多事情来改进这一部分：</p>
<ul>
<li>
<p>**优化提示。**添加明确的指令、约束和模式。使用少量输入输出对向模型展示你的需求。</p>
</li>
<li>
<p>**尝试其他模型。**有些模型更擅长遵循指令，有些则在代码或事实回忆方面表现出色。不要认为一种模型适用于所有情况。</p>
</li>
<li>
<p><strong>将艰巨的任务分解成更小的部分。</strong></p>
</li>
<li>
<p>**作为最后手段进行微调。**微调功能强大，但成本高昂。将其留到成熟系统中使用，在这些系统中，你需要提升最后几个百分点的质量，且已尝试过其他所有方法。</p>
</li>
</ul>
<h3 data-id="heading-3">降低延迟</h3>
<p>确保输出质量应该是你的第一步。之后，我们再来谈谈降低延迟。</p>
<ol>
<li>获取基线</li>
</ol>
<p>第一步是为工作流程中的每个步骤计时。你可能会发现，比如大语言模型（LLM）生成搜索词需要7秒，网络搜索需要5秒，撰写文章需要11秒，依此类推。</p>
<p>这为你提供了一个基线，让你知道应该优化什么。</p>
<p>2. 并行化</p>
<p>接下来，尽可能并行运行各项任务。例如网页抓取、多项搜索或解析多个文档。这往往是最容易实现的优化。</p>
<p>3. 合理调整模型规模</p>
<p>在任务简单（如关键词生成）的情况下，使用更小、更快的大语言模型（LLM），并将重量级模型留作综合和推理使用。</p>
<p>4. 尝试更快的供应商。</p>
<p>吞吐量和令牌流速度差异很大。优化服务的提供商可以在不改变任何提示的情况下节省数秒时间。</p>
<p>5. 最后，修剪上下文。</p>
<p>较短的提示和上下文意味着更快的解码速度，因此请尽量只保留该步骤真正需要的内容。</p>
<h3 data-id="heading-4">降低成本</h3>
<p>在质量高且延迟可控的情况下，你就可以开始考虑成本了。首先，你需要像测量延迟一样，测量每一步的成本。</p>
<p>代理系统有几个成本来源：</p>
<p>**大语言模型调用：**这由输入令牌和输出令牌决定。这些通常分开定价（输入令牌较便宜，输出令牌成本较高）。</p>
<p>**API****调用：**如网络搜索、PDF转换、图像生成、语音转文本等。这些通常按次或按单位计费。</p>
<p>**基础设施：**如果你正在运行自己的检索系统、向量数据库或用于代码执行的计算资源。</p>
<p>假设你正在构建一个撰写论文的研究代理。以下是一次运行可能的成本：</p>
<p>按回车键或点击以查看全尺寸图像</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b977c1f5a2c347e8b5b9b3959724ba78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a6J5oCd5rS-QW5zcGlyZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975560&amp;x-signature=7WSNk2vyZuqaQZJKugerD7a82ZU%3D" alt="" loading="lazy"/></p>
<p>如果你每天运行1000次，那就是每天80美元，或每月2400美元。</p>
<p>按回车键或点击以查看全尺寸图像</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/241da4e0af884d80aee5363080c1aecd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a6J5oCd5rS-QW5zcGlyZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975560&amp;x-signature=ofJOwKZA%2FyohtFjlx1rSWbCRjfo%3D" alt="" loading="lazy"/></p>
<p>一旦你知道每一步的成本，以下是你可以采取的优化措施：</p>
<ul>
<li>
<p>**先解决大开销的部分。**如果网络搜索每次调用花费2美分，而你每次运行调用10次，那就是20美分。尽最大努力减少调用次数、缓存结果或批量查询。</p>
</li>
<li>
<p>**对模型进行分层。**简单任务使用低成本模型，前沿模型仅在真正关键的地方使用。</p>
</li>
<li>
<p>**积极缓存。**像搜索响应、嵌入、块检索或中间摘要这样的确定性结果不应每次都重新计算。</p>
</li>
<li>
<p>**限制输出。**使用诸如 “返回包含这些必填字段的 JSON”、“最多提供 5 个要点” 之类的指令，要求输出结构化、简洁的结果。使用更少的令牌，降低费用。</p>
</li>
<li>
<p>**批量处理。**如果您要处理许多相似的项目，尽可能将操作捆绑在一起。例如，在AWS上，批量处理的成本仅为按需处理的50%。</p>
</li>
</ul>
<h3 data-id="heading-5">可观测性和监控</h3>
<p>你已经有了一个在质量、延迟和成本方面都让你满意的系统。现在我们需要确保它在扩展后仍能按预期运行。</p>
<p>这就是监控和可观测性发挥作用的地方。可观测性涵盖可调试性、质量监控和幻觉跟踪。基本上，任何有助于你观察智能体行为和性能的内容都属于可观测性范畴。</p>
<p>棘手的是，AI系统的可观测性与传统软件有着根本的不同。</p>
<p>使用传统软件时，你可以追踪到清晰的执行路径。函数A调用函数B，函数B查询数据库、返回数据、渲染页面，诸如此类。</p>
<p>由于多种不同原因，AI系统并非如此运作：</p>
<ul>
<li>
<p>它们是非确定性的。相同的输入可能会根据模型的响应产生不同的输出。你不能简单地重复请求并期望得到相同的结果。</p>
</li>
<li>
<p>他们通过并行运行的工具、代理生成子代理等方式实现分布式执行。</p>
</li>
<li>
<p>大量外部依赖项存在潜在的故障点，且这些故障点不受你控制。</p>
</li>
<li>
<p>还有更多！</p>
</li>
</ul>
<p>为了管理这一切，我们需要两种可见性：</p>
<ul>
<li>
<p><strong>“Zoom-in”指标</strong>可帮助您调试单次运行。这是您的完整跟踪信息：提示、工具调用、令牌使用情况、重试尝试以及每个决策点。基本上包含重现错误并确切找出错误发生位置所需的一切信息。</p>
</li>
<li>
<p><strong>“缩小”指标</strong>告诉你整个系统在多次运行中的表现。这包括自动质量检查（通常以大语言模型作为评判）、幻觉率、成功率/投资回报率（ROI）衡量指标，以及显示变化是有益还是有害的趋势线。</p>
</li>
</ul>
<p>你不仅要记录智能体做了什么，还要记录它这么做的原因。例如，你可能会记录这样的内容：“智能体选择使用网络搜索而非检索增强生成（RAG），因为查询中包含‘近期’”或“反思过程识别出3个问题：缺少引用、日期模糊、语气不当”</p>
<p>当你同时运行数千个智能体时，你无法手动查看每一条追踪信息。这就是<strong>质量抽样</strong>发挥作用的地方。与其深入检查每一次执行，你可以定义一个抽样率——比如，总运行次数的一定百分比——来评估质量和幻觉情况。然后，系统会使用这部分执行来计算智能体的整体质量得分和幻觉得分。</p>
<p>这使您能够对修复和改进领域进行优先级排序。</p>
<p>除了技术指标，你还需要了解用户行为。</p>
<ul>
<li>
<p>**人们实际在寻求什么？**他们是否按预期使用你的代理，还是找到了创造性的变通方法？</p>
</li>
<li>
<p>**他们在哪里卡住了？**他们会重新表述并再次尝试吗？这表明第一次尝试没有成功。</p>
</li>
<li>
<p>**他们如何处理输出结果？**如果他们立即要求修改，那么初始质量就不够好。</p>
</li>
<li>
<p>**会话时长是多少？**非常短的会话可能意味着快速成功或立即失败。非常长的会话可能意味着代理有能力但效率低下。</p>
</li>
</ul>
<p>这些定性数据与你的技术指标一样，都能为你的产品路线图提供指导。</p>
<h3 data-id="heading-6">安全</h3>
<p>最后，我们需要谈谈构建强大系统中最不令人兴奋但最重要的部分之一：安全。</p>
<p>就像可观测性一样，AI智能体的安全性与传统应用程序的安全性不同。你不仅要防范外部攻击者，实际上还必须防范自己的系统做出危险决策或被操纵而采取有害行动。</p>
<p>这些就是需要留意的事项：</p>
<ul>
<li>
<p>**提示注入：**用户输入或外部数据中的恶意内容，会劫持你的代理指令</p>
</li>
<li>
<p>**不安全的代码生成：**代理编写访问敏感数据或执行危险操作的代码</p>
</li>
<li>
<p>**数据泄露：**通过代理输出或工具调用暴露的PII或专有信息</p>
</li>
<li>
<p>**资源耗尽：**代理启动高成本操作或无限循环</p>
</li>
</ul>
<p>让我们特别深入探讨一下代码执行。代码执行是智能体的终极工具。它极其强大，因为智能体可以编写代码来生成图表、创建 Markdown 文件、处理数据，并且通常可以在你设定的边界内“为所欲为”。</p>
<p>这是一把双刃剑。</p>
<p>许多任务可以通过定义明确的自定义工具来完成，因此您的系统并不总是需要退回到自由形式的编码。但当您启用它时，您需要设置防护措施。</p>
<p>以下是安全执行代码的方法：</p>
<ul>
<li>
<p>**沙盒执行。**使用 Docker 或受限的运行器环境。将代码执行与主应用程序完全隔离。代码应在每次执行后销毁的容器中运行。</p>
</li>
<li>
<p>**资源限制。**设置超时时间、内存上限、CPU限制。阻止危险的导入操作、网络访问（除非明确需要），以及在指定临时目录之外的文件系统写入操作。</p>
</li>
<li>
<p>**仅使用白名单库。**允许使用特定的、安全的库，如pandas、numpy或datetime。不允许随意安装。如果代理需要某个库，你需要明确地将其添加到白名单中。</p>
</li>
<li>
<p>**验证加反思循环。**如果代码执行出错，捕获回溯信息并让模型修复代码。给它一到两次尝试机会，并确保设置了断路器。</p>
</li>
<li>
<p>**确定性输入/输出。**让代码返回一个小的、结构化的结果——一个数字、一个列表、一个JSON对象。然后你再为用户格式化这个结果。不要让代码直接向用户输出或写入他们可以访问的文件。</p>
</li>
<li>
<p>以及<strong>输入和输出的安全处理</strong>，确保所有输入在到达代理之前都经过验证，所有输出都经过扫描，以检查是否包含API密钥或PII等敏感数据。</p>
</li>
</ul>
<p>高级部分就到此结束啦！掌握了这些内容，你就准备好构建可扩展并在生产环境中为用户提供服务的真实系统了。</p>
<h2 data-id="heading-7">奖金</h2>
<p>但正如承诺的那样，我们还有一个额外福利要送给超级高手们。</p>
<p>我们今天讨论的大部分内容都假定你正在使用像LangGraph或CrewAI这样的框架。但如果你是一名对了解Claude Code等智能体工具内部工作原理感兴趣的开发者，我强烈推荐这篇关于智能体系统设计的博客：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgerred.github.io%2Fbuilding-an-agentic-system%2Fcore-architecture.html" target="_blank" title="https://gerred.github.io/building-an-agentic-system/core-architecture.html" ref="nofollow noopener noreferrer">gerred.github.io/building-an…</a></p>
<p>它探讨了诸如三个核心层（终端 UI、大语言模型 “智能” 层和工具层）、如何使用异步生成器构建响应式命令循环、流式传输 + 工具调用模式，甚至还涉及一个并行执行引擎和智能工具调度（读与写），这些在底层与支撑 Claude Code 和 Cursor 的技术极为相似。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[墨梅博客 MVP 发布与草梅 Auth 更新 | 2025 年第 51 周草梅周报]]></title>    <link>https://juejin.cn/post/7585808181239136307</link>    <guid>https://juejin.cn/post/7585808181239136307</guid>    <pubDate>2025-12-21T14:53:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585808181239136307" data-draft-id="7585743487259312137" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="墨梅博客 MVP 发布与草梅 Auth 更新 | 2025 年第 51 周草梅周报"/> <meta itemprop="keywords" content="GitHub,开源,AI编程"/> <meta itemprop="datePublished" content="2025-12-21T14:53:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="草梅友仁"/> <meta itemprop="url" content="https://juejin.cn/user/3043088413495815"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            墨梅博客 MVP 发布与草梅 Auth 更新 | 2025 年第 51 周草梅周报
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3043088413495815/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    草梅友仁
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T14:53:02.000Z" title="Sun Dec 21 2025 14:53:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd" target="_blank" title="https://blog.cmyr.ltd" ref="nofollow noopener noreferrer">草梅友仁的博客</a> 发布和更新，并在多个平台同步发布。如有更新，以博客上的版本为准。您也可以通过文末的 <code>原文链接</code> 查看最新版本。</p>
</blockquote>
<h2 data-id="heading-0">前言</h2>
<p>欢迎来到草梅周报！这是一个由草梅友仁基于 AI 整理的周报，旨在为您提供最新的博客更新、GitHub 动态、个人动态和其他周刊文章推荐等内容。</p>
<hr/>
<p>本周在开发 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCaoMeiYouRen%2Fmomei" target="_blank" title="https://github.com/CaoMeiYouRen/momei" ref="nofollow noopener noreferrer">墨梅 (Momei)</a> 中。</p>
<blockquote>
<p>您可以前往官网试用：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmomei.app%2F" target="_blank" title="https://momei.app/" ref="nofollow noopener noreferrer">momei.app/</a></p>
<p>也可以前往文档站来了解项目整体规划和未来开发路线图：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.momei.app%2F" target="_blank" title="https://docs.momei.app/" ref="nofollow noopener noreferrer">docs.momei.app/</a></p>
</blockquote>
<p>经过一段时间的高强度开发，在把 GitHub Copilot 用到上限，甚至还额外支出了几美元之后，我终于可以宣布 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmomei.app%2F" target="_blank" title="https://momei.app/" ref="nofollow noopener noreferrer">墨梅博客</a> 已经到了可以初步使用的地步。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17a11bffd39e47c3bfa24a737fdf8521~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5qKF5Y-L5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975816&amp;x-signature=kiU3%2FF8VfeqN6ViW1DYbzhdjzCo%3D" alt="QQ截图20251220232130" loading="lazy"/></p>
<p>当然了，距离真正上线肯定还有点距离，目前还存在不少问题要修。</p>
<p>不过作为一个开源项目，最重要的还是先把 MVP(最小可行性产品)版本端上来，先让用户看下大概的样子。</p>
<p>在当前进度中，已经完成了主页、文章页、登录注册页、后台管理页等多个页面的内容，并且支持国际化和暗色模式。</p>
<p>以下是部分页面的截图展示。</p>
<p>主页：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2288084f13a49f8ab5215d0e4d7e63f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5qKF5Y-L5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975816&amp;x-signature=qvajEszFz51dCQzFhZqA7VyYEY8%3D" alt="QQ截图20251221215342" loading="lazy"/></p>
<p>文章列表页：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4764a6b7af1f4e1d98ab673e1a2c07b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5qKF5Y-L5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975816&amp;x-signature=6xepqiou8BI1cC%2BeI415df4lv6k%3D" alt="QQ截图20251221215352" loading="lazy"/></p>
<p>正文页：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8125a12ed4494349a2d9b7512c818e2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5qKF5Y-L5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975816&amp;x-signature=8Owmewzz9YYyhjP9G3eH6ZshiQc%3D" alt="QQ截图20251221221235" loading="lazy"/></p>
<p>登录注册页：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c56beac9cb4452ebbe51daa3127b4ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5qKF5Y-L5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975816&amp;x-signature=DPa1Iy6Q%2F3bsTY6VwW8fursb%2B3s%3D" alt="QQ截图20251221215644" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75e5b62491d04edf8daa3ad2bbaec282~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5qKF5Y-L5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975816&amp;x-signature=LGGQabNewYWCB7CyFN5gW%2FZpg1s%3D" alt="QQ截图20251221215658" loading="lazy"/></p>
<p>国际化演示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81f1cad24e144ca79f7cff3b25cebd4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5qKF5Y-L5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975816&amp;x-signature=NAxAE6D%2Fi32vBcVotkbGkgkuGI8%3D" alt="QQ截图20251221215127" loading="lazy"/></p>
<p>暗色模式演示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd3c3999ec204f5ab8f7ee83fa7bf029~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5qKF5Y-L5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975816&amp;x-signature=57wBOeywHbZBIjgBR5sqdxbrdmg%3D" alt="QQ截图20251221215117" loading="lazy"/></p>
<p>当然，目前墨梅博客还有很多需要打磨的细节，页面和功能上也还不完善，如有任何意见和建议，都可以在项目的  <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCaoMeiYouRen%2Fmomei%2Fissues" target="_blank" title="https://github.com/CaoMeiYouRen/momei/issues" ref="nofollow noopener noreferrer">GitHub issues</a> 中提出。</p>
<blockquote>
<p>墨梅博客的 demo 站也会在后续部署。</p>
</blockquote>
<p>如果你也对墨梅博客感兴趣，欢迎参与开发和测试。</p>
<hr/>
<p>本周依旧在开发 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCaoMeiYouRen%2Fcaomei-auth" target="_blank" title="https://github.com/CaoMeiYouRen/caomei-auth" ref="nofollow noopener noreferrer">草梅 Auth</a> 中。</p>
<blockquote>
<p>你也可以直接访问官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fauth.cmyr.dev%2F" target="_blank" title="https://auth.cmyr.dev/" ref="nofollow noopener noreferrer">auth.cmyr.dev/</a>
Demo 站：<a href="https://link.juejin.cn?target=https%3A%2F%2Fauth-demo.cmyr.dev%2F" target="_blank" title="https://auth-demo.cmyr.dev/" ref="nofollow noopener noreferrer">auth-demo.cmyr.dev/</a>
文档地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fauth-docs.cmyr.dev%2F" target="_blank" title="https://auth-docs.cmyr.dev/" ref="nofollow noopener noreferrer">auth-docs.cmyr.dev/</a></p>
</blockquote>
<p>本周 草梅 Auth 发布了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCaoMeiYouRen%2Fcaomei-auth%2Freleases%2Ftag%2Fv1.12.1" target="_blank" title="https://github.com/CaoMeiYouRen/caomei-auth/releases/tag/v1.12.1" ref="nofollow noopener noreferrer">1.12.1</a> 版本。</p>
<p>本周主要是进行了 BUG 修复，以及替换 sqlite3 的数据库驱动为 better-sqlite3，以支持新版版本的 Node.js</p>
<p>如果你对草梅 Auth 感兴趣，欢迎参与开发和测试。</p>
<h2 data-id="heading-1">GitHub Release</h2>
<h3 data-id="heading-2">caomei-auth</h3>
<h4 data-id="heading-3"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCaoMeiYouRen%2Fcaomei-auth%2Freleases%2Ftag%2Fv1.12.1" target="_blank" title="https://github.com/CaoMeiYouRen/caomei-auth/releases/tag/v1.12.1" ref="nofollow noopener noreferrer">v1.12.1</a> - 2025-12-20 20:14:35</h4>
<p>摘要:
版本 1.12.1 (2025-12-20) 摘要：</p>
<p>Bug 修复：</p>
<ol>
<li>修正了 revokeConsentSchema 中 clientId 的错误提示信息格式问题</li>
<li>新增 secureRandom 函数以提高随机数生成的安全性</li>
<li>将数据库驱动更新为 better-sqlite3，并相应调整了配置</li>
</ol>
<h3 data-id="heading-4">cmyr-template-cli</h3>
<h4 data-id="heading-5"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCaoMeiYouRen%2Fcmyr-template-cli%2Freleases%2Ftag%2Fv1.43.0" target="_blank" title="https://github.com/CaoMeiYouRen/cmyr-template-cli/releases/tag/v1.43.0" ref="nofollow noopener noreferrer">v1.43.0</a> - 2025-12-18 21:15:33</h4>
<p>摘要:
版本 1.43.0 更新摘要：</p>
<p>新功能：</p>
<ul>
<li>新增支持创建 GitHub 仓库分支保护规则的功能</li>
</ul>
<p>Bug 修复：</p>
<ul>
<li>移除了 catch 块中的错误参数，简化了错误处理流程</li>
</ul>
<h2 data-id="heading-6">最新 GitHub 加星仓库</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhinesboy%2FmavonEditor" target="_blank" title="https://github.com/hinesboy/mavonEditor" ref="nofollow noopener noreferrer">CaoMeiYouRen starred mavonEditor</a> - 2025-12-20 23:26:42
基于 Vue 的 Markdown 编辑器，支持多种个性化功能。主要开发语言为 Vue，获得 6581 个星标。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FAyayaXiaowang%2FAyaya_Miliastra_Editor" target="_blank" title="https://github.com/AyayaXiaowang/Ayaya_Miliastra_Editor" ref="nofollow noopener noreferrer">CaoMeiYouRen starred Ayaya_Miliastra_Editor</a> - 2025-12-19 21:49:47
支持使用 Python 代码描述节点图，系统内置引擎可解析验证并自动排版，结合自动化脚本将步骤精准映射到实际编辑器。主要开发语言为 Python，项目获得 149 个星标。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgo-gitea%2Fgitea" target="_blank" title="https://github.com/go-gitea/gitea" ref="nofollow noopener noreferrer">CaoMeiYouRen starred gitea</a> - 2025-12-18 21:19:11
基于 Go 语言开发的一体化软件开发服务平台，提供 Git 托管、代码审查、团队协作、包注册表和 CI/CD 功能。该平台采用自托管方式，设计理念强调简单易用，目前已在 GitHub 获得超过 52,000 颗星标。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FheyManNice%2Fbili-cured-my-neck-pain" target="_blank" title="https://github.com/heyManNice/bili-cured-my-neck-pain" ref="nofollow noopener noreferrer">CaoMeiYouRen starred bili-cured-my-neck-pain</a> - 2025-12-15 17:34:52
B 站 PC 网页版新增视频旋转和缩放功能，使用 TypeScript 开发。该项目已获得 52 个星标。</li>
</ul>
<h2 data-id="heading-7">其他博客或周刊推荐</h2>
<h3 data-id="heading-8">阮一峰的网络日志</h3>
<ul>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.ruanyifeng.com%2Fblog%2F2025%2F12%2Fweekly-issue-378.html" target="_blank" title="http://www.ruanyifeng.com/blog/2025/12/weekly-issue-378.html" ref="nofollow noopener noreferrer">科技爱好者周刊（第 378 期）：预测是新的互联网热点</a> - 2025-12-19 08:06:47</li>
</ul>
<h3 data-id="heading-9">阿猫的博客</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fameow.xyz%2Farchives%2Fweekly-089" target="_blank" title="https://ameow.xyz/archives/weekly-089" ref="nofollow noopener noreferrer">猫鱼周刊 vol. 089 Vibe Engineering</a> - 2025-12-21 20:21:28</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fameow.xyz%2Farchives%2Fweekly-088" target="_blank" title="https://ameow.xyz/archives/weekly-088" ref="nofollow noopener noreferrer">猫鱼周刊 vol. 088 两个 Linus 的史诗级会面</a> - 2025-12-14 23:25:30</li>
</ul>
<h3 data-id="heading-10">潮流周刊</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fweekly.tw93.fun%2Fposts%2F250%2F" target="_blank" title="https://weekly.tw93.fun/posts/250/" ref="nofollow noopener noreferrer">第 250 期 - 北京的冬</a> - 2025-12-22 08:00:00</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fweekly.tw93.fun%2Fposts%2F249%2F" target="_blank" title="https://weekly.tw93.fun/posts/249/" ref="nofollow noopener noreferrer">第 249 期 - 美洲红鹮</a> - 2025-12-15 08:00:00</li>
</ul>
<h2 data-id="heading-11">总结</h2>
<p>本周的更新和动态如上所示。感谢您的阅读！
您可以通过以下方式订阅草梅周报的更新：</p>
<ul>
<li><strong>博客</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd" target="_blank" title="https://blog.cmyr.ltd" ref="nofollow noopener noreferrer">草梅友仁的博客</a></li>
<li><strong>墨梅博客</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmomei.app" target="_blank" title="https://momei.app" ref="nofollow noopener noreferrer">墨梅博客</a></li>
<li><strong>RSS</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd%2Fweekly.xml" target="_blank" title="https://blog.cmyr.ltd/weekly.xml" ref="nofollow noopener noreferrer">草梅周报</a></li>
<li><strong>公众号</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Foss.cmyr.dev%2Fimages%2F20241025184516839-21n2ctv.png" target="_blank" title="https://oss.cmyr.dev/images/20241025184516839-21n2ctv.png" ref="nofollow noopener noreferrer">草梅友仁的后花园</a></li>
<li><strong>邮箱订阅</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Flistmonk.cmyr.dev%2Fsubscription%2Fform" target="_blank" title="https://listmonk.cmyr.dev/subscription/form" ref="nofollow noopener noreferrer">草梅友仁的博客订阅</a></li>
</ul>
<h2 data-id="heading-12">往期回顾</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd%2Farchives%2F2025-50-caomei-weekly-caomei-auth-1-12-0-momei-blog.html" target="_blank" title="https://blog.cmyr.ltd/archives/2025-50-caomei-weekly-caomei-auth-1-12-0-momei-blog.html" ref="nofollow noopener noreferrer">草梅 Auth 1.12.0 发布与墨梅博客立项经验 | 2025 年第 50 周草梅周报</a> - 2025-12-14 20:25:28</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd%2Farchives%2F2025-49-caomei-weekly-caomei-auth-1-11-1-release-and-ai-refactoring.html" target="_blank" title="https://blog.cmyr.ltd/archives/2025-49-caomei-weekly-caomei-auth-1-11-1-release-and-ai-refactoring.html" ref="nofollow noopener noreferrer">草梅 Auth 1.11.1 版本发布与 AI 辅助代码重构实践 | 2025 年第 49 周草梅周报</a> - 2025-12-07 20:10:31</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd%2Farchives%2F2025-48-caomei-weekly-nano-banana-pro-ai-image-generation.html" target="_blank" title="https://blog.cmyr.ltd/archives/2025-48-caomei-weekly-nano-banana-pro-ai-image-generation.html" ref="nofollow noopener noreferrer">Nano Banana Pro AI 图像生成模型与创意实践 | 2025 年第 48 周草梅周报</a> - 2025-11-30 20:30:59</li>
</ul>
<p>本文作者：草梅友仁<br/>本文地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd%2Farchives%2F2025-51-caomei-weekly-momei-blog-mvp-caomei-auth-update.html" target="_blank" title="https://blog.cmyr.ltd/archives/2025-51-caomei-weekly-momei-blog-mvp-caomei-auth-update.html" ref="nofollow noopener noreferrer">blog.cmyr.ltd/archives/20…</a><br/>版权声明：本文采用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcreativecommons.org%2Flicenses%2Fby-nc-sa%2F4.0%2Fdeed.zh-hans" target="_blank" title="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans" ref="nofollow noopener noreferrer">CC BY-NC-SA 4.0 协议</a> 进行分发，转载请注明出处！<br/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[无人机低空视觉数据集全景解读：从单机感知到具身智能的跨越]]></title>    <link>https://juejin.cn/post/7585929179319566371</link>    <guid>https://juejin.cn/post/7585929179319566371</guid>    <pubDate>2025-12-22T02:48:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585929179319566371" data-draft-id="7585850609017061391" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="无人机低空视觉数据集全景解读：从单机感知到具身智能的跨越"/> <meta itemprop="keywords" content="算法,深度学习,计算机视觉"/> <meta itemprop="datePublished" content="2025-12-22T02:48:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            无人机低空视觉数据集全景解读：从单机感知到具身智能的跨越
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:48:20.000Z" title="Mon Dec 22 2025 02:48:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>年来，随着无人机技术的快速发展和低空经济政策的推进，无人机在智慧城市、交通巡检、应急救援等领域的应用日益广泛。然而，无人机的智能化离不开高质量视觉数据的支持。那么，当前有哪些公开的低空视觉数据集？它们又如何分类、有何特点？未来又将如何发展？</p>
<p>本文系统梳理近11年来低空无人机视觉数据集的发展脉络，为研究人员与应用开发者提供清晰的认知框架与实践参考。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c079482600534650af9b9e45b287c3e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=u%2BUK0w5drpVvrWJrxYLVYm0yMaQ%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-0"><strong>空视觉数据集：为什么如此重要？</strong></h2>
<p>低空视觉感知是无人机获取环境信息、实现自主决策的关键技术。无论是目标检测、跟踪、语义分割，还是无人机自主导航与协同作业，都离不开大量高质量、多样化的标注数据。</p>
<p>公开数据集的发布，不仅推动了算法研究的标准化，也降低了研究门槛，加速了技术落地。然而，随着任务复杂化和场景多元化，单一类型的数据已难以满足需求。因此，系统梳理现有数据集，明确其特点与适用场景，显得尤为重要。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96a2dcc979784b63880900a49611a8fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=WtvSuidyXXrFDsDG2Dx0IDac7j0%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-1"><strong>五大维度解析低空视觉数据集</strong></h2>
<p>论文提出了一套基于设备类型、任务需求、模态类型、环境特性、应用需求五大方向的分类体系，全面覆盖低空视觉数据集的构建逻辑与应用场景。</p>
<ul>
<li><strong>设备类型：单机 vs 多机</strong></li>
</ul>

<ul>
<li>单机数据集：由单一无人机采集，视角固定，适用于特定场景下的目标检测、跟踪等任务。代表数据集包括VisDrone、UAV123、AnimalDrone等。</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2cebeed6c9c46bea3dcd79cd2d562d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=TJOwlAQdm8Q26jx0%2BJU%2BXEQVJgQ%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>多机协同数据集：由多架无人机协同采集，覆盖多视角、跨场景，适用于立体安防、广域监测等高可靠性任务。代表数据集有MDOT、CoPerception-UAVs、MAVREC等。</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53671fadf524442caf1c932f1a110b45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=Vti6kTZTTvETmkM5Y1an7OgWXw0%3D" alt="图片" loading="lazy"/></p>
<p>展示了DOTA、SDD、DroneVehicle等数据集的典型图像，涵盖白天与夜间场景。</p>
<ul>
<li><strong>任务需求：单任务 vs 多任务</strong></li>
</ul>

<ul>
<li>单一任务数据集：专注如车辆检测、行人跟踪等单一任务，标注粒度集中。如VEDAI、COWC等。</li>
<li>多任务数据集：支持目标检测、跟踪、计数、行为分析等多个任务，标注信息更丰富。如VisDrone、DroneCrowd、UAV-Human等。</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74dfdb8e72854a8c956400a3bf294b3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=IqDqoPbsqlYS%2Bfz5HUdATL7WnIo%3D" alt="图片" loading="lazy"/></p>
<ul>
<li><strong>模态类型：单源 vs 多源</strong></li>
</ul>

<ul>
<li>单源数据集：仅包含可见光或红外等单一模态数据，适用于常规场景。</li>
<li>多源数据集：融合可见光、红外、深度、LiDAR等多种传感器数据，提升在夜间、遮挡等复杂场景下的感知鲁棒性。代表数据集包括DroneVehicle、DroneRGBT、UAV-Human等。</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e97660cf247415cab3a87e409c99463~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=Fek%2FAIc947TKmcf8lLo%2F7VA3NsM%3D" alt="图片" loading="lazy"/></p>
<p>展示了DroneVehicle、FIReStereo、SynDrone等多源数据的融合示例。</p>
<ul>
<li><strong>环境特性：复杂场景下的数据挑战</strong></li>
</ul>
<p>复杂环境数据集涵盖雾天、雨天、运动模糊、低光照等恶劣条件，用于提升模型在真实场景中的鲁棒性。代表数据集有HazyDet、UAVDT、UAV-AWID等。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/464cf1f3469348299840fa3965d78c3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=3Kpmb98F0S3zvTUkZZ5BIVUMRag%3D" alt="图片" loading="lazy"/></p>
<p>展示了雾天、雨天、运动模糊等复杂场景下的图像示例。</p>
<ul>
<li><strong>应用需求：视觉感知 vs 具身智能</strong></li>
</ul>

<ul>
<li>视觉感知数据集：侧重于目标识别与环境理解。</li>
<li>具身智能数据集：融合无人机状态、环境语义与任务指令，支持自主导航与决策。如CityNav、AeroVerse、OpenUAV等。</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c63a0a4e6f8244eb804108872c6134c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=lwRnnTxDBM0lm7oHMW3Sb5hLqYI%3D" alt="图片" loading="lazy"/></p>
<p>展示基于语言指令的无人机目标导航任务场景。</p>
<h2 data-id="heading-2"><strong>典型数据集深度解析</strong></h2>
<p>论文对各类别中的典型数据集进行了详细分析，涵盖数据规模、标注特点、适用任务等关键信息。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbe0b2abdce34b9fa4908ecf07a75da4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=x6fh5X%2BXuKNTTqrPoN8J2jZkXK4%3D" alt="图片" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbd72fb0602b4441a55c6385cf6fc430~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=pxhbdF3btwymFPs0qvidJxAxUFw%3D" alt="图片" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d7e8d92f62a424abeb26343c5cd2e1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=xRyKWKejEy4brgAYPwyJ0P3%2BtAw%3D" alt="图片" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11ea8687d097455482bd56695bf78c5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=4iY8qCae3y7X04sKeduhY8M%2F374%3D" alt="图片" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/241e0c5994354a97ad816ba1810e8be4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=jNunAMsSPRoytRSuNXwP%2FFour3c%3D" alt="图片" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d605b56a772347e4b986b7adb44c8840~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=ZO2XF56iVE5uCFAdE4YHsDQDPoo%3D" alt="图片" loading="lazy"/></p>
<ul>
<li><strong>单机数据集代表：VisDrone</strong></li>
</ul>
<p>发布年份：2018</p>
<p>数据量：超2000万张图像</p>
<p>特点：覆盖14个中国城市、多种天气与光照条件，支持检测、跟踪、计数等多任务。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/661f31660cca41188275e0d77cbd73ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=qz5UuYSPnx8HIqdGwDa8x0h%2FDUs%3D" alt="图片" loading="lazy"/></p>
<ul>
<li><strong>多机协同数据集代表：MDOT</strong></li>
</ul>
<p>发布年份：2021</p>
<p>特点：包含双机与三机协同数据，标注10种场景属性，支持多视角目标跟踪。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a13f807f76a4717bf8167771f9eddcb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=L7mrcB37a3PigqGwE3nnuUWZLZc%3D" alt="图片" loading="lazy"/></p>
<ul>
<li><strong>多任务数据集代表：DroneCrowd</strong></li>
</ul>
<p>发布年份：2021</p>
<p>特点：专注于无人机视角下的人群密度估计与行为分析，标注480万个头部位置。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ba8b3bf4fa647b9aeba5250ac0df997~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=dCCftwUsSR9vgFSRqMI3ei9y3Qk%3D" alt="图片" loading="lazy"/></p>
<ul>
<li><strong>多源数据集代表：DroneVehicle</strong></li>
</ul>
<p>发布年份：2020</p>
<p>特点：包含2.8万对RGB-红外图像，支持跨模态车辆检测，提升全天候感知能力。</p>
<ul>
<li><strong>具身智能数据集代表：AeroVerse</strong></li>
</ul>
<p>发布年份：2024</p>
<p>特点：融合视觉、语言与导航指令，支持无人机在复杂城市场景中的语义导航与任务规划。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4cf64aea48854bdfb0cddcb7dd333d22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=UTZDUEDJXK%2FkLFces7sj%2BKdQrV0%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-3"><strong>现状总结与未来展望</strong></h2>
<p>当前进展：</p>
<p>数据集体系初步形成，覆盖单机、多机、多任务、多源等多个维度。</p>
<p>数据规模与质量显著提升，推动了感知算法性能的进步。</p>
<p>仍存挑战：</p>
<p>标注成本高、效率低：尤其在多任务、多源场景下，人工标注仍占主导。</p>
<p>多源数据对齐难：不同模态数据之间存在时空同步误差。</p>
<p>极端环境数据稀缺：雨雪、雾霾等恶劣天气数据覆盖不足。</p>
<p>具身智能数据割裂：环境感知与无人机状态数据缺乏深度融合。</p>
<p>未来发展方向：</p>
<p>提升数据多样性与标注效率：结合合成数据与半自动标注技术。</p>
<p>推动多源数据标准化：制定统一的对齐、存储与评估标准。</p>
<p>加强极端环境数据建设：与气象部门合作，构建量化标注体系。</p>
<p>深化具身智能数据融合：构建“环境-机体-任务”一体化的数据集框架。</p>
<h2 data-id="heading-4"><strong>总结</strong></h2>
<p>低空视觉数据集作为无人机智能化的基石，正朝着多源融合、动态适应、语义理解、自主协同的方向快速发展。未来，随着仿真技术、自动化标注与跨模态学习方法的进步，我们有望构建更智能、更鲁棒、更贴近真实世界的低空视觉数据生态系统，赋能无人机在物流、安防、农业、救援等领域的深层次应用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文读懂分布式事务：核心原理、解决方案与实践思考]]></title>    <link>https://juejin.cn/post/7586481379590078483</link>    <guid>https://juejin.cn/post/7586481379590078483</guid>    <pubDate>2025-12-22T02:49:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586481379590078483" data-draft-id="7585778343352188991" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文读懂分布式事务：核心原理、解决方案与实践思考"/> <meta itemprop="keywords" content="后端,分布式"/> <meta itemprop="datePublished" content="2025-12-22T02:49:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="回家路上绕了弯"/> <meta itemprop="url" content="https://juejin.cn/user/536217404587134"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文读懂分布式事务：核心原理、解决方案与实践思考
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/536217404587134/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    回家路上绕了弯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:49:43.000Z" title="Mon Dec 22 2025 02:49:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一文读懂分布式事务：核心原理、解决方案与实践思考</h2>
<p>在单体应用时代，我们对事务的认知大多停留在“ACID”层面——一个操作要么全成，要么全败，数据库本身（如MySQL的InnoDB引擎）就能很好地保障这一点。但随着业务发展，系统拆分为微服务架构后，数据被分散到不同的数据库实例甚至不同类型的存储中间件中，“分布式事务”这个难题就摆在了我们面前。</p>
<p>比如电商下单场景：用户支付成功后，需要同时完成“扣减库存”“更新订单状态”“增加商家账户余额”三个操作，这三个操作分别对应库存服务、订单服务、账户服务的数据库。如何保证这三个操作要么全部成功，要么全部回滚？这就是分布式事务要解决的核心问题。今天，我们就从基础概念出发，拆解分布式事务的核心挑战，梳理主流解决方案，并聊聊实际落地中的取舍。</p>
<h3 data-id="heading-1">一、分布式事务的核心：为什么单体事务不适用了？</h3>
<p>首先要明确：分布式事务的本质是“跨多个资源节点的事务协调”，其核心目标依然是保障数据的一致性，但由于“分布式”的特性，单体事务的保障机制失效了。</p>
<p>在单体应用中，事务由数据库直接管理，依托本地锁和日志就能实现ACID：</p>
<ul>
<li>原子性（Atomicity）：依赖数据库的undo log，失败时回滚；</li>
<li>一致性（Consistency）：由业务逻辑和数据库约束共同保障；</li>
<li>隔离性（Isolation）：依赖数据库锁机制，避免并发问题；</li>
<li>持久性（Durability）：依赖数据库的redo log，确保提交后数据不丢失。</li>
</ul>
<p>但在分布式场景下，多个数据库实例之间无法共享锁和日志，存在三个核心挑战：</p>
<ol>
<li>网络不可靠：服务间通信可能出现延迟、超时、丢包，导致“部分操作成功、部分失败”；</li>
<li>节点故障：某个服务的数据库宕机，可能导致该节点的操作未完成，其他节点已完成；</li>
<li>数据分散：不同节点的数据无法实时同步，难以判断全局事务的状态。</li>
</ol>
<p>为了应对这些挑战，行业提出了多种分布式事务解决方案，核心思路都是“通过协调机制，确保多个节点的操作最终达成一致”，但在一致性、可用性、性能上各有取舍。</p>
<h3 data-id="heading-2">二、分布式事务主流解决方案：从理论到实践</h3>
<p>聊解决方案前，先提一个重要理论——CAP定理：分布式系统中，一致性（Consistency）、可用性（Availability）、分区容错性（Partition Tolerance）三者不可兼得，只能选其二。分布式事务的解决方案，本质上都是在CAP定理下的权衡。下面我们逐一拆解主流方案：</p>
<h4 data-id="heading-3">1. 2PC（两阶段提交）：最经典的“强一致性”方案</h4>
<p>2PC是分布式事务的“元老级”方案，核心思路是“分阶段协调”，引入一个“事务协调者”（TC）来统一管理所有参与者（TM，即各个服务的数据库）的事务状态。</p>
<p>两个阶段具体如下：</p>
<ul>
<li>准备阶段（Prepare）：协调者向所有参与者发送“准备请求”，参与者执行本地事务（但不提交），记录undo/redo log，然后向协调者返回“准备成功”或“准备失败”；</li>
<li>提交阶段（Commit/Rollback）：如果协调者收到所有参与者的“准备成功”，则发送“提交请求”，参与者执行提交操作并释放资源；如果有任何一个参与者返回“准备失败”，则发送“回滚请求”，参与者通过undo log回滚事务。</li>
</ul>
<p>优点：实现简单，强一致性，符合ACID；</p>
<p>缺点：① 性能差：准备阶段会锁定资源，直到整个分布式事务完成，并发场景下吞吐量低；② 可用性低：协调者是单点故障，若协调者宕机，所有参与者会处于“等待状态”，资源无法释放；③ 脑裂问题：若协调者在发送提交请求时宕机，部分参与者可能收到请求并提交，部分未收到，导致数据不一致。</p>
<p>适用场景：对一致性要求极高、并发量低的场景，如金融核心交易（但现在金融场景也更多用优化方案）。</p>
<h4 data-id="heading-4">2. 3PC（三阶段提交）：优化2PC的可用性问题</h4>
<p>3PC在2PC的基础上增加了“预提交阶段”，并引入了“超时机制”，试图解决2PC的单点故障和资源锁定问题。</p>
<p>三个阶段：</p>
<ul>
<li>CanCommit阶段：协调者询问参与者“是否可以执行事务”，参与者仅做可行性检查（不执行事务），返回yes/no；</li>
<li>PreCommit阶段：协调者收到所有yes后，发送“预提交请求”，参与者执行本地事务（不提交）；若有no，发送“中断请求”；</li>
<li>DoCommit阶段：协调者确认所有参与者预提交成功后，发送“提交请求”；若超时未收到确认，默认执行提交（区别于2PC的等待）。</li>
</ul>
<p>优点：解决了2PC协调者宕机后的资源锁定问题，可用性略有提升；</p>
<p>缺点：依然存在脑裂风险（如部分参与者未收到DoCommit请求，默认提交，而其他参与者回滚），且实现更复杂，实际应用较少。</p>
<h4 data-id="heading-5">3. TCC（Try-Confirm-Cancel）：柔性事务的“高性能”方案</h4>
<p>TCC是一种“业务侵入式”的柔性事务方案，核心思路是“将分布式事务拆分为三个本地事务”，由业务代码实现一致性，不依赖数据库的事务机制。</p>
<p>三个阶段的定义需要业务开发人员手动实现：</p>
<ul>
<li>Try阶段：尝试执行事务，做业务检查（如库存是否充足），并锁定资源（如冻结部分库存，而非直接扣减）；</li>
<li>Confirm阶段：确认执行事务，将Try阶段的锁定资源转为实际操作（如将冻结的库存扣减），该阶段必须保证成功；</li>
<li>Cancel阶段：取消事务，释放Try阶段锁定的资源（如解冻冻结的库存），恢复到初始状态。</li>
</ul>
<p>优点：① 性能高：所有操作都是本地事务，无锁等待，适合高并发场景；② 灵活性强：可根据业务定制逻辑，支持非关系型数据库（如Redis、MongoDB）；</p>
<p>缺点：① 业务侵入性强：需要开发人员手动实现Try/Confirm/Cancel三个接口，开发成本高；② 需处理幂等性：Confirm和Cancel可能因网络重试被多次调用，需保证重复执行结果一致；③ 补偿逻辑复杂：如Cancel阶段失败，需要人工介入处理。</p>
<p>适用场景：高并发、对一致性要求不是“强实时”的场景，如电商下单、支付退款。</p>
<h4 data-id="heading-6">4. SAGA模式：长事务的“补偿型”方案</h4>
<p>SAGA模式适用于“长事务”场景（如跨多个服务的复杂流程，执行时间长），核心思路是“将分布式事务拆分为一系列本地事务，每个本地事务完成后提交，若某个步骤失败，则通过补偿事务回滚前面所有已完成的步骤”。</p>
<p>SAGA有两种实现方式：</p>
<ul>
<li>编排式：引入一个“编排器”，由编排器统一协调所有本地事务的执行顺序和补偿顺序（如A→B→C成功，则正常结束；若C失败，则执行C的补偿→B的补偿→A的补偿）；</li>
<li>协同式：无编排器，每个服务通过消息通知下一个服务执行，失败时由当前服务通知上一个服务执行补偿（耦合度高，不推荐）。</li>
</ul>
<p>优点：① 支持长事务：无需锁定资源，适合执行时间长的场景；② 可用性高：每个本地事务独立提交，失败后通过补偿恢复；③ 低侵入性（编排式）：补偿逻辑由业务实现，但编排器统一管理流程；</p>
<p>缺点：① 一致性弱：属于最终一致性，中间状态可能存在数据不一致（如A、B已提交，C未提交，补偿前数据处于中间态）；② 补偿逻辑复杂：需为每个本地事务设计对应的补偿事务，且补偿事务可能失败。</p>
<p>适用场景：长事务场景，如供应链管理（采购→入库→付款→物流）、订单履约流程。</p>
<h4 data-id="heading-7">5. 本地消息表（事务消息）：基于消息队列的最终一致性方案</h4>
<p>该方案的核心思路是“将分布式事务转化为消息的可靠投递和消费”，依托消息队列的可靠性（如RocketMQ的事务消息、Kafka的事务机制），实现最终一致性。经典实现是“本地消息表+消息队列”：</p>
<ol>
<li>第一步：在发起方的数据库中创建“本地消息表”，记录需要发送的消息；</li>
<li>第二步：发起方执行本地事务（如扣减库存），并将消息插入本地消息表（同一本地事务，确保原子性）；</li>
<li>第三步：通过定时任务或消息队列的事务机制，将本地消息表中的消息投递到消息队列；</li>
<li>第四步：接收方消费消息，执行本地事务（如更新订单状态）；若消费失败，消息队列重试，直到消费成功；</li>
<li>第五步：发起方确认消息已被消费，删除本地消息表中的记录。</li>
</ol>
<p>优点：① 低侵入性：无需修改核心业务逻辑，仅需增加消息表和投递逻辑；② 高可用性：依托消息队列的重试机制，容错性强；③ 性能好：本地事务执行后异步投递消息，无锁等待；</p>
<p>缺点：① 一致性弱：属于最终一致性，存在中间态；② 需处理幂等性：消息可能被重复投递，接收方需保证重复消费无副作用；③ 仅适用于“一发起方多接收方”的单向流程，不支持复杂的双向交互。</p>
<p>适用场景：异步通知类场景，如电商下单后通知库存、物流、账户服务，用户注册后通知积分、消息服务。</p>
<h3 data-id="heading-8">三、解决方案选型：没有最好，只有最合适</h3>
<p>分布式事务的解决方案没有“银弹”，选型时需结合业务场景的一致性要求、并发量、系统复杂度等因素综合判断，以下是常见的选型建议：</p>



































<table><thead><tr><th>选型维度</th><th>推荐方案</th><th>不推荐方案</th></tr></thead><tbody><tr><td>强一致性、低并发</td><td>2PC（如金融核心交易）</td><td>TCC、SAGA（一致性不足）</td></tr><tr><td>高并发、最终一致性</td><td>TCC、本地消息表</td><td>2PC（性能差）</td></tr><tr><td>长事务、多步骤流程</td><td>SAGA模式（编排式）</td><td>2PC、3PC（资源锁定久）</td></tr><tr><td>异步通知、单向流程</td><td>本地消息表（事务消息）</td><td>TCC（开发成本高）</td></tr><tr><td>非关系型数据库场景</td><td>TCC、SAGA</td><td>2PC、3PC（依赖数据库事务）</td></tr></tbody></table>
<h3 data-id="heading-9">四、实际落地的关键注意事项</h3>
<p>无论选择哪种方案，落地时都需要关注以下几个核心问题，否则容易出现数据不一致：</p>
<ol>
<li>幂等性设计：所有分布式事务的参与者（尤其是补偿操作、消息消费）必须支持幂等，避免重复执行导致数据错误（如重复扣减库存）。常见方案：使用唯一ID（如订单号）作为幂等键，执行前先检查是否已处理；</li>
<li>超时处理：明确各阶段的超时时间，避免无限等待导致资源锁定或数据积压。如TCC的Try阶段超时，直接执行Cancel；消息消费超时，触发重试；</li>
<li>日志与监控：完善分布式事务的日志记录（如各阶段状态、执行时间、错误信息），便于问题排查；同时建立监控告警，及时发现事务失败、重试频繁等异常情况；</li>
<li>人工介入机制：对于无法自动补偿的异常（如补偿事务失败、数据损坏），必须提供人工介入通道，避免数据不一致长期存在。</li>
</ol>
<h3 data-id="heading-10">五、总结</h3>
<p>分布式事务的核心是“在分布式环境下保障数据一致性”，而其本质是CAP定理下的权衡——强一致性必然牺牲可用性和性能，最终一致性则通过牺牲实时性换取高可用和高并发。</p>
<p>实际开发中，我们不必追求“完美的一致性”，而是要根据业务场景选择合适的方案：金融核心场景优先保证强一致性（2PC），电商高并发场景优先选择最终一致性（TCC、本地消息表），长事务场景选择SAGA模式。同时，做好幂等性、超时处理、监控告警等落地细节，才能真正保障分布式事务的稳定运行。</p>
<p>最后，记住一个原则：能避免分布式事务，就尽量避免。通过业务设计（如合并服务、数据冗余）减少跨服务的数据操作，才是解决分布式事务问题的最优解。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零实现富文本编辑器#9-编辑器文本结构变更的受控处理]]></title>    <link>https://juejin.cn/post/7585778343352221759</link>    <guid>https://juejin.cn/post/7585778343352221759</guid>    <pubDate>2025-12-22T02:50:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585778343352221759" data-draft-id="7585825055437586438" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零实现富文本编辑器#9-编辑器文本结构变更的受控处理"/> <meta itemprop="keywords" content="前端,GitHub,架构"/> <meta itemprop="datePublished" content="2025-12-22T02:50:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="WindRunnerMax"/> <meta itemprop="url" content="https://juejin.cn/user/1829999989247214"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零实现富文本编辑器#9-编辑器文本结构变更的受控处理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1829999989247214/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    WindRunnerMax
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:50:48.000Z" title="Mon Dec 22 2025 02:50:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读27分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>先前我们主要处理了浏览器复杂<code>DOM</code>结构的默认行为，以及兼容<code>IME</code>输入法的各种输入场景，以此需要针对性地处理输入法和浏览器兼容的行为。在这里我们关注于处理文本结构性变更行为的处理，主要是针对行级别的操作、文本拖拽操作等，分别处于文本结构结构以及变更操作扩展。</p>
<ul>
<li>开源地址: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FWindRunnerMax%2FBlockKit" target="_blank" title="https://github.com/WindRunnerMax/BlockKit" ref="nofollow noopener noreferrer">github.com/WindRunnerM…</a></li>
<li>在线编辑: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwindrunnermax.github.io%2FBlockKit%2F" target="_blank" title="https://windrunnermax.github.io/BlockKit/" ref="nofollow noopener noreferrer">windrunnermax.github.io/BlockKit/</a></li>
<li>项目笔记: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FWindRunnerMax%2FBlockKit%2Fblob%2Fmaster%2FNOTE.md" target="_blank" title="https://github.com/WindRunnerMax/BlockKit/blob/master/NOTE.md" ref="nofollow noopener noreferrer">github.com/WindRunnerM…</a></li>
</ul>
<details>
<summary><strong>从零实现富文本编辑器系列文章</strong></summary>
<ul>
<li><a href="https://juejin.cn/post/7490554094412611636" target="_blank" title="https://juejin.cn/post/7490554094412611636">深感一无所长，准备试着从零开始写个富文本编辑器</a></li>
<li><a href="https://juejin.cn/post/7492339631700377652" target="_blank" title="https://juejin.cn/post/7492339631700377652">从零实现富文本编辑器#2-基于MVC模式的编辑器架构设计</a></li>
<li><a href="https://juejin.cn/post/7494920513967112227" target="_blank" title="https://juejin.cn/post/7494920513967112227">从零实现富文本编辑器#3-基于Delta的线性数据结构模型</a></li>
<li><a href="https://juejin.cn/post/7508648111485665295" target="_blank" title="https://juejin.cn/post/7508648111485665295">从零实现富文本编辑器#4-浏览器选区模型的核心交互策略</a></li>
<li><a href="https://juejin.cn/post/7513183180091523107" target="_blank" title="https://juejin.cn/post/7513183180091523107">从零实现富文本编辑器#5-编辑器选区模型的状态结构表达</a></li>
<li><a href="https://juejin.cn/post/7534162607894347828" target="_blank" title="https://juejin.cn/post/7534162607894347828">从零实现富文本编辑器#6-浏览器选区与编辑器选区模型同步</a></li>
<li><a href="https://juejin.cn/post/7544561402783793192" target="_blank" title="https://juejin.cn/post/7544561402783793192">从零实现富文本编辑器#7-基于组合事件的半受控输入模式</a></li>
<li><a href="https://juejin.cn/post/7562526517516812331" target="_blank" title="https://juejin.cn/post/7562526517516812331">从零实现富文本编辑器#8-浏览器输入模式的非受控DOM行为</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">从零实现富文本编辑器#9-编辑器文本结构变更的受控处理</a></li>
</ul>
</details>
<h2 data-id="heading-0">概述</h2>
<p>在当前我们主要聊的编辑器输入模式中，主要是关注于文本的半受控输入以及脏<code>DOM</code>的检测，输入状态同步是比较复杂且容易出问题的地方。而在这里我们则关注于输入同步行为扩展，例如回车、删除、拖拽文本等操作，相当于完善了编辑器整体输入模式的处理。</p>
<p>具体来说，执行换行和删除回车时会变更<code>DOM</code>结构，而删除文本以及拖拽文本同样是由<code>BeforeInput</code>等事件组合执行的，在编辑器中这些操作都是输入的一部分。此外，这些操作通常都是可以受控处理的，因此并不太容易出现脏<code>DOM</code>的问题，但是整体上还是有很多需要注意的点:</p>
<ul>
<li>回车操作通常需要拆分当前行结构，并且还需要关注到行格式的继承问题，特别是类似于列表等结构处理起来会更复杂一些。此外由于数据结构本身的设计不同，回车的操作实现也会有很大的差异，还有诸如软回车、硬回车等不同的回车类型。</li>
<li>删除操作同样会涉及行结构的处理，即删除回车时需要合并行结构，并且也会受到数据结构本身的影响，删除可能并不会符合操作直觉，因此需要手动校正行格式。并且删除的时候还需要关注<code>Unicode</code>字符的处理，特别是类似于<code>Emoji</code>等符号的删除需要特殊处理。</li>
<li>拖拽操作同样会涉及行结构的处理，而在我们的状态管理中本就是以行为单位进行管理的，因此拖拽行级结构相对会简单，当然实现的交互上还是有些工作量。而文本节点本身同样是可以拖拽的，因此我们同样需要根据选区范围进行文本的剪切和插入。</li>
</ul>
<h2 data-id="heading-1">回车操作</h2>
<p>在最开始的时候，我们就聊到了<code>ContentEditable</code>的不受控行为，特别是回车操作在不同浏览器中的表现是不一致的。在之前的例子中，我们就提到了回车操作在不同浏览器中的表现差异:</p>
<ul>
<li>在空<code>contenteditable</code>编辑器的情况下，直接按下回车键，在<code>Chrome</code>中的表现是会插入<code>&lt;div&gt;&lt;br&gt;&lt;/div&gt;</code>，而在<code>FireFox(&lt;60)</code>中的表现是会插入<code>&lt;br&gt;</code>，<code>IE</code>中的表现是会插入<code>&lt;p&gt;&lt;br&gt;&lt;/p&gt;</code>。</li>
<li>在有文本的编辑器中，如果在文本中间插入回车例如<code>123|123</code>，在<code>Chrome</code>中的表现内容是<code>123&lt;div&gt;123&lt;/div&gt;</code>，而在<code>FireFox</code>中的表现则是会将内容格式化为<code>&lt;div&gt;123&lt;/div&gt;&lt;div&gt;123&lt;/div&gt;</code>。</li>
<li>同样在有文本的编辑器中，如果在文本中间插入回车后再删除回车，例如<code>123|123-&gt;123123</code>，在<code>Chrome</code>中的表现内容会恢复原本的<code>123123</code>，而在<code>FireFox</code>中的表现则是会变为<code>&lt;div&gt;123123&lt;/div&gt;</code>。</li>
</ul>
<p>其实这些示例其实也写过很多次了，每次提到浏览器的不受控行为都会提到相关的差异，这些默认行为也变成了我们处理状态同步时需要关注的点。而实际上，关于回车的行为本身我们是可以受控处理的，即阻止其默认行为，然后根据当前的选区状态进行行结构的拆分和格式继承等处理。</p>
<p>通常来说，我们可以通过两种方式阻止默认行为，一种是监听<code>BeforeInput</code>事件并阻止其默认行为，另一种是监听<code>KeyDown</code>事件并阻止其默认行为。前者的好处是可以直接获取到事件的输入类型，例如软硬回车等，而后者的好处则是可以更早地阻止默认行为。</p>
<p>那么自然的我们还是借助<code>BeforeInput</code>事件来处理回车操作，这样会比较方便一些。那么这里的实现就比较简单，理论上来说我们只需要在数据结构中插入一个<code>\n</code>的<code>op</code>即可。此外由于我们的编辑器本身不支持软回车，因此这两种类型的回车都需要统一处理为硬回车。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">switch</span> (inputType) {
  <span class="hljs-keyword">case</span> <span class="hljs-string">"insertLineBreak"</span>:
  <span class="hljs-keyword">case</span> <span class="hljs-string">"insertParagraph"</span>: {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-property">perform</span>.<span class="hljs-title function_">insertBreak</span>(sel);
    <span class="hljs-keyword">break</span>;
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Perform</span> {
  public <span class="hljs-title function_">insertBreak</span>(<span class="hljs-params">sel: Range, attributes?: AttributeMap</span>) {
    <span class="hljs-keyword">const</span> raw = <span class="hljs-title class_">RawRange</span>.<span class="hljs-title function_">fromRange</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>, sel);
    <span class="hljs-keyword">const</span> start = raw.<span class="hljs-property">start</span>;
    <span class="hljs-keyword">const</span> len = raw.<span class="hljs-property">len</span>;
    <span class="hljs-keyword">const</span> delta = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Delta</span>().<span class="hljs-title function_">retain</span>(start);
    len &amp;&amp; delta.<span class="hljs-title function_">delete</span>(len);
    delta.<span class="hljs-title function_">insertEOL</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-property">state</span>.<span class="hljs-title function_">apply</span>(delta, { <span class="hljs-attr">range</span>: raw });
  }
}
</code></pre>
<p>这件事看起来并没有那么复杂，因为<code>DOM</code>的结构变更处理是由我们的<code>LineState</code>以及<code>Mutate</code>模块实现的，<code>Mutate</code>模块实现了<code>key</code>值的维护以及<code>immutable</code>。接下来，在<code>React</code>适配器中，我们就可以直接以<code>LineState</code>为基准渲染行结构，渲染这件事就自然而然地交给了<code>React</code>。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 数据同步变更, 异步批量绘制变更
 */</span>
<span class="hljs-keyword">const</span> onContentChange = <span class="hljs-title function_">useMemoFn</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setLines</span>(state.<span class="hljs-title function_">getLines</span>());
});

<span class="hljs-comment">/**
 * 监听内容变更事件, 更新当前块视图
 */</span>
<span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
  editor.<span class="hljs-property">event</span>.<span class="hljs-title function_">on</span>(<span class="hljs-variable constant_">EDITOR_EVENT</span>.<span class="hljs-property">CONTENT_CHANGE</span>, onContentChange);
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    editor.<span class="hljs-property">event</span>.<span class="hljs-title function_">off</span>(<span class="hljs-variable constant_">EDITOR_EVENT</span>.<span class="hljs-property">CONTENT_CHANGE</span>, onContentChange);
  };
}, [editor.<span class="hljs-property">event</span>, onContentChange]);
</code></pre>
<p><code>Mutate</code>模块实现的算法会比较复杂，这里就暂时先不展开了。简单来说，就是会根据当前的选区位置，找到对应的行结构，然后将其拆分为两行，并且继承当前行的格式属性。当然我们并不是<code>Case By Case</code>地处理，而是根据变更的<code>Delta</code>操作实现一个通用的变更模式。</p>
<p>看起来插入回车这件事就简单的结束了，然而实际上并没有，这件事复杂的点在于行格式的继承问题。在我们的<code>Mutate</code>的设计中，在行样式的处理上我们是完全遵循着<code>delta</code>的数据结构设计，即最后的<code>EOL</code>节点才承载行样式。</p>
<p>那么这样会造成一个比较反直觉的问题，如果我们直接在行中间插入<code>\n</code>的话，原本的行样式是会处于下一行的，因为本质上是因为<code>EOL</code>节点是在末尾的，此时插入<code>\n</code>自然原本的<code>EOL</code>是会直接跟随到下一行的。</p>
<p>这个问题本质上是由于<code>\n</code>太滞后了导致了，而如果我们将承载行内容的节点前提，也就是在行首加入<code>SOL-Start Of Line</code>节点，由该节点来承载样式，<code>\n</code>节点仅用于分割行，那么在执行<code>Mutate Insert</code>的时候自然就能很轻松地得到将行样式保留在上一行，而不是跟随到下一行。</p>
<p>但是这种方式很明显会因为破坏了原本的数据结构，因此导致整个状态管理发生新的问题，需要很多额外的<code>Case</code>来处理这个不需要渲染的节点所带来的问题。还有一种方案是在<code>Mutate Iterator</code>对象中加入<code>used</code>标记，当插入的节点为<code>\n</code>时会检查当前的存量<code>LineState</code>是否被复用过。</p>
<p>如果没有被复用过的话就直接将该<code>State</code>的<code>key</code>、<code>attrs</code>全部复用过来，当后续的<code>\n</code>节点再读区时则会因为已经复用过导致无法再复用，此时就是完全重新创建的新状态。</p>
<p>但是这里的问题是无法很好地保证第二个<code>\n</code>的实际值，也就是说破坏了我们原本的模型结构，其并不是交换式的，也无法将确定的新值传递到第二个<code>\n</code>上，而且在<code>Mutate Compose</code>的过程中做这件事是会导致真的需要实现这种效果时无法规避这个行为。</p>
<p>实际上<code>Quill</code>则是会存在同样的问题，我发现其如果直接执行插入<code>\n</code>的话也是会将样式跟随到下一行，那么其实这样就意味着其行样式继承是在回车的事件处理的，设想了一下这种方式的处理是合理的，这种情况下我们就可以是完全受控的情况处理。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// https://quilljs.com/playground/snow</span>
quill.<span class="hljs-title function_">updateContents</span>([{ <span class="hljs-attr">retain</span>: <span class="hljs-number">3</span> }, { <span class="hljs-attr">insert</span>: <span class="hljs-string">"\n"</span> }]);
</code></pre>
<p>那么回到编辑器回车这件事上，在行格式的继承上，如果接着上述的操作实现，则很容易地可以看出来行格式的继承问题。在下面的例子中，<code>quota</code>表示引用格式，如果在<code>Md</code>中引用是以<code>&gt;</code>在行首表示的，插入回车时原始行应该保持引用格式，而下面的例子中引用格式却仅表现在了新行。</p>
<pre><code class="hljs language-js" lang="js">[ { <span class="hljs-attr">insert</span>: <span class="hljs-string">"abc{caret}def"</span> }, { <span class="hljs-attr">insert</span>: <span class="hljs-string">"\n"</span>, <span class="hljs-attr">attributes</span>: { <span class="hljs-attr">quote</span>: <span class="hljs-string">"true"</span> } } ]
<span class="hljs-comment">// 插入回车后 =&gt;</span>
[ { <span class="hljs-attr">insert</span>: <span class="hljs-string">"abc"</span> }, { <span class="hljs-attr">insert</span>: <span class="hljs-string">"\n"</span> }, { <span class="hljs-attr">insert</span>: <span class="hljs-string">"{caret}def"</span> }, { <span class="hljs-attr">insert</span>: <span class="hljs-string">"\n"</span>, <span class="hljs-attr">attributes</span>: { <span class="hljs-attr">quote</span>: <span class="hljs-string">"true"</span> } } ]
</code></pre>
<p>那么在这里就需要区分多种情况，那么如果是在行首，就将当前属性全部带入下一行，即默认的行为。如果在末尾插入回车，则需要将下一行的属性全部清空，此时也需要合并传入的属性。如果在行中间插入属性，则需要拷贝当前行属性放置于当前插入的新行属性，如果此时存在传入的属性则同样需要合并。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// |xx(\n {y:1}) =&gt; (\n)xx(\n {y:1})</span>
<span class="hljs-comment">// xx|(\n {y:1}) =&gt; xx(\n {y:1})(\n)</span>
<span class="hljs-comment">// xx|(\n {y:1}) =&gt; xx(\n {y:1})(\n &amp; attributes)</span>
<span class="hljs-comment">// x|x(\n {y:1}) =&gt; x(\n {y:1})x(\n {y:1})</span>
<span class="hljs-comment">// x|x(\n {y:1}) =&gt; x(\n {y:1})x(\n {y:1 &amp; attributes})</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 当光标在行首时, 直接移动行属性</span>
<span class="hljs-comment">// |xx(\n {y:1}) =&gt; (\n)|xx(\n {y:1} &amp; attributes)</span>
<span class="hljs-keyword">if</span> (start === startLine.<span class="hljs-property">start</span>) {
  delta.<span class="hljs-title function_">insertEOL</span>();
  <span class="hljs-keyword">const</span> lineOffset = endLine.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>;
  delta.<span class="hljs-title function_">retain</span>(lineOffset - sel.<span class="hljs-property">end</span>.<span class="hljs-property">offset</span>).<span class="hljs-title function_">retain</span>(<span class="hljs-number">1</span>, attributes);
  point = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Point</span>(sel.<span class="hljs-property">start</span>.<span class="hljs-property">line</span> + <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);
  <span class="hljs-comment">// 当光标在行尾时, 将行属性保留在当前行</span>
  <span class="hljs-comment">// xx|(\n {y:1}) =&gt; xx(\n {y:1})(\n attributes)</span>
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (start === startLine.<span class="hljs-property">start</span> + startLine.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>) {
  delta.<span class="hljs-title function_">retain</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_">insertEOL</span>(attributes);
  point = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Point</span>(sel.<span class="hljs-property">start</span>.<span class="hljs-property">line</span> + <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);
  <span class="hljs-comment">// 当光标在行中时, 将行属性保留在当前行, 下一行合并新属性</span>
  <span class="hljs-comment">// x|x(\n {y:1}) =&gt; xx(\n {y:1})(\n {y:1} &amp; attributes)</span>
} <span class="hljs-keyword">else</span> {
  delta.<span class="hljs-title function_">insertEOL</span>(startLine.<span class="hljs-property">attributes</span>);
  <span class="hljs-keyword">const</span> lineOffset = endLine.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>;
  <span class="hljs-keyword">const</span> attrs = { ...startLine.<span class="hljs-property">attributes</span>, ...attributes };
  delta.<span class="hljs-title function_">retain</span>(lineOffset - sel.<span class="hljs-property">end</span>.<span class="hljs-property">offset</span>).<span class="hljs-title function_">retain</span>(<span class="hljs-number">1</span>, attrs);
}
</code></pre>
<h2 data-id="heading-2">删除操作</h2>
<p>删除操作同样是文本结构变更中比较重要的一个操作，而同样的删除也需要关注行结构的合并以及行格式的问题。首先聊的是相对简单的部分，删除文本片段内容，由于本身我们的选区是携带<code>Range</code>信息的，因此删除文本片段内容其实并没有什么复杂的地方，直接根据选区删除对应的内容即可。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Perform</span> {
  public <span class="hljs-title function_">deleteFragment</span>(<span class="hljs-params">sel: Range</span>) {
    <span class="hljs-keyword">if</span> (sel.<span class="hljs-property">isCollapsed</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">const</span> raw = <span class="hljs-title class_">RawRange</span>.<span class="hljs-title function_">fromRange</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>, sel);
    <span class="hljs-keyword">if</span> (!raw) <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">const</span> len = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(raw.<span class="hljs-property">len</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">const</span> start = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(raw.<span class="hljs-property">start</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> (start &lt; <span class="hljs-number">0</span> || len &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">const</span> delta = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Delta</span>().<span class="hljs-title function_">retain</span>(start).<span class="hljs-title function_">delete</span>(len);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-property">state</span>.<span class="hljs-title function_">apply</span>(delta, { <span class="hljs-attr">range</span>: raw });
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
  }
}
</code></pre>
<p>而删除本身还存在向前删除和向后删除的情况，因此我们需要分别处理<code>deleteContentBackward</code>和<code>deleteContentForward</code>两种输入类型。实际上这两种删除的实现是类似的，主要是计算删除的位置不同而已，但是也需要分别处理行首行末等情况。</p>
<p>处理<code>backward</code>删除时主要是处理行首删除的情况，即处于当前行的行首, 且存在行状态节点。此时分别处理上个节点为块节点、当前行存在行属性、当前行不存在行属性三种情况，这里的主要目标是删除时要删除当前行结构，以此更加符合操作直觉，并且将光标移动到合适的位置。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 处于当前行的行首, 且存在行状态节点</span>
<span class="hljs-keyword">if</span> (line &amp;&amp; sel.<span class="hljs-property">start</span>.<span class="hljs-property">offset</span> === <span class="hljs-number">0</span>) {
  <span class="hljs-keyword">const</span> prevLine = line &amp;&amp; line.<span class="hljs-title function_">prev</span>();
  <span class="hljs-comment">// 上一行为块节点且处于当前行首时, 删除则移动光标到该节点上</span>
  <span class="hljs-keyword">if</span> (prevLine &amp;&amp; <span class="hljs-title function_">isBlockLine</span>(prevLine)) {
  <span class="hljs-comment">// 当前行为空时特殊处理, 先删除掉该行</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isEmptyLine</span>(line)) {
      <span class="hljs-keyword">const</span> delta = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Delta</span>().<span class="hljs-title function_">retain</span>(line.<span class="hljs-property">start</span>).<span class="hljs-title function_">delete</span>(<span class="hljs-number">1</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-property">state</span>.<span class="hljs-title function_">apply</span>(delta, { <span class="hljs-attr">autoCaret</span>: <span class="hljs-literal">false</span> });
    }
    <span class="hljs-keyword">const</span> firstLeaf = prevLine.<span class="hljs-title function_">getFirstLeaf</span>();
    <span class="hljs-keyword">const</span> range = firstLeaf &amp;&amp; firstLeaf.<span class="hljs-title function_">toRange</span>();
    range &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-property">selection</span>.<span class="hljs-title function_">set</span>(range, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
  }
  <span class="hljs-keyword">const</span> attrsLength = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(line.<span class="hljs-property">attributes</span>).<span class="hljs-property">length</span>;
  <span class="hljs-comment">// 如果在当前行的行首, 且存在其他行属性, 则删除当前行的行属性</span>
  <span class="hljs-keyword">if</span> (attrsLength &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">const</span> delta = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Delta</span>().<span class="hljs-title function_">retain</span>(line.<span class="hljs-property">start</span> + line.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>).<span class="hljs-title function_">retain</span>(<span class="hljs-number">1</span>, <span class="hljs-title function_">invertAttributes</span>(line.<span class="hljs-property">attributes</span>));
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-property">state</span>.<span class="hljs-title function_">apply</span>(delta, { <span class="hljs-attr">autoCaret</span>: <span class="hljs-literal">false</span> });
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
  }
  <span class="hljs-comment">// 如果在当前行的行首, 且不存在其他行属性, 则将当前行属性移到下一行</span>
  <span class="hljs-keyword">if</span> (prevLine &amp;&amp; !attrsLength) {
    <span class="hljs-keyword">const</span> prevAttrs = { ...prevLine.<span class="hljs-property">attributes</span> };
    <span class="hljs-keyword">const</span> delta = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Delta</span>().<span class="hljs-title function_">retain</span>(line.<span class="hljs-property">start</span> - <span class="hljs-number">1</span>).<span class="hljs-title function_">delete</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_">retain</span>(line.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>).<span class="hljs-title function_">retain</span>(<span class="hljs-number">1</span>, prevAttrs);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-property">state</span>.<span class="hljs-title function_">apply</span>(delta);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
  }
}
</code></pre>
<p>而处理<code>forward</code>删除时主要是处理行末删除的情况，这个情况相对起来会更简单一些，此时并没处理复杂情况，因为其操作更不高频。如果此时光标位于块节点上，那么删除时直接执行当前块节点的删除操作即可。如果光标位于当前行的行末，且下一行为块节点，那么删除时则将光标移动到该块节点上。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 当前行为块结构时, 执行 backward 删除操作</span>
<span class="hljs-keyword">if</span> (line &amp;&amp; sel.<span class="hljs-property">start</span>.<span class="hljs-property">offset</span> === <span class="hljs-number">1</span> &amp;&amp; <span class="hljs-title function_">isBlockLine</span>(line)) { 
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">deleteBackward</span>(sel);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
}
<span class="hljs-keyword">const</span> nextLine = line &amp;&amp; line.<span class="hljs-title function_">next</span>();
<span class="hljs-comment">// 下一行为块节点且处于当前行末时, 删除则移动光标到该节点上</span>
<span class="hljs-keyword">if</span> (line &amp;&amp; sel.<span class="hljs-property">start</span>.<span class="hljs-property">offset</span> === line.<span class="hljs-property">length</span> - <span class="hljs-number">1</span> &amp;&amp; nextLine &amp;&amp; <span class="hljs-title function_">isBlockLine</span>(nextLine)) {
  <span class="hljs-keyword">const</span> firstLeaf = nextLine.<span class="hljs-title function_">getFirstLeaf</span>();
  <span class="hljs-keyword">const</span> range = firstLeaf &amp;&amp; firstLeaf.<span class="hljs-title function_">toRange</span>();
  range &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-property">selection</span>.<span class="hljs-title function_">set</span>(range, <span class="hljs-literal">true</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>在删除内容这里最需要关注的其实是视图层问题，当与<code>React</code>结合的视图层面更新时，同样也会出现非受控行为的问题，这里的不受控是<code>React</code>数据层及其渲染层的问题。其实，这里本质上还是跟<code>IME</code>输入的<code>DOM</code>变更有关。</p>
<p>具体来说，当选区存在跨节点行为时，无论是行内还是跨行的选区，唤醒输入法<code>Composing</code>输入内容后，这部分节点内容会被删除，并且替换为输入的内容。但是当确定内容之后，编辑器便会崩溃，这也是删除与插入的合并操作造成的问题，报错内容如下:</p>
<pre><code class="hljs language-csharp" lang="csharp">Failed to execute <span class="hljs-string">'removeChild'</span> <span class="hljs-keyword">on</span> <span class="hljs-string">'Node'</span>: The node to be removed <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> a child of <span class="hljs-keyword">this</span> node.
</code></pre>
<p>从报错上来看，<code>React</code>会将子节点从父节点移除，这本身是非常合理的行为。举个例子，当实现一个列表时，如果数据源删除了某些节点，那么<code>React</code>就会将对应的<code>DOM</code>节点自动移除掉，也就是不需要操作<code>DOM</code>，而是可以直接通过声明式的方式来实现变更。</p>
<p>那么这里的问题就出现在这些<code>DOM</code>已经实际上被移除了，因此当<code>React</code>尝试移除这些节点时就会报错，而这个异常会导致整个编辑器崩溃，因此我们就需要避免这个情况的发生。那么首先就需要避免<code>removeChild</code>的异常，我们很难直接避免<code>React</code>的行为，因此只能在<code>DOM</code>节点上进行拦截。</p>
<p>然而，即使是在<code>DOM</code>上处理拦截行为也并不容易，<code>removeChild</code>方法是在<code>Node</code>对象上的，如果我们直接重写<code>Node.prototype.removeChild</code>方法，那么就会影响到整个页面的<code>DOM</code>节点，因此我们只能尝试在编辑器的<code>ref</code>上处理。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 重写 removeChild 方法
 * - 避免 IME 破坏跨节点渲染造成问题
 * - https://github.com/facebookarchive/draft-js/issues/1320
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">rewriteRemoveChild</span> = (<span class="hljs-params">node: Node</span>) =&gt; {
  <span class="hljs-keyword">const</span> removeChild = <span class="hljs-title class_">Node</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">removeChild</span>;
  node.<span class="hljs-property">removeChild</span> = <span class="hljs-keyword">function</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Node</span>&gt;(<span class="hljs-attr">child</span>: T) {
    <span class="hljs-keyword">if</span> (child.<span class="hljs-property">parentNode</span> !== <span class="hljs-variable language_">this</span>) <span class="hljs-keyword">return</span> child;
    <span class="hljs-keyword">return</span> removeChild.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, child) <span class="hljs-keyword">as</span> T;
  };
};
</code></pre>
<p>然而编辑器本身会存在大量的<code>DOM</code>节点，我们很难在所有的节点上进行重写，因此我们还需要限制<code>DOM</code>变动的范围。在<code>React</code>中控制重渲染的方式可以通过<code>key</code>来实现，因此就需要在<code>IME</code>输入起始时刷新相关节点的<code>key</code>，以此来避免<code>React</code>复用这些节点，然后刷新范围就限制在了行节点上。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 组合输入开始
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">event</span>
 */</span>
@<span class="hljs-title class_">Bind</span>
protected <span class="hljs-title function_">onCompositionStart</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 需要强制刷新 state.key, 且需要配合 removeChild 避免抛出异常</span>
  <span class="hljs-keyword">const</span> sel = <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-property">selection</span>.<span class="hljs-title function_">get</span>();
  <span class="hljs-keyword">if</span> (!sel || sel.<span class="hljs-property">isCollapsed</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = sel.<span class="hljs-property">start</span>.<span class="hljs-property">line</span>; i &lt;= sel.<span class="hljs-property">end</span>.<span class="hljs-property">line</span>; ++i) {
    <span class="hljs-keyword">const</span> line = <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-property">state</span>.<span class="hljs-property">block</span>.<span class="hljs-title function_">getLine</span>(i);
    line &amp;&amp; line.<span class="hljs-title function_">forceRefresh</span>();
  }
}
</code></pre>
<p>然后在<code>React</code>控制节点的部分，就需要将重写的逻辑加入到块节点以及行节点的<code>DOM</code>上，以此来避免异常的发生。这里还需要避免<code>ref</code>函数的重复执行，<code>React</code>的特性是如果<code>ref</code>引用不同就会原始的引用再调用新的方法，因此这里需要借助<code>useMemoFn</code>实现。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> setModel = <span class="hljs-title function_">useMemoFn</span>(<span class="hljs-function">(<span class="hljs-params">ref: HTMLDivElement | <span class="hljs-literal">null</span></span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (ref) {
    <span class="hljs-title function_">rewriteRemoveChild</span>(ref);
  }
});
</code></pre>
<p>从本质上来看，是执行输入法时没有办法控制<code>DOM</code>的变更行为，或者阻止浏览器的默认行为。但是我们却可以在<code>start</code>的时候就执行相关的处理，类似于将<code>end</code>时的删除且插入的行为分离出来，也就是说先执行<code>deleteFragment</code>方法，将所有的<code>DOM</code>直接通过先移除掉来同步行为。</p>
<p>但是这里又出现了新的问题，因为本身的<code>delete</code>方法会将选区内的内容全部删除，这样的话会导致唤醒<code>IME</code>时，选区所在的<code>DOM</code>节点会被删除。因此浏览器会将光标兜底到当前行的起始位置，虽然不影响最终输入的内容，但是在输入的时候就可以明显地看出来问题，有些影响用户体验。</p>
<p>在这里其实还可以考虑一种实现，在组合输入时同样会删除选区的内容，但是保留光标所在的<code>DOM</code>节点，这个实现就会很复杂。其实如果能在唤醒输入法前就将选区删除并且再设置好光标位置，再出现输入法的话，倒是就不会出现这个问题，然而目前并没有相关的<code>API</code>可以实现这样的行为。</p>
<p>但是在后期研究<code>slate</code>的实现发现，其仅仅是在<code>IME</code>组合输入开始的时候删除了相关的节点，而我们的编辑器却无法做到。经过排查之后发现是更新内容后的浏览器选区事件被我们阻止了，但是这里的表现也比较奇怪，阻止了选区更新竟然会导致行的该节点后的所有节点都无法渲染出来。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Input</span> {
  @<span class="hljs-title class_">Bind</span>
  protected <span class="hljs-title function_">onCompositionStart</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 避免 IME 破坏跨节点渲染造成问题</span>
    <span class="hljs-keyword">const</span> sel = <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-property">selection</span>.<span class="hljs-title function_">get</span>();
    <span class="hljs-keyword">if</span> (!sel || sel.<span class="hljs-property">isCollapsed</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-property">perform</span>.<span class="hljs-title function_">deleteFragment</span>(sel);
  }
}
</code></pre>
<p>因此在这里放行选区更新的事件，即在<code>Update Effect</code>时不再通过<code>Composing</code>状态阻止选区的更新行为，这样就可以避免上述的问题了。然而这里的表现确实是非常奇怪的，<code>React</code>确实是持有了<code>DOM</code>状态，而改动就是这里的更新选区行为，选区本身导致节点无法正常渲染实在是有点费解。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> selection = editor.<span class="hljs-property">selection</span>.<span class="hljs-title function_">get</span>();
  <span class="hljs-comment">// 渲染完成后更新浏览器选区</span>
  <span class="hljs-keyword">if</span> (editor.<span class="hljs-property">state</span>.<span class="hljs-title function_">isFocused</span>() &amp;&amp; selection) {
    editor.<span class="hljs-property">logger</span>.<span class="hljs-title function_">debug</span>(<span class="hljs-string">"UpdateDOMSelection"</span>);
    editor.<span class="hljs-property">selection</span>.<span class="hljs-title function_">updateDOMSelection</span>(<span class="hljs-literal">true</span>);
  }
});
</code></pre>
<h3 data-id="heading-3">Emoji 处理</h3>
<p><code>Unicode</code>可以视为<code>Map</code>，可以从数值<code>code point</code>映射到具体的字形，这样就可以直接引用符号而不需要实际使用符号本身。可能的代码点值范围是从<code>U+0000</code>到<code>U+10FFFF</code>，有超过<code>110</code>万个可能的符号，为了保持条理性，<code>Unicode</code>将此代码点范围划分为<code>17</code>个平面。</p>
<p>首个平面<code>U+0000 -&gt; U+FFFF</code>称为基本多语言平面或<code>BMP</code>，包含了最常用的字符。这样<code>BMP</code>之外就剩下大约<code>100</code>万个代码点<code>U+010000 -&gt; U+10FFFF</code>，这些代码点所属的平面称为补充平面或星面。</p>
<p><code>JavaScript</code>的单个字符由无符号的<code>16</code>位整数支持，因此其无法容纳任何高于<code>U+FFFF</code>的代码点，而是需要将其拆分为代理对。这其实就是<code>JS</code>的<code>UCS-2</code>编码形式，造成了所有字符在<code>JS</code>中都是<code>2</code>个字节，而如果是<code>4</code>个字节的字符，那么就会当作两个双字节的字符处理即代理对。</p>
<p>其实这么说起来<code>UTF-8</code>的变长<code>1-4</code>字节的编码是无法表示的，代理对自然是可以解决这个问题。而表达<code>UTF-16</code>的编码长度要么是<code>2</code>个字节，要么是<code>4</code>个字节。在<code>ECMAScript 6</code>中引入了新的表达方式，但是为了向后兼容<code>ECMAScript 5</code>依然可以用代理对的形式表示星面。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-string">"\u{1F3A8}"</span>
<span class="hljs-comment">// 🎨</span>
<span class="hljs-string">"\uD83C\uDFA8"</span>
<span class="hljs-comment">// 🎨</span>
</code></pre>
<p>实际上在<code>ES6</code>中引入的函数也解决了字符串遍历的问题，正则表达式也提供了<code>u</code>修饰符来处理<code>4</code>字节的字符。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-string">"1🎨1"</span>)
<span class="hljs-comment">// ["1", "🎨", "1"]</span>
/^.<span class="hljs-property">$</span>/u.<span class="hljs-title function_">test</span>(<span class="hljs-string">"🎨"</span>)
<span class="hljs-comment">// true</span>
<span class="hljs-string">"1🎨1"</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">""</span>)
<span class="hljs-comment">// ["1", "\uD83C", "\uDFA8", "1"]</span>
</code></pre>
<p>另外在基本平面即低位代理对内，从<code>U+D800</code>到<code>U+DFFF</code>是一个空段，即这些码点不对应任何字符，自然可以避免原本基本平面的冲突，因此可以用来映射辅助平面的字符。高位<code>[\uD800-\uDBFF]</code>与低位<code>[\uDC00-\uDFFF]</code>恰好是<code>2^10 * 2^10</code>长度，恰好<code>100</code>多万个代码点。</p>
<pre><code class="hljs language-js" lang="js">(<span class="hljs-number">0xDBFF</span> - <span class="hljs-number">0xD800</span> + <span class="hljs-number">1</span>) * (<span class="hljs-number">0xDFFF</span> - <span class="hljs-number">0xDC00</span> + <span class="hljs-number">1</span>) = <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> = <span class="hljs-number">1048576</span>
</code></pre>
<p>虽然可以已经用<code>Unicode</code>代理对的方式表达<code>4</code>字节符号，但是类似<code>Emoji</code>这些符号是可以组合的。那么这样会导致字形上看起来是单个字符，实际上是通过<code>\u200d</code>即<code>ZWJ</code>组合起来的字符，因此其长度会更长，且<code>ES6</code>的函数也是会将其拆离表现的。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-string">"🧑"</span> + <span class="hljs-string">"\u200d"</span> + <span class="hljs-string">"🎨"</span>
<span class="hljs-comment">// 🧑‍🎨</span>
<span class="hljs-string">"🧑‍🎨"</span>.<span class="hljs-property">length</span>
<span class="hljs-comment">// 5</span>
<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-string">"🧑‍🎨"</span>)
<span class="hljs-comment">// ["🧑", "‍", "🎨"]</span>
</code></pre>
<p>因此，在这里我们需要在删除之前判断即将要删除的文本长度，这本身其实是可以有多种方式来实现的。例如我们即将要提到的词级别的内容删除，将其转换为非受控的状态来删除，而在这里我们则是通过计算末尾的<code>Unicode</code>字符长度来实现删除。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 获取末尾 Unicode 字符长度
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">str</span>
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getLastUnicodeLen</span> = (<span class="hljs-params">str: string | P.Nil</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!str || str.<span class="hljs-property">length</span> &lt; <span class="hljs-number">2</span>) {
    <span class="hljs-keyword">return</span> str ? str.<span class="hljs-property">length</span> : <span class="hljs-number">0</span>;
  }
  <span class="hljs-keyword">const</span> first = str.<span class="hljs-title function_">charCodeAt</span>(str.<span class="hljs-property">length</span> - <span class="hljs-number">2</span>);
  <span class="hljs-keyword">const</span> second = str.<span class="hljs-title function_">charCodeAt</span>(str.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>);
  <span class="hljs-keyword">if</span> (<span class="hljs-number">0xd800</span> &lt; first &amp;&amp; first &lt; <span class="hljs-number">0xdbff</span> &amp;&amp; <span class="hljs-number">0xdc00</span> &lt; second &amp;&amp; second &lt; <span class="hljs-number">0xdfff</span>) {
    <span class="hljs-comment">// 此时基本 Unicode 字符长度为 2</span>
    <span class="hljs-keyword">let</span> len = <span class="hljs-number">2</span>;
    <span class="hljs-comment">// 通过连接符号来组合单个 Unicode 字符长度</span>
    <span class="hljs-comment">// [-][-] \u200d [-][-] \u200d [-][-]</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = str.<span class="hljs-property">length</span> - <span class="hljs-number">3</span>; i &gt; <span class="hljs-number">0</span>; i = i - <span class="hljs-number">3</span>) {
      <span class="hljs-keyword">if</span> (str[i].<span class="hljs-title function_">charCodeAt</span>(<span class="hljs-number">0</span>) !== <span class="hljs-number">0x200d</span>) <span class="hljs-keyword">break</span>;
      len = len + <span class="hljs-number">3</span>;
    }
    <span class="hljs-keyword">return</span> len;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
};
</code></pre>
<h3 data-id="heading-4">词级文本处理</h3>
<p>先前我们针对<code>Emoji</code>的删除做了特殊处理，因为其本身是多个字符组成的内容，所以在删除时如果直接取长度为<code>1</code>的话会导致出现遗留不可见字符的情况。那么除了<code>Emoji</code>可能存在删除多个字符的情况，使用<code>Alt + Del</code>组合键在默认情况下是删除词级别内容，同样是存在多个字符的情况。</p>
<p>如果仅仅是使用<code>ContentEditable</code>的情况下，浏览器会自动处理词级别的删除行为，包括<code>Emoji</code>的删除行为也是可以自动处理的。因此针对非受控输入的编辑器例如<code>Quill</code>、飞书文档的实现，是不太需要主动处理相关行为的，主要关注点在于<code>DOM</code>变更后的被动同步状态。</p>
<p>而在我们实现的编辑器中，因为输入的相关实现是完全基于<code>beforeInput</code>事件来处理的，是完全受控的行为，因此我们必须要主动处理删除的行为。实际上在事件中，<code>inputType</code>值是给出了<code>deleteWordBackward</code>和<code>deleteWordForward</code>的，却没有给出默认行为要删除的长度。</p>
<p>因此我最开始是想要么改为非受控输入，要么是通过<code>Intl.Segmenter</code>方法来主动分词实现。然而在看到<code>MDN</code>的<code>DEMO</code>之后，发现这个构造器需要传递语言参数，这样的话在编辑器中是没有办法实现的，因为编辑器中无法实际确定语言类型。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> segmenterZH = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intl</span>.<span class="hljs-title class_">Segmenter</span>(<span class="hljs-string">"ZH-CN"</span>, { <span class="hljs-attr">granularity</span>: <span class="hljs-string">"word"</span> });
<span class="hljs-keyword">const</span> string1 = <span class="hljs-string">"当前所有功能都是基于插件化定义实现"</span>;
<span class="hljs-keyword">const</span> iterator1 = segmenterZH.<span class="hljs-title function_">segment</span>(string1)[<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>]();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(iterator1.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>.<span class="hljs-property">segment</span>); <span class="hljs-comment">// 当前</span>
</code></pre>
<p>因此我去找了相关开源编辑器的实现，<code>slate</code>是完全自定义处理的行为，使用<code>getWordDistance</code>来自行计算词的距离。这样对于英文问题不大，但是对于中文词组的处理就比较差了，是以标点符号为准作为切割目标的，因此对于中文实现更像是按句删除了。</p>
<p>而在<code>Lexical</code>中尝试了删除词组的表现则比较符合预期，本来我以为也是非受控的输入，但是查阅源码后发现同样是基于<code>beforeInput</code>事件来处理的。那么这个表现就非常符合浏览器的行为，本来我以为也是基于<code>Segmenter</code>实现，想查看是如何处理语言问题的，发现首参数是可以不传递的。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> segmenterZH = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intl</span>.<span class="hljs-title class_">Segmenter</span>(<span class="hljs-literal">undefined</span>, { <span class="hljs-attr">granularity</span>: <span class="hljs-string">"word"</span> });
<span class="hljs-keyword">const</span> string1 = <span class="hljs-string">"当前所有功能都是基于插件化定义实现"</span>;
<span class="hljs-keyword">const</span> iterator1 = segmenterZH.<span class="hljs-title function_">segment</span>(string1)[<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>]();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(iterator1.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>.<span class="hljs-property">segment</span>); <span class="hljs-comment">// 当前</span>
</code></pre>
<p>然而，再细致地查阅源码后发现，<code>Lexical</code>并未直接使用<code>Segmenter</code>来处理分词，而是使用了<code>selection.modify</code>这个<code>API</code>来预处理选区的变更。基于这个<code>API</code>可以同步地变更选区的<code>DOM</code>引用，然后我们就可以立即得到未来的选区状态，因此就可以构造删除的范围。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> root = <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-title function_">getContainer</span>();
<span class="hljs-keyword">const</span> domSelection = <span class="hljs-title function_">getRootSelection</span>(root);
<span class="hljs-keyword">const</span> selection = <span class="hljs-variable language_">this</span>.<span class="hljs-property">current</span>;
<span class="hljs-keyword">if</span> (!domSelection || !selection) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
domSelection.<span class="hljs-title function_">modify</span>(<span class="hljs-variable constant_">ALERT</span>.<span class="hljs-property">MOVE</span>, direction, granularity);
<span class="hljs-keyword">const</span> staticSel = <span class="hljs-title function_">getStaticSelection</span>(domSelection);
<span class="hljs-keyword">if</span> (!staticSel || <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">limit</span>()) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
<span class="hljs-keyword">const</span> { startContainer } = staticSel;
<span class="hljs-keyword">if</span> (!root.<span class="hljs-title function_">contains</span>(startContainer)) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
<span class="hljs-keyword">const</span> newRange = <span class="hljs-title function_">toModelRange</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>, staticSel, <span class="hljs-literal">false</span>);
newRange &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">set</span>(newRange);
</code></pre>
<p>并且在<code>Lexical</code>中还解释了<code>beforeInput</code>事件以及对应的<code>getTargetRanges()</code>方法。由此先前我对于浏览器没有给出默认要删除的长度的判断是错误的，其是通过<code>Range</code>来表达的。但是注释中还提到了这个方案不可靠，其在复杂场景下可能无法正确反应操作后的选区状态。</p>
<p>而对于使用像<code>Intl.Segmenter</code>等按词组分割的工具，比较容易出错，而且需要对于整个<code>Op</code>进行分词，也有很多不必要的计算。不同语言的分词规则差异巨大，例如英文空格分词以及中文无空格分词，自动识别词边界非常困难，尤其是在涉及自动换行和非罗马语言的情况下会非常困难。</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Flexical%2Fblob%2Faf687fa%2Fpackages%2Flexical%2Fsrc%2FLexicalSelection.ts%23L1605" target="_blank" title="https://github.com/facebook/lexical/blob/af687fa/packages/lexical/src/LexicalSelection.ts#L1605" ref="nofollow noopener noreferrer">github.com/facebook/le…</a></li>
</ul>
<p>总结起来，使用<code>selection.modify</code>方法直接利用了浏览器引擎自身对选区计算的内置、高度优化的逻辑，浏览器如何分词自然是浏览器本身最熟知。此外，实际上<code>BeforeInput</code>事件还有诸多方法，词级别删除这件事本身其实也可以用<code>getTargetRanges</code>来实现。</p>
<pre><code class="hljs language-js" lang="js">event.<span class="hljs-title function_">getTargetRanges</span>()[<span class="hljs-number">0</span>] <span class="hljs-comment">// InputEvent</span>
<span class="hljs-comment">// StaticRange {startContainer: text, startOffset: 13, endContainer: text, endOffset: 14, collapsed: false}</span>
</code></pre>
<h2 data-id="heading-5">文本拖拽</h2>
<p>既然都提到了<code>getTargetRanges</code>方法，我们自然就可以顺理成章地以此为基础聊一下文本拖拽的实现。在<code>beforeInput</code>事件中，<code>inputType</code>值是有<code>deleteByDrag</code>以及<code>insertFromDrop</code>两种类型，拖拽需要有两个操作组合而来，分别是文本的删除与插入操作。</p>
<p><code>getTargetRanges</code>方法返回的实际上是个<code>static range</code>数组，因此需要调用先前我们实现的<code>toModelRange</code>方法来转换到编辑器的选区模型。那么移动文本的这个操作实际上只需要关注两个<code>Range</code>，分别记录删除和插入的位置就可以实现了。</p>
<p>因此基于<code>beforeInput</code>事件的拖拽实现其实是非常简单的，主要是将删除和插入的逻辑组合在一起即可。这里需要放置一个临时的变量，用来记录起始的位置，因为这里是两个事件分别发生的，因此需要将删除的位置保存下来，然后在插入时使用这个位置来移动文本片段。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">switch</span> (inputType) {
  <span class="hljs-keyword">case</span> <span class="hljs-string">"deleteByDrag"</span>: {
    <span class="hljs-keyword">const</span> domRange = event.<span class="hljs-title function_">getTargetRanges</span>()[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">const</span> range = domRange &amp;&amp; <span class="hljs-title function_">toModelRange</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>, domRange, <span class="hljs-literal">false</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dragStartRange</span> = range || <span class="hljs-literal">null</span>;
  }
  <span class="hljs-keyword">case</span> <span class="hljs-string">"insertFromDrop"</span>: {
    <span class="hljs-keyword">const</span> domRange = event.<span class="hljs-title function_">getTargetRanges</span>()[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">const</span> range = domRange &amp;&amp; <span class="hljs-title function_">toModelRange</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>, domRange, <span class="hljs-literal">false</span>);
    range &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-property">perform</span>.<span class="hljs-title function_">moveFragment</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dragStartRange</span>, range);
  }
}
</code></pre>
<p>移动内容片段的部分则比较简单，唯一一个需要关注的点是使用了<code>transformPosition</code>函数来处理位置偏移。因为在删除内容片段后，插入位置会发生变化，两次变更的基准都是同一个草稿，而变更则是顺序的关系，此时就需要假设<code>A</code>发生来处理对<code>B</code>的影响。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Perform</span> {
  <span class="hljs-comment">/**
   * 移动选区内容片段到目标选区处
   * <span class="hljs-doctag">@param</span> <span class="hljs-variable">from</span>
   * <span class="hljs-doctag">@param</span> <span class="hljs-variable">to</span>
   */</span>
  public <span class="hljs-title function_">moveFragment</span>(<span class="hljs-params"><span class="hljs-keyword">from</span>: Range, to: Range</span>) {
    <span class="hljs-keyword">const</span> rawFrom = <span class="hljs-title class_">RawRange</span>.<span class="hljs-title function_">fromRange</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>, <span class="hljs-keyword">from</span>);
    <span class="hljs-keyword">const</span> rawTo = <span class="hljs-title class_">RawRange</span>.<span class="hljs-title function_">fromRange</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>, to);
    <span class="hljs-keyword">if</span> (!rawFrom || !rawTo) <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">const</span> fragment = <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-property">lookup</span>.<span class="hljs-title function_">getFragment</span>(<span class="hljs-keyword">from</span>);
    <span class="hljs-keyword">if</span> (!fragment) <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">const</span> delDelta = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Delta</span>().<span class="hljs-title function_">retain</span>(rawFrom.<span class="hljs-property">start</span>).<span class="hljs-title function_">delete</span>(rawFrom.<span class="hljs-property">len</span>);
    <span class="hljs-keyword">const</span> toStart = delDelta.<span class="hljs-title function_">transformPosition</span>(rawTo.<span class="hljs-property">start</span>);
    <span class="hljs-keyword">const</span> insertDelta = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Delta</span>().<span class="hljs-title function_">retain</span>(toStart).<span class="hljs-title function_">merge</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Delta</span>(fragment));
    <span class="hljs-keyword">const</span> composed = delDelta.<span class="hljs-title function_">compose</span>(insertDelta);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-property">state</span>.<span class="hljs-title function_">apply</span>(composed, { <span class="hljs-attr">range</span>: rawTo });
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
  }
}
</code></pre>
<p>而除了在<code>BeforeInput</code>事件中处理拖拽外，我们还可以在<code>DragEvent</code>事件中处理拖拽的逻辑，在<code>slate</code>中就是基于<code>Drag</code>相关的事件来完成的。实际上这也是在阻止<code>Drag</code>默认行为后，手动处理拖拽的逻辑，如果需要接管诸如图片的拖拽行为等，那么就必须要采用这个方案了。</p>
<p>基于<code>DragEvent</code>的方案中，主要关注点有三部分，首先是需要在<code>DragStart</code>事件中将当前的选区位置在<code>dataTransfer</code>中保存下来，其次是在<code>DragOver</code>事件中阻止默认行为以允许拖拽，最后是在<code>Drop</code>事件中获取拖拽的内容并且执行移动操作。下面是<code>Slate</code>中的实现:</p>
<pre><code class="hljs language-js" lang="js">&lt;div
  onDragStart={<span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title class_">ReactEditor</span>.<span class="hljs-title function_">setFragmentData</span>(
      editor,
      event.<span class="hljs-property">dataTransfer</span>,
      <span class="hljs-string">'drag'</span>
    )
   }, [])}
  onDragOver={<span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    event.<span class="hljs-title function_">preventDefault</span>();
  }, [])}
  onDrop={<span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> draggedRange = editor.<span class="hljs-property">selection</span>
    <span class="hljs-keyword">const</span> range = <span class="hljs-title class_">ReactEditor</span>.<span class="hljs-title function_">findEventRange</span>(editor, event);
    <span class="hljs-keyword">const</span> data = event.<span class="hljs-property">dataTransfer</span>
    <span class="hljs-title class_">Transforms</span>.<span class="hljs-title function_">delete</span>(editor, { <span class="hljs-attr">at</span>: draggedRange })
    <span class="hljs-title class_">Transforms</span>.<span class="hljs-title function_">select</span>(editor, range)
    <span class="hljs-title class_">ReactEditor</span>.<span class="hljs-title function_">insertData</span>(editor, data)
  }, [])}
&gt;&lt;/div&gt;
</code></pre>
<p>在这里的<code>findEventRange</code>方法是比较需要关注的，因为此时的<code>DragEvent</code>并没有提供类似于<code>getTargetRanges</code>的方法，因此我们并没有办法直接获取拖拽的目标位置。在之前我们提到了在<code>DOM</code>基础上的自绘选区实现，在这里仍然可以调用相关<code>API</code>来实现指定位置的选区获取。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> <span class="hljs-attr">domRange</span>: <span class="hljs-title class_">Range</span>;
<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-property">caretRangeFromPoint</span>) {
  domRange = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">caretRangeFromPoint</span>(x, y);
} <span class="hljs-keyword">else</span> {
  <span class="hljs-keyword">const</span> position = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">caretPositionFromPoint</span>(x, y);
  <span class="hljs-keyword">if</span> (position) {
    domRange = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createRange</span>();
    domRange.<span class="hljs-title function_">setStart</span>(position.<span class="hljs-property">offsetNode</span>, position.<span class="hljs-property">offset</span>);
    domRange.<span class="hljs-title function_">setEnd</span>(position.<span class="hljs-property">offsetNode</span>, position.<span class="hljs-property">offset</span>);
  }
}
<span class="hljs-keyword">const</span> range = domRange &amp;&amp; <span class="hljs-title function_">toModelRange</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>, domRange, <span class="hljs-literal">false</span>);
<span class="hljs-comment">// ...</span>
</code></pre>
<h2 data-id="heading-6">总结</h2>
<p>先前我们针对性地处理输入法和浏览器兼容的行为，由于输入法会直接操作<code>DOM</code>，因此实现编辑器模型的输入状态同步需要处理很多问题。而在这里我们关注于处理文本结构性变更行为的处理，主要是实现了回车插入、删除、拖拽等文本变更行为的处理，至此完成了编辑器输入同步部分的实现。</p>
<p>接下来我们需要实现编辑器的视图层同步能力，即<code>React/Vue</code>等视图层的适配器实现，以此来对接核心层的编辑器模型。先前我们已经实现了模型层<code>delta</code>、控制器层<code>core</code>，再加上视图层的适配器<code>react</code>，就可以完整实现编辑器的<code>MVC</code>框架了。</p>
<h2 data-id="heading-7">每日一题</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FWindRunnerMax%2FEveryDay" target="_blank" title="https://github.com/WindRunnerMax/EveryDay" ref="nofollow noopener noreferrer">github.com/WindRunnerM…</a></li>
</ul>
<h2 data-id="heading-8">参考</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmathiasbynens.be%2Fnotes%2Fjavascript-unicode" target="_blank" title="https://mathiasbynens.be/notes/javascript-unicode" ref="nofollow noopener noreferrer">mathiasbynens.be/notes/javas…</a></li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.ruanyifeng.com%2Fblog%2F2014%2F12%2Funicode.html" target="_blank" title="http://www.ruanyifeng.com/blog/2014/12/unicode.html" ref="nofollow noopener noreferrer">www.ruanyifeng.com/blog/2014/1…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Feev.ee%2Fblog%2F2015%2F09%2F12%2Fdark-corners-of-unicode" target="_blank" title="https://eev.ee/blog/2015/09/12/dark-corners-of-unicode" ref="nofollow noopener noreferrer">eev.ee/blog/2015/0…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FInputEvent" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/InputEvent" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FSelection%2Fmodify" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Selection/modify" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fw3c.github.io%2Finput-events%2F%23interface-InputEvent-Attributes" target="_blank" title="https://w3c.github.io/input-events/#interface-InputEvent-Attributes" ref="nofollow noopener noreferrer">w3c.github.io/input-event…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FInputEvent%2FgetTargetRanges" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/InputEvent/getTargetRanges" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js 编程实战：Express 基础]]></title>    <link>https://juejin.cn/post/7586157459971571764</link>    <guid>https://juejin.cn/post/7586157459971571764</guid>    <pubDate>2025-12-22T03:02:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586157459971571764" data-draft-id="7585929179319713827" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js 编程实战：Express 基础"/> <meta itemprop="keywords" content="后端,前端,Node.js"/> <meta itemprop="datePublished" content="2025-12-22T03:02:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js 编程实战：Express 基础
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:02:14.000Z" title="Mon Dec 22 2025 03:02:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在 Node.js 后端开发中，Express 是使用最广泛的 Web 框架之一。它在 Node.js 原生 HTTP 模块之上进行了封装，提供了更加简洁、灵活的接口，用于构建 Web 应用和 API 服务。Express 并不追求功能的“全家桶”，而是强调轻量和可扩展，这也正是它长期流行的重要原因。</p>
</blockquote>
<p>本文将从 Express 的基本概念出发，介绍其核心用法和常见开发模式。</p>
<hr/>
<h2 data-id="heading-0">一、为什么选择 Express</h2>
<p>Node.js 自带的 HTTP 模块虽然功能完整，但在实际开发中，处理路由、参数解析、错误处理等内容时会显得较为繁琐。Express 对这些常见需求进行了抽象，让开发者可以更加专注于业务逻辑本身。</p>
<p>Express 的优势主要体现在结构清晰、学习成本低以及生态成熟。大量中间件和社区实践，使得 Express 适合从小型项目到中大型服务的不同场景。</p>
<hr/>
<h2 data-id="heading-1">二、创建第一个 Express 应用</h2>
<p>在已有 Node.js 环境的前提下，首先需要安装 Express。</p>
<pre><code class="hljs language-bash" lang="bash">npm install express
</code></pre>
<p>创建一个最简单的服务示例：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();

app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">'Hello Express'</span>);
});

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'server running on port 3000'</span>);
});
</code></pre>
<p>运行后访问浏览器，即可看到返回结果。这也是大多数 Express 应用的起点。</p>
<hr/>
<h2 data-id="heading-2">三、路由的基本使用</h2>
<p>路由是 Express 中最核心的概念之一，用于定义请求路径与处理逻辑之间的映射关系。</p>
<pre><code class="hljs language-js" lang="js">app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/users'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">list</span>: [] });
});

app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/users'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">'create user'</span>);
});
</code></pre>
<p>Express 根据请求方法和路径匹配对应的路由处理函数，顺序匹配非常重要。</p>
<hr/>
<h2 data-id="heading-3">四、请求对象与响应对象</h2>
<p>在路由处理中，最常用的是 <code>req</code> 和 <code>res</code> 对象。</p>
<p><code>req</code> 用于获取请求信息，例如参数、请求头、请求体等；
<code>res</code> 用于向客户端返回响应。</p>
<pre><code class="hljs language-js" lang="js">app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/detail'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> id = req.<span class="hljs-property">query</span>.<span class="hljs-property">id</span>;
  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">`id is <span class="hljs-subst">${id}</span>`</span>);
});
</code></pre>
<p>理解这两个对象的常用属性，是编写 Express 接口的基础。</p>
<hr/>
<h2 data-id="heading-4">五、中间件的概念</h2>
<p>中间件是 Express 的核心机制，用于在请求和响应之间执行通用逻辑。</p>
<pre><code class="hljs language-js" lang="js">app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(req.<span class="hljs-property">method</span>, req.<span class="hljs-property">url</span>);
  <span class="hljs-title function_">next</span>();
});
</code></pre>
<p>中间件可以用于日志记录、权限校验、参数处理等场景。只有调用 <code>next</code>，请求才会继续向下传递。</p>
<hr/>
<h2 data-id="heading-5">六、解析请求体数据</h2>
<p>在实际开发中，经常需要处理 POST 请求的请求体数据。</p>
<pre><code class="hljs language-js" lang="js">app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">json</span>());
app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">urlencoded</span>({ <span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span> }));
</code></pre>
<p>配置完成后，可以通过 <code>req.body</code> 直接访问提交的数据。</p>
<hr/>
<h2 data-id="heading-6">七、静态资源服务</h2>
<p>Express 也可以用于提供静态资源服务，例如图片、前端构建产物等。</p>
<pre><code class="hljs language-js" lang="js">app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">static</span>(<span class="hljs-string">'public'</span>));
</code></pre>
<p>这样可以直接通过 URL 访问指定目录下的文件。</p>
<hr/>
<h2 data-id="heading-7">八、错误处理基础</h2>
<p>Express 提供了统一的错误处理中间件机制。</p>
<pre><code class="hljs language-js" lang="js">app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">err, req, res, next</span>) =&gt;</span> {
  res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">'server error'</span>);
});
</code></pre>
<p>集中处理错误，有助于保持业务代码的简洁性和一致性。</p>
<hr/>
<h2 data-id="heading-8">九、Express 项目结构建议</h2>
<p>一个常见的 Express 项目结构包括：</p>
<ul>
<li>路由层，负责接口定义</li>
<li>控制层，处理业务逻辑</li>
<li>服务层，封装数据访问</li>
<li>中间件层，处理通用功能</li>
</ul>
<p>合理的结构可以显著提升项目的可维护性。</p>
<hr/>
<h2 data-id="heading-9">十、总结</h2>
<p>Express 是 Node.js 生态中最成熟、最稳定的 Web 框架之一。它在保持灵活性的同时，为开发者提供了足够的约束和规范，非常适合作为后端开发的入门与实战框架。</p>
<p>掌握 Express 的基础用法，是深入学习 Node.js Web 开发的关键一步。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js 编程实战：路由与中间件]]></title>    <link>https://juejin.cn/post/7585888537642418191</link>    <guid>https://juejin.cn/post/7585888537642418191</guid>    <pubDate>2025-12-22T03:02:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585888537642418191" data-draft-id="7585888537642401807" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js 编程实战：路由与中间件"/> <meta itemprop="keywords" content="后端,Node.js,前端"/> <meta itemprop="datePublished" content="2025-12-22T03:02:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js 编程实战：路由与中间件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:02:41.000Z" title="Mon Dec 22 2025 03:02:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在 Node.js Web 开发中，路由与中间件是构建应用的两大核心机制。路由负责将请求分发到具体的业务处理逻辑，而中间件则负责在请求处理过程中执行通用操作。二者相互配合，构成了 Express 等框架的运行基础。</p>
</blockquote>
<p>理解路由匹配规则和中间件执行顺序，是写好 Node.js 服务端代码的关键。</p>
<hr/>
<h2 data-id="heading-0">一、什么是路由</h2>
<p>路由用于描述请求路径与处理函数之间的映射关系。一个完整的路由通常由请求方法、路径和回调函数组成。</p>
<pre><code class="hljs language-js" lang="js">app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/users'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">'user list'</span>);
});
</code></pre>
<p>当客户端以 GET 方法访问 <code>/users</code> 时，Express 会执行对应的处理函数。</p>
<hr/>
<h2 data-id="heading-1">二、路由匹配规则</h2>
<p>Express 的路由是按<strong>定义顺序</strong>进行匹配的。一旦匹配成功，后续路由将不会再被执行。</p>
<pre><code class="hljs language-js" lang="js">app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/users/:id'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">send</span>(req.<span class="hljs-property">params</span>.<span class="hljs-property">id</span>);
});
</code></pre>
<p>动态路由可以通过参数的形式获取路径中的变量，这在资源型接口设计中非常常见。</p>
<hr/>
<h2 data-id="heading-2">三、路由拆分与模块化</h2>
<p>在项目规模扩大后，将所有路由写在一个文件中会导致代码难以维护。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> router = express.<span class="hljs-title class_">Router</span>();

router.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">'user list'</span>);
});

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = router;
</code></pre>
<p>通过路由模块化，可以让项目结构更加清晰，职责更加明确。</p>
<hr/>
<h2 data-id="heading-3">四、中间件的基本概念</h2>
<p>中间件本质上是一个函数，用于在请求进入路由之前或响应返回之前执行逻辑。</p>
<pre><code class="hljs language-js" lang="js">app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(req.<span class="hljs-property">method</span>, req.<span class="hljs-property">url</span>);
  <span class="hljs-title function_">next</span>();
});
</code></pre>
<p>中间件可以访问请求对象、响应对象，并决定是否继续传递请求。</p>
<hr/>
<h2 data-id="heading-4">五、中间件的执行顺序</h2>
<p>中间件按照<strong>注册顺序</strong>执行。</p>
<ul>
<li>全局中间件优先执行</li>
<li>路由级中间件按顺序执行</li>
<li>错误处理中间件最后执行</li>
</ul>
<p>一旦中间件没有调用 <code>next</code>，请求链将被中断。</p>
<hr/>
<h2 data-id="heading-5">六、常见中间件使用场景</h2>
<p>中间件通常用于处理通用逻辑，例如：</p>
<ul>
<li>请求日志记录</li>
<li>参数校验</li>
<li>用户认证与权限控制</li>
<li>请求体解析</li>
<li>跨域处理</li>
</ul>
<p>将这些逻辑从业务代码中抽离，可以显著提升代码可读性。</p>
<hr/>
<h2 data-id="heading-6">七、路由级中间件</h2>
<p>除了全局中间件，还可以为特定路由添加中间件。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">auth</span> = (<span class="hljs-params">req, res, next</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!req.<span class="hljs-property">headers</span>.<span class="hljs-property">token</span>) {
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">401</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">'unauthorized'</span>);
  }
  <span class="hljs-title function_">next</span>();
};

app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/profile'</span>, auth, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">'profile'</span>);
});
</code></pre>
<p>这种方式可以实现精细化的权限控制。</p>
<hr/>
<h2 data-id="heading-7">八、错误处理中间件</h2>
<p>Express 提供了专门的错误处理中间件形式。</p>
<pre><code class="hljs language-js" lang="js">app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">err, req, res, next</span>) =&gt;</span> {
  res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">'server error'</span>);
});
</code></pre>
<p>集中处理异常，有助于统一错误返回结构。</p>
<hr/>
<h2 data-id="heading-8">九、next 的使用注意事项</h2>
<p><code>next</code> 用于将控制权交给下一个中间件或路由。</p>
<p>需要注意：</p>
<ul>
<li>不调用 <code>next</code>，请求将被阻塞</li>
<li>调用 <code>next(err)</code> 会直接进入错误处理中间件</li>
<li>避免重复调用 <code>next</code></li>
</ul>
<p>合理使用 <code>next</code> 是中间件设计的核心。</p>
<hr/>
<h2 data-id="heading-9">十、路由与中间件的协作模式</h2>
<p>在实际项目中，常见的协作方式是：</p>
<ul>
<li>中间件负责通用逻辑</li>
<li>路由负责业务分发</li>
<li>控制器负责业务实现</li>
</ul>
<p>这种分层设计有助于项目长期维护和扩展。</p>
<hr/>
<h2 data-id="heading-10">十一、总结</h2>
<p>路由和中间件是 Node.js Web 框架中最重要的基础设施。路由决定请求走向，中间件决定请求如何被处理。只有真正理解它们的执行机制和设计思路，才能写出结构清晰、易维护的服务端代码。</p>
<p>在项目初期建立合理的路由和中间件体系，将为后续功能扩展打下坚实基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[面试官：Vision-Language 模型中，如何实现跨模态特征对齐？CLIP 与 BLIP 的主要区别？]]></title>    <link>https://juejin.cn/post/7585798113546977330</link>    <guid>https://juejin.cn/post/7585798113546977330</guid>    <pubDate>2025-12-21T15:20:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585798113546977330" data-draft-id="7585798113546960946" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="面试官：Vision-Language 模型中，如何实现跨模态特征对齐？CLIP 与 BLIP 的主要区别？"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2025-12-21T15:20:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="coting"/> <meta itemprop="url" content="https://juejin.cn/user/933911964427818"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            面试官：Vision-Language 模型中，如何实现跨模态特征对齐？CLIP 与 BLIP 的主要区别？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/933911964427818/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    coting
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T15:20:19.000Z" title="Sun Dec 21 2025 15:20:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>面试官：<strong>Vision-Language 模型中是如何实现跨模态特征对齐的？CLIP 和 BLIP 有什么区别？</strong></p>
<p>这道题表面上问“特征对齐”，其实考察的是你对多模态表示学习（Multimodal Representation Learning）的理解深度。</p>
<p>所有相关源码示例、流程图、面试八股、模型配置与知识库构建技巧，我也将持续更新在Github：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Faicoting%2FAIHub" target="_blank" title="https://github.com/aicoting/AIHub" ref="nofollow noopener noreferrer"><strong>AIHub</strong></a>，欢迎关注收藏！</p>
<h2 data-id="heading-0">一、为什么要跨模态特征对齐？</h2>
<p>在 Vision-Language 模型里，我们面对的是两种完全不同的数据模态：</p>
<ul>
<li>图像：二维像素矩阵，结构连续但语义隐含；</li>
<li>文本：一维离散序列，语义明确但结构缺失。</li>
</ul>
<p>这两种模态的表示空间天然不一样。<br/>
如果你直接把图像特征和文本特征拼在一起去算相似度，模型是无法理解它们的关系的。</p>
<p>所以核心目标就是<strong>把不同模态的特征映射到同一个语义空间（Shared Embedding Space）中，让它们可以对齐、对比、甚至互相生成。</strong></p>
<p>这一步就叫 <strong>跨模态特征对齐（Cross-modal Alignment）</strong>。</p>
<h2 data-id="heading-1">二、跨模态对齐的三种典型思路</h2>
<p>跨模态对齐并不是一刀切的，有不同层次的实现方式：</p>
<h3 data-id="heading-2">1.表征级对齐（Representation-level Alignment）</h3>
<p>最常见的一种，也是 <strong>CLIP</strong> 的核心思路。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4595bc92670b447a873be80d51efb597~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766935218&amp;x-signature=HWqTa%2FKOJe7VfLy40oSXgQu26hI%3D" alt="" loading="lazy"/></p>
<p>CLIP 会：</p>
<ul>
<li>用一个视觉编码器（Vision Encoder, 通常是 ViT）提取图像特征；</li>
<li>用一个文本编码器（Text Encoder, 通常是 Transformer）提取文本特征；</li>
<li>然后用**对比学习（Contrastive Learning）**让同一图文对的相似度更高，不同图文对的相似度更低。</li>
</ul>
<p>公式上写就是：<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/142ac638074c4bcf9345f69ba487a093~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766935218&amp;x-signature=DU408ZKD3wjgkXdKc38PgDDHYfY%3D" alt="image" loading="lazy"/><br/>
这样，视觉空间和语言空间就被压缩到一个共同的语义空间中。</p>
<p>表征级对齐方法训练简单、高效，但是只能捕捉“整体语义”，缺乏细粒度的对齐（比如“狗在草地上跑”的局部理解）。</p>
<h3 data-id="heading-3">2.局部级对齐（Fine-grained Alignment）</h3>
<p>这种方法更精细一些，比如 <strong>BLIP</strong> 系列模型。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb2f0aee169b4136a1151a87916de9db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766935218&amp;x-signature=Ri0CeM9trk5PlYFDg9n%2FxGK4Gxs%3D" alt="" loading="lazy"/></p>
<p>它不满足于只对齐整张图片和整段文字，而是进一步通过 <strong>Cross-Attention</strong> 实现细粒度的 token-level 对齐：</p>
<p>哪个词对应图像的哪个区域？<br/>
“cat” 对应哪一块特征？</p>
<p>“on the bed” 对应哪一块背景？</p>
<p>在 BLIP 中，图像特征会先经过一个视觉编码器提取成 patch embedding，然后输入到一个<strong>多模态 Transformer</strong>里，与文本 token 通过交叉注意力（Cross-Attention）交互。<br/>
这样模型不仅知道“图像整体说的是什么”，还能理解“图像里的每个部分对应哪段文字”。</p>
<p>局部级对齐能实现图文理解、问答、生成等复杂任务，但是计算更重、训练更复杂。</p>
<h3 data-id="heading-4">3.语义层对齐（Semantic-level Alignment）</h3>
<p>这类方法通常出现在生成式模型（比如 BLIP-2、Flamingo、LLaVA）中。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc13a34e3a0c4ec4ade7e8a958d3afaa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766935218&amp;x-signature=M3g3VGz1BL%2BCJDOG6DTXODywpos%3D" alt="" loading="lazy"/></p>
<p>它们会使用一个<strong>冻结的大语言模型（LLM）作为语言理解核心，再用一个轻量的视觉投影器（Q-former 或 Adapter）</strong>，把视觉特征转化为 LLM 能理解的 token 形式，从而实现语义层面对齐。</p>
<p>这种方式特别适合 <strong>视觉问答（VQA）</strong>、<strong>图文生成</strong> 任务，代表模型包括 <strong>BLIP-2、LLaVA、MiniGPT-4</strong> 等。</p>
<hr/>
<h2 data-id="heading-5">三、CLIP vs BLIP：到底有什么不同？</h2>
<p>我们可以用一个表格来看一下CLIP和BLIP的主要区别：</p>













































<table><thead><tr><th align="center">对比项</th><th align="center"><strong>CLIP</strong></th><th align="center"><strong>BLIP</strong></th></tr></thead><tbody><tr><td align="center">模型类型</td><td align="center">双编码器（Dual Encoder）</td><td align="center">交叉编码器（Cross Encoder）</td></tr><tr><td align="center">对齐方式</td><td align="center">对比学习，全局语义对齐</td><td align="center">Cross-Attention，细粒度对齐</td></tr><tr><td align="center">输入输出</td><td align="center">图像 + 文本 → 相似度</td><td align="center">图像 + 文本 → 理解或生成</td></tr><tr><td align="center">任务类型</td><td align="center">检索（Retrieval）、匹配</td><td align="center">理解（VQA）、生成（Captioning）</td></tr><tr><td align="center">训练目标</td><td align="center">图文对比损失（InfoNCE）</td><td align="center">图文生成 + 对比 + 重构</td></tr><tr><td align="center">特点</td><td align="center">快、泛化强、预训练高效</td><td align="center">理解深、语义细腻、可迁移生成任务</td></tr><tr><td align="center">代表应用</td><td align="center">CLIP, ALIGN, Florence</td><td align="center">BLIP, BLIP-2, LLaVA, MiniGPT-4</td></tr></tbody></table>
<p>面试官问这题，不是想听你背论文，而是想看你能否抓住<strong>核心逻辑</strong>。</p>
<p>一个简洁高分答案可以这样组织：</p>
<p>Vision-Language 模型的关键是跨模态特征对齐。<br/>
常见的实现方式包括：</p>
<ul>
<li><strong>表征级对齐</strong>：CLIP 通过对比学习在全局语义空间对齐；</li>
<li><strong>局部级对齐</strong>：BLIP 通过 Cross-Attention 实现细粒度图文交互；</li>
<li><strong>语义层对齐</strong>：BLIP-2 将视觉特征映射到语言模型 token 空间。<br/>
其中，CLIP 强在高效检索与表示学习，BLIP 强在生成与多模态理解。</li>
</ul>
<p>这样答既有体系，也能体现你对架构演进的理解。</p>
<p>总结一下，CLIP 把视觉数据和文本数据连了起来，BLIP 让模型不仅能“理解”，还能“表达”。</p>
<p>这条演化路径其实就是多模态模型走向智能体（Agent）的必经之路：从对齐到交互，从理解到生成。</p>
<p>如果你能从这个视角去看待多模态模型的设计逻辑，那么你也就会慢慢对人工智能有了更加深入的理解。</p>
<p>关于深度学习和大模型相关的知识和前沿技术更新，请关注公众号 <strong>aicoting</strong>！</p>
<p><strong>📚推荐阅读</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1962254381677257759" target="_blank" title="https://zhuanlan.zhihu.com/p/1962254381677257759" ref="nofollow noopener noreferrer">面试官：Transformer如何优化到线性级？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1962929340292502638" target="_blank" title="https://zhuanlan.zhihu.com/p/1962929340292502638" ref="nofollow noopener noreferrer">面试官：模型的量化了解吗？解释一下非对称量化与对称量化</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1962947114230346375" target="_blank" title="https://zhuanlan.zhihu.com/p/1962947114230346375" ref="nofollow noopener noreferrer">面试官：模型剪枝了解吗？解释一下结构化剪枝与非结构化剪枝</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1963373485435917372" target="_blank" title="https://zhuanlan.zhihu.com/p/1963373485435917372" ref="nofollow noopener noreferrer">面试官：为什么 Adam 在部分任务上会比 SGD 收敛更快，但泛化性更差？如何改进？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1963547933044631464" target="_blank" title="https://zhuanlan.zhihu.com/p/1963547933044631464" ref="nofollow noopener noreferrer">面试官：BatchNorm、LayerNorm、GroupNorm、InstanceNorm 有什么本质区别？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1964062982347687219" target="_blank" title="https://zhuanlan.zhihu.com/p/1964062982347687219" ref="nofollow noopener noreferrer">面试官：深层网络梯度消失的根本原因是什么？除了 ResNet，还有哪些架构能有效缓解？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F82010759692" target="_blank" title="https://zhuanlan.zhihu.com/p/82010759692" ref="nofollow noopener noreferrer">面试官：大模型中的幻觉本质原因是什么？如何通过训练或推理手段抑制？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1965142986452108272" target="_blank" title="https://zhuanlan.zhihu.com/p/1965142986452108272" ref="nofollow noopener noreferrer">面试官：FlashAttention 的实现原理与内存优化方式？为什么能做到 O(N²) attention 的显存线性化？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1965823665364014863" target="_blank" title="https://zhuanlan.zhihu.com/p/1965823665364014863" ref="nofollow noopener noreferrer">面试官：KV Cache 了解吗？推理阶段 KV Cache 的复用原理？动态批处理如何提升吞吐？</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python三维绘图全教程：plot3d/mesh/surf/contour函数实战（附完整代码）]]></title>    <link>https://juejin.cn/post/7585743487258689545</link>    <guid>https://juejin.cn/post/7585743487258689545</guid>    <pubDate>2025-12-21T12:10:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585743487258689545" data-draft-id="7585534343562887218" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python三维绘图全教程：plot3d/mesh/surf/contour函数实战（附完整代码）"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-21T12:10:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="月度空间"/> <meta itemprop="url" content="https://juejin.cn/user/1567280531253689"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python三维绘图全教程：plot3d/mesh/surf/contour函数实战（附完整代码）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1567280531253689/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    月度空间
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T12:10:18.000Z" title="Sun Dec 21 2025 12:10:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在数据可视化、科学计算和工程分析中，三维绘图是展示空间数据、函数关系的重要手段。MATLAB中常用<code>plot3()</code>、<code>mesh()</code>、<code>surf()</code>、<code>contour()</code>实现三维绘图，而Python的<code>matplotlib</code>库通过<code>mplot3d</code>模块完美复刻了这些功能（对应<code>plot3D()</code>、<code>plot_wireframe()</code>、<code>plot_surface()</code>、<code>contour3D()</code>等函数）。</p>
<h2 data-id="heading-0">一、准备工作：安装依赖与基础环境搭建</h2>
<h3 data-id="heading-1">1.1 安装必备库</h3>
<p>Python三维绘图依赖<code>matplotlib</code>（绘图核心）和<code>numpy</code>（数值计算与数据生成），执行以下命令安装：</p>
<pre><code class="hljs language-bash" lang="bash">pip install matplotlib numpy
</code></pre>
<h3 data-id="heading-2">1.2 导入模块与创建3D绘图环境</h3>
<p><code>matplotlib</code>的<code>mplot3d</code>模块是实现3D绘图的核心，需先导入并创建3D坐标轴对象：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">from</span> mpl_toolkits <span class="hljs-keyword">import</span> mplot3d  <span class="hljs-comment"># 必须导入，启用3D绘图功能</span>

<span class="hljs-comment"># 创建画布与3D坐标轴</span>
fig = plt.figure(figsize=(<span class="hljs-number">8</span>, <span class="hljs-number">6</span>))  <span class="hljs-comment"># 设置画布大小</span>
ax = plt.axes(projection=<span class="hljs-string">'3d'</span>)    <span class="hljs-comment"># 指定投影为3D</span>
plt.show()  <span class="hljs-comment"># 显示绘图窗口</span>
</code></pre>
<p><strong>关键说明</strong>：<code>projection='3d'</code>是创建3D绘图环境的核心参数，缺少则默认生成2D坐标轴。</p>
<h2 data-id="heading-3">二、3D线图（对应MATLAB plot3()）：ax.plot3D()</h2>
<p><code>plot3D()</code>是MATLAB<code>plot3()</code>的Python等价函数，用于绘制<strong>三维空间中的折线/曲线</strong>，适合展示一维数据的空间轨迹（如运动路径、螺旋线）。</p>
<h3 data-id="heading-4">2.1 基本语法</h3>
<pre><code class="hljs language-python" lang="python">ax.plot3D(xdata, ydata, zdata, color, linewidth, label, ...)
</code></pre>
<ul>
<li><code>xdata/ydata/zdata</code>：三维坐标数据（需为等长数组）；</li>
<li><code>color</code>：线条颜色（如<code>'red'</code>、<code>'#FF5733'</code>）；</li>
<li><code>linewidth</code>：线条宽度；</li>
<li><code>label</code>：图例标签。</li>
</ul>
<h3 data-id="heading-5">2.2 实战案例：绘制三维螺旋线</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">from</span> mpl_toolkits <span class="hljs-keyword">import</span> mplot3d

<span class="hljs-comment"># 生成数据：螺旋线参数方程</span>
theta = np.linspace(<span class="hljs-number">0</span>, <span class="hljs-number">10</span> * np.pi, <span class="hljs-number">1000</span>)  <span class="hljs-comment"># 角度范围</span>
x = np.sin(theta) * np.cos(theta)         <span class="hljs-comment"># x坐标</span>
y = np.sin(theta) * np.sin(theta)         <span class="hljs-comment"># y坐标</span>
z = np.linspace(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1000</span>)               <span class="hljs-comment"># z坐标</span>

<span class="hljs-comment"># 创建3D绘图环境</span>
fig = plt.figure(figsize=(<span class="hljs-number">8</span>, <span class="hljs-number">6</span>))
ax = plt.axes(projection=<span class="hljs-string">'3d'</span>)

<span class="hljs-comment"># 绘制3D线图</span>
ax.plot3D(x, y, z, color=<span class="hljs-string">'blue'</span>, linewidth=<span class="hljs-number">2</span>, label=<span class="hljs-string">'3D螺旋线'</span>)

<span class="hljs-comment"># 设置坐标轴标签与图例</span>
ax.set_xlabel(<span class="hljs-string">'X轴'</span>, fontsize=<span class="hljs-number">12</span>)
ax.set_ylabel(<span class="hljs-string">'Y轴'</span>, fontsize=<span class="hljs-number">12</span>)
ax.set_zlabel(<span class="hljs-string">'Z轴'</span>, fontsize=<span class="hljs-number">12</span>)
ax.legend(loc=<span class="hljs-string">'upper right'</span>)
ax.set_title(<span class="hljs-string">'三维螺旋线（plot3D实现）'</span>, fontsize=<span class="hljs-number">14</span>)

plt.show()
</code></pre>
<p><strong>结果解读</strong>：代码通过参数方程生成螺旋线的三维坐标，<code>plot3D()</code>将其连接为连续曲线，可清晰看到曲线在XY平面呈螺旋状，沿Z轴线性上升。</p>
<h3 data-id="heading-6">2.3 拓展：绘制三维随机折线</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 生成随机三维数据</span>
np.random.seed(<span class="hljs-number">42</span>)  <span class="hljs-comment"># 固定随机种子</span>
x = np.cumsum(np.random.randn(<span class="hljs-number">100</span>))
y = np.cumsum(np.random.randn(<span class="hljs-number">100</span>))
z = np.cumsum(np.random.randn(<span class="hljs-number">100</span>))

<span class="hljs-comment"># 绘图</span>
fig = plt.figure(figsize=(<span class="hljs-number">8</span>, <span class="hljs-number">6</span>))
ax = plt.axes(projection=<span class="hljs-string">'3d'</span>)
ax.plot3D(x, y, z, color=<span class="hljs-string">'green'</span>, marker=<span class="hljs-string">'o'</span>, markersize=<span class="hljs-number">3</span>, label=<span class="hljs-string">'随机折线'</span>)

ax.set_xlabel(<span class="hljs-string">'X'</span>)
ax.set_ylabel(<span class="hljs-string">'Y'</span>)
ax.set_zlabel(<span class="hljs-string">'Z'</span>)
ax.legend()
ax.set_title(<span class="hljs-string">'三维随机折线'</span>)
plt.show()
</code></pre>
<p><strong>技巧</strong>：添加<code>marker</code>参数可显示数据点，便于观察离散数据的空间分布。</p>
<h2 data-id="heading-7">三、3D网格图（对应MATLAB mesh()）：ax.plot_wireframe()</h2>
<p><code>plot_wireframe()</code>对应MATLAB的<code>mesh()</code>，用于绘制<strong>三维网格面</strong>，仅显示曲面的网格线条，适合展示函数的空间轮廓，不填充颜色。</p>
<h3 data-id="heading-8">3.1 核心步骤：生成网格数据</h3>
<p>绘制二维函数<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi><mo>=</mo><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">z = f(x, y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span></span>的网格图，需先通过<code>np.meshgrid()</code>生成X、Y平面的网格坐标：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 生成x、y轴的一维数据</span>
x = np.linspace(-<span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-number">50</span>)
y = np.linspace(-<span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-number">50</span>)
<span class="hljs-comment"># 生成网格坐标矩阵</span>
X, Y = np.meshgrid(x, y)
</code></pre>
<p><strong>说明</strong>：<code>np.meshgrid()</code>将一维的x、y转换为二维矩阵，使每个<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>X</mi><mo stretchy="false">[</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">]</mo><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">[</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">]</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(X[i,j], Y[i,j])</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">])</span></span></span></span></span>对应平面上的一个点。</p>
<h3 data-id="heading-9">3.2 基本语法</h3>
<pre><code class="hljs language-python" lang="python">ax.plot_wireframe(X, Y, Z, rstride, cstride, color, linewidth, ...)
</code></pre>
<ul>
<li><code>rstride/cstride</code>：行/列步长（数值越大，网格越稀疏）；</li>
<li><code>Z</code>：与X、Y对应的z轴数据矩阵。</li>
</ul>
<h3 data-id="heading-10">3.3 实战案例：绘制正弦曲面网格图</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">from</span> mpl_toolkits <span class="hljs-keyword">import</span> mplot3d

<span class="hljs-comment"># 1. 生成网格数据</span>
x = np.linspace(-np.pi, np.pi, <span class="hljs-number">30</span>)
y = np.linspace(-np.pi, np.pi, <span class="hljs-number">30</span>)
X, Y = np.meshgrid(x, y)
<span class="hljs-comment"># 2. 定义三维函数：z = sin(X) + cos(Y)</span>
Z = np.sin(X) + np.cos(Y)

<span class="hljs-comment"># 3. 创建3D绘图环境</span>
fig = plt.figure(figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">8</span>))
ax = plt.axes(projection=<span class="hljs-string">'3d'</span>)

<span class="hljs-comment"># 4. 绘制网格图</span>
ax.plot_wireframe(X, Y, Z, rstride=<span class="hljs-number">2</span>, cstride=<span class="hljs-number">2</span>, color=<span class="hljs-string">'purple'</span>, linewidth=<span class="hljs-number">1</span>)

<span class="hljs-comment"># 5. 设置标签与标题</span>
ax.set_xlabel(<span class="hljs-string">'X (rad)'</span>, fontsize=<span class="hljs-number">12</span>)
ax.set_ylabel(<span class="hljs-string">'Y (rad)'</span>, fontsize=<span class="hljs-number">12</span>)
ax.set_zlabel(<span class="hljs-string">'Z'</span>, fontsize=<span class="hljs-number">12</span>)
ax.set_title(<span class="hljs-string">'三维正弦曲面网格图（mesh/plot_wireframe实现）'</span>, fontsize=<span class="hljs-number">14</span>)

plt.show()
</code></pre>
<p><strong>参数解读</strong>：<code>rstride=2, cstride=2</code>表示每隔2个点绘制一条网格线，若设为1则网格密集，渲染速度变慢；<code>color</code>统一设置网格线条颜色。</p>
<h2 data-id="heading-11">四、3D曲面图（对应MATLAB surf()）：ax.plot_surface()</h2>
<p><code>plot_surface()</code>对应MATLAB的<code>surf()</code>，用于绘制<strong>填充颜色的三维曲面</strong>，通过颜色映射（colormap）可直观展示Z值的变化，是最常用的三维曲面可视化方法。</p>
<h3 data-id="heading-12">4.1 基本语法</h3>
<pre><code class="hljs language-python" lang="python">ax.plot_surface(X, Y, Z, cmap, alpha, edgecolor, ...)
</code></pre>
<ul>
<li><code>cmap</code>：颜色映射方案（如<code>'viridis'</code>、<code>'plasma'</code>、<code>'coolwarm'</code>）；</li>
<li><code>alpha</code>：透明度（0-1，1为不透明）；</li>
<li><code>edgecolor</code>：曲面边缘线条颜色（设为<code>'none'</code>则隐藏边缘）。</li>
</ul>
<h3 data-id="heading-13">4.2 实战案例1：绘制抛物面曲面图</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">from</span> mpl_toolkits <span class="hljs-keyword">import</span> mplot3d

<span class="hljs-comment"># 生成网格数据</span>
x = np.linspace(-<span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">50</span>)
y = np.linspace(-<span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">50</span>)
X, Y = np.meshgrid(x, y)
<span class="hljs-comment"># 抛物面函数：z = x² + y²</span>
Z = X**<span class="hljs-number">2</span> + Y**<span class="hljs-number">2</span>

<span class="hljs-comment"># 创建绘图环境</span>
fig = plt.figure(figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">8</span>))
ax = plt.axes(projection=<span class="hljs-string">'3d'</span>)

<span class="hljs-comment"># 绘制曲面图</span>
surf = ax.plot_surface(X, Y, Z, cmap=<span class="hljs-string">'viridis'</span>, alpha=<span class="hljs-number">0.8</span>, edgecolor=<span class="hljs-string">'black'</span>)

<span class="hljs-comment"># 添加颜色条（展示Z值与颜色的对应关系）</span>
fig.colorbar(surf, ax=ax, shrink=<span class="hljs-number">0.6</span>, aspect=<span class="hljs-number">10</span>, label=<span class="hljs-string">'Z值'</span>)

<span class="hljs-comment"># 设置标签与标题</span>
ax.set_xlabel(<span class="hljs-string">'X'</span>)
ax.set_ylabel(<span class="hljs-string">'Y'</span>)
ax.set_zlabel(<span class="hljs-string">'Z'</span>)
ax.set_title(<span class="hljs-string">'三维抛物面曲面图（surf/plot_surface实现）'</span>, fontsize=<span class="hljs-number">14</span>)

plt.show()
</code></pre>
<p><strong>结果解读</strong>：颜色从蓝到黄渐变，对应Z值从0（中心）到32（边缘）递增，颜色条清晰展示了数值与颜色的映射关系；<code>edgecolor='black'</code>让曲面的网格边缘更明显。</p>
<h3 data-id="heading-14">4.3 实战案例2：彩色正弦曲面（隐藏边缘）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 复用前文的X、Y、Z数据（Z = sin(X) + cos(Y)）</span>
fig = plt.figure(figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">8</span>))
ax = plt.axes(projection=<span class="hljs-string">'3d'</span>)

<span class="hljs-comment"># 隐藏边缘的曲面图</span>
surf = ax.plot_surface(X, Y, Z, cmap=<span class="hljs-string">'coolwarm'</span>, alpha=<span class="hljs-number">0.9</span>, edgecolor=<span class="hljs-string">'none'</span>)

fig.colorbar(surf, ax=ax, shrink=<span class="hljs-number">0.6</span>, label=<span class="hljs-string">'Z值'</span>)
ax.set_xlabel(<span class="hljs-string">'X (rad)'</span>)
ax.set_ylabel(<span class="hljs-string">'Y (rad)'</span>)
ax.set_zlabel(<span class="hljs-string">'Z'</span>)
ax.set_title(<span class="hljs-string">'彩色正弦曲面（无边缘）'</span>, fontsize=<span class="hljs-number">14</span>)

plt.show()
</code></pre>
<p><strong>技巧</strong>：<code>edgecolor='none'</code>可让曲面更平滑，适合展示连续的颜色渐变效果。</p>
<h2 data-id="heading-15">五、等高线图（对应MATLAB contour()）：contour()/contour3D()</h2>
<p>等高线图通过<strong>二维平面上的闭合曲线</strong>展示三维函数的Z值分布，分为<strong>2D等高线</strong>（<code>ax.contour()</code>）和<strong>3D等高线</strong>（<code>ax.contour3D()</code>），对应MATLAB的<code>contour()</code>和<code>contour3()</code>。</p>
<h3 data-id="heading-16">5.1 2D等高线图：ax.contour()</h3>
<h4 data-id="heading-17">5.1.1 基本语法</h4>
<pre><code class="hljs language-python" lang="python">ax.contour(X, Y, Z, levels, colors, linewidths, label, ...)
</code></pre>
<ul>
<li><code>levels</code>：等高线层级数（或指定具体数值）；</li>
<li><code>colors</code>：等高线颜色；</li>
<li><code>linewidths</code>：线条宽度。</li>
</ul>
<h4 data-id="heading-18">5.1.2 实战案例：抛物面2D等高线</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 复用抛物面的X、Y、Z数据</span>
fig, ax = plt.subplots(figsize=(<span class="hljs-number">8</span>, <span class="hljs-number">6</span>))

<span class="hljs-comment"># 绘制2D等高线</span>
contour = ax.contour(X, Y, Z, levels=<span class="hljs-number">15</span>, cmap=<span class="hljs-string">'viridis'</span>, linewidths=<span class="hljs-number">1.5</span>)

<span class="hljs-comment"># 添加等高线数值标签</span>
ax.clabel(contour, inline=<span class="hljs-literal">True</span>, fontsize=<span class="hljs-number">8</span>, fmt=<span class="hljs-string">'%.1f'</span>)

<span class="hljs-comment"># 设置标签与标题</span>
ax.set_xlabel(<span class="hljs-string">'X'</span>)
ax.set_ylabel(<span class="hljs-string">'Y'</span>)
ax.set_title(<span class="hljs-string">'抛物面2D等高线图'</span>, fontsize=<span class="hljs-number">14</span>)
plt.grid(<span class="hljs-literal">True</span>, alpha=<span class="hljs-number">0.3</span>)
plt.show()
</code></pre>
<p><strong>关键参数</strong>：<code>ax.clabel()</code>用于添加等高线的数值标签，<code>inline=True</code>表示标签嵌入线条内部。</p>
<h3 data-id="heading-19">5.2 3D等高线图：ax.contour3D()</h3>
<p><code>contour3D()</code>将等高线绘制在<strong>三维空间的指定Z平面</strong>，保留三维空间的立体感。</p>
<h4 data-id="heading-20">5.2.1 基本语法</h4>
<pre><code class="hljs language-python" lang="python">ax.contour3D(X, Y, Z, levels, cmap, linewidths, ...)
</code></pre>
<h4 data-id="heading-21">5.2.2 实战案例：正弦曲面3D等高线</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 复用正弦曲面的X、Y、Z数据</span>
fig = plt.figure(figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">8</span>))
ax = plt.axes(projection=<span class="hljs-string">'3d'</span>)

<span class="hljs-comment"># 绘制3D等高线（20个层级）</span>
ax.contour3D(X, Y, Z, levels=<span class="hljs-number">20</span>, cmap=<span class="hljs-string">'coolwarm'</span>, linewidths=<span class="hljs-number">1</span>)

<span class="hljs-comment"># 设置视角与标签</span>
ax.view_init(elev=<span class="hljs-number">30</span>, azim=<span class="hljs-number">60</span>)  <span class="hljs-comment"># 调整视角（仰角30°，方位角60°）</span>
ax.set_xlabel(<span class="hljs-string">'X (rad)'</span>)
ax.set_ylabel(<span class="hljs-string">'Y (rad)'</span>)
ax.set_zlabel(<span class="hljs-string">'Z'</span>)
ax.set_title(<span class="hljs-string">'正弦曲面3D等高线图'</span>, fontsize=<span class="hljs-number">14</span>)

plt.show()
</code></pre>
<p><strong>视角调整</strong>：<code>ax.view_init(elev, azim)</code>可手动设置绘图视角，<code>elev</code>为仰角（与XY平面的夹角），<code>azim</code>为方位角（绕Z轴的旋转角度）。</p>
<h3 data-id="heading-22">5.3 混合绘图：曲面图+3D等高线</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 抛物面数据的曲面+3D等高线混合图</span>
fig = plt.figure(figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">8</span>))
ax = plt.axes(projection=<span class="hljs-string">'3d'</span>)

<span class="hljs-comment"># 绘制曲面（半透明）</span>
ax.plot_surface(X, Y, Z, cmap=<span class="hljs-string">'viridis'</span>, alpha=<span class="hljs-number">0.5</span>, edgecolor=<span class="hljs-string">'none'</span>)
<span class="hljs-comment"># 绘制3D等高线</span>
ax.contour3D(X, Y, Z, levels=<span class="hljs-number">10</span>, cmap=<span class="hljs-string">'viridis'</span>, linewidths=<span class="hljs-number">2</span>)

ax.set_xlabel(<span class="hljs-string">'X'</span>)
ax.set_ylabel(<span class="hljs-string">'Y'</span>)
ax.set_zlabel(<span class="hljs-string">'Z'</span>)
ax.set_title(<span class="hljs-string">'抛物面：曲面图+3D等高线'</span>, fontsize=<span class="hljs-number">14</span>)
plt.show()
</code></pre>
<p><strong>实战价值</strong>：混合绘图既展示了曲面的整体形态，又通过等高线清晰标注了Z值的分布，适合专业报告与论文可视化。</p>
<h2 data-id="heading-23">六、三维绘图常见技巧与问题解决</h2>
<h3 data-id="heading-24">6.1 调整视角</h3>
<p>除了<code>ax.view_init()</code>，还可在绘图窗口中<strong>鼠标交互调整</strong>：</p>
<ul>
<li>左键拖动：旋转视角（调整azim/elev）；</li>
<li>滚轮：缩放画面；</li>
<li>右键拖动：平移画面。</li>
</ul>
<h3 data-id="heading-25">6.2 设置坐标轴范围</h3>
<p>通过<code>ax.set_xlim()</code>/<code>ax.set_ylim()</code>/<code>ax.set_zlim()</code>固定坐标轴范围，避免自动缩放导致的比例失调：</p>
<pre><code class="hljs language-python" lang="python">ax.set_xlim(-<span class="hljs-number">5</span>, <span class="hljs-number">5</span>)
ax.set_ylim(-<span class="hljs-number">5</span>, <span class="hljs-number">5</span>)
ax.set_zlim(-<span class="hljs-number">2</span>, <span class="hljs-number">2</span>)
</code></pre>
<h3 data-id="heading-26">6.3 保存高清图片</h3>
<p>使用<code>plt.savefig()</code>保存图片，设置<code>dpi</code>参数提高分辨率：</p>
<pre><code class="hljs language-python" lang="python">plt.savefig(<span class="hljs-string">'3d_surface.png'</span>, dpi=<span class="hljs-number">300</span>, bbox_inches=<span class="hljs-string">'tight'</span>)
</code></pre>
<ul>
<li><code>dpi=300</code>：适合印刷/论文的高清分辨率；</li>
<li><code>bbox_inches='tight'</code>：裁剪空白边缘。</li>
</ul>
<h3 data-id="heading-27">6.4 解决“网格/曲面渲染模糊”问题</h3>
<ul>
<li>增大<code>np.linspace()</code>的采样点数（如从30改为50），让数据更密集；</li>
<li>保存图片时提高<code>dpi</code>；</li>
<li>减少<code>rstride/cstride</code>的步长（设为1）。</li>
</ul>
<h3 data-id="heading-28">6.5 自定义颜色映射</h3>
<p><code>matplotlib</code>内置了数十种颜色映射方案，也可自定义：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> matplotlib.colors <span class="hljs-keyword">import</span> LinearSegmentedColormap

<span class="hljs-comment"># 自定义从红到绿的颜色映射</span>
colors = [(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>), (<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>)]  <span class="hljs-comment"># 红→绿</span>
cmap = LinearSegmentedColormap.from_list(<span class="hljs-string">'custom'</span>, colors, N=<span class="hljs-number">100</span>)
ax.plot_surface(X, Y, Z, cmap=cmap)
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Github项目CI&CD部署]]></title>    <link>https://juejin.cn/post/7585839411121766446</link>    <guid>https://juejin.cn/post/7585839411121766446</guid>    <pubDate>2025-12-21T13:42:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585839411121766446" data-draft-id="7585839411121750062" data-original-type="2" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Github项目CI&amp;CD部署"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-21T13:42:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="charlee44"/> <meta itemprop="url" content="https://juejin.cn/user/1117549770846872"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Github项目CI&amp;CD部署
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1117549770846872/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    charlee44
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T13:42:04.000Z" title="Sun Dec 21 2025 13:42:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 引言</h2>
<p>在软件开发中，<strong>CI/CD</strong>（持续集成 / 持续部署）是一种自动化流程：每当代码更新，系统会自动<strong>构建、测试并部署</strong>应用，避免手动操作的繁琐与错误。作为 DevOps 的核心实践，CI/CD 有力支撑了敏捷开发“快速交付、持续反馈”的理念，让团队既能灵活响应变化，又能保障交付质量。</p>
<h2 data-id="heading-1">2. 操作</h2>
<h3 data-id="heading-2">2.1 配置 SSH 密钥</h3>
<p>如果代码托管在 GitHub 上，那么可以通过 GitHub Actions 来实现 CI/CD 部署。其实 GitHub Actions 的实现原理很简单，就是通过 SSH 登录到目标主机，然后执行一键安装部署脚本。</p>
<p>由于 GitHub Actions 的原理是 Github 主机登录到目标主机（Ubuntu）来执行命令，因此最好先生成一对专用于 CI/CD 新的 SSH 密钥。笔者的开发环境是 Windows，因此通过 PowerShell 来生成：</p>
<pre><code class="hljs language-bash" lang="bash">ssh-keygen -t rsa -b 4096 -f ./github_cicd_key
</code></pre>
<p>然后会提示输入密码：</p>
<pre><code class="hljs language-bash" lang="bash">Enter passphrase (empty <span class="hljs-keyword">for</span> no passphrase):
</code></pre>
<p>CI/CD 场景下一般用无密码密钥，直接按回车。结束运行后就可以看到两个密钥文件：</p>
<ul>
<li>github_cicd_key（私钥）</li>
<li>github_cicd_key.pub（公钥）</li>
</ul>
<p>将公钥内容添加到 Ubuntu 服务器的 ~/.ssh/authorized_keys：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在 Ubuntu 服务器上执行</span>&#13;
<span class="hljs-built_in">echo</span> <span class="hljs-string">"粘贴 github_cicd_key.pub 的全部内容"</span> &gt;&gt; ~/.ssh/authorized_keys
</code></pre>
<p>回到 GitHub 仓库页面：</p>
<ul>
<li>进入 Settings -&gt; Security -&gt; Secrets and variables → Actions</li>
<li>点击 New repository secret</li>
<li>添加以下三个 Secret：</li>
</ul>





















<table><thead><tr><th>Name</th><th>Value（值）</th></tr></thead><tbody><tr><td>SERVER_HOST</td><td>目标主机 IP（如 123.123.123.123）</td></tr><tr><td>SERVER_USER</td><td>登录用户名（如 ubuntu、root 等）</td></tr><tr><td>SSH_PRIVATE_KEY</td><td>打开 github_cicd_key 文件，复制全部内容粘贴进来</td></tr></tbody></table>
<h3 data-id="heading-3">2.2 创建 CI/CD 工作流</h3>
<p>在本地项目根目录（Windows 上）创建文件：</p>
<pre><code class="hljs language-text" lang="text">.github/workflows/build-and-deploy.yml
</code></pre>
<p>内容如下所示：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">Blog</span>&#13;
&#13;
<span class="hljs-comment"># 支持两种触发方式</span>&#13;
<span class="hljs-attr">on:</span>&#13;
  <span class="hljs-comment"># 1. 手动触发（GitHub UI 上点击 "Run workflow"）</span>&#13;
  <span class="hljs-attr">workflow_dispatch:</span>&#13;
&#13;
  <span class="hljs-comment"># 2. 自动触发：仅当推送到 main 分支 且 提交信息含 [deploy]</span>&#13;
  <span class="hljs-attr">push:</span>&#13;
    <span class="hljs-attr">branches:</span> [<span class="hljs-string">main</span>]&#13;
&#13;
<span class="hljs-attr">jobs:</span>&#13;
  <span class="hljs-attr">deploy:</span> &#13;
    <span class="hljs-attr">if:</span> <span class="hljs-string">&gt;</span>&#13;
      <span class="hljs-string">github.event_name</span> <span class="hljs-string">==</span> <span class="hljs-string">'workflow_dispatch'</span> <span class="hljs-string">||</span>&#13;
      <span class="hljs-string">(github.event_name</span> <span class="hljs-string">==</span> <span class="hljs-string">'push'</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">contains(github.event.head_commit.message,</span> <span class="hljs-string">'[deploy]'</span><span class="hljs-string">))</span>&#13;
&#13;
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>&#13;
    <span class="hljs-attr">steps:</span>&#13;
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">remote</span> <span class="hljs-string">script</span> <span class="hljs-string">via</span> <span class="hljs-string">SSH</span>&#13;
        <span class="hljs-attr">uses:</span> <span class="hljs-string">appleboy/ssh-action@v1.0.3</span>&#13;
        <span class="hljs-attr">with:</span>&#13;
          <span class="hljs-attr">host:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.SERVER_HOST</span> <span class="hljs-string">}}</span>&#13;
          <span class="hljs-attr">username:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.SERVER_USER</span> <span class="hljs-string">}}</span>&#13;
          <span class="hljs-attr">key:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.SSH_PRIVATE_KEY</span> <span class="hljs-string">}}</span>&#13;
          <span class="hljs-attr">script:</span> <span class="hljs-string">|</span>&#13;
            <span class="hljs-string">cd</span> <span class="hljs-string">/home/ubuntu/</span>&#13;
            <span class="hljs-string">bash</span> <span class="hljs-string">-l</span> <span class="hljs-string">-c</span> <span class="hljs-string">'./build-and-deploy.sh'</span>
</code></pre>
<p>这段工作流配置的意思是：</p>
<ul>
<li>可以手动触发（GitHub UI 上点击 "Run workflow"）CI/CD 工作流。</li>
<li>可以自动触发 CI/CD 工作流，不过要求推送到 main 分支且提交信息含 [deploy] 。</li>
<li>使用 SSH 的配置 <code>SERVER_HOST</code>、<code>SERVER_USER</code> 和 <code>SSH_PRIVATE_KEY</code> 登录目标主机 。</li>
<li>执行一键构建和部署脚本 <code>build-and-deploy.sh</code> 。</li>
</ul>
<p>build-and-deploy.yml 需要提交并推送到 GitHub：</p>
<pre><code class="hljs language-sql" lang="sql">git <span class="hljs-keyword">add</span> .&#13;
git <span class="hljs-keyword">commit</span> <span class="hljs-operator">-</span>m "Add simple CI/CD workflow"&#13;
git push origin main
</code></pre>
<p>最后，通过打开 GitHub 仓库 → Actions 标签页，就可以看到是否有 workflow 正在运行（绿色 ✔ 表示成功），还可以查看具体的 CI/CD 日志。</p>
<h3 data-id="heading-4">2.3 注意事项</h3>
<p>CI/CD 的配置文件 build-and-deploy.yml 中执行任意 shell 命令，不过还是推荐封装好一键构建部署脚本，直接调用这个脚本。很多情况下可以使用这个脚本来进行手动部署。</p>
<p>另外 GitHub Actions 使用的是 非交互式、非登录式 shell，不会加载 .bashrc 或 .profile，环境变量（尤其是 PATH）与手动登录时不同。因此，有两种方案：</p>
<ol>
<li>在构建部署脚本的开头显式加载环境。比如：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 用于CI/CD环境配置</span>&#13;
<span class="hljs-built_in">export</span> NVM_DIR=<span class="hljs-string">"<span class="hljs-variable">$HOME</span>/.nvm"</span>&#13;
[ -s <span class="hljs-string">"<span class="hljs-variable">$NVM_DIR</span>/nvm.sh"</span> ] &amp;&amp; \. <span class="hljs-string">"<span class="hljs-variable">$NVM_DIR</span>/nvm.sh"</span>  <span class="hljs-comment"># This loads nvm</span>&#13;
[ -s <span class="hljs-string">"<span class="hljs-variable">$NVM_DIR</span>/bash_completion"</span> ] &amp;&amp; \. <span class="hljs-string">"<span class="hljs-variable">$NVM_DIR</span>/bash_completion"</span>  <span class="hljs-comment"># This loads nvm bash_completion</span>&#13;
&#13;
<span class="hljs-built_in">export</span> LD_LIBRARY_PATH=/home/ubuntu/GISBasic/lib/:/home/ubuntu/GISBasic/lib64/:<span class="hljs-variable">${LD_LIBRARY_PATH:-}</span> <span class="hljs-comment">#支持变量 LD_LIBRARY_PATH 未定义或为空</span>
</code></pre>
<ol start="2">
<li>配置文件 build-and-deploy.yml 执行脚本命令增加 <code>bash -l -c</code>，表示以登录用户的身份启动一个新 shell，并在这个环境中运行脚本。例如这里的：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">bash -l -c <span class="hljs-string">'./build-and-deploy.sh'</span>
</code></pre>
<h2 data-id="heading-5">3. 展望</h2>
<p>其实 CI/CD 配置远不是那么简单，随着项目复杂度提升，还可以逐步引入更多工程实践：</p>
<ul>
<li>基于 Git Tag 的正式发布：当功能稳定时，打一个 v1.0.0 这样的语义化版本标签，自动触发构建并将二进制文件上传到 GitHub Release，方便他人下载使用。</li>
<li>自动化测试集成：在部署前运行单元测试、端到端测试，确保新代码不会破坏现有功能。</li>
<li>多环境支持：区分开发、预发、生产环境，避免直接在生产服务器上“试错”。</li>
<li>基础设施即代码（IaC）：用 Ansible、Terraform 等工具管理服务器配置，让环境可复现、可版本控制。</li>
<li>监控与回滚机制：部署后自动检查服务健康状态，异常时自动回退到上一版本。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🐟 摸鱼指南（一）：5 秒建项目，拒绝搬砖]]></title>    <link>https://juejin.cn/post/7585727457472790528</link>    <guid>https://juejin.cn/post/7585727457472790528</guid>    <pubDate>2025-12-21T14:19:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585727457472790528" data-draft-id="7585007321207291956" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🐟 摸鱼指南（一）：5 秒建项目，拒绝搬砖"/> <meta itemprop="keywords" content="Flutter,Visual Studio Code,MVVM"/> <meta itemprop="datePublished" content="2025-12-21T14:19:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="TT_Close"/> <meta itemprop="url" content="https://juejin.cn/user/2858385964538663"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🐟 摸鱼指南（一）：5 秒建项目，拒绝搬砖
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2858385964538663/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    TT_Close
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T14:19:10.000Z" title="Sun Dec 21 2025 14:19:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.7;font-weight:400;font-size:16px;overflow-x:hidden;color:#212122}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:8px;padding-bottom:8px}.markdown-body h1{color:#a0a0a0;font-size:38px;margin-top:32px;padding-top:32px}.markdown-body h2{color:#fff;background-color:#212122;width:fit-content;border-bottom-right-radius:100px;margin-top:47px;margin-bottom:16px;padding:4px 48px 4px 8px;line-height:1.7;font-size:30px;transition:all .3s ease-out}.markdown-body h2:hover{border-bottom-right-radius:50px;transition:all .3s ease-out}.markdown-body h3{font-size:24px;padding-left:8px;margin-top:32px;border-bottom:2px solid #c6c4c4;line-height:1.7}.markdown-body h4{font-size:20px;padding-left:8px;margin-top:32px;border-bottom:1px solid #ddd}.markdown-body h5{font-size:16px;margin-top:24px}.markdown-body h6{margin-top:16px;line-height:1.1}.markdown-body p{font-size:16px;text-align:start;white-space:normal;text-size-adjust:auto;line-height:2;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%;margin:auto;padding-left:8px;padding-right:8px}.markdown-body hr{border:none;border-top:4px double #212122;margin-top:32px;margin-bottom:32px;text-align:center}.markdown-body hr:after{content:"♥";display:inline-block;position:relative;top:-15px;padding:0 10px;color:#212122;font-size:18px}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f1f1f1;color:#ef7060;font-size:14px;padding:.065em 6px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.7;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);margin:32px 16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-color:#212122;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);background-size:40px}.markdown-body pre&gt;code{font-size:14px;padding:16px 8px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#fff;background:#272822}.markdown-body pre&gt;code::-webkit-scrollbar{height:10px;background-color:#f5f5f5}.markdown-body pre&gt;code::-webkit-scrollbar-track{box-shadow:inset 0 0 6px rgba(0,0,0,.3);border-radius:3px;background-color:#f5f5f5}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{border-radius:3px;box-shadow:inset 0 0 6px rgba(0,0,0,.3);background-color:#555}.markdown-body a{color:#ef7060;padding:2px;text-decoration:none;border-bottom:.125em solid #ef7060;border-radius:2px;box-shadow:inset 0 -.025em 0 #ef7060;transition:box-shadow .27s cubic-bezier(.77,0,.175,1),color .27s cubic-bezier(.77,0,.175,1)}.markdown-body a:focus,.markdown-body a:hover{outline:none;box-shadow:inset 0 -1.5em 0 #ef7060;color:#fff}.markdown-body a:before{content:"⇲ ";vertical-align:top;margin-left:2px;font-family:dart!important;font-size:12px;color:inherit;opacity:.7}.markdown-body table{background:#fbfbfb;border-radius:4px;border-collapse:collapse;margin:auto;padding:5px;width:95%;box-shadow:0 5px 10px rgba(0,0,0,.1);animation:float 5s infinite}.markdown-body table th{color:#fff;background:#212122;border-bottom:1px solid #9ea7af;border-right:1px solid #343a45;font-size:18px;padding:16px;text-align:left;vertical-align:middle}.markdown-body table th:first-child{border-top-left-radius:4px}.markdown-body table th:last-child{border-top-right-radius:4px;border-right:none}.markdown-body table tr{border-top:1px solid #c1c3d1;border-bottom:1px solid #c1c3d1;color:#666b85}.markdown-body table tr:hover td{background:#212122;color:#fff;border-top:1px solid #22262e}.markdown-body table tr:first-child{border-top:none}.markdown-body table tr:last-child{border-bottom:none}.markdown-body table tr:nth-child(odd) td{background:#f1f1f1}.markdown-body table tr:nth-child(odd):hover td{background:#212122}.markdown-body table tr:last-child td:first-child{border-bottom-left-radius:4px}.markdown-body table tr:last-child td:last-child{border-bottom-right-radius:4px}.markdown-body table td{background:#fbfbfb;padding:16px;text-align:left;vertical-align:middle;font-size:16px;border-right:1px solid #c1c3d1}.markdown-body table td:last-child{border-right:0}.markdown-body blockquote{color:#777;padding:1px 16px;margin:24px 0;border-left:4px solid #c6c4c4;background-color:#f1f1f1;transition:all .3s ease-out;border-radius:4px}.markdown-body blockquote:hover{border-left-color:#212122;background-color:#212122;color:#fff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:24px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body span.math{margin-left:32px;font-size:18px;font-weight:700}@media (max-width:720px){.markdown-body h1{font-size:30.4px}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:19.2px}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:12.8px}}</style><style data-highlight="" data-highlight-key="an-old-hope">.hljs-comment,.hljs-quote{color:#b6b18b}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#eb3c54}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#e7ce56}.hljs-attribute{color:#ee7c2b}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#4fb4d7}.hljs-section,.hljs-title{color:#78bb65}.hljs-keyword,.hljs-selector-tag{color:#b45ea4}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1c1d21;color:#c0c5ce}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong><code>flutter create</code> = 毛坯房，搭架子 30 分钟，一行业务都没写。</strong></p>
<p>Flu CLI = 精装房，<strong>5 秒拎包入住</strong>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">😤 flutter create 给你了什么？</h2>
<pre><code class="hljs language-bash" lang="bash">flutter create my_app
</code></pre>
<pre><code class="hljs language-bash" lang="bash">lib/
└── main.dart   <span class="hljs-comment"># 一个 Counter Demo，就这？</span>
</code></pre>
<p><strong>然后你要</strong>：</p>
<ul>
<li>手动建 10+ 个目录（5 分钟）</li>
<li>写 BasePage、BaseViewModel 基类（10 分钟）</li>
<li>配路由、主题、删示例代码（10 分钟）</li>
</ul>
<p><strong>总计 30 分钟，一行业务都没写。</strong> 😡</p>
<hr/>
<h2 data-id="heading-1">🚀 Flu CLI 的方式:5 秒精装房</h2>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45385ea6571d4165aea81bc9af6a368c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFRfQ2xvc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766934412&amp;x-signature=1pGqC%2BjrykVLeyNXMUEMK7M%2Ferc%3D" alt="create-project-modular.gif" loading="lazy"/></p>
<h3 data-id="heading-2">操作步骤</h3>
<p><strong>3 步搞定</strong>：</p>
<ol>
<li><strong>右键空文件夹</strong> → 选择 <code>Flu: 创建新项目</code></li>
<li><strong>选择模板</strong> → 输入项目名（如 <code>my_app</code>）→ 输入包名（如 <code>com.example.myapp</code>）</li>
<li><strong>等 5 秒</strong> → 项目自动在新窗口打开</li>
</ol>
<p><strong>完事儿。</strong></p>
<h3 data-id="heading-3">你得到了什么？</h3>
<p>以 <strong>Modular</strong> 模板为例：</p>
<pre><code class="hljs language-csharp" lang="csharp">my_app/
├── lib/
│   ├── core/
│   │   ├── <span class="hljs-keyword">base</span>/
│   │   │   ├── base_page.dart          <span class="hljs-meta"># ✅ 基类写好了</span>
│   │   │   └── base_viewmodel.dart     <span class="hljs-meta"># ✅ 基类写好了</span>
│   │   ├── theme/
│   │   │   └── app_theme.dart          <span class="hljs-meta"># ✅ 主题配好了</span>
│   │   └── router/
│   │       └── app_router.dart         <span class="hljs-meta"># ✅ 路由配好了</span>
│   ├── features/
│   │   └── home/
│   │       ├── pages/
│   │       │   └── home_page.dart      <span class="hljs-meta"># ✅ 示例页面有了</span>
│   │       ├── viewmodels/
│   │       │   └── home_viewmodel.dart <span class="hljs-meta"># ✅ 示例 VM 有了</span>
│   │       └── widgets/
│   ├── shared/
│   │   ├── models/
│   │   ├── services/
│   │   └── widgets/
│   └── main.dart
├── .flu-cli.json                        <span class="hljs-meta"># ✅ 配置文件也有了</span>
└── pubspec.yaml
</code></pre>
<p><strong>关键是</strong>：这些代码都是能跑的，不是空壳！</p>
<p><strong>BasePage、BaseViewModel、主题配置、路由配置...全部写好了。</strong></p>
<hr/>
<h2 data-id="heading-4">📦 4 种内置模板</h2>
<blockquote>
<p><strong>选择困难？看这张表 👇</strong></p>
</blockquote>



































<table><thead><tr><th>模板</th><th>适合场景</th><th>结构</th><th>推荐</th></tr></thead><tbody><tr><td><strong>Lite</strong></td><td>Demo、快速验证</td><td><code>pages/widgets/models/</code></td><td>⭐⭐⭐</td></tr><tr><td><strong>Modular</strong></td><td>中大型项目、团队开发</td><td><code>core/features/shared/</code></td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><strong>Clean</strong></td><td>企业级、严格分层</td><td><code>domain/data/presentation/</code></td><td>⭐⭐⭐⭐</td></tr><tr><td><strong>Custom</strong></td><td>团队统一标准</td><td>自定义</td><td>⭐⭐⭐⭐⭐</td></tr></tbody></table>

<p><img alt="模板对比转存失败，建议直接上传图片文件" src="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-5">Lite：轻装上阵</h3>
<pre><code class="hljs language-css" lang="css">lib/
├── pages/
├── widgets/
├── models/
└── <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.dart</span>
</code></pre>
<p><strong>一句话</strong>：扁平结构，快速开发，不适合大项目。</p>
<hr/>
<h3 data-id="heading-6">Modular：推荐 ⭐</h3>
<pre><code class="hljs language-bash" lang="bash">lib/
├── core/       <span class="hljs-comment"># 基类、主题、路由</span>
├── features/   <span class="hljs-comment"># 功能模块（home/auth/profile...）</span>
└── shared/     <span class="hljs-comment"># 共享层（models/services/widgets）</span>
</code></pre>
<p><strong>一句话</strong>：按功能分模块，团队协作首选。</p>
<hr/>
<h3 data-id="heading-7">Clean：架构洁癖者专属</h3>
<pre><code class="hljs language-bash" lang="bash">lib/
├── domain/        <span class="hljs-comment"># 领域层</span>
├── data/          <span class="hljs-comment"># 数据层</span>
└── presentation/  <span class="hljs-comment"># 表现层</span>
</code></pre>
<p><strong>一句话</strong>：严格分层，学习曲线陡，企业级项目适用。</p>
<hr/>
<h3 data-id="heading-8">Custom：团队的「黄金标准」 🔥</h3>
<p>把公司标准项目放 Git 仓库，配置成自定义模板，<strong>新人 5 秒上手</strong>。</p>
<p>详见下文 👇</p>
<hr/>
<h2 data-id="heading-9">🎨 自定义模板：团队的「黄金标准」</h2>
<h3 data-id="heading-10">场景</h3>
<p><strong>问题</strong>：</p>
<ul>
<li>公司有一套标准项目结构</li>
<li>包含封装好的网络库、主题、基类、工具类</li>
<li>每次新项目都要从老项目复制？<strong>太 low 了</strong></li>
</ul>
<p><strong>解决方案</strong>：把标准项目放 Git 仓库，配置成自定义模板。</p>
<hr/>
<h3 data-id="heading-11">Step 1：准备 Git 仓库</h3>
<p>把你们公司的标准项目结构推到 Git 仓库：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 示例仓库</span>
https://gitee.com/your-company/flutter-template.git
</code></pre>
<p><strong>仓库内容</strong>：</p>
<pre><code class="hljs language-csharp" lang="csharp">flutter-template/
├── lib/
│   ├── core/
│   │   ├── network/
│   │   │   └── http_client.dart    <span class="hljs-meta"># 封装好的网络库</span>
│   │   ├── <span class="hljs-keyword">base</span>/
│   │   │   ├── base_page.dart
│   │   │   └── base_viewmodel.dart
│   │   └── theme/
│   │       └── company_theme.dart  <span class="hljs-meta"># 公司统一主题</span>
│   ├── features/
│   └── shared/
├── .flu-cli.json                    <span class="hljs-meta"># ✅ 配置文件也放进去</span>
└── pubspec.yaml
</code></pre>
<hr/>
<h3 data-id="heading-12">Step 2:在 Flu CLI 中添加模板</h3>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bb078423d3a461b8c377a10ae252f29~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFRfQ2xvc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766934412&amp;x-signature=RZChzYL1pxLvXalqbsCsn4lEAWw%3D" alt="add-custom-template.gif" loading="lazy"/></p>
<p><strong>Flu CLI 支持两种模板来源</strong>：</p>
<h4 data-id="heading-13">方式一：Git 仓库（推荐）</h4>
<p><strong>操作</strong>：</p>
<ol>
<li>右键空文件夹 → <code>Flu: 创建新项目</code></li>
<li>选择 <code>自定义模板...</code></li>
<li>选择 <code>$(repo) Git 仓库</code></li>
<li>输入仓库 URL：<code>https://gitee.com/your-company/flutter-template.git</code></li>
<li>输入分支名：<code>main</code>（默认）</li>
<li>给模板起个名字：<code>公司标准模板</code></li>
<li>（可选）输入描述</li>
</ol>
<p><strong>优点</strong>：</p>
<ul>
<li>✅ 团队共享，所有人都能拉取</li>
<li>✅ 支持版本管理，模板更新方便</li>
<li>✅ 支持 Gitee/GitHub/GitLab/私有仓库</li>
</ul>
<h4 data-id="heading-14">方式二：本地文件夹</h4>
<p><strong>操作</strong>：</p>
<ol>
<li>右键空文件夹 → <code>Flu: 创建新项目</code></li>
<li>选择 <code>自定义模板...</code></li>
<li>选择 <code>$(folder-opened) 本地文件夹</code></li>
<li>选择本地项目目录（如 <code>/Users/you/my-template</code>）</li>
<li>给模板起个名字：<code>我的本地模板</code></li>
<li>（可选）输入描述</li>
</ol>
<p><strong>优点</strong>：</p>
<ul>
<li>✅ 不需要 Git 仓库</li>
<li>✅ 适合个人使用</li>
<li>✅ 修改立即生效</li>
</ul>
<hr/>
<p><strong>下次创建项目</strong>：</p>
<p>模板列表里会出现 <code>公司标准模板</code> / <code>我的本地模板</code>，选它就完事儿。</p>
<hr/>
<h3 data-id="heading-15">好处</h3>









































<table><thead><tr><th>对比</th><th>传统方式</th><th>自定义模板（Git）</th><th>自定义模板（本地）</th></tr></thead><tbody><tr><td><strong>新项目创建</strong></td><td>从老项目复制 30 分钟</td><td>5 秒</td><td>5 秒</td></tr><tr><td><strong>团队统一</strong></td><td>靠文档约束，不靠谱</td><td>100% 统一</td><td>仅个人使用</td></tr><tr><td><strong>模板更新</strong></td><td>手动通知所有人</td><td>Git 仓库更新，重新拉取</td><td>直接修改本地目录</td></tr><tr><td><strong>新人入职</strong></td><td>培训 2 小时</td><td>5 秒上手</td><td>5 秒上手</td></tr><tr><td><strong>网络要求</strong></td><td>-</td><td>需要能访问 Git</td><td>不需要</td></tr></tbody></table>
<p><strong>配置一次，全员受益。</strong> 🐟🐟🐟</p>
<hr/>
<h2 data-id="heading-16">🔧 高级选项</h2>

















<table><thead><tr><th>选项</th><th>效果</th></tr></thead><tbody><tr><td><code>✅ 初始化配置文件</code></td><td>自动生成 <code>.flu-cli.json</code>，后续生成文件时自动应用配置</td></tr><tr><td><code>✅ 配置 App 资源</code></td><td>顺便把图标和启动图一起配了，一步到位</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-17">❓ FAQ</h2>

























<table><thead><tr><th>问题</th><th>答案</th></tr></thead><tbody><tr><td>创建失败？</td><td>检查网络、查看 VSCode 输出面板、确认 Flutter 已安装</td></tr><tr><td>能改生成的结构吗？</td><td>当然，就是普通 Flutter 项目，随便改</td></tr><tr><td>自定义模板必须是 Git？</td><td>不是，支持 Git 仓库和本地文件夹两种方式</td></tr><tr><td>会覆盖项目名和包名吗？</td><td>会，自动替换</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-18">🐟 摸鱼小结</h2>





























<table><thead><tr><th>功能</th><th>传统</th><th>Flu CLI</th><th>省时</th></tr></thead><tbody><tr><td>建项目</td><td>30 分钟</td><td>5 秒</td><td><strong>29 分 55 秒</strong></td></tr><tr><td>建 10 个项目</td><td>5 小时</td><td>50 秒</td><td><strong>4 小时 59 分</strong></td></tr><tr><td>3 年建 50 个</td><td>25 小时</td><td>4 分钟</td><td><strong>24 小时 56 分</strong></td></tr></tbody></table>
<p><strong>建项目从此告别搬砖。</strong> 🐟🐟🐟</p>
<hr/>
<h2 data-id="heading-19">📚 系列文章</h2>
<ul>
<li><strong><a href="https://juejin.cn/post/7585600621522714664" target="_blank" title="https://juejin.cn/post/7585600621522714664">← 上一篇：主打文章</a></strong></li>
<li><strong><a href="https://juejin.cn/post/7585600621522714664" target="_blank" title="https://juejin.cn/post/7585600621522714664">→ 下一篇：告别 Ctrl+C/V</a></strong></li>
</ul>
<hr/>
<blockquote>
<p>💬 <strong>交流群</strong>：加微信 <code>Huoye-TT</code> 备注 "flu-cli"</p>
<p>⭐ <strong>开源地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fflu-cli%2Fflu-cli" target="_blank" title="https://gitee.com/flu-cli/flu-cli" ref="nofollow noopener noreferrer">Gitee</a> | 求 Star！</p>
<p>📖 <strong>完整文档</strong>：<a href="https://link.juejin.cn?target=http%3A%2F%2Fhuozhiye.cn%2Fflu-cli%2F" target="_blank" title="http://huozhiye.cn/flu-cli/" ref="nofollow noopener noreferrer">huozhiye.cn/flu-cli/</a></p>
</blockquote>
<hr/>
<p><strong>如果这篇文章让你告别了搬砖，点个赞呗 👍</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[python--数据维度与数据格式化]]></title>    <link>https://juejin.cn/post/7585798113546551346</link>    <guid>https://juejin.cn/post/7585798113546551346</guid>    <pubDate>2025-12-21T13:52:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585798113546551346" data-draft-id="7585686247286718515" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="python--数据维度与数据格式化"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-21T13:52:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="酷酷的佳"/> <meta itemprop="url" content="https://juejin.cn/user/2939463340923272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            python--数据维度与数据格式化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2939463340923272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    酷酷的佳
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T13:52:10.000Z" title="Sun Dec 21 2025 13:52:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、数据维度：从 “线” 到 “体” 的数据形态</h2>
<p>数据维度本质是 “定位一个元素需要几个索引”，可以用生活化的比喻理解：</p>
<ul>
<li>一维：像一根线，只有 “前后” 方向，1 个索引就能找到元素；</li>
<li>二维：像一张纸（表格），需要 “行 + 列”2 个索引定位；</li>
<li>多维：像一个魔方，需要 3 个及以上索引（如长 × 宽 × 高）定位。</li>
</ul>
<h3 data-id="heading-1">1. 一维数据（1D）</h3>
<p>最基础的维度，Python 中常用<strong>列表、元组、一维数组</strong>表示，仅需 1 个索引访问元素。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 示例：存储班级学生姓名（一维列表）</span>
names = [<span class="hljs-string">"张三"</span>, <span class="hljs-string">"李四"</span>, <span class="hljs-string">"王五"</span>]

<span class="hljs-comment"># 访问元素：索引从0开始</span>
<span class="hljs-built_in">print</span>(names[<span class="hljs-number">0</span>])  <span class="hljs-comment"># 输出：张三</span>
<span class="hljs-built_in">print</span>(names[-<span class="hljs-number">1</span>]) <span class="hljs-comment"># 输出：王五（倒数第一个）</span>

<span class="hljs-comment"># 遍历一维数据</span>
<span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> names:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"学生：<span class="hljs-subst">{name}</span>"</span>)
</code></pre>
<p><strong>应用场景</strong>：存储单列数据（如成绩、手机号、商品名称）。</p>
<h3 data-id="heading-2">2. 二维数据（2D）</h3>
<p>类似 Excel 表格，Python 中常用<strong>嵌套列表、二维数组、Pandas DataFrame</strong>表示，需 2 个索引（行 + 列）访问元素。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 示例：存储学生姓名+语文/数学成绩（二维列表）</span>
student_scores = [
    [<span class="hljs-string">"张三"</span>, <span class="hljs-number">90</span>, <span class="hljs-number">88</span>],  <span class="hljs-comment"># 第0行：姓名、语文、数学</span>
    [<span class="hljs-string">"李四"</span>, <span class="hljs-number">85</span>, <span class="hljs-number">92</span>],  <span class="hljs-comment"># 第1行</span>
    [<span class="hljs-string">"王五"</span>, <span class="hljs-number">95</span>, <span class="hljs-number">80</span>]   <span class="hljs-comment"># 第2行</span>
]

<span class="hljs-comment"># 访问元素：行索引 + 列索引</span>
<span class="hljs-built_in">print</span>(student_scores[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>])  <span class="hljs-comment"># 第1行第0列：李四</span>
<span class="hljs-built_in">print</span>(student_scores[<span class="hljs-number">2</span>][<span class="hljs-number">2</span>])  <span class="hljs-comment"># 第2行第2列：80（王五的数学成绩）</span>

<span class="hljs-comment"># 遍历二维数据（按行遍历）</span>
<span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> student_scores:
    name, chinese, math = row  <span class="hljs-comment"># 解包每行数据</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{name}</span>：语文<span class="hljs-subst">{chinese}</span>，数学<span class="hljs-subst">{math}</span>"</span>)
</code></pre>
<p><strong>应用场景</strong>：存储表格型数据（如学生信息表、销售清单）。</p>
<h3 data-id="heading-3">3. 多维数据（3D+）</h3>
<p>三维及以上数据，常见于图像（宽 × 高 × 颜色通道）、时空数据（时间 × 地点 × 指标）等场景，Python 中常用<strong>numpy 多维数组</strong>实现（嵌套列表可读性差，不推荐）。</p>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-lua" lang="lua">import numpy as np

# 示例：三维数组（<span class="hljs-number">2</span>个班级 × <span class="hljs-number">3</span>个学生 × <span class="hljs-number">2</span>门成绩）
class_scores = np.array([
    <span class="hljs-string">[[90, 88], [85, 92], [95, 80]]</span>,  # <span class="hljs-number">1</span>班：<span class="hljs-number">3</span>个学生的语文/数学成绩
    <span class="hljs-string">[[88, 91], [79, 85], [92, 87]]</span>   # <span class="hljs-number">2</span>班
])

# 访问元素：班级索引 + 学生索引 + 科目索引
<span class="hljs-built_in">print</span>(class_scores[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>][<span class="hljs-number">1</span>])  # <span class="hljs-number">1</span>班第<span class="hljs-number">2</span>个学生的数学成绩：<span class="hljs-number">92</span>
<span class="hljs-built_in">print</span>(class_scores.shape)     # 查看维度：(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>) → <span class="hljs-number">2</span>行<span class="hljs-number">3</span>列<span class="hljs-number">2</span>层
</code></pre>
<h3 data-id="heading-4">维度转换小技巧（新手常用）</h3>
<p>用<code>numpy.reshape</code>可快速转换数据维度（一维↔二维↔多维）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 一维数组转二维（3行2列）</span>
arr1d = np.array([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>])
arr2d = arr1d.reshape(<span class="hljs-number">3</span>, <span class="hljs-number">2</span>)
<span class="hljs-built_in">print</span>(arr2d)
<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># [[1 2]</span>
<span class="hljs-comment">#  [3 4]</span>
<span class="hljs-comment">#  [5 6]]</span>
</code></pre>
<hr/>
<h2 data-id="heading-5">二、数据格式化：让数据 “规范又好看”</h2>
<p>数据格式化是将数据按指定规则展示（如字符串拼接）或存储（如 JSON/CSV），核心分两类：<strong>字符串格式化</strong>（输出展示）、<strong>数据结构格式化</strong>（存储 / 传输）。</p>
<h3 data-id="heading-6">1. 字符串格式化（最常用）</h3>
<p>目的：将变量 / 数据嵌入字符串，规范输出格式，Python 有 3 种主流方式（推荐优先用 f-string）。</p>

























<table><thead><tr><th>方式</th><th>语法示例</th><th>特点</th></tr></thead><tbody><tr><td>% 格式化（老式）</td><td><code>"姓名：%s，成绩：%.1f" % (name, score)</code></td><td>兼容性好，语法稍繁琐</td></tr><tr><td>str.format()</td><td><code>"姓名：{}，成绩：{:.1f}".format(name, score)</code></td><td>通用，支持参数定位</td></tr><tr><td>f-string（Python3.6+）</td><td><code>f"姓名：{name}，成绩：{score:.1f}"</code></td><td>最简洁、高效，新手首选</td></tr></tbody></table>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 实战示例：三种方式对比</span>
name = <span class="hljs-string">"张三"</span>
score = <span class="hljs-number">90.5</span>

<span class="hljs-comment"># 1. %格式化</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"姓名：%s，成绩：%.1f"</span> % (name, score))  <span class="hljs-comment"># 输出：姓名：张三，成绩：90.5</span>

<span class="hljs-comment"># 2. str.format()</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"姓名：{}，成绩：{:.1f}"</span>.<span class="hljs-built_in">format</span>(name, score))  <span class="hljs-comment"># 输出同上</span>

<span class="hljs-comment"># 3. f-string（推荐）</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"姓名：<span class="hljs-subst">{name}</span>，成绩：<span class="hljs-subst">{score:<span class="hljs-number">.1</span>f}</span>"</span>)  <span class="hljs-comment"># 输出同上</span>
</code></pre>
<h3 data-id="heading-7">2. 数据结构格式化（存储 / 传输）</h3>
<p>将 Python 原生数据（列表 / 字典）转换为 JSON、CSV 等通用格式，方便存储到文件或传输给接口。</p>
<h4 data-id="heading-8">示例 1：字典转 JSON（接口数据常用）</h4>
<p>JSON 是跨语言的通用数据格式，需导入<code>json</code>模块：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> json

<span class="hljs-comment"># 原始Python字典</span>
student = {
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"张三"</span>,
    <span class="hljs-string">"age"</span>: <span class="hljs-number">18</span>,
    <span class="hljs-string">"scores"</span>: {<span class="hljs-string">"chinese"</span>: <span class="hljs-number">90</span>, <span class="hljs-string">"math"</span>: <span class="hljs-number">88</span>}
}

<span class="hljs-comment"># 字典转JSON字符串（ensure_ascii=False显示中文，indent=2格式化缩进）</span>
json_str = json.dumps(student, ensure_ascii=<span class="hljs-literal">False</span>, indent=<span class="hljs-number">2</span>)
<span class="hljs-built_in">print</span>(json_str)
<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># {</span>
<span class="hljs-comment">#   "name": "张三",</span>
<span class="hljs-comment">#   "age": 18,</span>
<span class="hljs-comment">#   "scores": {</span>
<span class="hljs-comment">#     "chinese": 90,</span>
<span class="hljs-comment">#     "math": 88</span>
<span class="hljs-comment">#   }</span>
<span class="hljs-comment"># }</span>

<span class="hljs-comment"># JSON字符串转回字典</span>
student_dict = json.loads(json_str)
<span class="hljs-built_in">print</span>(student_dict[<span class="hljs-string">"scores"</span>][<span class="hljs-string">"math"</span>])  <span class="hljs-comment"># 输出：88</span>
</code></pre>
<h4 data-id="heading-9">示例 2：二维列表转 CSV（Excel 兼容）</h4>
<p>CSV 是表格型数据的轻量格式，需导入<code>csv</code>模块：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> csv

<span class="hljs-comment"># 二维数据（表头+内容）</span>
data = [
    [<span class="hljs-string">"姓名"</span>, <span class="hljs-string">"语文"</span>, <span class="hljs-string">"数学"</span>],
    [<span class="hljs-string">"张三"</span>, <span class="hljs-number">90</span>, <span class="hljs-number">88</span>],
    [<span class="hljs-string">"李四"</span>, <span class="hljs-number">85</span>, <span class="hljs-number">92</span>]
]

<span class="hljs-comment"># 写入CSV文件（newline=""避免空行，encoding="utf-8"支持中文）</span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"student_scores.csv"</span>, <span class="hljs-string">"w"</span>, encoding=<span class="hljs-string">"utf-8"</span>, newline=<span class="hljs-string">""</span>) <span class="hljs-keyword">as</span> f:
    writer = csv.writer(f)
    writer.writerows(data)  <span class="hljs-comment"># 批量写入所有行</span>

<span class="hljs-comment"># 读取CSV文件</span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"student_scores.csv"</span>, <span class="hljs-string">"r"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
    reader = csv.reader(f)
    <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> reader:
        <span class="hljs-built_in">print</span>(row)  <span class="hljs-comment"># 输出每行数据（列表形式）</span>
<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># ['姓名', '语文', '数学']</span>
<span class="hljs-comment"># ['张三', '90', '88']</span>
<span class="hljs-comment"># ['李四', '85', '92']</span>
</code></pre>
<hr/>
<h3 data-id="heading-10">总结</h3>
<ol>
<li><strong>数据维度</strong>：一维（单索引，如列表）、二维（行 + 列索引，如嵌套列表）、多维（多索引，如 numpy 数组）是核心形态，维度转换可借助<code>numpy.reshape</code>；</li>
<li><strong>字符串格式化</strong>：优先使用<code>f-string</code>，简洁高效，<code>%.1f</code>等格式符可控制数值精度；</li>
<li><strong>数据结构格式化</strong>：JSON 适合接口传输，CSV 适合表格存储，转换时需注意编码（如<code>utf-8</code>）和格式参数（如<code>indent</code>）。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从硬编码到规则引擎：AI Agent 工程化的降本增效之路]]></title>    <link>https://juejin.cn/post/7585897699602710554</link>    <guid>https://juejin.cn/post/7585897699602710554</guid>    <pubDate>2025-12-22T01:55:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585897699602710554" data-draft-id="7585866811716747291" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从硬编码到规则引擎：AI Agent 工程化的降本增效之路"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-12-22T01:55:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="自由生长2024"/> <meta itemprop="url" content="https://juejin.cn/user/1591748569862670"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从硬编码到规则引擎：AI Agent 工程化的降本增效之路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1591748569862670/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    自由生长2024
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T01:55:13.000Z" title="Mon Dec 22 2025 01:55:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>摘要：AI Agent 工程化的关键在于“该省则省”：高频确定性任务用硬编码或规则引擎处理，复杂开放问题才调用大模型，通过混合架构实现低成本、高可靠、低延迟的生产级智能系统。</p>
<hr/>
<h2 data-id="heading-0">从硬编码到规则引擎：AI Agent 工程化的降本增效之路</h2>
<blockquote>
<p><strong>核心观点：智能不等于全用大模型。真正的生产级 AI 系统，是“能省则省、该智则智”的混合架构。</strong></p>
</blockquote>
<h3 data-id="heading-1">引言：别让 LLM 干所有活</h3>
<p>当我们兴奋地构建 AI Agent 时，很容易陷入一个误区：<strong>把所有逻辑都交给大语言模型（LLM）处理</strong>。<br/>
但现实很骨感：LLM 调用贵、延迟高、行为不可控。如果用户每天问一万次“我的订单到哪了？”，每次都让 GPT-4o 思考一遍，成本和体验都会崩盘。</p>
<p>于是，聪明的工程师开始思考：<strong>能不能把高频、确定性强的路径固化下来？</strong></p>
<p>答案是肯定的——这条路，从<strong>硬编码</strong>起步，走向<strong>规则引擎</strong>，最终形成<strong>AI + 规则的混合智能架构</strong>。</p>
<hr/>
<h3 data-id="heading-2">第一阶段：硬编码 —— 最朴素的优化</h3>
<p>对于<strong>模式固定、逻辑明确</strong>的请求，直接写死处理流程是最高效的方式。</p>
<pre><code class="hljs language-erlang" lang="erlang"><span class="hljs-keyword">if</span> <span class="hljs-string">"订单"</span> in <span class="hljs-keyword">query</span> <span class="hljs-keyword">and</span> (<span class="hljs-string">"在哪"</span> in <span class="hljs-keyword">query</span> or <span class="hljs-string">"物流"</span> in <span class="hljs-keyword">query</span>):
    order_id = extract_order_id(<span class="hljs-keyword">query</span>)
    status = logistics_api.get_status(order_id)
    return f<span class="hljs-string">"您的订单当前状态：{status}"</span>
</code></pre>
<p>✅ 优势：</p>
<ul>
<li>零 LLM 调用，成本趋近于 0</li>
<li>响应毫秒级，用户体验好</li>
<li>行为完全可控，无幻觉风险</li>
</ul>
<p>❌ 局限：</p>
<ul>
<li>规则散落在代码中，难以维护</li>
<li>每次新增场景都要改代码、测、上线</li>
</ul>
<blockquote>
<p><strong>硬编码是起点，但不是终点。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-3">第二阶段：规则引擎 —— 把“if-else”解放出来</h3>
<p>规则引擎的核心思想是：<strong>将业务逻辑从代码中剥离，变成可配置、可热更新的策略</strong>。</p>
<h4 data-id="heading-4">什么是规则引擎？</h4>
<p>它是一个专门执行“如果……那么……”规则的运行时系统。例如：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"condition"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"intent == 'order_status'"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"call_logistics_api_and_format_response"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>运营人员只需修改规则配置，无需程序员介入。</p>
<h4 data-id="heading-5">在 AI Agent 中的价值</h4>





















<table><thead><tr><th>场景</th><th>处理方式</th></tr></thead><tbody><tr><td>“退货流程是什么？”</td><td>规则引擎 → 返回预设 FAQ</td></tr><tr><td>“我买的 A 能和 B 一起用吗？”</td><td>LLM + RAG → 分析产品文档</td></tr><tr><td>“帮我订明天去上海的机票”</td><td>Agent 规划 → 调用航班 API</td></tr></tbody></table>
<blockquote>
<p><strong>规则引擎处理“已知问题”，LLM 处理“未知问题”。</strong></p>
</blockquote>
<h4 data-id="heading-6">自动驾驶中的启示</h4>
<p>自动驾驶系统早已采用类似思路：</p>
<ul>
<li>深度学习负责“感知世界”（识别车辆、行人）</li>
<li>规则引擎负责“遵守交规”（红灯停、斑马线让行）</li>
</ul>
<p>即使 AI 认为“可以安全通过”，规则仍强制制动——<strong>这是安全底线</strong>。</p>
<p>AI Agent 同理：<strong>规则是成本与安全的守门人</strong>。</p>
<hr/>
<h3 data-id="heading-7">第三阶段：混合架构 —— 智能系统的成熟形态</h3>
<p>现代生产级 AI 系统普遍采用三层路由架构：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87b8afe65a9a492f9dd4201132878f56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Ieq55Sx55Sf6ZW_MjAyNA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766973312&amp;x-signature=zyxLbg5ba09MX%2FWhsUgLLk3hZWQ%3D" alt="tongyi-mermaid-2025-12-22-094845.png" loading="lazy"/></p>

<h4 data-id="heading-8">关键组件</h4>
<ol>
<li><strong>语义缓存</strong>：用向量数据库缓存相似问题的答案，避免重复计算</li>
<li><strong>意图分类器</strong>：轻量模型或关键词匹配，决定走哪条路径</li>
<li><strong>规则引擎</strong>：处理标准化业务流程</li>
<li><strong>通用 Agent</strong>：仅用于真正需要泛化能力的场景</li>
</ol>
<h4 data-id="heading-9">效果数据（行业实践）</h4>
<ul>
<li><strong>70%+ 请求</strong>由规则或缓存处理，<strong>不调用 LLM</strong></li>
<li><strong>整体成本下降 50%~90%</strong></li>
<li><strong>P99 延迟从 2s 降至 200ms 以内</strong></li>
</ul>
<hr/>
<h3 data-id="heading-10">结语：智能的本质是“恰到好处”</h3>
<blockquote>
<p><strong>不要为了用 AI 而用 AI。</strong><br/>
真正的工程智慧，在于知道<strong>什么时候不用大模型</strong>。</p>
</blockquote>
<p>从硬编码到规则引擎，再到混合智能架构，我们走的是一条<strong>从实验到生产、从炫技到务实</strong>的进化之路。<br/>
未来的 AI Agent，不是“全知全能”的神，而是<strong>懂得分工协作、精打细算的高效工作者</strong>。</p>
<hr/>
<p><strong>作者建议</strong>：<br/>
如果你正在开发 AI Agent，不妨先问自己：</p>
<blockquote>
<p>“这个问题，有没有可能用 10 行 if-else 解决？”<br/>
如果有，那就别急着调 LLM——先省下那一分钱，再谈智能。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[重写 equals 但未重写 hashCode：HashMap 存储数据丢失]]></title>    <link>https://juejin.cn/post/7585789195869126692</link>    <guid>https://juejin.cn/post/7585789195869126692</guid>    <pubDate>2025-12-22T00:52:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585789195869126692" data-draft-id="7584203412197670938" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="重写 equals 但未重写 hashCode：HashMap 存储数据丢失"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-22T00:52:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="uup"/> <meta itemprop="url" content="https://juejin.cn/user/4378706456356627"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            重写 equals 但未重写 hashCode：HashMap 存储数据丢失
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4378706456356627/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    uup
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T00:52:53.000Z" title="Mon Dec 22 2025 00:52:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、Bug 场景</h2>
<p>在一个基于 Java 的应用程序中，自定义了一个类并将其对象存储在 <code>HashMap</code> 中。为了确保对象在 <code>HashMap</code> 中的正确比较，开发人员重写了 <code>equals</code> 方法，但却忘记重写 <code>hashCode</code> 方法。结果在程序运行过程中，发现存储在 <code>HashMap</code> 中的某些对象丢失了，导致相关业务逻辑出现错误。</p>
<h2 data-id="heading-1">二、代码示例</h2>
<h3 data-id="heading-2">自定义类（有缺陷）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span> {
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.age = age;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">equals</span><span class="hljs-params">(Object o)</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span> == o) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">if</span> (o == <span class="hljs-literal">null</span> || getClass() != o.getClass()) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> (Person) o;
        <span class="hljs-keyword">return</span> age == person.age &amp;&amp; name.equals(person.name);
    }

    <span class="hljs-comment">// 未重写hashCode方法</span>
}
</code></pre>
<h3 data-id="heading-3">测试代码</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HashMapDataLossBugExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Map&lt;Person, String&gt; personMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        <span class="hljs-type">Person</span> <span class="hljs-variable">person1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"Alice"</span>, <span class="hljs-number">30</span>);
        <span class="hljs-type">Person</span> <span class="hljs-variable">person2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"Alice"</span>, <span class="hljs-number">30</span>);

        personMap.put(person1, <span class="hljs-string">"Person 1 Details"</span>);
        personMap.put(person2, <span class="hljs-string">"Person 2 Details"</span>);

        System.out.println(<span class="hljs-string">"Map size: "</span> + personMap.size());
        System.out.println(<span class="hljs-string">"Expected value for person2: Person 2 Details, Actual: "</span> + personMap.get(person2));
    }
}
</code></pre>
<h2 data-id="heading-4">三、问题描述</h2>
<ol>
<li><strong>预期行为</strong>：<code>person1</code> 和 <code>person2</code> 是内容相同的两个 <code>Person</code> 对象，按照 <code>equals</code> 方法的定义，它们应该被视为相等。在 <code>HashMap</code> 中，应该只存储一份相同内容的对象，并能通过任意一个对象获取到对应的详细信息。因此，<code>personMap.size()</code> 应该返回 <code>1</code>，且通过 <code>person2</code> 获取到的值应该是 <code>"Person 2 Details"</code>。</li>
<li><strong>实际行为</strong>：<code>personMap.size()</code> 返回 <code>2</code>，并且通过 <code>person2</code> 获取到的值为 <code>null</code>。这是因为在 Java 中，<code>HashMap</code> 使用 <code>hashCode</code> 方法来确定对象在哈希表中的存储位置。如果两个对象通过 <code>equals</code> 方法比较相等，但它们的 <code>hashCode</code> 方法返回不同的值，<code>HashMap</code> 会将它们存储在不同的位置，从而导致逻辑上相同的对象被当作不同的对象处理。由于没有重写 <code>hashCode</code> 方法，<code>person1</code> 和 <code>person2</code> 的 <code>hashCode</code> 值不同（默认的 <code>hashCode</code> 方法基于对象的内存地址），尽管它们通过 <code>equals</code> 方法比较是相等的。</li>
</ol>
<h2 data-id="heading-5">四、解决方案</h2>
<ol>
<li><strong>重写 <code>hashCode</code> 方法</strong>：根据 <code>equals</code> 方法中用于比较的字段，合理地重写 <code>hashCode</code> 方法，确保相等的对象具有相同的哈希码。</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span> {
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.age = age;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">equals</span><span class="hljs-params">(Object o)</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span> == o) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">if</span> (o == <span class="hljs-literal">null</span> || getClass() != o.getClass()) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> (Person) o;
        <span class="hljs-keyword">return</span> age == person.age &amp;&amp; name.equals(person.name);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> name.hashCode();
        result = <span class="hljs-number">31</span> * result + age;
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<ol start="2">
<li><strong>使用 <code>Objects.hash</code></strong> ：<code>java.util.Objects</code> 类提供了 <code>hash</code> 方法，可以方便地生成哈希码，简化 <code>hashCode</code> 方法的编写。</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.Objects;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span> {
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.age = age;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">equals</span><span class="hljs-params">(Object o)</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span> == o) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">if</span> (o == <span class="hljs-literal">null</span> || getClass() != o.getClass()) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> (Person) o;
        <span class="hljs-keyword">return</span> age == person.age &amp;&amp; name.equals(person.name);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Objects.hash(name, age);
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Dubbo | 1分钟通过JUnit调用本地Dubbo接口完成测试]]></title>    <link>https://juejin.cn/post/7585798113547550770</link>    <guid>https://juejin.cn/post/7585798113547550770</guid>    <pubDate>2025-12-22T01:38:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585798113547550770" data-draft-id="7585789195869257764" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Dubbo | 1分钟通过JUnit调用本地Dubbo接口完成测试"/> <meta itemprop="keywords" content="后端,Java,Dubbo"/> <meta itemprop="datePublished" content="2025-12-22T01:38:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mars酱"/> <meta itemprop="url" content="https://juejin.cn/user/1714893869821278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Dubbo | 1分钟通过JUnit调用本地Dubbo接口完成测试
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1714893869821278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mars酱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T01:38:02.000Z" title="Mon Dec 22 2025 01:38:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>作者：Mars酱</p>
<p>声明：本文章由Mars酱编写，部分内容来源于网络，如有疑问请联系本人。</p>
<p>转载：欢迎转载，转载前先请联系我！</p>
</blockquote>
<h2 data-id="heading-0">Dubbo的架构</h2>
<p>先啰嗦下Dubbo的架构吧，如下图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30cec8537a0a487f9835683bb4efa48e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFyc-mFsQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766972312&amp;x-signature=bQjBuZ1MRWiBxVg0G%2FgXP3GHQYA%3D" alt="" loading="lazy"/></p>
<p>我们看到的Dubbo的架构是包含：注册中心、消费者、提供者、监控中心四个角色的，每个角色之间简单来讲就是各种订阅、通知、注册，总的来说就是你调用我，我调用你。（别的细节就不啰嗦了）</p>
<h2 data-id="heading-1">Dubbo的注册方式</h2>
<p>简单介绍了Dubbo的设计架构，那么作为微服务的强者之一，它的注册方式是这样的，如下图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79c96eb6418943268652771f7faa61dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFyc-mFsQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766972312&amp;x-signature=7wm0D141tqds9aemcwpq0Bu5k4M%3D" alt="" loading="lazy"/></p>
<p>一般我们使用的注册中心有zookeepr、nacos、eureka等等，而注册中心的作用就是为了均衡各个服务提供者和调用者，让服务器和应用达到最大性能和响应速度。</p>
<p>通常情况下，我们会在本地编写好业务逻辑代码，然后发布到服务器上，再根据输出的日志和各种异常错误来完成业务逻辑接口的自测，修复好错误之后，再重新发布到服务器上，再观察输入日志和异常，再修复，再发布，这样轮询，直到接口的输入和输出满足需求为止，那么问题来了！这个效率很低！！</p>
<p>反复修复、发布、再修复、再发布，中途你可能需要合并到测试分支、解决分支中的冲突、服务器可能别的业务逻辑在测试等等，我们是不是可以在本地完成专业的流程呢？可以的</p>
<h2 data-id="heading-2">常见的单元测试</h2>
<p>OK，通常情况下，我们的dubbo接口可能是这样</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BusiDubbo</span> {
    List <span class="hljs-title function_">listBusi</span><span class="hljs-params">(BusiDubboDto bdd)</span>
}
</code></pre>
<p>然后，我们dubbo接口的实现一般是这样（盲写的伪代码，不对，千万别抄）</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@DubboService</span>
<span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BusiDubboImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BusiDubbo</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BusiService1 busiService1;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BusiService2 busiService2;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BusiService3 busiService3;
    

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List <span class="hljs-title function_">listBusi</span><span class="hljs-params">(BusiDubboDto bdd)</span>{
        <span class="hljs-type">List</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();
        <span class="hljs-comment">// 业务处理1, 比如：result的获取</span>
        result = busiService1.list();

        <span class="hljs-comment">// 业务处理2，比如：过滤出xxx的业务数据</span>
        result.filter(source -&gt; {<span class="hljs-comment">/** xxxxx */</span>})

        <span class="hljs-comment">// 业务处理3， 比如：对比前一期数据，找到x不对的</span>
        busiService2.list2().filter(source -&gt; {
            <span class="hljs-keyword">return</span> (result.notContains(source.getX());
        })
        
        <span class="hljs-comment">// ...</span>
        busiService3.save(result);

        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<p>好了，dubbo接口中实现的逻辑拖沓冗长，为了验证逻辑的正确性，我们会根据软件的单一原则，会把这个实现中的每个步骤的逻辑测试一遍，比如我们会这样</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Junit</span>
<span class="hljs-comment">// ... 省略很多注解</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">BusiService1JunitTest</span> {

    <span class="hljs-meta">@Autowire</span>
    <span class="hljs-keyword">private</span> BusiService1 busiService1;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testList</span><span class="hljs-params">()</span>{
        <span class="hljs-comment">// 单独测试业务逻辑1的部分</span>
        <span class="hljs-type">List</span> <span class="hljs-variable">re</span> <span class="hljs-operator">=</span> busiService1.list();
        assertEquals(<span class="hljs-number">100</span>, re.size());
    }
}
</code></pre>
<p>这是BusiService1的单元测试，下面是BusiService2的</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Junit</span>
<span class="hljs-comment">// ... 省略很多注解</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">BusiService2JunitTest</span> {

    <span class="hljs-meta">@Autowire</span>
    <span class="hljs-keyword">private</span> BusiService2 busiService2;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testList</span><span class="hljs-params">()</span>{
        <span class="hljs-comment">// 测试业务逻辑2的部分</span>
        <span class="hljs-type">List</span> <span class="hljs-variable">re2</span> <span class="hljs-operator">=</span> busiService2.list();
        assertEquals(<span class="hljs-number">20</span>, re2.size());
    }
}
</code></pre>
<p>如果有其他的业务逻辑，我们大概率也可能会挨个编写测试，我们虽然保证了每个逻辑的原子性是正确的，但是dubbo实现部分是由各个原子接口组装再重新拼接的，这里的逻辑远比我描述的要复杂得多，那么我们可能在有正规的测试服务器的情况下，编写一个可以测试整体业务逻辑的JUnit测试类，它编写出来应该类似这样</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Junit</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">BusiDubboTest</span> {

    <span class="hljs-meta">@DubboReference</span>
    <span class="hljs-keyword">private</span> BusiDubbo busiDubbo;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testListBusi</span><span class="hljs-params">()</span>{
        <span class="hljs-comment">// 调用dubbo接口，走一遍整理逻辑</span>
        <span class="hljs-type">List</span> <span class="hljs-variable">reList</span> <span class="hljs-operator">=</span> busiDubbo.listBusi();
        assertEquals(<span class="hljs-number">100</span>, reList);
    }
}
</code></pre>
<p>这样编写并没有什么不正确，只是这个单元测试调用的是测试服务器上的dubbo服务接口，如果此时你是需要断点做测试，并跟踪数据的话，你是需要输入很多的log日志，在服务器上跟踪查找输出记录的，那么如果我们本地运行dubbo服务实现，再运行上面这个单元测试呢？是不是可以在本机的dubbo服务实现上打断点，完成单元测测试呢？</p>
<p>是的，可以！</p>
<p>但是取决于注册中心的路由策略，本地服务也会在注册中心注册为一个服务提供者，那么，你开始运行上面那个JUnit单元测试，当发起调用请求时 ，会由注册中心根据设定的路由规则去路由到这个接口的实现，可能会路由到服务器集群的服务，也可能会路由到你本地的接口实现，可能你发起多次调用，一次都不会路由到你的本地，所以，什么时候注册中心才能路由到我本机让我打打断点调试下接口？随注册中心的缘吧</p>
<h2 data-id="heading-3">本地完成dubbo接口单元测试</h2>
<p>为了解决上面那个问题，让接口调用只走本地dubbo实现，我们可以在本地dubbo接口中设置register属性为false，这就标志本地这个dubbo服务不会注册到了注册中心，怎么写呢？下面是例子（xml配置格式一样，改写register属性为false）</p>
<p>provider 提供者：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-comment">// register=fasle 注意这个属性和值</span>
<span class="hljs-meta">@DubboService(register = false)</span>
<span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BusiDubboImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BusiDubbo</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BusiService1 busiService1;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BusiService2 busiService2;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BusiService3 busiService3;
    

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List <span class="hljs-title function_">listBusi</span><span class="hljs-params">(BusiDubboDto bdd)</span>{
        <span class="hljs-type">List</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();
        <span class="hljs-comment">// 业务处理1, 比如：result的获取</span>
        result = busiService1.list();

        <span class="hljs-comment">// 业务处理2，比如：过滤出xxx的业务数据</span>
        result.filter(source -&gt; {<span class="hljs-comment">/** xxxxx */</span>})

        <span class="hljs-comment">// 业务处理3， 比如：对比前一期数据，找到x不对的</span>
        busiService2.list2().filter(source -&gt; {
            <span class="hljs-keyword">return</span> (result.notContains(source.getX());
        })
        
        <span class="hljs-comment">// ...</span>
        busiService3.save(result);

        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<p>既然不会注册到注册中心，那么消费在消费的时候，注册中心不会有这个接口服务，注册中心更不会根据路由规则找到这个接口，但是我们需要调试，就表示JUnit的单元测试需要调用本地的dubbo服务实现，接口服务就这样写了</p>
<p>consumer 消费者：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Junit</span>
<span class="hljs-comment">// 省略其他注解</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AiInvokingCoreControllerTest</span> {

    <span class="hljs-meta">@DubboReference(protocol = "tri", url = "tri://127.0.0.1:50051")</span>
    <span class="hljs-keyword">private</span> BusiDubbo busiDubbo;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testListBusi</span><span class="hljs-params">()</span>{
        <span class="hljs-type">BusiDubboDto</span> <span class="hljs-variable">bdd</span> <span class="hljs-operator">=</span> BusiDubboDto.builder().p1(<span class="hljs-string">"x1"</span>).p2(<span class="hljs-string">"x2"</span>)....build();
        <span class="hljs-type">List</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> busiDubbo.listBusi();
        assertEquals(<span class="hljs-number">100</span>, result.size());
    }
}
</code></pre>
<p>经常使用dubbo框架的朋友们可能注意到了，在@DubboReference注解中有两个属性，一个是protocal，一个是url。</p>
<p>protocol是协议声明，dubbo支持的协议是dubbo、grpc、rest、triple等</p>
<p>url是dubbo实现的调用地址，我们是本地运行的dubbo服务，因此根据protocal的协议，url的值应该是：</p>





























<table><thead><tr><th>协议名称</th><th>配置值</th><th>默认端口</th><th>url填写示例</th></tr></thead><tbody><tr><td><strong>triple</strong></td><td>tri</td><td>50051</td><td>tri://127.0.0.1:50051</td></tr><tr><td><strong>dubbo</strong></td><td>dubbo</td><td>20880</td><td>dubbo://127.0.0.1:5001</td></tr><tr><td><strong>rest</strong></td><td>tri 或 rest</td><td>50051</td><td>tri://127.0.0.1:50051rest://127.0.0.1:50051</td></tr></tbody></table>
<p>好了，如果你用的是dubbo协议，怎么写？下面是示例</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Junit</span>
<span class="hljs-comment">// 省略其他注解</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AiInvokingCoreControllerTest</span> {

    
    <span class="hljs-meta">@DubboReference(protocol = "dubbo", url = "dubbo://127.0.0.1:20880")</span>
    <span class="hljs-keyword">private</span> BusiDubbo busiDubbo;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testListBusi</span><span class="hljs-params">()</span>{
        <span class="hljs-type">BusiDubboDto</span> <span class="hljs-variable">bdd</span> <span class="hljs-operator">=</span> BusiDubboDto.builder().p1(<span class="hljs-string">"x1"</span>).p2(<span class="hljs-string">"x2"</span>)....build();
        <span class="hljs-type">List</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> busiDubbo.listBusi();
        assertEquals(<span class="hljs-number">100</span>, result.size());
    }
}
</code></pre>
<h2 data-id="heading-4">极简的结尾</h2>
<p>简单来说，首先，dubbo接口实现中的register改成false，不把接口注册到注册中心；其次，调用方配置好protoal协议值，再根据公式 "协议配置值://127.0.0.1:协议默认端口号" 填充并替换掉 ${...} 部分的内容，即可开展你的本地dubbo服务单元测试了。</p>
<p>好好享受断点的幸福吧~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node-OPCUA 入门(1)-创建一个简单的OPC UA服务器]]></title>    <link>https://juejin.cn/post/7585808181239513139</link>    <guid>https://juejin.cn/post/7585808181239513139</guid>    <pubDate>2025-12-22T01:22:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585808181239513139" data-draft-id="7585897699602333722" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node-OPCUA 入门(1)-创建一个简单的OPC UA服务器"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-12-22T01:22:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="李广山Samuel"/> <meta itemprop="url" content="https://juejin.cn/user/4266544138563288"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node-OPCUA 入门(1)-创建一个简单的OPC UA服务器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4266544138563288/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    李广山Samuel
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T01:22:35.000Z" title="Mon Dec 22 2025 01:22:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0"><strong>1.0 node-opcua简介</strong></h4>
<p>node-opcua是一个完全用Typescript为NodeJS编写的OPC UA栈的实现。不依赖于外部第三方库。它依赖于一些仅在服务器端可用的javascript模块，如fs (FileSystem)或net(Socket)。</p>
<h4 data-id="heading-1"><strong>2.0 创建一个简单的node-opcua 服务器</strong></h4>
<p>在这个示例中，我们创建一个OPC UA服务器，它公开3个读/写变量，服务器将在名为“我的设备”的新对象下公开这些变量。</p>
<pre><code class="hljs language-Plain" lang="Plain">    + 跟文件夹
        + 项目
            + 我的设备
                + 变量1
                + 变量2
</code></pre>
<h5 data-id="heading-2"><strong>2.1 首先创建一个项目:</strong></h5>
<pre><code class="hljs language-bash" lang="bash">$ <span class="hljs-built_in">mkdir</span> myserver
$ <span class="hljs-built_in">cd</span> myserver
$ npm init                      <span class="hljs-comment"># 初始化项目创建一个package.json文件</span>
$ npm install node-opcua --save <span class="hljs-comment"># 添加依赖node-opcua模块</span>
</code></pre>
<h5 data-id="heading-3"><strong>2.2 编辑项目</strong></h5>
<p>在项目目录项创建并编辑一个sample_server.js文件</p>
<p>2.2.1 通过'require'语句导入node-opcua模块:</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { <span class="hljs-title class_">OPCUAServer</span>, <span class="hljs-title class_">Variant</span>, <span class="hljs-title class_">DataType</span>, <span class="hljs-title class_">StatusCodes</span>} = <span class="hljs-built_in">require</span>(<span class="hljs-string">"node-opcua"</span>);
</code></pre>
<p>2.2.2 服务器实例化</p>
<p>创建一个OPCUAServer实例。可以将选项传递给OPCUAServer来定制行为。对于简单的服务器，您只需要指定一个TCP端口。</p>
<pre><code class="hljs language-javascript" lang="javascript"> <span class="hljs-comment">// 创建一个OPCUAServer</span>
    <span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OPCUAServer</span>({
        <span class="hljs-attr">port</span>: <span class="hljs-number">4334</span>, <span class="hljs-comment">// 服务器套接字的监听端口</span>
        <span class="hljs-attr">resourcePath</span>: <span class="hljs-string">"/UA/MyLittleServer"</span>, <span class="hljs-comment">//此路径将添加到端点资源名称中</span>
        <span class="hljs-attr">buildInfo</span>: {
            <span class="hljs-attr">productName</span>: <span class="hljs-string">"我的示例服务器1"</span>,
            <span class="hljs-attr">buildNumber</span>: <span class="hljs-string">"7658"</span>,
            <span class="hljs-attr">buildDate</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-number">2014</span>, <span class="hljs-number">5</span>, <span class="hljs-number">2</span>)
        }
    });
</code></pre>
<p>资源路径将用于构造服务器的端点统一资源标识符(url)。在我们的例子中，服务器的端点urn将是：</p>
<pre><code class="hljs language-javascript" lang="javascript">opc.<span class="hljs-property">tcp</span>:<span class="hljs-comment">//&lt;hostname&gt;:4334/UA/MyLittleServer</span>
</code></pre>
<p>hostname替换为您的计算机名称或完全合格的域名。  客户端必须使用这个URN连接到服务器。</p>
<p>设置服务器信息，可以在这个阶段设置其他信息，例如：</p>
<pre><code class="hljs language-javascript" lang="javascript"> <span class="hljs-attr">buildInfo</span>: {
            <span class="hljs-attr">productName</span>: <span class="hljs-string">"我的示例服务器1"</span>,
            <span class="hljs-attr">buildNumber</span>: <span class="hljs-string">"7658"</span>,
            <span class="hljs-attr">buildDate</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-number">2022</span>, <span class="hljs-number">9</span>, <span class="hljs-number">8</span>)
        }
</code></pre>
<p>2.2.3 服务器初始化</p>
<p>一旦创建，服务器将被初始化。在初始化期间，服务器将加载其默认节点集，并准备所有标准OPC UA变量的绑定。initialize方法是一个异步操作，需要一个“回调”函数，该函数将在初始化过程完成时执行。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">await</span> server.<span class="hljs-title function_">initialize</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"已初始化"</span>);
</code></pre>
<p>2.2.4 初始化后</p>
<p>让我们创建一个函数，它将使用一些我们想要公开的变量来扩展服务器默认地址空间。这个函数将在初始化回调函数中调用。</p>
<p>addressSpace用于定制我们的服务器将向外部世界公开的对象模型。</p>
<pre><code class="hljs language-javascript" lang="javascript">  <span class="hljs-keyword">const</span> addressSpace = server.<span class="hljs-property">engine</span>.<span class="hljs-property">addressSpace</span>;
  <span class="hljs-keyword">const</span> namespace = addressSpace.<span class="hljs-title function_">getOwnNamespace</span>();
</code></pre>
<p>2.2.5 在objects文件夹中添加一个新对象</p>
<pre><code class="hljs language-javascript" lang="javascript">    <span class="hljs-comment">// 声明一个新对象</span>
    <span class="hljs-keyword">const</span> device = namespace.<span class="hljs-title function_">addObject</span>({
        <span class="hljs-attr">organizedBy</span>: addressSpace.<span class="hljs-property">rootFolder</span>.<span class="hljs-property">objects</span>,
        <span class="hljs-attr">browseName</span>: <span class="hljs-string">"我的设备"</span>
    });
</code></pre>
<p>2.2.6 添加一些变量</p>
<p>在服务器名称空间中添加变量1， 模拟“变量1”每500毫秒改变一次。</p>
<pre><code class="hljs language-javascript" lang="javascript">    <span class="hljs-comment">// 将“变量1”添加到新创建的文件夹“我的设备”中</span>

    <span class="hljs-keyword">const</span> variable1 = namespace.<span class="hljs-title function_">addVariable</span>({
        <span class="hljs-attr">componentOf</span>: device,
        <span class="hljs-attr">browseName</span>: <span class="hljs-string">"变量1"</span>,
        <span class="hljs-attr">dataType</span>: <span class="hljs-string">"Double"</span>,
        <span class="hljs-attr">minimumSamplingInterval</span>: <span class="hljs-number">100</span>,
    });
    <span class="hljs-keyword">let</span> counter = <span class="hljs-number">0</span>;
    <span class="hljs-comment">// 模拟“变量1”每500毫秒改变一次</span>
    <span class="hljs-keyword">const</span> timerId = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> { counter += <span class="hljs-number">1</span>; variable1.<span class="hljs-title function_">setValueFromSource</span>({ <span class="hljs-attr">dataType</span>: <span class="hljs-title class_">DataType</span>.<span class="hljs-property">Double</span>, <span class="hljs-attr">value</span>: counter }) }, <span class="hljs-number">500</span>);

    addressSpace.<span class="hljs-title function_">registerShutdownTask</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-built_in">clearInterval</span>(timerId); });
</code></pre>
<p>注意，上面的例子，我们没有为变量指定NodeId。服务器会自动为我们分配一个新的nodeId。</p>
<p>添加变量2，这个示例我们指定节点ID：</p>
<pre><code class="hljs language-javascript" lang="javascript">  <span class="hljs-comment">// 在新创建的文件夹我的设备中添加一个名为“变量2”的变量</span>

    namespace.<span class="hljs-title function_">addVariable</span>({

        <span class="hljs-attr">componentOf</span>: device,
        <span class="hljs-attr">nodeId</span>: <span class="hljs-string">"ns=1;b=1020FFAA"</span>, <span class="hljs-comment">// 命名空间中的节点ID</span>
        <span class="hljs-attr">browseName</span>: <span class="hljs-string">"变量2"</span>,
        <span class="hljs-attr">dataType</span>: <span class="hljs-string">"Double"</span>,
        <span class="hljs-attr">minimumSamplingInterval</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 这个变量受事件驱动</span>
    });
</code></pre>
<p>下面再创建一个变量，来公开运行中的机器上的可用内存百分比。  我们写一个函数来计算这个值。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> os = <span class="hljs-built_in">require</span>(<span class="hljs-string">"os"</span>);
    <span class="hljs-comment">/**
     * 返回运行中的机器上的空闲内存百分比
     * <span class="hljs-doctag">@return</span> {<span class="hljs-type">double</span>}
     */</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">available_memory</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// var value = process.memoryUsage().heapUsed / 1000000;</span>
        <span class="hljs-keyword">const</span> percentageMemUsed = os.<span class="hljs-title function_">freemem</span>() / os.<span class="hljs-title function_">totalmem</span>() * <span class="hljs-number">100.0</span>;
        <span class="hljs-keyword">return</span> percentageMemUsed;
    }
    namespace.<span class="hljs-title function_">addVariable</span>({

        <span class="hljs-attr">componentOf</span>: device,

        <span class="hljs-attr">nodeId</span>: <span class="hljs-string">"s=free_memory"</span>, <span class="hljs-comment">// 一个字符串节点ID</span>
        <span class="hljs-attr">browseName</span>: <span class="hljs-string">"空闲内存"</span>,
        <span class="hljs-attr">dataType</span>: <span class="hljs-string">"Double"</span>,
        <span class="hljs-attr">minimumSamplingInterval</span>: <span class="hljs-number">1234</span>,
        <span class="hljs-attr">value</span>: {
            <span class="hljs-attr">get</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Variant</span>({ <span class="hljs-attr">dataType</span>: <span class="hljs-title class_">DataType</span>.<span class="hljs-property">Double</span>, <span class="hljs-attr">value</span>: <span class="hljs-title function_">available_memory</span>() })
        }
    });
</code></pre>
<p>2.2.7 启动服务器
创建并初始化服务器之后，我们使用start异步方法让服务器初始化它的所有端点并开始监听客户端。显示端点url</p>
<pre><code class="hljs language-javascript" lang="javascript">  <span class="hljs-keyword">await</span> server.<span class="hljs-title function_">start</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"服务器正在监听 ... ( 按 CTRL+C 停止)"</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"端口 "</span>, server.<span class="hljs-property">endpoints</span>[<span class="hljs-number">0</span>].<span class="hljs-property">port</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">" 主服务器端点url是 "</span>, server.<span class="hljs-title function_">getEndpointUrl</span>());
</code></pre>
<p>2.2.8 下面，是完整sample_server.js文件</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> os = <span class="hljs-built_in">require</span>(<span class="hljs-string">"os"</span>);
<span class="hljs-keyword">const</span> { <span class="hljs-title class_">OPCUAServer</span>, <span class="hljs-title class_">Variant</span>, <span class="hljs-title class_">DataType</span>, <span class="hljs-title class_">StatusCodes</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"node-opcua"</span>);


(<span class="hljs-keyword">async</span> () =&gt; {

    <span class="hljs-comment">// 创建一个OPCUAServer</span>
    <span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OPCUAServer</span>({
        <span class="hljs-attr">port</span>: <span class="hljs-number">4334</span>, <span class="hljs-comment">// 服务器套接字的监听端口</span>
        <span class="hljs-attr">resourcePath</span>: <span class="hljs-string">"/UA/MyLittleServer"</span>, <span class="hljs-comment">//此路径将添加到端点资源名称中</span>
        <span class="hljs-attr">buildInfo</span>: {
            <span class="hljs-attr">productName</span>: <span class="hljs-string">"我的示例服务器1"</span>,
            <span class="hljs-attr">buildNumber</span>: <span class="hljs-string">"7658"</span>,
            <span class="hljs-attr">buildDate</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-number">2022</span>, <span class="hljs-number">9</span>, <span class="hljs-number">8</span>)
        }
    });
    <span class="hljs-keyword">await</span> server.<span class="hljs-title function_">initialize</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"已初始化"</span>);

    <span class="hljs-keyword">const</span> addressSpace = server.<span class="hljs-property">engine</span>.<span class="hljs-property">addressSpace</span>;
    <span class="hljs-keyword">const</span> namespace = addressSpace.<span class="hljs-title function_">getOwnNamespace</span>();

    <span class="hljs-comment">// 声明一个新对象</span>
    <span class="hljs-keyword">const</span> device = namespace.<span class="hljs-title function_">addObject</span>({
        <span class="hljs-attr">organizedBy</span>: addressSpace.<span class="hljs-property">rootFolder</span>.<span class="hljs-property">objects</span>,
        <span class="hljs-attr">browseName</span>: <span class="hljs-string">"我的设备"</span>
    });

    <span class="hljs-comment">// 添加一些变量</span>
    <span class="hljs-comment">// 将“变量1”添加到新创建的文件夹“我的设备”中</span>

    <span class="hljs-keyword">const</span> variable1 = namespace.<span class="hljs-title function_">addVariable</span>({
        <span class="hljs-attr">componentOf</span>: device,
        <span class="hljs-attr">browseName</span>: <span class="hljs-string">"变量1"</span>,
        <span class="hljs-attr">dataType</span>: <span class="hljs-string">"Double"</span>,
        <span class="hljs-attr">minimumSamplingInterval</span>: <span class="hljs-number">100</span>,
    });

    <span class="hljs-keyword">let</span> counter = <span class="hljs-number">0</span>;
    <span class="hljs-comment">// 模拟“变量1”每500毫秒改变一次</span>
    <span class="hljs-keyword">const</span> timerId = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> { counter += <span class="hljs-number">1</span>; variable1.<span class="hljs-title function_">setValueFromSource</span>({ <span class="hljs-attr">dataType</span>: <span class="hljs-title class_">DataType</span>.<span class="hljs-property">Double</span>, <span class="hljs-attr">value</span>: counter }) }, <span class="hljs-number">500</span>);

    addressSpace.<span class="hljs-title function_">registerShutdownTask</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-built_in">clearInterval</span>(timerId); });

    <span class="hljs-comment">// 在新创建的文件夹我的设备中添加一个名为“变量2”的变量</span>

    namespace.<span class="hljs-title function_">addVariable</span>({

        <span class="hljs-attr">componentOf</span>: device,
        <span class="hljs-attr">nodeId</span>: <span class="hljs-string">"ns=1;b=1020FFAA"</span>, <span class="hljs-comment">// 命名空间中的节点ID</span>
        <span class="hljs-attr">browseName</span>: <span class="hljs-string">"变量2"</span>,
        <span class="hljs-attr">dataType</span>: <span class="hljs-string">"Double"</span>,
        <span class="hljs-attr">minimumSamplingInterval</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 这个变量受事件驱动</span>
    });

    <span class="hljs-comment">/**
     * 返回运行中的机器上的空闲内存百分比
     * <span class="hljs-doctag">@return</span> {<span class="hljs-type">double</span>}
     */</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">available_memory</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// var value = process.memoryUsage().heapUsed / 1000000;</span>
        <span class="hljs-keyword">const</span> percentageMemUsed = os.<span class="hljs-title function_">freemem</span>() / os.<span class="hljs-title function_">totalmem</span>() * <span class="hljs-number">100.0</span>;
        <span class="hljs-keyword">return</span> percentageMemUsed;
    }
    namespace.<span class="hljs-title function_">addVariable</span>({

        <span class="hljs-attr">componentOf</span>: device,

        <span class="hljs-attr">nodeId</span>: <span class="hljs-string">"s=free_memory"</span>, <span class="hljs-comment">// 一个字符串节点ID</span>
        <span class="hljs-attr">browseName</span>: <span class="hljs-string">"空闲内存"</span>,
        <span class="hljs-attr">dataType</span>: <span class="hljs-string">"Double"</span>,
        <span class="hljs-attr">minimumSamplingInterval</span>: <span class="hljs-number">1234</span>,
        <span class="hljs-attr">value</span>: {
            <span class="hljs-attr">get</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Variant</span>({ <span class="hljs-attr">dataType</span>: <span class="hljs-title class_">DataType</span>.<span class="hljs-property">Double</span>, <span class="hljs-attr">value</span>: <span class="hljs-title function_">available_memory</span>() })
        }
    });

    <span class="hljs-keyword">await</span> server.<span class="hljs-title function_">start</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"服务器正在监听 ... ( 按 CTRL+C 停止)"</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"端口 "</span>, server.<span class="hljs-property">endpoints</span>[<span class="hljs-number">0</span>].<span class="hljs-property">port</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">" 主服务器端点url是 "</span>, server.<span class="hljs-title function_">getEndpointUrl</span>());

    process.<span class="hljs-title function_">once</span>(<span class="hljs-string">"SIGINT"</span>, <span class="hljs-keyword">async</span> () =&gt; {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"正在关闭"</span>);
        <span class="hljs-keyword">await</span> server.<span class="hljs-title function_">shutdown</span>();
    });

})();
</code></pre>
<p>2.2.9 执行并测试服务器</p>
<pre><code class="hljs language-javascript" lang="javascript">$ node sample_server.<span class="hljs-property">js</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d0d47581a7c4e0989592a9503581d71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5bm_5bGxU2FtdWVs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766971355&amp;x-signature=tYgYp1IrGCuH15zsgdgmP%2BDe4uY%3D" alt="NVUZtZaPGYnk9DWhk40JGBQJNsUQVvLTP__fcJMkpMo.png" loading="lazy"/></p>
<p>3.0 使用UaExpert测试服务</p>
<p>3.1 打开UaExpert，右键选择“Project|Server”在上下文菜单点击”Add...“添加</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e21c8633760d420989bbb47711831a97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5bm_5bGxU2FtdWVs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766971355&amp;x-signature=kD6v3H8582kjNS4WKPJs2RS3RDk%3D" alt="ctMnaDZEwwchS0JwVCWzYhpTisVjM2bgQp6krTsAADE.png" loading="lazy"/></p>
<p>3.2 打开添加服务器窗口，添加服务器</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ed8155d049a46aab7068b8ed0da8c7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5bm_5bGxU2FtdWVs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766971355&amp;x-signature=%2FP3oc5vMmi70IA2xbdbDuxcfqzE%3D" alt="vXHrvjLXhEtJ0lHQ7IGn9ReE-clOAlwviwiSc2dJFlo.png" loading="lazy"/></p>
<p>3.3 添加服务器URL地址，本例中为opc.tcp://DESKTOP-MGFMSQP:4334/UA/MyLittleServer
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/049e2c742e654db391cc37eb0db27086~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5bm_5bGxU2FtdWVs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766971355&amp;x-signature=ryA5x%2Fozb7%2FaE1FrOZekX0q14qY%3D" alt="QzZyLelutfKOqvPBTjsxaUMhFBTIjjEdyjZaTBgB_KE.png" loading="lazy"/>
3.4 服务器被找到，选择加密方式，确认添加
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e03770ee7e4e46c2824ee21cb25aa629~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5bm_5bGxU2FtdWVs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766971355&amp;x-signature=Sdgch22OBSqMwWvctmI0CBZy30k%3D" alt="nh6lsCkudkazjJwVZev3wZZBoHo-TQJQZ2gkgb1aOHk.png" loading="lazy"/>
3.5 在Servers文件夹下，选择新添加的服务器NodeOPCUA，右键上下文菜单点击Connect连接服务器。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f22f8b62e21a41a2905d422b7a54a9c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5bm_5bGxU2FtdWVs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766971355&amp;x-signature=LNgh6xz0Opiohh6XAfDeoV3lIFI%3D" alt="c5yByz8iSWUWRze6PU5pCAzCnDbLhMXcTv6HIb5Qo60.png" loading="lazy"/>
3.6 在下面的Adddress Space(地址空间)，列出了我的设备和变量
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f6ca40cb6f04c239701b830649ac1fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5bm_5bGxU2FtdWVs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766971355&amp;x-signature=Ad3jTH2QdhRzo9UQs49xG1gtNE4%3D" alt="FJJ_whd0L1rCkY7l-5LNeLvwZAYb1hSvo5veKd88fPc.png" loading="lazy"/>
3.7 把变量拖入Data Access View(数据访问视图)，可以看到变量值的变化。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/987a16d20d1c4a5f8dda0cc7136b10a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5bm_5bGxU2FtdWVs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766971355&amp;x-signature=BcrvCESFzQ2Av3cXrUKCVGqU0Dc%3D" alt="_dk2ixj4L0qGC1Fv7XghkcHY-T4qaev_70bqatJ0I_E.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>