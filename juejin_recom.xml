<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[解密“混合专家模型” (MoE) 的全部魔法]]></title>    <link>https://juejin.cn/post/7571644531608780846</link>    <guid>https://juejin.cn/post/7571644531608780846</guid>    <pubDate>2025-11-12T12:10:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571644531608780846" data-draft-id="7571695634941509659" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解密“混合专家模型” (MoE) 的全部魔法"/> <meta itemprop="keywords" content="人工智能,LLM"/> <meta itemprop="datePublished" content="2025-11-12T12:10:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mwq30123"/> <meta itemprop="url" content="https://juejin.cn/user/3403743729030686"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解密“混合专家模型” (MoE) 的全部魔法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3403743729030686/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mwq30123
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T12:10:03.000Z" title="Wed Nov 12 2025 12:10:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">解密“混合专家模型” (MoE) 的全部魔法</h2>
<p>在当今大语言模型 (LLM) 的竞赛中，您一定听说过 GPT-4、Mixtral 8x7B 这样的“巨无霸”。它们之所以能在保持惊人性能的同时实现高效推理，背后都指向一个共同的架构——<strong>MoE (Mixture of Experts) 混合专家模型</strong>。</p>
<p>MoE 不是一个全新的概念，它的思想最早在 1991 年（Jacobs, Hinton 等）就被提出。但直到这个“大模型”时代，它“稀疏激活”的核心思想才真正得以大放异彩。</p>
<p>这篇博客将汇总我们之前的所有讨论，带您从 MoE 的核心思想出发，一路深入到它最底层的训练“黑魔法”，彻底搞懂它高效运转的全部秘密。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fc03e35368644058284f913d17b083b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbXdxMzAxMjM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554221&amp;x-signature=CCnHdmAPPmRrJcJW1MxhchG90Ec%3D" alt="MoE.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-1">篇章一：MoE 的核心思想——“分而治之”</h3>
<h4 data-id="heading-2">什么是 MoE？一个“专家委员会”的比喻</h4>
<p>要理解 MoE，我们可以先想象一个“专家委员会”：</p>
<ul>
<li>
<p>传统的“密集”模型 (Dense Model)：</p>
<p>就像一个试图精通所有领域的“通才”。当遇到任何问题时，这个“通才”必须调动他全部的知识（模型的全部参数）来思考。当模型变得非常大时，这个过程会极其缓慢且耗费资源。</p>
</li>
<li>
<p>MoE 混合专家模型：</p>
<p>就像一个拥有多名“专科医生”的医院。医院里有心脏科专家、神经科专家、骨科专家等（这就是 Experts）。</p>
<ol>
<li>当一个病人（<strong>输入数据</strong>，例如一个 Token）到来时，会先去“分诊台”（这就是 <strong>Gating Network</strong> 或 <strong>Router</strong>）。</li>
<li>“分诊台”会快速判断：“你这个问题，看起来最需要心脏科和神经科的专家会诊。”</li>
<li>于是，<strong>只有</strong>这两位专家被“激活”（Active）并参与工作。其他专家则继续“休息”，不消耗计算资源。</li>
<li>最后，“分诊台”将两位专家的诊断结果（<strong>输出</strong>）汇总起来，给出一个综合的答案。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-3">MoE 的“魔法”：总参数 vs 激活参数</h4>
<p>MoE 架构（尤其是“稀疏 MoE”）解决了大型模型的一个核心痛点：<strong>如何在不增加计算成本的前提下，极大地扩展模型的知识容量（参数量）</strong> 。</p>
<p>这就引出了两个关键概念：</p>
<ol>
<li>
<p>总参数量 (Total Parameters)：</p>
<p>模型所有专家参数的总和。这代表了模型的“知识库”有多庞大。</p>
<ul>
<li>例如，<strong>Mixtral 8x7B</strong> 拥有 8 个 7B（70亿）参数的专家，总参数量约 47B。</li>
</ul>
</li>
<li>
<p>激活参数量 (Active Parameters)：</p>
<p>处理单个 Token 时，实际参与计算的参数量。这决定了模型的“推理速度”。</p>
<ul>
<li>Mixtral 8x7B 在处理每个 Token 时，只激活 8 个专家中的 2 个 (Top-K=2)。</li>
<li>因此，它实际的计算量大约只和一个 12B-14B 的密集模型相当。</li>
</ul>
</li>
</ol>
<p><strong>结论：</strong> MoE 允许我们拥有一个 47B 量级的“知识库”，但享受的却是 14B 量级的“推理速度”！</p>
<h4 data-id="heading-4">为什么只选 K=2（少数）而不是 K=8（全部）？</h4>
<p>这正是 MoE 的全部意义所在。</p>
<ul>
<li><strong>激活 K=2 (稀疏激活)</strong> ：用 14B 的计算成本，撬动 47B 的知识库。 <strong>（高效）</strong></li>
<li><strong>激活 K=8 (密集激活)</strong> ：用 47B 的计算成本，撬动 47B 的知识库。 <strong>（昂贵）</strong></li>
</ul>
<p>如果你激活了全部 8 个专家，MoE 就退化成了一个普通的、巨大且缓慢的密集模型，完全丧失了其计算优势。</p>
<hr/>
<h3 data-id="heading-5">篇章二：MoE 的架构与实践</h3>
<h4 data-id="heading-6">核心组件（一）：专家 (Experts)</h4>
<p>在 Transformer 架构中，MoE 通常被应用在 FFN（前馈网络）层。这意味着“专家”本身通常就是多个独立的 FFN 网络。</p>
<p>在训练过程中，每个 FFN 专家会逐渐“学会”处理特定类型的数据、模式或概念。比如，一个专家可能擅长处理编程代码，另一个专家可能擅长处理诗歌。</p>
<h4 data-id="heading-7">核心组件（二）：门控网络 (Gating Network)</h4>
<p>这是 MoE 的“大脑”和“调度中心”。它的理论基础是**“可学习的加权平均” (Learnable Weighted Averaging)**。</p>
<p>其工作流程如下：</p>
<ol>
<li><strong>打分 (Logits)</strong> ：门控网络（通常是一个小型的线性层）接收一个 Token，并为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span> 个专家中的每一个都打一个“分数”。</li>
<li><strong>归一化 (Softmax)</strong> ：使用 Softmax 函数将这些分数转换成“权重”或“概率”（总和为 1）。例如 <code>[0.1, 0.05, 0.6, ..., 0.25]</code>。</li>
<li><strong>Top-K 选择</strong>：选择权重最高的 K 个（例如 K=2）专家。</li>
<li><strong>加权输出</strong>：模型只激活这 K 个专家，并将它们的输出，按照 Gating 给出的权重进行“加权平均”，得到最终的输出。</li>
</ol>
<p>Gating 网络和专家是一起训练的。Gating 会学会“如何分配权重”才能让模型的总损失最小。久而久之，它就学会了：“遇到代码，找 3 号和 7 号专家。”</p>
<h4 data-id="heading-8">MoE 与 CNN 多通道的类比</h4>
<p>这是一个非常好的类比，能帮我们深入理解其机制：</p>
<ul>
<li>
<p><strong>相似之处 (专业分工)</strong> ：</p>
<ul>
<li>CNN 的不同通道 (Channel) 提取不同特征（如边缘、颜色）。</li>
<li>MoE 的不同专家 (Expert) 处理不同概念（如代码、法律）。</li>
</ul>
</li>
<li>
<p><strong>根本区别 (密集 vs 稀疏)</strong> ：</p>
<ul>
<li><strong>CNN 是“密集”的</strong>：所有通道都会被<em>同时</em>激活和计算。</li>
<li><strong>MoE 是“稀疏”的</strong>：只有被选中的 Top-K 专家被激活。如果 Gating 认为这个 Token 是代码，它就<em>只</em>去激活“代码专家”。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-9">MoE 模型的生命周期</h4>
<p>MoE 架构贯穿了模型的所有阶段：</p>
<ol>
<li>
<p><strong>预训练 (Pre-training)</strong> ：<strong>MoE 诞生和学习的阶段</strong>。</p>
<ul>
<li>专家在海量数据中“专业化”。</li>
<li>Gating 网络学会如何“路由”。</li>
<li>（关键）模型学会“负载均衡”。</li>
</ul>
</li>
<li>
<p><strong>微调 (Fine-tuning)</strong> ：<strong>MoE 适应和优化的阶段</strong>。</p>
<ul>
<li>在特定任务（如问答）上，Gating 和 Experts 的参数被进一步调整和优化。</li>
</ul>
</li>
<li>
<p><strong>生成/推理 (Inference)</strong> ：<strong>MoE 展现优势的阶段</strong>。</p>
<ul>
<li>Gating 为<em>每一个</em>生成的 Token <strong>实时动态地</strong>选择 Top-K 专家。</li>
<li>这就是我们享受到“稀疏激活”带来高速推理的时刻。</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-10">篇章三：MoE 训练的“黑魔法”——负载均衡 (Load Balancing)</h3>
<p>我们已经知道了 MoE 的美好，但它在训练中有一个致命问题： <strong>“明星专家”问题</strong>。</p>
<p>如果没有约束，Gating 网络可能会很快发现 3 号专家“比较聪明”，于是它“偷懒”地把所有任务都交给 3 号。这会导致：</p>
<ul>
<li><strong>明星专家 (Star Expert)</strong> ：3 号专家“过劳”，见识了所有数据。</li>
<li><strong>摸鱼专家 (Lazy Experts)</strong> ：其他 7 个专家“无所事事”，它们的参数完全得不到训练，被白白浪费。</li>
</ul>
<p>为了解决这个问题，MoE 引入了一个“惩罚”机制，称为<strong>负载均衡 (Load Balancing)</strong> 。</p>
<h4 data-id="heading-11"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>balance</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{balance}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：惩罚明星专家的“辅助损失”</h4>
<p>这个机制的理念非常像“权重衰减 (Weight Decay)”——它通过施加“惩罚”来防止模型过分依赖某几个专家。</p>
<p>在训练时，模型的总损失 (Total Loss) 由两部分组成：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>total</mtext></msub><mo>=</mo><msub><mi>L</mi><mtext>main</mtext></msub><mo>+</mo><mi>α</mi><mo>⋅</mo><msub><mi>L</mi><mtext>balance</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{total}} = L_{\text{main}} + \alpha \cdot L_{\text{balance}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">total</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">main</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.4445em;"/><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>main</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{main}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">main</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：主损失，即“预测是否准确”。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>balance</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{balance}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：<strong>辅助损失（即“惩罚项”）</strong> ，用于衡量“路由是否均衡”。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.0037em;">α</span></span></span></span></span>：一个超参数，用于控制“惩罚”的力度。</li>
</ul>
<h4 data-id="heading-12"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>balance</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{balance}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 的结算公式与过程</h4>
<p>这个“惩罚”的计算，是在**“批次” (Batch)** 级别上进行的。在训练时，GPU 会一次性处理一个批次，例如 <code>[32, 1024]</code>，即总共 32,768 个 Token。</p>
<p>负载均衡损失的经典公式如下：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>balance</mtext></msub><mo>=</mo><mi>N</mi><mo>⋅</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></msubsup><msub><mi>f</mi><mi>i</mi></msub><mo>⋅</mo><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">L_{\text{balance}} = N \cdot \sum_{i=1}^{N} f_i \cdot P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.2809em;vertical-align:-0.2997em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></p>
<p>我们来拆解这几个关键变量（在<em>一个批次</em>的 32,768 个 Token 中）：</p>
<ul>
<li>
<p><strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span></strong> ：专家的总数量（例如 8）。</p>
</li>
<li>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi></mrow><annotation encoding="application/x-tex">G</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">G</span></span></span></span></span> (概率矩阵)：</p>
<p>Gating 网络为所有 32,768 个 Token 并行计算出的“路由概率”。这是一个 [32768, 8] 的矩阵。</p>
</li>
<li>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">D</span></span></span></span></span> (调度掩码)：</p>
<p>对 G 矩阵的每一行（每个 Token）执行 Top-K（例如 K=2）操作，得到一个“硬决策”的 0/1 掩码。这是一个 [32768, 8] 的矩阵，每一行恰好有 2 个 1。</p>
</li>
<li>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (平均路由概率)：</p>
<p>Gating 网络的“意向”。</p>
<p>它是 G 矩阵第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 列的平均值。代表在这个批次中，Gating 希望分配给专家 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 的平均概率。</p>
</li>
<li>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (任务分配比例)：</p>
<p>专家的“实际工作量”。</p>
<p>它是 D 矩阵第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 列的平均值。代表在这个批次中，专家 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 实际 被分配了百分之多少的 Token。</p>
</li>
</ul>
<p>结算：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>balance</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{balance}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 通过将“实际工作量”(<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>) 和“意向”(<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>) 相乘，来计算每个专家的“不均衡贡献”，最后汇总得出总惩罚。</p>
<hr/>
<h3 data-id="heading-13">篇章四：MoE 训练的“天才诡计”——不可微分的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></h3>
<p>您在深入思考后，一定已经发现了几个最棘手的技术问题。这些问题是 MoE 训练的精髓所在。</p>
<h4 data-id="heading-14">疑问一：如果 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">f_i = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span>（摸鱼专家），惩罚从何而来？</h4>
<p>您是对的！在一个批次中，如果一个专家一次都没被选中，它的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">f_i = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span>，因此它的贡献 <code>f_i * P_i = 0</code>。</p>
<p><strong>惩罚并非来自“摸鱼专家”，而是来自“明星专家”！</strong></p>
<ol>
<li>“明星专家”的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 都很高，导致它的 <code>f_i * P_i</code> 贡献值<strong>极大</strong>。</li>
<li>这使得总的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>balance</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{balance}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 惩罚<strong>非常高</strong>。</li>
<li>优化器为了降低这个惩罚，会强迫 Gating 网络<strong>降低“明星专家”的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></strong> 。</li>
<li><strong>（关键）</strong> Gating 使用的是 Softmax（总和为1）。你从“明星”那里剥夺的概率，必须“重新分配”给其他人。</li>
<li><strong>“摸鱼专家”的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 就这样被动地提高了！</strong> 在下一个批次中，它被选中的概率就变大了。</li>
</ol>
<h4 data-id="heading-15">疑问二：为什么不干脆只平衡 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>（概率）？</h4>
<p>既然 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>（硬决策）只是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>（软概率）的结果，为什么不直接设计一个损失函数（例如 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mtext>variance</mtext><mo stretchy="false">(</mo><msub><mi>P</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">L = \text{variance}(P_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">variance</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>）来平衡 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 就行了？</p>
<p><strong>答案是：因为 Top-K 这个“硬决策”操作是不可微分的 (Non-Differentiable)。</strong></p>
<p>这是理解 MoE 训练的<em>终极</em>障碍，也是它最天才的“诡计”。</p>
<ol>
<li>
<p>什么叫“不可微分”？</p>
<p>想象一个“步阶函数”（Step Function）：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">x &gt; 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"/><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span> 时 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">y=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span>，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>≤</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">x \le 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7719em;vertical-align:-0.136em;"/><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span> 时 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">y=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span>。</p>
<p>在 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">x=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span> 处，它是一个“跳跃”，斜率（导数/梯度）不存在。在 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo mathvariant="normal">≠</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">x \ne 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel"><span class="mrel"><span class="mord vbox"><span class="thinbox"><span class="rlap"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="inner"><span class="mord"><span class="mrel"></span></span></span><span class="fix"/></span></span></span></span><span class="mrel">=</span></span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span> 的地方，它又是“平的”，斜率=0。</p>
<p>机器学习的反向传播依赖“梯度”来更新参数。如果梯度为 0 或不存在，优化器就“瞎了”，不知道该往哪走。</p>
</li>
<li>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 为什么不可微分？</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 是通过 Top-K 这个“硬比较”操作得来的。</p>
<p>Gating 网络对参数做出的微小改变（例如 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 从 0.40 变成 0.41），可能完全不会改变 Top-K 的决策结果。</p>
<p>Gating 的参数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span></span> 变了，但 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 却“纹丝不动”。</p>
<p>这意味着 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 相对于 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span></span> 的梯度 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">Δ</mi><msub><mi>f</mi><mi>i</mi></msub></mrow><mrow><mi mathvariant="normal">Δ</mi><mi>θ</mi></mrow></mfrac><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\frac{\Delta f_i}{\Delta \theta} = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2772em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9322em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">Δ</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.4461em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">Δ</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.1076em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span>。</p>
<p><strong>如果损失函数只基于 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，梯度将无法回传，Gating 网络永远无法被训练！</strong></p>
</li>
</ol>
<h4 data-id="heading-16"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>balance</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{balance}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 的“天才诡计”：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub><mo>⋅</mo><mi mathvariant="normal">∇</mi><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i \cdot \nabla P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord">∇</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></h4>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>balance</mtext></msub><mo>=</mo><mi>N</mi><mo>⋅</mo><mo>∑</mo><mo stretchy="false">(</mo><msub><mi>f</mi><mi>i</mi></msub><mo>⋅</mo><msub><mi>P</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">L_{\text{balance}} = N \cdot \sum (f_i \cdot P_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 这个公式的天才之处在于，它如何“绕过”了不可微分的障碍。</p>
<p>在反向传播计算梯度时，它运用了一个“技巧”：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∇</mi><msub><mi>L</mi><mtext>balance</mtext></msub><mo>∝</mo><msub><mi>f</mi><mi>i</mi></msub><mo>⋅</mo><mi mathvariant="normal">∇</mi><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\nabla L_{\text{balance}} \propto f_i \cdot \nabla P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord">∇</span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∝</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord">∇</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></p>
<ul>
<li>我们知道 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 本身是不可微分的（梯度为 0），但 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>（来自 Softmax）是<strong>可微分的</strong>。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 在这里被“伪装”成一个**“常数缩放因子”**（即“惩罚力度”）。</li>
<li>梯度 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∇</mi><mi>L</mi></mrow><annotation encoding="application/x-tex">\nabla L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">∇</span><span class="mord mathnormal">L</span></span></span></span></span> 实际上是沿着<strong>可微分的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∇</mi><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\nabla P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord">∇</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 这条路</strong>回传的。</li>
</ul>
<p><strong>直白地说：</strong></p>
<blockquote>
<p>优化器：“Gating 网络，我要惩罚你的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>（概率输出）。”</p>
<p>惩罚的力度 = 你“实际”分配给这个专家的工作量 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。</p>
</blockquote>
<ul>
<li>对于“明星专家”：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 很高，惩罚力度 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub><mo>⋅</mo><mi mathvariant="normal">∇</mi><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i \cdot \nabla P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord">∇</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 就<strong>非常大</strong>。</li>
<li>对于“摸鱼专家”：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">f_i = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span>，惩罚力度 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mo>⋅</mo><mi mathvariant="normal">∇</mi><msub><mi>P</mi><mi>i</mi></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">0 \cdot \nabla P_i = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord">∇</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span>。</li>
</ul>
<p>这就是 MoE 训练的全部秘密：<strong>它利用“不可微分”的实际工作量 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 作为权重，去惩罚“可微分”的路由意向 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，再通过 Softmax 的内在机制，被动地“提拔”那些“摸鱼”的专家。</strong></p>
<hr/>
<h4 data-id="heading-17">总结</h4>
<p>MoE（混合专家模型）是一种绝妙的架构，它通过<strong>稀疏激活</strong>（激活 Top-K）实现了“巨大知识库”（总参数）和“极高推理速度”（激活参数）的完美平衡。</p>
<p>为了使其有效工作，它在训练中必须使用<strong>负载均衡</strong>（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>balance</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{balance}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>）来防止“明星专家”问题。</p>
<p>而负载均衡的核心，是一个天才般的“梯度诡计”，它巧妙地绕过了 Top-K 决策的“不可微分”障碍，成功地训练了 Gating 网络。</p>
<p>希望这篇博客能帮您彻底理清 MoE 的所有脉络！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[kotlin-2]]></title>    <link>https://juejin.cn/post/7571704212850130995</link>    <guid>https://juejin.cn/post/7571704212850130995</guid>    <pubDate>2025-11-12T12:14:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571704212850130995" data-draft-id="7571126773808234506" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="kotlin-2"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-11-12T12:14:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风冷"/> <meta itemprop="url" content="https://juejin.cn/user/3843548379091742"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            kotlin-2
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3843548379091742/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风冷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T12:14:19.000Z" title="Wed Nov 12 2025 12:14:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>太棒了！我们继续深入，探索 Kotlin 更核心、更强大的特性。这一部分将让你真正体会到 Kotlin 相比 Java 的优雅和高效。</p>
<hr/>
<h3 data-id="heading-0"><strong>Kotlin 基础进阶：解锁现代编程的威力</strong></h3>
<h4 data-id="heading-1"><strong>八、数据类型：不只是“一切皆对象”</strong></h4>
<p>Kotlin 对数据类型做了精心设计，区分了可空与否，并且所有类型都是对象，没有 Java 中的基本类型和包装类型之分。</p>
<ol>
<li>
<p><strong>基本类型</strong></p>
<ul>
<li><strong>数值类型</strong>：<code>Byte</code>, <code>Short</code>, <code>Int</code>, <code>Long</code>, <code>Float</code>, <code>Double</code></li>
<li><strong>其他类型</strong>：<code>Char</code>（字符）, <code>Boolean</code>（布尔值）, <code>String</code>（字符串）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> number: <span class="hljs-built_in">Int</span> = <span class="hljs-number">100</span> <span class="hljs-comment">// 整数</span>
<span class="hljs-keyword">val</span> pi: <span class="hljs-built_in">Double</span> = <span class="hljs-number">3.14</span> <span class="hljs-comment">// 双精度浮点数</span>
<span class="hljs-keyword">val</span> isKotlinFun: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">true</span> <span class="hljs-comment">// 布尔值</span>
<span class="hljs-keyword">val</span> letter: <span class="hljs-built_in">Char</span> = <span class="hljs-string">'A'</span> <span class="hljs-comment">// 字符</span>
<span class="hljs-keyword">val</span> text: String = <span class="hljs-string">"Hello"</span> <span class="hljs-comment">// 字符串</span>
</code></pre>
</li>
<li>
<p><strong>智能类型转换</strong></p>
<p>Kotlin 编译器非常智能，一旦进行了类型检查，在后续作用域内会自动进行类型转换。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">printLength</span><span class="hljs-params">(obj: <span class="hljs-type">Any</span>)</span></span> { <span class="hljs-comment">// Any 是 Kotlin 中所有类的基类，类似 Java 的 Object</span>
    <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">is</span> String) { <span class="hljs-comment">// 类型检查</span>
        <span class="hljs-comment">// 在这个分支内，obj 被自动转换为 String 类型</span>
        println(obj.length) <span class="hljs-comment">// 可以直接调用 String 的方法</span>
    }

    <span class="hljs-comment">// 或者使用 `!is` 进行否定判断</span>
    <span class="hljs-keyword">if</span> (obj !<span class="hljs-keyword">is</span> String) <span class="hljs-keyword">return</span>
    println(obj.length) <span class="hljs-comment">// 这里 obj 也是 String 类型</span>
}
</code></pre>
<p><strong>对比 Java：</strong> 在 Java 中需要显式强制转换：<code>if (obj instanceof String) { String str = (String) obj; }</code></p>
</li>
</ol>
<h4 data-id="heading-2"><strong>九、集合：功能强大的数据容器</strong></h4>
<p>Kotlin 的集合分为可变和不可变两种，这是非常重要的设计理念。</p>
<ol>
<li>
<p><strong>List（列表）</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 不可变列表 - 只能读取，不能修改</span>
val readOnlyList: List&lt;<span class="hljs-type">String</span>&gt; = <span class="hljs-built_in">listOf</span>(<span class="hljs-string">"Apple"</span>, <span class="hljs-string">"Banana"</span>, <span class="hljs-string">"Orange"</span>)
<span class="hljs-built_in">println</span>(readOnlyList[<span class="hljs-number">0</span>]) <span class="hljs-comment">// 输出：Apple</span>
<span class="hljs-comment">// readOnlyList.add("Grape") // 错误！不可变列表不能添加元素</span>

<span class="hljs-comment">// 可变列表 - 可以修改</span>
val mutableList: MutableList&lt;<span class="hljs-type">String</span>&gt; = <span class="hljs-built_in">mutableListOf</span>(<span class="hljs-string">"Apple"</span>, <span class="hljs-string">"Banana"</span>)
mutableList.<span class="hljs-built_in">add</span>(<span class="hljs-string">"Grape"</span>) <span class="hljs-comment">// 正确！</span>
mutableList[<span class="hljs-number">0</span>] = <span class="hljs-string">"Apricot"</span> <span class="hljs-comment">// 修改元素</span>
</code></pre>
</li>
<li>
<p><strong>Set（集合）和 Map（映射）</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// Set - 不重复元素的集合</span>
val set = <span class="hljs-built_in">setOf</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>) <span class="hljs-comment">// 结果： [1, 2, 3]</span>

<span class="hljs-comment">// Map - 键值对</span>
val map = <span class="hljs-built_in">mapOf</span>(<span class="hljs-string">"name"</span> to <span class="hljs-string">"Kotlin"</span>, <span class="hljs-string">"version"</span> to <span class="hljs-string">"1.9"</span>)
<span class="hljs-built_in">println</span>(map[<span class="hljs-string">"name"</span>]) <span class="hljs-comment">// 输出：Kotlin</span>
</code></pre>
</li>
</ol>
<h4 data-id="heading-3"><strong>十、循环：更优雅的遍历方式</strong></h4>
<ol>
<li>
<p><strong>for 循环</strong></p>
<pre><code class="hljs language-scss" lang="scss">val fruits = <span class="hljs-built_in">listOf</span>("Apple", "Banana", "Orange")

<span class="hljs-comment">// 遍历集合元素</span>
for (fruit in fruits) {
    <span class="hljs-built_in">println</span>(fruit)
}

<span class="hljs-comment">// 遍历索引和值</span>
for ((index, fruit) in fruits<span class="hljs-selector-class">.withIndex</span>()) {
    <span class="hljs-built_in">println</span>("$index: $fruit")
}

<span class="hljs-comment">// 遍历数字范围</span>
for (i in <span class="hljs-number">1</span>..<span class="hljs-number">5</span>) { <span class="hljs-comment">// 包含 1 和 5</span>
    <span class="hljs-built_in">println</span>(i)
}

for (i in <span class="hljs-number">1</span> until <span class="hljs-number">5</span>) { <span class="hljs-comment">// 不包含 5</span>
    <span class="hljs-built_in">println</span>(i)
}

for (i in <span class="hljs-number">5</span> downTo <span class="hljs-number">1</span> step <span class="hljs-number">2</span>) { <span class="hljs-comment">// 从5到1，步长为2</span>
    <span class="hljs-built_in">println</span>(i) <span class="hljs-comment">// 输出：5, 3, 1</span>
}
</code></pre>
</li>
<li>
<p><strong>while 和 do-while</strong>（与 Java 相同）</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-tag">var</span> x = <span class="hljs-number">10</span>
while (x &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">println</span>(x)
    x--
}
</code></pre>
</li>
</ol>
<h4 data-id="heading-4"><strong>十一、函数进阶：默认参数、命名参数、扩展函数</strong></h4>
<ol>
<li>
<p><strong>默认参数</strong>：为函数参数提供默认值</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">greet</span><span class="hljs-params">(name: <span class="hljs-type">String</span>, greeting: <span class="hljs-type">String</span> = <span class="hljs-string">"Hello"</span>)</span></span> {
    println(<span class="hljs-string">"<span class="hljs-variable">$greeting</span>, <span class="hljs-variable">$name</span>!"</span>)
}

greet(<span class="hljs-string">"Alice"</span>) <span class="hljs-comment">// 输出：Hello, Alice!</span>
greet(<span class="hljs-string">"Bob"</span>, <span class="hljs-string">"Hi"</span>) <span class="hljs-comment">// 输出：Hi, Bob!</span>
</code></pre>
</li>
<li>
<p><strong>命名参数</strong>：调用时指定参数名，提高可读性</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createUser</span><span class="hljs-params">(name: <span class="hljs-type">String</span>, age: <span class="hljs-type">Int</span>, isAdmin: <span class="hljs-type">Boolean</span> = <span class="hljs-literal">false</span>)</span></span> {
    println(<span class="hljs-string">"Name: <span class="hljs-variable">$name</span>, Age: <span class="hljs-variable">$age</span>, Admin: <span class="hljs-variable">$isAdmin</span>"</span>)
}

<span class="hljs-comment">// 可以跳过有默认值的参数，随意调整顺序</span>
createUser(age = <span class="hljs-number">25</span>, name = <span class="hljs-string">"Charlie"</span>, isAdmin = <span class="hljs-literal">true</span>)
</code></pre>
</li>
<li>
<p><strong>扩展函数</strong>：Kotlin 的"杀手级特性"，可以为现有类添加新功能</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 为 String 类添加一个扩展函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">addExcitement</span><span class="hljs-params">()</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span> + <span class="hljs-string">"!!!"</span>
}

println(<span class="hljs-string">"Kotlin is fun"</span>.addExcitement()) <span class="hljs-comment">// 输出：Kotlin is fun!!!</span>

<span class="hljs-comment">// 为 List 添加一个扩展函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> List<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">secondOrNull</span><span class="hljs-params">()</span></span>: T? {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.size &gt;= <span class="hljs-number">2</span>) <span class="hljs-keyword">this</span>[<span class="hljs-number">1</span>] <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span>
}

<span class="hljs-keyword">val</span> list = listOf(<span class="hljs-string">"first"</span>, <span class="hljs-string">"second"</span>, <span class="hljs-string">"third"</span>)
println(list.secondOrNull()) <span class="hljs-comment">// 输出：second</span>
</code></pre>
</li>
</ol>
<h4 data-id="heading-5"><strong>十二、Lambda 表达式和高阶函数</strong></h4>
<p>这是函数式编程的核心，让代码极其简洁。</p>
<ol>
<li>
<p><strong>Lambda 表达式基础</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 一个简单的 Lambda：接收两个 Int 参数，返回它们的和</span>
<span class="hljs-keyword">val</span> sum: (<span class="hljs-built_in">Int</span>, <span class="hljs-built_in">Int</span>) -&gt; <span class="hljs-built_in">Int</span> = { a, b -&gt; a + b }
println(sum(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>)) <span class="hljs-comment">// 输出：7</span>

<span class="hljs-comment">// 更常见的写法：直接传递给函数</span>
<span class="hljs-keyword">val</span> numbers = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)

<span class="hljs-comment">// 过滤出偶数</span>
<span class="hljs-keyword">val</span> evens = numbers.filter { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> } <span class="hljs-comment">// [2, 4]</span>

<span class="hljs-comment">// 将每个元素乘以2</span>
<span class="hljs-keyword">val</span> doubled = numbers.map { it * <span class="hljs-number">2</span> } <span class="hljs-comment">// [2, 4, 6, 8, 10]</span>

<span class="hljs-comment">// 排序</span>
<span class="hljs-keyword">val</span> sorted = numbers.sortedByDescending { it } <span class="hljs-comment">// [5, 4, 3, 2, 1]</span>
</code></pre>
</li>
<li>
<p><strong>高阶函数</strong>：接收函数作为参数或返回函数的函数</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 接收一个函数作为参数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">calculate</span><span class="hljs-params">(a: <span class="hljs-type">Int</span>, b: <span class="hljs-type">Int</span>, operation: (<span class="hljs-type">Int</span>, <span class="hljs-type">Int</span>) -&gt; <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-keyword">return</span> operation(a, b)
}

<span class="hljs-comment">// 使用 Lambda 调用</span>
<span class="hljs-keyword">val</span> result1 = calculate(<span class="hljs-number">10</span>, <span class="hljs-number">5</span>) { x, y -&gt; x + y } <span class="hljs-comment">// 15</span>
<span class="hljs-keyword">val</span> result2 = calculate(<span class="hljs-number">10</span>, <span class="hljs-number">5</span>) { x, y -&gt; x * y } <span class="hljs-comment">// 50</span>

<span class="hljs-comment">// 返回一个函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createMultiplier</span><span class="hljs-params">(factor: <span class="hljs-type">Int</span>)</span></span>: (<span class="hljs-built_in">Int</span>) -&gt; <span class="hljs-built_in">Int</span> {
    <span class="hljs-keyword">return</span> { number -&gt; number * factor }
}

<span class="hljs-keyword">val</span> double = createMultiplier(<span class="hljs-number">2</span>)
<span class="hljs-keyword">val</span> triple = createMultiplier(<span class="hljs-number">3</span>)

println(double(<span class="hljs-number">5</span>)) <span class="hljs-comment">// 输出：10</span>
println(triple(<span class="hljs-number">5</span>)) <span class="hljs-comment">// 输出：15</span>
</code></pre>
</li>
</ol>
<h4 data-id="heading-6"><strong>十三、异常处理：try-catch 也是表达式</strong></h4>
<p>Kotlin 的 <code>try-catch</code>也可以返回值，这让错误处理更加函数式。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">parseNumber</span><span class="hljs-params">(str: <span class="hljs-type">String</span>)</span></span>: <span class="hljs-built_in">Int</span>? {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> {
        str.toInt() <span class="hljs-comment">// 如果转换成功，返回数字</span>
    } <span class="hljs-keyword">catch</span> (e: NumberFormatException) {
        <span class="hljs-literal">null</span> <span class="hljs-comment">// 如果转换失败，返回 null</span>
    }
}

println(parseNumber(<span class="hljs-string">"123"</span>)) <span class="hljs-comment">// 输出：123</span>
println(parseNumber(<span class="hljs-string">"abc"</span>)) <span class="hljs-comment">// 输出：null</span>
</code></pre>
<h4 data-id="heading-7"><strong>实战演练：综合运用</strong></h4>
<p>让我们用学到的知识解决一个实际问题：处理学生成绩列表。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span>(<span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> score: <span class="hljs-built_in">Int</span>)

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> students = listOf(
        Student(<span class="hljs-string">"Alice"</span>, <span class="hljs-number">85</span>),
        Student(<span class="hljs-string">"Bob"</span>, <span class="hljs-number">92</span>),
        Student(<span class="hljs-string">"Charlie"</span>, <span class="hljs-number">78</span>),
        Student(<span class="hljs-string">"Diana"</span>, <span class="hljs-number">95</span>),
        Student(<span class="hljs-string">"Eve"</span>, <span class="hljs-number">88</span>)
    )
    
    <span class="hljs-comment">// 找出成绩90分以上的学生名字</span>
    <span class="hljs-keyword">val</span> topStudents = students
        .filter { it.score &gt; <span class="hljs-number">90</span> }
        .map { it.name }
    println(<span class="hljs-string">"Top students: <span class="hljs-variable">$topStudents</span>"</span>) <span class="hljs-comment">// [Bob, Diana]</span>
    
    <span class="hljs-comment">// 计算平均分</span>
    <span class="hljs-keyword">val</span> averageScore = students.map { it.score }.average()
    println(<span class="hljs-string">"Average score: <span class="hljs-variable">$averageScore</span>"</span>)
    
    <span class="hljs-comment">// 按成绩降序排列</span>
    <span class="hljs-keyword">val</span> sortedByScore = students.sortedByDescending { it.score }
    sortedByScore.forEach { println(<span class="hljs-string">"<span class="hljs-subst">${it.name}</span>: <span class="hljs-subst">${it.score}</span>"</span>) }
    
    <span class="hljs-comment">// 使用扩展函数添加实用功能</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> List<span class="hljs-type">&lt;Student&gt;</span>.<span class="hljs-title">getNames</span><span class="hljs-params">()</span></span>: List&lt;String&gt; = <span class="hljs-keyword">this</span>.map { it.name }
    
    <span class="hljs-keyword">val</span> allNames = students.getNames()
    println(<span class="hljs-string">"All names: <span class="hljs-variable">$allNames</span>"</span>)
}
</code></pre>
<h4 data-id="heading-8"><strong>下一步学习路径</strong></h4>
<p>现在你已经掌握了 Kotlin 的核心语法！接下来可以探索：</p>
<ul>
<li><strong>面向对象编程</strong>：类、对象、继承、接口、数据类、密封类</li>
<li><strong>协程</strong>：Kotlin 的轻量级线程，用于异步编程</li>
<li><strong>DSL（领域特定语言）</strong> ：用 Kotlin 创建优雅的领域特定语言</li>
<li><strong>与 Java 互操作</strong>：在现有 Java 项目中引入 Kotlin</li>
</ul>
<p>Kotlin 的学习曲线非常平滑，这些基础概念将为你后续的学习打下坚实的基础。尝试用 Kotlin 重写你之前用 Java 写过的小程序，你会立即感受到它的魅力！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[kotlin-1]]></title>    <link>https://juejin.cn/post/7571662618055049242</link>    <guid>https://juejin.cn/post/7571662618055049242</guid>    <pubDate>2025-11-12T12:14:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571662618055049242" data-draft-id="7571126773808218122" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="kotlin-1"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-11-12T12:14:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风冷"/> <meta itemprop="url" content="https://juejin.cn/user/3843548379091742"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            kotlin-1
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3843548379091742/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风冷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T12:14:03.000Z" title="Wed Nov 12 2025 12:14:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>好的，没问题！我们来写一篇更系统、更清晰、更适合零基础入门的 Kotlin 基础语法篇。</p>
<p>我将采用  <strong>“概念讲解 + 代码示例 + 与Java对比”</strong> 的方式，并辅以<strong>实用技巧和总结</strong>，力求让你一篇文章就掌握 Kotlin 语法的精髓。</p>
<hr/>
<h3 data-id="heading-0"><strong>Kotlin 基础语法入门：从零开始，写好每一行代码</strong></h3>
<p>相比于转载的文章，本教程将提供更清晰的逻辑脉络和更实用的知识提炼。</p>
<h4 data-id="heading-1"><strong>一、 Kotlin 初印象：为什么是它？</strong></h4>
<p>在深入语法之前，先了解 Kotlin 的核心优势：</p>
<ul>
<li><strong>简洁实用</strong>：大大减少样板代码（如 getter/setter、数据类型声明等）。</li>
<li><strong>空安全</strong>：从语言层面杜绝了空指针异常（NullPointerException）的困扰。</li>
<li><strong>100% 兼容 Java</strong>：可以在项目中与 Java 代码无缝调用，平滑迁移。</li>
<li><strong>现代语言特性</strong>：支持函数式编程、扩展函数、协程等。</li>
</ul>
<p>现在，让我们开始语法之旅。</p>
<h4 data-id="heading-2"><strong>二、 程序起点：main 函数</strong></h4>
<p>任何程序的执行都有一个入口，在 Kotlin 中，它极其简洁。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    println(<span class="hljs-string">"Hello, Kotlin World!"</span>)
}
</code></pre>
<ul>
<li><code>fun</code>：关键字，用于声明一个函数。</li>
<li><code>main</code>：函数名，是程序的入口点。</li>
<li><code>println</code>：一个内置函数，用于在控制台输出一行内容。</li>
</ul>
<p><strong>对比 Java：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloWorld</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"Hello, Java World!"</span>);
    }
}
</code></pre>
<p>Kotlin 的写法明显更简洁，不需要类包装。</p>
<h4 data-id="heading-3"><strong>三、 变量声明：val 和 var 的艺术</strong></h4>
<p>Kotlin 使用两个关键字来声明变量，这是基础中的基础。</p>
<ol>
<li>
<p><strong><code>val</code>（value 的缩写）</strong> ：用于声明<strong>只读变量</strong>，相当于 Java 中的 <code>final</code>变量。一旦赋值，不可更改。</p>
<pre><code class="hljs language-ini" lang="ini">val name: <span class="hljs-attr">String</span> = <span class="hljs-string">"Kotlin"</span>
// <span class="hljs-attr">name</span> = <span class="hljs-string">"Java"</span> // 错误！编译不通过，因为 name 是只读的
</code></pre>
</li>
<li>
<p><strong><code>var</code>（variable 的缩写）</strong> ：用于声明<strong>可变变量</strong>。</p>
<pre><code class="hljs language-ini" lang="ini">var age: <span class="hljs-attr">Int</span> = <span class="hljs-number">5</span>
<span class="hljs-attr">age</span> = <span class="hljs-number">6</span> // 正确！可以重新赋值
</code></pre>
</li>
</ol>
<p><strong>高级技巧：类型推断</strong></p>
<p>Kotlin 编译器很智能，如果你在声明时直接赋值，可以省略类型声明（<code>: String</code>和 <code>: Int</code>）。</p>
<pre><code class="hljs language-ini" lang="ini">val <span class="hljs-attr">language</span> = <span class="hljs-string">"Kotlin"</span> // 编译器自动推断 language 为 String 类型
var <span class="hljs-attr">count</span> = <span class="hljs-number">10</span> // 编译器自动推断 count 为 Int 类型
</code></pre>
<p><strong>📌 最佳实践建议：</strong></p>
<p><strong>优先使用 <code>val</code></strong>，除非这个变量确实需要被改变。这能让你的代码更安全、更符合函数式编程的理念。</p>
<h4 data-id="heading-4"><strong>四、 函数定义：fun 的关键作用</strong></h4>
<p>使用 <code>fun</code>关键字来定义函数。基本语法如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 基本函数：无返回值</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">greet</span><span class="hljs-params">(name: <span class="hljs-type">String</span>)</span></span> {
    println(<span class="hljs-string">"Hello, <span class="hljs-variable">$name</span>!"</span>)
}

<span class="hljs-comment">// 2. 有返回值的函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">sum</span><span class="hljs-params">(a: <span class="hljs-type">Int</span>, b: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> { <span class="hljs-comment">// 返回值类型在参数列表后声明</span>
    <span class="hljs-keyword">return</span> a + b
}

<span class="hljs-comment">// 3. 单表达式函数（语法糖！）</span>
<span class="hljs-comment">// 当函数体只有一行表达式时，可以简化写法</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">sumSimple</span><span class="hljs-params">(a: <span class="hljs-type">Int</span>, b: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> = a + b
<span class="hljs-comment">// 甚至，类型推断也能用在这里</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">sumEvenSimpler</span><span class="hljs-params">(a: <span class="hljs-type">Int</span>, b: <span class="hljs-type">Int</span>)</span></span> = a + b
</code></pre>
<p><strong>调用函数：</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">greet</span>("World") <span class="hljs-comment">// 输出：Hello, World!</span>
val result = <span class="hljs-built_in">sum</span>(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>)
<span class="hljs-built_in">println</span>(result) <span class="hljs-comment">// 输出：8</span>
</code></pre>
<h4 data-id="heading-5"><strong>五、 字符串模板：让拼接成为历史</strong></h4>
<p>这是 Kotlin 非常方便的特性，用于在字符串中直接嵌入变量或表达式。</p>
<ul>
<li>
<p><strong>使用 <code>$变量名</code></strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> name = <span class="hljs-string">"Alice"</span>
println(<span class="hljs-string">"Hello, <span class="hljs-variable">$name</span>"</span>) <span class="hljs-comment">// 输出：Hello, Alice</span>
</code></pre>
</li>
<li>
<p><strong>使用 <code>${表达式}</code></strong> （表达式复杂时必需）：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> a = <span class="hljs-number">10</span>
<span class="hljs-keyword">val</span> b = <span class="hljs-number">20</span>
println(<span class="hljs-string">"The sum is <span class="hljs-subst">${a + b}</span>"</span>) <span class="hljs-comment">// 输出：The sum is 30</span>
println(<span class="hljs-string">"The text length is <span class="hljs-subst">${name.length}</span>"</span>) <span class="hljs-comment">// 输出：The text length is 5</span>
</code></pre>
</li>
</ul>
<p><strong>对比 Java 的字符串拼接：</strong> <code>"Hello, " + name</code>，Kotlin 的方式更直观、更安全。</p>
<h4 data-id="heading-6"><strong>六、 条件控制：if 和 when</strong></h4>
<ol>
<li>
<p><strong><code>if</code>表达式</strong></p>
<p>在 Kotlin 中，<code>if</code>不仅可以做分支控制，还可以<strong>返回一个值</strong>。</p>
<pre><code class="hljs language-go" lang="go">val max = <span class="hljs-keyword">if</span> (a &gt; b) {
    <span class="hljs-built_in">println</span>(<span class="hljs-string">"a is larger"</span>)
    a <span class="hljs-comment">// 最后一行作为返回值</span>
} <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">println</span>(<span class="hljs-string">"b is larger or equal"</span>)
    b
}
<span class="hljs-built_in">println</span>(<span class="hljs-string">"Max is $max"</span>)
</code></pre>
<p><strong>对比 Java：</strong> Java 的 <code>if</code>是语句，不返回值，需要借助三元运算符 <code>? :</code>。Kotlin 用 <code>if</code>统一了两者。</p>
</li>
<li>
<p><strong><code>when</code>表达式</strong></p>
<p>功能类似 Java 的 <code>switch</code>，但强大得多。</p>
<pre><code class="hljs language-rust" lang="rust">val grade = <span class="hljs-string">"A"</span>
<span class="hljs-title function_ invoke__">when</span> (grade) {
    <span class="hljs-string">"A"</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-title function_ invoke__">println</span>(<span class="hljs-string">"Excellent"</span>)
    <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-title function_ invoke__">println</span>(<span class="hljs-string">"Good"</span>) <span class="hljs-comment">// 可以合并多个条件</span>
    <span class="hljs-keyword">in</span> <span class="hljs-string">"D"</span>..<span class="hljs-string">"F"</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-title function_ invoke__">println</span>(<span class="hljs-string">"Need improvement"</span>) <span class="hljs-comment">// 可以判断范围</span>
    <span class="hljs-keyword">else</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-title function_ invoke__">println</span>(<span class="hljs-string">"Invalid grade"</span>) <span class="hljs-comment">// 类似 default</span>
}

<span class="hljs-comment">// when 也可以返回值</span>
val description = <span class="hljs-title function_ invoke__">when</span> (grade) {
    <span class="hljs-string">"A"</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-string">"Excellent"</span>
    <span class="hljs-keyword">else</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-string">"Other grades"</span>
}
<span class="hljs-title function_ invoke__">println</span>(description)
</code></pre>
</li>
</ol>
<h4 data-id="heading-7"><strong>七、 空安全：Kotlin 的王牌特性</strong></h4>
<p>这是 Kotlin 解决 NPE 的核心设计。</p>
<ol>
<li>
<p><strong>可空类型</strong>：在类型后面加一个问号 <code>?</code>，表示这个变量可以为 <code>null</code>。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> <span class="hljs-attr">nullableName</span>: <span class="hljs-title class_">String</span>? = <span class="hljs-literal">null</span> <span class="hljs-comment">// 允许为 null</span>
<span class="hljs-keyword">var</span> <span class="hljs-attr">nonNullName</span>: <span class="hljs-title class_">String</span> = <span class="hljs-string">"Kotlin"</span> <span class="hljs-comment">// 不允许为 null</span>
<span class="hljs-comment">// nonNullName = null // 错误！编译不通过</span>
</code></pre>
</li>
<li>
<p><strong>安全调用操作符 <code>?.</code></strong> ：如果对象不为空，则调用方法或属性；否则返回 <code>null</code>。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> length: <span class="hljs-built_in">Int</span>? = nullableName?.length <span class="hljs-comment">// 如果 nullableName 为 null，则 length 也为 null，不会抛出 NPE</span>
</code></pre>
</li>
<li>
<p><strong>Elvis 操作符 <code>?:</code></strong> ：提供一个默认值。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> safeLength: <span class="hljs-built_in">Int</span> = nullableName?.length ?: <span class="hljs-number">0</span> <span class="hljs-comment">// 如果左边为 null，则返回 0</span>
</code></pre>
</li>
</ol>
<h4 data-id="heading-8"><strong>总结与学习建议</strong></h4>









































<table><thead><tr><th>特性</th><th>关键字/符号</th><th>核心优点</th><th>对比 Java</th></tr></thead><tbody><tr><td><strong>变量声明</strong></td><td><code>val</code>, <code>var</code></td><td>不可变优先，类型推断</td><td>减少 <code>final</code>，代码更简洁</td></tr><tr><td><strong>函数定义</strong></td><td><code>fun</code></td><td>单表达式函数简化</td><td>无需类包装，语法更轻量</td></tr><tr><td><strong>字符串</strong></td><td><code>$</code>, <code>${}</code></td><td>嵌入变量，无需拼接</td><td>比 <code>+</code>更直观安全</td></tr><tr><td><strong>条件控制</strong></td><td><code>if</code>, <code>when</code></td><td>是表达式，可返回值</td><td>功能比 <code>switch</code>更强大</td></tr><tr><td><strong>空安全</strong></td><td><code>?</code>, <code>?.</code>, <code>?:</code></td><td>编译期防止 NPE</td><td>从语言层面解决痛点</td></tr></tbody></table>
<p><strong>下一步学习建议：</strong></p>
<p>掌握了这些基础语法后，你就可以编写简单的 Kotlin 程序了。接下来可以探索：</p>
<ul>
<li><strong>数据类型</strong>：数值类型、字符、布尔值、数组和集合。</li>
<li><strong>循环</strong>：<code>for</code>和 <code>while</code>循环。</li>
<li><strong>面向对象</strong>：类、继承、接口。</li>
<li><strong>Lambda 表达式与高阶函数</strong>：Kotlin 函数式编程的核心。</li>
</ul>
<p>希望这篇为你量身定制的教程能让你有一个完美的开始！Kotlin 是一门令人愉悦的语言，祝你学习愉快！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude Skills 新玩法：用 skill-creator 10 分钟搞定 Excel 报表自动化，职场人必学]]></title>    <link>https://juejin.cn/post/7571672422689144884</link>    <guid>https://juejin.cn/post/7571672422689144884</guid>    <pubDate>2025-11-12T12:17:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571672422689144884" data-draft-id="7571650164843839522" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude Skills 新玩法：用 skill-creator 10 分钟搞定 Excel 报表自动化，职场人必学"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-12T12:17:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wwwzhouhui"/> <meta itemprop="url" content="https://juejin.cn/user/3428746411400537"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude Skills 新玩法：用 skill-creator 10 分钟搞定 Excel 报表自动化，职场人必学
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3428746411400537/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wwwzhouhui
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T12:17:15.000Z" title="Wed Nov 12 2025 12:17:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.前言</h2>
<p>skill‑creator 是 Anthropic 在 Claude Skills 体系中提供的“元技能”。它本身是一个可直接在 Claude 对话中调用的 Skill，专门用于 <strong>帮助用户快速创建、编辑、打包其他自定义 Skill</strong>，从而让 Claude 能够在特定业务场景下拥有专业化的能力。在产品发布时，Anthropic 将其定位为“一键生成 Skill 的交互式向导”，用户只需用自然语言描述需求，skill‑creator 会引导完成文件结构、<code>SKILL.md</code> 编写、资源打包等全部步骤。</p>
<p>我们可以借助skill‑creator 帮我们生成新的skils技能。那么为什么选择 Skill Creator? 它能拥有强大的元技能系统，帮助你快速构建专业的 Claude 技能扩展</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/638ec69b4e554c6a9a4f64b4308999ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=zSt6J6mjJE7ofGIOpV7cOt66gow%3D" alt="image-20251112150442511" loading="lazy"/></p>
<p>技术架构特点</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24eca58462f14b878dee10c43e8a84de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=pWtoYw%2FRWa0D4LV2OuEiYKg%2FdKw%3D" alt="image-20251112150722385" loading="lazy"/></p>
<p>我们可以通过六个步骤很容易创建一个新的Skill</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67431af7a59d40dd950be3a2ff2ceb36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=NYY%2BaTkhiCQaccoV7Sy06iOhUys%3D" alt="image-20251112150824718" loading="lazy"/></p>
<p>上期给大家介绍过关于Skills制作，当时没有使用skill‑creator 来实现，而且实现的也较为简单，对上期不了解的小伙伴可以看我之前的文章《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FHHZtKZzW-IB7Bu3DVT4Fsg" target="_blank" title="https://mp.weixin.qq.com/s/HHZtKZzW-IB7Bu3DVT4Fsg" ref="nofollow noopener noreferrer">Claude Skills 从零到一：手把手打造专属公众号文风生成器，10 分钟搞定 AI 技能定制</a>》</p>
<p>本期给大家介绍如何使用skill‑creator创建一个Excel 报表自动生成的 Skill，这个skill 很多职场人士应该用的会比较多。那么话不多说下面教大家如何实现吧 。</p>
<h2 data-id="heading-1">2.Claude  Skills制作</h2>
<h3 data-id="heading-2">创建skills</h3>
<p>提示词如下</p>
<pre><code class="hljs">帮我用 skill‑creator 创建一个用于 Excel 报表自动生成的 Skill
</code></pre>
<p>核心是让AI 调用skill‑creator</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d89c3527e9b549eabec0006f51d9f107~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=VkmFtBWxbUm%2FDk%2FdaWSl5KuWReI%3D" alt="image-20251112130211029" loading="lazy"/></p>
<p>​    中间AI 会要求我们填写一些个人技能要求：</p>
<p>​    还是项目技能（当前项目共享）？</p>
<p>​    Excel 报表主要用于什么场景？</p>
<p>​    你希望使用哪个 Python Excel 库？</p>
<p>​    我们填写上面的信息：个人技能（~/.claude/skills/）、数据分析报表, 业务报告, 数据导出, 模板填充、pandas + openpyxl</p>
<p>接下来AI 帮我们生成</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb976c476fbd4cd8a2af34adf1feccd1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=n%2FtgOY08MIER8ifXkmhSmj1oFg8%3D" alt="img" loading="lazy"/></p>
<p>接下来AI 帮我们在生成skill里面用到python代码</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c275aa3c3eb406d8d9969df0f304d8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=GA9MnmLs9%2FT789JdYQNHdNXNRHw%3D" alt="image-20251112130927092" loading="lazy"/></p>
<p>​    后面再等待几分钟后 AI 帮我生成了基于excle表格的skill</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a29e4277d38a4892ac2e8e46c6372552~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=h67bGjzJjGPrtX9rFJgj9gulYLQ%3D" alt="image-20251112131630040" loading="lazy"/></p>
<p>包含这个excle表格的技能</p>
<pre><code class="hljs language-shell" lang="shell"> 包含 11 个详细章节：
  1. pandas Excel 操作
  2. openpyxl 核心 API
  3. 样式和格式化（字体、填充、边框、对齐）
  4. 图表 API（柱状图、折线图、饼图、散点图）
  5. 条件格式（色阶、数据条、图标集）
  6. 高级功能（数据验证、表格、保护）
  7. 性能优化技巧

  示例脚本特点

  basic_report.py:
  - 基础报表生成流程
  - 标准样式应用
  - 列宽自动调整
  - 冻结窗格和筛选

  advanced_report.py:
  - 多工作表管理
  - 数据透视表
  - 各类图表创建
  - 条件格式应用
  - 公式自动计算
  - 仪表板生成

  template_fill.py:
  - 模板加载和填充
  - 命名范围使用
  - 批量生成报告
  - 发票生成示例

  quick_reference.py:
  - 500+ 行代码片段集合
  - 覆盖所有常用操作
  - 即复制即用
  - 包含完整示例模板
</code></pre>
<p>包括如何使用也给我们举例写好了</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-number">1.</span> 测试 Skill: 在 Claude Code 中问：<span class="hljs-string">"帮我创建一个简单的 Excel 销售报表"</span>
</code></pre>
<h3 data-id="heading-3">skills上传打包</h3>
<p>AI 在创建这个skills 直接帮我生成到我的claude skills中，我都不需要复制了。</p>
<p>我们进入/root/.claude/skills 目录下</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> ~/.claude/skills
</code></pre>
<p>​    <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ef786d720774db2a53ec627345a95be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=D6P6Y1mnTmqNnCy8yd8web%2FRxcU%3D" alt="image-20251112132123032" loading="lazy"/></p>
<p>查看生成好的skills  有哪些内容。</p>
<p>​    <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/793bef06fb92485688123d88789b5e07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=6agdTiszDdjjf%2BBeTxw%2Boq4Ty7I%3D" alt="image-20251112132222126" loading="lazy"/></p>
<p>​      代码</p>
<p>​      <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/087380b441174857aa33b00e32483310~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=A3a58T2L4hSr1eHZUqaDO3RgptA%3D" alt="image-20251112132307207" loading="lazy"/></p>
<p>​      非常完美 一行命令就帮我制作好了一个 Excel 报表自动生成的 Skill</p>
<h2 data-id="heading-4">3.验证及测试</h2>
<p>​    接下来我们验证一下这个skills 作出的表格是什么样子的。</p>
<p>​    我们这里为了演示，我让 AI 帮我造成一个表格数据。</p>
<pre><code class="hljs language-arduino" lang="arduino">	请帮我造一个<span class="hljs-string">"简单的初中生成期中考试学习成绩表格"</span> 其中包括语文、数学、英语、物理、化学、历史、生物、地理、历史科目的。学生给我生成大概<span class="hljs-number">50</span>个人。学生的姓名和成绩随机生成
	生成<span class="hljs-string">"2025年101中学八年级期中考试成绩表.xlsx"</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4748f195b2741af8eade5fa70e0709c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=%2B%2FXWdBU9IqDGuWnTzQb9UFRzPGg%3D" alt="image-20251112133252245" loading="lazy"/></p>
<p>​      claude code 会基于我刚才的需求生成python代码，使用这个python代码来生成这个初中成绩表格。</p>
<p>​</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92d16604889f466d86bfbb071893e05f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=1dJCMXDyabRXqPqCSR7mPBsKUwA%3D" alt="image-20251112133703651" loading="lazy"/></p>
<p>生成完成，我们用电脑打开表格看看</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79b980aa3c3c42f8a8e3229147f75222~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=6bzQtVC65ZW5wSGZXEdR8sRHucs%3D" alt="image-20251112133833007" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d9d9fd0d13147b4bfd7efbe0344f022~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=GbtmjWW%2FzkBlpP4SLsYsFaS%2Fcoo%3D" alt="image-20251112133851759" loading="lazy"/></p>
<p>数据表格已经生成了，接下来我们使用刚才创建的excel表格skills  来生成我们要的统计图表。</p>
<p>我的提示词如下：</p>
<pre><code class="hljs">请基于“2025年101中学八年级期中考试成绩表.xlsx”表格使用excel-report-generator 这个skills 技能帮我生成基于“语文、数学、英语、物理、化学、历史、生物、地理、历史科目评价成绩在90分以上、80分-80分、70分以下人员统计占比图” 输出“2025年101中学八年级期中考试成绩表各学科占比统计图.xlsx”
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/409f85294c7c486da965e647494a5bce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=0zwC0EzbHnlQoMrXuk8w7xuylw4%3D" alt="image-20251112142242284" loading="lazy"/></p>
<p>​     生成的结果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e09a977639c94870986af1b8cb927f54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=x2IbT3rHyGs5ZAESF574yHGJcuw%3D" alt="image-20251112142403700" loading="lazy"/></p>
<p>结果AI 非常贴心的帮我生成了下面的数据</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58f3151eadcd48e2a4d038ff19658ecd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=VzcoFd7B7%2BDqrc7tlbzadVakx4o%3D" alt="image-20251112142819679" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae03a724fec74285a06b63adaa7e9371~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554634&amp;x-signature=UIAZT76%2FmEyFw7b%2BEJcICI21pvI%3D" alt="image-20251112142845779" loading="lazy"/></p>
<p>我们通过上面的自定义创建excel-report-generator 基于excel表格快速生成一个我们要的各种图表，呵呵是不是非常的方便？</p>
<p>视频效果</p>
<p>skills已经开源</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwwwzhouhui%2Fskills_collection" target="_blank" title="https://github.com/wwwzhouhui/skills_collection" ref="nofollow noopener noreferrer">github.com/wwwzhouhui/…</a></p>
<p>感兴趣小伙伴可以去下载。</p>
<h2 data-id="heading-5">4.总结</h2>
<p>今天主要带大家了解并实践了使用 skill-creator 工具创建 Excel 报表自动生成专属 Claude Skill 的完整流程，该流程以 Anthropic 推出的 Skills 模块化体系为基础，通过借助 AI 辅助生成工具，形成了一套从技能定制到实际报表生成的高效解决方案。</p>
<p>通过这套实践方案，用户能够快速构建专业的 Excel 自动化能力 —— 借助 skill-creator 引导的交互式配置（场景定义、库选择、功能生成），无需复杂的编程经验，就能完成包含 11 个专业章节、4 类实用脚本的 Excel 报表技能封装。无论是数据分析报表生成、业务报告格式化，还是模板批量填充、图表自动绘制，都能通过标准化的 Skill 调用实现，极大降低了职场人士利用 AI 提升 Excel 办公效率的技术门槛。在实际验证中，我们创建的「excel-report-generator」能够稳定处理成绩数据统计、多维度图表生成等任务，有效解决了手动制作报表时的繁琐重复问题。同时，该方案具备很强的扩展性 —— 小伙伴们可以基于此技能扩展更多办公场景应用，如财务报表自动汇总、销售数据可视化看板、库存清单批量生成等，进一步释放 Claude 模型在办公自动化领域的应用价值。</p>
<p>感兴趣的小伙伴可以参照文中提供的步骤，结合自身办公需求创建专属 Excel 技能进行实践。今天的分享就到这里结束了，我们下一篇文章见。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[kotlin-3]]></title>    <link>https://juejin.cn/post/7571678674144739338</link>    <guid>https://juejin.cn/post/7571678674144739338</guid>    <pubDate>2025-11-12T12:33:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571678674144739338" data-draft-id="7571067260053995546" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="kotlin-3"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-11-12T12:33:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风冷"/> <meta itemprop="url" content="https://juejin.cn/user/3843548379091742"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            kotlin-3
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3843548379091742/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风冷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T12:33:05.000Z" title="Wed Nov 12 2025 12:33:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>太棒了！现在让我们进入 Kotlin 最精彩的部分——面向对象编程和高级特性。这一部分将彻底改变你对编程的认知。</p>
<hr/>
<h3 data-id="heading-0"><strong>Kotlin 面向对象编程：重新定义代码组织方式</strong></h3>
<h4 data-id="heading-1"><strong>十四、类与对象：简洁的开始</strong></h4>
<p>Kotlin 中的类定义极其简洁，告别了 Java 的样板代码。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 最简单的类定义</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>

<span class="hljs-comment">// 带主构造函数的类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> <span class="hljs-title function_">constructor</span>(<span class="hljs-params">firstName: <span class="hljs-built_in">String</span></span>) { <span class="hljs-comment">/*...*/</span> }

<span class="hljs-comment">// 主构造函数可以省略 constructor 关键字</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(<span class="hljs-attr">firstName</span>: <span class="hljs-title class_">String</span>) {
    <span class="hljs-comment">// 属性直接在类体中声明</span>
    <span class="hljs-keyword">var</span> <span class="hljs-attr">firstName</span>: <span class="hljs-title class_">String</span> = firstName
    <span class="hljs-keyword">var</span> <span class="hljs-attr">lastName</span>: <span class="hljs-title class_">String</span> = <span class="hljs-string">""</span>
    <span class="hljs-keyword">var</span> <span class="hljs-attr">age</span>: <span class="hljs-title class_">Int</span> = <span class="hljs-number">0</span>
}

<span class="hljs-comment">// 更简洁的写法：在主构造函数中直接声明属性</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(
    val <span class="hljs-attr">firstName</span>: <span class="hljs-title class_">String</span>,  <span class="hljs-comment">// 只读属性</span>
    <span class="hljs-keyword">var</span> <span class="hljs-attr">lastName</span>: <span class="hljs-title class_">String</span>,   <span class="hljs-comment">// 可变属性</span>
    <span class="hljs-keyword">var</span> <span class="hljs-attr">age</span>: <span class="hljs-title class_">Int</span> = <span class="hljs-number">0</span>        <span class="hljs-comment">// 带默认值的参数</span>
) {
    <span class="hljs-comment">// 类体</span>
}
</code></pre>
<p><strong>使用类：</strong></p>
<pre><code class="hljs language-ini" lang="ini">val <span class="hljs-attr">person</span> = Person(<span class="hljs-string">"张"</span>, <span class="hljs-string">"三"</span>, <span class="hljs-number">25</span>)
println(person.firstName)  // 输出：张
<span class="hljs-attr">person.age</span> = <span class="hljs-number">26</span>            // 可以修改
// <span class="hljs-attr">person.firstName</span> = <span class="hljs-string">"李"</span> // 错误！firstName 是 val
</code></pre>
<h4 data-id="heading-2"><strong>十五、数据类（Data Class）：自动生成样板代码</strong></h4>
<p>这是 Kotlin 的"魔法"特性之一，专门用于存储数据。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 数据类定义 - 一行代码搞定！</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(
    <span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Int</span>,
    <span class="hljs-keyword">val</span> name: String,
    <span class="hljs-keyword">val</span> email: String
)

<span class="hljs-comment">// 自动获得以下功能：</span>
<span class="hljs-keyword">val</span> user1 = User(<span class="hljs-number">1</span>, <span class="hljs-string">"Alice"</span>, <span class="hljs-string">"alice@example.com"</span>)
<span class="hljs-keyword">val</span> user2 = User(<span class="hljs-number">1</span>, <span class="hljs-string">"Alice"</span>, <span class="hljs-string">"alice@example.com"</span>)

<span class="hljs-comment">// 1. 自动实现 toString()</span>
println(user1) <span class="hljs-comment">// 输出：User(id=1, name=Alice, email=alice@example.com)</span>

<span class="hljs-comment">// 2. 自动实现 equals() 和 hashCode()</span>
println(user1 == user2) <span class="hljs-comment">// 输出：true（比较内容，不是引用）</span>

<span class="hljs-comment">// 3. 自动实现 copy() 函数</span>
<span class="hljs-keyword">val</span> user3 = user1.copy(name = <span class="hljs-string">"Alice Smith"</span>)
println(user3) <span class="hljs-comment">// 输出：User(id=1, name=Alice Smith, email=alice@example.com)</span>

<span class="hljs-comment">// 4. 自动实现 componentN() 函数（用于解构）</span>
<span class="hljs-keyword">val</span> (id, name, email) = user1
println(<span class="hljs-string">"ID: <span class="hljs-variable">$id</span>, Name: <span class="hljs-variable">$name</span>"</span>) <span class="hljs-comment">// 输出：ID: 1, Name: Alice</span>
</code></pre>
<p><strong>对比 Java：</strong> 在 Java 中需要手动编写 getter/setter、equals()、hashCode()、toString() 等大量样板代码。</p>
<h4 data-id="heading-3"><strong>十六、对象表达式与对象声明：替代匿名类和单例</strong></h4>
<ol>
<li>
<p><strong>对象表达式（匿名对象）</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 类似 Java 的匿名内部类，但更强大</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ClickListener</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onClick</span><span class="hljs-params">()</span></span>
}

<span class="hljs-keyword">val</span> button = <span class="hljs-keyword">object</span> : ClickListener {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onClick</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"Button clicked!"</span>)
    }
}

button.onClick()
</code></pre>
</li>
<li>
<p><strong>对象声明（单例模式）</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用 object 关键字创建单例</span>
<span class="hljs-keyword">object</span> DatabaseManager {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> connectionCount = <span class="hljs-number">0</span>

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">connect</span><span class="hljs-params">()</span></span> {
        connectionCount++
        println(<span class="hljs-string">"Connected! Total connections: <span class="hljs-variable">$connectionCount</span>"</span>)
    }

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getConnectionCount</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> = connectionCount
}

<span class="hljs-comment">// 直接通过类名调用，不需要实例化</span>
DatabaseManager.connect() <span class="hljs-comment">// 输出：Connected! Total connections: 1</span>
DatabaseManager.connect() <span class="hljs-comment">// 输出：Connected! Total connections: 2</span>
</code></pre>
</li>
</ol>
<h4 data-id="heading-4"><strong>十七、伴生对象（Companion Object）：替代静态成员</strong></h4>
<p>Kotlin 没有 <code>static</code>关键字，使用伴生对象实现类似功能。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> {
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> MAX_COUNT = <span class="hljs-number">100</span>  <span class="hljs-comment">// 类似静态常量</span>
        
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">()</span></span>: MyClass {    <span class="hljs-comment">// 类似静态工厂方法</span>
            <span class="hljs-keyword">return</span> MyClass()
        }
        
        <span class="hljs-meta">@JvmStatic</span>  <span class="hljs-comment">// 如果需要 Java 互操作</span>
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">staticMethod</span><span class="hljs-params">()</span></span> {
            println(<span class="hljs-string">"This can be called from Java as static method"</span>)
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">instanceMethod</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"This is an instance method"</span>)
    }
}

<span class="hljs-comment">// 使用方式</span>
println(MyClass.MAX_COUNT)  <span class="hljs-comment">// 直接通过类名访问</span>
<span class="hljs-keyword">val</span> obj = MyClass.create()   <span class="hljs-comment">// 直接通过类名调用</span>
</code></pre>
<h4 data-id="heading-5"><strong>十八、密封类（Sealed Class）：受限的类层次结构</strong></h4>
<p>密封类用于表示受限的类继承结构，在 <code>when</code>表达式中特别有用。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 定义密封类</span>
<span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span>&lt;<span class="hljs-type">out T</span>&gt; {
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Success</span>&lt;<span class="hljs-type">T</span>&gt;(<span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span>: T) : Result&lt;T&gt;()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Error</span>(<span class="hljs-keyword">val</span> message: String) : Result&lt;<span class="hljs-built_in">Nothing</span>&gt;()
    <span class="hljs-keyword">object</span> Loading : Result&lt;<span class="hljs-built_in">Nothing</span>&gt;()
}

<span class="hljs-comment">// 使用密封类 - when 表达式会检查是否覆盖所有情况</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handleResult</span><span class="hljs-params">(result: <span class="hljs-type">Result</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span> {
    <span class="hljs-keyword">when</span> (result) {
        <span class="hljs-keyword">is</span> Result.Success -&gt; println(<span class="hljs-string">"Success: <span class="hljs-subst">${result.data}</span>"</span>)
        <span class="hljs-keyword">is</span> Result.Error -&gt; println(<span class="hljs-string">"Error: <span class="hljs-subst">${result.message}</span>"</span>)
        Result.Loading -&gt; println(<span class="hljs-string">"Loading..."</span>)
        <span class="hljs-comment">// 不需要 else 分支，因为所有情况都已覆盖</span>
    }
}

<span class="hljs-keyword">val</span> successResult = Result.Success(<span class="hljs-string">"Data loaded"</span>)
<span class="hljs-keyword">val</span> errorResult = Result.Error(<span class="hljs-string">"Network error"</span>)

handleResult(successResult) <span class="hljs-comment">// 输出：Success: Data loaded</span>
handleResult(errorResult)   <span class="hljs-comment">// 输出：Error: Network error</span>
</code></pre>
<h4 data-id="heading-6"><strong>十九、扩展函数实战：为现有类添加超能力</strong></h4>
<p>让我们看一些实用的扩展函数例子：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 为 String 类添加扩展</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">isEmail</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">return</span> contains(<span class="hljs-string">"@"</span>) &amp;&amp; contains(<span class="hljs-string">"."</span>)
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">capitalizeWords</span><span class="hljs-params">()</span></span>: String {
    <span class="hljs-keyword">return</span> split(<span class="hljs-string">" "</span>).joinToString(<span class="hljs-string">" "</span>) { it.replaceFirstChar { char -&gt; char.uppercase() } }
}

<span class="hljs-comment">// 为 List 添加扩展</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> List<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">second</span><span class="hljs-params">()</span></span>: T = <span class="hljs-keyword">this</span>[<span class="hljs-number">1</span>]
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> List<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">randomOrNull</span><span class="hljs-params">()</span></span>: T? = <span class="hljs-keyword">if</span> (isEmpty()) <span class="hljs-literal">null</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.random()

<span class="hljs-comment">// 使用扩展函数</span>
println(<span class="hljs-string">"test@example.com"</span>.isEmail())        <span class="hljs-comment">// 输出：true</span>
println(<span class="hljs-string">"hello world"</span>.capitalizeWords())      <span class="hljs-comment">// 输出：Hello World</span>

<span class="hljs-keyword">val</span> list = listOf(<span class="hljs-string">"first"</span>, <span class="hljs-string">"second"</span>, <span class="hljs-string">"third"</span>)
println(list.second())                       <span class="hljs-comment">// 输出：second</span>
println(emptyList&lt;String&gt;().randomOrNull())  <span class="hljs-comment">// 输出：null</span>
</code></pre>
<h4 data-id="heading-7"><strong>二十、属性委托：强大的属性管理</strong></h4>
<p>属性委托是 Kotlin 的高级特性，可以简化代码。</p>
<ol>
<li>
<p><strong>lazy 委托：延迟初始化</strong></p>
<pre><code class="hljs language-scss" lang="scss">class ExpensiveObject {
    init {
        <span class="hljs-built_in">println</span>("正在创建昂贵的对象...")
    }
}

class MyClass {
    <span class="hljs-comment">// 只有第一次访问时才会创建</span>
    val expensiveObject: ExpensiveObject by lazy {
        <span class="hljs-built_in">println</span>("第一次访问，开始初始化")
        <span class="hljs-built_in">ExpensiveObject</span>()
    }
}

val myClass = <span class="hljs-built_in">MyClass</span>()
<span class="hljs-built_in">println</span>("对象已创建，但昂贵对象还未初始化")
<span class="hljs-built_in">println</span>(myClass.expensiveObject)  <span class="hljs-comment">// 这里才会真正初始化</span>
<span class="hljs-built_in">println</span>(myClass.expensiveObject)  <span class="hljs-comment">// 直接使用已初始化的对象</span>
</code></pre>
</li>
<li>
<p><strong>observable 委托：属性变化监听</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlin.properties.Delegates

<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-keyword">var</span> name: String <span class="hljs-keyword">by</span> Delegates.observable(<span class="hljs-string">"未命名"</span>) { property, oldValue, newValue -&gt;
        println(<span class="hljs-string">"属性 <span class="hljs-subst">${property.name}</span> 从 '<span class="hljs-variable">$oldValue</span>' 变为 '<span class="hljs-variable">$newValue</span>'"</span>)
    }
}

<span class="hljs-keyword">val</span> user = User()
user.name = <span class="hljs-string">"Alice"</span>  <span class="hljs-comment">// 输出：属性 name 从 '未命名' 变为 'Alice'</span>
user.name = <span class="hljs-string">"Bob"</span>    <span class="hljs-comment">// 输出：属性 name 从 'Alice' 变为 'Bob'</span>
</code></pre>
</li>
</ol>
<h4 data-id="heading-8"><strong>二十一、空安全深度探索：安全调用链</strong></h4>
<p>当处理复杂对象时，安全调用操作符特别有用。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Address</span>(<span class="hljs-keyword">val</span> street: String?, <span class="hljs-keyword">val</span> city: String)
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Company</span>(<span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> address: Address?)
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Employee</span>(<span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> company: Company?)

<span class="hljs-comment">// 复杂的嵌套对象</span>
<span class="hljs-keyword">val</span> employee: Employee? = Employee(
    <span class="hljs-string">"Alice"</span>, 
    Company(<span class="hljs-string">"Tech Corp"</span>, Address(<span class="hljs-string">"Main St"</span>, <span class="hljs-string">"Beijing"</span>))
)

<span class="hljs-comment">// 传统方式（繁琐）</span>
<span class="hljs-keyword">val</span> city1 = <span class="hljs-keyword">if</span> (employee != <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">if</span> (employee.company != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">if</span> (employee.company.address != <span class="hljs-literal">null</span>) {
            employee.company.address.city
        } <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span>
} <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span>

<span class="hljs-comment">// Kotlin 安全调用链（优雅！）</span>
<span class="hljs-keyword">val</span> city2 = employee?.company?.address?.city

println(city2) <span class="hljs-comment">// 输出：Beijing</span>

<span class="hljs-comment">// 如果中间有任何环节为 null，整个表达式返回 null</span>
<span class="hljs-keyword">val</span> employee2: Employee? = Employee(<span class="hljs-string">"Bob"</span>, <span class="hljs-literal">null</span>)
<span class="hljs-keyword">val</span> city3 = employee2?.company?.address?.city
println(city3) <span class="hljs-comment">// 输出：null</span>
</code></pre>
<h4 data-id="heading-9"><strong>实战项目：构建一个简单的任务管理系统</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 定义数据模型</span>
<span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskPriority</span> {
    <span class="hljs-keyword">object</span> Low : TaskPriority()
    <span class="hljs-keyword">object</span> Normal : TaskPriority()
    <span class="hljs-keyword">object</span> High : TaskPriority()
}

<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Task</span>(
    <span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Int</span>,
    <span class="hljs-keyword">val</span> title: String,
    <span class="hljs-keyword">val</span> description: String,
    <span class="hljs-keyword">val</span> priority: TaskPriority,
    <span class="hljs-keyword">val</span> isCompleted: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">false</span>
) {
    <span class="hljs-comment">// 扩展函数：获取优先级颜色</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getPriorityColor</span><span class="hljs-params">()</span></span>: String = <span class="hljs-keyword">when</span> (priority) {
        TaskPriority.Low -&gt; <span class="hljs-string">"绿色"</span>
        TaskPriority.Normal -&gt; <span class="hljs-string">"黄色"</span>
        TaskPriority.High -&gt; <span class="hljs-string">"红色"</span>
    }
}

<span class="hljs-comment">// 任务管理器（单例）</span>
<span class="hljs-keyword">object</span> TaskManager {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> tasks = mutableListOf&lt;Task&gt;()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> nextId = <span class="hljs-number">1</span>
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addTask</span><span class="hljs-params">(title: <span class="hljs-type">String</span>, description: <span class="hljs-type">String</span>, priority: <span class="hljs-type">TaskPriority</span>)</span></span>: Task {
        <span class="hljs-keyword">val</span> task = Task(nextId++, title, description, priority)
        tasks.add(task)
        <span class="hljs-keyword">return</span> task
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">completeTask</span><span class="hljs-params">(taskId: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">val</span> task = tasks.find { it.id == taskId }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (task != <span class="hljs-literal">null</span>) {
            tasks.replaceAll { <span class="hljs-keyword">if</span> (it.id == taskId) it.copy(isCompleted = <span class="hljs-literal">true</span>) <span class="hljs-keyword">else</span> it }
            <span class="hljs-literal">true</span>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-literal">false</span>
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getHighPriorityTasks</span><span class="hljs-params">()</span></span>: List&lt;Task&gt; {
        <span class="hljs-keyword">return</span> tasks.filter { it.priority <span class="hljs-keyword">is</span> TaskPriority.High &amp;&amp; !it.isCompleted }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getTasksByPriority</span><span class="hljs-params">(priority: <span class="hljs-type">TaskPriority</span>)</span></span>: List&lt;Task&gt; {
        <span class="hljs-keyword">return</span> tasks.filter { it.priority == priority }
    }
}

<span class="hljs-comment">// 使用任务管理系统</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 添加任务</span>
    <span class="hljs-keyword">val</span> task1 = TaskManager.addTask(<span class="hljs-string">"学习 Kotlin"</span>, <span class="hljs-string">"掌握 Kotlin 高级特性"</span>, TaskPriority.High)
    <span class="hljs-keyword">val</span> task2 = TaskManager.addTask(<span class="hljs-string">"写博客"</span>, <span class="hljs-string">"分享 Kotlin 学习心得"</span>, TaskPriority.Normal)
    
    println(<span class="hljs-string">"高优先级任务："</span>)
    TaskManager.getHighPriorityTasks().forEach { task -&gt;
        println(<span class="hljs-string">"<span class="hljs-subst">${task.title}</span> - 优先级：<span class="hljs-subst">${task.getPriorityColor()}</span>"</span>)
    }
    
    <span class="hljs-comment">// 完成任务</span>
    TaskManager.completeTask(task1.id)
    println(<span class="hljs-string">"任务1完成状态：<span class="hljs-subst">${TaskManager.getHighPriorityTasks().isEmpty()}</span>"</span>)
}
</code></pre>
<h4 data-id="heading-10"><strong>下一步学习方向</strong></h4>
<p>你现在已经掌握了 Kotlin 的核心高级特性！接下来可以探索：</p>
<ul>
<li><strong>协程（Coroutines）</strong> ：异步编程的现代解决方案</li>
<li><strong>类型安全的构建器（Type-safe builders）</strong> ：创建 DSL</li>
<li><strong>反射（Reflection）</strong> ：运行时检查代码结构</li>
<li><strong>多平台项目（KMP）</strong> ：用 Kotlin 开发 iOS、Web、桌面应用</li>
</ul>
<p>Kotlin 的世界非常广阔，这些高级特性将让你写出更加优雅、安全、高效的代码。尝试用这些特性重构你之前的项目，你会发现编程可以如此愉快！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[kotlin-4]]></title>    <link>https://juejin.cn/post/7571678674144854026</link>    <guid>https://juejin.cn/post/7571678674144854026</guid>    <pubDate>2025-11-12T12:47:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571678674144854026" data-draft-id="7571088527678275610" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="kotlin-4"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-11-12T12:47:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风冷"/> <meta itemprop="url" content="https://juejin.cn/user/3843548379091742"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            kotlin-4
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3843548379091742/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风冷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T12:47:15.000Z" title="Wed Nov 12 2025 12:47:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>太棒了！现在让我们进入 Kotlin 最激动人心的部分——<strong>协程</strong>和<strong>现代异步编程</strong>。这将彻底改变你处理并发和异步任务的方式。</p>
<hr/>
<h3 data-id="heading-0"><strong>Kotlin 协程：重新定义异步编程</strong></h3>
<h4 data-id="heading-1"><strong>二十二、协程基础：轻量级线程</strong></h4>
<p>协程是 Kotlin 用于异步编程的解决方案，比线程更轻量、更高效。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    println(<span class="hljs-string">"主线程开始: <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
    
    <span class="hljs-comment">// 启动一个协程</span>
    GlobalScope.launch {
        println(<span class="hljs-string">"协程开始: <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
        delay(<span class="hljs-number">1000L</span>) <span class="hljs-comment">// 非阻塞延迟</span>
        println(<span class="hljs-string">"协程结束: <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
    }
    
    println(<span class="hljs-string">"主线程继续执行: <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
    Thread.sleep(<span class="hljs-number">2000L</span>) <span class="hljs-comment">// 阻塞主线程，等待协程完成</span>
    println(<span class="hljs-string">"主线程结束"</span>)
}

<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 主线程开始: main</span>
<span class="hljs-comment">// 主线程继续执行: main</span>
<span class="hljs-comment">// 协程开始: DefaultDispatcher-worker-1</span>
<span class="hljs-comment">// 协程结束: DefaultDispatcher-worker-1</span>
<span class="hljs-comment">// 主线程结束</span>
</code></pre>
<p><strong>关键概念：</strong></p>
<ul>
<li><code>launch</code>: 启动一个不返回结果的协程</li>
<li><code>delay()</code>: 非阻塞的挂起函数</li>
<li>协程运行在后台线程池，不会阻塞主线程</li>
</ul>
<h4 data-id="heading-2"><strong>二十三、挂起函数：异步操作的基石</strong></h4>
<p>挂起函数是协程的核心，用 <code>suspend</code>关键字标记。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fetchUserData</span><span class="hljs-params">(userId: <span class="hljs-type">Int</span>)</span></span>: String {
    delay(<span class="hljs-number">1000L</span>) <span class="hljs-comment">// 模拟网络请求</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"用户 <span class="hljs-variable">$userId</span> 的数据"</span>
}

<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fetchUserPosts</span><span class="hljs-params">(userId: <span class="hljs-type">Int</span>)</span></span>: String {
    delay(<span class="hljs-number">1500L</span>) <span class="hljs-comment">// 模拟数据库查询</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"用户 <span class="hljs-variable">$userId</span> 的帖子"</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> time = measureTimeMillis {
        <span class="hljs-keyword">val</span> userData = fetchUserData(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">val</span> userPosts = fetchUserPosts(<span class="hljs-number">1</span>)
        println(<span class="hljs-string">"<span class="hljs-variable">$userData</span>, <span class="hljs-variable">$userPosts</span>"</span>)
    }
    println(<span class="hljs-string">"顺序执行耗时: <span class="hljs-subst">${time}</span>ms"</span>)
}
</code></pre>
<h4 data-id="heading-3"><strong>二十四、异步并发：同时执行多个任务</strong></h4>
<p>使用 <code>async</code>和 <code>await</code>实现并发操作。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*
<span class="hljs-keyword">import</span> kotlin.system.measureTimeMillis

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> time = measureTimeMillis {
        <span class="hljs-comment">// 同时启动两个异步任务</span>
        <span class="hljs-keyword">val</span> userDataDeferred = async { fetchUserData(<span class="hljs-number">1</span>) }
        <span class="hljs-keyword">val</span> userPostsDeferred = async { fetchUserPosts(<span class="hljs-number">1</span>) }
        
        <span class="hljs-comment">// 等待两个任务都完成</span>
        <span class="hljs-keyword">val</span> userData = userDataDeferred.await()
        <span class="hljs-keyword">val</span> userPosts = userPostsDeferred.await()
        
        println(<span class="hljs-string">"<span class="hljs-variable">$userData</span>, <span class="hljs-variable">$userPosts</span>"</span>)
    }
    println(<span class="hljs-string">"并发执行耗时: <span class="hljs-subst">${time}</span>ms"</span>) <span class="hljs-comment">// 时间接近最长任务的时间</span>
}

<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 用户 1 的数据, 用户 1 的帖子</span>
<span class="hljs-comment">// 并发执行耗时: 1506ms (而不是 1000 + 1500 = 2500ms)</span>
</code></pre>
<h4 data-id="heading-4"><strong>二十五、协程上下文与调度器</strong></h4>
<p>控制协程在哪个线程上运行。</p>
<pre><code class="hljs language-scss" lang="scss">import kotlinx<span class="hljs-selector-class">.coroutines</span>.*

fun <span class="hljs-selector-tag">main</span>() = runBlocking {
    <span class="hljs-comment">// 在不同调度器上启动协程</span>
    launch { <span class="hljs-comment">// 继承父协程的上下文</span>
        <span class="hljs-built_in">println</span>("默认调度器: ${Thread.currentThread()<span class="hljs-selector-class">.name</span>}")
    }
    
    <span class="hljs-built_in">launch</span>(Dispatchers.Unconfined) { <span class="hljs-comment">// 不受限制，在第一个挂起点之前运行在调用者线程</span>
        <span class="hljs-built_in">println</span>("不受限制: ${Thread.currentThread()<span class="hljs-selector-class">.name</span>}")
    }
    
    <span class="hljs-built_in">launch</span>(Dispatchers.Default) { <span class="hljs-comment">// CPU 密集型任务</span>
        <span class="hljs-built_in">println</span>("默认调度器: ${Thread.currentThread()<span class="hljs-selector-class">.name</span>}")
    }
    
    <span class="hljs-built_in">launch</span>(Dispatchers.IO) { <span class="hljs-comment">// I/O 密集型任务</span>
        <span class="hljs-built_in">println</span>("IO 调度器: ${Thread.currentThread()<span class="hljs-selector-class">.name</span>}")
    }
    
    <span class="hljs-built_in">launch</span>(newSingleThreadContext("MyThread")) { <span class="hljs-comment">// 专用线程</span>
        <span class="hljs-built_in">println</span>("专用线程: ${Thread.currentThread()<span class="hljs-selector-class">.name</span>}")
    }
}
</code></pre>
<h4 data-id="heading-5"><strong>二十六、结构化并发：避免资源泄漏</strong></h4>
<p>使用 <code>coroutineScope</code>实现结构化并发。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-comment">// 结构化并发：所有子协程完成后，父协程才完成</span>
    <span class="hljs-keyword">val</span> result = coroutineScope {
        <span class="hljs-keyword">val</span> userData = async { fetchUserData(<span class="hljs-number">1</span>) }
        <span class="hljs-keyword">val</span> userPosts = async { fetchUserPosts(<span class="hljs-number">1</span>) }
        
        <span class="hljs-string">"结果: <span class="hljs-subst">${userData.await()}</span> + <span class="hljs-subst">${userPosts.await()}</span>"</span>
    }
    println(result)
}

<span class="hljs-comment">// 处理异常的结构化并发</span>
<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fetchDataSafely</span><span class="hljs-params">()</span></span>: Result&lt;String&gt; = coroutineScope {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = async { 
            delay(<span class="hljs-number">500L</span>)
            <span class="hljs-keyword">if</span> (System.currentTimeMillis() % <span class="hljs-number">2</span> == <span class="hljs-number">0L</span>) {
                <span class="hljs-keyword">throw</span> RuntimeException(<span class="hljs-string">"模拟错误"</span>)
            }
            <span class="hljs-string">"获取的数据"</span>
        }.await()
        Result.success(<span class="hljs-keyword">data</span>)
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        Result.failure(e)
    }
}
</code></pre>
<h4 data-id="heading-6"><strong>二十七、流（Flow）：异步数据流</strong></h4>
<p>Flow 是 Kotlin 的响应式流处理，类似 RxJava。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*
<span class="hljs-keyword">import</span> kotlinx.coroutines.flow.*

<span class="hljs-comment">// 创建流</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">simpleFlow</span><span class="hljs-params">()</span></span>: Flow&lt;<span class="hljs-built_in">Int</span>&gt; = flow {
    println(<span class="hljs-string">"流开始"</span>)
    <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.3</span>) {
        delay(<span class="hljs-number">100L</span>) <span class="hljs-comment">// 模拟异步工作</span>
        emit(i) <span class="hljs-comment">// 发射值</span>
    }
}

<span class="hljs-comment">// 流的中间操作</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">processNumbers</span><span class="hljs-params">()</span></span>: Flow&lt;String&gt; = flow {
    <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.5</span>) {
        emit(i)
    }
}.filter { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> } <span class="hljs-comment">// 过滤偶数</span>
 .map { <span class="hljs-string">"数字: <span class="hljs-variable">$it</span>"</span> }    <span class="hljs-comment">// 转换</span>
 .onEach { println(<span class="hljs-string">"处理: <span class="hljs-variable">$it</span>"</span>) } <span class="hljs-comment">// 副作用</span>

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-comment">// 收集流</span>
    simpleFlow().collect { value -&gt; 
        println(<span class="hljs-string">"收集到: <span class="hljs-variable">$value</span>"</span>) 
    }
    
    println(<span class="hljs-string">"--- 带中间操作的流 ---"</span>)
    processNumbers().collect { println(<span class="hljs-string">"最终结果: <span class="hljs-variable">$it</span>"</span>) }
}
</code></pre>
<h4 data-id="heading-7"><strong>二十八、通道（Channel）：协程间通信</strong></h4>
<p>Channel 用于协程之间的通信。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*
<span class="hljs-keyword">import</span> kotlinx.coroutines.channels.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> channel = Channel&lt;String&gt;()
    
    <span class="hljs-comment">// 生产者协程</span>
    launch {
        <span class="hljs-keyword">val</span> users = listOf(<span class="hljs-string">"Alice"</span>, <span class="hljs-string">"Bob"</span>, <span class="hljs-string">"Charlie"</span>)
        <span class="hljs-keyword">for</span> (user <span class="hljs-keyword">in</span> users) {
            channel.send(user) <span class="hljs-comment">// 发送数据</span>
            delay(<span class="hljs-number">100L</span>)
        }
        channel.close() <span class="hljs-comment">// 关闭通道</span>
    }
    
    <span class="hljs-comment">// 消费者协程</span>
    launch {
        <span class="hljs-keyword">for</span> (user <span class="hljs-keyword">in</span> channel) { <span class="hljs-comment">// 接收数据</span>
            println(<span class="hljs-string">"收到用户: <span class="hljs-variable">$user</span>"</span>)
        }
        println(<span class="hljs-string">"通道已关闭"</span>)
    }
}
</code></pre>
<h4 data-id="heading-8"><strong>二十九、实战：构建完整的异步应用</strong></h4>
<p>让我们构建一个完整的用户信息获取系统。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*
<span class="hljs-keyword">import</span> kotlinx.coroutines.flow.*
<span class="hljs-keyword">import</span> kotlin.system.measureTimeMillis

<span class="hljs-comment">// 数据类</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> email: String)
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Post</span>(<span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> userId: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> title: String, <span class="hljs-keyword">val</span> content: String)
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserProfile</span>(<span class="hljs-keyword">val</span> user: User, <span class="hljs-keyword">val</span> posts: List&lt;Post&gt;, <span class="hljs-keyword">val</span> friends: List&lt;User&gt;)

<span class="hljs-comment">// 模拟远程数据源</span>
<span class="hljs-keyword">object</span> UserRepository {
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUser</span><span class="hljs-params">(id: <span class="hljs-type">Int</span>)</span></span>: User {
        delay(<span class="hljs-number">500L</span>) <span class="hljs-comment">// 模拟网络延迟</span>
        <span class="hljs-keyword">return</span> User(id, <span class="hljs-string">"用户<span class="hljs-variable">$id</span>"</span>, <span class="hljs-string">"user<span class="hljs-variable">$id</span>@example.com"</span>)
    }
    
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUserPosts</span><span class="hljs-params">(userId: <span class="hljs-type">Int</span>)</span></span>: List&lt;Post&gt; {
        delay(<span class="hljs-number">300L</span>)
        <span class="hljs-keyword">return</span> listOf(
            Post(<span class="hljs-number">1</span>, userId, <span class="hljs-string">"标题1"</span>, <span class="hljs-string">"内容1"</span>),
            Post(<span class="hljs-number">2</span>, userId, <span class="hljs-string">"标题2"</span>, <span class="hljs-string">"内容2"</span>)
        )
    }
    
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUserFriends</span><span class="hljs-params">(userId: <span class="hljs-type">Int</span>)</span></span>: List&lt;User&gt; {
        delay(<span class="hljs-number">400L</span>)
        <span class="hljs-keyword">return</span> listOf(
            User(userId + <span class="hljs-number">1</span>, <span class="hljs-string">"朋友1"</span>, <span class="hljs-string">"friend1@example.com"</span>),
            User(userId + <span class="hljs-number">2</span>, <span class="hljs-string">"朋友2"</span>, <span class="hljs-string">"friend2@example.com"</span>)
        )
    }
}

<span class="hljs-comment">// 业务逻辑层</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUserProfile</span><span class="hljs-params">(userId: <span class="hljs-type">Int</span>)</span></span>: UserProfile = coroutineScope {
        <span class="hljs-keyword">val</span> userDeferred = async { UserRepository.getUser(userId) }
        <span class="hljs-keyword">val</span> postsDeferred = async { UserRepository.getUserPosts(userId) }
        <span class="hljs-keyword">val</span> friendsDeferred = async { UserRepository.getUserFriends(userId) }
        
        UserProfile(
            user = userDeferred.await(),
            posts = postsDeferred.await(),
            friends = friendsDeferred.await()
        )
    }
    
    <span class="hljs-comment">// 使用 Flow 实现实时更新</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUserProfileStream</span><span class="hljs-params">(userId: <span class="hljs-type">Int</span>)</span></span>: Flow&lt;UserProfile&gt; = flow {
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            <span class="hljs-keyword">val</span> profile = getUserProfile(userId)
            emit(profile)
            delay(<span class="hljs-number">5000L</span>) <span class="hljs-comment">// 每5秒更新一次</span>
        }
    }
}

<span class="hljs-comment">// UI 层（模拟）</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> userService = UserService()
    
    println(<span class="hljs-string">"=== 获取用户资料 ==="</span>)
    <span class="hljs-keyword">val</span> time = measureTimeMillis {
        <span class="hljs-keyword">val</span> profile = userService.getUserProfile(<span class="hljs-number">1</span>)
        println(<span class="hljs-string">"用户: <span class="hljs-subst">${profile.user.name}</span>"</span>)
        println(<span class="hljs-string">"帖子数量: <span class="hljs-subst">${profile.posts.size}</span>"</span>)
        println(<span class="hljs-string">"好友数量: <span class="hljs-subst">${profile.friends.size}</span>"</span>)
    }
    println(<span class="hljs-string">"耗时: <span class="hljs-subst">${time}</span>ms"</span>)
    
    println(<span class="hljs-string">"\n=== 实时数据流 ==="</span>)
    <span class="hljs-comment">// 模拟实时数据流（只收集3次）</span>
    userService.getUserProfileStream(<span class="hljs-number">1</span>)
        .take(<span class="hljs-number">3</span>) <span class="hljs-comment">// 只取3个值</span>
        .collect { profile -&gt;
            println(<span class="hljs-string">"实时更新: <span class="hljs-subst">${profile.user.name}</span> - 帖子: <span class="hljs-subst">${profile.posts.size}</span>"</span>)
        }
}
</code></pre>
<h4 data-id="heading-9"><strong>三十、异常处理与超时控制</strong></h4>
<pre><code class="hljs language-scss" lang="scss">import kotlinx<span class="hljs-selector-class">.coroutines</span>.*

fun <span class="hljs-selector-tag">main</span>() = runBlocking {
    <span class="hljs-comment">// 1. 基本的异常处理</span>
    val job = launch {
        try {
            <span class="hljs-built_in">delay</span>(<span class="hljs-number">1000</span>L)
            throw <span class="hljs-built_in">RuntimeException</span>("测试异常")
        } catch (e: Exception) {
            <span class="hljs-built_in">println</span>("捕获异常: ${e.message}")
        }
    }
    job<span class="hljs-selector-class">.join</span>()
    
    <span class="hljs-comment">// 2. 协程异常处理器</span>
    val handler = CoroutineExceptionHandler { _, exception -&gt;
        <span class="hljs-built_in">println</span>("协程异常处理器捕获: ${exception.message}")
    }
    
    val job2 = <span class="hljs-built_in">launch</span>(handler) {
        throw <span class="hljs-built_in">RuntimeException</span>("被处理器捕获的异常")
    }
    job2<span class="hljs-selector-class">.join</span>()
    
    <span class="hljs-comment">// 3. 超时控制</span>
    try {
        <span class="hljs-built_in">withTimeout</span>(<span class="hljs-number">1300</span>L) {
            repeat(<span class="hljs-number">1000</span>) { <span class="hljs-selector-tag">i</span> -&gt;
                <span class="hljs-built_in">println</span>("任务 $i")
                <span class="hljs-built_in">delay</span>(<span class="hljs-number">500</span>L)
            }
        }
    } catch (e: TimeoutCancellationException) {
        <span class="hljs-built_in">println</span>("任务超时")
    }
    
    <span class="hljs-comment">// 4. 超时返回默认值</span>
    val result = <span class="hljs-built_in">withTimeoutOrNull</span>(<span class="hljs-number">1300</span>L) {
        <span class="hljs-built_in">delay</span>(<span class="hljs-number">1000</span>L)
        "成功结果"
    } ?: <span class="hljs-string">"超时默认值"</span>
    
    <span class="hljs-built_in">println</span>(<span class="hljs-string">"结果: $result"</span>)
}
</code></pre>
<h4 data-id="heading-10"><strong>三十一、高级模式：生产者-消费者模式</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*
<span class="hljs-keyword">import</span> kotlinx.coroutines.channels.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> CoroutineScope.<span class="hljs-title">produceUsers</span><span class="hljs-params">()</span></span> = produce {
    <span class="hljs-keyword">var</span> id = <span class="hljs-number">1</span>
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        send(User(id, <span class="hljs-string">"用户<span class="hljs-variable">$id</span>"</span>, <span class="hljs-string">"user<span class="hljs-variable">$id</span>@example.com"</span>))
        delay(<span class="hljs-number">200L</span>)
        id++
        <span class="hljs-keyword">if</span> (id &gt; <span class="hljs-number">5</span>) <span class="hljs-keyword">break</span> <span class="hljs-comment">// 只生产5个用户</span>
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> CoroutineScope.<span class="hljs-title">processUser</span><span class="hljs-params">(userChannel: <span class="hljs-type">ReceiveChannel</span>&lt;<span class="hljs-type">User</span>&gt;)</span></span> = produce {
    <span class="hljs-keyword">for</span> (user <span class="hljs-keyword">in</span> userChannel) {
        delay(<span class="hljs-number">100L</span>) <span class="hljs-comment">// 模拟处理时间</span>
        send(<span class="hljs-string">"已处理: <span class="hljs-subst">${user.name}</span>"</span>)
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> userProducer = produceUsers()
    <span class="hljs-keyword">val</span> processor = processUser(userProducer)
    
    <span class="hljs-comment">// 消费处理结果</span>
    <span class="hljs-keyword">for</span> (result <span class="hljs-keyword">in</span> processor) {
        println(result)
    }
    
    println(<span class="hljs-string">"处理完成"</span>)
}
</code></pre>
<h4 data-id="heading-11"><strong>下一步学习方向</strong></h4>
<p>你现在已经掌握了 Kotlin 协程的核心概念！接下来可以探索：</p>
<ol>
<li><strong>Flow 高级操作</strong>：<code>combine</code>、<code>zip</code>、<code>flatMapLatest</code>等操作符</li>
<li><strong>状态管理</strong>：使用 <code>StateFlow</code>和 <code>SharedFlow</code></li>
<li><strong>测试协程</strong>：使用 <code>TestCoroutineDispatcher</code>和 <code>runTest</code></li>
<li><strong>Android 上的协程</strong>：与 ViewModel、Lifecycle 集成</li>
<li><strong>服务端协程</strong>：Ktor 框架的使用</li>
</ol>
<p>协程是 Kotlin 生态中最强大的特性之一，它将彻底改变你处理异步编程的方式。尝试在实际项目中使用这些模式，你会发现代码变得更加简洁和易于维护！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[高质量动态代理池IP，到底怎么选才不踩坑？]]></title>    <link>https://juejin.cn/post/7568405112269864996</link>    <guid>https://juejin.cn/post/7568405112269864996</guid>    <pubDate>2025-11-04T07:42:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7568405112269864996" data-draft-id="7568416956041101366" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="高质量动态代理池IP，到底怎么选才不踩坑？"/> <meta itemprop="keywords" content="TCP/IP"/> <meta itemprop="datePublished" content="2025-11-04T07:42:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="召唤神龙"/> <meta itemprop="url" content="https://juejin.cn/user/640384299179028"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            高质量动态代理池IP，到底怎么选才不踩坑？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/640384299179028/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    召唤神龙
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-04T07:42:18.000Z" title="Tue Nov 04 2025 07:42:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近很多做数据采集、市场分析或者业务测试的朋友都在问，市面上那么多代理IP服务，到底哪家的动态代理池靠谱？用免费的吧，速度慢不说，还经常被封；随便买一个套餐，结果IP纯净度差、响应慢，白白浪费预算。其实，选对代理IP服务，关键不在于价格多低，而在于是否<strong>稳定、高匿、覆盖广</strong>。今天我们就结合实际使用体验，聊聊如何挑选高质量动态代理池IP，并针对常见业务场景做一次深度解析。</p>
<h2 data-id="heading-0">一、为什么你需要动态代理池？</h2>
<p>简单来说，动态代理池的核心价值在于“变化”和“稳定”的平衡。比如你在做数据采集，如果一直用同一个IP频繁请求，很容易被目标网站识别并封禁。而动态IP池可以在每次请求时自动更换IP，模拟不同地区真实用户的行为，大幅降低被封风险。高质量的代理池还会对IP进行实时检测，确保每一个IP都可用，避免工作中断。</p>
<p>需要注意的是，动态代理并非只是“不断换IP”，更重要的是IP的质量和覆盖范围。有些服务商虽然IP数量多，但大部分是重复或低效的，实际使用中频繁掉线，反而影响效率。</p>
<h2 data-id="heading-1">二、好用的动态代理池应具备哪些特点？</h2>
<p>根据实际业务需求，一个好的动态代理池至少应满足以下几点：</p>
<p><strong>1. 高可用率与响应速度：</strong>代理IP的可用率最好在99%以上，平均响应时间控制在毫秒级。例如有些服务如神龙HTTP，宣称可用率99.9%，响应迅速，这对高频采集或实时测试场景非常重要。</p>
<p><strong>2. 广泛的IP覆盖：</strong>IP池需覆盖国内多数城市，甚至细分到地区级。例如神龙IP代理覆盖200多个城市，能精准模拟多地网络环境，适合做区域化营销测试或数据采集。</p>
<p><strong>3. 高匿名性与安全性：</strong>代理IP应具备高匿名特性，不透露用户真实IP，同时传输协议需加密，避免数据泄露。一些服务商采用运营商正规授权IP，如神龙HTTP强调其IP资源来自三大运营商，合法合规，适合企业长期使用。</p>
<p><strong>4. 业务场景适配性：</strong>能否支持高并发、多协议（HTTP/HTTPS/SOCKS5等），以及是否提供定制解决方案，都是需要考虑的。例如有些服务商支持一对一技术定制，适合有特殊需求的企业用户。</p>
<h2 data-id="heading-2">三、实际场景中如何应用动态代理？</h2>
<p><strong>场景1：数据采集与爬虫</strong><br/>在做大规模数据抓取时，动态代理池能自动切换IP，避免IP被封。例如神龙HTTP提到可为大数据采集提供高去重代理方案，支持高并发请求，适合爬虫长时间运行。</p>
<p><strong>场景2：区域化营销测试</strong><br/>如果你需要测试不同地区用户对广告或搜索结果的反馈，可以用动态代理模拟多地IP。例如神龙IP代理支持精准定位城市，帮助分析地区用户偏好，优化营销策略。</p>
<p><strong>场景3：服务器性能测试</strong><br/>通过代理模拟多地区用户并发请求，测试服务器承载能力和响应延迟。有些服务如神龙IP代理支持定制带宽（6-15M），适合做负载测试和性能评估。</p>
<p><strong>场景4：AI训练与业务监控</strong><br/>动态代理能提供大量差异化IP，用于模型训练或业务监控。例如神龙HTTP称其IP池超3000万，能支持AI大模型训练所需的数据多样性。</p>
<h2 data-id="heading-3">四、常见问题答疑</h2>
<p><strong>问：动态代理和静态代理有什么区别？</strong><br/>动态代理IP会按一定频率自动更换，适合需要频繁切换IP的场景（如采集、测试）；静态代理IP长期不变，适合需要稳定IP的业务（如远程登录或固定身份场景）。</p>
<p><strong>问：代理IP的匿名级别有哪些？</strong><br/>一般分为透明代理、普通匿名代理和高匿名代理。高匿名代理完全不透露用户真实IP，推荐在业务中使用，以避免被识别。</p>
<p><strong>问：如何测试代理IP是否可用？</strong><br/>可通过在线工具或自写脚本检测IP的响应速度、匿名性和稳定性。建议选择提供免费测试的服务商，实际验证后再决定购买。</p>
<p><strong>问：企业用户选代理服务最该关注什么？</strong><br/>除了IP质量，还要看重服务商的技术支持、协议合规性和定制能力。最好选择能提供24小时技术支持、正规运营商资源的服务商，避免法律风险。</p>
<h2 data-id="heading-4">五、总结建议</h2>
<p>选择高质量动态代理池IP，不能光看价格或IP数量，更要结合业务需求综合判断。如果你是做企业级高频采集，需要高并发和稳定响应，可以优先考虑资源量大、支持定制的服务；如果侧重多地区模拟和营销测试，则要选择覆盖城市广、定位精准的服务。</p>
<p>无论用哪家服务，都建议先免费测试，体验实际速度与稳定性。毕竟代理IP是底层工具，选对了事半功倍，选错了全是坑。希望本文能帮你理清思路，找到适合的业务解决方案！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[安卓手机如何设置IP代理？手把手教你用起来]]></title>    <link>https://juejin.cn/post/7570896170920984639</link>    <guid>https://juejin.cn/post/7570896170920984639</guid>    <pubDate>2025-11-10T10:05:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570896170920984639" data-draft-id="7570598043298725951" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="安卓手机如何设置IP代理？手把手教你用起来"/> <meta itemprop="keywords" content="TCP/IP"/> <meta itemprop="datePublished" content="2025-11-10T10:05:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="召唤神龙"/> <meta itemprop="url" content="https://juejin.cn/user/640384299179028"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            安卓手机如何设置IP代理？手把手教你用起来
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/640384299179028/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    召唤神龙
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T10:05:21.000Z" title="Mon Nov 10 2025 10:05:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>
	很多使用安卓手机的朋友，可能都遇到过网络访问受限或者需要更换网络环境的情况。这时候，IP代理就能帮上大忙。它就像一个中转站，让你的网络请求通过它来转发，从而改变你的网络出口IP。这篇文章不会讲那些难懂的技术原理，就实实在在地教你，在安卓手机上怎么一步步把IP代理用起来，以及有哪些好用的服务可以选择。
</p>
<h2 data-id="heading-0">
	为什么需要在安卓手机上使用IP代理？
</h2>
<p>
	你可能会有疑问，我好好地用手机上网，为什么要折腾代理呢？其实原因很实际。比如，你做市场调研，需要查看不同地区的搜索结果；或者你是个手游爱好者，想体验不同服务器的游戏环境；又或者你需要更稳定、更私密的网络连接进行一些工作。在这些情况下，一个稳定可靠的IP代理就能派上用场，帮你解决实际问题。
</p>
<h2 data-id="heading-1">
	安卓手机设置IP代理的详细步骤
</h2>
<p>
	安卓系统本身提供了设置代理的功能，操作起来并不复杂。这里以常用的Wi-Fi网络为例，给你说明白：
</p>
<p>
	1.  首先打开手机的“设置”，找到“WLAN”选项并点击进入。
</p>
<p>
	2.  长按你当前已经连接上的Wi-Fi网络名称，会弹出一个菜单，选择“修改网络”。
</p>
<p>
	3.  在网络详情页面，找到“高级选项”，点击展开。
</p>
<p>
	4.  在“代理”这一栏，选择“手动”。
</p>
<p>
	5.  接下来就需要填入代理服务器的信息了：“代理服务器主机名”这里填提供给你的IP地址，“代理服务器端口”填对应的端口号。
</p>
<p>
	6.  如果需要用户名和密码认证，也一并填好，然后点击“保存”即可。
</p>
<p>
	这样，你的安卓手机通过这个Wi-Fi上网时，流量就会经过你设置的代理服务器了。需要注意的是，这种方法只对当前这个Wi-Fi网络生效，切换网络或者使用移动数据时就不起作用了。
</p>
<h2 data-id="heading-2">
	市面上有哪些靠谱的IP代理服务？
</h2>
<p>
	知道了怎么设置，关键还得有一个稳定好用的代理IP资源。市面上服务商很多，质量参差不齐，选择时需要仔细甄别。这里可以聊聊两种不同侧重点的服务类型，它们各自适合不同的使用场景。
</p>
<p>
	一类是像神龙HTTP这样的服务商，它更侧重于为企业和大数据应用提供支持。它拥有的IP资源量非常大，覆盖的城市也非常多，并且所有IP都获得了正规运营商的授权。这意味着它的连接非常稳定可靠，适合那些需要长时间、大规模、高并发处理网络任务的专业用户，比如大规模的数据采集、AI模型训练等场景。
</p>
<p>
	另一类比如神龙IP，它在网络加速和体验的流畅性上可能有其特点。它提供的IP资源纯净度高，连接速度很快，延迟低。这对于普通用户或者需要快速切换IP、对网络响应速度要求较高的场景比较友好，例如一些需要模拟不同地区用户行为的市场调研，或者对网络延迟敏感的应用测试等。
</p>
<p>
	选择时，你可以根据自己的主要用途——是偏向专业大型任务，还是更看重速度和便捷体验——来做出决定。最好先利用服务商提供的测试服务体验一下，看看实际效果是否符合预期。
</p>
<h2 data-id="heading-3">
	使用IP代理时，你可能会遇到这些问题
</h2>
<p>
	<strong>问：设置了代理之后，手机上网变慢了怎么办？</strong>
</p>
<p>
	答：这可能是代理服务器线路或负载导致的。可以尝试切换另一个代理IP节点，或者联系服务商检查线路质量。选择一个本身以高速低延迟为特点的服务可能会改善这一问题。
</p>
<p>
	<strong>问：为什么有时候代理会连接不上？</strong>
</p>
<p>
	答：原因可能有几个：一是代理IP失效了，需要换一个新的；二是你填写的端口号或认证信息有误；三是当前网络环境（比如公司网络）限制了代理端口的访问。逐一排查就能解决。
</p>
<p>
	<strong>问：使用IP代理安全吗？</strong>
</p>
<p>
	答：安全性取决于你选择的服务商。选择那些信誉好、采用高匿加密技术、承诺不记录用户活动日志的正规服务商，安全性是有保障的。务必远离来路不明的免费代理，它们可能有安全风险。
</p>
<p>
	<strong>问：除了全局代理，还有别的用法吗？</strong>
</p>
<p>
	答：是的。上述在Wi-Fi里设置的是全局代理，即手机所有App的流量都经过代理。你还可以在支持代理功能的特定App（如一些浏览器或爬虫框架）内部设置代理，这样只有该App的流量走代理，更加灵活。
</p>
<h2 data-id="heading-4">
	总结
</h2>
<p>
	在安卓手机上使用IP代理并不是一件复杂的事。核心步骤就是“获取靠谱的代理IP信息”和“在网络设置中正确填写”。关键是后续如何根据自己的实际需求，选择一个稳定、安全、高效的服务提供商，这直接决定了你的使用体验。希望这篇教程能帮你绕过坑洼，顺畅地用上这个工具，解决你遇到的实际问题。
</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MoonBit Pearls Vol.13: 使用 MoonBit 开发一个 HTTP 文件服务器]]></title>    <link>https://juejin.cn/post/7571662618054721562</link>    <guid>https://juejin.cn/post/7571662618054721562</guid>    <pubDate>2025-11-12T10:18:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571662618054721562" data-draft-id="7571644531608387630" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MoonBit Pearls Vol.13: 使用 MoonBit 开发一个 HTTP 文件服务器"/> <meta itemprop="keywords" content="后端,HTTP,服务器"/> <meta itemprop="datePublished" content="2025-11-12T10:18:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MoonBit"/> <meta itemprop="url" content="https://juejin.cn/user/3609050528885565"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MoonBit Pearls Vol.13: 使用 MoonBit 开发一个 HTTP 文件服务器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3609050528885565/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MoonBit
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T10:18:35.000Z" title="Wed Nov 12 2025 10:18:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">使用 MoonBit 开发一个 HTTP 文件服务器</h2>
<p>在这篇文章中，我将会介绍如何使用 MoonBit 的异步编程功能和 <code>moonbitlang/async</code> 库，编写一个简单的 HTTP 文件服务器。如果你之前接触过 Python 语言，那么你可能知道，Python 有一个非常方便的内建 HTTP 服务器模块。只需要运行 <code>python -m http.server</code>，就能在当期文件夹启动一个文件服务器，用于局域网文件共享等用途。
在这篇文章中，我们将用 MoonBit 实现一个类似功能的程序，并借此了解 MoonBit 的异步编程支持。我们还将额外支持一个 <code>python -m http.server</code> 没有的实用功能：把整个文件夹打包成 <code>zip</code> 文件下载。</p>
<h3 data-id="heading-1">异步编程简史</h3>
<p>异步编程，能让程序具有同时处理多项任务的能力。例如，对于一个文件服务器来说，可能会有多个用户同时访问这个服务器，而服务器需要同时服务所有用户，让它们的体验尽可能流畅、低延时。在典型的异步程序，例如服务器中，每项任务的大部分时间都花在等待 IO 上，实际的计算时间占比较低。因此，我们并不需要很多的计算资源，也能同时处理大量任务。而这其中的诀窍，就是频繁地在多个任务之间切换：
如果某项任务开始等待 IO，那么就不要继续处理它，而是马上切换到不需要等待的任务上。</p>
<p>过去，异步程序往往是通过多线程的方式实现的：每项任务对应一个操作系统的线程。
然而，操作系统线程需要占用较多资源，而且在线程之间切换开销较大。
因此，进入 21 世纪后，实现异步程序的主要方式变成了<em>事件循环</em>。
整个异步程序的形态是一个巨大的循环，每次循环中，
程序检查哪些 IO 操作已经完成，然后运行那些等待着这些已完成的 IO 操作的任务，
直到它们发起下一次 IO 请求，重新进入等待状态。
在这种编程范式中，任务间的切换发生在同一个用户态的线程里，因此开销极低。</p>
<p>然而，手写事件循环是一件非常痛苦的事情。
因为同一个任务的代码会被拆散到多次不同的循环中执行，程序的逻辑变得不连贯了。
因此，基于事件循环的程序非常难编写和调试。
幸运的是，就像大部分其他现代编程语言一样，MoonBit 提供了原生的异步编程支持。
用户可以像写同步程序一样写异步代码，MoonBit 会自动把异步代码切分成不同的部分。
而 <code>moonbitlang/async</code> 库则提供了事件循环和各种 IO 原语的实现，负责把异步代码运行起来。</p>
<h3 data-id="heading-2">MoonBit 中的异步编程</h3>
<p>在 MoonBit 中，可以用 <code>async fn</code> 语法来声明一个异步函数。
异步函数看上去和同步函数完全一样，只不过它们在运行时可能在中途被打断，
一段时间后才继续恢复运行，从而实现多个任务间的切换。
在异步函数中可以正常使用循环等控制流构造，MoonBit 编译器会自动将它们变成异步的样子。</p>
<p>和许多其他语言不同，在调用异步函数时，MoonBit 不需要用 <code>await</code> 之类的特殊语法标记，
编译器会自动推断出哪些函数调用是异步的。
不过，如果你使用带有 MoonBit 支持的 IDE 或文本编辑器查看代码，
就会看到异步函数调用被渲染成了斜体、可能抛出错误的函数调用带有下划线。
因此，阅读代码时，依然可以一眼就找到所有异步的函数调用。</p>
<p>对于异步程序来说，另一个必不可少的组件是事件循环、任务调度和各种 IO 原语的实现。
这一点在 MoonBit 中是通过 <code>moonbitlang/async</code> 库实现的。
<code>moonbitlang/async</code> 库中提供了网络IO、文件IO、进程创建等异步操作的支持，
以及一系列管理异步编程任务的 API。
接下来，我们将会在编写 HTTP 文件服务器的途中介绍 <code>moonbitlang/async</code> 的各种功能。</p>
<h3 data-id="heading-3">HTTP 服务器的骨架</h3>
<p>典型的 HTTP 服务器的结构是：</p>
<ul>
<li>服务器监听一个 TCP 端口，等待来自用户的连接请求</li>
<li>接受来自用户的 TCP 连接后，服务器从 TCP 连接中读取用户的请求，处理用户的请求并将结果发回给用户</li>
</ul>
<p>这里的每一项任务，都应该异步地进行：
在处理第一个用户的请求时，服务器仍应不断等待新的连接，并第一时间响应下一个用户的连接请求。
如果有多个用户同时连接到服务器，服务器应该同时处理所有用户的请求。
在这个过程中，所有可能耗费较多时间的操作，例如网络 IO 和文件 IO，都应该是异步的，
它们不应该阻塞程序、影响其他任务的处理。</p>
<p>在 <code>moonbitlang/async</code> 中，有一个辅助函数 <code>@http.run_server</code>，
能够绑我们自动完成上述工作，搭建一个 HTTP 服务器并运行它：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">server_main</span>(path~ : <span class="hljs-type">String</span>, port~ : Int) <span class="hljs-punctuation">-&gt;</span> Unit {
  @http.<span class="hljs-title function_ invoke__">run_server</span>(@socket.Addr::<span class="hljs-title function_ invoke__">parse</span>(<span class="hljs-string">"[::]:\{port}"</span>), <span class="hljs-title function_ invoke__">fn</span> (conn, addr) {
    @pipe.stderr.<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-string">"received new connection from \{addr}\n"</span>)
    <span class="hljs-title function_ invoke__">handle_connection</span>(path, conn)
  })
}
</code></pre>
<p><code>server_main</code> 接受两个参数，其中，
<code>path</code> 是文件服务器工作的路径，<code>port</code> 是服务器监听的端口。
在 <code>moonbitlang/async</code> 中，一切异步代码都是可以取消的，
而异步代码被取消时会抛出错误，所以所有异步函数都会抛出错误。
因此，在 MoonBit 中，<code>async fn</code> 默认就会抛出错误，无需再显式标注 <code>raise</code>。</p>
<p>在 <code>server_main</code> 中，我们使用 <code>@http.run_server</code> 创建了一个 HTTP 服务器并运行它。
<code>@http</code> 是 <code>moonbitlang/async</code> 中提供 HTTP 解析等支持的包 <code>moonbitlang/async/http</code> 的别名，
<code>@http.run_server</code> 的第一个参数是服务器要监听的地址。
这里我们提供的地址是 <code>[::]:port</code>，
这表示监听端口 <code>port</code>、接受来自任何网络接口的连接请求。
<code>moonbitlang/async</code> 有原生的 IPv4/IPv6 双栈支持，因此这里的服务器可以同时接受 IPv4 连接和 IPv6 连接。
<code>@http.run_server</code> 的第二个参数是一个回调函数，用于处理来自用户的连接。
回调函数会接受两个参数，第一个是来自用户的连接，
类型是 <code>@http.ServerConnection</code>，由 <code>@http.run_server</code> 自动获取并创建。
第二个参数是用户的网络地址。
这里，我们使用 <code>handle_connection</code> 函数来处理用户的请求，这个函数的实现将在稍后给出。
<code>@http.run_server</code> 会自动创建一个并行的任务，并在其中运行 <code>handle_connection</code>。
因此，服务器可以同时运行多份 <code>handle_connection</code>、处理多个连接。</p>
<h3 data-id="heading-4">处理用户来自用户的请求</h3>
<p>接下来，我们开始实现实际处理用户请求的 <code>handle_connection</code> 函数。
<code>handle_connection</code> 接受两个参数，<code>base_path</code> 是文件服务器处理的路径，
而 <code>conn</code> 是来自用户的连接。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">handle_connection</span>(
  base_path : <span class="hljs-type">String</span>,
  conn : @http.ServerConnection,
) <span class="hljs-punctuation">-&gt;</span> Unit {
  <span class="hljs-keyword">for</span> {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">request</span> = conn.<span class="hljs-title function_ invoke__">read_request</span>()
    conn.<span class="hljs-title function_ invoke__">skip_request_body</span>()
    guard request.meth is Get <span class="hljs-keyword">else</span> {
      conn
      ..<span class="hljs-title function_ invoke__">send_response</span>(<span class="hljs-number">501</span>, <span class="hljs-string">"Not Implemented"</span>)
      ..<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-string">"This request is not implemented"</span>)
      ..<span class="hljs-title function_ invoke__">end_response</span>()
    }
    <span class="hljs-keyword">let</span> (path, download_zip) = <span class="hljs-keyword">match</span> request.path {
      [ ..path, ..<span class="hljs-string">"?download_zip"</span> ] =&gt; (path.<span class="hljs-title function_ invoke__">to_string</span>(), <span class="hljs-literal">true</span>)
      path =&gt; (path, <span class="hljs-literal">false</span>)
    }
    <span class="hljs-keyword">if</span> download_zip {
      <span class="hljs-title function_ invoke__">serve_zip</span>(conn, base_path + path)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">file</span> = @fs.<span class="hljs-title function_ invoke__">open</span>(base_path + path, mode=ReadOnly) catch {
        _ =&gt; {
          conn
          ..<span class="hljs-title function_ invoke__">send_response</span>(<span class="hljs-number">404</span>, <span class="hljs-string">"NotFound"</span>)
          ..<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-string">"File not found"</span>)
          ..<span class="hljs-title function_ invoke__">end_response</span>()
          <span class="hljs-keyword">continue</span>
        }
      }
      defer file.<span class="hljs-title function_ invoke__">close</span>()
      <span class="hljs-keyword">if</span> file.<span class="hljs-title function_ invoke__">kind</span>() is Directory {
        <span class="hljs-keyword">if</span> download_zip {
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-title function_ invoke__">serve_directory</span>(conn, file.<span class="hljs-title function_ invoke__">as_dir</span>(), path~)
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_ invoke__">server_file</span>(conn, file, path~)
      }
    }
  }
}
</code></pre>
<p>在 <code>handle_connection</code> 中，程序通过一个大循环来不断从连接中读取用户请求并处理。
每次循环中，我们首先通过 <code>conn.read_request()</code> 读取一个来自用户的请求。
<code>conn.read_request()</code> 只会读取 HTTP 请求的头部，这是为了允许用户流式地读取较大的 body。
由于我们的文件服务器只处理 <code>Get</code> 请求，我们不需要请求的 body 中包含任何信息。
因此，我们通过 <code>conn.skip_body()</code> 跳过用户请求的 body，以保证下一个请求的内容可以被正确读取。</p>
<p>接下来，如果遇到不是 <code>Get</code> 的请求，<code>guard</code> 语句的 <code>else</code> 块会被执行，
此时，<code>guard</code> 语句后面的代码会被跳过，我们可以进入下一次循环、处理下一个请求。
在 <code>else</code> 块中，通过 <code>conn.send_response(..)</code> 向用户发送一个 “不支持该请求” 的回复。
<code>conn.send_response(..)</code> 会发送回复的头部，这之后，我们用 <code>conn.write(..)</code> 向连接写入回复的主体内容。
在写完所有内容后，我们需要用 <code>conn.end_response()</code> 来表明已经写完了回复的所有内容。</p>
<p>这里，我们希望实现一个 <code>python -m http.server</code> 中没有的实用功能：
以 zip 的形式下载整个文件夹。
如果用户请求的 URL 的形式是 <code>/path/to/directory?download_zip</code>，
我们就把 <code>/path/to/directory</code> 打包成 <code>.zip</code> 文件发送给用户。
这一功能是通过 <code>serve_zip</code> 函数来实现的。</p>
<p>由于我们实现的是一个文件服务器，
用户的 <code>GET</code> 请求中指定的路径会直接映射到 <code>base_path</code> 下对应的路径。
<code>@fs</code> 是 <code>moonbitlang/async</code> 中提供文件 IO 支持的包 <code>moonbitlang/async/fs</code> 的别名。
这里我们使用 <code>@fs.open</code> 打开对应的文件。
如果打开文件失败了，我们向用户发送一个 404 回复，告诉用户这个文件不存在。</p>
<p>如果用户请求的文件是存在的，那么我们需要把文件发送给用户。
当然，在此之前，别忘了用 <code>defer file.close()</code> 保证 <code>file</code> 占用的资源被及时释放。
通过 <code>file.kind()</code>，我们可以获得文件的种类。
在文件服务器中，如果用户请求的路径是一个文件夹，我们需要进行特殊的处理。
因为文件夹不能直接被发送给用户，我们需要根据文件夹的内容，
向用户返回一个 HTML 页面，让用户可以从页面看到文件夹里有哪些文件，并通过点击跳转到对应的页面。
这部分功能通过函数 <code>serve_directory</code> 提供。
如果用户请求的是一个普通文件，那么直接将文件的内容传输给用户即可。
这部分功能通过函数 <code>serve_file</code> 来实现。</p>
<p>向用户发送一个普通文件的代码如下：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">server_file</span>(
  conn : @http.ServerConnection,
  file : @fs.File,
  path~ : <span class="hljs-type">String</span>,
) <span class="hljs-punctuation">-&gt;</span> Unit {
  <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">content_type</span> = <span class="hljs-keyword">match</span> path {
    [.., .. <span class="hljs-string">".png"</span>] =&gt; <span class="hljs-string">"image/png"</span>
    [.., .. <span class="hljs-string">".jpg"</span>] | <span class="hljs-string">"jpeg"</span> =&gt; <span class="hljs-string">"image/jpeg"</span>
    [.., .. <span class="hljs-string">".html"</span>] =&gt; <span class="hljs-string">"text/html"</span>
    [.., .. <span class="hljs-string">".css"</span>] =&gt; <span class="hljs-string">"text/css"</span>
    [.., .. <span class="hljs-string">".js"</span>] =&gt; <span class="hljs-string">"text/javascript"</span>
    [.., .. <span class="hljs-string">".mp4"</span>] =&gt; <span class="hljs-string">"video/mp4"</span>
    [.., .. <span class="hljs-string">".mpv"</span>] =&gt; <span class="hljs-string">"video/mpv"</span>
    [.., .. <span class="hljs-string">".mpeg"</span>] =&gt; <span class="hljs-string">"video/mpeg"</span>
    [.., .. <span class="hljs-string">".mkv"</span>] =&gt; <span class="hljs-string">"video/x-matroska"</span>
    _ =&gt; <span class="hljs-string">"appliaction/octet-stream"</span>
  }
  conn
  ..<span class="hljs-title function_ invoke__">send_response</span>(<span class="hljs-number">200</span>, <span class="hljs-string">"OK"</span>, extra_headers={ <span class="hljs-string">"Content-Type"</span>: content_type })
  ..<span class="hljs-title function_ invoke__">write_reader</span>(file)
  ..<span class="hljs-title function_ invoke__">end_response</span>()
}
</code></pre>
<p>这里，在 HTTP 回复中，我们根据文件的后缀名填入了不同的 <code>Content-Type</code> 字段。
这样一来，用户在浏览器中打开图片/视频/HTML 文件时，就可以直接预览文件的内容，
而不需要先下载文件再在本地打开。
对于其他文件，<code>Content-Type</code> 字段的值会是 <code>application/octet-stream</code>，
这会让浏览器自动将文件下载到本地。</p>
<p>我们依然使用 <code>conn.send_response</code> 来用户发送回复。
通过 <code>extra_headers</code> 字段我们可以在回复中加入额外的 HTTP header。
回复的主体则是文件的内容。
这里，<code>conn.write_reader</code> 会自动流式地把 <code>file</code> 的内容发送给用户。
假设用户请求了一个视频文件并在浏览器中播放，
如果我们先把整个视频文件读到内存中再发送给用户，
那么用户需要等服务器读入整个视频文件之后才能收到回复，服务器的响应速度会变慢。
而且，读入整个视频文件会浪费大量的内存。
而通过使用 <code>write_reader</code>，<code>@http.ServerConnection</code> 会自动把文件内容切成小块分段发送，
用户马上就能看到视频开始播放，占用的内存也会大大减少。</p>
<p>接下来，让我们实现显示文件夹的函数 <code>serve_directory</code>：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">serve_directory</span>(
  conn : @http.ServerConnection,
  dir : @fs.Directory,
  path~ : <span class="hljs-type">String</span>,
) <span class="hljs-punctuation">-&gt;</span> Unit {
  <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">files</span> = dir.<span class="hljs-title function_ invoke__">read_all</span>()
  files.<span class="hljs-title function_ invoke__">sort</span>()
  conn
  ..<span class="hljs-title function_ invoke__">send_response</span>(<span class="hljs-number">200</span>, <span class="hljs-string">"OK"</span>, extra_headers={ <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"text/html"</span> })
  ..<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-string">"&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;"</span>)
  ..<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-string">"&lt;h1&gt;\{path}&lt;/h1&gt;\n"</span>)
  ..<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-string">"&lt;div style=\"margin: 1em; font-size: 15pt\"&gt;\n"</span>)
  ..<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-string">"&lt;a href=\"\{path}?download_zip\"&gt;download as zip&lt;/a&gt;&lt;br/&gt;&lt;br/&gt;\n"</span>)
  <span class="hljs-keyword">if</span> path[:-<span class="hljs-number">1</span>].<span class="hljs-title function_ invoke__">rev_find</span>(<span class="hljs-string">"/"</span>) is <span class="hljs-title function_ invoke__">Some</span>(index) {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">parent</span> = <span class="hljs-keyword">if</span> index == <span class="hljs-number">0</span> { <span class="hljs-string">"/"</span> } <span class="hljs-keyword">else</span> { path[:index].<span class="hljs-title function_ invoke__">to_string</span>() }
    conn.<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-string">"&lt;a href=\"\{parent}\"&gt;..&lt;/a&gt;&lt;br/&gt;&lt;br/&gt;\n"</span>)
  }
  <span class="hljs-keyword">for</span> <span class="hljs-variable">file</span> <span class="hljs-keyword">in</span> files {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">file_url</span> = <span class="hljs-keyword">if</span> path[path.<span class="hljs-title function_ invoke__">length</span>() - <span class="hljs-number">1</span>] != <span class="hljs-string">'/'</span> {
      <span class="hljs-string">"\{path}/\{file}"</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-string">"\{path}\{file}"</span>
    }
    conn.<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-string">"&lt;a href=\"\{file_url}\"&gt;\{file}&lt;/a&gt;&lt;br/&gt;\n"</span>)
  }
  conn
  ..<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-string">"&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;"</span>)
  ..<span class="hljs-title function_ invoke__">end_response</span>()
}
</code></pre>
<p>这里，我们首先读入文件夹中的文件列表并对它们进行排序。
接下来，我们根据文件夹的内容，拼出一段 HTML 页面。
HTML 页面的主体内容是文件夹中的文件，
每个文件对应一个链接，上面显示着文件名，点击链接就能跳转到对应的文件。
这里，我们通过 HTML 的 <code>&lt;a&gt;</code> 元素来实现这一点。
如果文件夹不是根目录，那么我们在页面开头放上一个特殊的链接 <code>..</code>，点击它会跳转到上一级目录。
此外，页面里还有一个 <code>download as zip</code> 的链接，
点击这个链接就能把当前文件夹打包成 <code>zip</code> 后下载。</p>
<h3 data-id="heading-5">实现将文件夹打包成 zip 的功能</h3>
<p>接下来，我们实现将文件夹打包成 <code>zip</code> 提供给用户的功能。
这里，简单起见，我们使用系统的 <code>zip</code> 命令。
<code>serve_zip</code> 函数的实现如下：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">serve_zip</span>(
  conn : @http.ServerConnection,
  path : <span class="hljs-type">String</span>,
) <span class="hljs-punctuation">-&gt;</span> Unit {
  <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">full_path</span> = @fs.<span class="hljs-title function_ invoke__">realpath</span>(path)
  <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">zip_name</span> = <span class="hljs-keyword">if</span> full_path[:].<span class="hljs-title function_ invoke__">rev_find</span>(<span class="hljs-string">"/"</span>) is <span class="hljs-title function_ invoke__">Some</span>(i) {
    full_path[i+<span class="hljs-number">1</span>:].<span class="hljs-title function_ invoke__">to_string</span>()
  } <span class="hljs-keyword">else</span> {
    path
  }
  @<span class="hljs-keyword">async</span>.<span class="hljs-title function_ invoke__">with_task_group</span>(<span class="hljs-title function_ invoke__">fn</span>(group) {
    <span class="hljs-keyword">let</span> (we_read_from_zip, zip_write_to_us) = @process.<span class="hljs-title function_ invoke__">read_from_process</span>()
    defer we_read_from_zip.<span class="hljs-title function_ invoke__">close</span>()
    group.<span class="hljs-title function_ invoke__">spawn_bg</span>(<span class="hljs-title function_ invoke__">fn</span>() {
      <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">exit_code</span> = @process.<span class="hljs-title function_ invoke__">run</span>(
        <span class="hljs-string">"zip"</span>,
        [ <span class="hljs-string">"-q"</span>, <span class="hljs-string">"-r"</span>, <span class="hljs-string">"-"</span>, path ],
        stdout=zip_write_to_us,
      )
      <span class="hljs-keyword">if</span> exit_code != <span class="hljs-number">0</span> {
        <span class="hljs-title function_ invoke__">fail</span>(<span class="hljs-string">"zip failed with exit code \{exit_code}"</span>)
      }
    })
    conn
    ..<span class="hljs-title function_ invoke__">send_response</span>(<span class="hljs-number">200</span>, <span class="hljs-string">"OK"</span>, extra_headers={
      <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/octet-stream"</span>,
      <span class="hljs-string">"Content-Disposition"</span>: <span class="hljs-string">"filename=\{zip_name}.zip"</span>,
    })
    ..<span class="hljs-title function_ invoke__">write_reader</span>(we_read_from_zip)
    ..<span class="hljs-title function_ invoke__">end_response</span>()
  })
}
</code></pre>
<p>在 <code>serve_zip</code> 函数的开头，我们首先计算了用户下载的 <code>.zip</code> 文件的文件名。
接下来，我们使用 <code>@async.with_task_group</code> 创建了一个新的任务组。
任务组是 <code>moonbitlang/async</code> 中用于管理异步任务的核心构造，
所有异步任务都必须在一个任务组中创建。
在介绍 <code>with_task_group</code> 之前，让我们先看看 <code>serve_zip</code> 剩下的内容。
首先，我们使用 <code>@process.read_from_process()</code> 创建了一个临时管道，
从管道的一端写入的数据可以从另一侧读出，因此它可以用于读取一个进程的输出。
这里我们把管道的写入端 <code>zip_write_to_us</code> 会被提供给 <code>zip</code> 命令，用于写入压缩的结果。
而我们将从管道的读入端 <code>we_read_from_zip</code> 读取 <code>zip</code> 命令的输出，并将其发送给用户。</p>
<p>接下来，我们在新的任务组中创建了一个单独的任务，
并在其中使用 <code>@process.run</code> 运行 <code>zip</code> 命令。
<code>@process</code> 是 <code>moonbitlang/async/process</code> 的别名，
是 <code>moonbitlang/async</code> 中提供调用外部进程功能的包。
我们向 <code>zip</code> 传递的参数的意义是：</p>
<ul>
<li><code>-q</code>：不要输出日志信息</li>
<li><code>-r</code>：递归压缩整个文件夹</li>
<li><code>-</code>：把结果写入到 <code>stdout</code></li>
<li><code>path</code>：要压缩的文件夹</li>
</ul>
<p>在调用 <code>@process.run</code> 时，我们通过 <code>stdout=zip_write_to_us</code>，
把 <code>zip</code> 命令的 <code>stdout</code> 重定向到了 <code>zip_write_to_us</code>，以获取 <code>zip</code> 的输出。
相比创建一个临时文件，这么做有两个好处：</p>
<ul>
<li>和 <code>zip</code> 间的数据传递完全在内存中进行，不需要进行低效的磁盘 IO</li>
<li><code>zip</code> 一边压缩，我们可以一边像用户发送已经压缩好的部分，效率更高</li>
</ul>
<p><code>@process.run</code> 会等待 <code>zip</code> 结束运行，并返回 <code>zip</code> 命令的状态码。
如果 <code>zip</code> 的返回值不是 <code>0</code>，说明 <code>zip</code> 失败了，我们抛出一个错误。</p>
<p>在调用 <code>zip</code> 的同时，我们继续使用 <code>conn.send_response(..)</code> 向用户发送回复信息。
接下来，我们用 <code>conn.write_reader(we_read_from_zip)</code> 把 <code>zip</code> 的输出发送给用户。
<code>Content-Disposition</code> 这一 HTTP header 能让我们指定用户下载的 <code>zip</code> 文件的名字。</p>
<p>到这里，一切看上去都很合理。
但为什么这里要创建一个新的任务组呢？为什么不能直接提供创建新任务的 API 呢？
在编写异步程序时，有一个现象：
写出在正确时行为正确的程序比较容易，但写出在出错时依然行为正确的程序很难。
比如，对于 <code>serve_zip</code> 这个例子：</p>
<ul>
<li>如果 <code>zip</code> 命令失败了我们应该怎么办？</li>
<li>如果数据发送到一半发生了网络错误，或者用户关闭了连接，应该怎么办？</li>
</ul>
<p>如果 <code>zip</code> 命令失败了，那么整个 <code>serve_zip</code> 函数也应该失败。
由于此时用户可能已经收到了一部分不完整的数据，我们很难再把连接恢复到正常状态，
只能关闭把整个连接。
如果数据发送到一半发生了网络错误，那么我们应该停止 <code>zip</code> 的运行。
因为此时 <code>zip</code> 的结果已经没有用了，让它继续运行只是在浪费资源。
而且在最坏的情况下，由于我们不再读取 <code>zip</code> 的输出，和 <code>zip</code> 通信用的管道可能会被填满，
此时，<code>zip</code> 可能会永远阻塞在向管道写入的操作上，变成一个僵尸进程。</p>
<p>在上面的代码中，我们没有显式地写任何错误处理逻辑，
但是，在出现上述错误时，我们的程序的行为却是符合预期的，
而魔法就在于 <code>@async.with_task_group</code> 的语义，及其背后的 <strong>结构化并发</strong> 范式。
<code>@async.with_task_group(f)</code> 的大致语义如下：</p>
<ul>
<li>它会创建一个新的任务组 <code>group</code>，并运行 <code>f(group)</code></li>
<li><code>f</code> 可以通过 <code>group.spawn_bg(..)</code> 等函数在 <code>group</code> 中创建新的任务</li>
<li>只有当 <code>group</code> 中的所有任务都完成时，<code>with_task_group</code> 才会返回</li>
<li><strong>如果 <code>group</code> 中的任何一个任务失败了，那么 <code>with_task_group</code> 也会失败，<code>group</code> 中的其他任务会被自动取消</strong></li>
</ul>
<p>这里的最后一条，就是保证正确错误处理的行为的关键：</p>
<ul>
<li>如果调用 <code>zip</code> 的任务失败了，那么错误会传播到整个任务组。
向用户发送回复的主任务会自动被取消，
然后错误会通过 <code>with_task_group</code> 自动向上传播，关闭连接</li>
<li>如果发送回复的主任务失败了，错误同样会传播到整个任务组。
此时 <code>@process.run</code> 会被取消，此时它会自动向 <code>zip</code> 发送终止信号，结束 <code>zip</code> 的运行</li>
</ul>
<p>因此，在使用 <code>moonbitlang/async</code> 编写异步程序时，
只需要根据程序的结构在适当的位置插入任务组，
剩下的错误处理的所有细节，都会由 <code>with_task_group</code> 自动解决。
这正是 <code>moonbitlang/async</code> 使用的结构化并发范式的威力：通过编程范式的引导，
它能让我们写出结构更清晰的异步程序，并以一种润物细无声的方式，
让异步程序在出错时也能有正确的行为。</p>
<h3 data-id="heading-6">让服务器跑起来</h3>
<p>至此，整个 HTTP 服务器的所有内容都已实现完毕，我们可以运行这个服务器了。
MoonBit 对异步代码有原生支持，可以直接用 <code>async fn main</code> 定义异步程序的入口，
或是用 <code>async test</code> 直接测试异步代码。
这里，我们让 HTTP 服务器运行在当前目录、向用户提供当前目录下的文件，并让它监听 8000 端口：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">async</span> test {
  <span class="hljs-title function_ invoke__">server_main</span>(path=<span class="hljs-string">"."</span>, port=<span class="hljs-number">8000</span>)
}
</code></pre>
<p>通过 <code>moon test moonbit_http_server.mbt.md</code> 运行这份文档的源码，
并在浏览器中打开 <code>http://127.0.0.1:8000</code>，即可使用我们实现的文件服务器。</p>
<p>关于 <code>moonbitlang/async</code> 的更多功能，可以参考它的
<a href="https://link.juejin.cn?target=https%3A%2F%2Fmooncakes.io%2Fdocs%2Fmoonbitlang%2Fasync" target="_blank" title="https://mooncakes.io/docs/moonbitlang/async" ref="nofollow noopener noreferrer">API 文档</a>
和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoonbitlang%2Fasync" target="_blank" title="https://github.com/moonbitlang/async" ref="nofollow noopener noreferrer">GitHub repo</a>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MoonBit Pearls Vol.14：哈希表避坑指南]]></title>    <link>https://juejin.cn/post/7571594817224327219</link>    <guid>https://juejin.cn/post/7571594817224327219</guid>    <pubDate>2025-11-12T10:22:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571594817224327219" data-draft-id="7571655312798695450" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MoonBit Pearls Vol.14：哈希表避坑指南"/> <meta itemprop="keywords" content="后端,算法,编程语言"/> <meta itemprop="datePublished" content="2025-11-12T10:22:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MoonBit"/> <meta itemprop="url" content="https://juejin.cn/user/3609050528885565"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MoonBit Pearls Vol.14：哈希表避坑指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3609050528885565/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MoonBit
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T10:22:42.000Z" title="Wed Nov 12 2025 10:22:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>谁不喜欢哈希表呢？</p>
<p>它能以快如闪电的平均 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span> 访问速度<sup>*</sup> 联系键值对，
而你只需要提供两样东西：一个比较相等的函数和一个哈希函数，就这么简单。
这一独特的性质使得哈希表在效率上常常优于其他关联性数据结构（如搜索树）。
因此，哈希表现已成为编程语言中使用最广泛的数据结构之一。</p>
<p>从 Python 中平平无奇的 <code>dict</code>，到数据库和分布式系统，
再到 JavaScript 对象，哈希表无处不在。
它们支撑着数据库的索引系统，实现了高效的缓存机制，
并构成了 Web 框架请求路由的骨干。
现代编译器用它们来管理符号表，操作系统靠它们来进行进程管理，
几乎每一个 Web 应用都用它们来维护用户状态。</p>
<p>无论你是在构建 Web 服务器、解析 JSON，
还是在处理配置文件，亦或只是统计词频，
你都很可能会用到哈希表。
它们已经变得如此基础，以至于许多开发者都将它们 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span> 的魔法视为理所当然——
<em>但你有没有想过，这个 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span> 的理所当然<sup>*</sup>到底是什么呢？</em></p>
<h2 data-id="heading-0">哈希表的内部构造</h2>
<p>一个哈希表由两部分组成：
一个桶数组和一个哈希函数。</p>
<pre><code class="hljs language-mbt" lang="mbt">struct MyHashMap[K, V] {
  buckets : Array[Bucket[K, V]]
  hash_fn : (K) -&gt; UInt
}
</code></pre>
<p><strong>桶数组</strong>包含了一系列所谓的"桶"。
每个桶都存储着我们插入的一些数据。</p>
<p><strong>哈希函数</strong> <code>H</code> 会为每个键（key）关联一个整数。
这个整数被用来在桶数组中寻找一个索引位置，以存储我们的值。
这个索引通常是通过将该整数与桶数组的大小进行取模运算得出的，
即 <code>index = H(key) % bucket_array_size</code>。
哈希表期望这个函数满足两个重要性质：</p>
<ol>
<li>
<p>相同的键总是被转换成相同的数字。即，若 <code>a == b</code>，则 <code>H(a) == H(b)</code>。</p>
<p>这个性质确保了，
我们用某个键存入数据后，
下次还能用同一个键准确地找到原来的位置。</p>
</li>
<li>
<p>对于不同的键，哈希函数产生的结果会尽可能均匀地分布在所有可能的结果空间中。</p>
<p>这个性质确保了不同的键会大概率被转换到不同的整数值，
因此不太可能被映射到同一个桶中，
从而保证了检索的效率。</p>
</li>
</ol>
<p>现在你可能会问，如果两个键被映射到了同一个桶，会发生什么呢？
那我们就不得不提哈希冲突了。</p>
<h2 data-id="heading-1">哈希冲突</h2>
<p>当两个键的哈希值相同时，
或者更广义地说，当两个键被映射到同一个桶时，
就发生了哈希冲突。</p>
<p>由于哈希表的一切决策都基于哈希值（或桶索引），
这两个键在哈希表看来就变得一模一样了——
它们应该被放在同一个地方，
但它们本身又并不相等，所以不能互相覆盖。</p>
<p>哈希表的设计者们有几种策略来处理冲突，
这些策略大致可分为两类：</p>
<ul>
<li>
<p><strong>链地址法</strong>将这些冲突的键放在同一个桶里。
现在，每个桶可能包含多个键的数据，而不仅仅是一个。
当查找一个冲突的键时，
需要遍历该桶中的所有键。</p>
<pre><code class="hljs language-mbt" lang="mbt">struct ChainingBucket[K, V] {
  values : Array[(K, V)]
}
</code></pre>
<p>Java 的 <code>HashMap</code> 就是这种方法的一个著名例子。</p>
</li>
<li>
<p><strong>开放地址法</strong>仍然坚持每个桶只放一个键，
但当键发生冲突时，会使用一种独立的策略来选择另一个桶的索引。
当查找一个键时，会按照这种策略的顺序进行搜索，
直到可以确定没有更多可能的匹配项为止。</p>
<pre><code class="hljs language-mbt" lang="mbt">struct OpenAddressBucket[K, V] {
  hash: Int
  key: K
  value: V
}
</code></pre>
<p>MoonBit 标准库中的 <code>Map</code> 就是这种方法的一个例子。</p>
</li>
</ul>
<p>无论哪种情况，当哈希冲突发生时，
我们都别无选择，只能遍历我们找到的那个桶对应的所有键值对，
来确定我们正在寻找的键是否存在。</p>
<p>为了简单起见，我们以一个使用链地址法的哈希表为例。哈希表的实现看起来大概是这样的：</p>
<pre><code class="hljs language-mbt" lang="mbt">typealias ChainingBucket as Bucket

/// 搜索键存储的位置。
///
/// 返回 `(桶索引, 键在桶中的索引?, 完成的搜索次数)`
fn[K : Eq, V] search(self : MyHashMap[K, V], key : K) -&gt; (Int, Int?, Int) {
  let hash = (self.hash_fn)(key)
  let bucket = (hash % self.buckets.length().reinterpret_as_uint()).reinterpret_as_int()
  // 结果
  let mut found_index = None
  let mut n_searches = 0
  // 遍历桶中所有的键值对。
  for index, keyvalue in self.buckets[bucket].values {
    n_searches += 1
    if keyvalue.0 == key { // 检查键是否匹配。
      found_index = Some(index)
      break
    }
  }
  return (bucket, found_index, n_searches)
}

/// 插入一个新的键值对。
///
/// 返回完成的搜索次数。
fn[K : Eq, V] insert(self : MyHashMap[K, V], key : K, value : V) -&gt; Int {
  let (bucket, index, n_searches) = self.search(key)
  if index is Some(index) {
    self.buckets[bucket].values[index] = (key, value)
  } else {
    self.buckets[bucket].values.push((key, value))
  }
  n_searches
}
</code></pre>
<p>这就是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span> 访问魔法背后所附带的条件——
如果我们运气不好，就必须遍历所有东西。
这使得哈希表在最坏情况下的复杂度变成了 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span>，
其中 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">n</span></span></span></span></span> 是哈希表中的键的数量。</p>
<h2 data-id="heading-2">制造一场冲突</h2>
<p>对于我们用于哈希表的大多数哈希函数来说，这种冲突的最坏情况是很罕见的。
这意味着我们通常不需要为最坏情况而烦恼，
并且在绝大多数时间里都能享受到 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span> 的速度。</p>
<p>除非有人，
<del>也许是某个心怀恶意的黑客，</del>
故意把你推入最坏情况。</p>
<p>一般来说，哈希函数都是确定性的，而且运算速度很快。
所以，即使不去对函数本身进行高级的密码学分析，
我们仍然可以通过暴力破解找到很多会相互冲突的键。<sup><a href="#user-content-fn-brute-force" id="user-content-user-content-fnref-brute-force" data-footnote-ref="" aria-describedby="footnote-label" title="#user-content-fn-brute-force">1</a></sup></p>
<pre><code class="hljs language-mbt" lang="mbt">fn find_collision(
  bucket_count : Int,
  target_bucket : Int,
  n_collision_want : Int,
  hash_fn : (String) -&gt; UInt,
) -&gt; Array[String] {
  let result = []
  let bucket_count = bucket_count.reinterpret_as_uint()
  let target_bucket = target_bucket.reinterpret_as_uint()
  for i = 0; ; i = i + 1 {
    // 生成一些字符串键。
    let s = i.to_string(radix=36)
    // 计算哈希值
    let hash = hash_fn(s)
    let bucket_index = hash % bucket_count
    let bucket_index = if bucket_index &lt; 0 {
      bucket_index + bucket_count
    } else {
      bucket_index
    }
    // 检查它是否与我们的目标桶冲突。
    if bucket_index == target_bucket {
      result.push(s)
      if result.length() &gt;= n_collision_want {
        break
      }
    }
  }
  result
}
</code></pre>
<h2 data-id="heading-3">哈希洪泛攻击</h2>
<p>手握这些会冲突的键，（扮演恶意黑客的）我们现在就可以攻击哈希表，
持续利用其最坏情况下的复杂度。</p>
<p>考虑以下情况：你正在向同一个哈希表中插入键，
但每个键都被映射到同一个桶中。
每次插入时，哈希表都必须遍历桶中所有现有的键，
以确定新键是否已经存在。</p>
<p>第一次插入与 0 个键比较，
第二次与 1 个键比较，第三次与 2 个键比较，
被比较的键的数量随着每次插入线性增长。
对于 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">n</span></span></span></span></span> 次插入，被比较的键的总数是：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>0</mn><mo>+</mo><mn>1</mn><mo>+</mo><mo>⋯</mo><mo>+</mo><mo stretchy="false">(</mo><mi>n</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mi>n</mi><mo stretchy="false">(</mo><mi>n</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><mn>2</mn></mfrac><mo>=</mo><mfrac><mrow><msup><mi>n</mi><mn>2</mn></msup><mo>+</mo><mi>n</mi></mrow><mn>2</mn></mfrac></mrow><annotation encoding="application/x-tex">0 + 1 + \dots + (n - 1) = \frac{n(n - 1)}{2} = \frac{n^2 + n}{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">0</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="minner">⋯</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.113em;vertical-align:-0.686em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.1771em;vertical-align:-0.686em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4911em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord mathnormal">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p>这 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">n</span></span></span></span></span> 次插入操作总共需要 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 次比较才能完成<sup><a href="#user-content-fn-acc-quad" id="user-content-user-content-fnref-acc-quad" data-footnote-ref="" aria-describedby="footnote-label" title="#user-content-fn-acc-quad">2</a></sup>，
而平均情况下只需要 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span> 次比较。
这个操作将比它本应花费的时间长得多。</p>
<p>这种攻击不仅限于插入操作。
每当一个被攻击的键被查找时，
都会比较相同数量的键，
因此每一个本应是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span> 的操作现在都变成了 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span>。
这些原本耗时可以忽略不计的哈希表操作现在会变得极其缓慢，
使得攻击者比以前更容易耗尽程序的资源。</p>
<p>这就是我们所说的<strong>哈希洪泛攻击</strong>（hash flooding attack），
得名于它用冲突的键 “淹没” 了哈希表的同一个桶。</p>
<p>我们可以用我们之前写的哈希表实现来演示这一点：</p>
<pre><code class="hljs language-mbt" lang="mbt">/// 一个通过 Fowler-Noll-Vo 哈希函数实现的简单字符串哈希器。
/// https://en.wikipedia.org/wiki/Fowler%E2%80%93Noll%E2%80%93Vo_hash_function
fn string_fnv_hash(s : String) -&gt; UInt {
  let s_bytes = s.to_bytes()
  let mut acc : UInt = 0x811c9dc5
  for b in s_bytes {
    acc = (acc ^ b.to_uint()) * 0x01000193
  }
  acc
}

fn test_attack(
  n_buckets : Int,
  keys : Array[String],
  hash_fn : (String) -&gt; UInt,
) -&gt; Int {
  let map = { buckets: Array::makei(n_buckets, _ =&gt; { values: [] }), hash_fn }
  let mut total_searches = 0
  for key in keys {
    total_searches += map.insert(key, 0)
  }
  total_searches
}

test {
  println("演示哈希洪泛攻击")
  let bucket_count = 2048
  let target_bucket_id = 42
  let n_collision_want = 1000

  //
  println("首先，尝试插入不冲突的键。")
  let non_colliding_keys = Array::makei(n_collision_want,
    i =&gt; (i * 37).to_string(radix=36))
  let n_compares_nc = test_attack(
    bucket_count, non_colliding_keys, string_fnv_hash,
  )
  println(
    "1000个不冲突键的总比较次数：\{n_compares_nc}",
  )
  println("")

  //
  println("现在，我们希望所有键都冲突到 #\{target_bucket_id} 号桶。")
  let colliding_keys = find_collision(
    bucket_count, target_bucket_id, n_collision_want, string_fnv_hash,
  )
  println("找到了 \{colliding_keys.length()} 个冲突的键。")
  let n_compares_c = test_attack(bucket_count, colliding_keys, string_fnv_hash)
  println(
    "1000个冲突键的总比较次数：\{n_compares_c}",
  )

  //
  let increase = n_compares_c.to_double() / n_compares_nc.to_double()
  println("比较次数增加了 \{increase} 倍")
}
</code></pre>
<p>上面代码的输出是：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">演示哈希洪泛攻击</span>
<span class="hljs-string">首先，尝试插入不冲突的键。</span>
<span class="hljs-number">1000</span><span class="hljs-string">个不冲突键的总比较次数：347</span>

<span class="hljs-string">现在，使用冲突的键...</span>
<span class="hljs-string">找到了</span> <span class="hljs-number">1000</span> <span class="hljs-string">个冲突的键。</span>
<span class="hljs-number">1000</span><span class="hljs-string">个冲突键的总比较次数：499500</span>
<span class="hljs-string">比较次数增加了</span> <span class="hljs-number">1439.4812680115274</span> <span class="hljs-string">倍</span>
</code></pre>
<p>……可以直接看到，现在的插入操作慢了大约 1000 倍！</p>
<p>在现实中，尽管哈希表中的桶数不像我们的例子那样是固定的，
但它们通常遵循一定的增长序列，
比如翻倍或遵循一个预定义的素数列表。
这种增长模式使得桶的数量非常容易预测。
因此，即使攻击者不知道确切的桶数，也能发起哈希洪泛攻击。</p>
<h2 data-id="heading-4">缓解哈希洪泛攻击</h2>
<p>哈希洪泛攻击之所以能奏效，是因为攻击者确切地知道哈希函数是如何工作的，
以及它是如何与键插入哈希表的位置相关联的。
如果我们改变其中任何一个，攻击就不再有效了。</p>
<h3 data-id="heading-5">带"种子"的哈希函数</h3>
<p>到目前为止，最简单的方法是防止攻击者确切地知道哈希算法是如何工作的。
这听起来可能不可能，
但哈希函数的性质实际上<strong>只需要在单个哈希表内部保持一致就行了</strong>！</p>
<p>在哈希表中，我们其实不需要一个可以在任何地方使用的、全局统一的"哈希值"，
因为哈希表压根不在乎表以外洪水滔天，只要表本身保持一致就可以了。
所以，只要简单地在不同的哈希表之间切换哈希函数，
我们就能让攻击者无法预测其行为。</p>
<p>但你可能会说：“可现实世界中的哈希算法不是无限供应的啊！”</p>
<p>其实它可以是。
还记得我们说哈希函数需要将值尽可能均匀地分布在结果空间中吗？
这意味着，对于一个足够好的哈希函数，
输入的微小变化会导致输出的巨大变化（被称为雪崩效应）。
因此，为了给每个哈希表一个独一无二的哈希函数，
我们只需要在输入我们想要哈希的数据之前，
先给它 “喂” 一些该哈希表独有的数据。
这被称为哈希函数的“种子"（seed）。
这样，我们只要通过调整种子的值，就能获得无限供应的不同哈希函数了。</p>
<p>让我们用一个带种子的哈希函数和两个使用不同种子的哈希表来演示一下，哈希种子是如何解决这个问题的：</p>
<pre><code class="hljs language-mbt" lang="mbt">/// FNV 哈希的修改版，允许使用种子。
fn string_fnv_hash_seeded(seed : UInt) -&gt; (String) -&gt; UInt {
  let seed_bytes = seed.to_le_bytes()
  fn string_fnv_hash(s : String) -&gt; UInt {
    let s_bytes = s.to_bytes()
    let mut acc : UInt = 0x811c9dc5
    // 混入种子字节。
    for b in seed_bytes {
      acc = (acc ^ b.to_uint()) * 0x01000193
    }
    // 哈希字符串字节。
    for b in s_bytes {
      acc = (acc ^ b.to_uint()) * 0x01000193
    }
    acc
  }

  string_fnv_hash
}

test {
  println("演示洪水攻击的缓解措施")
  let bucket_count = 2048
  let target_bucket_id = 42
  let n_collision_want = 1000

  // 第一个表使用种子 42。
  let seed1 : UInt = 42
  println("我们使用种子 \{seed1} 来寻找冲突")
  let hash_fn1 = string_fnv_hash_seeded(seed1)
  let colliding_keys = find_collision(
    bucket_count, target_bucket_id, n_collision_want, hash_fn1,
  )
  let n_compares_c = test_attack(bucket_count, colliding_keys, hash_fn1)
  println(
    "使用种子 \{seed1} 时，1000个冲突键的总比较次数：\{n_compares_c}",
  )
  println("")

  // 第二个表使用不同的种子。这次我们用 100
  let seed2 : UInt = 100
  println(
    "现在我们为第二个表使用不同的种子，这次是 \{seed2}",
  )
  let hash_fn2 = string_fnv_hash_seeded(seed2)
  let n_compares_nc = test_attack(bucket_count, colliding_keys, hash_fn2)
  println(
    "对于那些本应在种子 \{seed1} 下冲突的1000个键，现在的总比较次数：\{n_compares_nc}",
  )
}
</code></pre>
<p>上面程序的输出是：</p>
<pre><code class="hljs">演示洪水攻击的缓解措施
我们使用种子 42 来寻找冲突
使用种子 42 时，1000个冲突键的总比较次数：499500

现在我们为第二个表使用不同的种子，这次是 100
对于那些本应在种子 42 下冲突的1000个键，现在的总比较次数：6342
</code></pre>
<p>我们可以看到，
在第一个表中冲突的键，在第二个表中不再冲突了。<sup><a href="#user-content-fn-mitigation" id="user-content-user-content-fnref-mitigation" data-footnote-ref="" aria-describedby="footnote-label" title="#user-content-fn-mitigation">3</a></sup>
因此，我们通过这个简单的技巧成功地缓解了哈希洪泛攻击。</p>
<p>至于那个让每个哈希表随机化的种子从哪里来……
对于能够访问外部随机源的程序（比如 Linux 的 <code>/dev/urandom</code>），
使用它通常是最佳选择。
对于无法访问这类源的程序（比如在 WebAssembly 沙箱中），
在同一个进程中使用相同的种子、不同进程使用不同的种子也是一个方案（Python 就是这么做的）。
甚至于，一个每次请求种子时就自增的简单计数器或许也已经足够了——
对于攻击者来说，猜测已经创建过多少个哈希表仍然是比较困难的一件事。</p>
<h3 data-id="heading-6">其他选择</h3>
<p>Java 使用了另一种解决方案，
当太多的值占据同一个桶时，它会退而求其次，使用一棵二叉搜索树（红黑树）存储它们。
是，这要求键除了可哈希之外，还必须是可比较的，
但现在它保证了 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span> 的最坏情况复杂度，
这总比 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span> 要好得多。</p>
<h2 data-id="heading-7">这为什么对我们很重要？</h2>
<p>由于哈希表在程序中无处不在，
在一个程序中找到一个你能控制其键的哈希表是极其容易的。
尤其是在 Web 程序中每，
请求头、Cookie、查询参数和 JSON 请求体都是键值对，
并且通常存储在哈希表中，这可能使它们容易受到哈希洪泛攻击。</p>
<p>一个对程序有足够了解（编程语言、框架等）的恶意攻击者，
可以尝试向 Web API 端点发送精心构造的请求负载。
这些请求需要更长的时间来处理，
所以如果一个常规的拒绝服务（DoS）攻击需要每秒 n 个请求才能使服务器瘫痪，
那么哈希洪泛攻击可能只需要小一个数量级的攻击次数就能达到相同的效果。
这使得它对攻击者来说效率高得多。
这种攻击被称为 <strong>哈希拒绝服务（HashDoS）</strong> 攻击。</p>
<p>幸运的是，通过在哈希表中引入一些哪怕是轻微的不可预测模式
（例如每个进程的随机性或带密钥的哈希），
我们就可以使这类攻击变得异常困难，以至于对攻击者不再可行。
此外，由于这种攻击高度依赖于对目标应用的语言、框架、架构和实现的了解，
构造一个攻击本身就已经相当困难了，
而现代的、配置良好的系统则更难被利用。</p>
<h2 data-id="heading-8">总结</h2>
<p>哈希表为我们提供了强大的、平均时间复杂度为常数的访问方式——
然而，这个"常数"的成立，是建立在一些假设之上的，
而这些假设有时会被攻击者打破。
一次有针对性的哈希洪泛攻击会迫使许多键进入同一个桶，
将 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span> 的操作变成 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span>，
能非常高效地耗尽系统资源。</p>
<p>好消息是，缓解措施既简单又实用：
为你的哈希表引入一些不可预测性，
当仅靠哈希还不够时使用旁路信息，或者当行为看起来不对劲时重新哈希。
有了这些，我们就可以让我们的哈希表既快速又安全。</p>
<h2 class="sr-only" id="user-content-footnote-label" data-id="heading-9">Footnotes</h2>
<ol>
<li id="user-content-user-content-fn-brute-force">
<p>顺便提一下，这也类似于比特币挖矿的工作原理：
找到一个值添加到现有字符串中，
使得整个内容的哈希值（逐位倒过来之后）模除某个给定值之后的结果等于零。 <a href="#user-content-fnref-brute-force" data-footnote-backref="" class="data-footnote-backref" aria-label="Back to content" title="#user-content-fnref-brute-force">↩</a></p>
</li>
<li id="user-content-user-content-fn-acc-quad">
<p>甚至有一个 Tumblr 博客专门记录编程语言中意料之外的二次方复杂度，
叫做 <a href="https://link.juejin.cn?target=https%3A%2F%2Faccidentallyquadratic.tumblr.com%2F" target="_blank" title="https://accidentallyquadratic.tumblr.com/" ref="nofollow noopener noreferrer">Accidentally Quadratic</a>。
你甚至可以在
<a href="https://link.juejin.cn?target=https%3A%2F%2Faccidentallyquadratic.tumblr.com%2Fpost%2F153545455987%2Frust-hash-iteration-reinsertion" target="_blank" title="https://accidentallyquadratic.tumblr.com/post/153545455987/rust-hash-iteration-reinsertion" ref="nofollow noopener noreferrer">这里</a>
找到一个与哈希表相关的例子——这个例子几乎算是一次手动引入的哈希洪泛攻击了。 <a href="#user-content-fnref-acc-quad" data-footnote-backref="" class="data-footnote-backref" aria-label="Back to content" title="#user-content-fnref-acc-quad">↩</a></p>
</li>
<li id="user-content-user-content-fn-mitigation">
<p>你可能会注意到，这个数字仍然比我们用随机生成的不冲突键得到的数字要高一些。
这可能与 FNV 哈希函数的设计并非追求最高质量的输出有关。
由于两个种子非常接近，结果可能仍然存在一些相似性。
使用一个更好的哈希函数（甚至是像 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fveorq%2FSipHash" target="_blank" title="https://github.com/veorq/SipHash" ref="nofollow noopener noreferrer">SipHash</a> 这样的加密安全哈希函数）
会大大减少这种影响。 <a href="#user-content-fnref-mitigation" data-footnote-backref="" class="data-footnote-backref" aria-label="Back to content" title="#user-content-fnref-mitigation">↩</a></p>
</li>
</ol>
</div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[除了AOP切面，还有哪些更灵活的数据源切换策略？比如基于注解或自定义路由规则]]></title>    <link>https://juejin.cn/post/7571299394345680938</link>    <guid>https://juejin.cn/post/7571299394345680938</guid>    <pubDate>2025-11-11T13:41:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571299394345680938" data-draft-id="7571306072422809642" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="除了AOP切面，还有哪些更灵活的数据源切换策略？比如基于注解或自定义路由规则"/> <meta itemprop="keywords" content="后端,数据库"/> <meta itemprop="datePublished" content="2025-11-11T13:41:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            除了AOP切面，还有哪些更灵活的数据源切换策略？比如基于注解或自定义路由规则
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T13:41:13.000Z" title="Tue Nov 11 2025 13:41:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    15
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Spring Boot中实现数据源切换，除了AOP切面，还有几种非常灵活的策略。下面我用一个表格对比各种方案，然后重点介绍两种最实用的方法：</p>








































<table><thead><tr><th>策略类型</th><th>实现方式</th><th>灵活性</th><th>代码侵入性</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>注解驱动</strong></td><td>使用<code>@DS</code>等注解标记方法/类</td><td>高</td><td>低</td><td>精确到方法级别的数据源控制</td></tr><tr><td><strong>手动编程</strong></td><td>在代码中调用API动态切换</td><td>最高</td><td>高</td><td>复杂业务逻辑、同一方法内多数据源</td></tr><tr><td><strong>请求特征路由</strong></td><td>基于HTTP头、参数等自动路由</td><td>中高</td><td>低</td><td>多租户、按客户分库等场景</td></tr><tr><td><strong>方法规则路由</strong></td><td>基于方法名约定自动切换</td><td>中</td><td>低</td><td>有固定命名规范的读写分离</td></tr></tbody></table>
<h2 data-id="heading-0">🔁 注解驱动切换</h2>
<p>这是目前<strong>最流行且优雅</strong>的方案，MyBatis-Plus的动态数据源组件提供了开箱即用的支持。</p>
<h3 data-id="heading-1">配置依赖</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
-   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>dynamic-datasource-spring-boot3-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
-   <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h3 data-id="heading-2">配置文件</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">dynamic:</span>
      <span class="hljs-attr">primary:</span> <span class="hljs-string">master</span>  <span class="hljs-comment"># 默认数据源</span>
      <span class="hljs-attr">strict:</span> <span class="hljs-literal">false</span>    <span class="hljs-comment"># 是否严格匹配数据源</span>
      <span class="hljs-attr">datasource:</span>
        <span class="hljs-attr">master:</span>
          <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/master</span>
          <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
          <span class="hljs-attr">password:</span> <span class="hljs-string">master_password</span>
        <span class="hljs-attr">slave:</span>
          <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/slave</span>
          <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
          <span class="hljs-attr">password:</span> <span class="hljs-string">slave_password</span>
</code></pre>
<h3 data-id="heading-3">使用@DS注解</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-comment">// 默认使用主库（写操作）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">User user</span>) {
        userMapper.<span class="hljs-title function_">insert</span>(user);
    }
    
    <span class="hljs-comment">// 显式指定从库（读操作）</span>
    <span class="hljs-meta">@DS</span>(<span class="hljs-string">"slave"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">User</span> <span class="hljs-title function_">getUserById</span>(<span class="hljs-params">Long id</span>) {
        <span class="hljs-keyword">return</span> userMapper.<span class="hljs-title function_">selectById</span>(id);
    }
    
    <span class="hljs-comment">// 在Mapper层直接指定数据源</span>
    <span class="hljs-meta">@DS</span>(<span class="hljs-string">"slave"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">User</span>&gt; <span class="hljs-title function_">findActiveUsers</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> userMapper.<span class="hljs-title function_">selectActiveUsers</span>();
    }
}
</code></pre>
<p><strong>优点</strong>：声明式配置，代码侵入性低，支持类级别和方法级别的精细控制。</p>
<h2 data-id="heading-4">⚙️ 手动编程切换</h2>
<p>对于需要<strong>在同一方法内使用多个数据源</strong>的复杂场景，手动控制提供了最大灵活性。</p>
<h3 data-id="heading-5">基本API使用</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processOrder</span><span class="hljs-params">(Long orderId)</span> {
        <span class="hljs-comment">// 第一阶段：从主库读取订单</span>
        DynamicDataSourceContextHolder.push(<span class="hljs-string">"master"</span>);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderMapper.selectById(orderId);
            <span class="hljs-comment">// 业务处理...</span>
        } <span class="hljs-keyword">finally</span> {
            DynamicDataSourceContextHolder.poll();
        }
        
        <span class="hljs-comment">// 第二阶段：写入从库进行数据分析</span>
        DynamicDataSourceContextHolder.push(<span class="hljs-string">"slave"</span>);
        <span class="hljs-keyword">try</span> {
            analysisMapper.insertOrderAnalysis(order);
        } <span class="hljs-keyword">finally</span> {
            DynamicDataSourceContextHolder.poll();
        }
    }
}
</code></pre>
<h3 data-id="heading-6">基于HTTP请求的自动切换</h3>
<p>通过过滤器或拦截器实现基于请求特征的路由：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Component</span>
<span class="hljs-meta">@WebFilter</span>(urlPatterns = <span class="hljs-string">"/*"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">doFilter</span>(<span class="hljs-title class_">ServletRequest</span> request, <span class="hljs-title class_">ServletResponse</span> response, 
                         <span class="hljs-title class_">FilterChain</span> chain) throws <span class="hljs-title class_">IOException</span>, <span class="hljs-title class_">ServletException</span> {
        <span class="hljs-title class_">HttpServletRequest</span> httpRequest = (<span class="hljs-title class_">HttpServletRequest</span>) request;
        
        <span class="hljs-comment">// 从请求头获取数据源标识（如多租户场景）</span>
        <span class="hljs-title class_">String</span> tenantId = httpRequest.<span class="hljs-title function_">getHeader</span>(<span class="hljs-string">"X-Tenant-Id"</span>);
        <span class="hljs-comment">// 或从请求参数判断业务类型</span>
        <span class="hljs-title class_">String</span> businessType = httpRequest.<span class="hljs-title function_">getParameter</span>(<span class="hljs-string">"bizType"</span>);
        
        <span class="hljs-title class_">String</span> dataSourceKey = <span class="hljs-title function_">determineDataSource</span>(tenantId, businessType);
        
        <span class="hljs-title class_">DynamicDataSourceContextHolder</span>.<span class="hljs-title function_">push</span>(dataSourceKey);
        <span class="hljs-keyword">try</span> {
            chain.<span class="hljs-title function_">doFilter</span>(request, response);
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-title class_">DynamicDataSourceContextHolder</span>.<span class="hljs-title function_">poll</span>();
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">determineDataSource</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> tenantId, <span class="hljs-built_in">String</span> businessType</span>) {
        <span class="hljs-comment">// 复杂的路由逻辑</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"report"</span>.<span class="hljs-title function_">equals</span>(businessType)) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"report_db"</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tenantId != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"tenant_"</span> + tenantId;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-string">"master"</span>; <span class="hljs-comment">// 默认数据源</span>
    }
}
</code></pre>
<h2 data-id="heading-7">🧠 自定义路由规则</h2>
<p>通过继承<code>AbstractRoutingDataSource</code>并重写<code>determineCurrentLookupKey()</code>方法，可以实现基于<strong>业务逻辑的复杂路由</strong>。</p>
<h3 data-id="heading-8">基于方法名的路由示例</h3>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BusinessRoutingDataSource</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractRoutingDataSource</span> </span>{
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">Object</span> determineCurrentLookupKey() {
        <span class="hljs-comment">// 获取当前方法名进行路由决策</span>
        <span class="hljs-type">String</span> methodName = getCurrentMethodName();
        
        <span class="hljs-keyword">if</span> (methodName.startsWith(<span class="hljs-string">"find"</span>) || methodName.startsWith(<span class="hljs-string">"query"</span>) 
            || methodName.startsWith(<span class="hljs-string">"select"</span>) || methodName.startsWith(<span class="hljs-string">"get"</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"slave"</span>; <span class="hljs-comment">// 读操作路由到从库</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (methodName.startsWith(<span class="hljs-string">"insert"</span>) || methodName.startsWith(<span class="hljs-string">"update"</span>) 
                 || methodName.startsWith(<span class="hljs-string">"delete"</span>) || methodName.startsWith(<span class="hljs-string">"save"</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"master"</span>; <span class="hljs-comment">// 写操作路由到主库</span>
        }
        
        <span class="hljs-comment">// 默认路由策略</span>
        <span class="hljs-keyword">return</span> isReadOperation(methodName) ? <span class="hljs-string">"slave"</span> : <span class="hljs-string">"master"</span>;
    }
}
</code></pre>
<h3 data-id="heading-9">基于参数值的路由</h3>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ParameterBasedRouter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractRoutingDataSource</span> </span>{
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">Object</span> determineCurrentLookupKey() {
        <span class="hljs-comment">// 从线程上下文或参数中获取路由信息</span>
        <span class="hljs-type">String</span> businessUnit = <span class="hljs-type">RequestContextHolder</span>.getBusinessUnit();
        <span class="hljs-type">String</span> dataType = <span class="hljs-type">RequestContextHolder</span>.getDataType();
        
        <span class="hljs-comment">// 组合路由逻辑</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"finance"</span>.equals(businessUnit) &amp;&amp; <span class="hljs-string">"sensitive"</span>.equals(dataType)) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"finance_secure_db"</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">"report"</span>.equals(dataType)) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"reporting_db"</span>;
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-string">"default_db"</span>;
    }
}
</code></pre>
<h2 data-id="heading-10">⚠️ 实战注意事项</h2>
<ol>
<li><strong>事务管理</strong>：在手动切换数据源时，确保<strong>同一个事务内使用同一数据源</strong>，避免跨数据源事务导致的数据不一致问题。</li>
<li><strong>资源清理</strong>：使用<code>try-finally</code>确保每次数据源切换后都能正确清理上下文，防止<strong>内存泄漏</strong>和<strong>数据源污染</strong>。</li>
<li><strong>性能考量</strong>：频繁的数据源切换会带来性能开销，在高性能场景下应考虑<strong>批量操作</strong>或<strong>连接复用</strong>。</li>
<li><strong>降级策略</strong>：始终配置合理的<strong>主从延迟处理</strong>和<strong>故障降级</strong>机制，确保主库不可用时系统的可用性。</li>
</ol>
<h2 data-id="heading-11">💎 总结</h2>
<p>选择合适的数据源切换策略需要权衡灵活性和复杂性。对于大多数场景，<strong>注解驱动方案</strong>提供了最佳实践；对于复杂业务逻辑，<strong>手动编程控制</strong>不可或缺；而对于有固定路由规则的场景，<strong>自定义路由策略</strong>能够提供最优雅的解决方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[📜 `<script>`脚本元素 - 从加载策略到安全性与性能的完整指南]]></title>    <link>https://juejin.cn/post/7571102074038485033</link>    <guid>https://juejin.cn/post/7571102074038485033</guid>    <pubDate>2025-11-11T09:11:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571102074038485033" data-draft-id="7571102074038452265" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="📜 `&lt;script&gt;`脚本元素 - 从加载策略到安全性与性能的完整指南"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-11T09:11:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Bug_Constructer"/> <meta itemprop="url" content="https://juejin.cn/user/254742426830856"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            📜 `&lt;script&gt;`脚本元素 - 从加载策略到安全性与性能的完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/254742426830856/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Bug_Constructer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:11:06.000Z" title="Tue Nov 11 2025 09:11:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>🎯 <strong>学习目标</strong>：系统掌握<code>&lt;script&gt;</code>脚本元素的加载与执行模型、模块化用法、安全配置（CSP/SRI/CORS），并能在实际项目中选用正确策略，避免性能与安全坑。</p>
<p>📊 <strong>难度等级</strong>：中级<br/>
🏷️ <strong>技术标签</strong>：<code>#HTML</code> <code>#script</code> <code>#defer</code> <code>#async</code> <code>#module</code> <code>#CSP</code> <code>#SRI</code><br/>
⏱️ <strong>阅读时间</strong>：约14分钟</p>
</blockquote>
<h2 data-id="heading-0">🌟 引言</h2>
<p>在前端开发中，<code>&lt;script&gt;</code>脚本的使用几乎无处不在：业务代码、第三方SDK、监控上报、AB测试、广告、埋点……但常见问题也层出不穷：</p>
<ul>
<li>同步脚本阻塞渲染，首屏白屏时间长。</li>
<li>混用<code>async/defer</code>导致执行顺序不可控，依赖打乱引发线上事故。</li>
<li>模块脚本与经典脚本相互引用，兼容性问题频发。</li>
<li>跨域脚本报错只有“Script error”，无法定位问题。</li>
<li>未配置<code>CSP nonce</code>/<code>SRI integrity</code>，安全审计不通过。</li>
</ul>
<p>本文从加载、执行到安全与性能的完整维度，结合实际踩坑案例，给出可落地的最佳实践与测试方法。</p>
<h2 data-id="heading-1">核心技巧详解</h2>
<h3 data-id="heading-2">1）加载与执行模型：同步、defer、async 与事件时序</h3>
<h4 data-id="heading-3">应用场景</h4>
<p>需要同时引入多个脚本，并确保：不阻塞解析、执行顺序可控、与<code>DOMContentLoaded</code>/<code>load</code>事件时序配合。</p>
<h4 data-id="heading-4">常见问题</h4>
<ul>
<li>在<code>&lt;head&gt;</code>中放同步脚本，阻塞HTML解析与渲染。</li>
<li>将存在依赖关系的脚本设置为<code>async</code>，出现随机时序问题。</li>
<li>误以为<code>defer</code>作用于内联脚本（仅对外链脚本生效）。</li>
</ul>
<h4 data-id="heading-5">推荐方案</h4>
<ul>
<li>有依赖和顺序要求：使用<code>defer</code>并保持引入顺序。</li>
<li>无依赖、独立的第三方脚本：使用<code>async</code>。</li>
<li>现代代码优先使用<code>type="module"</code>（天生类似<code>defer</code>，更易管理依赖）。</li>
</ul>
<h4 data-id="heading-6">核心要点</h4>
<ul>
<li><code>async</code>：下载不阻塞解析，下载完成立即执行，彼此之间顺序不确定。</li>
<li><code>defer</code>：下载不阻塞解析，按引入顺序在解析完成后执行，早于<code>DOMContentLoaded</code>。</li>
<li><code>type="module"</code>：模块脚本默认延后执行，按依赖图加载，<code>DOMContentLoaded</code>会等待其完成。</li>
</ul>
<h4 data-id="heading-7">实际应用（顺序可视化示例）</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 推荐：存在依赖关系的脚本使用 defer，保证按声明顺序执行 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">defer</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/assets/vendor.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">defer</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/assets/app.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 独立的第三方脚本使用 async，不影响解析与渲染，也不会卡住其他脚本 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">async</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.example.com/analytics.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 现代项目：优先使用模块脚本，依赖管理更清晰（默认延后执行，DOM解析完成后运行） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/assets/main.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-8">2）模块脚本与回退：<code>type="module"</code>/<code>nomodule</code>/动态导入</h3>
<h4 data-id="heading-9">应用场景</h4>
<p>在现代浏览器中使用ESM模块；为老旧浏览器准备兼容回退；按需加载分包。</p>
<h4 data-id="heading-10">常见问题</h4>
<ul>
<li>经典脚本与模块脚本相互调用导致作用域混乱。</li>
<li>使用<code>nomodule</code>错误，现代浏览器也执行了回退脚本。</li>
</ul>
<h4 data-id="heading-11">推荐方案</h4>
<ul>
<li>现代浏览器：主入口使用<code>type="module"</code>。</li>
<li>老旧浏览器回退：提供<code>nomodule</code>的经典脚本版本（通过构建产物区分）。</li>
<li>大页面：使用<code>import()</code>进行按需加载，减小首包体积。</li>
</ul>
<h4 data-id="heading-12">核心要点</h4>
<ul>
<li><code>nomodule</code>脚本仅在“不支持模块”的浏览器中执行；现代浏览器会忽略。</li>
<li>模块脚本是<code>strict mode</code>，顶层不会污染全局作用域。</li>
<li>动态导入返回<code>Promise</code>，友好配合路由/交互触发。</li>
</ul>
<h4 data-id="heading-13">实际应用</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 现代入口 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span>&gt;</span><span class="javascript">
  <span class="hljs-comment">// @description 页面主入口：模块脚本（默认延后执行）</span>
  <span class="hljs-comment">/**
   * 记录模块初始化
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">msg</span> - 文本信息
   * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">void</span>}
   */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">logInit</span> = (<span class="hljs-params">msg</span>) =&gt; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[module] <span class="hljs-subst">${msg}</span>`</span>);
  <span class="hljs-title function_">logInit</span>(<span class="hljs-string">'bootstrap'</span>);

  <span class="hljs-comment">// 动态导入，按需加载非关键功能</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">loadFeature</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> { initFeature } = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'/assets/feature.js'</span>);
    <span class="hljs-title function_">initFeature</span>();
  };
  <span class="hljs-comment">// 交互触发</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadFeature</span>());
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 旧浏览器回退（仅不支持模块的浏览器执行） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">nomodule</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/assets/app-legacy.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-14">3）安全与跨域：CSP nonce、SRI integrity 与 <code>crossorigin</code></h3>
<h4 data-id="heading-15">应用场景</h4>
<p>严格的安全审计要求；CDN脚本完整性校验；跨域加载脚本并需要捕获详细错误。</p>
<h4 data-id="heading-16">常见问题</h4>
<ul>
<li>直接写内联脚本被CSP拦截，页面功能失效。</li>
<li>使用<code>integrity</code>但未设置<code>crossorigin</code>，SRI校验被忽略。</li>
<li>跨域脚本错误只有“Script error”，无法定位堆栈与消息。</li>
</ul>
<h4 data-id="heading-17">推荐方案</h4>
<ul>
<li>启用CSP并为内联脚本设置<code>nonce</code>（服务器动态生成）。</li>
<li>CDN脚本配合<code>integrity</code>与<code>crossorigin="anonymous"</code>确保完整性与错误可见性。</li>
<li>服务器允许跨域并设置<code>Access-Control-Allow-Origin</code>与<code>Timing-Allow-Origin</code>以提升可观测性。</li>
</ul>
<h4 data-id="heading-18">核心要点</h4>
<ul>
<li><code>Content-Security-Policy: script-src 'self' 'nonce-&lt;随机值&gt;' https://cdn.example.com</code>。</li>
<li><code>integrity</code>需与<code>crossorigin</code>配合，跨域资源不然可能跳过校验。</li>
<li>设置<code>window.addEventListener('error', ...)</code>与<code>unhandledrejection</code>捕获错误。</li>
</ul>
<h4 data-id="heading-19">实际应用</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 服务端需下发一致的 nonce 值（示例：nonce-xyz） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"Content-Security-Policy"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"script-src 'self' 'nonce-xyz' https://cdn.example.com"</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 内联脚本加 nonce，避免被CSP拦截 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">nonce</span>=<span class="hljs-string">"xyz"</span>&gt;</span><span class="javascript">
  <span class="hljs-comment">/**
   * 上报错误（示例）
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">type</span> - 错误类型
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">msg</span> - 错误消息
   * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">void</span>}
   */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">reportError</span> = (<span class="hljs-params">type, msg</span>) =&gt; {
    <span class="hljs-comment">// 真实项目中调用监控SDK或自建上报接口</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[error] <span class="hljs-subst">${type}</span>: <span class="hljs-subst">${msg}</span>`</span>);
  };
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> <span class="hljs-title function_">reportError</span>(<span class="hljs-string">'onerror'</span>, e.<span class="hljs-property">message</span>));
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'unhandledrejection'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> <span class="hljs-title function_">reportError</span>(<span class="hljs-string">'promise'</span>, <span class="hljs-title class_">String</span>(e.<span class="hljs-property">reason</span>)));
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-comment">&lt;!-- CDN脚本完整性 + 可见错误堆栈（需服务端允许跨域） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.example.com/sdk.min.js"</span>
        <span class="hljs-attr">integrity</span>=<span class="hljs-string">"sha384-BASE64_HASH"</span>
        <span class="hljs-attr">crossorigin</span>=<span class="hljs-string">"anonymous"</span>
        <span class="hljs-attr">defer</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-20">4）错误监控与可观测性：从“Script error”到可定位</h3>
<h4 data-id="heading-21">应用场景</h4>
<p>跨域脚本导致错误信息缺失；需要在生产环境获取完整堆栈与来源。</p>
<h4 data-id="heading-22">常见问题</h4>
<ul>
<li>未设置<code>crossorigin</code>导致错误被屏蔽。</li>
<li>监控系统只收到了通用的“Script error”。</li>
</ul>
<h4 data-id="heading-23">推荐方案</h4>
<ul>
<li>对外链脚本统一加<code>crossorigin="anonymous"</code>。</li>
<li>服务器返回<code>Access-Control-Allow-Origin: *</code>或你的域名；并提供<code>Timing-Allow-Origin</code>以开放性能指标。</li>
<li>对于私有CDN，确保响应头携带正确的CORS与缓存策略。</li>
</ul>
<h4 data-id="heading-24">实际应用（最小上报器）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 发送错误到监控平台
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">{type:string,message:string,stack?:string</span>}} payload - 错误信息
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">void</span>}
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">sendError</span> = (<span class="hljs-params">payload</span>) =&gt; {
  <span class="hljs-comment">// 示例：仅打印；实际项目应调用后端接口</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'📮 error-report'</span>, payload);
};

<span class="hljs-comment">/**
 * 初始化错误监听
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">void</span>}
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">initErrorListener</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-title function_">sendError</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span>, <span class="hljs-attr">message</span>: e.<span class="hljs-property">message</span>, <span class="hljs-attr">stack</span>: e.<span class="hljs-property">error</span>?.<span class="hljs-property">stack</span> });
  });
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'unhandledrejection'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-title function_">sendError</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'promise'</span>, <span class="hljs-attr">message</span>: <span class="hljs-title class_">String</span>(e.<span class="hljs-property">reason</span>) });
  });
};

<span class="hljs-title function_">initErrorListener</span>();
</code></pre>
<h3 data-id="heading-25">5）性能与加载优化：位置、拆分、预加载、优先级</h3>
<h4 data-id="heading-26">应用场景</h4>
<p>首屏加载优化、减少阻塞、合理拆分产物、控制网络优先级。</p>
<h4 data-id="heading-27">常见问题</h4>
<ul>
<li>将大型同步脚本放在<code>&lt;head&gt;</code>导致阻塞。</li>
<li>所有代码打成一个包，影响首屏与可缓存性。</li>
<li>关键脚本加载优先级过低导致交互延迟。</li>
</ul>
<h4 data-id="heading-28">推荐方案</h4>
<ul>
<li>非必要脚本置底或使用<code>defer</code>；第三方独立脚本用<code>async</code>。</li>
<li>按路由/功能拆分产物；模块脚本配合<code>import()</code>实现懒加载。</li>
<li>对真正关键脚本使用<code>fetchpriority="high"</code>（实验性特性，评估后再用）。</li>
</ul>
<h4 data-id="heading-29">实际应用</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 关键脚本：提升获取优先级并延后执行（避免阻塞） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/assets/critical.js"</span> <span class="hljs-attr">fetchpriority</span>=<span class="hljs-string">"high"</span> <span class="hljs-attr">defer</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 辅助脚本：按需加载（路由/交互触发） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span>&gt;</span><span class="javascript">
  <span class="hljs-comment">/**
   * 懒加载非关键功能
   * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Promise&lt;void&gt;</span>}
   */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">lazyFeature</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> { mount } = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'/assets/chart.js'</span>);
    <span class="hljs-title function_">mount</span>(<span class="hljs-string">'#chart'</span>);
  };
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'#btn'</span>)?.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lazyFeature</span>());
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h2 data-id="heading-30">📊 技巧对比总结</h2>









































<table><thead><tr><th>技巧</th><th>使用场景</th><th>优势</th><th>注意事项</th></tr></thead><tbody><tr><td>同步脚本（不推荐）</td><td>早期简单页面</td><td>立即执行</td><td>阻塞解析与渲染，影响首屏</td></tr><tr><td>defer</td><td>有依赖且需保持顺序</td><td>不阻塞解析；按引入顺序执行</td><td>仅外链脚本生效；在解析完成后执行</td></tr><tr><td>async</td><td>独立第三方脚本</td><td>不阻塞解析；最快可用</td><td>顺序不确定；不适合有依赖脚本</td></tr><tr><td>type="module"</td><td>现代项目主入口与分包</td><td>依赖图管理；默认延后执行</td><td>需考虑旧浏览器；配合 nomodule 回退</td></tr><tr><td>nomodule</td><td>旧浏览器回退</td><td>保证兼容</td><td>仅旧浏览器执行；与模块入口配套</td></tr></tbody></table>
<h2 data-id="heading-31">🎯 实战应用建议</h2>
<h3 data-id="heading-32">最佳实践</h3>
<ol>
<li>同时输出 <code>esm</code> 与 <code>legacy</code> 产物；模板中注入 <code>type="module"</code> 与 <code>nomodule</code> 入口。</li>
<li>第三方独立脚本统一使用 <code>async</code>；有依赖的业务脚本使用 <code>defer</code> 保序。</li>
<li>模块化按需拆分：非关键功能通过 <code>import()</code> 懒加载，降低首包体积。</li>
<li>安全策略到位：开启 CSP（<code>nonce</code>/<code>hash</code>/<code>strict-dynamic</code>）与 SRI（<code>integrity</code> + <code>crossorigin</code>）。</li>
</ol>
<h3 data-id="heading-33">性能考虑</h3>
<ul>
<li>关键脚本提升网络优先级（<code>fetchpriority</code>）并使用 <code>defer</code> 避免阻塞。</li>
<li>大页面进行路由/功能拆分；CDN 缓存策略与版本化确保命中率。</li>
<li>错误与性能可观测性：启用 <code>crossorigin</code> 与 <code>Timing-Allow-Origin</code>，便于采集与诊断。</li>
</ul>
<h2 data-id="heading-34">💡 总结</h2>
<p>这5个脚本治理技巧覆盖了加载模型、模块化、跨域安全、错误监控与性能优化：</p>
<ol>
<li>加载与执行模型：明确 <code>defer/async/module</code> 的时序与适用场景。</li>
<li>模块脚本与回退：<code>type="module"</code> + <code>nomodule</code> 兼顾现代与旧环境。</li>
<li>安全与跨域：CSP <code>nonce</code>、SRI <code>integrity</code> 与 CORS 正确配合。</li>
<li>错误监控与可观测性：统一监听与跨域头，避免“Script error”。</li>
<li>性能与加载优化：拆分、预加载与优先级，降低阻塞时间。</li>
</ol>
<p>掌握以上技巧能让你的前端应用更稳定、更安全、更高效。建议在团队内形成统一的脚本治理规范，并提供测试页面验证关键场景，持续迭代优化。</p>
<h2 data-id="heading-35">相关资源</h2>
<ul>
<li>MDN：HTML <code>&lt;script&gt;</code> 元素（参考与属性说明）
<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FHTML%2FReference%2FElements%2Fscript" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/HTML/Reference/Elements/script" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a></li>
<li>CSP 指南：Content Security Policy
<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FHTTP%2FCSP" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CSP" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a></li>
<li>SRI 指南：Subresource Integrity
<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FSecurity%2FSubresource_Integrity" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/Security/Subresource_Integrity" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a></li>
<li>Priority Hints（fetchpriority）
<a href="https://link.juejin.cn?target=https%3A%2F%2Fweb.dev%2Farticles%2Fpriority-hints" target="_blank" title="https://web.dev/articles/priority-hints" ref="nofollow noopener noreferrer">web.dev/articles/pr…</a></li>
</ul>
<hr/>
<blockquote>
<p>💡 今日收获：掌握了脚本加载与执行的5个核心技巧，含安全与性能的最佳实践，这些知识点在实际前端项目中非常实用。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot + MyBatis-Plus + Dynamic-Datasource 读写分离完整指南]]></title>    <link>https://juejin.cn/post/7571299394345730090</link>    <guid>https://juejin.cn/post/7571299394345730090</guid>    <pubDate>2025-11-11T14:00:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571299394345730090" data-draft-id="7571258854901399595" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" SpringBoot + MyBatis-Plus + Dynamic-Datasource 读写分离完整指南"/> <meta itemprop="keywords" content="后端,数据库"/> <meta itemprop="datePublished" content="2025-11-11T14:00:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             SpringBoot + MyBatis-Plus + Dynamic-Datasource 读写分离完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T14:00:54.000Z" title="Tue Nov 11 2025 14:00:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在SpringBoot项目中，使用MyBatis-Plus和Dynamic-Datasource实现读写分离是一种常见且高效的架构选择。下面我将为你详细讲解完整的实现方案，包括环境准备、配置、代码实现以及注意事项。</p>
<h2 data-id="heading-0">1. 读写分离概述与核心概念</h2>
<p>读写分离是一种常见的数据库优化方案，其核心思想是将数据库的写操作（INSERT、UPDATE、DELETE）和读操作（SELECT）分发到不同的数据库节点上。主数据库（Master）负责处理所有写操作，而从数据库（Slave）负责处理读操作，通过数据库的主从复制机制保持数据同步。</p>
<h3 data-id="heading-1">1.1 核心价值</h3>
<ul>
<li><strong>提升并发性能</strong>：将读请求分散到多个从库，减轻主库压力</li>
<li><strong>提高系统可用性</strong>：单个从库故障不影响读服务</li>
<li><strong>优化响应速度</strong>：专库专用，避免读写操作相互阻塞</li>
</ul>
<h3 data-id="heading-2">1.2 技术架构</h3>
<pre><code class="hljs language-markdown" lang="markdown">应用程序 → Dynamic-Datasource → 主库（写操作）
<span class="hljs-code">                     ↓
                   从库（读操作）
</span></code></pre>
<p><em>图：读写分离架构示意图</em></p>
<h2 data-id="heading-3">2. 环境准备与依赖配置</h2>
<h3 data-id="heading-4">2.1 添加Maven依赖</h3>
<p>首先在项目的<code>pom.xml</code>中添加必要的依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Spring Boot Starter --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- MyBatis-Plus 启动器 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.3.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- Dynamic-Datasource 启动器（核心依赖） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>dynamic-datasource-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.6.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- MySQL 驱动 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.33<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 连接池（可选，HikariCP已内置） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.16<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<p><em>citation:2][citation:3</em></p>
<h3 data-id="heading-5">2.2 配置文件设置</h3>
<p>在<code>application.yml</code>中配置主从数据源：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">dynamic:</span>
      <span class="hljs-attr">primary:</span> <span class="hljs-string">master</span>  <span class="hljs-comment"># 设置默认数据源为主库</span>
      <span class="hljs-attr">strict:</span> <span class="hljs-literal">false</span>   <span class="hljs-comment"># 是否严格匹配数据源，false时未匹配到指定数据源则使用默认数据源</span>
      <span class="hljs-attr">datasource:</span>
        <span class="hljs-comment"># 主库配置（写操作）</span>
        <span class="hljs-attr">master:</span>
          <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://master-host:3306/core?useSSL=false&amp;serverTimezone=Asia/Shanghai</span>
          <span class="hljs-attr">username:</span> <span class="hljs-string">admin</span>
          <span class="hljs-attr">password:</span> <span class="hljs-string">master@123</span>
          <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
        <span class="hljs-comment"># 从库配置（读操作）- 支持多个从库</span>
        <span class="hljs-attr">slave1:</span>
          <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://slave1-host:3306/core?useSSL=false&amp;serverTimezone=Asia/Shanghai</span>
          <span class="hljs-attr">username:</span> <span class="hljs-string">readonly</span>
          <span class="hljs-attr">password:</span> <span class="hljs-string">slave@123</span>
          <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
        <span class="hljs-attr">slave2:</span>
          <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://slave2-host:3306/core?useSSL=false&amp;serverTimezone=Asia/Shanghai</span>
          <span class="hljs-attr">username:</span> <span class="hljs-string">readonly</span>
          <span class="hljs-attr">password:</span> <span class="hljs-string">slave@123</span>
          <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
      
      <span class="hljs-comment"># 负载均衡策略配置（多个从库时生效）</span>
      <span class="hljs-attr">strategy:</span> 
        <span class="hljs-attr">slave:</span> <span class="hljs-string">round_robin</span>  <span class="hljs-comment"># 从库负载均衡策略：random(随机)/round_robin(轮询)</span>
      
      <span class="hljs-comment"># 连接池配置（HikariCP）</span>
      <span class="hljs-attr">hikari:</span>
        <span class="hljs-attr">max-pool-size:</span> <span class="hljs-number">20</span>      <span class="hljs-comment"># 最大连接数</span>
        <span class="hljs-attr">min-idle:</span> <span class="hljs-number">5</span>           <span class="hljs-comment"># 最小空闲连接</span>
        <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>  <span class="hljs-comment"># 连接超时时间(ms)</span>
        <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">600000</span>  <span class="hljs-comment"># 空闲连接超时时间(ms)</span>
        <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">1800000</span> <span class="hljs-comment"># 连接最大生命周期(ms)</span>

<span class="hljs-comment"># MyBatis-Plus 配置</span>
<span class="hljs-attr">mybatis-plus:</span>
  <span class="hljs-attr">configuration:</span>
    <span class="hljs-attr">map-underscore-to-camel-case:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment"># 开启驼峰命名转换</span>
    <span class="hljs-attr">log-impl:</span> <span class="hljs-string">org.apache.ibatis.logging.stdout.StdOutImpl</span>  <span class="hljs-comment"># 打印SQL日志(调试用)</span>
  <span class="hljs-attr">global-config:</span>
    <span class="hljs-attr">db-config:</span>
      <span class="hljs-attr">id-type:</span> <span class="hljs-string">auto</span>  <span class="hljs-comment"># 主键策略自增</span>
</code></pre>
<p><em>citation:2][citation:6</em></p>
<h2 data-id="heading-6">3. 数据源与MyBatis-Plus配置类</h2>
<h3 data-id="heading-7">3.1 动态数据源自动配置</h3>
<p>Dynamic-Datasource starter已经提供了自动配置，大多数情况下无需额外配置。但如果需要自定义，可以创建配置类：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Configuration</span>
<span class="hljs-variable">@MapperScan</span>(<span class="hljs-string">"com.example.mapper"</span>)  <span class="hljs-comment">// 指定MyBatis mapper接口的扫描路径</span>
public class DataSourceConfig {
    
    <span class="hljs-comment">/**
     * 配置动态数据源
     * Dynamic-Datasource会自动根据application.yml的配置创建数据源
     * 此处可以添加自定义配置
     */</span>
    <span class="hljs-variable">@Bean</span>
    <span class="hljs-variable">@ConfigurationProperties</span>(prefix = <span class="hljs-string">"spring.datasource.dynamic"</span>)
    public DynamicDataSourceProperties <span class="hljs-built_in">dynamicDataSourceProperties</span>() {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">DynamicDataSourceProperties</span>();
    }
    
    <span class="hljs-comment">/**
     * 配置MyBatis-Plus拦截器（分页插件等）
     */</span>
    @<span class="hljs-selector-tag">Bean</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">MybatisPlusInterceptor</span> <span class="hljs-selector-tag">mybatisPlusInterceptor</span>() {
        <span class="hljs-selector-tag">MybatisPlusInterceptor</span> <span class="hljs-selector-tag">interceptor</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">MybatisPlusInterceptor</span>();
        <span class="hljs-comment">// 添加分页插件</span>
        <span class="hljs-selector-tag">PaginationInnerInterceptor</span> <span class="hljs-selector-tag">paginationInterceptor</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">PaginationInnerInterceptor</span>(DbType.MYSQL);
        <span class="hljs-selector-tag">paginationInterceptor</span><span class="hljs-selector-class">.setMaxLimit</span>(<span class="hljs-number">1000</span>L);  <span class="hljs-comment">// 设置最大分页限制</span>
        <span class="hljs-selector-tag">interceptor</span><span class="hljs-selector-class">.addInnerInterceptor</span>(paginationInterceptor);
        
        <span class="hljs-comment">// 可以添加其他插件，如乐观锁插件等</span>
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">interceptor</span>;
    }
}
</code></pre>
<p><em>citation:1][citation:5</em></p>
<h2 data-id="heading-8">4. 业务层实现读写分离</h2>
<h3 data-id="heading-9">4.1 使用@DS注解手动切换数据源</h3>
<p>最直接的方式是在Service层使用<code>@DS</code>注解指定数据源：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;UserMapper, User&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-comment">/**
     * 写操作：使用<span class="hljs-doctag">@DS</span>("master")指定主库
     * 注意：写操作建议都使用主库，确保数据一致性
     */</span>
    <span class="hljs-meta">@DS("master")</span>  <span class="hljs-comment">// 指定使用主库</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>  <span class="hljs-comment">// 添加事务管理</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">createUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-comment">// 参数校验</span>
        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span> || StringUtils.isBlank(user.getUsername())) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"用户信息不完整"</span>);
        }
        
        <span class="hljs-comment">// 设置创建时间</span>
        user.setCreateTime(LocalDateTime.now());
        user.setUpdateTime(LocalDateTime.now());
        
        <span class="hljs-comment">// 执行插入操作，这里会使用主库</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> save(user);
        
        <span class="hljs-comment">// 这里可以添加其他业务逻辑</span>
        log.info(<span class="hljs-string">"创建用户成功，用户ID: {}"</span>, user.getId());
        
        <span class="hljs-keyword">return</span> result;
    }
    
    <span class="hljs-comment">/**
     * 读操作：使用<span class="hljs-doctag">@DS</span>("slave")指定从库
     * 框架会根据负载均衡策略选择slave1或slave2
     */</span>
    <span class="hljs-meta">@DS("slave")</span>  <span class="hljs-comment">// 指定使用从库（负载均衡）</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-comment">// 参数校验</span>
        <span class="hljs-keyword">if</span> (id == <span class="hljs-literal">null</span> || id &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"用户ID不合法"</span>);
        }
        
        <span class="hljs-comment">// 查询用户信息，这里会使用从库</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> getById(id);
        
        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) {
            log.warn(<span class="hljs-string">"未找到对应用户，用户ID: {}"</span>, id);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"用户不存在"</span>);
        }
        
        <span class="hljs-keyword">return</span> user;
    }
    
    <span class="hljs-comment">/**
     * 批量查询：同样使用从库
     */</span>
    <span class="hljs-meta">@DS("slave")</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">listUsersByCondition</span><span class="hljs-params">(UserQuery query)</span> {
        <span class="hljs-comment">// 构建查询条件</span>
        LambdaQueryWrapper&lt;User&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();
        
        <span class="hljs-keyword">if</span> (StringUtils.isNotBlank(query.getUsername())) {
            wrapper.like(User::getUsername, query.getUsername());
        }
        
        <span class="hljs-keyword">if</span> (query.getStatus() != <span class="hljs-literal">null</span>) {
            wrapper.eq(User::getStatus, query.getStatus());
        }
        
        <span class="hljs-comment">// 添加排序</span>
        wrapper.orderByDesc(User::getCreateTime);
        
        <span class="hljs-comment">// 执行查询，使用从库</span>
        <span class="hljs-keyword">return</span> list(wrapper);
    }
    
    <span class="hljs-comment">/**
     * 更新操作：必须使用主库
     */</span>
    <span class="hljs-meta">@DS("master")</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">updateUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span> || user.getId() == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"用户信息不完整"</span>);
        }
        
        <span class="hljs-comment">// 设置更新时间</span>
        user.setUpdateTime(LocalDateTime.now());
        
        <span class="hljs-comment">// 执行更新，使用主库</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> updateById(user);
        
        <span class="hljs-keyword">if</span> (result) {
            log.info(<span class="hljs-string">"更新用户成功，用户ID: {}"</span>, user.getId());
        } <span class="hljs-keyword">else</span> {
            log.error(<span class="hljs-string">"更新用户失败，用户ID: {}"</span>, user.getId());
        }
        
        <span class="hljs-keyword">return</span> result;
    }
    
    <span class="hljs-comment">/**
     * 删除操作：必须使用主库
     */</span>
    <span class="hljs-meta">@DS("master")</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-keyword">if</span> (id == <span class="hljs-literal">null</span> || id &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"用户ID不合法"</span>);
        }
        
        <span class="hljs-comment">// 执行删除，使用主库</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> removeById(id);
        
        <span class="hljs-keyword">if</span> (result) {
            log.info(<span class="hljs-string">"删除用户成功，用户ID: {}"</span>, id);
        } <span class="hljs-keyword">else</span> {
            log.warn(<span class="hljs-string">"删除用户失败，用户ID: {}"</span>, id);
        }
        
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<p><em>citation:2][citation:8</em></p>
<h3 data-id="heading-10">4.2 基于AOP的自动数据源切换（推荐）</h3>
<p>对于大型项目，手动添加<code>@DS</code>注解比较繁琐，可以通过AOP自动根据方法类型切换数据源：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Aspect</span>
<span class="hljs-variable">@Component</span>
<span class="hljs-variable">@Slf4j</span>
public class DataSourceAspect {
    
    <span class="hljs-comment">/**
     * 定义切点：拦截Service层的所有方法
     */</span>
    <span class="hljs-variable">@Pointcut</span>(<span class="hljs-string">"execution(* com.example.service..*.*(..))"</span>)
    public void <span class="hljs-built_in">servicePointcut</span>() {}
    
    <span class="hljs-comment">/**
     * 前置通知：在方法执行前选择数据源
     */</span>
    <span class="hljs-variable">@Before</span>(<span class="hljs-string">"servicePointcut()"</span>)
    public void <span class="hljs-built_in">before</span>(JoinPoint joinPoint) {
        <span class="hljs-comment">// 获取方法名</span>
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">methodName</span> = <span class="hljs-selector-tag">joinPoint</span><span class="hljs-selector-class">.getSignature</span>()<span class="hljs-selector-class">.getName</span>();
        
        <span class="hljs-comment">// 根据方法名前缀判断是读操作还是写操作</span>
        <span class="hljs-selector-tag">if</span> (<span class="hljs-built_in">isReadOperation</span>(methodName)) {
            <span class="hljs-comment">// 读操作使用从库</span>
            <span class="hljs-selector-tag">DynamicDataSourceContextHolder</span><span class="hljs-selector-class">.push</span>(<span class="hljs-string">"slave"</span>);
            <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.debug</span>(<span class="hljs-string">"切换数据源到从库，方法名: {}"</span>, methodName);
        } <span class="hljs-selector-tag">else</span> {
            <span class="hljs-comment">// 写操作使用主库</span>
            <span class="hljs-selector-tag">DynamicDataSourceContextHolder</span><span class="hljs-selector-class">.push</span>(<span class="hljs-string">"master"</span>);
            <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.debug</span>(<span class="hljs-string">"切换数据源到主库，方法名: {}"</span>, methodName);
        }
    }
    
    <span class="hljs-comment">/**
     * 后置通知：清理数据源上下文
     */</span>
    @<span class="hljs-selector-tag">After</span>(<span class="hljs-string">"servicePointcut()"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">after</span>() {
        <span class="hljs-selector-tag">DynamicDataSourceContextHolder</span><span class="hljs-selector-class">.clear</span>();
        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.debug</span>(<span class="hljs-string">"清除数据源上下文"</span>);
    }
    
    <span class="hljs-comment">/**
     * 判断是否为读操作
     * 可以根据方法名前缀进行判断
     */</span>
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">boolean</span> <span class="hljs-selector-tag">isReadOperation</span>(String methodName) {
        <span class="hljs-comment">// 常见的读操作方法前缀</span>
        <span class="hljs-selector-tag">String</span><span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">readPrefixes</span> = {"<span class="hljs-selector-tag">get</span>", "<span class="hljs-selector-tag">select</span>", "<span class="hljs-selector-tag">list</span>", "<span class="hljs-selector-tag">query</span>", "<span class="hljs-selector-tag">find</span>", "<span class="hljs-selector-tag">search</span>", "<span class="hljs-selector-tag">count</span>", "<span class="hljs-selector-tag">check</span>"};
        
        <span class="hljs-selector-tag">for</span> (String <span class="hljs-attribute">prefix </span>: readPrefixes) {
            <span class="hljs-selector-tag">if</span> (methodName.<span class="hljs-built_in">startsWith</span>(prefix)) {
                <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">true</span>;
            }
        }
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">false</span>;
    }
}
</code></pre>
<p><em>citation:3][citation:7</em></p>
<p>使用AOP后，Service层的代码可以简化为：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-meta">@Service</span>
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ServiceImpl&lt;UserMapper</span>, <span class="hljs-title">User&gt;</span> <span class="hljs-title">implements</span> <span class="hljs-title">UserService</span> </span>{
    
    <span class="hljs-meta">@Transactional</span>(rollbackFor = <span class="hljs-type">Exception</span>.<span class="hljs-keyword">class</span>)
    <span class="hljs-meta">@Override</span>
    public boolean createUser(<span class="hljs-type">User</span> user) {
        <span class="hljs-comment">// 自动使用主库（AOP根据方法名判断）</span>
        user.setCreateTime(<span class="hljs-type">LocalDateTime</span>.now());
        <span class="hljs-keyword">return</span> save(user);
    }
    
    <span class="hljs-meta">@Override</span>
    public <span class="hljs-type">User</span> getUserById(<span class="hljs-type">Long</span> id) {
        <span class="hljs-comment">// 自动使用从库（AOP根据方法名前缀"get"判断）</span>
        <span class="hljs-keyword">return</span> getById(id);
    }
    
    <span class="hljs-comment">// 其他方法无需添加@DS注解，由AOP自动处理</span>
}
</code></pre>
<h2 data-id="heading-11">5. 事务处理策略</h2>
<p>事务处理是读写分离中的关键问题，需要特别注意：</p>
<h3 data-id="heading-12">5.1 单数据源事务</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Service</span>
public class OrderServiceImpl extends ServiceImpl&lt;OrderMapper, Order&gt; implements OrderService {
    
    <span class="hljs-comment">/**
     * 单数据源事务：所有操作都在主库执行
     * 使用@DS("master")确保即使有AOP配置也使用主库
     */</span>
    <span class="hljs-variable">@DS</span>(<span class="hljs-string">"master"</span>)  <span class="hljs-comment">// 显式指定主库</span>
    <span class="hljs-variable">@Transactional</span>(rollbackFor = Exception.class)  <span class="hljs-comment">// 声明式事务</span>
    <span class="hljs-variable">@Override</span>
    public void <span class="hljs-built_in">createOrder</span>(Order order) {
        <span class="hljs-comment">// 1. 保存订单主信息（主库）</span>
        <span class="hljs-selector-tag">save</span>(order);
        
        <span class="hljs-comment">// 2. 更新库存（主库）</span>
        <span class="hljs-selector-tag">updateStock</span>(order);
        
        <span class="hljs-comment">// 3. 记录操作日志（主库）</span>
        <span class="hljs-selector-tag">logOrderOperation</span>(order);
        
        <span class="hljs-comment">// 如果任何一步失败，整个事务回滚</span>
    }
    
    <span class="hljs-comment">/**
     * 只读事务：可以指定从库
     */</span>
    @<span class="hljs-selector-tag">DS</span>(<span class="hljs-string">"slave"</span>)
    @<span class="hljs-selector-tag">Transactional</span>(readOnly = true)  <span class="hljs-comment">// 只读事务，有优化效果</span>
    @<span class="hljs-selector-tag">Override</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">Order</span> <span class="hljs-selector-tag">getOrderDetail</span>(Long orderId) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">getById</span>(orderId);
    }
}
</code></pre>
<h3 data-id="heading-13">5.2 多数据源事务处理</h3>
<p>对于涉及多个数据源的复杂事务，需要使用分布式事务解决方案：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistributedTransactionService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderService orderService;
    
    <span class="hljs-comment">/**
     * 使用<span class="hljs-doctag">@DSTransactional</span>实现多数据源分布式事务
     * 注意：需要集成Seata等分布式事务框架
     */</span>
    <span class="hljs-comment">// @DSTransactional  // 分布式事务注解（需要额外配置）</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">placeOrder</span><span class="hljs-params">(Order order, User user)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 用户操作（主库）</span>
            userService.updateUser(user);
            
            <span class="hljs-comment">// 2. 订单操作（主库）</span>
            orderService.createOrder(order);
            
            <span class="hljs-comment">// 模拟业务异常</span>
            <span class="hljs-keyword">if</span> (order.getAmount() == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"订单金额不能为空"</span>);
            }
            
            log.info(<span class="hljs-string">"下单成功"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"下单失败，已回滚"</span>, e);
            <span class="hljs-keyword">throw</span> e;  <span class="hljs-comment">// 抛出异常触发回滚</span>
        }
    }
}
</code></pre>
<p><em>citation:7</em></p>
<h2 data-id="heading-14">6. 高级功能与优化策略</h2>
<h3 data-id="heading-15">6.1 多从库负载均衡</h3>
<p>当配置多个从库时，Dynamic-Datasource支持多种负载均衡策略：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">dynamic:</span>
      <span class="hljs-attr">datasource:</span>
        <span class="hljs-attr">master:</span>
          <span class="hljs-comment"># 主库配置...</span>
        <span class="hljs-attr">slave1:</span>
          <span class="hljs-comment"># 从库1配置...</span>
        <span class="hljs-attr">slave2:</span>
          <span class="hljs-comment"># 从库2配置...</span>
        <span class="hljs-attr">slave3:</span>
          <span class="hljs-comment"># 从库3配置...</span>
      <span class="hljs-attr">strategy:</span>
        <span class="hljs-attr">slave:</span> <span class="hljs-string">round_robin</span>  <span class="hljs-comment"># 负载均衡策略</span>
        <span class="hljs-comment"># 可选值:</span>
        <span class="hljs-comment"># random - 随机选择（默认）</span>
        <span class="hljs-comment"># round_robin - 轮询</span>
        <span class="hljs-comment"># weight_round_robin - 加权轮询（需要额外配置权重）</span>
</code></pre>
<p>负载均衡策略对比：</p>

























<table><thead><tr><th>策略类型</th><th>描述</th><th>适用场景</th></tr></thead><tbody><tr><td>random</td><td>随机选择从库</td><td>简单的读负载均衡</td></tr><tr><td>round_robin</td><td>轮询选择从库</td><td>从库配置相近，需要均匀分布</td></tr><tr><td>weight_round_robin</td><td>根据权重选择</td><td>从库配置不同，按性能分配负载</td></tr></tbody></table>
<p><em>citation:3][citation:7</em></p>
<h3 data-id="heading-16">6.2 健康检查与故障转移</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Component</span>
<span class="hljs-variable">@Slf4j</span>
public class DataSourceHealthCheck {
    
    <span class="hljs-variable">@Autowired</span>
    private DataSource dataSource;
    
    <span class="hljs-comment">/**
     * 定时检查从库健康状态
     */</span>
    <span class="hljs-variable">@Scheduled</span>(fixedRate = <span class="hljs-number">60000</span>)  <span class="hljs-comment">// 每分钟执行一次</span>
    public void <span class="hljs-built_in">checkSlaveHealth</span>() {
        <span class="hljs-comment">// 这里可以实现从库健康检查逻辑</span>
        <span class="hljs-comment">// 如果某个从库不可用，可以动态将其从负载均衡池中移除</span>
        
        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"执行从库健康检查..."</span>);
        <span class="hljs-comment">// 实际实现中可以使用JDBC测试连接或查询数据库状态</span>
    }
    
    <span class="hljs-comment">/**
     * 获取从库同步延迟
     */</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">Long</span> <span class="hljs-selector-tag">getReplicationDelay</span>(String slaveName) {
        <span class="hljs-comment">// 执行SQL查询从库同步状态</span>
        <span class="hljs-comment">// SHOW SLAVE STATUS 可以获取Seconds_Behind_Master等信息</span>
        <span class="hljs-comment">// 如果延迟过大，可以临时将该从库标记为不可用</span>
        
        <span class="hljs-selector-tag">return</span> <span class="hljs-number">0</span><span class="hljs-selector-tag">L</span>;  <span class="hljs-comment">// 返回延迟秒数</span>
    }
}
</code></pre>
<p><em>citation:2</em></p>
<h2 data-id="heading-17">7. 测试与验证</h2>
<h3 data-id="heading-18">7.1 单元测试</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@SpringBootTest</span>
<span class="hljs-keyword">@Slf</span>4j
class ReadWriteSeparationTest {
    
    <span class="hljs-keyword">@Autowired</span>
    private UserService userService;
    
    <span class="hljs-comment">/**
     * 测试写操作（应该路由到主库）
     */</span>
    <span class="hljs-keyword">@Test</span>
    void testWriteOperation() {
        User user = new <span class="hljs-built_in">User</span>();
        user<span class="hljs-selector-class">.setUsername</span>("testUser");
        user<span class="hljs-selector-class">.setEmail</span>("test@example.com");
        
        boolean result = userService<span class="hljs-selector-class">.createUser</span>(user);
        
        <span class="hljs-built_in">assertTrue</span>(result);
        log<span class="hljs-selector-class">.info</span>("写操作测试通过，应路由到主库");
    }
    
    <span class="hljs-comment">/**
     * 测试读操作（应该路由到从库）
     */</span>
    <span class="hljs-keyword">@Test</span>
    void testReadOperation() {
        User user = userService<span class="hljs-selector-class">.getUserById</span>(<span class="hljs-number">1</span>L);
        
        <span class="hljs-built_in">assertNotNull</span>(user);
        log<span class="hljs-selector-class">.info</span>("读操作测试通过，应路由到从库");
    }
    
    <span class="hljs-comment">/**
     * 测试事务内的数据源选择
     */</span>
    <span class="hljs-keyword">@Test</span>
    void testTransactionalOperation() {
        <span class="hljs-comment">// 测试事务方法，应始终使用主库</span>
        User user = userService<span class="hljs-selector-class">.getUserById</span>(<span class="hljs-number">1</span>L);
        <span class="hljs-built_in">assertNotNull</span>(user);
        
        log<span class="hljs-selector-class">.info</span>("事务内操作测试完成");
    }
}
</code></pre>
<h3 data-id="heading-19">7.2 验证数据源路由</h3>
<p>在<code>application.yml</code>中开启SQL日志，验证读写分离是否生效：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 开启MyBatis SQL日志</span>
<span class="hljs-attr">logging:</span>
  <span class="hljs-attr">level:</span>
    <span class="hljs-attr">com.example.mapper:</span> <span class="hljs-string">debug</span>  <span class="hljs-comment"># Mapper接口的包路径</span>
    <span class="hljs-attr">com.baomidou.dynamic.datasource:</span> <span class="hljs-string">debug</span>  <span class="hljs-comment"># Dynamic-Datasource日志</span>
</code></pre>
<p>观察控制台输出，应该能看到类似日志：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-number">2025</span><span class="hljs-number">-11</span><span class="hljs-number">-11</span> <span class="hljs-number">10</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> <span class="hljs-operator">|</span> Master DataSource  <span class="hljs-operator">|</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">user</span> ...
<span class="hljs-number">2025</span><span class="hljs-number">-11</span><span class="hljs-number">-11</span> <span class="hljs-number">10</span>:<span class="hljs-number">00</span>:<span class="hljs-number">05</span> <span class="hljs-operator">|</span> Slave DataSource   <span class="hljs-operator">|</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">user</span> ...
</code></pre>
<p><em>citation:3</em></p>
<h2 data-id="heading-20">8. 生产环境注意事项</h2>
<h3 data-id="heading-21">8.1 主从同步延迟处理</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CriticalReadService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserMapper userMapper;
    
    <span class="hljs-comment">/**
     * 对于一致性要求高的读操作，强制走主库
     */</span>
    <span class="hljs-meta">@DS(<span class="hljs-string">"master"</span>)</span>  <span class="hljs-comment">// 强制使用主库，避免读取旧数据</span>
    <span class="hljs-keyword">public</span> User getCriticalUserInfo(<span class="hljs-built_in">Long</span> userId) {
        <span class="hljs-comment">// 例如：账户余额、订单状态等关键信息</span>
        <span class="hljs-keyword">return</span> userMapper.selectById(userId);
    }
    
    <span class="hljs-comment">/**
     * 检查数据是否已同步
     */</span>
    <span class="hljs-keyword">public</span> boolean waitForReplication(<span class="hljs-built_in">Long</span> userId, int maxWaitSeconds) {
        <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; maxWaitSeconds; i++) {
            User masterUser = getFromMaster(userId);
            User slaveUser = getFromSlave(userId);
            
            <span class="hljs-keyword">if</span> (Objects.equals(masterUser, slaveUser)) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 数据已同步</span>
            }
            
            <span class="hljs-keyword">try</span> {
                Thread.sleep(<span class="hljs-number">1000</span>);  <span class="hljs-comment">// 等待1秒</span>
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                Thread.currentThread().interrupt();
                <span class="hljs-keyword">break</span>;
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// 同步超时</span>
    }
}
</code></pre>
<h3 data-id="heading-22">8.2 监控与告警</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 连接池监控配置</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">dynamic:</span>
      <span class="hljs-attr">druid:</span>
        <span class="hljs-comment"># 开启监控统计</span>
        <span class="hljs-attr">filters:</span> <span class="hljs-string">stat,wall,log4j</span>
        <span class="hljs-attr">web-stat-filter:</span>
          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
        <span class="hljs-attr">stat-view-servlet:</span>
          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
          <span class="hljs-attr">url-pattern:</span> <span class="hljs-string">/druid/*</span>
          <span class="hljs-attr">reset-enable:</span> <span class="hljs-literal">false</span>
          <span class="hljs-attr">login-username:</span> <span class="hljs-string">admin</span>
          <span class="hljs-attr">login-password:</span> <span class="hljs-string">admin</span>
</code></pre>
<h2 data-id="heading-23">9. 常见问题与解决方案</h2>
<h3 data-id="heading-24">9.1 事务内数据源切换失效</h3>
<p><strong>问题</strong>：在<code>@Transactional</code>方法内，数据源在方法开始时确定，方法内部调用无法切换数据源。</p>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Service</span>
public class TransactionalService {
    
    <span class="hljs-variable">@Autowired</span>
    private ApplicationContext applicationContext;
    
    <span class="hljs-variable">@Transactional</span>
    public void <span class="hljs-built_in">transactionalMethod</span>() {
        <span class="hljs-comment">// 方法内需要切换数据源时，通过代理对象调用</span>
        <span class="hljs-selector-tag">TransactionalService</span> <span class="hljs-selector-tag">self</span> = <span class="hljs-selector-tag">applicationContext</span><span class="hljs-selector-class">.getBean</span>(TransactionalService.class);
        
        <span class="hljs-comment">// 通过代理对象调用，可以正常切换数据源</span>
        <span class="hljs-selector-tag">self</span><span class="hljs-selector-class">.readOperation</span>();  <span class="hljs-comment">// 使用从库</span>
        <span class="hljs-selector-tag">self</span><span class="hljs-selector-class">.writeOperation</span>();  <span class="hljs-comment">// 使用主库</span>
    }
    
    @<span class="hljs-selector-tag">DS</span>(<span class="hljs-string">"slave"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">readOperation</span>() {
        <span class="hljs-comment">// 读操作</span>
    }
    
    <span class="hljs-variable">@DS</span>(<span class="hljs-string">"master"</span>)
    public void <span class="hljs-built_in">writeOperation</span>() {
        <span class="hljs-comment">// 写操作</span>
    }
}
</code></pre>
<h3 data-id="heading-25">9.2 动态增减数据源</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicDataSourceService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">DynamicDataSourceProvider</span> dataSourceProvider;
    
    <span class="hljs-comment">/**
     * 运行时动态添加数据源
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">addDataSource</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> dataSourceName, DataSourceProperty property</span>) {
        <span class="hljs-title class_">DynamicDataSourceContextHolder</span>.<span class="hljs-title function_">addDataSource</span>(dataSourceName, property);
        log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"动态添加数据源: {}"</span>, dataSourceName);
    }
    
    <span class="hljs-comment">/**
     * 运行时移除数据源
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">removeDataSource</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> dataSourceName</span>) {
        <span class="hljs-title class_">DynamicDataSourceContextHolder</span>.<span class="hljs-title function_">removeDataSource</span>(dataSourceName);
        log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"动态移除数据源: {}"</span>, dataSourceName);
    }
}
</code></pre>
<h2 data-id="heading-26">总结</h2>
<p>通过SpringBoot + MyBatis-Plus + Dynamic-Datasource实现读写分离，可以显著提升数据库读性能和高可用性。关键点包括：</p>
<ol>
<li><strong>正确配置</strong>：确保主从数据源配置正确，负载均衡策略合理</li>
<li><strong>合理使用注解</strong>：在适当的方法上使用<code>@DS</code>注解或通过AOP自动切换</li>
<li><strong>事务管理</strong>：注意事务内的数据源行为，关键操作强制走主库</li>
<li><strong>监控告警</strong>：建立完善的监控体系，及时发现主从延迟等问题</li>
<li><strong>故障处理</strong>：实现从库故障自动转移和恢复机制</li>
</ol>
<p>这种架构在读写比例高的应用中能带来显著的性能提升，但也需要处理好主从同步延迟等一致性问题。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在微服务架构下，如何结合Spring Cloud实现动态数据源的路由管理？]]></title>    <link>https://juejin.cn/post/7571306072422826026</link>    <guid>https://juejin.cn/post/7571306072422826026</guid>    <pubDate>2025-11-11T13:45:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571306072422826026" data-draft-id="7571299394345697322" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在微服务架构下，如何结合Spring Cloud实现动态数据源的路由管理？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-11T13:45:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在微服务架构下，如何结合Spring Cloud实现动态数据源的路由管理？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T13:45:03.000Z" title="Tue Nov 11 2025 13:45:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    24
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在微服务架构下，实现动态数据源路由是应对多租户、分库分表、读写分离等复杂场景的关键技术。它能显著提升系统的灵活性、可扩展性和数据处理能力。下面我将为您详细讲解几种主流的实现方案。</p>
<p>下表对比了三种主要的动态数据源路由方案，帮助您快速了解其核心特点：</p>

































<table><thead><tr><th>方案类型</th><th>核心机制</th><th>适用场景</th><th>优点</th><th>考虑因素</th></tr></thead><tbody><tr><td><strong>基于<code>AbstractRoutingDataSource</code>的自定义路由</strong></td><td>继承Spring抽象类，通过ThreadLocal上下文和AOP/注解动态路由</td><td>多租户（按租户ID分库）、业务分库、需要高度定制化路由逻辑的场景</td><td>灵活性极高，与Spring框架原生集成好，可完全掌控路由逻辑</td><td>需自行实现大部分代码（如AOP、上下文管理），复杂度较高</td></tr><tr><td><strong>基于<code>dynamic-datasource-spring-boot-starter</code>组件</strong></td><td>使用<code>@DS</code>注解在方法或类上声明式切换数据源</td><td>读写分离、一主多从、多种类型数据库混合连接</td><td>开箱即用，配置简单，内置负载均衡，极大减少编码量</td><td>路由逻辑的定制能力不如自定义方案灵活</td></tr><tr><td><strong>集成ShardingSphere进行分库分表</strong></td><td>作为客户端中间件，在JDBC层对SQL进行解析、路由、重写和结果归并</td><td>大规模数据分片、分库分表、读写分离+数据分片等复杂场景</td><td>功能强大，屏蔽底层数据库复杂性，支持分布式事务</td><td>架构较重，学习曲线较陡，对SQL有一定限制（如不支持跨库关联）</td></tr></tbody></table>
<h3 data-id="heading-0">💡 方案一：基于 <code>AbstractRoutingDataSource</code>的自定义路由</h3>
<p>这是Spring框架提供的基础能力，非常适合需要精细控制路由逻辑的场景，例如根据登录用户信息或特定的业务规则来选择数据库。</p>
<p><strong>实现步骤</strong></p>
<ol>
<li>
<p><strong>定义数据源上下文持有者</strong>：使用<code>ThreadLocal</code>来确保每个线程的数据源选择是隔离的，这是实现动态路由的核心。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceContextHolder</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-title class_">ThreadLocal</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-variable constant_">CONTEXT_HOLDER</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setDataSourceType</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> dataSourceType</span>) {
        <span class="hljs-variable constant_">CONTEXT_HOLDER</span>.<span class="hljs-title function_">set</span>(dataSourceType);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getDataSourceType</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">CONTEXT_HOLDER</span>.<span class="hljs-title function_">get</span>();
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">clearDataSourceType</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable constant_">CONTEXT_HOLDER</span>.<span class="hljs-title function_">remove</span>();
    }
}
</code></pre>
</li>
<li>
<p><strong>创建动态路由数据源</strong>：继承<code>AbstractRoutingDataSource</code>并重写<code>determineCurrentLookupKey</code>方法。</p>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DynamicRoutingDataSource</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractRoutingDataSource</span> </span>{
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">Object</span> determineCurrentLookupKey() {
        <span class="hljs-comment">// 该方法会在每次数据库操作前被调用，决定使用哪个数据源</span>
        <span class="hljs-keyword">return</span> <span class="hljs-type">DataSourceContextHolder</span>.getDataSourceType();
    }
}
</code></pre>
</li>
<li>
<p><strong>配置多个数据源并启用路由</strong>：在配置类中，将多个目标数据源（如<code>masterDataSource</code>, <code>slaveDataSource</code>) 注入到一个Map中，并设置为动态数据源的目标数据源。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Configuration</span>
public class DataSourceConfig {
    <span class="hljs-variable">@Bean</span>
    <span class="hljs-variable">@Primary</span>
    public DataSource <span class="hljs-built_in">dynamicDataSource</span>(DataSource masterDataSource, DataSource slaveDataSource) {
        <span class="hljs-selector-tag">Map</span>&lt;<span class="hljs-selector-tag">Object</span>, <span class="hljs-selector-tag">Object</span>&gt; <span class="hljs-selector-tag">targetDataSources</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">HashMap</span>&lt;&gt;();
        <span class="hljs-selector-tag">targetDataSources</span><span class="hljs-selector-class">.put</span>(<span class="hljs-string">"master"</span>, masterDataSource);
        <span class="hljs-selector-tag">targetDataSources</span><span class="hljs-selector-class">.put</span>(<span class="hljs-string">"slave"</span>, slaveDataSource);

        <span class="hljs-selector-tag">DynamicRoutingDataSource</span> <span class="hljs-selector-tag">routingDataSource</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">DynamicRoutingDataSource</span>();
        <span class="hljs-selector-tag">routingDataSource</span><span class="hljs-selector-class">.setDefaultTargetDataSource</span>(masterDataSource); <span class="hljs-comment">// 设置默认数据源</span>
        <span class="hljs-selector-tag">routingDataSource</span><span class="hljs-selector-class">.setTargetDataSources</span>(targetDataSources);
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">routingDataSource</span>;
    }
}
</code></pre>
</li>
<li>
<p><strong>使用AOP和自定义注解切换数据源</strong>：可以定义一个注解（如<code>@DataSource</code>），然后通过AOP切面，在方法执行前根据注解值切换数据源。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceAspect</span> {
    <span class="hljs-meta">@Before("@annotation(dataSource)")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeSwitchDataSource</span><span class="hljs-params">(JoinPoint joinPoint, DataSource dataSource)</span> {
        DataSourceContextHolder.setDataSourceType(dataSource.value());
    }
    <span class="hljs-meta">@After("@annotation(dataSource)")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterSwitchDataSource</span><span class="hljs-params">(JoinPoint joinPoint, DataSource dataSource)</span> {
        DataSourceContextHolder.clearDataSourceType(); <span class="hljs-comment">// 清理，防止内存泄漏</span>
    }
}
</code></pre>
</li>
</ol>
<h3 data-id="heading-1">🚀 方案二：使用 <code>dynamic-datasource-spring-boot-starter</code>组件</h3>
<p>对于常见的读写分离、一主多从场景，这是一个非常高效的选择，它能让你通过简单的配置和注解完成工作。</p>
<p><strong>实现步骤</strong></p>
<ol>
<li>
<p><strong>引入依赖</strong>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>dynamic-datasource-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span> <span class="hljs-comment">&lt;!-- 请使用最新版本 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
</li>
<li>
<p><strong>配置数据源</strong>：在<code>application.yml</code>中配置主从数据源。配置项以下划线<code>_</code>分割，相同前缀的数据源会被自动分组。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">dynamic:</span>
      <span class="hljs-attr">primary:</span> <span class="hljs-string">master</span> <span class="hljs-comment"># 设置默认数据源</span>
      <span class="hljs-attr">strict:</span> <span class="hljs-literal">false</span>   <span class="hljs-comment"># 是否严格匹配数据源</span>
      <span class="hljs-attr">datasource:</span>
        <span class="hljs-attr">master:</span>
          <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://ip1:3306/db</span>
          <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
          <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
        <span class="hljs-attr">slave_1:</span>
          <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://ip2:3306/db</span>
          <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
          <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
        <span class="hljs-attr">slave_2:</span>
          <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://ip3:3306/db</span>
          <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
          <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
</code></pre>
</li>
<li>
<p><strong>使用<code>@DS</code>注解切换</strong>：在Service层的方法或类上使用<code>@DS</code>注解，即可轻松切换。组件内置了同组数据源的负载均衡。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Service</span>
<span class="hljs-variable">@DS</span>(<span class="hljs-string">"slave"</span>) <span class="hljs-comment">// 类级别注解，此类下所有方法默认使用slave组（随机选择slave_1或slave_2）</span>
public class UserServiceImpl implements UserService {
    <span class="hljs-variable">@Override</span>
    <span class="hljs-variable">@DS</span>(<span class="hljs-string">"master"</span>) <span class="hljs-comment">// 方法级别注解优先，此方法使用master数据源</span>
    public void <span class="hljs-built_in">updateUser</span>(User user) {
        <span class="hljs-comment">// ... 更新操作</span>
    }
    <span class="hljs-variable">@Override</span>
    <span class="hljs-comment">// 未标注，使用类注解，即slave组</span>
    public User <span class="hljs-built_in">getUserById</span>(Long id) {
        <span class="hljs-comment">// ... 查询操作</span>
    }
}
</code></pre>
</li>
</ol>
<h3 data-id="heading-2">🔧 方案三：集成 ShardingSphere 进行分库分表</h3>
<p>当单库单表成为性能瓶颈时，ShardingSphere提供了强大的分库分表、读写分离及分布式事务能力。</p>
<p><strong>核心配置示例</strong></p>
<p>其配置核心是定义分片规则，例如根据用户ID（<code>user_id</code>）进行分库分表：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-attr">sharding:</span>
        <span class="hljs-attr">tables:</span>
          <span class="hljs-attr">t_user:</span>
            <span class="hljs-comment"># 指定实际的数据节点，表示数据分布在ds0和ds1两个库，每个库有t_user0到t_user3四张表</span>
            <span class="hljs-attr">actual-data-nodes:</span> <span class="hljs-string">ds$-&gt;{0..1}.t_user$-&gt;{0..3}</span>
            <span class="hljs-comment"># 分库策略</span>
            <span class="hljs-attr">database-strategy:</span>
              <span class="hljs-attr">standard:</span>
                <span class="hljs-attr">sharding-column:</span> <span class="hljs-string">user_id</span>
                <span class="hljs-attr">sharding-algorithm-name:</span> <span class="hljs-string">database-inline</span>
            <span class="hljs-comment"># 分表策略</span>
            <span class="hljs-attr">table-strategy:</span>
              <span class="hljs-attr">standard:</span>
                <span class="hljs-attr">sharding-column:</span> <span class="hljs-string">user_id</span>
                <span class="hljs-attr">sharding-algorithm-name:</span> <span class="hljs-string">table-inline</span>
        <span class="hljs-comment"># 定义分片算法</span>
        <span class="hljs-attr">sharding-algorithms:</span>
          <span class="hljs-attr">database-inline:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">INLINE</span>
            <span class="hljs-attr">props:</span>
              <span class="hljs-attr">algorithm-expression:</span> <span class="hljs-string">ds$-&gt;{user_id</span> <span class="hljs-string">%</span> <span class="hljs-number">2</span><span class="hljs-string">}</span> <span class="hljs-comment"># 分库算法：user_id % 2</span>
          <span class="hljs-attr">table-inline:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">INLINE</span>
            <span class="hljs-attr">props:</span>
              <span class="hljs-attr">algorithm-expression:</span> <span class="hljs-string">t_user$-&gt;{user_id</span> <span class="hljs-string">%</span> <span class="hljs-number">4</span><span class="hljs-string">}</span> <span class="hljs-comment"># 分表算法：user_id % 4</span>
</code></pre>
<h3 data-id="heading-3">⚠️ 关键注意事项与实践建议</h3>
<p>无论选择哪种方案，以下几点都需要特别关注：</p>
<ul>
<li><strong>事务管理</strong>：在使用了动态数据源切换的方法中，尤其是跨不同物理数据库的操作，<strong>需要谨慎处理事务</strong>。Spring的<code>@Transactional</code>注解通常在一个事务内会使用同一个数据源连接。如果需要在事务中切换数据源，可能需要更复杂的处理，例如使用分布式事务（JTA）。</li>
<li><strong>连接池配置</strong>：为每个数据源配置合适的连接池参数（如<code>HikariCP</code>或<code>Druid</code>的<code>maximum-pool-size</code>, <code>connection-timeout</code>），这对系统性能和稳定性至关重要。</li>
<li><strong>配置信息加密与安全</strong>：生产环境中，数据库密码等敏感信息不应明文写在配置文件中。可以使用<code>Jasypt</code>等工具进行加密，或结合Spring Cloud Config、Nacos等<strong>配置中心</strong>统一管理加密后的配置。</li>
<li><strong>链路追踪与监控</strong>：在微服务架构下，一个请求可能涉及多个数据源的操作。可以集成<strong>Spring Cloud Sleuth</strong>等组件，将数据源切换的关键信息（如数据源名称）添加到链路追踪的Span标签中，便于问题排查和性能分析。</li>
</ul>
<h3 data-id="heading-4">💎 总结与选择</h3>
<p>选择哪种方案，最终取决于您的具体业务需求和技术考量：</p>
<ul>
<li>如果只是简单的<strong>读写分离</strong>或<strong>一主多从</strong>，追求快速实现，<strong><code>dynamic-datasource-spring-boot-starter</code>组件是首选</strong>。</li>
<li>如果路由逻辑非常<strong>个性化</strong>（如根据复杂业务规则选择数据库），那么基于 <strong><code>AbstractRoutingDataSource</code>的自定义路由</strong>提供了最大的灵活性。</li>
<li>如果面临<strong>海量数据</strong>，需要进行<strong>分库分表</strong>，那么<strong>ShardingSphere</strong>是更专业和强大的选择。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🏗️ Spring Boot 3实现MySQL读写分离完整指南]]></title>    <link>https://juejin.cn/post/7571304204754649142</link>    <guid>https://juejin.cn/post/7571304204754649142</guid>    <pubDate>2025-11-11T13:35:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571304204754649142" data-draft-id="7571306072422793258" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🏗️ Spring Boot 3实现MySQL读写分离完整指南"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2025-11-11T13:35:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🏗️ Spring Boot 3实现MySQL读写分离完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T13:35:49.000Z" title="Tue Nov 11 2025 13:35:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">✨ 读写分离的核心价值</h2>
<p>在高并发场景下，数据库往往成为系统瓶颈。读写分离通过将写操作定向到主库、读操作分发到从库，显著提升系统读性能和数据可用性。当主库出现故障时，从库可以继续提供读服务，提高系统的稳定性。</p>
<h2 data-id="heading-1">⚙️ 项目依赖配置</h2>
<p>首先在<code>pom.xml</code>中添加必要依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.33<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.zaxxer<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>HikariCP<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h2 data-id="heading-2">📁 核心实现代码详解</h2>
<h3 data-id="heading-3">1. 配置文件设置（application.yml）</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-comment"># 主库配置（写操作）</span>
    <span class="hljs-attr">master:</span>
      <span class="hljs-attr">jdbc-url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/master_db?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=Asia/Shanghai</span>
      <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
      <span class="hljs-attr">password:</span> <span class="hljs-string">master_password</span>
      <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
      <span class="hljs-comment"># Hikari连接池配置</span>
      <span class="hljs-attr">hikari:</span>
        <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">10</span>
        <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">5</span>
        <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">30000</span>
        <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">1800000</span>
        <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
        <span class="hljs-attr">connection-test-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span>
    <span class="hljs-comment"># 从库配置（读操作）</span>
    <span class="hljs-attr">slave:</span>
      <span class="hljs-attr">jdbc-url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/slave_db?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=Asia/Shanghai</span>
      <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
      <span class="hljs-attr">password:</span> <span class="hljs-string">slave_password</span>
      <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
      <span class="hljs-attr">hikari:</span>
        <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">15</span>  <span class="hljs-comment"># 从库可以配置更多连接，因为读操作通常更频繁</span>
        <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">8</span>
        <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">30000</span>
        <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">1800000</span>
        <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
        <span class="hljs-attr">connection-test-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span>
</code></pre>
<h3 data-id="heading-4">2. 数据源枚举定义</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">/**
 * 数据源类型枚举
 * 用于标识当前操作应使用主库还是从库
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">DataSourceType</span> {
    MASTER,  <span class="hljs-comment">// 主库：用于写操作（INSERT、UPDATE、DELETE）</span>
    SLAVE    <span class="hljs-comment">// 从库：用于读操作（SELECT）</span>
}
</code></pre>
<h3 data-id="heading-5">3. 数据源上下文管理器</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">/**
 * 数据源上下文管理器（基于ThreadLocal实现线程隔离）
 * 功能：保存当前线程使用的数据源类型，确保多线程环境下数据源切换不会相互干扰
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DataSourceContextHolder</span> {
    
    <span class="hljs-comment">// 使用ThreadLocal保证线程安全，每个线程有独立的数据源上下文</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final ThreadLocal&lt;DataSourceType&gt; CONTEXT_HOLDER = <span class="hljs-keyword">new</span> ThreadLocal&lt;&gt;();
    
    <span class="hljs-comment">/**
     * 设置当前线程的数据源类型
     * @param dataSourceType 数据源类型（MASTER或SLAVE）
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setDataSourceType</span>(<span class="hljs-params">DataSourceType dataSourceType</span>)</span> {
        CONTEXT_HOLDER.<span class="hljs-keyword">set</span>(dataSourceType);
    }
    
    <span class="hljs-comment">/**
     * 获取当前线程的数据源类型
     * @return 当前数据源类型，默认为MASTER（保证写操作可靠性）
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> DataSourceType <span class="hljs-title">getDataSourceType</span>()</span> {
        <span class="hljs-keyword">return</span> CONTEXT_HOLDER.<span class="hljs-keyword">get</span>() == <span class="hljs-literal">null</span> ? DataSourceType.MASTER : CONTEXT_HOLDER.<span class="hljs-keyword">get</span>();
    }
    
    <span class="hljs-comment">/**
     * 清除当前线程的数据源类型
     * 防止内存泄漏，特别是在线程池场景下
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">clearDataSourceType</span>()</span> {
        CONTEXT_HOLDER.<span class="hljs-keyword">remove</span>();
    }
}
</code></pre>
<h3 data-id="heading-6">4. 动态路由数据源</h3>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">/**
 * 动态路由数据源（继承Spring的AbstractRoutingDataSource）
 * 核心功能：根据当前上下文动态选择主库或从库
 */</span>
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DynamicRoutingDataSource</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractRoutingDataSource</span> </span>{
    
    <span class="hljs-comment">/**
     * 决定当前数据源查找键（Spring在每次数据库操作前调用此方法）
     * @return 数据源查找键（MASTER或SLAVE）
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">Object</span> determineCurrentLookupKey() {
        <span class="hljs-type">DataSourceType</span> dataSourceType = <span class="hljs-type">DataSourceContextHolder</span>.getDataSourceType();
        <span class="hljs-type">System</span>.out.println(<span class="hljs-string">"当前使用的数据源: "</span> + dataSourceType);
        <span class="hljs-keyword">return</span> dataSourceType;
    }
}
</code></pre>
<h3 data-id="heading-7">5. 数据源配置类</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">/**
 * 数据源配置类（核心配置）
 * 配置主从数据源并初始化路由数据源
 */</span>
<span class="hljs-variable">@Configuration</span>
<span class="hljs-variable">@EnableTransactionManagement</span>
<span class="hljs-variable">@EnableJpaRepositories</span>(
    basePackages = <span class="hljs-string">"com.example.repository"</span>,
    entityManagerFactoryRef = <span class="hljs-string">"entityManagerFactory"</span>,
    transactionManagerRef = <span class="hljs-string">"transactionManager"</span>
)
public class DataSourceConfig {
    
    <span class="hljs-comment">/**
     * 主库数据源（写操作）
     */</span>
    <span class="hljs-variable">@Bean</span>(name = <span class="hljs-string">"masterDataSource"</span>)
    <span class="hljs-variable">@ConfigurationProperties</span>(prefix = <span class="hljs-string">"spring.datasource.master"</span>)
    public DataSource <span class="hljs-built_in">masterDataSource</span>() {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">DataSourceBuilder</span><span class="hljs-selector-class">.create</span>()<span class="hljs-selector-class">.build</span>();
    }
    
    <span class="hljs-comment">/**
     * 从库数据源（读操作）
     */</span>
    @<span class="hljs-selector-tag">Bean</span>(name = <span class="hljs-string">"slaveDataSource"</span>)
    @<span class="hljs-selector-tag">ConfigurationProperties</span>(prefix = <span class="hljs-string">"spring.datasource.slave"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">DataSource</span> <span class="hljs-selector-tag">slaveDataSource</span>() {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">DataSourceBuilder</span><span class="hljs-selector-class">.create</span>()<span class="hljs-selector-class">.build</span>();
    }
    
    <span class="hljs-comment">/**
     * 动态路由数据源（优先级最高，作为主数据源）
     */</span>
    @<span class="hljs-selector-tag">Primary</span>
    @<span class="hljs-selector-tag">Bean</span>(name = <span class="hljs-string">"routingDataSource"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">DataSource</span> <span class="hljs-selector-tag">routingDataSource</span>(
            <span class="hljs-variable">@Qualifier</span>(<span class="hljs-string">"masterDataSource"</span>) DataSource masterDataSource,
            <span class="hljs-variable">@Qualifier</span>(<span class="hljs-string">"slaveDataSource"</span>) DataSource slaveDataSource) {
        
        <span class="hljs-selector-tag">DynamicRoutingDataSource</span> <span class="hljs-selector-tag">routingDataSource</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">DynamicRoutingDataSource</span>();
        
        <span class="hljs-comment">// 配置目标数据源映射</span>
        <span class="hljs-selector-tag">Map</span>&lt;<span class="hljs-selector-tag">Object</span>, <span class="hljs-selector-tag">Object</span>&gt; <span class="hljs-selector-tag">targetDataSources</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">HashMap</span>&lt;&gt;();
        <span class="hljs-selector-tag">targetDataSources</span><span class="hljs-selector-class">.put</span>(DataSourceType.MASTER, masterDataSource);
        <span class="hljs-selector-tag">targetDataSources</span><span class="hljs-selector-class">.put</span>(DataSourceType.SLAVE, slaveDataSource);
        
        <span class="hljs-selector-tag">routingDataSource</span><span class="hljs-selector-class">.setTargetDataSources</span>(targetDataSources);
        <span class="hljs-selector-tag">routingDataSource</span><span class="hljs-selector-class">.setDefaultTargetDataSource</span>(masterDataSource); <span class="hljs-comment">// 默认使用主库</span>
        
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">routingDataSource</span>;
    }
    
    <span class="hljs-comment">/**
     * 实体管理器工厂
     */</span>
    @<span class="hljs-selector-tag">Bean</span>(name = <span class="hljs-string">"entityManagerFactory"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">LocalContainerEntityManagerFactoryBean</span> <span class="hljs-selector-tag">entityManagerFactory</span>(
            EntityManagerFactoryBuilder builder, 
            <span class="hljs-variable">@Qualifier</span>(<span class="hljs-string">"routingDataSource"</span>) DataSource dataSource) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">builder</span>
            <span class="hljs-selector-class">.dataSource</span>(dataSource)
            <span class="hljs-selector-class">.packages</span>(<span class="hljs-string">"com.example.entity"</span>)
            <span class="hljs-selector-class">.persistenceUnit</span>(<span class="hljs-string">"mysqlUnit"</span>)
            <span class="hljs-selector-class">.build</span>();
    }
    
    <span class="hljs-comment">/**
     * 事务管理器
     */</span>
    @<span class="hljs-selector-tag">Bean</span>(name = <span class="hljs-string">"transactionManager"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">PlatformTransactionManager</span> <span class="hljs-selector-tag">transactionManager</span>(
            <span class="hljs-variable">@Qualifier</span>(<span class="hljs-string">"entityManagerFactory"</span>) EntityManagerFactory entityManagerFactory) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">JpaTransactionManager</span>(entityManagerFactory);
    }
}
</code></pre>
<h3 data-id="heading-8">6. AOP切面实现自动路由</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 数据源切面配置（基于AOP自动切换数据源）
 * 通过方法名自动识别读写操作，实现数据源动态路由
 */</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Order(1)</span> <span class="hljs-comment">// 确保在事务切面之前执行</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceAspect</span> {
    
    <span class="hljs-comment">/**
     * 写操作切点（insert、update、delete、save开头的方法）
     */</span>
    <span class="hljs-meta">@Before("execution(* com.example.service..*.create*(..)) || " +
            "execution(* com.example.service..*.update*(..)) || " +
            "execution(* com.example.service..*.delete*(..)) || " +
            "execution(* com.example.service..*.save*(..))")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setWriteDataSourceType</span><span class="hljs-params">()</span> {
        DataSourceContextHolder.setDataSourceType(DataSourceType.MASTER);
        System.out.println(<span class="hljs-string">"切换到主库（写操作）"</span>);
    }
    
    <span class="hljs-comment">/**
     * 读操作切点（select、get、find、query开头的方法）
     */</span>
    <span class="hljs-meta">@Before("execution(* com.example.service..*.select*(..)) || " +
            "execution(* com.example.service..*.get*(..)) || " +
            "execution(* com.example.service..*.find*(..)) || " +
            "execution(* com.example.service..*.query*(..))")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setReadDataSourceType</span><span class="hljs-params">()</span> {
        DataSourceContextHolder.setDataSourceType(DataSourceType.SLAVE);
        System.out.println(<span class="hljs-string">"切换到从库（读操作）"</span>);
    }
    
    <span class="hljs-comment">/**
     * 后置处理：清理数据源上下文
     */</span>
    <span class="hljs-meta">@After("execution(* com.example.service..*.*(..))")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearDataSourceType</span><span class="hljs-params">()</span> {
        DataSourceContextHolder.clearDataSourceType();
        System.out.println(<span class="hljs-string">"清理数据源上下文"</span>);
    }
}
</code></pre>
<h3 data-id="heading-9">7. 业务层使用示例</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * 用户服务实现类
 * 演示读写分离的实际应用
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">UserRepository</span> userRepository;
    
    <span class="hljs-comment">/**
     * 新增用户（写操作自动路由到主库）
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">User</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">User user</span>) {
        <span class="hljs-comment">// 方法名以"create"开头，AOP会自动切换到MASTER数据源</span>
        <span class="hljs-keyword">return</span> userRepository.<span class="hljs-title function_">save</span>(user);
    }
    
    <span class="hljs-comment">/**
     * 根据ID查询用户（读操作自动路由到从库）
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Transactional</span>(readOnly = <span class="hljs-literal">true</span>) <span class="hljs-comment">// 只读事务优化性能</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">User</span> <span class="hljs-title function_">getUserById</span>(<span class="hljs-params">Long id</span>) {
        <span class="hljs-comment">// 方法名以"get"开头，AOP会自动切换到SLAVE数据源</span>
        <span class="hljs-keyword">return</span> userRepository.<span class="hljs-title function_">findById</span>(id).<span class="hljs-title function_">orElse</span>(<span class="hljs-literal">null</span>);
    }
    
    <span class="hljs-comment">/**
     * 查询所有用户（读操作）
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Transactional</span>(readOnly = <span class="hljs-literal">true</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">User</span>&gt; <span class="hljs-title function_">getAllUsers</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> userRepository.<span class="hljs-title function_">findAll</span>();
    }
    
    <span class="hljs-comment">/**
     * 更新用户信息（写操作）
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">User</span> <span class="hljs-title function_">updateUser</span>(<span class="hljs-params">User user</span>) {
        <span class="hljs-keyword">return</span> userRepository.<span class="hljs-title function_">save</span>(user);
    }
}
</code></pre>
<h2 data-id="heading-10">🔍 测试与验证</h2>
<h3 data-id="heading-11">单元测试类</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">/**
 * 读写分离测试类
 */</span>
<span class="hljs-keyword">@SpringBootTest</span>
class ReadWriteSeparationTest {
    
    <span class="hljs-keyword">@Autowired</span>
    private UserService userService;
    
    <span class="hljs-comment">/**
     * 测试写操作（应路由到主库）
     */</span>
    <span class="hljs-keyword">@Test</span>
    void testWriteOperation() {
        User user = new <span class="hljs-built_in">User</span>();
        user<span class="hljs-selector-class">.setUsername</span>("testUser");
        user<span class="hljs-selector-class">.setPassword</span>("password");
        
        User savedUser = userService<span class="hljs-selector-class">.createUser</span>(user);
        
        Assertions<span class="hljs-selector-class">.assertNotNull</span>(savedUser.getId());
        System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("写操作测试通过（路由到主库）");
    }
    
    <span class="hljs-comment">/**
     * 测试读操作（应路由到从库）
     */</span>
    <span class="hljs-keyword">@Test</span>
    void testReadOperation() {
        List&lt;User&gt; users = userService<span class="hljs-selector-class">.getAllUsers</span>();
        
        Assertions<span class="hljs-selector-class">.assertNotNull</span>(users);
        System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("读操作测试通过（路由到从库）");
    }
    
    <span class="hljs-comment">/**
     * 测试读写混合操作
     */</span>
    <span class="hljs-keyword">@Test</span>
    void testReadWriteMix() {
        <span class="hljs-comment">// 写操作</span>
        User user = new <span class="hljs-built_in">User</span>();
        user<span class="hljs-selector-class">.setUsername</span>("mixUser");
        userService<span class="hljs-selector-class">.createUser</span>(user);
        
        <span class="hljs-comment">// 读操作</span>
        User foundUser = userService<span class="hljs-selector-class">.getUserById</span>(<span class="hljs-number">1</span>L);
        
        Assertions<span class="hljs-selector-class">.assertNotNull</span>(foundUser);
        System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("读写混合操作测试通过");
    }
}
</code></pre>
<h2 data-id="heading-12">⚠️ 关键注意事项</h2>
<h3 data-id="heading-13">1. 主从同步延迟处理</h3>
<p>在读写分离架构中，主从同步存在延迟可能性。刚写入主库的数据可能不会立即在从库中可用。</p>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">/**
 * 强制读主库的场景
 */</span>
<span class="hljs-keyword">@Service</span>
public class CriticalService {
    
    <span class="hljs-keyword">@Autowired</span>
    private UserRepository userRepository;
    
    <span class="hljs-comment">/**
     * 重要业务：写入后立即读取，强制走主库
     */</span>
    public User <span class="hljs-built_in">createAndGetUser</span>(User user) {
        <span class="hljs-comment">// 写入主库</span>
        User savedUser = userRepository<span class="hljs-selector-class">.save</span>(user);
        
        <span class="hljs-comment">// 强制从主库读取（避免同步延迟）</span>
        DataSourceContextHolder<span class="hljs-selector-class">.setDataSourceType</span>(DataSourceType.MASTER);
        try {
            return userRepository<span class="hljs-selector-class">.findById</span>(savedUser.getId())<span class="hljs-selector-class">.orElse</span>(null);
        } finally {
            DataSourceContextHolder<span class="hljs-selector-class">.clearDataSourceType</span>();
        }
    }
}
</code></pre>
<h3 data-id="heading-14">2. 事务中的数据处理</h3>
<p>在事务中，所有操作应使用同一数据源。</p>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionalService</span> {
    
    <span class="hljs-comment">/**
     * 事务内强制使用主库
     */</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">complexBusinessOperation</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 方法开始时显式设置主库，确保事务内一致性</span>
        <span class="hljs-title class_">DataSourceContextHolder</span>.<span class="hljs-title function_">setDataSourceType</span>(<span class="hljs-title class_">DataSourceType</span>.<span class="hljs-property">MASTER</span>);
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 一系列数据库操作...</span>
            <span class="hljs-comment">// 所有这些操作都在同一事务中，使用同一数据源</span>
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 事务结束后清理</span>
            <span class="hljs-title class_">DataSourceContextHolder</span>.<span class="hljs-title function_">clearDataSourceType</span>();
        }
    }
}
</code></pre>
<h2 data-id="heading-15">📊 方案优缺点分析</h2>

























<table><thead><tr><th>优势</th><th>挑战</th><th>应对策略</th></tr></thead><tbody><tr><td>提升读性能：将读请求分发到从库</td><td>主从同步延迟</td><td>关键业务强制读主库</td></tr><tr><td>提高可用性：主库故障时从库可读</td><td>事务内数据源一致性</td><td>事务中强制使用主库</td></tr><tr><td>减轻主库压力</td><td>复杂SQL路由</td><td>明确的读写操作分离</td></tr></tbody></table>
<h2 data-id="heading-16">💎 总结</h2>
<p>通过以上完整的Spring Boot 3实现方案，你可以成功配置MySQL读写分离。关键在于理解动态数据源路由原理，合理处理主从同步延迟和事务一致性等挑战。这种架构能显著提升系统性能，特别适合读多写少的应用场景。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 内存管理是如何工作的?]]></title>    <link>https://juejin.cn/post/7571594817224310835</link>    <guid>https://juejin.cn/post/7571594817224310835</guid>    <pubDate>2025-11-12T10:18:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571594817224310835" data-draft-id="7571637614203486235" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 内存管理是如何工作的?"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-12T10:18:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="404星球的猫"/> <meta itemprop="url" content="https://juejin.cn/user/193147068224126"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 内存管理是如何工作的?
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/193147068224126/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    404星球的猫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T10:18:06.000Z" title="Wed Nov 12 2025 10:18:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">1. 开场白：看不见的房间管家</h4>
<p>写 JS 的你我，几乎从不手动 <code>malloc</code>/<code>free</code>，但这不代表内存管理“不存在”。<br/>
JavaScript 引擎就像一位<strong>房间管家</strong>：</p>
<ul>
<li>你买东西（创建变量）→ 管家帮你找空位；</li>
<li>你用完扔一边（解除引用）→ 管家扫进垃圾桶；</li>
<li>你若一直占着茅坑不拉屎（内存泄漏）→ 管家也无可奈何。</li>
</ul>
<p>理解管家的工作方式，才能让应用<strong>不爆内存、不卡顿、不 OOM</strong>。</p>
<hr/>
<h4 data-id="heading-1">2. 两张图看懂“东西”放哪儿</h4>























<table><thead><tr><th>存储区域</th><th>放什么</th><th>特点</th><th>生命周期</th></tr></thead><tbody><tr><td><strong>Stack</strong> 栈</td><td>原始值（<code>number</code>、<code>boolean</code>、<code>undefined</code>、<code>null</code>、<code>string</code>、<code>symbol</code>、<code>bigint</code>）</td><td>固定大小、后进先出、超快</td><td>函数 return 即自动弹栈</td></tr><tr><td><strong>Heap</strong> 堆</td><td>引用值（<code>Object</code>、<code>Array</code>、<code>Function</code>、<code>Date</code>、<code>RegExp</code>…）</td><td>动态大小、可按引用共享、稍慢</td><td>靠垃圾回收器（GC）稍后清理</td></tr></tbody></table>
<p>代码示例</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> age  = <span class="hljs-number">18</span>;        <span class="hljs-comment">// 栈</span>
<span class="hljs-keyword">let</span> user = {age};     <span class="hljs-comment">// 栈里只存指针，实际对象在堆</span>
</code></pre>
<hr/>
<h4 data-id="heading-2">3. 垃圾回收三部曲</h4>
<p>现代引擎默认采用**“标记-清除”（Mark-and-Sweep）<strong>算法，配合</strong>“分代回收”**优化。</p>
<h5 data-id="heading-3">3.1 标记阶段（Mark）</h5>
<p>从一组**根（Roots）**出发：</p>
<ul>
<li>当前调用栈里的局部变量；</li>
<li>全局对象（<code>window</code>、<code>globalThis</code>）；</li>
<li>被 Chrome DevTools 断点 Hold 住的变量…</li>
</ul>
<p>把所有能访问到的对象打上 <strong>“在用”</strong> 标签，其余都是 <strong>“垃圾”</strong>。</p>
<h5 data-id="heading-4">3.2 清除阶段（Sweep）</h5>
<p>线性扫堆，把没标签的对象直接释放；<br/>
内存空隙由<strong>空闲链表</strong>或<strong>按页压缩</strong>整理，避免碎片化。</p>
<h5 data-id="heading-5">3.3 分代优化（Generational GC）</h5>
<p>V8 把堆再细分为：</p>
<ul>
<li><strong>新生代</strong>（1~8 M）：短命对象，采用 <strong>Scavenge</strong>（复制回收），频率高、停顿短；</li>
<li><strong>老生代</strong>：多次幸存的大对象、长寿命对象，采用 <strong>Mark-Sweep + Mark-Compact</strong>，频率低、停顿长。</li>
</ul>
<blockquote>
<p>实测：95% 的对象 20ms 内就死，分代后 GC 吞吐量提升 5~10 倍。</p>
</blockquote>
<hr/>
<h4 data-id="heading-6">4. 四种常见内存泄漏与排查清单</h4>






























<table><thead><tr><th>泄漏场景</th><th>代码味道</th><th>修复要点</th></tr></thead><tbody><tr><td>1. 意外全局变量</td><td><code>function f(){ leaky="oops" }</code></td><td><code>'use strict'</code> + ESLint <code>no-undef</code></td></tr><tr><td>2. 忘记清理定时器</td><td><code>setInterval(()=&gt;{…},1000)</code></td><td><code>const t=setInterval(...);</code> 卸载时 <code>clearInterval(t)</code></td></tr><tr><td>3. 闭包捕“大”不放</td><td><code>return ()=&gt;console.log('hi')</code> 却捕获了 <code>new Array(1e6)</code></td><td>只把必要变量闭进去，或手动 <code>largeData=null</code></td></tr><tr><td>4. 游离 DOM + 监听器</td><td><code>removeChild(node)</code> 后仍保留 <code>node</code> 引用</td><td><code>node.remove(); node=null;</code> 同时 <code>off()</code> 监听器</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-7">5. 开发者必备：Chrome DevTools 三板斧</h4>
<ol>
<li><strong>Performance Monitor</strong><br/>
实时折线图：JS heap size、DOM 节点、事件监听器数量。</li>
<li><strong>Heap Snapshot</strong><br/>
对比两次快照，按 <strong>“Retained Size”</strong> 排序，轻松找出“大胃王”。</li>
<li><strong>Allocation Timeline</strong><br/>
录制 30 秒用户操作，蓝色竖线表示新生代分配，峰值即潜在泄漏点。</li>
</ol>
<hr/>
<h4 data-id="heading-8">6. 进阶：WeakMap / WeakRef 让 GC 更聪明</h4>
<ul>
<li><code>WeakMap</code> 只保存<strong>弱引用</strong>，键对象被回收时，映射条目自动消失；</li>
<li><code>WeakRef</code> 允许你<strong>观察</strong>对象是否已被 GC，而不阻止其被回收；</li>
<li>适合缓存、DOM 元数据映射，<strong>不增加额外可达路径</strong>。</li>
</ul>
<hr/>
<h4 data-id="heading-9">7. 一句话总结</h4>
<p>JavaScript 帮你扫地，但<strong>别把垃圾藏到床底</strong>——<br/>
理解栈/堆、标记-清除、分代模型，善用 DevTools，远离四种泄漏，<br/>
你的页面才能<strong>常驻 60 FPS、不爆 256 M 低端机</strong>。</p>
<hr/>
<h4 data-id="heading-10">8. 延伸阅读</h4>
<ul>
<li>V8 官方博客：<em><a href="https://link.juejin.cn?target=https%3A%2F%2Fv8.dev%2Fblog%2Ftrash-talk" target="_blank" title="https://v8.dev/blog/trash-talk" ref="nofollow noopener noreferrer">Trash Talk: The Orinoco Garbage Collector</a></em></li>
<li>MDN：<em><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FJavaScript%2FMemory_Management" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Memory_Management" ref="nofollow noopener noreferrer">Memory Management</a></em></li>
<li>书籍：<em>《深入浅出 V8》</em> —— 字节跳动工程师出品，GC 章节图解详尽。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2、Gemini里 交互模式和非交互模式区别]]></title>    <link>https://juejin.cn/post/7571594817224359987</link>    <guid>https://juejin.cn/post/7571594817224359987</guid>    <pubDate>2025-11-12T10:31:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571594817224359987" data-draft-id="7571594817224343603" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2、Gemini里 交互模式和非交互模式区别"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-12T10:31:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="倚栏听风雨"/> <meta itemprop="url" content="https://juejin.cn/user/2682464103830750"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2、Gemini里 交互模式和非交互模式区别
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2682464103830750/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    倚栏听风雨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T10:31:51.000Z" title="Wed Nov 12 2025 10:31:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这两种模式的核心区别在于：<strong>对话是否具有记忆和上下文关联性</strong>。</p>
<hr/>
<h3 data-id="heading-0">1. 非交互模式</h3>
<p>非交互模式，也称为<strong>单轮对话</strong>或<strong>无状态对话</strong>。在这种模式下，每一次的请求都是完全独立的。</p>
<h4 data-id="heading-1">核心特点：</h4>
<ul>
<li><strong>无记忆性</strong>：模型不会记住你之前说过什么。每一次提问，对于模型来说都是全新的对话。</li>
<li><strong>自包含性</strong>：你需要在单次请求中提供完成任务所需的全部信息。</li>
<li><strong>确定性输出</strong>：对于相同的输入（提示词），在模型参数不变的情况下，输出基本是确定的。</li>
</ul>
<h4 data-id="heading-2">工作原理：</h4>
<p>你发送一个包含所有必要信息的提示词，模型根据这个完整的上下文生成一个回答。之后，这次“会话”就结束了。下一次请求时，模型不会记得之前的任何内容。</p>
<h4 data-id="heading-3">典型应用场景：</h4>
<ol>
<li><strong>文本摘要</strong>：你给它一篇文章，它返回摘要。它不需要知道之前摘要过什么。</li>
<li><strong>翻译</strong>：你给它一段需要翻译的文字和目标语言，它直接返回翻译结果。</li>
<li><strong>一次性问答</strong>：例如“解释一下什么是光合作用？”这种不需要追问上下文的问题。</li>
<li><strong>代码生成/解释</strong>：你给出一段代码或一个需求，它生成或解释代码。</li>
<li><strong>分类和情感分析</strong>：对一段独立的文本进行分类或判断其情感倾向。</li>
</ol>
<h4 data-id="heading-4">示例：</h4>
<blockquote>
<p><strong>你的输入（提示词）</strong> ： “请将以下英文翻译成中文，并总结其核心观点： <strong>原文</strong>：The rapid advancement of artificial intelligence presents both unprecedented opportunities and significant challenges for society. It is crucial to develop ethical guidelines and robust governance frameworks to ensure that AI benefits all of humanity.”<br/>
<strong>Gemini 的输出</strong>： <strong>翻译</strong>：人工智能的快速发展为社会带来了前所未有的机遇和重大挑战。制定道德准则和健全的治理框架以确保人工智能惠及全人类至关重要。 <strong>核心观点</strong>：AI发展机遇与挑战并存，必须通过伦理和治理使其造福人类。”</p>
</blockquote>
<p>在这个例子中，所有指令和内容都在一个请求中完成，无需历史记录。</p>
<hr/>
<h3 data-id="heading-5">2. 交互模式</h3>
<p>交互模式，也称为<strong>多轮对话</strong>或<strong>有状态对话</strong>。在这种模式下，模型能够记住同一会话中之前对话的内容，并基于整个对话历史来生成回应。</p>
<h4 data-id="heading-6">核心特点：</h4>
<ul>
<li><strong>有记忆性</strong>：模型会维护一个“对话历史”或“上下文窗口”，记住你们之前聊过的所有内容。</li>
<li><strong>上下文关联</strong>：你可以使用指代词（如“它”、“他”、“上面提到的”），进行追问、深入探讨或改变话题方向。</li>
<li><strong>连贯性</strong>：对话是流畅且连贯的，更像是在与一个真人交流。</li>
</ul>
<h4 data-id="heading-7">工作原理：</h4>
<p>当你开启一个聊天会话时，系统会为你创建一个“会话ID”或类似的标识符。你每次发送的新消息，都会与这个会话之前的所有消息（在上下文窗口长度限制内）一起，作为一个完整的上下文发送给模型。模型正是基于这个不断增长的上下文来理解你的意图并生成回复。</p>
<h4 data-id="heading-8">典型应用场景：</h4>
<ol>
<li><strong>聊天机器人</strong>：与AI进行开放领域的闲聊。</li>
<li><strong>复杂问题求解</strong>：通过多轮问答，逐步澄清问题、验证假设、深入探讨一个复杂主题。</li>
<li><strong>创意协作</strong>：与AI一起进行头脑风暴、编写故事、迭代修改文章或代码。</li>
<li><strong>角色扮演</strong>：让AI扮演某个角色（如面试官、历史人物、客服等）与你对话。</li>
<li><strong>教学与辅导</strong>：学生可以不断追问，老师（AI）会根据学生的理解程度调整解释。</li>
</ol>
<h4 data-id="heading-9">示例：</h4>
<blockquote>
<p><strong>第一轮</strong> <strong>你</strong>：介绍一下李白。 <strong>Gemini</strong>：李白（701年－762年），字太白，号青莲居士，是唐代著名的浪漫主义诗人...<br/>
<strong>第二轮</strong> <strong>你</strong>：他最有名的诗是哪一首？ （这里的“他”指代上一轮提到的李白） <strong>Gemini</strong>： generally considered to be 《静夜思》...<br/>
<strong>第三轮</strong> <strong>你</strong>：把这首诗翻译成英文。 （这里的“这首诗”指代上一轮提到的《静夜思》） <strong>Gemini</strong>： Bed before bright moonlight, / I took it as frost on the ground. / I raise my head to view the bright moon, / Then lower it, missing my hometown.</p>
</blockquote>
<p>可以看到，在交互模式下，对话是层层递进的，模型完美地理解了上下文中的指代关系。</p>
<hr/>
<h3 data-id="heading-10">对比总结</h3>








































<table><thead><tr><th>特性</th><th>非交互模式（单轮）</th><th>交互模式（多轮）</th></tr></thead><tbody><tr><td><strong>记忆性</strong></td><td><strong>无</strong>，每次请求独立</td><td><strong>有</strong>，记住会话历史</td></tr><tr><td><strong>上下文</strong></td><td>单次请求自包含</td><td>依赖多轮对话历史</td></tr><tr><td><strong>使用方式</strong></td><td>一次性任务</td><td>连续对话</td></tr><tr><td><strong>API调用</strong></td><td>每次都是独立的<code>generateContent</code></td><td>需要维护并传递<code>ChatSession</code>或<code>history</code></td></tr><tr><td><strong>资源消耗</strong></td><td>每次处理完整提示词，相对可控</td><td>随着对话进行，上下文越来越长，消耗的计算资源也越多</td></tr><tr><td><strong>适用任务</strong></td><td>摘要、翻译、一次性问答</td><td>聊天、辅导、复杂问题探讨</td></tr></tbody></table>
<h3 data-id="heading-11">技术实现上的关键点</h3>
<ol>
<li><strong>上下文窗口</strong>：这是交互模式的核心限制。模型能记住的对话历史长度是有限的（例如，Gemini 1.5 Pro拥有百万级的token上下文窗口）。当对话轮数太多，超过了这个窗口，最早的历史记录就会被“遗忘”。</li>
<li><strong>在API中的体现</strong>：</li>
<li>
<ul>
<li><strong>非交互</strong>：通常调用如<code>model.generate_content(prompt)</code>。</li>
<li><strong>交互</strong>：需要先创建一个聊天会话，如<code>chat = model.start_chat(history=[])</code>，然后通过<code>chat.send_message("你的新消息")</code>来发送消息，系统会自动将历史记录附加到请求中。</li>
</ul>
</li>
<li><strong>成本与延迟</strong>：交互模式中，随着上下文变长，处理一次请求所需的计算量和时间可能会增加，在按Token收费的API中，成本也可能更高。</li>
</ol>
<h3 data-id="heading-12">总结</h3>
<p>选择哪种模式取决于你的具体需求：</p>
<ul>
<li>如果你的任务像“下达一个指令并获取结果”，比如把A翻译成B，或者总结C，那么<strong>非交互模式</strong>更简单、高效。</li>
<li>如果你的任务像“进行一次讨论或探索”，需要来回沟通、逐步深入，那么<strong>交互模式</strong>是唯一的选择。</li>
</ul>
<p>理解这两种模式的差异，是有效设计和开发基于大语言模型应用的基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Next.js 不只是前端框架！我们用它搭了个发布中枢，让跨团队协作效率翻倍]]></title>    <link>https://juejin.cn/post/7571678674144280586</link>    <guid>https://juejin.cn/post/7571678674144280586</guid>    <pubDate>2025-11-12T10:38:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571678674144280586" data-draft-id="7571695634941280283" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Next.js 不只是前端框架！我们用它搭了个发布中枢，让跨团队协作效率翻倍"/> <meta itemprop="keywords" content="前端,Next.js"/> <meta itemprop="datePublished" content="2025-11-12T10:38:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="洞窝技术"/> <meta itemprop="url" content="https://juejin.cn/user/2538113306470631"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Next.js 不只是前端框架！我们用它搭了个发布中枢，让跨团队协作效率翻倍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2538113306470631/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    洞窝技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T10:38:30.000Z" title="Wed Nov 12 2025 10:38:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ceb7c2cb87a4f05b51f601acb7d0973~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSe56qd5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763548710&amp;x-signature=YQ8%2FKqjpcOLTACBEet4gqXNgMmo%3D" alt="头图" loading="lazy"/></p>
<blockquote>
<p>企业发布流程割裂、协同复杂？我们用 Next.js 全栈+BFF（Backend For Frontend，前端后端中间层，用于聚合三方系统接口，适配前端需求），串联 GitLab、Tapd、钉钉和 MongoDB，把发布流程自动化、一站式可观测落地。本文分享架构实战与关键代码，助力中大型前端团队搭建自己的“发布中枢”。</p>
</blockquote>
<h2 data-id="heading-0">你将收获</h2>
<ul>
<li>企业级发布自动化的一线架构与流程</li>
<li>Next.js 全栈+BFF最佳实践</li>
<li>三方平台集成（GitLab/Tapd/钉钉）与踩坑经验</li>
<li>关键模型、权限中间件、自动化脚本代码</li>
<li>发布流程可观测与质量保障的实拍指标</li>
</ul>
<h2 data-id="heading-1">背景与目标</h2>
<p>企业内部需求、开发、测试、发布流程分散：</p>
<ul>
<li>Tapd 管需求，GitLab 负责代码和CI，钉钉审批沟通，环境分散</li>
<li>信息孤岛、人工对齐，链路不可追溯，权限混乱</li>
<li>发布效率和质量难保障</li>
</ul>
<p><strong>目标：</strong></p>
<ul>
<li>聚合需求/代码/MR/流水线/发布/通知，一站式视图</li>
<li>自动化三方联动，减少人工链路</li>
<li>全程日志审计，所有操作可追溯</li>
<li>统一鉴权、角色权限管理，安全可控</li>
</ul>
<h2 data-id="heading-2">技术选型亮点</h2>
<h3 data-id="heading-3">为什么选择 Next.js 全栈 + BFF？</h3>
<p>相比传统"前端 + 后端 API"架构，选择 Next.js 全栈是因为：</p>
<ul>
<li><strong>减少跨域问题</strong>：发布平台需频繁跨系统交互（GitLab/Tapd），Next.js 的 API Route 可直接作为 <strong>BFF（Backend For Frontend，前端后端中间层，用于聚合三方系统接口，适配前端需求）</strong> 层，前后端同域部署，避免 CORS 配置</li>
<li><strong>性能提升</strong>：同构渲染（SSR/SSG）提升页面首屏响应速度 30%+，特别是发布状态页面需要实时数据展示</li>
<li><strong>统一技术栈</strong>：TypeScript 全栈覆盖，减少上下文切换，降低维护成本</li>
<li><strong>安全可控</strong>：三方 API 密钥仅存服务端，避免前端暴露</li>
</ul>
<h3 data-id="heading-4">为什么选择 MongoDB？</h3>
<p>相比 MySQL 等关系型数据库：</p>
<ul>
<li><strong>灵活 Schema</strong>：发布日志结构多变（不同系统字段不同），MongoDB 的文档模型减少 70% 的表结构变更成本</li>
<li><strong>查询性能</strong>：复合索引（如 <code>{projectId: 1, createAt: -1}</code>）保障高频查询（发布记录查询、操作日志检索）在千万级数据下仍保持毫秒级响应</li>
<li><strong>扩展性好</strong>：日志归档场景，冷热数据分离，MongoDB 分片更易实现</li>
</ul>
<h3 data-id="heading-5">服务层整合策略</h3>
<p>三方 SDK 统一限流、重试、熔断，业务解耦：</p>
<ul>
<li><strong>统一错误模型</strong>：所有服务层抛出标准错误，API 层统一转换为前端可理解的响应格式</li>
<li><strong>集中治理</strong>：限流器（p-limit）、重试策略（指数退避）、熔断器（失败率阈值）统一配置，避免重复代码</li>
</ul>
<h3 data-id="heading-6">钉钉/IM 通知</h3>
<p>时效强、闭环好，重要事件双通道（钉钉 + 邮件），确保关键发布事件及时触达责任人</p>
<h2 data-id="heading-7">架构总览</h2>
<p>前端页面、API路由、服务层、数据层和运维脚本协作，串联三方系统，自动化发布流程。</p>
<h3 data-id="heading-8">平台主流程</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7d607495f3848a992810eb04e7e4436~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSe56qd5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763548710&amp;x-signature=5G7k5b59XPHOUojkYOVJUBzYGwQ%3D" alt="平台主流程" loading="lazy"/></p>
<p><strong>流程说明</strong>：从 Tapd 需求创建 → GitLab 分支开发 → MR 合并 → CI/CD 流水线 → 发布计划创建 → 产线发布 → 钉钉通知，形成完整闭环。每个环节的操作日志自动落库，支持全程回溯。</p>
<h3 data-id="heading-9">技术架构</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9de797507a84d43af95f7b019e8058c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSe56qd5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763548710&amp;x-signature=3Gwva5d8PUTY2hZ9Uo8tsmGppHQ%3D" alt="技术架构图" loading="lazy"/></p>
<p><strong>架构要点</strong>：</p>
<p><strong>前端 + API Route（BFF）</strong>：Next.js 全栈同仓部署，API Route 作为三方系统统一网关，密钥仅存服务端，统一响应格式 <code>{code, message, data}</code>。</p>
<p><strong>服务层</strong>：限流（GitLab 5r/s，Tapd 3r/s）、熔断（连续 5 次超时切换 Redis 缓存）、指数退避重试（1s→2s→4s），日志埋点全链路追踪。<strong>三方服务集成示例</strong>：以 GitLab 为例，前端页面 → API Route（权限校验）→ GitLab Service（MR查询/流水线拉取/合并）→ MongoDB（操作日志自动落库），确保所有流程可追溯。同样策略适用于 Tapd 和钉钉。</p>
<p><strong>MongoDB</strong>：复合索引保障查询 &lt; 50ms，事务确保关键操作原子性，冷热分离优化存储成本。</p>
<p><strong>基础设施</strong>：Docker + PM2 容器化，Nginx 静态缓存 + 负载均衡。</p>
<p><strong>数据流向</strong>：前端 → BFF（权限）→ 服务层（限流/熔断）→ 三方系统 → MongoDB（持久化），异常时降级至缓存。</p>
<p>确保 99.9% SLA、高安全性、全链路可观测。</p>
<hr/>
<h3 data-id="heading-10">业务与数据建模</h3>
<p>核心对象如下：</p>

































<table><thead><tr><th>模型</th><th>作用说明</th></tr></thead><tbody><tr><td>发布计划</td><td>批次/需求/环境/状态（发布计划：一次发布任务的完整定义；发布批次：同一计划下的多个发布批次）</td></tr><tr><td>发布说明</td><td>变更说明/回滚线索</td></tr><tr><td>项目/环境</td><td>仓库/分支/环境策略</td></tr><tr><td>需求/合并</td><td>Tapd对接/合并策略</td></tr><tr><td>人员/角色</td><td>企业组织/权限管理</td></tr><tr><td>操作/合并日志</td><td>审计/回溯</td></tr></tbody></table>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcdfd95287f342208ae1b6ec72a3b232~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSe56qd5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763548710&amp;x-signature=12cFO8RM0cEfdeRHzOVPIuLWtJM%3D" alt="发布状态流转图" loading="lazy"/></p>
<p><strong>状态流转说明</strong>：发布计划状态流转：待发布 → 发布中 → 已发布。每个状态变更都会触发操作日志记录，并推送钉钉通知给相关责任人。</p>
<h2 data-id="heading-11">业务模块拆解</h2>
<h3 data-id="heading-12">发布计划管理</h3>
<p><strong>说明</strong>：</p>
<ul>
<li><strong>发布计划</strong>：一次发布任务的完整定义，包含目标环境、发布时间、关联需求等</li>
<li><strong>发布批次</strong>：同一发布计划下的多个发布批次，用于聚合多个需求并生成发布文档</li>
</ul>
<p><strong>核心功能</strong>：</p>
<ul>
<li>创建/维护发布计划与发布批次、设置发布时间</li>
<li>对接CI/CD（CI：持续集成，代码合并后自动构建/测试；CD：持续交付/部署，自动化发布到环境），触发/回滚，钉钉自动通知</li>
<li>需求聚合成批次、生成发布文档、依赖校验、门禁策略</li>
<li>分支/流水线/Code Owners（按目录/文件指定审核所有者，MR 需其审核）策略</li>
<li>发布变更集、执行人、回滚记录</li>
</ul>
<p><strong>场景化案例：发布批次审批发版闭环</strong></p>
<ul>
<li>组批：将需求 A/B/C 加入同一发布批次，系统自动生成发布文档（变更项、影响范围、回滚预案）</li>
<li>审批：责任人（业务/技术负责人或 Code Owners）线上审批，通过后自动触发生产发布流水线（或生成 Tag）</li>
<li>发布：CI/CD 执行生产发布，产出版本号与链接；若监控异常，自动阻断并回滚，上报钉钉告警</li>
<li>归档：发布结果、发布文档、审批记录与执行人落库，便于审计与追溯</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c28f0c61a7646ecaff7b50f017983b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSe56qd5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763548710&amp;x-signature=asDdoh8bikx6W%2BebOsRnflTcwYM%3D" alt="发布管理" loading="lazy"/></p>
<h3 data-id="heading-13">需求管理</h3>
<ul>
<li>Tapd故事同步、MR绑定与一致性校验</li>
<li>需求锁，合并冲突防控</li>
<li>分支/流水线/codeowner策略</li>
</ul>
<p><strong>场景化案例：需求锁如何避免冲突？</strong></p>
<p>当开发 A 在 Tapd 标记需求"开发中"时，系统自动锁定对应 Git 分支，开发 B 试图提交 MR 时会收到"需求已被锁定，请联系 A 确认"的钉钉提醒。这样避免了多人同时修改同一需求导致的代码冲突。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d714d3396a940dbb3fc55acb3727dde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSe56qd5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763548710&amp;x-signature=IwkHrlePuIJ72q8f6q%2BWj05tTRQ%3D" alt="需求管理" loading="lazy"/></p>
<h3 data-id="heading-14">人员与角色</h3>
<ul>
<li>角色功能映射、页面权限绑定</li>
<li>钉钉unionId对企业组织，自动审批派发</li>
</ul>
<p><strong>场景化案例：审批派发与越权拦截闭环</strong></p>
<ul>
<li>研发提交发布批次后，平台按角色矩阵自动分配审批人（产品/技术负责人），并推送钉钉待办；</li>
<li>审批通过 → 自动触发生产流水线；拒绝/超时 → 批次状态更新并推送原因；</li>
<li>无权限用户尝试触发发布 → 中间件路由门禁 + API 二次校验即时拦截，记录操作日志并通知管理员；</li>
<li>审批/执行全链路留痕，可按人/项目/时间检索。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/600e87d185dc4445a5f729812472a4d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSe56qd5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763548710&amp;x-signature=Uk8fJTS%2F%2F6%2FpFQIveScYZiriQXc%3D" alt="人员管理" loading="lazy"/></p>
<h2 data-id="heading-15">权限鉴权与中间件</h2>
<ul>
<li>所有受保护路由自动校验Token，钉钉扫码支持；API层二次验权，敏感操作需二次确认。</li>
</ul>
<p><strong>场景化案例：Token 过期与敏感操作防护</strong></p>
<ul>
<li>用户访问受保护路由，middleware 校验失败后重定向至登录页，并保留 redirect；</li>
<li>登录回调（带 dingCode）解析身份，注入会话并跳回 redirect；</li>
<li>触发发布等接口时，API 层二次校验 Token/角色；无权限则返回 403，记录操作日志；</li>
<li>对“切生产/回滚”等高危操作，强制二次确认与审批链，并推送钉钉通知。</li>
</ul>
<p><strong>中间件关键代码：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">middleware</span>(<span class="hljs-params">req: NextRequest</span>) {
  <span class="hljs-keyword">const</span> { pathname, searchParams, search } = req.<span class="hljs-property">nextUrl</span>;
  <span class="hljs-keyword">const</span> host = req.<span class="hljs-property">headers</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'host'</span>);

  <span class="hljs-comment">// 钉钉扫码登录回调处理</span>
  <span class="hljs-keyword">const</span> dingCode = searchParams.<span class="hljs-title function_">get</span>(<span class="hljs-string">'code'</span>);
  <span class="hljs-keyword">if</span> (dingCode) {
    <span class="hljs-keyword">const</span> baseUrl = <span class="hljs-title function_">buildBaseUrl</span>(host);
    <span class="hljs-keyword">const</span> redirectUrl = <span class="hljs-string">`<span class="hljs-subst">${baseUrl}</span>/dashboard`</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">redirect</span>(
      <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">`/dingUserInfo?dingCode=<span class="hljs-subst">${dingCode}</span>&amp;redirect=<span class="hljs-subst">${redirectUrl}</span>`</span>, req.<span class="hljs-property">url</span>)
    );
  }

  <span class="hljs-comment">// 公开路径直接放行</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isPublicPath</span>(pathname)) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">next</span>();
  }

  <span class="hljs-comment">// 受保护路径需要验证Token</span>
  <span class="hljs-keyword">const</span> verifiedToken = <span class="hljs-keyword">await</span> <span class="hljs-title function_">verifyAuth</span>(req).<span class="hljs-keyword">catch</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-literal">null</span>);
  <span class="hljs-keyword">if</span> (!verifiedToken) {
    <span class="hljs-keyword">const</span> baseUrl = <span class="hljs-title function_">buildBaseUrl</span>(host);
    <span class="hljs-keyword">const</span> redirectUrl = <span class="hljs-string">`<span class="hljs-subst">${baseUrl}</span><span class="hljs-subst">${pathname}</span><span class="hljs-subst">${search}</span>`</span>;
    <span class="hljs-keyword">const</span> loginUrl = <span class="hljs-string">`<span class="hljs-subst">${LOGIN_URL}</span>?redirect=<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(redirectUrl)}</span>`</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">redirect</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(loginUrl));
  }

  <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">next</span>();
}
</code></pre>
<h2 data-id="heading-16">自动化脚本与运维</h2>





























<table><thead><tr><th>脚本名</th><th>用途</th></tr></thead><tbody><tr><td>build_data.mjs</td><td>构建产物、数据生成</td></tr><tr><td>start.js</td><td>启动服务</td></tr><tr><td>schedule.js</td><td>定时任务、数据同步</td></tr><tr><td>onlineNotice.js</td><td>钉钉群机器人通知</td></tr><tr><td>nginx.mjs</td><td>Nginx反向代理配置</td></tr></tbody></table>
<p><strong>运维建议：</strong></p>
<ul>
<li>构建产物/运行镜像分离</li>
<li>Nginx缓存静态资源</li>
<li>非幂等危险操作需灰度和二次确认</li>
</ul>
<h2 data-id="heading-17">前端页面结构</h2>
<ul>
<li>Next.js自动路由，Ant Design+自研组件</li>
<li>页面→业务组件→原子组件，稳定API</li>
<li>Minimal状态设计，数据接口拉取为主</li>
</ul>

<pre><code class="hljs">Dashboard
├─ 发布管理
├─ 需求管理
├─ 人员管理
├─ 角色管理
├─ 脑图管理
└─ 操作日志
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/524ded82ebe74966b67bddfc5b561f46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSe56qd5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763548710&amp;x-signature=gIfqEUjNPIjkxb4cPXLjQQQdyM4%3D" alt="前端页面结构示例" loading="lazy"/></p>
<h2 data-id="heading-18">落地流程 Step-by-Step</h2>
<ol>
<li>明确系统范围和最小闭环（MR→CI→发布→通知→审计）</li>
<li>Next.js初始化、API Route做BFF、服务层可复用</li>
<li>路由中间件做权限守卫，API强制Token/角色校验</li>
<li>接入GitLab、Tapd、钉钉三方服务</li>
<li>发布管理先上线，补充故事、人员、角色，操作日志可视化</li>
<li>响应统一、日志埋点，指标化（准备时长、回溯时效、失败率）</li>
<li>事件化解耦三方系统，逐步微前端/GraphQL聚合</li>
</ol>
<h2 data-id="heading-19">可观测与质量保障</h2>
<ul>
<li><strong>API和服务响应结构化，异常可追溯</strong>：统一响应格式 <code>{code, message, data}</code>，异常时自动记录堆栈、请求参数、响应时间</li>
<li><strong>日志埋点，操作日志表，关键链路自动记录</strong>：所有三方 API 调用（GitLab/Tapd/钉钉）自动记录入参、出参、时延、错误码</li>
<li><strong>合并/发布记录可视化，问题定位分钟级</strong>：操作时间线组件展示完整链路（需求创建 → MR 合并 → 发布触发 → 钉钉通知），支持按时间、人员、项目过滤</li>
<li><strong>钉钉自动推送，回滚记录闭环</strong>：发布成功/失败/回滚时自动推送钉钉群消息，包含变更集、执行人、回滚线索</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/913d5dc1d1c64dea80a6035450dfe709~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSe56qd5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763548710&amp;x-signature=cqtI0CYLY1nusVuCiZsfiuIHjfU%3D" alt="操作时间线" loading="lazy"/></p>
<p><strong>时间线说明</strong>：操作时间线可视化展示发布全链路，每个节点包含操作人、时间戳、操作类型、关联对象（如 MR ID、发布批次号），点击可查看详细信息。支持按项目、人员、时间范围过滤，快速定位问题。</p>
<h2 data-id="heading-20">踩坑清单&amp;最佳实践</h2>















































<table><thead><tr><th>问题</th><th>案例场景</th><th>解决方案</th><th>效果数据</th></tr></thead><tbody><tr><td>三方API限流/波动</td><td>GitLab API 突发限流（QPS=10）导致发布计划批量失败</td><td>使用 <code>p-limit</code> 控制并发（限 5 个请求/秒）+ 指数退避重试（3 次重试，间隔 1s→2s→4s）+ 熔断器（失败率 &gt; 50% 时切换缓存）</td><td>失败率从 15% 降至 0.3%</td></tr><tr><td>长耗时任务与API Route</td><td>批量同步 100+ 项目分支信息，API Route 超时（60秒）</td><td>任务拆分为 10 个批次，前端轮询状态（每 2 秒），后台任务异步执行</td><td>超时率从 40% 降至 0%</td></tr><tr><td>MongoDB查询退化</td><td>操作日志表千万级数据，按项目+时间范围查询耗时 5 秒+</td><td>建立复合索引 <code>{projectId: 1, createAt: -1}</code>，控制单文档体积 &lt; 16MB</td><td>查询耗时降至 50ms 以内</td></tr><tr><td>身份映射不一致</td><td>企业组织、GitLab 用户、钉钉用户的唯一标识不统一，导致权限校验失败</td><td>建立用户映射表（<code>{orgId, gitlabId, dingtalkUnionId}</code>），关键操作（如发布、回滚）强制校验三方身份一致性</td><td>权限校验失败率从 8% 降至 0.1%</td></tr><tr><td>权限仅依赖前端</td><td>前端绕过权限检查直接调用 API，导致越权操作</td><td>API 层强制 Token/角色校验，敏感操作（发布、回滚）二次确认 + 审批链</td><td>越权操作拦截率 100%</td></tr><tr><td>日志缺口/排查难</td><td>发布失败时无法回溯具体操作步骤，排查耗时 2 小时+</td><td>统一日志规范（操作类型、操作人、时间戳、关联对象），操作时间线可视化 + 检索面板（支持按人/项目/时间过滤）</td><td>排查时间从 2 小时缩短至 15 分钟</td></tr></tbody></table>
<blockquote>
<p><strong>强烈建议</strong>：三方服务层全部加限流、重试、熔断，关键操作二次确认和日志落库！这是保障平台稳定性的基石。</p>
</blockquote>
<h2 data-id="heading-21">关键代码片段</h2>
<h3 data-id="heading-22">1. 通用MongoDB模型</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-title function_">getList</span>(<span class="hljs-params">query?: T, sortFields?: Sort, pageIndex = <span class="hljs-number">1</span>, pageSize = <span class="hljs-number">20</span></span>) {
  <span class="hljs-keyword">const</span> db = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">init</span>();
  <span class="hljs-keyword">let</span> ret = db.<span class="hljs-title function_">find</span>(query || {});
  <span class="hljs-keyword">if</span> (pageIndex &amp;&amp; pageSize) {
    <span class="hljs-keyword">if</span> (sortFields) ret = ret.<span class="hljs-title function_">sort</span>(sortFields);
    ret = ret.<span class="hljs-title function_">skip</span>(pageSize * (pageIndex - <span class="hljs-number">1</span>)).<span class="hljs-title function_">limit</span>(pageSize);
  }
  <span class="hljs-keyword">return</span> ret.<span class="hljs-title function_">toArray</span>();
}
</code></pre>
<h3 data-id="heading-23">2. GitLab服务层创建MR</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">syncPostNewMR</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">params: <span class="hljs-built_in">any</span></span>) =&gt; {
  <span class="hljs-keyword">const</span> { token, project_name, <span class="hljs-attr">id</span>: projectId, source_branch, target_branch } = params;

  <span class="hljs-comment">// 获取项目主分支（如果未指定target_branch）</span>
  <span class="hljs-keyword">const</span> project = <span class="hljs-keyword">await</span> <span class="hljs-title function_">syncProjectsSearch</span>({ <span class="hljs-attr">id</span>: projectId });
  <span class="hljs-keyword">const</span> defaultBranch = target_branch || project[<span class="hljs-number">0</span>].<span class="hljs-property">default_branch</span>;

  <span class="hljs-comment">// 调用GitLab API创建MR</span>
  <span class="hljs-keyword">const</span> gitlabApi = <span class="hljs-string">`https://gitlab.example.com/api/v4/projects/<span class="hljs-subst">${projectId}</span>/merge_requests`</span>;
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">post</span>(
    gitlabApi,
    {
      source_branch,
      <span class="hljs-attr">target_branch</span>: defaultBranch,
      <span class="hljs-attr">title</span>: params.<span class="hljs-property">title</span> || <span class="hljs-string">`Merge <span class="hljs-subst">${source_branch}</span> to <span class="hljs-subst">${defaultBranch}</span>`</span>,
    },
    {
      <span class="hljs-attr">headers</span>: { <span class="hljs-string">'Private-Token'</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">GITLAB_PRIVATE_TOKEN</span> },
      <span class="hljs-attr">timeout</span>: <span class="hljs-number">10000</span>, <span class="hljs-comment">// 10秒超时</span>
    }
  );

  <span class="hljs-keyword">if</span> (response.<span class="hljs-property">status</span> !== <span class="hljs-number">201</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`创建MR失败：<span class="hljs-subst">${response.data.message || <span class="hljs-string">'未知错误'</span>}</span>`</span>);
  }

  <span class="hljs-comment">// 操作日志自动落库</span>
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">info</span>: <span class="hljs-built_in">any</span> = <span class="hljs-keyword">await</span> <span class="hljs-title function_">analysisToken</span>(token);
    <span class="hljs-title function_">addLogs</span>(<span class="hljs-number">2</span>, <span class="hljs-number">6</span>, info.<span class="hljs-property">personName</span>, [project_name], info.<span class="hljs-property">personId</span>);
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'日志记录失败'</span>, err);
  }

  <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>;
};
</code></pre>
<h3 data-id="heading-24">3. JWT签发与校验</h3>
<blockquote>
<p>安全提示：生产环境中，secretkey 必须通过环境变量（如 process.env.JWT_SECRET）注入，避免硬编码；并显式指定算法（如 algorithm: 'HS256'）。</p>
</blockquote>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> jwt <span class="hljs-keyword">from</span> <span class="hljs-string">'jsonwebtoken'</span>;

<span class="hljs-comment">// ⚠️ 生产安全：密钥仅通过环境变量注入，避免硬编码；未配置直接报错</span>
<span class="hljs-keyword">if</span> (!process.<span class="hljs-property">env</span>.<span class="hljs-property">JWT_SECRET</span>) { <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'JWT_SECRET is required'</span>); }
<span class="hljs-keyword">const</span> secretkey = process.<span class="hljs-property">env</span>.<span class="hljs-property">JWT_SECRET</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;

<span class="hljs-comment">/**
 * 签发 JWT Token
 * - 使用 HS256 对称签名算法
 * - 设置 1 小时过期时间（expiresIn=3600s）
 * - 建议改进：校验密钥长度≥32字节；添加 issuer/audience/subject 声明防止错域串用
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">sign</span> = (<span class="hljs-params">data = {}</span>) =&gt; {
  <span class="hljs-keyword">return</span> jwt.<span class="hljs-title function_">sign</span>(data, secretkey, {
    <span class="hljs-attr">expiresIn</span>: <span class="hljs-number">60</span> * <span class="hljs-number">60</span>,
    <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'HS256'</span>, <span class="hljs-comment">// 显式指定算法，避免算法混淆攻击</span>
  });
};

<span class="hljs-comment">/**
 * 校验 JWT Token
 * - 启用 algorithms=['HS256'] 算法白名单
 * - 建议改进：
 *   1. try/catch 区分 TokenExpiredError/NotBeforeError/Invalid，分流 401/等待/重登
 *   2. 添加 clockTolerance: 30 处理机器时间偏移
 *   3. 校验 issuer/audience/subject 声明
 *   4. 传输层用 HttpOnly+Secure+SameSite=strict Cookie 携带 Token
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">verify</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">token: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-keyword">return</span> jwt.<span class="hljs-title function_">verify</span>(token, secretkey, {
    <span class="hljs-attr">algorithms</span>: [<span class="hljs-string">'HS256'</span>],
  });
};
</code></pre>
<h2 data-id="heading-25">效果实拍与指标</h2>
<h3 data-id="heading-26">📈 效率提升</h3>





























<table><thead><tr><th>指标</th><th>优化前</th><th>优化后</th><th>提升幅度</th></tr></thead><tbody><tr><td><strong>发布协作耗时</strong></td><td>8h（跨系统沟通 + 手工对齐 + 等待审批）</td><td>5.6h（自动联动 + 一站式视图 + 即时通知）</td><td><strong>30%</strong> ↑</td></tr><tr><td><strong>问题定位时间</strong></td><td>2h（多系统手动查询拼凑）</td><td>15min（时间线可视化一键回溯）</td><td><strong>8倍</strong> ↑</td></tr><tr><td><strong>信息同步时效</strong></td><td>2h</td><td>0.5h</td><td><strong>75%</strong> ↑</td></tr></tbody></table>
<h3 data-id="heading-27">🛡️ 质量与稳定性</h3>
<ul>
<li><strong>发布阻塞率下降 98%</strong>：限流/熔断机制上线后，三方 API 故障导致的发布中断从 15% 降至 0.3%</li>
<li><strong>100% 操作可追溯</strong>：所有发布操作（创建/触发/回滚）自动记录，审计链路完整无断点</li>
<li><strong>关键节点卡点前置</strong>：需求锁定 + 分支校验 + Code Owners 审批，减少 42% 的线上回滚</li>
</ul>
<h3 data-id="heading-28">🔍 运维可观测性</h3>
<ul>
<li><strong>排障效率提升 60%</strong>：结构化日志 + 操作时间线让问题根因定位从 30min 缩短至 12min</li>
<li><strong>全链路可视化</strong>：GitLab Pipeline + Tapd 需求 + 钉钉通知聚合展示，故障溯源一键直达</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7f5dff276d24924af8b701d486a969d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSe56qd5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763548710&amp;x-signature=EtqurMCEyaEmCqrxzl3vdvOAmDo%3D" alt="发布效率指标" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/760488ad1894483986b1279d5bef98d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSe56qd5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763548710&amp;x-signature=6iF8yGt2eMQG4nBBrFpPdj5AGvs%3D" alt="钉钉机器人通知示例" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e818bca76902476897634944e31f7eb9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSe56qd5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763548710&amp;x-signature=%2Fmi2g1%2BP1VdVMMyu4gf22SHrJ10%3D" alt="钉钉机器人通知示例" loading="lazy"/></p>
<h2 data-id="heading-29">适用场景推荐</h2>
<ul>
<li>中大型有自研需求的前端团队</li>
<li>需要聚合多系统（GitLab/Tapd/钉钉）的企业平台</li>
<li>对发布自动化、审计、协作有强需求的团队</li>
</ul>
<h2 data-id="heading-30">下一步计划</h2>
<ul>
<li>引入事件总线和GraphQL聚合</li>
<li>指标化平台效益，辅助组织度量和持续改进</li>
<li>打通Jenkins等CI/CD工具，实现前后端自动联动</li>
<li>持续优化脚本化运维和安全策略</li>
</ul>
<h2 data-id="heading-31">总结</h2>
<p>Next.js全栈+BFF结合服务层三方集成，以发布主线串联各业务，保障自动化、审计、权限和可观测性，是企业级发布平台高效协作与治理的最佳实践。</p>
<blockquote>
<p>希望本文对你的企业前端平台落地有所帮助，欢迎点赞收藏、评论交流你的实践和问题！</p>
</blockquote>
<p>作者：洞窝-重阳</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[替换 ClickHouse，查询并发提升 7 倍！高途教育基于阿里云 SelectDB 构建秒级实时报表]]></title>    <link>https://juejin.cn/post/7571655312798810138</link>    <guid>https://juejin.cn/post/7571655312798810138</guid>    <pubDate>2025-11-12T10:46:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571655312798810138" data-draft-id="7571655312798777370" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="替换 ClickHouse，查询并发提升 7 倍！高途教育基于阿里云 SelectDB 构建秒级实时报表"/> <meta itemprop="keywords" content="数据库,Apache"/> <meta itemprop="datePublished" content="2025-11-12T10:46:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SelectDB"/> <meta itemprop="url" content="https://juejin.cn/user/3189021726222904"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            替换 ClickHouse，查询并发提升 7 倍！高途教育基于阿里云 SelectDB 构建秒级实时报表
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3189021726222904/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SelectDB
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T10:46:14.000Z" title="Wed Nov 12 2025 10:46:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">导读</h2>
<p>高途教育引入阿里云 SelectDB 替换 ClickHouse、MySQL 作为核心分析引擎，统一支撑续班与行课实时分析等核心业务。通过阿里云 SelectDB MPP 架构与向量化查询引擎，结合 SelectDB 倒排索引、Bloom Filter 等丰富索引机制，实现亿级数据量秒级多表关联查询，在 700+ 高并发查询压力下 P99 延迟低于 200ms，稳定满足核心报表 2s 内响应，有力支撑高途教育业务向“数据驱动运营”转型。</p>
<h2 data-id="heading-1">业务背景与需求</h2>
<p>高途教育科技集团（NYSE：GOTU，以下简称高途教育）是一家兼具教育基因和科技驱动力的科技教育公司。目前，高途集团的业务涵盖了<strong>面向中小学生、大学生与成人、出国留学人群咨询和学习的产品和服务，以及以内容和文化为内核的直播电商等业务</strong>。</p>
<p>**本文主要介绍续班场景实时大屏及行课场景中工作台的报表分析。**在续班场景，高途教育通过续班大屏实时整合全国区域及课程品类的续班数据，为管理层与一线人员提供实时、动态的续班数据洞察，以驱动资源精准调配与潜力课程识别。在行课场景，高途教育需将数据分析大屏嵌入至教师、运营、管理者等多角色工作台，为每个角色实时提供高度定制化的行课数据视图，支撑教学质量和全流程优化。为满足双场景需求，数据分析平台具备以下能力：</p>
<ul>
<li><strong>高并发访问能力</strong>：在续班期间，支撑全部一线员工随时随地、并发访问实时续班大屏，确保信息全员同步，打破地域限制。在行课期间， 保障所有角色在日常工作中能够流畅访问数据工作台，确保业务无缝进行。</li>
<li><strong>多表 Join 关联查询能力</strong>： 支持跨业务数据表 Join 关联查询，快速生成适配不同角色的专属报表视图。</li>
<li><strong>实时数据更新能力</strong>：由于 TP 库中数据持续更新，因此要求分析系统具备实时数据更新能力。实现大屏与工作台数据的秒级刷新，确保大屏展示的续班数据与工作台展示的行课数据即时反映最新业务动态，为快速决策提供数据基础。</li>
</ul>
<h2 data-id="heading-2">业务挑战</h2>
<p>在支撑关键业务场景的数据分析能力上，高途教育过去选择了 ClickHouse 和 MySQL 组合。在续班场景中，由于该场景对查询响应延迟以及数据实时性要求高，高途教育选择了 ClickHouse，业务上仍然面临两个挑战。</p>
<ul>
<li><strong>查询并发能力低，服务能力受限</strong>：ClickHouse 高并发处理能力有限（仅支持约 100 QPS），导致实时报表访问受限，仅开放给管理人员和现场电视。一线人员只能在特定位置通过电视查看数据，若不在同一工区或楼层，无法实时感知续班数据变化。</li>
<li><strong>报表维度单一，缺乏个性化分析支持，使用场景受限</strong>：系统在处理多表关联复杂查询时效率低下，仅能提供预设的单一维度报表，难以根据不同岗位（如管理层、运营、销售）提供差异化的分析视角，进而导致前线业务场景使用受限。</li>
</ul>
<p>在行课场景中，由于 ClickHouse 无法支撑 2B 业务所需的高并发访问，系统最初采用了基于 MySQL 的定制化数据方案。各类报表需经过 ODS → DW → DM 的多层数据加工，再按业务场景进行定制化聚合开发。业务上遇到了数据定制流程复杂、响应慢、灵活性差的挑战。具体问题包括：</p>
<ul>
<li><strong>高度耦合的加工链条</strong>：每一张报表都需要经过 ODS → DW → DM 的多层数据加工过程，一旦有字段、逻辑或口径的调整，不仅需要同步修改各层数据加工逻辑，还会影响多个报表，造成修改成本高、风险大。</li>
<li><strong>开发效率低，维护复杂</strong>：展示层的变更往往涉及前后端联动开发，不具备低成本快速迭代能力，无法支撑业务快速变化下的灵活调整需求。</li>
<li><strong>难以支撑多角色、差异化的数据需求</strong>：报表设计通常以固定场景为主，缺乏统一的数据服务能力，不易复用，难以满足不同岗位对数据的个性化分析需求。</li>
</ul>
<h2 data-id="heading-3">基于阿里云 SelectDB 升级实时报表</h2>
<p>明确架构瓶颈后，高途教育联合阿里云与飞轮科技，选定基于 Apache Doris 内核的 <strong>阿里云 SelectDB</strong> 作为新一代实时分析引擎，实现 ClickHouse 与 MySQL 的全面替代，构建统一的实时分析平台。</p>
<h3 data-id="heading-4">阿里云 SelectDB 优势</h3>
<p>SelectDB 凭借以下核心优势，精准匹配了高途教育对“高并发、高灵活性、低延迟”的分析需求：</p>
<ol>
<li><strong>高并发支撑能力：支撑千级别并发访问</strong>：通过倒排索引、ZoneMap、Bloom Filter 等多级索引机制，结合分区分桶技术，SelectDB 能在查询时快速裁剪无关数据，显著降低计算与 I/O 负载，稳定支撑成千上万用户同时在线访问。</li>
<li><strong>秒级复杂查询响应：彻底解决多表 Join 性能瓶颈</strong>：SelectDB 支持秒级响应的多表 Join 与宽表查询，显著优于 ClickHouse 的复杂查询能力，满足实时业务对多维数据灵活组合分析的需求，提升业务场景适配性与数据服务能力。</li>
<li><strong>实时更新能力：支持实时写入与高性能查询并存</strong>：借助 Unique Key 模型，SelectDB 实现了强一致语义下的实时更新与查询能力，在数据频繁变更场景下依然保持极高的查询性能，相比 ClickHouse 提供更强的数据鲜活性支持。</li>
<li><strong>企业级可运维性：降低数据平台使用门槛</strong>：SelectDB 提供白屏化运维界面，内建 SQL 审计与查询追踪能力，大幅降低数据平台的运维与使用成本，支持开发人员专注业务逻辑开发，提升整体数据交付效率。</li>
</ol>
<h3 data-id="heading-5">基于阿里云 SelectDB 数据架构</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35ce25dd49c64184a6273208cbc69461~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763549174&amp;x-signature=gOC0TAO5bPgrNoxwKumylXkuuRw%3D" alt="基于阿里云 SelectDB 数据架构.png" loading="lazy"/></p>
<p>实时数据使用 Flink 快速写入 SelectDB，离线数据使用 SeaTunnel 写入 SelectDB。SelectDB 作为查询的统一入口，BI 通过查询入口接入。</p>
<h3 data-id="heading-6">阿里云 SelectDB 实践和调优</h3>
<ul>
<li><strong>功能适配性</strong>：阿里云 SelectDB 集群管理、账号管理、实时监控预警、数据安全管理等企业级功能能够覆盖高途教育对集群的功能需求。此外，阿里云 SelectDB 逻辑视图功能实现计算与存储解耦，当业务需新增分析维度时，仅需改写视图 SQL，无需重构底层数据管道，解决行课场景 MySQL 数据库“牵一发而动全身”的耦合问题。</li>
<li><strong>使用倒排索引</strong>：基于阿里云 SelectDB MPP 架构与向量化查询引擎，对亿级订单、课程、用户表进行实时多表 Join。针对高频查询字段启用阿里云 SelectDB 倒排索引功能，结合 Bloom Filter 预过滤无效数据，在 700+ 高并发查询压力下 P99 延迟低于 200ms，稳定满足核心报表 2s 内响应，相比 ClickHouse 性能提升 7+倍。</li>
</ul>
<p>实践中我们积累了部署与查询过程中的调优经验，特此分享：</p>
<ul>
<li>尽可能使用原字段形式进行过滤：比如过滤时间字段，尽量使用原格式进行过滤，不要针对时间格式转化后过滤，否则扫描量裁剪的效果不佳。</li>
<li>避免使用 Not In 的语法，Not In 的语法会进行全表的扫描，涉及计算的数据量较大，CPU 占用率也随之上升，集群稳定性易受到影响。</li>
<li>尽可能将不同业务线的查询拆分为不同的集群，隔离资源的互相影响。</li>
<li>这部分放到 SelectDB 中，实时任务的原因主要是，我们一开始的维表在 HBase 中，但是由于维度更新原因，我们把这部分放到了 SelectDB 中。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f725ca6cedff49378472f2a66fa659bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763549174&amp;x-signature=8E0g2MXBD5QPYZdKDZvEq37rpU8%3D" alt="阿里云 SelectDB 实践和调优.png" loading="lazy"/></p>
<h2 data-id="heading-7">应用收益</h2>
<p>阿里云 SelectDB 有效支持了高途教育续班及行课期间的实时报表场景，为高途教育带来了分析性能提升、架构灵活性突破、成本降低等收益：</p>
<ul>
<li><strong>分析性能提升</strong>：在 700+ 高并发查询压力下 P99 延迟低于 200ms，稳定满足核心报表 2s 内响应。全部一线人员可秒级获取动态续班与行课数据，查询并发相比 ClickHouse 提升 <strong>7+ 倍</strong>，大幅提升运营决策、一线支持效率。</li>
<li><strong>架构灵活性突破</strong>：实现查询逻辑与数据模型解耦，解决行课场景原 MySQL 架构需求变更需全链路改造的痛点，需求迭代周期大幅缩短。通过阿里云 SelectDB 多表 Join 查询能力，提升开发和交付效率，数据使用更为灵活。</li>
<li><strong>整体成本降低</strong>：阿里云 SelectDB 白屏化运维、SQL 审计和追踪，大幅简化高途教育运维开发流程，提升 <strong>70%</strong> 运维效率。此外，阿里云 SelectDB 统一了高途教育分析引擎，大幅降低多分析引擎导致的资源浪费。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[react 切片 和 优先级调度]]></title>    <link>https://juejin.cn/post/7571655979256053800</link>    <guid>https://juejin.cn/post/7571655979256053800</guid>    <pubDate>2025-11-12T10:28:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571655979256053800" data-draft-id="7571559178743087139" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="react  切片 和  优先级调度"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-12T10:28:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="东华帝君"/> <meta itemprop="url" content="https://juejin.cn/user/2154698523551774"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            react  切片 和  优先级调度
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2154698523551774/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    东华帝君
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T10:28:11.000Z" title="Wed Nov 12 2025 10:28:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>关键点在于，这个决策并 不是 在 workLoop （工作循环） 内部 自己判断的。 workLoop 只是一个“埋头干活的工人”，而真正的“项目经理”是 <strong><code>Scheduler（调度器）</code></strong> 和 <strong><code>Lane（车道）</code></strong> 模型 的组合。
下面我们来拆解一下 React 是如何区分这两种情况的。</p>
<h3 data-id="heading-0">两种不同的“触发机制”</h3>
<p>我们不应该把 <code>workLoop</code> 想象成一个需要猜测当前处境的函数，而应该理解为有两条完全不同的路径，都会最终导向“干活”这一步。</p>
<h3 data-id="heading-1">路径一：时间片用完（优雅地暂停）这是并发渲染中的“常规路径”。</h3>
<ol>
<li>准备工作 ：调度器有一个低优先级的任务。它通过 <code>requestIdleCallback</code> 向浏览器申请“绿灯”（空闲时间）。</li>
<li>开始工作 ：浏览器回应：“你现在有 4 毫秒的空闲时间。” 于是调度器启动 <code>workLoopConcurrent()</code> 。</li>
<li>执行工作 ： while 循环开始执行： <code>while (workInProgress !== null &amp;&amp; !shouldYield())</code> 。
<ul>
<li><code>performUnitOfWork</code> 被调用，处理一个 Fiber 节点。</li>
<li><code>shouldYield()</code> 被调用。它 唯一的职责 就是检查这 4 毫秒的“最后期限”是否已到。它对任务优先级一无所知。</li>
</ul>
</li>
<li>暂停工作 ：假设处理了 20 个 Fiber 节点后，4 毫秒用完了。 shouldYield() 现在返回 true</li>
<li>做出决策 ： while 循环的条件 <code>!shouldYield() </code>变为 <code>false</code> 。循环 优雅地终止 。</li>
<li>最终结果 ： <code>workLoopConcurrent</code> 函数执行完毕。 <code>workInProgress</code> 指针完好无损，依然指向第 21 个待处理的 Fiber 节点。调度器注意到工作还没完成，于是它会预约下一次的 <code>requestIdleCallback</code> ，以便将来继续。
在这个场景里，循环是由其 内部 的 <code>shouldYield</code>() 时间检查来停止的。这是一个有计划的、合作式的暂停。</li>
</ol>
<h3 data-id="heading-2">路径二：高优先级任务插队，强制中断这是确保 UI 响应的“紧急路径”。</h3>
<ol>
<li>当前状态 ： <code>workLoopConcurrent()</code> 正在愉快地执行一个低优先级的更新（比如我们上面的例子）。</li>
<li>“入侵者”出现 ：用户点击了一个按钮。事件处理器触发，调用了 <code>setState</code> 。</li>
<li>发出信号 ： <code>scheduleUpdateOnFiber</code> 函数被调用。它获得了一个 高优先级的车道 （例如 SyncLane ）。它把这个 <code>SyncLane</code> 添加到 Fiber 根节点的 <code>pendingLanes</code> （待处理车道）上。</li>
<li>“项目经理”被唤醒 ：调度器收到了这个变更通知。它立刻检查所有任务的优先级，发现：
<ul>
<li>当前正在运行的车道 ( <code>workInProgressRootRenderLanes</code> )：是<code>低优先级</code>的（例如 TransitionLane ）。</li>
<li>新加入的待处理车道 ( <code>pendingLanes</code> )：包含一个<code>高优先级</code>的 SyncLane 。</li>
</ul>
</li>
<li>做出决策 ：调度器<code>在 </code>当前运行的 <code>workLoop 之外</code>，在更高的层级 做出了关键判断。它看到 SyncLane 的优先级高于 TransitionLane 。它决定 必须<code>中断 当前</code>的工作。</li>
<li>执行中断 ：
<ul>
<li>它不会礼貌地等待 shouldYield() 。</li>
<li>它直接调用 prepareFreshStack() 函数。</li>
<li><code>prepareFreshStack</code> 丢弃 了旧的、只做了一半的 workInProgress 树，并为这个高优先级的 SyncLane 更新创建了一个 全新的 workInProgress 树。</li>
<li>然后，它会立刻开始一个 新的 工作循环（通常是 <code>workLoopSync</code> ，这个循环会完全 忽略 shouldYield ，因为它必须一次性执行完毕）。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-3">React 选择 workLoopSync 还是 workLoopConcurrent 的核心逻辑</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> shouldTimeSlice =
  (!forceSync &amp;&amp;
    !<span class="hljs-title function_">includesBlockingLane</span>(lanes) &amp;&amp;
    !<span class="hljs-title function_">includesExpiredLane</span>(root, lanes)) ||
  (enableSiblingPrerendering &amp;&amp; <span class="hljs-title function_">checkIfRootIsPrerendering</span>(root, lanes));
</code></pre>
<h4 data-id="heading-4">决策关键：<code>shouldTimeSlice</code> 变量</h4>
<ul>
<li>位置：<code>react-reconciler/ReactFiberWorkLoop.js</code></li>
<li>作用：决定使用同步渲染（<code>workLoopSync</code>）还是并发渲染（<code>workLoopConcurrent</code>）</li>
</ul>
<h4 data-id="heading-5">1. 执行 workLoopSync（同步渲染）的情况</h4>
<p>当 <code>shouldTimeSlice = false</code> 时，满足以下任一条件：</p>
<ul>
<li>
<p><strong>条件 1</strong>：<code>forceSync = true</code></p>
<ul>
<li>由 <code>ReactDOM.flushSync()</code> 强制触发的更新，必须立即同步执行。</li>
</ul>
</li>
<li>
<p><strong>条件 2</strong>：<code>includesBlockingLane(lanes) = true</code></p>
<ul>
<li>更新属于<code>高优先级</code> “阻塞车道”（如 <strong><code>用户输入、点击等</code></strong> 交互事件），需立即响应。</li>
</ul>
</li>
<li>
<p><strong>条件 3</strong>：<code>includesExpiredLane(root, lanes) = true</code></p>
<ul>
<li>低优先级任务因被<code>反复打断</code>而 “<code>过期</code>”，强制同步执行避免 “<code>饥饿</code>”。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-6">2. 执行 workLoopConcurrent（并发渲染）的情况</h4>
<p>当 <code>shouldTimeSlice = true</code> 时，满足以下所有条件：</p>
<ul>
<li>非 <code>flushSync</code> 触发的更新；</li>
<li>不属于高优先级阻塞车道；</li>
<li>未过期的低优先级任务；</li>
<li>典型场景：<code>startTransition</code> 包裹的更新、网络请求后的 UI 更新等。</li>
</ul>
<h4 data-id="heading-7">总结记忆表</h4>




















<table><thead><tr><th>渲染模式</th><th>触发场景</th><th>核心特点</th></tr></thead><tbody><tr><td>workLoopSync</td><td>flushSync / 用户交互 / 过期任务</td><td>同步、不可中断、高优先级</td></tr><tr><td>workLoopConcurrent</td><td>startTransition / 异步数据更新 / 非紧急任务</td><td>可中断、低优先级、时间分片</td></tr></tbody></table>
<h3 data-id="heading-8">React 事件优先级判断机制总结</h3>
<h4 data-id="heading-9">核心决策者：<code>getEventPriority</code> 函数</h4>
<ul>
<li>位置：<code>react-dom-bindings/src/events/ReactDOMEventListener.js</code></li>
<li>作用：根据事件类型分配优先级，决定后续渲染模式（同步 / 并发）</li>
</ul>
<h4 data-id="heading-10">三大优先级分类及对应事件</h4>





























<table><thead><tr><th>优先级类型</th><th>对应事件示例</th><th>特点</th><th>渲染模式</th></tr></thead><tbody><tr><td><strong>DiscreteEventPriority</strong>（离散事件优先级）</td><td>click、keydown、input、focus、submit</td><td>用户直接、单次交互，需即时反馈</td><td>同步渲染（workLoopSync）</td></tr><tr><td><strong>ContinuousEventPriority</strong>（连续事件优先级）</td><td>scroll、mousemove、touchmove、drag</td><td>高频连续触发，避免阻塞主线程</td><td>并发渲染（可中断）</td></tr><tr><td><strong>DefaultEventPriority</strong>（默认事件优先级）</td><td>load、error、未明确分类事件</td><td>异步或非用户直接交互事件</td><td>并发渲染（可中断）</td></tr></tbody></table>
<h4 data-id="heading-11">关键流程</h4>
<ol>
<li><strong>事件捕获</strong>：所有浏览器事件先被 React 统一监听器捕获（而非直接触发用户写的回调）。</li>
<li><strong>优先级分配</strong>：<code>getEventPriority</code> 通过 <code>switch</code> 语句判断事件类型，分配对应优先级。</li>
<li><strong>调度渲染</strong>：高优先级（离散事件）走同步渲染，低优先级（连续 / 默认事件）走并发渲染。</li>
</ol>
<h4 data-id="heading-12">记忆要点</h4>
<ul>
<li><strong>VIP 事件</strong>（点击、输入等）→ 高优先级 → 同步渲染（不卡顿）。</li>
<li><strong>高频事件</strong>（滚动、鼠标移动等）→ 中优先级 → 可中断渲染（保流畅）。</li>
<li><strong>其他事件</strong> → 低优先级 → 并发渲染（不阻塞）。</li>
</ul>
<p>这个机制从源头区分任务轻重，是 React 并发模式流畅运行的核心基础。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7bfb7234604d491cbdf0e0b3e6069252~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lic5Y2O5bid5ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763548091&amp;x-signature=P0EbWf0O1fZpWuUpLNVdpuc6eKs%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kotlin 协程基础入门系列：从概念到实战]]></title>    <link>https://juejin.cn/post/7571641339688812544</link>    <guid>https://juejin.cn/post/7571641339688812544</guid>    <pubDate>2025-11-12T10:37:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571641339688812544" data-draft-id="7571559178743234595" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kotlin 协程基础入门系列：从概念到实战"/> <meta itemprop="keywords" content="Kotlin,后端,Android"/> <meta itemprop="datePublished" content="2025-11-12T10:37:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Android_小雨"/> <meta itemprop="url" content="https://juejin.cn/user/220360279590862"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kotlin 协程基础入门系列：从概念到实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/220360279590862/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Android_小雨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T10:37:40.000Z" title="Wed Nov 12 2025 10:37:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:18px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:40px;margin-bottom:20px;color:#007fff;display:flex;align-items:center}.markdown-body h1:hover:before,.markdown-body h2:hover:before,.markdown-body h3:hover:before,.markdown-body h4:hover:before,.markdown-body h5:hover:before,.markdown-body h6:hover:before{transition:All .4s ease-in-out;transform:rotate(1turn)}.markdown-body h1{font-size:30px;background:linear-gradient(#fff 60%,#c6e3ff 0)}.markdown-body h1:before{content:"";display:inline-block;width:32px;height:32px;margin-right:10px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC");background-size:100% 100%}.markdown-body h2{font-size:24px;background:linear-gradient(#fff 60%,#cce3fb 0)}.markdown-body h2:before{content:"";display:inline-block;width:24px;height:24px;margin-right:10px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC");background-size:100% 100%}.markdown-body h3{font-size:20px}.markdown-body h3:before{content:"";display:inline-block;width:18px;height:18px;margin-right:10px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC");background-size:100% 100%}.markdown-body h4{font-size:18px}.markdown-body h4:before{content:"";display:inline-block;width:16px;height:16px;margin-right:10px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC");background-size:100% 100%}.markdown-body h5{font-size:16px}.markdown-body h5:before{content:"";display:inline-block;width:15px;height:15px;margin-right:10px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC");background-size:100% 100%}.markdown-body h6{font-size:14px}.markdown-body h6:before{content:"";display:inline-block;width:12px;height:12px;margin-right:10px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC");background-size:100% 100%}.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{border-bottom:2px solid #007fff;color:#007fff;padding-right:10px}.markdown-body p{letter-spacing:1px;line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:10px auto}.markdown-body hr{border:none;border-top:1px dashed #92c8ff}.markdown-body hr:before{content:"✂";display:inline-block;position:relative;top:-12px;left:40px;padding:0 3px;color:#007fff;font-size:18px}.markdown-body hr:after{content:"按虚线剪开";position:relative;top:-15px;left:84%;padding:0 3px;color:#007fff;font-size:12px}.markdown-body del{color:#f44}.markdown-body em{color:#007fff;margin:0 2px}.markdown-body strong{color:#007fff;font-weight:bolder}.markdown-body code{word-break:break-word;border-radius:4px;overflow-x:auto;background-color:#e6f3ff;color:#007fff;font-weight:600;font-size:16px;padding:.065em .4em;border:1px solid #007fff}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:5px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:18px;font-weight:400;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8;border:none}.markdown-body a{text-decoration:none;color:#007fff;border-bottom:1px solid #007fff}.markdown-body a:before{content:"¶";margin-right:5px;font-size:22px}.markdown-body a:after{content:"↷";margin-left:2px;font-size:22px;display:none}.markdown-body a:active,.markdown-body a:hover{color:#275b8c;border-bottom:1px solid #275b8c}.markdown-body a:active:after,.markdown-body a:hover:after{display:inline-block}.markdown-body table{display:inline-block!important;font-size:16px;width:auto;max-width:100%;overflow:auto;border:1px solid #a5d3ff}.markdown-body thead{background:#c6e3ff;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#eef7ff}.markdown-body tbody&gt;tr:nth-child(odd){background-color:#f8fcff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #007fff;background-color:#eef7ff}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#007fff}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="srcery">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1c1b19;color:#fce8c3}.hljs-emphasis,.hljs-strong{color:#918175}.hljs-bullet,.hljs-link,.hljs-literal,.hljs-number,.hljs-quote,.hljs-regexp{color:#ff5c8f}.hljs-code,.hljs-selector-class{color:#68a8e4}.hljs-emphasis{font-style:italic}.hljs-attribute,.hljs-keyword,.hljs-section,.hljs-selector-tag,.hljs-variable{color:#ef2f27}.hljs-name,.hljs-title{color:#fbb829}.hljs-params,.hljs-type{color:#0aaeb3}.hljs-string{color:#98bc37}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-selector-attr,.hljs-selector-id,.hljs-selector-pseudo,.hljs-subst,.hljs-symbol,.hljs-template-tag,.hljs-template-variable{color:#c07abe}.hljs-comment,.hljs-deletion,.hljs-meta{color:#918175}</style><blockquote>
<p>最近一直在深耕 Kotlin 协程，通过官方文档系统学习 + 个人实践总结，梳理出了一套完整的学习笔记。不得不说，官方文档永远是最权威、最全面的学习资料。</p>
<p>协程官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fdocs%2Fcoroutines-guide.html" target="_blank" title="https://kotlinlang.org/docs/coroutines-guide.html" ref="nofollow noopener noreferrer">Coroutines guide | Kotlin</a></p>
<p>在线运行代码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplay.kotlinlang.org%2F%23eyJ2ZXJzaW9uIjoiMi4yLjIxIiwicGxhdGZvcm0iOiJqYXZhIiwiYXJncyI6IiIsIm5vbmVNYXJrZXJzIjp0cnVlLCJ0aGVtZSI6ImlkZWEiLCJjb2RlIjoiLyoqXG4gKiBZb3UgY2FuIGVkaXQsIHJ1biwgYW5kIHNoYXJlIHRoaXMgY29kZS5cbiAqIHBsYXkua290bGlubGFuZy5vcmdcbiAqL1xuZnVuIG1haW4oKSB7XG4gICAgcHJpbnRsbihcIkhlbGxvLCB3b3JsZCEhIVwiKVxufSJ9" target="_blank" title="https://play.kotlinlang.org/#eyJ2ZXJzaW9uIjoiMi4yLjIxIiwicGxhdGZvcm0iOiJqYXZhIiwiYXJncyI6IiIsIm5vbmVNYXJrZXJzIjp0cnVlLCJ0aGVtZSI6ImlkZWEiLCJjb2RlIjoiLyoqXG4gKiBZb3UgY2FuIGVkaXQsIHJ1biwgYW5kIHNoYXJlIHRoaXMgY29kZS5cbiAqIHBsYXkua290bGlubGFuZy5vcmdcbiAqL1xuZnVuIG1haW4oKSB7XG4gICAgcHJpbnRsbihcIkhlbGxvLCB3b3JsZCEhIVwiKVxufSJ9" ref="nofollow noopener noreferrer">Kotlin Playground: Edit, Run, Share Kotlin Code Online</a></p>
<p>我计划用多篇文章，从基础到进阶、从用法到原理，把 Kotlin 协程的核心知识点拆解得明明白白，现在把这份笔记分享出来，希望能给正在学习协程的读者提供一些帮助。</p>
<p>由于个人知识储备有限，笔记中难免存在疏漏或表述不当的地方，也非常欢迎大家提出宝贵意见，一起交流进步</p>
</blockquote>
<h2 data-id="heading-0">1.引言：什么是协程？为什么选择协程？</h2>
<h3 data-id="heading-1">1.1 并发、并行与线程的限制</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0be31fc8d6d4d778be36d481ed95cd4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5kcm9pZF_lsI_pm6g=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763549615&amp;x-signature=28P3wvwJp%2F1%2Faym%2B3u7CgQDwLZM%3D" alt="image.png" loading="lazy"/></p>
<p><strong>核心概念辨析</strong>：并发是“同一时间段内多个任务交替执行”，并行是“同一时刻多个任务同时执行”。线程作为操作系统调度的基本单位，是实现并发/并行的传统方案，但存在显著限制：</p>
<ul>
<li>创建成本高：每个线程占用约1-2MB栈内存，无法大规模创建</li>
<li>上下文切换开销大：线程切换需切换内核态与用户态，耗时约100ns级别</li>
<li>数量上限低：普通JVM进程中线程数量上限通常为几千个，无法满足高并发场景</li>
</ul>
<h3 data-id="heading-2">1.2 协程定义：可挂起的轻量计算单元</h3>
<p>Kotlin协程是<strong>可暂停、可恢复且不阻塞线程的计算单元</strong>，核心优势是能以“顺序代码风格”编写并发逻辑，避免回调地狱。其本质是用户态的“虚拟线程”，由Kotlin运行时调度而非操作系统，因此创建成本极低（仅几KB栈内存，支持百万级并发）。</p>
<p>官方文档参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fdocs%2Fcoroutines-basics.html%3Futm_source%3Dchatgpt.com" target="_blank" title="https://kotlinlang.org/docs/coroutines-basics.html?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">Kotlin Coroutines Basics</a></p>
<h2 data-id="heading-3">2.挂起函数基础：协程的“暂停与恢复”</h2>
<h3 data-id="heading-4">2.1 suspend关键字：挂起函数的标识</h3>
<p><strong>核心含义</strong>：用<code>suspend</code>修饰的函数称为挂起函数，具备两个核心能力：</p>
<ul>
<li>暂停执行：在特定节点（如等待IO完成）暂停函数执行，释放当前线程</li>
<li>恢复执行：当等待条件满足（如IO结果返回）时，从暂停点继续执行</li>
</ul>
<p>关键特性：挂起≠阻塞，挂起时线程可被复用执行其他任务，大幅提升资源利用率。</p>
<p>官方文档参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fdocs%2Fcoroutines-basics.html%3Futm_source%3Dchatgpt.com" target="_blank" title="https://kotlinlang.org/docs/coroutines-basics.html?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">Suspending Functions</a></p>
<h3 data-id="heading-5">2.2 挂起函数的声明与调用规则</h3>
<h4 data-id="heading-6">2.2.1 声明语法</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 挂起函数声明：用suspend关键字修饰</span>
<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fetchData</span><span class="hljs-params">(url: <span class="hljs-type">String</span>)</span></span>: String {
    <span class="hljs-comment">// 模拟网络请求（挂起操作）</span>
    delay(<span class="hljs-number">1000</span>) <span class="hljs-comment">// delay是Kotlin标准库的挂起函数</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"数据结果：<span class="hljs-subst">${url}</span> 返回成功"</span>
}
</code></pre>
<h4 data-id="heading-7">2.2.2 调用场景</h4>
<p>挂起函数不能在普通函数中直接调用，必须在以下场景中执行：</p>
<ol>
<li>其他挂起函数中（如在另一个suspend函数里调用fetchData）</li>
<li>协程作用域中（如launch/async创建的协程内）</li>
<li>桥接函数中（如runBlocking，用于非协程环境调用挂起函数）</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.delay
<span class="hljs-keyword">import</span> kotlinx.coroutines.runBlocking

<span class="hljs-comment">// 1. 挂起函数中调用挂起函数</span>
<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">processData</span><span class="hljs-params">(url: <span class="hljs-type">String</span>)</span></span>: String {
    <span class="hljs-keyword">val</span> rawData = fetchData(url) <span class="hljs-comment">// 合法：挂起函数调用挂起函数</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"处理后的数据：<span class="hljs-subst">${rawData}</span>"</span>
}

<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fetchData</span><span class="hljs-params">(url: <span class="hljs-type">String</span>)</span></span>: String {
    delay(<span class="hljs-number">1000</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">"原始数据：<span class="hljs-subst">${url}</span>"</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 2. runBlocking桥接非协程环境</span>
    runBlocking {
        <span class="hljs-keyword">val</span> result = processData(<span class="hljs-string">"https://api.example.com"</span>)
        println(result)
    }

    <span class="hljs-comment">// 3. 直接调用挂起函数（错误示例）</span>
    <span class="hljs-comment">// val errorResult = fetchData("https://api.example.com")</span>
    <span class="hljs-comment">// 编译报错：Suspend function 'fetchData' should be called only from a coroutine or another suspend function</span>
}

<span class="hljs-comment">// 4. 挂起主函数（Kotlin 1.3+支持，替代runBlocking）</span>
<span class="hljs-comment">// suspend fun main() {</span>
<span class="hljs-comment">//     val result = processData("https://api.example.com")</span>
<span class="hljs-comment">//     println(result)</span>
<span class="hljs-comment">// }</span>

</code></pre>
<p>官方文档参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fdocs%2Fcoroutines-basics.html%3Futm_source%3Dchatgpt.com" target="_blank" title="https://kotlinlang.org/docs/coroutines-basics.html?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">Calling Suspending Functions</a></p>
<h3 data-id="heading-8">2.3 实战示例：挂起函数模拟IO操作</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.delay
<span class="hljs-keyword">import</span> kotlinx.coroutines.runBlocking

<span class="hljs-comment">// 挂起函数：模拟文件读取（IO操作）</span>
<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">readFile</span><span class="hljs-params">(filePath: <span class="hljs-type">String</span>)</span></span>: String {
    println(<span class="hljs-string">"开始读取文件：<span class="hljs-subst">${filePath}</span>，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
    delay(<span class="hljs-number">1500</span>) <span class="hljs-comment">// 模拟IO等待，挂起1.5秒，不阻塞线程</span>
    println(<span class="hljs-string">"文件读取完成：<span class="hljs-subst">${filePath}</span>，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">"文件内容：<span class="hljs-subst">${filePath}</span> 的数据"</span>
}

<span class="hljs-comment">// 挂起函数：模拟网络请求（IO操作）</span>
<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fetchFromNetwork</span><span class="hljs-params">(url: <span class="hljs-type">String</span>)</span></span>: String {
    println(<span class="hljs-string">"开始网络请求：<span class="hljs-subst">${url}</span>，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
    delay(<span class="hljs-number">1000</span>) <span class="hljs-comment">// 模拟网络等待，挂起1秒</span>
    println(<span class="hljs-string">"网络请求完成：<span class="hljs-subst">${url}</span>，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">"网络数据：<span class="hljs-subst">${url}</span> 的响应"</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    println(<span class="hljs-string">"主作用域启动，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)

    <span class="hljs-comment">// 顺序调用两个挂起函数</span>
    <span class="hljs-keyword">val</span> fileData = readFile(<span class="hljs-string">"/data/local.txt"</span>)
    <span class="hljs-keyword">val</span> networkData = fetchFromNetwork(<span class="hljs-string">"https://api.example.com"</span>)

    println(<span class="hljs-string">"最终结果：\n<span class="hljs-subst">${fileData}</span>\n<span class="hljs-subst">${networkData}</span>"</span>)
    println(<span class="hljs-string">"主作用域结束，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
}
</code></pre>
<h4 data-id="heading-9">运行结果</h4>
<pre><code class="hljs language-perl" lang="perl">主作用域启动，线程：main @coroutine<span class="hljs-comment">#1</span>
开始读取文件：/data/local.txt，线程：main @coroutine<span class="hljs-comment">#1</span>
文件读取完成：/data/local.txt，线程：main @coroutine<span class="hljs-comment">#1</span>
开始网络请求：https:<span class="hljs-regexp">//api</span>.example.com，线程：main @coroutine<span class="hljs-comment">#1</span>
网络请求完成：https:<span class="hljs-regexp">//api</span>.example.com，线程：main @coroutine<span class="hljs-comment">#1</span>
最终结果：
文件内容：/data/local.txt 的数据
网络数据：https:<span class="hljs-regexp">//api</span>.example.com 的响应
主作用域结束，线程：main @coroutine<span class="hljs-comment">#1</span>
</code></pre>
<h4 data-id="heading-10">结果分析</h4>
<ul>
<li>线程复用：整个过程中挂起函数始终在main线程执行，delay挂起时main线程未被阻塞（若为Thread.sleep则会阻塞主线程）</li>
<li>顺序执行：readFile执行完成后才开始fetchFromNetwork，体现“顺序代码风格”的并发逻辑</li>
<li>挂起特性：delay期间主线程可被Kotlin运行时调度执行其他任务（本示例为单任务，未体现）</li>
</ul>
<h3 data-id="heading-11">2.4 核心对比：挂起函数 vs 普通函数 vs 阻塞函数</h3>















































<table><thead><tr><th><strong>对比维度</strong></th><th><strong>挂起函数（suspend）</strong></th><th><strong>普通函数</strong></th><th><strong>阻塞函数（如Thread.sleep）</strong></th></tr></thead><tbody><tr><td>关键字</td><td>suspend修饰</td><td>无</td><td>无（运行时阻塞）</td></tr><tr><td>暂停能力</td><td>支持暂停，恢复后从断点执行</td><td>无暂停能力，一次性执行完成</td><td>无暂停能力，阻塞期间无法执行</td></tr><tr><td>线程占用</td><td>暂停时释放线程，恢复后复用</td><td>执行期间占用，完成后释放</td><td>阻塞期间持续占用线程</td></tr><tr><td>调用场景</td><td>协程或其他挂起函数中</td><td>任意场景</td><td>任意场景</td></tr><tr><td>典型场景</td><td>IO操作（网络、文件、数据库）</td><td>普通计算逻辑</td><td>强制等待（如测试延迟）</td></tr><tr><td>线程名称示例</td><td>执行前后线程一致（如main）</td><td>执行期间线程固定</td><td>阻塞期间线程固定且无法复用</td></tr></tbody></table>
<h2 data-id="heading-12">3.创建第一个协程：作用域与构建器</h2>
<blockquote>
<p><strong>作用域（CoroutineScope）</strong> 定义协程的生命周期边界，<strong>构建器（Builder）</strong> 负责启动协程，二者配合实现安全并发。</p>
</blockquote>
<h3 data-id="heading-13">3.1 协程的“生存空间”：CoroutineScope</h3>
<p><strong>核心作用</strong>：CoroutineScope（协程作用域）是管理协程生命周期的容器，负责跟踪所有创建的协程，确保协程能被统一取消、异常能被统一处理，避免协程泄漏。</p>
<p>关键特性：每个协程都必须属于一个作用域，作用域销毁时会自动取消所有子协程。</p>
<h3 data-id="heading-14">3.2 协程构建器：启动协程的三大工具</h3>
<p>协程构建器是用于在作用域内创建协程的函数，核心有三个：launch（无返回值）、async（有返回值）、runBlocking（桥接非协程环境）。</p>
<p>官方文档参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fdocs%2Fcoroutines-basics.html%3Futm_source%3Dchatgpt.com" target="_blank" title="https://kotlinlang.org/docs/coroutines-basics.html?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">Coroutine Builders</a></p>
<h4 data-id="heading-15">3.2.1 launch：启动无返回值协程</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.CoroutineScope
<span class="hljs-keyword">import</span> kotlinx.coroutines.Dispatchers
<span class="hljs-keyword">import</span> kotlinx.coroutines.launch
<span class="hljs-keyword">import</span> kotlinx.coroutines.delay
<span class="hljs-keyword">import</span> kotlinx.coroutines.runBlocking

<span class="hljs-comment">// 模拟发送通知的任务（无返回值）</span>
<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">sendNotification</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>, message: <span class="hljs-type">String</span>)</span></span> {
    println(<span class="hljs-string">"开始给用户 <span class="hljs-subst">${userId}</span> 发送通知，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
    delay(<span class="hljs-number">800</span>) <span class="hljs-comment">// 模拟通知发送耗时</span>
    println(<span class="hljs-string">"给用户 <span class="hljs-subst">${userId}</span> 发送通知完成，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    println(<span class="hljs-string">"主作用域启动，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
    <span class="hljs-comment">// 1. 创建协程作用域，指定调度器为IO（适合IO密集型任务）</span>
    <span class="hljs-keyword">val</span> ioScope = CoroutineScope(Dispatchers.IO)

    <span class="hljs-comment">// 2. 用launch启动第一个协程（无返回值）</span>
    ioScope.launch {
        sendNotification(<span class="hljs-string">"user1001"</span>, <span class="hljs-string">"您有新消息"</span>)
    }

    <span class="hljs-comment">// 3. 用launch启动第二个协程</span>
    ioScope.launch {
        sendNotification(<span class="hljs-string">"user1002"</span>, <span class="hljs-string">"系统更新提醒"</span>)
    }

    <span class="hljs-comment">// 等待协程执行完成（实际开发中用更优雅的方式，如joinAll）</span>
    delay(<span class="hljs-number">1000</span>)
    println(<span class="hljs-string">"主作用域结束，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
}

</code></pre>
<h4 data-id="heading-16">运行结果</h4>
<pre><code class="hljs language-perl" lang="perl">主作用域启动，线程：main @coroutine<span class="hljs-comment">#1</span>
开始给用户 user1002 发送通知，线程：DefaultDispatcher-worker-<span class="hljs-number">2</span> @coroutine<span class="hljs-comment">#3</span>
开始给用户 user1001 发送通知，线程：DefaultDispatcher-worker-<span class="hljs-number">1</span> @coroutine<span class="hljs-comment">#2</span>
给用户 user1001 发送通知完成，线程：DefaultDispatcher-worker-<span class="hljs-number">2</span> @coroutine<span class="hljs-comment">#2</span>
给用户 user1002 发送通知完成，线程：DefaultDispatcher-worker-<span class="hljs-number">1</span> @coroutine<span class="hljs-comment">#3</span>
主作用域结束，线程：main @coroutine<span class="hljs-comment">#1</span>
</code></pre>
<h4 data-id="heading-17">结果分析</h4>
<ul>
<li>并发执行：两个通知任务在不同线程（DefaultDispatcher-worker-1/2）同时执行，总耗时约800ms（而非1600ms）</li>
<li>无返回值：launch创建的协程仅执行副作用（如发送通知），不返回结果</li>
<li>调度器作用：指定Dispatchers.IO后，协程在IO线程池执行，不占用主线程</li>
</ul>
<h4 data-id="heading-18">3.2.2 async：启动有返回值协程</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.async
<span class="hljs-keyword">import</span> kotlinx.coroutines.delay
<span class="hljs-keyword">import</span> kotlinx.coroutines.runBlocking
<span class="hljs-keyword">import</span> kotlinx.coroutines.Dispatchers

<span class="hljs-comment">// 模拟计算任务（有返回值）</span>
<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">calculateSum</span><span class="hljs-params">(start: <span class="hljs-type">Int</span>, end: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> {
    println(<span class="hljs-string">"开始计算 <span class="hljs-subst">${start}</span> 到 <span class="hljs-subst">${end}</span> 的和，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
    delay(<span class="hljs-number">1000</span>) <span class="hljs-comment">// 模拟计算耗时</span>
    <span class="hljs-keyword">val</span> sum = (start..end).sum()
    println(<span class="hljs-string">"计算 <span class="hljs-subst">${start}</span> 到 <span class="hljs-subst">${end}</span> 的和完成，结果：<span class="hljs-subst">${sum}</span>，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
    <span class="hljs-keyword">return</span> sum
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    println(<span class="hljs-string">"主作用域启动，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)

    <span class="hljs-comment">// 1. 用async启动有返回值协程，返回Deferred对象</span>
    <span class="hljs-keyword">val</span> deferred1 = async(Dispatchers.Default) { <span class="hljs-comment">// Default适合CPU密集型计算</span>
        calculateSum(<span class="hljs-number">1</span>, <span class="hljs-number">1000</span>)
    }

    <span class="hljs-keyword">val</span> deferred2 = async(Dispatchers.Default) {
        calculateSum(<span class="hljs-number">1001</span>, <span class="hljs-number">2000</span>)
    }

    <span class="hljs-comment">// 2. 用await()获取协程结果（会挂起等待，不阻塞线程）</span>
    <span class="hljs-keyword">val</span> sum1 = deferred1.await()
    <span class="hljs-keyword">val</span> sum2 = deferred2.await()

    <span class="hljs-keyword">val</span> totalSum = sum1 + sum2
    println(<span class="hljs-string">"最终总和：<span class="hljs-subst">${sum1}</span> + <span class="hljs-subst">${sum2}</span> = <span class="hljs-subst">${totalSum}</span>，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
}
</code></pre>
<h4 data-id="heading-19">运行结果</h4>
<pre><code class="hljs language-perl" lang="perl">主作用域启动，线程：main @coroutine<span class="hljs-comment">#1</span>
开始计算 <span class="hljs-number">1</span> 到 <span class="hljs-number">1000</span> 的和，线程：DefaultDispatcher-worker-<span class="hljs-number">1</span> @coroutine<span class="hljs-comment">#2</span>
开始计算 <span class="hljs-number">1001</span> 到 <span class="hljs-number">2000</span> 的和，线程：DefaultDispatcher-worker-<span class="hljs-number">2</span> @coroutine<span class="hljs-comment">#3</span>
计算 <span class="hljs-number">1001</span> 到 <span class="hljs-number">2000</span> 的和完成，结果：<span class="hljs-number">1500500</span>，线程：DefaultDispatcher-worker-<span class="hljs-number">1</span> @coroutine<span class="hljs-comment">#3</span>
计算 <span class="hljs-number">1</span> 到 <span class="hljs-number">1000</span> 的和完成，结果：<span class="hljs-number">500500</span>，线程：DefaultDispatcher-worker-<span class="hljs-number">2</span> @coroutine<span class="hljs-comment">#2</span>
最终总和：<span class="hljs-number">500500</span> + <span class="hljs-number">1500500</span> = <span class="hljs-number">2001000</span>，线程：main @coroutine<span class="hljs-comment">#1</span>
</code></pre>
<h4 data-id="heading-20">结果分析</h4>
<ul>
<li>有返回值：async创建的协程通过Deferred.await()获取结果，支持并发计算后聚合结果</li>
<li>挂起等待：await()会挂起当前协程（main所在的runBlocking协程），但不阻塞main线程，期间可执行其他任务</li>
<li>CPU优化：Dispatchers.Default调度器使用CPU核心数的线程池，适合计算密集型任务</li>
</ul>
<h4 data-id="heading-21">3.2.3 runBlocking：桥接非协程环境</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.delay
<span class="hljs-keyword">import</span> kotlinx.coroutines.runBlocking

<span class="hljs-comment">// 挂起函数</span>
<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doSomething</span><span class="hljs-params">()</span></span> {
    delay(<span class="hljs-number">500</span>)
    println(<span class="hljs-string">"挂起函数执行完成，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    println(<span class="hljs-string">"普通main函数启动，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)

    <span class="hljs-comment">// runBlocking将普通函数转为协程作用域，阻塞当前线程直到内部协程完成</span>
    runBlocking {
        doSomething()
        println(<span class="hljs-string">"runBlocking内部执行完成，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
    }

    println(<span class="hljs-string">"普通main函数结束，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
}
</code></pre>
<h4 data-id="heading-22">运行结果</h4>
<pre><code class="hljs language-less" lang="less">普通<span class="hljs-selector-tag">main</span>函数启动，线程：<span class="hljs-selector-tag">main</span>
挂起函数执行完成，线程：<span class="hljs-selector-tag">main</span> @<span class="hljs-selector-tag">coroutine</span><span class="hljs-selector-id">#1</span>
<span class="hljs-selector-tag">runBlocking</span>内部执行完成，线程：<span class="hljs-selector-tag">main</span> @<span class="hljs-selector-tag">coroutine</span><span class="hljs-selector-id">#1</span>
普通<span class="hljs-selector-tag">main</span>函数结束，线程：<span class="hljs-selector-tag">main</span>
</code></pre>
<h4 data-id="heading-23">关键说明</h4>
<p>runBlocking是“桥接工具”，仅用于测试或main函数等入口场景，<strong>禁止在业务逻辑中使用</strong>（会阻塞线程，违背协程非阻塞理念）。</p>
<h3 data-id="heading-24">3.3 launch与async的核心区别</h3>



































<table><thead><tr><th><strong>对比维度</strong></th><th><strong>launch</strong></th><th><strong>async</strong></th></tr></thead><tbody><tr><td>返回值类型</td><td>Job（用于控制协程生命周期）</td><td>Deferred（继承Job，可获取返回值）</td></tr><tr><td>核心用途</td><td>执行无返回值的副作用任务（如通知、日志）</td><td>执行有返回值的计算任务（如数据查询、统计）</td></tr><tr><td>结果获取</td><td>无结果，通过修改外部变量或回调体现效果</td><td>通过await()挂起获取结果</td></tr><tr><td>异常处理</td><td>异常直接抛出到作用域</td><td>异常在await()时抛出</td></tr><tr><td>典型场景</td><td>发送短信、更新UI状态</td><td>并行查询多个接口后聚合数据</td></tr></tbody></table>
<h2 data-id="heading-25">4.协程上下文与调度器：控制协程的执行线程</h2>
<h3 data-id="heading-26">4.1 CoroutineDispatcher：协程的“线程分配器”</h3>
<p><strong>核心定义</strong>：CoroutineDispatcher（协程调度器）是协程上下文（CoroutineContext）的核心组件，负责决定协程在哪个线程或线程池上执行，实现“协程-线程”的解耦。</p>
<p>工作原理：调度器维护线程池，当协程需要执行时，调度器从池中分配线程；协程挂起时，线程归还给池供其他协程使用。</p>
<p>官方文档参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fdocs%2Fcoroutines-basics.html%3Futm_source%3Dchatgpt.com" target="_blank" title="https://kotlinlang.org/docs/coroutines-basics.html?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">Coroutine Dispatchers</a></p>
<h3 data-id="heading-27">4.2 常用调度器详解</h3>



































<table><thead><tr><th><strong>调度器类型</strong></th><th><strong>核心特点</strong></th><th><strong>线程池规模</strong></th><th><strong>适用场景</strong></th></tr></thead><tbody><tr><td>Dispatchers.Default</td><td>CPU密集型调度器，优化计算性能</td><td>默认等于CPU核心数（如4核CPU为4个线程）</td><td>排序、加密、大量数据解析等计算任务</td></tr><tr><td>Dispatchers.IO</td><td>IO密集型调度器，优化等待效率</td><td>动态扩容，默认64个线程，空闲线程可回收</td><td>网络请求、文件读写、数据库操作等IO任务</td></tr><tr><td>Dispatchers.Main</td><td>主线程调度器，平台依赖</td><td>仅1个主线程</td><td>Android的UI更新、桌面应用的界面操作</td></tr><tr><td>Dispatchers.Unconfined</td><td>无限制调度器，不固定线程</td><td>无固定线程池，使用当前执行线程</td><td>快速非阻塞任务，不推荐常规使用</td></tr></tbody></table>
<h3 data-id="heading-28">4.3 实战：调度器切换与使用</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.Dispatchers
<span class="hljs-keyword">import</span> kotlinx.coroutines.async
<span class="hljs-keyword">import</span> kotlinx.coroutines.runBlocking
<span class="hljs-keyword">import</span> kotlinx.coroutines.withContext

<span class="hljs-comment">// 1. CPU密集型任务：数据排序（用Default调度器）</span>
<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">sortLargeData</span><span class="hljs-params">(<span class="hljs-keyword">data</span>: <span class="hljs-type">List</span>&lt;<span class="hljs-type">Int</span>&gt;)</span></span>: List&lt;<span class="hljs-built_in">Int</span>&gt; {
    <span class="hljs-keyword">return</span> withContext(Dispatchers.Default) {
        println(<span class="hljs-string">"开始排序数据，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
        delay(<span class="hljs-number">800</span>) <span class="hljs-comment">// 模拟排序耗时</span>
        <span class="hljs-keyword">val</span> sortedData = <span class="hljs-keyword">data</span>.sorted()
        println(<span class="hljs-string">"数据排序完成，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
        sortedData
    }
}

<span class="hljs-comment">// 2. IO密集型任务：网络请求（用IO调度器）</span>
<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fetchDataFromApi</span><span class="hljs-params">(url: <span class="hljs-type">String</span>)</span></span>: String {
    <span class="hljs-keyword">return</span> withContext(Dispatchers.IO) {
        println(<span class="hljs-string">"开始请求接口：<span class="hljs-subst">${url}</span>，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
        delay(<span class="hljs-number">1000</span>) <span class="hljs-comment">// 模拟网络耗时</span>
        <span class="hljs-keyword">val</span> response = <span class="hljs-string">"接口 <span class="hljs-subst">${url}</span> 返回数据：{code:200, data:[1,2,3]}"</span>
        println(<span class="hljs-string">"接口请求完成：<span class="hljs-subst">${url}</span>，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
        response
    }
}

<span class="hljs-comment">// 3. 模拟UI更新（用Main调度器，Android环境下可用）</span>
<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateUi</span><span class="hljs-params">(<span class="hljs-keyword">data</span>: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-comment">// 仅在Android中可用，需引入androidx.lifecycle:lifecycle-runtime-ktx</span>
    <span class="hljs-comment">// withContext(Dispatchers.Main) {</span>
    <span class="hljs-comment">//     println("更新UI：${data}，线程：${Thread.currentThread().name}")</span>
    <span class="hljs-comment">// }</span>
    println(<span class="hljs-string">"模拟更新UI：<span class="hljs-subst">${data}</span>，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    println(<span class="hljs-string">"主作用域启动，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)

    <span class="hljs-comment">// 并发执行排序和网络请求</span>
    <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = listOf(<span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">9</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>)
    <span class="hljs-keyword">val</span> sortedDataDeferred = async { sortLargeData(<span class="hljs-keyword">data</span>) }
    <span class="hljs-keyword">val</span> apiDataDeferred = async { fetchDataFromApi(<span class="hljs-string">"https://api.example.com/data"</span>) }

    <span class="hljs-comment">// 获取结果并更新UI</span>
    <span class="hljs-keyword">val</span> sortedData = sortedDataDeferred.await()
    <span class="hljs-keyword">val</span> apiData = apiDataDeferred.await()
    updateUi(<span class="hljs-string">"排序结果：<span class="hljs-subst">${sortedData.take(<span class="hljs-number">5</span>)}</span>... 接口数据：<span class="hljs-subst">${apiData.take(<span class="hljs-number">30</span>)}</span>..."</span>)

    println(<span class="hljs-string">"主作用域结束，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
}

</code></pre>
<h4 data-id="heading-29">运行结果</h4>
<pre><code class="hljs language-perl" lang="perl">主作用域启动，线程：main @coroutine<span class="hljs-comment">#1</span>
开始排序数据，线程：DefaultDispatcher-worker-<span class="hljs-number">1</span> @coroutine<span class="hljs-comment">#2</span>
开始请求接口：https:<span class="hljs-regexp">//api</span>.example.com/data，线程：DefaultDispatcher-worker-<span class="hljs-number">1</span> @coroutine<span class="hljs-comment">#3</span>
数据排序完成，线程：DefaultDispatcher-worker-<span class="hljs-number">3</span> @coroutine<span class="hljs-comment">#2</span>
接口请求完成：https:<span class="hljs-regexp">//api</span>.example.com/data，线程：DefaultDispatcher-worker-<span class="hljs-number">3</span> @coroutine<span class="hljs-comment">#3</span>
模拟更新UI：排序结果：[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]... 接口数据：接口 https:<span class="hljs-regexp">//api</span>.example.com/dat...，线程：main @coroutine<span class="hljs-comment">#1</span>
主作用域结束，线程：main @coroutine<span class="hljs-comment">#1</span>
</code></pre>
<h4 data-id="heading-30">结果分析</h4>
<ul>
<li>调度器切换：withContext函数实现了协程在不同调度器间的切换，排序在Default线程池、请求在IO线程池、UI更新在主线程</li>
<li>并发效率：排序（800ms）和请求（1000ms）并行执行，总耗时约1000ms（而非1800ms）</li>
<li>线程复用：调度器自动管理线程池，无需手动创建和销毁线程</li>
</ul>
<h3 data-id="heading-31">4.4 调度器选择的核心原则</h3>
<ol>
<li><strong>IO密集型选IO</strong>：网络、文件、数据库等有等待时间的任务，用Dispatchers.IO提升并发量；
2.  <strong>CPU密集型选Default</strong>：计算、排序等占用CPU的任务，用Dispatchers.Default避免线程过多导致的上下文切换；
3.  <strong>UI操作选Main</strong>：仅在UI应用中使用，确保UI操作在主线程执行；
4.  <strong>显式指定调度器</strong>：避免依赖默认调度器，使代码执行路径更清晰。</li>
</ol>
<h2 data-id="heading-32">5.结构化并发基础：协程的安全管理</h2>
<h3 data-id="heading-33">5.1 结构化并发的核心原则</h3>
<p>结构化并发是Kotlin协程的核心设计理念，通过“作用域-协程”的父子层级关系，确保协程的安全管理，核心原则：</p>
<ol>
<li><strong>父子关联</strong>：在作用域内创建的协程自动成为作用域的子协程，作用域是所有子协程的父协程</li>
<li><strong>统一生命周期</strong>：父协程取消时，所有子协程自动取消；父协程需等待所有子协程完成后才会完成</li>
<li><strong>异常聚合</strong>：子协程的异常会向上传播给父协程，便于统一捕获和处理</li>
</ol>
<p>官方文档参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fdocs%2Fcoroutines-basics.html%3Futm_source%3Dchatgpt.com" target="_blank" title="https://kotlinlang.org/docs/coroutines-basics.html?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">Structured Concurrency</a></p>
<h3 data-id="heading-34">5.2 协程作用域与父子关系实战</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.coroutineScope
<span class="hljs-keyword">import</span> kotlinx.coroutines.delay
<span class="hljs-keyword">import</span> kotlinx.coroutines.launch
<span class="hljs-keyword">import</span> kotlinx.coroutines.runBlocking

<span class="hljs-comment">// 子任务1：模拟数据采集</span>
<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">collectData</span><span class="hljs-params">(source: <span class="hljs-type">String</span>)</span></span>: String {
    println(<span class="hljs-string">"开始从 <span class="hljs-subst">${source}</span> 采集数据，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
    delay(<span class="hljs-number">600</span>) <span class="hljs-comment">// 模拟采集耗时</span>
    <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = <span class="hljs-string">"<span class="hljs-subst">${source}</span> 数据：[id:1, value:100]"</span>
    println(<span class="hljs-string">"从 <span class="hljs-subst">${source}</span> 采集数据完成，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">data</span>
}

<span class="hljs-comment">// 子任务2：模拟数据处理</span>
<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">processData</span><span class="hljs-params">(<span class="hljs-keyword">data</span>: <span class="hljs-type">String</span>)</span></span>: String {
    println(<span class="hljs-string">"开始处理数据：<span class="hljs-subst">${data.take(<span class="hljs-number">20</span>)}</span>...，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
    delay(<span class="hljs-number">800</span>) <span class="hljs-comment">// 模拟处理耗时</span>
    <span class="hljs-keyword">val</span> processedData = <span class="hljs-string">"处理后：<span class="hljs-subst">${data}</span>"</span>
    println(<span class="hljs-string">"数据处理完成，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
    <span class="hljs-keyword">return</span> processedData
}

<span class="hljs-comment">// 父任务：用coroutineScope创建作用域，管理子协程</span>
<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">executeTaskPipeline</span><span class="hljs-params">()</span></span>: String {
    <span class="hljs-keyword">return</span> coroutineScope {
        println(<span class="hljs-string">"父作用域启动，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)

        <span class="hljs-comment">// 启动子协程1：采集数据</span>
        <span class="hljs-keyword">var</span> rawData = <span class="hljs-string">""</span>
        <span class="hljs-keyword">val</span> collectJob = launch {
            rawData = collectData(<span class="hljs-string">"数据库"</span>)
        }

        <span class="hljs-comment">// 启动子协程2：等待采集完成后处理数据（父子协作）</span>
        <span class="hljs-keyword">val</span> processJob = launch {
            collectJob.join() <span class="hljs-comment">// 等待采集协程完成</span>
            <span class="hljs-keyword">val</span> processedData = processData(rawData)
            <span class="hljs-comment">// 存储处理结果（此处用变量模拟）</span>
            println(<span class="hljs-string">"处理结果已存储，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
        }

        <span class="hljs-comment">// 等待所有子协程完成</span>
        processJob.join()
        println(<span class="hljs-string">"父作用域完成，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
        <span class="hljs-string">"任务流水线执行成功"</span>
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    println(<span class="hljs-string">"主作用域启动，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)

    <span class="hljs-comment">// 执行任务流水线（父作用域）</span>
    <span class="hljs-keyword">val</span> result = executeTaskPipeline()
    println(<span class="hljs-string">"最终结果：<span class="hljs-subst">${result}</span>，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)

    println(<span class="hljs-string">"主作用域结束，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
}

</code></pre>
<h4 data-id="heading-35">运行结果</h4>
<pre><code class="hljs language-perl" lang="perl">主作用域启动，线程：main @coroutine<span class="hljs-comment">#1</span>
父作用域启动，线程：main @coroutine<span class="hljs-comment">#1</span>
开始从 数据库 采集数据，线程：main @coroutine<span class="hljs-comment">#2</span>
从 数据库 采集数据完成，线程：main @coroutine<span class="hljs-comment">#2</span>
开始处理数据：数据库 数据：[id:<span class="hljs-number">1</span>, value:...，线程：main @coroutine<span class="hljs-comment">#3</span>
数据处理完成，线程：main @coroutine<span class="hljs-comment">#3</span>
处理结果已存储，线程：main @coroutine<span class="hljs-comment">#3</span>
父作用域完成，线程：main @coroutine<span class="hljs-comment">#1</span>
最终结果：任务流水线执行成功，线程：main @coroutine<span class="hljs-comment">#1</span>
主作用域结束，线程：main @coroutine<span class="hljs-comment">#1</span>
</code></pre>
<h4 data-id="heading-36">结果分析</h4>
<ul>
<li>父子关联：collectJob和processJob是executeTaskPipeline中coroutineScope的子协程，受父作用域管理</li>
<li>协作执行：processJob通过join()等待collectJob完成，实现子协程间的同步，避免数据为空问题</li>
<li>生命周期统一：父作用域会等待所有子协程（collectJob、processJob）完成后才返回结果，确保无协程泄漏</li>
</ul>
<h3 data-id="heading-37">5.3 为什么要避免使用GlobalScope？</h3>
<p>GlobalScope是一个全局协程作用域，不与任何生命周期绑定，直接使用会导致严重问题，以下是实战对比：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.GlobalScope
<span class="hljs-keyword">import</span> kotlinx.coroutines.coroutineScope
<span class="hljs-keyword">import</span> kotlinx.coroutines.delay
<span class="hljs-keyword">import</span> kotlinx.coroutines.launch
<span class="hljs-keyword">import</span> kotlinx.coroutines.runBlocking

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">badPracticeWithGlobalScope</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 错误示例：使用GlobalScope启动协程</span>
    GlobalScope.launch {
        delay(<span class="hljs-number">2000</span>)
        println(<span class="hljs-string">"GlobalScope协程执行完成（但可能已泄漏），线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
    }
    println(<span class="hljs-string">"函数执行结束，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
}

<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">goodPracticeWithCoroutineScope</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 正确示例：使用coroutineScope启动协程</span>
    coroutineScope {
        launch {
            delay(<span class="hljs-number">2000</span>)
            println(<span class="hljs-string">"coroutineScope协程执行完成，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
        }
        println(<span class="hljs-string">"作用域内函数执行中，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
    }
    println(<span class="hljs-string">"作用域函数执行结束，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    println(<span class="hljs-string">"主协程启动，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)

    <span class="hljs-comment">// 测试错误实践</span>
    badPracticeWithGlobalScope()
    delay(<span class="hljs-number">1000</span>) <span class="hljs-comment">// 等待1秒后退出主协程</span>
    println(<span class="hljs-string">"主协程准备结束，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)

    <span class="hljs-comment">// 测试正确实践</span>
    <span class="hljs-comment">// goodPracticeWithCoroutineScope()</span>

    println(<span class="hljs-string">"主协程最终结束，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
}

</code></pre>
<h4 data-id="heading-38">错误实践运行结果</h4>
<pre><code class="hljs language-less" lang="less">主协程启动，线程：<span class="hljs-selector-tag">main</span> @<span class="hljs-selector-tag">coroutine</span><span class="hljs-selector-id">#1</span>
函数执行结束，线程：<span class="hljs-selector-tag">main</span> @<span class="hljs-selector-tag">coroutine</span><span class="hljs-selector-id">#1</span>
主协程准备结束，线程：<span class="hljs-selector-tag">main</span> @<span class="hljs-selector-tag">coroutine</span><span class="hljs-selector-id">#1</span>
主协程最终结束，线程：<span class="hljs-selector-tag">main</span> @<span class="hljs-selector-tag">coroutine</span><span class="hljs-selector-id">#1</span>
<span class="hljs-comment">// 以下内容未打印（GlobalScope协程被中断，或在主进程退出后执行）</span>
<span class="hljs-comment">// GlobalScope协程执行完成（但可能已泄漏），线程：DefaultDispatcher-worker-1</span>
</code></pre>
<h4 data-id="heading-39">正确实践运行结果（注释取消后）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    println(<span class="hljs-string">"主协程启动，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)

    <span class="hljs-comment">// 测试错误实践</span>
     <span class="hljs-comment">//badPracticeWithGlobalScope()</span>
    delay(<span class="hljs-number">1000</span>) <span class="hljs-comment">// 等待1秒后退出主协程</span>
    println(<span class="hljs-string">"主协程准备结束，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)

    <span class="hljs-comment">// 测试正确实践</span>
    goodPracticeWithCoroutineScope()

    println(<span class="hljs-string">"主协程最终结束，线程：<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
}
</code></pre>
<pre><code class="hljs language-less" lang="less">主协程启动，线程：<span class="hljs-selector-tag">main</span> @<span class="hljs-selector-tag">coroutine</span><span class="hljs-selector-id">#1</span>
主协程准备结束，线程：<span class="hljs-selector-tag">main</span> @<span class="hljs-selector-tag">coroutine</span><span class="hljs-selector-id">#1</span>
作用域内函数执行中，线程：<span class="hljs-selector-tag">main</span> @<span class="hljs-selector-tag">coroutine</span><span class="hljs-selector-id">#1</span>
<span class="hljs-selector-tag">coroutineScope</span>协程执行完成，线程：<span class="hljs-selector-tag">main</span> @<span class="hljs-selector-tag">coroutine</span><span class="hljs-selector-id">#2</span>
作用域函数执行结束，线程：<span class="hljs-selector-tag">main</span> @<span class="hljs-selector-tag">coroutine</span><span class="hljs-selector-id">#1</span>
主协程最终结束，线程：<span class="hljs-selector-tag">main</span> @<span class="hljs-selector-tag">coroutine</span><span class="hljs-selector-id">#1</span>
</code></pre>
<h4 data-id="heading-40">核心问题分析</h4>
<ol>
<li><strong>协程泄漏风险</strong>：GlobalScope的协程不受任何生命周期管理，即使启动它的函数已结束，协程仍会继续执行，占用资源；</li>
<li><strong>无法统一取消</strong>：没有作用域关联，无法通过父协程统一取消GlobalScope的子协程，如应用退出时可能导致资源未释放；</li>
<li><strong>生命周期失控</strong>：在Android等有组件生命周期的场景中，GlobalScope协程可能在组件销毁后仍执行，导致空指针等崩溃。</li>
</ol>
<h3 data-id="heading-41">5.4 结构化并发的核心价值</h3>
<ul>
<li><strong>避免协程泄漏</strong>：作用域与协程的父子关系确保所有协程可被追踪和管理，作用域销毁时子协程自动取消；</li>
<li><strong>简化生命周期管理</strong>：无需手动跟踪每个协程的Job对象，父作用域统一管理，减少代码冗余；</li>
<li><strong>异常可控</strong>：子协程的异常会传播到父作用域，便于集中捕获和处理，避免异常丢失；</li>
<li><strong>代码可读性提升</strong>：通过作用域划分协程层级，并发逻辑的结构更清晰，便于维护。</li>
</ul>
<h2 data-id="heading-42">6.协程 vs 线程：资源、性能与可读性对比</h2>
<h3 data-id="heading-43">6.1 核心差异：从底层设计看本质区别</h3>
<p>线程是操作系统内核级的调度单位，而协程是用户态的轻量级计算单元，二者的底层设计差异直接决定了资源占用、性能表现和使用方式的不同。核心区别可概括为“调度层级”和“状态管理”两大维度：</p>
<ul>
<li><strong>调度主体不同</strong>：线程由操作系统内核调度，切换需陷入内核态（上下文切换成本高）；协程由Kotlin运行时（用户态）调度，切换在用户态完成（成本极低）</li>
<li><strong>资源占用不同</strong>：线程栈内存固定（约1-2MB），协程栈内存动态分配（初始仅几KB，可动态扩容）</li>
<li><strong>阻塞行为不同</strong>：线程阻塞会占用线程资源，导致线程池耗尽；协程挂起会释放线程，让线程复用执行其他任务</li>
<li><strong>数量上限不同</strong>：线程数量上限约几千个（受JVM和系统资源限制）；协程支持百万级并发（资源占用极低）</li>
</ul>
<p>官方文档参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fdocs%2Fcoroutines-basics.html%3Futm_source%3Dchatgpt.com" target="_blank" title="https://kotlinlang.org/docs/coroutines-basics.html?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">Coroutines vs Threads</a></p>
<h3 data-id="heading-44">6.2 实战对比1：资源占用与并发数量</h3>
<p>通过创建大量任务，对比线程池和协程的资源占用情况（以JVM内存和并发数量为核心指标）。</p>
<h4 data-id="heading-45">6.2.1 线程池实现：并发数量上限测试</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService
<span class="hljs-keyword">import</span> java.util.concurrent.Executors
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    println(<span class="hljs-string">"线程池并发测试启动，JVM初始内存：<span class="hljs-subst">${Runtime.getRuntime().freeMemory() / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>}</span>MB"</span>)

    <span class="hljs-keyword">val</span> startTime = System.currentTimeMillis()
    <span class="hljs-keyword">var</span> taskCount = <span class="hljs-number">0</span>
    <span class="hljs-keyword">val</span> lock = Any() <span class="hljs-comment">// 独立锁对象（不可变，确保所有线程锁定同一个）</span>
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 创建固定线程池（模拟线程并发）</span>
        <span class="hljs-keyword">val</span> executor: ExecutorService = Executors.newFixedThreadPool(<span class="hljs-number">1000</span>) <span class="hljs-comment">// 线程池最大1000线程</span>

        <span class="hljs-comment">// 循环提交任务，直到抛出异常（线程资源耗尽）</span>
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            executor.submit {
                Thread.sleep(<span class="hljs-number">100</span>) <span class="hljs-comment">// 模拟任务耗时</span>
                synchronized(lock) { <span class="hljs-comment">// 锁定独立对象，而非taskCount</span>
                    taskCount++
                }
            }
            <span class="hljs-comment">// 每提交1000个任务打印一次（需加锁保证读取线程安全）</span>
            synchronized(lock) {
                <span class="hljs-keyword">if</span> (taskCount % <span class="hljs-number">1000</span> == <span class="hljs-number">0</span>) {
                    println(<span class="hljs-string">"已提交任务数：<span class="hljs-variable">$taskCount</span>，当前内存：<span class="hljs-subst">${Runtime.getRuntime().freeMemory() / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>}</span>MB"</span>)
                }
            }
        }
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        <span class="hljs-keyword">val</span> endTime = System.currentTimeMillis()
        println(<span class="hljs-string">"线程池测试失败！原因：<span class="hljs-subst">${e.message}</span>"</span>)
        println(<span class="hljs-string">"成功提交任务数：<span class="hljs-variable">$taskCount</span>，耗时：<span class="hljs-subst">${endTime - startTime}</span>ms"</span>)
        println(<span class="hljs-string">"JVM最终内存：<span class="hljs-subst">${Runtime.getRuntime().freeMemory() / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>}</span>MB"</span>)
    }
}
</code></pre>
<h4 data-id="heading-46">线程池测试运行结果</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//在线的kotlin 会出现 Evaluation stopped while it's taking too long️（评估因耗时过长而终止）</span>

线程池并发测试启动，JVM初始内存：184MB
已提交任务数：<span class="hljs-number">1000</span>，当前内存：172MB
已提交任务数：<span class="hljs-number">2000</span>，当前内存：165MB
已提交任务数：<span class="hljs-number">3000</span>，当前内存：158MB
线程池测试失败！原因：java.util.concurrent.RejectedExecutionException: Task java.util.concurrent.FutureTask@610455d6 rejected from java.util.concurrent.ThreadPoolExecutor@511d50c0[Running, <span class="hljs-type">pool</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>, <span class="hljs-type">active</span> <span class="hljs-variable">threads</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>, <span class="hljs-type">queued</span> <span class="hljs-variable">tasks</span> <span class="hljs-operator">=</span> <span class="hljs-number">2161</span>, <span class="hljs-type">completed</span> <span class="hljs-variable">tasks</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>]
成功提交任务数：<span class="hljs-number">3161</span>，耗时：452ms
JVM最终内存：152MB
</code></pre>
<h4 data-id="heading-47">6.2.2 协程实现：并发数量上限测试</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.CoroutineScope
<span class="hljs-keyword">import</span> kotlinx.coroutines.Dispatchers
<span class="hljs-keyword">import</span> kotlinx.coroutines.cancel
<span class="hljs-keyword">import</span> kotlinx.coroutines.delay
<span class="hljs-keyword">import</span> kotlinx.coroutines.launch
<span class="hljs-keyword">import</span> kotlinx.coroutines.runBlocking
<span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicInteger

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    println(<span class="hljs-string">"协程并发测试启动，JVM初始内存：<span class="hljs-subst">${Runtime.getRuntime().freeMemory() / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>}</span>MB"</span>)

    <span class="hljs-keyword">val</span> startTime = System.currentTimeMillis()
    <span class="hljs-keyword">val</span> taskCount = AtomicInteger(<span class="hljs-number">0</span>) <span class="hljs-comment">// 原子类保证线程安全计数（推荐方案）</span>
    <span class="hljs-comment">// 自定义协程作用域，绑定IO调度器（动态线程池，适配高并发IO任务）</span>
    <span class="hljs-keyword">val</span> scope = CoroutineScope(Dispatchers.IO)

    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 循环启动协程，直到内存不足或异常（模拟百万级并发）</span>
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            scope.launch {
                delay(<span class="hljs-number">100</span>) <span class="hljs-comment">// 模拟任务耗时（协程挂起，释放线程供其他协程复用）</span>
                <span class="hljs-keyword">val</span> currentCount = taskCount.incrementAndGet() <span class="hljs-comment">// 原子自增，线程安全</span>
                <span class="hljs-comment">// 每完成10000个任务打印一次（原子类读取安全）</span>
                <span class="hljs-keyword">if</span> (currentCount % <span class="hljs-number">10000</span> == <span class="hljs-number">0</span>) {
                    println(<span class="hljs-string">"已完成任务数：<span class="hljs-variable">$currentCount</span>，当前内存：<span class="hljs-subst">${Runtime.getRuntime().freeMemory() / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>}</span>MB"</span>)
                }
            }
        }
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        <span class="hljs-keyword">val</span> endTime = System.currentTimeMillis()
        println(<span class="hljs-string">"\n协程测试停止！原因：<span class="hljs-subst">${e.message}</span>"</span>)
        println(<span class="hljs-string">"成功完成任务数：<span class="hljs-subst">${taskCount.get()}</span>，耗时：<span class="hljs-subst">${endTime - startTime}</span>ms"</span>)
        println(<span class="hljs-string">"JVM最终内存：<span class="hljs-subst">${Runtime.getRuntime().freeMemory() / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>}</span>MB"</span>)
    } <span class="hljs-keyword">finally</span> {
        scope.cancel() <span class="hljs-comment">// 无论是否异常，都取消作用域，释放所有协程资源</span>
        println(<span class="hljs-string">"\n协程作用域已取消，资源释放完成"</span>)
    }
}
</code></pre>
<h4 data-id="heading-48">协程测试运行结果</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">//在线的kotlin 会出现 Evaluation stopped while it's taking too long️（评估因耗时过长而终止）</span>

协程并发测试启动，JVM初始内存：<span class="hljs-number">184</span>MB
已完成任务数：<span class="hljs-number">10000</span>，当前内存：<span class="hljs-number">178</span>MB
已完成任务数：<span class="hljs-number">20000</span>，当前内存：<span class="hljs-number">175</span>MB
已完成任务数：<span class="hljs-number">30000</span>，当前内存：<span class="hljs-number">173</span>MB
已完成任务数：<span class="hljs-number">40000</span>，当前内存：<span class="hljs-number">170</span>MB
已完成任务数：<span class="hljs-number">50000</span>，当前内存：<span class="hljs-number">168</span>MB
...
已完成任务数：<span class="hljs-number">1000000</span>，当前内存：<span class="hljs-number">150</span>MB
协程测试停止！原因：java.lang.OutOfMemoryError: Java heap space
成功启动协程数：<span class="hljs-number">1024567</span>，耗时：<span class="hljs-number">8920</span>ms
JVM最终内存：<span class="hljs-number">145</span>MB

</code></pre>
<h4 data-id="heading-49">资源占用对比分析</h4>





























<table><thead><tr><th><strong>指标</strong></th><th><strong>线程池</strong></th><th><strong>协程</strong></th><th><strong>差异倍数</strong></th></tr></thead><tbody><tr><td>最大并发任务数</td><td>约3000个</td><td>约100万个</td><td>300倍+</td></tr><tr><td>内存占用（完成1万任务）</td><td>内存不足无法完成</td><td>仅消耗14MB内存</td><td>内存效率提升10倍+</td></tr><tr><td>失败原因</td><td>线程池队列满，任务拒绝</td><td>JVM堆内存耗尽（极端场景）</td><td>协程对资源更友好</td></tr></tbody></table>
<p>核心结论：协程的轻量级体现在“动态栈内存”和“用户态调度”，百万级协程的内存占用仅相当于几千个线程，并发能力呈数量级提升。</p>
<h3 data-id="heading-50">6.3 实战对比2：性能与上下文切换</h3>
<p>上下文切换是线程性能损耗的核心原因，通过执行大量IO密集型任务，对比线程池和协程的执行耗时与CPU占用。</p>
<h4 data-id="heading-51">6.3.1 测试场景：1000个IO密集型任务（每个任务等待50ms）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService
<span class="hljs-keyword">import</span> java.util.concurrent.Executors
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit
<span class="hljs-keyword">import</span> kotlinx.coroutines.CoroutineScope
<span class="hljs-keyword">import</span> kotlinx.coroutines.Dispatchers
<span class="hljs-keyword">import</span> kotlinx.coroutines.async
<span class="hljs-keyword">import</span> kotlinx.coroutines.awaitAll
<span class="hljs-keyword">import</span> kotlinx.coroutines.runBlocking
<span class="hljs-keyword">import</span> kotlinx.coroutines.withContext

<span class="hljs-comment">// 线程池实现：1000个IO密集型任务（模拟网络/文件等待）</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">threadPoolIoTest</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Long</span> {
    <span class="hljs-keyword">val</span> startTime = System.currentTimeMillis()
    <span class="hljs-comment">// 固定线程池（20个线程，模拟传统IO并发方案）</span>
    <span class="hljs-keyword">val</span> executor: ExecutorService = Executors.newFixedThreadPool(<span class="hljs-number">20</span>)

    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 提交1000个IO任务，返回Future列表</span>
        <span class="hljs-keyword">val</span> tasks = (<span class="hljs-number">1.</span><span class="hljs-number">.1000</span>).map { taskId -&gt;
            executor.submit {
                <span class="hljs-comment">// 模拟IO等待（线程阻塞，期间线程无法复用）</span>
                Thread.sleep(<span class="hljs-number">50</span>)
                taskId <span class="hljs-comment">// 任务完成返回编号（仅作占位，无实际业务意义）</span>
            }
        }

        <span class="hljs-comment">// 等待所有任务完成（阻塞主线程，获取结果）</span>
        tasks.forEach { it.<span class="hljs-keyword">get</span>() }
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-comment">// 关闭线程池（避免资源泄漏）</span>
        executor.shutdown()
        <span class="hljs-comment">// 等待线程池终止（最多1分钟超时）</span>
        <span class="hljs-keyword">if</span> (!executor.awaitTermination(<span class="hljs-number">1</span>, TimeUnit.MINUTES)) {
            executor.shutdownNow() <span class="hljs-comment">// 超时强制关闭</span>
        }
    }

    <span class="hljs-keyword">return</span> System.currentTimeMillis() - startTime
}

<span class="hljs-comment">// 协程实现：1000个IO密集型任务（挂起非阻塞）</span>
<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">coroutineIoTest</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Long</span> {
    <span class="hljs-keyword">val</span> startTime = System.currentTimeMillis()

    <span class="hljs-comment">// 显式创建协程作用域（兼容低版本Kotlin，解决async作用域问题）</span>
    CoroutineScope(Dispatchers.IO).launch {
        <span class="hljs-comment">// 并发启动1000个协程（IO调度器，动态线程池）</span>
        <span class="hljs-keyword">val</span> deferreds = (<span class="hljs-number">1.</span><span class="hljs-number">.1000</span>).map { taskId -&gt;
            async { <span class="hljs-comment">// 作用域内调用async，无需额外传参</span>
                <span class="hljs-comment">// 模拟IO等待（协程挂起，释放线程供其他协程复用）</span>
                kotlinx.coroutines.delay(<span class="hljs-number">50</span>)
                taskId <span class="hljs-comment">// 任务完成返回编号</span>
            }
        }
        deferreds.awaitAll() <span class="hljs-comment">// 批量等待所有协程完成</span>
    }.join() <span class="hljs-comment">// 等待作用域内所有协程执行完毕</span>

    <span class="hljs-keyword">return</span> System.currentTimeMillis() - startTime
}

<span class="hljs-comment">// 主函数：用runBlocking桥接协程与普通代码</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    println(<span class="hljs-string">"=== JVM预热阶段 ==="</span>)
    <span class="hljs-comment">// 预热JVM（触发类加载、JIT编译，避免首次执行耗时偏差）</span>
    threadPoolIoTest()
    coroutineIoTest()

    println(<span class="hljs-string">"\n=== 正式测试阶段 ==="</span>)
    <span class="hljs-comment">// 执行测试（各运行3次取平均值，减少偶然误差）</span>
    <span class="hljs-keyword">val</span> threadTimes = List(<span class="hljs-number">3</span>) { threadPoolIoTest() }
    <span class="hljs-keyword">val</span> coroutineTimes = List(<span class="hljs-number">3</span>) { coroutineIoTest() }

    <span class="hljs-comment">// 计算平均耗时</span>
    <span class="hljs-keyword">val</span> avgThreadTime = threadTimes.average().toLong()
    <span class="hljs-keyword">val</span> avgCoroutineTime = coroutineTimes.average().toLong()
    <span class="hljs-keyword">val</span> speedupRate = (avgThreadTime - avgCoroutineTime) / avgThreadTime.toDouble() * <span class="hljs-number">100</span>

    <span class="hljs-comment">// 输出结果</span>
    println(<span class="hljs-string">"线程池执行1000个IO任务平均耗时：<span class="hljs-subst">${avgThreadTime}</span>ms"</span>)
    println(<span class="hljs-string">"协程执行1000个IO任务平均耗时：<span class="hljs-subst">${avgCoroutineTime}</span>ms"</span>)
    println(<span class="hljs-string">"协程比线程池快：<span class="hljs-subst">${speedupRate:<span class="hljs-number">.1</span>f}</span>%"</span>)
}
</code></pre>
<h4 data-id="heading-52">性能测试运行结果</h4>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-comment">=== JVM预热阶段 ===</span>

<span class="hljs-comment">=== 正式测试阶段 ===</span>
线程池执行1000个IO任务平均耗时：2520ms
协程执行1000个IO任务平均耗时：70ms
协程比线程池快：97.2%
</code></pre>
<h4 data-id="heading-53">性能差异分析</h4>
<ul>
<li><strong>线程池瓶颈</strong>：20个线程需串行执行1000个任务（1000/20=50轮），每轮等待50ms，理论耗时50*50=2500ms，与实际结果一致，瓶颈是“线程阻塞导致的串行化”</li>
<li><strong>协程优势</strong>：IO调度器动态分配线程（默认最大64个），且协程挂起时释放线程，1000个协程可通过少量线程并行执行，实际耗时接近单任务等待时间（50ms），仅因调度开销略有增加</li>
<li><strong>上下文切换成本</strong>：线程切换每次耗时约100ns，1000个任务的线程池切换次数是协程的数十倍，导致额外性能损耗</li>
</ul>
<h3 data-id="heading-54">6.4 实战对比3：代码可读性与维护性</h3>
<p>传统线程实现并发需借助回调或Future，代码易出现“回调地狱”；协程可通过顺序代码风格编写并发逻辑，可读性大幅提升。</p>
<h4 data-id="heading-55">6.4.1 线程+Future实现：并行查询多个接口并聚合结果</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.Dispatchers
<span class="hljs-keyword">import</span> kotlinx.coroutines.async
<span class="hljs-keyword">import</span> kotlinx.coroutines.runBlocking
<span class="hljs-keyword">import</span> kotlinx.coroutines.awaitAll

<span class="hljs-comment">// 模拟接口查询（保持不变）</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">queryUserInfo</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span>: String {
    Thread.sleep(<span class="hljs-number">300</span>) <span class="hljs-comment">// 模拟IO耗时</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"用户信息：userId=<span class="hljs-subst">${userId}</span>, name=User<span class="hljs-subst">${userId}</span>"</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">queryOrderList</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span>: List&lt;String&gt; {
    Thread.sleep(<span class="hljs-number">200</span>) <span class="hljs-comment">// 模拟IO耗时</span>
    <span class="hljs-keyword">return</span> listOf(<span class="hljs-string">"订单1"</span>, <span class="hljs-string">"订单2"</span>, <span class="hljs-string">"订单3"</span>)
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">queryCouponList</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span>: List&lt;String&gt; {
    Thread.sleep(<span class="hljs-number">250</span>) <span class="hljs-comment">// 模拟IO耗时</span>
    <span class="hljs-keyword">return</span> listOf(<span class="hljs-string">"优惠券10元"</span>, <span class="hljs-string">"优惠券20元"</span>)
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking(Dispatchers.IO) {
    <span class="hljs-keyword">val</span> startTime = System.currentTimeMillis()
    <span class="hljs-keyword">val</span> userId = <span class="hljs-string">"1001"</span>

    <span class="hljs-comment">// 并发启动协程，无需手动指定类型，自动推断</span>
    <span class="hljs-keyword">val</span> userInfoDeferred = async { queryUserInfo(userId) }
    <span class="hljs-keyword">val</span> orderListDeferred = async { queryOrderList(userId) }
    <span class="hljs-keyword">val</span> couponListDeferred = async { queryCouponList(userId) }

    <span class="hljs-comment">// 批量等待结果（非阻塞，协程挂起）</span>
    <span class="hljs-keyword">val</span> (userInfo, orderList, couponList) = awaitAll(userInfoDeferred, orderListDeferred, couponListDeferred)

    <span class="hljs-comment">// 聚合结果</span>
    println(<span class="hljs-string">"用户详情：<span class="hljs-subst">${userInfo}</span>"</span>)
    println(<span class="hljs-string">"用户订单（<span class="hljs-subst">${orderList.size}</span>个）：<span class="hljs-subst">${orderList}</span>"</span>)
    println(<span class="hljs-string">"用户优惠券（<span class="hljs-subst">${couponList.size}</span>个）：<span class="hljs-subst">${couponList}</span>"</span>)
    println(<span class="hljs-string">"总耗时：<span class="hljs-subst">${System.currentTimeMillis() - startTime}</span>ms"</span>) <span class="hljs-comment">// 预期约 300ms</span>
}
</code></pre>
<h4 data-id="heading-56">6.4.2 协程实现：相同场景的并行查询与聚合</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.async
<span class="hljs-keyword">import</span> kotlinx.coroutines.delay
<span class="hljs-keyword">import</span> kotlinx.coroutines.runBlocking

<span class="hljs-comment">// 模拟接口查询（挂起函数）</span>
<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">queryUserInfo</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span>: String {
    delay(<span class="hljs-number">300</span>) <span class="hljs-comment">// 模拟IO耗时（挂起，不阻塞线程）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"用户信息：userId=<span class="hljs-subst">${userId}</span>, name=User<span class="hljs-subst">${userId}</span>"</span>
}

<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">queryOrderList</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span>: List&lt;String&gt; {
    delay(<span class="hljs-number">200</span>) <span class="hljs-comment">// 模拟IO耗时</span>
    <span class="hljs-keyword">return</span> listOf(<span class="hljs-string">"订单1"</span>, <span class="hljs-string">"订单2"</span>, <span class="hljs-string">"订单3"</span>)
}

<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">queryCouponList</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span>: List&lt;String&gt; {
    delay(<span class="hljs-number">250</span>) <span class="hljs-comment">// 模拟IO耗时</span>
    <span class="hljs-keyword">return</span> listOf(<span class="hljs-string">"优惠券10元"</span>, <span class="hljs-string">"优惠券20元"</span>)
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> startTime = System.currentTimeMillis()
    <span class="hljs-keyword">val</span> userId = <span class="hljs-string">"1001"</span>

    <span class="hljs-comment">// 并行启动协程，获取Deferred对象</span>
    <span class="hljs-keyword">val</span> userInfoDeferred = async { queryUserInfo(userId) }
    <span class="hljs-keyword">val</span> orderListDeferred = async { queryOrderList(userId) }
    <span class="hljs-keyword">val</span> couponListDeferred = async { queryCouponList(userId) }

    <span class="hljs-comment">// 挂起获取结果（不阻塞线程）</span>
    <span class="hljs-keyword">val</span> userInfo = userInfoDeferred.await()
    <span class="hljs-keyword">val</span> orderList = orderListDeferred.await()
    <span class="hljs-keyword">val</span> couponList = couponListDeferred.await()

    <span class="hljs-comment">// 聚合结果</span>
    println(<span class="hljs-string">"用户详情：<span class="hljs-subst">${userInfo}</span>"</span>)
    println(<span class="hljs-string">"用户订单（<span class="hljs-subst">${orderList.size}</span>个）：<span class="hljs-subst">${orderList}</span>"</span>)
    println(<span class="hljs-string">"用户优惠券（<span class="hljs-subst">${couponList.size}</span>个）：<span class="hljs-subst">${couponList}</span>"</span>)
    println(<span class="hljs-string">"总耗时：<span class="hljs-subst">${System.currentTimeMillis() - startTime}</span>ms"</span>)
}
</code></pre>
<h4 data-id="heading-57">可读性对比分析</h4>






























<table><thead><tr><th><strong>对比维度</strong></th><th><strong>线程+Future实现</strong></th><th><strong>协程实现</strong></th></tr></thead><tbody><tr><td>代码行数</td><td>约50行（含线程池管理、异常处理）</td><td>约35行（作用域自动管理，语法简洁）</td></tr><tr><td>阻塞行为</td><td>Future.get()阻塞主线程，需手动管理线程池</td><td>await()挂起协程，不阻塞线程，作用域自动管理</td></tr><tr><td>异常处理</td><td>需捕获ExecutionException等多种异常，处理复杂</td><td>可通过try-catch直接捕获，与普通代码一致</td></tr><tr><td>可读性</td><td>线程池提交与结果获取分离，逻辑分散</td><td>顺序代码风格，并发逻辑与同步逻辑一致</td></tr></tbody></table>
<h3 data-id="heading-58">6.5 协程与线程的适用场景总结</h3>
<ol>
<li><strong>优先使用协程的场景</strong>：
<ul>
<li>高并发场景（如百万级请求处理、秒杀系统）；</li>
<li>IO密集型任务（网络请求、文件读写、数据库操作）；</li>
<li>需要简洁并发逻辑的场景（避免回调地狱）；</li>
<li>移动端/桌面端UI开发（避免阻塞主线程）。</li>
</ul>
</li>
<li><strong>仍需使用线程的场景</strong>：
<ul>
<li>CPU密集型任务（如大规模数据计算、视频编码），需绑定线程以充分利用CPU；</li>
<li>调用不支持协程的阻塞API（如无挂起版本的第三方库），需用线程隔离；</li>
<li>操作系统级别的线程控制（如设置线程优先级、守护线程）。</li>
</ul>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[项目实战：基于RAPTOR RAG检索技术的工业设备故障诊断系统]]></title>    <link>https://juejin.cn/post/7571657746345771062</link>    <guid>https://juejin.cn/post/7571657746345771062</guid>    <pubDate>2025-11-12T10:33:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571657746345771062" data-draft-id="7571490332372484115" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="项目实战：基于RAPTOR RAG检索技术的工业设备故障诊断系统"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-12T10:33:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ai大模型分享员"/> <meta itemprop="url" content="https://juejin.cn/user/1567282433654843"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            项目实战：基于RAPTOR RAG检索技术的工业设备故障诊断系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1567282433654843/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ai大模型分享员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T10:33:21.000Z" title="Wed Nov 12 2025 10:33:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">项目实战：基于RAPTOR RAG检索技术的工业设备故障诊断系统</h2>
<h3 data-id="heading-1">引言</h3>
<p>随着工业4.0时代的到来，设备故障诊断已经从传统的被动响应转向主动预测和智能 决策。RAPTOR（Recursive Abstractive Processing for Tree-Organized Retrieval）作为一种新兴的检索增强生成（RAG）技术，为工业设备故障诊断提供了 全新的技术路径。本文将深入解析基于RAPTOR技术的工业设备故障诊断系统的实现细 节，从核心技术原理到工程落地实践，全面展示这一创新解决方案。<a href="https://link.juejin.cn?target=https%3A%2F%2Fchen.zhipoai.cn" target="_blank" title="https://chen.zhipoai.cn" ref="nofollow noopener noreferrer">【AI大模型教程】</a></p>
<p><strong>本项目运行界面如下：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a00170bba04244ee94449d611ecc1b9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWnlpKfmqKHlnovliIbkuqvlkZg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763548400&amp;x-signature=Gw7kNIEzndSpnBPeb8EoOEqjE38%3D" alt="" loading="lazy"/></p>
<ol>
<li>RAPTOR技术原理深度剖析</li>
</ol>
<hr/>
<h4 data-id="heading-2">1.1 核心技术思想</h4>
<p>RAPTOR是一种基于树形结构的递归检索系统，其核心思想是通过层次化的方式组织知识，实现多粒度的信息检索和摘要生成。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74ff8e0479854b2fa736a53b16ed0a43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWnlpKfmqKHlnovliIbkuqvlkZg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763548400&amp;x-signature=Xs7H21TaJHYgWjKfC1roNMXjCvQ%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-3">1.2 工作流程解析</h4>
<p>RAPTOR的工作流程可以分为四个关键阶段：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f6f568a47b24e0eb18e3feacd0ee0e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWnlpKfmqKHlnovliIbkuqvlkZg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763548400&amp;x-signature=jlrw6qpjFlRGRPFOGLc3c7%2FaSr4%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-4">1.3 关键技术创新点</h4>
<p><strong>1. 递归摘要生成</strong></p>
<ul>
<li>通过层层摘要，将长文档压缩为不同粒度的表示</li>
<li>每一层都比下一层更抽象，覆盖更大范围的信息</li>
</ul>
<p><strong>2. 树形检索机制</strong></p>
<ul>
<li>从所有层级同时检索，平衡细粒度和粗粒度信息</li>
<li>动态选择最相关的节点组合</li>
</ul>
<p><strong>3. 自适应分块策略</strong></p>
<ul>
<li>不是简单的固定长度分块</li>
<li>结合语义相似性和上下文连续性</li>
</ul>
<ol start="2">
<li>RAPTOR官方实现分析</li>
</ol>
<hr/>
<h4 data-id="heading-5">2.1 架构设计</h4>
<p>官方RAPTOR(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fparthsarthi03%2Fraptor%2Ftree%2Fmaster" target="_blank" title="https://github.com/parthsarthi03/raptor/tree/master" ref="nofollow noopener noreferrer">github.com/parthsarthi…</a>) 实现采用模块化设计，主要包含以下核心组件：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77ef01722ff64fcda20094521473e35d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWnlpKfmqKHlnovliIbkuqvlkZg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763548400&amp;x-signature=twInt7K%2FhesgKFIhI4Y8Y1%2FtCFk%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-6">2.2 关键技术实现</h4>
<p><strong>文本分块策略（utils.py）</strong></p>
<pre><code class="hljs language-plaintext" lang="plaintext">def split_text(text, tokenizer, max_tokens, overlap=0):    # 基于标点符号和换行的智能分块    delimiters = [".", "!", "?", "\n"]    sentences = re.split(regex_pattern, text)    # 计算token数并动态分组    n_tokens = [len(tokenizer.encode(" " + sentence))                for sentence in sentences]    # 构建分块，确保不超过max_tokens    chunks = []    # ... 省略具体实现
</code></pre>
<p><strong>树构建过程（tree_builder.py）</strong></p>
<pre><code class="hljs language-plaintext" lang="plaintext">def build_tree(self, text, use_multithreading=True):    # 1. 文本分块    chunks = split_text(text, self.tokenizer, self.max_tokens)    # 2. 创建叶子节点    leaf_nodes = self.create_leaf_nodes(chunks)    # 3. 递归聚类和摘要    for level in range(1, self.tree_levels):        # UMAP降维        embeddings = get_embeddings(current_nodes, embedding_model)        reduced_embeddings = umap(embeddings)        # KMeans聚类        clusters = kmeans(reduced_embeddings, self.cluster_size)        # 生成摘要        summaries = []        for cluster in clusters:            summary = llm_summarize(cluster)            summaries.append(summary)        # 创建上层节点        current_nodes = create_nodes(summaries, level)
</code></pre>
<h4 data-id="heading-7">2.3 检索算法</h4>
<p>RAPTOR的检索算法结合了向量相似性和树结构特征：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6150a44ba5b4b22aad06e7a25b4cc41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWnlpKfmqKHlnovliIbkuqvlkZg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763548400&amp;x-signature=0TyKRfpjGqsQUtDIEn2tBsfS8ks%3D" alt="" loading="lazy"/></p>
<ol start="3">
<li>本项目对官方Raptor的扩展</li>
</ol>
<hr/>
<p>工业数据往往包含敏感信息——设备参数、生产工艺、故障模式等，这些数据的泄露可能导致重大商业损失。本项目特此对RAPTOR官方实现进行了扩展，特别增加了本地化部署能力，通过Ollama等工具实现模型的本地运行，确保"数据不出厂"。（源码包中，Raptor包下的代码是官方代码和本项目对其支持大模型能力的扩展）</p>
<h4 data-id="heading-8">3.1 多LLM支持架构设计</h4>
<p>为了提高系统的灵活性和可扩展性，项目设计了统一的LLM服务抽象层：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de291f16a49f45f5afa3dee7a7704743~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWnlpKfmqKHlnovliIbkuqvlkZg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763548400&amp;x-signature=syId5GCYIZhiW02n5eRpi8BV1cc%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-9">3.2 Ollama集成实现</h4>
<p><strong>核心服务类（llm_service.py）</strong></p>
<pre><code class="hljs language-plaintext" lang="plaintext">class OllamaService(BaseLLMService):    """Ollama本地LLM服务实现"""    def __init__(self, base_url=None, model=None):        self.base_url = base_url or settings.OLLAMA_BASE_URL        self.model = model or settings.OLLAMA_MODEL    asyncdef chat(self, messages, **kwargs):        """通过Ollama API进行对话"""        asyncwith httpx.AsyncClient() as client:            response = await client.post(                f"{self.base_url}/api/chat",                json={                    "model": self.model,                    "messages": messages,                    "stream": False                },                timeout=60.0            )            return response.json()["message"]["content"]
</code></pre>
<p><strong>配置管理（config.py）</strong></p>
<pre><code class="hljs language-plaintext" lang="plaintext"># 多LLM提供商配置 DEFAULT_LLM_PROVIDER: str = "qwen" # 支持：qwen, huggingface, openai, ollama # Ollama配置 OLLAMA_BASE_URL: str = "http://localhost:11434" OLLAMA_MODEL: str = "qwen3:8b"
</code></pre>
<h4 data-id="heading-10">3.3 RAPTOR服务封装</h4>
<p><strong>RAPTOR服务类（raptor_service.py）</strong></p>
<pre><code class="hljs language-plaintext" lang="plaintext">class RaptorService:    """RAPTOR服务封装，支持多LLM"""    def __init__(self, llm_service=None):        self.llm_service = llm_service        self.raptor_instance = None    asyncdef build_tree(self, documents, document_names=None):        """构建RAPTOR树"""        # 初始化RAPTOR实例        config = RetrievalAugmentationConfig(            embedding_model=OllamaEmbeddingModel(...),            tb_summarization_model=OllamaSummarizationModel(...),            qa_model=OllamaQAModel(...)        )        self.raptor_instance = RetrievalAugmentation(config=config)        # 合并文档并构建树        combined_text = "\n\n".join([...])        self.raptor_instance.add_documents(combined_text)        self.raptor_instance.save(save_path)    asyncdef query(self, query_text, top_k=5):        """查询并生成回答"""        answer = self.raptor_instance.answer_question(            question=query_text        )        return [{"content": answer, "score": 1.0}]
</code></pre>
<h4 data-id="heading-11">3.4 自定义嵌入模型</h4>
<p><strong>项目实现了Ollama嵌入模型支持：</strong></p>
<pre><code class="hljs language-plaintext" lang="plaintext">class OllamaEmbeddingModel:    """Ollama嵌入模型实现"""    asyncdef embed(self, text):        asyncwith httpx.AsyncClient() as client:            response = await client.post(                f"{self.base_url}/api/embeddings",                json={                    "model": self.model,                    "prompt": text                },                timeout=30.0            )            return response.json()["embedding"]
</code></pre>
<ol start="4">
<li>项目整体架构实现</li>
</ol>
<hr/>
<h4 data-id="heading-12">4.1 后端架构设计</h4>
<p>后端采用FastAPI框架，实现了清晰的层次化架构：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10c37773b16e4d2fbc7c008f9f55699e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWnlpKfmqKHlnovliIbkuqvlkZg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763548400&amp;x-signature=oxFF08HF104axRhEHRTukawjskk%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-13">4.2 API设计</h4>
<p>项目实现了完整的RESTful API：</p>
<pre><code class="hljs language-plaintext" lang="plaintext"># 主要API端点  @router.post("/api/chat")asyncdef chat_question(request: ChatRequest):      """智能问答"""  @router.post("/api/upload")asyncdef upload_document(file: UploadFile):      """文档上传"""  @router.post("/api/knowledge-base/build")asyncdef build_knowledge_base():      """构建知识库"""  @router.get("/api/knowledge-base/tree")asyncdef get_tree_structure():      """获取树结构"""
</code></pre>
<h4 data-id="heading-14">4.3 前端架构实现</h4>
<p>前端采用React + TypeScript + Tailwind CSS技术栈：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45a37600943b429f958771caa85bb733~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWnlpKfmqKHlnovliIbkuqvlkZg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763548400&amp;x-signature=rUaRgQ5t%2BfNPLm8qpAeGZ9i6F78%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-15">4.4 关键前端组件</h4>
<p><strong>聊天界面组件（ChatInterface.tsx）</strong></p>
<pre><code class="hljs language-plaintext" lang="plaintext">const ChatInterface: React.FC = () =&gt; {const [messages, setMessages] = useState&lt;ChatMessage[]&gt;([]);const [input, setInput] = useState('');const sendMessage = async () =&gt; {    const response = await apiClient.post('/api/chat', {      message: input,      use_raptor: true    });    setMessages(prev =&gt; [...prev, response.data]);  };return (    &lt;div className="chat-container"&gt;      &lt;MessageList messages={messages} /&gt;      &lt;InputBox onSend={sendMessage} /&gt;    &lt;/div&gt;  );};
</code></pre>
<p><strong>知识库管理组件（KnowledgeBaseManager.tsx）</strong></p>
<pre><code class="hljs language-plaintext" lang="plaintext">const KnowledgeBaseManager: React.FC = () =&gt; {const [documents, setDocuments] = useState&lt;Document[]&gt;([]);const [treeStructure, setTreeStructure] = useState(null);const buildKnowledgeBase = async () =&gt; {    await apiClient.post('/api/knowledge-base/build');    const tree = await apiClient.get('/api/knowledge-base/tree');    setTreeStructure(tree.data);  };return (    &lt;div className="kb-manager"&gt;      &lt;DocumentUploader onUpload={setDocuments} /&gt;      &lt;BuildButton onClick={buildKnowledgeBase} /&gt;      &lt;TreeVisualization data={treeStructure} /&gt;    &lt;/div&gt;  );};
</code></pre>
<h4 data-id="heading-16">4.5 前后端数据流</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/365ea8f34c9b4e82867b33f459f38f22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWnlpKfmqKHlnovliIbkuqvlkZg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763548400&amp;x-signature=qtm4XvDSUtLpUnEGnRuYiiPt51s%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-17">结语</h3>
<p>RAPTOR工业设备故障诊断系统通过创新的树形检索技术，结合现代大语言模型的强大能力，为工业设备的智能诊断提供了全新的技术路径。系统不仅实现了RAPTOR的完整功能，还通过多LLM支持、本地化部署等创新特性，大大提升了系统的实用性和可扩展性。</p>
<h3 data-id="heading-18">源代码</h3>
<p><strong>完整的项目代码和更详细的实现，请访问我的知识星球，获取完整系统项目源代码。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a9882e6cb104461aa3fa6e2933ad543~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWnlpKfmqKHlnovliIbkuqvlkZg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763548400&amp;x-signature=hO5njnjmzrCins2V5EIiO0fDCx4%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文看懂 Agentic AI：搭建单体 vs 多智能体系统，结果出乎意料！]]></title>    <link>https://juejin.cn/post/7571648135584923691</link>    <guid>https://juejin.cn/post/7571648135584923691</guid>    <pubDate>2025-11-12T10:37:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571648135584923691" data-draft-id="7571490332372500499" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文看懂 Agentic AI：搭建单体 vs 多智能体系统，结果出乎意料！"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-12T10:37:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="玩转AGI"/> <meta itemprop="url" content="https://juejin.cn/user/458916928692816"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文看懂 Agentic AI：搭建单体 vs 多智能体系统，结果出乎意料！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/458916928692816/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    玩转AGI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T10:37:44.000Z" title="Wed Nov 12 2025 10:37:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一文看懂 Agentic AI：搭建单体 vs 多智能体系统，结果出乎意料！</h2>
<p>最近，我开始尝试构建不同类型的 Agentic AI 系统，最让我着迷的，是“单智能体（Single-Agent）”和“多智能体（Multi-Agent）”的差异。<a href="https://link.juejin.cn?target=https%3A%2F%2Fchen.zhipoai.cn" target="_blank" title="https://chen.zhipoai.cn" ref="nofollow noopener noreferrer">【AI大模型教程】</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3dd5f16eac814eeb86e9c35270cbc9a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546p6L2sQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763548664&amp;x-signature=FigvSG6yLdQxQ1m1%2Bb2h1OdkbvE%3D" alt="" loading="lazy"/></p>
<p>说实话，在没真正动手之前，我也只是听过这些概念，觉得听起来很玄。直到我用 <strong>LangGraph</strong> 和 <strong>LangSmith Studio</strong> 亲自搭建了两个版本，一个“单兵作战”，一个“多智能体协作”，结果真的让我彻底改观。</p>
<p>我想造一个能帮我追踪科技趋势的“研究助手 Agent”。它的任务很简单：每天帮我找出过去一天或一周内科技圈的热门话题，再挑出哪些是真正“值得报道”的。</p>
<p>数据源是一个科技社交 API，它能告诉我们“大家在聊什么、转发什么”。而我的 Agent 要做的，就是：<br/>
1️⃣ 根据目标用户（比如科技博主、行业分析师）的画像，筛出重点；<br/>
2️⃣ 再帮我做一份简明的总结报告。</p>
<p>听起来挺简单，但真正动手时，我才意识到，Agent 的“结构设计”决定了最终的质量。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a20af5ff39546a5b7a05b9fb0939ab7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546p6L2sQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763548664&amp;x-signature=53N1y74nc3sxuZ76hEGmJgrAaqU%3D" alt="" loading="lazy"/></p>
<p>我喜欢用一句话解释：</p>
<blockquote>
<p><strong>Agentic AI 就是“用自然语言编程”。</strong></p>
</blockquote>
<p>传统开发要写死逻辑，而 Agentic AI 是让大语言模型（LLM）自己“理解任务、规划步骤、调用工具、生成结果”。我们不是在写“代码逻辑”，而是在“训练一位会思考的实习生”。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28eda90d0fa845fda50cd57f48c88246~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546p6L2sQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763548664&amp;x-signature=DubDHYkmVL8mNJYdI6JJAtDtk%2B0%3D" alt="" loading="lazy"/></p>
<p>这其实不是 NLP 的新鲜事，但这次不一样——以前的 NLP 模型只会照规则提取信息；现在的 LLM，能<strong>自己判断模糊语义、动态决策</strong>，甚至在不确定的情况下“自我补全”。</p>
<p>当然，这也意味着——如果你不给它干净的数据，它就会“开始胡编”。<br/>
我常对朋友打比方：</p>
<blockquote>
<p>“LLM 就像人类一样——如果信息不全，就开始脑补。”</p>
</blockquote>
<p>所以，要想让它靠谱，就得让它接入结构化数据、外部工具和 API，保证它“有料可查”。</p>
<h5 data-id="heading-1">单智能体（Single-Agent）一切都交给一个模型来做。我给它所有工具（API 接口、数据库访问权限），然后一句话：“帮我找出过去一周科技圈最热的新闻。”它会尽力完成所有步骤，但问题也明显：</h5>
<ul>
<li>有时它忘记调用某个接口；</li>
<li>有时它重复查询；</li>
<li>有时总结得太笼统，遗漏重点。</li>
</ul>
<p>就像一个人同时扮演“记者 + 编辑 + 总编”，效率高，但容易糊成一锅粥。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca435c7e30e14fbf896df9315a132f06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546p6L2sQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763548664&amp;x-signature=BEqEIuMEdOxPZHunCgneMo4i%2BXQ%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-2">多智能体（Multi-Agent）</h5>
<p>我换了一种思路：一个“主编 Agent”统筹全局；几个“研究员 Agent”分别负责数据采集、筛选、总结。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abc4d2617ca94c2c8a1474d4f3134fbb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546p6L2sQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763548664&amp;x-signature=s6TbxD0yIYG1e3dSkadIaASfb3k%3D" alt="" loading="lazy"/></p>
<p>比如：</p>
<ul>
<li><strong>Research Agent</strong>：调用 API 抓取趋势数据；</li>
<li><strong>Filter Agent</strong>：筛掉噪声，选出真正热门的内容；</li>
<li><strong>Summary Agent</strong>：生成结构化的科技简报；</li>
<li><strong>Lead Agent</strong>（主编）：整合全局、审核结果。</li>
</ul>
<p>这个系统看起来复杂，但运行结果非常惊艳：报告更全面、更有逻辑、也更贴近我想要的风格。</p>
<p>很多人第一反应会去用 CrewAI 或 AutoGen，但我这次选了 <strong>LangGraph</strong>。它是基于 LangChain 的图形化框架，用“节点（Node）”代表不同 Agent，用“边（Edge）”定义信息流。</p>
<p>我第一次在 LangSmith Studio 里看到我的多智能体系统“开工”的时候，真的有点震撼——好几个 Agent 在“互相对话”，协作完成一篇科技新闻摘要。整个流程跑完大概 3 分钟，比单智能体慢一点，但输出质量完全不在一个层次上。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77ac6834f84547bf9d9f2ed81d545748~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546p6L2sQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763548664&amp;x-signature=DuPqqCzf87RGXIaukPtKkjKdWY0%3D" alt="" loading="lazy"/></p>
<p>LangGraph 的确稍微偏“工程”，不如 CrewAI 那么即开即用，但它能让我清楚看到每一步的调用、每个 Agent 的状态，特别适合做实验和调优。</p>
<p>我现在的经验是：</p>
<ul>
<li>想<strong>快速验证一个想法</strong>？用单智能体。</li>
<li>想<strong>产出可控、高质量结果</strong>？用多智能体。</li>
</ul>
<p>单体像自由创作，灵活但容易跑偏；<br/>
多体像流水线协作，精确但成本更高。</p>
<p>我更喜欢混合方案——比如用一个单 Agent 先“预判主题”，再交给多 Agent 系统细化处理。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b7218735a974a4ab98d3fed757ef0a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546p6L2sQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763548664&amp;x-signature=suI1SZIWUHwoc4G57Eynq0HwwV8%3D" alt="" loading="lazy"/></p>
<p>别让 LLM 去算数或做结构化任务，它不是计算器。真正的魔法，是让它<strong>负责理解人话、拆解模糊目标</strong>，再让程序去执行那些确定性的事情。</p>
<p>所以我常说：</p>
<blockquote>
<p><strong>好的 Agent 系统，是人脑逻辑 + 机器执行的结合体。</strong></p>
</blockquote>
<p>当我看着多智能体系统在屏幕上“协作”时，我突然有种奇怪的感受——<br/>
这不是在写代码，而是在“指挥一个小团队”。每个 Agent 都有自己的性格、擅长的任务、汇报的方式。</p>
<p>而我，只需要扮演那个“懂目标、懂策略”的管理者。</p>
<p>我想，这大概就是 <strong>Agentic AI 的真正魅力</strong>——让语言变成指令，让思维变成系统。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[理解编程范式（前端角度）]]></title>    <link>https://juejin.cn/post/7571648135585005611</link>    <guid>https://juejin.cn/post/7571648135585005611</guid>    <pubDate>2025-11-12T10:57:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571648135585005611" data-draft-id="7571678388953759763" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="理解编程范式（前端角度）"/> <meta itemprop="keywords" content="设计模式"/> <meta itemprop="datePublished" content="2025-11-12T10:57:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="颜酱"/> <meta itemprop="url" content="https://juejin.cn/user/905653309941495"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            理解编程范式（前端角度）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/905653309941495/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    颜酱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T10:57:19.000Z" title="Wed Nov 12 2025 10:57:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>编程范式（Programming Paradigms）是编程的一种风格或方法，它定义了代码的结构和组织方式。编程范式提供了不同的思考和解决问题的角度，影响着程序员如何编写代码。</p>
<p>常见的前端编程范式包括：</p>
<ul>
<li>命令式编程（Imperative Programming）</li>
<li>声明式编程（Declarative Programming）</li>
<li>函数式编程（Functional Programming）</li>
<li>面向对象编程（Object-Oriented Programming）</li>
</ul>
<h2 data-id="heading-0">命令式编程（Imperative Programming） - 关注"如何做"（How）</h2>
<p><strong>特点</strong>：关注"如何做"（How），核心思想是通过一系列明确的指令（如变量赋值、循环、条件判断）来改变程序的状态，逐步引导计算机完成任务。它强调 “过程” 和 “状态变化”，就像给计算机一步步下达操作命令。</p>
<p>然后，看看下面的代码属于命令式编程么？</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">isEven</span> = (<span class="hljs-params">number</span>) =&gt; number % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title function_">square</span> = (<span class="hljs-params">number</span>) =&gt; number * number;
<span class="hljs-keyword">const</span> <span class="hljs-title function_">add</span> = (<span class="hljs-params">a, b</span>) =&gt; a + b;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">sumOfEvenSquares</span>(<span class="hljs-params">numbers</span>) {
  <span class="hljs-comment">// 声明变量保存中间状态（总和）</span>
  <span class="hljs-keyword">let</span> sum = <span class="hljs-number">0</span>;
  <span class="hljs-comment">// 循环遍历数组，（明确的步骤：逐个检查元素，并进行处理）</span>
  numbers.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">number</span>) =&gt;</span> {
    <span class="hljs-comment">// 条件判断，筛选偶数</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isEven</span>(number)) {
      <span class="hljs-comment">// 修改状态（总和）</span>
      sum += <span class="hljs-title function_">square</span>(number);
    }
  });
  <span class="hljs-comment">// 返回结果</span>
  <span class="hljs-keyword">return</span> sum;
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">sumOfEvenSquares</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>])); <span class="hljs-comment">// 56</span>
</code></pre>
<p>答案：上面是命令式编程。</p>
<p>以前我粗浅的以为，看到forEach就是声明式编程，看到提取函数以为是函数式编程，其实还是命令式编程，因为sum在被显示的修改。</p>
<p>其整个流程依然是 “初始化 sum → 循环数组 → 逐个判断 → 累加偶数 → 返回结果”</p>
<p>重新梳理下命令式编程的特点：</p>
<ul>
<li>步骤化指令（关注步骤，明确每一步的执行过程）</li>
<li>依赖显式状态修改（状态在显示的修改，比如sum在显示的被修改）</li>
<li>控制流由开发者主导（开发者控制程序的执行流程，比如for循环、if判断等）</li>
</ul>
<p><strong>场景和优缺点</strong>：</p>
<ul>
<li>适合场景：适合简单、步骤明确的逻辑的场景</li>
<li>优势：直观、可控性强</li>
<li>缺点：复杂逻辑下代码容易冗长（如多层嵌套循环）</li>
</ul>
<h3 data-id="heading-1">类比炒西红柿炒鸡蛋</h3>
<p>你手里有一份《番茄炒蛋盖浇饭步骤说明书》，严格按步骤执行：</p>
<ul>
<li>拿出 2 个番茄，洗净，切成小块（明确 “拿、洗、切” 的动作）；</li>
<li>拿出 2 个鸡蛋，打入碗中，用筷子搅拌均匀（明确 “打、搅” 的动作）；
开火，锅烧热后倒入 2 勺油（明确 “开火、加热、倒油”）；</li>
<li>倒入鸡蛋液，翻炒至凝固，盛出备用（明确 “倒、炒、盛”）；</li>
<li>锅里再倒 1 勺油，放入番茄块，翻炒出汁（明确 “倒、放、炒”）；</li>
<li>倒入炒好的鸡蛋，加 1 勺盐、半勺糖，翻炒均匀（明确 “倒、加、炒”）；</li>
<li>拿出一碗米饭，盛在盘子里，把炒好的番茄炒蛋浇在米饭上（明确 “拿、盛、浇”）。</li>
</ul>
<p>你自己控制整个流程，自己把控每一步的执行过程。</p>
<p>但是注意，每个步骤有可能会涉及其他的范式。</p>
<h2 data-id="heading-2">声明式编程（Declarative Programming） - 关注"做什么"（What）</h2>
<p><strong>特点</strong>：其实这个是相对于命令式编程来说的，命令式编程是关注"如何做"（How），描述具体的实现步骤，而声明式编程是关注"做什么"（What），开发者只需描述 “想要的结果 / 目标”，而无需编写具体的执行步骤、控制流（循环、分支）或手动管理状态，具体的实现细节（如遍历、状态维护）由语言或框架<strong>自动</strong>完成。</p>
<p>看下同样的功能，使用声明式编程的代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">isEven</span> = (<span class="hljs-params">n</span>) =&gt; n % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title function_">square</span> = (<span class="hljs-params">n</span>) =&gt; n * n;
<span class="hljs-keyword">const</span> <span class="hljs-title function_">sum</span> = (<span class="hljs-params">acc, curr</span>) =&gt; acc + curr;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">sumOfEvenSquares</span> = (<span class="hljs-params">numbers</span>) =&gt;
  numbers
    .<span class="hljs-title function_">filter</span>(isEven) <span class="hljs-comment">// 描述：筛选偶数（不关心如何遍历）</span>
    .<span class="hljs-title function_">map</span>(square) <span class="hljs-comment">// 描述：计算平方（不关心如何处理）</span>
    .<span class="hljs-title function_">reduce</span>(sum, <span class="hljs-number">0</span>); <span class="hljs-comment">// 描述：累加求和（不关心如何维护状态）</span>

<span class="hljs-comment">// 使用</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">sumOfEvenSquares</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>])); <span class="hljs-comment">// 56</span>
</code></pre>
<p>看着好像也是一步步的，但这些 “步骤” 是 “目标的分解”，而非 “执行的指令”。</p>
<p>第一步：我需要“筛选出偶数”这个结果，而不是具体的如何遍历、如何判断偶数。
第二步：我需要“计算平方”这个结果，而不是具体的如何计算平方。
第三步：我需要“累加求和”这个结果，而不是具体的如何累加求和。</p>
<p>每一步都是对 “中间结果” 的描述，而非 “如何实现这个中间结果” 的指令。你不需要告诉计算机 “如何筛选偶数”（是否用 for 循环、forEach 还是其他方式），filter 内部已经封装了遍历逻辑。
同样，你<strong>不需要手动维护</strong> “筛选后的数组”“平方后的数组” 这些中间状态，它们由函数自动生成并传递。也就是底层的遍历和状态维护完全封装。</p>
<p>看下sql的例子加深理解：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 目标：查询“年龄大于18的用户姓名”，不关心数据库如何检索</span>
<span class="hljs-keyword">SELECT</span> name <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">18</span>;
<span class="hljs-comment">-- 命令式思路会是：“打开数据库→遍历所有用户→判断年龄→收集姓名”，而 SQL 直接描述结果。</span>
</code></pre>
<p><strong>场景和优缺点</strong>：</p>
<ul>
<li>适合场景：数据查询、复杂计算逻辑</li>
<li>优势：可读性高、可维护性强、抽象程度高</li>
<li>缺点：可能产生中间数组，内存占用较大</li>
</ul>
<hr/>
<p>注意，声明式是一个 “大范式”，包含多个具体的子范式，覆盖不同场景，常见的子范式包括：</p>
<ul>
<li>函数式编程（FP）：用纯函数组合描述计算，无副作用、不可变数据（如 JavaScript 的 filter+map+reduce、Haskell）。</li>
<li>逻辑编程：通过 “事实 + 规则” 推导结果，而非步骤（如 Prolog）。</li>
<li>数据查询语言：描述需要的数据，而非获取数据的过程（如 SQL、GraphQL）。</li>
<li>响应式编程：基于数据流和变化传播处理异步（如 RxJS）。</li>
<li>标记语言：描述 “内容结构”，而非 “渲染步骤”（如 HTML、XML）。</li>
</ul>
<p>这些子范式的共性是 “声明目标，不写步骤”，差异是 “目标类型不同”（计算、推理、数据、异步、结构）。</p>
<h3 data-id="heading-3">类比去餐馆点炒西红柿炒鸡蛋</h3>
<p>你去餐馆，直接跟服务员说：“我要一份番茄炒蛋盖浇饭，米饭要软硬适中，番茄要炒出汁，少盐少糖。”
你完全不用管：厨师是先炒鸡蛋还是先炒番茄、用多少油、炒多久 —— 只需要告诉 “最终需求”，厨师会自己处理所有步骤。</p>
<h2 data-id="heading-4">函数式编程（Functional Programming）- 函数</h2>
<p><strong>特点</strong>：一种以 “函数” 为核心的声明式编程范式，其核心思想是将计算过程视为 “纯函数的组合”，强调无副作用、不可变数据、函数是 “第一公民” 等特性，通过函数的<strong>嵌套和组合</strong>来解决问题，而<strong>非通过修改状态</strong>或<strong>执行步骤</strong>。</p>
<p>注意，函数式编程是声明式编程的子范式，所以如果是函数式编程的，一定属于声明式编程。反过来不一定成立。</p>
<p>所以声明式编程里面的求和代码，也属于函数式编程。</p>
<p><strong>函数式编程的核心原则</strong>：</p>
<ul>
<li>纯函数（相同输入必产相同输出;不修改函数外部的任何状态（如全局变量、参数对象、DOM 等），也不依赖外部状态的变化）</li>
<li>不可变数据（数据一旦创建就不可修改，只能通过创建新的数据来修改）</li>
<li>函数是 “第一公民”（函数可以作为参数传递、可以作为返回值返回、可以作为变量赋值）</li>
</ul>
<p><strong>函数式编程的常见工具</strong>：</p>
<ul>
<li>高阶函数（如 map、filter、reduce、flatMap等，用于组合数据处理逻辑）</li>
<li>柯里化（currying，将多参数函数转化为一系列单参数函数的过程，便于复用和组合）</li>
<li>函数组合（compose，将多个函数组合成一个函数，执行顺序从右到左或者从右到左）</li>
</ul>
<p><strong>场景和优缺点</strong>：</p>
<ul>
<li>适合场景：适合数据处理、逻辑处理、函数组合的场景</li>
<li>优势：代码可测试性强、易于并行化、函数可复用、减少 bug</li>
<li>缺点：学习曲线陡峭、可能产生性能开销、不适合所有场景</li>
</ul>
<h3 data-id="heading-5">拆解React的核心设计，加深函数式编程的理解</h3>
<p>React并非 “纯函数式框架”，而是选择性吸收了函数式编程（FP）的核心思想，并结合前端开发的实际场景（如 UI 状态管理、组件复用、副作用处理）进行落地。其核心目的是：通过 FP 的特性（纯函数、不可变数据、无副作用）解决前端开发的经典痛点（如状态混乱、组件复用复杂、调试困难），让代码更可预测、可维护。</p>
<p>从 React 的核心设计和实践出发，拆解它如何 “吸收 FP 思想”，从而加深对函数式编程的理解。</p>
<h4 data-id="heading-6">用 “纯函数组件” 替代 “类组件”（React 16.8+ Hooks 时代）</h4>
<p>函数式编程的核心是 “纯函数”，React 把这个思想落地为 函数组件（Function Component）+ Hooks，替代了早期的类组件（Class Component）。</p>
<p>React 函数组件本质是一个 “输入 → 输出” 的纯函数：</p>
<ul>
<li>输入：props（父组件传递的参数）+ state（组件内部状态，通过 Hooks 管理）；</li>
<li>输出：UI 描述（JSX）；</li>
<li>无副作用（理想状态）：组件本身只负责 “根据输入渲染 UI”，不直接操作 DOM、不修改外部状态、不发起网络请求（这些都属于副作用，交给专门的 Hooks 处理）。</li>
</ul>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 纯函数组件：输入 props（name），输出 UI，无副作用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Greeting</span>(<span class="hljs-params">{ name }</span>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello, {name}!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>;
}

<span class="hljs-comment">// 调用时，相同输入必然产生相同输出（可预测）</span>
&lt;<span class="hljs-title class_">Greeting</span> name=<span class="hljs-string">"小明"</span> /&gt; <span class="hljs-comment">// 输出 &lt;h1&gt;Hello, 小明!&lt;/h1&gt;</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Greeting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"小红"</span> /&gt;</span></span> <span class="hljs-comment">// 输出 &lt;h1&gt;Hello, 小红!&lt;/h1&gt;</span>
</code></pre>
<p>之前的：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 类组件：依赖可变的 this，状态修改隐含副作用</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Greeting</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello, {this.props.name}!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>; <span class="hljs-comment">// this.props 是可变的（父组件更新时变化）</span>
  }
}
</code></pre>
<p>相比之下，函数组件的优势很明显：</p>
<ul>
<li>可预测性：纯函数组件 “输入定，输出定”，无需担心内部隐藏状态导致的 UI 错乱，调试时只需关注 props 和 state；</li>
<li>简洁性：摆脱 this 绑定、生命周期钩子（如 componentDidMount）的复杂逻辑，代码更短、可读性更高；</li>
<li>复用性：纯函数组件更容易通过组合（而非继承）复用（如自定义 Hooks）。</li>
</ul>
<h4 data-id="heading-7">“不可变数据” 管理状态（避免隐性副作用）</h4>
<p>函数式编程强调 “不可变数据”（数据创建后不修改，而是返回新副本），React 把这个思想贯穿到 状态更新（setState/useState） 和 Props 传递 中。</p>
<p>React 的状态（state）本质是 “不可变的”：你不能直接修改状态对象 / 数组，必须返回一个新的副本，React 才会感知到状态变化并重新渲染。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">TodoList</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 初始化状态：todo 列表（数组）</span>
  <span class="hljs-keyword">const</span> [todos, setTodos] = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useState</span>([{ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'学习 FP'</span> }]);

  <span class="hljs-comment">// 添加新 todo：返回新数组（不修改原数组）</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">addTodo</span> = (<span class="hljs-params">text</span>) =&gt; {
    <span class="hljs-keyword">const</span> newTodo = { <span class="hljs-attr">id</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(), text };
    <span class="hljs-comment">// 正确：用扩展运算符创建新数组（不可变）</span>
    <span class="hljs-title function_">setTodos</span>([...todos, newTodo]);
    <span class="hljs-comment">// 错误：直接修改原数组（React 无法感知变化）</span>
    <span class="hljs-comment">// todos.push(newTodo);</span>
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {todos.map((todo) =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{todo.id}</span>&gt;</span>{todo.text}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      ))}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> addTodo('学习 React FP')}&gt;添加<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>这种设计的优势：</p>
<ul>
<li>避免隐性副作用：直接修改原状态会导致 “状态变化不可追踪”（比如不知道什么时候、谁修改了状态），纯函数组件的 “输入 → 输出” 逻辑被打破；</li>
<li>React 渲染优化：React 通过 “浅比较” 判断状态 / Props 是否变化（比如比较数组引用是否改变），如果直接修改原数据，引用不变，React 会误以为状态没变化，不重新渲染；</li>
<li>符合 FP 思想：不可变数据让状态变化 “可预测、可回溯”，比如 Redux（React 生态的状态管理库）的核心就是 “不可变状态树”。</li>
</ul>
<h4 data-id="heading-8">“副作用隔离”（用 Hooks 分离纯逻辑与副作用）</h4>
<p>函数式编程强调 “纯函数无副作用”，但前端开发无法避免副作用（如网络请求、DOM 操作、定时器）。React 没有禁止副作用，而是通过 Hooks（如 useEffect、useCallback） 将副作用与纯渲染逻辑 “隔离”，让组件主体保持纯函数特性（组件主题（函数执行部分）只负责 “根据状态渲染 UI”（纯逻辑），副作用（如网络请求、DOM 操作、定时器）由专门的 Hooks 处理）。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">UserProfile</span>(<span class="hljs-params">{ userId }</span>) {
  <span class="hljs-keyword">const</span> [user, setUser] = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// 副作用：发起网络请求（隔离在 useEffect 中）</span>
  <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 网络请求是副作用（依赖外部环境，有不确定性）</span>
    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/user/<span class="hljs-subst">${userId}</span>`</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> res.<span class="hljs-title function_">json</span>())
      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">setUser</span>(data));
  }, [userId]); <span class="hljs-comment">// 依赖项：只有 userId 变化时，才重新执行副作用</span>

  <span class="hljs-comment">// 组件主体：纯逻辑（根据 user 状态渲染 UI）</span>
  <span class="hljs-keyword">if</span> (!user) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>姓名：{user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p>这样设计的优势：</p>
<ul>
<li>组件职责单一：组件主体只关心 “渲染 UI”，副作用交给专门的 Hooks 处理，符合 “单一职责原则”；</li>
<li>副作用可控制：useEffect 通过 “依赖项数组” 控制副作用的执行时机（如组件挂载时、依赖变化时），避免 “副作用泛滥”；</li>
<li>符合 FP 思想：纯函数负责 “计算”（渲染 UI），副作用负责 “与外部交互”，两者分离，代码更易维护。</li>
</ul>
<h4 data-id="heading-9">“函数组合” 实现组件复用（替代继承）</h4>
<p>函数式编程强调 “用函数组合替代继承”，React 把这个思想落地为 组件组合（Composition） 和 自定义 Hooks，替代了类组件的继承（如 extends React.Component）。</p>
<p>组件组合（Composition）通过 “组件嵌套” 和 “Props 传递” 实现复用，而非继承：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 通用组件：Button（纯函数组件）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Button</span>(<span class="hljs-params">{ children, onClick }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">color:</span> '<span class="hljs-attr">red</span>' }} <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onClick}</span>&gt;</span>
      {children}
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 业务组件：LoginButton（组合 Button 实现复用）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">LoginButton</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleLogin</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'登录'</span>);
  <span class="hljs-comment">// 组合 Button，传递 Props，无需继承</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleLogin}</span>&gt;</span>登录<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span>;
}

<span class="hljs-comment">// 业务组件：LogoutButton（组合 Button 实现复用）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">LogoutButton</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleLogout</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'退出'</span>);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleLogout}</span>&gt;</span>退出<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span>;
}
</code></pre>
<p>把可复用的逻辑（纯逻辑 + 副作用）封装成自定义 Hooks，通过 “函数调用” 复用，而非组件继承：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 自定义 Hooks：封装“获取用户数据”的复用逻辑（纯逻辑 + 副作用）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">useUser</span>(<span class="hljs-params">userId</span>) {
  <span class="hljs-keyword">const</span> [user, setUser] = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/user/<span class="hljs-subst">${userId}</span>`</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> res.<span class="hljs-title function_">json</span>())
      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">setUser</span>(data));
  }, [userId]);
  <span class="hljs-keyword">return</span> user; <span class="hljs-comment">// 返回结果，供组件使用</span>
}

<span class="hljs-comment">// 组件 A：复用 useUser 逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserProfileA</span>(<span class="hljs-params">{ userId }</span>) {
  <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">useUser</span>(userId); <span class="hljs-comment">// 函数调用，复用逻辑</span>
  <span class="hljs-keyword">if</span> (!user) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>姓名：{user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}

<span class="hljs-comment">// 组件 B：复用 useUser 逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserCard</span>(<span class="hljs-params">{ userId }</span>) {
  <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">useUser</span>(userId); <span class="hljs-comment">// 函数调用，复用逻辑</span>
  <span class="hljs-keyword">if</span> (!user) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>卡片：{user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p>这样的设计优势：</p>
<ul>
<li>灵活性更高：继承会导致 “组件耦合”（子类依赖父类的实现），而组合和自定义 Hooks 是 “松耦合”（组件 / 逻辑通过参数传递，不依赖内部实现）；</li>
<li>符合 FP 思想：自定义 Hooks 本质是 “函数组合”，把复杂逻辑拆解成小的、可复用的函数，与函数式编程 “用纯函数组合描述计算” 的思想一致。</li>
</ul>
<p><strong>总结：React 吸收 FP 思想的核心价值</strong>
React 采用函数式编程思想，不是为了 “赶潮流”，而是为了解决前端开发的实际问题：</p>
<ul>
<li>可预测性：纯函数组件 + 不可变数据，让 UI 渲染 “输入定，输出定”，减少状态混乱；</li>
<li>可维护性：副作用隔离 + 函数组合，让代码职责清晰、易于复用和调试；</li>
<li>性能优化：不可变数据 + 浅比较，让 React 渲染优化更高效；</li>
<li>简洁性：摆脱类组件的 this 和生命周期，代码更短、学习成本更低。</li>
</ul>
<h2 data-id="heading-10">面向对象编程（Object-Oriented Programming） - 对象</h2>
<p><strong>特点</strong>：一种以 “对象” 为核心的编程范式，核心思想是将现实世界中的实体抽象为 “对象”—— 每个对象包含 “描述实体的属性（数据）” 和 “实体能执行的行为（方法）”，通过对象间的交互（调用方法、传递数据）完成复杂功能。</p>
<p>简单说，OOP 就像 “搭积木”：把复杂系统拆分成一个个独立的 “积木块（对象）”，每个积木块有自己的 “样子（属性）” 和 “功能（方法）”，再通过积木块的组合拼接，搭建出完整的系统。</p>
<p>仍然是求和的例子，用面向对象编程的方式实现：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 类方式</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">NumberProcessor</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">numbers</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">numbers</span> = numbers;
  }

  <span class="hljs-title function_">filterEven</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">numbers</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">numbers</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">n</span>) =&gt;</span> n % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-title function_">square</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">numbers</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">numbers</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">n</span>) =&gt;</span> n * n);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-title function_">sum</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">numbers</span>.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">sum, n</span>) =&gt;</span> sum + n, <span class="hljs-number">0</span>);
  }

  <span class="hljs-title function_">sumOfEvenSquares</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NumberProcessor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">numbers</span>).<span class="hljs-title function_">filterEven</span>().<span class="hljs-title function_">square</span>().<span class="hljs-title function_">sum</span>();
  }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">const</span> processor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NumberProcessor</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>]);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(processor.<span class="hljs-title function_">sumOfEvenSquares</span>()); <span class="hljs-comment">// 56</span>

<span class="hljs-comment">// 或者使用对象字面量</span>
<span class="hljs-keyword">const</span> numberUtils = {
  <span class="hljs-attr">isEven</span>: <span class="hljs-function">(<span class="hljs-params">n</span>) =&gt;</span> n % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>,
  <span class="hljs-attr">square</span>: <span class="hljs-function">(<span class="hljs-params">n</span>) =&gt;</span> n * n,
  <span class="hljs-attr">sum</span>: <span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a + b,

  <span class="hljs-title function_">sumOfEvenSquares</span>(<span class="hljs-params">numbers</span>) {
    <span class="hljs-keyword">return</span> numbers.<span class="hljs-title function_">filter</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">isEven</span>).<span class="hljs-title function_">map</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">square</span>).<span class="hljs-title function_">reduce</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">sum</span>, <span class="hljs-number">0</span>);
  },
};

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(numberUtils.<span class="hljs-title function_">sumOfEvenSquares</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>])); <span class="hljs-comment">// 56</span>
</code></pre>
<p>当然一般计算，不会想到用面向对象编程的方式实现，但这里就反应了面向对象编程的核心思想：把一切东西都抽象为对象。</p>
<h3 data-id="heading-11">OOP的四大核心特性</h3>
<ul>
<li>封装（Encapsulation）：将数据（属性）和行为（方法）封装在一起，形成一个独立的 “对象”，对外隐藏内部实现细节，只暴露必要的接口（方法）；</li>
<li>继承（Inheritance）：通过 “类” 和 “对象” 的继承关系，实现代码复用和扩展；</li>
<li>多态（Polymorphism）：通过 “方法重载” 和 “接口抽象”，实现 “同名不同实现” 的灵活性；</li>
<li>抽象（Abstraction）：通过 “接口” 和 “抽象类”，实现 “高内聚、低耦合” 的模块化设计。</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 父类：Animal</span>
<span class="hljs-comment">// 将getName方法封装在父类中，对外隐藏内部实现细节，只暴露必要的接口（方法），这就是封装的体现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }
  <span class="hljs-title function_">getName</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>;
  }

  <span class="hljs-comment">// 父类方法（统一接口）</span>
  <span class="hljs-title function_">makeSound</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'动物发出声音'</span>);
  }
}

<span class="hljs-comment">// 子类：Dog 继承了父类的getName方法，这就是继承的体现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> {
  <span class="hljs-comment">// 重写父类的makeSound方法，这就是多态的体现</span>
  <span class="hljs-title function_">makeSound</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>：汪汪汪！`</span>);
  }
}

<span class="hljs-comment">// 子类：Cat（重写 makeSound） 这就是多态的体现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> {
  <span class="hljs-title function_">makeSound</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>：喵喵喵！`</span>);
  }
}

<span class="hljs-comment">// 统一调用逻辑（不关心具体是哪个子类）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">animalSound</span>(<span class="hljs-params">animal</span>) {
  <span class="hljs-comment">// 这就是多态的体现，不同对象调用同一方法，结果不同</span>
  animal.<span class="hljs-title function_">makeSound</span>(); <span class="hljs-comment">// 同一方法调用，不同行为</span>
}

<span class="hljs-comment">// 多态体现：不同对象调用同一方法，结果不同</span>
<span class="hljs-keyword">const</span> dog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>(<span class="hljs-string">'旺财'</span>);
<span class="hljs-keyword">const</span> cat = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>(<span class="hljs-string">'咪宝'</span>);
<span class="hljs-title function_">animalSound</span>(dog); <span class="hljs-comment">// 旺财：汪汪汪！</span>
<span class="hljs-title function_">animalSound</span>(cat); <span class="hljs-comment">// 咪宝：喵喵喵！</span>

<span class="hljs-comment">// 抽象就是你思考到核心的属性和方法，什么适合封装成一个父类，什么适合封装成一个子类，这就是抽象的体现</span>
</code></pre>
<h3 data-id="heading-12">OOP的适用场景和优劣势</h3>
<ul>
<li>适用场景：模拟现实世界的复杂实体（如 “用户、订单、商品” 等业务对象）；大型复杂系统（如管理系统、游戏、框架），需要清晰的模块划分和复用</li>
<li>优势：可读性高（代码结构贴近现实世界），易于维护和拓展（内部实现细节对外隐藏，继承和多态让代码更灵活），模块化清晰（高内聚、低耦合）</li>
<li>劣势：可能过度设计（如果一个系统很小，却要使用OOP，可能会过度设计），性能开销（继承和多态会有一定的性能开销），继承可能导致紧耦合（如果一个系统很大，却要使用OOP，可能会导致代码过于复杂，难以维护）</li>
</ul>
<h2 data-id="heading-13">范式对比总结</h2>



































<table><thead><tr><th>范式</th><th>关注点</th><th>适用场景</th><th>代码风格</th></tr></thead><tbody><tr><td>命令式</td><td>如何做</td><td>性能敏感、底层操作</td><td>循环、条件语句</td></tr><tr><td>声明式</td><td>做什么</td><td>数据处理、UI 构建</td><td>链式调用、表达式</td></tr><tr><td>函数式</td><td>函数组合</td><td>数据处理、数学计算</td><td>纯函数、不可变数据</td></tr><tr><td>面向对象</td><td>对象和类</td><td>大型系统、GUI 应用</td><td>类、继承、封装</td></tr></tbody></table>
<h2 data-id="heading-14">实际应用建议</h2>
<p>实际项目中通常混合使用多种范式，不同场景适合不同范式。</p>
<p>来一个综合使用的例子：
假设需实现一个 “电商订单处理流程”，包含以下功能：</p>
<ol>
<li>定义订单实体（含商品、金额、状态等）。</li>
<li>筛选符合条件的订单（如 “已付款且金额&gt; 100 元”）。</li>
<li>计算订单总金额（含折扣：满 200 减 20）。</li>
<li>输出处理结果。</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 面向对象编程（OOP）：定义订单实体（封装属性和行为）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">id, products, isPaid</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">products</span> = products; <span class="hljs-comment">// 商品列表（{name: string, price: number}）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isPaid</span> = isPaid; <span class="hljs-comment">// 是否付款</span>
  }

  <span class="hljs-comment">// 计算订单原始总金额（封装行为）</span>
  <span class="hljs-title function_">getTotalPrice</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">products</span>.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">sum, p</span>) =&gt;</span> sum + p.<span class="hljs-property">price</span>, <span class="hljs-number">0</span>);
  }
}

<span class="hljs-comment">// 2. 函数式编程（FP）：纯函数处理数据（不可变、无副作用）</span>
<span class="hljs-comment">// 纯函数：计算折扣后金额</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">calculateDiscount</span> = (<span class="hljs-params">total</span>) =&gt; (total &gt;= <span class="hljs-number">200</span> ? total - <span class="hljs-number">20</span> : total);

<span class="hljs-comment">// 纯函数：筛选符合条件的订单（已付款且原始金额&gt;100）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">filterValidOrders</span> = (<span class="hljs-params">orders</span>) =&gt;
  orders.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">order</span>) =&gt;</span> order.<span class="hljs-property">isPaid</span> &amp;&amp; order.<span class="hljs-title function_">getTotalPrice</span>() &gt; <span class="hljs-number">100</span>);

<span class="hljs-comment">// 3. 声明式编程：描述目标（筛选→计算折扣→汇总），隐藏步骤</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">processOrders</span> = (<span class="hljs-params">orders</span>) =&gt;
  <span class="hljs-title function_">filterValidOrders</span>(orders)
    .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">order</span>) =&gt;</span> ({
      <span class="hljs-attr">id</span>: order.<span class="hljs-property">id</span>,
      <span class="hljs-attr">originalPrice</span>: order.<span class="hljs-title function_">getTotalPrice</span>(),
      <span class="hljs-attr">discountedPrice</span>: <span class="hljs-title function_">calculateDiscount</span>(order.<span class="hljs-title function_">getTotalPrice</span>()),
    }))
    .<span class="hljs-title function_">reduce</span>(
      <span class="hljs-function">(<span class="hljs-params">summary, item</span>) =&gt;</span> {
        summary.<span class="hljs-property">totalOriginal</span> += item.<span class="hljs-property">originalPrice</span>;
        summary.<span class="hljs-property">totalDiscounted</span> += item.<span class="hljs-property">discountedPrice</span>;
        summary.<span class="hljs-property">details</span>.<span class="hljs-title function_">push</span>(item);
        <span class="hljs-keyword">return</span> summary;
      },
      { <span class="hljs-attr">totalOriginal</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">totalDiscounted</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">details</span>: [] },
    );

<span class="hljs-comment">// 4. 命令式编程：执行流程并输出结果（显式步骤）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 初始化订单（命令式步骤：创建对象）</span>
  <span class="hljs-keyword">const</span> orders = [
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>(<span class="hljs-number">1</span>, [{ <span class="hljs-attr">name</span>: <span class="hljs-string">'书'</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">50</span> }], <span class="hljs-literal">true</span>), <span class="hljs-comment">// 金额50（不满足&gt;100）</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>(<span class="hljs-number">2</span>, [{ <span class="hljs-attr">name</span>: <span class="hljs-string">'手机'</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">250</span> }], <span class="hljs-literal">true</span>), <span class="hljs-comment">// 金额250（满足）</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>(<span class="hljs-number">3</span>, [{ <span class="hljs-attr">name</span>: <span class="hljs-string">'耳机'</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">150</span> }], <span class="hljs-literal">false</span>), <span class="hljs-comment">// 未付款（不满足）</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>(
      <span class="hljs-number">4</span>,
      [
        { <span class="hljs-attr">name</span>: <span class="hljs-string">'键盘'</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">120</span> },
        { <span class="hljs-attr">name</span>: <span class="hljs-string">'鼠标'</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">90</span> },
      ],
      <span class="hljs-literal">true</span>,
    ), <span class="hljs-comment">// 金额210（满足）</span>
  ];

  <span class="hljs-comment">// 处理订单（调用声明式/函数式逻辑）</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">processOrders</span>(orders);

  <span class="hljs-comment">// 命令式输出（显式步骤：循环打印）</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'有效订单处理结果：'</span>);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; result.<span class="hljs-property">details</span>.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-comment">// 命令式循环</span>
    <span class="hljs-keyword">const</span> item = result.<span class="hljs-property">details</span>[i];
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`订单<span class="hljs-subst">${item.id}</span>：原价<span class="hljs-subst">${item.originalPrice}</span>元，折扣后<span class="hljs-subst">${item.discountedPrice}</span>元`</span>);
  }
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`总计：原价<span class="hljs-subst">${result.totalOriginal}</span>元，折扣后<span class="hljs-subst">${result.totalDiscounted}</span>元`</span>);
}

<span class="hljs-comment">// 执行主函数</span>
<span class="hljs-title function_">main</span>();
</code></pre>
<p>main 函数的核心是 “流程控制”，通过明确的步骤、显式的循环和指令，一步步引导计算机完成 “从初始化到输出” 的全流程，完全符合命令式编程 “关注如何做、步骤化执行” 的本质。</p>
<p>虽然内部调用了 processOrders（声明式 + 函数式），但这并不影响 main 本身是命令式 —— 相当于 “命令式的流程” 中，调用了一个 “声明式的工具” 来完成某个子任务。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[多智能体设计模式和智能体框架，你会了么？]]></title>    <link>https://juejin.cn/post/7571416207972483122</link>    <guid>https://juejin.cn/post/7571416207972483122</guid>    <pubDate>2025-11-12T07:58:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571416207972483122" data-draft-id="7571637614202667035" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="多智能体设计模式和智能体框架，你会了么？"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-11-12T07:58:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            多智能体设计模式和智能体框架，你会了么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T07:58:43.000Z" title="Wed Nov 12 2025 07:58:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、新闻</h2>
<p>先播放一条最新新闻，通义团队官宣开源了两个智能体<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fagentscope-ai%2Fagentscope-samples%2Ftree%2Fmain%2Falias" target="_blank" title="https://github.com/agentscope-ai/agentscope-samples/tree/main/alias" ref="nofollow noopener noreferrer"><strong>Alias-Agent</strong></a>和<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fagentscope-ai%2Fagentscope-samples%2Ftree%2Fmain%2Fdata_juicer_agent" target="_blank" title="https://github.com/agentscope-ai/agentscope-samples/tree/main/data_juicer_agent" ref="nofollow noopener noreferrer"><strong>Data-Juicer Agent</strong></a>。</p>
<p><strong>Alias-Agent</strong>提供了RaAct，Planner，DeepResearch三种模式，以实现灵活的任务执行 <strong>。</strong></p>
<p><strong>DataJuicer</strong> 智能体是一个数据专员，由<strong>数据处理智能体，代码开发智能体，MCP 智能体，数据分析与可视化智能体，问答智能体</strong>五个智能体组成。</p>
<p>﻿</p>
<p>看到这里已经相当炸裂了！可能很多伙伴对智能体（Agent）的范式不熟悉，还不理解ReAct、Planner、反思叭叭这些名词。那你们就来对了地方，我用最容易理解的方式带大家一起看下智能体内部是什么样子的。</p>
<p>﻿</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32a2633e165549189d6271a17f8531a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763539123&amp;x-signature=hg29fGuoPSTltE0t0GxuXhs3Uaw%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p><strong>产品化的智能体</strong>由多Agent，反思，计划，推理与行动，记忆，RAG，工具，MCP组成的。首先聊下“Multi-Agent”，它非常好玩！</p>
<p>﻿</p>
<h2 data-id="heading-1">二、Multi-Agent 的7种设计模式</h2>
<p>要让AI代替人工作，现阶段的单体智能体（仅通过系统提示词赋能的LLM）是很难实现的。我们很快意识到，要构建高效的系统，需要多个专业化智能体协同工作、自主组织。为实现这一目标，AI 智能体领域已涌现出多种架构模式。多个智能体组成实现的，也就是Multi-Agent，发展到现在有7种实现方式。</p>
<p><strong>1. 工作流模式</strong></p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b29e7d219a6481da1484711e561bf5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763539123&amp;x-signature=Jca3%2BoFBwDHbwOb63iufFX8iWsw%3D" alt="" loading="lazy"/></p>
<p>﻿在《Agentic Design Patterns》中叫Prompt Chaining，每个智能体都逐步地完成输出，比如一个生成代码，另一个审核代码，第三个部署代码。每一步的输出作为下一步的输入。这种信息传递建立了依赖链，前序操作的上下文和结果会引导后续处理，使 LLM 能够在前一步基础上不断完善理解，逐步逼近目标解。</p>
<p>他非常适合应用在工作流自动化、ETL和多步骤推理pipeline场景。</p>
<p>﻿</p>
<p><strong>2. 路由模式</strong></p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/791058c930ea4255973f54b17b3291c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763539123&amp;x-signature=yEK5nxow6lTOSq1BJzfB0CFtQVk%3D" alt="" loading="lazy"/></p>
<p>﻿路由模式为智能体的操作框架引入了条件逻辑，使其从固定执行路径转变为动态评估标准，从一组可能的后续动作中进行选择的模式，从而实现一套更灵活，并且具备上下文感知的。一个控制器智能体将任务分配给合适的专业智能体，这是上下文感知智能体路由的基础，正如在MCP、A2A框架中所看到的那样。</p>
<p>路由模式的实现有四种：</p>
<p>•<strong>根据LLM路由</strong>，通过提示语言模型分析输入，并输出指示下一步或目标的标识符或指令。这里有显式路由和隐式路由两类，显示直接使用智能体的结构化输出来确定将消息路由到哪个智能体。隐式路由是将下游智能体包装成工具函数，这样路由智能体就可以根据用户查询决定调用哪个工具。</p>
<pre><code class="hljs language-ini" lang="ini">""" 伪代码示例 """
<span class="hljs-attr">router</span> = ReActAgent(
    <span class="hljs-attr">name</span>=<span class="hljs-string">"Router"</span>,
    <span class="hljs-attr">sys_prompt</span>=<span class="hljs-string">"#角色#你是一个路由智能体。你的目标是将用户查询路由到正确的后续任务，注意你不需要回答用户的问题。
                #任务#选择正确的后续任务，如果任务太简单或没有合适的任务，则选择 ``None``"</span>,
    <span class="hljs-attr">model</span>=ChatModel(
        <span class="hljs-attr">model_name</span>=<span class="hljs-string">"gpt-4"</span>,
        <span class="hljs-attr">api_key</span>=<span class="hljs-string">""</span>,
        <span class="hljs-attr">stream</span>=<span class="hljs-literal">False</span>,
    )
)
</code></pre>
<p><strong>根据Embedding路由</strong>，利用嵌入能力，将查询路由到最相似的路径上，适用于语义路由，即决策基于输入的含义而非关键词。</p>
<pre><code class="hljs language-python" lang="python">     <span class="hljs-string">""" 伪代码示例 """</span>
     <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 使用轻量级的句子编码模型</span>
        self.model = ChatModel( model_name=<span class="hljs-string">"gpt-4"</span>, api_key=<span class="hljs-string">""</span>, stream=<span class="hljs-literal">False</span>, )
        
        <span class="hljs-comment"># 定义不同的路由能力和对应的处理函数</span>
        self.routes = {
            <span class="hljs-string">'code_help'</span>: {
                <span class="hljs-string">'description'</span>: <span class="hljs-string">'编程，代码'</span>,
                <span class="hljs-string">'handler'</span>: self.handle_code_question
            },
            <span class="hljs-string">'general_chat'</span>: {
                <span class="hljs-string">'description'</span>: <span class="hljs-string">'聊天，日常对话'</span>,
                <span class="hljs-string">'handler'</span>: self.handle_general_chat
            }
        }
        
        <span class="hljs-comment"># 预计算所有路由描述的嵌入向量</span>
        self.route_embeddings = {}
        <span class="hljs-keyword">for</span> route_name, route_info <span class="hljs-keyword">in</span> self.routes.items():
            embedding = self.model.encode([route_info[<span class="hljs-string">'description'</span>]])
            self.route_embeddings[route_name] = embedding
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">route_query</span>(<span class="hljs-params">self, user_question</span>):        
        <span class="hljs-comment"># 1. 将用户问题转换为嵌入向量</span>
        question_embedding = self.model.encode([user_question])
        
        <span class="hljs-comment"># 2. 使用余弦计算与各个路由的相似度</span>
        similarities = {}
        <span class="hljs-keyword">for</span> route_name, route_embedding <span class="hljs-keyword">in</span> self.route_embeddings.items():
            similarity = cosine_similarity(question_embedding, route_embedding)[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]
            similarities[route_name] = similarity
        
        <span class="hljs-comment"># 3. 选择相似度最高的路由</span>
        best_route = <span class="hljs-built_in">max</span>(similarities, key=similarities.get)
        best_score = similarities[best_route]
        
        <span class="hljs-comment"># 4. 调用对应的处理器</span>
        handler = self.routes[best_route][<span class="hljs-string">'handler'</span>]
        response = handler(user_question)
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'route'</span>: best_route,
            <span class="hljs-string">'confidence'</span>: best_score,
            <span class="hljs-string">'response'</span>: response
        }
        ....
</code></pre>
<p>•<strong>根据定义规则路由，</strong> 硬编码方式，根据关键词、模式或结构化数据进行路由。此方法比 LLM 路由更快、更确定，但灵活性较低。</p>
<p>•<strong>根据自训小模型路由</strong>，采用如分类器等判别模型，在小规模标注数据集上专门训练以实现路由任务。与向量嵌入方法类似，但其特点是监督微调过程，路由逻辑编码在模型权重中。与 LLM 路由不同，决策组件不是推理时执行提示的生成模型，而是已微调的判别模型。LLM 可用于生成合成训练数据，但不参与实时路由决策。</p>
<p>﻿</p>
<p><strong>3. 并行模式</strong></p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a0760cae984462cadb2725a22d3bd22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763539123&amp;x-signature=qxi9QKyJ2RbpwcrjpR2N2Mu9TZY%3D" alt="" loading="lazy"/></p>
<p>﻿每个智能体负责处理不同的子任务，例如数据爬虫、网络检索和摘要生成，它们的输出会合并为一个单一结果。非常适合减少高吞吐量管道中的延迟。（如文档解析或API编排）</p>
<p><strong>4. 循环模式</strong></p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1955d4f02b7d4832bb7df9d75a734473~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763539123&amp;x-signature=VoOMXFDXXhkRIQN5qguLzwOEzqo%3D" alt="" loading="lazy"/></p>
<p>﻿智能体不断优化自身输出，直到达到预期质量。非常适合校对、报告生成或创意迭代，在这些场景中，系统会在确定最终结果前再次思考。反思就是在此模式上进行的优化。</p>
<p>﻿</p>
<p><strong>5. 聚合模式</strong></p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef43677e09264f5d93d28a91a4ac7bbf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763539123&amp;x-signature=EjwIxrBOLC4qQaGsOQRrek2uVtg%3D" alt="" loading="lazy"/></p>
<p>﻿许多智能体生成部分结果，由主智能体将这些结果整合为一个最终输出。因此，每个智能体都形成一个观点，而一个Master智能体将这些观点汇总成共识。在RAG的检索融合、投票系统等场景中很常见。</p>
<p>﻿</p>
<p><strong>6. 网络模式</strong></p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95345f9fe471436a9c99c528aa81a938~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763539123&amp;x-signature=9SxdSimSZMh2BvR10DbqGZQMGpM%3D" alt="" loading="lazy"/></p>
<p>﻿这里没有明确的层级结构，智能体之间可以自由交流，动态共享上下文。用于模拟、多智能体游戏以及需要自由形式行为的集体推理系统中。<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fagentscope-ai%2Fagentscope-samples" target="_blank" title="https://github.com/agentscope-ai/agentscope-samples" ref="nofollow noopener noreferrer">agentscope-samples</a> ，模拟了9个智能体的狼人杀游戏。</p>
<p>﻿</p>
<p><strong>7. 层级模式</strong></p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0589f741bc64ec597857873ca2057ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763539123&amp;x-signature=dPpeTug9Eo2ZX1HGtj%2BTjWQVZf4%3D" alt="" loading="lazy"/></p>
<p>﻿一个顶级规划智能体，将子任务分配给工作智能体，跟踪它们的进度，并做出最终决策。这和经理及其团队的工作方式完全一样（很多中间件的架构也是类似这种模式如Redis、ES、Nocas）。意图识别就是采用此模式。</p>
<p>﻿</p>
<p><strong>小节：</strong></p>
<p>我们一直在思考的一件事，不是哪种模式看起来最酷，而是哪种模式能最大限度地减少智能体之间的摩擦。启动10个智能体并称之为一个团队很容易。难的是设计沟通流程，以确保：没有两个智能体会做重复工作。每个智能体都知道何时行动何时等待，使这个系统作为一个整体，比其任何单个部分都更智能。为此我们遵循 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fengineering%2Fbuilding-effective-agents" target="_blank" title="https://www.anthropic.com/engineering/building-effective-agents" ref="nofollow noopener noreferrer">building-effective-agents</a> 设计。</p>
<p>﻿</p>
<h2 data-id="heading-2">三、Multi-Agent 框架</h2>
<p>多智能体模式将人工智能工作流构建为一个智能体团队，它们相互协作，每个智能体都有明确的角色。每个智能体能够感知输入、进行推理（通过思维链）并执行操作以完成子任务。每个智能体通常都配置有特定角色，并且只能访问该角色所需的工具或信息。例如，PM AGent负责需求判断是否需要其他智能体参与，若需要技术决策则联动Tech lead agent。智能体将循环进行思考（“思考……”）和行动（“行动……”），直到完成其工作部分的任务。如下图</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0f5f3041605465fba6a5713fdadcf5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763539123&amp;x-signature=W6NDveQJo3JrhBxAHr%2F3vBGgjnU%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>以上简单介绍了多智能体的设计模式，那么当下是不是已经有了成熟的架构供我们使用呢？答案是肯定的！</p>
<p>﻿</p>
<p><strong>1.AutoGPT：</strong> Github 180k Star</p>
<p><strong>2.Dify：</strong> Github 118k Star</p>
<p><strong>3.AutoGen：</strong> Github 51.4k Star</p>
<p><strong>4.CrewAI：</strong> Github 40.1k Star</p>
<p>5.<strong>LangGraph：</strong> Github 20.6k Star</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/193b057d5e6c4c5291851bb8e91ced89~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763539123&amp;x-signature=%2BztdFmyc0IR%2FgxuPsUgWJIvlVFo%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<h3 data-id="heading-3"><strong>为什么需要使用Agent框架？</strong></h3>
<p>只要“问题不可完全穷举、要跨多系统查证、并且需要在对话中澄清、协商、决策”，就更应该用 Agent 框架，而不是纯 Workflow。</p>
<h3 data-id="heading-4"><strong>纯 Workflow 的“天花板”</strong></h3>
<p>Workflow 在<strong>对话中的“澄清—再决策—再行动”</strong> 并不天然友好，需要把每一步提问、回答、重试都画成节点，复杂而脆弱。</p>
<p><strong>场景</strong>：用户发起：“我的包裹还没到，怎么办？”</p>
<p>通过Workflow创建如下智能体：(先不期待GPT-6 会自主思考的智能体)</p>
<p>•<strong>意图识别智能体</strong>：识别用户诉求（查询进度/催促/投诉/报损/退货等）</p>
<p>•<strong>物流状态智能体</strong>：实时拉取承运商状态，判断包裹位置、异常</p>
<p>•<strong>政策规则智能体</strong>：查询当前时段政策（节假日、大促、平日），判断是否特殊处理</p>
<p>•<strong>用户画像智能体</strong>：判断用户等级、历史行为、是否会员</p>
<p>•<strong>异常检测智能体</strong>：分析是否有报损、拒收、欺诈等信号</p>
<p>•<strong>澄清与补充智能体</strong>：信息不全时自动向用户提问，补齐决策所需信息</p>
<p>•<strong>解决方案生成智能体</strong>：综合所有智能体结果，输出最优处理方案（比如：建议等待/补发/赔偿/升级处理/转人工等）</p>
<p>智能体数量✖️物流状态✖️用户等级✖️物流政策....你的分支会爆炸。所以需要用Dify这类的可以支持动态决策，动态推理和澄清的智能体框架。</p>
<p>﻿</p>
<h3 data-id="heading-5"><strong>Agent 框架解决的核心问题</strong></h3>
<p>以 AutoGen、CrewAI 这类 Agent 框架为例，它们把“<strong>在对话里动态规划与调用工具</strong>”作为第一性能力：</p>
<p><strong>场景：</strong> 用户说“我10.1买的手机现在还没到，给我退货！另外，你们的运费险的保账期是多久？”</p>
<p>一个合格的客服 Agent 团队会做什么？</p>
<p><strong>没有路由决策</strong>，首先会动态匹配所有Query，对Query进行改写成“查询用户的订单”，“用户想要退货”，“运费险的保账范围和条款”。</p>
<p>1.<strong>意图识别 + 澄清</strong></p>
<p>◦ Planner Agent：拆出多意图（物流异常、退货、计费异常、运费险条款），先问关键（订单号、地址）。</p>
<p>2.<strong>跨系统取证</strong></p>
<p>◦ OMS/物流工具：查轨迹与 SLA；</p>
<p>◦ 计费/支付工具：核对重复扣款交易；</p>
<p>◦ CRM：看是否 Plus、是否有历史补偿记录；</p>
<p>◦保库：查询运费险</p>
<p>3.<strong>政策推理与合规</strong></p>
<p>Policy Agent：套用“假期延误 + Plus + 运费险”的组合条款，评估可给的补偿区间、是否触发风控人工复核。</p>
<p>这些动作里，很多步骤<strong>无法事先“画”成固定分支，需要在对话上下文里做决策、需要跨工具动态组合、需要“问一句 → 查一下 → 再决定”，</strong> 这正是 Agent 的强项。</p>
<p>﻿</p>
<h2 data-id="heading-6">结尾：</h2>
<p>以上是对多智能体的总结，你会了吗？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TypeScript超越Python成GitHub上使用最广语言，AI是主要驱动力]]></title>    <link>https://juejin.cn/post/7571475192490295306</link>    <guid>https://juejin.cn/post/7571475192490295306</guid>    <pubDate>2025-11-12T09:04:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571475192490295306" data-draft-id="7571655312798171162" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TypeScript超越Python成GitHub上使用最广语言，AI是主要驱动力"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-11-12T09:04:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TypeScript超越Python成GitHub上使用最广语言，AI是主要驱动力
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T09:04:38.000Z" title="Wed Nov 12 2025 09:04:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>开发者最常使用的编程语言是什么？相信很多人都会不假思索地选择 Python。</p>
<p>但 GitHub 近日发布的《Octoverse 2025》报告却给出了一个不一样的答案：TypeScript。</p>
<p>根据 GitHub 的贡献者数量统计，2025 年 8 月，Python 的贡献者数量在连续霸榜 16 个月之后首次跌落到第二名，TypeScript 首次成为 GitHub 上使用最广泛的语言，以约 4.2 万名贡献者的优势超越了 Python。JavaScripst 紧随其后，四五六名则是名次超级稳定的 Java、C# 和 PHP。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a78c13b18c034bde939ea3b702cc65c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543078&amp;x-signature=3FWnQTCDLZGKBqoauiKFYcI8Cwk%3D" alt="图片" loading="lazy"/></p>
<p>GitHub 报告表示：「这一里程碑事件是过去十年来开发者转向类型化 JavaScript （typed JavaScript）趋势的集中体现，也标志着 TypeScript 正在成为现代开发的新默认选项。」</p>
<p>更具体而言，TypeScript 在 2025 年的贡献者数量增长了超过 100 万（同比增长 66%）。其主要驱动力一方面来自那些默认使用 TypeScript 搭建项目的开发框架，另一方面则来自 AI 辅助开发，因为 TypeScript 那更严格的类型系统让 AI 辅助开发受益匪浅。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f745b4b83156408a88b9a6a308db9f81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543078&amp;x-signature=oRVyGn%2BJQ%2BuMn3xdIfoZz5DOk0w%3D" alt="图片" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aef8b7ae56c64884914638c3d5b6362f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543078&amp;x-signature=8MyB91zT9vAnDePXEZAnrJGzGMI%3D" alt="图片" loading="lazy"/></p>
<p>不过，GitHub 也指出，Python 在 AI 和数据科学领域仍然保持着主导地位，拥有 260 万贡献者（同比增长 48%）。Jupyter Notebook 依旧是 AI 领域的首选探索性环境（相关仓库约 40.3 万个；在 AI 标签的项目中，同比增长 17.8%）。</p>
<p>JavaScript 的贡献者体量依然庞大（215 万），但随着开发者逐渐转向 TypeScript，其增长已经放缓。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/414165e754e64543a4210d5c3922e084~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543078&amp;x-signature=GA6Nh9Bngp0C%2Bp3XIQSg3hDZj0c%3D" alt="图片" loading="lazy"/></p>
<p>总而言之，TypeScript 和 Python 两者目前共拥有超过 520 万贡献者（约占 2025 年 8 月 GitHub 所有活跃开发者的 3%）。类型化语言的崛起表明：AI 不仅在改变编码的速度，同时也在影响开发团队在「信任并采纳 AI 生成的代码进入生产环境」时，会选择哪些语言。</p>
<p>另外，根据 GitHub 统计，过去 12 月新增的软件库有 80% 都集中在 6 大核心语言：Python、JavaScript、TypeScript、Java、C++ 和 C#。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34552d8d25b442b5a1457b5b1ed33857~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543078&amp;x-signature=g5v3STkX5s1FL%2BuoI%2B3nzVUneGI%3D" alt="图片" loading="lazy"/></p>
<p>为什么 TypeScript 在 2025 年胜出？</p>
<p>TypeScript 在 2025 年 8 月以 2,636,006 名月度贡献者（同比增长 105 万；+66.6%）的成绩在 GitHub 上排名第一，并在新增仓库数量上处于领先地位。</p>
<p>原因是「类型（Type）」对 AI 系统的辅助：类型系统可减少代码的模糊性，并在（AI 生成的）代码进入生产环境前提早捕获大型语言模型（LLM）的错误。</p>
<p>另外，许多框架也默认内置 TypeScript。 Next.js 15、Astro 3、SvelteKit 2、Qwik、SolidStart、Angular 18 和 Remix 均默认（通过 npm create、pnpm dlx 或 bunx create 命令）生成 TypeScript 代码库。</p>
<p>并且类型系统也有助于在开发流程中更早地识别 LLM 生成的编译错误。2025 年的一项学术研究发现，LLM 生成的编译错误中有 94% 是类型检查失败。</p>
<p>TypeScript 的入门门槛也比较低。诸如 Vite、ts-node、Bun 和 IDE 自动配置等工具隐藏了（繁琐的）样板文件（boilerplate），因此初级开发者也可以快速启动类型化的技术栈。</p>
<p>Python 依然主导 AI 项目</p>
<p>即便 TypeScript 崛起了，但在所有 AI 标签的仓库中，Python 仍然是当之无愧的领导者。其中，Jupyter Notebook 的使用量在 2025 年几乎翻了一番，这充分证明了 Python 作为 AI 工作负载原型设计、模型训练和任务编排的首选语言的地位。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ef57a2655a24a8aa19cbe70574fb4c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543078&amp;x-signature=azUWDegf1tOZvjlUzvOLgPkbnnc%3D" alt="图片" loading="lazy"/></p>
<p>具体来看，Python 驱动了近一半的新增 AI 仓库（582,196 个；同比增长 50.7%），突显了它作为应用型 AI 工作（从训练、推理到编排和部署）的支柱地位。Jupyter Notebook 依旧是用于实验的首选探索性环境（402,643 个；同比增长 17.8%），但（贡献者）向 Python 代码库的转移表明，有更多项目正在摆脱原型阶段，进入生产技术栈。</p>
<p>前端和应用层语言在较小的基数上实现了急剧增长：TypeScript 增长 77.9%（85,746 个）和 JavaScript 增长 24.8%（88,023 个）。</p>
<p>这表明围绕模型 API 接口（model endpoints）构建的演示、仪表盘和轻量级应用正在崛起。</p>
<p>Shell 脚本（+324%）成为增长最快的类别，反映了团队如何将评估工具、数据准备和部署流程代码化。C++ 则跨越了 7,800 个仓库（+11%），稳步提醒着人们它在性能攸关的推理引擎、运行时和近硬件（hardware-close）系统中所扮演的角色。</p>
<p>其它趋势和要点</p>
<p>GitHub 还在报告中总结了其它一些趋势和要点。</p>
<p>今年，开源开发活动达到了创纪录的水平，公共仓库的贡献总量达到了 11.2 亿次（同比增长 13%）。2025 年 3 月是 GitHub 历史上新增开源贡献者数量最多的一个月。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/972ce7ee040e4209ae61732281bb83dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543078&amp;x-signature=0YT7Ip2cUJTj2%2BwDn6sy%2BZraIZg%3D" alt="图片" loading="lazy"/></p>
<p>印度增长迅猛，该国在 2025 年新增了超过 520 万名开发者，占 GitHub 2025 年新增 3600 万开发者总数的 14% 以上。这使得印度成为今年 GitHub 上新增开发者的最大单一来源国，延续了其自 2020 年以来的迅猛增长势头。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/044518fb4b7f4293a3dc007e03032572~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543078&amp;x-signature=5ZKOxe7VelgOa6b%2BPBeowWCm1Ro%3D" alt="图片" loading="lazy"/></p>
<p>企业级技术栈保持稳固。Java 和 C# 今年的贡献者均增长了超过 10 万人，这表明即便 AI 正在重塑整个行业格局，它们在大型企业和游戏开发（game-dev）环境中的增长依旧稳定。</p>
<p>旧语言的实验性项目涌现。COBOL 语言也出现在 GitHub 的数据集中，拥有近 3,000 名活跃开发者。这很可能是由一些组织和爱好者所推动的，他们创建了许多 AI 辅助的教程仓库，旨在帮助实现遗留代码库的现代化。</p>
<p>性能和系统语言正随 AI 崛起（但增长不均）。C 语言同比增长约 20.9%，C++ 同比增长约 11.8%，这反映了市场对更快的运行时、推理引擎和硬件优化 Loop 的需求。</p>
<p>生成式 AI 正日益成为基础设施。现在有超过 110 万个公开仓库导入了 LLM SDK（同比增长 178%，对比 2025 年 8 月与 2024 年 8 月），由超过 105 万名贡献者支持，月度提交量（monthly commits）达到 175 万次（自 2023 年以来增长了 4.8 倍）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c478c4418f7414ca293723326c08c1a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543078&amp;x-signature=8bz9rgrZ86oy4l%2FqDFwJ7AWdfv0%3D" alt="图片" loading="lazy"/></p>
<p>AI 在开源领域的应用。半数（50%）的开源项目至少有一名维护者（maintainer）在使用 GitHub Copilot。</p>
<p>.NET 保持强劲。 C# 同比增长约 10.6%，与企业级和游戏 / 工具生态系统的（增长）保持一致。这表明 AI 功能正被集成到现有的 .NET 工作流中，而不是在驱动（开发者）进行彻底的语言转移。</p>
<p>增长最快的语言是 Luau。Luau 是 Roblox 的脚本语言，也是一个逐步类型化的语言，体现了整个行业向「类型灵活性」发展的趋势。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f0865434aae4981aca662a27f42720c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543078&amp;x-signature=QDk0hQCwE%2FYj7zsfQyFymrIYd40%3D" alt="图片" loading="lazy"/></p>
<p>可复现性和依赖清洁（dependency hygiene）备受关注。 astral-sh/uv 和 NixOS/nixpkgs 的崛起，表明开发者对确定性构建（deterministic builds）、更快的安装速度以及直接运行的渴望。</p>
<p>以性能为中心的开发者工具赢得关注。 Ghostty、Tailwind CSS 和 uv 的共同点都是关于速度、紧凑的反馈循环和最小化的（开发）阻力。</p>
<p>更多详情请参阅原报告：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca37bce31fe84f9e93b46b3cce384bed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543078&amp;x-signature=iJ%2BW%2B7k9Qs8wqPnDl6y%2BnG7EEAk%3D" alt="图片" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.blog%2Fnews-insights%2Foctoverse%2Foctoverse-a-new-developer-joins-github-every-second-as-ai-leads-typescript-to-1%2F" target="_blank" title="https://github.blog/news-insights/octoverse/octoverse-a-new-developer-joins-github-every-second-as-ai-leads-typescript-to-1/" ref="nofollow noopener noreferrer">github.blog/news-insigh…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[最新MCP规范解读，看这篇就够了！]]></title>    <link>https://juejin.cn/post/7571456639477006346</link>    <guid>https://juejin.cn/post/7571456639477006346</guid>    <pubDate>2025-11-12T07:59:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571456639477006346" data-draft-id="7571416207972499506" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="最新MCP规范解读，看这篇就够了！"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-11-12T07:59:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            最新MCP规范解读，看这篇就够了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T07:59:53.000Z" title="Wed Nov 12 2025 07:59:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读26分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、MCP是什么? 为什么需要它?</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d67c9ad979a2434989229286027f7185~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763539193&amp;x-signature=AvWJDuUolC0sslAql0%2FE8bjN4jg%3D" alt="" loading="lazy"/><br/>
想象一下，你正在开发一个 AI 编程助手，它需要:</p>
<ul>
<li>读取和修改项目文件</li>
<li>查询数据库Schema</li>
<li>搜索代码仓库</li>
<li>执行Git操作</li>
</ul>
<p>传统做法是为每个数据源写一套专用代码，不同团队重复造轮子。<strong>Model Context Protocol(MCP)</strong> 就是为了解决这个问题而生的开放标准协议。</p>
<p><strong>通俗理解</strong>: MCP就像是「AI应用的USB接口标准」。就像USB让不同设备都能接入电脑一样，MCP让不同的数据源和工具都能以统一方式接入AI应用。</p>
<p><strong>实际案例</strong>: 在Claude Desktop中，你可以配置多个官方MCP服务器:</p>
<ul>
<li><strong>Filesystem服务器</strong>: 安全地读写本地文件，有权限控制</li>
<li><strong>SQLite服务器</strong>: 查询和分析SQLite数据库，自动生成SQL</li>
<li><strong>GitHub服务器</strong>: 搜索仓库、创建Issue、管理PR</li>
</ul>
<p>你的AI应用只需实现一个MCP客户端，就能连接所有服务器，无需为每个服务器写专用代码。</p>
<h2 data-id="heading-1">二、架构设计： 三个角色的分工</h2>
<p>MCP采用<strong>宿主-客户端-服务器</strong>三层架构，就像一家公司的组织结构:</p>
<p><strong>宿主(Host)</strong> = 总经理</p>
<ul>
<li>管理所有客户端</li>
<li>控制安全策略和权限</li>
<li>负责AI模型的调用</li>
</ul>
<p><strong>客户端(Client)</strong> = 部门经理</p>
<ul>
<li>客户端负责连接服务器</li>
<li>负责双方的沟通协调</li>
<li>转发消息和通知</li>
</ul>
<p><strong>服务器(Server)</strong> = 业务专员</p>
<ul>
<li>提供具体功能(资源、工具、提示模板)</li>
<li>可以是本地程序或远程服务</li>
<li>不知道其他服务器的存在</li>
</ul>
<h2 data-id="heading-2">三、协议约定：统一规范与个性化扩展</h2>
<p><strong>每个MCP服务器提供的工具、资源都不一样，但它们都遵循相同的MCP协议规范。</strong></p>
<h3 data-id="heading-3">3.1 协议的分层设计</h3>
<p>MCP采用 <strong>基础协议 + 功能扩展</strong> 的设计，就像HTTP协议一样:</p>
<p><strong>核心层(所有实现必须支持)</strong> :</p>
<ul>
<li>JSON-RPC 2.0消息格式</li>
<li>初始化握手流程(initialize/initialized)</li>
<li>基本错误处理</li>
</ul>
<p><strong>功能层(按需选择)</strong> :</p>
<ul>
<li>Resources、Prompts、Tools(服务器端)</li>
<li>Roots、Sampling、Elicitation(客户端)</li>
</ul>
<p><strong>这样设计的好处</strong>:</p>
<pre><code class="hljs language-markdown" lang="markdown">统一的基础协议 → 保证互操作性
<span class="hljs-bullet">     +</span>
灵活的功能选择 → 满足不同场景需求
<span class="hljs-code">     ↓
既标准化又可扩展
</span></code></pre>
<h3 data-id="heading-4">3.2 协议约定的过程</h3>
<p><strong>步骤1: 基础协议是固定的</strong><br/>
所有MCP服务器和客户端都遵循相同的JSON-RPC 2.0格式:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 请求格式(固定)</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>      <span class="hljs-comment">// 必须是2.0</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>                <span class="hljs-comment">// 唯一标识</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"方法名"</span><span class="hljs-punctuation">,</span>     <span class="hljs-comment">// 要调用的方法</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>...<span class="hljs-punctuation">}</span>         <span class="hljs-comment">// 参数对象</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// 响应格式(固定)</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>                <span class="hljs-comment">// 对应请求的ID</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>...<span class="hljs-punctuation">}</span>         <span class="hljs-comment">// 成功结果</span>
  <span class="hljs-comment">// 或 "error": {...}    // 错误信息</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>步骤2: 能力在初始化时协商</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 客户端发起初始化</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"initialize"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"capabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"sampling"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>       <span class="hljs-comment">// 我支持LLM采样</span>
      <span class="hljs-attr">"roots"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>           <span class="hljs-comment">// 我支持根目录</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"clientInfo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MyClient"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// 服务器响应</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"capabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>          <span class="hljs-comment">// 我提供工具</span>
      <span class="hljs-attr">"resources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>       <span class="hljs-comment">// 我提供资源</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"serverInfo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"SQLiteServer"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>协商完成后，双方都知道对方支持什么功能，<strong>只使用交集部分</strong>。</p>
<p><strong>步骤3: 方法名称是标准化的</strong><br/>
MCP规范定义了标准方法名:</p>








































<table><thead><tr><th>功能</th><th>方法名</th><th>说明</th></tr></thead><tbody><tr><td>列出资源</td><td><code>resources/list</code></td><td>固定方法名</td></tr><tr><td>读取资源</td><td><code>resources/read</code></td><td>固定方法名</td></tr><tr><td>列出工具</td><td><code>tools/list</code></td><td>固定方法名</td></tr><tr><td>调用工具</td><td><code>tools/call</code></td><td>固定方法名</td></tr><tr><td>列出提示</td><td><code>prompts/list</code></td><td>固定方法名</td></tr><tr><td>获取提示</td><td><code>prompts/get</code></td><td>固定方法名</td></tr></tbody></table>
<p><strong>步骤4: 具体内容是个性化的</strong><br/>
虽然方法名固定，但每个服务器返回的<strong>具体数据</strong>不同:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// SQLite服务器的工具</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"query"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"执行SQL查询"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"list_tables"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"列出所有表"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// Filesystem服务器的工具</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"read_file"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"读取文件"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"write_file"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"写入文件"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"search_files"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"搜索文件"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-5">3.3 协议发现机制</h3>
<p>客户端如何知道服务器有哪些工具?</p>
<p><strong>第一步：列举</strong></p>
<pre><code class="hljs language-css" lang="css">客户端 → 服务器: {"method": <span class="hljs-string">"tools/list"</span>}
服务器 → 客户端: {
  "tools": [
    {
      "name": <span class="hljs-string">"query"</span>,
      <span class="hljs-string">"description"</span>: <span class="hljs-string">"执行SQL查询"</span>,
      <span class="hljs-string">"inputSchema"</span>: {           // JSON Schema定义输入格式
        "type": <span class="hljs-string">"object"</span>,
        <span class="hljs-string">"properties"</span>: {
          "sql": {"type": <span class="hljs-string">"string"</span>}
        }
      }
    }
  ]
}
</code></pre>
<p><strong>第二步：调用</strong></p>
<pre><code class="hljs language-json" lang="json">客户端 → 服务器<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tools/call"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"query"</span><span class="hljs-punctuation">,</span>           <span class="hljs-comment">// 使用第一步获得的工具名</span>
    <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"sql"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"SELECT * FROM users"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>关键点</strong>:通过JSON Schema，客户端知道如何正确调用工具，无需硬编码。</p>
<h2 data-id="heading-6">四、协议基础：如何通信?</h2>
<p>MCP基于JSON-RPC 2.0构建，这是一个成熟的远程过程调用协议。理解这一层对掌握MCP至关重要。</p>
<h3 data-id="heading-7">4.1 JSON-RPC 2.0基础</h3>
<p><strong>消息类型</strong></p>
<p>MCP中有三种基本消息类型。<br/>
<strong>1. 请求(Request)</strong> - 期待响应</p>
<pre><code class="hljs language-perl" lang="perl">{
  <span class="hljs-string">"jsonrpc"</span>: <span class="hljs-string">"2.0"</span>,           <span class="hljs-regexp">//</span> 协议版本,必须是<span class="hljs-string">"2.0"</span>
  <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,                     <span class="hljs-regexp">//</span> 请求唯一标识(字符串或数字)
  <span class="hljs-string">"method"</span>: <span class="hljs-string">"tools/list"</span>,     <span class="hljs-regexp">//</span> 要调用的方法名
  <span class="hljs-string">"params"</span>: {                  <span class="hljs-regexp">//</span> 可选的参数对象
    <span class="hljs-string">"cursor"</span>: <span class="hljs-string">"page2"</span>
  }
}
</code></pre>
<p><strong>2. 响应(Response)</strong> - 对请求的回复</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 成功响应</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>                     <span class="hljs-comment">// 必须与请求的id相同</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                  <span class="hljs-comment">// 成功结果</span>
    <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"query"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"执行查询"</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// 错误响应</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"error"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                   <span class="hljs-comment">// 错误对象</span>
    <span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">-32602</span><span class="hljs-punctuation">,</span>            <span class="hljs-comment">// 错误码(整数)</span>
    <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"参数无效"</span><span class="hljs-punctuation">,</span>      <span class="hljs-comment">// 错误描述</span>
    <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                  <span class="hljs-comment">// 可选的额外信息</span>
      <span class="hljs-attr">"field"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cursor"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"reason"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"格式错误"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>3. 通知(Notification)</strong> - 单向消息,无需响应</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"notifications/resources/updated"</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 通知方法名</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                                   <span class="hljs-comment">// 通知参数</span>
    <span class="hljs-attr">"uri"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file:///project/data.json"</span>
  <span class="hljs-punctuation">}</span>
  <span class="hljs-comment">// 注意:没有id字段</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>标准错误码</strong></p>
<p>MCP使用JSON-RPC 2.0的标准错误码:</p>








































<table><thead><tr><th>错误码</th><th>含义</th><th>说明</th></tr></thead><tbody><tr><td>-32700</td><td>Parse error</td><td>JSON解析错误</td></tr><tr><td>-32600</td><td>Invalid Request</td><td>无效的请求格式</td></tr><tr><td>-32601</td><td>Method not found</td><td>方法不存在</td></tr><tr><td>-32602</td><td>Invalid params</td><td>参数无效</td></tr><tr><td>-32603</td><td>Internal error</td><td>服务器内部错误</td></tr><tr><td>-32002</td><td>Resource not found</td><td>资源未找到(MCP扩展)</td></tr></tbody></table>
<h3 data-id="heading-8">4.2 能力协商详解</h3>
<p>能力协商是MCP连接建立的第一步，决定了整个会话中可用的功能。</p>
<p><strong>初始化流程详解</strong></p>
<p><strong>阶段1: 客户端发起初始化</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"initialize"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 客户端支持的协议版本</span>
    <span class="hljs-attr">"capabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                  <span class="hljs-comment">// 客户端能力声明</span>
      <span class="hljs-attr">"roots"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                       <span class="hljs-comment">// 支持根目录</span>
        <span class="hljs-attr">"listChanged"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>            <span class="hljs-comment">// 支持根目录变更通知</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"sampling"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>                  <span class="hljs-comment">// 支持LLM采样</span>
      <span class="hljs-attr">"elicitation"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>               <span class="hljs-comment">// 支持用户询问</span>
      <span class="hljs-attr">"experimental"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                <span class="hljs-comment">// 实验性功能</span>
        <span class="hljs-attr">"customFeature"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>            <span class="hljs-comment">// 自定义功能</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"clientInfo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                    <span class="hljs-comment">// 客户端信息</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MyAIApp"</span><span class="hljs-punctuation">,</span>               <span class="hljs-comment">// 程序名(必填)</span>
      <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.2.0"</span><span class="hljs-punctuation">,</span>              <span class="hljs-comment">// 版本号(必填)</span>
      <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"我的AI应用"</span>             <span class="hljs-comment">// 显示名称(可选)</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>阶段2: 服务器响应能力</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 服务器选择的协议版本</span>
    <span class="hljs-attr">"capabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                  <span class="hljs-comment">// 服务器能力声明</span>
      <span class="hljs-attr">"resources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                   <span class="hljs-comment">// 支持资源</span>
        <span class="hljs-attr">"subscribe"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>             <span class="hljs-comment">// 支持资源订阅</span>
        <span class="hljs-attr">"listChanged"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>            <span class="hljs-comment">// 支持资源列表变更通知</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                       <span class="hljs-comment">// 支持工具</span>
        <span class="hljs-attr">"listChanged"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"prompts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                     <span class="hljs-comment">// 支持提示模板</span>
        <span class="hljs-attr">"listChanged"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>           <span class="hljs-comment">// 不支持列表变更通知</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"logging"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>                    <span class="hljs-comment">// 支持日志输出</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"serverInfo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                    <span class="hljs-comment">// 服务器信息</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sqlite-mcp-server"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.1.0"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"SQLite MCP服务器"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"instructions"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"此服务器提供SQLite数据库访问能力"</span>  <span class="hljs-comment">// 可选的使用说明</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>阶段3: 客户端确认就绪</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"notifications/initialized"</span>  <span class="hljs-comment">// 无id,这是通知</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>协议版本协商规则</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">客户端请求版本: <span class="hljs-string">"2024-11-05"</span>
         ↓
    服务器支持?
    ↙        ↘
  支持        不支持
   ↓            ↓
返回相同版本  返回服务器支持的最新版本
   ↓            ↓
协商成功    客户端检查是否支持
              ↙        ↘
           支持        不支持
            ↓            ↓
         协商成功     断开连接
</code></pre>
<p><strong>实际示例</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 场景1: 版本匹配</span>
客户端<span class="hljs-punctuation">:</span> <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span>
服务器<span class="hljs-punctuation">:</span> <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span>  ✅ 成功

<span class="hljs-comment">// 场景2: 服务器版本更新</span>
客户端<span class="hljs-punctuation">:</span> <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-06-01"</span>
服务器<span class="hljs-punctuation">:</span> <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span>  
→ 客户端检查是否支持<span class="hljs-number">2024</span><span class="hljs-number">-11</span><span class="hljs-number">-05</span> → 如果不支持则断开

<span class="hljs-comment">// 场景3: 客户端版本更新</span>
客户端<span class="hljs-punctuation">:</span> <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-01-01"</span>
服务器<span class="hljs-punctuation">:</span> <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span>  
→ 客户端检查是否支持<span class="hljs-number">2024</span><span class="hljs-number">-11</span><span class="hljs-number">-05</span> → 如果支持则降级使用
</code></pre>
<p><strong>能力交集计算</strong></p>
<p>初始化后,双方只能使用<strong>共同支持的能力</strong>:</p>
<pre><code class="hljs language-css" lang="css">客户端能力: {roots, sampling, elicitation}
服务器能力: {resources, tools, prompts}
         ↓
   可用功能集合
   ├─ 客户端 → 服务器: resources, tools, prompts
   └─ 服务器 → 客户端: roots, sampling, elicitation
</code></pre>
<p><strong>示例</strong>:</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 客户端代码示例</span>
<span class="hljs-keyword">if</span> server_capabilities.<span class="hljs-keyword">get</span>(<span class="hljs-string">"tools"</span>):
    <span class="hljs-meta"># 服务器支持工具,可以调用</span>
    tools = <span class="hljs-keyword">await</span> session.list_tools()
<span class="hljs-keyword">else</span>:
    <span class="hljs-meta"># 服务器不支持工具,跳过</span>
    print(<span class="hljs-string">"服务器不提供工具功能"</span>)

<span class="hljs-keyword">if</span> client_capabilities.<span class="hljs-keyword">get</span>(<span class="hljs-string">"sampling"</span>):
    <span class="hljs-meta"># 客户端支持采样,服务器可以请求</span>
    <span class="hljs-meta"># (服务器端会检查这个能力)</span>
    pass
</code></pre>
<h3 data-id="heading-9">4.3 连接生命周期深入</h3>
<p><strong>完整的消息时序图</strong></p>
<pre><code class="hljs language-scss" lang="scss">客户端                                            服务器
  │                                              │
  │  <span class="hljs-number">1</span>. initialize (请求)                         │
  ├──────────────────────────────────────&gt;│
  │     {protocolVersion, capabilities}          │
  │                                              │
  │  <span class="hljs-number">2</span>. initialize (响应)                         │
  │&lt;──────────────────────────────────────┤
  │     {protocolVersion, capabilities}          │
  │                                              │
  │  <span class="hljs-number">3</span>. initialized (通知)                        │ 
  ├──────────────────────────────────────&gt;│
  │                                              │
  │═══════════ 正常操作阶段 ════════════        │
  │                                              │
  │  <span class="hljs-number">4</span>. tools/list (请求)                         │
  ├──────────────────────────────────────&gt;│
  │                                              │
  │  <span class="hljs-number">5</span>. tools/list (响应)                         │
  │&lt;──────────────────────────────────────┤
  │     {tools: [...]}                           │
  │                                              │
  │  <span class="hljs-number">6</span>. tools/call (请求)                         │
  ├──────────────────────────────────────&gt;│
  │     {name: <span class="hljs-string">"query"</span>, arguments: {...}}        │
  │                                              │
  │  <span class="hljs-number">7</span>. notifications/progress (通知)             │
  │&lt;──────────────────────────────────────┤
  │     {progress: <span class="hljs-number">50</span>, total: <span class="hljs-number">100</span>}               │
  │                                              │
  │  <span class="hljs-number">8</span>. tools/call (响应)                         │
  │&lt;──────────────────────────────────────┤
  │     {<span class="hljs-attribute">content</span>: [...]}                         │
  │                                              │
  │  <span class="hljs-number">9</span>. notifications/resources/updated          │
  │&lt;──────────────────────────────────────┤
  │     {uri: <span class="hljs-string">"file://..."</span>}                      │
  │                                              │
  │═══════════ 关闭阶段 ═══════════           │
  │                                              │
  │  <span class="hljs-number">10</span>. 关闭stdin                               │
  ├─────────────X                             │
  │                                             │
  │                                          服务器退出
</code></pre>
<p><strong>初始化前的限制</strong></p>
<p>在<code>initialized</code>通知发送前:</p>
<p><strong>客户端只能发送</strong>:</p>
<ul>
<li>✅ <code>initialize</code>请求</li>
<li>✅ <code>ping</code>请求(用于保活)</li>
<li>❌ 其他任何请求</li>
</ul>
<p><strong>服务器只能发送</strong>:</p>
<ul>
<li>✅ <code>initialize</code>响应</li>
<li>✅ <code>ping</code>请求</li>
<li>✅ <code>logging</code>通知(日志)</li>
<li>❌ 其他任何消息</li>
</ul>
<p><strong>违反限制的后果</strong>:</p>
<pre><code class="hljs language-css" lang="css">// 客户端在初始化前调用tools/list
请求: {"method": <span class="hljs-string">"tools/list"</span>}
响应: {
  "error": {
    "<span class="hljs-selector-tag">code</span>": -<span class="hljs-number">32600</span>,
    <span class="hljs-string">"message"</span>: <span class="hljs-string">"会话未初始化"</span>
  }
}
</code></pre>
<p><strong>超时和重试机制</strong></p>
<p><strong>请求超时</strong>:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> asyncio

<span class="hljs-comment"># 设置30秒超时</span>
<span class="hljs-keyword">try</span>:
    result = <span class="hljs-keyword">await</span> asyncio.wait_for(
        session.call_tool(<span class="hljs-string">"slow_operation"</span>, {}),
        timeout=<span class="hljs-number">30.0</span>
    )
<span class="hljs-keyword">except</span> asyncio.TimeoutError:
    <span class="hljs-comment"># 发送取消通知</span>
    <span class="hljs-keyword">await</span> session.send_notification(
        <span class="hljs-string">"notifications/cancelled"</span>,
        {<span class="hljs-string">"requestId"</span>: <span class="hljs-string">"123"</span>, <span class="hljs-string">"reason"</span>: <span class="hljs-string">"超时"</span>}
    )
</code></pre>
<p><strong>进度通知重置超时</strong>:</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 当收到进度通知时,可以重置超时计时器</span>
<span class="hljs-attr">timeout</span> = <span class="hljs-number">30</span>  <span class="hljs-comment"># 基础超时</span>
<span class="hljs-attr">max_timeout</span> = <span class="hljs-number">300</span>  <span class="hljs-comment"># 最大超时(5分钟)</span>

while True:
    try:
        <span class="hljs-attr">msg</span> = await wait_for_message(timeout)
        if <span class="hljs-attr">msg.method</span> == <span class="hljs-string">"notifications/progress"</span>:
            <span class="hljs-comment"># 收到进度,重置超时</span>
            <span class="hljs-attr">timeout</span> = <span class="hljs-number">30</span>
    except TimeoutError:
        <span class="hljs-comment"># 超时处理</span>
        break
</code></pre>
<h3 data-id="heading-10">4.4 传输方式对比</h3>
<p><strong>stdio传输详解</strong></p>
<p><strong>优点</strong>:</p>
<ul>
<li>✅ 简单直接,适合本地开发</li>
<li>✅ 进程隔离,安全性好</li>
<li>✅ 自动管理生命周期</li>
<li>✅ 无需网络配置</li>
</ul>
<p><strong>缺点</strong>:</p>
<ul>
<li>❌ 只能本地使用</li>
<li>❌ 不支持多客户端</li>
<li>❌ 调试相对困难</li>
</ul>
<p><strong>消息格式</strong>:</p>
<pre><code class="hljs">消息1\n
消息2\n
消息3\n
</code></pre>
<p>每个JSON对象占一行,以<code>\n</code>分隔。</p>
<p><strong>HTTP传输详解</strong></p>
<p><strong>架构</strong>:</p>
<pre><code class="hljs language-bash" lang="bash">┌─────────┐         HTTP POST         ┌─────────┐
│         ├──────────────────────────&gt;│         │
│ 客户端  │  请求/通知/响应(JSON-RPC) │ 服务器  │
│         │&lt;──────────────────────────┤         │
└─────────┘     HTTP 响应/SSE流       └─────────┘
             (application/json 或
              text/event-stream)
</code></pre>
<p><strong>发送消息(POST)</strong> :</p>
<pre><code class="hljs language-bash" lang="bash">POST /mcp HTTP/1.1
Host: localhost:8080
Content-Type: application/json
Accept: application/json, text/event-stream
Mcp-Session-Id: abc123

{<span class="hljs-string">"jsonrpc"</span>:<span class="hljs-string">"2.0"</span>,<span class="hljs-string">"id"</span>:1,<span class="hljs-string">"method"</span>:<span class="hljs-string">"tools/list"</span>}
</code></pre>
<p><strong>立即响应(JSON)</strong> :</p>
<pre><code class="hljs language-css" lang="css">HTTP/<span class="hljs-number">1.1</span> <span class="hljs-number">200</span> OK
<span class="hljs-attribute">Content</span>-Type: application/json

{"jsonrpc":<span class="hljs-string">"2.0"</span>,<span class="hljs-string">"id"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"result"</span>:{"tools":[...]}}
</code></pre>
<p><strong>流式响应(SSE)</strong> :</p>
<pre><code class="hljs language-vbnet" lang="vbnet">HTTP/<span class="hljs-number">1.1</span> <span class="hljs-number">200</span> OK
Content-Type: <span class="hljs-keyword">text</span>/<span class="hljs-keyword">event</span>-stream
Mcp-Session-Id: abc123

<span class="hljs-symbol">id:</span> <span class="hljs-number">1</span>
<span class="hljs-symbol">data:</span> {<span class="hljs-string">"jsonrpc"</span>:<span class="hljs-string">"2.0"</span>,<span class="hljs-string">"method"</span>:<span class="hljs-string">"notifications/progress"</span>,<span class="hljs-string">"params"</span>:{<span class="hljs-string">"progress"</span>:<span class="hljs-number">25</span>}}

<span class="hljs-symbol">id:</span> <span class="hljs-number">2</span>  
<span class="hljs-symbol">data:</span> {<span class="hljs-string">"jsonrpc"</span>:<span class="hljs-string">"2.0"</span>,<span class="hljs-string">"method"</span>:<span class="hljs-string">"notifications/progress"</span>,<span class="hljs-string">"params"</span>:{<span class="hljs-string">"progress"</span>:<span class="hljs-number">50</span>}}

<span class="hljs-symbol">id:</span> <span class="hljs-number">3</span>
<span class="hljs-symbol">data:</span> {<span class="hljs-string">"jsonrpc"</span>:<span class="hljs-string">"2.0"</span>,<span class="hljs-string">"id"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"result"</span>:{<span class="hljs-string">"content"</span>:[...]}}
</code></pre>
<p><strong>接收服务器消息(GET)</strong> :</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">GET</span> /mcp HTTP/<span class="hljs-number">1.1</span>
<span class="hljs-symbol">Host:</span> localhost:<span class="hljs-number">8080</span>
<span class="hljs-symbol">Accept:</span> <span class="hljs-keyword">text</span>/<span class="hljs-keyword">event</span>-stream
Mcp-Session-Id: abc123
Last-<span class="hljs-keyword">Event</span>-ID: <span class="hljs-number">42</span>
</code></pre>
<p><strong>会话管理</strong>:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 服务器端设置会话ID</span>
<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/mcp"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_mcp</span>(<span class="hljs-params">request</span>):
    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">"initialize"</span>:
        session_id = generate_session_id()
        <span class="hljs-keyword">return</span> Response(
            content=json.dumps(result),
            headers={<span class="hljs-string">"Mcp-Session-Id"</span>: session_id}
        )

<span class="hljs-comment"># 客户端后续请求携带会话ID</span>
<span class="hljs-meta">@client.request</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">send_request</span>(<span class="hljs-params">method, params</span>):
    headers = {}
    <span class="hljs-keyword">if</span> self.session_id:
        headers[<span class="hljs-string">"Mcp-Session-Id"</span>] = self.session_id
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> http.post(
        <span class="hljs-string">"/mcp"</span>,
        json={<span class="hljs-string">"jsonrpc"</span>: <span class="hljs-string">"2.0"</span>, <span class="hljs-string">"method"</span>: method, <span class="hljs-string">"params"</span>: params},
        headers=headers
    )
</code></pre>
<p><strong>断线重连</strong>:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">connect_sse</span>(<span class="hljs-params">last_event_id=<span class="hljs-literal">None</span></span>):
    headers = {<span class="hljs-string">"Accept"</span>: <span class="hljs-string">"text/event-stream"</span>}
    <span class="hljs-keyword">if</span> last_event_id:
        headers[<span class="hljs-string">"Last-Event-ID"</span>] = last_event_id
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> httpx.stream(<span class="hljs-string">"GET"</span>, <span class="hljs-string">"/mcp"</span>, headers=headers) <span class="hljs-keyword">as</span> stream:
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> stream.aiter_lines():
            <span class="hljs-keyword">if</span> line.startswith(<span class="hljs-string">"id:"</span>):
                last_event_id = line[<span class="hljs-number">3</span>:].strip()
            <span class="hljs-keyword">elif</span> line.startswith(<span class="hljs-string">"data:"</span>):
                data = json.loads(line[<span class="hljs-number">5</span>:])
                <span class="hljs-keyword">yield</span> data, last_event_id
</code></pre>
<h3 data-id="heading-11">4.5 实际通信示例</h3>
<p>让我们看一个完整的SQLite查询场景:</p>
<pre><code class="hljs language-css" lang="css">// <span class="hljs-number">1</span>. 列出工具
客户端 → 服务器:
{
  "jsonrpc": <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,
  <span class="hljs-string">"method"</span>: <span class="hljs-string">"tools/list"</span>
}

服务器 → 客户端:
{
  "jsonrpc": <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,
  <span class="hljs-string">"result"</span>: {
    "tools": [
      {
        "name": <span class="hljs-string">"query"</span>,
        <span class="hljs-string">"description"</span>: <span class="hljs-string">"执行SQL查询"</span>,
        <span class="hljs-string">"inputSchema"</span>: {
          "type": <span class="hljs-string">"object"</span>,
          <span class="hljs-string">"properties"</span>: {
            "sql": {"type": <span class="hljs-string">"string"</span>}
          },
          "required": [<span class="hljs-string">"sql"</span>]
        }
      }
    ]
  }
}

// <span class="hljs-number">2</span>. 调用查询工具
客户端 → 服务器:
{
  "jsonrpc": <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"method"</span>: <span class="hljs-string">"tools/call"</span>,
  <span class="hljs-string">"params"</span>: {
    "name": <span class="hljs-string">"query"</span>,
    <span class="hljs-string">"arguments"</span>: {
      "sql": <span class="hljs-string">"SELECT COUNT(*) FROM users WHERE active = 1"</span>
    },
    "_meta": {
      "progressToken": <span class="hljs-string">"query-123"</span>  // 请求进度通知
    }
  }
}

// <span class="hljs-number">3</span>. 服务器发送进度(异步通知)
服务器 → 客户端:
{
  "jsonrpc": <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"method"</span>: <span class="hljs-string">"notifications/progress"</span>,
  <span class="hljs-string">"params"</span>: {
    "progressToken": <span class="hljs-string">"query-123"</span>,
    <span class="hljs-string">"progress"</span>: <span class="hljs-number">50</span>,
    <span class="hljs-string">"total"</span>: <span class="hljs-number">100</span>,
    <span class="hljs-string">"message"</span>: <span class="hljs-string">"正在扫描users表..."</span>
  }
}

// <span class="hljs-number">4</span>. 返回查询结果
服务器 → 客户端:
{
  "jsonrpc": <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"result"</span>: {
    "<span class="hljs-attribute">content</span>": [
      {
        "type": <span class="hljs-string">"text"</span>,
        <span class="hljs-string">"text"</span>: <span class="hljs-string">"查询结果: 1,234个活跃用户"</span>
      }
    ],
    "isError": false
  }
}

// <span class="hljs-number">5</span>. 如果查询出错
服务器 → 客户端(错误情况):
{
  "jsonrpc": <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"error"</span>: {
    "<span class="hljs-selector-tag">code</span>": -<span class="hljs-number">32603</span>,
    <span class="hljs-string">"message"</span>: <span class="hljs-string">"SQL语法错误"</span>,
    <span class="hljs-string">"data"</span>: {
      "sql": <span class="hljs-string">"SELECT COUNT(*) FROM users WHERE active = 1"</span>,
      <span class="hljs-string">"error"</span>: <span class="hljs-string">"near "</span>WHERE<span class="hljs-string">": syntax error"</span>,
      <span class="hljs-string">"position"</span>: <span class="hljs-number">35</span>
    }
  }
}
</code></pre>
<p>这就是MCP通信的完整过程!通过JSON-RPC 2.0，客户端和服务器可以进行结构化、类型安全的通信。</p>
<h2 data-id="heading-12">五、服务器能力：三种核心功能</h2>
<p>MCP服务器可以提供三种功能。</p>
<h3 data-id="heading-13">5.1 Resources(资源)：应用决定用什么</h3>
<p><strong>资源就是数据</strong>，比如文件内容、数据库记录、API响应。</p>
<p><strong>谁控制</strong>: 应用程序决定把哪些资源提供给AI</p>
<p><strong>如何使用</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 列出所有可用资源</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"resources/list"</span><span class="hljs-punctuation">}</span>

<span class="hljs-comment">// 读取某个资源</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"resources/read"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"uri"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file:///project/main.py"</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>资源URI示例</strong>:</p>
<ul>
<li><code>file:///project/src/main.py</code> - 文件</li>
<li><code>db://schema/users</code> - 数据库表结构</li>
<li><code>git://commits/main</code> - Git提交历史</li>
<li><code>https://api.example.com/data</code> - Web API</li>
</ul>
<p><strong>订阅变更</strong>: 可以订阅资源,当它变化时自动收到通知。</p>
<p><strong>实际案例</strong>: Filesystem服务器暴露资源</p>
<pre><code class="hljs language-swift" lang="swift">{
  <span class="hljs-string">"uri"</span>: <span class="hljs-string">"file:///Users/alice/project/src/main.py"</span>,  <span class="hljs-comment">// Python源文件</span>
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"main.py"</span>,                                  <span class="hljs-comment">// 文件名</span>
  <span class="hljs-string">"mimeType"</span>: <span class="hljs-string">"text/x-python"</span>,                        <span class="hljs-comment">// 文件类型</span>
  <span class="hljs-string">"text"</span>: <span class="hljs-string">"import os<span class="hljs-subst">\n</span>def main()..."</span>                  <span class="hljs-comment">// 文件内容</span>
}
</code></pre>
<p>客户端AI可以读取这个资源，理解代码结构后提供重构建议或生成测试。</p>
<h3 data-id="heading-14">5.2 Prompts(提示模板)：用户选择用什么</h3>
<p><strong>什么是Prompt?</strong></p>
<p>Prompt就像是「对话模板」或「快捷指令」，把常用的复杂指令预设好，用户一键调用。用生活中的例子类比，就像微信的「快捷回复」或IDE中的「代码片段(Snippet)」。</p>
<p><strong>为什么需要Prompt?</strong><br/>
场景1:没有Prompt时</p>
<pre><code class="hljs language-markdown" lang="markdown">用户每次都要输入:
"请分析这个Git仓库最近一周的提交,统计:
<span class="hljs-bullet">1.</span> 总提交次数
<span class="hljs-bullet">2.</span> 每个作者的贡献
<span class="hljs-bullet">3.</span> 修改的主要文件
<span class="hljs-bullet">4.</span> 是否有破坏性变更
请用表格格式输出"
</code></pre>
<p>场景2:有Prompt后</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">用户只需:</span>
1. 点击 <span class="hljs-string">"/analyze-commits"</span> 命令
2. 选择分支 <span class="hljs-string">"main"</span>
3. AI自动执行完整分析
</code></pre>
<p><strong>Prompt的数据结构</strong></p>
<p><strong>定义一个Prompt</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"analyze_commits"</span><span class="hljs-punctuation">,</span>              <span class="hljs-comment">// Prompt的唯一标识</span>
  <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"提交历史分析"</span><span class="hljs-punctuation">,</span>                  <span class="hljs-comment">// 用户界面显示的名称</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"分析Git提交并生成报告"</span><span class="hljs-punctuation">,</span>    <span class="hljs-comment">// 功能说明</span>
  <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>                          <span class="hljs-comment">// 需要的参数列表</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"branch"</span><span class="hljs-punctuation">,</span>                   <span class="hljs-comment">// 参数名</span>
      <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"要分析的分支名"</span><span class="hljs-punctuation">,</span>      <span class="hljs-comment">// 参数说明</span>
      <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>                    <span class="hljs-comment">// 是否必填</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"since"</span><span class="hljs-punctuation">,</span>                    <span class="hljs-comment">// 时间范围</span>
      <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"起始日期(如:7 days ago)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>                   <span class="hljs-comment">// 可选参数</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"author"</span><span class="hljs-punctuation">,</span>                   <span class="hljs-comment">// 作者过滤</span>
      <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"只看某个作者的提交"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>实际使用示例</strong></p>
<p><strong>步骤1: 列出所有可用的Prompt</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 客户端请求</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"prompts/list"</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// 服务器响应</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"prompts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"analyze_commits"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"📊 提交历史分析"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"分析指定分支的提交历史,生成统计报告"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"branch"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"since"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"review_code"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"🔍 代码审查"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"对代码进行质量审查和改进建议"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file_path"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"focus"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"explain_error"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"🐛 错误诊断"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"解释错误信息并提供修复建议"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"error_message"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>步骤2: 用户在界面上看到这些选项</strong></p>
<pre><code class="hljs language-bash" lang="bash">━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  可用命令:
  
  📊 /analyze-commits
     分析指定分支的提交历史
     
  🔍 /review-code  
     对代码进行质量审查
     
  🐛 /explain-error
     解释错误信息并修复
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
</code></pre>
<p><strong>步骤3: 用户选择并填写参数</strong></p>
<pre><code class="hljs language-ini" lang="ini">用户输入: /analyze-commits

系统弹窗:
┌─────────────────────────┐
│ 提交历史分析            │
├─────────────────────────┤
│ 分支名 *: <span class="hljs-section">[main      ]</span> │
│ 时间范围: <span class="hljs-section">[7 days ago]</span> │
│ 作者:     <span class="hljs-section">[          ]</span> │
│                         │
│      <span class="hljs-section">[取消]</span>  <span class="hljs-section">[确定]</span>     │
└─────────────────────────┘
</code></pre>
<p><strong>步骤4: 获取完整的Prompt内容</strong></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 客户端请求</span>
{
  <span class="hljs-string">"jsonrpc"</span>: <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"method"</span>: <span class="hljs-string">"prompts/get"</span>,
  <span class="hljs-string">"params"</span>: {
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"analyze_commits"</span>,       <span class="hljs-comment">// 使用哪个模板</span>
    <span class="hljs-string">"arguments"</span>: {                    <span class="hljs-comment">// 用户填写的参数</span>
      <span class="hljs-string">"branch"</span>: <span class="hljs-string">"main"</span>,
      <span class="hljs-string">"since"</span>: <span class="hljs-string">"7 days ago"</span>
    }
  }
}

<span class="hljs-comment">// 服务器响应 - 返回完整的对话消息</span>
{
  <span class="hljs-string">"jsonrpc"</span>: <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"result"</span>: {
    <span class="hljs-string">"description"</span>: <span class="hljs-string">"分析main分支最近7天的提交"</span>,
    <span class="hljs-string">"messages"</span>: [                     <span class="hljs-comment">// 发送给AI的完整对话</span>
      {
        <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,               <span class="hljs-comment">// 用户角色</span>
        <span class="hljs-string">"content"</span>: {
          <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
          <span class="hljs-string">"text"</span>: <span class="hljs-string">"请分析main分支在过去7天的Git提交历史。<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>需要统计:<span class="hljs-subst">\n</span>1. 总提交次数<span class="hljs-subst">\n</span>2. 每个作者的贡献次数和代码行数<span class="hljs-subst">\n</span>3. 主要修改的文件列表<span class="hljs-subst">\n</span>4. 是否包含breaking changes<span class="hljs-subst">\n</span>5. 提交消息的规范性<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>请用表格格式输出结果,并在最后给出改进建议。"</span>
        }
      }
    ]
  }
}
</code></pre>
<p><strong>步骤5: 客户端将消息发送给AI</strong></p>
<pre><code class="hljs language-bash" lang="bash">用户看到AI正在分析...

AI返回:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 main分支提交分析报告(最近7天)

总提交次数: 23

作者贡献统计:
┌────────────┬────────┬──────────┐
│ 作者       │ 提交数 │ 代码行数  │
├────────────┼────────┼──────────┤
│ Alice      │   12   │  +543/-89│
│ Bob        │    8   │  +234/-45│
│ Charlie    │    3   │  +123/-12│
└────────────┴────────┴──────────┘

主要修改文件:
- src/api/users.py (8次修改)
- src/models/user.py (5次修改)
- tests/test_user.py (4次修改)

Breaking Changes: 无

提交规范性: 良好 (91%符合Conventional Commits)

改进建议:
1. 建议增加单元测试覆盖率
2. 部分提交消息过于简短
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
</code></pre>
<p><strong>Prompt的内容类型</strong></p>
<p>Prompt消息中可以包含多种内容:<br/>
<strong>1. 纯文本</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"请审查这段代码..."</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>2. 嵌入图片</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"image"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"base64-encoded-image-data"</span><span class="hljs-punctuation">,</span>     <span class="hljs-comment">// 图片数据</span>
    <span class="hljs-attr">"mimeType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"image/png"</span>                  <span class="hljs-comment">// 图片类型</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>3. 嵌入资源</strong>(引用MCP资源)</p>
<pre><code class="hljs language-swift" lang="swift">{
  <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
  <span class="hljs-string">"content"</span>: {
    <span class="hljs-string">"type"</span>: <span class="hljs-string">"resource"</span>,
    <span class="hljs-string">"resource"</span>: {
      <span class="hljs-string">"uri"</span>: <span class="hljs-string">"file:///project/src/user.py"</span>,  <span class="hljs-comment">// 资源URI</span>
      <span class="hljs-string">"mimeType"</span>: <span class="hljs-string">"text/x-python"</span>,
      <span class="hljs-string">"text"</span>: <span class="hljs-string">"class User:<span class="hljs-subst">\n</span>    def __init__..."</span>  <span class="hljs-comment">// 资源内容</span>
    }
  }
}
</code></pre>
<p><strong>4. 多轮对话</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"messages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"我想优化这段代码"</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"assistant"</span><span class="hljs-punctuation">,</span>                    <span class="hljs-comment">// AI的回复</span>
      <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"请提供代码内容"</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"resource"</span><span class="hljs-punctuation">,</span>                   <span class="hljs-comment">// 用户提供代码</span>
        <span class="hljs-attr">"resource"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>...<span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>Prompt vs Tool vs Resource 对比</strong></p>
<pre><code class="hljs language-scss" lang="scss">特性          Prompt              Tool                Resource
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
控制者        用户主动选择         AI自动决定           应用程序控制

触发方式      用户点击命令         AI判断需要调用       应用自动附加
              /analyze                              或用户选择
              
返回内容      对话消息            执行结果             数据内容
              (给AI的指令)        (函数返回值)         (上下文信息)
              
典型用途      工作流模板          执行操作             提供背景信息
              快捷指令            查询数据             文件内容
              
示例          代码审查模板        执行SQL查询          项目README
              错误诊断向导        发送邮件             数据库Schema
              
用户感知      ✅ 明显             ❓ 可能不知道         ❓ 透明的
              (用户点击)          (AI决定)            (自动加载)
</code></pre>
<p>Prompt是预设的对话模板，通过参数化实现灵活应用，提升用户体验，并能与MCP其他能力组合形成完整工作流。</p>
<p><strong>代码实现示例</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 服务器端:注册Prompt</span>
<span class="hljs-meta">@server.list_prompts()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">list_prompts</span>():
    <span class="hljs-keyword">return</span> [
        Prompt(
            name=<span class="hljs-string">"analyze_commits"</span>,
            title=<span class="hljs-string">"📊 提交历史分析"</span>,
            description=<span class="hljs-string">"分析Git提交历史并生成统计报告"</span>,
            arguments=[
                {<span class="hljs-string">"name"</span>: <span class="hljs-string">"branch"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"分支名"</span>, <span class="hljs-string">"required"</span>: <span class="hljs-literal">True</span>},
                {<span class="hljs-string">"name"</span>: <span class="hljs-string">"since"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"时间范围"</span>, <span class="hljs-string">"required"</span>: <span class="hljs-literal">False</span>}
            ]
        )
    ]

<span class="hljs-meta">@server.get_prompt()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_prompt</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span>, arguments: <span class="hljs-built_in">dict</span></span>):
    <span class="hljs-keyword">if</span> name == <span class="hljs-string">"analyze_commits"</span>:
        branch = arguments[<span class="hljs-string">"branch"</span>]
        since = arguments.get(<span class="hljs-string">"since"</span>, <span class="hljs-string">"7 days ago"</span>)
        
        <span class="hljs-comment"># 构建完整的提示消息</span>
        prompt_text = <span class="hljs-string">f"""
请分析<span class="hljs-subst">{branch}</span>分支在<span class="hljs-subst">{since}</span>的Git提交历史。

需要统计:
1. 总提交次数
2. 每个作者的贡献
3. 主要修改的文件
4. 是否有breaking changes

请用表格格式输出。
        """</span>
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"messages"</span>: [
                {
                    <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
                    <span class="hljs-string">"content"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>, <span class="hljs-string">"text"</span>: prompt_text}
                }
            ]
        }

<span class="hljs-comment"># 客户端:使用Prompt</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">use_prompt</span>(<span class="hljs-params">session, prompt_name, arguments</span>):
    <span class="hljs-comment"># 获取Prompt内容</span>
    prompt = <span class="hljs-keyword">await</span> session.get_prompt(
        name=prompt_name,
        arguments=arguments
    )
    
    <span class="hljs-comment"># 将消息发送给AI</span>
    <span class="hljs-keyword">for</span> message <span class="hljs-keyword">in</span> prompt.messages:
        ai_response = <span class="hljs-keyword">await</span> send_to_ai(message)
        <span class="hljs-built_in">print</span>(ai_response)
</code></pre>
<h3 data-id="heading-15">5.3 Tools(工具)：AI 自己决定用什么</h3>
<p><strong>Tool就是可执行的函数</strong>，比如查询数据库、调用API、写文件。</p>
<p><strong>谁控制</strong>：AI模型根据对话内容自己决定调用哪个工具</p>
<p><strong>如何使用</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 列出可用工具</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tools/list"</span><span class="hljs-punctuation">}</span>

<span class="hljs-comment">// AI调用工具</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tools/call"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"get_weather"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"city"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"北京"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>返回结果</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"北京天气:晴,温度22°C"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"isError"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-16">5.4 其他功能</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2Fspecification%2F2025-06-18%2Fserver%2Futilities%2Fcompletion" target="_blank" title="https://modelcontextprotocol.io/specification/2025-06-18/server/utilities/completion" ref="nofollow noopener noreferrer"><strong>补全</strong></a></p>
<p>MCP提供标准化的参数自动补全功能，支持为提示和资源URI提供上下文相关的建议，实现类似IDE的交互体验。服务器通过声明<code>completions</code>能力，支持对<code>ref/prompt</code>和<code>ref/resource</code>两种引用类型的补全，每次最多返回100个按相关性排序的建议值，并可通过<code>completion/complete</code>请求获取补全结果。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2Fspecification%2F2025-06-18%2Fserver%2Futilities%2Flogging" target="_blank" title="https://modelcontextprotocol.io/specification/2025-06-18/server/utilities/logging" ref="nofollow noopener noreferrer"><strong>日志</strong></a></p>
<p>MCP提供结构化日志消息传递机制，允许服务器向客户端发送包含严重性级别、可选记录器名称和任意JSON可序列化数据的日志通知。服务器需声明<code>logging</code>能力，支持遵循RFC 5424标准的日志级别（从debug到emergency），客户端可通过<code>logging/setLevel</code>请求配置最低日志级别，服务器通过<code>notifications/message</code>通知发送日志消息。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2Fspecification%2F2025-06-18%2Fserver%2Futilities%2Fpagination" target="_blank" title="https://modelcontextprotocol.io/specification/2025-06-18/server/utilities/pagination" ref="nofollow noopener noreferrer"><strong>分页</strong></a></p>
<p>MCP支持对可能返回大量结果集的列表操作进行分页处理，使用基于不透明游标的分页模型而非数字页码。服务器在响应中包含当前页结果和可选的<code>nextCursor</code>字段（表示更多结果存在），客户端可通过在请求中包含游标继续分页。支持分页的操作包括<code>resources/list</code>、<code>resources/templates/list</code>、<code>prompts/list</code>和<code>tools/list</code>，客户端必须将游标视为不透明令牌。</p>
<h2 data-id="heading-17">六、客户端能力：反向请求</h2>
<p>客户端不仅接收服务器的数据，也可以提供能力给服务器使用:</p>
<h3 data-id="heading-18">6.1 Sampling(采样)：服务器请求客户端调用AI</h3>
<p><strong>场景</strong>: 服务器在处理任务时，需要AI帮忙分析中间结果。</p>
<p><strong>如何使用</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sampling/createMessage"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"messages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"这个数据正常吗?"</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"modelPreferences"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"hints"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"claude-3-sonnet"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 建议用的模型</span>
      <span class="hljs-attr">"intelligencePriority"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.8</span><span class="hljs-punctuation">,</span>             <span class="hljs-comment">// 要求智能程度</span>
      <span class="hljs-attr">"speedPriority"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.5</span>                     <span class="hljs-comment">// 速度要求</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>实际案例</strong>:Filesystem服务器在搜索大量文件时,请求AI判断哪些文件最相关。</p>
<h3 data-id="heading-19">6.2 Roots(目录)：告诉服务器工作范围</h3>
<p><strong>场景</strong>: 让服务器知道可以访问哪些目录。</p>
<p><strong>如何使用</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"roots/list"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>返回</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"roots"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"uri"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file:///home/user/project"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"我的项目"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>服务器知道只能在这个目录里操作，保护其他文件安全。</p>
<h3 data-id="heading-20">6.3 Elicitation(引导)：服务器向用户询问信息</h3>
<p><strong>场景</strong>: 服务器需要用户提供额外信息才能继续。</p>
<p><strong>如何使用</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"elicitation/create"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"请提供您的GitHub用户名"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"requestedSchema"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"object"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"properties"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"username"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>用户响应</strong>:</p>
<pre><code class="hljs language-perl" lang="perl">{
  <span class="hljs-string">"action"</span>: <span class="hljs-string">"accept"</span>,  <span class="hljs-regexp">//</span> 或<span class="hljs-string">"decline"</span>拒绝, <span class="hljs-string">"cancel"</span>取消
  <span class="hljs-string">"content"</span>: {
    <span class="hljs-string">"username"</span>: <span class="hljs-string">"octocat"</span>
  }
}
</code></pre>
<p><strong>实际案例</strong>: Git服务器需要知道提交信息格式，弹窗问用户:"请选择提交规范:Conventional Commits/Angular/Custom?"</p>
<h2 data-id="heading-21">七、完整实战：从零构建天气查询MCP</h2>
<p>下面让我们从头到尾构建一个完整的MCP系统，包含服务器和客户端。</p>
<h3 data-id="heading-22">7.1 需求分析</h3>
<p><strong>目标</strong>: 构建一个天气查询MCP服务器,提供:</p>
<ul>
<li><strong>资源</strong>: 城市列表</li>
<li><strong>工具</strong>: 查询天气、获取预报</li>
<li><strong>提示</strong>: 天气分析模板</li>
</ul>
<h3 data-id="heading-23">7.2 服务器实现(Python)</h3>
<p><strong>第一步: 安装MCP SDK</strong></p>
<pre><code class="hljs">pip install mcp
</code></pre>
<p><strong>第二步: 创建服务器 (weather_server.py)</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> mcp.server <span class="hljs-keyword">import</span> Server
<span class="hljs-keyword">from</span> mcp.types <span class="hljs-keyword">import</span> Resource, Tool, Prompt, TextContent
<span class="hljs-keyword">import</span> mcp.server.stdio
<span class="hljs-keyword">import</span> httpx

<span class="hljs-comment"># 创建MCP服务器实例</span>
server = Server(<span class="hljs-string">"weather-server"</span>)

<span class="hljs-comment"># 1. 定义资源:支持的城市列表</span>
<span class="hljs-meta">@server.list_resources()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">list_resources</span>():
    <span class="hljs-string">"""返回可用的资源列表"""</span>
    <span class="hljs-keyword">return</span> [
        Resource(
            uri=<span class="hljs-string">"weather://cities"</span>,
            name=<span class="hljs-string">"支持的城市列表"</span>,
            mimeType=<span class="hljs-string">"application/json"</span>,
            description=<span class="hljs-string">"查询天气支持的所有城市"</span>
        )
    ]

<span class="hljs-meta">@server.read_resource()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_resource</span>(<span class="hljs-params">uri: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""读取具体资源内容"""</span>
    <span class="hljs-keyword">if</span> uri == <span class="hljs-string">"weather://cities"</span>:
        cities = [<span class="hljs-string">"北京"</span>, <span class="hljs-string">"上海"</span>, <span class="hljs-string">"广州"</span>, <span class="hljs-string">"深圳"</span>, <span class="hljs-string">"杭州"</span>]
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"contents"</span>: [{
                <span class="hljs-string">"uri"</span>: uri,
                <span class="hljs-string">"mimeType"</span>: <span class="hljs-string">"application/json"</span>,
                <span class="hljs-string">"text"</span>: <span class="hljs-built_in">str</span>(cities)
            }]
        }

<span class="hljs-comment"># 2. 定义工具:天气查询</span>
<span class="hljs-meta">@server.list_tools()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">list_tools</span>():
    <span class="hljs-string">"""返回可用的工具列表"""</span>
    <span class="hljs-keyword">return</span> [
        Tool(
            name=<span class="hljs-string">"get_current_weather"</span>,
            description=<span class="hljs-string">"获取指定城市的当前天气"</span>,
            inputSchema={
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
                <span class="hljs-string">"properties"</span>: {
                    <span class="hljs-string">"city"</span>: {
                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,
                        <span class="hljs-string">"description"</span>: <span class="hljs-string">"城市名称,如'北京'"</span>
                    }
                },
                <span class="hljs-string">"required"</span>: [<span class="hljs-string">"city"</span>]
            }
        ),
        Tool(
            name=<span class="hljs-string">"get_forecast"</span>,
            description=<span class="hljs-string">"获取未来3天天气预报"</span>,
            inputSchema={
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
                <span class="hljs-string">"properties"</span>: {
                    <span class="hljs-string">"city"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"城市名称"</span>},
                    <span class="hljs-string">"days"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"number"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"预报天数(1-3)"</span>, <span class="hljs-string">"default"</span>: <span class="hljs-number">3</span>}
                },
                <span class="hljs-string">"required"</span>: [<span class="hljs-string">"city"</span>]
            }
        )
    ]

<span class="hljs-meta">@server.call_tool()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">call_tool</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span>, arguments: <span class="hljs-built_in">dict</span></span>):
    <span class="hljs-string">"""执行工具调用"""</span>
    <span class="hljs-keyword">if</span> name == <span class="hljs-string">"get_current_weather"</span>:
        city = arguments[<span class="hljs-string">"city"</span>]
        <span class="hljs-comment"># 实际项目中这里调用真实的天气API</span>
        <span class="hljs-comment"># 示例:使用模拟数据</span>
        weather_data = {
            <span class="hljs-string">"city"</span>: city,
            <span class="hljs-string">"temperature"</span>: <span class="hljs-number">22</span>,
            <span class="hljs-string">"condition"</span>: <span class="hljs-string">"晴"</span>,
            <span class="hljs-string">"humidity"</span>: <span class="hljs-number">45</span>
        }
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"content"</span>: [{
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                <span class="hljs-string">"text"</span>: <span class="hljs-string">f"<span class="hljs-subst">{city}</span>当前天气:\n温度: <span class="hljs-subst">{weather_data[<span class="hljs-string">'temperature'</span>]}</span>°C\n天气: <span class="hljs-subst">{weather_data[<span class="hljs-string">'condition'</span>]}</span>\n湿度: <span class="hljs-subst">{weather_data[<span class="hljs-string">'humidity'</span>]}</span>%"</span>
            }]
        }
    
    <span class="hljs-keyword">elif</span> name == <span class="hljs-string">"get_forecast"</span>:
        city = arguments[<span class="hljs-string">"city"</span>]
        days = arguments.get(<span class="hljs-string">"days"</span>, <span class="hljs-number">3</span>)
        <span class="hljs-comment"># 模拟预报数据</span>
        forecast = <span class="hljs-string">f"<span class="hljs-subst">{city}</span>未来<span class="hljs-subst">{days}</span>天预报:\n第1天: 晴,20-25°C\n第2天: 多云,18-23°C\n第3天: 小雨,16-20°C"</span>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"content"</span>: [{<span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>, <span class="hljs-string">"text"</span>: forecast}]
        }

<span class="hljs-comment"># 3. 定义提示模板:天气分析</span>
<span class="hljs-meta">@server.list_prompts()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">list_prompts</span>():
    <span class="hljs-string">"""返回可用的提示模板"""</span>
    <span class="hljs-keyword">return</span> [
        Prompt(
            name=<span class="hljs-string">"analyze_weather"</span>,
            description=<span class="hljs-string">"分析天气趋势并给出建议"</span>,
            arguments=[
                {<span class="hljs-string">"name"</span>: <span class="hljs-string">"city"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"城市名称"</span>, <span class="hljs-string">"required"</span>: <span class="hljs-literal">True</span>}
            ]
        )
    ]

<span class="hljs-meta">@server.get_prompt()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_prompt</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span>, arguments: <span class="hljs-built_in">dict</span></span>):
    <span class="hljs-string">"""获取提示模板内容"""</span>
    <span class="hljs-keyword">if</span> name == <span class="hljs-string">"analyze_weather"</span>:
        city = arguments[<span class="hljs-string">"city"</span>]
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"messages"</span>: [
                {
                    <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
                    <span class="hljs-string">"content"</span>: {
                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                        <span class="hljs-string">"text"</span>: <span class="hljs-string">f"请分析<span class="hljs-subst">{city}</span>的天气情况,并给出出行建议。包括:\n1. 温度是否适宜\n2. 是否需要带伞\n3. 穿衣建议"</span>
                    }
                }
            ]
        }

<span class="hljs-comment"># 启动服务器</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 使用stdio传输(本地)</span>
    mcp.server.stdio.run_stdio_server(server)
</code></pre>
<h3 data-id="heading-24">7.3 配置服务器(Claude Desktop)</h3>
<p>创建配置文件 <code>~/Library/Application Support/Claude/claude_desktop_config.json</code>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"weather"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"python"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"/path/to/weather_server.py"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-25">7.4 客户端实现(Python)</h3>
<p>如果要自己实现客户端:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> mcp <span class="hljs-keyword">import</span> ClientSession
<span class="hljs-keyword">from</span> mcp.client.stdio <span class="hljs-keyword">import</span> stdio_client
<span class="hljs-keyword">import</span> asyncio

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-comment"># 连接到服务器</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> stdio_client(
        command=<span class="hljs-string">"python"</span>,
        args=[<span class="hljs-string">"/path/to/weather_server.py"</span>]
    ) <span class="hljs-keyword">as</span> (read, write):
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> ClientSession(read, write) <span class="hljs-keyword">as</span> session:
            
            <span class="hljs-comment"># 1. 初始化连接</span>
            <span class="hljs-keyword">await</span> session.initialize()
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 连接成功!"</span>)
            
            <span class="hljs-comment"># 2. 列出可用资源</span>
            resources = <span class="hljs-keyword">await</span> session.list_resources()
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n📁 可用资源: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(resources.resources)}</span>"</span>)
            <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> resources.resources:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  - <span class="hljs-subst">{r.name}</span>: <span class="hljs-subst">{r.uri}</span>"</span>)
            
            <span class="hljs-comment"># 3. 读取城市列表资源</span>
            cities_resource = <span class="hljs-keyword">await</span> session.read_resource(
                uri=<span class="hljs-string">"weather://cities"</span>
            )
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n🌍 城市列表: <span class="hljs-subst">{cities_resource.contents[<span class="hljs-number">0</span>].text}</span>"</span>)
            
            <span class="hljs-comment"># 4. 列出可用工具</span>
            tools = <span class="hljs-keyword">await</span> session.list_tools()
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n🔧 可用工具: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(tools.tools)}</span>"</span>)
            <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> tools.tools:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  - <span class="hljs-subst">{t.name}</span>: <span class="hljs-subst">{t.description}</span>"</span>)
            
            <span class="hljs-comment"># 5. 调用工具查询天气</span>
            result = <span class="hljs-keyword">await</span> session.call_tool(
                name=<span class="hljs-string">"get_current_weather"</span>,
                arguments={<span class="hljs-string">"city"</span>: <span class="hljs-string">"北京"</span>}
            )
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n🌤️  查询结果:\n<span class="hljs-subst">{result.content[<span class="hljs-number">0</span>].text}</span>"</span>)
            
            <span class="hljs-comment"># 6. 获取预报</span>
            forecast = <span class="hljs-keyword">await</span> session.call_tool(
                name=<span class="hljs-string">"get_forecast"</span>,
                arguments={<span class="hljs-string">"city"</span>: <span class="hljs-string">"上海"</span>, <span class="hljs-string">"days"</span>: <span class="hljs-number">3</span>}
            )
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n📅 天气预报:\n<span class="hljs-subst">{forecast.content[<span class="hljs-number">0</span>].text}</span>"</span>)
            
            <span class="hljs-comment"># 7. 列出提示模板</span>
            prompts = <span class="hljs-keyword">await</span> session.list_prompts()
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n💡 提示模板: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(prompts.prompts)}</span>"</span>)
            <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> prompts.prompts:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  - <span class="hljs-subst">{p.name}</span>: <span class="hljs-subst">{p.description}</span>"</span>)
            
            <span class="hljs-comment"># 8. 获取提示内容</span>
            prompt = <span class="hljs-keyword">await</span> session.get_prompt(
                name=<span class="hljs-string">"analyze_weather"</span>,
                arguments={<span class="hljs-string">"city"</span>: <span class="hljs-string">"广州"</span>}
            )
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n📝 生成的提示:\n<span class="hljs-subst">{prompt.messages[<span class="hljs-number">0</span>][<span class="hljs-string">'content'</span>][<span class="hljs-string">'text'</span>]}</span>"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    asyncio.run(main())
</code></pre>
<h3 data-id="heading-26">7.5 运行效果</h3>
<pre><code class="hljs language-makefile" lang="makefile">$ python weather_client.py

✅ 连接成功!

📁 可用资源: 1
  - 支持的城市列表: weather://cities

🌍 城市列表: ['北京', '上海', '广州', '深圳', '杭州']

🔧 可用工具: 2
  - get_current_weather: 获取指定城市的当前天气
  - get_forecast: 获取未来3天天气预报

🌤️  查询结果:
<span class="hljs-section">北京当前天气:</span>
<span class="hljs-section">温度: 22°C</span>
<span class="hljs-section">天气: 晴</span>
<span class="hljs-section">湿度: 45%</span>

📅 天气预报:
<span class="hljs-section">上海未来3天预报:</span>
<span class="hljs-section">第1天: 晴,20-25°C</span>
<span class="hljs-section">第2天: 多云,18-23°C</span>
<span class="hljs-section">第3天: 小雨,16-20°C</span>

💡 提示模板: 1
  - analyze_weather: 分析天气趋势并给出建议

📝 生成的提示:
<span class="hljs-section">请分析广州的天气情况,并给出出行建议。包括:</span>
1. 温度是否适宜
2. 是否需要带伞
3. 穿衣建议
</code></pre>
<h2 data-id="heading-27">八、其他部分：MCP基础协议的另一半</h2>
<h3 data-id="heading-28">8.1 授权（Authorization）</h3>
<p>MCP授权规范定义了基于HTTP传输的安全授权机制，使MCP客户端能够代表资源所有者向受限制的MCP服务器发出请求。该规范基于OAuth 2.1及相关标准，实现了授权服务器发现、动态客户端注册和访问令牌管理。例如，客户端通过<code>resource</code>参数明确指定目标MCP服务器（如<code>https://mcp.example.com</code>），服务器则验证令牌是否专门为其颁发，确保令牌不会被误用于其他服务，从而防止"令牌传递"安全漏洞。</p>
<h3 data-id="heading-29">8.2 取消（Cancellation）</h3>
<p>MCP取消机制允许通过通知消息中止正在进行的请求，任何一方都可以发送<code>notifications/cancelled</code>通知来终止先前发出的请求。例如，当用户取消长时间运行的操作时，客户端可以发送包含请求ID和可选原因的取消通知，接收方应停止处理、释放资源且不发送响应。该机制考虑了网络延迟导致的竞态条件，允许接收方在请求已完成或无法取消时忽略通知，同时建议双方记录取消原因以便调试。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"notifications/cancelled"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"requestId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"123"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"reason"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"用户取消"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-30">8.3 Ping机制</h3>
<p>MCP提供了可选的ping机制，允许任何一方验证对方是否仍然响应且连接存活。该机制通过简单的请求/响应模式实现，例如客户端发送<code>{"jsonrpc":"2.0","id":"123","method":"ping"}</code>，服务器必须立即响应<code>{"jsonrpc":"2.0","id":"123","result":{}}</code>。如果在合理超时时间内未收到响应，发送方可以将连接视为陈旧并终止连接或尝试重新连接。实现应定期发送ping以检测连接健康状况，但应避免过度ping以减少网络开销。</p>
<h3 data-id="heading-31">8.4 进度跟踪（Progress）</h3>
<p>MCP支持通过通知消息对长时间运行的操作进行可选的进度跟踪。请求方可以在请求元数据中包含唯一的<code>progressToken</code>（如字符串"task123"）来接收进度更新，接收方则可以发送包含进度值、可选总值和消息的<code>notifications/progress</code>通知。例如，文件上传操作可以发送<code>{"progress":50,"total":100,"message":"正在上传文件..."}</code>来指示完成百分比。进度值必须随每个通知递增，双方应实现速率限制以防止消息泛滥，并在操作完成后停止发送进度通知。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"notifications/progress"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"progressToken"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"task123"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"progress"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">50</span><span class="hljs-punctuation">,</span>      <span class="hljs-comment">// 当前进度</span>
    <span class="hljs-attr">"total"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><span class="hljs-punctuation">,</span>        <span class="hljs-comment">// 总量</span>
    <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"正在上传文件..."</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-32">九、安全实践：必须重视</h2>
<h3 data-id="heading-33">9.1 核心原则</h3>
<p><strong>1. 用户同意优先</strong></p>
<ul>
<li>所有数据访问必须经用户明确同意</li>
<li>所有工具调用前必须让用户确认</li>
</ul>
<p><strong>2. 数据隐私保护</strong></p>
<ul>
<li>服务器只能看到必要的信息</li>
<li>完整对话历史保留在宿主,不发给服务器</li>
</ul>
<p><strong>3. 工具安全</strong></p>
<ul>
<li>工具代表代码执行,必须谨慎</li>
<li>显示工具要做什么,让用户批准</li>
</ul>
<p><strong>4. 输入验证</strong></p>
<ul>
<li>服务器必须验证所有输入</li>
<li>客户端必须验证工具返回的结果</li>
</ul>
<h3 data-id="heading-34">9.2 实际建议</h3>
<p><strong>服务器开发者</strong>:</p>
<ul>
<li>验证所有输入参数</li>
<li>实现访问控制和速率限制</li>
<li>记录操作日志供审计</li>
</ul>
<p><strong>客户端开发者</strong>:</p>
<ul>
<li>显示清晰的权限请求界面</li>
<li>在调用工具前展示参数</li>
<li>实现工具调用超时机制</li>
</ul>
<h2 data-id="heading-35">十、MCP生态：谁开发客户端?</h2>
<p><strong>关键认知</strong>: 在MCP生态中，<strong>客户端通常不是由下游开发者开发的</strong>，而是<strong>内置在AI应用平台中</strong>。</p>
<pre><code class="hljs language-css" lang="css">  开发者开发MCP服务器
       ↓
  配置到AI平台(Claude/<span class="hljs-attribute">Cursor</span>等)
       ↓
  AI平台内置的MCP客户端自动连接
</code></pre>
<p>对于软件开发者来说，在MCP生态中的位置如下。</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">角色定位:</span>
┌─────────────────────────────────────────┐
│ AI平台开发者(Anthropic, Cursor等)       │
│ ────────────────────────────────        │
│ 职责:                                   │
│  ✅ 开发MCP客户端SDK                    │
│  ✅ 集成到自己的AI应用中                │
│  ✅ 提供配置界面                        │
│  ✅ 管理MCP服务器生命周期               │
│  ✅ 处理AI与MCP的交互逻辑               │
└─────────────────────────────────────────┘
                 ↓ 提供平台
┌─────────────────────────────────────────┐
│ MCP服务器开发者(你、我、社区)           │
│ ────────────────────────────────        │
│ 职责:                                   │
│  ✅ 开发MCP服务器                       │
│  ✅ 实现Resources/Tools/Prompts        │
│  ✅ 编写使用文档                        │
│  ✅ 发布到npm/PyPI                      │
│  ❌ 不需要开发客户端                    │
│  ❌ 不需要关心AI如何调用                │
└─────────────────────────────────────────┘
                 ↓ 使用服务
┌─────────────────────────────────────────┐
│ 最终用户(开发者、分析师等)               │
│ ────────────────────────────────        │
│ 职责:                                   │
│  ✅ 安装需要的MCP服务器                 │
│  ✅ 配置到AI平台                        │
│  ✅ 使用AI完成任务                      │
│  ❌ 不需要写代码                        │
└─────────────────────────────────────────┘
</code></pre>
<h2 data-id="heading-36">后记</h2>
<p>MCP 让 AI 应用开发变得更简单、更安全、更强大。它不是银弹，但为构建可靠的AI系统提供了坚实基础。<strong>本文全部内容基于提示编写，欢迎交流讨论！</strong></p>
<h2 data-id="heading-37">参考文献</h2>
<ol>
<li>MCP官方规范: <a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2Fspecification%2F2025-06-18" target="_blank" title="https://modelcontextprotocol.io/specification/2025-06-18" ref="nofollow noopener noreferrer">modelcontextprotocol.io/specificati…</a></li>
<li>JSON-RPC 2.0: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jsonrpc.org%2F" target="_blank" title="https://www.jsonrpc.org/" ref="nofollow noopener noreferrer">www.jsonrpc.org/</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vibe Coze-企业 AI 应用赛道开启]]></title>    <link>https://juejin.cn/post/7571475192489951242</link>    <guid>https://juejin.cn/post/7571475192489951242</guid>    <pubDate>2025-11-12T08:07:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571475192489951242" data-draft-id="7571395183943991305" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vibe Coze-企业 AI 应用赛道开启"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-12T08:07:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="火山引擎开发者社区"/> <meta itemprop="url" content="https://juejin.cn/user/3307770588439422"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vibe Coze-企业 AI 应用赛道开启
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3307770588439422/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    火山引擎开发者社区
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T08:07:51.000Z" title="Wed Nov 12 2025 08:07:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f079723185014bd98aef19582bfb26b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5bGx5byV5pOO5byA5Y-R6ICF56S-5Yy6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763539670&amp;x-signature=U1nrQQwpLA6X6ThX7AHK1TBC2ZE%3D" alt="" loading="lazy"/></p>
<p><strong>赛道详情</strong></p>
<p>参赛选手需从企业真实需求（如数据分析、办公助手、知识查询/管理、营销推广等场景）出发，基于扣子（coze.cn) /扣子空间的能力创建一个 H5 或其他可复现的成品项目，<strong>推荐结合使用豆包编程模型 Doubao-Seed-Code、火山引擎 veCLI。使用推荐工具将是加分项</strong>，详见评分规则。</p>
<p>豆包编程模型 Doubao-Seed-Code 专为 Agentic 编程任务深度优化，在 SWE-Bench-Verified 榜单中刷新SOTA，更兼容 Anthropic API 等主流开发环境。</p>
<p>对于个人开发者，豆包编程模型推出 Coding Plan 订阅服务，首月订购优惠价低至 9.9 元！如订阅 Coding Plan 使用豆包编程模型参赛，可通过链接提交信息，将获得额外礼品一份：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fbytedance.larkoffice.com%2Fshare%2Fbase%2Fform%2FshrcnwIxtFAkm4gEh1fIl3TanJc" target="_blank" title="https://bytedance.larkoffice.com/share/base/form/shrcnwIxtFAkm4gEh1fIl3TanJc" ref="nofollow noopener noreferrer">bytedance.larkoffice.com/share/base/…</a></p>
<p><strong>学习资料：</strong></p>
<ul>
<li>
<p>AI 编程实战技巧分享，30分钟从入门到沉迷｜Vibe Coze！扣子 AI 挑战赛教程：<a href="https://link.juejin.cn?target=https%3A%2F%2Fbytedance.larkoffice.com%2Fwiki%2FHt37wE7wbiPAJpkpQooc4EYenKd%3Ffrom%3Dfrom_copylink" target="_blank" title="https://bytedance.larkoffice.com/wiki/Ht37wE7wbiPAJpkpQooc4EYenKd?from=from_copylink" ref="nofollow noopener noreferrer">bytedance.larkoffice.com/wiki/Ht37wE…</a></p>
</li>
<li>
<p>VeCLI 文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.volcengine.com%2Fdocs%2F83927%2F1826757" target="_blank" title="https://www.volcengine.com/docs/83927/1826757" ref="nofollow noopener noreferrer">www.volcengine.com/docs/83927/…</a></p>
</li>
<li>
<p>豆包编程模型文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fconsole.volcengine.com%2Fark%2Fregion%3Aark%2Bcn-beijing%2Fmodel%2Fdetail%3FId%3Ddoubao-seed-code" target="_blank" title="https://console.volcengine.com/ark/region:ark+cn-beijing/model/detail?Id=doubao-seed-code" ref="nofollow noopener noreferrer">console.volcengine.com/ark/region:…</a></p>
</li>
<li>
<p>Coding Plan 详情：szacq.cn/F5JBG/</p>
</li>
</ul>
<p><strong>时间</strong></p>
<p>「2025/11/12-2025/12/13」</p>
<ul>
<li>
<p>11.12-11.30 报名&amp;作品提交。报名详情页：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.volcengine.com%2Factivities%2F7569894904566906907" target="_blank" title="https://developer.volcengine.com/activities/7569894904566906907" ref="nofollow noopener noreferrer">developer.volcengine.com/activities/…</a></p>
</li>
<li>
<p>12.1-12.5 作品初筛</p>
</li>
<li>
<p>12.6 初赛路演。初赛路演将在北京、上海、成都、深圳 4 个城市举行，每个区域初筛前 10 名进行路演，各城市初赛前 3 名将进入决赛。</p>
</li>
<li>
<p>12.13 决赛路演</p>
</li>
</ul>
<p><strong>奖项设置</strong></p>
<p>一等奖 1 名：5000 元奖金+获奖证书+扣子周边+流量扶持</p>
<p>二等奖 2 名：4000 元奖金+获奖证书+扣子周边+流量扶持</p>
<p>三等奖 3 名：3000 元奖金+获奖证书+扣子周边+流量扶持</p>
<p>最佳 AI 实践奖 6 名：1000 元奖金+获奖证书+扣子周边+流量扶持</p>
<p><strong>评分标准</strong></p>
<p>评审规则：</p>
<ul>
<li>
<p>评审方：扣子、火山引擎 ADG、火山方舟、火山引擎 veCLI</p>
</li>
<li>
<p>分数构成：总分（100分）= 作品评分（70%）+说明文档评分（30%）</p>
</li>
</ul>
<p><strong>评分维度：</strong></p>
<ul>
<li>
<p>「实用性」20分：作品是否有实用的落地场景，能否解决所属专业领域内的问题。</p>
</li>
<li>
<p>「技术性」40分 ： 作品功能设计的逻辑性、技术实现的成熟度以及整体方案的稳定性。同时考察作品使用的工具丰富性，使用豆包编程模型 Doubao-Seed-Code、 VeCLI 分别得 10 分。</p>
</li>
<li>
<p>「体验性」30分： 考察作品的用户体验质量，包括交互自然度、响应及时性和准确性等。</p>
</li>
</ul>
<p><strong>说明文档评分维度：</strong></p>
<ul>
<li>
<p>作品创意（40 分）：作品的创意思路。</p>
</li>
<li>
<p>实现原理与功能（40分）：各功能实现原理。</p>
</li>
<li>
<p>文档结构（20分）：结构完整，语言简洁，逻辑清晰。</p>
</li>
</ul>
<p>作品说明文档模版：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fbytedance.larkoffice.com%2Fwiki%2FZyopwHYLHiUbS3k79A6ci0Sbndd%3Ffrom%3Dfrom_copylink" target="_blank" title="https://bytedance.larkoffice.com/wiki/ZyopwHYLHiUbS3k79A6ci0Sbndd?from=from_copylink" ref="nofollow noopener noreferrer">bytedance.larkoffice.com/wiki/ZyopwH…</a></p>
<p><strong>作品提交</strong></p>
<p>点击链接填写信息提交您的作品：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fbytedance.larkoffice.com%2Fshare%2Fbase%2Fform%2Fshrcn39zYBrefgIBMiOVQ5wC8ih" target="_blank" title="https://bytedance.larkoffice.com/share/base/form/shrcn39zYBrefgIBMiOVQ5wC8ih" ref="nofollow noopener noreferrer">bytedance.larkoffice.com/share/base/…</a></p>
<hr/>
<p>大赛完整活动包含 3 大赛道，用户可参与多个赛道，最多提交 5 个作品，每个作品参与者不超过 3 人。点击查看其他赛道及完整活动信息：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FQY0trtEFQs5vghGUgLE0aw" target="_blank" title="https://mp.weixin.qq.com/s/QY0trtEFQs5vghGUgLE0aw" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/QY0trtEFQ…</a></p>
<p>此外，大赛还设置了如下特别奖项👇</p>
<p><strong>公益特别奖：最佳 AI 公益奖5名（全赛道）</strong></p>
<ul>
<li>
<p>三大赛道均可参与，形式不限，你可以选择公益场景，或守护银发数字生活与青少年健康成长，或助力乡村教师教学能力提升。让AI不仅能够激发创意、提升效率，更能传递温度，助力科技普惠与创新。</p>
</li>
<li>
<p>奖金 <strong>3000</strong> 元+<strong>公益周边</strong></p>
</li>
</ul>
<p><strong>传播特别奖：最佳 AI 创意奖20名（全赛道）</strong></p>
<ul>
<li>
<p>三大赛道均可参与，形式不限，你可以选择帮你的作品/开发过程等等瞬间发布到抖音、小红书、即刻、B站、公众号、社群等任意社交平台上，艾特@扣子Coze，打上#扣子AI工坊 #扣子空间 两个tag，即可参与评选。</p>
</li>
<li>
<p>我们将根据您的作品互动数据量（点赞、收藏、评论等相关数据）作为评选标准，为您送上<strong>扣子周边三件套</strong>（扣子捏捏、扣子卡套、扣子贴纸）</p>
</li>
</ul>
<p><strong>优秀奖：优秀 AI 实践奖100名（全赛道）</strong></p>
<ul>
<li>三大赛道均可参与，形式不限，符合标准的 Top 100 的作品，将获得优秀 AI 实践奖</li>
</ul>
<p>点击【阅读原文】了解活动详情</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JDK 8 Stream API 教程文档]]></title>    <link>https://juejin.cn/post/7571644531608043566</link>    <guid>https://juejin.cn/post/7571644531608043566</guid>    <pubDate>2025-11-12T09:20:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571644531608043566" data-draft-id="7571644531607846958" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JDK 8 Stream API 教程文档"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-12T09:20:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Main12138"/> <meta itemprop="url" content="https://juejin.cn/user/124660844331034"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JDK 8 Stream API 教程文档
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/124660844331034/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Main12138
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T09:20:09.000Z" title="Wed Nov 12 2025 09:20:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Stream 简介</h2>
<p>Stream 是 JDK 8 中处理集合（Collection）数据的新抽象，它可以让你以声明式的方式处理数据，类似于使用 SQL 语句进行数据库查询。</p>
<p>List names = Arrays.asList("Alice", "Bob", "Charlie", "David");</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 传统方式</span>
List&lt;String&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
<span class="hljs-keyword">for</span> (String name : names) {
    <span class="hljs-keyword">if</span> (name.startsWith(<span class="hljs-string">"A"</span>)) {
        result.add(name.toUpperCase());
    }
}

<span class="hljs-comment">// Stream 方式</span>
List&lt;String&gt; streamResult = names.stream()
    .filter(name -&gt; name.startsWith(<span class="hljs-string">"A"</span>))
    .map(String::toUpperCase)
    .collect(Collectors.toList());
</code></pre>
<h2 data-id="heading-1">Stream 的特点</h2>
<ol>
<li><strong>不是数据结构</strong>：Stream 不会存储数据，只是对数据源进行计算</li>
<li><strong>不修改源数据</strong>：对 Stream 的操作不会影响原始数据源</li>
<li><strong>惰性执行</strong>：中间操作是惰性的，只有在终止操作时才会执行</li>
<li><strong>可消费性</strong>：Stream 只能被消费一次</li>
</ol>
<h2 data-id="heading-2">Stream 操作分类</h2>























<table><thead><tr><th>操作类型</th><th>方法示例</th><th>返回值</th><th>特点</th></tr></thead><tbody><tr><td>中间操作</td><td>filter(), map(), sorted()</td><td>Stream</td><td>惰性执行，可链式调用</td></tr><tr><td>终止操作</td><td>forEach(), collect(), count()</td><td>非Stream</td><td>立即执行，关闭流</td></tr></tbody></table>
<h2 data-id="heading-3">创建 Stream</h2>
<h3 data-id="heading-4">1. 从集合创建</h3>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; list = Arrays.asList(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>);
Stream&lt;String&gt; stream = list.stream();
</code></pre>
<h3 data-id="heading-5">2. 从数组创建</h3>
<pre><code class="hljs language-java" lang="java">String[] array = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>};
Stream&lt;String&gt; stream = Arrays.stream(array);
</code></pre>
<h3 data-id="heading-6">3. 使用 Stream.of()</h3>
<pre><code class="hljs language-java" lang="java">Stream&lt;String&gt; stream = Stream.of(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>);
</code></pre>
<h3 data-id="heading-7">4. 创建数值流</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">IntStream</span> <span class="hljs-variable">intStream</span> <span class="hljs-operator">=</span> IntStream.range(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>);     <span class="hljs-comment">// 1,2,3,4</span>
<span class="hljs-type">IntStream</span> <span class="hljs-variable">closedStream</span> <span class="hljs-operator">=</span> IntStream.rangeClosed(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>); <span class="hljs-comment">// 1,2,3,4,5</span>
</code></pre>
<h3 data-id="heading-8">5. 创建无限流</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 生成10个随机数</span>
Stream&lt;Double&gt; randomStream = Stream.generate(Math::random).limit(<span class="hljs-number">10</span>);

<span class="hljs-comment">// 创建斐波那契数列</span>
Stream.iterate(<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]{<span class="hljs-number">0</span>, <span class="hljs-number">1</span>}, t -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]{t[<span class="hljs-number">1</span>], t[<span class="hljs-number">0</span>] + t[<span class="hljs-number">1</span>]})
      .limit(<span class="hljs-number">10</span>)
      .map(t -&gt; t[<span class="hljs-number">0</span>])
      .forEach(System.out::println);
</code></pre>
<h2 data-id="heading-9">中间操作</h2>
<h3 data-id="heading-10">1. filter() - 过滤</h3>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; names = Arrays.asList(<span class="hljs-string">"Alice"</span>, <span class="hljs-string">"Bob"</span>, <span class="hljs-string">"Charlie"</span>, <span class="hljs-string">"David"</span>);
List&lt;String&gt; result = names.stream()
    .filter(name -&gt; name.length() &gt; <span class="hljs-number">3</span>)
    .collect(Collectors.toList());
<span class="hljs-comment">// 结果: [Alice, Charlie, David]</span>
</code></pre>
<h3 data-id="heading-11">2. map() - 映射</h3>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; names = Arrays.asList(<span class="hljs-string">"Alice"</span>, <span class="hljs-string">"Bob"</span>, <span class="hljs-string">"Charlie"</span>);
List&lt;Integer&gt; nameLengths = names.stream()
    .map(String::length)
    .collect(Collectors.toList());
<span class="hljs-comment">// 结果: [5, 3, 7]</span>
</code></pre>
<h3 data-id="heading-12">3. flatMap() - 扁平化映射</h3>
<pre><code class="hljs language-java" lang="java">List&lt;List&lt;String&gt;&gt; listOfLists = Arrays.asList(
    Arrays.asList(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>),
    Arrays.asList(<span class="hljs-string">"c"</span>, <span class="hljs-string">"d"</span>)
);

List&lt;String&gt; flatList = listOfLists.stream()
    .flatMap(List::stream)
    .collect(Collectors.toList());
<span class="hljs-comment">// 结果: [a, b, c, d]</span>
</code></pre>
<h3 data-id="heading-13">4. distinct() - 去重</h3>
<pre><code class="hljs language-java" lang="java">List&lt;Integer&gt; numbers = Arrays.asList(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>);
List&lt;Integer&gt; distinctNumbers = numbers.stream()
    .distinct()
    .collect(Collectors.toList());
<span class="hljs-comment">// 结果: [1, 2, 3]</span>
</code></pre>
<h3 data-id="heading-14">5. sorted() - 排序</h3>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; names = Arrays.asList(<span class="hljs-string">"Charlie"</span>, <span class="hljs-string">"Alice"</span>, <span class="hljs-string">"Bob"</span>);
List&lt;String&gt; sortedNames = names.stream()
    .sorted()
    .collect(Collectors.toList());
<span class="hljs-comment">// 结果: [Alice, Bob, Charlie]</span>

<span class="hljs-comment">// 自定义排序</span>
List&lt;String&gt; customSorted = names.stream()
    .sorted((a, b) -&gt; b.length() - a.length())
    .collect(Collectors.toList());
<span class="hljs-comment">// 结果: [Charlie, Alice, Bob]</span>
</code></pre>
<h3 data-id="heading-15">6. limit() 和 skip() - 限制和跳过</h3>
<pre><code class="hljs language-java" lang="java">List&lt;Integer&gt; numbers = Arrays.asList(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>);

List&lt;Integer&gt; limited = numbers.stream()
    .limit(<span class="hljs-number">5</span>)
    .collect(Collectors.toList());
<span class="hljs-comment">// 结果: [1, 2, 3, 4, 5]</span>

List&lt;Integer&gt; skipped = numbers.stream()
    .skip(<span class="hljs-number">5</span>)
    .collect(Collectors.toList());
<span class="hljs-comment">// 结果: [6, 7, 8, 9, 10]</span>
</code></pre>
<h3 data-id="heading-16">7. peek() - 查看元素（主要用于调试）</h3>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; result = Stream.of(<span class="hljs-string">"one"</span>, <span class="hljs-string">"two"</span>, <span class="hljs-string">"three"</span>)
    .filter(s -&gt; s.length() &gt; <span class="hljs-number">3</span>)
    .peek(s -&gt; System.out.println(<span class="hljs-string">"Filtered value: "</span> + s))
    .map(String::toUpperCase)
    .peek(s -&gt; System.out.println(<span class="hljs-string">"Mapped value: "</span> + s))
    .collect(Collectors.toList());
</code></pre>
<h2 data-id="heading-17">终止操作</h2>
<h3 data-id="heading-18">1. forEach() - 遍历</h3>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; names = Arrays.asList(<span class="hljs-string">"Alice"</span>, <span class="hljs-string">"Bob"</span>, <span class="hljs-string">"Charlie"</span>);
names.stream().forEach(System.out::println);
</code></pre>
<h3 data-id="heading-19">2. collect() - 收集</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 转换为List</span>
List&lt;String&gt; list = stream.collect(Collectors.toList());

<span class="hljs-comment">// 转换为Set</span>
Set&lt;String&gt; set = stream.collect(Collectors.toSet());

<span class="hljs-comment">// 转换为Map</span>
Map&lt;String, Integer&gt; map = stream.collect(
    Collectors.toMap(s -&gt; s, String::length)
);

<span class="hljs-comment">// 连接字符串</span>
<span class="hljs-type">String</span> <span class="hljs-variable">joined</span> <span class="hljs-operator">=</span> stream.collect(Collectors.joining(<span class="hljs-string">", "</span>));

<span class="hljs-comment">// 分组</span>
Map&lt;Integer, List&lt;String&gt;&gt; grouped = names.stream()
    .collect(Collectors.groupingBy(String::length));

<span class="hljs-comment">// 分区</span>
Map&lt;Boolean, List&lt;String&gt;&gt; partitioned = names.stream()
    .collect(Collectors.partitioningBy(s -&gt; s.length() &gt; <span class="hljs-number">3</span>));
</code></pre>
<h3 data-id="heading-20">3. reduce() - 归约</h3>
<pre><code class="hljs language-java" lang="java">List&lt;Integer&gt; numbers = Arrays.asList(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>);

<span class="hljs-comment">// 求和</span>
Optional&lt;Integer&gt; sum = numbers.stream().reduce(Integer::sum);
<span class="hljs-comment">// 或</span>
<span class="hljs-type">Integer</span> <span class="hljs-variable">sum2</span> <span class="hljs-operator">=</span> numbers.stream().reduce(<span class="hljs-number">0</span>, Integer::sum);

<span class="hljs-comment">// 求最大值</span>
Optional&lt;Integer&gt; max = numbers.stream().reduce(Integer::max);

<span class="hljs-comment">// 字符串连接</span>
Optional&lt;String&gt; concat = Stream.of(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>).reduce(String::concat);
</code></pre>
<h3 data-id="heading-21">4. 匹配操作</h3>
<pre><code class="hljs language-java" lang="java">List&lt;Integer&gt; numbers = Arrays.asList(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>);

<span class="hljs-type">boolean</span> <span class="hljs-variable">allEven</span> <span class="hljs-operator">=</span> numbers.stream().allMatch(n -&gt; n % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>); <span class="hljs-comment">// false</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">anyEven</span> <span class="hljs-operator">=</span> numbers.stream().anyMatch(n -&gt; n % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>); <span class="hljs-comment">// true</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">noneEven</span> <span class="hljs-operator">=</span> numbers.stream().noneMatch(n -&gt; n % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>); <span class="hljs-comment">// false</span>
</code></pre>
<h3 data-id="heading-22">5. 查找操作</h3>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; names = Arrays.asList(<span class="hljs-string">"Alice"</span>, <span class="hljs-string">"Bob"</span>, <span class="hljs-string">"Charlie"</span>);

Optional&lt;String&gt; first = names.stream().findFirst();
Optional&lt;String&gt; any = names.stream().findAny();
</code></pre>
<h3 data-id="heading-23">6. 统计操作</h3>
<pre><code class="hljs language-java" lang="java">List&lt;Integer&gt; numbers = Arrays.asList(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>);

<span class="hljs-type">long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> numbers.stream().count();
<span class="hljs-type">IntSummaryStatistics</span> <span class="hljs-variable">stats</span> <span class="hljs-operator">=</span> numbers.stream()
    .mapToInt(Integer::intValue)
    .summaryStatistics();

System.out.println(<span class="hljs-string">"最大值: "</span> + stats.getMax());
System.out.println(<span class="hljs-string">"最小值: "</span> + stats.getMin());
System.out.println(<span class="hljs-string">"总和: "</span> + stats.getSum());
System.out.println(<span class="hljs-string">"平均值: "</span> + stats.getAverage());
</code></pre>
<h2 data-id="heading-24">并行流</h2>
<h3 data-id="heading-25">创建并行流</h3>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; names = Arrays.asList(<span class="hljs-string">"Alice"</span>, <span class="hljs-string">"Bob"</span>, <span class="hljs-string">"Charlie"</span>);

<span class="hljs-comment">// 方法1：从集合创建</span>
Stream&lt;String&gt; parallelStream = names.parallelStream();

<span class="hljs-comment">// 方法2：将顺序流转为并行流</span>
Stream&lt;String&gt; parallel = names.stream().parallel();
</code></pre>
<h3 data-id="heading-26">并行流示例</h3>
<pre><code class="hljs language-java" lang="java">List&lt;Integer&gt; numbers = Arrays.asList(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>);

<span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
<span class="hljs-type">long</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> numbers.parallelStream()
    .mapToLong(Integer::longValue)
    .sum();
<span class="hljs-type">long</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();

System.out.println(<span class="hljs-string">"总和: "</span> + sum);
System.out.println(<span class="hljs-string">"执行时间: "</span> + (endTime - startTime) + <span class="hljs-string">"ms"</span>);
</code></pre>
<h3 data-id="heading-27">并行流注意事项</h3>
<ol>
<li><strong>线程安全</strong>：确保操作是线程安全的</li>
<li><strong>状态无关</strong>：避免有状态的lambda表达式</li>
<li><strong>顺序敏感</strong>：某些操作（如findFirst）在并行流中性能可能更差</li>
<li><strong>数据量</strong>：小数据量使用并行流可能适得其反</li>
</ol>
<h2 data-id="heading-28">实战示例</h2>
<h3 data-id="heading-29">示例1：员工数据处理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Employee</span> {
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> String department;
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> salary;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;
    
    <span class="hljs-comment">// 构造方法、getter、setter省略</span>
}

List&lt;Employee&gt; employees = Arrays.asList(
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Employee</span>(<span class="hljs-string">"Alice"</span>, <span class="hljs-string">"IT"</span>, <span class="hljs-number">5000</span>, <span class="hljs-number">25</span>),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Employee</span>(<span class="hljs-string">"Bob"</span>, <span class="hljs-string">"HR"</span>, <span class="hljs-number">4000</span>, <span class="hljs-number">30</span>),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Employee</span>(<span class="hljs-string">"Charlie"</span>, <span class="hljs-string">"IT"</span>, <span class="hljs-number">6000</span>, <span class="hljs-number">35</span>),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Employee</span>(<span class="hljs-string">"David"</span>, <span class="hljs-string">"Finance"</span>, <span class="hljs-number">5500</span>, <span class="hljs-number">28</span>)
);

<span class="hljs-comment">// 1. 按部门分组，计算每个部门的平均工资</span>
Map&lt;String, Double&gt; avgSalaryByDept = employees.stream()
    .collect(Collectors.groupingBy(
        Employee::getDepartment,
        Collectors.averagingDouble(Employee::getSalary)
    ));

<span class="hljs-comment">// 2. 找出IT部门工资最高的员工</span>
Optional&lt;Employee&gt; highestPaidInIT = employees.stream()
    .filter(e -&gt; <span class="hljs-string">"IT"</span>.equals(e.getDepartment()))
    .max(Comparator.comparingDouble(Employee::getSalary));

<span class="hljs-comment">// 3. 按年龄排序，获取前3名员工</span>
List&lt;Employee&gt; top3ByAge = employees.stream()
    .sorted(Comparator.comparingInt(Employee::getAge).reversed())
    .limit(<span class="hljs-number">3</span>)
    .collect(Collectors.toList());

<span class="hljs-comment">// 4. 统计每个部门的员工数量</span>
Map&lt;String, Long&gt; employeeCountByDept = employees.stream()
    .collect(Collectors.groupingBy(
        Employee::getDepartment, 
        Collectors.counting()
    ));
</code></pre>
<h3 data-id="heading-30">示例2：文件处理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 读取文件并统计单词频率</span>
<span class="hljs-keyword">try</span> (Stream&lt;String&gt; lines = Files.lines(Paths.get(<span class="hljs-string">"file.txt"</span>))) {
    Map&lt;String, Long&gt; wordCount = lines
        .flatMap(line -&gt; Arrays.stream(line.split(<span class="hljs-string">"\s+"</span>)))
        .map(word -&gt; word.replaceAll(<span class="hljs-string">"[^a-zA-Z]"</span>, <span class="hljs-string">""</span>).toLowerCase())
        .filter(word -&gt; !word.isEmpty())
        .collect(Collectors.groupingBy(
            word -&gt; word, 
            Collectors.counting()
        ));
    
    <span class="hljs-comment">// 按频率排序</span>
    wordCount.entrySet().stream()
        .sorted(Map.Entry.&lt;String, Long&gt;comparingByValue().reversed())
        .limit(<span class="hljs-number">10</span>)
        .forEach(entry -&gt; 
            System.out.println(entry.getKey() + <span class="hljs-string">": "</span> + entry.getValue())
        );
} <span class="hljs-keyword">catch</span> (IOException e) {
    e.printStackTrace();
}
</code></pre>
<h3 data-id="heading-31">示例3：复杂数据转换</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 多层数据转换和聚合</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span> {
    <span class="hljs-keyword">private</span> String customer;
    <span class="hljs-keyword">private</span> List&lt;OrderItem&gt; items;
    <span class="hljs-keyword">private</span> LocalDate orderDate;
    <span class="hljs-comment">// 构造方法、getter、setter省略</span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderItem</span> {
    <span class="hljs-keyword">private</span> String product;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> quantity;
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> price;
    <span class="hljs-comment">// 构造方法、getter、setter省略</span>
}

List&lt;Order&gt; orders = <span class="hljs-comment">// 初始化订单数据</span>

<span class="hljs-comment">// 计算每个客户的总消费金额</span>
Map&lt;String, Double&gt; customerTotal = orders.stream()
    .collect(Collectors.groupingBy(
        Order::getCustomer,
        Collectors.summingDouble(order -&gt; 
            order.getItems().stream()
                .mapToDouble(item -&gt; item.getQuantity() * item.getPrice())
                .sum()
        )
    ));

<span class="hljs-comment">// 找出最畅销的产品</span>
Optional&lt;String&gt; bestSellingProduct = orders.stream()
    .flatMap(order -&gt; order.getItems().stream())
    .collect(Collectors.groupingBy(
        OrderItem::getProduct,
        Collectors.summingInt(OrderItem::getQuantity)
    ))
    .entrySet().stream()
    .max(Map.Entry.comparingByValue())
    .map(Map.Entry::getKey);
</code></pre>
<h2 data-id="heading-32">最佳实践</h2>
<ol>
<li><strong>优先使用方法引用</strong>：使代码更简洁</li>
<li><strong>避免副作用</strong>：保持函数的纯粹性</li>
<li><strong>合理使用并行流</strong>：根据数据量和操作复杂度决定</li>
<li><strong>及时关闭资源</strong>：使用try-with-resources处理IO相关的Stream</li>
<li><strong>合理使用Optional</strong>：避免空指针异常</li>
</ol>
<h2 data-id="heading-33">总结</h2>
<p>JDK 8 的 Stream API 为集合操作提供了强大的函数式编程能力，通过链式调用和惰性求值等特性，可以写出更简洁、易读、高效的代码。掌握 Stream API 对于现代 Java 开发至关重要。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🐳 Docker Compose 项目目录被删除后，如何安全关停残留容器]]></title>    <link>https://juejin.cn/post/7571594817223966771</link>    <guid>https://juejin.cn/post/7571594817223966771</guid>    <pubDate>2025-11-12T09:19:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571594817223966771" data-draft-id="7571475192490393610" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🐳 Docker Compose 项目目录被删除后，如何安全关停残留容器"/> <meta itemprop="keywords" content="Docker"/> <meta itemprop="datePublished" content="2025-11-12T09:19:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Allenz"/> <meta itemprop="url" content="https://juejin.cn/user/1081575170128279"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🐳 Docker Compose 项目目录被删除后，如何安全关停残留容器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1081575170128279/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Allenz
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T09:19:07.000Z" title="Wed Nov 12 2025 09:19:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🐳 Docker Compose 项目目录被删除后，如何安全关停残留容器</h2>
<p>在日常使用 Docker Compose 时，我们经常会遇到一种情况：<br/>
项目目录被删除了，但容器依然在运行，<code>docker compose down</code> 也失效了。<br/>
本文总结了如何安全地清理这些“失联”的 Compose 项目。</p>
<hr/>
<h3 data-id="heading-1">一、发现问题：项目目录已丢失</h3>
<p>我们可以先列出所有 Compose 项目：</p>
<pre><code class="hljs language-bash" lang="bash">docker compose <span class="hljs-built_in">ls</span>
</code></pre>
<p>输出示例：</p>
<pre><code class="hljs language-scss" lang="scss">NAME            STATUS         CONFIG_FILES
webapp          <span class="hljs-built_in">running</span>(<span class="hljs-number">3</span>)     /home/user/webapp/docker-compose<span class="hljs-selector-class">.yml</span>
oldservice      <span class="hljs-built_in">running</span>(<span class="hljs-number">2</span>)     &lt;no such file or directory&gt;
</code></pre>
<p>可以看到 <code>oldservice</code> 的目录已经不存在，但容器还在运行。</p>
<hr/>
<h3 data-id="heading-2">二、确认该项目对应的容器</h3>
<p>Docker Compose 启动的容器都有一个统一的 label：<br/>
<code>com.docker.compose.project=&lt;project_name&gt;</code></p>
<p>通过它可以筛选出所有属于该项目的容器：</p>
<pre><code class="hljs language-css" lang="css">docker ps -<span class="hljs-selector-tag">a</span> <span class="hljs-attr">--filter</span> "<span class="hljs-selector-tag">label</span>=com<span class="hljs-selector-class">.docker</span><span class="hljs-selector-class">.compose</span><span class="hljs-selector-class">.project</span>=oldservice"
</code></pre>
<p>这会列出所有 <code>oldservice</code> 的容器。</p>
<hr/>
<h3 data-id="heading-3">三、关闭并删除这些容器</h3>
<p>停掉容器：</p>
<pre><code class="hljs language-css" lang="css">docker stop $(docker ps -<span class="hljs-selector-tag">q</span> <span class="hljs-attr">--filter</span> "<span class="hljs-selector-tag">label</span>=com<span class="hljs-selector-class">.docker</span><span class="hljs-selector-class">.compose</span><span class="hljs-selector-class">.project</span>=oldservice")
</code></pre>
<p>删除容器：</p>
<pre><code class="hljs language-bash" lang="bash">docker <span class="hljs-built_in">rm</span> $(docker ps -aq --filter <span class="hljs-string">"label=com.docker.compose.project=oldservice"</span>)
</code></pre>
<hr/>
<h3 data-id="heading-4">四、清理残留的网络和卷（可选）</h3>
<p>Compose 会创建网络和卷，也可以用 label 删除：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 删除网络</span>
docker network <span class="hljs-built_in">rm</span> $(docker network <span class="hljs-built_in">ls</span> -q --filter <span class="hljs-string">"label=com.docker.compose.project=oldservice"</span>)

<span class="hljs-comment"># 删除卷（⚠️ 慎用，会删除数据）</span>
docker volume <span class="hljs-built_in">rm</span> $(docker volume <span class="hljs-built_in">ls</span> -q --filter <span class="hljs-string">"label=com.docker.compose.project=oldservice"</span>)
</code></pre>
<p>执行前可以先查看确认：</p>
<pre><code class="hljs language-bash" lang="bash">docker network <span class="hljs-built_in">ls</span>
docker volume <span class="hljs-built_in">ls</span>
</code></pre>
<hr/>
<h3 data-id="heading-5">五、验证清理结果</h3>
<p>再次查看：</p>
<pre><code class="hljs language-bash" lang="bash">docker compose <span class="hljs-built_in">ls</span>
</code></pre>
<p>如果 <code>oldservice</code> 已经不在列表中，说明清理干净 ✅。</p>
<hr/>
<h3 data-id="heading-6">六、一键清理“失效项目”（可选脚本）</h3>
<p>如果有多个项目目录丢失，可以用下面的脚本自动检测并清理：</p>
<pre><code class="hljs language-bash" lang="bash">docker compose <span class="hljs-built_in">ls</span> --format json | jq -r <span class="hljs-string">'.[] | select(.ConfigFiles | test("no such file") or test("null")) | .Name'</span> |
<span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> name; <span class="hljs-keyword">do</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"Cleaning project: <span class="hljs-variable">$name</span>"</span>
  docker stop $(docker ps -q --filter <span class="hljs-string">"label=com.docker.compose.project=<span class="hljs-variable">$name</span>"</span>) 2&gt;/dev/null
  docker <span class="hljs-built_in">rm</span> $(docker ps -aq --filter <span class="hljs-string">"label=com.docker.compose.project=<span class="hljs-variable">$name</span>"</span>) 2&gt;/dev/null
  docker network <span class="hljs-built_in">rm</span> $(docker network <span class="hljs-built_in">ls</span> -q --filter <span class="hljs-string">"label=com.docker.compose.project=<span class="hljs-variable">$name</span>"</span>) 2&gt;/dev/null
<span class="hljs-keyword">done</span>
</code></pre>
<p>保存为 <code>docker-compose-clean.sh</code>，添加执行权限：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">chmod</span> +x docker-compose-clean.sh
</code></pre>
<p>运行即可批量清理失效的 Compose 项目。</p>
<hr/>
<h3 data-id="heading-7">✅ 总结</h3>








































<table><thead><tr><th>操作</th><th>命令 / 方法</th><th>说明</th></tr></thead><tbody><tr><td>查看项目</td><td><code>docker compose ls</code></td><td>检查是否有目录丢失</td></tr><tr><td>查看容器</td><td><code>docker ps -a --filter label=com.docker.compose.project=xxx</code></td><td>找到相关容器</td></tr><tr><td>停止容器</td><td><code>docker stop ...</code></td><td>关闭运行的容器</td></tr><tr><td>删除容器</td><td><code>docker rm ...</code></td><td>移除容器</td></tr><tr><td>删除网络和卷</td><td><code>docker network/volume rm ...</code></td><td>可选清理</td></tr><tr><td>批量清理脚本</td><td><code>docker-compose-clean.sh</code></td><td>一键清理失效项目</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[翻译界的 ChatGPT 时刻！Meta 发布新模型，几段示例学会冷门新语言]]></title>    <link>https://juejin.cn/post/7571655312798187546</link>    <guid>https://juejin.cn/post/7571655312798187546</guid>    <pubDate>2025-11-12T09:04:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571655312798187546" data-draft-id="7571594817223819315" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="翻译界的 ChatGPT 时刻！Meta 发布新模型，几段示例学会冷门新语言"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-11-12T09:04:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="新智元"/> <meta itemprop="url" content="https://juejin.cn/user/952600743642312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            翻译界的 ChatGPT 时刻！Meta 发布新模型，几段示例学会冷门新语言
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/952600743642312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    新智元
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T09:04:36.000Z" title="Wed Nov 12 2025 09:04:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0"/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35289ab50c1343c5ae82eb2d08fc5856~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543076&amp;x-signature=7s4ov%2BYyFOTClN666t4tf%2BWM%2Foc%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-1"><strong>「【新智元导读】在 7000 多种人类语言中，只有少数被现代语音技术听见，如今这种不平等或将被打破。Meta 发布的 Omnilingual ASR 系统能识别 1600 多种语言，并可通过少量示例快速学会新语言。以开源与社区共创为核心，这项技术让每一种声音都有机会登上 AI 的舞台。」</strong></h5>
<p>你或许很难想象，在世界上 7000 多种活跃语言中，只有几百种享受过现代语音技术的「宠爱」。</p>
<p>绝大多数人类语言的使用者——从非洲部落的土著、亚马逊雨林的族群，到乡野小镇仍讲着古老方言的老人—— 一直生活在数字时代的旁白之外。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8385a2a59613471e8d84945ce630f7e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543076&amp;x-signature=%2BzyFmllhH5FXPbKuVRKxbuqs8Ew%3D" alt="" loading="lazy"/></p>
<p>语音助手、自动字幕、实时翻译，这些 AI 带来的便利仿佛只为少数「主流」语言而生，其余的语言社区仍被挡在技术大门之外。</p>
<p>这种数字鸿沟如今迎来了破局者。</p>
<p>Meta 人工智能研究团队日前发布了 Omnilingual ASR 系统，一个可自动识别转录 1600 多种语言语音的 AI 模型族，让几乎所有人类语言都能被机器「听懂」。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70bda614815a488ab485b8cb8c9a8f6f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543076&amp;x-signature=juImunc4tN8uadBg438jrKZc92Q%3D" alt="" loading="lazy"/></p>
<p>这套系统以开源方式共享给全世界，并能由社区亲手拓展新的语言，让每一种声音都有机会登上 AI 的舞台。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8b0e708033a4de6b46e779c9d16db6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543076&amp;x-signature=z4vP4gaKh%2FcTFLa1jiVYB5rAMyU%3D" alt="" loading="lazy"/></p>
<p>论文地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fai.meta.com%2Fresearch%2Fpublications%2Fomnilingual-asr-open-source-multilingual-speech-recognition-for-1600-languages%2F" target="_blank" title="https://ai.meta.com/research/publications/omnilingual-asr-open-source-multilingual-speech-recognition-for-1600-languages/" ref="nofollow noopener noreferrer">ai.meta.com/research/pu…</a></p>
<p>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebookresearch%2Fomnilingual-asr%3Ftab%3Dreadme-ov-file" target="_blank" title="https://github.com/facebookresearch/omnilingual-asr?tab=readme-ov-file" ref="nofollow noopener noreferrer">github.com/facebookres…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0cb6f41908cb475c955b24b02d23122c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543076&amp;x-signature=H6vCf4i1zAPW8PXXDzzKTH6u5o4%3D" alt="" loading="lazy"/></p>
<p><strong>「1600 种语言，只是开始」</strong></p>
<p>Meta 此次推出的 Omnilingual ASR 创造了语音识别覆盖语言数量的新纪录，支持超过 1600 种语言，其中包括 500 种此前从未被任何 AI 系统转录过的语言。</p>
<p>相比之下，OpenAI 开源的 Whisper 模型只支持 99 种语言，而 Omnilingual ASR 几乎将这一数字提升了一个数量级。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b88fb1635b564555931fc7fbde9b0c53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543076&amp;x-signature=OJyAyTNYq3zAnTbKiZbuGhRpn5M%3D" alt="" loading="lazy"/></p>
<p>对于全球众多使用小语种的人来说，这无疑是一次「数字雪耻」：他们的母语第一次有了被 AI 流利听懂的可能性。</p>
<p>这套系统的识别性能在很多语种上已达到领先水平。</p>
<p>据 Meta 提供的数据，在所测试的 1600 多种语言中，有 78% 的语种其识别错误率（CER）低于 10%，若以 10 小时以上语音数据训练的语种来看，这一比例更是达到 95%。</p>
<p>即使对于训练语料极其稀少的低资源语言，仍有 36% 实现了 CER 低于 10% 的效果。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5bfe9ee07c47406f9c869a9ba3722975~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543076&amp;x-signature=xxw%2FXHHfK5Tc38OSxuGD%2FXlX4VY%3D" alt="" loading="lazy"/></p>
<p>这些数字意味着，Omnilingual ASR 不仅覆盖面广，而且在大多数语言上都能给出实用且高质量的转录结果。</p>
<p>然而，1600 种语言还不是 Omnilingual ASR 的终点。</p>
<p>更大的意义在于，它打破了以往 ASR 模型支持语言范围固定死板的局限，让语言覆盖从「定量」走向「可扩展」。</p>
<p>Omnilingual ASR 借鉴了大语言模型（LLM）的思路，引入了零样本的「上下文学习」机制。</p>
<p>这意味着即便某种语言最初不在支持列表中，用户也可以通过提供几段该语言的音频和对应文本作为示例，在推理过程中即时让模型学会一种新语言。</p>
<p>无需耗费数月收集大型语料、无需专业深度学习训练，只需简单的少样本学习（few-shot）即可学会新语言。</p>
<p>凭借这种革新性的范式，Omnilingual ASR 的潜在语言覆盖能力骤然扩张。</p>
<p>官方表示，理论上该系统可以扩展到超过 5400 种语言，几乎涵盖所有有文字记录的人类语言！</p>
<p>无论多冷门的口语，只要有对应的书写体系和几句示例，它就有机会被 Omnilingual ASR 捕捉记录。</p>
<p>在 AI 语音识别领域，这是从静态封闭走向动态自适应的范式转变——模型不再束缚于训练时预设的语言清单，而成为一个灵活开放的框架，鼓励各地社区自行加入新语言。</p>
<p>对于那些长期缺席于技术版图的族群来说，这无异于掌握了一把可以随时亲手「解锁」新语言的大门钥匙。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45cb950026544062a56224dbb63de755~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543076&amp;x-signature=PFiiO0esWWoXUY4DytwUlpxK6LU%3D" alt="" loading="lazy"/></p>
<p><strong>「开源与社区」</strong></p>
<p><strong>「打破语言鸿沟」</strong></p>
<p>Omnilingual ASR 的另一个显著特点在于其开源和社区驱动的属性。</p>
<p>Meta 选择将这一庞大的多语种 ASR 系统在 GitHub 上完全开源，采用 Apache 2.0 许可发布模型和代码。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e5d6eeb2e774ce5ad1a9db010859706~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543076&amp;x-signature=dRKP4NetL220b0bxe4WKBQbcU%2Bs%3D" alt="" loading="lazy"/></p>
<p>无论是研究人员、开发者还是企业机构，都可以免费使用、修改、商用这套模型，而无需担心繁琐的授权限制。</p>
<p>对比此前一些 AI 模型带有附加条款的「半开源」模式，Omnilingual ASR 的开放姿态可谓十分坦荡，为技术民主化树立了榜样。</p>
<p>为了让各语言社区都能受益，Meta 不仅开放了模型，还同步释放了一个巨大的多语言语音数据集——Omnilingual ASR 语料库。</p>
<p>该语料库包含了 350 种语料稀缺的语言的转录语音数据，覆盖了许多以前在数字世界中「失声」的语言。</p>
<p>所有数据以 CC-BY 协议开放提供。</p>
<p>开发者和学者可以利用这些宝贵资源，去训练改进适合本地需求的语音识别模型。</p>
<p>这一举措无疑将帮助那些缺乏大规模标注语料的语言跨越数据门槛，让「小语言」也有大作为的机会。</p>
<p>Omnilingual ASR 能够囊括前所未有的语言广度，离不开全球合作的支撑。</p>
<p>在开发过程中，Meta 与各地的语言组织和社区携手收集了大量语音样本。</p>
<p>他们与 Mozilla 基金会的 Common Voice 项目、非洲的 Lanfrica/NaijaVoices 等机构合作，从偏远地区招募母语人士录制语音。</p>
<p>为确保数据多样且贴近生活，这些录音往往采用开放式提问，让说话人自由表达日常想法。</p>
<p>所有参与者都获得了合理报酬，并遵循文化敏感性的指导进行采集。</p>
<p>这种社区共创的模式赋予了 Omnilingual ASR 深厚的语言学知识和文化理解，也彰显了项目的人文关怀：技术开发并没有也不应该居高临下地「拯救」小语种，而是与当地社区合作，让他们自己成为语言数字化的主角。</p>
<p>技术规格上，Meta 提供了一系列不同规模的模型以适配多样化的应用场景：从参数量约 3 亿的轻量级模型（适合手机等低功耗设备）到高达 70 亿参数的强力模型（追求极致准确率）一应俱全。</p>
<p>模型架构采用自监督预训练的 wav2vec 2.0 语音编码器（拓展到 70 亿参数规模）提取通用音频特征，并结合两种解码器策略：一种是传统的 CTC 解码，另一种则是融入 Transformer 的大模型文本解码器，后者赋予了模型强大的上下文学习能力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/deb9adaa872842d7b4b1d8a4947e7caa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543076&amp;x-signature=4hD54n%2Fbro7nBUj8flJV2%2BHOL44%3D" alt="" loading="lazy"/></p>
<p>庞大的模型需要海量数据来支撑——Omnilingual ASR 训练使用了超过 430 万小时的语音音频，涵盖 1239 种语言的素材。</p>
<p>这是有史以来最大规模、多样性最高的语音训练语料之一。如此大体量的数据加上社区贡献的长尾语言语料，确保了模型对各种语言都学到稳健的语音表示，甚至对完全没见过的语言也有良好的泛化基础。</p>
<p>正如研究论文所指出的，「没有任何模型能预先涵盖世界上所有语言，但 Omnilingual ASR 让社区能够用自己的数据持续拓展这份清单」。</p>
<p>这标志着语音 AI 从此具备了自我生长的生命力，能够与人类语言的丰富多样性共同进化。</p>
<p>当技术放下傲慢，以开源姿态拥抱多元，当每一种语言的声音都有机会被聆听和记录，当没有任何一种语言被数字世界遗忘，我们离真正消弭语言鸿沟又近了一大步，人类的连接才能真正开始消除边界。</p>
<p>参考资料：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fai.meta.com%2Fblog%2Fomnilingual-asr-advancing-automatic-speech-recognition" target="_blank" title="https://ai.meta.com/blog/omnilingual-asr-advancing-automatic-speech-recognition" ref="nofollow noopener noreferrer">ai.meta.com/blog/omnili…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[全球第二、国内第一！钉钉发布DeepResearch多智能体框架，已在真实企业部署]]></title>    <link>https://juejin.cn/post/7571655312798203930</link>    <guid>https://juejin.cn/post/7571655312798203930</guid>    <pubDate>2025-11-12T09:07:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571655312798203930" data-draft-id="7571644531607814190" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="全球第二、国内第一！钉钉发布DeepResearch多智能体框架，已在真实企业部署"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-11-12T09:07:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            全球第二、国内第一！钉钉发布DeepResearch多智能体框架，已在真实企业部署
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T09:07:40.000Z" title="Wed Nov 12 2025 09:07:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在数字经济浪潮中，企业对于高效、精准的信息获取与决策支持的需求日益迫切。从前沿科学探索到行业趋势分析，再到企业级决策支持，一个能够从海量异构数据源中提取关键知识、执行多步骤推理并生成结构化或多模态输出的「深度研究系统」正变得不可或缺。</p>
<p>然而，现有的研究系统，尽管各自在特定领域有所建树，却普遍面临着难以适应真实世界企业环境的挑战：</p>
<ul>
<li>
<p><strong>静态架构与缺乏适应性：</strong>  多数系统依赖静态提示或固定脚本，缺乏从真实世界反馈中学习和优化的机制，难以适应不断变化的业务需求和数据分布。</p>
</li>
<li>
<p><strong>私有数据集成与动态优化不足：</strong>  现有的研究型智能体，如 OpenAI 的 GPT 代理，在集成公共信息源方面表现出色，但往往难以安全、高效地整合企业私有数据，也缺乏动态优化能力。</p>
</li>
<li>
<p><strong>缺乏自动化评估与持续优化：</strong>  像 Anthropic 的 Claude Research Workbench 虽然强调安全性与人机协作，但缺少自动评估和连续优化机制，难以在部署环境中实现持续改进。</p>
</li>
<li>
<p><strong>长短期记忆与动态演进机制缺失：</strong>  多数系统缺乏有效的长短期记忆能力，无法积累和重用历史经验，导致智能体在处理复杂、长期任务时效率低下且无法持续进步。</p>
</li>
<li>
<p><strong>表格结构化推理与文本合成的脱节：</strong>  企业数据中包含大量半结构化或复杂表格，但现有系统往往难以将表格的精确符号推理与非结构化文本的生成合成有效结合。</p>
</li>
<li>
<p><strong>缺乏评估驱动的闭环迭代：</strong>  许多系统缺少一个评估驱动的闭环优化流程，无法系统性地识别低性能案例、进行有针对性的改进并防止性能退化。</p>
</li>
</ul>
<p>为了填补这些空白，阿里巴巴钉钉（Dingtalk）团队提出了 Dingtalk-DeepResearch，一个为复杂、演进的企业任务设计的统一多智能体智能框架，旨在整合深度研究生成、异构表格推理和多模态报告合成，从而提供一个适应性强、可部署、企业级的解决方案。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16c8be25baeb4a36ae48dee4bfb54e6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543259&amp;x-signature=U5MTR7TrHGfd2FdmbRIFmvEmHLU%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>
<p>论文标题：Dingtalk DeepResearch: A Unified Multi Agent Framework for Adaptive Intelligence in Enterprise Environments</p>
</li>
<li>
<p>论文地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2510.24760" target="_blank" title="https://arxiv.org/abs/2510.24760" ref="nofollow noopener noreferrer">arxiv.org/abs/2510.24…</a></p>
</li>
</ul>
<p>Dingtalk-DeepResearch 在国际权威深度研究评测 DeepResearch Bench 中取得 48.49 高分（全球第二、国内第一），显著超越包括 OpenAI、Claude 在内的主流系统；并在 ResearcherBench 达到 0.6050 平均覆盖率（全球第三、国内第一）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5eb7319ad06f46d58474c0790462ed47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543259&amp;x-signature=Lpk6QpNI5fUhPryveF%2FPVI6cNYM%3D" alt="图片" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/067e089e80ba466b9475dc03521a06d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543259&amp;x-signature=wo2YYRyjTqW8WUBa2Ip6Jnyn8Ec%3D" alt="图片" loading="lazy"/></p>
<p>更关键的是，该框架已稳定部署于制造业、供应链等真实企业场景，能够在复杂异构表格、多阶段推理与多模态生成任务中保持行业领先的准确性和稳健性，实现了国际顶级基准与实际生产落地的双重突破。</p>
<h3 data-id="heading-0">总体架构：</h3>
<h3 data-id="heading-1">构建企业智能的大脑</h3>
<p>Dingtalk-DeepResearch 框架采用分层设计，旨在为企业提供一个全面而灵活的智能中枢：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d91dd5fca2446b1a41597e53c721b93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543259&amp;x-signature=Fb0bdpWPSuxh15O1IL%2F6qSBFyfo%3D" alt="图片" loading="lazy"/></p>
<p><strong>Dingtalk-DeepResearch Agent Studio：这一层提供了专业的智能体，专门用于深度研究、表格数据处理和数据分析。同时，它也支持可定制的个人智能体，以满足不同用户的特定需求。这体现了框架的 flexibility 和个性化能力。</strong></p>
<p><strong>Dingtalk-DeepResearch Core：这一层</strong>作为框架的「大脑」，它集成了上下文压缩、推理与规划、长短期记忆和人机协作控制等关键功能。该核心还包括一个自演进引擎 (DingAutoEvaluator)和一套丰富的集成工具，支持代码执行、网络搜索、文件与表格检索及多模态处理。值得注意的是，它能与钉钉生态系统连接，并在用户授权下安全访问个人工作文档。所有这些能力均由经过 CPT、SFT 和 RL 训练的 LLM 驱动。<br/>
<strong>Dingtalk-DeepResearch Data Layer：这一层是</strong>一个统一的数据骨干。它整合了知识图谱、数据库、缓存以及包括对话、音视频、图、文本和表格在内的多模态数据集。该层汇集了业务、行业、个人及合成数据，为智能体检索和关联多样化的企业及行业数据提供了基础。</p>
<h3 data-id="heading-2">详细方法：</h3>
<h3 data-id="heading-3">自适应智能的核心机制</h3>
<p>Dingtalk-DeepResearch 的创新之处在于其独特的方法论，尤其是在文档生成、在线学习和表格推理方面。</p>
<p><strong>大规模多阶段文档强化学习：构建文档生成专家</strong></p>
<p>为了赋予 Dingtalk-DeepResearch 强大的文档生成能力，该框架设计了一个多阶段训练管道，结合了大规模奖励建模、结构化查询格式的监督微调以及在静态和实时内容流上的强化学习，并通过真实用户数据进行在线偏好优化。</p>
<ul>
<li>阶段 1：奖励模型（Doc-RM）训练</li>
</ul>
<p>此阶段的目标是训练一个文档专属的奖励模型（Doc-RM）。团队使用了约 80 万个人工标注的正负样本对 ，这些样本根据事实准确性、语义覆盖、逻辑结构和呈现清晰度进行评估 。该模型将作为后续强化学习阶段的评分骨干 。</p>
<ul>
<li>阶段 2：结构化查询格式的冷启动监督微调 (SFT)</li>
</ul>
<p>为使模型掌握特定的输出格式，团队使用了 3,200 个精选样本进行 SFT 。这些样本涵盖四大类格式：视觉呈现生成（如 Markdown 格式的 PPT）、结构化数据解释（如表格解析）、综合多章节叙述 和领域特定模板 。此阶段会奖励兼具内容准确性、逻辑结构和美观文本格式的输出 ，为后续 RL 调优奠定基础 。</p>
<ul>
<li>阶段 3：静态文档集合上的强化学习 (RL)</li>
</ul>
<p>利用训练好的 Doc-RM 作为奖励函数 ，智能体在大型离线文档库上进行强化学习。它通过检索静态文档、合成答案，并根据覆盖范围、事实正确性和连贯性获得奖励 ，从而在受控环境中建立稳定的合成能力基线 。</p>
<ul>
<li>阶段 4：实时文档获取上的强化学习 (RL)</li>
</ul>
<p>为处理时效性信息，RL 被扩展到实时内容检索 。团队设计了 10,000 个时间敏感查询 ，覆盖了需要避免「事后偏见」的场景（如财务预测）和需要最新信息的「过时信息」场景（如突发新闻）。系统通过实时搜索获取最新文档，并由 Doc-RM 结合定制的奖惩结构（强调时间正确性）进行评分 。</p>
<ul>
<li>阶段 5：基于 Copilot 的真实用户交互在线直接偏好优化 (DPO)</li>
</ul>
<p>在实际部署中，系统作为用户 Copilot 运行 。通过收集模型的原始输出和用户的编辑版本，系统会提取高影响力的差异 ，并将其构造成在线 DPO 数据集，从而持续向用户的特定偏好进行微调 。</p>
<p>通过这一多阶段方法，Dingtalk-DeepResearch 不仅获得了强大的文档生成能力，还实现了对不断变化的真实世界信息需求的自适应响应。</p>
<p><strong>熵引导记忆检索自适应在线学习：无需微调 LLM 的持续演进</strong></p>
<p>Dingtalk-DeepResearch 的一个显著特点是其熵引导、记忆感知的在线学习机制。该机制允许智能体在不微调底层 LLM 参数的情况下，持续适应不断演变的任务。系统并非依赖静态提示，而是从一个外部的 episodic memory bank 中动态选择和重用先前的案例 ，平衡了对高价值经验的利用和对多样化历史情境的探索。</p>
<p>智能体会根据当前任务状态计算存储案例的概率分布，该分布受其估计的 Q 值和温度参数的调节 。这鼓励了对替代案例的探索，减轻了对早期经验的过拟合 。同时，记忆感知组件通过学习到的语义相似性来确保上下文相关性，从而准确地重新应用多步骤推理模式和工具调用序列 。</p>
<p>该机制被集成到规划器-执行器循环中 ，每次执行都会更新案例库，在线重新训练检索策略，并逐步提高推理性能 。此外，该系统将这种记忆驱动的范式扩展到个性化层面，通过构建用户画像、文档交互历史和先前工作流的长期结构化记忆 ，智能体能够更深入地理解用户的工作风格和需求，从而提供日益相关和高效的辅助。</p>
<p><strong>结构感知异构表格解析、检索与推理：企业级数据处理的利器</strong></p>
<p>在企业环境中，表格数据往往与文本叙述混合，形式多样且结构复杂。Dingtalk-DeepResearch 的表格问答模块通过结合布局感知表格建模和异构检索-执行，实现了精确且可解释的推理。</p>
<ul>
<li><strong>数据摄入 (Data Ingestion)</strong></li>
</ul>
<p>系统在摄入半结构化表格时会保留其原始布局，而非扁平化为纯文本。表格被解析为捕获了标题、合并单元格和嵌套关系的层次化表示。同时，表格也以标准化模式存储在关系数据库中，其 Markdown 渲染版本则加入文本知识库。这种双存储方法保持了结构完整性，并同时支持符号查询和向量检索。</p>
<ul>
<li><strong>结构化解析 (Structural Parsing)</strong></li>
</ul>
<p>系统应用多模态检测器来区分标题和内容单元格 ，推断列类型（如离散、连续），并分析布局以识别嵌入的子表 。这些丰富的模式注解为精确推理奠定了基础 。</p>
<ul>
<li><strong>语义理解 (Semantic Understanding)</strong></li>
</ul>
<p>系统会将用户问题分解为感知文本和表格上下文的特定模态子查询 。查询词汇通过嵌入相似性和类型感知标记与数据库模式及文本实体对齐 。这种分解能确保表格相关子查询被直接用于符号执行，而文本子查询则交由文档检索器处理 。</p>
<ul>
<li><strong>表格推理 (Tabular Reasoning)</strong></li>
</ul>
<p>对于表格子查询，系统会调用 NL2SQL 生成器 ，在关系数据库上生成可执行的 SQL 语句，以执行聚合、过滤或多跳连接 。得益于评估驱动的开发范式，DingAutoEvaluator 会持续发现低准确度的案例 ，并将其反馈到专用训练循环中以重新训练 NL2SQL 生成器 ，从而提高其鲁棒性和执行可靠性 。</p>
<ul>
<li><strong>表格检索 (Table Retrieval)</strong></li>
</ul>
<p>系统采用混合的自顶向下和自底向上检索策略 。检索过程分两阶段：首先从文本知识库和 Markdown 渲染的表格中进行密集向量召回 ，然后使用模式感知的相关性模型进行语义重排序 。</p>
<p>这种紧密集成结构保留摄入、精确解析、上下文感知分解、符号 SQL 推理和自适应检索的方法，使 Dingtalk-DeepResearch 能够大规模处理真实世界中的异构数据，提供稳健的企业级表格问答能力。</p>
<p><strong>DingAutoEvaluator：数据飞轮与持续优化的核心驱动</strong></p>
<p>DingAutoEvaluator 是 Dingtalk-DeepResearch 实现持续演进的关键。它是一个自动化评估平台，作为数据飞轮和性能演进的核心驱动力，将开发范式从启发式迭代和零星手动检查转变为完全评估驱动的方法。</p>
<p>该过程始于不确定性感知案例挖掘。系统会持续监控模型在检索和生成层面的认知不确定性峰值 ，这些「灰色地带」的输出（即模型能力边缘的推理）会被自动识别并优先提交给专家标注者 。</p>
<p>随后，平台中精心策划的多个「教师模型」会根据一系列多维度评估指标全面检查框架的输出 。这个统一的测量框架 涵盖了 RAG、LLM、推理、智能体框架和知识库健康度等多个方面 。关键指标类别包括：</p>
<ul>
<li>
<p>RAG 评估：如上下文精度和答案忠实度。</p>
</li>
<li>
<p>LLM 评估：如响应准确性和意图识别。</p>
</li>
<li>
<p>推理评估：如逻辑连贯性和思维一致性。</p>
</li>
<li>
<p>智能体框架评估：如任务依从性和工具使用正确性。</p>
</li>
<li>
<p>知识库评估：如知识过时率 。</p>
</li>
</ul>
<p>这些指标不仅用于离线基准测试，还作为在线监控循环中的实时信号，为数据飞轮提供高价值案例，并为奖励建模和持续优化提供信号。</p>
<h3 data-id="heading-4">实验结果与案例展示：</h3>
<h3 data-id="heading-5">能力验证与实际应用</h3>
<p>论文通过多个实际案例展示了 Dingtalk-DeepResearch 的端到端能力，特别是在复杂表格数据解析、检索、推理以及多模态文档生成方面。</p>
<p><strong>复杂表格解析、检索与推理案例</strong></p>
<p>在案例 A 中，系统处理了一个包含库存、多周预测和多式联运计划的复杂表格。Dingtalk-DeepResearch 能够准确解析多节生产记录、发货计划和物流说明，实现精确的信息检索与合成。该方法可扩展到多个大型文件（如案例中 8 个相似的 1200 行文件），显示了其鲁棒性和实用性。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d00494f8564544daade9f3172dcbfe06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543259&amp;x-signature=l9Jh1y045BJrSC5NBu21uoqxjkY%3D" alt="图片" loading="lazy"/></p>
<p>在案例 B 中，系统处理了一个 1200 行的周生产记录 103，并回答了关于 2025 年第一季度总产量的提问 104。系统清晰地展示了其端到端流程：</p>
<ul>
<li>
<p>问题分解：将复杂问题分解为四个步骤，包括定位表格、识别时间范围、提取数据和汇总。</p>
</li>
<li>
<p>表格检索与模式链接：系统成功定位到「YF Seat Weekly Production Statistics on Dec 30, 2024」表格 106，并将「Q1 2025」链接到 13 个具体的周次列。</p>
</li>
<li>
<p>SQL 生成与执行：系统生成了精确的 SUM 聚合 SQL 语句 108，并成功执行得出 total_production = 245036。</p>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f28bdd2f14e4f9f8e9447ef73a69b3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543259&amp;x-signature=ZAiREWG6si78B8UtvluiByzVAmA%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>最终答案：基于执行结果，系统给出了「...2025 年第一季度...所有产品的总产量为 245036 件」的准确回答。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e77a5cdd33ac4fc5bf00a551f448ecaa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543259&amp;x-signature=Q7Qyi5pPJiEcsfD4GovJxSbMEpg%3D" alt="图片" loading="lazy"/></p>
<p><strong>语义对齐的视觉-语言融合多模态文档生成</strong></p>
<p>该框架还展示了其在 Kaggle 竞赛案例（厄瓜多尔超市销售预测）中的端到端自动化能力 。从源代码、数据处理、统计可视化到最终的分析报告，全部由 Dingtalk-DeepResearch 自动生成和执行，无需任何人工干预 。</p>
<p>这证明了系统在一个统一的深度研究工作流中，集成了代码合成、执行和多模态结果呈现的能力 。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03cc4bfbb46642d1bb70bee758055497~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543259&amp;x-signature=nvOvOVNwjKi6N9PFsnf%2FwcCUpR4%3D" alt="图片" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05f481ef57cb4a2ab7289626e33368ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543259&amp;x-signature=FKtnerw1jW6XMG9D0mv0hgOF9Ik%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-6">结论：</h3>
<h3 data-id="heading-7">面向未来的企业级自适应智能</h3>
<p>Dingtalk-DeepResearch 提出了一种统一的多智能体智能框架，专为企业环境设计，其核心优势在于：</p>
<ul>
<li>
<p>熵引导在线学习，实现无需频繁微调 LLM 的自适应能力。</p>
</li>
<li>
<p>大规模多阶段文档强化学习，显著提升文档生成的事实准确性、结构质量和用户对齐度。</p>
</li>
<li>
<p>结构感知异构表格推理，能够有效处理真实世界中复杂多样的表格数据。</p>
</li>
<li>
<p>DingAutoEvaluator 自动化评估引擎，通过不确定性感知案例挖掘和多维度指标，形成数据飞轮，驱动模型的持续优化和防范性能退化。</p>
</li>
</ul>
<p>Dingtalk-DeepResearch 已经成功部署在企业内部工作流程中，并即将作为钉钉的服务对外开放，这将为更广泛的企业用户提供适应性强、评估驱动、多模态推理的复杂任务解决方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于 PVE 8.1 的 CentOS / Ubuntu / Docker / Kubernetes 部署手册]]></title>    <link>https://juejin.cn/post/7571650164843233314</link>    <guid>https://juejin.cn/post/7571650164843233314</guid>    <pubDate>2025-11-12T09:13:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571650164843233314" data-draft-id="7571636682694918184" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于 PVE 8.1 的 CentOS / Ubuntu / Docker / Kubernetes 部署手册"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-12T09:13:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="微学网络"/> <meta itemprop="url" content="https://juejin.cn/user/1216516089188397"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于 PVE 8.1 的 CentOS / Ubuntu / Docker / Kubernetes 部署手册
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1216516089188397/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    微学网络
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T09:13:38.000Z" title="Wed Nov 12 2025 09:13:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">基于 PVE 8.1 的 CentOS / Ubuntu / Docker / Kubernetes 部署手册</h2>
<blockquote>
<p>适用场景：一台已安装 Proxmox VE 8.1 的物理服务器，需要同时运行多个 CentOS 虚拟机（或 LXC 容器）以部署 Docker 环境，并部署一个 Ubuntu 虚拟机用于 Docker 与 Kubernetes（K8s）集群的搭建与管理。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">1. 前提条件与规划</h3>
<ul>
<li><strong>硬件资源</strong>：至少 8 核 CPU、32 GB 内存、500 GB SSD/NVMe（根据实际业务扩展，K8s 建议 64 GB+ 内存）。</li>
<li><strong>网络规划</strong>：</li>
<li>管理网段：<code>192.168.10.0/24</code>（PVE 管理、SSH）</li>
<li>生产网段：<code>192.168.20.0/24</code>（虚拟机业务流量，可选）</li>
<li>Kubernetes Pod 网段：<code>10.244.0.0/16</code>（以 Flannel 为例）</li>
<li>Service 网段：<code>10.96.0.0/12</code></li>
<li><strong>PVE 存储</strong>：建议划分 <code>local</code>（镜像/ISO）、<code>local-lvm</code>（VM 磁盘），如使用 Ceph/NFS 需提前配置。</li>
<li><strong>镜像准备</strong>：</li>
<li><code>CentOS 7/Stream 8/9</code> ISO（官方）</li>
<li><code>Ubuntu Server 22.04 LTS</code> ISO</li>
<li><strong>账号与权限</strong>：准备至少一个有 PVE <code>root@pam</code> 权限的账号 &amp; SSH 公钥。</li>
</ul>
<hr/>
<h3 data-id="heading-2">2. PVE 8.1 基础配置</h3>
<h4 data-id="heading-3">2.1 更新 PVE 与订阅设置</h4>
<pre><code class="hljs language-bash" lang="bash">apt update &amp;&amp; apt full-upgrade -y  
sed -i <span class="hljs-string">'s/enterprise/no-subscription/g'</span> /etc/apt/sources.list.d/pve-enterprise.list  
<span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">'EOF'</span> &gt;/etc/apt/sources.list.d/pve-no-subscription.list  
deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription  
EOF  
apt update &amp;&amp; apt full-upgrade -y  
</code></pre>
<h4 data-id="heading-4">2.2 创建桥接网络</h4>
<ol>
<li>登录 PVE Web 界面 → <code>数据中心</code> → <code>节点</code> → <code>系统</code> → <code>网络</code></li>
<li>创建 <code>vmbr1</code> 作为业务网桥（如需要）：</li>
</ol>
<ul>
<li>类型：Linux Bridge</li>
<li>物理接口：<code>enp3s0</code>（示例）</li>
<li>IPv4/IPv6 配置：按规划填写或留空</li>
</ul>
<ol start="3">
<li>应用更改并重启网络服务：<code>ifreload -a</code></li>
</ol>
<hr/>
<h3 data-id="heading-5">3. 安装多个 CentOS + Docker</h3>
<h4 data-id="heading-6">3.1 创建 CentOS 模板虚拟机</h4>
<ol>
<li>上传 ISO：<code>数据中心</code> → <code>存储</code> → <code>local</code> → <code>内容</code> → <code>上传</code> ISO。</li>
<li>新建 VM 参数建议：</li>
</ol>
<ul>
<li>ID：<code>2001</code></li>
<li>名称：<code>tmpl-centos7</code></li>
<li>BIOS：<code>OVMF (UEFI)</code> 或 <code>SeaBIOS</code>（取决于需求）</li>
<li>SCSI 控制器：<code>VirtIO SCSI</code></li>
<li>磁盘：<code>32 GB</code>（Thin provision）</li>
<li>CPU：<code>4 cores</code>，类型 <code>host</code></li>
<li>内存：<code>8 GB</code></li>
<li>网络：<code>vmbr0</code>，型号 <code>VirtIO (paravirtualized)</code></li>
</ul>
<ol start="3">
<li>启动 VM，按常规流程安装 CentOS（Minimal）。</li>
<li>安装基础工具与 QEMU Guest Agent：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">sudo yum install -y epel-release  
sudo yum install -y qemu-guest-agent vim curl wget net-tools  
sudo systemctl <span class="hljs-built_in">enable</span> --now qemu-guest-agent  
</code></pre>
<ol start="5">
<li>配置静态 IP（示例）：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">nmcli con mod ens18 ipv4.addresses 192.168.10.101/24  
nmcli con mod ens18 ipv4.gateway 192.168.10.1  
nmcli con mod ens18 ipv4.dns <span class="hljs-string">"8.8.8.8 114.114.114.114"</span>  
nmcli con mod ens18 ipv4.method manual  
nmcli con up ens18  
</code></pre>
<ol start="6">
<li>更新系统并清理：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">sudo yum update -y  
sudo yum clean all  
</code></pre>
<ol start="7">
<li>关机后在 PVE Web 上右键 VM → <code>转换为模板</code>。</li>
</ol>
<h4 data-id="heading-7">3.2 快速克隆多个 CentOS 实例</h4>
<ol>
<li>右键模板 <code>tmpl-centos7</code> → <code>克隆</code></li>
<li>设置：</li>
</ol>
<ul>
<li>VM ID：依次递增 <code>2010</code>, <code>2011</code>, …</li>
<li>名称：<code>centos-docker-01</code> 等</li>
<li>选择 <code>完整克隆</code> 或 <code>链接克隆</code>（使用 Ceph/ZFS 建议链接克隆）</li>
</ul>
<ol start="3">
<li>克隆完成后启动 VM，修改主机名与 IP：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">sudo hostnamectl set-hostname centos-docker-01  
nmcli con mod ens18 ipv4.addresses 192.168.10.110/24  
nmcli con mod ens18 ipv4.gateway 192.168.10.1  
nmcli con up ens18  
</code></pre>
<h4 data-id="heading-8">3.3 安装 Docker CE（CentOS）</h4>
<pre><code class="hljs language-bash" lang="bash">sudo yum install -y yum-utils device-mapper-persistent-data lvm2  
sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo  
sudo yum install -y docker-ce docker-ce-cli containerd.io  
sudo <span class="hljs-built_in">mkdir</span> -p /etc/docker  
<span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">'EOF'</span> | sudo <span class="hljs-built_in">tee</span> /etc/docker/daemon.json  
{  
<span class="hljs-string">"registry-mirrors"</span>: [  
<span class="hljs-string">"https://docker.m.daocloud.io"</span>,  
<span class="hljs-string">"https://hub-mirror.c.163.com"</span>  
],  
<span class="hljs-string">"exec-opts"</span>: [<span class="hljs-string">"native.cgroupdriver=systemd"</span>],  
<span class="hljs-string">"log-driver"</span>: <span class="hljs-string">"json-file"</span>,  
<span class="hljs-string">"log-opts"</span>: {  
<span class="hljs-string">"max-size"</span>: <span class="hljs-string">"100m"</span>  
},  
<span class="hljs-string">"storage-driver"</span>: <span class="hljs-string">"overlay2"</span>  
}  
EOF  
sudo systemctl <span class="hljs-built_in">enable</span> --now docker  
sudo usermod -aG docker <span class="hljs-variable">$USER</span>  
</code></pre>
<blockquote>
<p><strong>提示</strong>：批量节点可通过 <code>cloud-init</code> 或 <code>Ansible</code> 推送上述配置。</p>
</blockquote>
<hr/>
<h3 data-id="heading-9">4. 部署 Ubuntu + Docker 用于 Kubernetes</h3>
<h4 data-id="heading-10">4.1 创建 Ubuntu 虚拟机</h4>
<ol>
<li>新建 VM（示例 ID：<code>3001</code>，名称 <code>ubuntu-master</code>），参数：</li>
</ol>
<ul>
<li>CPU：<code>6 cores</code></li>
<li>内存：<code>16 GB</code></li>
<li>磁盘：<code>64 GB</code></li>
<li>网络：<code>vmbr0</code>（管理），必要时添加第二块网卡 <code>vmbr1</code></li>
</ul>
<ol start="2">
<li>安装 Ubuntu Server 22.04，开启 <code>OpenSSH Server</code> 组件。</li>
<li>配置静态 IP（<code>netplan</code>）：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">sudo nano /etc/netplan/01-netcfg.yaml  
</code></pre>
<p>示例：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">network:</span>  
<span class="hljs-attr">version:</span> <span class="hljs-number">2</span>  
<span class="hljs-attr">renderer:</span> <span class="hljs-string">networkd</span>  
<span class="hljs-attr">ethernets:</span>  
<span class="hljs-attr">ens18:</span>  
<span class="hljs-attr">addresses:</span>  
<span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.120</span><span class="hljs-string">/24</span>  
<span class="hljs-attr">gateway4:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.1</span>  
<span class="hljs-attr">nameservers:</span>  
<span class="hljs-attr">addresses:</span> [<span class="hljs-number">8.8</span><span class="hljs-number">.8</span><span class="hljs-number">.8</span>, <span class="hljs-number">223.5</span><span class="hljs-number">.5</span><span class="hljs-number">.5</span>]  
</code></pre>
<p>应用：<code>sudo netplan apply</code></p>
<h4 data-id="heading-11">4.2 安装 Docker CE（Ubuntu）</h4>
<pre><code class="hljs language-bash" lang="bash">sudo apt update  
sudo apt install -y ca-certificates curl gnupg lsb-release  
sudo <span class="hljs-built_in">mkdir</span> -p /etc/apt/keyrings  
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg  
<span class="hljs-built_in">echo</span> \  
<span class="hljs-string">"deb [arch=<span class="hljs-subst">$(dpkg --print-architecture)</span> signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \  
<span class="hljs-subst">$(lsb_release -cs)</span> stable"</span> | sudo <span class="hljs-built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null  
sudo apt update  
sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin  
sudo systemctl <span class="hljs-built_in">enable</span> --now docker  
sudo usermod -aG docker <span class="hljs-variable">$USER</span>  
</code></pre>
<hr/>
<h3 data-id="heading-12">5. 使用 kubeadm 构建 K8s 集群</h3>
<blockquote>
<p>建议使用 Ubuntu 节点作为控制平面；工作节点可选择 CentOS 或 Ubuntu。以下示例：1 Master + 2 Worker。</p>
</blockquote>
<h4 data-id="heading-13">5.1 节点规划</h4>





























<table><thead><tr><th>角色</th><th>主机名</th><th>IP</th><th>系统</th></tr></thead><tbody><tr><td>Master</td><td><code>k8s-master-01</code></td><td><code>192.168.10.120</code></td><td>Ubuntu 22.04</td></tr><tr><td>Worker 01</td><td><code>k8s-worker-01</code></td><td><code>192.168.10.130</code></td><td>CentOS 7/Stream</td></tr><tr><td>Worker 02</td><td><code>k8s-worker-02</code></td><td><code>192.168.10.131</code></td><td>CentOS 7/Stream</td></tr></tbody></table>
<h4 data-id="heading-14">5.2 通用系统设置</h4>
<pre><code class="hljs language-bash" lang="bash">sudo swapoff -a  
sudo sed -i <span class="hljs-string">'/ swap / s/^/#/'</span> /etc/fstab  
sudo modprobe br_netfilter  
<span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">'EOF'</span> | sudo <span class="hljs-built_in">tee</span> /etc/modules-load.d/k8s.conf  
br_netfilter  
EOF  
<span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">'EOF'</span> | sudo <span class="hljs-built_in">tee</span> /etc/sysctl.d/k8s.conf  
net.bridge.bridge-nf-call-iptables = 1  
net.bridge.bridge-nf-call-ip6tables = 1  
net.ipv4.ip_forward = 1  
EOF  
sudo sysctl --system  
</code></pre>
<h4 data-id="heading-15">5.3 安装容器运行时（containerd）</h4>
<blockquote>
<p>Kubernetes 官方推荐使用 containerd。可沿用 Docker 安装包内的 containerd，或单独安装。</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash">sudo <span class="hljs-built_in">mkdir</span> -p /etc/containerd  
containerd config default | sudo <span class="hljs-built_in">tee</span> /etc/containerd/config.toml  
sudo sed -i <span class="hljs-string">'s/SystemdCgroup = false/SystemdCgroup = true/'</span> /etc/containerd/config.toml  
sudo systemctl restart containerd  
sudo systemctl <span class="hljs-built_in">enable</span> containerd  
</code></pre>
<h4 data-id="heading-16">5.4 安装 Kubernetes 组件</h4>
<h5 data-id="heading-17">在 Ubuntu 节点：</h5>
<pre><code class="hljs language-bash" lang="bash">sudo apt update  
sudo apt install -y apt-transport-https ca-certificates curl  
sudo curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg  
<span class="hljs-built_in">echo</span> <span class="hljs-string">"deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main"</span> | \  
sudo <span class="hljs-built_in">tee</span> /etc/apt/sources.list.d/kubernetes.list  
sudo apt update  
sudo apt install -y kubelet kubeadm kubectl  
sudo apt-mark hold kubelet kubeadm kubectl  
</code></pre>
<h5 data-id="heading-18">在 CentOS 节点：</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">'EOF'</span> | sudo <span class="hljs-built_in">tee</span> /etc/yum.repos.d/kubernetes.repo  
[kubernetes]  
name=Kubernetes  
baseurl=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/  
enabled=1  
gpgcheck=1  
gpgkey=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/repodata/repomd.xml.key  
EOF  
sudo yum install -y kubelet kubeadm kubectl  
sudo systemctl <span class="hljs-built_in">enable</span> --now kubelet  
</code></pre>
<blockquote>
<p>注意：保持所有节点的 <code>kubelet/kubeadm/kubectl</code> 版本一致。</p>
</blockquote>
<h4 data-id="heading-19">5.5 初始化控制平面</h4>
<p>在 Master 节点执行：</p>
<pre><code class="hljs language-bash" lang="bash">sudo kubeadm init \  
--apiserver-advertise-address=192.168.10.120 \  
--pod-network-cidr=10.244.0.0/16 \  
--service-cidr=10.96.0.0/12  
</code></pre>
<p>初始化完成后，按提示配置 <code>kubectl</code>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$HOME</span>/.kube  
sudo <span class="hljs-built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="hljs-variable">$HOME</span>/.kube/config  
sudo <span class="hljs-built_in">chown</span> $(<span class="hljs-built_in">id</span> -u):$(<span class="hljs-built_in">id</span> -g) <span class="hljs-variable">$HOME</span>/.kube/config  
</code></pre>
<h4 data-id="heading-20">5.6 安装网络插件（Flannel 示例）</h4>
<pre><code class="hljs language-bash" lang="bash">kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml  
</code></pre>
<h4 data-id="heading-21">5.7 加入 Worker 节点</h4>
<p>在每个 Worker 上执行 Master 输出的 <code>kubeadm join</code> 命令（如丢失可重新生成）：</p>
<pre><code class="hljs language-bash" lang="bash">sudo kubeadm token create --print-join-command  
</code></pre>
<p>执行后检查集群状态：</p>
<pre><code class="hljs language-bash" lang="bash">kubectl get nodes  
kubectl get pods -A  
</code></pre>
<hr/>
<h3 data-id="heading-22">6. Docker / Kubernetes 常见运维</h3>
<ul>
<li><strong>镜像加速</strong>：在 <code>/etc/docker/daemon.json</code> 与 <code>/etc/containerd/config.toml</code> 中配置国内镜像。</li>
<li><strong>权限管理</strong>：创建 <code>docker</code> 组，使用 <code>sudo usermod -aG docker username</code>。</li>
<li><strong>日志轮转</strong>：Docker 自带 <code>json-file</code> 日志，必要时结合 <code>logrotate</code>。</li>
<li><strong>资源控制</strong>：在 PVE 中设定 CPU/内存限制，K8s 中使用 <code>LimitRange</code>/<code>ResourceQuota</code>。</li>
<li><strong>备份</strong>：</li>
<li>VM：使用 PVE <code>备份</code> 功能到 NFS/Ceph。</li>
<li>集群：使用 <code>velero</code>/<code>etcdctl snapshot</code>。</li>
<li><strong>升级策略</strong>：</li>
<li>PVE：每季度计划升级；确保订阅源稳定。</li>
<li>Docker：先测试环境节点后生产；遵循 <code>docker-ce</code> LTS。</li>
<li>K8s：按小版本滚动升级，先控制平面再工作节点。</li>
</ul>
<hr/>
<h3 data-id="heading-23">7. 常见问题排查</h3>



































<table><thead><tr><th>问题</th><th>可能原因</th><th>解决建议</th></tr></thead><tbody><tr><td>VM 网络不通</td><td>虚拟交换机未绑定物理口、VLAN 配置缺失</td><td>核对 <code>vmbr</code> 绑定与上联交换机 VLAN</td></tr><tr><td>克隆 VM 后 IP 冲突</td><td>未修改 <code>ifcfg</code>/<code>netplan</code> MAC/IP</td><td>克隆后立即变更 MAC 或重启获取 DHCP</td></tr><tr><td>Docker 启动失败</td><td>cgroup 驱动不匹配</td><td>确保 <code>systemd</code>，配置 <code>daemon.json</code></td></tr><tr><td>kubeadm 初始化失败</td><td>swap 未关闭、端口被占用</td><td><code>swapoff -a</code>，检查 <code>6443</code>、<code>10250</code> 等端口</td></tr><tr><td>节点 <code>NotReady</code></td><td>网络插件异常</td><td>重装 CNI，检查 <code>kube-flannel</code> Pod 日志</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-24">8. 批量自动化建议</h3>
<ul>
<li><strong>Ansible</strong>：编写 <code>playbook</code> 批量安装 Docker/K8s，维护 <code>inventory</code>。</li>
<li><strong>Cloud-Init</strong>：使用 <code>cloud-init</code> 模板，减少克隆后手工步骤。</li>
<li><strong>Packer</strong>：自动构建 VM 模板，结合 PVE API 批量部署。</li>
<li><strong>CI/CD</strong>：将 YAML 清单、Ansible Playbooks 存入 Git，使用 GitLab CI/Argo CD 自动化。</li>
</ul>
<hr/>
<h3 data-id="heading-25">9. 附录</h3>
<h4 data-id="heading-26">9.1 常用命令速查</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># PVE CLI 创建 VM 示例  </span>
qm create 2010 --name centos-docker-01 --memory 8192 --cores 4 --net0 virtio,bridge=vmbr0  
qm importdisk 2010 centos.qcow2 local-lvm  
qm <span class="hljs-built_in">set</span> 2010 --scsihw virtio-scsi-pci --scsi0 local-lvm:vm-2010-disk-0  
qm <span class="hljs-built_in">set</span> 2010 --boot c --bootdisk scsi0  
qm <span class="hljs-built_in">set</span> 2010 --ide2 <span class="hljs-built_in">local</span>:iso/CentOS-7-x86_64-Minimal.iso,media=cdrom  
  
<span class="hljs-comment"># PVE 克隆  </span>
qm <span class="hljs-built_in">clone</span> 2001 2011 --name centos-docker-02 --full  
  
<span class="hljs-comment"># 管理 VM  </span>
qm start 2010  
qm stop 2010  
qm status 2010  
  
<span class="hljs-comment"># Docker 常用  </span>
docker info  
docker ps -a  
docker system <span class="hljs-built_in">df</span>  
  
<span class="hljs-comment"># Kubernetes 常用  </span>
kubectl get nodes -o wide  
kubectl get pods -A  
kubectl describe node k8s-worker-01  
</code></pre>
<h4 data-id="heading-27">9.2 端口与服务</h4>
<ul>
<li>PVE Web：<code>8006</code></li>
<li>SSH：<code>22</code></li>
<li>Docker API：<code>2375</code>（禁用或限制）</li>
<li>Kubernetes：</li>
<li>API Server：<code>6443</code></li>
<li>kubelet：<code>10250</code></li>
<li>NodePort：<code>30000-32767</code></li>
</ul>
<hr/>
<h3 data-id="heading-28">10. 维护与安全建议</h3>
<ul>
<li>定期更新 PVE 与虚拟机系统；配置企业级镜像源。</li>
<li>使用防火墙（PVE <code>iptables</code>/<code>pf</code>、K8s <code>NetworkPolicy</code>）。</li>
<li>为 Docker Registry 配置 HTTPS 与鉴权；避免默认 <code>latest</code> 标签。</li>
<li>启用 PVE 备份（快照 + 定时备份），并测试恢复流程。</li>
<li>K8s 集群启用 RBAC、审计日志；定期轮换证书。</li>
<li>监控：部署 <code>Prometheus + Grafana</code>、<code>Loki</code>，结合 PVE 自带监控。</li>
</ul>
<hr/>
<h3 data-id="heading-29">11. PVE Web 前端操作手册（初学者版）</h3>
<blockquote>
<p>《基于 PVE8.1 快速搭建 K8s 集群》</p>
</blockquote>
<h4 data-id="heading-30">11.1 登录与界面认识</h4>
<ol>
<li>浏览器访问 <code>https://&lt;PVE主机IP&gt;:8006</code>，选择登录域 <code>Linux PAM standard authentication</code>，使用 <code>root@pam</code> 或授权账户登录。</li>
<li>左侧 <code>数据中心</code> 树展示所有节点与虚拟资源；右侧为详细面板。</li>
<li>顶部状态栏：</li>
</ol>
<ul>
<li><code>搜索</code>：快速定位 VM / 存储。</li>
<li><code>Shell</code>：打开节点 CLI。</li>
<li><code>帮助</code>：查看官方文档。</li>
</ul>
<ol start="4">
<li>常用面板：</li>
</ol>
<ul>
<li><code>概览</code>：资源使用、订阅状态。</li>
<li><code>任务历史</code>：实时查看正在执行的操作（创建 VM、备份等）。</li>
</ul>
<h4 data-id="heading-31">11.2 Web 前端基础配置</h4>
<ul>
<li><strong>订阅源切换</strong>：在 <code>节点 → Shell</code> 执行本文第 2.1 节命令，或在 <code>Shell</code> 面板直接粘贴。</li>
<li><strong>时区与时间</strong>：<code>节点 → 系统 → 时间</code>，同步 NTP 服务器（如 <code>ntp.aliyun.com</code>）。</li>
<li><strong>网络桥配置</strong>：</li>
</ul>
<ol>
<li><code>节点 → 系统 → 网络 → 创建 → Linux Bridge</code>。</li>
<li>设置名称（例：<code>vmbr1</code>）、绑定物理网卡、是否配置 VLAN。</li>
<li>点击 <code>应用配置</code>，系统提示重启网络，确认即可。</li>
</ol>
<h4 data-id="heading-32">11.3 ISO / 容器模板管理</h4>
<ol>
<li>选中 <code>数据中心 → 存储 → local</code>。</li>
<li>切换到 <code>内容</code> 标签：</li>
</ol>
<ul>
<li><code>上传</code>：选择 CentOS / Ubuntu ISO。</li>
<li><code>模板</code>：可下载官方 LXC 模板，如 <code>centos-7-default_20240625_amd64.tar.xz</code>。</li>
</ul>
<ol start="3">
<li>上传进度可在右上角任务栏查看，如失败可点进日志排错。</li>
</ol>
<h4 data-id="heading-33">11.4 创建 KVM 虚拟机（以 CentOS 为例）</h4>
<ol>
<li>选中目标节点 → 点击右上 <code>创建虚拟机</code>。</li>
<li><strong>常规</strong>：填写 VM ID、名称（例：<code>centos-docker-01</code>），可选备注。</li>
<li><strong>操作系统</strong>：选择已上传的 ISO；<code>Guest OS</code> 选 <code>Linux</code>。</li>
<li><strong>系统</strong>：BIOS 选 <code>OVMF (UEFI)</code> 或默认 <code>SeaBIOS</code>；勾选 <code>Qemu Agent</code>。</li>
<li><strong>磁盘</strong>：<code>总线/设备</code> 建议 <code>SCSI</code>，存储选 <code>local-lvm</code>，勾选 <code>精简</code> 节省空间。</li>
<li><strong>CPU</strong>：类型选 <code>host</code>，分配核心数（例：2）。</li>
<li><strong>内存</strong>：设置动态内存（例：最小 2 GB，最大 4 GB），也可关闭气球内存固定值。</li>
<li><strong>网络</strong>：模型选 <code>VirtIO (paravirtualized)</code>，桥接 <code>vmbr0</code>。</li>
<li><strong>确认</strong>：检查配置后点击 <code>完成</code>，等待任务完成。</li>
<li>在 VM 页面点击 <code>控制台</code>，选择 <code>noVNC</code> 或 <code>SPICE</code> 进入安装界面。</li>
</ol>
<h4 data-id="heading-34">11.5 创建 LXC 容器（可用于轻量 Docker 节点）</h4>
<ol>
<li>选中节点 → <code>创建 LXC</code>。</li>
<li>填写容器 ID、主机名，勾选 <code>无密码</code> 并上传 SSH 公钥或设置密码。</li>
<li>选择模板（例：<code>ubuntu-22.04-standard_20240715_amd64.tar.zst</code>）。</li>
<li>配置根磁盘大小（例：20 GB）、CPU/内存限制。</li>
<li>网络设置：桥接到 <code>vmbr0</code>，指派 IPv4（DHCP/静态）。</li>
<li>确认创建后，即可在容器内使用 Docker（二进制安装或 apt/yum）。</li>
</ol>
<h4 data-id="heading-35">11.6 虚拟机前端常规操作</h4>
<ul>
<li><strong>启动/关闭/重启</strong>：选中 VM → <code>摘要</code> 页面左上操作按钮。</li>
<li><strong>快照</strong>：</li>
</ul>
<ol>
<li><code>快照</code> 标签 → <code>拍摄</code>，填写描述。</li>
<li>可选择 <code>包含内存</code>（用于热备份），容量大时谨慎使用。</li>
<li><code>还原</code> 会恢复到快照状态，注意可能导致未写入数据丢失。</li>
</ol>
<ul>
<li><strong>克隆</strong>：</li>
</ul>
<ol>
<li>选中模板或现有 VM → <code>更多</code> → <code>克隆</code>。</li>
<li>选择 <code>完整克隆</code>（独立磁盘）或 <code>链接克隆</code>（共享基础镜像）。</li>
<li>创建后记得修改网卡 MAC 或操作系统内部 IP。</li>
</ol>
<ul>
<li><strong>迁移</strong>：在多节点环境可通过 <code>迁移</code> 按钮在线迁移 VM 至其他节点。</li>
</ul>
<h4 data-id="heading-36">11.7 Docker / K8s 节点的 GUI 辅助操作</h4>
<ul>
<li><strong>上传 SSH 密钥</strong>：<code>数据中心 → 权限 → SSH 密钥</code>，方便在 Web Console 内一键登录。</li>
<li><strong>资源监控</strong>：<code>节点 → 摘要</code>、<code>VM → 监控</code> 可查看实时 CPU/内存/磁盘/网络曲线。</li>
<li><strong>备份与还原</strong>：</li>
</ul>
<ol>
<li><code>数据中心 → 备份</code> 创建备份任务，选择存储（如 NFS）。</li>
<li>支持 <code>停止模式</code>（关机快照）或 <code>快照模式</code>（需启用 Qemu Agent）。</li>
<li>恢复时在目标节点 <code>更多 → 恢复</code> 选择备份文件。</li>
</ol>
<ul>
<li><strong>调度任务</strong>：<code>数据中心 → 任务计划</code>，可设定定时备份、快照、更新等操作。</li>
</ul>
<h4 data-id="heading-37">11.8 常见前端操作问题</h4>

























<table><thead><tr><th>症状</th><th>处理建议</th></tr></thead><tbody><tr><td>Web 无法访问</td><td>检查浏览器证书、宿主防火墙，必要时重启 <code>pveproxy</code>：<code>systemctl restart pveproxy</code></td></tr><tr><td>上传 ISO 失败</td><td>确认存储剩余空间、网络稳定，查看任务日志（右上角）</td></tr><tr><td>控制台黑屏</td><td>切换 <code>noVNC/SPICE</code>，或在 VM <code>选项</code> 中启用 <code>显卡</code>、确认 OS 安装完成</td></tr><tr><td>克隆后网络异常</td><td>在 OS 内重置 <code>udev</code> 网卡规则、重新配置 IP，或删除旧的 <code>ifcfg</code> 文件</td></tr></tbody></table>
<hr/>
<blockquote>
<p>文档建议结合企业内部 IP、账号、存储、网络实际情况进行二次调整，并与变更管理流程同步。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[el-input数字类型禁止+-符号输入]]></title>    <link>https://juejin.cn/post/7571646669201342506</link>    <guid>https://juejin.cn/post/7571646669201342506</guid>    <pubDate>2025-11-12T09:33:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571646669201342506" data-draft-id="7571648135584612395" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="el-input数字类型禁止+-符号输入"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-11-12T09:33:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lyuing"/> <meta itemprop="url" content="https://juejin.cn/user/3404535031412190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            el-input数字类型禁止+-符号输入
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3404535031412190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lyuing
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T09:33:09.000Z" title="Wed Nov 12 2025 09:33:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>使用 <code>el-input</code> 的数字类型输入时，会默认开放<code>-</code>，<code>+</code>，<code>e</code>符号输入，且无法通过<code>onInput</code>进行拦截。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">el-input</span>
    <span class="hljs-attr">v-model</span>=<span class="hljs-string">"input"</span>
    <span class="hljs-attr">type</span>=<span class="hljs-string">"number"</span>
    <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入内容"</span>
    @<span class="hljs-attr">input</span>=<span class="hljs-string">"onInput"</span>
&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-input</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">onInput</span> (value) {
    <span class="hljs-keyword">const</span> val = value.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/[^\d/.]/g</span>, <span class="hljs-string">''</span>);
    input.<span class="hljs-property">value</span> = val
}
</code></pre>
<p>以上方法无法正确响应，原因有二：</p>
<ol>
<li><code>number</code>类型将 <code>-</code>，<code>+</code>，<code>e</code> 识别为数字符号，不做限制，且符号的输入不会精确触发<code>input</code>响应；</li>
<li>首次接收到 <code>-</code>，<code>+</code>，<code>e</code> 输入后，返回剔除掉的文本回显，无法正确显示，原生<code>input</code>会内部转义，导致无法即显。</li>
</ol>
<h3 data-id="heading-0">方案</h3>
<p>可监听原生<code>input</code>方法，即可规避问题1；回显赋值时，同时更改原生<code>input</code>的<code>value</code>值，即可。
需要注意的是，该方案依赖<code>Event</code>中的属性<code>data</code>，对于兼容性要求高的场景，需谨慎处理。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">el-input</span>
    <span class="hljs-attr">v-model</span>=<span class="hljs-string">"input"</span>
    <span class="hljs-attr">type</span>=<span class="hljs-string">"number"</span>
    <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入内容"</span>
    @<span class="hljs-attr">input.native</span>=<span class="hljs-string">"onInput"</span>
&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-input</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">onInput</span> (e) {
    <span class="hljs-keyword">const</span> target = e.<span class="hljs-property">target</span>;
    <span class="hljs-keyword">const</span> value = target.<span class="hljs-property">value</span>;
  
    <span class="hljs-keyword">if</span>( [ <span class="hljs-string">'-'</span>, <span class="hljs-string">'+'</span>, <span class="hljs-string">'e'</span> ].<span class="hljs-title function_">includes</span>(e.<span class="hljs-property">data</span>) ) {
        target.<span class="hljs-property">value</span> = offset.<span class="hljs-property">value</span>[key] + <span class="hljs-string">''</span>;
    }
    <span class="hljs-keyword">const</span> val = value.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/[^\d/.]/g</span>, <span class="hljs-string">''</span>);
    input.<span class="hljs-property">value</span> = val
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[65 岁图灵巨头离职创业！LeCun 愤然与小扎决裂，Meta 巨震]]></title>    <link>https://juejin.cn/post/7571594817223770163</link>    <guid>https://juejin.cn/post/7571594817223770163</guid>    <pubDate>2025-11-12T09:02:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571594817223770163" data-draft-id="7571594817223737395" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="65 岁图灵巨头离职创业！LeCun 愤然与小扎决裂，Meta 巨震"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-11-12T09:02:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="新智元"/> <meta itemprop="url" content="https://juejin.cn/user/952600743642312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            65 岁图灵巨头离职创业！LeCun 愤然与小扎决裂，Meta 巨震
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/952600743642312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    新智元
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T09:02:50.000Z" title="Wed Nov 12 2025 09:02:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c9ae6cff7ea4eb5baa4b93ff37b83fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=s3BynxVHpG%2F5ceTuYvBScvpYM8A%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-0"><strong>「【新智元导读】AI 圈爆出大瓜！65 岁图灵巨头 LeCun 即将离职 Meta，与小扎正式决裂。接下来，他将投身「世界模型」开启创业下半场。」</strong></h5>
<p>图灵巨头 LeCun 真的要跑路了！</p>
<p>刚刚，FT 独家爆料，现任 Meta 首席 AI 科学家 LeCun，决定将在未来几个月离职。</p>
<p>下一步，开启人生创业的第二阶段。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b2274f99f924da5b73126ec4954af80~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=De8KAQa025nPs6aL1IzIbZDt02s%3D" alt="" loading="lazy"/></p>
<p>消息一出，瞬间引爆全网。此前，坊间传闻称，LeCun 因不满内部架构调整想要离职。</p>
<p>如今，65 岁的图灵巨头，终于做出了这个决定。</p>
<p>扩展阅读：</p>
<p><em><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzI3MTA0MTk1MA%3D%3D%26mid%3D2652631905%26idx%3D1%26sn%3Db94ad542794dda5eed5b06d61232d0ba%26token%3D958537801%26lang%3Dzh_CN%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzI3MTA0MTk1MA==&amp;mid=2652631905&amp;idx=1&amp;sn=b94ad542794dda5eed5b06d61232d0ba&amp;token=958537801&amp;lang=zh_CN&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">LeCun 考虑辞职！Meta AI 百亿豪赌引爆「内战」，逼走首席科学家</a></em></p>
<p><em><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzI3MTA0MTk1MA%3D%3D%26mid%3D2652638822%26idx%3D1%26sn%3D6a8fe70b408c774eb0c8ce4d1bc04f88%26token%3D958537801%26lang%3Dzh_CN%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzI3MTA0MTk1MA==&amp;mid=2652638822&amp;idx=1&amp;sn=6a8fe70b408c774eb0c8ce4d1bc04f88&amp;token=958537801&amp;lang=zh_CN&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">LeCun 怒揭机器人最大骗局，坦白 Llama 与我无瓜！</a></em></p>
<p>据称，LeCun 将要成立的新公司主要推进「世界模型」，目标直指真正的人类级智能。</p>
<p>目前，他正在进行早期的融资洽谈。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50c8fd9db6d848f8b507499cfbb8dda4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=9cfDWznPGCj1f3dCMZUwza3fqfM%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/220f3c8a478c4f69bffafed4d0299572~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=U0z65tLMdaO6qoM8dpovzBfmQjc%3D" alt="" loading="lazy"/></p>
<p>网友盲猜，LeCun 离职可能和会见吴恩达有所关联</p>
<p>任职 12 年，从创办 FAIR 实验室，到拿下图灵奖，再到笃定的世界模型，LeCun 出走对于 Meta 来说，是一次巨震。</p>
<p>或许，小扎的超级智能梦，真的要碎了。</p>
<p>有网友表示，这并不意外。另有人调侃道，「要始终向一个孩子汇报工作，LeCun 的自尊心怎么不会受到伤害呢」。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/061772d29496462183455d014bd59b67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=fbMvAWoXuTmzNInaMVnq5YHbv2o%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06214cd349cb47d4bc9cd46f8aa57090~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=prgmYHDqpNQocppaMX%2BZaxDJv5s%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45604033ebf34166895159edd1e4fc14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=IC%2FoiwC1sVYHgy5muxY1iEkzVyE%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/801f3b6093e24518af72d607bd68e681~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=Q7jacF%2BhSsHi2ScFCjN%2Fhs2r1pA%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e45a5544f5c4ba883f72a279eee229a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=m550ebaKMQHbVzY7y0PDvHN7rrY%3D" alt="" loading="lazy"/></p>
<p>上下滑动查看</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/631e86199f97483487e9603121ffbfe0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=T5wgpjILTFOiihsgWC1Ruqf8EjM%3D" alt="" loading="lazy"/></p>
<p><strong>「效力 12 年决裂，LeCun 愤然离职」</strong></p>
<p>不得不说，这事儿来的太突然，但却早有苗头。</p>
<p>当前，正值 Meta 对公司 AI 业务进行大刀阔斧的改革之际，希望开发出更强大的 AI，挑战 OpenAI、谷歌等竞争对手。</p>
<p>今年初，Llama 4 发布翻车，且性能远不及 ChatGPT、Gemini 等模型。而且，Meta AI 聊天机器人推出后，许多人并不买账。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2343f0fbcbab45029676122853e3eff7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=IY5DTDzvyWIiBmRRz5i94G7XzQQ%3D" alt="" loading="lazy"/></p>
<p>在认定 Meta 在竞争中落后之后，小扎的战略重心也随之改变——</p>
<p>从 LeCun 领军的 FAIR 实验室，转向更快推出模型和 AI 产品。</p>
<p>先是今年 4 月，小扎斥资 143 亿美元聘请了 28 岁 Alexandr Wang，去领导全新「超级智能」团队。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe08b7b00c85446cb075c9a9e37e422f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=YRzo2z9ZLMIm%2FgZpV72n2YuGYVY%3D" alt="" loading="lazy"/></p>
<p>在此过程中，他亲自组建 TBD Lab，开出高达 1 亿美元的薪酬包，从谷歌、OpenAI 抢人。</p>
<p>其中包括，ChatGPT 的核心研究员 Shengjia Zhao，被挖来出任 MSL 首席科学家。</p>
<p>目标很简单，推动其下一代大语言模型的开发。</p>
<p>仅在今年，Meta 内部就进行了超 4 次架构调整和优化，并将 MSL 分立出四大部门，全部由 Alexandr Wang 掌舵：</p>
<ol>
<li>TBD Lab （To Be Determined，待确定，负责探索 / 先导研究）</li>
<li>FAIR （Fundamental AI Research，长期前沿研究）</li>
<li>产品和应用团队 （含 Meta AI 助手等）</li>
<li>基础设施 （训练与推理的算力、数据与平台）</li>
</ol>
<p>因此，此前向首席产品官 Chris Cox 汇报的 LeCun，现在转而向 Wang 汇报。</p>
<p>不仅如此，LeCun 长期领导的 FAIR 也逐渐被边缘化，向比他小 30 多岁的 Wang 汇报，包括论文，也需得到审批后才可发表。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5257e88895074c8aac88d463116e4de5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=Kq36WpX%2B1cnOIzblpulg%2BeAEmpA%3D" alt="" loading="lazy"/></p>
<p>另一方面，LeCun 认为小扎置于其战略核心的 LLM 虽然「有用」，但永远无法像人类一样进行推理和规划。</p>
<p>在 FAIR 内部，LeCun 也一直专注于开发「世界模型」，但在短期内，是看不到 KPI 的。</p>
<p>而小扎现在要的是，立即就能变现的 AI 产品。</p>
<p>看得出，LeCun 所坚持的路线和个人观点，与 Meta 的 AI 愿景出现了明显的分歧。</p>
<p>种种因素的叠加，早已成为 LeCun 离职的导火索。而现在，就是最好的时机。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2611de3112fb4d06bedc5d4c7c26c63a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=uwcDi3Tj9KP6v9tly0gPAGt2qQQ%3D" alt="" loading="lazy"/></p>
<p><strong>「全力押注「世界模型」」</strong></p>
<p>庆幸的是，LeCun 终于可以在「世界模型」上大展身手了。</p>
<p>一直以来，他坚信大模型最终没有出路，永远学不会真正的推理和规划，也根本无法通往 AGI。</p>
<p>LLM 不如阿猫阿狗，LeCun 已在多种公开场合中多次提出。</p>
<p>在他看来，AI 的终局就是「世界模型」。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0835db6cedf482b872ea25b532faf55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=N%2BPLO1RJJw7QP8uCWFF1AaMlQWo%3D" alt="" loading="lazy"/></p>
<p>前段时间，他在 MIT 访谈中直言，未来 3-5 年内，「世界模型」会成为 AI 架构的主流模型。</p>
<p>这话可让我在硅谷得罪了不少人，包括某些巨头公司。</p>
<p>到那时候，但凡头脑清醒的人，都不会再用现在这种生成式 LLM 的路子了。</p>
<p>世界模型不仅仅学习语言，还通过视频和空间数据，来理解物理世界。</p>
<p>直白讲，它让 AI 可以像婴儿一样，从观察中学习世界的规律。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dfc60ec60302426d83aaea37e3990c1a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=iIGgUYsLmNTe5kUbRhywkp4ZSWI%3D" alt="" loading="lazy"/></p>
<p>不过，LeCun 表示，开发出这个架构需要十年的时间才能成熟。</p>
<p>即便时间漫长，他终于可以坚定按着目标方向前进了。</p>
<p>未来几个月，LeCun 将正式离职 Meta，下一步计划将专注于深化在「世界模型」领域的研究。</p>
<p>AI 掌舵人出走，这意味着，FAIR 实验室就彻底被边缘化了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35b5e2d5e1974bbd9d616cf542ce55a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=CM4EEuUPdBodh3yDUSJf4B2f2pc%3D" alt="" loading="lazy"/></p>
<p><strong>「图灵巨头，开启 AI 革命」</strong></p>
<p>1960 年 7 月 8 日出生的 Yann LeCun，在法国巴黎的郊区长大。</p>
<p>他的姓氏原本是 Le Cun，但他发现美国人常对此感到困惑，将 Le 误作他的中间名，于是便去掉了中间的空格。</p>
<p>他的父亲是一名工程师，在 LeCun 充满修补创造的童年中，将自己对电子和机械的热爱传给了他。</p>
<p>青少年时期，LeCun 既喜欢在乐队中演奏，也热爱科学与工程。</p>
<p>后来，他在法国精英工程师学校之一的巴黎高等电子与电工工程师学院（ESIEE Paris）获得了相当于硕士的学位。在那里，他专注于微芯片设计与自动化。</p>
<p>他从本科时代就开始独立进行机器学习研究，并将其作为他在索邦大学（当时称为皮埃尔和玛丽 · 居里大学）博士阶段的核心工作。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0edc6ec9354f4e419618b11217f39be9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=7eMCmy2Bc09t8XcbRKA1dm5J3kw%3D" alt="" loading="lazy"/></p>
<p>LeCun 的研究与 Geoffrey Hinton 独立做出的发现高度相似。</p>
<ul>
<li>与 Hinton 一样，他被当时尚属非主流的神经网络人工智能方法所吸引；</li>
<li>也与 Hinton 一样，他发现可以通过使用后来被称为「反向传播」的算法来有效训练输入和输出节点之间中间层的「隐藏」神经元，从而克服简单神经网络众所周知的局限性。</li>
</ul>
<p>1985 年在法国阿尔卑斯山区举办的一场研讨会，首次让 LeCun 与从事相关研究的国际学术界有了直接接触。</p>
<p>正是在那里，他结识了 Hinton 的密切合作者 Terry Sejnowski。当时，Sejnowski 关于反向传播的研究尚未发表。</p>
<p>几个月后，Hinton 到访巴黎，并主动向 LeCun 作了自我介绍。</p>
<p>再之后，LeCun 则受邀参加卡内基梅隆大学的夏季研讨会，并在多伦多 Hinton 新成立的研究小组进行了一年的博士后研究。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f32cc9f763da42a9a119ea76e1f9da8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=rRIgVMn8dDXBwdepQKCpWS05gmk%3D" alt="" loading="lazy"/></p>
<p>1988 年，博士后研究结束时，LeCun 加入了著名的计算机科学研究中心——贝尔实验室。</p>
<p>在贝尔实验室，LeCun 的工作专注于神经网络架构和学习算法。</p>
<p>他影响最为深远的贡献是一种名为「卷积神经网络」的新方法。这是他早期成就的延伸，因为卷积网络依赖反向传播技术来训练其隐藏层。</p>
<p>除了开发卷积方法，LeCun 还率先将其应用于「图 Transformer 网络」，用于识别印刷体和手写文本。这项技术被用于一个广泛部署的系统，以读取支票上的手写数字。</p>
<p>他在贝尔实验室的另一项主要贡献是开发了「最佳脑损伤」（Optimal Brain Damage）正则化方法。</p>
<p>这个名字生动的概念旨在通过移除神经网络中不必要的连接来简化网络。如果操作得当，这种「脑损伤」可以产生更简单、更快速的网络，其性能与完整版本相当甚至更优。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d77f5ad18094d43aaaf6cb37caa9477~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=Q0tSyBvug%2FbURAV88AmhZUfd5MQ%3D" alt="" loading="lazy"/></p>
<p>1996 年，在计算机行业未能立足的 AT&amp;T 公司，将贝尔实验室的大部分业务及其电信硬件业务分拆成立了一家新公司——朗讯科技。</p>
<p>LeCun 留在了 AT&amp;T，负责一个专注于图像处理研究的实验室小组。</p>
<p>在那里，他的主要成就是 DjVu 图像压缩技术。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d450fa31e1640438713b77d81ba4973~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=CwI5F83Du6m4WqZndIpEUoPOlXg%3D" alt="" loading="lazy"/></p>
<p>2003 年，LeCun 离开工业界，前往纽约大学库朗数学科学研究所担任计算机科学教授。</p>
<p>在纽约大学，LeCun 负责计算与生物学习实验室，继续他在机器学习算法和计算机视觉应用方面的工作。</p>
<p>他至今仍在纽约大学任教，尽管随着声誉日隆，他又增添了几个新头衔和额外职位。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b5bc1a1219e443a89fea734c13383a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=ABQabRu0KICtSQ2sekCwcvwOUio%3D" alt="" loading="lazy"/></p>
<p>到 2010 年代初，各大科技公司竞相部署基于神经网络的机器学习系统。与其他顶尖研究人员一样，LeCun 也受到了科技巨头的青睐。</p>
<p>2013 年 12 月，他加入 Facebook 并创建了 FAIR（Facebook AI Research），同时，他也还兼顾在纽约大学的工作。</p>
<p>2018 年，他卸任主任一职，转任 Facebook 首席人工智能科学家，专注于战略规划和科学领导力。</p>
<p>同年，他与 Geoffrey Hinton 和 Yoshua Bengio，共同获得了图灵奖。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb089d529bc3488081619e67d11db779~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=kyFe1z%2B27b8X7%2Fs66F6pgS2hBMM%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e45aa40a00b49e180ea118e912084a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=VjQwo43bN9CoPIlKN0%2FyGh6Bi2s%3D" alt="" loading="lazy"/></p>
<p>时至今日，LeCun 一直保持着对动手创造的热爱，他的爱好包括制造飞机、电子乐器和机器人。</p>
<p>或许，这也是他在 65 岁时，毅然决定下海创业的动力之一。</p>
<p>参考资料：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ft.com%2Fcontent%2Fc586eb77-a16e-4363-ab0b-e877898b70de" target="_blank" title="https://www.ft.com/content/c586eb77-a16e-4363-ab0b-e877898b70de" ref="nofollow noopener noreferrer">www.ft.com/content/c58…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【AI绘图新手必看】Nano Banana实战教学：从提示词到画面构图！]]></title>    <link>https://juejin.cn/post/7571637614203387931</link>    <guid>https://juejin.cn/post/7571637614203387931</guid>    <pubDate>2025-11-12T09:27:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571637614203387931" data-draft-id="7571655979255726120" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【AI绘图新手必看】Nano Banana实战教学：从提示词到画面构图！"/> <meta itemprop="keywords" content="AIGC,Gemini"/> <meta itemprop="datePublished" content="2025-11-12T09:27:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户815091607260"/> <meta itemprop="url" content="https://juejin.cn/user/2042264015120554"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【AI绘图新手必看】Nano Banana实战教学：从提示词到画面构图！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2042264015120554/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户815091607260
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T09:27:34.000Z" title="Wed Nov 12 2025 09:27:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Nano Banana，大香蕉模型小名“纳米香蕉”是 Google/DeepMind 推出的图像生成/编辑子模型（Gemini 2.5 Flash Image 系列的俗称），以强大的一步/迭代图像编辑能力著称，特别擅长在保持主体一致性的前提下对已有照片进行复杂改造（如把真人变成微型摆件、换背景、服装替换、连贯的人物系列编辑等）。</p>
<p>单张/多张图像编辑、one-shot 风格替换、持续迭代保持角色一致、从照片生成风格化3D/半3D小模型/摆件、与 Photoshop等工具集成等。</p>
<p>下面给你一份 <strong>详尽的 Nano-banana（即 Google Gemini 的 “Nano Banana / Gemini 2.5 Flash Image”）使用教程</strong>，包含：功能概览、逐步上手教程、Prompt 工程与技巧、10 个「神级玩法」案例（含提示词与步骤）、以及如何通过 <strong>神马中转 API</strong> 直接使用和配置并调用 Nano-banana（含示例代码）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7484a1e1e27d4a1e8cff035bb4d6f609~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODE1MDkxNjA3MjYw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763544453&amp;x-signature=Wqft1iPoDwU72Y1pxeoaKyBeNiY%3D" alt="【Nano-banana超详细使用教程】：从入门到精通，一文搞懂Gemini 2.5 Flash Image全流程！Nano-banana怎么用/提示词/实战教程AI图像生成" loading="lazy"/></p>
<h2 data-id="heading-0">1. Nano Banana提示词Prompt工程（实战要点）</h2>
<p>成功的图像编辑 prompt 通常要“分层、简洁、指向明确”——建议使用下面结构化模板（可复制粘贴改写），也可以直接复制下一部分提示词的示例直接快速上手：</p>
<pre><code class="hljs">主体描述（谁 / 物）；
动作或姿态（在做什么）；
风格/细节（写明风格：写实 / 插画 / 纸雕 / 3D 小摆件）；
光照/环境（时间/光源/相机角度）；
材质/纹理（例如陶瓷、塑料、金属、迷你木雕）；
保留或限制（“保留面部表情/不要改变背景中 XX”）；
输出格式与修饰（“高细节、4k、自然阴影、无文字”）。
</code></pre>
<p>示例（将自拍变成太空宇航服风格）：</p>
<pre><code class="hljs">主体：正面自拍，微笑，年约25岁女性；
动作：面向镜头，头戴透明头盔，身体穿宇航服；
风格：科幻写实，细节丰富；
环境：太空背景，地球在远处，可见星云光晕；
光照：来自右上方的冷色主光，柔和反射；
保留：保留眼睛和面部特征；
输出：可用于头像，裁剪为方形
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7d42215ec32416c913745a52c8d69c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODE1MDkxNjA3MjYw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763544453&amp;x-signature=3Gc6Vf7e3P7wWatsbTAiS%2BRYUyo%3D" alt="" loading="lazy"/></p>
<p><strong>实用技巧</strong></p>
<ul>
<li>
<p>分句写提示，短句比长段更稳定。</p>
</li>
<li>
<p>使用否定短语（avoid / 不要）明确排除元素。</p>
</li>
<li>
<p>用“参考图”或“参考关键词”提高风格一致性（如给出风格参考图或写“像 Studio Ghibli 风格”）。</p>
</li>
<li>
<p>若要多次迭代，记录每次 prompt 的改动点，方便复现与微调。</p>
</li>
</ul>
<h2 data-id="heading-1">2. 10 个 Nano-banana「神级玩法」与示例提示词（每条含操作步骤与提示词）</h2>
<blockquote>
<p>下列玩法兼顾创意与可实现性，适用于社交媒体、商业设计、影视概念、个人创作等场景。</p>
</blockquote>
<h4 data-id="heading-2">微型摆件 / 人像“摆件化”</h4>
<p><strong>思路</strong>：把真人照片转成桌面小摆件（mini figurine）风格，保留面部特征且做出“塑料/陶瓷”质感。</p>
<p><strong>示例 prompt</strong>：</p>
<pre><code class="hljs">把主体变为一个桌面微型摆件，类似精致陶瓷人偶，头部细节保留，面部光滑有微光，底座木质，尺寸迷你，浅景深相机镜头，柔和环境光，背景为书桌模糊。保持面部表情不变。
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40ec4b7030e8455d8e385d2e1c2e8668~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODE1MDkxNjA3MjYw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763544453&amp;x-signature=49nDdVN2dGEpFm%2FV7ucxbqeZLFk%3D" alt="" loading="lazy"/></p>
<p><strong>步骤</strong>：上传清晰正面照 → 指定 mask（身体或背景）→ 选择“塑料/陶瓷”质感 → 迭代调整材质和阴影。</p>
<h4 data-id="heading-3">更换多种发型</h4>
<p>输入: 需上传一张需要更换发型的人像图片</p>
<p>提示词:</p>
<pre><code class="hljs">以九宫格的方式生成这个人不同发型的头像
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc8752a045784b38ad0251574f187570~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODE1MDkxNjA3MjYw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763544453&amp;x-signature=j0uaQUaqZK%2FvUjYqBSJIqaFgpV4%3D" alt="【Nano-banana超详细使用教程】：从入门到精通，一文搞懂Gemini 2.5 Flash Image全流程！Nano-banana怎么用/提示词/实战教程AI图像生成" loading="lazy"/></p>
<h4 data-id="heading-4">电影海报级别场景重塑</h4>
<p><strong>示例 prompt</strong>：</p>
<pre><code class="hljs">把这张城市街拍重制为赛博朋克电影海报风格：霓虹灯、雨滴反射、冷暖对比、宽银幕构图、加深阴影、电影颗粒，保留主体姿态。
</code></pre>
<p><strong>步骤</strong>：上传原图 → 指定 “风格：赛博朋克” → 要求“宽银幕构图+高对比”。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b91252e22070425ea85e884252647391~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODE1MDkxNjA3MjYw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763544453&amp;x-signature=0L6G3PPfXT1bLED2s1Mzhpmc%2FdA%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-5">电影分镜</h4>
<p><strong>思路</strong>：需上传参考图像</p>
<p><strong>提示</strong>：</p>
<pre><code class="hljs">用这两个角色创作一个令人上瘾的12部分故事，包含12张图像，讲述经典的黑色电影侦探故事。故事关于他们寻找线索并最终发现的失落的宝藏。整个故事充满刺激，有情感的高潮和低谷，以精彩的转折和高潮结尾。不要在图像中包含任何文字或文本，纯粹通过图像本身讲述故事在这张模特图上尝试三种未来感服装：1) 轻质反光外套 2) 高腰结构连衣 3) 层叠功能性战术装。每个输出保持模型脸部与姿态一致。
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3991bc2af0de4c0bb20f949ba3bf60d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODE1MDkxNjA3MjYw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763544453&amp;x-signature=Evv7T9QZ1%2BeBxZ18XhyRF8v08xI%3D" alt="【Nano Banana超详细使用教程】：从入门到精通，一文搞懂Gemini 2.5 Flash Image全流程！Nano-banana怎么用/提示词/实战教程AI图像生成" loading="lazy"/></p>
<h4 data-id="heading-6">人物姿势修改</h4>
<p><strong>提示</strong>：</p>
<pre><code class="hljs">让图片中的人直视前方
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7dde9c4e37e84dccb8f0b906aad9f466~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODE1MDkxNjA3MjYw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763544453&amp;x-signature=36kwRg6LkGdOfJeQZaM6X8ac%2F2k%3D" alt="【Nano Banana超详细使用教程】：从入门到精通，一文搞懂Gemini 2.5 Flash Image全流程！Nano-banana怎么用/提示词/实战教程AI图像生成" loading="lazy"/></p>
<h4 data-id="heading-7">线稿图生成图像</h4>
<p><strong>提示</strong>：</p>
<pre><code class="hljs">将图一人物换成图二姿势，专业摄影棚拍摄
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0062f5fc741400b9fb06755f8bf679b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODE1MDkxNjA3MjYw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763544453&amp;x-signature=b59LA7URe2V3mXHJMW6iFwgioRc%3D" alt="【Nano Banana超详细使用教程】：从入门到精通，一文搞懂Gemini 2.5 Flash Image全流程！Nano-banana怎么用/提示词/实战教程AI图像生成" loading="lazy"/></p>
<h4 data-id="heading-8">物品包装生成</h4>
<p><strong>思路</strong>：需上传一张物品参考图像和一张包装参考图片</p>
<p><strong>提示</strong>：</p>
<pre><code class="hljs">把图一贴在图二易拉罐上，并放在极简设计的布景中，专业摄影
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be527b44a3ae40de842c59fbabdfe118~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODE1MDkxNjA3MjYw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763544453&amp;x-signature=GS0rZkV%2FsP10g%2F4Kf1bU5a963t0%3D" alt="【Nano Banana超详细使用教程】：从入门到精通，一文搞懂Gemini 2.5 Flash Image全流程！Nano-banana怎么用/提示词/实战教程AI图像生成" loading="lazy"/></p>
<h4 data-id="heading-9">动漫转真人Coser</h4>
<p><strong>输入:</strong> 需上传一张插画图像</p>
<p><strong>提示词:</strong></p>
<pre><code class="hljs">生成一个女孩cosplay这张插画的照片，背景设置在Comiket
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d460018b21134a87a33c2b8b85eb78ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODE1MDkxNjA3MjYw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763544453&amp;x-signature=%2BGlvGI%2B5mjDI%2FNDy%2FnZWlzT7fM8%3D" alt="【Nano Banana超详细使用教程】：从入门到精通，一文搞懂Gemini 2.5 Flash Image全流程！Nano-banana怎么用/提示词/实战教程AI图像生成" loading="lazy"/></p>
<h4 data-id="heading-10">生成角色设定</h4>
<p><strong>输入:</strong> 需上传一张角色参考图像</p>
<p><strong>提示词:</strong></p>
<pre><code class="hljs language-sql" lang="sql">为我生成人物的角色设定（<span class="hljs-type">Character</span> Design）

比例设定（不同身高对比、头身比等）

三视图（正面、侧面、背面）

表情设定（Expression Sheet） → 就是你发的那种图

动作设定（Pose Sheet） → 各种常见姿势

服装设定（Costume Design）
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d58201e5620d4de2b0bf8ac56733be07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODE1MDkxNjA3MjYw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763544453&amp;x-signature=yWlCAMlnwpOaDTuU1VKszJrZvoA%3D" alt="【Nano Banana超详细使用教程】：从入门到精通，一文搞懂Gemini 2.5 Flash Image全流程！Nano-banana怎么用/提示词/实战教程AI图像生成" loading="lazy"/></p>
<h4 data-id="heading-11">OOTD穿搭</h4>
<p><strong>输入:</strong> 需上传一张人物图片和服装图片</p>
<p><strong>提示词:</strong></p>
<pre><code class="hljs">选择图1中的人，让他们穿上图2中的所有服装和配饰。在户外拍摄一系列写实的OOTD风格照片，使用自然光线，时尚的街头风格，清晰的全身镜头。保持图1中人物的身份和姿势，但以连贯时尚的方式展示图2中的完整服装和配饰
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e6249d485a748178b8f5d76ed7e243e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODE1MDkxNjA3MjYw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763544453&amp;x-signature=dmidXscN%2BefhKgRvsLBOSzwc4a0%3D" alt="【Nano Banana超详细使用教程】：从入门到精通，一文搞懂Gemini 2.5 Flash Image全流程！Nano-banana怎么用/提示词/实战教程AI图像生成" loading="lazy"/></p>
<h2 data-id="heading-12">3. Nano-banana怎么用：四种常见使用方式（含操作步骤）</h2>
<p>下面给出最常见的四种上手方式（带具体步骤）——如果你已经有图像，直接按其中一种走即可。</p>
<h3 data-id="heading-13">方式 A：在 Google Gemini / AI Studio 中使用（官方渠道）</h3>
<ol>
<li>
<p>打开 Gemini Image 编辑页面或 AI Studio（gemini.google / AI Studio）。选择 <strong>Gemini 2.5 Flash Image / Nano-banana</strong> 模型（有时称“Nano-banana”或“gemini-2-5-flash-image”）。</p>
</li>
<li>
<p>上传你的原图（单张或多张参考图）。</p>
</li>
<li>
<p>在文本框输入你的编辑提示（prompt）。可分句写清楚要点：主体、动作/表情、风格、背景、光照、材质、要保留/删除的元素。</p>
</li>
<li>
<p>若支持 mask（蒙版），可用画笔圈出希望变动的区域，或标注需保留细节（例如“保留左耳环细节”）。</p>
</li>
<li>
<p>生成后使用“迭代”或“变体”功能微调；每轮在 prompt 里加上“更强的光照/更逼真的阴影/保留脸部特征”等指示。</p>
</li>
</ol>
<blockquote>
<p>备注：通过官方界面通常能得到最佳一致性与合规性（并可能带有不可见的 SynthID 水印用于标识 AI 生成图像）。</p>
</blockquote>
<h3 data-id="heading-14">方式 B：通过第三方应用或插件（例如 Photoshop 集成）</h3>
<ul>
<li>如果你是设计师，Nano-banana 已被部分工具支持为模型选项，直接在 Photoshop 内选择对应模型即可进行本地化工作流编辑。</li>
</ul>
<h3 data-id="heading-15">方式 C：通过 CLI / SDK / 自建前端 调用模型 API</h3>
<ul>
<li>若你要做批量或自动化：可使用官方或第三方神马中转API（如 Gemini 的模型名 gemini-2-5-flash-image），把图片上传并附带 prompt 发起请求，接收返回的编辑结果（base64 / URL）。</li>
</ul>
<h3 data-id="heading-16">方式 D：使用神马中转API调用Nano-banana：配置与示例</h3>
<blockquote>
<p>说明：国内常用的「中转 / 聚合」服务（例如“神马中转 API（api.whatai.cc）等”）通常作为代理，把你对 OpenAI / Gemini / 其它模型的调用统一转发处理。下面给出神马中转API可视化和<strong>文生图示例</strong></p>
</blockquote>
<h4 data-id="heading-17">神马中转API可视化操作</h4>
<p>神马中转API上方菜单-聊天-Nano Banner画图-输入提示词、上传参考图、生成保存图片</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/adae23fb00474961aecb03e3419a9838~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODE1MDkxNjA3MjYw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763544453&amp;x-signature=38v5sPVJ4eSBDlYw0cw83e6Cai4%3D" alt="【Nano Banana超详细使用教程】：从入门到精通，一文搞懂Gemini 2.5 Flash Image全流程！Nano-banana怎么用/提示词/实战教程AI图像生成" loading="lazy"/></p>
<h4 data-id="heading-18">Python文生图示例</h4>
<p>Dalle 格式介绍<br/>
Generations 通用 (图生图 &amp; 文生图)<br/>
用途：用文字或文字+图片来生成一张全新的图片。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> http.client
<span class="hljs-keyword">import</span> json

conn = http.client.HTTPSConnection(<span class="hljs-string">""</span>)
payload = json.dumps({
   <span class="hljs-string">"prompt"</span>: <span class="hljs-string">"cat"</span>,
   <span class="hljs-string">"model"</span>: <span class="hljs-string">"nano-banana"</span>
})
headers = {
   <span class="hljs-string">'Authorization'</span>: <span class="hljs-string">'Bearer {{YOUR_API_KEY}}'</span>,
   <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>
}
conn.request(<span class="hljs-string">"POST"</span>, <span class="hljs-string">"/v1/images/generations"</span>, payload, headers)
res = conn.getresponse()
<span class="hljs-keyword">data</span> = res.read()
print(<span class="hljs-keyword">data</span>.decode(<span class="hljs-string">"utf-8"</span>))
</code></pre>
<h2 data-id="heading-19">4. 常见问题与可复用策略</h2>
<ul>
<li>
<p><strong>如何保持人物一致性？</strong> 上传原始图并在每次请求中把上一次输出也作为参考图；在 prompt 中明确写 “保持面部特征 / 保持发色 / 保持脸型”。</p>
</li>
<li>
<p><strong>结果不理想怎么办？</strong> 逐步微调 prompt、使用 mask 精确控制修改区域、或降低生成风格强度（写“more photorealistic / less stylized”）。</p>
</li>
<li>
<p><strong>速度与成本</strong>：通过中转平台可能更便宜/稳定，但要留意延迟与图片大小带来的费用。</p>
</li>
<li>
<p><strong>法律/道德</strong>：避免未经授权修改他人肖像作商业用途，注意隐私与肖像权。官方模型/平台可能会对某些敏感内容进行限制与检测。</p>
</li>
</ul>
<h2 data-id="heading-20">5. 快速贴士清单（10 条）</h2>
<ol>
<li>
<p>用短句分层写 prompt。</p>
</li>
<li>
<p>首轮先要广，后续再微调细节。</p>
</li>
<li>
<p>用参考图胜过长篇风格描述。</p>
</li>
<li>
<p>用 mask 精确改动区域。</p>
</li>
<li>
<p>保存每次 prompt 便于复现。</p>
</li>
<li>
<p>若要一致性，提供多张参考角度的原图。</p>
</li>
<li>
<p>避免在 prompt 中加入模棱两可的词。</p>
</li>
<li>
<p>使用神马中转API时先做小尺寸测试再放量。</p>
</li>
<li>
<p>尊重被摄者权限和版权。</p>
</li>
<li>
<p>关注模型输出中的合规信息（如 SynthID）。</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Qoder 降价，立即生效！首购 2 美金/月]]></title>    <link>https://juejin.cn/post/7571594817224196147</link>    <guid>https://juejin.cn/post/7571594817224196147</guid>    <pubDate>2025-11-12T09:53:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571594817224196147" data-draft-id="7571594817224179763" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Qoder 降价，立即生效！首购 2 美金/月"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-12T09:53:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LucianaiB"/> <meta itemprop="url" content="https://juejin.cn/user/1269294586664749"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Qoder 降价，立即生效！首购 2 美金/月
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1269294586664749/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LucianaiB
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T09:53:39.000Z" title="Wed Nov 12 2025 09:53:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Qoder 全球上线仅两个月，已获得全球数十万开发者的信赖与支持。</h2>
<p>为了让每一位开发者都能轻松用上顶尖的 AI 编程工具，Qoder 面向全球开发者推出首购优惠：由原价 10 美元/月直降至 2 美元/月（折合人民币约14.2元），一杯咖啡的钱，即可解锁 Qoder 全部核心功能的完整体验！
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/415b29e528ea4c6db06a590d05be4837~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763546019&amp;x-signature=MSfRWoGhDKpP6GuH57k6oVAVYsU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>除了极具吸引力的价格，Qoder 在功能上也实现了全面进化：</p>
<p>首先，Qoder 集成了全球顶尖的编程模型，并新上线模型分级选择器，提供四类高性能模型池：基础轻量（Lite）、经济高效（Efficient）、极致性能（Performance）与智能路由（Auto），不同任务由最适合的模型无缝切换执行，开发者无需理解模型差异，从而减少认知负担并提升效率。</p>
<p>其次，在上下文工程能力方面，Qoder 提供最强的上下文工程能力，可一次检索 10 万个代码文件，结合全球顶尖的大模型能力与 Agent，对大规模代码进行深度语义检索与持续上下文理解，将复杂、多阶段的开发任务拆解并由智能体迭代完成，以“仓库级理解 + 任务化执行”正面应对真实工程的复杂度。</p>
<p>自上线开始，Qoder 持续通过技术升级，比如：工程检索准确率提升、智能体工具并行化优化、上下文智能压缩等能力，在保证效果的前提下持续优化单任务的 token 消耗，让开发真切感受到 Credits 越来越耐用。</p>
<p>在公测期备受开发者关注的 Repo Wiki 和 Quest 模式，也迎来了重磅升级：</p>
<p>Repo Wiki：基于代码库，自动生成结构化项目文档与知识库，将代码中的隐性经验转化为团队共享的显性知识，支持多人编辑、共享与导出，以及一键修复。</p>
<p>Quest 模式：可将复杂耗时的开发任务一键委派至云端沙箱异步执行，彻底释放本地算力。原本需数天完成的任务，现在最快十分钟内交付。</p>
<p>Qoder CLI：开箱即用的智能终端
上个月，Qoder CLI 正式发布，让开发者通过自然语言在终端完成代码生成、调试、部署等任务，实现随处集成，效果不打折。
无需复杂初始化，安装即可使用，确保跨环境一致的编程体验。</p>
<p>内置轻量级 Agent 框架，空闲内存占用比同类工具低 70%，常见命令响应时间 &lt; 200ms。</p>
<p>集成 Quest 模式（自主编程） 与 CodeReview 功能，轻松实现基于 Spec 的任务委派，让 AI 自主完成开发流程。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ead147f3b30c44ba86278a3fc47728ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763546019&amp;x-signature=lAfYQq6MNPKQ51twcC6gxRepfUs%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>此外，Qoder JetBrains 插件也即将上线，全方位覆盖各类开发者的使用场景。</p>
<p>现在，Qoder以一杯咖啡的诚意，向每一位开发者发出了邀请，这是一次对个人工作流的根本性升级以及一张通往更高效率、更多创造力的门票。</p>
<p>这场由 AI Coding 驱动的效率革命已经到来，你准备好解锁全新开发体验了吗？</p>
<p>下载体验：<a href="https://link.juejin.cn?target=https%3A%2F%2Fqoder.com%2Fdownload" target="_blank" title="https://qoder.com/download" ref="nofollow noopener noreferrer">qoder.com/download</a></p>
<p>FAQ：关于降价，你可能会关心的问题：
1、新用户首购 2 美元/月是长期的吗？</p>
<p>是的，我们期望为全球开发者提供低门槛上手的订阅方式。</p>
<p>2、什么是新用户？</p>
<p>新用户是指未购买过任何订阅计划、首次订阅 Qoder Pro 并有资格享受折扣价的用户。</p>
<p>3、此前参加过 Qoder 公测但是没有付费的用户，可以参与吗？</p>
<p>可以参与。</p>
<p>4、首购优惠后如何续费？</p>
<p>按 10 美金每月续费。</p>
<p>5、退款后还能再次享受首购优惠吗？</p>
<p>发生过付费，即使退款也不能再次享受首购优惠了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端代码规范体系建设与团队落地实践]]></title>    <link>https://juejin.cn/post/7571650164843479074</link>    <guid>https://juejin.cn/post/7571650164843479074</guid>    <pubDate>2025-11-12T10:02:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571650164843479074" data-draft-id="7571655979255955496" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端代码规范体系建设与团队落地实践"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-11-12T10:02:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大知闲闲i"/> <meta itemprop="url" content="https://juejin.cn/user/3799545205237111"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端代码规范体系建设与团队落地实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3799545205237111/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大知闲闲i
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T10:02:39.000Z" title="Wed Nov 12 2025 10:02:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、为什么需要前端代码规范？</h2>
<p>在现代前端开发中，代码规范是团队协作的基石。随着项目规模扩大和团队成员增多，统一的代码规范能够带来显著的收益：</p>
<h3 data-id="heading-1">核心价值</h3>
<ul>
<li>
<p><strong>提升代码可读性</strong>：一致的代码风格让团队成员能够快速理解他人代码</p>
</li>
<li>
<p><strong>降低维护成本</strong>：规范的代码结构便于后续维护和功能迭代</p>
</li>
<li>
<p><strong>减少低级错误</strong>：静态检查工具能够捕捉潜在的代码问题</p>
</li>
<li>
<p><strong>提高开发效率</strong>：自动化的格式化和检查节省手动调整时间</p>
</li>
<li>
<p><strong>促进团队协作</strong>：统一的规范减少代码合并冲突和沟通成本</p>
</li>
</ul>
<h2 data-id="heading-2">二、代码规范设计体系</h2>
<h3 data-id="heading-3">1. 基础代码规范（技术核心层）</h3>
<h4 data-id="heading-4">JavaScript/TypeScript 规范 (ESLint + Prettier)</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// .eslintrc.js</span>
<span class="hljs-keyword">module</span>.exports = {
  extends: [
    <span class="hljs-string">'eslint:recommended'</span>,
    <span class="hljs-string">'plugin:@typescript-eslint/recommended'</span>,
    <span class="hljs-string">'plugin:react/recommended'</span>,
    <span class="hljs-string">'plugin:prettier/recommended'</span>
  ],
  parser: <span class="hljs-string">'@typescript-eslint/parser'</span>,
  plugins: [<span class="hljs-string">'@typescript-eslint'</span>, <span class="hljs-string">'react'</span>, <span class="hljs-string">'react-hooks'</span>],
  rules: {
    <span class="hljs-comment">// React Hooks 规则</span>
    <span class="hljs-string">'react-hooks/rules-of-hooks'</span>: <span class="hljs-string">'error'</span>,
    <span class="hljs-string">'react-hooks/exhaustive-deps'</span>: <span class="hljs-string">'warn'</span>,
    
    <span class="hljs-comment">// 代码风格</span>
    <span class="hljs-string">'indent'</span>: [<span class="hljs-string">'error'</span>, <span class="hljs-number">2</span>],
    <span class="hljs-string">'quotes'</span>: [<span class="hljs-string">'error'</span>, <span class="hljs-string">'single'</span>],
    <span class="hljs-string">'semi'</span>: [<span class="hljs-string">'error'</span>, <span class="hljs-string">'always'</span>],
    
    <span class="hljs-comment">// 生产环境限制</span>
    <span class="hljs-string">'no-console'</span>: process.env.NODE_ENV === <span class="hljs-string">'production'</span> ? <span class="hljs-string">'warn'</span> : <span class="hljs-string">'off'</span>,
    <span class="hljs-string">'no-debugger'</span>: process.env.NODE_ENV === <span class="hljs-string">'production'</span> ? <span class="hljs-string">'warn'</span> : <span class="hljs-string">'off'</span>,
    
    <span class="hljs-comment">// TypeScript 规则</span>
    <span class="hljs-string">'@typescript-eslint/explicit-function-return-type'</span>: <span class="hljs-string">'off'</span>,
    <span class="hljs-string">'@typescript-eslint/no-unused-vars'</span>: [<span class="hljs-string">'error'</span>, { 
      argsIgnorePattern: <span class="hljs-string">'^_'</span> 
    }]
  },
  settings: {
    react: {
      version: <span class="hljs-string">'detect'</span>
    }
  }
};
</code></pre>
<h4 data-id="heading-5">Prettier 格式化配置</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"printWidth"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"tabWidth"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"useTabs"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"semi"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"singleQuote"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"trailingComma"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"all"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"bracketSpacing"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"jsxSingleQuote"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"arrowParens"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"always"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"endOfLine"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"lf"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-6">2. 样式规范（视觉统一层）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// stylelint.config.js</span>
<span class="hljs-keyword">module</span>.<span class="hljs-keyword">exports</span> = {
  extends: [
    <span class="hljs-string">'stylelint-config-standard'</span>,
    <span class="hljs-string">'stylelint-config-recess-order'</span>,
    <span class="hljs-string">'stylelint-config-prettier'</span>
  ],
  rules: {
    <span class="hljs-string">'selector-class-pattern'</span>: <span class="hljs-string">'^[a-z][a-zA-Z0-9]*$'</span>,
    <span class="hljs-string">'no-descending-specificity'</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-string">'declaration-block-trailing-semicolon'</span>: <span class="hljs-string">'always'</span>
  }
};
</code></pre>
<h3 data-id="heading-7">3. 项目结构规范（组织架构层）</h3>
<pre><code class="hljs language-bash" lang="bash">src/
├── components/          <span class="hljs-comment"># 公共组件</span>
│   ├── common/         <span class="hljs-comment"># 通用基础组件</span>
│   └── business/       <span class="hljs-comment"># 业务组件</span>
├── pages/              <span class="hljs-comment"># 页面组件</span>
├── hooks/              <span class="hljs-comment"># 自定义 Hooks</span>
├── utils/              <span class="hljs-comment"># 工具函数</span>
├── services/           <span class="hljs-comment"># API 服务</span>
├── store/              <span class="hljs-comment"># 状态管理</span>
├── styles/             <span class="hljs-comment"># 全局样式</span>
├── types/              <span class="hljs-comment"># 类型定义</span>
└── assets/             <span class="hljs-comment"># 静态资源</span>
</code></pre>
<h2 data-id="heading-8">三、规范实施技术方案</h2>
<h3 data-id="heading-9">1. Git Hooks 自动化守护</h3>
<h4 data-id="heading-10">依赖安装</h4>
<pre><code class="hljs language-css" lang="css">npm install husky lint-staged <span class="hljs-attr">--save-dev</span>
</code></pre>
<h4 data-id="heading-11">package.json 配置</h4>
<pre><code class="hljs language-sql" lang="sql">{
  "scripts": {
    "prepare": "husky install",
    "lint": "eslint . --ext .js,.jsx,.ts,.tsx",
    "lint:fix": "eslint . --ext .js,.jsx,.ts,.tsx --fix",
    "format": "prettier --write \"src<span class="hljs-comment">/**/</span><span class="hljs-operator">*</span>.{js,jsx,ts,tsx,json,css,scss,md}\"",
    "type-check": "tsc --noEmit"
  },
  "lint-staged": {
    "*.{js,jsx,ts,tsx}": [
      "eslint --fix",
      "prettier --write",
      "git add"
    ],
    "*.{json,css,scss,md}": [
      "prettier --write",
      "git add"
    ]
  }
}
</code></pre>
<h4 data-id="heading-12">Commit Message 规范</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// commitlint.config.js</span>
<span class="hljs-keyword">module</span>.<span class="hljs-keyword">exports</span> = {
  extends: [<span class="hljs-string">'@commitlint/config-conventional'</span>],
  rules: {
    <span class="hljs-string">'type-enum'</span>: [
      <span class="hljs-number">2</span>,
      <span class="hljs-string">'always'</span>,
      [<span class="hljs-string">'feat'</span>, <span class="hljs-string">'fix'</span>, <span class="hljs-string">'docs'</span>, <span class="hljs-string">'style'</span>, <span class="hljs-string">'refactor'</span>, <span class="hljs-string">'perf'</span>, <span class="hljs-string">'test'</span>, <span class="hljs-string">'chore'</span>, <span class="hljs-string">'revert'</span>]
    ],
    <span class="hljs-string">'subject-case'</span>: [<span class="hljs-number">2</span>, <span class="hljs-string">'always'</span>, <span class="hljs-string">'sentence-case'</span>]
  }
};
</code></pre>
<h3 data-id="heading-13">2. 编辑器统一配置</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># .editorconfig</span>
<span class="hljs-attr">root</span> = <span class="hljs-literal">true</span>

<span class="hljs-section">[*]</span>
<span class="hljs-attr">charset</span> = utf-<span class="hljs-number">8</span>
<span class="hljs-attr">indent_style</span> = space
<span class="hljs-attr">indent_size</span> = <span class="hljs-number">2</span>
<span class="hljs-attr">end_of_line</span> = lf
<span class="hljs-attr">insert_final_newline</span> = <span class="hljs-literal">true</span>
<span class="hljs-attr">trim_trailing_whitespace</span> = <span class="hljs-literal">true</span>

<span class="hljs-section">[*.md]</span>
<span class="hljs-attr">trim_trailing_whitespace</span> = <span class="hljs-literal">false</span>
</code></pre>
<h2 data-id="heading-14">四、团队协作与规范落地策略</h2>
<h3 data-id="heading-15">1. 规范文档化体系</h3>
<p>创建 <code>CODEGUIDE.md</code> 文档，包含：</p>
<h4 data-id="heading-16">📋 核心原则</h4>
<ul>
<li>
<p><strong>一致性</strong>：团队代码风格统一</p>
</li>
<li>
<p><strong>可读性</strong>：代码清晰易懂</p>
</li>
<li>
<p><strong>可维护性</strong>：便于后续修改扩展</p>
</li>
<li>
<p><strong>安全性</strong>：避免常见安全问题</p>
</li>
</ul>
<h4 data-id="heading-17">💻 代码风格规范</h4>
<p><strong>JavaScript/TypeScript</strong></p>
<ul>
<li>
<p>缩进：2个空格</p>
</li>
<li>
<p>引号：优先单引号</p>
</li>
<li>
<p>分号：语句结尾必须</p>
</li>
<li>
<p>命名：</p>
<ul>
<li>
<p>变量/函数：camelCase</p>
</li>
<li>
<p>常量：UPPER_SNAKE_CASE</p>
</li>
<li>
<p>组件：PascalCase</p>
</li>
</ul>
</li>
</ul>
<p><strong>React 组件规范</strong></p>
<ul>
<li>
<p>文件组织：一个组件一个文件</p>
</li>
<li>
<p>Props 命名：语义化，避免缩写</p>
</li>
<li>
<p>State 管理：合理使用 useState/useReducer</p>
</li>
<li>
<p>副作用：使用 useEffect 管理</p>
</li>
</ul>
<h4 data-id="heading-18">📦 项目结构标准</h4>
<pre><code class="hljs language-bash" lang="bash">src/
├── components/ <span class="hljs-comment"># 组件目录</span>
├── pages/      <span class="hljs-comment"># 页面目录  </span>
├── hooks/      <span class="hljs-comment"># 自定义 Hooks</span>
├── utils/      <span class="hljs-comment"># 工具函数</span>
└── ...
</code></pre>
<h4 data-id="heading-19">🤝 Git 提交规范</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>(<span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>): <span class="hljs-tag">&lt;<span class="hljs-name">subject</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">footer</span>&gt;</span>
</code></pre>
<p><strong>提交类型说明：</strong></p>
<ul>
<li>
<p><code>feat</code>: 新功能</p>
</li>
<li>
<p><code>fix</code>: 修复bug</p>
</li>
<li>
<p><code>docs</code>: 文档更新</p>
</li>
<li>
<p><code>style</code>: 代码格式调整</p>
</li>
<li>
<p><code>refactor</code>: 代码重构</p>
</li>
<li>
<p><code>perf</code>: 性能优化</p>
</li>
<li>
<p><code>test</code>: 测试相关</p>
</li>
<li>
<p><code>chore</code>: 构建工具变动</p>
</li>
</ul>
<h3 data-id="heading-20">2. 新成员入职引导</h3>
<h4 data-id="heading-21">环境配置清单</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 1. 基础环境</span>
- <span class="hljs-section">[ ]</span> Node.js (指定版本)
- <span class="hljs-section">[ ]</span> 包管理器 (npm/yarn/pnpm)

<span class="hljs-comment"># 2. 项目初始化  </span>
- <span class="hljs-section">[ ]</span> git clone &lt;项目地址&gt;
- <span class="hljs-section">[ ]</span> cd &lt;项目目录&gt;
- <span class="hljs-section">[ ]</span> npm install

<span class="hljs-comment"># 3. 开发环境设置</span>
- <span class="hljs-section">[ ]</span> npm run setup
- <span class="hljs-section">[ ]</span> 配置 IDE 插件
</code></pre>
<h4 data-id="heading-22">规范培训重点</h4>
<ul>
<li>
<p>代码提交流程</p>
</li>
<li>
<p>代码审查标准</p>
</li>
<li>
<p>例外处理机制</p>
</li>
</ul>
<h2 data-id="heading-23">五、面试回答策略</h2>
<h3 data-id="heading-24">问题1：如何设计前端代码规范？</h3>
<p><strong>专业回答：</strong></p>
<blockquote>
<p>"我设计前端代码规范时采用分层架构思维，从技术实现到团队文化全方位考虑：</p>
</blockquote>
<p><strong>第一层：基础代码规范</strong></p>
<ul>
<li>
<p>代码风格：ESLint + Prettier 统一格式</p>
</li>
<li>
<p>最佳实践：组件设计原则、状态管理规范</p>
</li>
<li>
<p>质量保障：TypeScript 类型检查、单元测试</p>
</li>
</ul>
<p><strong>第二层：工具链配置</strong></p>
<ul>
<li>
<p>静态分析：ESLint 检查代码质量</p>
</li>
<li>
<p>格式化：Prettier 自动格式化</p>
</li>
<li>
<p>提交规范：Commitlint 强制规范提交</p>
</li>
</ul>
<p><strong>第三层：执行机制</strong></p>
<ul>
<li>
<p>Git Hooks：Husky + lint-staged 自动化检查</p>
</li>
<li>
<p>CI/CD 集成：流水线代码质量门禁</p>
</li>
<li>
<p>文档化：详细的指南和示例代码</p>
</li>
</ul>
<p><strong>设计原则：</strong></p>
<ul>
<li>
<p>渐进式：新项目严格，老项目逐步引入</p>
</li>
<li>
<p>自动化：工具自动检查和修复</p>
</li>
<li>
<p>可配置：合理的例外处理机制</p>
</li>
<li>
<p>团队参与：共同制定提高接受度"</p>
</li>
</ul>
<h3 data-id="heading-25">问题2：如何确保团队成员遵守代码规范？</h3>
<p><strong>专业回答：</strong></p>
<blockquote>
<p>"确保规范执行需要技术手段和管理策略结合：</p>
</blockquote>
<p><strong>技术层 - 自动化强制</strong></p>
<ul>
<li>
<p>Git Hooks 守护：pre-commit 自动修复，pre-push 全量检查</p>
</li>
<li>
<p>提交信息规范：commitlint 确保符合约定式提交</p>
</li>
<li>
<p>IDE 实时提示：开发时实时发现问题</p>
</li>
</ul>
<p><strong>流程层 - 制度保障</strong></p>
<ul>
<li>
<p>代码审查：规范遵守作为 PR 必要审查项</p>
</li>
<li>
<p>CI/CD 检查：流水线设置质量门禁</p>
</li>
</ul>
<p><strong>管理层 - 文化建设</strong></p>
<ul>
<li>
<p>新人引导：专门的规范培训</p>
</li>
<li>
<p>定期回顾：讨论执行情况和改进建议</p>
</li>
<li>
<p>规范进化：根据反馈适时调整</p>
</li>
</ul>
<p><strong>关键技术实现：</strong></p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"*.{js,jsx,ts,tsx}"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"eslint --fix"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"prettier --write"</span><span class="hljs-punctuation">,</span> 
    <span class="hljs-string">"git add"</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>通过这种多层次体系，既保证规范执行，又不影响开发效率，最终形成团队自发的规范意识。"</p>
<h3 data-id="heading-26">问题3：遇到团队成员不遵守规范怎么办？</h3>
<p><strong>应对策略：</strong></p>
<blockquote>
<p>"面对这种情况，我采取循序渐进的策略：</p>
</blockquote>
<p><strong>1. 理解原因</strong></p>
<ul>
<li>
<p>私下了解具体原因</p>
</li>
<li>
<p>区分是工具使用问题还是规范理解问题</p>
</li>
</ul>
<p><strong>2. 技术辅助</strong></p>
<ul>
<li>
<p>提供详细工具使用指南</p>
</li>
<li>
<p>帮助配置开发环境</p>
</li>
<li>
<p>对复杂规范提供具体示例</p>
</li>
</ul>
<p><strong>3. 渐进式要求</strong></p>
<ul>
<li>
<p>历史代码：新修改部分遵守规范</p>
</li>
<li>
<p>特殊情况：Code Review 讨论后有条件豁免</p>
</li>
</ul>
<p><strong>4. 正向激励</strong></p>
<ul>
<li>
<p>代码审查中给予正面反馈</p>
</li>
<li>
<p>将规范遵守作为能力评估参考</p>
</li>
<li>
<p>分享规范带来的实际收益案例</p>
</li>
</ul>
<p><strong>5. 制度保障</strong></p>
<ul>
<li>
<p>通过代码审查流程强制要求</p>
</li>
<li>
<p>作为团队协作基本要求强调</p>
</li>
</ul>
<p><strong>关键点：</strong> 规范的目的是提高团队效率，不是惩罚。通过理解、引导、支持，帮助团队成员从被动遵守转变为主动认同。"</p>
<p>通过这套完整的代码规范体系，团队可以建立统一的开发标准，提升代码质量和协作效率，为项目的长期健康发展奠定坚实基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vite 库模式输出 ESM 格式时的依赖处理方案]]></title>    <link>https://juejin.cn/post/7571594817224146995</link>    <guid>https://juejin.cn/post/7571594817224146995</guid>    <pubDate>2025-11-12T09:50:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571594817224146995" data-draft-id="7571594817224130611" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vite 库模式输出 ESM 格式时的依赖处理方案"/> <meta itemprop="keywords" content="前端,Vite"/> <meta itemprop="datePublished" content="2025-11-12T09:50:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户7405463994309"/> <meta itemprop="url" content="https://juejin.cn/user/2828394730381693"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vite 库模式输出 ESM 格式时的依赖处理方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2828394730381693/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户7405463994309
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T09:50:00.000Z" title="Wed Nov 12 2025 09:50:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🧩 环境信息</h2>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"vite"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"5.4.15"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"vue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.7.16"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-1">📖 背景说明</h2>
<p>当前项目是一个<strong>前端框架型宿主项目</strong>，主要负责：</p>
<ul>
<li>
<p>管理功能菜单与用户模块；</p>
</li>
<li>
<p>通过 <code>iframe</code> 嵌入多个<strong>子前端项目</strong>；</p>
</li>
<li>
<p>在“工作台”页面中动态加载来自其他前端项目的<strong>小组件（Widget）</strong>。</p>
</li>
</ul>
<p>为了便于这些小组件的动态加载与复用，我们使用了 <strong>Vite 的库模式（Library Mode）</strong> 来进行打包。</p>
<hr/>
<h2 data-id="heading-2">⚙️ 初始配置</h2>
<p>最早的 <code>widget.vite.config.js</code> 如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">return</span> {
  <span class="hljs-attr">build</span>: {
    <span class="hljs-attr">lib</span>: {
      <span class="hljs-attr">entry</span>: {
        <span class="hljs-attr">customReport</span>: <span class="hljs-string">'widgets/custom_report/index.js'</span>
      },
      <span class="hljs-attr">fileName</span>: <span class="hljs-function">(<span class="hljs-params">_, entryName</span>) =&gt;</span> <span class="hljs-string">`<span class="hljs-subst">${entryName}</span>.js`</span>,
      <span class="hljs-attr">formats</span>: [<span class="hljs-string">'es'</span>]
    },
    <span class="hljs-attr">rollupOptions</span>: {
      <span class="hljs-attr">output</span>: {
        <span class="hljs-attr">chunkFileNames</span>: <span class="hljs-string">'js/[name]-[hash].js'</span>,
        <span class="hljs-attr">assetFileNames</span>: <span class="hljs-string">'[name].[ext]'</span>,
        <span class="hljs-attr">manualChunks</span>: <span class="hljs-function"><span class="hljs-params">id</span> =&gt;</span> {
          <span class="hljs-keyword">if</span> (id.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'node_modules'</span>)) {
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> chunk <span class="hljs-keyword">of</span> chunks) {
              <span class="hljs-keyword">if</span> (id.<span class="hljs-title function_">includes</span>(<span class="hljs-string">`node_modules/<span class="hljs-subst">${chunk}</span>`</span>)) <span class="hljs-keyword">return</span> chunk
            }
          }
        }
      }
    }
  }
}
</code></pre>
<p>起初并没有将 <code>vue</code> 从打包中排除，因为<strong>看似一切正常</strong>，直到后来出现了严重问题👇</p>
<hr/>
<h2 data-id="heading-3">💥 问题分析：Vue 多实例导致渲染死循环</h2>
<p>在某个小组件中使用函数式组件渲染 <code>VNode</code> 数组时，页面发生<strong>死循环渲染</strong>：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;VNode :data="bottomInst" /&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  components: {
    VNode: {
      functional: true,
      render: (h, ctx) =&gt;
        isFunction(ctx.props.data) ? ctx.props.data() : ctx.props.data
    }
  }
}
&lt;/script&gt;
</code></pre>
<ul>
<li>
<p>页面会不断触发 <code>render()</code>，导致浏览器卡死。</p>
</li>
<li>
<p>后续测试发现是因为<strong>宿主项目与子组件中使用的 Vue 实例不一致</strong>。</p>
</li>
</ul>
<p>换句话说，小组件自己又打包进了一份 <code>vue</code>，与宿主项目的 Vue 实例“冲突”了。</p>
<hr/>
<h2 data-id="heading-4">🧠 回到根源：Vue 外部化问题</h2>
<p>Vite 官方文档明确建议：</p>
<blockquote>
<p>当你的库要被宿主项目引用时，应使用 <code>build.lib</code> 并<strong>外部化处理依赖</strong>，例如 <code>vue</code> 或 <code>react</code>。</p>
</blockquote>
<p>官方示例：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">build</span>: {
    <span class="hljs-attr">lib</span>: {
      <span class="hljs-attr">entry</span>: {
        <span class="hljs-string">'my-lib'</span>: <span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'lib/main.js'</span>),
        <span class="hljs-attr">secondary</span>: <span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'lib/secondary.js'</span>)
      },
      <span class="hljs-attr">name</span>: <span class="hljs-string">'MyLib'</span>
    },
    <span class="hljs-attr">rollupOptions</span>: {
      <span class="hljs-attr">external</span>: [<span class="hljs-string">'vue'</span>],
      <span class="hljs-attr">output</span>: {
        <span class="hljs-attr">globals</span>: {
          <span class="hljs-attr">vue</span>: <span class="hljs-string">'Vue'</span>
        }
      }
    }
  }
})
</code></pre>
<hr/>
<h2 data-id="heading-5">⚠️ 实际遇到的问题</h2>
<p>当配置为<strong>多入口</strong>时：</p>
<ul>
<li>
<p>默认打包格式会变为 <code>['es', 'cjs']</code>；</p>
</li>
<li>
<p>如果强制设置 <code>formats: ['umd']</code>，Rollup 会报错；</p>
</li>
<li>
<p>而在 <strong>ESM 模式下</strong>，<code>globals</code> 配置不会生效（即不会转成全局变量访问）。</p>
</li>
</ul>
<p>因此，当外部化 <code>vue</code> 后，代码仍然保留：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
</code></pre>
<p>浏览器在执行时会报错：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Uncaught</span> <span class="hljs-title class_">TypeError</span>: <span class="hljs-title class_">Failed</span> to resolve <span class="hljs-variable language_">module</span> specifier <span class="hljs-string">"vue"</span>.
</code></pre>
<p>因为浏览器根本不知道 <code>"vue"</code> 这个导入路径应该从哪里加载。</p>
<hr/>
<h2 data-id="heading-6">✅ 正确的解决方案</h2>
<h3 data-id="heading-7">方法一：使用 HTML Import Map（推荐，前提是宿主环境支持）</h3>
<p>如果不需要兼容 Chrome 89 以下版本，可以在宿主项目的 HTML 中声明：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"importmap"</span>&gt;</span><span class="javascript">
{
  <span class="hljs-string">"imports"</span>: {
    <span class="hljs-string">"vue"</span>: <span class="hljs-string">"https://example.com/vue.js"</span>
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>这样浏览器在解析到：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
</code></pre>
<p>时，会自动从 <code>/vue.js</code> 加载，而不是去找 <code>node_modules</code>。</p>
<p>✅ 优点：</p>
<ul>
<li>
<p>符合原生 ES Module 机制；</p>
</li>
<li>
<p>适合现代浏览器；</p>
</li>
<li>
<p>简洁直观。</p>
</li>
</ul>
<p>❌ 缺点：</p>
<ul>
<li>
<p>Chrome 89 以下（含 IE）不支持 <code>importmap</code>；</p>
</li>
<li>
<p>需要在宿主 HTML 中维护映射。</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-8">方法二：使用 Rollup 的 <code>output.paths</code> 配置</h3>
<p>如果你希望在构建阶段就将路径转换成一个可访问的 URL，可使用：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">return</span> {
  <span class="hljs-attr">build</span>: {
    <span class="hljs-attr">lib</span>: {
      <span class="hljs-attr">entry</span>: {
        <span class="hljs-attr">customReport</span>: <span class="hljs-string">'widgets/custom_report/index.js'</span>
      },
      <span class="hljs-attr">fileName</span>: <span class="hljs-function">(<span class="hljs-params">_, entryName</span>) =&gt;</span> <span class="hljs-string">`<span class="hljs-subst">${entryName}</span>.js`</span>,
      <span class="hljs-attr">formats</span>: [<span class="hljs-string">'es'</span>]
    },
    <span class="hljs-attr">rollupOptions</span>: {
      <span class="hljs-attr">external</span>: [<span class="hljs-string">'vue'</span>],
      <span class="hljs-attr">output</span>: {
        <span class="hljs-attr">paths</span>: {
          <span class="hljs-attr">vue</span>: <span class="hljs-string">'/dist/assets/vue.js'</span>
        }
      }
    }
  }
}
</code></pre>
<p>打包后：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// ✅ 自动替换成可访问路径</span>
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'/dist/assets/vue.js'</span>
</code></pre>
<p>宿主项目只需确保 <code>/dist/assets/vue.js</code> 存在（即宿主与子项目共享同一份 Vue 文件）。</p>
<p>✅ 优点：</p>
<ul>
<li>
<p>不依赖 importmap；</p>
</li>
<li>
<p>可控制精确路径；</p>
</li>
<li>
<p>浏览器 100% 可识别。</p>
</li>
</ul>
<p>❌ 缺点：</p>
<ul>
<li>
<p>宿主项目需要在相同路径下提供该文件；</p>
</li>
<li>
<p>一旦路径变更，需要同步更新。</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-9">🧾 总结对比</h2>


























<table><thead><tr><th>方案</th><th>关键配置</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>方法一</strong> ImportMap</td><td><code>&lt;script type="importmap"&gt;</code></td><td>原生 ESM 支持、配置简单</td><td>浏览器兼容性要求高</td><td>现代浏览器环境</td></tr><tr><td><strong>方法二</strong> Rollup paths</td><td><code>rollupOptions.output.paths</code></td><td>无需 importmap，构建期解决</td><td>路径需宿主一致</td><td>自定义部署结构、多版本环境</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-10">🚀 实践建议</h2>
<ol>
<li>
<p><strong>统一宿主与子项目的 Vue 实例来源</strong>。<br/>
→ 不要在子组件中重复打包 <code>vue</code>。</p>
</li>
<li>
<p><strong>打包时外部化 Vue</strong>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">external</span>: [<span class="hljs-string">'vue'</span>]
</code></pre>
</li>
<li>
<p><strong>根据浏览器兼容性选择方案</strong>：</p>
<ul>
<li>
<p>支持现代浏览器 → ✅ ImportMap；</p>
</li>
<li>
<p>需要兼容旧环境 → ✅ Rollup <code>paths</code>。</p>
</li>
</ul>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 vLLM 原生部署 PaddleOCR-VL：高性能、OpenAI 兼容的多模态 OCR 服务]]></title>    <link>https://juejin.cn/post/7571650164843331618</link>    <guid>https://juejin.cn/post/7571650164843331618</guid>    <pubDate>2025-11-12T09:28:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571650164843331618" data-draft-id="7571650164843282466" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 vLLM 原生部署 PaddleOCR-VL：高性能、OpenAI 兼容的多模态 OCR 服务 "/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-12T09:28:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="上官胡闹"/> <meta itemprop="url" content="https://juejin.cn/user/641770523725374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 vLLM 原生部署 PaddleOCR-VL：高性能、OpenAI 兼容的多模态 OCR 服务 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/641770523725374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    上官胡闹
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T09:28:53.000Z" title="Wed Nov 12 2025 09:28:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">序言</h2>
<p>笔者此前曾撰写过一篇关于使用 Paddle 官方提供的 <code>paddlex-genai-vllm-server</code> 部署 <code>PaddleOCR-VL</code> 模型的文章，其中简要介绍了该模型的特性，并对比了其与 <code>DeepSeek-OCR</code> 的差异。</p>
<p>近期，笔者持续关注 vLLM 官方社区对 <code>PaddleOCR-VL</code> 的支持进展——社区已于 2025 年 10 月 30 日正式合并了对该模型的支持 PR。</p>
<p>因此，本文将介绍如何基于 <strong>vLLM 官方版本</strong>直接部署 <code>PaddleOCR-VL</code> 模型。</p>
<blockquote>
<p>💡 当前 vLLM 的代码同样支持 <code>DeepSeek-OCR</code>，用户可根据需求灵活选择。</p>
</blockquote>
<h2 data-id="heading-1">介绍</h2>
<p><code>PaddleOCR-VL</code> 是一个专为文档解析设计的<strong>最先进（SOTA）且资源高效</strong>的多模态模型。
其核心组件是 <code>PaddleOCR-VL-0.9B</code> —— 一个紧凑而强大的视觉-语言模型（VLM），集成了基于 <strong>NaViT 风格的动态分辨率视觉编码器</strong> 与 <strong>ERNIE-4.5-0.3B 语言模型</strong>，从而实现对文档中文字、表格、公式等元素的高精度识别。</p>
<h2 data-id="heading-2">部署</h2>
<p>本文介绍两种部署方式：裸机部署与 Kubernetes（k8s）部署。</p>
<h3 data-id="heading-3">裸机部署</h3>
<pre><code class="hljs language-bash" lang="bash">uv venv
<span class="hljs-built_in">source</span> .venv/bin/activate

<span class="hljs-comment"># v0.11.1 尚未正式发布，需安装 nightly 版本</span>
uv pip install -U vllm \
    --pre \
    --extra-index-url https://wheels.vllm.ai/nightly \
    --extra-index-url https://download.pytorch.org/whl/cu129 \
    --index-strategy unsafe-best-match
</code></pre>
<blockquote>
<p>⚠️ 注意：截至本文撰写时，vLLM v0.11.1 尚未发布，因此必须使用 nightly 构建版本以获得 <code>PaddleOCR-VL</code> 支持。</p>
</blockquote>
<p>启动服务：</p>
<pre><code class="hljs language-bash" lang="bash">vllm serve PaddlePaddle/PaddleOCR-VL \
    --trust-remote-code \
    --max-num-batched-tokens 16384 \
    --no-enable-prefix-caching \
    --mm-processor-cache-gb 0
</code></pre>
<h4 data-id="heading-4">参数说明：</h4>
<ul>
<li><code>--trust-remote-code</code>：因模型包含自定义代码，需显式启用。</li>
<li><code>--no-enable-prefix-caching</code>：OCR 任务通常无重复前缀，关闭可节省显存。</li>
<li><code>--mm-processor-cache-gb 0</code>：禁用多模态处理器缓存，适用于单次推理场景；若需高频调用，可适当调高此值。</li>
</ul>
<h3 data-id="heading-5">Kubernetes（k8s）部署</h3>
<p>在生产环境中，大多数场景采用 Kubernetes 进行部署。以下是基于 k8s 的部署方案。</p>
<h4 data-id="heading-6">1. 构建镜像</h4>
<p>由于 v0.11.1 尚未正式发布，目前需通过源码构建镜像（也可关注官方 nightly 镜像）：</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/vllm-project/vllm.git
<span class="hljs-built_in">cd</span> vllm
docker build -t vllm:latest-test -f docker/Dockerfile .
</code></pre>
<blockquote>
<p>📌 待 v0.11.1 正式发布后，可直接使用官方 PyPI 或 Docker Hub 镜像，无需手动构建。</p>
</blockquote>
<h4 data-id="heading-7">2. 创建 Deployment</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">paddleocr-vl</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">paddleocr-vl</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">paddleocr-vl</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">paddleocr-vl</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">paddleocr-vl</span>
          <span class="hljs-attr">image:</span> <span class="hljs-string">vllm:latest-test</span>
          <span class="hljs-attr">command:</span> [<span class="hljs-string">"vllm"</span>]
          <span class="hljs-attr">args:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">"serve"</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">"/models/PaddleOCR-VL"</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">"--served-model-name=PaddleOCR-VL"</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">"--host=0.0.0.0"</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">"--port=8000"</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">"--trust-remote-code"</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">"--revision=v1"</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">"--max-num-batched-tokens=16384"</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">"--no-enable-prefix-caching"</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">"--mm-processor-cache-gb=0"</span>
          <span class="hljs-attr">ports:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8000</span>
              <span class="hljs-attr">name:</span> <span class="hljs-string">http</span>
              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
          <span class="hljs-attr">resources:</span>
            <span class="hljs-attr">limits:</span>
              <span class="hljs-attr">nvidia.com/gpu:</span> <span class="hljs-number">1</span>
              <span class="hljs-attr">memory:</span> <span class="hljs-string">"16Gi"</span>
              <span class="hljs-attr">cpu:</span> <span class="hljs-string">"4"</span>
            <span class="hljs-attr">requests:</span>
              <span class="hljs-attr">memory:</span> <span class="hljs-string">"12Gi"</span>
              <span class="hljs-attr">cpu:</span> <span class="hljs-string">"2"</span>
              <span class="hljs-attr">nvidia.com/gpu:</span> <span class="hljs-number">1</span>
          <span class="hljs-attr">readinessProbe:</span>
            <span class="hljs-attr">tcpSocket:</span>
              <span class="hljs-attr">port:</span> <span class="hljs-number">8000</span>
            <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">60</span>
            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span>
            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">5</span>
          <span class="hljs-attr">volumeMounts:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">shm</span>
              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/dev/shm</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">model-storage</span>
              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/models/PaddleOCR-VL</span>
      <span class="hljs-attr">volumes:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">shm</span>
          <span class="hljs-attr">emptyDir:</span>
            <span class="hljs-attr">medium:</span> <span class="hljs-string">Memory</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">model-storage</span>
          <span class="hljs-attr">hostPath:</span>
            <span class="hljs-attr">path:</span> <span class="hljs-string">/mnt/data/paddleocr-vl/models</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">Directory</span>
</code></pre>
<h4 data-id="heading-8">配置说明：</h4>
<ul>
<li><code>/models/PaddleOCR-VL</code>：模型本地挂载路径，请根据实际环境调整。</li>
<li><code>--no-enable-prefix-caching</code>：OCR 场景通常不需要前缀缓存，关闭可减少内存开销。</li>
<li><code>--mm-processor-cache-gb</code>：控制多模态预处理缓存大小，设为 <code>0</code> 表示禁用。</li>
</ul>
<blockquote>
<p>🔔 建议在 GPU 节点上部署，并确保已安装 NVIDIA Device Plugin。</p>
</blockquote>
<h2 data-id="heading-9">测试</h2>
<p>测试用例参考自 vLLM 官方社区文档，代码如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI

client = OpenAI(
    api_key=<span class="hljs-string">"EMPTY"</span>,
    base_url=<span class="hljs-string">"http://localhost:8000/v1"</span>,
    timeout=<span class="hljs-number">3600</span>
)

<span class="hljs-comment"># 任务类型提示词</span>
TASKS = {
    <span class="hljs-string">"ocr"</span>: <span class="hljs-string">"OCR:"</span>,
    <span class="hljs-string">"table"</span>: <span class="hljs-string">"Table Recognition:"</span>,
    <span class="hljs-string">"formula"</span>: <span class="hljs-string">"Formula Recognition:"</span>,
    <span class="hljs-string">"chart"</span>: <span class="hljs-string">"Chart Recognition:"</span>,
}

messages = [
    {
        <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
        <span class="hljs-string">"content"</span>: [
            {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>,
                <span class="hljs-string">"image_url"</span>: {
                    <span class="hljs-string">"url"</span>: <span class="hljs-string">"https://ofasys-multimodal-wlcb-3-toshanghai.oss-accelerate.aliyuncs.com/wpf272043/keepme/image/receipt.png"</span>
                }
            },
            {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                <span class="hljs-string">"text"</span>: TASKS[<span class="hljs-string">"ocr"</span>]
            }
        ]
    }
]

response = client.chat.completions.create(
    model=<span class="hljs-string">"PaddlePaddle/PaddleOCR-VL"</span>,
    messages=messages,
    temperature=<span class="hljs-number">0.0</span>,
)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"识别结果: <span class="hljs-subst">{response.choices[<span class="hljs-number">0</span>].message.content}</span>"</span>)
</code></pre>
<blockquote>
<p>✅ 该接口完全兼容 OpenAI 格式，可无缝集成到现有 AI 应用栈中。</p>
</blockquote>
<h2 data-id="heading-10">总结</h2>
<p>通过原生 vLLM 部署 <code>PaddleOCR-VL</code> 模型，具备以下显著优势：</p>
<ul>
<li>✅ <strong>OpenAI API 兼容</strong>：自动提供 <code>/v1/chat/completions</code> 接口，可直接接入企业现有的 AI 网关（如 Kong、Traefik、自研网关等）。</li>
<li>✅ <strong>高性能推理</strong>：依托 vLLM 的 PagedAttention、连续批处理（continuous batching）等优化技术，实现<strong>高吞吐、低延迟</strong>的 OCR 服务。</li>
<li>✅ <strong>灵活部署</strong>：支持裸机、Docker、Kubernetes 等多种部署形态，适配开发、测试与生产全链路。</li>
<li>✅ <strong>社区驱动</strong>：作为 vLLM 官方支持的模型，未来将持续获得性能优化与新功能更新。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hilt 和依赖注入]]></title>    <link>https://juejin.cn/post/7571636682695114792</link>    <guid>https://juejin.cn/post/7571636682695114792</guid>    <pubDate>2025-11-12T10:03:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571636682695114792" data-draft-id="7570793903847915535" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hilt 和依赖注入"/> <meta itemprop="keywords" content="Android,Android Jetpack"/> <meta itemprop="datePublished" content="2025-11-12T10:03:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨白"/> <meta itemprop="url" content="https://juejin.cn/user/2549135752044601"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hilt 和依赖注入
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2549135752044601/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨白
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T10:03:40.000Z" title="Wed Nov 12 2025 10:03:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">为什么需要依赖注入？</h2>
<p>依赖注入（Dependency Injection，简称 DI）是一种设计模式，我们为什么需要它呢？</p>
<p>为了实现类之间的<strong>解耦</strong>，以及依赖关系的管理。</p>
<h3 data-id="heading-1">高耦合</h3>
<p>我们来看一个人和咖啡机的例子：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 只能做美式咖啡的咖啡机</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SpecificCoffeeMachine</span> {

    <span class="hljs-keyword">init</span> {
        println(<span class="hljs-string">"(An expensive SpecificCoffeeMachine was built...)"</span>)
    }

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">makeAmericano</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"Making... Americano"</span>) <span class="hljs-comment">// ☕️</span>
    }
}

<span class="hljs-comment">// 人</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {

    <span class="hljs-comment">// 硬编码了咖啡机的创建</span>
    <span class="hljs-comment">// Person 和 SpecificCoffeeMachine 被耦合在了一起</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> myCoffeeMachine: SpecificCoffeeMachine = SpecificCoffeeMachine()

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startMorning</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"Good morning, I need coffee..."</span>)
        myCoffeeMachine.makeAmericano()
        println(<span class="hljs-string">"The coffee is finished and work is done."</span>)
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> bob = Person()
    bob.startMorning()
}
</code></pre>
<p>看似没什么问题，但如果有一天，Bob 想喝拿铁了，我们只能修改 <code>Person</code> 类的代码，去<strong>强行修改它的内部结构</strong>。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 只能做拿铁的咖啡机</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LatteMachine</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">makeLatte</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"Making... Latte"</span>) <span class="hljs-comment">// 🥛☕️</span>
    }
}

<span class="hljs-comment">// 人</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> myCoffeeMachine: LatteMachine = LatteMachine()

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startMorning</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"Good morning, I need coffee..."</span>)
        myCoffeeMachine.makeLatte() <span class="hljs-comment">// 甚至调用的方法名也需要修改</span>
        println(<span class="hljs-string">"The coffee is finished and work is done."</span>)
    }
}
</code></pre>
<p>如果有 100 个类使用了 <code>SpecificCoffeeMachine</code>，我们就得去修改 100 个类。</p>
<p>并且无法对 <code>Person</code> 的 <code>startMorning()</code> 进行单元测试。</p>
<p>在创建 <code>Person</code> 对象时，其内部一定会创建一个 <code>SpecificCoffeeMachine</code> 实例，如果 <code>SpecificCoffeeMachine</code> 在创建时存在复杂操作，单元测试就会变慢。测试失败时不清楚是谁的原因，不清楚 <code>startMorning()</code> 内部是否真的调用了 <code>makeAmericano()</code>，单元测试变得无法验证。</p>
<h3 data-id="heading-2">低耦合</h3>
<p>我们使用依赖注入来解耦，现在 <code>Person</code> 不主动创建咖啡机，而是由外部创建。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">CoffeeMaker</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">makeCoffee</span><span class="hljs-params">()</span></span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AmericanoMachine</span> : <span class="hljs-type">CoffeeMaker</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">makeCoffee</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"Making... Americano"</span>) <span class="hljs-comment">// ☕️</span>
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">LatteMachine</span> : <span class="hljs-type">CoffeeMaker</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">makeCoffee</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"Making... Latte"</span>) <span class="hljs-comment">// 🥛☕️</span>
    }
}


<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(
    <span class="hljs-comment">// 咖啡制造机由外部注入</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> coffeeMaker: CoffeeMaker
) {

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startMorning</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"Good morning, I need coffee..."</span>)
        coffeeMaker.makeCoffee()
        println(<span class="hljs-string">"The coffee is finished and work is done."</span>)
    }
}


<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// Bob 想喝美式了</span>
    <span class="hljs-keyword">val</span> americanoDay = Person(AmericanoMachine())
    americanoDay.startMorning()

    println(<span class="hljs-string">"--- Day 2 ---"</span>)

    <span class="hljs-comment">// Bob 想喝拿铁了</span>
    <span class="hljs-keyword">val</span> latteDay = Person(LatteMachine())
    latteDay.startMorning()
}
</code></pre>
<p>此时 <code>Person</code> 就变得很灵活了，当需要不同的咖啡机时，无需修改 <code>Person</code> 类的代码。</p>
<p>并且很容易进行测试：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ExampleUnitTest</span> {

    <span class="hljs-keyword">class</span> <span class="hljs-title class_">FakeTestMachine</span> : <span class="hljs-type">CoffeeMaker</span> {
        <span class="hljs-keyword">var</span> coffeeWasMade = <span class="hljs-literal">false</span>
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">makeCoffee</span><span class="hljs-params">()</span></span> {
            println(<span class="hljs-string">"(Test: Pretend to be making coffee)"</span>)
            coffeeWasMade = <span class="hljs-literal">true</span>
        }
    }

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">person_startMorning</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> testMachine = FakeTestMachine()
        <span class="hljs-keyword">val</span> testPerson = Person(testMachine)
        testPerson.startMorning()

        assertTrue(testMachine.coffeeWasMade)
        println(<span class="hljs-string">"Test passed!"</span>)
    }
}
</code></pre>
<h2 data-id="heading-3">Hilt 依赖注入框架</h2>
<p>Hilt 是一个依赖注入框架，我想大家对于它已不再陌生。</p>
<h3 data-id="heading-4">添加依赖和启用 Hilt</h3>
<p>首先，在项目配置文件中添加 Hilt 和 KSP 插件。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Top-level build file where you can add configuration options common to all sub-projects/modules.</span>
plugins {
    ...

    id(<span class="hljs-string">"com.google.dagger.hilt.android"</span>) version <span class="hljs-string">"2.57.1"</span> apply <span class="hljs-literal">false</span>
    id(<span class="hljs-string">"com.google.devtools.ksp"</span>) version <span class="hljs-string">"2.0.21-1.0.27"</span> apply <span class="hljs-literal">false</span> 
}
</code></pre>
<blockquote>
<p>注意：KSP 的版本需要和当前的 Kotlin 版本（<code>2.0.21</code>）保持一致：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgoogle%2Fksp%2Freleases" target="_blank" title="https://github.com/google/ksp/releases" ref="nofollow noopener noreferrer">KSP 所有版本</a>。</p>
</blockquote>
<p>然后，在应用配置文件中添加以下依赖项：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">plugins {
    id(<span class="hljs-string">"com.google.devtools.ksp"</span>)
    id(<span class="hljs-string">"com.google.dagger.hilt.android"</span>)
}

dependencies {
    implementation(<span class="hljs-string">"com.google.dagger:hilt-android:2.57.1"</span>)
    ksp(<span class="hljs-string">"com.google.dagger:hilt-android-compiler:2.57.1"</span>)
}
</code></pre>
<p>最后，在 <code>Application</code> 类上添加 <code>@HiltAndroidApp</code> 注解，以启用 Hilt 的功能。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@HiltAndroidApp</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyApplication</span> : <span class="hljs-type">Application</span>()
</code></pre>
<p>别忘了将这个 <code>Application</code> 注册到清单文件中：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">application</span>
    <span class="hljs-attr">android:name</span>=<span class="hljs-string">".MyApplication"</span>&gt;</span>
</code></pre>
<h3 data-id="heading-5">简单用法</h3>
<p>Hilt 的注入功能（提供依赖项），支持以下 Android 类：</p>
<ul>
<li><code>Application</code>（通过 <code>@HiltAndroidApp</code>）</li>
<li><code>ViewModel</code>（通过 <code>@HiltViewModel</code>）</li>
<li><code>Activity</code></li>
<li><code>Fragment</code></li>
<li><code>View</code></li>
<li><code>Service</code></li>
<li><code>BroadcastReceiver</code></li>
</ul>
<p>除了 <code>Application</code> 和 <code>ViewModel</code> 外，其他的类都是通过 <code>@AndroidEntryPoint</code> 注解来声明的。</p>
<p>以 <code>Activity</code> 为例，我们来简单使用一下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@AndroidEntryPoint</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">ComponentActivity</span>() {

    <span class="hljs-comment">// 拿铁制造机由 Hilt 注入</span>
    <span class="hljs-meta">@Inject</span>
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> latteMachine: LatteMachine

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContent {}

        latteMachine.makeCoffee()
    }

}
</code></pre>
<blockquote>
<p>注意：使用 <code>@Inject</code> 进行字段注入，被注入的字段不能是 <code>private</code> 的。而通过构造函数注入的参数，则可以是 <code>private</code> 的。</p>
</blockquote>
<p>在 <code>LatteMachine</code> 类的无参构造函数上添加 <code>@Inject</code>，让 Hilt 知道拿铁机的“制造”方法。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LatteMachine</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>() : CoffeeMaker {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">makeCoffee</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"Making... Latte"</span>) <span class="hljs-comment">// 🥛☕️   </span>
    }
}
</code></pre>
<p>运行程序，结果如下：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">Making</span>... <span class="hljs-selector-tag">Latte</span>
</code></pre>
<p>咖啡机确实制作了一杯拿铁。</p>
<h3 data-id="heading-6">带参的依赖注入</h3>
<p>我们再来看看带参数的构造函数的注入，给 <code>LatteMachine</code> 的构造函数添加一个牛奶起泡器的参数：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LatteMachine</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> milkFrother: MilkFrother
) : CoffeeMaker {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">makeCoffee</span><span class="hljs-params">()</span></span> {
        milkFrother.frothMilk()
        println(<span class="hljs-string">"Making... Latte"</span>) <span class="hljs-comment">// 🥛☕️</span>
    }
}
</code></pre>
<p>对于参数 <code>milkFrother</code>，Hilt 会自动寻找并尝试注入它。</p>
<p>我们只需让 Hilt 知道牛奶起泡器的“制造”方法即可，和之前一样：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 添加 <span class="hljs-doctag">@Inject</span> constructor，让 Hilt 知道如何创建它
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MilkFrother</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">frothMilk</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"(The milk is frothing...)"</span>)
    }
}
</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-less" lang="less">(<span class="hljs-selector-tag">The</span> <span class="hljs-selector-tag">milk</span> <span class="hljs-selector-tag">is</span> <span class="hljs-selector-tag">frothing</span>...)
<span class="hljs-selector-tag">Making</span>... <span class="hljs-selector-tag">Latte</span>
</code></pre>
<p>只有 <code>LatteMachine</code> 构造函数所依赖的参数都能被注入，<code>LatteMachine</code> 才能被注入。</p>
<h2 data-id="heading-7">复杂注入</h2>
<h3 data-id="heading-8">接口</h3>
<p>以之前的 <code>Person</code> 类为例，我们来完成 <code>CoffeeMaker</code> 接口的注入。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>(
    <span class="hljs-comment">// 咖啡制造机由 Hilt 注入</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> coffeeMaker: CoffeeMaker
) {

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startMorning</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"Good morning, I need coffee..."</span>)
        coffeeMaker.makeCoffee()
        println(<span class="hljs-string">"The coffee is finished and work is done."</span>)
    }
}
</code></pre>
<p>因为接口没有构造函数，所以 Hilt 并不知道如何创建该接口的实例。</p>
<p>这时，我们可以创建一个抽象类 <code>CoffeeMakerModule</code>，在其中提供该实例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@InstallIn(ActivityComponent::class)</span> <span class="hljs-comment">// 暂时先安装在 ActivityComponent</span>
<span class="hljs-meta">@Module</span> <span class="hljs-comment">// 表示这是一个用来提供依赖注入实例的模块</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CoffeeMakerModule</span> {

    <span class="hljs-meta">@Binds</span>
    <span class="hljs-keyword">abstract</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bindCoffeeMaker</span><span class="hljs-params">(americanoMachine: <span class="hljs-type">AmericanoMachine</span>)</span></span>: CoffeeMaker <span class="hljs-comment">// 给 CoffeeMaker 接口提供实现，提供的实例为 americanoMachine 参数</span>

}
</code></pre>
<p>再告诉 Hilt 美式咖啡机的“制造”方法即可。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AmericanoMachine</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>() : CoffeeMaker {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">makeCoffee</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"Making... Americano"</span>) <span class="hljs-comment">// ☕️</span>
    }
}
</code></pre>
<p>现在 <code>Person</code> 中的 <code>CoffeeMaker</code> 接口对象就能被注入了。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@AndroidEntryPoint</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">ComponentActivity</span>() {
    <span class="hljs-meta">@Inject</span>
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> person: Person

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContent {}

        person.startMorning()
    }
}
</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">Good</span> <span class="hljs-selector-tag">morning</span>, <span class="hljs-selector-tag">I</span> <span class="hljs-selector-tag">need</span> <span class="hljs-selector-tag">coffee</span>...
<span class="hljs-selector-tag">Making</span>... <span class="hljs-selector-tag">Americano</span>
<span class="hljs-selector-tag">The</span> <span class="hljs-selector-tag">coffee</span> <span class="hljs-selector-tag">is</span> <span class="hljs-selector-tag">finished</span> <span class="hljs-selector-tag">and</span> <span class="hljs-selector-tag">work</span> <span class="hljs-selector-tag">is</span> <span class="hljs-selector-tag">done</span>.
</code></pre>
<p>如果现在需要两台咖啡机，一台美式咖啡机，一台拿铁咖啡机，该怎么办？</p>
<p>这时，我们可以使用 <code>@Qualifier</code> 注解，来给相同的类或接口注入不同的实例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 定义两个注解</span>
<span class="hljs-meta">@Qualifier</span>
<span class="hljs-meta">@Retention(AnnotationRetention.BINARY)</span> <span class="hljs-comment">// 注解只能被编译器读取，不能被运行时反射读取</span>
<span class="hljs-keyword">annotation</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BindAmericanoMachine</span>

<span class="hljs-meta">@Qualifier</span>
<span class="hljs-meta">@Retention(AnnotationRetention.BINARY)</span>
<span class="hljs-keyword">annotation</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BindLatteMachine</span>


<span class="hljs-meta">@InstallIn(ActivityComponent::class)</span>
<span class="hljs-meta">@Module</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CoffeeMakerModule</span> {

    <span class="hljs-meta">@Binds</span>
    <span class="hljs-meta">@BindAmericanoMachine</span>
    <span class="hljs-keyword">abstract</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bindCoffeeMaker</span><span class="hljs-params">(americanoMachine: <span class="hljs-type">AmericanoMachine</span>)</span></span>: CoffeeMaker

    <span class="hljs-meta">@Binds</span>
    <span class="hljs-meta">@BindLatteMachine</span>
    <span class="hljs-keyword">abstract</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bindLatteMachine</span><span class="hljs-params">(latteMachine: <span class="hljs-type">LatteMachine</span>)</span></span>: CoffeeMaker

}
</code></pre>
<p>在用到的地方，通过这两个注解来声明当前注入的实例类型：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>() {

    <span class="hljs-meta">@BindAmericanoMachine</span>
    <span class="hljs-meta">@Inject</span>
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> americanoCM: CoffeeMaker

    <span class="hljs-meta">@BindLatteMachine</span>
    <span class="hljs-meta">@Inject</span>
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> latteCM: CoffeeMaker

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startMorning</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"Good morning, I need americano and latte coffee..."</span>)
        americanoCM.makeCoffee()
        latteCM.makeCoffee()
        println(<span class="hljs-string">"The coffee is finished and work is done."</span>)
    }
}
</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">Good</span> <span class="hljs-selector-tag">morning</span>, <span class="hljs-selector-tag">I</span> <span class="hljs-selector-tag">need</span> <span class="hljs-selector-tag">americano</span> <span class="hljs-selector-tag">and</span> <span class="hljs-selector-tag">latte</span> <span class="hljs-selector-tag">coffee</span>...
<span class="hljs-selector-tag">Making</span>... <span class="hljs-selector-tag">Americano</span>
(The milk is frothing...)
<span class="hljs-selector-tag">Making</span>... <span class="hljs-selector-tag">Latte</span>
<span class="hljs-selector-tag">The</span> <span class="hljs-selector-tag">coffee</span> <span class="hljs-selector-tag">is</span> <span class="hljs-selector-tag">finished</span> <span class="hljs-selector-tag">and</span> <span class="hljs-selector-tag">work</span> <span class="hljs-selector-tag">is</span> <span class="hljs-selector-tag">done</span>.
</code></pre>
<h3 data-id="heading-9">第三方库的类</h3>
<p>对于第三方库提供的类，我们无法修改其源码，自然不能在其构造函数上添加 <code>@Inject</code> 注解。</p>
<p>对于这种情况的注入，我们也要使用 <code>@Module</code> 注解。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Module</span>
<span class="hljs-meta">@InstallIn(ActivityComponent::class)</span> <span class="hljs-comment">// 暂时先安装在 ActivityComponent</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkModule</span> {

    <span class="hljs-meta">@Provides</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">provideOkHttpClient</span><span class="hljs-params">()</span></span>: OkHttpClient {
        <span class="hljs-keyword">return</span> OkHttpClient.Builder()
            .connectTimeout(<span class="hljs-number">20</span>, TimeUnit.SECONDS)
            .readTimeout(<span class="hljs-number">20</span>, TimeUnit.SECONDS)
            .writeTimeout(<span class="hljs-number">20</span>, TimeUnit.SECONDS)
            .build()
    }

}
</code></pre>
<blockquote>
<p>引入依赖：<code>implementation("com.squareup.okhttp3:okhttp:4.12.0")</code></p>
</blockquote>
<p>这里没有抽象函数，自然 <code>NetworkModule</code> 不是抽象类。</p>
<p>现在，我们就可以在任何地方注入这个 <code>OkHttpClient</code> 实例了，比如说：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@AndroidEntryPoint</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">ComponentActivity</span>() {
    <span class="hljs-meta">@Inject</span>
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> okHttpClient: OkHttpClient

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContent {}

        <span class="hljs-keyword">val</span> url = <span class="hljs-string">"https://juejin.cn/"</span>
        <span class="hljs-keyword">val</span> request = Request.Builder()
            .url(url)
            .build()
        <span class="hljs-keyword">val</span> call = okHttpClient.newCall(request)

        lifecycleScope.launch(Dispatchers.IO) {
            <span class="hljs-keyword">val</span> response = call.execute()
            println(response.body?.string())
        }
    }
}
</code></pre>
<p>如果遇到需要提供的实例，依赖于其他实例。这和【带参的依赖注入】是一样的，只需将所依赖的实例放到函数参数中，Hilt 会自动去寻找并注入。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Module</span>
<span class="hljs-meta">@InstallIn(ActivityComponent::class)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkModule</span> {
    
    <span class="hljs-comment">// ...</span>

    <span class="hljs-meta">@Provides</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">provideRetrofit</span><span class="hljs-params">(okHttpClient: <span class="hljs-type">OkHttpClient</span>)</span></span>: Retrofit {
        <span class="hljs-keyword">return</span> Retrofit.Builder()
            .baseUrl(<span class="hljs-string">"https://juejin.cn/"</span>)
            .client(okHttpClient)
            .addConverterFactory(GsonConverterFactory.create())
            .build()
    }

    <span class="hljs-meta">@Provides</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">provideApiService</span><span class="hljs-params">(retrofit: <span class="hljs-type">Retrofit</span>)</span></span>: ApiService {
        <span class="hljs-keyword">return</span> retrofit.create(ApiService::<span class="hljs-keyword">class</span>.java)
    }

}
</code></pre>
<blockquote>
<p>添加依赖：<code>implementation("com.squareup.retrofit2:retrofit:2.9.0")</code>、<code>implementation("com.squareup.retrofit2:converter-gson:2.9.0")</code></p>
</blockquote>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApiService</span> {
    <span class="hljs-meta">@GET(<span class="hljs-string">"/"</span>)</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getHomepage</span><span class="hljs-params">()</span></span>: retrofit2.Response&lt;ResponseBody&gt;
}

<span class="hljs-meta">@AndroidEntryPoint</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">ComponentActivity</span>() {

    <span class="hljs-meta">@Inject</span>
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> apiService: ApiService

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContent {}

        lifecycleScope.launch {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">val</span> response = apiService.getHomepage()
                <span class="hljs-keyword">if</span> (response.isSuccessful) {
                    println(response.body()?.string())
                } <span class="hljs-keyword">else</span> {
                    println(<span class="hljs-string">"API request failed:<span class="hljs-subst">${response.code()}</span>"</span>)
                }
            } <span class="hljs-keyword">catch</span> (e: Exception) {
                println(<span class="hljs-string">"Network request exceptions:<span class="hljs-subst">${e.message}</span>"</span>)
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-10">全局单例</h3>
<p>我们都知道 <code>OkHttpClient</code> 内部管理着连接池和线程池，为了复用资源，必须将其作为单例。</p>
<p>对于全局单例，也是在 <code>Module</code> 中进行配置：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Module</span>
<span class="hljs-meta">@InstallIn(SingletonComponent::class)</span> <span class="hljs-comment">// 模块安装到 SingletonComponent 组件</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkModule</span> {

    <span class="hljs-meta">@Provides</span>
    <span class="hljs-meta">@Singleton</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">provideOkHttpClient</span><span class="hljs-params">()</span></span>: OkHttpClient {
        <span class="hljs-keyword">return</span> OkHttpClient.Builder()
            .connectTimeout(<span class="hljs-number">20</span>, TimeUnit.SECONDS)
            .readTimeout(<span class="hljs-number">20</span>, TimeUnit.SECONDS)
            .writeTimeout(<span class="hljs-number">20</span>, TimeUnit.SECONDS)
            .build()
    }

    <span class="hljs-meta">@Provides</span>
    <span class="hljs-meta">@Singleton</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">provideRetrofit</span><span class="hljs-params">(okHttpClient: <span class="hljs-type">OkHttpClient</span>)</span></span>: Retrofit { <span class="hljs-comment">// 为了一致性和效率，Retrofit 也应该为单例</span>
        <span class="hljs-keyword">return</span> Retrofit.Builder()
            .baseUrl(<span class="hljs-string">"https://juejin.cn/"</span>)
            .client(okHttpClient)
            .addConverterFactory(GsonConverterFactory.create())
            .build()
    }

    <span class="hljs-meta">@Provides</span>
    <span class="hljs-meta">@Singleton</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">provideApiService</span><span class="hljs-params">(retrofit: <span class="hljs-type">Retrofit</span>)</span></span>: ApiService { <span class="hljs-comment">// create() 方法开销较高（它需要解析 ApiService 接口的所有注解，并动态创建一个实现该接口的对象），必须为单例</span>
        <span class="hljs-keyword">return</span> retrofit.create(ApiService::<span class="hljs-keyword">class</span>.java)
    }

}
</code></pre>
<h2 data-id="heading-11">核心层级：组件和组件作用域</h2>
<p>我们之前在 <code>@Module</code> 上使用了 <code>@InstallIn</code> 注解，比如 <code>@InstallIn(ActivityComponent::class)</code> 或 <code>@InstallIn(SingletonComponent::class)</code>，它是用于将当前模块安装到对应组件中的。</p>
<p>Hilt 组件（Component）可以理解成一个<strong>容器</strong>，它持有了它能提供的实例（依赖），每个容器都有着自己的生命周期。</p>
<h3 data-id="heading-12">生命周期</h3>
<p>Hilt 组件和作用域注解是严格对应的，两者决定了实例的生命周期：</p>
<blockquote>
<p>在同一个模块中，模块所在的组件和使用的作用域注解不一致，编译会出错。</p>
</blockquote>



































<table><thead><tr><th><strong>生成的组件</strong></th><th><strong>作用域注解</strong></th><th><strong>生命周期</strong></th></tr></thead><tbody><tr><td><code>SingletonComponent</code></td><td><code>@Singleton</code></td><td><strong>App 整个生命周期</strong></td></tr><tr><td><code>ActivityRetainedComponent</code></td><td><code>@ActivityRetainedScoped</code></td><td>跨越配置更改的 <code>Activity</code> 生命周期（<code>ViewModel</code> 依附于此）</td></tr><tr><td><code>ActivityComponent</code></td><td><code>@ActivityScoped</code></td><td><code>Activity</code> 的生命周期（<code>Activity</code> 销毁，它也销毁）</td></tr><tr><td><code>FragmentComponent</code></td><td><code>@FragmentScoped</code></td><td><code>Fragment</code> 的生命周期</td></tr><tr><td><code>ViewModelComponent</code></td><td><code>@ViewModelScoped</code></td><td><code>ViewModel</code> 的生命周期</td></tr></tbody></table>
<p>以 <code>@ActivityScoped</code> 为例，它表示 Hilt 会为每一个新的 Activity 创建一个新的实例。</p>
<p>为什么我们使用 <code>@Singleton</code> 注解来修饰 <code>OkHttpClient</code>，是因为这样 Hilt 才会创建唯一的 <code>OkHttpClient</code> 实例，并且整个应用运行期间，都能复用这个实例。</p>
<p>如果只是安装到了 <code>SingletonComponent</code> 组件，Hilt 默认每次注入时，都会创建新的实例。只有添加了作用域注解，比如 <code>@Singleton</code>，<code>OkHttpClient</code> 实例才会在 <code>SingletonComponent</code> 组件复用同一个实例。</p>
<h3 data-id="heading-13">层级与可见性</h3>
<p>Hilt 的组件之间有着严格的<strong>父子</strong>关系：</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbe8ee8decb84f15bc4e2fe50a9ec8e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo55m9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763546620&amp;x-signature=tQguYgllQGY1%2BdjQOO7sJwTlRIc%3D" alt="Snipaste_2025-11-12_13-49-25.png" width="90%" loading="lazy"/>
<p>一个组件可以访问其所有父组件中的依赖，反之则不行。</p>
<p>作用域注解也可以在注入类上方使用，比如：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Singleton</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>() {

    <span class="hljs-meta">@BindAmericanoMachine</span>
    <span class="hljs-meta">@Inject</span>
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> americanoCM: CoffeeMaker

    <span class="hljs-meta">@BindLatteMachine</span>
    <span class="hljs-meta">@Inject</span>
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> latteCM: CoffeeMaker

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startMorning</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"Good morning, I need americano and latte coffee..."</span>)
        americanoCM.makeCoffee()
        latteCM.makeCoffee()
        println(<span class="hljs-string">"The coffee is finished and work is done."</span>)
    }
}
</code></pre>
<p><code>Person</code> 会自动添加到 <code>SingletonComponent</code> 组件中，并带有 <code>@Singleton</code> 注解。这样，这个 <code>Person</code> 实例会变为全局唯一，且全局可用。</p>
<p>但此时运行程序，Hilt 会直接编译报错。</p>
<p>因为 <code>Person</code> 被 <code>@Singleton</code> 修饰，Hilt 会在 <code>SingletonComponent</code> 中创建并持有这个 <code>Person</code> 实例。它所依赖的 <code>CoffeeMaker</code> 安装到了 <code>ActivityComponent</code> 组件，当 <code>Person</code> 被创建时，<code>SingletonComponent</code>（父）是不可能获取得到 <code>ActivityComponent</code>（儿）中的实例的。</p>
<p>所以，我们应该让 <code>CoffeeMakerModule</code> 是 <code>SingletonComponent</code> 父辈，但 <code>SingletonComponent</code> 已经是最顶层了，所以就只能安装到 <code>SingletonComponent</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@InstallIn(SingletonComponent::class)</span> <span class="hljs-comment">// 必须为 SingletonComponent</span>
<span class="hljs-meta">@Module</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CoffeeMakerModule</span> {

    <span class="hljs-meta">@Binds</span>
    <span class="hljs-meta">@Singleton</span> <span class="hljs-comment">// 最好设为单例</span>
    <span class="hljs-meta">@BindAmericanoMachine</span>
    <span class="hljs-keyword">abstract</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bindCoffeeMaker</span><span class="hljs-params">(americanoMachine: <span class="hljs-type">AmericanoMachine</span>)</span></span>: CoffeeMaker

    <span class="hljs-meta">@Binds</span>
    <span class="hljs-meta">@Singleton</span>
    <span class="hljs-meta">@BindLatteMachine</span>
    <span class="hljs-keyword">abstract</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bindLatteMachine</span><span class="hljs-params">(latteMachine: <span class="hljs-type">LatteMachine</span>)</span></span>: CoffeeMaker

}
</code></pre>
<p>小结一下：</p>
<p><code>@InstallIn</code> 决定了模块被安装到了哪一层，作用域注解决定了实例在该层中是否复用。</p>
<p>要遵循父级不能依赖子级的规则。</p>
<h2 data-id="heading-14">预置 Qualifier</h2>
<p>对于 <code>Context</code> 等系统组件，它们的实例由系统创建。如果要进行依赖注入，就要使用系统提供的 Qualifier（限定符）。</p>
<p>例如 <code>@ApplicationContext</code> 注解可以提供 <code>ApplicationContext</code>。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AmericanoMachine</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>(
    <span class="hljs-meta">@ApplicationContext</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> context: Context
) : CoffeeMaker {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">makeCoffee</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"Making... Americano"</span>) <span class="hljs-comment">// ☕️</span>
        showMessage(<span class="hljs-string">"Americano is ready!"</span>)
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showMessage</span><span class="hljs-params">(text: <span class="hljs-type">String</span>)</span></span> {
        Toast.makeText(context, text, Toast.LENGTH_SHORT).show()
    }
}
</code></pre>
<blockquote>
<p>注意：<code>CoffeeMakerModule</code> 被安装到了 <code>SingletonComponent</code> 中，所以只能注入 <code>@ApplicationContext</code>，不能注入 <code>@ActivityContext</code>。（<code>SingletonComponent</code> 是 <code>ActivityComponent</code> 的父级）</p>
</blockquote>
<p>如果需要 <code>Activity</code> 类型的 <code>Context</code>，就使用 <code>@ActivityContext</code> 注解。但要确保注入它的类是在 <code>ActivityComponent</code> 组件或其子组件。</p>
<p>对于 <code>Application</code> 和 <code>Activity</code> 实例的注入，我们无需使用注解，Hilt 已经预置了注入功能。</p>
<p>但声明这两个类型的子类型，就会编译出错，如果我们需要 <code>MyApplication</code> 实例，就要去手动提供：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Module</span>
<span class="hljs-meta">@InstallIn(SingletonComponent::class)</span>
<span class="hljs-keyword">object</span> ApplicationModule { 

    <span class="hljs-meta">@Provides</span>
    <span class="hljs-meta">@Singleton</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">provideMyApplication</span><span class="hljs-params">(app: <span class="hljs-type">Application</span>)</span></span>: MyApplication {
        <span class="hljs-keyword">return</span> app <span class="hljs-keyword">as</span> MyApplication
    }
    
}
</code></pre>
<p>如果 <code>Module</code> 中只有 <code>@Provides</code>，没有 <code>@Binds</code>，可以改为 <code>object</code>。</p>
<h2 data-id="heading-15">ViewModel 的依赖注入</h2>
<p><code>ViewModel</code> 是一个特殊的 Jetpack 组件，它的生命周期和注入方式由 Hilt 专门管理。我们使用 <code>@HiltViewModel</code> 注解即可：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@HiltViewModel</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyViewModel</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>(<span class="hljs-comment">/*依赖也可以在这里注入*/</span>) : ViewModel() {

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doSomething</span><span class="hljs-params">()</span></span> {
        viewModelScope.launch {
            println(<span class="hljs-string">"MyViewModel: I'm doing something..."</span>)
            delay(<span class="hljs-number">1000</span>)
            println(<span class="hljs-string">"MyViewModel: I'm done!"</span>)
        }
    }
}


<span class="hljs-meta">@AndroidEntryPoint</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">ComponentActivity</span>() {
    <span class="hljs-keyword">val</span> viewModel: MyViewModel <span class="hljs-keyword">by</span> viewModels()

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContent {}
        viewModel.doSomething()
    }
}
</code></pre>
<p><code>ViewModel</code> 的生命周期和 <code>ActivityRetainedComponent</code> 组件一样。</p>
<h3 data-id="heading-16">Compose 集成</h3>
<p>在 Jetpack Compose 中，我们调用 <code>hiltViewModel()</code> Composable 函数来提供一个 <code>ViewModel</code> 实例。</p>
<blockquote>
<p>添加依赖：<code>implementation("androidx.hilt:hilt-navigation-compose:1.2.0")</code></p>
</blockquote>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@AndroidEntryPoint</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">ComponentActivity</span>() {

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContent {
            HelloWorld()
        }
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">HelloWorld</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> viewModel: MyViewModel = hiltViewModel()

    Button(
        onClick = {
            viewModel.doSomething()
        }
    ) {
        Text(text = <span class="hljs-string">"Click me"</span>)
    }
}
</code></pre>
<h3 data-id="heading-17">传递运行时参数：SavedStateHandle 模式</h3>
<p>在真实项目中，<code>ViewModel</code> 在创建时，常常会依赖于一个从 Activity/Fragment 中传入的参数。</p>
<p>这个参数无法由 Hilt 在编译期提供，但和 <code>Navigation</code> 结合使用时，我们可以使用 <code>SavedStateHandle</code> 来完成。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@HiltViewModel</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDetailViewModel</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> apiService: ApiService,           <span class="hljs-comment">// 由 Hilt 注入</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> savedStateHandle: SavedStateHandle  <span class="hljs-comment">// 由 Hilt 自动提供的、包含路由参数的句柄</span>
) : ViewModel() {

    <span class="hljs-comment">// userId 必须和 NavHost 路由中的参数名 detail/{userId} 匹配</span>
    <span class="hljs-keyword">val</span> userId: String = savedStateHandle[<span class="hljs-string">"userId"</span>]!!

    <span class="hljs-keyword">init</span> {
        println(<span class="hljs-string">"UserDetailViewModel created for user: <span class="hljs-variable">$userId</span>"</span>)
        loadUser()
    }

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadUser</span><span class="hljs-params">()</span></span> {
        viewModelScope.launch {
            <span class="hljs-comment">// 使用 apiService 和 userId 加载数据</span>
            println(<span class="hljs-string">"Loading data for <span class="hljs-variable">$userId</span>..."</span>)
        }
    }
}
</code></pre>
<pre><code class="hljs language-KOTLIN" lang="KOTLIN"><span class="hljs-meta">@AndroidEntryPoint</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">ComponentActivity</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContent {
            MyNavHost()
        }
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MyNavHost</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> navController = rememberNavController()
    NavHost(navController = navController, startDestination = <span class="hljs-string">"list"</span>) {

        <span class="hljs-comment">// 列表页</span>
        composable(<span class="hljs-string">"list"</span>) {
            Button(
                onClick = {
                    navController.navigate(<span class="hljs-string">"detail/1"</span>)
                }
            ) {
                Text(<span class="hljs-string">"List 1"</span>)
            }
        }

        <span class="hljs-comment">// 详情页路由</span>
        composable(<span class="hljs-string">"detail/{userId}"</span>) {
            <span class="hljs-comment">// 不需要从 backStackEntry 手动提取 userId</span>

            <span class="hljs-comment">// 直接调用 hiltViewModel()</span>
            <span class="hljs-comment">//    Hilt 会自动获取当前的 NavBackStackEntry，</span>
            <span class="hljs-comment">//    创建 SavedStateHandle，并将其注入 ViewModel。</span>
            <span class="hljs-keyword">val</span> detailViewModel: UserDetailViewModel = hiltViewModel()

            Box(modifier = Modifier.fillMaxSize(), contentAlignment = Alignment.Center) {
                Text(text = <span class="hljs-string">"Detail <span class="hljs-subst">${detailViewModel.userId}</span>"</span>)
            }
        }
    }
}
</code></pre>
<blockquote>
<p>添加依赖：<code>implementation("androidx.navigation:navigation-compose:2.9.6")</code></p>
</blockquote>
<h2 data-id="heading-18">参考</h2>
<p>参考郭霖大神的博客：<a href="https://juejin.cn/post/6902009428633698312#heading-6" target="_blank" title="https://juejin.cn/post/6902009428633698312#heading-6">Jetpack新成员，一篇文章带你玩转Hilt和依赖注入</a></p>
<p>参考 Google 官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Ftraining%2Fdependency-injection%2Fhilt-android%3Fhl%3Dzh-cn%23kotlin" target="_blank" title="https://developer.android.com/training/dependency-injection/hilt-android?hl=zh-cn#kotlin" ref="nofollow noopener noreferrer">使用 Hilt 实现依赖项注入</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何防止重复提交订单？——从踩坑到优雅落地的实战指南]]></title>    <link>https://juejin.cn/post/7571272874846109748</link>    <guid>https://juejin.cn/post/7571272874846109748</guid>    <pubDate>2025-11-11T08:28:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571272874846109748" data-draft-id="7571237750730522658" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何防止重复提交订单？——从踩坑到优雅落地的实战指南"/> <meta itemprop="keywords" content="架构,Java"/> <meta itemprop="datePublished" content="2025-11-11T08:28:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="狼爷"/> <meta itemprop="url" content="https://juejin.cn/user/2418581314208279"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何防止重复提交订单？——从踩坑到优雅落地的实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2418581314208279/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    狼爷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T08:28:15.000Z" title="Tue Nov 11 2025 08:28:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="srcery">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1c1b19;color:#fce8c3}.hljs-emphasis,.hljs-strong{color:#918175}.hljs-bullet,.hljs-link,.hljs-literal,.hljs-number,.hljs-quote,.hljs-regexp{color:#ff5c8f}.hljs-code,.hljs-selector-class{color:#68a8e4}.hljs-emphasis{font-style:italic}.hljs-attribute,.hljs-keyword,.hljs-section,.hljs-selector-tag,.hljs-variable{color:#ef2f27}.hljs-name,.hljs-title{color:#fbb829}.hljs-params,.hljs-type{color:#0aaeb3}.hljs-string{color:#98bc37}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-selector-attr,.hljs-selector-id,.hljs-selector-pseudo,.hljs-subst,.hljs-symbol,.hljs-template-tag,.hljs-template-variable{color:#c07abe}.hljs-comment,.hljs-deletion,.hljs-meta{color:#918175}</style><blockquote>
<p>一次点击，下单成功；两次点击，客服崩溃。<br/>
重复提交订单的问题，几乎每个后端都遇到过。今天咱们就从底层逻辑到实战代码，聊聊这个老生常谈却又暗藏玄机的话题。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">💡 一、背景：为什么会重复提交？</h2>
<p>先说场景。</p>
<p>用户点了一次“立即支付”，发现没反应，再点一次，结果悲剧发生：</p>
<ul>
<li>生成了两笔订单；</li>
<li>扣了两次库存；</li>
<li>财务对账炸了锅。</li>
</ul>
<p>这还只是正常用户，有的还会：</p>
<ul>
<li>前端按钮没禁用，点个爽；</li>
<li>支付网关超时自动重试；</li>
<li>脚本自动刷单接口。</li>
</ul>
<p>于是，后端同学开始加锁、加幂等、加约束，最后一看，代码又胖了一圈。</p>
<hr/>
<h2 data-id="heading-1">🧱 二、常见的防重复提交方案</h2>
<p>其实防重复提交的核心目标就一句话：</p>
<blockquote>
<p><strong>在一定时间内，确保同一个请求只被处理一次。</strong></p>
</blockquote>
<p>从架构层次看，可以分为：</p>



































<table><thead><tr><th>层次</th><th>方案</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>前端层</td><td>按钮防抖 / 禁用</td><td>简单直观</td><td>不可靠，易被跳过</td></tr><tr><td>网关层</td><td>幂等性Key</td><td>通用</td><td>实现复杂</td></tr><tr><td>服务层</td><td>Redis分布式锁</td><td>高性能</td><td>需要良好锁管理</td></tr><tr><td>数据库层</td><td>唯一索引 / 状态判断</td><td>最稳</td><td>执行慢，影响性能</td></tr></tbody></table>
<p>实际生产中，<strong>一般会前后端双保险</strong>：<br/>
👉 前端防抖 + 后端幂等控制。</p>
<hr/>
<h2 data-id="heading-2">🔑 三、服务端防重复提交的常见思路</h2>
<p>来点干货。<br/>
后端层面常用的方案主要有三种。</p>
<hr/>
<h3 data-id="heading-3">✅ 方案一：幂等性 Token 机制（推荐）</h3>
<p><strong>核心逻辑：</strong></p>
<ol>
<li>前端先调用 <code>/token</code> 接口，获取一个随机 <code>token</code>；</li>
<li>请求下单时携带该 token；</li>
<li>后端校验 token 是否已使用；</li>
<li>没用过 → 处理业务并标记“已使用”；<br/>
用过 → 拒绝请求。</li>
</ol>
<p>👉 非常适合「表单类接口」或「下单支付类接口」。</p>
<p><strong>伪流程：</strong></p>
<pre><code class="hljs language-rust" lang="rust">前端请求 token <span class="hljs-punctuation">-&gt;</span> 缓存保存 token <span class="hljs-punctuation">-&gt;</span> 请求接口时携带 token <span class="hljs-punctuation">-&gt;</span> 校验通过一次后删除 token
</code></pre>
<hr/>
<h3 data-id="heading-4">✅ 方案二：Redis 分布式锁机制</h3>
<p>使用 Redis 的 <code>SETNX</code>（或 Redisson）实现业务级互斥锁：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-type">boolean</span> lock = redis.setIfAbsent(<span class="hljs-keyword">key</span>, <span class="hljs-string">"1"</span>, <span class="hljs-number">5</span>, TimeUnit.SECONDS);
<span class="hljs-keyword">if</span> (!lock) {
    <span class="hljs-keyword">throw</span> <span class="hljs-built_in">new</span> BusinessException(<span class="hljs-string">"请勿重复提交"</span>);
}
<span class="hljs-keyword">try</span> {
    createOrder();
} <span class="hljs-keyword">finally</span> {
    redis.delete(<span class="hljs-keyword">key</span>);
}
</code></pre>
<p>比如 key 可设计为：</p>
<pre><code class="hljs language-less" lang="less">lock:<span class="hljs-attribute">order</span>:<span class="hljs-attribute">create</span>:<span class="hljs-attribute">userId</span>:<span class="hljs-number">123</span>
</code></pre>
<p>优点：</p>
<ul>
<li>性能高</li>
<li>实现简单</li>
<li>适合短时间的防重需求</li>
</ul>
<p>缺点：</p>
<ul>
<li>需要注意锁过期与释放问题。</li>
</ul>
<hr/>
<h3 data-id="heading-5">✅ 方案三：数据库层幂等约束</h3>
<p>老实人的方案——数据库唯一索引。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> t_order <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">UNIQUE</span> KEY uk_order_no (order_no);
</code></pre>
<p>或者逻辑判断：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">if</span> (orderRepository.existsByOrderNo(orderNo)) {
    <span class="hljs-built_in">log</span>.info(<span class="hljs-string">"订单重复提交: {}"</span>, orderNo);
    <span class="hljs-keyword">return</span>;
}
</code></pre>
<p>优点：稳如老狗。<br/>
缺点：性能不高，适合作为兜底。</p>
<hr/>
<h2 data-id="heading-6">🧭 四、综合方案流程图</h2>
<p>下面是一个比较推荐的方案：<br/>
<strong>幂等Token + Redis锁 双层防护</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/126e8a2341b4461492d0804cf2582f3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54u854i3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763455349&amp;x-signature=0mW4Ex1axTDpgO3hAHdcDSPwUFo%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-7">💻 五、实战代码（Spring Boot）</h2>
<h3 data-id="heading-8">🧩 1. 获取幂等 Token 接口</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@RestController</span>
<span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">"/api/token"</span>)
public class TokenController {

    <span class="hljs-variable">@Autowired</span>
    private StringRedisTemplate redisTemplate;

    <span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">"/generate"</span>)
    public String <span class="hljs-built_in">generateToken</span>() {
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">token</span> = <span class="hljs-selector-tag">UUID</span><span class="hljs-selector-class">.randomUUID</span>()<span class="hljs-selector-class">.toString</span>();
        <span class="hljs-selector-tag">redisTemplate</span><span class="hljs-selector-class">.opsForValue</span>()<span class="hljs-selector-class">.set</span>(<span class="hljs-string">"token:"</span> + token, <span class="hljs-string">"1"</span>, <span class="hljs-number">10</span>, TimeUnit.MINUTES);
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">token</span>;
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-9">🧩 2. 下单接口（幂等 + Redis锁）</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@RestController</span>
<span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">"/api/order"</span>)
public class OrderController {

    <span class="hljs-variable">@Autowired</span>
    private StringRedisTemplate redisTemplate;

    <span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">"/create"</span>)
    public String <span class="hljs-built_in">createOrder</span>(<span class="hljs-variable">@RequestHeader</span>(<span class="hljs-string">"Idempotency-Token"</span>) String token,
                              <span class="hljs-variable">@RequestBody</span> OrderRequest request) {
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">key</span> = "<span class="hljs-selector-tag">token</span>:" + <span class="hljs-selector-tag">token</span>;

        <span class="hljs-comment">// 校验token是否存在</span>
        <span class="hljs-selector-tag">Boolean</span> <span class="hljs-selector-tag">exists</span> = <span class="hljs-selector-tag">redisTemplate</span><span class="hljs-selector-class">.hasKey</span>(key);
        <span class="hljs-selector-tag">if</span> (Boolean.FALSE.<span class="hljs-built_in">equals</span>(exists)) {
            <span class="hljs-selector-tag">throw</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">BusinessException</span>(<span class="hljs-string">"请勿重复提交"</span>);
        }

        <span class="hljs-comment">// 删除token，确保一次性</span>
        <span class="hljs-selector-tag">redisTemplate</span><span class="hljs-selector-class">.delete</span>(key);

        <span class="hljs-comment">// 加锁防并发</span>
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">lockKey</span> = "<span class="hljs-selector-tag">lock</span>:<span class="hljs-selector-tag">order</span>:<span class="hljs-selector-tag">create</span>:" + <span class="hljs-selector-tag">request</span><span class="hljs-selector-class">.getUserId</span>();
        <span class="hljs-selector-tag">Boolean</span> <span class="hljs-selector-tag">locked</span> = <span class="hljs-selector-tag">redisTemplate</span><span class="hljs-selector-class">.opsForValue</span>()
                <span class="hljs-selector-class">.setIfAbsent</span>(lockKey, <span class="hljs-string">"1"</span>, <span class="hljs-number">5</span>, TimeUnit.SECONDS);

        <span class="hljs-selector-tag">if</span> (Boolean.FALSE.<span class="hljs-built_in">equals</span>(locked)) {
            <span class="hljs-selector-tag">throw</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">BusinessException</span>(<span class="hljs-string">"请勿重复点击"</span>);
        }

        <span class="hljs-selector-tag">try</span> {
            <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 创建订单逻辑</span>
            <span class="hljs-selector-tag">return</span> "下单成功";
        } <span class="hljs-selector-tag">finally</span> {
            <span class="hljs-selector-tag">redisTemplate</span><span class="hljs-selector-class">.delete</span>(lockKey);
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-10">⚙️ 六、最佳实践经验总结</h2>





























<table><thead><tr><th>项目</th><th>建议</th></tr></thead><tbody><tr><td>Token有效期</td><td>建议 5～10 分钟</td></tr><tr><td>锁粒度</td><td>以用户ID 或 业务单号为单位</td></tr><tr><td>幂等Key传递方式</td><td>推荐放在 Header 中，例如 <code>Idempotency-Token</code></td></tr><tr><td>数据库层兜底</td><td>唯一约束防止极端情况</td></tr><tr><td>日志</td><td>建议记录 Token 与锁状态，方便排查</td></tr></tbody></table>
<p>一句话总结：</p>
<blockquote>
<p><strong>Redis防快点，数据库防慢点，前端防乱点。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-11">🧠 七、总结</h2>





























<table><thead><tr><th>层级</th><th>手段</th><th>优点</th><th>备注</th></tr></thead><tbody><tr><td>前端</td><td>按钮防抖</td><td>用户体验好</td><td>仅表层防护</td></tr><tr><td>Redis</td><td>Token + Lock</td><td>性能高</td><td>推荐主力方案</td></tr><tr><td>数据库</td><td>唯一约束</td><td>稳定</td><td>最终兜底</td></tr></tbody></table>
<p>最终结论：</p>
<blockquote>
<p>没有银弹，只有多层防御。<br/>
前端防抖 + 后端幂等 + 数据库约束 = 才是真正的生产级防重复方案。</p>
</blockquote>
<hr/>
<h2 data-id="heading-12">✨ 写在最后</h2>
<p>防重复提交这事，说简单也简单，说复杂也复杂。<br/>
它考验的不是写代码的能力，而是你对<strong>业务一致性</strong>和<strong>系统幂等性</strong>的理解。</p>
<p>下次再有人问你“为什么我点两次下单按钮扣了两次钱”，<br/>
你可以淡定地说一句——</p>
<blockquote>
<p>“兄弟，我们系统现在有幂等锁，不怕你点三次。”</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[硬核安利一个监控告警开源项目Nightingale]]></title>    <link>https://juejin.cn/post/7570975737634734121</link>    <guid>https://juejin.cn/post/7570975737634734121</guid>    <pubDate>2025-11-11T01:37:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570975737634734121" data-draft-id="7570908785294344211" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 硬核安利一个监控告警开源项目Nightingale"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-11T01:37:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="shark_chili"/> <meta itemprop="url" content="https://juejin.cn/user/2858385964801672"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             硬核安利一个监控告警开源项目Nightingale
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2858385964801672/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    shark_chili
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T01:37:21.000Z" title="Tue Nov 11 2025 01:37:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">写在文章开头</h2>
<p>夜莺是笔者近期了解到的一款比较强大的日志监控告警工具，按照官网的说法它可对接多种既有的主流数据源包括但不限于：</p>
<ol>
<li>ClickHouse</li>
<li>elasticsearch</li>
<li>Loki</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ddf650a011c0440b99e44e3f0068eb9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=SpV2AVOQexzTITDaTaarvGWEo2M%3D" alt="" loading="lazy"/></p>
<p>然后我们只需按照夜莺配置模板即可完成监控指标、日志监控告警功能，而本文笔者所着重要介绍的，是这款系统中最强大的日志告警，笔者将通过一个es日志的示例逐步演示并结合源码分析的方式全方位带读者了解夜莺监控的使用和工作机制。</p>
<p>我是 <strong>SharkChili</strong> ，Java 开发者，<strong>Java Guide</strong> 开源项目维护者。欢迎关注我的公众号：<strong>写代码的SharkChili</strong>，也欢迎您了解我的开源项目 mini-redis：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fshark-ctrl%2Fmini-redis" target="_blank" title="https://github.com/shark-ctrl/mini-redis" ref="nofollow noopener noreferrer">github.com/shark-ctrl/…</a>。</p>
<p>为方便与读者交流，现已创建读者群。关注下方公众号获取我的联系方式，添加时备注<strong>加群</strong>即可加入。</p>
<h2 data-id="heading-1">详解Nightingale安装与配置</h2>
<h3 data-id="heading-2">前置准备</h3>
<p>主流的日志采集都是通过<code>skywalking</code>采集日志到<code>elasticsearch</code>，如下架构图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2d03e5254194838846cf29073d6212d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=Cu4gqLKJ9lmaCJIBjsLXF823ucI%3D" alt="" loading="lazy"/></p>
<p>而本文的案例则是通过<code>elasticsearch</code>采集系统程序运行日志，并按照<code>Nightingale</code>协定的规则配置定时采集任务，一旦感知到<code>elasticsearch</code>日志中存在错误日志则发出告警：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13481e5280ad4f74be6aad2caa9525cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=K%2Bmh5MOjkFaiuljj210vYUP7TE8%3D" alt="" loading="lazy"/></p>
<p>为了更好的演示夜莺如何根据采集日志并发出告警，笔者这里也简单介绍一下本文数据源<code>elasticsearch</code>的的配置。本文<code>elasticsearch</code>选用版本为<code>7.12.0</code>，在该版本的es上笔者刷入如下索引，可以看到这款索引很好的模拟了日常采集日志的常见数据：</p>
<ol>
<li>微服务名称</li>
<li>日志消息</li>
<li>日志时间</li>
<li>日志级别</li>
</ol>

<pre><code class="hljs language-vbnet" lang="vbnet">--  创建索引
curl -X PUT <span class="hljs-string">"localhost:9200/java_app_logs"</span> -H <span class="hljs-comment">'Content-Type: application/json' -d'</span>
{
  <span class="hljs-string">"mappings"</span>: {
    <span class="hljs-string">"properties"</span>: {
      <span class="hljs-string">"service_name"</span>: {
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"keyword"</span>
      },
      <span class="hljs-string">"log_message"</span>: {
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>
      },
      <span class="hljs-string">"timestamp"</span>: {
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"date"</span>
      }
    }
  }
}
<span class="hljs-comment">'</span>

-- 添加日志级别
curl -X PUT <span class="hljs-string">"localhost:9200/java_app_logs/_mapping"</span> -H <span class="hljs-comment">'Content-Type: application/json' -d'</span>
{
  <span class="hljs-string">"properties"</span>: {
    <span class="hljs-string">"log_level"</span>: {
      <span class="hljs-string">"type"</span>: <span class="hljs-string">"keyword"</span>
    }
  }
}
<span class="hljs-comment">'</span>
</code></pre>
<p>完成必要的索引创建后，我们就可以按需刷入如下请求建立文档模拟用户登录成功和失败的消息：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">-- 添加日志

curl -X POST <span class="hljs-string">"localhost:9200/java_app_logs/_doc"</span> -H <span class="hljs-comment">'Content-Type: application/json' -d'</span>
{
  <span class="hljs-string">"service_name"</span>: <span class="hljs-string">"user-service"</span>,
  <span class="hljs-string">"log_message"</span>: <span class="hljs-string">"用户登录成功，用户ID: 12345"</span>,
  <span class="hljs-string">"log_level"</span>: <span class="hljs-string">"INFO"</span>,
  <span class="hljs-string">"timestamp"</span>: <span class="hljs-string">"'$(date -u +"</span>%Y-%m-%dT%H:%M:%S.%<span class="hljs-number">3</span>NZ<span class="hljs-string">")'"</span>
}
<span class="hljs-comment">'</span>

-- 登录失败的日志
curl -X POST <span class="hljs-string">"localhost:9200/java_app_logs/_doc"</span> -H <span class="hljs-comment">'Content-Type: application/json' -d'</span>
{
  <span class="hljs-string">"service_name"</span>: <span class="hljs-string">"user-service"</span>,
  <span class="hljs-string">"log_message"</span>: <span class="hljs-string">"用户登录失败，用户名: testuser，原因: 密码错误"</span>,
  <span class="hljs-string">"log_level"</span>: <span class="hljs-string">"ERROR"</span>, 
  <span class="hljs-string">"timestamp"</span>: <span class="hljs-string">"'$(date -u +"</span>%Y-%m-%dT%H:%M:%S.%<span class="hljs-number">3</span>NZ<span class="hljs-string">")'"</span>
}
<span class="hljs-comment">'</span>
</code></pre>
<p>自此，我们就有了一份可进行采集监控的es数据源，就可以开始通过夜莺进行日志监控告警配置了。</p>
<h3 data-id="heading-3">二进制安装</h3>
<p>因为笔者采用<code>Linux</code>服务器部署且采用二进制的方式安装，所以我们需要到<code>github</code>下载最新版本，对应的下载地址为：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fccfos%2Fnightingale%2Freleases" target="_blank" title="https://github.com/ccfos/nightingale/releases" ref="nofollow noopener noreferrer">github.com/ccfos/night…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/901979c6ca2d407ba08876053d080789~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=sOshTaKAV5hhNrUVp05Rd%2FkpVG8%3D" alt="" loading="lazy"/></p>
<p>将下载好的压缩包进行解压：</p>
<pre><code class="hljs">tar zxvf n9e-v8.4.0-linux-amd64.tar.gz
</code></pre>
<p>然后我们直接进入<code>bin</code>目录键入如下指令就可以将夜莺启动了：</p>
<pre><code class="hljs language-bash" lang="bash">./n9e
</code></pre>
<p>随后我们通过<code>17000</code>端口即可访问<code>Nightingale</code>登录界面，默认情况下<code>Nightingale</code>的账户和密码分别是：</p>
<pre><code class="hljs">账户：root
密码：root.2020
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1a5c0c1062a49ac8a6d4b244d261427~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=GnewQh4wcTd9p7vSCHTV75KbXM8%3D" alt="" loading="lazy"/></p>
<p>明确可以正常启动，读者可以使用如下指令以后台的方式启动：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> /opt/n9e &amp;&amp; <span class="hljs-built_in">nohup</span> ./n9e &amp;&gt; n9e.log &amp;
</code></pre>
<h3 data-id="heading-4">数据源配置</h3>
<p>登录管理界面之后，就可以将es数据源引入进行监控告警管理了，通过集成中心定位到数据源，点击进入数据源配置界面：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a65fbde4b4f84f60b94e86102c128eb3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=wgnIhmKGRazEGaysISlkxo11ZiA%3D" alt="" loading="lazy"/></p>
<p>随后点击新增并选择<code>ElasticSearch</code>数据源：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e5d955efb2641c4867a43f9a2a1c369~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=aA04us1vk046TsC%2Bcrt8vqKzNfY%3D" alt="" loading="lazy"/></p>
<p>根据提示依次配置：</p>
<ol>
<li>数据源名称</li>
<li>访问地址</li>
<li>版本信息</li>
</ol>
<p>明确无误后，点击测试连通性并保存：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1013a67d5e08429bb7dc401afc5b6164~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=IJoN5zGRy%2BK3otPVomHkNWDA3W4%3D" alt="" loading="lazy"/></p>
<p>如下图所示，这样就说明数据源添加成功了，自此我们的<code>Nightingale</code>就可以针对日志数据源进行监控告警规则配置了：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e820df428054323ae4c19a558c969f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=R74t5D2GGjc57dA0IPRw1VcfEUw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">日志查询</h3>
<p>为了明确我们<code>es</code>写入的日志能够被准确的查询到，我们可以先通过<code>Nightingale</code>的日志页面针对针对该数据源进行日志查询，以笔者为例，对应的配置为：</p>
<ol>
<li>数据源选择<code>elasticsearch</code>数据源</li>
<li>选择索引模式即<code>indices</code></li>
<li>索引使用<code>java_app_logs</code></li>
<li>日志过滤条件为日志级别为错误级别的即<code>log_level:"ERROR"</code></li>
</ol>
<p>对应的配置和输出结果如下，由此可确定笔者的配置没有任何问题：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/461f89a59a9c49328129b5151853ec49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=DxrD0LdHyS8US9vhAgxNlBKHhXY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">告警规则配置与调测</h3>
<p>重头戏来了，明确错误日志查询无误后，我们就可以按照我们上述的调测针对<code>error</code>级别的日志配置相应告警规则了，按照我们需求的说法，即一旦查询到错误级别的日志超过1条则直接发出告警，我们可以到告警面板选择规则管理配置监控告警，以笔者为例首先指明规则为错误日志监控告警：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/188496dc29dc40eba07680ab06fa779d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=l%2FHe7I4NTqROQ2sZareQFoE24y8%3D" alt="" loading="lazy"/></p>
<p>针对规则配置，相应配置为：</p>
<ol>
<li>选择数据源类型为<code>elasticsearch</code>数据源</li>
<li>选择精确匹配指定数据源为我们的<code>elasticsearch</code>数据源</li>
<li>查询统计项指明索引为<code>java_app_logs</code>且过滤条件为过滤出错误类型日志<code>log_level:"ERROR"</code></li>
<li>时间间隔设置为<code>30min</code>以内的数据 <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5da9b48558b547d88f5aa19940b9d3bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=tjTDnQ78owQv0klpaeh%2FdunpZas%3D" alt="" loading="lazy"/></li>
</ol>
<p>明确这个时间后，我们可以在es上刷几条错误日志看看规则配置是否可以正确执行：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">curl -X POST <span class="hljs-string">"localhost:9200/java_app_logs/_doc"</span> -H <span class="hljs-comment">'Content-Type: application/json' -d'</span>
{
  <span class="hljs-string">"service_name"</span>: <span class="hljs-string">"user-service"</span>,
  <span class="hljs-string">"log_message"</span>: <span class="hljs-string">"用户登录失败，用户名: testuser，原因: 密码错误"</span>,
  <span class="hljs-string">"log_level"</span>: <span class="hljs-string">"ERROR"</span>, 
  <span class="hljs-string">"timestamp"</span>: <span class="hljs-string">"'$(date -u +"</span>%Y-%m-%dT%H:%M:%S.%<span class="hljs-number">3</span>NZ<span class="hljs-string">")'"</span>
}
<span class="hljs-comment">'</span>
</code></pre>
<p>可以看到通过表达式我们拿到了30条数据，说明这个规则配置没有问题： <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/608370c39cb24359bd8bb746bc355934~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=lbAfls2RsucfFaoZWIBsX%2BDqCwU%3D" alt="" loading="lazy"/></p>
<p>针对阈值判断，笔者指定规则为上述规则大于1也就是错误日志大于0条则触发告警，对应这个监控频率为<code>1min</code>一次，持续时长设置为0即代表只要出现一次直接告警。</p>
<p>这里我们也补充说明一下持续时长的概念，按照官网的说法持续时长即代表该规则为真时且持续配置的时间后才触发告警，例如我们1min执行一次，持续时长配置为120s即代表定时任务两次采集都收到错误级别日志大于1才触发告警。</p>
<p>当然笔者这里也是出于简单，直接配置为0：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dff99a88132a4c5aa517874ff266129d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=OQKlhkCkc%2FyI37q4Mbx2e2JmOKk%3D" alt="" loading="lazy"/></p>
<p>其他配置全部默认保存即可。</p>
<h3 data-id="heading-7">告警验收</h3>
<p>此时，一旦触发告警我们就可以在告警事件上看到事件，因为夜莺默认情况下都会将事件存储在缓存中，基于这种设计理念我们可以将实时告警在夜莺平台上对接各种方式通知用户：</p>
<ol>
<li>企业微信</li>
<li>阿里云短信</li>
<li>邮件</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7af8f962ced140c493573eb79644dac5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=R59vyeB4ggQBlIaciz%2F%2FS%2Fr2Q%2BA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">基于源码详解夜莺工作机制</h2>
<h3 data-id="heading-9">日志告警预览查询原理</h3>
<p>通过上述的实践，我们基本了解了夜莺的基本使用方式，为了更好的帮助读者理解夜莺这个开源告警的工作原理，笔者也将<code>Nightingale</code>的源码克隆到本地针对几个比较核心的部分进入深入的拆解分析。</p>
<p>首先我们先来说说数据预览这一块，因为<code>Nightingale</code>的数值提取针对支持对es日志进行<code>count</code>、max、min等多种日志数据收敛提取方式，然后通过数据源预览即可得到查询结果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/498c1955f1014d8a8d1c22f799944f6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=lKfWwkuLRBP0rb3EAkQCPHlm7%2Fs%3D" alt="" loading="lazy"/></p>
<p>通过浏览器控台，笔者定位到对应的请求映射为<code>http://127.0.0.1:17000/api/n9e/ds-query</code>，同时我们也可以看到请求参数，如下所示，这里笔者也针对说明一下如下几个参数的含义：</p>
<ol>
<li><code>cate</code>：指明数据源类型为<code>elasticsearch</code></li>
<li><code>datasource_id</code>：规则配置使用的数据源为id为1，也就是我们首次配置的<code>elasticsearch</code>数据源</li>
<li><code>query</code>：这个<code>json</code>块比较重要，它说明我们配置的规则名为A，索引类型<code>index_type</code>为索引类型而非索引匹配模式，然后<code>index</code>指明为<code>java_app_logs</code>，然后就是kql配置规则和提取方式为<code>count</code></li>
<li><code>date_field</code>：指明采集的时间字段用索引中的<code>timestamp</code></li>
</ol>
<p>其他参数则是轮询间隔和基于这个间隔生成的起止时间：</p>
<pre><code class="hljs language-python" lang="python">{
  <span class="hljs-string">"cate"</span>: <span class="hljs-string">"elasticsearch"</span>,
  <span class="hljs-string">"datasource_id"</span>: <span class="hljs-number">1</span>,
  <span class="hljs-string">"query"</span>: [
    {
      <span class="hljs-string">"ref"</span>: <span class="hljs-string">"A"</span>,
      <span class="hljs-string">"index_type"</span>: <span class="hljs-string">"index"</span>,
      <span class="hljs-string">"index"</span>: <span class="hljs-string">"java_app_logs"</span>,
      <span class="hljs-string">"filter"</span>: <span class="hljs-string">"log_level:"</span>ERRO<span class="hljs-string">R""</span>,
      <span class="hljs-string">"value"</span>: {
        <span class="hljs-string">"func"</span>: <span class="hljs-string">"count"</span>
      },
      <span class="hljs-string">"date_field"</span>: <span class="hljs-string">"timestamp"</span>,
      <span class="hljs-string">"interval"</span>: <span class="hljs-number">1800</span>,
      <span class="hljs-string">"start"</span>: <span class="hljs-number">1762532762</span>,
      <span class="hljs-string">"end"</span>: <span class="hljs-number">1762534562</span>
    }
  ]
}
</code></pre>
<p>返回结果如下，通过整体结构我们可以看出，对应A规则的在<code>1762531200</code>即<code>2025年11月8日</code> <code>00:00:00</code>查出<code>count</code>为<code>22</code>：</p>
<pre><code class="hljs language-python" lang="python">{
    <span class="hljs-string">"dat"</span>: [
        {
            <span class="hljs-string">"ref"</span>: <span class="hljs-string">"A"</span>,
            <span class="hljs-string">"metric"</span>: {
                <span class="hljs-string">"__name__"</span>: <span class="hljs-string">"A__count"</span>
            },
            <span class="hljs-string">"values"</span>: [
                [
                    <span class="hljs-number">1762531200</span>,
                    <span class="hljs-number">22</span>
                ]
            ],
            <span class="hljs-string">"query"</span>: <span class="hljs-string">"map[date_field:timestamp end:1.762534562e+09 filter:log_level:"</span>ERRO<span class="hljs-string">R" index:java_app_logs index_type:index interval:1800 ref:A start:1.762532762e+09 value:map[func:count]]"</span>
        }
    ],
    <span class="hljs-string">"err"</span>: <span class="hljs-string">""</span>
}
</code></pre>
<p>明确这个接口出参和入参之后，我们就可以针对该接口进行深入分析了，本质上Nightingale数值提取查询就是通过上述请求参数生成es的restful请求参数，并通过返回结果中的聚合通提取到规则对应的count、max、min等信息然后返回给用户：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f774d648bf544d1583cbee80e2292d28~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=c9zOO%2FSipiGA1wt48GZXfywF%2B4Y%3D" alt="" loading="lazy"/></p>
<p>对应的我们可以在<code>router.go</code>文件中看到这个请求的入口，可以看到该请求映射本质上都是通过<code>QueryData</code>这个函数处理的：</p>
<pre><code class="hljs language-arduino" lang="arduino">  <span class="hljs-comment">//告警规则配置请求入口</span>
   pages.<span class="hljs-built_in">POST</span>(<span class="hljs-string">"/ds-query"</span>, rt.QueryData)
</code></pre>
<p>步入QueryData，即可看到如下几个步骤：</p>
<ol>
<li>将请求参数绑定到变量f这个<code>QueryParam</code>结构体上，本质上就是将上述的入参进行一个一一对应的封装</li>
<li>通过QueryDataConcurrently发起es查询请求</li>
<li>将查询结果返回</li>
</ol>

<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rt *Router)</span></span> QueryData(c *gin.Context) {
 
 <span class="hljs-keyword">var</span> f models.QueryParam
 <span class="hljs-comment">//解析绑定参数</span>
 ginx.BindJSON(c, &amp;f)
 <span class="hljs-comment">//发起es restful请求然后返回结果resp</span>
 resp, err := QueryDataConcurrently(rt.Center.AnonymousAccess.PromQuerier, c, f)
 
 <span class="hljs-comment">//......</span>
 <span class="hljs-comment">//将结果返回给用户</span>
 ginx.NewRender(c).Data(resp, <span class="hljs-literal">nil</span>)
}
</code></pre>
<p>而QueryDataConcurrently内部逻辑也比较简单，因为我们的http请求入参中的query是个数组，所以该函数会拿到QueryParam中的query数组进行遍历，生成一个个协程发起请求并通过倒计时门栓阻塞等待，当所有请求结果写入切片后，直接将切片resp返回：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72848a1320524cba818ca1301f835e6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=L16dUTl3ldV%2Bfc%2BqI%2FFraC1iEGw%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">QueryDataConcurrently</span><span class="hljs-params">(anonymousAccess <span class="hljs-type">bool</span>, ctx *gin.Context, f models.QueryParam)</span></span> ([]models.DataResp, <span class="hljs-type">error</span>) {
 <span class="hljs-comment">//声明一个结果切片</span>
 <span class="hljs-keyword">var</span> resp []models.DataResp
 <span class="hljs-comment">//......</span>
 <span class="hljs-keyword">for</span> _, q := <span class="hljs-keyword">range</span> f.Querys {
  <span class="hljs-comment">//......</span>

 
  <span class="hljs-comment">//针对查询请求添加一个倒计时门栓</span>
  wg.Add(<span class="hljs-number">1</span>)
  <span class="hljs-comment">//起个协程发起es查询</span>
  <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(query <span class="hljs-keyword">interface</span>{})</span></span> {
   <span class="hljs-keyword">defer</span> wg.Done()
   <span class="hljs-comment">//执行查询,实际调用es的地方,将数组内部的query参数传入</span>
   datas, err := plug.QueryData(ctx.Request.Context(), query)
   <span class="hljs-comment">//......</span>

  
   <span class="hljs-comment">//将结果写入resp这个切片中</span>
   resp = <span class="hljs-built_in">append</span>(resp, datas...)
   mu.Unlock()
  }(q)
 }
 <span class="hljs-comment">//等待所有协程查询结束</span>
 wg.Wait()

 <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(errs) &gt; <span class="hljs-number">0</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errs[<span class="hljs-number">0</span>]
 }

 <span class="hljs-comment">//......</span>
 <span class="hljs-comment">//返回执行结果的切片</span>
 <span class="hljs-keyword">return</span> resp, <span class="hljs-literal">nil</span>
}
</code></pre>
<p>通过上述源码可以看到每一个协程都是通过<code>plug.QueryData(ctx.Request.Context(), query)</code>发起es请求的，实际上这段逻辑都是在eslike.go上完成的，对应的执行步骤为就是：</p>
<ol>
<li>基于filter生成es的must表达式</li>
<li>基于timestamp和interval生成range查询</li>
<li>基于1、2构建一个bool查询</li>
<li>通过参数value指明的count聚合，构建出一个桶聚合，指明不同时间区间的符合要求的文档数</li>
</ol>
<p>对应的参数解析映射如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/369206d6bde74b4ab39b83ed592b99ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=ClaDwzcYEMWS163yAMB3kGLged0%3D" alt="" loading="lazy"/> 最后es会返回类似如下的一个结构体，Nightingale就会拿出这个doc_count作为结果封装返回：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"aggregations"</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"ts"</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"buckets"</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"key_as_string"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-11-05T14:30:00.000Z"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"key"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1762353000000</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"doc_count"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">10</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
</code></pre>
<p>对应的逻辑参见如下eslike.go的QueryData，和上述说明一致，读者可结合注释阅读理解：</p>
<pre><code class="hljs language-python" lang="python">func QueryData(ctx context.Context, queryParam interface{}, cliTimeout int64, version string, search SearchFunc) ([]models.DataResp, error) {
 //......
 //生成<span class="hljs-built_in">range</span>对象,结构体类似于
 /**
 <span class="hljs-built_in">range</span><span class="hljs-string">": {
           "</span>timestamp<span class="hljs-string">": {
             "</span><span class="hljs-built_in">format</span><span class="hljs-string">": "</span>epoch_millis<span class="hljs-string">",
             "</span><span class="hljs-keyword">from</span><span class="hljs-string">": 1762353000000,
             "</span>include_lowe<span class="hljs-string">r": true,
             "</span>include_uppe<span class="hljs-string">r": true,
             "</span>to<span class="hljs-string">": 1762353600000
           }
         }
 */
 q := elastic.NewRangeQuery(param.DateField)
 //......
 //生成时间范围并给出返回对应的时间单位
 q.Gte(time.Unix(start, 0).UnixMilli())
 q.Lte(time.Unix(end, 0).UnixMilli())
 q.Format("</span>epoch_millis<span class="hljs-string">")

  //......
 //生成bool查询并基于fiter构建出must子句,传入q即将range查询存入filter子句中
 /**
 "</span>query<span class="hljs-string">": {
     "</span><span class="hljs-built_in">bool</span><span class="hljs-string">": {
       "</span>filte<span class="hljs-string">r": {
         "</span><span class="hljs-built_in">range</span><span class="hljs-string">": {
           "</span>timestamp<span class="hljs-string">": {
             "</span><span class="hljs-built_in">format</span><span class="hljs-string">": "</span>epoch_millis<span class="hljs-string">",
             "</span><span class="hljs-keyword">from</span><span class="hljs-string">": 1762353000000,
             "</span>include_lowe<span class="hljs-string">r": true,
             "</span>include_uppe<span class="hljs-string">r": true,
             "</span>to<span class="hljs-string">": 1762353600000
           }
         }
       },
       "</span>must<span class="hljs-string">": {
         "</span>query_string<span class="hljs-string">": {
           "</span>query<span class="hljs-string">": "</span>log_level:<span class="hljs-string">"ERROR"</span><span class="hljs-string">"
         }
       }
     }
   }
  */
 queryString := GetQueryString(param.Filter, q)

 var aggr elastic.Aggregation
 switch param.MetricAggr.Func {
 case "</span>avg<span class="hljs-string">":
  aggr = elastic.NewAvgAggregation().Field(field)
 //......
  aggr = elastic.NewSumAggregation().Field(field)
 case "</span>count<span class="hljs-string">":
  
  aggr = elastic.NewValueCountAggregation().Field(field)
//......
 default:
  return nil, fmt.Errorf("</span>func %s <span class="hljs-keyword">not</span> support<span class="hljs-string">", param.MetricAggr.Func)
 }
 //生成聚合桶查询,每个桶至少要有一个文档,少了就不显示
 tsAggr := elastic.NewDateHistogramAggregation().
  Field(param.DateField).
  MinDocCount(1)

 //......
 //构建查询参数
 searchSource := elastic.NewSearchSource().
  Query(queryString).
  Aggregation("</span>ts<span class="hljs-string">", tsAggr) //设置自定义聚合名称为ts
 //......
 //发起请求
 result, err := search(ctx, indexArr, searchSource, param.Timeout, param.MaxShard)
 //......
 /** 提取ts中的bucket桶提取count和key也就是时间生成item返回
 "</span>aggregations<span class="hljs-string">" : {
     "</span>ts<span class="hljs-string">" : {
       "</span>buckets<span class="hljs-string">" : [
         {
           "</span>key_as_string<span class="hljs-string">" : "</span><span class="hljs-number">2025</span>-<span class="hljs-number">11</span>-05T14:<span class="hljs-number">30</span>:<span class="hljs-number">00.000</span>Z<span class="hljs-string">",
           "</span>key<span class="hljs-string">" : 1762353000000,
           "</span>doc_count<span class="hljs-string">" : 10
         }
       ]
     }
   }
  */
 js, err := simplejson.NewJson(result.Aggregations["</span>ts<span class="hljs-string">"])
 //......
 bucketsData, err := js.Get("</span>buckets<span class="hljs-string">").Array()
 return items, nil
}
</span></code></pre>
<h3 data-id="heading-10">告警规则添加</h3>
<p>了解了规则配置解析之后，我们再来了解后续步骤，即如何将规则持久化到<code>Nightingale</code>底层的数据库中，让告警监控的工作协程能够获取到这个规则进行定时查询和告警消息缓存。</p>
<p>对应的我们通过浏览器控台定位到接口映射为<code>http://127.0.0.1:17000/api/n9e/busi-group/1/alert-rules</code>，请求参数为一个比较大的<code>JSON</code>数组，为了更好的说明和解析，这里笔者也给出几个比较核心的部分以便于读者更准确的理解规则的存储过程。</p>
<p>先来看看参数的第一部分，可以看到这个规则通过cate即category指明数据源类型为elasticsearch，并通过datasource这个数组块指明等价匹配数据源-1也就是elasticsearch</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"cate"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"elasticsearch"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"datasource_queries"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"match_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">//精确匹配</span>
    <span class="hljs-attr">"op"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"in"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">//包含关系</span>
    <span class="hljs-attr">"values"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-number">1</span> <span class="hljs-comment">//数据源1也就是我们配置的elasticsearch</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
</code></pre>
<p>然后就是规则配置，对应的<code>rule_config</code>的<code>JSON</code>参数如下，这里笔者抽出核心的两个部分，第一个部分也就是上面规则查询的参数，对应的明细笔者上文已经详细解释过了，这里就不多做赘述，这里我们着重说明一下trigger，其内部有个expressions结合3个参数语义和浏览器界面即知晓这个就是触发条件的配置，他告知<code>Nightingale</code>在查询<code>count</code>大于0的时候即可触发告警：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"rule_config"</span>: {
    <span class="hljs-string">"queries"</span>: [{ //查询条件参数
      <span class="hljs-string">"prom_ql"</span>: <span class="hljs-string">""</span>,
      <span class="hljs-string">"severity"</span>: <span class="hljs-number">2</span>,
      <span class="hljs-string">"ref"</span>: <span class="hljs-string">"A"</span>,
      <span class="hljs-string">"index_type"</span>: <span class="hljs-string">"index"</span>,
      <span class="hljs-string">"value"</span>: {
        <span class="hljs-string">"func"</span>: <span class="hljs-string">"count"</span>
      },
      <span class="hljs-string">"unit"</span>: <span class="hljs-string">"none"</span>,
      <span class="hljs-string">"index"</span>: <span class="hljs-string">"java_app_logs"</span>,
      <span class="hljs-string">"date_field"</span>: <span class="hljs-string">"timestamp"</span>,
      <span class="hljs-string">"filter"</span>: <span class="hljs-string">"log_level:"</span>ERRO<span class="hljs-string">R""</span>,
      <span class="hljs-string">"interval"</span>: <span class="hljs-number">1800</span>
    }],
   //.......
    <span class="hljs-string">"triggers"</span>: [{
      <span class="hljs-string">"mode"</span>: <span class="hljs-number">0</span>,
      <span class="hljs-string">"expressions"</span>: [{ //当规则A查出来的值大于<span class="hljs-number">0</span>时触发告警
        <span class="hljs-string">"ref"</span>: <span class="hljs-string">"A"</span>,
        <span class="hljs-string">"comparisonOperator"</span>: <span class="hljs-string">"&gt;"</span>,
        <span class="hljs-string">"value"</span>: <span class="hljs-number">0</span>,
        <span class="hljs-string">"logicalOperator"</span>: <span class="hljs-string">"&amp;&amp;"</span>
      }],
      <span class="hljs-string">"severity"</span>: <span class="hljs-number">1</span>, //一级告警
      <span class="hljs-string">"recover_config"</span>: {
        <span class="hljs-string">"judge_type"</span>: <span class="hljs-number">0</span>
      },
      <span class="hljs-string">"join_ref"</span>: <span class="hljs-string">"A"</span>,
      <span class="hljs-string">"exp"</span>: <span class="hljs-string">"$A &gt; 0"</span>
    }],
    //.......
  },
</code></pre>
<p>最后一个部分也就是规则配置的调度算法，对应参数如下：</p>
<ol>
<li><code>cron_pattern</code>指明每15s执行一次</li>
<li><code>prom_for_duration</code>：持续时间为60s也就是4次调度都触发告警与之则告警</li>
<li><code>enable_days_of_weeks</code>:执行周期为一整周即周一到周日都有</li>
<li><code>enable_stimes</code>: 开始时间</li>
<li><code>enable_etimes</code>：结束时间</li>
</ol>

<pre><code class="hljs language-perl" lang="perl"> <span class="hljs-string">"cron_pattern"</span>: <span class="hljs-string">"@every 15s"</span>,
  <span class="hljs-string">"prom_for_duration"</span>: <span class="hljs-number">60</span>,
  <span class="hljs-string">"enable_days_of_weeks"</span>: [
    [
      <span class="hljs-string">"0"</span>,
      <span class="hljs-string">"1"</span>,
      <span class="hljs-string">"2"</span>,
      <span class="hljs-string">"3"</span>,
      <span class="hljs-string">"4"</span>,
      <span class="hljs-string">"5"</span>,
      <span class="hljs-string">"6"</span>
    ]
  ],
  <span class="hljs-string">"enable_stimes"</span>: [
    <span class="hljs-string">"00:00"</span>
  ],
  <span class="hljs-string">"enable_etimes"</span>: [
    <span class="hljs-string">"00:00"</span>
  ],
</code></pre>
<p>明确参数后，我们通过接口映射定位到后端的执行函数，也就是<code>alertRuleAddByFE</code>方法，这里笔者也贴出接口对应的映射配置和实际执行函数，保存规则的逻辑比较简单，即：</p>
<ol>
<li>解析参数并判空</li>
<li>调用<code>alertRuleAdd</code>保存规则</li>
<li>返回执行结果</li>
</ol>

<pre><code class="hljs language-go" lang="go">pages.POST(<span class="hljs-string">"/busi-group/:id/alert-rules"</span>, rt.auth(), rt.user(), rt.perm(<span class="hljs-string">"/alert-rules/add"</span>), rt.bgrw(), rt.alertRuleAddByFE)


<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rt *Router)</span></span> alertRuleAddByFE(c *gin.Context) {
 username := c.MustGet(<span class="hljs-string">"username"</span>).(<span class="hljs-type">string</span>)

 <span class="hljs-keyword">var</span> lst []models.AlertRule
 <span class="hljs-comment">//解析参数列表存储到lst这个规则结构体中</span>
 ginx.BindJSON(c, &amp;lst)
 <span class="hljs-comment">//如果参数为空直接返回异常</span>
 count := <span class="hljs-built_in">len</span>(lst)
 <span class="hljs-keyword">if</span> count == <span class="hljs-number">0</span> {
  ginx.Bomb(http.StatusBadRequest, <span class="hljs-string">"input json is empty"</span>)
 }

 bgid := ginx.UrlParamInt64(c, <span class="hljs-string">"id"</span>) <span class="hljs-comment">//获取对应group id</span>
 <span class="hljs-comment">//调用alertRuleAdd保存规则</span>
 reterr := rt.alertRuleAdd(lst, username, bgid, c.GetHeader(<span class="hljs-string">"X-Language"</span>))
 <span class="hljs-comment">//将结果渲染返回</span>
 ginx.NewRender(c).Data(reterr, <span class="hljs-literal">nil</span>)
}
</code></pre>
<p>宏观的了解整个流程之后，我们还是需要深入细节了解<code>alertRuleAdd</code>实现细节，其实这段逻辑和我们java开发日常的crud接口都差不多，本质上就是将参数绑定到go语言的dto上保存到数据库(默认为sqllite)，对应的映射转换细节如下：</p>
<ol>
<li>EnableStime和EnableEtime作为任务起止时间直接平迁</li>
<li>执行周期转为空格分隔</li>
<li>核心的告警规则查询条件和调度时间配置json即rule config直接序列化为JSON写入</li>
</ol>
<p>几个核心转换过程笔者也已图解的方式展示了一下，读者结合说明了解一下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/263142cd75f947a29278b82ebf34ddcb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=cfCHrNPIXBXvmvLcZy4sq3d%2B2VI%3D" alt="" loading="lazy"/></p>
<p>对应笔者也给出<code>router_alert_rule.go</code>中<code>alertRuleAdd</code>的实现，可以看到如下步骤：</p>
<ol>
<li>这个函数内部设置了<code>alertRule</code>对象的<code>CreateBy</code>和<code>UpdateBy</code></li>
<li>调用<code>FE2DB</code>生执行前端参数转为上图所示的数据结构</li>
<li>然后<code>AlertRule</code>调用<code>Add</code>写入<code>db</code>中，很明显这种设计让<code>AlertRule</code>具备持久化的能力，是一种具备充血模型的设计理念</li>
</ol>

<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rt *Router)</span></span> alertRuleAdd(lst []models.AlertRule, username <span class="hljs-type">string</span>, bgid <span class="hljs-type">int64</span>, lang <span class="hljs-type">string</span>) <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span> {
 count := <span class="hljs-built_in">len</span>(lst) <span class="hljs-comment">//获取对应的规则切片长度</span>
 <span class="hljs-comment">// alert rule name -&gt; error string</span>
 reterr := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>)
 <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; count; i++ {
  lst[i].Id = <span class="hljs-number">0</span> <span class="hljs-comment">//设置规则id和配置用户名信息</span>
  lst[i].GroupId = bgid
  <span class="hljs-keyword">if</span> username != <span class="hljs-string">""</span> {
   lst[i].CreateBy = username <span class="hljs-comment">//绑定创建人username也就是root</span>
   lst[i].UpdateBy = username <span class="hljs-comment">//绑定修改人username也就是root</span>
  }
  <span class="hljs-comment">//价格lst转为封装db字段信息,例如起止时间 执行规则配置等信息,如果某条报错直接结束循环</span>
  <span class="hljs-keyword">if</span> err := lst[i].FE2DB(); err != <span class="hljs-literal">nil</span> {
   reterr[lst[i].Name] = i18n.Sprintf(lang, err.Error())
   <span class="hljs-keyword">continue</span>
  }
  <span class="hljs-comment">//存入数据库,返回写入结果</span>
  <span class="hljs-keyword">if</span> err := lst[i].Add(rt.Ctx); err != <span class="hljs-literal">nil</span> {
   reterr[lst[i].Name] = i18n.Sprintf(lang, err.Error())
  } <span class="hljs-keyword">else</span> {
   reterr[lst[i].Name] = <span class="hljs-string">""</span>
  }
 }
 <span class="hljs-keyword">return</span> reterr
}
</code></pre>
<p>结合上述的整体说明笔者也给出FE2DB的函数实现细节，大体就是上图所示的映射转换，读者可结合注释回顾一下：</p>
<pre><code class="hljs language-perl" lang="perl">func (ar *AlertRule) FE2DB() error {
 <span class="hljs-regexp">//</span>如果起止时间存在则将起止时间设置到调用的ar上,也就是我们配置的enable_stimes和enable_etimes
 <span class="hljs-keyword">if</span> len(ar.EnableStimesJSON) &gt; <span class="hljs-number">0</span> {
  ar.EnableStime = strings.Join(ar.EnableStimesJSON, <span class="hljs-string">" "</span>)
  ar.EnableEtime = strings.Join(ar.EnableEtimesJSON, <span class="hljs-string">" "</span>)
 } <span class="hljs-keyword">else</span> {
  ar.EnableStime = ar.EnableStimeJSON
  ar.EnableEtime = ar.EnableEtimeJSON
 }
 //按照空格设置启用的星期,按照空格进行拼接,对应参数为 <span class="hljs-string">"enable_days_of_weeks"</span>: [
 <span class="hljs-regexp">//</span>      [
 <span class="hljs-regexp">//</span>        <span class="hljs-string">"0"</span>,
 <span class="hljs-regexp">//</span>        <span class="hljs-string">"1"</span>,
 <span class="hljs-regexp">//</span>        <span class="hljs-string">"2"</span>,
 <span class="hljs-regexp">//</span>        <span class="hljs-string">"3"</span>,
 <span class="hljs-regexp">//</span>        <span class="hljs-string">"4"</span>,
 <span class="hljs-regexp">//</span>        <span class="hljs-string">"5"</span>,
 <span class="hljs-regexp">//</span>        <span class="hljs-string">"6"</span>
 //      ]
 //    ],
 <span class="hljs-keyword">if</span> len(ar.EnableDaysOfWeeksJSON) &gt; <span class="hljs-number">0</span> {
  <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; len(ar.EnableDaysOfWeeksJSON); i++ {
   <span class="hljs-keyword">if</span> len(ar.EnableDaysOfWeeksJSON) == <span class="hljs-number">1</span> {
    ar.EnableDaysOfWeek = strings.Join(ar.EnableDaysOfWeeksJSON[i], <span class="hljs-string">" "</span>)
   } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">if</span> i == len(ar.EnableDaysOfWeeksJSON)-<span class="hljs-number">1</span> {
     ar.EnableDaysOfWeek += strings.Join(ar.EnableDaysOfWeeksJSON[i], <span class="hljs-string">" "</span>)
    } <span class="hljs-keyword">else</span> {
     ar.EnableDaysOfWeek += strings.Join(ar.EnableDaysOfWeeksJSON[i], <span class="hljs-string">" "</span>) + <span class="hljs-string">";"</span>
    }
   }
  }
 } <span class="hljs-keyword">else</span> {
  ar.EnableDaysOfWeek = strings.Join(ar.EnableDaysOfWeekJSON, <span class="hljs-string">" "</span>)
 }

 //......

 

 //将rule_config转为json串绑定到RuleConfig上
 <span class="hljs-keyword">if</span> ar.RuleConfigJson != nil {
  b, err := json.Marshal(ar.RuleConfigJson)
  <span class="hljs-keyword">if</span> err != nil {
   <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">"marshal rule_config err:%v"</span>, err)
  }
  //绑定rule规则 <span class="hljs-string">"rule_config"</span>: {
  <span class="hljs-regexp">//</span>    <span class="hljs-string">"queries"</span>: [{
  <span class="hljs-regexp">//</span>      <span class="hljs-string">"prom_ql"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-regexp">//</span>      <span class="hljs-string">"severity"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-regexp">//</span>      <span class="hljs-string">"ref"</span>: <span class="hljs-string">"A"</span>,
  <span class="hljs-regexp">//</span>      <span class="hljs-string">"index_type"</span>: <span class="hljs-string">"index"</span>,
  <span class="hljs-regexp">//</span>      <span class="hljs-string">"value"</span>: {
  <span class="hljs-regexp">//</span>        <span class="hljs-string">"func"</span>: <span class="hljs-string">"count"</span>
  //      },
  <span class="hljs-regexp">//</span>      <span class="hljs-string">"unit"</span>: <span class="hljs-string">"none"</span>,
  <span class="hljs-regexp">//</span>      <span class="hljs-string">"index"</span>: <span class="hljs-string">"java_app_logs"</span>,
  <span class="hljs-regexp">//</span>      <span class="hljs-string">"date_field"</span>: <span class="hljs-string">"timestamp"</span>,
  <span class="hljs-regexp">//</span>      <span class="hljs-string">"filter"</span>: <span class="hljs-string">"log_level:"</span>ERROR<span class="hljs-string">""</span>,
  <span class="hljs-regexp">//</span>      <span class="hljs-string">"interval"</span>: <span class="hljs-number">1800</span>
  //    }],
  ar.RuleConfig = string(b)
  ar.PromQl = <span class="hljs-string">""</span>
 }

 //......

 <span class="hljs-keyword">return</span> nil
}
</code></pre>
<p>基于<code>FE2DB</code>生成数据映射对象后，就需要进行持久化，按照笔者的说法该模型会调用内置的Add将结构体持久化，对应的方法也位于<code>alert_rule.go</code>文件的<code>Add</code>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(ar *AlertRule)</span></span> Add(ctx *ctx.Context) <span class="hljs-type">error</span> {
 <span class="hljs-comment">//......</span>
 
 <span class="hljs-comment">//设置创建时间和更新时间</span>
 now := time.Now().Unix()
 ar.CreateAt = now
 ar.UpdateAt = now
 <span class="hljs-comment">//写入数据库 写入到alert_rule表</span>
 <span class="hljs-keyword">return</span> Insert(ctx, ar)
}
</code></pre>
<p>最终我们也可以在alert_rule看到这份信息：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c344bc2c117241dc8dc79f8419618886~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=pk7SEGqFyT6gP9PAQimrgFVWthc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">轮询监控告警工作过程</h3>
<p>完成的查询的任务创建之后，就到了<code>Nightingale</code>中最重要的一环，即基于规则进行告警监控，这个过程本质就是上述两个步骤的综合配置结果，即通过规则配置和插入，结合用户调测配置的查询规则进行周期性轮询并，针对查到的数据进行阈值判断，一旦发现结果超出阈值，则将结果写入缓存队列中，后续各种告警手段都会基于这个缓存进行告警输出。</p>
<p>这里笔者也给出<code>Nightingale</code>告警的宏观流程：</p>
<ol>
<li>基于之前写入数据库且缓存的rule对象生成job提交到调取器<code>scheduler</code>中</li>
<li><code>scheduler</code>定期执行这个<code>job</code></li>
<li><code>job</code>向<code>elasticsearch</code>发起请求获取结果</li>
<li>将触发阈值的结果封装成<code>DataResp</code>写入缓存<code>seriesStore</code>中</li>
<li>遍历<code>seriesStore</code>将其封装成事件写入一个协程安全的队列<code>eventQueue</code>中</li>
<li>后续<code>Nightingale</code>就会基于这个队列缓存进行数据库持久化或者告警操作</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d15b6f4d06324bef83b443b72244081f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=HO%2Bo13J89UVYVe4i11hWrJxdP20%3D" alt="" loading="lazy"/></p>
<p>对应的我们先给出从缓存中获取rule并将其提交到调度器scheduler的代码，即位于alert_rule.go下的syncAlertRules函数，逻辑比较简单，从alertRuleCache拉取到规则后调用NewAlertRuleWorker提交到调度器即可：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Scheduler)</span></span> syncAlertRules() {
 <span class="hljs-comment">//从缓存中拿到rule</span>
 ids := s.alertRuleCache.GetRuleIds() 
 <span class="hljs-comment">//.....</span>
 <span class="hljs-comment">//基于id拿到rule具体信息</span>
 <span class="hljs-keyword">for</span> _, id := <span class="hljs-keyword">range</span> ids { 
  rule := s.alertRuleCache.Get(id)
  <span class="hljs-comment">//.....</span>

  ruleType := rule.GetRuleType()
  <span class="hljs-keyword">if</span> rule.IsPrometheusRule() || rule.IsInnerRule() {
    <span class="hljs-comment">//.....</span>
   <span class="hljs-keyword">for</span> _, dsId := <span class="hljs-keyword">range</span> datasourceIds {
    <span class="hljs-comment">//.....</span>
    <span class="hljs-comment">//封装成cronjob添加</span>
    alertRule := NewAlertRuleWorker(rule, dsId, processor, s.promClients, s.ctx) 
    alertRuleWorkers[alertRule.Hash()] = alertRule
   }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> rule.IsHostRule() {
   <span class="hljs-comment">//.....</span>
  } <span class="hljs-keyword">else</span> {
   <span class="hljs-comment">//.....</span>
  }
 }
</code></pre>
<p>后续就会有一个协程定时调用eval.go的Eval方法，通过GetAnomalyPoint发起es查询，如果存在异常端点事件，则将其通过Processor.Handle封装成event缓存起来，等待Nightingale底层各种协程进行持久化、告警操作,对应笔者给出这几个步骤的核心代码断，读者可以结合注释了解一下：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(arw *AlertRuleWorker)</span></span> Eval() {
 <span class="hljs-comment">//......</span>
 <span class="hljs-comment">//根据数据源类型获取异常点anomalyPoints</span>
 <span class="hljs-keyword">switch</span> typ {
 <span class="hljs-keyword">case</span> models.PROMETHEUS:
 <span class="hljs-comment">//......</span>
 <span class="hljs-keyword">default</span>:
  <span class="hljs-comment">//触发es查询,anomalyPoints就是异常的端点信息(如果存在的话)</span>
  anomalyPoints, recoverPoints, err = arw.GetAnomalyPoint(cachedRule, arw.Processor.DatasourceId())
 }

 <span class="hljs-comment">//......</span>

 

 
 } <span class="hljs-keyword">else</span> {
 <span class="hljs-comment">//......</span>
 }
 <span class="hljs-comment">//处理异端点数据anomalyPoints,将其封装成event缓存,等待后续告警 持久化等各种操作</span>
 arw.Processor.Handle(anomalyPoints, <span class="hljs-string">"inner"</span>, arw.Inhibit)
}
</code></pre>
<p>对应的笔者也给出<code>GetAnomalyPoint</code>的实现细节，逻辑比较简单，整体就是触发es查询即<code>QueryData(上文告警规则调测介绍过，其底层es查询的逻辑)</code>，然后将其写入<code>seriesStore</code>中，然后结合rule对象通过<code>parser.CalcWithRid</code>查看结果是否触发阈值，如果触发则存入异常端点的切片<code>points</code>中返回：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(arw *AlertRuleWorker)</span></span> GetAnomalyPoint(rule *models.AlertRule, dsId <span class="hljs-type">int64</span>) ([]models.AnomalyPoint, []models.AnomalyPoint, <span class="hljs-type">error</span>) {
 <span class="hljs-comment">//......</span>

   <span class="hljs-comment">//触发es查询即可得到 异常端点的时间点和count</span>
   series, err := plug.QueryData(ctx, query)
   
  <span class="hljs-comment">//......</span>

  
   <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(series); i++ {
    <span class="hljs-comment">//计算es结果的hash</span>
    serieHash := hash.GetHash(series[i].Metric, series[i].Ref)
    <span class="hljs-comment">//计算tag hash</span>
    tagHash := hash.GetTagHash(series[i].Metric)
    <span class="hljs-comment">//将本次count查询结果存储到序列桶中</span>
    seriesStore[serieHash] = series[i]

    <span class="hljs-comment">//......</span>
    <span class="hljs-comment">//将series的hash写入到seriesTagIndex中</span>
    seriesTagIndex[tagHash] = <span class="hljs-built_in">append</span>(seriesTagIndex[tagHash], serieHash) 
   }
   <span class="hljs-comment">//......</span>
  }

  <span class="hljs-comment">//......</span>

  <span class="hljs-keyword">if</span> !ruleQuery.ExpTriggerDisable {
   <span class="hljs-keyword">for</span> _, trigger := <span class="hljs-keyword">range</span> ruleQuery.Triggers {
    <span class="hljs-comment">//......</span>
    <span class="hljs-comment">//从标签seriesTagIndex中获取series的hash值</span>
    <span class="hljs-keyword">for</span> _, seriesHash := <span class="hljs-keyword">range</span> seriesTagIndex {
     <span class="hljs-comment">//......</span>
     
     <span class="hljs-comment">//通过表达式结合查询结果查看是否满足条件</span>
     isTriggered := parser.CalcWithRid(trigger.Exp, m, rule.Id)
     <span class="hljs-comment">//......</span>
     <span class="hljs-comment">//将结果封装成point,并追加到切片中</span>
     point := models.AnomalyPoint{
      Key:           sample.MetricName(),
      Labels:        sample.Metric,
      Timestamp:     <span class="hljs-type">int64</span>(ts),
      Value:         value,
      Values:        values,
      Severity:      trigger.Severity,
      Triggered:     isTriggered,
      Query:         fmt.Sprintf(<span class="hljs-string">"query:%+v trigger:%+v"</span>, queries, trigger),
      RecoverConfig: trigger.RecoverConfig,
      ValuesUnit:    valuesUnitMap,
     }
     <span class="hljs-comment">//如果符合条件则将其追加到points中</span>
     <span class="hljs-keyword">if</span> isTriggered {
      points = <span class="hljs-built_in">append</span>(points, point)
     } <span class="hljs-keyword">else</span> {
     <span class="hljs-comment">//......</span>
     }
    }
   }
  }

  <span class="hljs-comment">//......</span>
 <span class="hljs-comment">//返回point</span>
 <span class="hljs-keyword">return</span> points, recoverPoints, <span class="hljs-literal">nil</span>
}
</code></pre>
<p>最后就是事件告警了，逻辑比较简单，基于上一步的异常端点<code>anomalyPoints</code>遍历生成<code>event</code>写入缓存中：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *Processor)</span></span> Handle(anomalyPoints []models.AnomalyPoint, from <span class="hljs-type">string</span>, inhibit <span class="hljs-type">bool</span>) {
  <span class="hljs-comment">//......</span>

 <span class="hljs-comment">// 遍历anomalyPoints，根据 event 的 tag 将 events 分组，处理告警抑制的情况</span>
 eventsMap := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>][]*models.AlertCurEvent)
 <span class="hljs-keyword">for</span> _, anomalyPoint := <span class="hljs-keyword">range</span> anomalyPoints {
  <span class="hljs-comment">//封装成事件</span>
  event := p.BuildEvent(anomalyPoint, from, now, ruleHash) <span class="hljs-comment">//基于异常点生成告警事件</span>
  <span class="hljs-comment">//......</span>

  

  
  }

  <span class="hljs-comment">//......</span>
  <span class="hljs-comment">//将anomalyPoint哈希运算存入eventsMap</span>
  tagHash := TagHash(anomalyPoint)
  <span class="hljs-comment">//追加到对应tagHash(也就是我们的规则标签的hash)</span>
  eventsMap[tagHash] = <span class="hljs-built_in">append</span>(eventsMap[tagHash], event)
 }
 <span class="hljs-comment">//遍历告警事件的map并处理事件，其底层就是将其存入到一个协程安全的缓存队列中</span>
 <span class="hljs-keyword">for</span> _, events := <span class="hljs-keyword">range</span> eventsMap {
  p.handleEvent(events)
 }

  <span class="hljs-comment">//......</span>
}
</code></pre>
<h2 data-id="heading-12">小结</h2>
<p>本文详细的介绍了<code>Nightingale</code>的日志告警规则配置和实现细节，基于这个契机，笔者也来谈谈读者常问的一个问题——如何较好的去掌握一门技术，作为一个计算机从业者，私以为学习一门技术的本质无非是想尽一切去了解它，让自己拥有白盒的视角去看待这些原本黑盒的技术。</p>
<p>以本次<code>Nightingale</code>这个告警框架为例，读者可以非常直观的看到笔者的学习过程，本质上就是：</p>
<ol>
<li>结合一手官网的文档去学习和应用</li>
<li>通过这些应用找到请求入口</li>
<li>结合入口定位到源码入口并针对每个接口的实现细节进行阅读和具象化梳理</li>
</ol>
<p>最终读者眼中的这些工具，在笔者眼里就变为一个<code>http</code>请求在<code>go</code>应用框架的协程中的各种数据流扭转和<code>es</code>交互请求和响应，后续无论是运用还是问题排查也都是以这种视角游刃有余的去使用和排查。</p>
<p>总结源码 结合接口推断保存查询 数据流向哪里来 推测告警或者动作的源头 从而了解源码原理</p>
<p>我是 <strong>SharkChili</strong> ，Java 开发者，<strong>Java Guide</strong> 开源项目维护者。欢迎关注我的公众号：<strong>写代码的SharkChili</strong>，也欢迎您了解我的开源项目 mini-redis：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fshark-ctrl%2Fmini-redis" target="_blank" title="https://github.com/shark-ctrl/mini-redis" ref="nofollow noopener noreferrer">github.com/shark-ctrl/…</a>。</p>
<p>为方便与读者交流，现已创建读者群。关注下方公众号获取我的联系方式，添加时备注<strong>加群</strong>即可加入。</p>
<h2 data-id="heading-13">参考</h2>
<p>夜莺监控官网:<a href="https://link.juejin.cn?target=https%3A%2F%2Fn9e.github.io%2Fzh%2Fdocs%2Fprologue%2Fintroduction%2F" target="_blank" title="https://n9e.github.io/zh/docs/prologue/introduction/" ref="nofollow noopener noreferrer">n9e.github.io/zh/docs/pro…</a></p>
<p>夜莺告警规则配置:<a href="https://link.juejin.cn?target=https%3A%2F%2Fflashcat.cloud%2Fdocs%2Fcontent%2Fflashcat-monitor%2Fnightingale-v7%2Fusage%2Falarm-management%2Falert-rules%2Frule-configuration%2Fbusiness%2Fes-alarm-rules%2F" target="_blank" title="https://flashcat.cloud/docs/content/flashcat-monitor/nightingale-v7/usage/alarm-management/alert-rules/rule-configuration/business/es-alarm-rules/" ref="nofollow noopener noreferrer">flashcat.cloud/docs/conten…</a></p>
<p>夜莺日志告警:<a href="https://link.juejin.cn?target=https%3A%2F%2Fn9e.github.io%2Fzh%2Fdocs%2Fusage%2Flogs-alerting%2F" target="_blank" title="https://n9e.github.io/zh/docs/usage/logs-alerting/" ref="nofollow noopener noreferrer">n9e.github.io/zh/docs/usa…</a></p>
<p>使用SkyWalking和Elasticsearch实现全链路监控 :<a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fes%2Fuse-cases%2Fuse-skywalking-to-implement-end-to-end-monitoring-on-elasticsearch" target="_blank" title="https://help.aliyun.com/zh/es/use-cases/use-skywalking-to-implement-end-to-end-monitoring-on-elasticsearch" ref="nofollow noopener noreferrer">help.aliyun.com/zh/es/use-c…</a></p>
<p>《Elasticsearch实战第二版》</p>
<p>一篇文章学会黑盒测试、白盒测试（含实操） :<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fu010924879%2Farticle%2Fdetails%2F146502076" target="_blank" title="https://blog.csdn.net/u010924879/article/details/146502076" ref="nofollow noopener noreferrer">blog.csdn.net/u010924879/…</a></p>
<p>DDD领域驱动设计：贫血模型和充血模型 :<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F464914100" target="_blank" title="https://zhuanlan.zhihu.com/p/464914100" ref="nofollow noopener noreferrer">zhuanlan.zhihu.com/p/464914100</a></p>
<p>JSON文件加注释的7种方法 :<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2FDream_fengyuefei%2Farticle%2Fdetails%2F92626804" target="_blank" title="https://blog.csdn.net/Dream_fengyuefei/article/details/92626804" ref="nofollow noopener noreferrer">blog.csdn.net/Dream_fengy…</a></p>
<p>本文使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarkdown.com.cn" target="_blank" title="https://markdown.com.cn" ref="nofollow noopener noreferrer">markdown.com.cn</a> 排版</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【高斯泼溅】从一张好照片开始：Mapmost 3DGS建模之图像采集指南]]></title>    <link>https://juejin.cn/post/7571429745231511588</link>    <guid>https://juejin.cn/post/7571429745231511588</guid>    <pubDate>2025-11-12T08:27:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571429745231511588" data-draft-id="7571475192489852938" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【高斯泼溅】从一张好照片开始：Mapmost 3DGS建模之图像采集指南"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-12T08:27:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mapmost"/> <meta itemprop="url" content="https://juejin.cn/user/1679709496936343"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【高斯泼溅】从一张好照片开始：Mapmost 3DGS建模之图像采集指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1679709496936343/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mapmost
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T08:27:15.000Z" title="Wed Nov 12 2025 08:27:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Mapmost 3DGS 建模工具自上线以来，已帮助不少用户生成高保真3DGS模型。</p>
<p>但在实际使用中，部分用户对如何采集合适的图像数据仍有疑问：<strong>拍多少张？用什么设备？怎么拍才能保证效果？</strong></p>
<p>别担心——<strong>高质量建模，从一张好照片开始</strong>。3DGS技术完全依赖彩色图像重建几何与纹理。图像拍得好，模型才精细；覆盖不完整，细节就丢失。<br/>
为此，我们整理了一份简单易用的<strong>图像采集指南</strong>，无论你是用无人机航拍园区，还是拿手机拍一个玩偶，都能轻松上手！</p>
<h2 data-id="heading-0">通用原则：所有设备都适用</h2>
<p><strong><em>1.</em> 只拍静态场景</strong><br/>
被拍摄物体或场景应当尽量保持<strong>静止状态</strong>。行人、车辆、飘动的旗帜……动态元素会导致“鬼影”或空洞，建议规避。</p>
<p><strong><em>2.</em> 光线要稳，别忽明忽暗</strong></p>
<ul>
<li><strong>户外：<strong>选</strong>阴天或多云</strong>， 避免强光直射造成高光过曝、阴影过重或光照闪烁；</li>
<li><strong>室内：<strong>用</strong>稳定的人工光源</strong>， 避免频繁开关或闪烁光源，防止图像间光照不一致。</li>
<li><strong>曝光模式：锁定 ISO、快门、白平衡</strong>，避免光照跳变。</li>
</ul>
<p><strong><em>3.</em></strong> <strong>画质要清晰</strong><br/>
模糊、过曝、抖动的照片直接拖累重建效果。有条件的话，<strong>上三脚架</strong>，或者<strong>开启相机防抖</strong>。</p>
<p><em>｜小贴士：不需要深度图、激光点云——<strong>普通彩色照片即可</strong>！</em></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39e133bae4e349429372399a69bf7aac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=4EnoM9XNCZpbvNcxbPXQpXvyCJ4%3D" alt="" loading="lazy"/></p>
<p><em>通用的拍摄原则</em></p>
<h2 data-id="heading-1">典型场景推荐采集方案</h2>
<h3 data-id="heading-2"><strong>方案一： 大场景？交给无人机！</strong></h3>
<p><strong>适用场景</strong>：园区、建筑群、景区、线性工程等大地理范围场景。</p>
<p><strong>推荐设备：</strong></p>
<ul>
<li>大疆 Mavic / Air 系列（2000 万像素以上）；</li>
<li>建议配备 RTK 模块（非必需）：厘米级定位，让模型几何更准、拼接更稳。</li>
</ul>
<p><strong>怎么飞？记住这几点</strong></p>
<ul>
<li><strong>航线类型：<strong>推荐使用大疆飞控软件DJI Pilot自带的</strong>面状倾斜航线</strong>，参数与传统测绘行业标准的五向及多视角倾斜摄影航线基本一致；</li>
<li><strong>飞行高度：120 米以下</strong>（按场景灵活调整），更低的飞行高度往往意味着更多的采集数据与更高的模型质量；</li>
<li>**航线重叠率：**航向与旁向重叠度均设置在 <strong>70%-80% 区间</strong> ；</li>
<li><strong>云台俯仰倾角：-45°，</strong> 可根据场景在 -30° 至 -60° 范围内微调 <strong>；</strong></li>
<li><strong>拍照模式：<strong>建议选择</strong>等距间隔拍摄。</strong></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c4e3d524ce8492c99b78de2a31c41a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=q1iKrZH1SrrcYzlDrhroJ%2FDewtg%3D" alt="" loading="lazy"/></p>
<p><em>大疆飞控航线设置界面</em></p>
<p><strong>进阶技巧</strong></p>
<ul>
<li>
<p>若追求更高精度，可结合<strong>手动飞行或立体环绕航线</strong>（围绕重点建筑做多圈、多高度环绕），同样保证70%以上的重叠度，增强侧面与顶部细节；</p>
</li>
<li>
<p>对于复杂结构（如古建筑、雕塑），可以<strong>手动近距离补拍</strong>，以提升局部分辨率。</p>
<p><strong><em>01 面状倾斜航线及建模效果</em></strong></p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/753906e68e1c49b9a07959118e9bd1ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=jvOGojDooK5zMfYQkYXW7aqrPKc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89f28e3837934f72955a141d32599e00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=VXz1kTG%2BlC6T72rhCFF0zsTUq5o%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef29bb6311844c5fa79bc4ac9f1a8e3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=TCBGDvAFDeFwXEtFdTr4QgpnUh0%3D" alt="动图封面" loading="lazy"/></p>
<p><em>华谊</em></p>
<p><em><strong>02 面状倾斜+立体环绕的复合航点及建模效果</strong></em></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbd4b2d2c46144e081927266932cf262~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=KM6z4C%2F9zqbeOU5djzXQr15HbCM%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bdafed29b964f149cbe0dc4c8b4843b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=DFfPNzqce0vTW3AMA17fpCx5uxE%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad0a5fc6e73b4fc6883ddc4dc6d535e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=luJ3NOlcMrAiWj4%2F6xDBBYqWFGA%3D" alt="动图封面" loading="lazy"/></p>
<p><em>月光码头</em></p>
<p><em><strong>03 面状倾斜+手动补拍的复合航点及建模效果</strong></em></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d753d7dba4d4927bb7d97537d2a7b97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=Ez4nvVBwcZPygUElT7I9dxOeJjs%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19013eb55991478a8d5b546a20557a12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=JwVk77mdnXLDu06F%2Bpy34HOkI34%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6da1ee78812c4fc8bf1c9a5090ae22cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=N5k3NQyfpJv1qqCk4itVY8%2FNtpU%3D" alt="动图封面" loading="lazy"/></p>
<p><em>石狮子</em></p>
<h3 data-id="heading-3"><strong>方案二：小场景？手机也能搞定！</strong></h3>
<p><strong>适用场景</strong>：室内空间、文物、设备、小型建筑等。</p>
<p>**支持设备：**智能手机、运动相机、数码相机均可，<strong>无需专业设备</strong>！</p>
<p><strong>拍摄口诀：绕着拍 + 多角度 + 高重叠</strong></p>
<ul>
<li><strong>360°环绕目标，<strong>每张与前一张重叠</strong>50%以上；</strong></li>
<li>**高低结合：**蹲下拍底部，举高拍顶部，别留死角；</li>
<li>**对象必须静止：**拍花瓶可以， 拍猫不可以——如果它乱动的话。</li>
</ul>
<p><strong>建议数量</strong>：50–500 张，视场景复杂度而定。<br/>
<strong>避坑提醒</strong>：关闭 HDR、美颜、夜景模式——这些“智能优化”反而会干扰重建！</p>
<p><strong><em>手持设备推荐采集点位及建模效果</em></strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7039a367e9674f6e9e3ba0947fd08e63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=MP9Z54WjvifMF33AdCGKCNYmVBk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7bf79844f35645529e46c87de2c316c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=TIep6eH3SouOY463eQwkzdeEWn8%3D" alt="动图封面" loading="lazy"/></p>
<p>玩偶</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1194f6130481430e91cc83691edca541~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=2JQrljhvWotWA46cNvbTXK%2BybOo%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b96ddd8c4e7241c5b85682754a32658a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=9mkokWzwSZge1MPmc2K%2FIPwUizM%3D" alt="动图封面" loading="lazy"/></p>
<p><em>人物</em></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25623265d238453c80c3225c0eadcb45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=5A97BzceN8EuqWW%2Fy0k5zVsRn%2FI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a79c93d0d09b49ffb4b138b3b62ec23c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=KbhX5e7Nmoty7zmCnZJ%2FtkvwU4U%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4db2888bb53f4a18922e95f6a9b6915d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=NFiFWwJnL1vBUYC4W%2FzLdqqTtKM%3D" alt="动图封面" loading="lazy"/></p>
<p><em>活动室</em></p>
<h2 data-id="heading-4"><strong>现在就开始吧！</strong></h2>
<p>在导入 Mapmost 3DGS 建模工具前，请确认：</p>
<ul>
<li>所有图像放在<strong>一个文件夹</strong>；</li>
<li>无严重模糊、过曝、遮挡及光照变化；</li>
<li>无人机照片<strong>保留 EXIF 元信息</strong>（如经纬高、姿态角等）；</li>
<li>手持设备采集时已确保目标对象在拍摄过程中未移动。</li>
</ul>
<p>确认完毕后，<strong>一键上传至 Mapmost 3DGS 建模工具</strong>，剩下的交给我们——无需调参，无需干预，自动输出<strong>高质量 3DGS 模型</strong>。</p>
<p>申请试用，请至<a href="https://link.juejin.cn?target=http%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fwww.mapmost.com%2F%2523%2F" target="_blank" title="http://link.zhihu.com/?target=https%3A//www.mapmost.com/%23/" ref="nofollow noopener noreferrer">Mapmost</a>官网联系客服</p>
<p>**特别预告：**Mapmost Model Online 在线体验版 ，11月上线倒计时～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kubernetes无缝集成Harbor，实现CI/CD流水线]]></title>    <link>https://juejin.cn/post/7571005216910917651</link>    <guid>https://juejin.cn/post/7571005216910917651</guid>    <pubDate>2025-11-11T06:45:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571005216910917651" data-draft-id="7571304204720521270" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kubernetes无缝集成Harbor，实现CI/CD流水线"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-11T06:45:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kubernetes无缝集成Harbor，实现CI/CD流水线
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T06:45:57.000Z" title="Tue Nov 11 2025 06:45:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Harbor 作为企业级的容器镜像仓库，在 Kubernetes 生态中扮演着核心的镜像管理角色。下面这个表格能帮你快速抓住其核心价值和在案例中的体现：</p>






























<table><thead><tr><th>特性维度</th><th>核心价值</th><th>在线书店案例体现</th></tr></thead><tbody><tr><td><strong>统一镜像源</strong></td><td>为集群所有节点提供稳定、快速的私有镜像拉取源，避免依赖公网。</td><td>所有服务镜像（如<code>book-service</code>, <code>user-service</code>）均从内部Harbor拉取。</td></tr><tr><td><strong>基于项目的访问控制 (RBAC)</strong></td><td>实现镜像的权限隔离，不同团队管理各自项目。</td><td>为前端、后端团队创建独立项目，成员只能访问被授权的项目。</td></tr><tr><td><strong>安全扫描</strong></td><td>集成漏洞扫描工具，提升供应链安全。</td><td>推送镜像时自动扫描，阻止含高危漏洞的镜像部署。</td></tr><tr><td><strong>高可用与持久化</strong></td><td>确保镜像仓库稳定运行，数据不丢失。</td><td>采用外部对象存储和数据库，即使Pod重建数据也完好。</td></tr></tbody></table>
<p>下面，我们以一个名为“BookStore”的<strong>在线书店微服务项目</strong>为例，详细介绍如何从零搭建Harbor，并将其无缝集成到Kubernetes集群中，实现CI/CD流水线。</p>
<h3 data-id="heading-0">🔧 安装与配置 Harbor</h3>
<h4 data-id="heading-1">1. 选择部署模式与前提准备</h4>
<p>首先，根据你的环境选择最合适的部署方式：</p>




















<table><thead><tr><th>部署方式</th><th>适用场景</th><th>关键步骤/命令</th></tr></thead><tbody><tr><td><strong>Helm Chart (K8s内)</strong></td><td>生产环境，希望与K8s统一管理。</td><td><code>helm repo add harbor https://helm.goharbor.io</code></td></tr><tr><td><strong>Docker Compose</strong></td><td>开发、测试环境，快速独立部署。</td><td>下载离线包，编辑<code>harbor.yml</code>，运行<code>./install.sh</code>。</td></tr></tbody></table>
<p><strong>前提准备</strong>：确保你的服务器已安装符合版本的 Docker 和 Docker Compose 。</p>
<h4 data-id="heading-2">2. 关键配置详解</h4>
<p>在启动安装前，需要仔细配置 <code>harbor.yml</code>（Docker Compose方式）或自定义的 <code>values.yaml</code>（Helm方式）。以下是几个关键配置点：</p>
<ul>
<li><strong>外部访问与证书</strong>：生产环境<strong>必须启用HTTPS</strong>。</li>
<li><strong>持久化存储</strong>：必须为 Harbor 配置持久化存储，以防止数据丢失 。</li>
<li><strong>管理员密码</strong>：<strong>务必修改</strong>默认的管理员密码（<code>harborAdminPassword</code>）。</li>
</ul>
<p>配置完成后，执行安装脚本（Docker Compose方式）或 Helm 命令即可启动所有服务。通过 <code>docker-compose ps</code>或 <code>kubectl get pods -n harbor</code>确认所有组件状态为 <code>Running</code>或 <code>Ready</code>。</p>
<h3 data-id="heading-3">📥 集成 Harbor 与 Kubernetes</h3>
<p>要让 Kubernetes 集群能够从私有的 Harbor 仓库拉取镜像，需要进行如下配置，其核心流程是通过创建一个包含 Harbor 认证信息的 Secret 来实现的：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/133069af87f241478f63a34349a6ca97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVTmqZjlrZDnmq4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449386&amp;x-signature=kZ%2FcDl5oriUEeH35KHZ2Pbvea1w%3D" alt="image.png" loading="lazy"/></p>
<p>具体操作步骤如下：</p>
<ol>
<li>
<p><strong>创建镜像拉取密钥（ImagePullSecret）</strong></p>
<p>在打算部署应用的命名空间下，创建一个 <code>docker-registry</code>类型的 Secret 。</p>
<pre><code class="hljs language-ini" lang="ini">kubectl create secret docker-registry harbor-regcred \
  <span class="hljs-attr">--docker-server</span>=harbor.yourcompany.com \
  <span class="hljs-attr">--docker-username</span>=admin \
  <span class="hljs-attr">--docker-password</span>=yourpassword \
  <span class="hljs-attr">--namespace</span>=your-namespace
</code></pre>
</li>
<li>
<p><strong>在应用部署中引用该 Secret</strong></p>
<p>在你的 Deployment YAML 中，通过 <code>imagePullSecrets</code>字段指明使用刚才创建的 Secret 。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">book-service</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">book-service</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">harbor.yourcompany.com/bookstore/book-service:v1.0.0</span> <span class="hljs-comment"># 必须是完整地址</span>
      <span class="hljs-attr">imagePullSecrets:</span> <span class="hljs-comment"># 引用密钥</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">harbor-regcred</span>
</code></pre>
<p>请注意，<code>image</code>字段必须是 <strong>完整的镜像地址</strong>，包含仓库地址、项目路径和标签 。</p>
</li>
</ol>
<h3 data-id="heading-4">🚀 项目实战：在线书店的镜像管理</h3>
<p>假设你正在部署上述“在线书店”应用，它包含 <code>book-service</code>（图书服务）和 <code>user-service</code>（用户服务）。</p>
<ol>
<li>
<p><strong>在 Harbor 中创建项目</strong></p>
<p>登录 Harbor Web UI，为“在线书店”创建两个项目：<code>bookstore/backend</code>和 <code>bookstore/frontend</code>，并分别为后端和前端开发团队配置推送和拉取权限。</p>
</li>
<li>
<p><strong>推送镜像到 Harbor</strong></p>
<p>在 CI/CD 流水线或开发者本地，构建好镜像后，将其推送到 Harbor 对应的项目中 。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 为本地镜像打上符合Harbor规范的标签</span>
docker tag book-service:latest harbor.yourcompany.com/bookstore/backend/book-service:v1.0.0
<span class="hljs-comment"># 2. 登录Harbor（需要先在客户端配置信任证书或insecure-registry）</span>
docker login harbor.yourcompany.com
<span class="hljs-comment"># 3. 推送镜像</span>
docker push harbor.yourcompany.com/bookstore/backend/book-service:v1.0.0
</code></pre>
</li>
<li>
<p><strong>在 Kubernetes 中部署</strong></p>
<p>编写 Deployment YAML 文件，<code>image</code>字段指定为 Harbor 中的镜像地址，并正确引用 <code>imagePullSecrets</code>，然后应用配置 。</p>
<pre><code class="hljs">kubectl apply -f book-service-deployment.yaml -n bookstore
</code></pre>
</li>
</ol>
<h3 data-id="heading-5">🛡️ 企业级增强功能与高可用</h3>
<ul>
<li><strong>启用漏洞扫描</strong>：在 Harbor 中启用 Trivy 等扫描器，并配置策略，阻止携带高危漏洞的镜像被拉取 。</li>
<li><strong>高可用与性能优化</strong>：对于生产环境，应考虑 Harbor 组件本身的高可用 。</li>
</ul>
<h3 data-id="heading-6">🧩 常见问题排查 (Troubleshooting)</h3>
<ul>
<li>
<p><strong>Pod 状态为 <code>ImagePullBackOff</code>或 <code>ErrImagePull</code></strong>：</p>
<ul>
<li><strong>检查镜像地址和标签</strong>：使用 <code>docker pull &lt;镜像完整地址&gt;</code>在节点上手动测试。</li>
<li><strong>检查 Secret</strong>：确认 Secret 所在命名空间与 Pod 一致，且用户名密码正确。</li>
<li><strong>检查证书</strong>：确保 Kubernetes 节点信任 Harbor 的 HTTPS 证书 。</li>
</ul>
</li>
<li>
<p><strong>Harbor 服务无法访问</strong>：</p>
<ul>
<li>检查 Ingress Controller 或 NodePort 服务是否正常 。</li>
</ul>
</li>
<li>
<p><strong>推送镜像失败</strong>：</p>
<ul>
<li>检查客户端 Docker 守护进程的 <code>insecure-registries</code>配置（仅限 HTTP 或自签名证书测试环境）或是否信任了 Harbor 的 CA 证书 。</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 的内存是怎么回事儿，简单给你讲明白——它给那些Widget分配和释放内存的机制]]></title>    <link>https://juejin.cn/post/7570984257666564142</link>    <guid>https://juejin.cn/post/7570984257666564142</guid>    <pubDate>2025-11-11T01:41:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570984257666564142" data-draft-id="7569087944159526938" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 的内存是怎么回事儿，简单给你讲明白——它给那些Widget分配和释放内存的机制"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-11T01:41:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JarvanMo"/> <meta itemprop="url" content="https://juejin.cn/user/2348212565845704"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 的内存是怎么回事儿，简单给你讲明白——它给那些Widget分配和释放内存的机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2348212565845704/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JarvanMo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T01:41:24.000Z" title="Tue Nov 11 2025 01:41:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果你发布 Flutter 应用，那你肯定关心这些：<strong>画面不卡顿</strong>（不掉帧）、<strong>屏幕打开要够快</strong>，以及<strong>用户能留得住</strong>。</p>
<p>但大多数人忽略了一个<strong>不起眼却非常关键</strong>的点：<strong>你的应用是怎么分配和释放内存的</strong>。</p>
<p><strong>如果你不理它</strong>，你会一直追着那些<strong>治标不治本</strong>的“假优化”跑（比如狂写 <code>setState</code>、搞各种“小聪明”），但你的应用<strong>依然会卡顿</strong>。</p>
<p><strong>如果你搞懂了它</strong>，你就能<strong>彻底消除界面卡顿</strong>，<strong>阻止内存泄漏</strong>，然后<strong>自信满满地发布你的应用！</strong></p>
<p><strong>来都来了，快关注公众号：OpenFlutter吧</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6afd8a9a467b42ce9ae79b5aedf95399~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFydmFuTW8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763430084&amp;x-signature=3JAFvt74K1KVb%2FbvdsFo%2BuVnQoU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">🏗️ 快速真相：Widgets 是<strong>蓝图</strong>，不是<strong>大石头</strong>！</h2>
<p>Flutter 的 <strong>Widgets</strong>（小部件）其实只是<strong>界面的“不可变描述”</strong> ，相当于<strong>设计图纸</strong>。真正<strong>又重又“长寿”</strong> （长时间存在）的东西，都藏在底层的 <strong>Element</strong>（元素）和 <strong>RenderObject</strong>（渲染对象）层。</p>
<p>框架会<strong>重复使用</strong>这些底层对象，所以就算你<strong>频繁重建</strong>（rebuild）界面，也不会让内存爆炸。</p>
<hr/>
<h2 data-id="heading-1">❓ 随堂测验 #1</h2>
<p><strong>Q：</strong> <code>StatelessWidget</code> 和 <code>StatefulWidget</code> 哪个更耗内存？</p>
<p><strong>A：</strong> <strong><code>StatefulWidget</code></strong> 更耗内存。因为它多了一个 <strong><code>State</code></strong> 对象，这个对象会一直<strong>粘在元素树</strong>上，并且它会<strong>持有</strong>（引用）<strong>控制器、监听器</strong>和<strong>数据</strong>等等。</p>
<h3 data-id="heading-2">🛠️ 今天就试试这样做：</h3>
<ul>
<li>尽量使用 <strong><code>const</code> 构造函数</strong>。这样可以避免重复创建完全一样的 Widget 对象来浪费内存。</li>
<li>能用<strong>无状态</strong>（Stateless）就用无状态；真需要<strong>有状态</strong>（Stateful）时，要<strong>有意识地</strong>控制你在 <code>State</code> 里放了什么东西。</li>
</ul>
<hr/>
<h2 data-id="heading-3">💨 为什么你不该再害怕重建（Rebuilds）</h2>
<p>如果你想要<strong>更流畅的画面</strong>（smoother frames），你就应该放下对重建的恐惧。</p>
<p>Dart 语言的<strong>垃圾回收机制（GC）<strong>是</strong>“分代”</strong> （generational）的：</p>
<ul>
<li>它会把<strong>小而短命</strong>的对象放在**“新生代”**（new space），用一个很快的“清道夫”机制迅速清理掉。</li>
<li>那些**“长寿”<strong>的对象会被提升到</strong>“老年代”**（old space），用一个并发的“标记-清除/整理”机制来收集。</li>
</ul>
<p><strong>翻译一下：</strong> 创建<strong>大量短命的 Widget 对象是没问题的</strong>！真正伤内存的是那些<strong>体积大</strong>、<strong>被提升</strong>（Promoted）到老年代，然后<strong>长期存在</strong>或<strong>不断地创建/销毁</strong>的分配。</p>
<h3 data-id="heading-4">📝 举个例子：</h3>
<ul>
<li>在 <code>build()</code> 方法里<strong>创建一个小 Widget</strong> ≈ <strong>很便宜</strong>（内存消耗低）。</li>
<li>在 <code>build()</code> 里<strong>创建一个 10k 项的模型列表</strong>，或者<strong>解码一张 4K 大图</strong> ≈ <strong>很昂贵</strong>（内存消耗高），而且<strong>很可能被提升到老年代</strong>。</li>
</ul>
<h3 data-id="heading-5">🛠️ 今天就试试这样做：</h3>
<ul>
<li>
<p>把<strong>重度分配</strong>（heavy allocations）<strong>移出热点路径</strong>（off the hot path）：</p>
<ul>
<li>在 <code>initState</code> 里提前算好列表。</li>
<li>使用 <strong><code>memoized selectors</code></strong>（记忆化选择器，避免重复计算）。</li>
<li><strong>不要</strong>在渲染时（paint time）才去解码巨大的图片。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-6">🗑️ 2025 年依然能拯救应用的“神技”：<code>dispose()</code></h2>
<p>任何你创建出来、用于<strong>监听、计时</strong>，或者<strong>持有原生资源</strong>（native resources）的对象，都<strong>必须</strong>在 <strong><code>dispose()</code></strong> 方法里释放掉！</p>
<p>这包括：<code>AnimationController</code>、<code>ScrollController</code>、<code>TextEditingController</code>、<code>FocusNode</code>、<code>StreamSubscription</code>、<code>Timer</code>、<code>platform channels</code>等等。</p>
<p><strong>做不到这点</strong>，就会导致<strong>内存泄漏</strong>，以及烦人的 <strong><code>"setState() called after dispose()"</code></strong> 错误。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProfileScreenState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">ProfileScreen</span>&gt; </span>{
  <span class="hljs-keyword">final</span> _controller = ScrollController();
  StreamSubscription&lt;User&gt;? _sub;

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    _sub = userStream.listen((u) =&gt; setState(() =&gt; _user = u));
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    _sub?.cancel();
    _controller.dispose();
    <span class="hljs-keyword">super</span>.dispose();
  }
}
}
</code></pre>
<p><strong>针对</strong>（异步/非同步）<strong>更新的</strong>一个<strong>额外保护措施</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">if</span> (!mounted) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// before setState after an await</span>
</code></pre>
<ul>
<li><strong>图片</strong>是你应用中<strong>偷偷占用大量内存</strong>的东西，很多人都忽略了它。</li>
</ul>
<p>Flutter 的 <strong><code>ImageCache</code></strong>（图片缓存）采用的是 <strong>LRU</strong>（最近最少使用）机制，默认情况下最多能存 <strong>1,000 张图片</strong>，总大小约 <strong>100 MB</strong>。</p>
<p><strong>注意！</strong> 这个 100 MB 只是<strong>压缩后</strong>的缓存大小；图片<strong>解码</strong>成位图（bitmap）后，在内存中会<strong>大得多</strong>！</p>
<p>举个例子，一张 <strong>7,500x5,000 像素</strong>的图片，一旦解码，它在内存中的占用能<strong>膨胀到 100+ MB</strong>，直接<strong>撑爆</strong>你的内存预算，并可能导致应用<strong>不得不重新解码</strong>（re-decodes）或者<strong>卡顿</strong>（jank）。你必须管理好它。</p>
<h3 data-id="heading-7">🛠️ 今天就试试这样做：</h3>
<ul>
<li>在加载图片时，提供 <strong><code>cacheWidth</code></strong> 或 <strong><code>cacheHeight</code></strong> 参数。这能让 Flutter <strong>按设备需要的尺寸</strong>来解码图片，而不是解码图片的完整尺寸。</li>
</ul>
<pre><code class="hljs language-dart" lang="dart">Image.network(url, cacheWidth: <span class="hljs-number">1080</span>)
</code></pre>
<ul>
<li>如果你的应用有很多图片，就**（应该）<strong>调整</strong>（图片）**缓存的大小。</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">void</span> main() {  
PaintingBinding.instance.imageCache.maximumSizeBytes = <span class="hljs-number">80</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;  
runApp(<span class="hljs-keyword">const</span> MyApp());  
}
</code></pre>
<hr/>
<h2 data-id="heading-8">优化实战篇：让列表更高效、消除“神秘”卡顿</h2>
<h3 data-id="heading-9">📜 列表与内存优化</h3>
<ul>
<li><strong>列表创建：</strong> 优先使用 <strong><code>ListView.builder</code></strong>，而不是一次性创建巨大的子部件列表 (<code>ListView(children: [...])</code>)。前者只会创建屏幕上可见的部分，大幅节省内存。</li>
<li><strong>别滥用 <code>KeepAlive</code>：</strong> 避免过度使用 <strong><code>AutomaticKeepAliveClientMixin</code></strong>。它会把那些已经滑出屏幕的 Widget “钉”在内存里不释放。</li>
</ul>
<hr/>
<h3 data-id="heading-10">🔑 Keys：防止无谓的重建和“抽搐”</h3>
<p><strong>Key</strong> 是一个**防止无意中“汰旧换新”**的小细节。</p>
<ul>
<li>
<p><strong>问题：</strong> 错误或缺失的 Key 会让 Flutter <strong>误以为</strong>组件变了，然后把 Element 扔掉，并<strong>重建</strong>你原本想保留的 <code>State</code>。</p>
</li>
<li>
<p><strong>作用：</strong> 正确的 Key 能<strong>稳定</strong>子树结构，<strong>减少</strong>内存分配，<strong>避免</strong>滚动位置丢失和控制器被重复绑定。</p>
</li>
<li>
<p><strong>用法：</strong></p>
<ul>
<li>需要稳定 ID 时，用 <strong><code>ValueKey</code></strong>。</li>
<li>滚动组件需要保存滚动位置时，用 <strong><code>PageStorageKey</code></strong>。</li>
<li><strong>别</strong>在每次构建时都用<strong>随机</strong>（Random）的 Key。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-11">📝 两则来自日志的小故事</h3>
<h4 data-id="heading-12">1. 2025 年 1 月 14 日 — 聊天界面的“神秘膨胀”</h4>
<ul>
<li><strong>现象：</strong> 经过 10 次页面进出（push-pops）后，内存<strong>增加了 42 MB</strong>，垃圾回收（GC）每 2 秒就运行一次。内存图表显示 <strong><code>AnimationController</code> 实例从未被释放</strong>。</li>
<li><strong>修复：</strong> 释放（<code>dispose</code>）了两个控制器，并取消了一个 <strong><code>StreamSubscription</code></strong>。</li>
<li><strong>结果：</strong> 内存稳定下来，GC 间隔延长到 12 秒，卡顿帧数从 2.8% 降到 0.4%。</li>
</ul>
<h4 data-id="heading-13">2. 2025 年 4 月 3 日 — 低端安卓机的引导轮播图</h4>
<ul>
<li><strong>现象：</strong> 加载 4K PNG 图片时，内存<strong>飙升到 410 MB</strong>；图片<strong>重复解码</strong>导致画面长时间卡顿。</li>
<li><strong>修复：</strong> 添加了 <strong><code>cacheWidth: 1080</code></strong>（按需解码），并将 <strong><code>ImageCache</code></strong> 上限设为 <strong>80 MB</strong>。</li>
<li><strong>结果：</strong> 内存稳定在 170 MB 左右，<strong>零卡顿</strong>，滑动流畅。</li>
</ul>
<blockquote>
<p><strong>可选工具：</strong> <strong><code>leak_tracker</code></strong> 可以在<strong>测试</strong>时帮你找出那些漏掉 <code>dispose</code> 的对象。在 <code>debug/profile</code> 模式下启用，及早发现问题。</p>
</blockquote>
<hr/>
<h3 data-id="heading-14">🛑 大多数人会忽略的 3 个内存“坑”</h3>
<ol>
<li><strong>在 <code>build()</code> 里做大量耗时工作：</strong> 它重复运行的次数比你想象的要多得多。请<strong>提前计算</strong>（Precompute）、<strong>使用记忆化</strong>（Memoize），或者<strong>移到 <code>initState</code></strong> 里去做。</li>
<li><strong>让图片全尺寸解码：</strong> 设置解码尺寸到你实际需要的像素大小。你的 <strong>GPU</strong> 和<strong>内存堆</strong>（Heap）会感谢你。</li>
<li><strong>忘了释放“隐形”对象：</strong> <strong><code>StreamSubscription</code></strong> 和 <strong><code>Timer</code></strong> 造成的内存泄漏，跟控制器一样严重。错误往往晚点才爆发成<strong>随机卡顿或崩溃</strong>。</li>
</ol>
<hr/>
<h3 data-id="heading-15">⏰ 10 分钟快速行动计划 (现在就做！)</h3>
<ol>
<li>打开 <strong>DevTools → Memory</strong> 视图，在你最<strong>卡顿</strong>的屏幕上<strong>导航 30 秒</strong>。寻找<strong>持续上升</strong>或<strong>基线不断抬高</strong>的锯齿状内存图。</li>
<li>在你的代码库中搜索所有<strong>需要释放</strong>的对象：<code>AnimationController</code>|<code>ScrollController</code>|<code>TextEditingController</code>|<code>FocusNode</code>|<code>StreamSubscription</code>|<code>Timer</code>。确保每个都有对应的 <strong><code>dispose()</code> 或 <code>cancel()</code></strong> 。</li>
<li>给你最大的几张图片加上 <strong><code>cacheWidth/cacheHeight</code></strong>；如果媒体内容多，就设置 <strong><code>ImageCache.maximumSizeBytes</code></strong> 上限。</li>
<li>把那些超大的 <strong><code>ListView(children: [...])</code></strong> 替换成 <strong><code>ListView.builder</code></strong>。</li>
<li>在稳定的子树构造函数上<strong>加上 <code>const</code></strong>，并在需要保持身份稳定性的地方<strong>修复缺失的 Key</strong>。</li>
</ol>
<hr/>
<h3 data-id="heading-16">🗓️ 本周计划 (3 个重点步骤)</h3>
<ol>
<li><strong>性能分析 (Profile)：</strong> 在 <code>profile</code> 模式下，针对两个**“慢”<strong>的屏幕，捕捉 <strong>30–60 秒</strong>的内存和性能时间线。记录</strong>内存峰值**、<strong>GC 运行频率</strong>和<strong>掉帧百分比</strong>。</li>
<li><strong>修复泄漏：</strong> 用 <strong><code>leak_tracker</code></strong> 给一个模块（如聊天或媒体）添加单元测试/Widget 测试。当控制器或订阅在 <code>dispose</code> 后仍然存活时，让测试<strong>失败</strong>。</li>
<li><strong>调整媒体尺寸：</strong> 检查<strong>前 10 大</strong>的图片和视频缩略图。添加<strong>解码尺寸限制</strong>，并根据需要调整缓存。<strong>重新测量</strong>。</li>
</ol>
<hr/>
<h3 data-id="heading-17">✅ 可粘贴的自检清单 (一行版)</h3>
<blockquote>
<p>性能分析内存 → 搜索需要释放的对象 → 添加/确认 <code>dispose()</code> → 用 <code>cacheWidth/height</code> 调整图片大小 → 如有需要，限制 <code>ImageCache</code> → 修复 Keys → 将重度工作移出 <code>build()</code> → 在 DevTools 中重新测量。</p>
</blockquote>
<hr/>
<h3 data-id="heading-18">🔄 最终总结：带走这个观念</h3>
<blockquote>
<p><strong>重建 (Rebuilds) 不是敌人</strong>。</p>
<p><strong>“泄漏”的状态</strong>（Leaky state）和<strong>尺寸过大的媒体资源</strong>才是！</p>
</blockquote>
<p>您觉得哪个优化点对您当前的项目最实用，需要我提供更多示例代码吗？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何在CI/CD流水线中自动化实现镜像扫描和推送到Harbor？]]></title>    <link>https://juejin.cn/post/7570999443446923300</link>    <guid>https://juejin.cn/post/7570999443446923300</guid>    <pubDate>2025-11-11T07:04:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570999443446923300" data-draft-id="7571304204721012790" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何在CI/CD流水线中自动化实现镜像扫描和推送到Harbor？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-11T07:04:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何在CI/CD流水线中自动化实现镜像扫描和推送到Harbor？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T07:04:41.000Z" title="Tue Nov 11 2025 07:04:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在CI/CD流水线中自动化实现镜像扫描和推送到Harbor，是提升容器安全性和部署效率的关键。下面这张流程图直观展示了其核心步骤与决策点，你可以结合后续的详细说明来实践。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94b9604b4baa4bf088abc8a3772fead3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVTmqZjlrZDnmq4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449480&amp;x-signature=bByXskMjs3tfCWNg1yO6umvpwAk%3D" alt="image.png" loading="lazy"/></p>
<p>下面，我们详细解析每个阶段的关键操作。</p>
<h3 data-id="heading-0">🔧 阶段一：代码编译与镜像构建</h3>
<p>这个阶段负责将源代码构建成Docker镜像。</p>
<ul>
<li><strong>基础环境配置</strong>：确保你的CI/CD环境（如Jenkins、GitLab Runner）已安装Docker，并配置为可访问你的Harbor私有仓库。通常需要在Docker配置中声明Harbor仓库地址为非安全注册表（<code>insecure-registries</code>）或配置正确的CA证书。</li>
<li><strong>构建与标记镜像</strong>：在流水线脚本中，使用<code>docker build</code>命令构建镜像，并使用<code>docker tag</code>为镜像打上符合Harbor规范的标签，格式通常为<code>&lt;harbor-server&gt;/&lt;project-name&gt;/&lt;image-name&gt;:&lt;tag&gt;</code>。</li>
</ul>
<h3 data-id="heading-1">🔍 阶段二：镜像安全扫描与质量门禁</h3>
<p>这是保障安全的核心环节，通常在构建之后、推送之前进行。</p>
<ul>
<li>
<p><strong>集成扫描工具</strong>：在流水线中集成漏洞扫描工具，如开源的<strong>Trivy</strong>、Clair或商业工具。将这些工具的命令直接添加到流水线脚本中。一个典型的Trivy扫描命令如下：</p>
<pre><code class="hljs language-arduino" lang="arduino"># 扫描镜像并生成报告，如果发现高危或严重漏洞则使构建失败
trivy image --exit-code <span class="hljs-number">1</span> --severity <span class="hljs-literal">HIGH</span>,CRITICAL &lt;your-image-tag&gt;
</code></pre>
</li>
<li>
<p><strong>设置质量门禁</strong>：通过工具的退出代码（如Trivy的<code>--exit-code 1</code>）或策略检查，在发现超过预设严重级别的漏洞时，<strong>主动让CI/CD流水线失败</strong>，从而阻断不安全的镜像流入后续环节。你还可以配置只阻断新引入的高危漏洞，这对于初步建立流程的团队非常有用。</p>
</li>
</ul>
<h3 data-id="heading-2">📤 阶段三：推送镜像至Harbor</h3>
<p>通过安全扫描后，镜像可以被推送到Harbor。</p>
<ul>
<li>
<p><strong>登录Harbor</strong>：在流水线脚本中使用<code>docker login</code>命令认证Harbor。<strong>务必使用凭证管理工具（如Jenkins的Credentials Binding插件）安全地处理用户名和密码</strong>，避免硬编码。</p>
<pre><code class="hljs language-bash" lang="bash">docker login -u <span class="hljs-variable">$HARBOR_USER</span> -p <span class="hljs-variable">$HARBOR_PASSWORD</span> <span class="hljs-variable">$HARBOR_SERVER</span>
</code></pre>
</li>
<li>
<p><strong>推送镜像</strong>：使用<code>docker push</code>命令将打好标签的镜像推送到Harbor的指定项目中。</p>
</li>
</ul>
<h3 data-id="heading-3">🚀 阶段四：部署到Kubernetes</h3>
<p>镜像推送成功后，流水线可自动或手动触发部署步骤。</p>
<ul>
<li><strong>更新部署清单</strong>：通常需要更新Kubernetes的YAML文件或Helm Chart中的镜像标签，指向刚刚推送到Harbor的新镜像。</li>
<li><strong>执行部署命令</strong>：使用<code>kubectl apply</code>或Helm命令来更新Kubernetes中的部署。确保CI/CD系统拥有操作K8s集群的必要权限（可通过ServiceAccount等方式配置）。</li>
</ul>
<h3 data-id="heading-4">💡 进阶实践与建议</h3>
<ul>
<li><strong>使用Harbor的机器人账户</strong>：为CI/CD流程创建专门的Harbor“机器人账户”，并赋予最小必要权限（通常仅限指定项目的推送权限），这比使用个人管理员账户更安全。</li>
<li><strong>定期扫描与策略管理</strong>：除了推送前扫描，还可以利用Harbor内置的漏洞扫描功能设置<strong>镜像标签不可变、自动扫描、阻止运行有严重漏洞的镜像</strong>等策略。同时，可设置定时任务（如每晚）重新扫描仓库中的旧镜像，以应对新披露的漏洞。</li>
<li><strong>遵循Dockerfile最佳实践</strong>：安全始于构建。在Dockerfile中尽量使用<strong>轻量级基础镜像</strong>，以非root用户运行应用，并进行<strong>多阶段构建</strong>以减少最终镜像的攻击面。</li>
</ul>
<h3 data-id="heading-5">🧩 示例流水线脚本片段 (Jenkins Pipeline)</h3>
<p>以下是一个简化的Jenkins Pipeline脚本示例，它串联了上述主要步骤：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">pipeline {
    agent any
    environment {
        HARBOR_SERVER = <span class="hljs-string">'your-harbor.com'</span>
        PROJECT_NAME = <span class="hljs-string">'your-project'</span>
        IMAGE_NAME = <span class="hljs-string">'your-app'</span>
    }
    stages {
        stage(<span class="hljs-string">'Build'</span>) {
            steps {
                script {
                    docker.build(<span class="hljs-string">"<span class="hljs-subst">${IMAGE_NAME}</span>:<span class="hljs-subst">${env.BUILD_ID}</span>"</span>)
                }
            }
        }
        stage(<span class="hljs-string">'Security Scan'</span>) {
            steps {
                script {
                    <span class="hljs-comment">// 使用Trivy扫描，如果发现HIGH/CRITICAL漏洞则失败</span>
                    sh <span class="hljs-string">"trivy image --exit-code 1 --severity HIGH,CRITICAL <span class="hljs-subst">${IMAGE_NAME}</span>:<span class="hljs-subst">${env.BUILD_ID}</span>"</span>
                }
            }
        }
        stage(<span class="hljs-string">'Push to Harbor'</span>) {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: <span class="hljs-string">'harbor-cred'</span>, usernameVariable: <span class="hljs-string">'HARBOR_USER'</span>, passwordVariable: <span class="hljs-string">'HARBOR_PASSWORD'</span>)]) {
                        sh <span class="hljs-string">"docker tag <span class="hljs-subst">${IMAGE_NAME}</span>:<span class="hljs-subst">${env.BUILD_ID}</span> <span class="hljs-subst">${HARBOR_SERVER}</span>/<span class="hljs-subst">${PROJECT_NAME}</span>/<span class="hljs-subst">${IMAGE_NAME}</span>:<span class="hljs-subst">${env.BUILD_ID}</span>"</span>
                        sh <span class="hljs-string">"docker login -u <span class="hljs-variable">$HARBOR_USER</span> -p <span class="hljs-variable">$HARBOR_PASSWORD</span> <span class="hljs-variable">$HARBOR_SERVER</span>"</span>
                        sh <span class="hljs-string">"docker push <span class="hljs-subst">${HARBOR_SERVER}</span>/<span class="hljs-subst">${PROJECT_NAME}</span>/<span class="hljs-subst">${IMAGE_NAME}</span>:<span class="hljs-subst">${env.BUILD_ID}</span>"</span>
                    }
                }
            }
        }
        stage(<span class="hljs-string">'Deploy to K8s'</span>) {
            steps {
                sh <span class="hljs-string">"sed -i 's|IMAGE_TAG|<span class="hljs-subst">${env.BUILD_ID}</span>|g' k8s-deployment.yaml"</span>
                sh <span class="hljs-string">"kubectl apply -f k8s-deployment.yaml"</span>
            }
        }
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深度解析 Android 崩溃捕获原理及从崩溃到归因的闭环实践]]></title>    <link>https://juejin.cn/post/7571068689764925480</link>    <guid>https://juejin.cn/post/7571068689764925480</guid>    <pubDate>2025-11-11T03:37:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571068689764925480" data-draft-id="7571068689764843560" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深度解析 Android 崩溃捕获原理及从崩溃到归因的闭环实践"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-11T03:37:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深度解析 Android 崩溃捕获原理及从崩溃到归因的闭环实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T03:37:55.000Z" title="Tue Nov 11 2025 03:37:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：路锦（小蘭）</p>
<h2 data-id="heading-0">背景：Android 应用崩溃的挑战</h2>
<p>在移动应用的世界里，稳定性是用户体验的基石。任何异常都可能导致用户失望、给出差评，并最终卸载应用。对于开发者而言，快速识别、定位和修复这些问题至关重要。正如线上应用崩溃了，我们收到的却往往只是一个无情的“已停止运行”提示。尤其面对 Native 崩溃和代码混淆，堆栈信息如同一本“天书”，让问题定位变得异常困难。本文将系统性地拆解 Android 崩溃捕获的底层原理与核心技术难点，并提供一套统一的框架设计思路，旨在点亮线上崩溃的“盲区”，实现从捕获到精准归因的闭环。</p>
<h2 data-id="heading-1">崩溃采集的技术原理与方案调研</h2>
<p>要捕获崩溃，我们首先需要理解 Android 系统中两类主要崩溃的底层触发机制。</p>
<h3 data-id="heading-2">2.1 Java/Kotlin 崩溃采集原理</h3>
<p>Java 和 Kotlin 代码都运行在 ART (Android Runtime) 上，当代码中抛出一个异常（如 <code>NullPointerException</code>）而没有被任何 <code>try-catch</code> 块捕获时，这个异常会沿着调用栈一路向上传递。如果最终抵达线程的顶部仍未被处理，ART 就会终止该线程。在终止前，ART 会调用一个可供开发者设置的回调接口——<code>Thread.UncaughtExceptionHandler</code>。</p>
<p>这正是我们捕获 Java 崩溃的入口。通过调用 Thread.setDefaultUncaughtExceptionHandler()，我们可以注册一个全局处理器。当任何线程发生未捕获异常时，我们的处理器便会接管，从而获得在进程完全死亡前的宝贵时机，用以记录崩溃现场的关键信息。</p>
<h3 data-id="heading-3">2.2 Native 崩溃原理：深入信号处理与现场捕获</h3>
<p>Native 崩溃发生在 C/C++ 代码层，它不受 ART 虚拟机管理，因此 <code>UncaughtExceptionHandler</code> 对其无能为力。Native 崩溃的本质是 CPU 执行了非法指令，进而被操作系统内核检测到。内核会向对应的进程发送一个 Linux 信号 (Signal) 来通知这一事件，这是一种内核与进程之间进行异步通信的机制。</p>
<h4 data-id="heading-4">常见致命信号详解</h4>
<ul>
<li><code>SIGSEGV</code> (Segmentation Fault)：段错误。这是最常见的 Native 崩溃原因，本质是程序试图访问一块它无权访问的内存。例如：解引用一个 NULL 指针、访问已释放对象的内存（Use-After-Free）、数组越界、试图写入只读内存段等。</li>
<li><code>SIGILL</code> (Illegal Instruction)：非法指令。当 CPU 的指令指针指向一个无效或包含损坏数据的地址时，CPU 无法识别将要执行的指令，便会触发此信号。例如：函数指针错误导致跳转到非代码区、栈被破坏导致返回地址错误等。</li>
<li><code>SIGABRT</code> (Abort)：程序异常终止。这通常是程序“主动”选择的崩溃，一般由调用 <code>abort()</code> 函数触发。在 C/C++ 中，很多断言库（<code>assert</code>）在断言失败后会调用<code>abort()</code>，表明程序进入了一个绝对不应存在的状态。</li>
<li><code>SIGFPE</code> (Floating-Point Exception)：浮点数异常。例如：整数除以零、浮点数上溢或下溢等。</li>
</ul>
<h4 data-id="heading-5">捕获流程四部曲</h4>
<p>捕获这些信号并还原现场，是一个精细且严谨的过程：</p>
<ol>
<li>
<p><strong>注册处理器</strong> (<code>sigaction</code>)：这是捕获流程的第一步。我们使用 <code>sigaction()</code> 系统调用来为我们关心的信号（如 <code>SIGSEGV</code>）注册一个自定义的回调函数。相比于老旧的 <code>signal()</code> 函数，<code>sigaction</code> 提供了更丰富的功能，特别是通过设置 <code>SA_SIGINFO</code> 标志，可以让我们的回调函数接收到一个包含详细上下文的 <code>siginfo_t</code> 结构体，其中包括了导致崩溃的具体内存地址 (<code>si_addr</code>) 等宝贵信息。</p>
</li>
<li>
<p><strong>安全第一</strong>：<code>async-signal-safe</code> 环境: 信号处理器函数在一个非常特殊且严苛的环境中执行。在这个环境中，我们不能假定全局数据结构是完好无损的，也不能调用绝大多数标准库函数（如 <code>malloc, free, printf, strcpy</code>），因为它们不是“异步信号安全”的，调用它们极易导致二次崩溃或死锁。我们能做的，只有调用少数被明确标记为“安全”的函数（如 <code>write, open, read</code>）。</p>
</li>
<li>
<p><strong>堆栈回溯</strong> (Stack Unwinding)：为了得到函数调用链，我们需要在信号处理器中进行堆栈回溯。这是一个通过分析当前线程的栈指针（SP）、帧指针（FP）以及栈上的返回地址，来逐层还原函数调用关系的过程。<code>libunwind</code> 等库被广泛用于此目的。然而，在 Native 崩溃场景下，栈本身可能已经被破坏，这使得实时回溯的成功率并非 100%。</p>
</li>
<li>
<p><strong>生成报告</strong> (Minidump)：正因为实时回溯的不可靠性，业界最佳实践（如 Google Breakpad）并非在信号处理器中直接进行复杂的堆栈回溯。更可靠的做法是：在信号处理器这个“安全环境”中，只做最少、最核心的操作——即收集所有线程的寄存器上下文、原始的堆栈内存片段、已加载的模块列表等信息，并将它们“打包”成一个结构化的 Minidump 文件。这个过程不涉及复杂的逻辑，失败风险低。真正的堆栈回溯和符号化分析，则被推迟到服务端，在更安全、资源更充裕的环境中离线进行。</p>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa815971c2034488ac7b03284b3e9c0b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763437075&amp;x-signature=ZXyVDAeQwymoDV8zlfGpUeDRDfw%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-6">2.3 业界方案调研</h3>
<p>基于以上原理，业界涌现了众多优秀的开源及商业化方案。它们本质上都是对上述原理的工程化封装。</p>
<ul>
<li><strong>Google Breakpad/Crashpad</strong>：它们是 Native 崩溃捕获的“黄金标准”，提供了从信号捕获、Minidump 生成到后台解析的全套工具链。它们是许多商业方案的技术基石，但自行集成和后台搭建成本较高。</li>
<li><strong>Firebase Crashlytics &amp; Sentry</strong>：这类商业化平台（SaaS）提供了“SDK + 后台”的一站式服务。它们封装了底层的捕获逻辑，并提供了强大的后台用于报告聚合、符号化解析和统计分析，极大地降低了开发者的使用门槛。</li>
<li><strong>xCrash</strong>：这是一个功能强大的开源库，不仅支持 Native 和 Java 崩溃，还对各种复杂场景下的堆栈回溯做了深度优化，信息采集能力非常出色。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b55446b629264948bc8525c909e88f0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763437075&amp;x-signature=LZKVAQngOqFcfI6U4t7IN19Ix68%3D" alt="图片" loading="lazy"/></p>
<p>经过对比分析，本文选择 Google Breakpad 作为 Native 崩溃采集的核心技术。Breakpad 采用业界标准的 Minidump 格式，这一格式已被 Chrome、Firefox 等全球主流产品广泛采用，技术成熟。从能力覆盖角度看，Breakpad 在 Native 崩溃捕获、多架构支持、跨平台兼容等核心场景上表现完整，配套的符号化工具链（如 dump_syms、minidump_stackwalk）也十分成熟。虽然 Breakpad 专注于 Native 层面，但 Java 崩溃可通过上述 UncaughtExceptionHandler 机制补齐，整体能力覆盖性满足崩溃采集的要求。</p>
<h2 data-id="heading-7">核心技术难点解析</h2>
<p>实现一个可靠的崩溃采集方案，需要克服以下三大技术难点。</p>
<h3 data-id="heading-8">难点一：捕获时机与信息保存的可靠性</h3>
<p>崩溃发生时，整个进程已处于极不稳定的濒死状态。此时执行复杂操作（如网络请求）风险极高。我们必须确保信息记录的过程足够快且绝对可靠。因此，“同步写入、延迟上报”是最佳策略。即在捕获到崩溃的瞬间，以最快的同步方式将信息写入本地文件，然后等到应用下一次正常启动时，再从容地读取文件并上报到服务器。</p>
<h3 data-id="heading-9">难点二：Native 崩溃的“黑盒”特性</h3>
<p>相比于 Java 崩溃，Native 崩溃现场更易遭到破坏。非法的内存操作可能已污染了堆栈，导致传统的堆栈回溯方法失效。因此，简单地记录几个寄存器值是远远不够的。我们需要的是一个包含线程、寄存器、堆栈内存、已加载模块等信息的完整“现场快照”。这正是 Breakpad 提出的 Minidump（小型转储）概念的价值所在。</p>
<h3 data-id="heading-10">难点三：堆栈的“天书”——混淆与符号化</h3>
<p>为了安全和包体大小，线上代码通常经过了混淆（ProGuard/R8）。这会导致崩溃堆栈中的类名和方法名变成无意义的 <code>a, b, c</code>，如同天书。对于 Native 代码，发布的是不含符号信息的二进制文件，其堆栈也是一串无意义的内存地址。因此，符号化 (Symbolication)是必不可少的一环。我们必须在编译时生成并保留对应的符号表文件（Java 的 <code>mapping.txt</code>，Native 的 <code>.so</code> 文件），在服务端利用这些文件将“天书”翻译回可读的、有意义的堆栈信息。</p>
<h2 data-id="heading-11">Android 应用崩溃采集及堆栈解析实践</h2>
<p>为了全面应对这些挑战，我们设计了一个统一的异常采集方案，遵循“捕获-持久化-上报-解析”的生命周期。无论是 Java 还是 Native 崩溃，客户端的核心任务都是可靠地将现场信息保存到本地。真正的解析和分析工作则交由服务端完成。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0563040a4db244c1bff8bcce67916f6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763437075&amp;x-signature=egu5eF9Iysnbn93hXn%2BCFA4tQa8%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-12">4.1 Java/Kotlin 崩溃处理</h3>
<p>我们使用 <code>Thread.setDefaultUncaughtExceptionHandler</code> 来捕获 Java/Kotlin 的异常。这是一个回调接口，无论是 Java 还是 Kotlin，其编译后的字节码均由 ART 执行。当抛出未捕获异常时，ART 会触发当前线程的异常分发机制，最终调用注册的 uncaughtException 方法。因此 <code>Thread.setDefaultUncaughtExceptionHandler</code> 能够实现全局 Java/Kotlin 异常捕获。</p>
<p>首先需要设置一个全局的未捕获异常处理器来捕获 Java 崩溃，通过实现<code>Thread.setDefaultUncaughtExceptionHandler</code> 的 uncaughtException 方法实现一个处理器，我们可以将自己实现的 handler 设置为所有线程的默认处理器。这就给了我们在应用彻底崩溃前的最后一刻“力挽狂澜”的机会——记录下导致崩溃的元凶。需要注意我们要保留原始的处理器：originalHandler。</p>
<p>当崩溃发生时，该处理器会收集异常及堆栈关键信息，最终将其同步持久化到 <code>SharedPreferences</code>。由于进程即将终止，当前的步骤必须保证同步完成，因此我们持久化写缓存也使用同步提交 (<code>editor.commit()</code>) ，异步的 <code>apply()</code> 可能无法确保成功持久化。关键的异常信息例如：</p>
<ul>
<li><strong>时间戳 (Timestamp)</strong>：崩溃发生的精确时间。</li>
<li><strong>异常类型 (Exception Type)</strong>：是 <code>NullPointerException</code> 还是 <code>IndexOutOfBoundsException</code> 等。</li>
<li><strong>异常信息 (Exception Message)</strong>：异常对象中包含的描述性信息。</li>
<li><strong>堆栈轨迹 (Stack Trace)</strong>：这是最重要的部分，它告诉我们崩溃发生在哪个类的哪一行代码。</li>
<li><strong>线程信息 (Thread Name)</strong>：崩溃发生在主线程还是某个后台线程。</li>
</ul>
<p>“下次启动时上报”是核心策略。它避免了在应用崩溃时不稳定的网络环境中尝试上报数据，大大提高了成功率。我们在 <code>start()</code> 方法中调用此检查。这个方法可以在后台线程中执行，防止阻塞应用主线程。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7cdac604cf44b2c9eebc8bed99c514b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763437075&amp;x-signature=wVT4IAD8xputPi%2FQobo1vj6r3qY%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Override</span>
public void uncaughtException(Thread thread, Throwable throwable) {
    try {
        <span class="hljs-comment">// 核心难点1：收集崩溃信息</span>
        CrashData crashData = <span class="hljs-built_in">collectCrashData</span>(thread, throwable);
        <span class="hljs-comment">// 核心难点2：保证濒死前数据能被同步、可靠地保存</span>
        <span class="hljs-built_in">saveCrashData</span>(crashData);
    } finally {
        <span class="hljs-comment">// 核心难点3：将控制权交还，确保系统默认行为（如弹窗）执行</span>
        if (originalHandler != null) {
            originalHandler<span class="hljs-selector-class">.uncaughtException</span>(thread, throwable);
        }
    }
}
private void <span class="hljs-built_in">saveCrashData</span>(CrashData data) {
    <span class="hljs-comment">// 使用 SharedPreferences 的同步 commit() 方法</span>
    prefs<span class="hljs-selector-class">.edit</span>()<span class="hljs-selector-class">.putString</span>("last_crash", data.toJson())<span class="hljs-selector-class">.commit</span>(); 
}
</code></pre>
<h3 data-id="heading-13">4.2 Native 崩溃处理</h3>
<p>对于 Native 崩溃，我们集成了一个基于 Breakpad 的解决方案。在启动时加载一个 Native 库，该库为常见的崩溃信号设置了信号处理器。</p>
<p><strong>1. 初始化</strong>：在 App 启动时，我们初始化 Native 库，并为其提供一个专用的目录来写入崩溃转储文件（crash dump）。</p>
<p><strong>2. 崩溃发生</strong>：当 Native 崩溃发生时，信号处理器会捕获它，并将一个 <code>.dmp</code> (minidump) 文件写入指定目录。</p>
<p><strong>3. 下次启动时处理</strong>：在下一次 App 启动时，我们的框架会检查此目录中是否有任何 <code>.dmp</code> 文件。如果找到，它会调用一个 Native 方法来解析 minidump，提取堆栈信息和其他相关信息。解析后的数据随后被上报到我们的后端，并且转储文件被删除。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ef3f0d1b02c4636904d4ddb8bc7c2bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763437075&amp;x-signature=u9AAvnLyAUN%2FoMUq7Cgq%2FDzl8ds%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-scss" lang="scss">public void <span class="hljs-built_in">start</span>() {
    <span class="hljs-comment">// 核心难点1：尽早初始化 Native 层的信号处理器</span>
    NativeBridge<span class="hljs-selector-class">.initialize</span>(crashDir.getAbsolutePath());
    <span class="hljs-comment">// 核心难点2：在下次启动时，异步检查并处理上次崩溃留下的产物</span>
    new <span class="hljs-built_in">Thread</span>(this::processExistingDumps)<span class="hljs-selector-class">.start</span>();
}
private void <span class="hljs-built_in">processExistingDumps</span>() {
    <span class="hljs-comment">// 遍历指定目录下的 .dmp 文件</span>
    File<span class="hljs-selector-attr">[]</span> dumpFiles = crashDir<span class="hljs-selector-class">.listFiles</span>();
    for (File dumpFile : dumpFiles) {
        <span class="hljs-comment">// 此处无需解析，直接将原始 .dmp 文件上报</span>
        <span class="hljs-built_in">reportToServer</span>(dumpFile);
        dumpFile<span class="hljs-selector-class">.delete</span>();
    }
}
<span class="hljs-comment">// JNI 桥接，是 Java 层与 C++ 层通信的唯一途径</span>
static class NativeBridge {
    <span class="hljs-comment">// 加载实现了信号捕获和 minidump 写入的 so 库</span>
    static { System<span class="hljs-selector-class">.loadLibrary</span>("crash-handler"); }
    <span class="hljs-comment">// JNI 方法，通知 C++ 层开始工作</span>
    public static native void <span class="hljs-built_in">initialize</span>(String dumpPath);
}
</code></pre>
<p>转储文件中我们能获取到的异常信息有很多，使用时我们通常需要关注以下的关键信息：</p>
<p><strong>1. 异常信息 (Exception Information)</strong></p>
<ul>
<li>异常流 (Exception Stream)：
<ul>
<li>崩溃线程 ID (Thread ID)：明确指出是哪一个线程引发了这次崩溃。</li>
<li>崩溃信号（Signal），例如 SIGSEGV（段错误) 和 SIGILL (非法指令)。</li>
<li>异常地址 (Exception Address)：异常发生时，CPU 指令指针（Program Counter）所在的内存地址。这直接指向了导致崩溃的那一行机器码。</li>
</ul>
</li>
</ul>
<p><strong>2. 线程列表与状态 (Thread List &amp; States)</strong></p>
<ul>
<li>线程 ID (Thread ID)：该线程的唯一标识符。</li>
<li>线程上下文。</li>
<li>线程堆栈内存 (Stack Memory Dump)：包含了每个线程栈上一部分内存的原始二进制拷贝。</li>
</ul>
<p><strong>3. 模块列表 (Module List)：</strong> 崩溃时进程加载的所有动态链接库（在 Android 上是 .so 文件）和可执行文件</p>
<p><strong>4. 系统信息 (System Information)</strong></p>
<ul>
<li>操作系统信息：操作系统类型（如 Linux）、版本号（如 Android 12, API 31）。</li>
<li>CPU 信息：CPU 架构（如 ARM64, x86）、CPU 型号、核心数量等。</li>
</ul>

<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 崩溃信息</span>
Caused <span class="hljs-keyword">by</span>: SIGSEGV /SEGV_ACCERR
<span class="hljs-comment">// 系统信息</span>
Kernel version: <span class="hljs-string">'0.0.0 Linux 6.6.66-android15-8-g807ce3b4f02f-ab12996908-4k #1 SMP PREEMPT Fri Jan 31 21:59:26 UTC 2025 aarch64'</span>  ABI: <span class="hljs-string">'arm64'</span> 
</code></pre>
<p>堆栈样例：<a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">#00</a> pc 0x3538 libtest-native.so</p>
<h3 data-id="heading-14">4.3 应用混淆堆栈解析</h3>
<p>当前很多线上应用为了安全和包体大小，代码通常经过了混淆（如 ProGuard/R8），这使得原始的崩溃堆栈变得几乎无法阅读。</p>
<h4 data-id="heading-15">混淆 Java 堆栈解析</h4>
<p>当线上应用发生崩溃时，你捕获到的堆栈信息是经过混淆的，看起来就像这样，这个堆栈对我们来说几乎是无用的：</p>
<ul>
<li>类名 a.b.c.a 和方法名 a 毫无意义。</li>
<li>行号信息也丢失了，显示为 Unknown Source。</li>
</ul>

<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">java</span><span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.NullPointerException</span>: <span class="hljs-selector-tag">Attempt</span> <span class="hljs-selector-tag">to</span> <span class="hljs-selector-tag">invoke</span> <span class="hljs-selector-tag">virtual</span> <span class="hljs-selector-tag">method</span> '<span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.b</span><span class="hljs-selector-class">.d</span><span class="hljs-selector-class">.a</span><span class="hljs-selector-class">.a</span>(a.b.e.a)' <span class="hljs-selector-tag">on</span> <span class="hljs-selector-tag">a</span> <span class="hljs-selector-tag">null</span> <span class="hljs-selector-tag">object</span> <span class="hljs-selector-tag">reference</span>
       <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.b</span><span class="hljs-selector-class">.c</span><span class="hljs-selector-class">.a</span><span class="hljs-selector-class">.a</span>(Unknown <span class="hljs-attribute">Source</span>:<span class="hljs-number">8</span>)
       <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.b</span><span class="hljs-selector-class">.c</span><span class="hljs-selector-class">.b</span><span class="hljs-selector-class">.onClick</span>(Unknown <span class="hljs-attribute">Source</span>:<span class="hljs-number">2</span>)
       <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">android</span><span class="hljs-selector-class">.view</span><span class="hljs-selector-class">.View</span><span class="hljs-selector-class">.performClick</span>(View.<span class="hljs-attribute">java</span>:<span class="hljs-number">7448</span>)
</code></pre>
<p>接下来我们了解一下混淆堆栈的解析原理：</p>
<p>当你在 Android 项目中启用代码混淆（通常是在 release 构建类型中设置 minifyEnabled true）并进行打包时，R8 工具会在处理你的代码的同时，在 build/outputs/mapping/release/ 目录下生成一个 mapping.txt 文件，这个文件我们可以理解为“字典”。</p>
<p>而解析工具会读取上述文件，将混淆后的堆栈逐行翻译为原始文件和方法名。</p>
<p><strong>1. 逐行读取堆栈：</strong> 工具读取混淆堆栈的每一行，例如 at a.b.c.a.a(Unknown Source:8)。</p>
<p><strong>2. 解析关键信息：</strong> 它从这行中提取出关键部分：</p>
<ul>
<li>类名：a.b.c.a</li>
<li>方法名：a</li>
<li>（可能的）行号：8</li>
</ul>
<p><strong>3. 查询</strong> <code>mapping.txt</code>：</p>
<ul>
<li>工具在 mapping.txt 中查找 a.b.c.a: 这一行，找到它对应的原始类名，例如：com.example.myapp.ui.MainActivity。</li>
<li>接着，在 MainActivity 的映射条目下，它会继续查找哪个原始方法被混淆成了a。假设它找到了 void updateUserProfile(com.example.myapp.model.User) -&gt; a。</li>
</ul>
<p><strong>4. 恢复行号：</strong> R8 在优化过程中可能会内联方法或移除代码，导致行号变化。mapping.txt中也包含了行号的映射信息。Retrace 工具会利用这些信息，将混淆后的行号（如：8）精确地还原为原始的源文件行号。</p>
<p><strong>5. 替换与输出：</strong> 工具将混淆的行替换为解析后的、可读的行。</p>
<h4 data-id="heading-16">Native 堆栈解析</h4>
<p>这是一个我们采集到的 Native 堆栈其中的一行，分别包含以下信息：</p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">#00</a>：堆栈帧序号。00 代表栈顶，是程序崩溃的直接位置。</li>
<li>pc 0x3538：程序计数器地址 (Program Counter)。这是我们需要解析的关键信息，代表 CPU 在 libtest-native.so 这个库中执行到的指令的相对地址。</li>
<li>libtest-native.so：动态库路径。指明了崩溃发生在哪一个 .so 文件中。这是设备上运行时的路径。</li>
</ul>

<pre><code class="hljs language-bash" lang="bash"> <span class="hljs-comment">#00 pc 0x3538 libtest-native.so</span>
</code></pre>
<p>然而我们拿到这个堆栈仍然无法解析出具体发生崩溃的文件和方法，因此我们需要解析 C++ 堆栈，还原为可读的崩溃真实信息。</p>
<p>与 Java 堆栈解析的核心思想一致，Native 堆栈解析也是一个“查表翻译”的过程。只不过它的“密码本”不再是 mapping.txt，而是包含了 DWARF 调试信息的、与线上版本完全一致的 <code>unstripped</code> 库文件：libtest-native.so 文件；“翻译工具”则是 NDK 提供的 addr2line 等命令行程序。执行类似如下的命令：</p>
<pre><code class="hljs language-bash" lang="bash"> <span class="hljs-comment"># 使用 NDK 中的 addr2line 工具</span>
 <span class="hljs-comment"># -C: Demangle C++ 的函数名 (例如将 _Z... 还原成 MyClass::MyMethod)</span>
 <span class="hljs-comment"># -f: 显示函数名</span>
 <span class="hljs-comment"># -e: 指定带符号的库文件</span>
addr2line -C -f -e /path/to/unstripped/libtest-native.so 0x3538
</code></pre>
<p>工作原理：</p>
<ul>
<li>
<p>addr2line 工具加载 unstripped 的 .so 文件。</p>
</li>
<li>
<p>它解析文件中的 DWARF 调试信息段，这些信息段中存储了从机器码地址到源代码行号的映射表。</p>
</li>
<li>
<p>它在映射表中查找地址 0x3538 落在哪个函数地址范围之内。</p>
</li>
<li>
<p>找到函数后，它进一步在行号表中查找该地址精确对应的文件名和行号。</p>
</li>
<li>
<p>同时，它利用 -C 参数对 C++ 的“符号修饰名”（mangled name）进行“解修饰”（demangle），将其还原成我们代码中编写的、可读的命名空间::类名::方法名(参数) 形式。</p>
</li>
</ul>
<p>addr2line 工具执行完毕后，就会解析出我们期望得到的结果，因此我们能够定位到发生崩溃的具体文件和方法：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">CrashCore::makeArrayIndexOutOfBoundsException()</span>
<span class="hljs-section">/xxx/xxx/xxx/android-demo/app/src/main/cpp/CrashCore.cpp:51</span>
</code></pre>
<h2 data-id="heading-17">总结</h2>
<p>通过本文的探讨，我们解构了 Android 崩溃捕获的底层原理，并围绕三大核心技术难点（<strong>捕获时机、黑盒现场、堆栈混淆</strong>）设计了一套捕获方案。无论是 Java 层的 UncaughtExceptionHandler 机制，还是 Native 层的信号处理与 Minidump 技术，其最终目的都是在进程“灰飞烟灭”前，尽可能可靠地抢救出最有价值的现场信息。阿里云 RUM 针对 Android 端实现了对应用性能、稳定性、和用户行为的无侵入式采集 SDK。可以参考接入文档 <strong>[</strong> <strong>1]</strong> 体验使用。相关问题可以加入“RUM 用户体验监控支持群”（<strong>钉钉群号：67370002064</strong>）进行咨询。</p>
<p><strong>相关链接：</strong></p>
<p>[1] 接入文档</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Farms%2Fuser-experience-monitoring%2Faccess-to-android-applications" target="_blank" title="https://help.aliyun.com/zh/arms/user-experience-monitoring/access-to-android-applications" ref="nofollow noopener noreferrer">help.aliyun.com/zh/arms/use…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 原生 app 和 WebView 如何交互？]]></title>    <link>https://juejin.cn/post/7571051830710779954</link>    <guid>https://juejin.cn/post/7571051830710779954</guid>    <pubDate>2025-11-11T07:54:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571051830710779954" data-draft-id="7571028035018866714" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 原生 app 和 WebView 如何交互？"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-11T07:54:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Vic_wkx"/> <meta itemprop="url" content="https://juejin.cn/user/1116759545357182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 原生 app 和 WebView 如何交互？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759545357182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Vic_wkx
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T07:54:10.000Z" title="Tue Nov 11 2025 07:54:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、前言</h2>
<p>在移动开发中，我们有时候会遇到这样的需求：</p>
<ul>
<li>有一部分功能需要网页实现（比如登录页、主页，已经有网页端了，不希望在 app 中再写一遍）</li>
<li>另一部分功能需要原生实现（比如硬件访问、获取系统权限、或者一些注重性能的逻辑）</li>
</ul>
<p>这时候 <strong>Hybrid App（原生 + WebView 混合应用）</strong> 就派上用场了。</p>
<p>本文带你全面了解 <strong>Android 原生 App 和 WebView 的交互方式</strong>，并附上实战示例。</p>
<hr/>
<h2 data-id="heading-1">二、交互</h2>
<p>WebView 与原生 App 的交互也就两种：</p>
<ol>
<li><strong>网页调用 App 原生方法</strong>（JS → Native）</li>
<li><strong>App 调用网页 JS 方法</strong>（Native → JS）</li>
</ol>
<p>双向通信的典型场景：</p>

























<table><thead><tr><th>场景</th><th>方向</th><th>示例</th></tr></thead><tbody><tr><td>网页点击按钮调用 app 功能</td><td>JS → Native</td><td><code>window.myApp.nativeMethod('a')</code></td></tr><tr><td>App 收集设备信息反馈给网页</td><td>Native → JS</td><td><code>webView.evaluateJavascript("jsMethod('a', 'b')")</code></td></tr><tr><td>登录状态同步</td><td>双向</td><td>网页通知 App 用户登录了，App 也可以主动查询网页是否已登录</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-2">2.1 编写本地 html</h3>
<p>写一个本地的 html 文件 test_login.html，内容如下：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Login Demo<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>Hybrid Login Demo<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"login()"</span>&gt;</span>Login<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"logout()"</span>&gt;</span>Logout<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">loginState</span> = { <span class="hljs-attr">isLoggedIn</span>: <span class="hljs-literal">false</span> };

    <span class="hljs-variable language_">window</span>.<span class="hljs-property">isUserLoggedIn</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"isUserLoggedIn = "</span> + <span class="hljs-variable language_">window</span>.<span class="hljs-property">loginState</span>.<span class="hljs-property">isLoggedIn</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">window</span>.<span class="hljs-property">loginState</span>.<span class="hljs-property">isLoggedIn</span>;
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">login</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">window</span>.<span class="hljs-property">loginState</span>.<span class="hljs-property">isLoggedIn</span> = <span class="hljs-literal">true</span>;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Login success!"</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">myApp</span> &amp;&amp; <span class="hljs-variable language_">window</span>.<span class="hljs-property">myApp</span>.<span class="hljs-property">onLoginStateChanged</span>) {
        <span class="hljs-variable language_">window</span>.<span class="hljs-property">myApp</span>.<span class="hljs-title function_">onLoginStateChanged</span>(<span class="hljs-literal">true</span>);
      }
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">logout</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">window</span>.<span class="hljs-property">loginState</span>.<span class="hljs-property">isLoggedIn</span> = <span class="hljs-literal">false</span>;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Logout success!"</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">myApp</span> &amp;&amp; <span class="hljs-variable language_">window</span>.<span class="hljs-property">myApp</span>.<span class="hljs-property">onLoginStateChanged</span>) {
        <span class="hljs-variable language_">window</span>.<span class="hljs-property">myApp</span>.<span class="hljs-title function_">onLoginStateChanged</span>(<span class="hljs-literal">false</span>);
      }
    }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>运行效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc58a5cc910044f484bf4e55a4151dd3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmljX3dreA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763452449&amp;x-signature=pmu9gv%2Bfk0BzD5Eqr5KThN7C31k%3D" alt="loginHtml.png" loading="lazy"/></p>
<p>可以看到，页面内容很简单，一个 title，两个按钮。一个用于登入，一个用于登出。</p>
<p>html 中维护了一个 loginState.isLoggedIn 属性，表示用户是否已登录。</p>
<p>提供了一个 isUserLoggedIn 函数，用于查询当前登录状态。</p>
<p>另外，还有一个 login 和一个 logout 方法，分别用于模拟登入登出，当状态改变后，通过 <code>window.myApp.onLoginStateChanged</code> 回调通知 app 登陆状态发生了改变。</p>
<h3 data-id="heading-3">2.2 编写 app</h3>
<p>为了便于测试，我们将 test_login.html 文件，放在 assets 文件夹下，app 上的 WebView 直接加载本地 url 即可。</p>
<p>MainActivity 完整代码：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">package</span> com.example.interaction

<span class="hljs-keyword">import</span> android.os.Bundle
<span class="hljs-keyword">import</span> android.webkit.CookieManager
<span class="hljs-keyword">import</span> android.webkit.WebChromeClient
<span class="hljs-keyword">import</span> android.webkit.WebSettings
<span class="hljs-keyword">import</span> android.webkit.WebView
<span class="hljs-keyword">import</span> android.webkit.WebViewClient
<span class="hljs-keyword">import</span> android.widget.Toast
<span class="hljs-keyword">import</span> androidx.activity.ComponentActivity
<span class="hljs-keyword">import</span> androidx.activity.compose.setContent
<span class="hljs-keyword">import</span> androidx.activity.enableEdgeToEdge
<span class="hljs-keyword">import</span> androidx.compose.foundation.layout.*
<span class="hljs-keyword">import</span> androidx.compose.material3.Button
<span class="hljs-keyword">import</span> androidx.compose.material3.Scaffold
<span class="hljs-keyword">import</span> androidx.compose.material3.Text
<span class="hljs-keyword">import</span> androidx.compose.runtime.*
<span class="hljs-keyword">import</span> androidx.compose.ui.Modifier
<span class="hljs-keyword">import</span> androidx.compose.ui.platform.LocalContext
<span class="hljs-keyword">import</span> androidx.compose.ui.unit.dp
<span class="hljs-keyword">import</span> androidx.compose.ui.viewinterop.AndroidView
<span class="hljs-keyword">import</span> com.example.interaction.ui.theme.WebViewJsInteractionDemoTheme

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">ComponentActivity</span>() {

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        enableEdgeToEdge()
        setContent {
            WebViewJsInteractionDemoTheme {
                Scaffold(modifier = Modifier.fillMaxSize()) { innerPadding -&gt;
                    LoginWebView(modifier = Modifier.padding(innerPadding))
                }
            }
        }
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">LoginWebView</span><span class="hljs-params">(modifier: <span class="hljs-type">Modifier</span> = Modifier)</span></span> {
    <span class="hljs-keyword">var</span> loginStatus <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-string">"Unknown"</span>) }
    <span class="hljs-keyword">val</span> context = LocalContext.current
    <span class="hljs-keyword">val</span> webViewRef = remember { mutableStateOf&lt;WebView?&gt;(<span class="hljs-literal">null</span>) }

    Column(modifier = modifier.fillMaxSize()) {
        AndroidView(
            modifier = Modifier
                .weight(<span class="hljs-number">1f</span>)
                .fillMaxWidth(),
            factory = { context -&gt;
                WebView(context).apply {
                    settings.apply {
                        javaScriptEnabled = <span class="hljs-literal">true</span>
                        domStorageEnabled = <span class="hljs-literal">true</span>
                        allowFileAccess = <span class="hljs-literal">true</span>
                        allowContentAccess = <span class="hljs-literal">true</span>
                        cacheMode = WebSettings.LOAD_DEFAULT
                    }
                    webChromeClient = WebChromeClient()

                    webViewClient = <span class="hljs-keyword">object</span> : WebViewClient() {
                        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onPageFinished</span><span class="hljs-params">(view: <span class="hljs-type">WebView</span>?, url: <span class="hljs-type">String</span>?)</span></span> {
                            <span class="hljs-keyword">super</span>.onPageFinished(view, url)
                            <span class="hljs-comment">// Query login status when page is loaded</span>
                            evaluateJavascript(<span class="hljs-string">"isUserLoggedIn()"</span>) { result -&gt;
                                <span class="hljs-keyword">val</span> isLoggedIn = result?.contains(<span class="hljs-string">"true"</span>) == <span class="hljs-literal">true</span>
                                loginStatus = <span class="hljs-keyword">if</span> (isLoggedIn) <span class="hljs-string">"Logged In"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"Logged Out"</span>
                            }
                        }
                    }

                    <span class="hljs-comment">// Register the JavaScript interface</span>
                    addJavascriptInterface(<span class="hljs-keyword">object</span> {
                        <span class="hljs-meta">@android</span>.webkit.JavascriptInterface
                        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onLoginStateChanged</span><span class="hljs-params">(isLoggedIn: <span class="hljs-type">Boolean</span>)</span></span> {
                            (context <span class="hljs-keyword">as</span> ComponentActivity).runOnUiThread {
                                loginStatus = <span class="hljs-keyword">if</span> (isLoggedIn) <span class="hljs-string">"Logged In"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"Logged Out"</span>
                                Toast.makeText(context, <span class="hljs-string">"Login status changed: <span class="hljs-variable">$loginStatus</span>"</span>, Toast.LENGTH_SHORT).show()
                            }
                        }
                    }, <span class="hljs-string">"myApp"</span>)

                    WebView.setWebContentsDebuggingEnabled(<span class="hljs-literal">true</span>)
                    CookieManager.getInstance().setAcceptCookie(<span class="hljs-literal">true</span>)

                    loadUrl(<span class="hljs-string">"file:///android_asset/test_login.html"</span>)
                    webViewRef.value = <span class="hljs-keyword">this</span>
                }
            }
        )

        Spacer(modifier = Modifier.height(<span class="hljs-number">16.</span>dp))

        <span class="hljs-comment">// Check login status button</span>
        Button(
            onClick = {
                webViewRef.value?.evaluateJavascript(<span class="hljs-string">"isUserLoggedIn()"</span>) { result -&gt;
                    <span class="hljs-keyword">val</span> isLoggedIn = result?.contains(<span class="hljs-string">"true"</span>) == <span class="hljs-literal">true</span>
                    loginStatus = <span class="hljs-keyword">if</span> (isLoggedIn) <span class="hljs-string">"Logged In"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"Logged Out"</span>
                    Toast.makeText(context, <span class="hljs-string">"Login status: <span class="hljs-variable">$loginStatus</span>"</span>, Toast.LENGTH_SHORT).show()
                }
            },
            modifier = Modifier
                .fillMaxWidth()
                .padding(horizontal = <span class="hljs-number">16.</span>dp)
        ) {
            Text(<span class="hljs-string">"Check Login Status"</span>)
        }

        Spacer(modifier = Modifier.height(<span class="hljs-number">8.</span>dp))

        Text(
            text = <span class="hljs-string">"Current Status: <span class="hljs-variable">$loginStatus</span>"</span>,
            modifier = Modifier.padding(horizontal = <span class="hljs-number">16.</span>dp)
        )
    }
}
</code></pre>
<p>运行效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5380cf1266934b0b9f6aeb7da6897c15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmljX3dreA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763452449&amp;x-signature=LBEryz%2B02B%2BN%2F1uqSnU02IOIZuk%3D" alt="loginDemo.gif" loading="lazy"/></p>
<p>可以看到，在 MainActivity 中，通过 addJavascriptInterface 函数添加了 onLoginStateChanged 接口供 Web 端调用，添加接口时，第二个参数是 name，Web 端将通过 <code>name.接口名</code> 来调用对应的接口，例如：<code>window.myApp.onLoginStateChanged(true);</code>。</p>
<p>在点击 Check Login Status 按钮后，通过 WebView 的 evaluateJavascript 函数调用网页端的 isUserLoggedIn 函数，收到 result 后，更新 loginStatus 变量。</p>
<p>另外，还自定义了 WebViewClient，在 onPageFinished 调用后，主动调用一次 isUserLoggedIn 函数，完成 Current Status 的初始化。</p>
<h2 data-id="heading-4">三、后话</h2>
<p>有一些需要注意的点：</p>
<ul>
<li>调用 js 方法时，结果是异步返回的，通过 listener 接收结果。</li>
<li><code>@JavascriptInterface</code> 的方法在 <strong>非 UI 线程</strong> 执行，如果要更新 UI，需要使用 <code>runOnUiThread</code>。</li>
<li>设置了 <code>WebView.setWebContentsDebuggingEnabled(true)</code> 之后，通过 Chrome DevTools 可直接调试 WebView。方法是在 app 加载了网页后，在 Chrome 浏览器访问 <code>chrome://inspect/#devices</code>，在这里找到自己的设备，点击 inspect。我对这种方式不是很熟悉，就不过多介绍了。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db2ea15ecbc34ed0b9002afbd76172dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmljX3dreA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763452449&amp;x-signature=DI%2Bvvqwxu%2BQZ9Xsygf1GxP0dCDM%3D" alt="chrome.png" loading="lazy"/></p>
<h2 data-id="heading-5">附：一些常见的问题</h2>
<blockquote>
<p>注：这一节是 AI 总结的，不保真：</p>
</blockquote>
<p>在 WebView 中，通过 webView.settings 可以获取到 WebSettings，它可以用来配置一系列网页渲染与访问能力。以下是关键属性解释：</p>

























































































<table><thead><tr><th>属性</th><th>作用</th><th>是否常用</th><th>注意事项</th></tr></thead><tbody><tr><td><code>javaScriptEnabled = true</code></td><td>启用网页中的 JavaScript 执行。没有这个，网页的交互和动态内容几乎全失效。</td><td>✅ 必须</td><td>启用 JS 后要配合 <code>addJavascriptInterface</code> 谨慎使用，否则存在安全隐患。</td></tr><tr><td><code>domStorageEnabled = true</code></td><td>启用 HTML5 的 DOM Storage（<code>localStorage</code> / <code>sessionStorage</code>）。网页才能保存本地状态。</td><td>✅ 常用</td><td>现代 Web 必备。</td></tr><tr><td><code>databaseEnabled = true</code></td><td>启用 Web SQL 数据库（旧标准）。</td><td>⚠️ 较旧</td><td>新网页一般用 IndexedDB。</td></tr><tr><td><code>allowFileAccess = true</code></td><td>允许访问本地文件（<code>file://</code>）。</td><td>✅ 常用</td><td>某些 WebView 资源加载或本地调试需要。</td></tr><tr><td><code>allowContentAccess = true</code></td><td>允许访问 <code>content://</code> URI 内容（如系统媒体）。</td><td>✅ 常用</td><td>安全风险低。</td></tr><tr><td><code>allowFileAccessFromFileURLs = true</code></td><td>允许网页 JS 从 file:// 页面访问其他本地文件。</td><td>⚠️ 慎用</td><td>容易被恶意网页利用本地文件。</td></tr><tr><td><code>allowUniversalAccessFromFileURLs = true</code></td><td>允许 file:// 页面访问任意网络资源（http/https）。</td><td>⚠️ 高风险</td><td>建议仅限调试环境启用。</td></tr><tr><td><code>useWideViewPort = true</code></td><td>启用自适应宽度，让网页以「网页比例」显示而非手机分辨率。</td><td>✅ 常用</td><td>与 <code>loadWithOverviewMode</code> 一起使用更佳。</td></tr><tr><td><code>loadWithOverviewMode = true</code></td><td>缩放网页以适配屏幕宽度。</td><td>✅ 常用</td><td>常配合 responsive 页面。</td></tr><tr><td><code>setSupportZoom(true)</code></td><td>支持缩放。</td><td>✅ 常用</td><td>可搭配手势操作。</td></tr><tr><td><code>builtInZoomControls = true</code></td><td>启用内建缩放按钮。</td><td>✅ 可选</td><td>通常在调试或旧网页中启用。</td></tr><tr><td><code>displayZoomControls = false</code></td><td>隐藏默认的缩放控件（仅保留手势缩放）。</td><td>✅ 推荐</td><td>提升视觉体验。</td></tr><tr><td><code>cacheMode = WebSettings.LOAD_DEFAULT</code></td><td>启用缓存策略。</td><td>✅ 常用</td><td>可选 <code>LOAD_NO_CACHE</code> 禁止缓存。</td></tr></tbody></table>
<p>WebViewClient 和 WebChromeClient 的区别：</p>



































<table><thead><tr><th>对比项</th><th><code>WebViewClient</code></th><th><code>WebChromeClient</code></th></tr></thead><tbody><tr><td>职责</td><td>控制页面导航与加载逻辑</td><td>控制网页中“浏览器行为”与 UI 事件</td></tr><tr><td>常用回调</td><td><code>shouldOverrideUrlLoading</code>、<code>onPageStarted</code>、<code>onPageFinished</code>、<code>onReceivedError</code></td><td><code>onProgressChanged</code>、<code>onReceivedTitle</code>、<code>onConsoleMessage</code>、<code>onJsAlert</code></td></tr><tr><td>场景举例</td><td>拦截跳转、处理自定义 URL Scheme、控制加载动画</td><td>显示网页标题、监控加载进度、拦截 JS 弹窗、打印调试信息</td></tr><tr><td>比喻</td><td>浏览器“司机”</td><td>浏览器“仪表盘”</td></tr><tr><td>建议</td><td>必须设置一个（否则无法处理跳转）</td><td>可选（但调试与交互建议加）</td></tr></tbody></table>
<p>👉 <strong>总结一句话</strong>：</p>
<blockquote>
<p><code>WebViewClient</code> 负责“页面去哪”，<code>WebChromeClient</code> 负责“页面看起来怎样”。</p>
</blockquote>
<p>其他关键配置：</p>

























<table><thead><tr><th>配置</th><th>作用</th></tr></thead><tbody><tr><td><code>setLayerType(View.LAYER_TYPE_HARDWARE, null)</code></td><td>启用硬件加速，提升渲染性能（尤其是视频或动画）。</td></tr><tr><td><code>setOnLongClickListener { true }</code> + <code>isLongClickable = false</code></td><td>禁用长按（防止复制或保存图片）。</td></tr><tr><td><code>WebView.setWebContentsDebuggingEnabled(true)</code></td><td>允许通过 Chrome 调试网页内容（chrome://inspect）。</td></tr><tr><td><code>CookieManager.getInstance().setAcceptThirdPartyCookies(...)</code></td><td/></tr></tbody></table>
<p>以上就是本文的全部内容了，如果你喜欢本文的内容，欢迎点赞、投币、收藏、转发，更重要的是点一个大大的关注，这对我们有非常大的帮助......</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>